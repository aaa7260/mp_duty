---
title: "你想在GSEA可视化图中标注几个基因？"
date: 2022-08-25T02:53:17Z
draft: false
tags: ["fetched","YuLabSMU"]
---

https://mp.weixin.qq.com/s/-y7DShsFiR4IDTuGAFHR3A

---

你想在GSEA可视化图中标注几个基因？ by YuLabSMU
------
<div><p data-mpa-powered-by="yiban.io"><img data-galleryid="" data-ratio="2.2222222222222223" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/MPBFtnFrw4loCdE2LBJSM3fRB1ZxMLsdTHBQibGUmPo0mnkI8an9785Z8QbfQy05FgpsFk9R3RxwXjwkvia5LuaA/640?wx_fmt=jpeg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/MPBFtnFrw4loCdE2LBJSM3fRB1ZxMLsdTHBQibGUmPo0mnkI8an9785Z8QbfQy05FgpsFk9R3RxwXjwkvia5LuaA/640?wx_fmt=jpeg"><span></span></p><p><span>小伙伴提问了，就这么说吧，</span><span>只要你敢要求，</span><span>我们</span><span>一般都能实现。我在邮件里回复了他怎么样的黑魔法可以拿到这个数据，回复完邮件，我想我应该写个图层，因为so easy。一如即往，上栗子。</span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><code>require(DOSE)<br>data(geneList)<br>x = gseDO(geneList)<br>require(enrichplot)<br>p &lt;- gseaplot(x, 1, by=<span>'runningScore'</span>) <br></code></pre><p data-tool="mdnice编辑器">我先画一张running score的，先简单讲一下。</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; id = x<span>$ID</span>[1]<br>&gt; x[[id]]<br>&gt; x[[id]]<br> [1] <span>"4312"</span>  <span>"597"</span>   <span>"3627"</span>  <span>"6373"</span>  <span>"820"</span>   <span>"3620"</span>  <span>"6364"</span>  <span>"29851"</span> <span>"4318"</span> <br>[10] <span>"3576"</span>  <span>"26227"</span> <span>"6890"</span>  <span>"952"</span>   <span>"1493"</span>  <span>"6352"</span>  <span>"3934"</span>  <span>"54210"</span> <span>"3932"</span> <br>[19] <span>"5551"</span>  <span>"3559"</span>  <span>"6347"</span>  <span>"6402"</span>  <span>"639"</span>   <span>"94025"</span> <span>"3126"</span>  <span>"3001"</span>  <span>"6351"</span> <br>[28] <span>"1236"</span>  <span>"5698"</span>  <span>"3948"</span>  <span>"919"</span>   <span>"3458"</span>  <span>"959"</span>   <span>"7296"</span>  <span>"79139"</span> <span>"3804"</span> <br>[37] <span>"4159"</span>  <span>"942"</span>   <span>"3329"</span>  <span>"9235"</span>  <span>"1234"</span>  <span>"7096"</span>  <span>"3383"</span>  <span>"4068"</span>  <span>"6367"</span> <br>[46] <span>"5806"</span>  <span>"100"</span>   <span>"3659"</span>  <span>"4360"</span>  <span>"939"</span>   <span>"6891"</span>  <span>"4210"</span>  <span>"671"</span>   <span>"7422"</span> <br>[55] <span>"929"</span>   <span>"26191"</span> <span>"6504"</span>  <span>"27087"</span> <span>"4282"</span>  <span>"7124"</span>  <span>"5027"</span>  <span>"5329"</span>  <span>"3569"</span> <br>[64] <span>"4049"</span>  <span>"7097"</span>  <span>"56244"</span> <span>"7852"</span>  <span>"1378"</span>  <span>"5133"</span>  <span>"5743"</span>  <span>"348"</span>   <span>"1118"</span> <br>[73] <span>"3119"</span>  <span>"7415"</span> <br></code></pre><p data-tool="mdnice编辑器">那么我们 可以拿到对应gene set里面的基因，读过clusterProfiler 4.0文章的小伙伴对这样的操作都不陌生了。</p><pre data-tool="mdnice编辑器"><span></span><code>set.seed(2022-08-24)<br>g = sample(x[[id]],5)<br></code></pre><p data-tool="mdnice编辑器">我随机拿几个基因来画图，对于你自己的图，你当然有自己心仪的基因。</p><pre data-tool="mdnice编辑器"><span></span><code>p + geom_gsea_gene(g)<br></code></pre><p><img data-galleryid="" data-ratio="0.5538461538461539" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4nBDlVVsabic63Mvmlic8wVdqp8g8SqbRpIoSFiaFKIyBj6GBg2gVLBIiaVxVo7pYVTqLcpkCouV50ibbw/640?wx_fmt=png" data-type="png" data-w="1040" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4nBDlVVsabic63Mvmlic8wVdqp8g8SqbRpIoSFiaFKIyBj6GBg2gVLBIiaVxVo7pYVTqLcpkCouV50ibbw/640?wx_fmt=png"></p><p>就是这么简单吧，有几个基因想label，传给我写好的图层，完美。你或者会说，你想要标gene symbol啊，这有何难呢。<br></p><pre data-tool="mdnice编辑器"><span></span><code>setReadable(x, <span>'org.Hs.eg.db'</span>, <span>"ENTREZID"</span>) -&gt; y<br>p2 &lt;- gseaplot(y, 1, by=<span>'runningScore'</span>) <br><br>set.seed(2022-08-24)<br>g2 = sample(y[[id]],25)<br><br>p2 + geom_gsea_gene(g2)<br></code></pre><p><img data-galleryid="" data-ratio="0.5524542829643888" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4nBDlVVsabic63Mvmlic8wVdq7rvSibRlKGoafuZO6UphZJd5lCrHXIibMc4TJv3SZN9noG8Byaf8U5icQ/640?wx_fmt=png" data-type="png" data-w="1039" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4nBDlVVsabic63Mvmlic8wVdq7rvSibRlKGoafuZO6UphZJd5lCrHXIibMc4TJv3SZN9noG8Byaf8U5icQ/640?wx_fmt=png"></p><p>这不就有了嘛。只要你是用了clusterProfiler系列的，换ID，也是认的。</p><p><br></p><p>看到这里，你有两个问题。<br></p><ol><li><p>这只是running score的图，enrichplot出的GSEA的图，多半是拼的。那怎么搞？</p></li><li><p>gene symbol这张图，基因名都挤一起了，怎么办呢？</p></li></ol><p><br></p><p>第一个问题，让我们来画一张gseaplot完整的。子图2是running score，我们可以用list一样，拿一个子图，搞它（没错，搞，随便搞），然后替换它，照样出图，完美。</p><pre data-tool="mdnice编辑器"><span></span><code>pg1 &lt;- gseaplot(x, 1)<br>pg1[[2]] = pg1[[2]]  + geom_gsea_gene(g, geom=ggplot2::geom_label)<br>pg1<br></code></pre><p><img data-galleryid="" data-ratio="0.718384697130712" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4nBDlVVsabic63Mvmlic8wVdqBUPEYRnXZPHiaCR0sVnicj5O8VJnZkCPKsOlamMrvlH7xSUiaubULxkKQ/640?wx_fmt=png" data-type="png" data-w="941" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4nBDlVVsabic63Mvmlic8wVdqBUPEYRnXZPHiaCR0sVnicj5O8VJnZkCPKsOlamMrvlH7xSUiaubULxkKQ/640?wx_fmt=png"></p><p><br></p><p>然后我们来解决第二个问题，你应当发现上面的代码有个geom的参数，没错，那你传ggrepel::geom_text_repel就可以了，基因之间的社交距离就出现了。<br></p><pre data-tool="mdnice编辑器"><span></span><code>pg2 &lt;- gseaplot2(y, 1)<br>pg2[[1]] = pg2[[1]]  + geom_gsea_gene(g2, geom=ggrepel::geom_text_repel)<br>pg2<br></code></pre><p><img data-galleryid="" data-ratio="0.7168803418803419" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4nBDlVVsabic63Mvmlic8wVdqc5jW9vKIunCot19NzQS2l0EXkSiaibcwCl8t4zZCA0n4lFmWXo1VYjsg/640?wx_fmt=png" data-type="png" data-w="936" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4nBDlVVsabic63Mvmlic8wVdqc5jW9vKIunCot19NzQS2l0EXkSiaibcwCl8t4zZCA0n4lFmWXo1VYjsg/640?wx_fmt=png"></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">这么灵活的图层，代码量不少吧？不好意思，才10行代码。核心代码就一行，调用了<code>ggtree</code>里的函数。</p><p><br></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">最后的最后，你可能会问，gseaplot2可是支持多个gene sets一直画的。让我们试一下吧。</p><pre data-tool="mdnice编辑器"><span></span><code>library(ggrepel)<br><br>pg3 &lt;- gseaplot2(y, 1:3)<br>pg3[[1]] = pg3[[1]]  + geom_gsea_gene(mapping=aes(colour = Description), g2, geom=geom_text_repel)<br>pg3<br></code></pre><p><img data-galleryid="" data-ratio="0.5551053484602917" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4nBDlVVsabic63Mvmlic8wVdqwtnXBdJffulfclEMBpd0hV3nrASapPQlxwcwia0U0eZ5jtKpibQeV0CA/640?wx_fmt=png" data-type="png" data-w="1234" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4nBDlVVsabic63Mvmlic8wVdqwtnXBdJffulfclEMBpd0hV3nrASapPQlxwcwia0U0eZ5jtKpibQeV0CA/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">同样的基因，不一定会出现在所有的通路上，出现在不同通路上的同一基因，它们的位置是不一样的，你看到一个基因，标记在多个通路上，这是对的。然后只要你传个颜色映射的<code>aes</code>，颜色就有了。就是这么简单。</p><p data-tool="mdnice编辑器">这你又有问题了，基因只传一个参数，所有的通路都是标和这些基因的交集，你想分别标不同的基因呢。那就<code>+</code>不同的图层嘛。所以我们又加了个<code>geneSet</code>的参数，来指定一下基因标的是那条通路（在同时有几条通路的情况下）。</p><pre data-tool="mdnice编辑器"><span></span><code>pg4 &lt;- gseaplot2(y, 1:3)<br><br>g11 &lt;- sample(y[[y<span>$ID</span>[1]]],5)<br>g22 &lt;- sample(y[[y<span>$ID</span>[2]]],5)<br>g33 &lt;- sample(y[[y<span>$ID</span>[3]]],5)<br>desc &lt;- y<span>$Description</span>[1:3]<br><br>pg4[[1]] &lt;- pg4[[1]]  + <br>    geom_gsea_gene(mapping=aes(colour = Description), g11, geom=geom_text_repel, geneSet=desc[1]) + <br>    geom_gsea_gene(mapping=aes(colour = Description), g22, geom=geom_text_repel, geneSet=desc[2]) +<br>    geom_gsea_gene(mapping=aes(colour = Description), g33, geom=geom_text_repel, geneSet=desc[3])<br>pg4<br></code></pre><p data-tool="mdnice编辑器"><img data-galleryid="" data-ratio="0.5587996755879967" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4nBDlVVsabic63Mvmlic8wVdqthMAs4PHpDrd2NDksUGCAicqOxSet5cFFXmAEUqz1hKJibiazHmib3k2aA/640?wx_fmt=png" data-type="png" data-w="1233" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4nBDlVVsabic63Mvmlic8wVdqthMAs4PHpDrd2NDksUGCAicqOxSet5cFFXmAEUqz1hKJibiazHmib3k2aA/640?wx_fmt=png"></p></section></section></section></div>