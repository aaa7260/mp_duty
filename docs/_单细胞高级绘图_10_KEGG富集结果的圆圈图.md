---
title: "【单细胞高级绘图】10.KEGG富集结果的圆圈图"
date: 2022-09-12T09:39:17Z
draft: ["false"]
tags: [
  "fetched",
  "TOP生物信息"
]
categories: ["Acdemic"]
---
【单细胞高级绘图】10.KEGG富集结果的圆圈图 by TOP生物信息
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">富集分析的可视化，断断续续也写了几篇了：</p><p data-tool="mdnice编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247483929&amp;idx=1&amp;sn=0806d92d6e0578cecbcacba3e7828d4b&amp;chksm=c251790ef526f0185b22430b7dc0dda0682a0554617a56823da05c021cbf419b2687017c0871&amp;scene=21#wechat_redirect" textvalue="如何优雅展示GO富集结果" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">如何优雅展示GO富集结果</a><br></p><p data-tool="mdnice编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247484022&amp;idx=1&amp;sn=5d19e1df6c03b702c81e06e21f79a9c4&amp;chksm=c2517961f526f077675a73b561bb23f5f80a2b335c21dcb4a1b798962461bb8fafc412869950&amp;scene=21#wechat_redirect" textvalue="用网络图展示富集分析" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">用网络图展示富集分析</a><br></p><p data-tool="mdnice编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247485621&amp;idx=2&amp;sn=ee2d1efa0fe55c2317d73890ef87fd6d&amp;chksm=c25173a2f526fab44f49ccb163916edaa5928b10d3ad3846db97d8d246924ee0af05affa533e&amp;scene=21#wechat_redirect" textvalue="KEGG通路的从属/注释信息如何获取" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">KEGG通路的从属/注释信息如何获取</a><br></p><p data-tool="mdnice编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247485640&amp;idx=1&amp;sn=75d9d1840c572081d1b283c7653ede56&amp;chksm=c25173dff526fac9fba70e5d62beab74e9ebf435e8627038b521588622925a8148cd0cfbe14a&amp;scene=21#wechat_redirect" textvalue="【单细胞高级绘图】07.KEGG富集结果展示" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">【单细胞高级绘图】07.KEGG富集结果展示</a><br></p><figure data-tool="mdnice编辑器"><img data-ratio="1.0013966480446927" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2b38oAXqeGMmHHXicrfibDXxmg4wErwic7M450MgUaBOKMpXQ1hricBCribrAoy7SK1mAEa9rPbibqJ9GvQ/640?wx_fmt=png" data-type="png" data-w="716" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2b38oAXqeGMmHHXicrfibDXxmg4wErwic7M450MgUaBOKMpXQ1hricBCribrAoy7SK1mAEa9rPbibqJ9GvQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">本次教程的figure仍然是读者求助的图，算得上是<code>kegg</code>富集图的新流派。据我的调查，该图应该是<code>基迪奥</code>云平台首创(https://www.omicshare.com/tools/Home/Soft/enrich_circle)，之后公众号<code>小白鱼的生统笔记</code>进行了复现(仿一个网图，使用circlize包绘制圈图可视化基因集富集分析结果)。</p><p data-tool="mdnice编辑器">最开始也是跟着上述的帖子学习，之后自己对代码进行了改写，重新安排图形的布局，使之（在我看来）更有意义。另一个改动是增加了kegg pathway的<code>注释信息</code>，我在之前的帖子中(<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247485621&amp;idx=2&amp;sn=ee2d1efa0fe55c2317d73890ef87fd6d&amp;chksm=c25173a2f526fab44f49ccb163916edaa5928b10d3ad3846db97d8d246924ee0af05affa533e&amp;scene=21#wechat_redirect" textvalue="KEGG通路的从属/注释信息如何获取" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">KEGG通路的从属/注释信息如何获取</a>)也提到了如何获取这个信息，没有这个信息是画不了这张图的。最后，将代码模块化，<strong>「一行代码」</strong>就能出图。</p><p data-tool="mdnice编辑器">这张图如何解读：</p><ul data-tool="mdnice编辑器"><li><section>不论是<code>组间</code>比较还是<code>cluster之间</code>的比较，在得到某组/某cluster的差异基因后，都能进行KEGG富集分析，选取<code>20-35</code>个term画图</section></li><li><section>圆圈<code>从外向内</code>看，<code>第1圈</code>是通路编号和分类，具体编号对应什么通路名称可以在代码输出的Excel文件中查询；</section></li><li><section><code>第2圈</code>表示这个通路有多少个基因；</section></li><li><section><code>第3圈</code>分为深绿和浅绿，二者加和始终是一样的，表示高表达基因的数目，深绿表示其中有多少基因属于这个通路，浅绿是不属于这个通路的基因数目；</section></li><li><section><code>第4圈</code>是富集分析的显著性，-log10(p.adjust)，有一条<code>灰色的竖线</code>表示-log10(0.01)；</section></li><li><section><code>第5圈</code>是富集因子，等于差异基因中落到这个通路的基因数除以这个通路的基因总数（第三圈深绿除以第二圈紫色）</section></li></ul><p data-tool="mdnice编辑器">代码演示</p><pre data-tool="mdnice编辑器"><code>library(Seurat)<br>library(tidyverse)<br>library(xlsx)<br><br>testseu=readRDS(<span>"testseu.rds"</span>)<br>Idents(testseu)=<span>"anno_new"</span><br><br><span>### 找差异基因 #########################################################################</span><br>marker_celltype=FindAllMarkers(testseu,logfc.threshold = 0.8,only.pos = T)<br><span># 过滤</span><br>marker_celltype=marker_celltype%&gt;%filter(p_val_adj &lt; 0.01)<br>marker_celltype<span>$d</span>=marker_celltype<span>$pct</span>.1-marker_celltype<span>$pct</span>.2<br>marker_celltype=marker_celltype%&gt;%filter(d &gt; 0.2)<br>marker_celltype=marker_celltype%&gt;%arrange(cluster,desc(avg_log2FC))<br>marker_celltype=as.data.frame(marker_celltype)<br>write.xlsx(marker_celltype,file = <span>"markers_log2fc0.8_padj0.01_pctd0.2.xlsx"</span>,row.names = F,col.names = T)<br><br><span>### 富集分析 ###########################################################################</span><br>library(clusterProfiler)<br>library(org.Hs.eg.db)<br>R.utils::setOption(<span>"clusterProfiler.download.method"</span>,<span>"auto"</span>) <span>#https://github.com/YuLab-SMU/clusterProfiler/issues/256</span><br><br><span>source</span>(<span>"syEnrich.R"</span>)<br>syEnrich(marker_celltype,outpath = <span>"markers_log2fc0.8_padj0.01_pctd0.2"</span>)<br><br><span>### 挑一类细胞来作为演示 #######################################################</span><br>kegg.res=read.xlsx(<span>"markers_log2fc0.8_padj0.01_pctd0.2.KEGG.xls"</span>,sheetIndex = 1,as.data.frame = T,header = T)<br>kegg.res=kegg.res%&gt;%filter(p.adjust &lt; 0.05)<br>kegg.res=kegg.res%&gt;%filter(cluster == <span>"Endothelial"</span>)<br></code></pre><p data-tool="mdnice编辑器">导入《<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247485621&amp;idx=2&amp;sn=ee2d1efa0fe55c2317d73890ef87fd6d&amp;chksm=c25173a2f526fab44f49ccb163916edaa5928b10d3ad3846db97d8d246924ee0af05affa533e&amp;scene=21#wechat_redirect" textvalue="KEGG通路的从属/注释信息如何获取" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">KEGG通路的从属/注释信息如何获取</a>》这一讲的文件</p><pre data-tool="mdnice编辑器"><code><span># 导入《KEGG通路的从属/注释信息如何获取》这一讲的文件</span><br>kegg_info=read.xlsx(<span>"kegg_info.xlsx"</span>,sheetIndex = 1,startRow = 3)<br>kegg_info=kegg_info[,c(<span>"ID"</span>,<span>"Pathway"</span>,<span>"big.annotion"</span>)]<br><br><span># 合并两个表格</span><br>kegg.res<span>$ID</span>=str_replace(kegg.res<span>$ID</span>,<span>"hsa"</span>,<span>""</span>)<br>kegg.res=kegg.res%&gt;%inner_join(kegg_info,by = <span>"ID"</span>)<br><br><span># 画图展示的term控制在20到35个</span><br>kegg.res=kegg.res%&gt;%arrange(p.adjust)<br>kegg.res=head(kegg.res,20)<br><br>write.table(kegg.res,file = <span>"kegg.res.txt"</span>,quote = F,sep = <span>"\t"</span>,row.names = F,col.names = T)<br>write.xlsx(kegg.res,file = <span>"kegg.res.xlsx"</span>,col.names = T,row.names = F)<br></code></pre><p data-tool="mdnice编辑器">调用画图函数</p><pre data-tool="mdnice编辑器"><code><span>### 调用画图函数 ###############################################################</span><br><span>source</span>(<span>"kegg_loop.R"</span>)<br>kegg_loop(enrich.res = kegg.res,filename = <span>"Endothelial_kegg"</span>)<br></code></pre><p data-tool="mdnice编辑器">然后就能得到推文开头那张图了。</p><h2 data-tool="mdnice编辑器"><span></span><span>获取代码</span><span></span></h2><p data-tool="mdnice编辑器">本文代码<strong>「限时公开」</strong>，<code>24小时</code>内是免费的。超过这个时间如何获取，后台回复<code>2022A</code>可知。</p><p data-tool="mdnice编辑器">代码和测试数据的网盘链接如下: </p><p data-tool="mdnice编辑器">链接：https://pan.baidu.com/s/1O1QJN-wvTdYSUhFEmt85vg</p><p data-tool="mdnice编辑器">提取码：szcj</p><h2 data-tool="mdnice编辑器"><span></span><span>说点别的</span><span></span></h2><p data-tool="mdnice编辑器">这个系列到今天一共更新了10篇帖子(9篇<code>2022A</code>，1篇<code>2022B</code>)，前后4个月的跨度，算是更新很慢的了。一方面，学校的事情越来越多，写博客的时间越来越少；另一方面，这些原创度很高的绘图帖子需要我花很多精力整理总结。</p><p data-tool="mdnice编辑器">创作不易，觉得代码有用的话，可以给个三/二/一连（文末<code>点赞</code>、<code>分享</code>、<code>点下小广告</code>）。</p></section><p><img data-ratio="0.3426666666666667" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2axZjuhcBMEdia3TJv1r062wlx6iccn76qHGArtic86bicFB2rzGyGmBalQnmXobKOcmlq7KVf9ZLhtUg/640?wx_fmt=png" data-type="png" data-w="750" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2axZjuhcBMEdia3TJv1r062wlx6iccn76qHGArtic86bicFB2rzGyGmBalQnmXobKOcmlq7KVf9ZLhtUg/640?wx_fmt=png"></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/qQ2-YelFDmQgv6-A4TdXog",target="_blank" rel="noopener noreferrer">原文链接</a>
