---
title: "TCGA泛癌的批量基因相关性分析，快上车吧"
date: 2022-12-13T04:40:26Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
TCGA泛癌的批量基因相关性分析，快上车吧 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>通常在肿瘤研究中，我们会挑出肿瘤的某种表型，然后去看一类基因和这类表型（比如免疫相关基因和血管生成）的相关性，开始一个生物学故事。</p></blockquote><blockquote data-tool="mdnice编辑器"><p>血管生成相关的marker当然不止一个，如果想再探索这群基因在不同肿瘤中的相关性，就要重复很多次换基因、换癌症的操作，颇为费力。想实现对这群基因的批量化分析吗？速速上车吧~</p></blockquote><p data-tool="mdnice编辑器">之前我们是用另外一个包实现的，<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247508084&amp;idx=1&amp;sn=301397b8217dc998e0e5f59f76bccd46&amp;chksm=fa456549cd32ec5f650d9e96148a6ae074ac59b5cf88fa5377c0480ae05ecea5b7123eca95fe&amp;scene=21#wechat_redirect" textvalue="玩转cgdsr之循环批量相关性" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">玩转cgdsr之循环批量相关性</a>，但是这个包11月底被弃用了，┭┮﹏┭┮，它的功能被一个新包继承过来了。</p><p data-tool="mdnice编辑器">这个包大家可以去了解⬇</p><p data-tool="mdnice编辑器">它把每一个肿瘤研究的数据都包装为一个MultiAssayExperiment对象，通过不同的函数可以取到其中的临床表型信息、不同的数据矩阵等等。</p><blockquote data-tool="mdnice编辑器"><p>[cBioPortalData: User Guide https://www.bioconductor.org/packages/release/bioc//vignettes/cBioPortalData/inst/doc/cBioPortalData.html#cbioportaldata-obtain-data-from-the-cbioportal-api)</p></blockquote><pre data-tool="mdnice编辑器"><code><span>if</span> (!<span>require</span>(<span>"BiocManager"</span>, quietly = <span>TRUE</span>))<br>    install.packages(<span>"BiocManager"</span>)<br><br>BiocManager::install(<span>"cBioPortalData"</span>)<br></code></pre><p data-tool="mdnice编辑器">成功安装以后，你可以通过ls函数来了解这个包能调用的函数类型：</p><pre data-tool="mdnice编辑器"><code>&gt; <span>##了解cBioPortalData包下面的函数</span><br>&gt; ls(<span>"package:cBioPortalData"</span>)<br> [<span>1</span>] <span>"allSamples"</span>            <span>"cBioCache"</span>             <span>"cBioDataPack"</span>         <br> [<span>4</span>] <span>"cBioPortal"</span>            <span>"cBioPortalData"</span>        <span>"clinicalData"</span>         <br> [<span>7</span>] <span>"downloadStudy"</span>         <span>"genePanelMolecular"</span>    <span>"genePanels"</span>           <br>[<span>10</span>] <span>"geneTable"</span>             <span>"getDataByGenes"</span>        <span>"getGenePanel"</span>         <br>[<span>13</span>] <span>"getGenePanelMolecular"</span> <span>"getSampleInfo"</span>         <span>"getStudies"</span>           <br>[<span>16</span>] <span>"loadStudy"</span>             <span>"molecularData"</span>         <span>"molecularProfiles"</span>    <br>[<span>19</span>] <span>"mutationData"</span>          <span>"operations"</span>            <span>"queryGeneTable"</span>       <br>[<span>22</span>] <span>"removeDataCache"</span>       <span>"removePackCache"</span>       <span>"sampleLists"</span>          <br>[<span>25</span>] <span>"samplesInSampleLists"</span>  <span>"searchOps"</span>             <span>"setCache"</span>             <br>[<span>28</span>] <span>"untarStudy"</span>     <br></code></pre><p data-tool="mdnice编辑器">先挑几个函数试试看喽~</p><p data-tool="mdnice编辑器">看看通过这个包我们能拿到多少个研究的数据</p><pre data-tool="mdnice编辑器"><code>cbio &lt;- cBioPortal(<br>  hostname = <span>"www.cbioportal.org"</span>,<br>  protocol = <span>"https"</span>,<br>  api. = <span>"/api/api-docs"</span><br>)<br><br>all_TCGA_studies &lt;- getStudies(cbio, buildReport = <span>TRUE</span>)<br>head(all_TCGA_studies)<br>dim(all_TCGA_studies) <br><span># [1] 365  15</span><br><br>all.cancer = all_TCGA_studies[grep(<span>"tcga$"</span>,all_TCGA_studies$studyId),]<span>#筛选出癌症——癌症_tcga这样的形式</span><br>dim(all.cancer) <span>#[1] 32 15</span><br>all.cancer$studyId[<span>1</span>:<span>5</span>]<br><br><span>#得到TCGA癌症列表</span><br>cancer_model = all.cancer$studyId<br>cancer_model<br> [<span>1</span>] <span>"acc_tcga"</span>      <span>"blca_tcga"</span>     <span>"brca_tcga"</span>     <span>"cesc_tcga"</span>    <br> [<span>5</span>] <span>"chol_tcga"</span>     <span>"coadread_tcga"</span> <span>"dlbc_tcga"</span>     <span>"esca_tcga"</span>    <br> [<span>9</span>] <span>"gbm_tcga"</span>      <span>"hnsc_tcga"</span>     <span>"laml_tcga"</span>     <span>"kirc_tcga"</span>    <br>[<span>13</span>] <span>"kich_tcga"</span>     <span>"lgg_tcga"</span>      <span>"lihc_tcga"</span>     <span>"kirp_tcga"</span>    <br>[<span>17</span>] <span>"luad_tcga"</span>     <span>"lusc_tcga"</span>     <span>"meso_tcga"</span>     <span>"ov_tcga"</span>      <br>[<span>21</span>] <span>"paad_tcga"</span>     <span>"pcpg_tcga"</span>     <span>"prad_tcga"</span>     <span>"skcm_tcga"</span>    <br>[<span>25</span>] <span>"sarc_tcga"</span>     <span>"stad_tcga"</span>     <span>"tgct_tcga"</span>     <span>"thym_tcga"</span>    <br>[<span>29</span>] <span>"thca_tcga"</span>     <span>"ucec_tcga"</span>     <span>"ucs_tcga"</span>      <span>"uvm_tcga"</span>  <br></code></pre><p data-tool="mdnice编辑器">然后，我们关心的是每种癌症下面有什么数据</p><pre data-tool="mdnice编辑器"><code>sampleLists(cbio, studyId = <span>"brca_tcga"</span>) <span>##以乳腺癌为例</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.27307692307692305" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib1AO1mOL6VREcQ3H4Vub2ehpDcibhZjBbBjKqsXNYAedWKxJywLtibFRiaGYlJKCkgCr08PGKsX74Gw/640?wx_fmt=png" data-type="png" data-w="1300" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib1AO1mOL6VREcQ3H4Vub2ehpDcibhZjBbBjKqsXNYAedWKxJywLtibFRiaGYlJKCkgCr08PGKsX74Gw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">可以看到有mrna/cna/methylation/rppa等多种类型的数据，基本可以满足数据挖掘的要求吧——</p><p data-tool="mdnice编辑器">如果我想要的是乳腺癌中血管生成相关基因的mrna数据，应该用哪个函数呢？</p><pre data-tool="mdnice编辑器"><code>brca_pub &lt;- cBioPortalData(<br>  api = cbio,<br>  studyId = <span>"brca_tcga"</span>,<br>  genes = c(<span>"VEGFA"</span>,<span>"PIGF"</span>,<span>"MMP2"</span>, <span>"MMP9"</span>, <span>"EGF"</span> ,<span>"bFGF"</span>,<br>            <span>"F4/80"</span>,<span>"iNOS"</span>,<span>"CD86"</span>,<span>"Arg1"</span>,<span>"CD206"</span>), by = <span>"hugoGeneSymbol"</span>,<br>  molecularProfileIds = <span>"brca_tcga_mrna"</span><br>)              <br></code></pre><p data-tool="mdnice编辑器">然后，再灵活运用这几个函数取出对应的信息</p><pre data-tool="mdnice编辑器"><code><span>## Functionality:</span><br><span>##  experiments() - obtain the ExperimentList instance</span><br><span>##  colData() - the primary/phenotype DataFrame</span><br><span>##  sampleMap() - the sample coordination DataFrame</span><br><span>##  `$`, `[`, `[[` - extract colData columns, subset, or experiment</span><br><span>##  *Format() - convert into a long or wide DataFrame</span><br><span>##  assays() - convert ExperimentList to a SimpleList of matrices</span><br><span>##  exportClass() - save data to flat files</span><br></code></pre><p data-tool="mdnice编辑器">到这里，你就能拿到表型数据和mrna数据了，后续的分析就看你啦！</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">接下来是对TCGA癌症列表的批量相关性分析，💪</p><p data-tool="mdnice编辑器">我们可以出多少张图呢，可以这么理解：32(TCGA_tumor)×n1(gene list1)<span>×</span><span>n2(gene list2</span><span>)</span></p><pre data-tool="mdnice编辑器"><code><span>genelist &lt;-  c(</span><span>"VEGFA"</span><span>,</span><span>"PIGF"</span><span>,</span><span>"MMP2"</span><span>, </span><span>"MMP9"</span><span>, </span><span>"EGF"</span><span> ,</span><span>"FGF2"</span><span>,</span><span>"NOS2"</span><span>,</span><br><span>               </span><span>"CD86"</span><span>,</span><span>"ARG1"</span><span>,</span><span>"MRC1"</span><span>)</span></code><code><span>df_list &lt;- list()</span><br></code><code><span>for</span> (i <span>in</span> <span>1</span>:length(cancer_model)) <br>  {<br>  cancer=cancer_model[i]<br>  cancerID &lt;- sampleLists(cbio, studyId = cancer)<br>  datID &lt;-cancerID$sampleListId[cancerID$category==<span>"all_cases_with_mrna_rnaseq_data"</span>] <br>  tmp &lt;- cBioPortalData(api = cbio, by = <span>"hugoGeneSymbol"</span>, studyId = cancer,<br>                        genes =unlist(genelist),<br>                        molecularProfileIds = datID)<br>  temp &lt;- <span>try</span>(assay(tmp[[datID]]),silent=<span>FALSE</span>)<br>  <span>if</span>(class(temp)[<span>1</span>] != <span>'try-error'</span>  ){  <span>##有的肿瘤没有mrna数据，所以要判断一下</span><br>    exp &lt;- assay(tmp[[datID]])<br>    df = na.omit(exp)<br>    range(df)<br>    df=log2(df+<span>1</span>)<br>    range(df)<br>    df1 &lt;- as.data.frame(t(df))<br>    df2 &lt;- df1[substr(rownames(df1),<span>14</span>,<span>15</span>)==<span>"01"</span>,] <span>##取出肿瘤组织样本</span><br>    df_list[[i]] &lt;- df2<br>  }<br>}<br><br>names(df_list) = cancer_model<br>save(df_list,genelist,file = <span>"correlation_output.Rdata"</span>)<br><br></code></pre><p data-tool="mdnice编辑器">这时候我们得到的是上面的一堆基因在32种肿瘤组织中的表达量矩阵,接下来就可以准备画图了。</p><p data-tool="mdnice编辑器">整理一下数据：</p><pre data-tool="mdnice编辑器"><code>rm(list = ls())<br><br>load(<span>"correlation_output.Rdata"</span>)<br><br><span>##调出能用的肿瘤矩阵</span><br><span>library</span>(rlist)<br>cancer_list &lt;-   list.clean(df_list) <span>##清除列表中的null数据</span><br><br><span>##散点图</span><br><span>library</span>(ggstatsplot)<br>genelist<br>Marker &lt;- c(<span>"NOS2"</span>,<span>"ARG1"</span> , <span>"CD86"</span>,<span>"MRC1"</span>) <span>##免疫相关基因</span><br>mygenelist &lt;-  setdiff(genelist,Marker);mygenelist <span>##血管生成相关基因</span><br><br>gene1 &lt;- <span>"NOS2"</span> <span>##这里需要手动换一下基因</span><br><span># gene1 &lt;- "ARG1"</span><br><span># gene1 &lt;- "CD86"</span><br><span># gene1 &lt;- "MRC1"</span><br></code></pre><pre data-tool="mdnice编辑器"><code><span>##接下来是循环的套娃模式</span><br><span>if</span> (<span>T</span>) {<br>plist&lt;-list()<br>fig_list &lt;- list()<br><span>#循环1</span><br><span>for</span> (i <span>in</span> <span>1</span>:length(mygenelist)) {<br>  gene &lt;- mygenelist[i]<br>    <span>##循环2</span><br>  <span>for</span> (j <span>in</span> <span>1</span>:length(cancer_list)) {<br>  cancer &lt;- names(cancer_list[j])<br>  df = cancer_list[[cancer]]<br>    print(<span>"ok"</span>)<br>        p&lt;-ggscatter(df,x=gene1,y=gene,<br>                 size=<span>1</span>, <br>                 rug=<span>T</span>, <br>                 add=<span>"reg.line"</span>,<br>                 point = <span>F</span>, <span>##去掉散点</span><br>                 conf.int=<span>T</span>,<br>                 conf.int.level=<span>0.95</span>,<br>                 cor.coef=<span>T</span>,<br>                 cor.method=<span>"pearson"</span>,<br>                 ggtheme=theme_pubr(),<br>                 title = cancer<br>    )<br>  fig_list[[j]]&lt;-p <span>##所有肿瘤</span><br>  }<br>  plist[[i]] &lt;- fig_list  <span>##所有基因</span><br>}<br></code></pre><p data-tool="mdnice编辑器">最后是可视化的拼图</p><pre data-tool="mdnice编辑器"><code><span>library</span>(cowplot)<br><span>library</span>(egg)<br>mygenelist <span>##"VEGFA" "PIGF"  "MMP2"  "MMP9"  "EGF"   "FGF2" </span><br><span>##批量拼图</span><br>names(plist) &lt;- mygenelist<br>lapply(names(plist), <span>function</span>(gene){<br>  <span># gene &lt;- names(plist)[1]</span><br>  print(gene)<br>  p &lt;- plot_grid(plotlist=plist[[gene]],labels = <span>"AUTO"</span>,<br>            nrow = <span>5</span>,<br>            ncol = <span>6</span>)<br>  ggsave(p,filename = paste0(<span>"../outputs/"</span>,gene1,gene,<span>"_cor.png"</span>),<br>         width = <span>15</span>, height = <span>14</span>, units = <span>'in'</span>, dpi = <span>300</span>)<br>})<br><br>  }<br></code></pre><p data-tool="mdnice编辑器">选两幅看看效果，虽略显冗杂，但可以反映这两个基因在多种肿瘤中的相关性的情况：</p><p data-tool="mdnice编辑器"><strong>NOS2和EGF</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="0.9333333333333333" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib1AO1mOL6VREcQ3H4Vub2eKYkUKcIMicwJN3MohiarJcqPm3otJrMeibWsjo0VtkRv3uEfRSumoDMVw/640?wx_fmt=png" data-type="png" data-w="4500" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib1AO1mOL6VREcQ3H4Vub2eKYkUKcIMicwJN3MohiarJcqPm3otJrMeibWsjo0VtkRv3uEfRSumoDMVw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>NOS2和VEGFA</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="0.9333333333333333" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib1AO1mOL6VREcQ3H4Vub2ey5dRv5Zt0tqv3iatNAo5xQrrcknRIBqQUCT43iaqZB7z84juzMaVwdFg/640?wx_fmt=png" data-type="png" data-w="4500" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib1AO1mOL6VREcQ3H4Vub2ey5dRv5Zt0tqv3iatNAo5xQrrcknRIBqQUCT43iaqZB7z84juzMaVwdFg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">如果你也有感兴趣的两群基因，不妨用这些代码去复现看看~~~~</p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/PsokBpeDIE3rDNbEQ5oXQw",target="_blank" rel="noopener noreferrer">原文链接</a>
