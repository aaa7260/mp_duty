---
title: "如何看两分组单细胞亚群比例差异？"
date: 2022-09-29T05:21:42Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
如何看两分组单细胞亚群比例差异？ by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>本周推文所用的数据集是GSE129516，并对文章的Figure 1D和1H进行复现。</p></blockquote><p data-tool="mdnice编辑器"><strong>文献</strong>：Landscape of Intercellular Crosstalk in Healthy and NASH Liver Revealed by Single-Cell Secretome Gene Analysis. DOI: 10.1016/j.molcel.2019.07.028.</p><figure data-tool="mdnice编辑器"><img data-ratio="0.8469750889679716" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosiciaIB3UUbhoaSzyRIoqrEP2VfQM2GKGXXwrrsywkiaRf5xl4r7SiafURsWroGYn8Kic2YFEQPcrPaNDA/640?wx_fmt=png" data-type="png" data-w="843" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosiciaIB3UUbhoaSzyRIoqrEP2VfQM2GKGXXwrrsywkiaRf5xl4r7SiafURsWroGYn8Kic2YFEQPcrPaNDA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>文章背景：</strong></p><p data-tool="mdnice编辑器">基于2019年的单细胞RNA测序数据对健康小鼠（chow）和非酒精性脂肪肝小鼠（nash）的肝脏非实质细胞进行了分析，揭示了NASH肝脏的单细胞图谱，总共获得了33,168个单细胞转录组(17,788 chow;15380 nash)。其中巨噬细胞是占比最大的免疫细胞群。</p><p data-tool="mdnice编辑器"><strong>小知识：</strong></p><p data-tool="mdnice编辑器">NASH小鼠模型可以分为4类：（1）日粮诱导模型，（2）化学物质诱导模型，（3）基因编辑模型，（4）前面2种，或者3种方法结合在一起的综合模型，这类模型的优点是疾病模型的病理特征最典型和全面。</p><p data-tool="mdnice编辑器">非酒精性脂肪性肝病是一种肝脏中储存过多脂肪的疾病。这种脂肪堆积不是由于大量饮酒引起的，当大量饮酒导致肝脏脂肪堆积时，这种情况称为酒精性肝病。NAFLD有两种类型：单纯性脂肪肝和非酒精性脂肪性肝炎（NASH，nonalcoholic steatohepatitis）。</p><p data-tool="mdnice编辑器"><strong>数据集：GSE129516</strong></p><p data-tool="mdnice编辑器">两个分组：nash 和 chow</p><figure data-tool="mdnice编辑器"><img data-ratio="0.27035175879396983" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosiciaIB3UUbhoaSzyRIoqrEP22r3tty7wrNBwz2NcGp3AzNQWDKfb7fqsZmE5sXfBryiaOianyI15Xe9Q/640?wx_fmt=png" data-type="png" data-w="995" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosiciaIB3UUbhoaSzyRIoqrEP22r3tty7wrNBwz2NcGp3AzNQWDKfb7fqsZmE5sXfBryiaOianyI15Xe9Q/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>要复现的图</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="1.0578512396694215" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosiciaIB3UUbhoaSzyRIoqrEP2sQlGicFHSiaaaPSS7jgFGzsoRy1L3HwiaCVldVvZxvENzsM5PSw9WJzsQ/640?wx_fmt=png" data-type="png" data-w="605" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosiciaIB3UUbhoaSzyRIoqrEP2sQlGicFHSiaaaPSS7jgFGzsoRy1L3HwiaCVldVvZxvENzsM5PSw9WJzsQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>step1：导入QC后的数据以及降维分群</strong></p><pre data-tool="mdnice编辑器"><span></span><code>dir.create(<span>"2-harmony"</span>)<br>getwd()<br>setwd(<span>"2-harmony"</span>)<br><br>sce.all=readRDS(<span>"../1-QC/sce.all_qc.rds"</span>)<br>sce=sce.all.filt <br>sce<br>sce &lt;- NormalizeData(sce, <br>                         normalization.method = <span>"LogNormalize"</span>,<br>                         scale.factor = <span>1e4</span>) <br>sce &lt;- FindVariableFeatures(sce)<br>sce &lt;- ScaleData(sce)<br>sce &lt;- RunPCA(sce, features = VariableFeatures(object = sce))<br><br><span>library</span>(harmony)<br>seuratObj &lt;- RunHarmony(sce, <span>"orig.ident"</span>)<br>names(seuratObj@reductions)<br>seuratObj &lt;- RunUMAP(seuratObj,  dims = <span>1</span>:<span>15</span>, <br>                     reduction = <span>"harmony"</span>)<br>DimPlot(seuratObj,reduction = <span>"umap"</span>,label=<span>T</span> ) <br><br>sce=seuratObj<br>sce &lt;- FindNeighbors(sce, reduction = <span>"harmony"</span>,<br>                     dims = <span>1</span>:<span>15</span>) <br>sce.all=sce<br><br>sce.all=FindClusters(sce.all, <span>#graph.name = "CCA_snn", </span><br>                       resolution = <span>0.5</span>, algorithm = <span>1</span>)<br><span>#接下来分析，按照分辨率为0.5进行 </span><br>sel.clust = <span>"RNA_snn_res.0.5"</span><br>sce.all &lt;- SetIdent(sce.all, value = sel.clust)<br>table(sce.all@active.ident) <br>saveRDS(sce.all, <span>"sce.all_int.rds"</span>)<br>setwd(<span>'../'</span>)<br></code></pre><p data-tool="mdnice编辑器"><strong>step2: 检查常见分群情况</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span>###### 检查常见分群情况  ######</span><br>dir.create(<span>"3-cell"</span>)<br>setwd(<span>"3-cell"</span>)  <br>sce.all=readRDS( <span>"../2-harmony/sce.all_int.rds"</span>)<br><br>DimPlot(sce.all, reduction = <span>"umap"</span>, group.by = <span>"seurat_clusters"</span>,label = <span>T</span>) <br>DimPlot(sce.all, reduction = <span>"umap"</span>, group.by = <span>"RNA_snn_res.0.5"</span>,label = <span>T</span>) <br>ggsave(<span>'umap_by_RNA_snn_res.0.5.pdf'</span>)<br><br><span>library</span>(ggplot2) <br>genes_to_check = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <span>'CD4'</span>,<span>'CD8A'</span>,<span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span> ,<br>                     <span>'IGHG1'</span>, <span>'MZB1'</span>, <span>'SDC1'</span>,<span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>, <br>                     <span>'TPSAB1'</span> , <span>'TPSB2'</span>,  <span># mast cells,</span><br>                   <span>'RCVRN'</span>,<span>'FPR1'</span> , <span>'ITGAM'</span> ,<span>'C1QA'</span>,  <span>'C1QB'</span>,  <span># mac</span><br>                     <span>'S100A9'</span>, <span>'S100A8'</span>, <span>'MMP19'</span>,<span># monocyte</span><br>                     <span>'FCGR3A'</span>,<span>'LAMP3'</span>, <span>'IDO1'</span>,<span>'IDO2'</span>,<span>## DC3 </span><br>                     <span>'CD1E'</span>,<span>'CD1C'</span>, <span># DC2</span><br>                     <span>'KLRB1'</span>,<span>'NCR1'</span>, <span># NK </span><br>                     <span>'FGF7'</span>,<span>'MME'</span>, <span>'ACTA2'</span>, <span>## human  fibo </span><br>                     <span>'DCN'</span>, <span>'LUM'</span>,  <span>'GSN'</span> , <span>## mouse PDAC fibo </span><br>                     <span>'MKI67'</span> , <span>'TOP2A'</span>, <br>                     <span>'PECAM1'</span>, <span>'VWF'</span>,  <span>## endo </span><br>                     <span>'EPCAM'</span> , <span>'KRT19'</span>,<span>'KRT7'</span>, <span># epi </span><br>                     <span>'FYXD2'</span>, <span>'TM4SF4'</span>, <span>'ANXA4'</span>,<span># cholangiocytes</span><br>                     <span>'APOC3'</span>, <span>'FABP1'</span>,  <span>'APOA1'</span>,  <span># hepatocytes</span><br>                     <span>'Serpina1c'</span>,<span>'PROM1'</span>, <span>'ALDH1A1'</span>,<br>                      <span>#文章中的marker gene</span><br>                      <span>'Kdr'</span>,<span>'Tek'</span>,  <span>'Csf1r'</span>, <span>'Ccl5'</span>, <br>                     <span>'Spp1'</span>, <span>'Col1a1'</span>, <span>'Dcn'</span>, <span>'Cd79b'</span>,<br>                     <span>'Stab2'</span>,<span>'Csf1r'</span>,<span>'Cd3g'</span>,<span>'Ebf1'</span>,<span>'Lrf8'</span>,<span>'Sox9'</span>,<br>                     <span>'Apoc3'</span>,<span>'Top2a'</span>,<span>'Johain'</span>,<span>'Dcn'</span><br> )<br>  <span>library</span>(stringr)  <br>  genes_to_check=str_to_title(genes_to_check)<br>  genes_to_check<br>  th=theme(axis.text.x = element_text(angle = <span>45</span>, <br>                                      vjust = <span>0.5</span>, hjust=<span>0.5</span>))  <br>  p &lt;- DotPlot(sce.all, features = unique(unlist(genes_to_check)) ,<br>               assay=<span>'RNA'</span> ,<span>#group.by = 'celltype'</span><br>               )  + coord_flip()  +th<br>  <br>  p<br>  ggsave(plot=p, filename=<span>"check_papermarker_by_seurat_cluster.pdf"</span>,<br>         width = <span>7</span> ,height = <span>10</span>)<br></code></pre><p data-tool="mdnice编辑器"><strong>step3: 细胞注释进行生物学命名</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span>#生物学命名</span><br> celltype=data.frame(ClusterID=<span>0</span>:<span>17</span>,<br>                      celltype= <span>0</span>:<span>17</span>) <br>  <span>#定义细胞亚群  </span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>3</span>,<span>4</span>,<span>5</span>,<span>6</span>,<span>14</span>,<span>16</span>),<span>2</span>]=<span>'Mac(9320)'</span>  <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>15</span>),<span>2</span>]=<span>'HSC(387)'</span>  <br>  <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>1</span>,<span>8</span>),<span>2</span>]=<span>'Tcells(6774)'</span>   <br>  celltype[celltype$ClusterID %<span>in</span>% c(  <span>13</span> ),<span>2</span>]=<span>'dividing cells(528)'</span> <br>  celltype[celltype$ClusterID %<span>in</span>% c(  <span>2</span> ),<span>2</span>]=<span>'CD20+ Bcells (3480)'</span> <br>  celltype[celltype$ClusterID %<span>in</span>% c(  <span>12</span> ),<span>2</span>]=<span>'plasma Bcells(576)'</span> <br>  <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>,<span>7</span>,<span>10</span>,<span>17</span>),<span>2</span>]=<span>'endo(10308)'</span> <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>9</span>),<span>2</span>]=<span>'Chol(10308)'</span>   <br>  <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>11</span> ),<span>2</span>]=<span>'hepatocytes(747)'</span>   <br>  <br>  head(celltype)<br>  celltype<br>  table(celltype$celltype)<br>  sce.all@meta.data$celltype = <span>"NA"</span><br>  <span>for</span>(i <span>in</span> <span>1</span>:nrow(celltype)){<br>    sce.all@meta.data[which(sce.all@meta.data$RNA_snn_res.0.5 == celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]}<br>  table(sce.all@meta.data$celltype)<br><br> <span># genes_to_check与step2的genes_to_check一致。</span><br>  <span>library</span>(stringr)  <br>  genes_to_check=str_to_title(genes_to_check)<br>  genes_to_check<br>  th=theme(axis.text.x = element_text(angle = <span>45</span>, <br>                                      vjust = <span>0.5</span>, hjust=<span>0.5</span>))  <br>  p &lt;- DotPlot(sce.all, features = unique(unlist(genes_to_check)) ,<br>               assay=<span>'RNA'</span> ,group.by = <span>'celltype'</span><br>               )  + coord_flip()  +th<br>  p<br>  ggsave(plot=p, filename=<span>"check_marker_by_celltype.pdf"</span>,width = <span>7</span> ,height = <span>10</span>)<br><span>#可视化</span><br>  <span>library</span>(patchwork)<br>  p_all_markers=DotPlot(sce.all, features = unique(unlist(genes_to_check)),<br>                        assay=<span>'RNA'</span> ,group.by = <span>'celltype'</span> )  + coord_flip()+th<br>  p_umap=DimPlot(sce.all, reduction = <span>"umap"</span>, group.by = <span>"celltype"</span><span>#,label = T</span><br>                 )<br>  p_all_markers+p_umap<br>  ggsave(<span>'markers_umap_by_celltype.pdf'</span>,width = <span>14</span>,height = <span>10</span>)<br> <span># DimPlot(sce.all, reduction = "umap",split.by = 'group',</span><br> <span>#         group.by = "celltype",label = T) </span><br>  <span>#ggsave('group_umap_by_celltype.pdf',width = 15)</span><br>saveRDS(sce.all, <span>"second_sce.all_int.rds"</span>)<br>setwd(<span>'../'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.717564870259481" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosiciaIB3UUbhoaSzyRIoqrEP2qlibHiamtibcTMzvlyibl4ua8dq19MbjQsHheR7rnXm2X8ibOyZkFfI29jg/640?wx_fmt=png" data-type="png" data-w="1002" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosiciaIB3UUbhoaSzyRIoqrEP2qlibHiamtibcTMzvlyibl4ua8dq19MbjQsHheR7rnXm2X8ibOyZkFfI29jg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>step4：两分组单细胞亚群细胞比例差异</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># 1.加载R包 ----</span><br>rm(list=ls()) <br><span>library</span>(ggplot2) <br><span>library</span>(cowplot) <br><span>library</span>(paletteer)  <br><span>library</span>(gplots)<br><span>library</span>(ggpubr)    <br><span>library</span>(ggsci) <br><span>library</span>(stringr)<br><span># 2.设置工作路径 ----</span><br><span>#在meta信息中添加分组信息</span><br>getwd() <br>dir.create(<span>"../4_group"</span>)<br>setwd(<span>"../4_group/"</span>)<br>getwd() <br><span># 3.读取数据 ----</span><br>sce=readRDS(file = <span>'../3-cell/second_sce.all_int.rds'</span>)<br>table(sce@meta.data$orig.ident)<br>table(sce@meta.data$celltype)<br>sce$group=ifelse(grepl(<span>"chow"</span>,sce@meta.data$orig.ident),<span>"chow"</span>,<span>"nash"</span>)<br>table(sce@meta.data$group)<br><br><span>source</span>(<span>"../custom_seurat_functions.R"</span>)<br><br>p1 = plot.clusters.group(data = sce,clusters =  <span>"celltype"</span>, <br>                         xlab = <span>"Celltype"</span>, log = <span>TRUE</span>,<br>                         group = <span>"orig.ident"</span>,legend.title = <span>"Sample"</span>,<br>                         widths = c(<span>3</span>,<span>1</span>),color = <span>2</span>)<br>p1<br>ggsave(<span>"origident_celltype_percent.pdf"</span>,units = <span>"cm"</span>,width = <span>27</span>,height = <span>13</span>)<br><br>p1 = plot.clusters.group(data = sce,clusters =  <span>"celltype"</span>, <br>                         xlab = <span>"Celltype"</span>, log = <span>TRUE</span>,<br>                         group = <span>"group"</span>,legend.title = <span>"Sample"</span>,<br>                         widths = c(<span>3</span>,<span>1</span>),color = <span>2</span>)<br>p1<br>ggsave(<span>"group_celltype_percent.pdf"</span>,units = <span>"cm"</span>,width = <span>27</span>,height = <span>13</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.47106227106227105" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosiciaIB3UUbhoaSzyRIoqrEP2l1ictjdb1WrcxPSG28y9Gbz3lN4zvwrS09LicFstVibTlc8otbdCSeU3g/640?wx_fmt=png" data-type="png" data-w="1365" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosiciaIB3UUbhoaSzyRIoqrEP2l1ictjdb1WrcxPSG28y9Gbz3lN4zvwrS09LicFstVibTlc8otbdCSeU3g/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.4665194996320824" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosiciaIB3UUbhoaSzyRIoqrEP2PicnfYDFJHAZMZDmicmb4o6RBiaVaK7NzBM5icJpBOoiacPuK2Eozyyviaiaw/640?wx_fmt=png" data-type="png" data-w="1359" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosiciaIB3UUbhoaSzyRIoqrEP2PicnfYDFJHAZMZDmicmb4o6RBiaVaK7NzBM5icJpBOoiacPuK2Eozyyviaiaw/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p>从两个分组中细胞分布来看，endo内皮和mac巨噬细胞两分组差异明显。</p><p>在nash发病过程中，肝脏内皮信号网络发生了全面破坏。也说明了nash中的内皮细胞明显减少的原因。而巨噬细胞是存在于我们身体所有器官中的免疫细胞，在nash发病过程中会建立免疫屏障，因此巨噬细胞也相应的明显增多。</p><p>细胞亚群差异符合生物学特征。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span>#在做单细胞百分比柱状堆叠图的时候，在公众号进行搜索，看到这篇推文中的图色彩很好看，一看作者自己封装了函数，我就拿来借用了一下，感谢作者【赵小明777】</span><br><span>source</span>(<span>"../custom_seurat_functions.R"</span>)<br><span>#注意custom_seurat_functions.R存放的路径。</span><br></code></pre><p data-tool="mdnice编辑器">引用：https://mp.weixin.qq.com/s/TQvoj8u-AbXDxKRN3DhwUA</p><p data-tool="mdnice编辑器"><strong>本期推文就到这里啦，感兴趣的可以复现试试。</strong></p></section><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/fBh52PUj8FvNXvgF4YZ1hQ",target="_blank" rel="noopener noreferrer">原文链接</a>
