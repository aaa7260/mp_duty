---
title: "用ggtreeExtra展示细菌的丰度分布"
date: 2022-12-14T00:27:09Z
draft: ["false"]
tags: [
  "fetched",
  "YuLabSMU"
]
categories: ["Acdemic"]
---
用ggtreeExtra展示细菌的丰度分布 by YuLabSMU
------
<div><p data-mpa-powered-by="yiban.io"><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzI5NjUyNzkxMg==&amp;mid=2247486677&amp;idx=1&amp;sn=c9af4ab4642db5e7f3eff04f392be17d&amp;scene=21#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-backh="468" data-backw="578" data-galleryid="" data-ratio="0.8100320170757738" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n7pE3Axz3fhsoBpkoYoBECb3aa3WicR2e6Buibhvf3DbIibMCsjQdNZQNicnzHZCFx0HCAJFh85ldJxQ/640?wx_fmt=png" data-type="png" data-w="937" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n7pE3Axz3fhsoBpkoYoBECb3aa3WicR2e6Buibhvf3DbIibMCsjQdNZQNicnzHZCFx0HCAJFh85ldJxQ/640?wx_fmt=png"></span></a></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzI5NjUyNzkxMg==&amp;mid=2247486677&amp;idx=1&amp;sn=c9af4ab4642db5e7f3eff04f392be17d&amp;scene=21#wechat_redirect" data-linktype="2">2018年MBE文章中的图</a>，这是用<code>ggtree</code>画的，文章中描述的<code>facet_plot</code>以及我们后面又写成图层的<code>geom_facet</code>，这是利用分面来实现不同数据在不同的分面上呈现。</p><p data-tool="mdnice编辑器">这里我们使用用<code>ggtreeExtra</code>来重现它，<code>ggtreeExtra</code>简单点讲，就是提供了一个图层函数<code>geom_fruit</code>来画树相关的数据，它的语法基本上等同于<code>geom_facet</code>，但不利用分面，所以没有分面的一些限制，比如说不能用于极坐标等。</p><h2 data-tool="mdnice编辑器"><span></span>数据</h2><p data-tool="mdnice编辑器">这里其实只是用了<code>phyloseq</code>包里的示例数据而已，所以我们加载这个包，加载数据，然后做点处理。</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(ggtree)<br><span>library</span>(ggplot2)<br><span>library</span>(ggtreeExtra)<br><span>library</span>(patchwork)<br><span>library</span>(ggridges)<br><span>library</span>(phyloseq)<br><br>set.seed(<span>1024</span>)<br><br>data(<span>"GlobalPatterns"</span>)<br>GP &lt;- GlobalPatterns<br><br>GP &lt;- prune_taxa(taxa_sums(GP) &gt; <span>1000</span>, GP)<br><br>sample_data(GP)$human &lt;- get_variable(GP, <span>"SampleType"</span>) %<span>in</span>%<br>  c(<span>"Feces"</span>, <span>"Skin"</span>)<br><br>mergedGP &lt;- merge_samples(GP, <span>"SampleType"</span>)<br>mergedGP &lt;- rarefy_even_depth(mergedGP, rngseed=<span>1024</span>)<br>mergedGP &lt;- tax_glom(mergedGP,<span>"Order"</span>)<br><br>melt_simple &lt;- psmelt(mergedGP) %&gt;%<br>  dplyr::filter(Abundance &lt; <span>120</span>) %&gt;%<br>  dplyr::select(OTU, val=Abundance)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>画树</h2><p data-tool="mdnice编辑器">画树是简单的，用<code>ggtree</code>搞定。</p><pre data-tool="mdnice编辑器"><span></span><code>p &lt;- ggtree(mergedGP, size = 0.3) +<br>     geom_tippoint(<br>         mapping=aes(color = Phylum), <br>         show.legend = FALSE, <br>         size=0.6<br>     )<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>画丰度分布</h2><p data-tool="mdnice编辑器">这时候<code>ggtreeExtra</code>上场了。</p><pre data-tool="mdnice编辑器"><span></span><code>p1 &lt;- p +<br>      geom_fruit(<br>          data = melt_simple,<br>          geom = geom_density_ridges,<br>          mapping = aes(<br>                        y = OTU, <br>                        x = val, <br>                        fill = Phylum<br>                   ),<br>          offset = <span>0.12</span>,<br>          pwidth = <span>0.4</span>,<br>          lwd = <span>.05</span>,<br>          axis.params = list(<br>                            axis = <span>"x"</span>, <br>                            text.size  = <span>1</span>, <br>                            hjust = <span>0.5</span>, <br>                            vjust = <span>1</span><br>                        ),<br>          grid.params = list(),<br>          show.legend = <span>FALSE</span><br>      ) <br></code></pre><p><img data-backh="556" data-backw="558" data-galleryid="" data-ratio="0.9964328180737217" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n7pE3Axz3fhsoBpkoYoBECfUgc2ia05ib8qLDOSEZFbCqToqYKZE5uQHl4TEgtAqHlDBticYgjAGYwQ/640?wx_fmt=png" data-type="png" data-w="841" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n7pE3Axz3fhsoBpkoYoBECfUgc2ia05ib8qLDOSEZFbCqToqYKZE5uQHl4TEgtAqHlDBticYgjAGYwQ/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">正如我在《<a href="https://mp.weixin.qq.com/s?__biz=MzI5NjUyNzkxMg==&amp;mid=2247492454&amp;idx=1&amp;sn=b20c0cbfbb7797fbffa30d283b91bcd2&amp;chksm=ec405221db37db37ae41d078b94ffb547410c5e4c805d693f8aaf4c0f9a763088b81e5852354&amp;token=1356711180&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">ggtreeExtra被严重低估了</a>》一文里说的，你会独立画图，你就会用<code>ggtreeExtra</code>把它和数据画在一起，当然用<code>ggtree::geom_facet</code>也是一样。告诉它<code>geom</code>、<code>data</code>和<code>mapping</code>就OK了，和你单独画一个分布是一样的。而我们的<code>geom_facet</code>和<code>geom_fruit</code>干的话，就是把<code>data</code>重新排序和树匹配，然后把画出来的图放在合适的位置（树的右边或外圈）。你还是用你熟悉的方法，而我们把脏活给干了。其它参数，只是微调一下，你也可以试试不加这些参数来画。</p><p data-tool="mdnice编辑器">我们把<code>geom</code>换成<code>geom_boxplot</code>就可以实现使用箱式图来画：</p><pre data-tool="mdnice编辑器"><span></span><code>p2 &lt;- p +<br>      scale_color_viridis_d() +<br>      geom_fruit(<br>          data = melt_simple,<br>          geom = geom_boxplot,<br>          mapping = aes(<br>                        y = OTU, <br>                        x = val, <br>                        fill = Phylum<br>                   ),<br>          offset = <span>0.12</span>,<br>          pwidth = <span>0.4</span>,<br>          size = <span>0.1</span>,<br>          outlier.size = <span>0.4</span>,<br>          outlier.stroke = <span>0.06</span>,<br>          outlier.shape = <span>21</span>,<br>          axis.params = list(<br>                            axis = <span>"x"</span>, <br>                            text.size = <span>1</span>, <br>                            hjust = <span>0.5</span>, <br>                            vjust = <span>1</span><br>                        ),<br>          grid.params = list(),<br>          show.legend = <span>FALSE</span><br>      ) + scale_fill_viridis_d()<br></code></pre><p><img data-backh="534" data-backw="558" data-galleryid="" data-ratio="0.9573033707865168" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n7pE3Axz3fhsoBpkoYoBECcUiagPsXsVOLT1eZ5o6Hk1dCTYFib9JI5qT1hHwy0nQXaJlAaWIfPqJA/640?wx_fmt=png" data-type="png" data-w="890" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n7pE3Axz3fhsoBpkoYoBECcUiagPsXsVOLT1eZ5o6Hk1dCTYFib9JI5qT1hHwy0nQXaJlAaWIfPqJA/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">用<code>ggtreeExtra</code>的好处在于，它支持极坐标，那么前面画的这两个图，其实我们只需要变换一下坐标轴就可以了。</p><pre data-tool="mdnice编辑器"><span></span><code>p3 &lt;- p1 + layout_circular()<br><br>p4 &lt;- p2 + layout_circular()<br></code></pre><p><img data-galleryid="" data-ratio="0.4728823887873248" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n7pE3Axz3fhsoBpkoYoBEC75QTBL7cu7qicwicRaxnkiaGWVTDDuDW8G1lK2TGFMfrxJ0iajqdnB4n8A/640?wx_fmt=png" data-type="png" data-w="1641" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n7pE3Axz3fhsoBpkoYoBEC75QTBL7cu7qicwicRaxnkiaGWVTDDuDW8G1lK2TGFMfrxJ0iajqdnB4n8A/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">就是这么简单！极坐标在数据多的时候，能够紧凑地把数据呈现出来，再者还能结合弦图，较好地呈现相互作用/关系数据。</p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/5UW4PjfEPswwGHXSlzPx8Q",target="_blank" rel="noopener noreferrer">原文链接</a>
