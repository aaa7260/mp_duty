---
title: "香浓熵值判断你的单细胞亚群是否有样品特异性"
date: 2022-12-03T15:54:28Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
香浓熵值判断你的单细胞亚群是否有样品特异性 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>单个单细胞样品的时代早就结束了，哪怕是稀有物种珍惜样品，也很难说就一个单细胞转录组表达量的降维聚类分群结果的描述就可以发表。</p></blockquote><p data-tool="mdnice编辑器">不过现在有一个取巧的手段， 就是虽然是单个单细胞样品，但是里面可以拆分出来不同的来源，有点类似于混样策略。比如2021年1月发表在cancer research杂志 ： 《Single-Cell Transcriptomic Heterogeneity in Invasive Ductal and Lobular Breast Cancer Cells》， 数据链接是：https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE144320，就只有一个10X样品样本：</p><pre data-tool="mdnice编辑器"><span></span><code>GSM4285803 All_CellLines<br></code></pre><p data-tool="mdnice编辑器">虽然这个单细胞文章仅仅是单个10X样品，但是测了8个不同的癌症细胞系，所以可以根据表达量相似性把细胞来源区分开。还有其它类似的情况是区分性别，以及区分恶性肿瘤上皮细胞和普通正常二倍体细胞。</p><p data-tool="mdnice编辑器">这些算法层面的区分，就面临准确性问题。其实更好的混样，应该是每个样品样独立的标签，然后混合起来作为一个样品去做单细胞，这样就省经费了。</p><p data-tool="mdnice编辑器">当然了，绝大部分科学团队其实并不会缺单细胞测序方面的资金，所以直接上大样品即可，不过多个单细胞样品往往是需要整合啦。我们也给出来了最佳实践，就是harmony流程啦 ：</p><pre data-tool="mdnice编辑器"><span></span><code>sce &lt;- NormalizeData(sce, <br>                         normalization.method = <span>"LogNormalize"</span>,<br>                         scale.factor = <span>1e4</span>) <br>sce &lt;- FindVariableFeatures(sce)<br>sce &lt;- ScaleData(sce)<br>sce &lt;- RunPCA(sce, features = VariableFeatures(object = sce))<br><br><span>library</span>(harmony)<br>seuratObj &lt;- RunHarmony(sce, <span>"orig.ident"</span>)<br>names(seuratObj@reductions)<br>seuratObj &lt;- RunUMAP(seuratObj,  dims = <span>1</span>:<span>15</span>, <br>                     reduction = <span>"harmony"</span>)<br>DimPlot(seuratObj,reduction = <span>"umap"</span>,label=<span>T</span> ) <br><br>sce=seuratObj<br>sce &lt;- FindNeighbors(sce, reduction = <span>"harmony"</span>,<br>                     dims = <span>1</span>:<span>15</span>) <br></code></pre><p data-tool="mdnice编辑器">多个样品整合起来就是为了分群而已，所以恶性的肿瘤上皮细胞往往是不需要整合，因为它具有病人特异性，也就是说每个恶性单细胞亚群都属于具体的某个病人。</p><p data-tool="mdnice编辑器">但是正常单细胞亚群通常是往往是会跨越病人存在，多个病人都有同一个正常单细胞亚群。这样的跨越我很久以前是肉眼看的， 参考：<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247488962&amp;idx=1&amp;sn=07981663c1b632c8c0f2b10f4dc6f14e&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现09—上皮细胞可以区分为恶性与否</a>。可以很明显的看到，第1,2,7,14,21,23,25 是跨越病人的聚类情况，如下所示：</p><p data-tool="mdnice编辑器">其实有一个量化指标，就是香浓熵值（Shannon entropy），我也是最近才看到，比如肺癌的单细胞文章：《Regenerative lineages and immune-mediated pruning in lung cancer metastasis》，就提到了这个Shannon entropy</p><ul data-tool="mdnice编辑器"><li><section>High entropy indicates that a cell state is highly reproducible across patient samples;</section></li><li><section>Low entropy indicates that the cell state is mostly derived from one sample and is patient-specific.</section></li></ul><p data-tool="mdnice编辑器">也就是说 Shannon entropy 是介于 0到1的值，其中越低的Shannon entropy代表这个单细胞亚群越具有样品特异性。公式是：</p><p><img data-galleryid="" data-ratio="0.7950065703022339" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkRj3Yf8fRQok0JTYmOYYImgj2cxIfQovRg79ztn2tuCEYVe4d9Fn7w3Jra1jnho3vBjmBkJUxug/640?wx_fmt=png" data-type="png" data-w="1522" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkRj3Yf8fRQok0JTYmOYYImgj2cxIfQovRg79ztn2tuCEYVe4d9Fn7w3Jra1jnho3vBjmBkJUxug/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>Shannon entropy的公式</figcaption></figure><p data-tool="mdnice编辑器">有了这个Shannon entropy的量化指标，如下所示，可以看到绿色的这个单细胞亚群就是具有病人特异性。</p><p><img data-galleryid="" data-ratio="0.9839228295819936" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkRj3Yf8fRQok0JTYmOYYICxX4lkibGQD0PpPJg1ib6icYWojeEbCVtvBRoW7265Fnm4KX0ho1V4RrQ/640?wx_fmt=png" data-type="png" data-w="622" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkRj3Yf8fRQok0JTYmOYYICxX4lkibGQD0PpPJg1ib6icYWojeEbCVtvBRoW7265Fnm4KX0ho1V4RrQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>绿色的这个单细胞亚群就是具有病人特异性</figcaption></figure><p data-tool="mdnice编辑器">有没有发现，其实它就是展现了不同单细胞亚群在不同样品的比例而已。</p><p data-tool="mdnice编辑器">#　信息熵的4个量化指标的R代码实现</p><blockquote data-tool="mdnice编辑器"><p>熵（entropy）在统计学中是一个很重要的概念，代表着信息的多少。经济学里面衡量贫富差距的基尼系数，以及环境生物学领域衡量物种多样性的辛普森多样性指数，以及免疫组库领域的D50都有异曲同工之妙。</p></blockquote><p data-tool="mdnice编辑器">基尼系数距离普通人的生活最近，通俗一点来理解：</p><ul data-tool="mdnice编辑器"><li><section><p>比如有10个人，他们的月薪都是2万，那么这10个人组成的小团体的基尼系数就是0，说明没有贫富差距</p></section></li><li><section><p>如果他们的月薪都是3万，基尼系数也仍然是0 ，因为大家都一样。</p></section></li><li><section><p>但是如果他们的收入是1到10，每个人不一样，那么这个小团体的基尼系数就是0.3</p></section></li><li><section><p>如果前面的9个人是1到9万的收入，但是最后一个月不是10万，而是100万，<strong>这个小团体的基尼系数就是0.67</strong></p></section></li><li><section><p>如果最后那个人是1个亿，基尼系数就会接近于1。</p></section></li></ul><p data-tool="mdnice编辑器">使用R代码，模拟这样的10个人小团体：</p><pre data-tool="mdnice编辑器"><span></span><code>n=<span>3</span><br>a=rep(n,<span>10</span>)<br>b1=a/sum(a)<br>b1 <span># 首先每个人的收入都是3万</span><br>plot(cumsum(b1),type = <span>'l'</span>)<br>a=<span>1</span>:<span>10</span><br>a=sort(a)<br>b2=a/sum(a)<br>b2 <span>## 然后每个人的收入都不一样，相差一万</span><br>points(cumsum(b2),type = <span>'l'</span>)<br>a=c(<span>1</span>:<span>9</span>,<span>100</span>)<br>a=sort(a)<br>b3=a/sum(a)<br>b3 <span># 最后，假定其中一个人收入是100万，遥遥领先剩余的9个人</span><br>points(cumsum(b3),type = <span>'l'</span>)<br><br>y1=as.numeric(table(b1)/length(b1))<br>y2=as.numeric(table(b2)/length(b2))<br>y3=as.numeric(table(b3)/length(b3))<br></code></pre><p data-tool="mdnice编辑器">如下所示：</p><p><img data-galleryid="" data-ratio="0.48356164383561645" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkRj3Yf8fRQok0JTYmOYYIMayeed5Dg2s6wzh7uW5NHcq4E9Rc2FI5ZH74T0JEFh7btQngqDiaQFw/640?wx_fmt=png" data-type="png" data-w="1460" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkRj3Yf8fRQok0JTYmOYYIMayeed5Dg2s6wzh7uW5NHcq4E9Rc2FI5ZH74T0JEFh7btQngqDiaQFw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>10个人小团体</figcaption></figure><p data-tool="mdnice编辑器">在上图中，10个人，按照收入排序（升序）后，收入累积的占比。</p><p data-tool="mdnice编辑器">那么，亲爱的读者，你可以猜测一下，我们中国的代表贫富差距的基尼系数是多少？</p><p data-tool="mdnice编辑器">国际惯例把0.2以下视为收入绝对平均；0.2-0.3视为收入比较平均；0.3-0.4视为收入相对合理；0.4-0.5视为收入差距较大；当基尼系数达到0.5以上时，则表示收入悬殊。</p><h3 data-tool="mdnice编辑器"><span></span><span>香农信息熵</span><span></span></h3><p data-tool="mdnice编辑器">同样的10个人，同样的月薪都是2万，信息熵就是0，同样的，每个人的收入如果是3万，也不会影响信息熵就是0这个结论。但是如果10个人的收入是1到10万这10种情况，这10个人的信息熵就很大了，是3.32，但是这10个人的<strong>收入多少并不影响信息熵的结果</strong>，无论是否有一个人收入高达百万或者过亿，这个信息熵都是3.32，代表着这10个人的小团体很不一样。</p><p data-tool="mdnice编辑器"><strong>所以信息熵并不能用来衡量贫富差距哦。</strong>有意思的是，如果10个人变成了100个人，同样的收入都不一样，这个时候的信息熵是6.64，也就是说<strong>信息熵居然是跟人数有关哦</strong>。但是有一个矫正后的香农信息熵，可以抹去人数的影响，代码如下：</p><p data-tool="mdnice编辑器">R代码函数如下：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 默认x 是一个群体的,每个人的收入,数值组成的向量</span><br>shannon.entropy &lt;-<span>function</span>(x,type=<span>'raw'</span>){<br> <span>if</span>(type==<span>'raw'</span>){<br>   myfreqs &lt;- table(x)/length(x) <br>   myvec &lt;- as.data.frame(myfreqs)[,<span>2</span>]<br> }<span>else</span>{<br>   myvec=x<br> }<br>  -sum(myvec * log2(myvec))<br>}<br>metric.entropy &lt;-<span>function</span>(x,type=<span>'raw'</span>){<br>  <span>if</span>(type==<span>'raw'</span>){<br>    myfreqs &lt;- table(x)/length(x) <br>    myvec &lt;- as.data.frame(myfreqs)[,<span>2</span>]<br>  }<span>else</span>{<br>    myvec=x<br>  }<br>  -sum(myvec * log(myvec,length(x)))<br>}<br><span>## modify shannon.entropy to metric entropy</span><br> <br></code></pre><p data-tool="mdnice编辑器">其中shannon.entropy函数其范围0&lt;=I(x)&lt;=1,符合直观感受。</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; shannon.entropy(b1)<br>[1] 0<br>&gt; shannon.entropy(b2)<br>[1] 3.321928<br>&gt; shannon.entropy(b3)<br>[1] 3.321928<br>&gt; <br>&gt; metric.entropy(b1)<br>[1] 0<br>&gt; metric.entropy(b2)<br>[1] 1<br>&gt; metric.entropy(b3)<br>[1] 1<br></code></pre><p data-tool="mdnice编辑器">也就是说，如果shannon.entropy接近于0，代表信息量很少，接近于1代表信息量大。</p><h3 data-tool="mdnice编辑器"><span></span><span>辛普森指数</span><span></span></h3><p data-tool="mdnice编辑器">辛普森多样性指数(Simpson index)，描述从一个群落种<strong>连续两次抽样所得到的个体数属于同一种的概率</strong>。</p><p data-tool="mdnice编辑器">其公式如下：D=1-∑(Ni(Ni-1))/(N(N-1))，其中Ni为群落中第i种的个体数，N为群落中所有种的个体数。</p><p data-tool="mdnice编辑器">如群落A，有甲99个，乙1个；群落B，有甲50个，乙50个；易得前者辛普森多样性指数=0.0198，后者希普森多样性指数=0.5000。也就是说辛普森指数越大，物种<strong>多样性越丰富</strong>，但辛普森指数最大不超过1。</p><p data-tool="mdnice编辑器">R代码函数如下：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 默认x 是一个群体的,每个人的收入,数值组成的向量</span><br>Simpson.index &lt;-<span>function</span>(x,type=<span>'raw'</span>){<br>  <span>if</span>(type==<span>'raw'</span>){<br>    myfreqs &lt;- table(x)/length(x) <br>    myvec &lt;- as.data.frame(myfreqs)[,<span>2</span>]<br>  }<span>else</span>{<br>    myvec=x<br>  }<br>  -sum(myvec * log(myvec,length(x)))<br>  <span>1</span>-sum( myvec ^<span>2</span>)<br>}<br><br></code></pre><p data-tool="mdnice编辑器">结果如下：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; Simpson.index(b1)<br>[1] 0<br>&gt; Simpson.index(b2)<br>[1] 0.9<br>&gt; Simpson.index(b3)<br>[1] 0.9<br>&gt; Simpson.index(1:100)<br>[1] 0.99<br>&gt; Simpson.index(1:1000)<br>[1] 0.999<br></code></pre><p data-tool="mdnice编辑器">值得注意的是<strong>辛普森多样性指数和香农信息熵都不关心具体每个人的收入多少</strong>，只统计各种收入数值情况在人群出现的频率进行各自公式计算即可。</p><h3 data-tool="mdnice编辑器"><span></span><span>GINI系数</span><span></span></h3><p data-tool="mdnice编辑器">基尼系数是本来是一个国际通用的经济学概念，用来衡量贫富差距。基尼系数介于0-1之间，基尼系数越大，表示不平等程度越高。</p><ul data-tool="mdnice编辑器"><li><section>基尼系数最大为1，表示居民之间的收入分配绝对不平均，即100%的收入被一个单位的人全部占有了；</section></li><li><section>基尼系数最小为0，表示居民之间的收入分配绝对平均，即人与人之间收入完全平等，没有任容何差异。</section></li></ul><p data-tool="mdnice编辑器">假定一定数量的人口按收入<strong>由低到高顺序排队</strong>，分为人数相等的n组，从第1组到第i组人口累计收入占全部人口总收入的比重</p><p><img data-galleryid="" data-ratio="0.39545454545454545" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkRj3Yf8fRQok0JTYmOYYIaicmibq2pS2XqKfnWtnGUvibanWvficH8Xhiat1pONIXd1dlLnRPaWlsN8A/640?wx_fmt=png" data-type="png" data-w="440" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkRj3Yf8fRQok0JTYmOYYIaicmibq2pS2XqKfnWtnGUvibanWvficH8Xhiat1pONIXd1dlLnRPaWlsN8A/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>GINI系数简化公式</figcaption></figure><p data-tool="mdnice编辑器">该公式是利用定积分的定义将<strong>对洛伦茨曲线的积分(面积B)分成n个等高梯形的面积之和得到的</strong>。（看不懂没有关系哈）</p><p data-tool="mdnice编辑器">R代码函数实现如下：</p><pre data-tool="mdnice编辑器"><span></span><code>gini.index  &lt;-<span>function</span>(x){ <br>  x &lt;- sort(x)  <br>  G &lt;- sum(x * <span>1L</span>:length(x)) <br>  G &lt;- <span>2</span> * G/sum(x) - (length(x) + <span>1L</span>)<br>  G/length(x)<br>}<br>&gt; gini.index(b1)<br>[<span>1</span>] <span>0</span><br>&gt; gini.index(b2)<br>[<span>1</span>] <span>0.3</span><br>&gt; gini.index(b3)<br>[<span>1</span>] <span>0.6724138</span><br></code></pre><p data-tool="mdnice编辑器">值得注意的是，基尼系数越下，代表收入越平均，可以理解为多样性越好！</p><p data-tool="mdnice编辑器">而且基尼系数关心具体每个人的收入情况，换一种说法就是<strong>基尼系数与辛普森多样性指数和香农信息熵的输入数据形式其实是不一样的</strong>：</p><ul data-tool="mdnice编辑器"><li><section>输入1和2这两个数，来计算香农信息熵结果是1，辛普森多样性指数是0.5；</section></li><li><section>但是对基尼系数来说，输入1和2这两个数，实际上相当于<strong>输入了1个a和2个b，就是3个元素</strong>。</section></li></ul><h3 data-tool="mdnice编辑器"><span></span><span>韩健首创的免疫组库多样性D50</span><span></span></h3><p data-tool="mdnice编辑器">这个D50其实就是饱和度曲线里面的达到50%饱和度，据韩健说是他第一次应用到免疫组库领域。把所有<strong>CDR3序列</strong>（元素）按照占比比例排序，<strong>从最高往最低累加</strong>，达到50%的总序列时候的CDR3序列种类比例，就是类似于饱和度曲线。</p><ul data-tool="mdnice编辑器"><li><section>D50最大为0.5，意味着全部的CDR3序列占比一致，多样性好；</section></li><li><section>D50最小为0，意味着有且只有一种CDR3序列，多样性差。</section></li></ul><p data-tool="mdnice编辑器">R代码函数如下：</p><pre data-tool="mdnice编辑器"><span></span><code>d50.index &lt;-<span>function</span>(x,type=<span>'raw'</span>){<br>  <span>if</span>(type==<span>'raw'</span>){<br>    myfreqs &lt;- table(x)/length(x) <br>    myvec &lt;- sort(as.numeric(myfreqs),decreasing = <span>T</span>)<br>  }<span>else</span>{<br>    myvec=sort(x,decreasing = <span>T</span>)<br>  }<br>  len=length(myvec)<br>  state=cumsum(myvec)&gt;sum(myvec)/<span>2</span>  <br>  (len -sum(state))/len <span># </span><br>}<br><br></code></pre><p data-tool="mdnice编辑器">结果如下：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; d50.index(b1)<br>[1] 0<br>&gt; d50.index(b2)<br>[1] 0.5<br>&gt; d50.index(b3)<br>[1] 0.5<br><br>&gt; d50.index(1:100)<br>[1] 0.5<br>&gt; d50.index(1:1000)<br>[1] 0.5<br>&gt; d50.index(c(1,2,2,2,3,4))<br>[1] 0.25<br></code></pre><p data-tool="mdnice编辑器">值得注意的是免疫组库多样性D50上限是0.5，因为这个时候<strong>人群收入的递减排序</strong>，不可能一半的高收入群体居然还达不到全部人群的一半的收入。通常情况是，1%的人就占社会收入的一半了，所以D50通常是0.01甚至更小值。</p><h3 data-tool="mdnice编辑器"><span></span><span>总结</span><span></span></h3><p data-tool="mdnice编辑器">上面我写的4个公式里面只有基尼系数计算必须输入的是数值，或者把非数值变量取频数后再进行计算。而且仅仅是<strong>只有基尼系数是越大，贫富差距越大，多样性越差</strong>。其它的数值都是越小多样性越差。</p><p data-tool="mdnice编辑器">其实，聪明的你，这个时候应该是可以做出来一个总结表格。</p></section><h3 data-tool="mdnice编辑器"><span>写在文末</span></h3><p data-tool="mdnice编辑器">我在《生信技能树》，《生信菜鸟团》，《单细胞天地》的大量推文教程里面共享的代码都是复制粘贴即可使用的， 有任何疑问欢迎留言讨论，也可以发邮件给我，详细描述你遇到的困难的前因后果给我，我的邮箱地址是 jmzeng1314@163.com</p><p data-tool="mdnice编辑器">如果你确实觉得我的教程对你的科研课题有帮助，让你茅塞顿开，或者说你的课题大量使用我的技能，烦请日后在发表自己的成果的时候，加上一个简短的致谢，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>We thank Dr.Jianming Zeng(University of Macau), and all the members of his bioinformatics team, biotrainee, <span>for</span> generously sharing their experience and codes.</code></pre><p data-tool="mdnice编辑器">十年后我环游世界各地的高校以及科研院所（当然包括中国大陆）的时候，如果有这样的情谊，我会优先见你。<span></span></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/W_u3XhgJsSfl4K4sEuxCLA",target="_blank" rel="noopener noreferrer">原文链接</a>
