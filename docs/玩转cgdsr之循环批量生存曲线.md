---
title: "玩转cgdsr之循环批量生存曲线"
date: 2022-10-31T05:13:43Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
玩转cgdsr之循环批量生存曲线 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">之前cgdsr的介绍见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486492&amp;idx=1&amp;sn=3a7251244377fdd4b2a3aa5c8cd1131a&amp;scene=21#wechat_redirect" data-linktype="2">使用R语言的cgdsr包获取TCGA数据</a>、<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247512167&amp;idx=1&amp;sn=bae9c82a4c4cbd266c9fce747885e6ed&amp;scene=21#wechat_redirect" data-linktype="2">通过R包cgdsr链接cbioportal来探索TCGA等公共数据</a>，这次我们用它来探索各类肿瘤不同临床特征（临床分期、性别、年龄）的预后（生存曲线）。</p><h4 data-tool="mdnice编辑器"><span></span>准备工作<span></span></h4><h5 data-tool="mdnice编辑器"><span></span>安装包<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span>#设置</span><br>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(data.table)<br><span>library</span>(dplyr)<br><span>library</span>(survminer) <br><span>library</span>(survival)<br><span>library</span>(loose.rock)<br><span>library</span>(futile.logger) <br><span>library</span>(glmSparseNet)<br><span>library</span>(ggrisk)  <br><span>library</span>(pheatmap) <br><span>library</span>(ggplot2)<br><span>library</span>(ggsci)<br><span>library</span>(ggstatsplot)<br><span>library</span>(DT) <br><span>library</span>(RCurl) <br><br><span>#cgdsr包，由于它挺久没更新了，cran和bioconductor的安装方式装不上，我们用install_github安装</span><br><span># BiocManager::install("cgdsr") </span><br><span># install.packages ("cgdsr")   </span><br>setRepositories(ind=<span>1</span>:<span>6</span>)<br>options(repos=<span>"http://cran.rstudio.com/"</span>)<br><span>if</span>(!<span>require</span>(devtools)) { install.packages(<span>"devtools"</span>) }<br><span>library</span>(devtools) <br><span>#install_github("cBioPortal/cgdsr")</span><br><span>library</span>(cgdsr)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>准备数据<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># Get list of cancer studies at server ## 获取有哪些文献</span><br>mycgds &lt;- CGDS(<span>"https://www.cbioportal.org/"</span>) <span>#设置好网站</span><br>test(mycgds)<br><br><span>#研究的那些文献和癌症</span><br>all_TCGA_studies &lt;- getCancerStudies(mycgds)<br>all_TCGA_studies[<span>1</span>:<span>3</span>, <span>1</span>:<span>2</span>]<br><span>#      cancer_study_id                                                       name</span><br><span>#1       paac_jhu_2014 Acinar Cell Carcinoma of the Pancreas (JHU, J Pathol 2014)</span><br><span>#2 mel_tsam_liang_2017                     Acral Melanoma (TGEN, Genome Res 2017)</span><br><span>#3     all_stjude_2015     Acute Lymphoblastic Leukemia (St Jude, Nat Genet 2015)</span><br><br><span>#筛选出癌症，构成 癌症_tcga 这样的形式</span><br>all.cancer = all_TCGA_studies[grep(<span>"tcga$"</span>,all_TCGA_studies$cancer_study_id),]<br>dim(all.cancer)<br><span>#[1] 32  3</span><br>all.cancer$cancer_study_id[<span>1</span>:<span>4</span>]<br><span>#[1] "laml_tcga" "acc_tcga"  "blca_tcga" "lgg_tcga" </span><br>cancer_model = all.cancer$cancer_study_id<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>循环画生存曲线<span></span></h4><p data-tool="mdnice编辑器">把同一类型的生存曲线，画在同一张图上，这样更加容易看。</p><h5 data-tool="mdnice编辑器"><span></span>临床分期的批量生存曲线<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span>#  lapply km plot----</span><br>model_list &lt;- lapply(cancer_model, <span>function</span>(i){<br>  <span>#  i = cancer_model[9]</span><br>  all_tables &lt;- getCaseLists(mycgds, i) <span>#查询指定文献里面的样品列表信息有哪些</span><br>  cg_table &lt;-  all_tables[<span>1</span>,<span>1</span>]<br>  cg_table <br>  clinicaldata &lt;- getClinicalData(mycgds, cg_table)<br>  <br>  <span>#临床分期的列名，并不是固定的，有一些有 "AJCC_CLINICAL_TUMOR_STAGE" "AJCC_PATHOLOGIC_TUMOR_STAGE"</span><br>  <span>#两种分期数据,所以要做一个判断</span><br>  stage.name = <span>"AJCC_PATHOLOGIC_TUMOR_STAGE"</span><br>  <span>if</span> (stage.name %<span>in</span>% colnames(clinicaldata)) {<br>    <br>    <span>#构造phe</span><br>    phe=clinicaldata[,c(<span>'OS_MONTHS'</span>,<span>'OS_STATUS'</span>,<span>"AJCC_PATHOLOGIC_TUMOR_STAGE"</span>)] <br>    colnames(phe) = c(<span>"time"</span>,<span>"event"</span>,<span>"cluster"</span>)<br>    <br>    <span>#有一些并没有分期数据的</span><br>    phe=phe[phe$cluster != <span>''</span>,] <br>    phe = na.omit(phe)<br>    <br>    <span>#I、II分型就好，不再细分ABC，所以把ABC去掉</span><br>    phe$cluster = gsub(<span>'A'</span>,<span>''</span>,phe$cluster) <br>    phe$cluster = gsub(<span>'B'</span>,<span>''</span>,phe$cluster)<br>    phe$cluster = gsub(<span>'C'</span>,<span>''</span>,phe$cluster)<br>    table(phe$cluster)<br>    <br>    phe$time = phe$time/<span>12</span><br>    kp &lt;- phe$time &gt;<span>0</span><br>    phe &lt;- phe[kp,]<br>    phe$event = as.numeric( substr(phe$event,<span>1</span>,<span>1</span>)) <br>    <br>    sfit &lt;- survfit(Surv(time, event)~cluster, data=phe)<br>    summary(sfit)<br>    survp = ggsurvplot(sfit,data = phe, <span>#这里很关键，不然会报错</span><br>                       legend.title = i, <span>#定义图例的名称 </span><br>                       <span># legend = "top",#图例位置</span><br>                       <span># legend.labs = c('High', 'Low'),</span><br>                       pval = <span>T</span>, <span>#在图上添加log rank检验的p值</span><br>                       <span># pval.method = TRUE,#添加p值的检验方法</span><br>                       risk.table = <span>TRUE</span>, <br>                       risk.table.y.text = <span>F</span>,<br>                       xlab = <span>"Time in years"</span>, <span>#x轴标题</span><br>                       <span># xlim = c(0, 10), #展示x轴的范围</span><br>                       break.time.by = <span>1</span>, <span>#x轴间隔</span><br>                       size = <span>1.5</span>, <span>#线条大小</span><br>                       ggtheme = theme_ggstatsplot(),<br>                       palette=<span>"nejm"</span>, <span>#配色</span><br>    )<br>    <span>return</span>(survp)               <br>  }<br>  <br>  <br>}) <br><span>#这个函数跑的比较慢</span><br><span>#print(model_list)</span><br>model_list = model_list[-which(sapply(model_list, is.null))] <span>#去除NULL的元素</span><br>length(model_list)<br><br>x=<span>3</span>;y=<span>7</span><br>all_plot &lt;- arrange_ggsurvplots(model_list,print = <span>F</span>,ncol =x, nrow = y,<br>                                risk.table.height = <span>0.3</span>,<br>                                surv.plot.height = <span>0.7</span>)<br><span># all_plot  </span><br>x=<span>30</span>;y=<span>20</span>  <span>#x是纵轴，y才是横轴</span><br>ggsave(all_plot,filename = <span>'01-survival-Clinical//stage_KM1.pdf'</span> ,<br>       height = x, width = y )<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6439406567761293" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9sTZWuvz2pYqKpiaf9m9tWtiabrEUTqOc58iaTfTdQOYloRj3JZsZH19oOYaodtWyYcKGshz5RgNyA/640?wx_fmt=png" data-type="png" data-w="5999" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9sTZWuvz2pYqKpiaf9m9tWtiabrEUTqOc58iaTfTdQOYloRj3JZsZH19oOYaodtWyYcKGshz5RgNyA/640?wx_fmt=png"><img data-ratio="0.8566427737956326" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9sTZWuvz2pYqKpiaf9m9tWZpfGgHFpQsKiahmK3JUymf5TzICfb8bI1vRZ6lUaCSZDUyRkR99vSsQ/640?wx_fmt=png" data-type="png" data-w="5999" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9sTZWuvz2pYqKpiaf9m9tWZpfGgHFpQsKiahmK3JUymf5TzICfb8bI1vRZ6lUaCSZDUyRkR99vSsQ/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">能够被分期分开的癌症要多一些，因为分期本身和生存的关联性比较大。</p><h5 data-tool="mdnice编辑器"><span></span>性别的批量生存曲线<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 2. lapply km plot----</span><br>model_list &lt;- lapply(cancer_model, <span>function</span>(i){<br>  <span>#  i = cancer_model[6]</span><br>  all_tables &lt;- getCaseLists(mycgds, i) <span>#查询指定文献里面的样品列表信息有哪些</span><br>  cg_table &lt;-  all_tables[<span>1</span>,<span>1</span>]<br>  cg_table <br>  clinicaldata &lt;- getClinicalData(mycgds, cg_table)<br>  phe=clinicaldata[,c(<span>'OS_MONTHS'</span>,<span>'OS_STATUS'</span>,<span>'SEX'</span>)]<br>  colnames(phe) = c(<span>"time"</span>,<span>"event"</span>,<span>"cluster"</span>)<br>  phe$time = phe$time/<span>12</span><br>  kp &lt;- phe$time &gt;<span>0</span><br>  phe &lt;- phe[kp,]<br>  phe$event = as.numeric( substr(phe$event,<span>1</span>,<span>1</span>)) <br>  table(phe$cluster)<br>  <br>  sfit &lt;- survfit(Surv(time, event)~cluster, data=phe)<br>  summary(sfit)<br>  survp = ggsurvplot(sfit,data = phe, <span>#这里很关键，不然会报错</span><br>                     legend.title = i, <span>#定义图例的名称 </span><br>                     <span># legend = "top",#图例位置</span><br>                     <span># legend.labs = c('High', 'Low'),</span><br>                     pval = <span>T</span>, <span>#在图上添加log rank检验的p值</span><br>                     <span># pval.method = TRUE,#添加p值的检验方法</span><br>                     risk.table = <span>TRUE</span>, <br>                     risk.table.y.text = <span>F</span>,<br>                     xlab = <span>"Time in years"</span>, <span>#x轴标题</span><br>                     <span># xlim = c(0, 10), #展示x轴的范围</span><br>                     break.time.by = <span>1</span>, <span>#x轴间隔</span><br>                     size = <span>1.5</span>, <span>#线条大小</span><br>                     ggtheme = theme_ggstatsplot(),<br>                     palette=<span>"nejm"</span>, <span>#配色</span><br>  )<br>  <span>return</span>(survp)               <br>}) <br><span>#这个函数跑的比较慢</span><br><span>#print(model_list)</span><br>x=<span>3</span>;y=<span>11</span><br>all_plot &lt;- arrange_ggsurvplots(model_list,print = <span>F</span>,ncol =x, nrow = y,<br>                                risk.table.height = <span>0.3</span>,<br>                                surv.plot.height = <span>0.7</span>)<br><span># all_plot  </span><br>x=<span>40</span>;y=<span>20</span>  <span>#x是纵轴，y才是横轴</span><br>ggsave(all_plot,filename = <span>'01-survival-Clinical//SEX_KM1.pdf'</span> ,<br>       height = x, width = y )<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.9078333333333334" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9sTZWuvz2pYqKpiaf9m9tWHTcHUrM5nRLFw0lYNSFtjgAs8mPy1wlNXwsdN5sL0TvfRrDlfwyjkg/640?wx_fmt=png" data-type="png" data-w="6000" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9sTZWuvz2pYqKpiaf9m9tWHTcHUrM5nRLFw0lYNSFtjgAs8mPy1wlNXwsdN5sL0TvfRrDlfwyjkg/640?wx_fmt=png"><img data-ratio="1.0898333333333334" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9sTZWuvz2pYqKpiaf9m9tWFj0ibIUt0EpwDwHe2YzghnIpZh42JbBbqF14VW898ysbYRcSZ0j4icAg/640?wx_fmt=png" data-type="png" data-w="6000" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9sTZWuvz2pYqKpiaf9m9tWFj0ibIUt0EpwDwHe2YzghnIpZh42JbBbqF14VW898ysbYRcSZ0j4icAg/640?wx_fmt=png"></p><h5 data-tool="mdnice编辑器"><span></span>年龄的批量生存曲线<span></span></h5><p data-tool="mdnice编辑器">以中位数为标准，分了年轻和年老两组。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 2. lapply km plot----</span><br>model_list &lt;- lapply(cancer_model, <span>function</span>(i){<br>   <span># i = cancer_model[6]</span><br>  all_tables &lt;- getCaseLists(mycgds, i)<br>  cg_table &lt;-  all_tables[<span>1</span>,<span>1</span>]<br>  cg_table <br>  clinicaldata &lt;- getClinicalData(mycgds, cg_table)<br>  phe=clinicaldata[,c(<span>'OS_MONTHS'</span>,<span>'OS_STATUS'</span>,<span>'AGE'</span>)]<br>  AGE = as.numeric(phe[,<span>3</span>])<br>  phe$cluster = ifelse(AGE &gt; median(AGE,na.rm = <span>TRUE</span>),<span>'old'</span>,<span>'youth'</span>)<br>  colnames(phe) = c(<span>"time"</span>,<span>"event"</span>,<span>"age"</span>,<span>"cluster"</span>)<br>  <br>  phe$time = phe$time/<span>12</span><br>  kp &lt;- phe$time &gt;<span>0</span><br>  phe &lt;- phe[kp,]<br>  phe$event = as.numeric( substr(phe$event,<span>1</span>,<span>1</span>)) <br>  table(phe$cluster)<br>  <br>  sfit &lt;- survfit(Surv(time, event)~cluster, data=phe)<br>  summary(sfit)<br>  survp = ggsurvplot(sfit,data = phe, <span>#这里很关键，不然会报错</span><br>                     legend.title = i, <span>#定义图例的名称 </span><br>                     <span># legend = "top",#图例位置</span><br>                     <span># legend.labs = c('High', 'Low'),</span><br>                     pval = <span>T</span>, <span>#在图上添加log rank检验的p值</span><br>                     <span># pval.method = TRUE,#添加p值的检验方法</span><br>                     risk.table = <span>TRUE</span>, <br>                     risk.table.y.text = <span>F</span>,<br>                     xlab = <span>"Time in years"</span>, <span>#x轴标题</span><br>                     <span># xlim = c(0, 10), #展示x轴的范围</span><br>                     break.time.by = <span>1</span>, <span>#x轴间隔</span><br>                     size = <span>1.5</span>, <span>#线条大小</span><br>                     ggtheme = theme_ggstatsplot(),<br>                     palette=<span>"nejm"</span>, <span>#配色</span><br>  )<br>  <span>return</span>(survp)               <br>}) <br><span>#这个函数跑的比较慢</span><br><span>#print(model_list)</span><br><br>x=<span>3</span>;y=<span>11</span><br>all_plot &lt;- arrange_ggsurvplots(model_list,print = <span>F</span>,ncol =x, nrow = y,<br>                                risk.table.height = <span>0.3</span>,<br>                                surv.plot.height = <span>0.7</span>)<br><span># all_plot  </span><br>x=<span>40</span>;y=<span>20</span>  <span>#x是纵轴，y才是横轴</span><br>ggsave(all_plot,filename = <span>'01-survival-Clinical//age_KM1.pdf'</span> ,<br>       height = x, width = y )<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.9055" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9sTZWuvz2pYqKpiaf9m9tWyJ9zT0gCn3FaZcJveBAYFZW3GegcNiaxxpcbzGcd9ibDHJ0oia2GIyxxA/640?wx_fmt=png" data-type="png" data-w="6000" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9sTZWuvz2pYqKpiaf9m9tWyJ9zT0gCn3FaZcJveBAYFZW3GegcNiaxxpcbzGcd9ibDHJ0oia2GIyxxA/640?wx_fmt=png"><img data-ratio="1.0881813635605935" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9sTZWuvz2pYqKpiaf9m9tWd2OMsXib1fIxO3PtTMXGS3x7Ecqaqib73WQeuZVwqoLjuSnuTemmVjCg/640?wx_fmt=png" data-type="png" data-w="5999" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9sTZWuvz2pYqKpiaf9m9tWd2OMsXib1fIxO3PtTMXGS3x7Ecqaqib73WQeuZVwqoLjuSnuTemmVjCg/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">相比之下年龄和性别就不是那么显著的特征。</p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Lb1P4SoLs4MmnFDSt7o3Cw",target="_blank" rel="noopener noreferrer">原文链接</a>
