---
title: "一篇单细胞文献复现及代码部分更新"
date: 2024-08-16T08:43:36Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
一篇单细胞文献复现及代码部分更新 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span>❝</span><p>群里小伙伴提出来可否复现一篇scientific reports 杂志的文章，文章题目为：综合单细胞和空间转录组学揭示了银屑病成纤维细胞和关键基因的异质性。说是复现文章，除非文章给了代码和比较准确的数据可以做到准确复现外，我现在做的复现只是按照常规流程降维分群，然后根据文章给出的一些marker gene，结合文章和自我理解人工定义细胞亚群。</p><p>也正好借今天复现的这篇文献把代码稍微更新一下，是曾老师今年年初的时候整理的。整体变化不大，只是把代码都汇总到不同.R文件中了，qc.R, harmony.R 和 check-all-marker.R。</p><span>❞</span></blockquote><h4 data-tool="mdnice编辑器"><span></span>文章<span></span></h4><figure data-tool="mdnice编辑器"><img data-imgfileid="100034756" data-ratio="0.4220994475138122" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQk7GSMsb0FvnFBRL0ncHqSJsRibgib8Zzl8X28aQ1sKQZdia9sq3QEpHiag/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="905" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQk7GSMsb0FvnFBRL0ncHqSJsRibgib8Zzl8X28aQ1sKQZdia9sq3QEpHiag/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>复现的图：<span></span></h4><p data-tool="mdnice编辑器">文章给的图太糊了</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100034757" data-ratio="0.27037037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQpniayd6nsicibs1wiaTRUFvAibvmpbKcyFWGUrcDoYTvGbbNVZQqxcdhIiag/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQpniayd6nsicibs1wiaTRUFvAibvmpbKcyFWGUrcDoYTvGbbNVZQqxcdhIiag/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>数据集：<span></span></h4><p data-tool="mdnice编辑器">下载数据，然后解压数据，整理数据</p><p data-tool="mdnice编辑器">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE151177</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100034755" data-ratio="0.10514786418400876" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQ6siaibRNRfIiaiasxpXZzpnfl5yqdFEfcVZ79HgerPO1IVl1NeIAchxk0A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="913" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQ6siaibRNRfIiaiasxpXZzpnfl5yqdFEfcVZ79HgerPO1IVl1NeIAchxk0A/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(stringr)<br>fs = list.files(<span>'./GSE151177_raw/'</span>,pattern = <span>'^GSM'</span>)<br><span>#执行这一步需要解压tar -xvf</span><br>samples=str_split(fs,<span>'_'</span>,simplify = <span>T</span>)[,<span>1</span>]<br><br><span>#dir.create("./GSE151177_raw")</span><br>fs<br>lapply(unique(samples),<span>function</span>(x){<br>  y=fs[grepl(x,fs)]<br>  folder=paste0(<span>"GSE151177_raw/"</span>, str_split(y[<span>1</span>],<span>'_'</span>,simplify = <span>T</span>)[,<span>1</span>])<br>  dir.create(folder,recursive = <span>T</span>)<br>  <span>#为每个样本创建子文件夹</span><br>  file.rename(paste0(<span>"GSE151177_raw/"</span>,y[<span>1</span>]),file.path(folder,<span>"barcodes.tsv.gz"</span>))<br>  <span>#重命名文件，并移动到相应的子文件夹里</span><br>  file.rename(paste0(<span>"GSE151177_raw/"</span>,y[<span>2</span>]),file.path(folder,<span>"features.tsv.gz"</span>))<br>  file.rename(paste0(<span>"GSE151177_raw/"</span>,y[<span>3</span>]),file.path(folder,<span>"matrix.mtx.gz"</span>))<br>})<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>复现代码：<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(harmony)<br><span>library</span>(ggsci)<br><span>library</span>(dplyr) <br><span>library</span>(future)<br><span>library</span>(Seurat)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(data.table)<br><span>library</span>(dplyr)<br><span>library</span>(ggplot2)<br><span>library</span>(patchwork)<br><span>library</span>(stringr)<br><br>dir=<span>'./GSE151177_raw/'</span> <br>samples=list.files( dir )<br>samples <br>sceList = lapply(samples,<span>function</span>(pro){ <br>  <span># pro=samples[1] </span><br>  print(pro)  <br>  sce = CreateSeuratObject(counts =  Read10X(file.path(dir,pro )) ,<br>                          project = gsub(<span>'^GSM[0-9]*_'</span>,<span>''</span>,<br>                         gsub(<span>'filtered_feature_bc_matrix'</span>,<span>''</span>,pro) )  ,<span># pro, #</span><br>                          min.cells = <span>5</span>,<br>                          min.features = <span>500</span> )<br>  print(sce)<br>  cid = tail(colnames(sce)[order(sce$nFeature_RNA)],<span>8000</span>)<br>  sce$nFeature_RNA[cid]<br>  sce=sce[,colnames(sce) %<span>in</span>% cid]<br>  print(sce)<br>  <span>return</span>(sce)<br>})<br><br>sce.all=merge(x=sceList[[<span>1</span>]],<br>              y=sceList[ -<span>1</span> ],<br>              add.cell.ids =  gsub(<span>'^GSM[0-9]*_'</span>,<span>''</span>,<br>gsub(<span>'filtered_feature_bc_matrix'</span>,<span>''</span>,samples))    )<br><br><br>as.data.frame(sce.all@assays$RNA@counts[<span>1</span>:<span>10</span>, <span>1</span>:<span>2</span>])<br>head(sce.all@meta.data, <span>10</span>)<br>table(sce.all$orig.ident) <br><br>table(sce.all@meta.data$orig.ident)<br>sce.all$group&lt;-ifelse(grepl(<span>"GSM4567877|GSM4567878|GSM4567879|GSM4567880|GSM4567881|GSM4567882"</span>,sce.all$orig.ident),<br>                       <span>"Cons"</span>,<span>"Pso"</span>)<br><br>table(sce.all@meta.data$group)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>QC质控<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>###### step2:QC质控 ######</span><br>dir.create(<span>"./1-QC"</span>)<br>setwd(<span>"./1-QC"</span>)<br><span># 如果过滤的太狠，就需要去修改这个过滤代码</span><br><span>source</span>(<span>'../scRNA_scripts/qc.R'</span>)<br>sce.all.filt = basic_qc(sce.all)<br>print(dim(sce.all))<br>print(dim(sce.all.filt))<br>setwd(<span>'../'</span>)<br></code></pre><p data-tool="mdnice编辑器"><strong>「以下为qc.R代码」</strong></p><pre data-tool="mdnice编辑器"><span></span><code>basic_qc &lt;- <span>function</span>(input_sce){<br>  <span>#计算线粒体基因比例</span><br>  mito_genes=rownames(input_sce)[grep(<span>"^MT-"</span>, rownames(input_sce),ignore.case = <span>T</span>)] <br>  print(mito_genes) <span>#可能是13个线粒体基因</span><br>  <span>#input_sce=PercentageFeatureSet(input_sce, "^MT-", col.name = "percent_mito")</span><br>  input_sce=PercentageFeatureSet(input_sce, features = mito_genes, col.name = <span>"percent_mito"</span>)<br>  fivenum(input_sce@meta.data$percent_mito)<br>  <br>  <span>#计算核糖体基因比例</span><br>  ribo_genes=rownames(input_sce)[grep(<span>"^Rp[sl]"</span>, rownames(input_sce),ignore.case = <span>T</span>)]<br>  print(ribo_genes)<br>  input_sce=PercentageFeatureSet(input_sce,  features = ribo_genes, col.name = <span>"percent_ribo"</span>)<br>  fivenum(input_sce@meta.data$percent_ribo)<br>  <br>  <span>#计算红血细胞基因比例</span><br>  Hb_genes=rownames(input_sce)[grep(<span>"^Hb[^(p)]"</span>, rownames(input_sce),ignore.case = <span>T</span>)]<br>  print(Hb_genes)<br>  input_sce=PercentageFeatureSet(input_sce,  features = Hb_genes,col.name = <span>"percent_hb"</span>)<br>  fivenum(input_sce@meta.data$percent_hb)<br>  <br>  <span>#可视化细胞的上述比例情况</span><br>  feats &lt;- c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>, <span>"percent_mito"</span>, <span>"percent_ribo"</span>, <span>"percent_hb"</span>)<br>  feats &lt;- c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>)<br>  p1=VlnPlot(input_sce, group.by = <span>"orig.ident"</span>, features = feats, pt.size = <span>0</span>, ncol = <span>2</span>) + <br>    NoLegend()<br>  p1 <br>  w=length(unique(input_sce$orig.ident))/<span>3</span>+<span>5</span>;w<br>  ggsave(filename=<span>"Vlnplot1.pdf"</span>,plot=p1,width = w,height = <span>5</span>)<br>  <br>  feats &lt;- c(<span>"percent_mito"</span>, <span>"percent_ribo"</span>, <span>"percent_hb"</span>)<br>  p2=VlnPlot(input_sce, group.by = <span>"orig.ident"</span>, features = feats, pt.size = <span>0</span>, ncol = <span>3</span>, same.y.lims=<span>T</span>) + <br>    scale_y_continuous(breaks=seq(<span>0</span>, <span>100</span>, <span>5</span>)) +<br>    NoLegend()<br>  p2 <br>  w=length(unique(input_sce$orig.ident))/<span>2</span>+<span>5</span>;w<br>  ggsave(filename=<span>"Vlnplot2.pdf"</span>,plot=p2,width = w,height = <span>5</span>)<br>  <br>  p3=FeatureScatter(input_sce, <span>"nCount_RNA"</span>, <span>"nFeature_RNA"</span>, group.by = <span>"orig.ident"</span>, pt.size = <span>0.5</span>)<br>  ggsave(filename=<span>"Scatterplot.pdf"</span>,plot=p3)<br>  <br>  <span>#根据上述指标，过滤低质量细胞/基因</span><br>  <span>#过滤指标1:最少表达基因数的细胞&amp;最少表达细胞数的基因</span><br>  <span># 一般来说，在CreateSeuratObject的时候已经是进行了这个过滤操作</span><br>  <span># 如果后期看到了自己的单细胞降维聚类分群结果很诡异，就可以回过头来看质量控制环节</span><br>  <span># 先走默认流程即可</span><br>  <span>if</span>(<span>F</span>){<br>    selected_c &lt;- WhichCells(input_sce, expression = nFeature_RNA &gt; <span>200</span>)<br>    selected_f &lt;- rownames(input_sce)[Matrix::rowSums(input_sce@assays$RNA@counts &gt; <span>0</span> ) &gt; <span>3</span>]<br>    input_sce.filt &lt;- subset(input_sce, features = selected_f, cells = selected_c)<br>    dim(input_sce) <br>    dim(input_sce.filt) <br>  }<br>  <br>  input_sce.filt =  input_sce<br>  <span># par(mar = c(4, 8, 2, 1))</span><br>  <span># 这里的C 这个矩阵，有一点大，可以考虑随抽样 </span><br>  C=subset(input_sce.filt,downsample=<span>100</span>)@assays$RNA@counts<br>  dim(C)<br>  C=Matrix::t(Matrix::t(C)/Matrix::colSums(C)) * <span>100</span><br><br>  most_expressed &lt;- order(apply(C, <span>1</span>, median), decreasing = <span>T</span>)[<span>50</span>:<span>1</span>]<br>  pdf(<span>"TOP50_most_expressed_gene.pdf"</span>,width=<span>14</span>)<br>  boxplot(as.matrix(Matrix::t(C[most_expressed, ])),<br>          cex = <span>0.1</span>, las = <span>1</span>, <br>          xlab = <span>"% total count per cell"</span>, <br>          col = (scales::hue_pal())(<span>50</span>)[<span>50</span>:<span>1</span>], <br>          horizontal = <span>TRUE</span>)<br>  dev.off()<br>  rm(C)<br>  <br>  <span>#过滤指标2:线粒体/核糖体基因比例(根据上面的violin图)</span><br>  selected_mito &lt;- WhichCells(input_sce.filt, expression = percent_mito &lt; <span>30</span>)<br>  selected_ribo &lt;- WhichCells(input_sce.filt, expression = percent_ribo &gt; <span>3</span>)<br>  selected_hb &lt;- WhichCells(input_sce.filt, expression = percent_hb &lt; <span>1</span> )<br>  length(selected_hb)<br>  length(selected_ribo)<br>  length(selected_mito)<br>  <br>  input_sce.filt &lt;- subset(input_sce.filt, cells = selected_mito)<br>  input_sce.filt &lt;- subset(input_sce.filt, cells = selected_ribo)<br>  input_sce.filt &lt;- subset(input_sce.filt, cells = selected_hb)<br>  dim(input_sce.filt)<br>  <br>  table(input_sce.filt$orig.ident) <br>  <br>  <span>#可视化过滤后的情况</span><br>  feats &lt;- c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>)<br>  p1_filtered=VlnPlot(input_sce.filt, group.by = <span>"orig.ident"</span>, features = feats, pt.size = <span>0</span>, ncol = <span>2</span>) + <br>    NoLegend()<br>  w=length(unique(input_sce.filt$orig.ident))/<span>3</span>+<span>5</span>;w <br>  ggsave(filename=<span>"Vlnplot1_filtered.pdf"</span>,plot=p1_filtered,width = w,height = <span>5</span>)<br>  <br>  feats &lt;- c(<span>"percent_mito"</span>, <span>"percent_ribo"</span>, <span>"percent_hb"</span>)<br>  p2_filtered=VlnPlot(input_sce.filt, group.by = <span>"orig.ident"</span>, features = feats, pt.size = <span>0</span>, ncol = <span>3</span>) + <br>    NoLegend()<br>  w=length(unique(input_sce.filt$orig.ident))/<span>2</span>+<span>5</span>;w <br>  ggsave(filename=<span>"Vlnplot2_filtered.pdf"</span>,plot=p2_filtered,width = w,height = <span>5</span>) <br>  <span>return</span>(input_sce.filt) <br>  <br>}<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>harmony整合多个单细胞样品<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>sp=<span>'human'</span><br><span>###### step3: harmony整合多个单细胞样品 ######</span><br>dir.create(<span>"2-harmony"</span>)<br>getwd()<br>setwd(<span>"2-harmony"</span>)<br><span>source</span>(<span>'../scRNA_scripts/harmony.R'</span>)<br>sce.all.int = run_harmony(sce.all.filt)<br>setwd(<span>'../'</span>)<br></code></pre><p data-tool="mdnice编辑器"><strong>「其中harmony.R 如下」</strong></p><pre data-tool="mdnice编辑器"><span></span><code>run_harmony &lt;- <span>function</span>(input_sce){<br>  <br>  print(dim(input_sce))<br>  input_sce &lt;- NormalizeData(input_sce, <br>                             normalization.method = <span>"LogNormalize"</span>,<br>                             scale.factor = <span>1e4</span>) <br>  input_sce &lt;- FindVariableFeatures(input_sce)<br>  input_sce &lt;- ScaleData(input_sce)<br>  input_sce &lt;- RunPCA(input_sce, features = VariableFeatures(object = input_sce))<br>  seuratObj &lt;- RunHarmony(input_sce, <span>"orig.ident"</span>)<br>  names(seuratObj@reductions)<br>  seuratObj &lt;- RunUMAP(seuratObj,  dims = <span>1</span>:<span>15</span>, <br>                       reduction = <span>"harmony"</span>)<br>  <span># p = DimPlot(seuratObj,reduction = "umap",label=T ) </span><br>  <span># ggsave(filename='umap-by-orig.ident-after-harmony',plot = p)</span><br>  input_sce=seuratObj<br>  input_sce &lt;- FindNeighbors(input_sce, reduction = <span>"harmony"</span>,<br>                             dims = <span>1</span>:<span>15</span>) <br>  input_sce.all=input_sce<br>  <br>  <span>#设置不同的分辨率，观察分群效果(选择哪一个？)</span><br>  <span>for</span> (res <span>in</span> c(<span>0.01</span>, <span>0.05</span>, <span>0.1</span>, <span>0.2</span>, <span>0.3</span>, <span>0.5</span>,<span>0.8</span>,<span>1</span>)) {<br>    input_sce.all=FindClusters(input_sce.all, <span>#graph.name = "CCA_snn", </span><br>                               resolution = res, algorithm = <span>1</span>)<br>  }<br>  colnames(input_sce.all@meta.data)<br>  apply(input_sce.all@meta.data[,grep(<span>"RNA_snn"</span>,colnames(input_sce.all@meta.data))],<span>2</span>,table)<br>  <br>  p1_dim=plot_grid(ncol = <span>3</span>, DimPlot(input_sce.all, reduction = <span>"umap"</span>, group.by = <span>"RNA_snn_res.0.01"</span>) + <br>                     ggtitle(<span>"louvain_0.01"</span>), DimPlot(input_sce.all, reduction = <span>"umap"</span>, group.by = <span>"RNA_snn_res.0.1"</span>) + <br>                     ggtitle(<span>"louvain_0.1"</span>), DimPlot(input_sce.all, reduction = <span>"umap"</span>, group.by = <span>"RNA_snn_res.0.2"</span>) + <br>                     ggtitle(<span>"louvain_0.2"</span>))<br>  ggsave(plot=p1_dim, filename=<span>"Dimplot_diff_resolution_low.pdf"</span>,width = <span>14</span>)<br>  <br>  p1_dim=plot_grid(ncol = <span>3</span>, DimPlot(input_sce.all, reduction = <span>"umap"</span>, group.by = <span>"RNA_snn_res.0.8"</span>) + <br>                     ggtitle(<span>"louvain_0.8"</span>), DimPlot(input_sce.all, reduction = <span>"umap"</span>, group.by = <span>"RNA_snn_res.1"</span>) + <br>                     ggtitle(<span>"louvain_1"</span>), DimPlot(input_sce.all, reduction = <span>"umap"</span>, group.by = <span>"RNA_snn_res.0.3"</span>) + <br>                     ggtitle(<span>"louvain_0.3"</span>))<br>  ggsave(plot=p1_dim, filename=<span>"Dimplot_diff_resolution_high.pdf"</span>,width = <span>18</span>)<br>  <br>  p2_tree=clustree(input_sce.all@meta.data, prefix = <span>"RNA_snn_res."</span>)<br>  ggsave(plot=p2_tree, filename=<span>"Tree_diff_resolution.pdf"</span>)<br>  table(input_sce.all@active.ident) <br>  saveRDS(input_sce.all, <span>"sce.all_int.rds"</span>)<br>  <span>return</span>(input_sce.all)<br>}<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>降维分群和maker gene<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>###### step4: 降维聚类分群和看标记基因库 ######</span><br><span># 原则上分辨率是需要自己肉眼判断，取决于个人经验</span><br><span># 为了省力，我们直接看 0.1和0.8即可。</span><br><span>#由于篇幅有限，我这里只展示了0.1的，下面的分群也都是根据0.1的来的。</span><br>table(Idents(sce.all.int))<br>table(sce.all.int$seurat_clusters)<br>table(sce.all.int$RNA_snn_res.0.1) <br>table(sce.all.int$RNA_snn_res.0.8) <br><span>#remotes::install_github(repo = 'genecell/COSGR')</span><br><span>library</span>(COSG)<br>getwd()<br>dir.create(<span>'check-by-0.1'</span>)<br>setwd(<span>'check-by-0.1'</span>)<br>sel.clust = <span>"RNA_snn_res.0.1"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br></code></pre><p data-tool="mdnice编辑器">check-all-markers.R代码所包含的marker gene比较多，我这里就只展示一部分。</p><p data-tool="mdnice编辑器">只需在harmony的时候定义好sp='human'或者sp='mouse'</p><pre data-tool="mdnice编辑器"><span></span><code>last_markers = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <span>'CD4'</span>,<span>'CD8A'</span>,<br>                   <span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span> ,<br>                   <span>'IGHG1'</span>, <span>'MZB1'</span>, <span>'SDC1'</span>,<br>                   <span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>, <br>                   <span>'TPSAB1'</span> , <span>'TPSB2'</span>,  <span># mast cells,</span><br>                   <span>'RCVRN'</span>,<span>'FPR1'</span> , <span>'ITGAM'</span> ,<br>                   <span>'C1QA'</span>,  <span>'C1QB'</span>,  <span># mac</span><br>                   <span>'S100A9'</span>, <span>'S100A8'</span>, <span>'MMP19'</span>,<span># monocyte</span><br>                   <span>'FCGR3A'</span>,<br>                   <span>'LAMP3'</span>, <span>'IDO1'</span>,<span>'IDO2'</span>,<span>## DC3 </span><br>                   <span>'CD1E'</span>,<span>'CD1C'</span>, <span># DC2</span><br>                   <span>'KLRB1'</span>,<span>'NCR1'</span>, <span># NK </span><br>                   <span>'FGF7'</span>,<span>'MME'</span>, <span>'ACTA2'</span>, <span>## human  fibo </span><br>                 <span>'GJB2'</span>, <span>'RGS5'</span>,<br>                   <span>'DCN'</span>, <span>'LUM'</span>,  <span>'GSN'</span> , <span>## mouse PDAC fibo </span><br>                   <span>'MKI67'</span> , <span>'TOP2A'</span>, <br>                   <span>'PECAM1'</span>, <span>'VWF'</span>,  <span>## endo </span><br>                 <span>"PLVAP"</span>,<span>'PROX1'</span>,<span>'ACKR1'</span>,<span>'CA4'</span>,<span>'HEY1'</span>,<br>                   <span>'EPCAM'</span> , <span>'KRT19'</span>,<span>'KRT7'</span>, <span># epi </span><br>                   <span>'FYXD2'</span>, <span>'TM4SF4'</span>, <span>'ANXA4'</span>,<span># cholangiocytes</span><br>                   <span>'APOC3'</span>, <span>'FABP1'</span>,  <span>'APOA1'</span>,  <span># hepatocytes</span><br>                   <span>'Serpina1c'</span>,<br>                   <span>'PROM1'</span>, <span>'ALDH1A1'</span> )<br>genes_to_check=c(<span>"SPINK5"</span>, <span>"FLG"</span>,    <br>                 <span>"LDR"</span>, <span>"KRT1"</span>,    <br>                 <span>"KRT10"</span>, <span>"FABP5"</span>,   <br>                 <span>"KRT5"</span>, <span>"KRT14"</span>,   <br>                 <span>"TYRP1"</span>, <span>"MLANA"</span>,   <br>                 <span>"CD40"</span>,           <br>                 <span>"LY75"</span>,<span>"CD207"</span>,<br>                 <span>"CD52"</span>,<span>"CD3D"</span>,   <br>                 <span>"TRAC"</span>, <span>"CCL1A1"</span>,      <br>                 <span>"LUM"</span>, <span>"CLDN5"</span>,   <br>                 <span>"PECAM1"</span>)<br><br>last_markers <br>genes_to_check<br><br>markers = c(<span>'last_markers'</span>,<span>"GSE_gene"</span>,<span>"all_gene"</span>)<br><br>p_umap=DimPlot(sce.all.int, reduction = <span>"umap"</span>,raster = <span>F</span>,label = <span>T</span>,repel = <span>T</span>) <br>p_umap <br><br><span>if</span>(sp==<span>'human'</span>){<br>   lapply(markers, <span>function</span>(x){<br>     <span>#x=markers[1]</span><br>     genes_to_check=str_to_upper(get(x)) <br>     DotPlot(sce.all.int , features = genes_to_check )  + <br>       coord_flip() + <br>       theme(axis.text.x=element_text(angle=<span>45</span>,hjust = <span>1</span>))<br>     <br>     h=length( genes_to_check )/<span>6</span>+<span>3</span>;h<br>     ggsave(paste(<span>'check_for_'</span>,x,<span>'.pdf'</span>),height = h)<br>   })<br>  lapply(markers_list, <span>function</span>(x){<br>    <span># x=markers_list[1]</span><br>    genes_to_check = lapply(get(x), str_to_upper)<br>    dup=names(table(unlist(genes_to_check)))[table(unlist(genes_to_check))&gt;<span>1</span>]<br>    genes_to_check = lapply(genes_to_check, <span>function</span>(x) x[!x %<span>in</span>% dup])<br>  <br>    DotPlot(sce.all.int , features = genes_to_check )  + <br>     <span># coord_flip() + </span><br>      theme(axis.text.x=element_text(angle=<span>45</span>,hjust = <span>1</span>))<br>    <br>    w=length( unique(unlist(genes_to_check)) )/<span>5</span>+<span>6</span>;w<br>    ggsave(paste(<span>'check_for_'</span>,x,<span>'.pdf'</span>),width  = w)<br>  })<br>  <br>  last_markers_to_check &lt;&lt;- str_to_upper(last_markers ) <br><br> }<span>else</span> <span>if</span>(sp==<span>'mouse'</span>){<br>   lapply(markers, <span>function</span>(x){<br>     <span>#x=markers[1]</span><br>     genes_to_check=str_to_title(get(x)) <br>     DotPlot(sce.all.int , features = genes_to_check )  + <br>       coord_flip() + <br>       theme(axis.text.x=element_text(angle=<span>45</span>,hjust = <span>1</span>))<br>     <br>     h=length( genes_to_check )/<span>6</span>+<span>3</span>;h<br>     w=length( unique(unlist(genes_to_check)) )/<span>5</span>+<span>6</span>;w<br>     ggsave(paste(<span>'check_for_'</span>,x,<span>'.pdf'</span>),height = h,width = w)<br>   })<br>   lapply(markers_list, <span>function</span>(x){<br>     <span># x=markers_list[1]</span><br>     genes_to_check = lapply(get(x), str_to_title)<br>     dup=names(table(unlist(genes_to_check)))[table(unlist(genes_to_check))&gt;<span>1</span>]<br>     genes_to_check = lapply(genes_to_check, <span>function</span>(x) x[!x %<span>in</span>% dup])<br>     <br>     DotPlot(sce.all.int , features = genes_to_check )  + <br>       <span># coord_flip() + </span><br>       theme(axis.text.x=element_text(angle=<span>45</span>,hjust = <span>1</span>))<br>     <br>     w=length( unique(unlist(genes_to_check)) )/<span>5</span>+<span>6</span>;w<br>     ggsave(paste(<span>'check_for_'</span>,x,<span>'.pdf'</span>),width  = w)<br>   })<br>   <br>   last_markers_to_check &lt;&lt;- str_to_title(last_markers ) <br>}<span>else</span> {<br>  print(<span>'we only accept human or mouse'</span>)<br>} <br><br>p_all_markers = DotPlot(sce.all.int , features = last_markers_to_check )  + <br>  coord_flip() + <br>  theme(axis.text.x=element_text(angle=<span>45</span>,hjust = <span>1</span>)) <br>p_all_markers+p_umap<br>h=length( last_markers_to_check )/<span>6</span>+<span>3</span>;h<br>w=length( unique( Idents(sce.all.int)) )/<span>5</span>+<span>10</span>;w<br>ggsave(paste(<span>'last_markers_and_umap.pdf'</span>),width  = w,height = h)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100034758" data-ratio="1.0899328859060402" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQFZeiclH0VB2pFYnDtJcIf57g5nRX6Rib98UsGnYZncLzzGsgURBkap4Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="745" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQFZeiclH0VB2pFYnDtJcIf57g5nRX6Rib98UsGnYZncLzzGsgURBkap4Q/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>确定单细胞亚群生物学名字<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>###### step5: 确定单细胞亚群生物学名字 ######</span><br><span># 一般来说，为了节省工作量，我们选择0.1的分辨率进行命名</span><br><span># 因为命名这个步骤是纯人工操作,除非0.1确实分群太粗狂了，我们就选择0.8。</span><br><span>source</span>(<span>'scRNA_scripts/lib.R'</span>)<br><span>#sce.all.int = readRDS('2-harmony/sce.all_int.rds')</span><br><span># sp='human'</span><br>colnames(sce.all.int@meta.data) <br>table(sce.all.int$RNA_snn_res.0.1)<br> <span># 7：Fibro</span><br>  <span># 6：Endo</span><br>  <span># 4: macro</span><br>  <span># 1: granu</span><br>  <span># 0: T</span><br>  <span># 2: Mono</span><br>  <span># 3:basal</span><br>  <span># 5:melan</span><br>  sce.all.int<br>  celltype=data.frame(ClusterID=<span>0</span>:<span>7</span> ,<br>                      celltype= <span>0</span>:<span>7</span>) <br>  <span>#定义细胞亚群        </span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>),<span>2</span>]=<span>'T'</span> <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>1</span>),<span>2</span>]=<span>'granu'</span> <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>2</span>  ),<span>2</span>]= <span>'Mono'</span> <span># 'myeloids'   </span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>3</span>  ),<span>2</span>]=<span>'basal'</span> <span># 'myeloids'  </span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>4</span> ),<span>2</span>]=<span>'macro'</span> <span># 'myeloids' </span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>5</span> ),<span>2</span>]=<span>'melan'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>6</span>),<span>2</span>]=<span>'Endo'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c(<span>7</span>),<span>2</span>]=<span>'fibro'</span>  <br>   <br>  head(celltype)<br>  table(celltype$celltype)<br>  sce.all.int@meta.data$celltype = <span>"NA"</span><br><br>  <span>for</span>(i <span>in</span> <span>1</span>:nrow(celltype)){<br>    sce.all.int@meta.data[which(sce.all.int@meta.data$RNA_snn_res.0.1 == celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]}<br>  Idents(sce.all.int)=sce.all.int$celltype<br>  <br>  sel.clust = <span>"celltype"</span><br>  sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>  table(sce.all.int@active.ident) <br></code></pre><h4 data-tool="mdnice编辑器"><span></span>一些可视化<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>last_markers = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <span>'CD4'</span>,<span>'CD8A'</span>,<br>                 <span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span> ,<br>                 <span>'IGHG1'</span>, <span>'MZB1'</span>, <span>'SDC1'</span>,<br>                 <span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>, <br>                 <span>'C1QA'</span>,  <span>'C1QB'</span>,  <span># mac</span><br>                 <span>'S100A9'</span>, <span>'S100A8'</span>, <span>'MMP19'</span>,<span># monocyte</span><br>                 <span>'FCGR3A'</span>,<br>                 <span>'LAMP3'</span>, <span>'IDO1'</span>,<span>'IDO2'</span>,<span>## DC3 </span><br>                 <span>'CD1E'</span>,<span>'CD1C'</span>, <span># DC2</span><br>                 <span>'FGF7'</span>,<span>'MME'</span>, <span>'ACTA2'</span>, <span>## human  fibo </span><br>                 <span>'GJB2'</span>, <span>'RGS5'</span>,<br>                 <span>'DCN'</span>, <span>'LUM'</span>,  <span>'GSN'</span> , <span>## mouse PDAC fibo </span><br>                 <span>'MKI67'</span> , <span>'TOP2A'</span>, <br>                 <span>'PECAM1'</span>, <span>'VWF'</span>,  <span>## endo</span><br>                 <span>'EPCAM'</span> , <span>'KRT19'</span>,<span>'KRT7'</span>, <span># epi </span><br>                 <span>'FYXD2'</span>, <span>'TM4SF4'</span>, <span>'ANXA4'</span>,<span># cholangiocytes</span><br>                 <span>'APOC3'</span>, <span>'FABP1'</span>,  <span>'APOA1'</span>,  <span># hepatocytes</span><br>                 <span>'Serpina1c'</span>,<br>                 <span>'PROM1'</span>, <span>'ALDH1A1'</span> )<br><span>library</span>(patchwork)<br>p_all_markers=DotPlot(sce.all.int, features = str_to_upper(last_markers),<br>                      assay=<span>'RNA'</span> ,group.by = <span>'celltype'</span> )  + coord_flip()+<br>  theme(axis.text.x = element_text(angle = <span>45</span>, vjust = <span>0.5</span>, hjust=<span>0.5</span>))<br>p_umap=DimPlot(sce.all.int, reduction = <span>"umap"</span>, group.by = <span>"celltype"</span>,label = <span>T</span>,label.box = <span>T</span>)<br>p_all_markers+p_umap<br>ggsave(<span>'markers_umap_by_celltype.pdf'</span>,width = <span>16</span>,height = <span>8</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100034759" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQgwwJliaicVJrm4icbtUFW28Wmzb71Rf0FB7NHk8cV768YiaZrhCnZvCOQg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQgwwJliaicVJrm4icbtUFW28Wmzb71Rf0FB7NHk8cV768YiaZrhCnZvCOQg/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(patchwork)<br>p_all_markers=DotPlot(sce.all.int, features = str_to_upper(genes_to_check),<br>                      assay=<span>'RNA'</span> ,group.by = <span>'celltype'</span> )  + coord_flip()+<br>  theme(axis.text.x = element_text(angle = <span>45</span>, vjust = <span>0.5</span>, hjust=<span>0.5</span>))<br>p_umap=DimPlot(sce.all.int, reduction = <span>"umap"</span>, group.by = <span>"celltype"</span>,label = <span>T</span>,label.box = <span>T</span>)<br>p_all_markers+p_umap<br>ggsave(<span>'GSE151177_umap_by_celltype.pdf'</span>,width = <span>16</span>,height = <span>8</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100034764" data-ratio="0.4925925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQrzGyVCAvm0esVpN89BURf4TPAGAhJ4y6C4LRhLzJZ2R4A5aKAbobEw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQrzGyVCAvm0esVpN89BURf4TPAGAhJ4y6C4LRhLzJZ2R4A5aKAbobEw/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>DimPlot(sce.all.int,group.by = <span>'group'</span>,raster = <span>T</span>)<br>ggsave(<span>'umap-by-group.pdf'</span>,width = <span>7</span>,height = <span>6</span>)<br>pdf(<span>'celltype-vs-orig.ident.pdf'</span>,width = <span>10</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100034762" data-ratio="0.8534599728629579" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQLhiayHKXxP7ia7JICvU3LZT5pIEd6qr6VGwZ0kpxrM375ZbWibHgJjibKw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="737" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQLhiayHKXxP7ia7JICvU3LZT5pIEd6qr6VGwZ0kpxrM375ZbWibHgJjibKw/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span>微信交流群</span><span></span></h3><p data-tool="mdnice编辑器">如果你也想参与到群里的讨论中，给我提出一些推文更新建议的话欢迎入群。同时你也可以得到我前期更新的所有数据及代码，在群里我会把代码分享给大家，而且大家可以在群里「提出自己感兴趣的单细胞文献」<strong>「我们尽可能优先选择大家的数据集去复现和实战，也欢迎大家在群里分享更多其它资料，咱们一起进步，」</strong>比较高级的单细胞分析 我们也会一起尝试， 相信你肯定是会不虚此行哈。</p><p data-tool="mdnice编辑器">附上之前推文的链接 <a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512238&amp;idx=1&amp;sn=e0c6dc2ea0e089aabb78133e50fb5d7f&amp;scene=21#wechat_redirect" data-linktype="2">为爱发电不可取（单细胞周更需要你的支持）</a></p><p data-tool="mdnice编辑器"><strong>「「目前群里已有400人，所以你想要进群的话就需要添加我的微信，私聊给我发99元的红包，我把你拉进群里。」」</strong></p><p data-tool="mdnice编辑器">我们这个群是真正的付费交流群，提供数据，代码，学习资料。如果介意99元的门槛且不认可我们知识分享的理念，<strong>「请不要加我好友」</strong>。因个人时间有限，不能及时回复还请见谅。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100034763" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQga15X206dqIWgric8wIpdGgZttojOGykq6YPa9eXoYJxicntuWdWfyvg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="172" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9hibf7DybKyswLKYD7VMgPQga15X206dqIWgric8wIpdGgZttojOGykq6YPa9eXoYJxicntuWdWfyvg/640?wx_fmt=png&amp;from=appmsg"></figure></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Odpa_z2my853Ygs_bFB67Q",target="_blank" rel="noopener noreferrer">原文链接</a>
