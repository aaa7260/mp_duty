---
title: "免疫浸润结果可视化"
date: 2024-08-02T07:33:53Z
draft: ["false"]
tags: [
  "fetched",
  "医学和生信笔记"
]
categories: ["Acdemic"]
---
免疫浸润结果可视化 by 医学和生信笔记
------
<div><section><span>关注公众号，发送</span><strong>R语言</strong><span>或</span><strong>python</strong><span>，可获取资料</span><span></span></section><section><mp-common-profile data-pluginname="mpprofile" data-id="MzUzOTQzNzU0NA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R9YDc8IDhqWAHTrZsMuhDpFlw4scqOl1ZVWpeY77cdibaSzPeGALfkEhdVpwHzVibHCRSYZg4csB43g/0?wx_fmt=png" data-nickname="医学和生信笔记" data-alias="yxhsxbj" data-signature="外科医生👨‍⚕️的R语言和生信学习🔖" data-from="2" data-is_biz_ban="0" data-weui-theme="light"></mp-common-profile></section><section data-role="outer" label="edit by 135editor"><section data-role="paragraph"><section data-role="outer" label="edit by 135editor"><section data-role="paragraph"><section data-role="outer" label="edit by 135editor"><section data-role="paragraph"><section data-role="outer"><section data-role="outer" label="edit by 135editor"><section data-tools="135编辑器" data-id="28"><p data-brushtype="text" hm_fix="440:185"><span>💡专注R语言在🩺生物医学中的使用</span></p></section></section></section></section></section><hr><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><span>免费千人</span><span>🐧</span><span><strong>QQ交流群：613637742</strong></span></p><hr><p data-tool="mdnice编辑器"><span><strong></strong></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span><span>免疫浸润结果可视化</span><span></span></h2><p data-tool="mdnice编辑器">在之前的推文中我们介绍了2行代码实现9种免疫浸润方法，今天给大家介绍下常见的免疫浸润结果的可视化。</p><p data-tool="mdnice编辑器">就以大家最常见的<code>cibersort</code>为例进行介绍。</p><p data-tool="mdnice编辑器">首先大家要对每种免疫浸润方法的结果有一个大体的认知，比如<code>cibersort</code>的结果是各种免疫细胞在样本中的比例，所以一个样本中所有的免疫细胞比例加起来总和是1！</p><p data-tool="mdnice编辑器">但是<code>ssGSEA</code>就不是这样了。</p><p data-tool="mdnice编辑器">只有理解了结果是什么样的，你才能选择合适的可视化方法。<strong>数就是图，图就是数</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(tidyHeatmap)<br><span>library</span>(tidyverse)<br><span>library</span>(RColorBrewer)<br><br><span># 首先变为长数据</span><br>cibersort_long &lt;- im_cibersort %&gt;% <br>  select(`P-value_CIBERSORT`,Correlation_CIBERSORT, RMSE_CIBERSORT,ID,everything()) %&gt;% <br>  pivot_longer(- c(<span>1</span>:<span>4</span>),names_to = <span>"cell_type"</span>,values_to = <span>"fraction"</span>) %&gt;% <br>  dplyr::mutate(cell_type = gsub(<span>"_CIBERSORT"</span>,<span>""</span>,cell_type),<br>                cell_type = gsub(<span>"_"</span>,<span>" "</span>,cell_type))<br><br>head(cibersort_long[,<span>4</span>:<span>6</span>])<br><span>## # A tibble: 6 × 3</span><br><span>##   ID                           cell_type                  fraction</span><br><span>##   &lt;chr&gt;                        &lt;chr&gt;                         &lt;dbl&gt;</span><br><span>## 1 TCGA-D5-6540-01A-11R-1723-07 B cells naive                0.0504</span><br><span>## 2 TCGA-D5-6540-01A-11R-1723-07 B cells memory               0     </span><br><span>## 3 TCGA-D5-6540-01A-11R-1723-07 Plasma cells                 0     </span><br><span>## 4 TCGA-D5-6540-01A-11R-1723-07 T cells CD8                  0.119 </span><br><span>## 5 TCGA-D5-6540-01A-11R-1723-07 T cells CD4 naive            0     </span><br><span>## 6 TCGA-D5-6540-01A-11R-1723-07 T cells CD4 memory resting   0.0951</span><br></code></pre><p data-tool="mdnice编辑器">如果你是初学者，也可以直接用<code>IOBR</code>为大家提供的<code>cell_bar_plot()</code>函数，可以直接帮你转换为长数据，并且还可以把图画出来。</p><pre data-tool="mdnice编辑器"><span></span><code>res_cibersort &lt;- cell_bar_plot(im_cibersort)<br><span>## There are seven categories you can choose: box, continue2, continue, random, heatmap, heatmap3, tidyheatmap</span><br><span>## &gt;&gt;&gt;&gt;=== Palette option for random: 1: palette1; 2: palette2; 3: palette3;  4: palette4</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo120RkFW79FibQ72YPbD5XR99J1raM3U29hhtwFzeCw4gd0j5WLumTLtQ/640?wx_fmt=png" data-type="png" data-w="504" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo120RkFW79FibQ72YPbD5XR99J1raM3U29hhtwFzeCw4gd0j5WLumTLtQ/640?wx_fmt=png"><figcaption>plot of chunk unnamed-chunk-17</figcaption></figure><p data-tool="mdnice编辑器">但是这个图你可能不能接受，没关系，转换好的长数据已经在<code>res_cibersort</code>这个对象里了。</p><pre data-tool="mdnice编辑器"><span></span><code>head(res_cibersort$data)<br><span>##                             ID     cell_type   fraction</span><br><span>## 1 TCGA-D5-6540-01A-11R-1723-07 B cells naive 0.05044811</span><br><span>## 2 TCGA-AA-3525-11A-01R-A32Z-07 B cells naive 0.11573408</span><br><span>## 3 TCGA-AA-3525-01A-02R-0826-07 B cells naive 0.06545120</span><br><span>## 4 TCGA-AA-3815-01A-01R-1022-07 B cells naive 0.03903166</span><br><span>## 5 TCGA-D5-6923-01A-11R-A32Z-07 B cells naive 0.02560987</span><br><span>## 6 TCGA-G4-6322-01A-11R-1723-07 B cells naive 0.08727238</span><br></code></pre><p data-tool="mdnice编辑器">和我们自己转换的是差不多的，这个数据就可以直接使用<code>ggplot2</code>自己画图了：</p><pre data-tool="mdnice编辑器"><span></span><code>p1 &lt;- cibersort_long %&gt;% <br>  ggplot(aes(ID,fraction))+<br>  geom_bar(stat = <span>"identity"</span>,position = <span>"stack"</span>,aes(fill=cell_type))+<br>  labs(x=<span>NULL</span>)+<br>  scale_y_continuous(expand = c(<span>0</span>,<span>0</span>))+<br>  scale_fill_manual(values = palette4,name=<span>NULL</span>)+ <span># iobr还给大家准备了几个色盘，贴心！</span><br>  theme_bw()+<br>  theme(axis.text.x = element_blank(),<br>        axis.ticks.x = element_blank(),<br>        legend.position = <span>"bottom"</span><br>        )<br>p1<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1IEAwCW11w7KKNGuRAv5N2CFTgkQRSTLQqxpsznEa9HibaF0jNqBtfxw/640?wx_fmt=png" data-type="png" data-w="720" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1IEAwCW11w7KKNGuRAv5N2CFTgkQRSTLQqxpsznEa9HibaF0jNqBtfxw/640?wx_fmt=png"><figcaption>plot of chunk unnamed-chunk-19</figcaption></figure><p data-tool="mdnice编辑器">除了这个最常见的堆叠条形图，还可以画箱线图，热图。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 有顺序的箱线图</span><br><span>library</span>(forcats)<br><br>p2 &lt;- ggplot(cibersort_long,aes(fct_reorder(cell_type, fraction),fraction,fill = cell_type)) + <br>  geom_boxplot() + <br>  <span>#geom_jitter(width = 0.2,aes(color=cell_type))+</span><br>  theme_bw() + <br>  labs(x = <span>"Cell Type"</span>, y = <span>"Estimated Proportion"</span>) +<br>  theme(axis.text.x = element_blank(),<br>        axis.ticks.x = element_blank(),<br>        legend.position = <span>"bottom"</span>) + <br>  scale_fill_manual(values = palette4)<br>p2<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo12dACIDmXfdFCu266OrUGkWpZhRc4icVLYJicsRmViaHWtAukctG4RbU0g/640?wx_fmt=png" data-type="png" data-w="504" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo12dACIDmXfdFCu266OrUGkWpZhRc4icVLYJicsRmViaHWtAukctG4RbU0g/640?wx_fmt=png"><figcaption>plot of chunk unnamed-chunk-20</figcaption></figure><p data-tool="mdnice编辑器">如果你的样本有不同分组，就可以根据画出分组箱线图。比如我这里就根据<code>tumor/normal</code>把样本分组，然后再组间进行非参数检验，并添加P值。</p><p data-tool="mdnice编辑器">这些都是R语言基础操作，本号的<strong>可视化</strong>合集中介绍了太多这些基本绘图知识了。</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(ggpubr)<br><span>library</span>(stringr)<br><br><span># 分组</span><br>cibersort_long$Group = ifelse(as.numeric(str_sub(cibersort_long$ID,<span>14</span>,<span>15</span>))&lt;<span>10</span>,<span>"tumor"</span>,<span>"normal"</span>)<br><br>p3 &lt;- ggplot(cibersort_long,aes(fct_reorder(cell_type,fraction),fraction,fill = Group)) + <br>  geom_boxplot(outlier.shape = <span>21</span>,color = <span>"black"</span>) + <br>  scale_fill_manual(values = palette1[c(<span>2</span>,<span>4</span>)])+ <br>  theme_bw() + <br>  labs(x = <span>NULL</span>, y = <span>"Estimated Proportion"</span>) +<br>  theme(legend.position = <span>"top"</span>) + <br>  theme(axis.text.x = element_text(angle=<span>45</span>,hjust = <span>1</span>),<br>        axis.text = element_text(color = <span>"black"</span>,size = <span>12</span>))+<br>  stat_compare_means(aes(group = Group,label = ..p.signif..),<br>                     method = <span>"kruskal.test"</span>,label.y = <span>0.4</span>)<br>p3<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1fSXGoYCTMmKiamRn1Oa2VJPJbEL7TpaDnJjou819LeUYicKR4btKicwQw/640?wx_fmt=png" data-type="png" data-w="720" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1fSXGoYCTMmKiamRn1Oa2VJPJbEL7TpaDnJjou819LeUYicKR4btKicwQw/640?wx_fmt=png"><figcaption>plot of chunk unnamed-chunk-21</figcaption></figure><p data-tool="mdnice编辑器">热图也是一样的easy，而且有了<code>tidyHeatmap</code>的加持，直接使用长数据即可，不用在变为宽数据了！</p><p data-tool="mdnice编辑器">可以参考文章：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247497593&amp;idx=1&amp;sn=12b343f5bff869c7abdd8a2b2b373cf6&amp;scene=21#wechat_redirect" data-linktype="2">tidyHeatmap完美使用长数据的热图可视化</a></p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(tidyHeatmap)<br><br>p4 &lt;- heatmap(.data = cibersort_long<br>        ,.row = cell_type<br>        ,.column = ID<br>        ,.value = fraction<br>        ,scale = <span>"column"</span><br>        ,palette_value = circlize::colorRamp2(<br>            seq(-<span>2</span>, <span>2</span>, length.out = <span>11</span>), <br>            RColorBrewer::brewer.pal(<span>11</span>, <span>"RdBu"</span>)<br>        )<br>        ,show_column_names=<span>F</span><br>        ,row_names_gp = gpar(fontsize = <span>10</span>),<br>        column_names_gp = gpar(fontsize = <span>7</span>),<br>        column_title_gp = gpar(fontsize = <span>7</span>),<br>        row_title_gp = gpar(fontsize = <span>7</span>)<br>        ) %&gt;% <br>  add_tile(Group) <span># 新版本已经改了，注意</span><br>p4<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo179482YO20m2xVgQOVG4yzibHicYIic2d7g6kRFSR4qSbaXIxANudHPvtQ/640?wx_fmt=png" data-type="png" data-w="864" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo179482YO20m2xVgQOVG4yzibHicYIic2d7g6kRFSR4qSbaXIxANudHPvtQ/640?wx_fmt=png"><figcaption>plot of chunk unnamed-chunk-22</figcaption></figure><p data-tool="mdnice编辑器"><code>ssGSEA</code>的可视化方法也是类似的，不过就没有堆叠条形图了，因为加和不是1，堆叠起来就会参差不齐，毫无美感。</p><p data-tool="mdnice编辑器">常用的还是箱线图这种样式的。</p><pre data-tool="mdnice编辑器"><span></span><code>ssgsea_long &lt;- im_ssgsea %&gt;% <br>  pivot_longer(- ID,names_to = <span>"cell_type"</span>,values_to = <span>"Score"</span>)<br>head(ssgsea_long)<br><span>## # A tibble: 6 × 3</span><br><span>##   ID                           cell_type                         Score</span><br><span>##   &lt;chr&gt;                        &lt;chr&gt;                             &lt;dbl&gt;</span><br><span>## 1 TCGA-3L-AA1B-01A-11R-A37K-07 Activated B cell               -0.192  </span><br><span>## 2 TCGA-3L-AA1B-01A-11R-A37K-07 Activated CD4 T cell            0.0120 </span><br><span>## 3 TCGA-3L-AA1B-01A-11R-A37K-07 Activated CD8 T cell            0.170  </span><br><span>## 4 TCGA-3L-AA1B-01A-11R-A37K-07 Activated dendritic cell        0.00545</span><br><span>## 5 TCGA-3L-AA1B-01A-11R-A37K-07 CD56bright natural killer cell  0.199  </span><br><span>## 6 TCGA-3L-AA1B-01A-11R-A37K-07 CD56dim natural killer cell     0.351</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>ggplot(ssgsea_long, aes(cell_type, Score))+<br>  geom_violin(width=<span>2.0</span>,aes(color=cell_type))+<br>  geom_boxplot(width=<span>0.2</span>,fill=<span>"black"</span>) + <br>  theme_bw() + <br>  labs(x = <span>NULL</span>) +<br>  theme(axis.text.x = element_blank(),<br>        axis.ticks.x = element_blank(),<br>        legend.position = <span>"bottom"</span>) + <br>  <span>#scale_fill_manual(values = palette4)+</span><br>  scale_color_manual(values = palette4,name=<span>NULL</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1onkuC6mo87c3sM6NApLOKUWDibu9aaK6SjP1U1ck5kQD29HlcUiamvhg/640?wx_fmt=png" data-type="png" data-w="720" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1onkuC6mo87c3sM6NApLOKUWDibu9aaK6SjP1U1ck5kQD29HlcUiamvhg/640?wx_fmt=png"><figcaption>plot of chunk unnamed-chunk-24</figcaption></figure><p data-tool="mdnice编辑器">除此之外也是可以添加分组，画热图等，其他的免疫浸润结果也是同样的可视化思路，这里就不再重复了，大家自己尝试下即可。</p><h2 data-tool="mdnice编辑器"><span></span><span>和分子联系起来</span><span></span></h2><p data-tool="mdnice编辑器">如果和某个分子联系起来，又可以画出各种花里胡哨的图，比如棒棒糖图，热图，散点图等。</p><p data-tool="mdnice编辑器">我这里是以<code>ssGSEA</code>的结果为例进行演示的，其他的都是一样的。</p><p data-tool="mdnice编辑器">我们就以<code>CTLA4</code> <code>EGFR</code> <code>PDL1</code>  <code>BRAF</code>  "VEGFB" "VEGFA" "VEGFC" "VEGFD" "NTRK2" "NTRK1" "NTRK3"这几个分子为例吧。</p><pre data-tool="mdnice编辑器"><span></span><code>genes &lt;- c(<span>"CTLA4"</span>,<span>"EGFR"</span>,<span>"PDL1"</span>,<span>"BRAF"</span>,<span>"KRAS"</span>,<span>"VEGFA"</span>,<span>"VEGFB"</span>,<span>"VEGFC"</span>,<span>"VEGFD"</span>,<span>"NTRK1"</span>,<span>"NTRK2"</span>,<span>"NTRK3"</span>)<br><br>genes_expr &lt;- as.data.frame(t(expr_coad[rownames(expr_coad) %<span>in</span>% genes,]))<br>genes_expr &lt;- genes_expr[match(im_ssgsea$ID,rownames(genes_expr)),]<br>identical(im_ssgsea$ID,rownames(genes_expr))<br><span>## [1] TRUE</span><br></code></pre><p data-tool="mdnice编辑器">接下来就是批量计算每一个基因和28种细胞之间的相关系数和P值，这个需求你可以写循环实现，或者apply系列，purrr系列等，但是我试过，都太慢了，尤其是数据量很大的时候。</p><p data-tool="mdnice编辑器">所以我这里给大家介绍一种更快的方法，借助<code>linkET</code>包实现，这个包在之前也介绍过了：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247491924&amp;idx=1&amp;sn=6f6fa87e0691adddef011aeef1d68c97&amp;scene=21#wechat_redirect" data-linktype="2">mantel-test可视化，别再只知道ggcor！</a></p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(linkET)<br><span>## </span><br><span>## Attaching package: 'linkET'</span><br><span>## The following object is masked from 'package:purrr':</span><br><span>## </span><br><span>##     simplify</span><br><span>## The following object is masked from 'package:ComplexHeatmap':</span><br><span>## </span><br><span>##     anno_link</span><br><br>cor_res &lt;- correlate(genes_expr, im_ssgsea[,-<span>1</span>],method = <span>"spearman"</span>)<br>  <br>qcorrplot(cor_res) +<br>  geom_square() +<br>  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(<span>11</span>, <span>"RdBu"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1tRh8Rb7wYJbdp5aen1m1etheEGCTLDHWzmTWyEFgCR57Uh0hEEeYlw/640?wx_fmt=png" data-type="png" data-w="504" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1tRh8Rb7wYJbdp5aen1m1etheEGCTLDHWzmTWyEFgCR57Uh0hEEeYlw/640?wx_fmt=png"><figcaption>plot of chunk unnamed-chunk-26</figcaption></figure><p data-tool="mdnice编辑器">但是这个图并没有明显的表示出P值，所以我知道大家想自己画的更加花里胡哨一点，在很久之前我就介绍过了这个方法了：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247484314&amp;idx=1&amp;sn=27ac2927c002e2cda87af6d4431633f8&amp;scene=21#wechat_redirect" data-linktype="2">R语言ggplot2画相关性热图</a></p><p data-tool="mdnice编辑器">画图前先准备下数据，把P值数据和相关系数数据整合到一起，所以借助<code>linkET</code>包也是有缺点的，如果自己写函数肯定是直接弄好的。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 先整理下数据</span><br>df_r &lt;- cor_res$r %&gt;% <br>  as.data.frame() %&gt;% <br>  rownames_to_column(var = <span>"gene"</span>) %&gt;% <br>  pivot_longer(-<span>1</span>,names_to = <span>"cell_type"</span>,values_to = <span>"correlation"</span>)<br><br>df_p &lt;- cor_res$p %&gt;% <br>  as.data.frame() %&gt;% <br>  rownames_to_column(var = <span>"gene"</span>) %&gt;% <br>  pivot_longer(-<span>1</span>,names_to = <span>"cell_type"</span>,values_to = <span>"pvalue"</span>)<br><br>df_cor &lt;- df_r %&gt;% <br>  left_join(df_p) %&gt;% <br>  mutate(stars = cut(pvalue,breaks = c(-<span>Inf</span>,<span>0.05</span>,<span>0.01</span>,<span>0.001</span>,<span>Inf</span>),right = <span>F</span>,labels = c(<span>"***"</span>,<span>"**"</span>,<span>"*"</span>,<span>" "</span>)))<br><span>## Joining with `by = join_by(gene, cell_type)`</span><br><br>head(df_cor)<br><span>## # A tibble: 6 × 5</span><br><span>##   gene  cell_type                      correlation   pvalue stars</span><br><span>##   &lt;chr&gt; &lt;chr&gt;                                &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;</span><br><span>## 1 VEGFB Activated B cell                    0.0837 5.55e- 2 " "  </span><br><span>## 2 VEGFB Activated CD4 T cell               -0.338  2.35e-15 "***"</span><br><span>## 3 VEGFB Activated CD8 T cell                0.0417 3.41e- 1 " "  </span><br><span>## 4 VEGFB Activated dendritic cell           -0.0181 6.79e- 1 " "  </span><br><span>## 5 VEGFB CD56bright natural killer cell      0.287  2.48e-11 "***"</span><br><span>## 6 VEGFB CD56dim natural killer cell         0.289  1.82e-11 "***"</span><br></code></pre><p data-tool="mdnice编辑器">数据都有了，画图就行了。<code>ggplot2</code>搞定一切，求求大家赶紧学学<code>ggplot2</code>吧，别再天天问图怎么画了。两本说明书，随便买一本认真看看就搞定了：《R数据可视化手册》或者《ggplot2：数据分析与图形艺术》</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(ggplot2)<br><br>ggplot(df_cor, aes(cell_type,gene))+<br>  geom_tile(aes(fill=correlation))+<br>  geom_text(aes(label=stars), color=<span>"black"</span>, size=<span>4</span>)+<br>  scale_fill_gradient2(low=<span>'#67B26F'</span>, high=<span>'#F2AA9D'</span>,mid = <span>'white'</span>,<br>                      limit=c(-<span>1</span>,<span>1</span>),name=paste0(<span>"*    p &lt; 0.05"</span>,<span>"\n\n"</span>,<span>"**  p &lt; 0.01"</span>,<span>"\n\n"</span>,<span>"*** p &lt; 0.001"</span>,<span>"\n\n"</span>,<span>"Correlation"</span>))+<br>  labs(x=<span>NULL</span>,y=<span>NULL</span>)+<br>  theme(axis.text.x = element_text(size=<span>8</span>,angle = <span>45</span>,hjust = <span>1</span>,color = <span>"black"</span>),<br>        axis.text.y = element_text(size=<span>8</span>,color = <span>"black"</span>),<br>        axis.ticks.y = element_blank(),<br>        panel.background=element_blank())<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.4444444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1JUHJXibApU7kaUhGNUrkN7RSeFUdjsaYqOKlCBnxaVA7icow3LC7zYOw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1JUHJXibApU7kaUhGNUrkN7RSeFUdjsaYqOKlCBnxaVA7icow3LC7zYOw/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>ggsave(<span>"df_cor.png"</span>,height = <span>4</span>,width = <span>9</span>) <span># 保存时不断调整长宽比即可得到满意的图形</span><br></code></pre><p data-tool="mdnice编辑器">棒棒糖图也是一样的简单，我们之前也介绍过了：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247489587&amp;idx=1&amp;sn=c9aecbca2ff424a2b737ebbc46fafdfb&amp;scene=21#wechat_redirect" data-linktype="2">你还不会画棒棒糖图？</a></p><p data-tool="mdnice编辑器">不过这种展示的是1个基因和其他细胞的关系，就是1对多的关系展示，上面的热图是多对多的关系展示。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 以EGFR为例</span><br>df_egfr &lt;- df_cor %&gt;% <br>  filter(gene==<span>"EGFR"</span>)<br><br>text_color &lt;- c(rep(<span>"red"</span>,<span>4</span>),rep(<span>"#FDD819"</span>,<span>1</span>),rep(<span>"#67B26F"</span>,<span>1</span>),rep(<span>"#C4E0E5"</span>,<span>12</span>),rep(<span>"#67B26F"</span>,<span>2</span>),rep(<span>"#FDD819"</span>,<span>3</span>),rep(<span>"red"</span>,<span>5</span>))<br><br>ggplot(df_egfr, aes(correlation, fct_reorder(cell_type,correlation)))+<br>  geom_segment(aes(xend = <span>0</span>,yend = cell_type),color=<span>"grey70"</span>,size=<span>1.2</span>)+ <br>  geom_point(aes(size = abs(correlation), color=factor(stars)))+ <br>  scale_color_manual(values = c(<span>"red"</span>,<span>"#FDD819"</span>,<span>"#67B26F"</span>,<span>"#C4E0E5"</span>),name=<span>"P-value"</span>)+<br>  scale_size_continuous(range = c(<span>3</span>,<span>8</span>),name=<span>"Correlation"</span>)+ <br>  labs(x=<span>NULL</span>,y=<span>NULL</span>)+<br>  theme_bw()+<br>  theme(axis.text.x = element_text(color=<span>"black"</span>,size = <span>14</span>),<br>        axis.text.y = element_text(color = text_color,size = <span>14</span>)<span>#给标签上色没想到特别好的方法</span><br>        )<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1m8ibPU3PtbCmY9VM6okqT66Pq3w6tTHG4Ku72nUKBPxicYiaOIBt0DzaQ/640?wx_fmt=png" data-type="png" data-w="504" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1m8ibPU3PtbCmY9VM6okqT66Pq3w6tTHG4Ku72nUKBPxicYiaOIBt0DzaQ/640?wx_fmt=png"><figcaption>plot of chunk unnamed-chunk-29</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>ggsave(<span>"df_egfr.png"</span>,width = <span>8</span>,height = <span>8</span>)<br></code></pre><p data-tool="mdnice编辑器">除此之外，你还可以可视化1个基因和1个细胞之间的关系，用散点图或者散点图矩阵的形式。</p><p data-tool="mdnice编辑器">我们可以直接使用<code>ggplot2</code>里面的分面，画一张图。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 还是以EGFR为例</span><br>df_egfr_scatter &lt;- im_ssgsea %&gt;% <br>  mutate(EGFR = genes_expr[,<span>"EGFR"</span>],.before = <span>1</span>) %&gt;% <br>  pivot_longer(-c(<span>1</span>,<span>2</span>),names_to = <span>"cell_type"</span>,values_to = <span>"score"</span>)<br></code></pre><p data-tool="mdnice编辑器">画图即可：</p><pre data-tool="mdnice编辑器"><span></span><code>ggplot(df_egfr_scatter, aes(EGFR,score))+<br>  geom_point()+<br>  geom_smooth(method = <span>"lm"</span>,color=<span>"blue"</span>)+<br>  stat_cor(method = <span>"spearman"</span>,color=<span>"red"</span>)+<br>  facet_wrap(~cell_type,scales = <span>"free_y"</span>,ncol = <span>5</span>)<br><span>## `geom_smooth()` using formula = 'y ~ x'</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1ohdVneRdTpdoh2joUL10ibScfcqcyNP6216lcYy4ia2Onlia3Yyia0OBMw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1ohdVneRdTpdoh2joUL10ibScfcqcyNP6216lcYy4ia2Onlia3Yyia0OBMw/640?wx_fmt=png"><figcaption>plot of chunk unnamed-chunk-31</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>ggsave(<span>"df_facet.png"</span>,width = <span>14</span>,height = <span>8</span>)<br><span>## `geom_smooth()` using formula = 'y ~ x'</span><br></code></pre><blockquote data-tool="mdnice编辑器"><p>注意：到目前为止我们用的都是所有样本，tumor和normal都有！</p></blockquote><p data-tool="mdnice编辑器">我们也可以按照tumor和normal分个组，再画图：</p><pre data-tool="mdnice编辑器"><span></span><code>df_egfr_scatter$sample_type &lt;- ifelse(as.numeric(substr(df_egfr_scatter$ID,<span>14</span>,<span>15</span>))&lt;<span>10</span>,<span>"tumor"</span>,<span>"normal"</span>)<br><br>ggplot(df_egfr_scatter, aes(EGFR,score,color=sample_type))+<br>  geom_point()+<br>  geom_smooth(method = <span>"lm"</span>)+<br>  stat_cor(method = <span>"spearman"</span>)+<br>  scale_color_manual(values = c(<span>'#FDD819'</span>,<span>'#028EA1'</span>))+<br>  facet_wrap(~cell_type,scales = <span>"free_y"</span>,ncol = <span>5</span>)<br><span>## `geom_smooth()` using formula = 'y ~ x'</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5712962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1n0RkgqObCMB65VAicAH664TibUAcpZyQI59QVhak99A43NOUNvj1Rosw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1n0RkgqObCMB65VAicAH664TibUAcpZyQI59QVhak99A43NOUNvj1Rosw/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>ggsave(<span>"df_facet_two.png"</span>,width = <span>14</span>,height = <span>8</span>)<br><span>## `geom_smooth()` using formula = 'y ~ x'</span><br></code></pre><p data-tool="mdnice编辑器">如果你需要单独画图，并保存，也是可以的，都没有问题，只要你基础够扎实，想做什么都可以，你R语言基础不行，啥都做不出来。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 还是以EGFR为例</span><br>df_egfr_scatter %&gt;% <br>  filter(cell_type == <span>"Activated B cell"</span>) %&gt;% <br>  ggplot(aes(EGFR, score,color=sample_type))+<br>  geom_point()+<br>  geom_rug(aes(color=sample_type))+<br>  geom_smooth(method = <span>"lm"</span>)+<br>  stat_cor(method = <span>"spearman"</span>)+<br>  scale_color_manual(values = c(<span>'#FDD819'</span>,<span>'#028EA1'</span>))+<br>  theme_bw()<br><span>## `geom_smooth()` using formula = 'y ~ x'</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1MNdL8J3hWNY5jQuToy3XPvkNyCJmCmYgo7RtfH6HvPL8LDVuhY2VNA/640?wx_fmt=png" data-type="png" data-w="504" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1MNdL8J3hWNY5jQuToy3XPvkNyCJmCmYgo7RtfH6HvPL8LDVuhY2VNA/640?wx_fmt=png"><figcaption>plot of chunk unnamed-chunk-33</figcaption></figure><p data-tool="mdnice编辑器">是不是很简单呢？</p><p data-tool="mdnice编辑器">然后你可以循环出图并保存到本地，不过我并没有使用上面这种花里胡哨的图，你可以自己修改：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(purrr)<br><br>plot_list &lt;- df_egfr_scatter %&gt;% <br>  split(.$cell_type) %&gt;% <span># group_split没有名字</span><br>  map(~ ggplot(., aes(EGFR,score,color=sample_type))+<br>        geom_point()+<br>        geom_smooth(method = <span>"lm"</span>)+<br>        stat_cor(method = <span>"spearman"</span>)+<br>        scale_color_manual(values = c(<span>'#FDD819'</span>,<span>'#028EA1'</span>))<br>      )<br>paths &lt;- paste0(names(plot_list),<span>".png"</span>)<br><br>pwalk(list(paths, plot_list),ggsave,width=<span>6</span>,height=<span>3</span>)<br></code></pre><p data-tool="mdnice编辑器">28张图片已保存到本地：</p><figure data-tool="mdnice编辑器"><img data-ratio="2.6666666666666665" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1CMw5vUX1NaVrKos3psWLu2fb6wJxqhYKMa2YLz1bdZ1AaXcegib6s8A/640?wx_fmt=png" data-type="png" data-w="255" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1CMw5vUX1NaVrKos3psWLu2fb6wJxqhYKMa2YLz1bdZ1AaXcegib6s8A/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">每一张都长这样：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5018518518518519" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1M8dSUcI0w1icFibXibNLQaPTzr0KmuE5iaFyiazE6vr24WgtmmyE8QDVXpg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicYDkjNTbQxB04GqD4DODo1M8dSUcI0w1icFibXibNLQaPTzr0KmuE5iaFyiazE6vr24WgtmmyE8QDVXpg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">OK，就先介绍到这里，关于结果的可视化，我这里介绍的只是最常见的，冰山一角而已，毕竟可视化方法太多了，不可能全都介绍到。</p><p data-tool="mdnice编辑器">大家如果有喜欢的图形，可通过评论区，粉丝QQ群等方式发给我~</p></section><p data-tool="mdnice编辑器"><br></p><hr><p>视频教程可关注<strong>我的b站：</strong><span><strong>阿越就是我<br></strong></span></p><hr><p><span>🔖精选合集</span></p><hr><p><br></p><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzOTQzNzU0NA==&amp;action=getalbum&amp;album_id=2267367379124928515#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-cropselx1="0" data-cropselx2="578" data-cropsely1="0" data-cropsely2="128" data-ratio="0.2222222222222222" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8LRib58e6MtiaIhf9gXpPUTWnmVicKzO3qE6sRViarmG8ibJGRnCAI2eBuuzQ3dp4tx9K5gFfTdHA7Wpw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8LRib58e6MtiaIhf9gXpPUTWnmVicKzO3qE6sRViarmG8ibJGRnCAI2eBuuzQ3dp4tx9K5gFfTdHA7Wpw/640?wx_fmt=png"></span></a></p><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzOTQzNzU0NA==&amp;action=getalbum&amp;album_id=2231476971388059661#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-cropselx1="0" data-cropselx2="556" data-cropsely1="0" data-cropsely2="124" data-ratio="0.2222222222222222" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8LRib58e6MtiaIhf9gXpPUTWibUpA8O16AzEGWhOwNKiciczAnjY9ySoq73UaJSAwaictMVUfMiab0W8bsQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8LRib58e6MtiaIhf9gXpPUTWibUpA8O16AzEGWhOwNKiciczAnjY9ySoq73UaJSAwaictMVUfMiab0W8bsQ/640?wx_fmt=png"></span></a></p><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzOTQzNzU0NA==&amp;action=getalbum&amp;album_id=2255945345983627264#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.2222222222222222" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8LRib58e6MtiaIhf9gXpPUTWmN6Vhuk1PGPibib90QHGGMia2ecUAOPGabsJUFk3KoAw6vIdEu12F7ldw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8LRib58e6MtiaIhf9gXpPUTWmN6Vhuk1PGPibib90QHGGMia2ecUAOPGabsJUFk3KoAw6vIdEu12F7ldw/640?wx_fmt=png"></span></a></p><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzOTQzNzU0NA==&amp;action=getalbum&amp;album_id=2393825487539191816#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.2222222222222222" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8LRib58e6MtiaIhf9gXpPUTWPFVPnORLaoL3szpia9vMic2ujGboXia3kZnhYASe5GhLeHVVrPmhmNojw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8LRib58e6MtiaIhf9gXpPUTWPFVPnORLaoL3szpia9vMic2ujGboXia3kZnhYASe5GhLeHVVrPmhmNojw/640?wx_fmt=png"></span></a></p><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzOTQzNzU0NA==&amp;action=getalbum&amp;album_id=2232796937446014976#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.2222222222222222" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8LRib58e6MtiaIhf9gXpPUTWODjpibyGdCvjCnmVHGECMI9YEkrtN6rtVEHytkOVc8bMZyo2hrOLxRA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8LRib58e6MtiaIhf9gXpPUTWODjpibyGdCvjCnmVHGECMI9YEkrtN6rtVEHytkOVc8bMZyo2hrOLxRA/640?wx_fmt=png"></span></a></p><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzOTQzNzU0NA==&amp;action=getalbum&amp;album_id=2216854859432116225#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-cropselx1="0" data-cropselx2="575" data-cropsely1="0" data-cropsely2="128" data-ratio="0.2222222222222222" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8LRib58e6MtiaIhf9gXpPUTWghjc1Vmgkic98WEnqEggHhfY9lDTyjU9TwXia1WQTmmx3tpPY7aTgE3Q/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8LRib58e6MtiaIhf9gXpPUTWghjc1Vmgkic98WEnqEggHhfY9lDTyjU9TwXia1WQTmmx3tpPY7aTgE3Q/640?wx_fmt=png"></span></a></p></section></section></section></section></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/YcUVElp0BEj5TxEqfSEkIQ",target="_blank" rel="noopener noreferrer">原文链接</a>
