---
title: "Doheatmap常用参数及美化"
date: 2024-08-14T02:14:49Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
Doheatmap常用参数及美化 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span></span><span>前情提要</span><span></span></h3><p data-tool="mdnice编辑器">在上期的推文<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247524497&amp;idx=1&amp;sn=441e2795b5c51a571c35fc4d206abc7c&amp;scene=21#wechat_redirect" data-linktype="2">细胞类群marker基因识别及可视化</a>结尾的时候，提到了五种基本可视化Marker基因的方式</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100040997" data-ratio="1.2361111111111112" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSqaFj73z8mQnQYVEc45vZFRLiaUf5eDODUMkvBlicrr5Lw9Od8NOI8WOcr8JXqj4fFGQP74tcA6DTg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSqaFj73z8mQnQYVEc45vZFRLiaUf5eDODUMkvBlicrr5Lw9Od8NOI8WOcr8JXqj4fFGQP74tcA6DTg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">那这期一起来<strong>了解一下<code>DoHeatmap</code>函数的参数设置，以及在可视化marker基因有什么可以调整修改的地方。</strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>DoHeatmap常用参数</span><span></span></h3><figure data-tool="mdnice编辑器"><img data-imgfileid="100040993" data-ratio="1.1710526315789473" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSqaFj73z8mQnQYVEc45vZFj4MjRGDPjvNNh8U5n2u4sovG6REty5E0Fw7Defu19ojWnhS1aD5yFg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="760" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSqaFj73z8mQnQYVEc45vZFj4MjRGDPjvNNh8U5n2u4sovG6REty5E0Fw7Defu19ojWnhS1aD5yFg/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>常用参数</span><span></span></h4><ul data-tool="mdnice编辑器"><li><section><strong>object：</strong>输入的seurat对象</section></li><li><section><strong>features：</strong>要绘制的基因向量，可以是marker基因也可以需要可视化的基因集</section></li><li><section><strong>cells：</strong>要绘制的细胞，默认是全部的细胞</section></li><li><section><strong>slot = "scale.data"：</strong>指定使用的数据，默认使用的是scale.data</section></li></ul><h4 data-tool="mdnice编辑器"><span></span><span>分组信息及颜色</span><span></span></h4><ul data-tool="mdnice编辑器"><li><section><strong>group.by = "ident"：</strong>分组的依据，可以自行选择，默认是active.ident的内容</section></li><li><section><strong>group.bar：</strong>添加分组信息的颜色条</section></li><li><section><strong>group.colors：</strong>指定分组颜色条的颜色</section></li><li><section><strong>group.bar.height = 0.02：</strong>缩放颜色条的高度</section></li></ul><h4 data-tool="mdnice编辑器"><span></span><span>标签信息</span><span></span></h4><ul data-tool="mdnice编辑器"><li><section><strong>label = TRUE：</strong>分组信息的标签</section></li><li><section><strong>size = 5.5：</strong>文本字体的代销</section></li><li><section><strong>hjust = 0：</strong>水平对齐</section></li><li><section><strong>vjust = 0：</strong>垂直对齐</section></li><li><section><strong>angle = 45：</strong>倾斜的角度</section></li></ul><h4 data-tool="mdnice编辑器"><span></span><span>分隔线</span><span></span></h4><ul data-tool="mdnice编辑器"><li><section><strong>draw.lines = TRUE：</strong>用线将各组信息分隔</section></li><li><section><strong>lines.width = NULL：</strong>分隔线的宽度</section></li></ul><h3 data-tool="mdnice编辑器"><span></span><span></span><span>DoHeatmap可视化及美化</span><span></span></h3><h4 data-tool="mdnice编辑器"><span></span><span>获取marker基因直接可视化</span><span></span></h4><p data-tool="mdnice编辑器">用到的数据，还是<strong>seurat官网pbmc-3k的示例数据</strong></p><p data-tool="mdnice编辑器">走完基本的降维聚类分群，然后<strong>使用<code>FindAllMarkers</code>分析获取全部亚群的marker基因，然后选择top5的marker基因进行可视化</strong></p><pre data-tool="mdnice编辑器"><span></span><code>pbmc.markers &lt;- FindAllMarkers(pbmc, only.pos = TRUE, min.pct = 0.25,  logfc.threshold = 0.25, verbose = FALSE)<br>top5 = pbmc.markers %&gt;% group_by(cluster) %&gt;% top_n(n = 5, wt = avg_log2FC)<br>g = unique(top5<span>$gene</span>)<br><br><span>#五种方式可视化marker基因</span><br>DoHeatmap(pbmc,features = g) + NoLegend()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100040995" data-ratio="0.6972222222222222" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSqaFj73z8mQnQYVEc45vZFZVZB4wHT7tLD53cYNJXATcReFk0vpJfZf9PYzQv1ibtlgf2ibovR99cg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSqaFj73z8mQnQYVEc45vZFZVZB4wHT7tLD53cYNJXATcReFk0vpJfZf9PYzQv1ibtlgf2ibovR99cg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>直接可视化的结果图有些可以调整的点：</strong></p><ul data-tool="mdnice编辑器"><li><section><strong>标签角度：</strong>默认参数会导致部分标签信息展示不全</section></li><li><section><strong>颜色调整：</strong>默认颜色有点不好看</section></li><li><section><strong>top5基因</strong>颜色在对应亚群没有很明显，因为没有scale所以展示没有很明显</section></li><li><section><strong>细胞数量太多</strong>，可以考虑抽样展示，不展示太具体的细胞</section></li><li><section><strong>CD4 T的marker基因在naive和memory间亮度不明显</strong>，可能因为marker基因不够特异，后续可以再细分</section></li></ul><h4 data-tool="mdnice编辑器"><span></span><span>1. 调整颜色和标签角度</span><span></span></h4><p data-tool="mdnice编辑器">因为默认参数的标签的角度是<code>angle = 45</code>所以是向右倾斜的，导致<strong>Platelet</strong>标签会显示不全</p><ul data-tool="mdnice编辑器"><li><section>可以改变一下<strong>横轴标签的排列顺序</strong></section></li><li><section>可以改变一下<strong>倾斜的角度</strong></section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span>#改变标签的排列顺序</span><br>pbmc<span>$cell_type</span> &lt;- factor( x= pbmc<span>$cluster_by_counts</span> ,c(<span>"Naive CD4 T"</span>, <span>"CD14+ Mono"</span>, <span>"Memory CD4 T"</span>,<br>                                                       <span>"B"</span>, <span>"CD8 T"</span>,<span>"FCGR3A+ Mono"</span>, <span>"Platelet"</span>, <span>"NK"</span>, <span>"DC"</span>))<br><br><span>#调整倾斜角度和颜色</span><br>DoHeatmap(pbmc,features = g,group.by = <span>"cell_type"</span>,group.colors = mycolors,<br>          size = 3,angle = -50,hjust=0.8) + <br>  scale_fill_gradientn(colors = c(<span>"white"</span>,<span>"grey"</span>,<span>"firebrick3"</span>))<br><br></code></pre><p data-tool="mdnice编辑器">使用<strong>group.colors</strong>调整分组颜色——可以设置和umap图一样的颜色，使用<strong>scale_fill_gradientn</strong>调整热图的颜色，一般设置三个颜色</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100040994" data-ratio="0.774074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSqaFj73z8mQnQYVEc45vZFQGkEWABLTXgicJJuM7VDcArahILVmVeKZxyuTo54BmNzpsgBRkonjDQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSqaFj73z8mQnQYVEc45vZFQGkEWABLTXgicJJuM7VDcArahILVmVeKZxyuTo54BmNzpsgBRkonjDQ/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>2. 重新scale并且抽样展示</span><span></span></h4><p data-tool="mdnice编辑器">正好看到群里有朋友在问，<strong>为什么选了top5基因进行可视化的时候，通常会发现展示的时候只剩下3到4个基因？</strong></p><blockquote data-tool="mdnice编辑器"><span></span><p>之前做细胞类群注释top5基因的dotplot的时候经常发现剩3个4个基因，我以为是这一步2000筛除了</p></blockquote><p data-tool="mdnice编辑器">因为<code>DoHeatmap</code>中默认<strong>slot = "scale.data"</strong> ，也就是用的<strong>数据是ScaleData后的结果数据集</strong>。而<code>FindAllMarkers</code>中默认<strong>slot = "data"</strong> ，也就是<strong>用的数据是NormalizeData后的数据集</strong>。</p><p data-tool="mdnice编辑器">因此就可能会造成DoHeatmap画热图时，不在前2000个高变基因中的marker不出现在热图中。可以<strong>基于top基因重新scale，并且抽样展示，不展示全部的细胞</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span>#基于top基因重新scale并随机抽样</span><br>pbmc.Scale &lt;- ScaleData(subset(pbmc,downsample=100),features = g )  <br><br>DoHeatmap(pbmc.Scale,<br>          features = g,<br>          group.by = <span>"cell_type"</span>,size = 3,<br>          assay = <span>'RNA'</span>, label = T)+<br>  scale_fill_gradientn(colors = c(<span>"white"</span>,<span>"grey"</span>,<span>"firebrick3"</span>))<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100040996" data-ratio="0.8185185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSqaFj73z8mQnQYVEc45vZFygKnrBcbSJmbWdAxq7SwZdE23TQkwLkYEUobYG8K1WXTUiafH2oQS6Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSqaFj73z8mQnQYVEc45vZFygKnrBcbSJmbWdAxq7SwZdE23TQkwLkYEUobYG8K1WXTUiafH2oQS6Q/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>3.是否展示图例</span><span></span></h4><p data-tool="mdnice编辑器">一般是默认展示图例的，如果<strong>不想展示的话可以加上NoLegend()，选择不展示图例</strong></p><pre data-tool="mdnice编辑器"><span></span><code>DoHeatmap(pbmc.Scale,<br>          features =  g,<br>          group.by = <span>"cell_type"</span>,size = 3,<br>          assay = <span>'RNA'</span>, label = T)+NoLegend()+<br>  scale_fill_gradientn(colors = c(<span>"white"</span>,<span>"grey"</span>,<span>"firebrick3"</span>))<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041002" data-ratio="0.7925925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSqaFj73z8mQnQYVEc45vZFs50olWEYupNz50zsXhoPibJhO6E0HD2UE97rUicicpFz1k5s1RfWnhVoA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSqaFj73z8mQnQYVEc45vZFs50olWEYupNz50zsXhoPibJhO6E0HD2UE97rUicicpFz1k5s1RfWnhVoA/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>小结</span><span></span></h3><p data-tool="mdnice编辑器">这期推文主要整理了一下<strong>DoHeatmap</strong>的常用参数，以及基于<strong>DoHeatmap</strong>的参数我们可以进行的一些图片调整与美化。</p><p data-tool="mdnice编辑器">很多朋友在进行热图可视化的时候，会选择用到<strong>Complexheatmap</strong>包，进行美化。那<strong>下期可以一起来学习一下使用Complexheatmap绘制热图</strong>。</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/s46KSqHdTYYIwRRQEGf_MQ",target="_blank" rel="noopener noreferrer">原文链接</a>
