---
title: "课后补充---特发性纤维化病理生态位的空间转录组学特征"
date: 2024-08-17T02:55:45Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞空间交响乐"
]
categories: ["Acdemic"]
---
课后补充---特发性纤维化病理生态位的空间转录组学特征 by 单细胞空间交响乐
------
<div><h4>作者，Evil Genius</h4><h4>今日参考文献，Spatial transcriptomic characterization of pathologic niches in IPF（Science Advances）。</h4><h4>首先搜集一下marker</h4><p><img data-imgfileid="100008862" data-ratio="0.3878048780487805" data-type="other" data-w="820" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWmxBMdpvcfK3CibDW4dqcXAju5ymGDom5QU4uAYfWEqLKrxsvMyJOAVQ/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWmxBMdpvcfK3CibDW4dqcXAju5ymGDom5QU4uAYfWEqLKrxsvMyJOAVQ/640?wx_fmt=other&amp;from=appmsg"></p><p><br></p><p><img data-imgfileid="100008858" data-ratio="0.31069609507640067" data-type="other" data-w="589" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWWhWC0pqHu2TUp5EVG6iawc2zT1C19jQrMWo43IPJxHwprX5BUK01rPg/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWWhWC0pqHu2TUp5EVG6iawc2zT1C19jQrMWo43IPJxHwprX5BUK01rPg/640?wx_fmt=other&amp;from=appmsg"></p><p><br></p><p><img data-imgfileid="100008860" data-ratio="0.5558912386706949" data-type="other" data-w="662" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWau9lNFsJibTClTp4icqNiaYq3jfjDl4v3tic57WYI5J1cHhW2UbB7XdUhQ/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWau9lNFsJibTClTp4icqNiaYq3jfjDl4v3tic57WYI5J1cHhW2UbB7XdUhQ/640?wx_fmt=other&amp;from=appmsg"><span></span></p><h4>单细胞 + 空间分析确定了三个与疾病相关的生态位，具有独特的细胞组成和定位。这种IPF生态位的空间特征将有助于识别破坏疾病驱动生态位的药物靶点，并有助于开发与疾病相关的体外模型。</h4><h4>知识背景</h4><ul><li><p><strong><span>细胞的位置、周围邻居和组织结构</span></strong>，如IPF中的蜂窝形态或成纤维细胞灶，对</p><p>于确定细胞表型、疾病状态以及最终的细胞功能和通讯至关重要</p></li><li><p><strong><span>了解每个生态位空间内细胞和分子的相互作用对于更好地解剖独特的疾病病</span></strong></p><p><strong><span>理生物学和指导下一代药物的发现至关重要。</span></strong></p></li><li><p>空间转录组学通过在完整组织的自然组织环境中提供空间解析的基因表达来解决这一问题，而不会诱导细胞应激、死亡或分离偏差。最近建立的Visium用于福尔马林固定和石蜡包埋(FFPE)技术可以对保存的FFPE组织切片进行无偏置的基于探针的近全转录组mRNA分析，而Xenium原位技术可以对多达500个选定基因进行亚细胞分辨率。</p></li></ul><h4>分析结果1、空间和scRNA-seq分析定位健康和IPF肺组织中的细胞和基因</h4><ul><li><p>cell2location</p></li><li><p>病理学家对HE染色组织切片的组织病理学注释</p></li><li><p>细胞类型共定位，异常的细胞共定位引起了疾病的发生和变化</p></li><li><p>Xenium平台验证Visium的分析结果</p></li></ul><p><img data-imgfileid="100008861" data-ratio="0.6638888888888889" data-type="other" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWUMWsa8g8ggNPSeRyY6CbPVTkZA3hx7m1tM8uPjZVVFTQ46oGDtvjKw/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWUMWsa8g8ggNPSeRyY6CbPVTkZA3hx7m1tM8uPjZVVFTQ46oGDtvjKw/640?wx_fmt=other&amp;from=appmsg"></p><p><img data-imgfileid="100008863" data-ratio="0.46944444444444444" data-type="other" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYW9pdu3pzYje6xYFuoqnvp9qFHGmgeqcWibHYjqfp4pdrSdJXOk5H0R0g/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYW9pdu3pzYje6xYFuoqnvp9qFHGmgeqcWibHYjqfp4pdrSdJXOk5H0R0g/640?wx_fmt=other&amp;from=appmsg"></p><p><img data-imgfileid="100008864" data-ratio="1.269717624148004" data-type="other" data-w="1027" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWSibZs7Jqw6ukoqSh7JOAkzjHjtoQbSCWQ02DaUOPKZIr3lL4lWNS5icQ/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWSibZs7Jqw6ukoqSh7JOAkzjHjtoQbSCWQ02DaUOPKZIr3lL4lWNS5icQ/640?wx_fmt=other&amp;from=appmsg"></p><h4>分析结果2、三种不同的niche出现在IPF肺组织中</h4><ul><li><p><strong><span>非负矩阵分解(NMF)</span></strong></p></li><li><p><strong><span>将cell2location逐细胞类型输出矩阵转换为细胞类型和生态位矩阵，以及spot和生态位矩阵。这能够确定每个spot内的主要细胞生态位和表征每个生态位的细胞类型，抽象出生物系统的复杂性，并确定组织内最相关的细胞邻近区。</span></strong></p></li><li><p>生态位的空间组织，利用位置数据并分析相邻的相互作用。</p></li></ul><p><img data-imgfileid="100008865" data-ratio="1.3247156153050672" data-type="other" data-w="967" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWbiaoibKIpN4xYZgdqpCblputHRTEY1QQeibYMOa9xwiaV9Pcy4D5s2jXvg/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWbiaoibKIpN4xYZgdqpCblputHRTEY1QQeibYMOa9xwiaV9Pcy4D5s2jXvg/640?wx_fmt=other&amp;from=appmsg"></p><p><br></p><p><img data-imgfileid="100008867" data-ratio="1.136111111111111" data-type="other" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWuvy1ZgR4tJpjqahFZicBKk159233QmNSH76UR0x4aq4LdgvicQ6OiarKg/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWuvy1ZgR4tJpjqahFZicBKk159233QmNSH76UR0x4aq4LdgvicQ6OiarKg/640?wx_fmt=other&amp;from=appmsg"></p><h4>分析结果3、在气道周围发现异常的基底样细胞</h4><p><img data-imgfileid="100008866" data-ratio="1.2087198515769944" data-type="other" data-w="1078" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWiadjfNJJTcU2zdIQlaJZq9vW6AuEMQXnUibbapdD8tm2ZNaKgcRibrAFg/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWiadjfNJJTcU2zdIQlaJZq9vW6AuEMQXnUibbapdD8tm2ZNaKgcRibrAFg/640?wx_fmt=other&amp;from=appmsg"></p><p><br></p><p><img data-imgfileid="100008869" data-ratio="0.9731481481481481" data-type="other" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWQVVAZgUPGdE8DN3ZlerjuB2mhSPicfKIBJREbustotvjYXBvkEatrPA/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWQVVAZgUPGdE8DN3ZlerjuB2mhSPicfKIBJREbustotvjYXBvkEatrPA/640?wx_fmt=other&amp;from=appmsg"></p><p><br></p><p><img data-imgfileid="100008870" data-ratio="1.1671361502347417" data-type="other" data-w="1065" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWtqibM84XrML44K3HIibeiarYCziaSKv1JY2kWzeiciaRTGcdUlTsaR5oyic1Q/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWtqibM84XrML44K3HIibeiarYCziaSKv1JY2kWzeiciaRTGcdUlTsaR5oyic1Q/640?wx_fmt=other&amp;from=appmsg"></p><p><br></p><p><img data-imgfileid="100008871" data-ratio="1.3906976744186046" data-type="other" data-w="1075" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWLDUcQFRl8Ul3N9fKpibrCcicS9zibcQwxQRH1K7Z9JAl3AO20tjMm2cAw/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWLDUcQFRl8Ul3N9fKpibrCcicS9zibcQwxQRH1K7Z9JAl3AO20tjMm2cAw/640?wx_fmt=other&amp;from=appmsg"></p><h4>分析结果4、SPP1+巨噬细胞亚群定位于纤维化气道的管腔</h4><p>进一步研究气道巨噬细胞生态位，我们首先旨在了解IPF中细胞巨噬细胞亚型的异质性，这些亚型都表达spp1 -被认为是许多纤维化疾病中常见的纤维化巨噬细胞标志物。空间Visium数据揭示了巨噬细胞亚型在IPF中的差异定位，并提示气道巨噬细胞生态位优先定位于纤维化气道的管腔，可以在mRNA和蛋白质水平上验证这一点。气道巨噬细胞生态位也出现在纤维化生态位附近，特别是异常的基底细胞，这是由预测的和独特的细胞间通讯支持的。</p><p><br></p><p><img data-imgfileid="100008872" data-ratio="1.4324074074074074" data-type="other" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWcffZialhDDW5MqaWcJBeDdfxBvWb4l1pbkaUZKzlT2J0qJR5pfytiaRw/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWcffZialhDDW5MqaWcJBeDdfxBvWb4l1pbkaUZKzlT2J0qJR5pfytiaRw/640?wx_fmt=other&amp;from=appmsg"></p><h4>分析结果5、免疫细胞病灶是由ipf特异性异位内皮细胞募集的</h4><p>空间转录组学数据以及H&amp;E组织结构显示，免疫生态位是IPF的一个显著组织病理学特征，以多种淋巴样细胞类型的病灶形式存在，可能通过异位内皮支气管血管的不同分泌信号募集。</p><p><br></p><p><img data-imgfileid="100008868" data-ratio="1.0157407407407408" data-type="other" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWHKJSVU4q69g2tWQvFeBgsjvrtc3thia2hQjuT1AaCUs3jYt7oTvuiaZQ/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYWHKJSVU4q69g2tWQvFeBgsjvrtc3thia2hQjuT1AaCUs3jYt7oTvuiaZQ/640?wx_fmt=other&amp;from=appmsg"></p><h4>来看看代码部分，我们看一下重点部分</h4><h4>重点、hotspot（空间打分）</h4><p><span aria-label="icon: copy"><svg viewbox="64 64 896 896" focusable="false" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></p><pre><code><span>import</span> scanpy <span>as</span> sc<br><span>import</span> squidpy <span>as</span> sq<br><span>import</span> numpy <span>as</span> np<br><span>import</span> pandas <span>as</span> pd<br><span>import</span> os<br><span>import</span> sys<br><span>import</span> seaborn <span>as</span> sb<br><span>import</span> matplotlib<span>.</span>pyplot <span>as</span> plt<br><span>from</span> matplotlib <span>import</span> colors<br><br><span>#import scvi</span><br><span>import</span> anndata <span>as</span> ad<br><br><span>import</span> warnings<br>warnings<span>.</span>filterwarnings<span>(</span><span>"ignore"</span><span>)</span><br><br><span>from</span> collections <span>import</span> Counter<br><br><span>import</span> ipywidgets <span>as</span> widgets<br><span>from</span> ipywidgets <span>import</span> interact<span>,</span> interact_manual<br><br>plt<span>.</span>rcParams<span>[</span><span>'figure.figsize'</span><span>]</span> <span>=</span> <span>(</span><span>6</span><span>,</span> <span>6</span><span>)</span><br><br><span>from</span> IPython<span>.</span>core<span>.</span>display <span>import</span> display<span>,</span> HTML<br><span>import</span> random<br><br><span>#Define a colour map for gene expression</span><br>colors2 <span>=</span> plt<span>.</span>cm<span>.</span>Reds<span>(</span>np<span>.</span>linspace<span>(</span><span>0</span><span>,</span> <span>1</span><span>,</span> <span>128</span><span>)</span><span>)</span><br>colors3 <span>=</span> plt<span>.</span>cm<span>.</span>Greys_r<span>(</span>np<span>.</span>linspace<span>(</span><span>0.7</span><span>,</span><span>0.8</span><span>,</span><span>20</span><span>)</span><span>)</span><br><span>#colorsComb = np.vstack([colors3, colors2])</span><br><span>#mymap = colors.LinearSegmentedColormap.from_list('my_colormap', colorsComb)</span><br><span>from</span> matplotlib <span>import</span> colors<br>colorsComb <span>=</span> np<span>.</span>vstack<span>(</span><span>[</span>plt<span>.</span>cm<span>.</span>Reds<span>(</span>np<span>.</span>linspace<span>(</span><span>0</span><span>,</span> <span>1</span><span>,</span> <span>128</span><span>)</span><span>)</span><span>,</span> plt<span>.</span>cm<span>.</span>Greys_r<span>(</span>np<span>.</span>linspace<span>(</span><span>0.7</span><span>,</span> <span>0.8</span><span>,</span> <span>0</span><span>)</span><span>)</span><span>]</span><span>)</span><br>mymap <span>=</span> colors<span>.</span>LinearSegmentedColormap<span>.</span>from_list<span>(</span><span>'my_colormap'</span><span>,</span> colorsComb<span>)</span><br><br><span># Helper function to split list in chunks</span><br><span>def</span> <span>chunks</span><span>(</span>lista<span>,</span> n<span>)</span><span>:</span><br>    <span>for</span> i <span>in</span> <span>range</span><span>(</span><span>0</span><span>,</span> <span>len</span><span>(</span>lista<span>)</span><span>,</span> n<span>)</span><span>:</span><br>        <span>yield</span> lista<span>[</span>i<span>:</span>i <span>+</span> n<span>]</span><br>        <br>        plt<span>.</span>rcParams<span>[</span><span>'figure.figsize'</span><span>]</span> <span>=</span> <span>(</span><span>6</span><span>,</span> <span>5</span><span>)</span><br>sc<span>.</span>set_figure_params<span>(</span>dpi<span>=</span><span>100</span><span>,</span> vector_friendly<span>=</span><span>True</span><span>)</span><br><span>def</span> <span>mysize</span><span>(</span>w<span>,</span> h<span>,</span> d<span>)</span><span>:</span><br>    fig<span>,</span> ax <span>=</span> plt<span>.</span>subplots<span>(</span>figsize <span>=</span> <span>(</span>w<span>,</span> h<span>)</span><span>,</span> dpi <span>=</span> d<span>)</span><br>    <span>return</span><span>(</span>fig<span>.</span>gca<span>(</span><span>)</span><span>)</span><br>plt<span>.</span>rcParams<span>[</span><span>'figure.figsize'</span><span>]</span> <span>=</span> <span>(</span><span>6</span><span>,</span> <span>5</span><span>)</span><br>sc<span>.</span>set_figure_params<span>(</span>dpi<span>=</span><span>100</span><span>,</span> vector_friendly<span>=</span><span>True</span><span>)</span><br>sc<span>.</span>settings<span>.</span>figdir <span>=</span> <span>"./figures/"</span><br><br><span>import</span> scvi<br><br><span>## frequently used variables</span><br><span>from</span> matplotlib <span>import</span> colors<br><span>import</span> matplotlib<span>.</span>pyplot <span>as</span> plt<br>colorsComb <span>=</span> np<span>.</span>vstack<span>(</span><span>[</span>plt<span>.</span>cm<span>.</span>Reds<span>(</span>np<span>.</span>linspace<span>(</span><span>0</span><span>,</span> <span>1</span><span>,</span> <span>128</span><span>)</span><span>)</span><span>,</span> plt<span>.</span>cm<span>.</span>Greys_r<span>(</span>np<span>.</span>linspace<span>(</span><span>0.7</span><span>,</span> <span>0.8</span><span>,</span> <span>0</span><span>)</span><span>)</span><span>]</span><span>)</span><br>mymap <span>=</span> colors<span>.</span>LinearSegmentedColormap<span>.</span>from_list<span>(</span><span>'my_colormap'</span><span>,</span> colorsComb<span>)</span><br><br><span>## Along these Lines, a colourmap diverging from gray to red</span><br>gray_red <span>=</span> colors<span>.</span>LinearSegmentedColormap<span>.</span>from_list<span>(</span><span>"grouping"</span><span>,</span> <span>[</span><span>"lightgray"</span><span>,</span> <span>"red"</span><span>,</span> <span>"darkred"</span><span>]</span><span>,</span> N <span>=</span> <span>128</span><span>)</span><br><br><span>## Some more Colour Maps</span><br>gray_violet <span>=</span> colors<span>.</span>LinearSegmentedColormap<span>.</span>from_list<span>(</span><span>"grouping"</span><span>,</span> <span>[</span><span>"lightgray"</span><span>,</span> <span>"mediumvioletred"</span><span>,</span> <span>"indigo"</span><span>]</span><span>,</span> N <span>=</span> <span>128</span><span>)</span><br>gray_blue <span>=</span> colors<span>.</span>LinearSegmentedColormap<span>.</span>from_list<span>(</span><span>"grouping"</span><span>,</span> <span>[</span><span>"lightgray"</span><span>,</span> <span>"cornflowerblue"</span><span>,</span> <span>"darkblue"</span><span>]</span><span>,</span> N <span>=</span> <span>128</span><span>)</span><br><br><br><span>def</span> <span>mysize</span><span>(</span>w<span>,</span> h<span>,</span> d<span>)</span><span>:</span><br>    fig<span>,</span> ax <span>=</span> plt<span>.</span>subplots<span>(</span>figsize <span>=</span> <span>(</span>w<span>,</span> h<span>)</span><span>,</span> dpi <span>=</span> d<span>)</span><br>    <span>return</span><span>(</span>fig<span>.</span>gca<span>(</span><span>)</span><span>)</span><br><span>#plt.rcParams['figure.figsize'] = (6, 5)</span><br><span>#sc.set_figure_params(dpi=120, vector_friendly=True)</span><br><br><span>import</span> matplotlib<span>.</span>colors <span>as</span> colors<br>c_low <span>=</span> colors<span>.</span>colorConverter<span>.</span>to_rgba<span>(</span><span>'orange'</span><span>,</span> alpha <span>=</span> <span>0</span><span>)</span><br>c_high <span>=</span> colors<span>.</span>colorConverter<span>.</span>to_rgba<span>(</span><span>'red'</span><span>,</span>alpha <span>=</span> <span>1</span><span>)</span><br>cmap_transparent <span>=</span> colors<span>.</span>LinearSegmentedColormap<span>.</span>from_list<span>(</span><span>'rb_cmap'</span><span>,</span><span>[</span>c_low<span>,</span> c_high<span>]</span><span>,</span> <span>512</span><span>)</span><br><br><span>import</span> matplotlib<span>.</span>colors <span>as</span> colors<br>c_low2 <span>=</span> colors<span>.</span>colorConverter<span>.</span>to_rgba<span>(</span><span>'green'</span><span>,</span> alpha <span>=</span> <span>0</span><span>)</span><br>c_high2 <span>=</span> colors<span>.</span>colorConverter<span>.</span>to_rgba<span>(</span><span>'darkblue'</span><span>,</span>alpha <span>=</span> <span>1</span><span>)</span><br>cmap_transparent2 <span>=</span> colors<span>.</span>LinearSegmentedColormap<span>.</span>from_list<span>(</span><span>'rb_cmap'</span><span>,</span><span>[</span>c_low2<span>,</span> c_high2<span>]</span><span>,</span> <span>512</span><span>)</span><br><br><span>print</span><span>(</span><span><span>f"squidpy==</span><span><span>{</span>sq<span>.</span>__version__<span>}</span></span><span>"</span></span><span>)</span><br><span>print</span><span>(</span><span><span>f"scanpy==</span><span><span>{</span>sc<span>.</span>__version__<span>}</span></span><span>"</span></span><span>)</span><br><br><span>import</span> cell2location <span>as</span> c2l<br><span>from</span> cell2location<span>.</span>utils <span>import</span> select_slide<br><br><span>##load</span><br>adata_vis <span>=</span> sc<span>.</span>read<span>(</span><span><span>f".h5ad"</span></span><span>)</span><br><br>Niche_NMF_palette <span>=</span> <span>dict</span><span>(</span><span>zip</span><span>(</span>adata_vis<span>.</span>obs<span>.</span>Niche_NMF<span>.</span>cat<span>.</span>categories<span>,</span> adata_vis<span>.</span>uns<span>[</span><span>"Niche_NMF_colors"</span><span>]</span><span>)</span><span>)</span><br><br>sc<span>.</span>pl<span>.</span>umap<span>(</span>adata_vis<span>,</span> color<span>=</span><span>"Niche_NMF"</span><span>,</span> palette<span>=</span>Niche_NMF_palette<span>,</span><span>)</span><br><br><span>import</span> hotspot<br><br><span>def</span> <span>compute_scores_hotspot</span><span>(</span>adata<span>,</span><br>                             genes<span>,</span><br>                             layer<span>=</span><span>None</span><span>,</span><br>                             n_neighbors <span>=</span> <span>30</span><span>,</span><br>                             neighborhood_factor <span>=</span> <span>3</span><span>,</span><br>                             gene_symbols <span>=</span> <span>None</span><span>,</span><br>                             use_rep <span>=</span> <span>"X_scVI"</span><span>,</span><br>                             model <span>=</span> <span>'danb'</span><br>                            <span>)</span><span>:</span><br>    <br>    <br>    <br>    <span>if</span> use_rep <span>is</span> <span>None</span><span>:</span><br>        <span>if</span> layer <span>is</span> <span>None</span><span>:</span><br>            index <span>=</span> pynndescent<span>.</span>NNDescent<span>(</span>adata<span>.</span>X<span>,</span> n_neighbors<span>=</span>n_neighbors<span>+</span><span>1</span><span>)</span><br>        <span>else</span><span>:</span><br>            index <span>=</span> pynndescent<span>.</span>NNDescent<span>(</span>adata<span>.</span>layers<span>[</span>layer<span>]</span><span>,</span> n_neighbors<span>=</span>n_neighbors<span>+</span><span>1</span><span>)</span><br>    <span>else</span><span>:</span><br>        index <span>=</span> pynndescent<span>.</span>NNDescent<span>(</span>adata<span>.</span>obsm<span>[</span>use_rep<span>]</span><span>,</span> n_neighbors<span>=</span>n_neighbors<span>+</span><span>1</span><span>)</span><br>    <br>    ind<span>,</span> dist <span>=</span> index<span>.</span>neighbor_graph<br>    ind<span>,</span> dist <span>=</span> ind<span>[</span><span>:</span><span>,</span> <span>1</span><span>:</span><span>]</span><span>,</span> dist<span>[</span><span>:</span><span>,</span> <span>1</span><span>:</span><span>]</span><br>    <br>    ind <span>=</span> pd<span>.</span>DataFrame<span>(</span>ind<span>,</span> index<span>=</span><span>list</span><span>(</span><span>range</span><span>(</span>adata<span>.</span>n_obs<span>)</span><span>)</span><span>)</span><br>    neighbors <span>=</span> ind<br>    <br>    weights <span>=</span> compute_weights<span>(</span>dist<span>,</span> neighborhood_factor<span>=</span>neighborhood_factor<span>)</span><br>    weights <span>=</span> pd<span>.</span>DataFrame<span>(</span>weights<span>,</span> index<span>=</span>neighbors<span>.</span>index<span>,</span><br>                           columns<span>=</span>neighbors<span>.</span>columns<span>)</span><br>    <br>       <br>    <span>if</span> layer <span>is</span> <span>None</span><span>:</span><br>        <span>if</span> scipy<span>.</span>sparse<span>.</span>issparse<span>(</span>adata<span>.</span>X<span>)</span><span>:</span><br>            umi_counts <span>=</span> adata<span>.</span>X<span>.</span><span>sum</span><span>(</span>axis<span>=</span><span>1</span><span>)</span><span>.</span>A1<br>        <span>else</span><span>:</span><br>            umi_counts <span>=</span> adata<span>.</span>X<span>.</span><span>sum</span><span>(</span>axis<span>=</span><span>1</span><span>)</span><br><br>    <span>else</span><span>:</span><br>        <span>if</span> scipy<span>.</span>sparse<span>.</span>issparse<span>(</span>adata<span>.</span>layers<span>[</span>layer<span>]</span><span>)</span><span>:</span><br>            umi_counts <span>=</span> adata<span>.</span>layers<span>[</span>layer<span>]</span><span>.</span><span>sum</span><span>(</span>axis<span>=</span><span>1</span><span>)</span><span>.</span>A1<br>        <span>else</span><span>:</span><br>            umi_counts <span>=</span> adata<span>.</span>layers<span>[</span>layer<span>]</span><span>.</span><span>sum</span><span>(</span>axis<span>=</span><span>1</span><span>)</span><br>        <br>    <span>if</span> gene_symbols <span>is</span> <span>None</span><span>:</span><br>        counts_dense <span>=</span> Hotspot<span>.</span>_counts_from_anndata<span>(</span><br>                    adata<span>[</span><span>:</span><span>,</span> adata<span>.</span>var_names<span>.</span>isin<span>(</span>genes<span>)</span><span>]</span><span>,</span> layer<span>,</span> dense<span>=</span><span>True</span><span>)</span><br>    <span>else</span><span>:</span> <br>        counts_dense <span>=</span> Hotspot<span>.</span>_counts_from_anndata<span>(</span><br>                    adata<span>[</span><span>:</span><span>,</span> adata<span>.</span>var<span>[</span>gene_symbols<span>]</span><span>.</span>isin<span>(</span>genes<span>)</span><span>]</span><span>,</span> layer<span>,</span> dense<span>=</span><span>True</span><span>)</span><br>        <br><br>    scores <span>=</span> modules<span>.</span>compute_scores<span>(</span><br>        counts_dense<span>,</span><br>        model<span>,</span><br>        umi_counts<span>,</span><br>        neighbors<span>.</span>values<span>,</span><br>        weights<span>.</span>values<span>,</span><br>    <span>)</span><br><br>    <span>return</span> scores<br><br><span>import</span> pynndescent<br><span>import</span> scipy<span>.</span>sparse <br><br><span>import</span> hotspot<br><span>from</span> hotspot <span>import</span> modules<br><span>from</span> hotspot<span>.</span>knn <span>import</span> compute_weights<br><span>from</span> hotspot<span>.</span>hotspot <span>import</span> Hotspot<br><br>senescence <span>=</span><span>[</span><span>"GLB1"</span><span>,</span><span>"TP53"</span><span>,</span><span>"SERPINE1"</span><span>,</span><span>"CDKN1A"</span><span>,</span><span>"CDKN1B"</span><span>,</span><span>"CDKN2B"</span><span>]</span><br><br>scores <span>=</span> compute_scores_hotspot<span>(</span>adata_vis<span>,</span> senescence<span>,</span>layer<span>=</span><span>"log1p"</span><span>,</span>n_neighbors <span>=</span> <span>30</span><span>,</span>neighborhood_factor <span>=</span> <span>3</span><span>,</span>gene_symbols <span>=</span> <span>None</span><span>,</span>use_rep <span>=</span> <span>"X_scVI"</span><span>,</span>model <span>=</span> <span>'danb'</span><span>)</span><br>adata_vis<span>.</span>obs<span>[</span><span>"senescence_hs_score"</span><span>]</span> <span>=</span> scores<br><br><span>#for i in fibs:</span><br>    gene <span>=</span> <span>"senescence_hs_score"</span><br>    vmins <span>=</span> <span>None</span><br>    vcenters<span>=</span> <span>None</span><br>    vmaxs <span>=</span> <span>2</span><br>    img_keys<span>=</span><span>'lowres'</span><br>    cmaps<span>=</span> <span>"bwr"</span><br>    palettes<span>=</span>Niche_NMF_palette<br>    group<span>=</span> <span>None</span> <span>#"Fibrotic"</span><br>    <span>import</span> matplotlib<span>.</span>pyplot <span>as</span> plt<br>    <span>from</span> cell2location<span>.</span>utils <span>import</span> select_slide<br>    fig<span>,</span> <span>(</span>ax1<span>,</span> ax2<span>,</span> ax3<span>,</span> ax4<span>,</span> ax5<span>,</span>ax6<span>)</span> <span>=</span> plt<span>.</span>subplots<span>(</span><span>1</span><span>,</span> <span>6</span><span>,</span> figsize<span>=</span><span>(</span><span>26</span><span>,</span><span>4</span><span>)</span><span>,</span> <span>)</span><br>    plt<span>.</span>suptitle<span>(</span><span>"                                                                          control                           "</span><span>,</span> y<span>=</span><span>1.05</span><span>)</span><br>    <span>with</span> plt<span>.</span>rc_context<span>(</span><span>{</span><span>'axes.facecolor'</span><span>:</span>  <span>'white'</span><span>,</span><span>'figure.figsize'</span><span>:</span> <span>[</span><span>4</span><span>,</span> <span>4</span><span>]</span><span>}</span><span>)</span><span>:</span><br>        slide <span>=</span> select_slide<span>(</span>adata_vis<span>,</span> <span>"90_C1_RO-730_Healthy_processed_CM"</span><span>)</span><br>        sc<span>.</span>pl<span>.</span>spatial<span>(</span>slide<span>,</span> cmap<span>=</span>cmaps<span>,</span>color<span>=</span>gene<span>,</span>size<span>=</span><span>1.3</span><span>,</span>img_key<span>=</span>img_keys<span>,</span>vmin<span>=</span>vmins<span>,</span> use_raw<span>=</span><span>False</span><span>,</span>layer<span>=</span><span>"log1p"</span><span>,</span>groups<span>=</span>group<span>,</span> vmax<span>=</span>vmaxs<span>,</span> ax<span>=</span>ax1<span>,</span> show<span>=</span><span>False</span><span>,</span>vcenter<span>=</span> vcenters<span>,</span>palette<span>=</span>palettes<span>,</span> legend_loc<span>=</span><span>None</span><span>)</span><br>        slide <span>=</span> select_slide<span>(</span>adata_vis<span>,</span> <span>"91_A1_RO-727_Healthy_processed_CM"</span><span>)</span><br>        sc<span>.</span>pl<span>.</span>spatial<span>(</span>slide<span>,</span> cmap<span>=</span>cmaps<span>,</span>color<span>=</span>gene<span>,</span>size<span>=</span><span>1.3</span><span>,</span>img_key<span>=</span>img_keys<span>,</span>vmin<span>=</span>vmins<span>,</span> use_raw<span>=</span><span>False</span><span>,</span>layer<span>=</span><span>"log1p"</span><span>,</span>groups<span>=</span>group<span>,</span> vmax<span>=</span>vmaxs<span>,</span> ax<span>=</span>ax2<span>,</span> show<span>=</span><span>False</span><span>,</span>vcenter<span>=</span> vcenters<span>,</span>palette<span>=</span>palettes<span>,</span> legend_loc<span>=</span><span>None</span><span>)</span><br>        slide <span>=</span> select_slide<span>(</span>adata_vis<span>,</span> <span>"91_B1_RO-728_Healthy_processed_CM"</span><span>)</span><br>        sc<span>.</span>pl<span>.</span>spatial<span>(</span>slide<span>,</span> cmap<span>=</span>cmaps<span>,</span>color<span>=</span>gene<span>,</span>size<span>=</span><span>1.3</span><span>,</span>img_key<span>=</span>img_keys<span>,</span>vmin<span>=</span>vmins<span>,</span> use_raw<span>=</span><span>False</span><span>,</span>layer<span>=</span><span>"log1p"</span><span>,</span>groups<span>=</span>group<span>,</span> vmax<span>=</span>vmaxs<span>,</span> ax<span>=</span>ax3<span>,</span> show<span>=</span><span>False</span><span>,</span>vcenter<span>=</span> vcenters<span>,</span>palette<span>=</span>palettes<span>,</span> legend_loc<span>=</span><span>None</span><span>)</span><br>        slide <span>=</span> select_slide<span>(</span>adata_vis<span>,</span> <span>"1217_0002_processed_aligned"</span><span>)</span><br>        sc<span>.</span>pl<span>.</span>spatial<span>(</span>slide<span>,</span> cmap<span>=</span>cmaps<span>,</span>color<span>=</span>gene<span>,</span>size<span>=</span><span>1.3</span><span>,</span>img_key<span>=</span>img_keys<span>,</span>vmin<span>=</span>vmins<span>,</span> use_raw<span>=</span><span>False</span><span>,</span>layer<span>=</span><span>"log1p"</span><span>,</span>groups<span>=</span>group<span>,</span> vmax<span>=</span>vmaxs<span>,</span> ax<span>=</span>ax4<span>,</span> show<span>=</span><span>False</span><span>,</span>vcenter<span>=</span> vcenters<span>,</span>palette<span>=</span>palettes<span>,</span> legend_loc<span>=</span><span>None</span><span>)</span><br>        slide <span>=</span> select_slide<span>(</span>adata_vis<span>,</span> <span>"92_A1_RO-3203_Healthy_processed_CM"</span><span>)</span><br>        sc<span>.</span>pl<span>.</span>spatial<span>(</span>slide<span>,</span> cmap<span>=</span>cmaps<span>,</span>color<span>=</span>gene<span>,</span>size<span>=</span><span>1.3</span><span>,</span>img_key<span>=</span>img_keys<span>,</span>vmin<span>=</span>vmins<span>,</span> use_raw<span>=</span><span>False</span><span>,</span>layer<span>=</span><span>"log1p"</span><span>,</span>groups<span>=</span>group<span>,</span> vmax<span>=</span>vmaxs<span>,</span> ax<span>=</span>ax5<span>,</span> show<span>=</span><span>False</span><span>,</span>vcenter<span>=</span> vcenters<span>,</span>palette<span>=</span>palettes<span>,</span> legend_loc<span>=</span><span>None</span><span>)</span><br>        slide <span>=</span> select_slide<span>(</span>adata_vis<span>,</span> <span>"1217_0004_processed_aligned"</span><span>)</span><br>        sc<span>.</span>pl<span>.</span>spatial<span>(</span>slide<span>,</span> cmap<span>=</span>cmaps<span>,</span>color<span>=</span>gene<span>,</span>size<span>=</span><span>1.3</span><span>,</span>img_key<span>=</span>img_keys<span>,</span>vmin<span>=</span>vmins<span>,</span> use_raw<span>=</span><span>False</span><span>,</span>layer<span>=</span><span>"log1p"</span><span>,</span>groups<span>=</span>group<span>,</span> vmax<span>=</span>vmaxs<span>,</span> ax<span>=</span>ax6<span>,</span> show<span>=</span><span>False</span><span>,</span>vcenter<span>=</span> vcenters<span>,</span>palette<span>=</span>palettes<span>,</span> legend_loc<span>=</span><span>None</span><span>)</span><br>    plt<span>.</span>savefig<span>(</span><span>"./figures/spatial_plot_senescence_hs_score_healthy_vmax2.pdf"</span><span>)</span>   <br>    fig<span>,</span> <span>(</span>ax7<span>,</span> ax8<span>,</span> ax9<span>,</span> ax10<span>,</span> ax11<span>,</span><span>)</span> <span>=</span> plt<span>.</span>subplots<span>(</span><span>1</span><span>,</span> <span>5</span><span>,</span> figsize<span>=</span><span>(</span><span>22</span><span>,</span><span>4</span><span>)</span><span>,</span> <span>)</span><br>    plt<span>.</span>suptitle<span>(</span><span>"                                                                          IPF                           "</span><span>,</span> y<span>=</span><span>1.05</span><span>)</span><br>    <span>with</span> plt<span>.</span>rc_context<span>(</span><span>{</span><span>'axes.facecolor'</span><span>:</span>  <span>'white'</span><span>,</span><span>'figure.figsize'</span><span>:</span> <span>[</span><span>4</span><span>,</span> <span>4</span><span>]</span><span>}</span><span>)</span><span>:</span><br>        slide <span>=</span> select_slide<span>(</span>adata_vis<span>,</span> <span>"90_A1_H237762_IPF_processed_CM"</span><span>)</span><br>        sc<span>.</span>pl<span>.</span>spatial<span>(</span>slide<span>,</span> cmap<span>=</span>cmaps<span>,</span>color<span>=</span>gene<span>,</span>size<span>=</span><span>1.3</span><span>,</span>img_key<span>=</span>img_keys<span>,</span>vmin<span>=</span>vmins<span>,</span> use_raw<span>=</span><span>False</span><span>,</span>layer<span>=</span><span>"log1p"</span><span>,</span>groups<span>=</span>group<span>,</span> vmax<span>=</span>vmaxs<span>,</span> ax<span>=</span>ax7<span>,</span> show<span>=</span><span>False</span><span>,</span>vcenter<span>=</span> vcenters<span>,</span>palette<span>=</span>palettes<span>,</span> legend_loc<span>=</span><span>None</span><span>)</span><br>        slide <span>=</span> select_slide<span>(</span>adata_vis<span>,</span> <span>"1217_0001_processed_aligned"</span><span>)</span><br>        sc<span>.</span>pl<span>.</span>spatial<span>(</span>slide<span>,</span> cmap<span>=</span>cmaps<span>,</span>color<span>=</span>gene<span>,</span>size<span>=</span><span>1.3</span><span>,</span>img_key<span>=</span>img_keys<span>,</span>vmin<span>=</span>vmins<span>,</span> use_raw<span>=</span><span>False</span><span>,</span>layer<span>=</span><span>"log1p"</span><span>,</span>groups<span>=</span>group<span>,</span> vmax<span>=</span>vmaxs<span>,</span> ax<span>=</span>ax8<span>,</span> show<span>=</span><span>False</span><span>,</span>vcenter<span>=</span> vcenters<span>,</span>palette<span>=</span>palettes<span>,</span> legend_loc<span>=</span><span>None</span><span>)</span><br>        slide <span>=</span> select_slide<span>(</span>adata_vis<span>,</span> <span>"91_D1_24513-17_IPF_processed_CM"</span><span>)</span><br>        sc<span>.</span>pl<span>.</span>spatial<span>(</span>slide<span>,</span> cmap<span>=</span>cmaps<span>,</span>color<span>=</span>gene<span>,</span>size<span>=</span><span>1.3</span><span>,</span>img_key<span>=</span>img_keys<span>,</span>vmin<span>=</span>vmins<span>,</span> use_raw<span>=</span><span>False</span><span>,</span>layer<span>=</span><span>"log1p"</span><span>,</span>groups<span>=</span>group<span>,</span> vmax<span>=</span>vmaxs<span>,</span> ax<span>=</span>ax9<span>,</span> show<span>=</span><span>False</span><span>,</span>vcenter<span>=</span> vcenters<span>,</span>palette<span>=</span>palettes<span>,</span> legend_loc<span>=</span><span>None</span><span>)</span><br>        slide <span>=</span> select_slide<span>(</span>adata_vis<span>,</span> <span>"1217_0003_processed_aligned"</span><span>)</span><br>        sc<span>.</span>pl<span>.</span>spatial<span>(</span>slide<span>,</span> cmap<span>=</span>cmaps<span>,</span>color<span>=</span>gene<span>,</span>size<span>=</span><span>1.3</span><span>,</span>img_key<span>=</span>img_keys<span>,</span>vmin<span>=</span>vmins<span>,</span> use_raw<span>=</span><span>False</span><span>,</span>layer<span>=</span><span>"log1p"</span><span>,</span>groups<span>=</span>group<span>,</span> vmax<span>=</span>vmaxs<span>,</span> ax<span>=</span>ax10<span>,</span> show<span>=</span><span>False</span><span>,</span>vcenter<span>=</span> vcenters<span>,</span>palette<span>=</span>palettes<span>,</span> legend_loc<span>=</span><span>None</span><span>)</span><br>        slide <span>=</span> select_slide<span>(</span>adata_vis<span>,</span> <span>"92_D1_RO-3736_IPF_processed_CM"</span><span>)</span><br>        sc<span>.</span>pl<span>.</span>spatial<span>(</span>slide<span>,</span> cmap<span>=</span>cmaps<span>,</span>color<span>=</span>gene<span>,</span>size<span>=</span><span>1.3</span><span>,</span>img_key<span>=</span>img_keys<span>,</span>vmin<span>=</span>vmins<span>,</span> use_raw<span>=</span><span>False</span><span>,</span>layer<span>=</span><span>"log1p"</span><span>,</span>groups<span>=</span>group<span>,</span> vmax<span>=</span>vmaxs<span>,</span> ax<span>=</span>ax11<span>,</span> show<span>=</span><span>False</span><span>,</span>vcenter<span>=</span> vcenters<span>,</span>palette<span>=</span>palettes<span>)</span><br>    plt<span>.</span>savefig<span>(</span><span>"./figures/spatial_plot_senescence_hs_score_IPF_vmax2.pdf"</span><span>)</span>   <br><span aria-hidden="true"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img data-imgfileid="100008873" data-ratio="0.23055555555555557" data-type="other" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYW7bUahicyVT1yIPQSecIM2iabscIFfasCarRCBCeiauSFicNIq4MnUibqA2Q/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmnukMfJIlYtrwAPuXVmAAYW7bUahicyVT1yIPQSecIM2iabscIFfasCarRCBCeiauSFicNIq4MnUibqA2Q/640?wx_fmt=other&amp;from=appmsg"></p><p><img data-galleryid="" data-imgfileid="100008878" data-ratio="0.1824074074074074" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/srXAibe95MmnukMfJIlYtrwAPuXVmAAYW5l9odexu9rztbqAXCN0jW5bVIxaJgKynMR0UUeSMIia9ywiaWHibD8Frw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/srXAibe95MmnukMfJIlYtrwAPuXVmAAYW5l9odexu9rztbqAXCN0jW5bVIxaJgKynMR0UUeSMIia9ywiaWHibD8Frw/640?wx_fmt=png&amp;from=appmsg"></p><h4>生活很好，有你更好</h4><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/J_64aADP04htUKIAz5zKTw",target="_blank" rel="noopener noreferrer">原文链接</a>
