---
title: "单细胞分析全流程：数据下载、多样本整合、QC及DecontX"
date: 2024-08-01T12:42:25Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
单细胞分析全流程：数据下载、多样本整合、QC及DecontX by 生信菜鸟团
------
<div><blockquote data-tool="mdnice编辑器"><p><span>从我们</span><span>生信技能树</span><span>历年的几千个马拉松授课学员里面募集了一些优秀的创作者，某种意义来说是传承了我们生信技能树的知识整理和分享的思想！</span></p></blockquote><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">今天的是学员一点一滴整理的授课知识点笔记哦，还有互动练习题哈，欢迎大家点击文末的阅读原文去关注我们学员的公众号哦！</p><p><br></p><p><br></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h4 data-tool="mdnice编辑器">准备开一个系列教程，回顾一下自己学过的单细胞知识，希望对大家有所帮助~<br></h4><h5 data-tool="mdnice编辑器">数据下载</h5><p data-tool="mdnice编辑器">首先要说一下如何找到自己想要的数据集。我一般会通过文献，在pubmed上按疾病+scRNA的策略进行检索，能够得到相关文献。绝大多数的文章都会包含下图中的信息，告诉你文章用到的数据上传到了哪个数据库，这里作者是上传到了cellxgene数据库上面。如果是上传到GEO，那么往往会提供GSE号。</p><p><img data-ratio="0.5125284738041003" data-s="300,640" data-type="png" data-w="439" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GU7DKpBLwKFGDb77Q981mMmKU68wWuZzwDibltKD8Pib9Z1IlZzboiaDhiaky05EbFLKqZ4zib3EuQTzsg/640?wx_fmt=png&amp;wxfrom=13&amp;tp=wxpic" data-imgfileid="100042189" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GU7DKpBLwKFGDb77Q981mMmKU68wWuZzwDibltKD8Pib9Z1IlZzboiaDhiaky05EbFLKqZ4zib3EuQTzsg/640?wx_fmt=png&amp;wxfrom=13&amp;tp=wxpic"></p><p data-tool="mdnice编辑器">我们最常用的数据库还是GEO，下载数据很简单，搜索在前面得到的GSE号就可以进入到数据集下载页面。之前的推文中已经介绍过标准10x三个文件还有矩阵形式的单细胞数据的读取方式，今天我选择了一个h5格式的数据进行分析，掌握这三种格式的读取方式基本能满足90%以上数据集的需求。这个数据集包含了5个样本，点击下图中的http开始进行下载。完成后解压到文件夹中。开始分析，具体说明在代码部分进行了注释。</p><p><img data-ratio="0.48839907192575405" data-s="300,640" data-type="png" data-w="862" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GU7DKpBLwKFGDb77Q981mMm4Su77mibibJZrOPFNryPfZRrWkL9UDWVpBE9eNZxcMs1VAUiabFwBvtTA/640?wx_fmt=png&amp;wxfrom=13&amp;tp=wxpic" data-imgfileid="100042187" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GU7DKpBLwKFGDb77Q981mMm4Su77mibibJZrOPFNryPfZRrWkL9UDWVpBE9eNZxcMs1VAUiabFwBvtTA/640?wx_fmt=png&amp;wxfrom=13&amp;tp=wxpic"></p><h5 data-tool="mdnice编辑器">读取数据</h5><pre data-tool="mdnice编辑器"><span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/XCopLcwfzefB8gj7MQANDowkbf3QMZYFoZoNqQzM3hzLKCBQqTqlhfoXYXJJD1MYrCXrbA2YdgRwtlaRZ4aiaGmjsU8MI5zAn/640?wx_fmt=svg" data-fail="0"></span><code><span>#读取h5格式数据需要用到hdf5r包</span><br>options(stringsAsFactors = <span>F</span>)<br>BiocManager::install(<span>"hdf5r"</span>)<br><span>library</span>(Seurat)<br><span>library</span>(hdf5r)<br><span>library</span>(tidyverse)<br><span>library</span>(data.table)<br>dir = <span>"E:/scRNA/单细胞转录组/output/"</span><span>#设置数据存放路径</span><br>setwd(dir)<span>#工作路径设置</span><br>fs &lt;- list.files(pattern = <span>".h5"</span>)<span>#读取该目录下所有h5格式文件</span><br>sceList = lapply(fs, <span>function</span>(x){<br>  <span># x=fs[1]</span><br>  print(x)<br>  a=Read10X_h5( x )<br>  a[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>] <br>  <span>library</span>(stringr)<br>  (p=str_split(x,<span>'_'</span>,simplify = <span>T</span>)[,<span>2</span>])<span>#把文件名按_进行拆分，保留第二部分，自行按需修改</span><br>  sce &lt;- CreateSeuratObject( a ,project = p )<br>  sce<br>})<br>setwd(<span>'../'</span>)<br><br></code></pre><p data-tool="mdnice编辑器">最终我们得到的是一个包含多个seurat对象的list</p><h5 data-tool="mdnice编辑器">质控</h5><pre data-tool="mdnice编辑器"><span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/XCopLcwfzefB8gj7MQANDowkbf3QMZYFoZoNqQzM3hzLKCBQqTqlhfoXYXJJD1MYrCXrbA2YdgRwtlaRZ4aiaGmjsU8MI5zAn/640?wx_fmt=svg" data-fail="0"></span><code><span>for</span>(i <span>in</span> <span>1</span>:length(sceList)){<br>  sc &lt;- sceList[[i]]<br>  sc &lt;- sceList[[i]]<br>  <span># 计算线粒体比例</span><br>  sc[[<span>"mt_percent"</span>]] &lt;- PercentageFeatureSet(sc, pattern = <span>"^mt-"</span>)<br>  <span># 将sc赋值给scRNAlist[[i]]</span><br>  sceList[[i]] &lt;- sc<br>  <span># 删除sc</span><br>  rm(sc)<br>}<br>sceList &lt;- lapply(X = sceList, FUN = <span>function</span>(x){<br>  x &lt;- subset(x, <br>              subset = nFeature_RNA &gt; <span>300</span> &amp; nFeature_RNA &lt; <span>7000</span> &amp; <br>                mt_percent &lt; <span>10</span> )})<br>sceList &lt;- merge(sceList [[<span>1</span>]],y=sceList [c(<span>2</span>:length(sceList))])<br>table(sceList$orig.ident)<br>saveRDS(sceList,file = <span>"sce.RDS"</span>)<br></code></pre><p data-tool="mdnice编辑器">这里结合了原文的一些质控条件只根据线粒体基因比例进行了过滤，这里的10并不是固定的，还可以根据红细胞基因比例、细胞周期等进行过滤，无非是把pattern改一改，方法大同小异，在此不再过多介绍。</p><h5 data-tool="mdnice编辑器">DecontX去除RNA污染</h5><p data-tool="mdnice编辑器">这一步可做可不做，正好前两天生信技能树上写到了这个包，这里就尝试一下。作用是什么呢？我们来看下面两张图，很明显一张图中亚群之间黏连细胞很多而另一张则分群十分清晰，这种黏连散在的细胞一般认为是污染严重的低质量细胞，这时候我们可以通过DecontX去除这些细胞，使分群的界限更加清晰。</p><p><img data-backh="268" data-backw="228" data-ratio="1.174496644295302" data-s="300,640" data-type="png" data-w="298" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GU7DKpBLwKFGDb77Q981mMmP6vz8W94S3ZicqFoQTht2U7qkU4YJicicmhLkEsjvDsk2LAbicgyYb5dmg/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-imgfileid="100042188" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GU7DKpBLwKFGDb77Q981mMmP6vz8W94S3ZicqFoQTht2U7qkU4YJicicmhLkEsjvDsk2LAbicgyYb5dmg/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p><img data-backh="178" data-backw="230" data-ratio="0.7734806629834254" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GU7DKpBLwKFGDb77Q981mMm2BkAmJBvXoDvVCItuhGh7yOia1icgFoV6h5XPR0RibuldxhOXdU5swlCw/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="362" data-imgfileid="100042194" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GU7DKpBLwKFGDb77Q981mMm2BkAmJBvXoDvVCItuhGh7yOia1icgFoV6h5XPR0RibuldxhOXdU5swlCw/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><pre data-tool="mdnice编辑器"><span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/XCopLcwfzefB8gj7MQANDowkbf3QMZYFoZoNqQzM3hzLKCBQqTqlhfoXYXJJD1MYrCXrbA2YdgRwtlaRZ4aiaGmjsU8MI5zAn/640?wx_fmt=svg" data-fail="0"></span><code>rm(list = ls())<br>sce &lt;- readRDS(<span>"sce.RDS"</span>)<br><span>library</span>(devtools)<br>devtools::install_github(<span>"campbio/decontX"</span>)<br><span>library</span>(decontX)<br><span>#提取counts矩阵</span><br>view(sce)<br>counts &lt;- sce@assays$RNA@counts<br>decontX_results &lt;- decontX(counts)<br>sce$contamination &lt;- decontX_results$contamination<br><span>###根据contamination值进行过滤，一般是保留&lt;0.2的细胞,这里过滤掉了7000多个细胞,其实有点多，可能会丢失过多的信息。</span><br>sce_filt &lt;- sce[,sce$contamination&lt;<span>0.2</span>]<br>saveRDS(sce,file = <span>"sce.RDS"</span>)<br>saveRDS(sce_filt,file = <span>"sce_filt.RDS"</span>)<br></code></pre><h5 data-tool="mdnice编辑器">整合数据：harmony</h5><p data-tool="mdnice编辑器">原文用的是CCA，但我个人更喜欢harmony，速度快，计算资源消耗小</p><pre data-tool="mdnice编辑器"><span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/XCopLcwfzefB8gj7MQANDowkbf3QMZYFoZoNqQzM3hzLKCBQqTqlhfoXYXJJD1MYrCXrbA2YdgRwtlaRZ4aiaGmjsU8MI5zAn/640?wx_fmt=svg" data-fail="0"></span><code>rm(list = ls())<br>sce &lt;- readRDS(<span>"../sce_filt.RDS"</span>)<br>dir.create(<span>"2-harmony"</span>)<br>setwd(<span>"./2-harmony"</span>)<br>sce &lt;- NormalizeData(sce,normalization.method = <span>"LogNormalize"</span>,<br>                     scale.factor = <span>1e4</span>)<br>sce &lt;- FindVariableFeatures(sce)<span>#找高变，可以自行修改参数，写完整的话就是FindVariableFeatures(sce, selection.method = "vst", nfeatures = 2000) </span><br>sce &lt;- ScaleData(sce)<span>#这一步的数据其实仅为PCA降维服务</span><br>sce &lt;- RunPCA(sce,features = VariableFeatures(object = sce))<br>ElbowPlot(scRNA1, ndims=<span>50</span>, reduction=<span>"pca"</span>)<span>#查看多少PC数比较合理，一般来讲可以选择10-50之间。PC数越大保留的信息越完整，但随之而来的是技术噪音的增大。后续我们选择了15个PC进行分析</span><br><span>library</span>(harmony)<br>obj &lt;- RunHarmony(sce,<span>"orig.ident"</span>)<br>names(obj@reductions)<br>obj &lt;- RunUMAP(obj,dims = <span>1</span>:<span>15</span>,<br>               reduction = <span>"harmony"</span>)<br>DimPlot(obj, reduction = <span>"umap"</span>,label = <span>T</span>)<br>sce &lt;- obj<br>sce &lt;- FindNeighbors(sce,reduction = <span>"harmony"</span>,<br>                     dims = <span>1</span>:<span>15</span>)<br><span>#在不同分辨率下进行聚类</span><br><span>for</span> (res <span>in</span> c(<span>0.01</span>, <span>0.05</span>, <span>0.1</span>, <span>0.2</span> ,<span>0.3</span>, <span>0.5</span>, <span>0.8</span>, <span>1</span>)) {<br>  sce = FindClusters(sce,<br>                     resolution = res, algorithm = <span>1</span>)<br>  <br>}<br>rm(obj)<br>head(colnames(sce))<br>table(sce$orig.ident)<br>apply(sce@meta.data[,grep(<span>"RNA_snn"</span>,colnames(sce@meta.data))],<span>2</span>,table)<span>#把不同resolution的结果添加到metadata中。</span><br>DimPlot(sce,reduction = <span>"umap"</span>,label = <span>F</span>,group.by = <span>"orig.ident"</span>)<br></code></pre><p data-tool="mdnice编辑器">比较一下DecontX前后的分群状态，这里呢效果不是非常好，但可以很明显的感受到DecontX之后的分群要更加分明。</p><p><img data-galleryid="" data-ratio="0.7110016420361248" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GU7DKpBLwKFGDb77Q981mMmyhHONRmXAtR5Un9r8HbHmpr0aibicDHwmDCPpj6fOBOvOsibXmc9JgUhg/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="609" data-imgfileid="100042193" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GU7DKpBLwKFGDb77Q981mMmyhHONRmXAtR5Un9r8HbHmpr0aibicDHwmDCPpj6fOBOvOsibXmc9JgUhg/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p><img data-galleryid="" data-ratio="0.7110016420361248" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GU7DKpBLwKFGDb77Q981mMmfyrnGKXOzHecJhjwD84hIIhVTiauHDAJLoF0euiaYWccibvtKFbDBic0Cw/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="609" data-imgfileid="100042191" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GU7DKpBLwKFGDb77Q981mMmfyrnGKXOzHecJhjwD84hIIhVTiauHDAJLoF0euiaYWccibvtKFbDBic0Cw/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p data-tool="mdnice编辑器">下一期我们来讲讲细胞注释那些事。</p><p data-tool="mdnice编辑器">参考文章：使用DecontX预测和去除单细胞转录组的环境游离RNA污染 · Issue #3858 · ixxmu/mp_duty (github.com)</p><p data-tool="mdnice编辑器"><br></p><p data-tool="mdnice编辑器"><br></p><h3 data-tool="mdnice编辑器"><span>文末友情宣传</span></h3><p data-tool="mdnice编辑器"><strong>强烈建议你推荐给身边的博士后以及年轻生物学PI，多一点数据认知，让他们的科研上一个台阶：</strong></p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247530001&amp;idx=1&amp;sn=676dcf224f9be23b288189775292aeeb&amp;chksm=9b4b36aaac3cbfbc3e3bb0865bd789d5093e3a643f3f345332995f707b7f209ae924e9e9529e&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买‍一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;scene=21#wechat_redirect" data-linktype="2">时隔5年，我们的生信技能树VIP学徒继续招生啦</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528363&amp;idx=1&amp;sn=5e02f3e9b2e148191e23ebc2c0d780e7&amp;scene=21#wechat_redirect" data-linktype="2">2024的共享服务器交个朋友福利价仍然是800</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;scene=21#wechat_redirect" data-linktype="2">千呼万唤始出来的独享生物信息学云服务器</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528144&amp;idx=1&amp;sn=be4d7e542d1077921024c86a4c130f16&amp;scene=21#wechat_redirect" data-linktype="2">永久免费的生信进阶培训（线下）</a></section></li></ul><p data-tool="mdnice编辑器"><br></p></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/UiO7AQczrcMdKENCWkLRCQ",target="_blank" rel="noopener noreferrer">原文链接</a>
