---
title: "同一个单细胞数据集，两种格式的处理方法"
date: 2024-08-07T04:40:10Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
同一个单细胞数据集，两种格式的处理方法 by 生信菜鸟团
------
<div><section><p>今天我们来看一个人类骨髓的单细胞数据集，同时提供了两种数据格式，试试两种格式读取~</p><p><img data-backh="375" data-backw="375" data-imgfileid="100042714" data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibjvUgjFKMYxnhibLnn36jLswGFNWtzlGKgRKD1ALXBfiagoJu1Szlw8y35Iy3vQfrYInOWwkv7yZibQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="375" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibjvUgjFKMYxnhibLnn36jLswGFNWtzlGKgRKD1ALXBfiagoJu1Szlw8y35Iy3vQfrYInOWwkv7yZibQ/640?wx_fmt=png&amp;from=appmsg"></p><blockquote><p>https://www.cell.com/iscience/fulltext/S2589-0042(23)01020-9?_returnURL=https%3A%2F%2Flinkinghub.elsevier.com%2Fretrieve%2Fpii%2FS2589004223010209%3Fshowall%3Dtrue#secsectitle0020</p></blockquote><blockquote><p>代码在Github (https://github.com/Sarah145/bone_marrow_analysis).</p><p>同时提供了GSE的matrix格式数据和h5数据：The <span>「raw scRNA-seq data」</span> that was generated as part of this study is available on GEO (GSE227903) and the <span>「integrated scRNA-seq」</span> atlas of the bone marrow in health and AML is available on zenodo.</p></blockquote><p>试试看两种类型的数据读取吧~</p><h2>基于Seurat的raw scRNA-seq 数据</h2><p><img data-backh="46" data-backw="562" data-imgfileid="100042715" data-ratio="0.08149171270718232" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibjvUgjFKMYxnhibLnn36jLsZOwicKhYJq5PlM2jtEtxwaCJ8X0k4rGgwucYw7m2vZ4qHFKUJgMAdyw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="724" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibjvUgjFKMYxnhibLnn36jLsZOwicKhYJq5PlM2jtEtxwaCJ8X0k4rGgwucYw7m2vZ4qHFKUJgMAdyw/640?wx_fmt=png&amp;from=appmsg"></p><p>每个样本包含<code>count</code>和<code>meta</code>两种数据。</p><p>需要注意一下count的样式</p><pre><span></span><code><span>&gt;</span> ct[<span>1</span><span>:</span><span>4</span>,<span>1</span><span>:</span><span>4</span>]<br>                  V1 MIR1302.2HG FAM138A OR4F5<br><span>1</span> AAACCCAAGCGGATCA<span>-</span><span>1</span>           <span>0</span>       <span>0</span>     <span>0</span><br><span>2</span> AAACGAAAGGGTAATT<span>-</span><span>1</span>           <span>0</span>       <span>0</span>     <span>0</span><br><span>3</span> AAACGAACATACCACA<span>-</span><span>1</span>           <span>0</span>       <span>0</span>     <span>0</span><br><span>4</span> AAACGAAGTATCAGGG<span>-</span><span>1</span>           <span>0</span>       <span>0</span>     <span>0</span><br></code></pre><p>发现问题了吗？</p><p>表达矩阵的格式应该是<code>基因 x 细胞</code>才对！</p><p>注意到这样的问题以后，再配合meta数据就顺利多了。</p><p>读来试试：</p><pre><span></span><code><span>if</span>(<span>T</span>){<br>  dir <span>&lt;-</span> <span>'../ExternalDatasets/Ennis_GSE227903_RAW/'</span><br>  samples1 <span>&lt;-</span> list.files(dir, pattern <span>=</span> <span>"count_mat.txt.gz"</span>)<br>  samples2 <span>&lt;-</span> list.files(dir, pattern <span>=</span> <span>"meta.txt.gz"</span>)<br>  <br>  <span># 读取 count 矩阵文件并创建 Seurat 对象</span><br>  sceList <span>&lt;-</span> lapply(samples1, <span>function</span>(pro) {<br>    print(pro)  <br>    ct <span>&lt;-</span> fread(file.path(dir, pro), check.names <span>=</span> <span>F</span>, data.table <span>=</span> <span>F</span>) <br>    <span>### 行为基因，列为样本</span><br>    rownames(ct) <span>&lt;-</span> ct[, <span>1</span>]<br>    ct <span>&lt;-</span> ct[, <span>-</span><span>1</span>]<br>    count <span>&lt;-</span> as.data.frame(t(ct))<br>    <br>    <span># 找到与当前 pro 对应的 meta 文件</span><br>    meta_file <span>&lt;-</span> samples2[grep(gsub(<span>"count_mat.txt.gz"</span>, <span>""</span>, pro), samples2)]<br>    <br>    <span># 确保找到对应的 meta 文件</span><br>    <span>if</span>(<span>length</span>(meta_file) <span>==</span> <span>1</span>) {<br>      phe <span>&lt;-</span> fread(file.path(dir, meta_file), data.table <span>=</span> <span>F</span>)<br>      phe[<span>1</span><span>:</span><span>4</span>,<span>1</span><span>:</span><span>4</span>]<br>      phe<span>$</span>sample_id <span>&lt;-</span> str_split(basename(meta_file),<span>"_m"</span>,simplify <span>=</span> <span>T</span>)[,<span>1</span>] <span>##提取样本名</span><br>      rownames(phe) <span>&lt;-</span> phe<span>$</span>cell  <span>##行是细胞ID</span><br><br>      identical(phe<span>$</span>cell,colnames(count)) <span>##死去的记忆又回来了~</span><br>      <br>      sce <span>&lt;-</span> CreateSeuratObject(<br>        counts <span>=</span> count,<br>        project <span>=</span> str_split(pro,<span>"_c"</span>,simplify <span>=</span> <span>T</span>)[,<span>1</span>],<br>        meta.data <span>=</span> phe<br>      )<br>      <span>return</span>(sce)<br>    } <span>else</span> {<br>      warning(paste(<span>"Meta file not found for:"</span>, pro))<br>      <span>return</span>(<span>NULL</span>)<br>    }<br>  }) <br>  <br>  <span># 移除为空的对象</span><br>  sceList <span>&lt;-</span> Filter(Negate(<span>is.null</span>), sceList)<br>  <br>  <span># 合并所有的 Seurat 对象</span><br>  sce.all <span>&lt;-</span> merge(x <span>=</span> sceList[[<span>1</span>]], <br>                   y <span>=</span> sceList[<span>-</span><span>1</span>], <br>                   add.cell.ids <span>=</span> str_split(samples1,<span>"_c"</span>,simplify <span>=</span> <span>T</span>)[,<span>1</span>])<br>}<br></code></pre><p>将多样本合并为大的seurat对象</p><pre><span></span><code>do.call(rbind,lapply(sceList, <span>dim</span>)) <br><br><span>names</span>(sce.all<span>@</span>assays<span>$</span>RNA<span>@</span>layers)<br>sce.all[[<span>"RNA"</span>]]<span>$</span>counts <br><span># Alternate accessor function with the same result</span><br>LayerData(sce.all, assay <span>=</span> <span>"RNA"</span>, layer <span>=</span> <span>"counts"</span>)<br>sce.all <span>&lt;-</span> JoinLayers(sce.all)<br><span>dim</span>(sce.all[[<span>"RNA"</span>]]<span>$</span>counts )<br><span># 36601 111347</span><br><br>as.data.frame(sce.all<span>@</span>assays<span>$</span>RNA<span>$</span>counts[<span>1</span><span>:</span><span>10</span>, <span>1</span><span>:</span><span>2</span>])<br>head(sce.all<span>@</span>meta.data, <span>10</span>)<br>table(sce.all<span>$</span>orig.ident) <br><br>saveRDS(sce.all,<span>"./sce_Ennis.rds"</span>)<br></code></pre><h2>基于Scanpy的integrated scRNA-seq 数据</h2><p>参考了菜鸟团的这篇文章，<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247522054&amp;idx=1&amp;sn=fac73724a169c28b4faf02bcd02c7358&amp;chksm=fa45523bcd32db2d1fbe8672bcbc66bc0c48e12155bf34107b609bba312477e00a18f0f1bde9&amp;scene=21#wechat_redirect" textvalue="软件测评：百万级单细胞数据的Anndata和Seurat对象互转" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">软件测评：百万级单细胞数据的Anndata和Seurat对象互转</a></p><p>需要安装 <span>「R包dior和Python包scanpy」</span></p><pre><span></span><code>seurat.data <span>&lt;-</span> read_h5ad(file <span>=</span> <span>"../ExternalDatasets/Ennis_bone_marrow.h5ad"</span>,<br>                         assay_name <span>=</span> <span>'RNA'</span>, <br>                         target.object <span>=</span> <span>'seurat'</span>)<br></code></pre></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Ydm6X7AUwr5WYM7dCZtmzA",target="_blank" rel="noopener noreferrer">原文链接</a>
