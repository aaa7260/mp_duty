---
title: "最近很火的单细胞算法！贝叶斯非负矩阵分解（CoGAPS 包）"
date: 2024-08-02T01:28:13Z
draft: ["false"]
tags: [
  "fetched",
  "生信碱移"
]
categories: ["Acdemic"]
---
最近很火的单细胞算法！贝叶斯非负矩阵分解（CoGAPS 包） by 生信碱移
------
<div><section data-tool="markdown编辑器" data-website="https://markdown.com.cn/editor"><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><img data-ratio="1.0324675324675325" data-type="gif" data-w="154" data-src="https://mmbiz.qpic.cn/mmbiz_gif/lN9Tp5oiaqHFn9Rg6MwMU3ukMR9ROPh7bf7QWHEMwhUBUwSUKFsV8oK9noHic3jLaeJVQewHJcLq1cTXVAat35Tw/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-imgfileid="100010176" src="https://mmbiz.qpic.cn/mmbiz_gif/lN9Tp5oiaqHFn9Rg6MwMU3ukMR9ROPh7bf7QWHEMwhUBUwSUKFsV8oK9noHic3jLaeJVQewHJcLq1cTXVAat35Tw/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section></section></section></section></section><section><section powered-by="xiumi.us"><section><p>老铁快点击蓝字 <strong>关注俺</strong></p></section></section></section><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><img data-imgfileid="100010175" data-ratio="1.0324675324675325" data-src="https://mmbiz.qpic.cn/mmbiz_gif/lN9Tp5oiaqHFn9Rg6MwMU3ukMR9ROPh7bf7QWHEMwhUBUwSUKFsV8oK9noHic3jLaeJVQewHJcLq1cTXVAat35Tw/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-type="gif" data-w="154" src="https://mmbiz.qpic.cn/mmbiz_gif/lN9Tp5oiaqHFn9Rg6MwMU3ukMR9ROPh7bf7QWHEMwhUBUwSUKFsV8oK9noHic3jLaeJVQewHJcLq1cTXVAat35Tw/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section></section></section></section></section></section></section></section></section><section data-mpa-powered-by="yiban.io" data-style='white-space: normal; max-width: 100%; letter-spacing: 0.544px; text-size-adjust: auto; background-color: rgb(255, 255, 255); font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif; box-sizing: border-box !important; overflow-wrap: break-word !important;'><section><section><section><section data-id="85660" data-custom="rgb(117, 117, 118)" data-color="rgb(117, 117, 118)"><section data-style="margin-top: 2em; padding-top: 0.5em; padding-bottom: 0.5em; max-width: 100%; border-style: solid none; text-decoration: inherit; border-top-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-top-width: 1px; border-bottom-width: 1px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p><span>生信碱移</span></p><section><span><span><strong>贝叶斯NMF算法</strong></span></span></section></section></section></section></section></section></section><section>病理、生理相关的生物学过程中，不同基因各司其职。<strong>一个普遍的假设是，执行特定功能的生物学过程往往具有一定的表达模式</strong>。非负矩阵分解（NMF）是一种适合高通量生物学的无监督聚类方法。<strong>然而，仅仅从 NMF 结果推断生物过程还是需要额外的事后统计和注释分析，否则无法很好的解释学习到的基因特征规律。</strong></section><section>为此，来自美国约翰霍普金斯大学的研究者于 2023年12月11日在<span><strong>Nature Protocols </strong></span><span><strong>[</strong><strong>IF:13.1</strong><strong>]</strong></span> 杂志分享了一套流程，<strong>其中介绍了贝叶斯NMF算法（CoGAPS），并演示了如何通过 CoGAPS 分析量化公共领域单细胞 RNA 测序数据中的细胞状态转换。</strong></section><p><img data-croporisrc="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWpvb9yav65d6msLM3iaKDcN5ZAt1ibczaNpy3RgRyPvvy7xfXrTx7Kneg4icX8DtolonEx3j6NBFzMw/0?wx_fmt=png&amp;from=appmsg" data-cropx1="0" data-cropx2="926.9999999999999" data-cropy1="0" data-cropy2="534.5344827586207" data-galleryid="" data-imgfileid="100010178" data-ratio="0.5760517799352751" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/LvUIqvYKCeWpvb9yav65d6msLM3iaKDcNJeM6doicVR6qZ4Q5zuu8VbBGe9OlWswhebFAYtpkp9dB2rPpdOTPmrA/640?wx_fmt=jpeg" data-type="jpeg" data-w="927" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/LvUIqvYKCeWpvb9yav65d6msLM3iaKDcNJeM6doicVR6qZ4Q5zuu8VbBGe9OlWswhebFAYtpkp9dB2rPpdOTPmrA/640?wx_fmt=jpeg"></p><p data-class="mbImgTitle"><strong>▲ 10.1038/s41596-023-00892-x</strong></p><p>最近看到<code><span>CoGAPS</span></code>包好像发了几篇高分文章，便赶紧给各位铁子介绍一下如何 R 包<code><span>CoGAPS</span></code>执行非负矩阵分解算法CoGAPS。<strong>上面的文章也同时提供了python的版本，大家感兴趣的话也可以自行学习</strong>：</p><ul data-tool="markdown.com.cn编辑器"><li><section>https://github.com/FertigLab/pycogaps</section></li><li><section>https://github.com/FertigLab/CoGAPS/</section></li></ul><h3 data-tool="markdown.com.cn编辑器"><span>1 R包的安装与引用</span></h3><p data-tool="markdown.com.cn编辑器">可以使用以下代码安装与引用该R包：</p><pre data-tool="markdown.com.cn编辑器"><span></span><code><span>#devtools::install_github("FertigLab/CoGAPS")</span><br><br><span>library</span>(CoGAPS)<br><span>library</span>(Seurat)<br><span>library</span>(dplyr)<br><span>library</span>(viridis)<br></code></pre><h3 data-tool="markdown.com.cn编辑器"><span></span><span>2 数据的读入</span><span></span></h3><section>示例数据<code><span>inputdata.Rds</span></code>可以在以下链接下载：</section><ul data-tool="markdown.com.cn编辑器"><li><section>https://github.com/FertigLab/CoGAPS/blob/b6b849cf84ed91f34038048e2b29ea0fcf93570b/data/inputdata.Rds</section></li></ul><section>这个<code><span>inputdata.Rds</span></code>其实就是我们的 seurat 对象。<strong>这里我们可以将其读入并命名为</strong><code><span>af</span></code><strong>，看看初步的细胞分群</strong>：</section><pre data-tool="markdown.com.cn编辑器"><span></span><code>af &lt;- readRDS(<span>"inputdata.Rds"</span>)<br>DimPlot(af, pt.size = <span>0.2</span>, group.by = <span>"celltype"</span>, reduction = <span>"umap"</span>)<br></code></pre><section><img data-galleryid="" data-imgfileid="100010180" data-ratio="0.6493506493506493" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWpvb9yav65d6msLM3iaKDcNzZCnFu4lkTIIHMjfuiaqMftZPvKqiaDiaE2SXibQwWHCGYID3y4PF7P7bA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="770" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWpvb9yav65d6msLM3iaKDcNzZCnFu4lkTIIHMjfuiaqMftZPvKqiaDiaE2SXibQwWHCGYID3y4PF7P7bA/640?wx_fmt=png&amp;from=appmsg"></section><h3 data-tool="markdown.com.cn编辑器"><span></span><span>3 执行 CoGAPS 分析</span><span></span></h3><section><strong>① 提取count矩阵进行CoGAPS分析</strong>，注意<code><span>nPatterns</span></code>参数，下方设置为3，即指定了3种表达模式（英文: pattern）：</section><pre data-tool="markdown.com.cn编辑器"><span></span><code><span># 提取count矩阵</span><br>pdac_epi_counts &lt;- GetAssayData(object = af, slot = <span>"counts"</span>) %&gt;% as.matrix()<br>norm_pdac_epi_counts &lt;- log1p(pdac_epi_counts)<br><span># 参数设置</span><br>pdac_params &lt;- CogapsParams(nIterations=<span>50000</span>, <span># 迭代数量</span><br>                            seed=<span>42</span>, <span># 设置随机数种子</span><br>                            nPatterns=<span>3</span>, <span># 设置聚类数量</span><br>                            sparseOptimization=<span>TRUE</span>, <span># optimize for sparse data</span><br>                            distributed=<span>"genome-wide"</span>) <span># parallelize across sets</span><br><span># 正式执行分析 </span><br>pdac_epi_result &lt;- CoGAPS(norm_pdac_epi_counts, pdac_params)<br>saveRDS(pdac_epi_result, <span>"./pdac_epi_cogaps_result.rds"</span>)<br></code></pre><p><strong>② 可视化细胞的表达模式评分：</strong></p><pre data-tool="markdown.com.cn编辑器"><span></span><code><span># 可视化细胞的表达模式评分</span><br>cogapsresult &lt;- readRDS(<span>"./pdac_epi_cogaps_result.rds"</span>)<br>patterns_in_order &lt;-t(cogapsresult@sampleFactors[colnames(af),])<br>af[[<span>"CoGAPS"</span>]] &lt;- CreateAssayObject(counts = patterns_in_order)<br>DefaultAssay(af) &lt;- <span>"CoGAPS"</span><br>pattern_names &lt;- rownames(af@assays$CoGAPS)<br>color_palette &lt;- viridis(n=<span>10</span>)<br>FeaturePlot(af, pattern_names, cols=color_palette, reduction = <span>"umap"</span>) &amp; NoLegend()<br></code></pre><p><img data-galleryid="" data-imgfileid="100010184" data-ratio="0.4517543859649123" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWpvb9yav65d6msLM3iaKDcNDMiaDgV1OVYpsefAFa6IbLFIu4oyjI5rSqmXbbu64jsq9V0yJIO8eZQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="912" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWpvb9yav65d6msLM3iaKDcNDMiaDgV1OVYpsefAFa6IbLFIu4oyjI5rSqmXbbu64jsq9V0yJIO8eZQ/640?wx_fmt=png&amp;from=appmsg"></p><p>简单来讲，执行COGA分析后，每个细胞对于每个表达模式 pattern 都会获得一个相应的评分。<strong>还可以使用常规的小提琴图展示或者自行进行更多的探索</strong>：</p><pre data-tool="markdown.com.cn编辑器"><span></span><code><span># 进行gsea分析</span><br>VlnPlot(af, features = pattern_names, group.by = "celltype", pt.size = 0.2)</code></pre><p><img data-galleryid="" data-imgfileid="100010185" data-ratio="0.4830970556161396" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWpvb9yav65d6msLM3iaKDcNZ6VfDq8iaClck1Pib4bcSImcucdJ9HrP35yAMibkZe2yfQKCJSHUrBC6A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="917" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWpvb9yav65d6msLM3iaKDcNZ6VfDq8iaClck1Pib4bcSImcucdJ9HrP35yAMibkZe2yfQKCJSHUrBC6A/640?wx_fmt=png&amp;from=appmsg"></p><p><strong>③ 计算每个表达模式的标志基因</strong>，下方代码运行后将在<code><span>genes_pm</span></code>储存中每个基因在不同模式中的排名：</p><pre data-tool="markdown.com.cn编辑器"><span></span><code>pm &lt;- patternMarkers(cogapsresult, threshold=<span>"cut"</span>)<br>genes_pm &lt;- pm$PatternRanks<br>genes_pm[<span>1</span>:<span>5</span>, <span>1</span>:<span>3</span>]<br><span>#        Pattern_1 Pattern_2 Pattern_3</span><br><span>#SAMD11      1     11496       724</span><br><span>#NOC2L       10980     11147     10890</span><br><span>#KLHL17       1128     100     11802</span><br><span>#PLEKHN1        86     13506     10504</span><br><span>#HES4         8083      1572     13497</span><br></code></pre><section><strong>④ 执行 GSEA 富集分析</strong>，通过指定<code><span>plotPatternGeneSet</span></code>函数中的<code><span>whichpattern</span></code>参数可以指定表达模式。</section><pre data-tool="markdown.com.cn编辑器"><span></span><code><span># 进行gsea分析</span><br>geneset &lt;- read.gmt(<span>"h.all.v7.5.1.symbols.gmt"</span>) <span># 读取基因集，这里使用的是msigdb数据库中的hallmark基因集，也可以自定义</span><br>geneset &lt;- split(geneset$gene, geneset$term)<br>hallmarks &lt;- getPatternGeneSet(object = cogapsresult, gene.sets = geneset, method = <span>"enrichment"</span>)<br>plotPatternGeneSet(hallmarks, whichpattern = <span>1</span>, padj_threshold = <span>0.05</span>)<br></code></pre><section><img data-imgfileid="100010189" data-ratio="0.810989010989011" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWpvb9yav65d6msLM3iaKDcNJ4hntHaBYKKUNPsIerw7zNtOeJg1NH6DiaiaVfbLp1lfUOE6icOKft1ZA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="910" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWpvb9yav65d6msLM3iaKDcNJ4hntHaBYKKUNPsIerw7zNtOeJg1NH6DiaiaVfbLp1lfUOE6icOKft1ZA/640?wx_fmt=png&amp;from=appmsg"></section><section>注意，<code><span>getPatternGeneSet</span></code>函数的<code><span>method</span></code>参数支持两种设置enrichment与overrepresentation，下面是它们各自的介绍：</section><ul data-tool="markdown.com.cn编辑器"><li><section>enrichment or overrepresentation. Conducts a test for gene set enrichment using fgsea::gsea ranking features by pattern amplitude or a test for gene set overrepresentation in pattern markers using fgsea::fora, respectively.</section></li></ul><section>此外，<code><span>getPatternGeneSet</span></code>函数还需要提供富集使用基因集列表，可以自行准备或下载。<strong>上面的示例代码读入了 msigdb 数据库的 hallmark 基因集（gmt文件格式），下载链接如下</strong>：</section><ul data-tool="markdown.com.cn编辑器"><li><section>https://www.gsea-msigdb.org/gsea/msigdb/collections.jsp</section></li></ul><p><span><span><strong>今天就分享到这</strong></span></span></p><p><span><span><strong>欢迎点击关注 <img data-ratio="1" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Yellowdog.png" data-w="128" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Yellowdog.png"><img data-ratio="1" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/smiley_83b.png" data-w="128" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/smiley_83b.png"><img data-ratio="1" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/smiley_83b.png" data-w="128" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/smiley_83b.png"></strong></span></span></p><section><mp-common-profile data-id="MzkyNTIzMzYyMA==" data-pluginname="mpprofile" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/LvUIqvYKCeXYZNMxRMnjiaicO2a27jDZ2FgQga8TdeQcsGRJRIn2IInkKtfcbbMXOBSViaPXpTOBulUlNzd11pzow/0?wx_fmt=png" data-nickname="生信碱移" data-alias="liudoufu307" data-signature="春来秋至，分享我的所见与所识" data-from="2" data-weuitheme="light"></mp-common-profile></section><section><br></section><section><strong><span>END~</span></strong><br></section><p><span><strong>仅供粉丝老铁们参考</strong></span></p><p><strong>如有侵权或错误，请联系删除改正～</strong></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ZKhyb4QgierorUb0AibI7A",target="_blank" rel="noopener noreferrer">原文链接</a>
