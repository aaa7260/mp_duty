---
title: "单细胞全流程之亚群提取、注释及AddModuleScore"
date: 2024-08-01T12:42:36Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
单细胞全流程之亚群提取、注释及AddModuleScore by 生信菜鸟团
------
<div><blockquote data-tool="mdnice编辑器"><p><span>从我们</span><span>生信技能树</span><span>历年的几千个马拉松授课学员里面募集了一些优秀的创作者，某种意义来说是传承了我们生信技能树的知识整理和分享的思想！</span></p></blockquote><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">今天的是学员一点一滴整理的授课知识点笔记哦，还有互动练习题哈，欢迎大家点击文末的阅读原文去关注我们学员的公众号哦！</p><p><br></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span>其实这部分内容应该放在后面再进行分享，但在曾老师的鞭策下复现了一张最近发表在SCIENCE TRANSLATIONAL MEDICINE上的图，总的来说复现的结果与原文有些差异，有一个细胞亚群并不能很好的注释出来，可能跟参数设置等一些细节上的差异有关，但并不影响学习其中的思路，在此分享给大家。</span><span></span><br></h3><p><img data-galleryid="" data-ratio="0.49934810951760106" data-s="300,640" data-type="png" data-w="767" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpP4ria6Yj5XkPFic45diaibdibbibxIP7X125rp6FeAbOCYvWDNqheYIokjBvw/640?wx_fmt=png&amp;wxfrom=13&amp;tp=wxpic" data-imgfileid="100042197" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpP4ria6Yj5XkPFic45diaibdibbibxIP7X125rp6FeAbOCYvWDNqheYIokjBvw/640?wx_fmt=png&amp;wxfrom=13&amp;tp=wxpic"></p><p><span><br></span></p><p data-tool="mdnice编辑器">数据链接：GEO Accession viewer (nih.gov)</p><p data-tool="mdnice编辑器">原图长这样。</p><p><img data-galleryid="" data-ratio="1.379182156133829" data-s="300,640" data-type="png" data-w="538" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpPwkwNzLydRG1sVjLtDaWxPfSOFrwlz2IPgaH9Ju18pnwZoDz8qddUiag/640?wx_fmt=png&amp;wxfrom=13&amp;tp=wxpic" data-imgfileid="100042198" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpPwkwNzLydRG1sVjLtDaWxPfSOFrwlz2IPgaH9Ju18pnwZoDz8qddUiag/640?wx_fmt=png&amp;wxfrom=13&amp;tp=wxpic"></p><h4 data-tool="mdnice编辑器"><span>数据读取、QC、降维聚类</span></h4><p data-tool="mdnice编辑器">这个过程在上一期中已经具体讲述，在此不再赘述，过滤条件根据原文来进行。</p><pre data-tool="mdnice编辑器"><span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/XCopLcwfzefB8gj7MQANDpvfkwx1cqASykFhKcS3lyNLj4pxm3Y7pwxlHRWxbS5ricUN4jY9FIutTG6rs2Kcxj3FmFb4ScR03/640?wx_fmt=svg" data-fail="0"></span><code><span>library</span>(Seurat)<br><span>library</span>(tidyverse)<br>rm(list = ls())<br>counts &lt;- read.table(file=<span>"GSM7025594_Vascular_processed.txt"</span>,sep=<span>"\t"</span>,header = <span>TRUE</span>, row.names = <span>1</span>)<br>sce &lt;- CreateSeuratObject(counts = counts,project = <span>"Humanized vasculitis mice"</span>,min.cells = <span>3</span>)<br><span>#质控</span><br>sce[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(sce,pattern = <span>"^MT-"</span>)<br>VlnPlot(sce,<br>        features = c(<span>"nCount_RNA"</span>,<span>"nFeature_RNA"</span>,<span>"percent.mt"</span>))<br><br>sce2 &lt;- subset(sce, <br>              subset = nFeature_RNA&gt;<span>200</span> &amp; nFeature_RNA&lt;<span>4000</span>&amp;<br>                percent.mt&lt;<span>10</span>)<br>saveRDS(sce2,file = <span>"sce_filt.rds"</span>)<br><span>#SCTransform</span><br>rm(list = ls())<br>sce &lt;- readRDS(<span>"sce_filt.rds"</span>)<br>sce &lt;- SCTransform(sce,vars.to.regress = <span>"percent.mt"</span>,verbose = <span>F</span>)<br>sce &lt;- RunPCA(sce,verbose = <span>F</span>)<br>ElbowPlot(sce, ndims=<span>50</span>, reduction=<span>"pca"</span>) <br><span>#选择20个PC</span><br>sce &lt;- RunUMAP(sce, dims = <span>1</span>:<span>20</span>, verbose = <span>FALSE</span>)<br>sce &lt;- RunTSNE(sce,dims = <span>1</span>:<span>20</span>)<br>sce &lt;- FindNeighbors(sce, dims = <span>1</span>:<span>20</span>, verbose = <span>FALSE</span>)<br>sce &lt;- FindClusters(sce, verbose = <span>FALSE</span>)<br>DimPlot(sce,reduction = <span>"umap"</span>)<br>DotPlot(sce,features = c(<span>"CD3G"</span>,<span>"CD4"</span>))<br></code></pre><p><img data-galleryid="" data-ratio="0.8547854785478548" data-s="300,640" data-type="png" data-w="606" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpPb0anRZvbWSrAibxsPFibvEe0wBssIvFPCGjQXY6iba4Lg1pNGlfqQicXjA/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-imgfileid="100042195" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpPb0anRZvbWSrAibxsPFibvEe0wBssIvFPCGjQXY6iba4Lg1pNGlfqQicXjA/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p data-tool="mdnice编辑器">作者根据CD3和CD4的表达来识别T细胞亚群，这里只有0,9两个cluster表达。</p><p data-tool="mdnice编辑器">提取T细胞亚群进行分析，注意进行亚群提取后必须要重新提取counts矩阵，删除原有的聚类结果的metadata，构建新的seurat对象，重新进行pipeline。</p><pre data-tool="mdnice编辑器"><span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/XCopLcwfzefB8gj7MQANDpvfkwx1cqASykFhKcS3lyNLj4pxm3Y7pwxlHRWxbS5ricUN4jY9FIutTG6rs2Kcxj3FmFb4ScR03/640?wx_fmt=svg" data-fail="0"></span><code>sce_T &lt;- subset(sce,<br>                subset = (seurat_clusters==c(<span>"0"</span>,<span>"9"</span>)))<br>sce_T &lt;- CreateSeuratObject(counts = sce_T@assays$RNA@counts,<br>                          meta.data = sce_T@meta.data[,<span>1</span>:<span>4</span>])<br>sce_T &lt;- NormalizeData(sce_T,normalization.method = <span>"LogNormalize"</span>,<br>                     scale.factor = <span>1e4</span>)<br>GetAssay(sce_T,assay = <span>"RNA"</span>)<br>sce_T &lt;- FindVariableFeatures(sce_T,<br>                            selection.method = <span>"vst"</span>,nfeatures = <span>2000</span>)<br>sce_T &lt;- ScaleData(sce_T)<br>sce_T &lt;- RunPCA(object = sce_T,pc.genes = VariableFeatures(sce_T))<br><br>sce_T &lt;- FindNeighbors(sce_T,dims = <span>1</span>:<span>15</span>)<br><span>for</span> (res <span>in</span> c(<span>0.01</span>, <span>0.05</span>, <span>0.1</span>, <span>0.2</span> ,<span>0.3</span>, <span>0.5</span>, <span>0.8</span>, <span>1</span>)) {<br>  sce_T = FindClusters(sce_T,<br>                     resolution = res, algorithm = <span>1</span>)<br>  <br>}<br>table(sce_T$RNA_snn_res.0.8)<br>sel.clust &lt;- <span>"RNA_snn_res.0.8"</span><br>sce_T &lt;- SetIdent(sce_T,value = sel.clust)<br>sce_T &lt;- RunUMAP(sce_T,dims = <span>1</span>:<span>15</span>)<br>DimPlot(sce_T,reduction = <span>"umap"</span>)<br>DefaultAssay(sce_T) &lt;- <span>"RNA"</span><br>markers &lt;- FindAllMarkers(sce_T, only.pos = <span>TRUE</span>, min.pct = <span>0.25</span>, logfc.threshold = <span>0.25</span>)<br>all.markers =markers %&gt;% dplyr::select(gene, everything()) %&gt;% subset(p_val&lt;<span>0.05</span>)<br>top20 =all.markers %&gt;% group_by(cluster) %&gt;% top_n(n = <span>20</span>, wt = avg_log2FC)<br>Idents(sce_T) &lt;- sce_T$RNA_snn_res.0.8<br>DoHeatmap(sce_T,features = top20$gene)<span>#热图复现</span><br></code></pre><p data-tool="mdnice编辑器">这里得到了图C，可以看到跟原文有一些区别。</p><p><img data-galleryid="" data-ratio="1.0053763440860215" data-s="300,640" data-type="png" data-w="744" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpPut8vmuDf5IsfGaEtiaErL58H6QGHmFxSXevK8ckjicxGBMHhHIUiaiaOQA/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-imgfileid="100042196" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpPut8vmuDf5IsfGaEtiaErL58H6QGHmFxSXevK8ckjicxGBMHhHIUiaiaOQA/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><h4 data-tool="mdnice编辑器"><span>注释</span></h4><p data-tool="mdnice编辑器">根据原文marker进行注释，复现</p><pre data-tool="mdnice编辑器"><span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/XCopLcwfzefB8gj7MQANDpvfkwx1cqASykFhKcS3lyNLj4pxm3Y7pwxlHRWxbS5ricUN4jY9FIutTG6rs2Kcxj3FmFb4ScR03/640?wx_fmt=svg" data-fail="0"></span><code>genes_to_check &lt;- c(<span>"TCF7"</span>,<span>"LEF1"</span>,<span>"IL7R"</span>,<span>"CD28"</span>,<span>"FAS"</span>,<span>"CXCR5"</span>,<span>"CCR7"</span>,<span>"GPR183"</span>,<br>                    <span>"BCL6"</span>,<span>"IL21"</span>,<span>"CXCL13"</span>,<span>"TNFSF8"</span>,<br>                    <span>"E2F8"</span>,<span>"MKI67"</span>,<span>"PCNA"</span>,<span>"MCM2"</span>,<br>                    <span>"EOMES"</span>,<span>"NKG7"</span>,<span>"PRF1"</span>,<span>"SLAMF7"</span>,<span>"GZMB"</span>,<span>"CCL4"</span>,<span>"GZMK"</span>,<span>"CCL5"</span>)<br>pdf(<span>"genes_to_check.pdf"</span>,<span>16</span>,<span>16</span>)<br>FeaturePlot(sce_T,genes_to_check)<br></code></pre><p><img data-galleryid="" data-ratio="0.8280922431865828" data-s="300,640" data-type="png" data-w="954" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpP3LRwNpjxTjJrq3Vkyj3tNrKuXC2J1uNWu0AtoIBwc0lWlIEggcaG4Q/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-imgfileid="100042199" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpP3LRwNpjxTjJrq3Vkyj3tNrKuXC2J1uNWu0AtoIBwc0lWlIEggcaG4Q/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p data-tool="mdnice编辑器">使用AI整理后就可以得到图D，E/F/G/H可以用一样的方法进行复现，这里没有重复。</p><pre data-tool="mdnice编辑器"><span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/XCopLcwfzefB8gj7MQANDpvfkwx1cqASykFhKcS3lyNLj4pxm3Y7pwxlHRWxbS5ricUN4jY9FIutTG6rs2Kcxj3FmFb4ScR03/640?wx_fmt=svg" data-fail="0"></span><code>DotPlot(sce_T,features = genes_to_check)+coord_flip()<br>dev.off()<br>celltype=data.frame(ClusterID=<span>0</span>:<span>4</span>,<br>                    celltype=<span>0</span>:<span>4</span>)<br>celltype[celltype$ClusterID %<span>in</span>% c(<span>0</span>),<span>2</span>]=<span>"TCF1hi"</span><br>celltype[celltype$ClusterID %<span>in</span>% c(<span>1</span>,<span>2</span>),<span>2</span>]=<span>"T cyto"</span><br>celltype[celltype$ClusterID %<span>in</span>% c(<span>3</span>),<span>2</span>]=<span>"Cycling 1"</span><br>celltype[celltype$ClusterID %<span>in</span>% c(<span>4</span>),<span>2</span>]=<span>"Cycling 2"</span><br><span>for</span> (i <span>in</span> <span>1</span>:nrow(celltype)) {<br>  sce_T@meta.data[which(sce_T@meta.data$RNA_snn_res.0.8==celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]<br>  <br>}<br>Idents(sce_T) &lt;- sce_T$celltype<br>DimPlot(sce_T,reduction = <span>"umap"</span>,label = <span>T</span>)<br>ggsave(<span>"dimplot.pdf"</span>)<br><br></code></pre><h4 data-tool="mdnice编辑器"></h4><p><img data-galleryid="" data-imgfileid="100042201" data-ratio="0.7527675276752768" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpP33KSloHbgm4CMzj9Zt7AHlDubcYmma5O2a3mw68LJJK3edA0VwYXZA/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="542" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpP33KSloHbgm4CMzj9Zt7AHlDubcYmma5O2a3mw68LJJK3edA0VwYXZA/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><h4 data-tool="mdnice编辑器"><span>AddModuleScore</span></h4><p data-tool="mdnice编辑器">通过msigdb官网找到自己想要的通路集合后直接通过msigdbr包下载数据集，使用AddModuleScore对细胞进行通路打分，这里还可以使用其他的打分方法，比如之前介绍的AUCell（<a href="https://mp.weixin.qq.com/s?__biz=MzkzNDQ3Njc4NQ==&amp;mid=2247484038&amp;idx=1&amp;sn=c706d844ca55b702019147953b6a6241&amp;chksm=c2bdec18f5ca650e64e5c454d4e42bfa6180aed4ea1d434fcb3d0c0aafe14b3c6dba216a9ea2&amp;token=66419625&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">AUCell：对单个细胞的基因集活性打分 (qq.com)</a>）等。</p><pre data-tool="mdnice编辑器"><span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/XCopLcwfzefB8gj7MQANDpvfkwx1cqASykFhKcS3lyNLj4pxm3Y7pwxlHRWxbS5ricUN4jY9FIutTG6rs2Kcxj3FmFb4ScR03/640?wx_fmt=svg" data-fail="0"></span><code><span>library</span>(msigdbr)<br><span>library</span>(RColorBrewer)<br>gene_sets &lt;- msigdbr(species = <span>"Homo sapiens"</span>, category = <span>"C2"</span>) %&gt;% <br>  dplyr::filter(gs_name==<span>"REACTOME_TCR_SIGNALING"</span>)<br>TCR_l &lt;-list(TCR_signaling=unique(gene_sets$gene_symbol)) <br>sce_T &lt;- AddModuleScore(sce_T,TCR_l)<br>FeaturePlot(sce_T,<span>'Cluster1'</span>,cols=rev(brewer.pal(<span>10</span>, name = <span>"RdBu"</span>)))<br>ggsave(<span>"TCR signaling.pdf"</span>)<br><span>#cell cycle</span><br>cell_cycling &lt;- msigdbr(species = <span>"Homo sapiens"</span>, category = <span>"C5"</span>) %&gt;% <br>  dplyr::filter(gs_name==<span>"GOBP_CELL_CYCLE"</span>)<br>cycling_l &lt;- list(cell_cycling=unique(cell_cycling$gene_symbol)) <br>sce_T &lt;- AddModuleScore(sce_T,cycling_l)<br>FeaturePlot(sce_T,<span>'Cluster1'</span>,cols = rev(brewer.pal(<span>10</span>, name = <span>"RdBu"</span>)))<br>ggsave(<span>"cell cycling.pdf"</span>)<br>saveRDS(sce_T,<span>"sce_T.rds"</span>)<br></code></pre></section><p><img data-galleryid="" data-imgfileid="100042206" data-ratio="0.4525916561314791" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpPEMeIdluFbnibz1R0RmkiaEpMJ5TJCs2zJWsxKTCqhrjylDSicPT9vrYrw/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="791" src="https://mmbiz.qpic.cn/mmbiz_png/PibBGN3Gt5GUbhAt1rOSDI0S7LR6avbpPEMeIdluFbnibz1R0RmkiaEpMJ5TJCs2zJWsxKTCqhrjylDSicPT9vrYrw/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p>到此就复现完毕啦，谢谢大家的支持~</p><p><br></p><p><br></p><h3 data-tool="mdnice编辑器"><span>文末友情宣传</span></h3><p data-tool="mdnice编辑器"><strong>强烈建议你推荐给身边的博士后以及年轻生物学PI，多一点数据认知，让他们的科研上一个台阶：</strong></p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247530001&amp;idx=1&amp;sn=676dcf224f9be23b288189775292aeeb&amp;chksm=9b4b36aaac3cbfbc3e3bb0865bd789d5093e3a643f3f345332995f707b7f209ae924e9e9529e&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买‍一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;scene=21#wechat_redirect" data-linktype="2">时隔5年，我们的生信技能树VIP学徒继续招生啦</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528363&amp;idx=1&amp;sn=5e02f3e9b2e148191e23ebc2c0d780e7&amp;scene=21#wechat_redirect" data-linktype="2">2024的共享服务器交个朋友福利价仍然是800</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;scene=21#wechat_redirect" data-linktype="2">千呼万唤始出来的独享生物信息学云服务器</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528144&amp;idx=1&amp;sn=be4d7e542d1077921024c86a4c130f16&amp;scene=21#wechat_redirect" data-linktype="2">永久免费的生信进阶培训（线下）</a></section></li></ul><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/433wxdvCl11YKel6MR5fKw",target="_blank" rel="noopener noreferrer">原文链接</a>
