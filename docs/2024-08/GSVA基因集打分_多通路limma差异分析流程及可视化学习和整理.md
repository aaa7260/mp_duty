---
title: "GSVA基因集打分/多通路limma差异分析流程及可视化学习和整理"
date: 2024-08-26T22:38:10Z
draft: ["false"]
tags: [
  "fetched",
  "生信方舟"
]
categories: ["Acdemic"]
---
GSVA基因集打分/多通路limma差异分析流程及可视化学习和整理 by 生信方舟
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h4 data-tool="mdnice编辑器"><span></span>基因集变异分析<span></span></h4><p data-tool="mdnice编辑器"><strong>GSVA（Gene Set Variation Analysis，基因集变异分析）</strong> 是一种<strong>无监督的基因集富集分析方法</strong>，用于评估样本层面上基因集（如 KEGG 路径、GO 术语）的表现。与传统的基因集富集分析不同，GSVA 不是直接检测不同基因集在不同实验条件下的富集程度，而是计算<strong>每个样本中预定义的基因集的富集得分</strong>，从而评估基因集在不同样本或条件下的变异性。</p><h5 data-tool="mdnice编辑器"><span></span>应用场景：<span></span></h5><p data-tool="mdnice编辑器">评估基因集的表现：GSVA 通过计算样本中基因集的富集得分，评估基因集在不同样本中的表现。这使得研究者可以在无监督的背景下评估不同样本中的基因集活动水平，而无需先定义实验组和对照组。</p><p data-tool="mdnice编辑器">样本分类：GSVA 可以用于对样本进行分类或聚类分析，帮助识别样本间基因集的差异，从而揭示潜在的生物学机制。</p><p data-tool="mdnice编辑器">医学科研：GSVA 在医学科研中具有重要应用，可以根据患者的基因表达谱评估关键基因集的活性水平，进而指导个性化治疗方案的选择。</p><h5 data-tool="mdnice编辑器"><span></span>适用范围/条件：<span></span></h5><p data-tool="mdnice编辑器">单细胞/bulk RNA数据：GSVA 适用于处理来自单细胞或bulkRNA 测序的基因表达数据。</p><p data-tool="mdnice编辑器">基因集分析：适用于任何预定义的基因集，如 KEGG 路径、GO 术语、TF 调控网络等。</p><p data-tool="mdnice编辑器">无监督分析：GSVA 主要用于无监督分析背景下的基因集富集分析，不需要预先定义样本的分组信息。</p><h5 data-tool="mdnice编辑器"><span></span>GSVA 与其他算法的差别<span></span></h5><ol data-tool="mdnice编辑器"><li><section>与 <strong>GSEA（Gene Set Enrichment Analysis）</strong>的差别：</section></li></ol><p data-tool="mdnice编辑器">分析方式：GSEA 主要用于检测不同实验组（如实验组和对照组）之间基因集富集差异，而 GSVA 是在每个样本层面计算基因集的富集得分。</p><p data-tool="mdnice编辑器">输入数据：GSEA 需要预先定义样本分组，而 GSVA 则不需要分组信息，可以直接在无监督的情况下计算基因集在每个样本中的表现。</p><p data-tool="mdnice编辑器">分析结果：GSEA 的结果是基因集在不同条件下的富集显著性（如 p 值），而 GSVA 的结果是每个样本中基因集的富集得分（一个连续值）。</p><ol start="2" data-tool="mdnice编辑器"><li><section>与 <strong>ssGSEA（Single-sample Gene Set Enrichment Analysis）</strong> 的差别：</section></li></ol><p data-tool="mdnice编辑器">分析思路：ssGSEA 是 GSEA 的扩展，用于计算每个样本中基因集的富集得分。它与 GSVA 相似，都是针对单个样本进行的分析。</p><p data-tool="mdnice编辑器">算法实现：GSVA 和 ssGSEA 在计算基因集富集得分时采用不同的算法。GSVA 使用的是非参数核密度估计方法，而 ssGSEA 是基于样本排序的积分方法。</p><p data-tool="mdnice编辑器">应用场景：虽然二者应用场景类似，但 GSVA 通常被认为在处理批量样本时更为稳定，而 ssGSEA 更直接用于单样本分析。</p><ol start="3" data-tool="mdnice编辑器"><li><section>与<strong>其他基因集富集算法（如 CAMERA, ROAST）</strong>的差别：</section></li></ol><p data-tool="mdnice编辑器">统计假设：CAMERA 和 ROAST 等方法基于线性模型和统计假设，用于评估预定义基因集在不同实验条件下的富集显著性。这些方法通常要求有明确的样本分组信息。</p><p data-tool="mdnice编辑器">适用范围：GSVA 不依赖于分组信息，因此在无监督分析或复杂实验设计中更为灵活，而 CAMERA 和 ROAST 则更适合在明确分组的实验设计中使用。</p><h4 data-tool="mdnice编辑器"><span></span>GSVA基因集打分分析步骤及热图<span></span></h4><h5 data-tool="mdnice编辑器"><span></span>1、加载R包、导入数据<span></span></h5><p data-tool="mdnice编辑器">准备了乳酸化和缺氧两个基因集</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1724689254597" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>rm(list = ls())  <br>setwd(<span>"./2-gsva/"</span>)<br><span>library</span>(readxl)<br><span>library</span>(GSVA)<br><br>load(file = <span>"combat.Rdata"</span>)<br>exp[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span>#           GSM3106326 GSM3106327 GSM3106328 GSM3106329</span><br><span># LINC01128   8.000049   8.044479   7.311868   7.610713</span><br><span># SAMD11      7.499611   7.562370   7.412649   7.239141</span><br><span># KLHL17      7.662076   7.672331   7.627330   7.564212</span><br><span># PLEKHN1     7.666884   7.889537   7.640606   7.746440</span><br>head(pd)[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span>#                                                title                  samples   GSE_num group</span><br><span># GSM3106326 Pulmonary arterial hypertension patient 1   idiopathic PAH patient GSE113439   PAH</span><br><span># GSM3106327 Pulmonary arterial hypertension patient 2 patient with PAH and CHD GSE113439   PAH</span><br><span># GSM3106328 Pulmonary arterial hypertension patient 3 patient with PAH and CTD GSE113439   PAH</span><br><span># GSM3106329 Pulmonary arterial hypertension patient 4 patient with PAH and CHD GSE113439   PAH</span><br>lactate &lt;- read_excel(<span>"Hypoxia Related Genes.xls"</span>, sheet = <span>1</span>)<br>names(lactate) &lt;- <span>"lactate"</span><br>hypoxia &lt;- read_excel(<span>"Hypoxia Related Genes.xls"</span>, sheet = <span>2</span>)<br>names(hypoxia) &lt;- <span>"hypoxia"</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span>2、GSVA分析<span></span></h5><pre data-tool="mdnice编辑器"><span data-remoteid="c1724689254598" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code><span># 制作基因集list</span><br><span># 其中要把基因集变成matrix哦~ </span><br>dataset &lt;- list(<span>"hypoxia"</span>= as.matrix(hypoxia),<span>"lactate"</span>= as.matrix(lactate))<br><br><span># GSVA</span><br>gsvaPar &lt;- gsvaParam(exp, dataset,maxDiff = <span>TRUE</span>)<br>gsvaPar <br><span># A GSVA::gsvaParam object</span><br><span># expression data:</span><br><span>#   matrix [18837, 132]</span><br><span>#     rows: LINC01128, SAMD11, ..., SPRR2G (18837 total)</span><br><span>#     cols: GSM3106326, GSM3106327, ..., GSM1291010 (132 total)</span><br><span># using assay: none</span><br><span># gene sets:</span><br><span>#   list</span><br><span>#     names: 493 hypoxia-related genes (1 total)</span><br><span>#     unique identifiers: ADM, ABCB1, ..., VPS11 (493 total)</span><br><span># gene set size: [1, Inf]</span><br><span># kcdf: Gaussian</span><br><span># tau: 1</span><br><span># maxDiff: TRUE</span><br><span># absRanking: FALSE</span><br>expr_geneset &lt;- gsva(gsvaPar)<br>dim(expr_geneset)<br>head(expr_geneset)[<span>1</span>:<span>2</span>,<span>1</span>:<span>4</span>]<br><span>#          GSM3106326 GSM3106327  GSM3106328 GSM3106329</span><br><span># hypoxia  0.08122476  0.1611271 -0.04422083 -0.1121407</span><br><span># lactate -0.17011732  0.1384359  0.33231938  0.0823520</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span>3、可视化-热图<span></span></h5><pre data-tool="mdnice编辑器"><span data-remoteid="c1724689254599" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code><span>library</span>(ComplexHeatmap)<br>data_total &lt;- as.data.frame(t(expr_geneset))<br>identical(rownames(data_total),rownames(pd))<br><br><span># 检查数据类型是否正确转换为数值型</span><br><span>library</span>(dplyr)<br>data_total &lt;- data_total %&gt;% mutate_all(as.numeric)<br><span># 标准化-方法3</span><br><span># 范围限定在-2至2</span><br>data_total &lt;- scale(data_total)<br>range(data_total)<br>data_total[data_total &gt; <span>2</span>] &lt;- <span>2</span><br>data_total[data_total + <span>2</span> &lt; <span>0</span>] &lt;- -<span>2</span><br><br><span># 也可以用circlize创建颜色映射</span><br><span># 定义颜色渐变</span><br><span>library</span>(circlize)<br>color_fun &lt;- colorRamp2(c(-<span>2</span>, <span>0</span>, <span>2</span>), c(<span>"#336699"</span>, <span>"white"</span>, <span>"tomato"</span>))<br><br><span># pd$type 和 pd$samples 是注释数据怎么上色</span><br>type_colors &lt;- c(<span>"control"</span> = <span>"green"</span>, <span>"PAH"</span> = <span>"red"</span>)<br>samples_colors &lt;- c(<span>"all PAH"</span> = <span>"blue"</span>, <span>"CTEPH patient"</span> = <span>"orange"</span>, <span>"FD"</span> = <span>"purple"</span>,<br>                    <span>"idiopathic PAH patient"</span> = <span>"brown"</span>, <span>"normal control"</span> = <span>"yellow"</span>,<br>                    <span>"patient with PAH and CHD"</span> = <span>"pink"</span>, <span>"patient with PAH and CTD"</span> = <span>"magenta"</span>,<br>                    <span>"pulmonary arterial hypertension (PAH) patient"</span> = <span>"cyan"</span>)<br>GSE_colors &lt;- c(<span>"GSE113439"</span> = <span>"navy"</span>,<span>"GSE53408"</span>=<span>"darkolivegreen"</span>,<span>"GSE117261"</span>=<span>"darkgoldenrod"</span>)<br><br><span># 注意这里是行注释！如果是顶部注释需要用HeatmapAnnotation</span><br>rowAnno &lt;- rowAnnotation(type = pd$group,samples = pd$samples,GSE_num =pd$GSE_num,<br>                                col = list(type = type_colors, <br>                                           samples = samples_colors,<br>                                           GSE_num = GSE_colors))<br><br>ComplexHeatmap::Heatmap(data_total, <br>                        na_col = <span>"white"</span>,<br>                        col = color_fun,  <span># 添加颜色映射函数</span><br>                        show_column_names = <span>T</span>, <span>#是否显示列名</span><br>                        row_names_side = <span>"left"</span>,<br>                        name = <span>"fraction"</span>,<br>                        row_order = c(rownames(data_total)[c(grep(<span>"control"</span>,pd$group),<br>                                                                grep(<span>"PAH"</span>,pd$group))]),<br>                        row_split = pd$group, <br>                        row_title = <span>NULL</span>,<br>                        cluster_columns = <span>F</span>,<br>                        left_annotation = rowAnno,<br>                        <span>#top_annotation = columnAnno,</span><br>                        <span>#heatmap_width = unit(20, "cm"),  # 调整热图宽度</span><br>                        <span>#row_dend_width = unit(1, "cm"),  # 调整聚类树宽度</span><br>                        cluster_rows = <span>F</span>, <span># 行聚类</span><br>                        row_names_gp = gpar(fontsize = <span>0</span>),  <span># 调整行名字体大小</span><br>                        column_names_gp = gpar(fontsize = <span>12</span>)<br>                        <span>#cluster_columns = FALSE # 列聚类。                     </span><br>                        )<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100001363" data-ratio="0.9903660886319846" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFmZTcVib2JrxH0UHxics8PkOoK4655sqSFiaynEubGSdRkyoUMXiar7uS219LWMRSfDYfn81tGWFaibOw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="519" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFmZTcVib2JrxH0UHxics8PkOoK4655sqSFiaynEubGSdRkyoUMXiar7uS219LWMRSfDYfn81tGWFaibOw/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>多条通路GSVA分析及limma差异分析步骤及热图<span></span></h4><h5 data-tool="mdnice编辑器"><span></span>1、GSVA分析<span></span></h5><p data-tool="mdnice编辑器">数据跟上面的一样</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1724689254600" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code><span>###GSVA分析</span><br><span>library</span>(msigdbr)<br><span>library</span>(GSVA)<br><span>library</span>(tidyverse)<br><span>library</span>(clusterProfiler)<br><span>library</span>(patchwork)<br><span>library</span>(limma)<br><span>library</span>(data.table)<br><br><span>#genesets &lt;- msigdbr(species = "Homo sapiens") </span><br>genesets &lt;- msigdbr(species = <span>"Homo sapiens"</span>, category = <span>"C2"</span>, subcategory = <span>"CP:KEGG"</span>)<br>genesets &lt;- subset(genesets, select = c(<span>"gs_name"</span>,<span>"gene_symbol"</span>)) %&gt;% as.data.frame()<br>genesets &lt;- split(genesets$gene_symbol, genesets$gs_name)<br><br><span># gsva默认开启全部线程计算</span><br>gsvaPar &lt;- gsvaParam(exp, genesets,maxDiff = <span>TRUE</span>)<br>gsvaPar <br>gsva.res &lt;- gsva(gsvaPar)<br>dim(gsva.res)<br>head(gsva.res)[<span>1</span>:<span>5</span>,<span>1</span>:<span>5</span>]<br><span>#                                                 GSM3106326  GSM3106327  GSM3106328  GSM3106329  GSM3106330</span><br><span># KEGG_ABC_TRANSPORTERS                            0.07197716 -0.17846775  0.18517308 -0.15940843 -0.25379687</span><br><span># KEGG_ACUTE_MYELOID_LEUKEMIA                     -0.05004563 -0.05015776  0.17257837 -0.33558735  0.09424981</span><br><span># KEGG_ADHERENS_JUNCTION                          -0.14788713 -0.10257106 -0.18413147  0.05595831  0.25874815</span><br><span># KEGG_ADIPOCYTOKINE_SIGNALING_PATHWAY            -0.12701380 -0.36331421 -0.27864321 -0.41398011 -0.10789732</span><br><span># KEGG_ALANINE_ASPARTATE_AND_GLUTAMATE_METABOLISM  0.04323269  0.29484579  0.02247517 -0.15112383 -0.16768683</span><br>write.csv(gsva.res,<span>"gsva.res.csv"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100001364" data-ratio="0.4013333333333333" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFmZTcVib2JrxH0UHxics8PkOWoWibV6gjIKicvkUNCN9ynpRSwIiaibm45nmxwQaqYkb0H44B3J5u6tucQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="750" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFmZTcVib2JrxH0UHxics8PkOWoWibV6gjIKicvkUNCN9ynpRSwIiaibm45nmxwQaqYkb0H44B3J5u6tucQ/640?wx_fmt=png&amp;from=appmsg"></figure><h5 data-tool="mdnice编辑器"><span></span>2、limma差异分析<span></span></h5><pre data-tool="mdnice编辑器"><span data-remoteid="c1724689254601" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code><span># 不同通路之间的limma差异分析</span><br><span># 一定要设置分组信息！</span><br>identical(colnames(gsva.res),rownames(pd))<br>s &lt;- intersect(colnames(gsva.res),rownames(pd))<br>gsva.res &lt;- gsva.res[,s]<br>pd &lt;- pd[s,]<br><br>Group &lt;- factor(pd$cluster,levels = c(<span>"c1"</span>,<span>"c2"</span>))<br>design = model.matrix(~Group)<br>fit = lmFit(gsva.res,design)<br>fit = eBayes(fit)<br>pathway_res = topTable(fit,coef = <span>2</span>,number = <span>Inf</span>)<br>pathway_res[<span>1</span>:<span>5</span>,<span>1</span>:<span>5</span>]<br><span>#                                             logFC      AveExpr         t      P.Value    adj.P.Val</span><br><span># KEGG_PROTEASOME                          0.4510362 -0.302452399  8.637118 2.410744e-13 4.483983e-11</span><br><span># KEGG_FRUCTOSE_AND_MANNOSE_METABOLISM     0.3944620 -0.002586752  6.339069 9.818417e-09 9.131127e-07</span><br><span># KEGG_RNA_POLYMERASE                      0.4186369 -0.053443215  6.074686 3.152025e-08 1.772463e-06</span><br><span># KEGG_VASCULAR_SMOOTH_MUSCLE_CONTRACTION -0.2652879 -0.029894344 -6.011044 4.162805e-08 1.772463e-06</span><br><span># KEGG_P53_SIGNALING_PATHWAY               0.2808839 -0.035073110  5.980057 4.764685e-08 1.772463e-06</span><br>write.csv(pathway_res,<span>"pathway_res.csv"</span>)<br><span># 标准自定啊！</span><br>range(pathway_res$logFC)<br>range(pathway_res$adj.P.Val)<br>pathway_sig &lt;- pathway_res[pathway_res$adj.P.Val&lt;<span>0.001</span> &amp; abs(pathway_res$logFC) &gt; <span>0.2</span>,]<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100001365" data-ratio="0.824" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFmZTcVib2JrxH0UHxics8PkOia22a88S1OXZobxJrZyL1hdEn48I6AqcFoGt5n0icuwjiaMLDY4oibZvUA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="750" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFmZTcVib2JrxH0UHxics8PkOia22a88S1OXZobxJrZyL1hdEn48I6AqcFoGt5n0icuwjiaMLDY4oibZvUA/640?wx_fmt=png&amp;from=appmsg"></figure><h5 data-tool="mdnice编辑器"><span></span>3、可视化热图<span></span></h5><pre data-tool="mdnice编辑器"><span data-remoteid="c1724689254602" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code><span>###热图</span><br><span>library</span>(pheatmap)<br><span>library</span>(stringr)<br><span># 这里又把排名靠前的通路提取出来，去跟gsva之后的数据取交集，得到不同样本下的通路数据</span><br>data &lt;- gsva.res[match(rownames(pathway_sig),rownames(gsva.res)),]<br><br><span>#对数据进行排序</span><br>identical(rownames(pd),colnames(data))<br>Group &lt;- factor(pd$cluster,levels = c(<span>"c1"</span>,<span>"c2"</span>))<br>sort_data &lt;- order(Group)<br>n &lt;- data[,sort_data]<br>pd &lt;- pd[sort_data,]<br><br><span># 调整颜色梯度</span><br>range(data)<br>breaksList = seq(-<span>0.5</span>, <span>0.5</span>, by = <span>0.1</span>)<br>colors &lt;- colorRampPalette(c(<span>"#336699"</span>, <span>"white"</span>, <span>"tomato"</span>))(length(breaksList))<br><br><span>#创建列和行注释</span><br>annCol &lt;- data.frame(group = pd$cluster,<br>                     row.names = colnames(data),<br>                     stringsAsFactors = <span>FALSE</span>)<br><span>#annRow &lt;- data.frame(row.names = rownames(data))</span><br>pheatmap(data,<br>         annotation_col = annCol,<br>         <span>#annotation_row = annRow,</span><br>         color = colors,<br>         breaks = breaksList,<br>         cluster_rows = <span>T</span>,<br>         cluster_cols = <span>FALSE</span>,<br>         show_rownames = <span>TRUE</span>,<br>         show_colnames = <span>FALSE</span>,<br>         <span>#gaps_col = cumsum(table(annCol$Type)),  # 使用排序后的列分割点</span><br>         <span>#gaps_row = cumsum(table(annRow$Methods)), # 行分割</span><br>         fontsize_row = <span>6</span>,<br>         fontsize_col = <span>6</span>,<br>         annotation_names_row = <span>FALSE</span><br>         )<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100001366" data-ratio="0.6693333333333333" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFmZTcVib2JrxH0UHxics8PkOdEwXiagVegVTwb8gpVWUnn1DNibIicj0a2pXRfyZJGHicOqKx34ncvw35Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="750" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFmZTcVib2JrxH0UHxics8PkOdEwXiagVegVTwb8gpVWUnn1DNibIicj0a2pXRfyZJGHicOqKx34ncvw35Q/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>参考资料：<span></span></h4><p data-tool="mdnice编辑器">1、GSVA：https://www.bioconductor.org/packages/release/bioc/html/GSVA.html</p><p data-tool="mdnice编辑器">2、生信技能树：https://mp.weixin.qq.com/s/4gVTgTGHnNms5x-1pvRslg</p><p data-tool="mdnice编辑器">3、生信菜鸟团：https://mp.weixin.qq.com/s/K3WkllrTV3T_LN3gC6HWaQ</p><p data-tool="mdnice编辑器"><strong>致谢</strong>：感谢曾老师、小洁老师以及生信技能树团队全体成员。</p><p data-tool="mdnice编辑器"><strong>注</strong>：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(欢迎交流)。更多内容可关注公众号：<strong>生信方舟</strong></p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/HSaQQHIkSVx1VF4t-gd-aQ",target="_blank" rel="noopener noreferrer">原文链接</a>
