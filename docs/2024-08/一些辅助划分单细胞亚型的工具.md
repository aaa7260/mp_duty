---
title: "一些辅助划分单细胞亚型的工具"
date: 2024-08-20T02:27:07Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
一些辅助划分单细胞亚型的工具 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span></span>一些辅助划分细胞亚型的工具</h1><p>话接上文，这里是第四部分：<span>一些辅助划分细胞亚型的工具</span></p><p><span><br></span></p><p data-tool="mdnice编辑器">之前的推文中我们进行了<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515538&amp;idx=1&amp;sn=9be83cecadb15fc6222edaa1e16f005a&amp;chksm=ea1cbb10dd6b3206228619c26296a2738f24fa3c993cf67e8ae5b33a9cc4d000fe74a9bfc8d8&amp;scene=21&amp;cur_album_id=3019915773533913092#wechat_redirect" data-linktype="2">多分组单细胞转录组测序样本第一层次未整合和整合数据的B细胞细分对比</a>，由于我本人水平的问题，手动注释细胞亚型效果不太好，而且我也觉得肉眼这样看判断很折磨人</p><p data-tool="mdnice编辑器">本期第四部分就介绍些辅助划分细胞亚型的工具</p><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247523558&amp;idx=1&amp;sn=dd678cf9f026b26eed50dc75d757e7d4&amp;scene=21#wechat_redirect" data-linktype="2">使用AUCell结合单细胞亚群标记基因列表来判断亚群名字</a></h1><h2 data-tool="mdnice编辑器"><span></span>示例数据</h2><blockquote data-tool="mdnice编辑器"><p>基本上每个人开始学习单细胞，都是从这个文档开始：https://satijalab.org/seurat/articles/pbmc3k_tutorial.html</p></blockquote><p data-tool="mdnice编辑器">这个数据集之前用过：<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247514316&amp;idx=1&amp;sn=139a39771f22b6e7a484523313909f4c&amp;chksm=ea1cbe4edd6b3758f6c9564ca49ff66db7ea727ddf9d2391fa4a88132ac8f582a336ffcfd157&amp;scene=21&amp;cur_album_id=3019915773533913092#wechat_redirect" data-linktype="2">初探单细胞下游</a></p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>library(Seurat)<br>library(patchwork)<br>library(tidyverse)<br>library(AUCell)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code># Load the PBMC dataset<br># https://cf.10xgenomics.com/samples/cell/pbmc3k/pbmc3k_filtered_gene_bc_matrices.tar.gz<br>pbmc.data &lt;- Read10X(data.dir = "filtered_gene_bc_matrices/hg19/")<br># Initialize the Seurat object with the raw (non-normalized data).<br>pbmc &lt;- CreateSeuratObject(counts = pbmc.data, project = "pbmc3k", min.cells = 3, min.features = 200)<br>pbmc<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.36743674367436746" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6w5CS7gnicxt82adibdweop3icpbAnyr295FnduZQv2zHgUNVztia4Ttg7A/640?wx_fmt=png" data-type="png" data-w="909" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6w5CS7gnicxt82adibdweop3icpbAnyr295FnduZQv2zHgUNVztia4Ttg7A/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>单细胞亚群标记基因列表</h2><pre data-tool="mdnice编辑器"><span></span><code>Bcells = c('MS4A1','SDC1','CD27','CD38','CD19', 'CD79A') <br>counts &lt;- GetAssayData(object = pbmc, slot = "counts")<br>head(counts)<br><br>cell_rankings &lt;- AUCell_buildRankings(counts)<br>cell_rankings<br><br>cells_AUC &lt;- AUCell_calcAUC(Bcells, cell_rankings)<br>cells_AUC<br><br>cells_assignment &lt;- AUCell_exploreThresholds(cells_AUC, plotHist = TRUE, assign=TRUE)<br>thr = cells_assignment$geneSet$aucThr$selected;thr<br><br>new_cells &lt;- names(which(getAUC(cells_AUC)["geneSet",]&gt; thr))<br>pbmc$is_list &lt;- ifelse(colnames(pbmc) %in% new_cells, "list", "non_list")<br>colnames(pbmc@meta.data)<br><br># DimPlot(object = pbmc, group.by = "is_list", label = TRUE) +<br># DimPlot(object = pbmc, group.by = "seurat_annotations", label = TRUE)<br></code></pre><p data-tool="mdnice编辑器">代码拆解：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.3176328502415459" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd63vY33TLN1wpBa7amx9vugqg8PjXakYsuDbLClicepFtqd9dPMV5Gq9g/640?wx_fmt=png" data-type="png" data-w="828" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd63vY33TLN1wpBa7amx9vugqg8PjXakYsuDbLClicepFtqd9dPMV5Gq9g/640?wx_fmt=png"><figcaption>img</figcaption></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.3627232142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6SlFLty6bgstIa5tYdNF1RJJYPhbFMbpuZMOPScbuHfhibibE32INQuVg/640?wx_fmt=png" data-type="png" data-w="896" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6SlFLty6bgstIa5tYdNF1RJJYPhbFMbpuZMOPScbuHfhibibE32INQuVg/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.4296028880866426" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6JsfK4DqkKLia2XK2wcL6ibmXFReLBH6tzhOrsWJicxGhTVcfGoZvu47rA/640?wx_fmt=png" data-type="png" data-w="831" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6JsfK4DqkKLia2XK2wcL6ibmXFReLBH6tzhOrsWJicxGhTVcfGoZvu47rA/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.20359281437125748" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6U3fh6lFYKcU4icujxsUUiaOlUpfm3eGLsgr7VYrntIb9efVvAkhBETSw/640?wx_fmt=png" data-type="png" data-w="835" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6U3fh6lFYKcU4icujxsUUiaOlUpfm3eGLsgr7VYrntIb9efVvAkhBETSw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">我们前面Bcells输入了6个基因，有一个不在该数据集features中，感觉计算AUC类似计算一个分数，后面就要找分数显著阈值</p><figure data-tool="mdnice编辑器"><img data-ratio="0.22023809523809523" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6DKyseQzjWBC2PZjwOtVaCU0SsFDNY1Q08Nddp8cDwicdn0EkqU3jRfA/640?wx_fmt=png" data-type="png" data-w="840" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6DKyseQzjWBC2PZjwOtVaCU0SsFDNY1Q08Nddp8cDwicdn0EkqU3jRfA/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.09013282732447818" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd66JpDyZZjibaTcIoyO42RqbhA1EMBCIHqacfg3UV2CTBGIxibbqNiacChg/640?wx_fmt=png" data-type="png" data-w="1054" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd66JpDyZZjibaTcIoyO42RqbhA1EMBCIHqacfg3UV2CTBGIxibbqNiacChg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">标记Bcells marker 列表 AUC得分显著显著的细胞</p><figure data-tool="mdnice编辑器"><img data-ratio="0.1076388888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd65pngFMOhhQDzca5hibTbawGic6guDae2aOoww9AT3ibvf9DS6RW3jzFWQ/640?wx_fmt=png" data-type="png" data-w="864" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd65pngFMOhhQDzca5hibTbawGic6guDae2aOoww9AT3ibvf9DS6RW3jzFWQ/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span>使用<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247514316&amp;idx=1&amp;sn=139a39771f22b6e7a484523313909f4c&amp;chksm=ea1cbe4edd6b3758f6c9564ca49ff66db7ea727ddf9d2391fa4a88132ac8f582a336ffcfd157&amp;scene=21&amp;cur_album_id=3019915773533913092#wechat_redirect" data-linktype="2">初探单细胞下游</a>推文代码实现一下基本流程：</h2><figure data-tool="mdnice编辑器"><img data-ratio="1.0324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6ppdKO3SfiaU45GfMzEmhBDKRlMqwlEtvFGsL3B8gttnwCyPm3PWB4vg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6ppdKO3SfiaU45GfMzEmhBDKRlMqwlEtvFGsL3B8gttnwCyPm3PWB4vg/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span>可视化AUCells结果</h2><pre data-tool="mdnice编辑器"><span></span><code>DimPlot(object = pbmc, group.by = "is_list", label = TRUE) +<br>DimPlot(object = pbmc, label = TRUE)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.4546296296296296" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6kuCPsEPZpUmZw1RTGoNvnNFztD1Vd2fTpU1UJ6cbnvDzyFXjJ0IiaDA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6kuCPsEPZpUmZw1RTGoNvnNFztD1Vd2fTpU1UJ6cbnvDzyFXjJ0IiaDA/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>局限性：</h2><blockquote data-tool="mdnice编辑器"><p>这里测试了多种单细胞亚群的标记基因列表，发现如果是比较过于类似的细胞是没办法区分的，比如 CD14+ Mono  和  FCGR3A+ Mono，以及 Memory CD4 T和  Naive CD4 T ，或者说是需要首先区分了它们后找到了它们的特异性基因然后再使用这些基因才有可能区分它们，就陷入了一个鸡生蛋蛋生鸡的死循环。。。。</p><p>但是，对b细胞来说，就没有这个问题， 因为它和t细胞是截然不同，而且也不可能去跟髓系免疫细胞混淆。。。</p></blockquote><blockquote data-tool="mdnice编辑器"><p>可以看到基本上是近乎完美的区分了b细胞和其它细胞，<strong>就需要实现知道所有的单细胞亚群的标记基因然后去一个个测试。所以这种方法并不是单细胞亚群命名的主流操作，仅仅是特殊情况下，需要去确定某个未知的单细胞亚群或者说想搞清楚某个状态的单细胞亚群或者某个通路激活的单细胞才会这样的操作</strong></p><p><strong>更多的用处可以是针对某个亚群显示多个基因的打分</strong></p></blockquote><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>scGate: marker-based purification of cell types from heterogeneous single-cell RNA-seq datasets(https://github.com/carmonalab/scGate)</h1><p data-tool="mdnice编辑器">scGate 是一个 R 软件包，它将典型的基于人工标记的细胞类型注释方法自动化，从而能够从复杂的 scRNA-seq 数据集中准确、直观地纯化出感兴趣的细胞群，而无需参考基因表达谱或训练数据。</p><p data-tool="mdnice编辑器">scGate 基于 UCell 进行稳健的单细胞特征评分，并基于 Seurat 这一全面而强大的单细胞 omics 分析框架。</p><p data-tool="mdnice编辑器">简而言之，scGate 的输入包括：i) 存储在 Seurat 对象中的基因表达矩阵；ii) 一个 "门控模型"（GM），由一组定义相关细胞群的标记基因组成。基因门控模型可以是简单的单一标记基因，也可以是阳性和阴性标记基因的组合。更复杂的 GM 可以分级方式构建，类似于流式细胞仪中使用的门控策略。</p><p data-tool="mdnice编辑器">scGate 使用基于等级的方法 UCell 评估每个细胞中特征标记表达的强度，然后通过计算相邻细胞的平均 UCell 分数来执行 k 近邻（kNN）平滑。最后，根据用户提供的门控模型生成的二元决策树中，会对 kNN 平滑特征得分应用一个通用阈值，从而将细胞注释为 "纯 "或 "不纯"，与感兴趣的细胞群相关。</p><h2 data-tool="mdnice编辑器"><span></span>Testing the package</h2><p data-tool="mdnice编辑器">使用scGate使用手动定义的标记基因纯化感兴趣的细胞群体</p><pre data-tool="mdnice编辑器"><span></span><code>library(scGate)<br><br>#Get a test scRNA-seq dataset (as a list of Seurat objects)<br>sample.data.seurat.list &lt;- scGate::get_testing_data()<br><br>seurat_object &lt;- sample.data.seurat.list$Satija<br><br>#Manually define a simple scGate gating model to purify eg. Natural Killer (NK) cells, using a positive marker KLRD1 and negative marker CD3D<br>my_scGate_model &lt;- gating_model(name = "NK", signature = c("KLRD1","CD3D-"))  <br><br>#scGate it!<br>seurat_object &lt;- scGate(data = seurat_object, model = my_scGate_model)<br><br>#Use Seurat to visualize "Pure" and "Impure" cells<br>DimPlot(seurat_object, group.by = "is.pure")<br><br>#Use Seurat to subset pure cells<br>seurat_object_purified &lt;- subset(seurat_object, subset = `is.pure` == "Pure" )<br></code></pre><p data-tool="mdnice编辑器">这段代码使用的测试数据集需要魔法否则无法获取，所以这里只作示例看看用法，我们还是具体到使用上面pbmc的数据集</p><p data-tool="mdnice编辑器">可以发现所需输入和前面AUCell类似：seurat对象和标记基因列表</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; seurat_object &lt;- pbmc<br>&gt; my_scGate_model &lt;- gating_model(name=<span>"Bcells"</span>,signature = Bcells)<br>&gt; Bcells<br>[1] <span>"MS4A1"</span> <span>"SDC1"</span>  <span>"CD27"</span>  <span>"CD38"</span>  <span>"CD19"</span>  <span>"CD79A"</span><br>&gt; <br>&gt; seurat_object &lt;- scGate(data = seurat_object, model = my_scGate_model)<br>Warning: The following genes were not found and will be<br>                        imputed to exp=0:<br>* SDC1<br><span>### Detected a total of 337 pure 'Target' cells (12.77% of total)</span><br>&gt; DimPlot(seurat_object, group.by = <span>"is.pure"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5879629629629629" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6XggbVu9nhmmDtRY084t9RTgXbAuDiap0fCha3ZxjQT0WTM3ZPdn7g6g/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6XggbVu9nhmmDtRY084t9RTgXbAuDiap0fCha3ZxjQT0WTM3ZPdn7g6g/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">感觉效果比AUCell好呢</p><h2 data-tool="mdnice编辑器"><span></span>Pre-defined Gating Models</h2><blockquote data-tool="mdnice编辑器"><p>A database of gating models for scGate is available on scGate_models and can be loaded using <code>get_scGateDB()</code></p><p>https://github.com/carmonalab/scGate_models</p><pre><span></span><code><span>#Get scGate database of pre-defined gating models</span><br>scGate_models_DB &lt;- get_scGateDB()<br><br><span>#For example, filter abT cells using one of scGate pre-defined gating models</span><br>seurat_object &lt;- scGate(seurat_object, model = scGate_models_DB$human$generic$Tcell.alphabeta)<br><br>DimPlot(seurat_object)<br></code></pre><p>The first time you run <code>get_scGateDB()</code> the database will be downloaded from the repository. On successive calls it will load your local version of the DB.</p></blockquote><p data-tool="mdnice编辑器">这个包的仓库还提供了一些定义好的scGate_model，也就是细胞亚型的markers</p><p data-tool="mdnice编辑器">我们根据提供的代码进行修改，将model参数使用的markers改为Bcells的，看看</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; <span>#Get scGate database of pre-defined gating models</span><br>&gt; scGate_models_DB &lt;- get_scGateDB()<br>trying URL <span>'https://github.com/carmonalab/scGate_models/archive/master.zip'</span><br>downloaded 27 KB<br>&gt; <br>&gt; <span>#For example, filter abT cells using one of scGate pre-defined gating models</span><br>&gt; seurat_object &lt;- scGate(seurat_object, model = scGate_models_DB<span>$human</span><span>$generic</span><span>$Bcell</span>)<br>Warning: The following genes were not found and will be<br>                        imputed to exp=0:<br>* COL1A1,RAMP2,SFTPB,SLPI,WFDC2,PIGR,SLC34A2,SFTA2,AGR3,ELF3,KRT19,COL1A2,COL3A1,DCN,LUM,THY1,MSR1Warning: pseudoinverse used at -2.2368Warning: neighborhood radius 0.30103Warning: reciprocal condition number  1.9598e-16<br><span>### Detected a total of 345 pure 'Target' cells (13.08% of total)</span><br>&gt; <br>&gt; DimPlot(seurat_object)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5814814814814815" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd65ibOSv6zgqD680FBJW52cocVdtZGzPlrrwlakGH3hjZOA3C43DPGP5w/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd65ibOSv6zgqD680FBJW52cocVdtZGzPlrrwlakGH3hjZOA3C43DPGP5w/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">效果也很好</p><p data-tool="mdnice编辑器">第二次调用Pre-defined Gating Models，会使用本地下载好的，并提示可以更新：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; scGate_models_DB &lt;- get_scGateDB()<br>Using <span>local</span> version of repo scGate_models-master. If you want update it, <span>set</span> option force_update = TRUE<br></code></pre><p data-tool="mdnice编辑器">用来分型很方便</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5423076923076923" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6mMaZIZ2UsxJq0NEuuCTg5iceABkXBswb9xs0744icBGFKxLmzDZEvEpQ/640?wx_fmt=png" data-type="png" data-w="780" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6mMaZIZ2UsxJq0NEuuCTg5iceABkXBswb9xs0744icBGFKxLmzDZEvEpQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">可以使用plot_tree函数来可视化某个模型的层次结构（需要ggparty）</p><pre data-tool="mdnice编辑器"><span></span><code>install.packages("ggparty")<br>scGate::plot_tree(scGate_models_DB$human$generic$Tcell.alphabeta)<br></code></pre><blockquote data-tool="mdnice编辑器"><p>一个 "门控模型"（GM），由一组定义相关细胞群的标记基因组成。基因门控模型可以是简单的单一标记基因，也可以是阳性和阴性标记基因的组合。更复杂的 GM 可以分级方式构建，类似于流式细胞仪中使用的门控策略。</p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="0.5212962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6CJBFg3OXep8qGuibdunw59CNQFaYOiaSSvNJXDUNibpTnvyibeG42HyU8A/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6CJBFg3OXep8qGuibdunw59CNQFaYOiaSSvNJXDUNibpTnvyibeG42HyU8A/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6zmYibukAocAduthELodGgF9QDibFJQyYmsDEKPzzKt5Doics3EZ7MdxxQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6zmYibukAocAduthELodGgF9QDibFJQyYmsDEKPzzKt5Doics3EZ7MdxxQ/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>scGate as a multi-class classifier</h2><blockquote data-tool="mdnice编辑器"><p>scGate还可以用作细胞类型分类器，对数据集中的多个细胞类型进行注释。要用基于标记的细胞类型定义注释数据集，只需向scGate提供模型列表，例如：</p><pre><span></span><code>models.list &lt;- scGate_models_DB$human$generic[c("Bcell","MoMacDC","CD8T","CD4T","Erythrocyte")]<br>obj &lt;- scGate(obj, model = models.list)<br></code></pre></blockquote><p data-tool="mdnice编辑器">根据我们这个pbmc数据集修改代码：</p><pre data-tool="mdnice编辑器"><span></span><code>models.list &lt;- scGate_models_DB$human$generic[c("Bcell","Monocyte","CD4T","CD8T","NK","panDC")]<br>pbmc &lt;- scGate(pbmc, model = models.list)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>Warning: The following genes were not found and will be<br>                        imputed to exp=0:<br>* COL1A1,RAMP2,SFTPB,SLPI,WFDC2,PIGR,SLC34A2,SFTA2,AGR3,ELF3,KRT19,COL1A2,COL3A1,DCN,LUM,THY1,MSR1,TM4SF1,VWF,EPAS1,SPARCL1,CLDN18,APOE,APOC1,KIT,CPA3,TPSAB1,TPSB2,MS4A2,CLEC9A,XCR1,RAB7B,CCL19,CCL22,TRAC,TRBC1,TRBC2,TRDC,TRGC1,TRGC2,TRDV1,TRDV2,HBB,HBA2Warning: pseudoinverse used at -2.2368Warning: neighborhood radius 0.30103Warning: reciprocal condition number  1.9598e-16<br><span>### Detected a total of 345 pure 'Bcell' cells (13.08% of total)</span><br><br><span>### Detected a total of 652 pure 'Monocyte' cells (24.72% of total)</span><br><br><span>### Detected a total of 1027 pure 'CD4T' cells (38.93% of total)</span><br><br><span>### Detected a total of 438 pure 'CD8T' cells (16.60% of total)</span><br><br><span>### Detected a total of 142 pure 'NK' cells (5.38% of total)</span><br><br><span>### Detected a total of 12 pure 'panDC' cells (0.45% of total)</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>&gt; table(pbmc@meta.data<span>$scGate_multi</span>)<br><br>   Bcell     CD4T     CD8T Monocyte    Multi       NK <br>     343     1025      434      652        6      138 <br>&gt; DimPlot(pbmc, group.by = <span>"scGate_multi"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5332527206771464" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6dEicG9S78auKVVZGnrt6T2icZNeW8V151ziactibRvu0obek8Hpjtw3waA/640?wx_fmt=png" data-type="png" data-w="827" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6dEicG9S78auKVVZGnrt6T2icZNeW8V151ziactibRvu0obek8Hpjtw3waA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">大致分类和我们前面手动选择markers注释一致</p><figure data-tool="mdnice编辑器"><img data-ratio="0.4" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6Dvo4G1GbJ5gNByg9Gn8oaPPqNP5OaXlJYEEqTibezgK9vzD70MaUFQw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6Dvo4G1GbJ5gNByg9Gn8oaPPqNP5OaXlJYEEqTibezgK9vzD70MaUFQw/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>&gt; models.list<span>$Bcell</span><br>   levels   use_as        name                                                            signature<br>1  level1 positive      Immune                          PTPRC;LAPTM5;SRGN;CXCR4;CD52;COL1A1-;RAMP2-<br>2  level1 positive    Lymphoid                                                                  LCK<br>3  level1 positive    PanBcell                                                                CD79A<br>4  level1 positive       Bcell                                                MS4A1;BANK1;PAX5;CD19<br>5  level1 positive         APC HLA-DRA;HLA-DMB;HLA-DMA;HLA-DQA1;HLA-DQB1;HLA-DRB1;HLA-DPA1;HLA-DPB1<br>6  level1 negative  Epithelial       SFTPB;SLPI;WFDC2;PIGR;SLC34A2;SFTA2;AGR3;ELF3;KRT18;KRT19;KRT8<br>7  level1 negative     Stromal          COL1A1;COL1A2;COL3A1;DCN;LUM;ACTA2;THY1;KRT18-;KRT19-;KRT8-<br>8  level2 positive    Lymphoid                                                                  LCK<br>9  level2 positive       Bcell                                                MS4A1;BANK1;PAX5;CD19<br>10 level2 positive    PanBcell                                                                CD79A<br>11 level2 negative     Myeloid                                                    SPI1;CD79A-;CD19-<br>12 level2 negative     MoMacDC                                LYZ;CSF1R;MSR1;MAFB;CD300E;ITGAX;CD68<br>13 level2 negative Neutrophils                                                  CSF3R;FCGR3B;ANXA2-<br>14 level3 positive    PanBcell                                                                CD79A<br>15 level3 positive       Bcell                                                MS4A1;BANK1;PAX5;CD19<br>16 level3 negative       Tcell                                                   CD3D;CD3E;CD3G;CD2<br>17 level3 negative          NK                 KLRD1;NKG7;NCR1;FCGR3A;CD3D-;CD3E-;CD3G-;CD8A-;CD8B-<br>18 level4 positive       Bcell                                                MS4A1;BANK1;PAX5;CD19<br></code></pre><blockquote data-tool="mdnice编辑器"><p>一个 "门控模型"（GM），由一组定义相关细胞群的标记基因组成。基因门控模型可以是简单的单一标记基因，也可以是阳性和阴性标记基因的组合。更复杂的 GM 可以分级方式构建，类似于流式细胞仪中使用的门控策略。</p></blockquote><p data-tool="mdnice编辑器">我们也可以参考这个格式自定义一些model，利用这个框架，可以避免手动注释带来的误差和耗时</p><blockquote data-tool="mdnice编辑器"><p>You may manually edit the available models (eg in Excel) or create new models for your cell type of interest. You can then load your custom model into R using:</p><pre><span></span><code>my_scGate_model &lt;- load_scGate_model(<span>"path_to_my.model"</span>)<br></code></pre></blockquote><h2 data-tool="mdnice编辑器"><span></span>Other single-cell modalities</h2><figure data-tool="mdnice编辑器"><img data-ratio="0.07962962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6nNSdkz2z9RE6xG8NekxaIbRsYQ2coaiaeqtxQeHlsoxMttL2Y3zROnA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6nNSdkz2z9RE6xG8NekxaIbRsYQ2coaiaeqtxQeHlsoxMttL2Y3zROnA/640?wx_fmt=png"></figure><h1 data-tool="mdnice编辑器"><span></span></h1><hr><h1 data-tool="mdnice编辑器">singleR</h1><p data-tool="mdnice编辑器">https://github.com/dviraran/SingleR</p><figure data-tool="mdnice编辑器"><img data-ratio="0.262037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6nx5HVVXGZVe1PmurnCo3Ribt7zn5uhibN4epWE9UhN4VAITy85lYuw6g/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6nx5HVVXGZVe1PmurnCo3Ribt7zn5uhibN4epWE9UhN4VAITy85lYuw6g/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>&gt; BiocManager::install(<span>"singleR"</span>)<br><span>'getOption("repos")'</span> replaces Bioconductor standard repositories, see <span>'help("repositories", package =<br>"BiocManager")'</span> <span>for</span> details.<br>Replacement repositories:<br>    CRAN: https://mirrors.tuna.tsinghua.edu.cn/CRAN/<br>Bioconductor version 3.16 (BiocManager 1.30.21.1), R 4.2.2 (2022-10-31)<br>Installing package(s) <span>'singleR'</span><br>Warning: package ‘singleR’ is not available <span>for</span> Bioconductor version <span>'3.16'</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.2132049518569463" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6771BtxLCsWYCes8UOqUwBiaWLr2dicoqJQ9Fzy4pHkc7j9KZXUGEKictg/640?wx_fmt=png" data-type="png" data-w="727" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6771BtxLCsWYCes8UOqUwBiaWLr2dicoqJQ9Fzy4pHkc7j9KZXUGEKictg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">https://bioconductor.org/packages/3.16/bioc/html/SingleR.html</p><figure data-tool="mdnice编辑器"><img data-ratio="1.1690140845070423" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd628N8LrlBHT8nicxuC3cR6qRRn3yqCF0npDzgpLfpjfes2pCVjKtbBZw/640?wx_fmt=png" data-type="png" data-w="781" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd628N8LrlBHT8nicxuC3cR6qRRn3yqCF0npDzgpLfpjfes2pCVjKtbBZw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">https://bioconductor.org/packages/3.16/bioc/src/contrib/SingleR_2.0.0.tar.gz</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; install.packages(<span>"SingleR_2.0.0.tar.gz"</span>,repos = NULL)<br>Installing package into ‘/home/data/t120455/R/x86_64-pc-linux-gnu-library/4.2’<br>(as ‘lib’ is unspecified)<br>ERROR: dependencies ‘BiocSingular’, ‘beachmat’ are not available <span>for</span> package ‘SingleR’<br>* removing ‘/home/data/t120455/R/x86_64-pc-linux-gnu-library/4.2/SingleR’<br>Warning <span>in</span> install.packages :<br>  installation of package ‘SingleR_2.0.0.tar.gz’ had non-zero <span>exit</span> status<br></code></pre><p data-tool="mdnice编辑器">安装依赖后</p><pre data-tool="mdnice编辑器"><span></span><code>install.packages(<span>"SingleR_2.0.0.tar.gz"</span>,repos = NULL)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>SingleR - Single-cell Recognition</h2><blockquote data-tool="mdnice编辑器"><p>单细胞RNA-seq（scRNA-seq）的最新进展使表征疾病模型中基因表达变化的粒度达到了前所未有的水平。已经开发了多种单细胞分析方法来检测基因表达变化并通过基因表达的相似性对细胞进行聚类。然而，按细胞类型对聚类的分类在很大程度上依赖于已知的标记基因，并且聚类的注释是手动进行的。这种策略具有主观性，并限制了密切相关的细胞亚群的充分分化。</p><p>在这里，我们提出了SingleR，一种新的无偏细胞类型识别scRNA-seq的计算方法。SingleR利用纯细胞类型的参考转录组数据集来独立推断每个单细胞的起源细胞。SingleR的注释与Seurat（一种为scRNA-seq设计的处理和分析包）相结合，为scRNA-seq数据的研究提供了强大的工具。我们开发了一个R包来生成带注释的scRNA-seq对象，然后可以使用SingleR web工具对数据进行可视化和进一步分析——http://comphealth.ucsf.edu/SingleR.</p></blockquote><p data-tool="mdnice编辑器">使用参考：</p><blockquote data-tool="mdnice编辑器"><p>https://github.com/dviraran/SingleR#usage</p><p>https://bioconductor.org/packages/3.16/bioc/manuals/SingleR/man/SingleR.pdf</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzkyNTQzNDIwOA==&amp;mid=2247484102&amp;idx=1&amp;sn=7d6e9cad6b3ed70f499e673173fbc028&amp;scene=21#wechat_redirect" data-linktype="2">基于SingleR和scmap两种算法的单细胞自动化注释示例演练</a></p></blockquote><h2 data-tool="mdnice编辑器"><span></span>获取celldex参考数据集</h2><figure data-tool="mdnice编辑器"><img data-ratio="0.47693817468105987" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6TsLXB6zMjlse4jWmv5HDmLReoT2gaFibeevicvwjBcvib5unM17Qrol6Q/640?wx_fmt=png" data-type="png" data-w="1019" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6TsLXB6zMjlse4jWmv5HDmLReoT2gaFibeevicvwjBcvib5unM17Qrol6Q/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p>这些参考数据集集成到一个R包中，即celldex</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code># install.packages("SingleR_2.0.0.tar.gz",repos = NULL)<br>rm(list=ls())<br>load("pbmc.Rdata")<br>library(Seurat)<br>library(tidyverse)<br>library(patchwork)<br>library(SingleR)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>pbmc<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>BiocManager::install("celldex")<br></code></pre><p data-tool="mdnice编辑器">第一次使用会提示创建一个cache文件夹，保存到本地</p><pre data-tool="mdnice编辑器"><span></span><code>library(celldex)<br># human<br>hpca.se &lt;- HumanPrimaryCellAtlasData()<br>bpe.se &lt;- BlueprintEncodeData()<br>DICE &lt;- DatabaseImmuneCellExpressionData() <br>NHD &lt;- NovershternHematopoieticData() <br>MID &lt;- MonacoImmuneData()<br># mouse<br>MRD &lt;- MouseRNAseqData() <br>IGD &lt;- ImmGenData()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.3212962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6EQ7pdcW6ThibkX8FYZT8mg8HC9DUYk5UEawzP5E7LGWt5UGM2xwktMg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6EQ7pdcW6ThibkX8FYZT8mg8HC9DUYk5UEawzP5E7LGWt5UGM2xwktMg/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.2942271880819367" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6dic2iag5HCfn2eOeD0zECicSJu7PlYOSpjg75ibxrYIqicx4Qo3dbCRjxuA/640?wx_fmt=png" data-type="png" data-w="1074" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6dic2iag5HCfn2eOeD0zECicSJu7PlYOSpjg75ibxrYIqicx4Qo3dbCRjxuA/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.4462962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6h8FOy0GKNxaWNt0QqKtpn2xeTicFON07asLym8OInD9Cz9VgU40E9xA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6h8FOy0GKNxaWNt0QqKtpn2xeTicFON07asLym8OInD9Cz9VgU40E9xA/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>加载单细胞数据</h2><pre data-tool="mdnice编辑器"><span></span><code># 将Seurat对象，转换为 SingleCell 对象，一种 SingleR 可接受的输入文件<br>test &lt;- as.SingleCellExperiment(pbmc)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>细胞注释</h2><p data-tool="mdnice编辑器">我们这里前面也进行过了这样的步骤</p><h3 data-tool="mdnice编辑器"><span></span>基于单个参考集的注释：<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code># 基于单个参考集的注释<br>Anno &lt;- SingleR(test = test,<br>                 ref = bpe.se,<br>                 labels = bpe.se$label.main<br>                )<br>pbmc@meta.data$SingleR &lt;- Anno$labels<br>DimPlot(pbmc, group.by = "SingleR", reduction = "umap", label = TRUE)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6HpTicpYMXwKUGlicNn4IpOSwFFqlOrAIcv7VVcBZCrJaE1zJfca6khQA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6HpTicpYMXwKUGlicNn4IpOSwFFqlOrAIcv7VVcBZCrJaE1zJfca6khQA/640?wx_fmt=png"><figcaption>img</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>基于多个参考集的注释：<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code># 基于多个参考集的注释<br>Anno2 &lt;- SingleR(test = test,<br>                 ref = list(HP = hpca.se , BP = bpe.se),<br>                 labels = list(hpca.se$label.main , bpe.se$label.main))<br>pbmc@meta.data$SingleR2 &lt;- Anno2$labels<br>DimPlot(pbmc, group.by = "SingleR2", reduction = "umap", label = TRUE)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6073147256977863" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6vNKgSpNhBf4sicCNXzGvSqVHFLEQnibzpBrDD8rsCgUvsHeysGpNIHTg/640?wx_fmt=png" data-type="png" data-w="1039" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6vNKgSpNhBf4sicCNXzGvSqVHFLEQnibzpBrDD8rsCgUvsHeysGpNIHTg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">可以发现不同注释数据集中冗余的细胞类型</p><blockquote data-tool="mdnice编辑器"><p>多个参考数据集的注释，注释结果中会有冲突，需要专业的知识的判断取舍；多个数据集的细胞命名有些许的差异，可以手动更改后再进行展示。</p></blockquote><p data-tool="mdnice编辑器">我感觉这个比scGate方便的点在于可以自行注释可能的细胞类型，不需要自己先手动地选择细胞类型来注释，当然别人给的不一定是适合的</p><hr data-tool="mdnice编辑器"><blockquote data-tool="mdnice编辑器"><p>SingleR的另一个优势是也可以自定义一个参考数据集，因为参考数据集的质量或者参考数据集的适用性也是影响注释好坏的一个因素。如果能够找到更好的参考数据集可以自定义，运用SingleR软件进行注释。</p></blockquote><h3 data-tool="mdnice编辑器"><span></span>自定义参考集：<span></span></h3><blockquote data-tool="mdnice编辑器"><p>SingleR如何使用自定义的参考集</p></blockquote><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>scmap</h1><p data-tool="mdnice编辑器">https://github.com/hemberg-lab/scmap</p><blockquote data-tool="mdnice编辑器"><p>scmap-一种无监督投影单细胞RNA-seq数据的工具</p><p>单细胞RNA-seq（scRNA-seq）被广泛用于研究复杂组织的组成，因为该技术允许研究人员使用转录组的无监督聚类来定义细胞类型。然而，由于实验方法和计算分析的差异，直接比较两个不同实验中鉴定的细胞往往具有挑战性。在这里，我们介绍了scmap，这是一种将scRNA-seq实验中的细胞投射到不同实验中鉴定的细胞类型上的方法。</p></blockquote><p data-tool="mdnice编辑器">也是biocmanager安装</p><p data-tool="mdnice编辑器">使用参考：</p><blockquote data-tool="mdnice编辑器"><p>https://bioconductor.org/packages/3.16/bioc/manuals/scmap/man/scmap.pdf</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzkyNTQzNDIwOA==&amp;mid=2247484102&amp;idx=1&amp;sn=7d6e9cad6b3ed70f499e673173fbc028&amp;scene=21#wechat_redirect" data-linktype="2">基于SingleR和scmap两种算法的单细胞自动化注释示例演练</a></p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>load("pbmc.Rdata")<br>library(scmap)<br>library(celldex)<br>library(scater)<br>library(SingleCellExperiment)<br><br># 待查询数据集，转化为 SingleCellExperiment 格式<br># 前面已经进行（看看seurat对象的data和counts就知道了）<br># 这里将省略标准化过程<br>pbmcAnno &lt;- as.SingleCellExperiment(pbmc)<br></code></pre><p data-tool="mdnice编辑器">https://bioconductor.org/packages/3.16/bioc/src/contrib/scater_1.26.1.tar.gz</p><pre data-tool="mdnice编辑器"><span></span><code>install.packages(<span>"scater_1.26.1.tar.gz"</span>,repos=NULL)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>定义参考基因数据集文件</h2><blockquote data-tool="mdnice编辑器"><p>Scmap软件接受“SingleCellExperiment”对象文件。</p><p>在制定参考基因数据集文件时，默认的基因名称位于“feature_symbol”列，细胞类型位于“cell_type1”列。</p><p>Scmap要求参考数据集是进行归一化和对数转化的（LogNormalize）。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span># 先下载 SingleR 的参考数据集文件</span><br>refData &lt;- celldex::DatabaseImmuneCellExpressionData()<br></code></pre><blockquote data-tool="mdnice编辑器"><p>参考前面singleR celldex参考数据集</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>&gt; refData &lt;- celldex::DatabaseImmuneCellExpressionData()<br>snapshotDate(): 2022-10-31<br>see ?celldex and browseVignettes(<span>'celldex'</span>) <span>for</span> documentation<br>loading from cache<br>Error: failed to load resource<br>  name: EH3488<br>  title: DICE RNA-seq logcounts<br>  reason: error reading from connection<br></code></pre><p data-tool="mdnice编辑器">怀疑是上次下载终端导致的，清除缓存文件：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.387037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd61WAqKfVFiaNsM5YzgnsiaTbDLiapic4dPdBNs2fQavtliaXZmsoQEZafRZg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd61WAqKfVFiaNsM5YzgnsiaTbDLiapic4dPdBNs2fQavtliaXZmsoQEZafRZg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><code>DatabaseImmuneCellExpressionData</code>这个数据集下载很慢，晚上感觉更慢，这里还是用前面的 <code>HumanPrimaryCellAtlasData</code>进行案例测试</p><pre data-tool="mdnice编辑器"><span></span><code># 先下载 SingleR 的参考数据集文件<br># refData &lt;- celldex::DatabaseImmuneCellExpressionData()<br>refData &lt;- HumanPrimaryCellAtlasData()<br>refData<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>class: SummarizedExperiment <br>dim: 19363 713 <br>metadata(0):<br>assays(1): logcounts<br>rownames(19363): A1BG A1BG-AS1 ... ZZEF1 ZZZ3<br>rowData names(0):<br>colnames(713): GSM112490 GSM112491 ... GSM92233<br>  GSM92234<br>colData names(3): label.main label.fine label.ont<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>&gt; colData(refData)<br>DataFrame with 713 rows and 3 columns<br>           label.main             label.fine   label.ont<br>          &lt;character&gt;            &lt;character&gt; &lt;character&gt;<br>GSM112490          DC DC:monocyte-derived:..  CL:0000840<br>GSM112491          DC DC:monocyte-derived:..  CL:0000840<br>GSM112540          DC DC:monocyte-derived:..  CL:0000840<br>GSM112541          DC DC:monocyte-derived:..  CL:0000451<br>GSM112661          DC DC:monocyte-derived:..  CL:0000451<br>...               ...                    ...         ...<br>GSM556665    Monocyte Monocyte:S._typhimur..  CL:0000576<br>GSM92231      Neurons   Neurons:Schwann_cell  CL:0002573<br>GSM92232      Neurons   Neurons:Schwann_cell  CL:0002573<br>GSM92233      Neurons   Neurons:Schwann_cell  CL:0002573<br>GSM92234      Neurons   Neurons:Schwann_cell  CL:0002573<br>&gt; rowData(refData)<br>DataFrame with 19363 rows and 0 columns<br></code></pre><p data-tool="mdnice编辑器">创建SingleCellExperiment对象：</p><pre data-tool="mdnice编辑器"><span></span><code># 定义 cell-type1 列<br>colData(refData)$cell_type1 &lt;- colData(refData)$label.main<br># 定义 feature_symbol 列<br>rowData(refData)$feature_symbol &lt;- rownames(refData)<br># 创建 scmap 参考数据集文件<br>refSCE &lt;- SingleCellExperiment(<br>  assays = list(<br>    logcounts=Matrix::Matrix(assays(refData)$logcounts)<br>  ),<br>  colData=colData(refData),<br>  rowData=rowData(refData)<br>)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>构建细胞索引</h2><blockquote data-tool="mdnice编辑器"><p>这一步是加快注释的步骤。构建索引使用的是高可变基因（含有更多的分类信息，去除混杂的影响因素）。对于筛选的基因的数量，可以通过参数“n_features”来指定，默认是500个基因。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>refSCE &lt;- scmap::selectFeatures(refSCE, suppress_plot = FALSE)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>Error <span>in</span> lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) : <br>  0 (non-NA) cases<br>In addition: Warning message:<br>In linearModel(object, n_features) :<br>  Your object does not contain counts() slot. Dropouts were calculated using logcounts() slot...<br></code></pre><p data-tool="mdnice编辑器">出现问题</p><pre data-tool="mdnice编辑器"><span></span><code>Error <span>in</span> lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) :<br>  0 (non-NA) cases<br></code></pre><p data-tool="mdnice编辑器">参考：error in selectFeatures(https://github.com/hemberg-lab/scmap/issues/29)</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">类似的包还有MACA，只不过是基于python的scanpy框架的</p><p data-tool="mdnice编辑器">https://github.com/ImXman/MACA</p><p data-tool="mdnice编辑器">总的来说可以使用多种方法、多个参考cellmarkers数据集来划分细胞亚型，并可视化<code>gplots::balloonplot()</code>列联表，并且最好有较强的专业知识</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">以上，就是本期转录组周更全部内容，我们系统总结了：单细胞水平样本samples间的差异分析、clusters间的差异分析鉴定marker、一些检索细胞亚型markers的数据库以及如何使用一些打分算法结合markers辅助确定细胞亚型，这四个问题，作为<a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI1Njk4ODE0MQ==&amp;action=getalbum&amp;album_id=3019915773533913092&amp;scene=173&amp;from_msgid=2247514167&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" data-linktype="2">初学者暑期搞定单细胞</a>这个专辑的完结，暑期开始暑期结束，也该有始有终。</p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/hjCrfT1DXhdwS1M4tXL3Ew",target="_blank" rel="noopener noreferrer">原文链接</a>
