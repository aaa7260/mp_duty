---
title: "R语言画图 | 子图嵌套/图上加图"
date: 2024-08-27T00:48:47Z
draft: ["false"]
tags: [
  "fetched",
  "被炸熟的虾"
]
categories: ["Acdemic"]
---
R语言画图 | 子图嵌套/图上加图 by 被炸熟的虾
------
<div><p><span>在文献中，经常可以看到一张大图在角落（多为右上角或右下角）嵌入一张局部小图，例如昨天复现的结果：</span><span></span></p><ul><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzkwNDQwMDI5NQ==&amp;mid=2247488023&amp;idx=1&amp;sn=89342cd05cd5d96179dc897f1f15e830&amp;scene=21#wechat_redirect" data-linktype="2"><span><strong><span>绘图练习 | 将子图嵌入主图（折线图 + 柱状图）</span></strong></span></a></section></li></ul><p><img data-galleryid="" data-imgfileid="100004370" data-ratio="1.1666666666666667" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3IHuyAFfCPJtPxrVPw25XaBeepMKISIsiaAHoCiaMLtPFtcdBeVABSL4D3ynnwkmKiahY02BepZDVx1g/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3IHuyAFfCPJtPxrVPw25XaBeepMKISIsiaAHoCiaMLtPFtcdBeVABSL4D3ynnwkmKiahY02BepZDVx1g/640?wx_fmt=png&amp;from=appmsg"></p><p><span>在</span><code><span>ggplot2</span></code><span>中，首先还是正常绘制主图，之后通过设定子图的位置，就可以将子图叠加在主图上，十分方便。</span></p><ul><li><section><span>方法一：</span><code><span><span>annotation_custom</span></span></code><span>函数</span></section></li><li><section><span>方法二：</span><code><span><span>viewport</span></span></code><span>函数</span></section></li><li><section><span>方法三：</span><code><span><span>inset_element</span></span></code><span>函数</span><span></span></section></li></ul><pre><code><span>library</span>(ggplot2)<br><span># 主图</span><br>p1 &lt;- ggplot(data = iris, aes(x = Petal.Length, y = Petal.Width)) +<br>      geom_point(aes(color = Species),size = <span>2</span>) +<br>      scale_color_manual(values = c(<span>"#93cc82"</span>,<span>"#4d97cd"</span>,<span>"#ea9c9d"</span>)) +<br>      theme_bw(base_size = <span>20</span>)<br><span># 子图</span><br>p2 &lt;- ggplot(data = iris, aes(x = Species, y = Petal.Width)) +<br>      geom_col(aes(fill = Species),show.legend = <span>FALSE</span>) +<br>      scale_fill_manual(values = c(<span>"#93cc82"</span>,<span>"#4d97cd"</span>,<span>"#ea9c9d"</span>)) +<br>      labs(x = <span>NULL</span>, y = <span>NULL</span>) +<br>      theme_bw(base_size = <span>20</span>) + <br>      coord_flip()<br></code></pre><h2><br></h2><h2><span>方法一：annotation_custom函数</span></h2><section><span>这个函数语法一目了然，函数的格式：</span></section><pre><code>p + annotation_custom(grob,xmin,xmax,ymin,ymax)<br></code></pre><ul><li><section><code><span>grob</span></code><span>表示要插入的图表；</span></section></li><li><section><code><span>xmin</span></code><span>和</span><code><span>xmax</span></code><span>表示坐标轴的水平位置；</span></section></li><li><section><code><span>ymin</span></code><span>和</span><code><span>ymax</span></code><span>表示坐标轴的垂直位置。</span></section></li></ul><p><code><span>annotation_custom</span></code><span>函数不仅可以添加子图，还可以添加表。需要注意的是子图嵌入主图之前要先转化成</span><code><span>grob</span></code><span>对象。</span></p><pre><code>p2_grob &lt;- ggplotGrob(p2)<br>p1 + annotation_custom(grob = p2_grob,xmin = <span>2.2</span>,xmax = <span>7</span>,ymin = <span>0</span>,ymax = <span>0.8</span>)<br></code></pre><p><img data-imgfileid="100004378" data-ratio="0.7736450584484591" data-s="300,640" data-type="png" data-w="941" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3IHuyAFfCPJtPxrVPw25XaBlb6KEOZv6A9bV6fva1XwdqEuyfRUjcJ0ECd2kiaxS16AH3FuOZSw11Q/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3IHuyAFfCPJtPxrVPw25XaBlb6KEOZv6A9bV6fva1XwdqEuyfRUjcJ0ECd2kiaxS16AH3FuOZSw11Q/640?wx_fmt=png&amp;from=appmsg"></p><h2><span>方法二：viewport函数</span></h2><p><code><span>grid</span></code><span>包中的</span><code><span>viewport()</span></code><span>函数：</span><code><span>viewport()</span></code><span>函数可以创建视图窗口，由</span><code><span>x</span></code><span>,</span><code><span>y</span></code><span>,</span><code><span>width</span></code><span>与</span><code><span>height</span></code><span>4</span><span>个参数决定视图窗口的大小和位置，范围都是</span><span>0</span><span>到</span><span>1</span><span>。</span></p><pre><code>viewport(x = unit(<span>0.5</span>, <span>"npc"</span>), y = unit(<span>0.5</span>, <span>"npc"</span>),<br>         width = unit(<span>1</span>, <span>"npc"</span>), height = unit(<span>1</span>, <span>"npc"</span>),<br>         default.units = <span>"npc"</span>, just = <span>"centre"</span>)<br></code></pre><p><span>例如，</span><span>(x,y)</span><span>若为</span><span>(0, 0)</span><span>，表示位置是左下角；</span><span>(1, 1)</span><span>表示右上角；</span><span>(0.5, 0.5)</span><span>表示中心。</span>(width，height)<span>的默认单位是</span>npc<span>，范围是</span>0-1<span>；也可使用绝对单位，如</span><code><span>unit(2,"cm")</span></code><span>或</span><code><span>unit(1,"inch")</span></code><span>。</span><span></span></p><pre><code><span>library</span>(grid) <br><span>## 设置子图的位置和大小</span><br>sub_1 &lt;- viewport(width = <span>0.4</span>,height = <span>0.25</span>,x = <span>0.32</span>,y = <span>0.85</span>)<br><span>## 绘制子图嵌套</span><br>print(p1)<br>print(p2,vp = sub_1)<br></code></pre><p><img data-cropselx1="0" data-cropselx2="413" data-cropsely1="0" data-cropsely2="320" data-imgfileid="100004379" data-ratio="0.7756613756613756" data-s="300,640" data-type="png" data-w="945" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3IHuyAFfCPJtPxrVPw25XaBa624E6ibolQjWCPERYsy3rhkibqjHDIryFEVR44CfXAYE0wbM16BhMeA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3IHuyAFfCPJtPxrVPw25XaBa624E6ibolQjWCPERYsy3rhkibqjHDIryFEVR44CfXAYE0wbM16BhMeA/640?wx_fmt=png&amp;from=appmsg"></p><p><span>总的来说，个人觉得位置参数需要反复调整，不如</span><code><span>annotation_custom</span></code><span>函数直接。</span></p><p><span>但</span><code><span>annotation_custom</span></code><span>函数只在默认的笛卡尔坐标系</span><code><span>coord_cartesian()</span></code><span>中起作用，其他的比如极坐标</span><code><span>coord_polar()</span></code><span>，还是得</span><code><span>viewport()</span></code><span>函数来：</span></p><pre><code>p5 + annotation_custom(grob = ggplotGrob(p6),<br>                       ymin = -<span>1000</span>, ymax = <span>5</span>, xmin = -<span>2</span>, xmax = <span>5</span>) <br><span># Error in `annotation_custom()`:</span><br><span># ! Problem while converting geom to grob.</span><br><span># ℹ Error occurred in the 4th layer.</span><br><span># Caused by error in `draw_panel()`:</span><br><span># ! `annotation_custom()` only works with `coord_cartesian()`.</span><br><span># Run `rlang::last_trace()` to see where the error occurred.</span><br></code></pre><pre><code><span>library</span>(grid) <br>sub_1 &lt;- viewport(x = <span>0.42</span>,y = <span>0.5</span>,width = <span>0.22</span>,height = <span>0.28</span>)<br>print(p5)<br>print(p6,vp = sub_1)<br></code></pre><p><img data-imgfileid="100004380" data-ratio="0.5" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3IHuyAFfCPJtPxrVPw25XaBJ8Korl2PrArWeVnENNib6ibqXQs8c8utqCniaIAdDMlqjMZKdkGSsT3Ow/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3IHuyAFfCPJtPxrVPw25XaBJ8Korl2PrArWeVnENNib6ibqXQs8c8utqCniaIAdDMlqjMZKdkGSsT3Ow/640?wx_fmt=png&amp;from=appmsg"></p><p><span>该图片代码出自：</span><a href="https://mp.weixin.qq.com/s?__biz=MzIyOTY3MDA3MA==&amp;mid=2247544330&amp;idx=1&amp;sn=cf4b80b58a93b85a6e4e0d35dbc64e13&amp;scene=21#wechat_redirect" data-linktype="2"><span><strong><span>如何绘制Nat Commun同款环状+散点柱形图组合图表？</span></strong></span></a><span>为了避免图层遮盖，子图记得去除背景（原文是</span><span>AI</span><span>拼图所以不用管）。</span></p><p><span></span></p><h2><span>方法三：inset_element函数</span></h2><p><span>常用拼图包</span><code><span>patchwork</span></code><span>也提供了一个嵌入子图的函数</span><code><span>inset_element()</span></code></p><pre><code>p + inset_element(p2,<br>                  left,bottom,right,top,<br>                  align_to = <span>"panel"</span>,<br>                  ......<br>                   )<br></code></pre><ul><li><section><code><span>left</span></code><span>,</span><code><span>bottom</span></code><span>,</span><code><span>right</span></code><span>,</span><code><span>top</span></code><span>：子图四周边界位置，是相对位置。</span></section></li><li><section><code><span>align_to</span></code><span>：相对位置的参照物，可以是'</span>panel<span>'（默认）, '</span>plot<span>'或'</span>full<span>'。不建议改，因为后两者不好把控。</span></section></li></ul><pre><code><span>library</span>(patchwork)<br>p1 + inset_element(p2, left = <span>0.01</span>, bottom = <span>0.6</span>, right = <span>0.6</span>, top = <span>0.99</span>, align_to = <span>'panel'</span>) <br></code></pre><p><img data-imgfileid="100004381" data-ratio="0.7555791710945803" data-s="300,640" data-type="png" data-w="941" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3IHuyAFfCPJtPxrVPw25XaB3TOuiaDicyiafJfK0uVapulyFqH0aBmWRMScUmkaXd1Qcet5yNwsD4lvw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3IHuyAFfCPJtPxrVPw25XaB3TOuiaDicyiafJfK0uVapulyFqH0aBmWRMScUmkaXd1Qcet5yNwsD4lvw/640?wx_fmt=png&amp;from=appmsg"></p><p><span>暂时记录这三种<img data-ratio="1" data-w="128" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Yellowdog.png" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Yellowdog.png">。</span></p><p><br></p><h3><span><strong>参考文章：</strong></span></h3><p><span><strong><span>1、R语言统计与绘图：</span></strong></span><a href="https://mp.weixin.qq.com/s?__biz=MzU4OTc0OTg2MA==&amp;mid=2247488296&amp;idx=1&amp;sn=e39f9a99083904eee05a8562006e7648&amp;scene=21#wechat_redirect" data-linktype="2"><span><strong><span>R语言统计与绘图：ggplot2如何在大图中添加小图</span></strong></span></a></p><p><span><strong><span>2、繁尘的bio小本本：</span></strong></span><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjY2NzMzOA==&amp;mid=2247483777&amp;idx=1&amp;sn=028336a4c59ecb4c8feaf531fcf31976&amp;scene=21#wechat_redirect" data-linktype="2"><span><strong><span>R语言|将子图嵌入主图的两种方法</span></strong></span></a></p><h3><span></span></h3><section><span></span></section><section><img data-imgfileid="100003752" data-ratio="0.05278592375366569" data-type="png" data-w="341" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/1LTeQhNfr8sUH75oYsoDaqjPCTiaukEmS8tWricW7LnLKKfIE9jKBexibqamsrlibaaXmuc2nicaYibfDFBNCmqX5mBw/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp" src="https://mmbiz.qpic.cn/sz_mmbiz_png/1LTeQhNfr8sUH75oYsoDaqjPCTiaukEmS8tWricW7LnLKKfIE9jKBexibqamsrlibaaXmuc2nicaYibfDFBNCmqX5mBw/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp"></section><section data-tools="135编辑器" data-id="116886" draggable="true"><section><section><section><section><strong data-brushtype="text">被炸熟的虾</strong></section></section></section><section><section><section data-width="35%"><section><img data-cropselx1="0" data-cropselx2="115" data-cropsely1="0" data-cropsely2="115" data-imgfileid="100003750" data-ratio="1" data-type="jpeg" data-w="258" data-width="100%" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/dRYYdqiaan3JjDfj2H8p6gg3CB25AGthbwzrotao4ev5tIe0utthbZRK8yOoDOuTzOSoTSnPWn61IdDCnXsnaiag/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/dRYYdqiaan3JjDfj2H8p6gg3CB25AGthbwzrotao4ev5tIe0utthbZRK8yOoDOuTzOSoTSnPWn61IdDCnXsnaiag/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp"></section></section><section data-width="63%"><section><section><strong>自己的摸索，发现问题麻烦告诉作者，光速回来改正</strong><strong><img data-imgfileid="100003751" data-ratio="1" data-type="png" data-w="64" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3KLQGNxibvI4SdtUfxjINkz2DO8cGEPTgbcMJ357RvXJ7IvWU2p7anljpePpakI9oKu3icJxobBDp5w/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3KLQGNxibvI4SdtUfxjINkz2DO8cGEPTgbcMJ357RvXJ7IvWU2p7anljpePpakI9oKu3icJxobBDp5w/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp"></strong></section></section></section></section></section></section></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/KTHbIht2HkorgV0OVl_42w",target="_blank" rel="noopener noreferrer">原文链接</a>
