---
title: "h5ad格式的单细胞数据如何在seurat中运行"
date: 2024-08-14T04:35:00Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
h5ad格式的单细胞数据如何在seurat中运行 by 生信菜鸟团
------
<div><section><span></span><p>首先需要明确什么工具支持分析这个格式的数据</p><p>Scanpy – Single-Cell Analysis in Python — scanpy</p><p>如果用顺手了R，那么就想想是否可以把h5ad转化为seurat支持的格式呢？</p><p>之前SeuratDisk包是可以的，代码也很简单</p><pre><span></span><code>Convert<span>(</span><span>"pbmc3k_final.h5ad"</span><span>,</span> dest <span>=</span> <span>"h5seurat"</span><span>,</span> overwrite <span>=</span> <span>TRUE</span><span>)</span><br>pbmc3k <span>&lt;-</span> LoadH5Seurat<span>(</span><span>"pbmc3k_final.h5seurat"</span><span>)</span><br>pbmc3k<br><span>#&gt; An object of class Seurat </span><br><span>#&gt; 13714 features across 2638 samples within 1 assay </span><br><span>#&gt; Active assay: RNA (13714 features, 0 variable features)</span><br><span>#&gt;  2 dimensional reductions calculated: pca, umap</span><br></code></pre><p>但是自从seurat升级了以后，这包就不好使了，github上也有一波这样的报错讨论，但没看到很好的解决方法。。。</p><p>那还是上手<span>scanpy</span>试试看~</p><p>参考 [Scanpy单细胞测序学习-环境配置 |  https://www.yingbio.cn/archives/scseq-scanpy-install</p><h2>第一步，安装anaconda设置conda-forge优先级</h2><p>因为打算在windows本地用，所以先下载Download Anaconda Distribution | Anaconda</p><p>然后，打开<code>anaconda shell prompt</code>：</p><pre><span></span><code> conda config --set show_channel_urls yes  <br> conda config --add channels conda-forge<br> conda config --get channels <br></code></pre><h2>第二步，创建小环境装scanpy</h2><pre><span></span><code> conda create --name scanpy python=3.10  <br> conda activate scanpy    <br></code></pre><pre><span></span><code> conda install scanpy python-igraph leidenalg   <br></code></pre><h2>第三步，在vscode中运行代码输出文件</h2><p><img data-backh="416" data-backw="430" data-imgfileid="100042767" data-ratio="0.9674418604651163" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGaQboq5o6fibhhoOBvbuayX6z8WichTKjuSYPlo30ibNczKDBYgL7gj0yw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="430" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGaQboq5o6fibhhoOBvbuayX6z8WichTKjuSYPlo30ibNczKDBYgL7gj0yw/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p><img data-backh="27" data-backw="562" data-imgfileid="100042768" data-ratio="0.04801097393689986" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGdywSJzLcgLicC0wsvVQibDRX1cKaIIA1WoqNfwt5jmCVJNOzibk3rDoew/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="729" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGdywSJzLcgLicC0wsvVQibDRX1cKaIIA1WoqNfwt5jmCVJNOzibk3rDoew/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p><img data-backh="308" data-backw="562" data-imgfileid="100042769" data-ratio="0.5472703062583223" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGptH1KAE6C4zuibblWY73uKFegWdwicaDDCaYSv045PqUaicnuiaJp5R9Ww/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="751" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGptH1KAE6C4zuibblWY73uKFegWdwicaDDCaYSv045PqUaicnuiaJp5R9Ww/640?wx_fmt=png&amp;from=appmsg"></p><p>选择scanpy下面的python版本，然后右下角会发现scanpy这个环境下的python被调用：</p><p><img data-backh="54" data-backw="562" data-imgfileid="100042770" data-ratio="0.0968208092485549" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGe9VzrxI1oN2iabrsQ88pCanRf9iaT10XNyv5XrsjSLslaP0ZRSd8AQSw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="692" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGe9VzrxI1oN2iabrsQ88pCanRf9iaT10XNyv5XrsjSLslaP0ZRSd8AQSw/640?wx_fmt=png&amp;from=appmsg"></p><p>接着输入下面的代码，运行——</p><pre><span></span><code><span>import</span> scanpy <span>as</span> sc<br><span>import</span> scipy.sparse <span>as</span> sparse<br><span>import</span> scipy.io <span>as</span> sio<br><br><span># 读取 AnnData 对象</span><br>filename = <span>"E:/SINGLE_CELL_02/Paper_Review/human bone marrow/spatial-bonemarrow-atlas-my/scRNA_Seq_Analysis/Step1.2_MapExternalDatasets/ExternalDatasets/Ennis_bone_marrow.h5ad"</span><br>adata = sc.read_h5ad(filename)<br><br><span># 打印 AnnData 对象的概览</span><br><span>print</span>(adata)<br><br><br><span># 提取细胞和基因信息</span><br>cellinfo = adata.obs<br>geneinfo = adata.var<br><br><span># 提取稀疏矩阵（计数矩阵）并转置</span><br>mtx = adata.layers[<span>'counts'</span>].T  <span># 使用 'counts' 层的数据</span><br><br><span># 保存细胞信息和基因信息为 CSV 文件</span><br>cellinfo.to_csv(<span>"e:/MyPython/singlecell_scanpy/cellinfo.csv"</span>)<br>geneinfo.to_csv(<span>"e:/MyPython/singlecell_scanpy/geneinfo.csv"</span>)<br><br><span># 保存稀疏矩阵为 .mtx 文件</span><br>sparse_matrix = sparse.csr_matrix(mtx)  <span># 将稀疏矩阵转换为 CSR 格式</span><br>sio.mmwrite(<span>"e:/MyPython/singlecell_scanpy/sparse_matrix.mtx"</span>, sparse_matrix)<br></code></pre><p>再看看AnnData的结构：</p><p><img data-backh="507" data-backw="562" data-imgfileid="100042771" data-ratio="0.9023638232271326" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGd4GsuDibWF4oH9icNIT8baQOBib5Miax9zaeogvZ68hvNZMBBib4I0QbuzQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="973" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGd4GsuDibWF4oH9icNIT8baQOBib5Miax9zaeogvZ68hvNZMBBib4I0QbuzQ/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-backh="346" data-backw="562" data-imgfileid="100042772" data-ratio="0.6161719549641761" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGYyoHA8qnG4HlO9RPcYMxENgIua6WhSQTJF6FXUlaViaM2cRPmC4w0PQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="977" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGYyoHA8qnG4HlO9RPcYMxENgIua6WhSQTJF6FXUlaViaM2cRPmC4w0PQ/640?wx_fmt=png&amp;from=appmsg"></p><p>输出文件二如下：</p><p><img data-backh="118" data-backw="562" data-imgfileid="100042773" data-ratio="0.21072319201995013" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGbOjunzYqkta6WNjA4atmKsFOLzWZMSvJlyr7RY5qHa2icPe42JyGvrg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="802" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8LxPaTjPoicYpAKhljNOWxGbOjunzYqkta6WNjA4atmKsFOLzWZMSvJlyr7RY5qHa2icPe42JyGvrg/640?wx_fmt=png&amp;from=appmsg"></p><p>接下来就可以用seurat处理数据啦~~~</p><pre><span></span><code>rm<span>(</span><span>list</span><span>=</span>ls<span>(</span><span>)</span><span>)</span><br>options<span>(</span>stringsAsFactors <span>=</span> <span>F</span><span>)</span> <br>source<span>(</span><span>'../scRNA_scripts/lib.R'</span><span>)</span><br><br><span>###### step1: 导入数据 ######   </span><br><span># 参考：https://cloud.tencent.com/developer/article/2377361</span><br>library<span>(</span>data.table<span>)</span><br>library<span>(</span>Matrix<span>)</span><br><span># https://hbctraining.github.io/scRNA-seq/lessons/readMM_loadData.html</span><br><span># </span><br><br>dir <span>&lt;-</span> <span>'E:/MyPython/singlecell_scanpy'</span><br>mtx<span>=</span>readMM<span>(</span>file.path<span>(</span>dir<span>,</span><span>"sparse_matrix.mtx"</span><span>)</span><span>)</span><br>mtx<span>[</span><span>1</span><span>:</span><span>4</span><span>,</span><span>1</span><span>:</span><span>4</span><span>]</span><br><span>dim</span><span>(</span>mtx<span>)</span><br><span># 16723 339381</span><br><br>library<span>(</span>data.table<span>)</span> <br><span>##行是基因</span><br>rl<span>=</span>read.csv<span>(</span>file.path<span>(</span>dir<span>,</span><span>"geneinfo.csv"</span><span>)</span><span>,</span>header <span>=</span> <span>F</span><span>)</span> <br>head<span>(</span>rl<span>)</span><br><br><span>##列是细胞</span><br>cl<span>=</span>fread<span>(</span>file.path<span>(</span>dir<span>,</span><span>"cellinfo.csv"</span><span>)</span><span>,</span>header <span>=</span> <span>T</span><span>)</span> <br>head<span>(</span>cl<span>)</span><br><br>head<span>(</span>rl<span>)</span><br><span>dim</span><span>(</span>mtx<span>)</span><br><br>mtx<span>[</span><span>1</span><span>:</span><span>4</span><span>,</span><span>1</span><span>:</span><span>4</span><span>]</span><br><br>rownames<span>(</span>mtx<span>)</span> <span>&lt;-</span> rl<span>$</span>V1<br>colnames<span>(</span>mtx<span>)</span><span>=</span> cl<span>$</span>V1<br>mtx<span>[</span><span>1</span><span>:</span><span>4</span><span>,</span><span>1</span><span>:</span><span>4</span><span>]</span> <br><br>phe<span>=</span>as.data.frame<span>(</span>cl<span>)</span><br>rownames<span>(</span>phe<span>)</span><span>=</span>phe<span>$</span>V1<br>phe <span>&lt;-</span> phe<span>[</span><span>,</span><span>-</span><span>1</span><span>]</span><br>identical<span>(</span>rownames<span>(</span>phe<span>)</span><span>,</span>colnames<span>(</span>mtx<span>)</span><span>)</span> <span>##死去的记忆</span><br><br>sce.all<span>=</span>CreateSeuratObject<span>(</span>counts <span>=</span> mtx <span>,</span><br>                           meta.data <span>=</span> phe<span>)</span><br><br><span>dim</span><span>(</span>sce.all<span>[[</span><span>"RNA"</span><span>]</span><span>]</span><span>$</span>counts <span>)</span><br><span># 16723 339381</span><br>as.data.frame<span>(</span>sce.all<span>@</span>assays<span>$</span>RNA<span>$</span>counts<span>[</span><span>1</span><span>:</span><span>10</span><span>,</span> <span>1</span><span>:</span><span>2</span><span>]</span><span>)</span><br>head<span>(</span>sce.all<span>@</span>meta.data<span>,</span> <span>10</span><span>)</span><br>table<span>(</span>sce.all<span>$</span>orig.ident<span>)</span>  <br><span># SeuratProject </span><br><span># 339381 </span><br></code></pre><span></span></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Sw1QQKRLp_RtUb4Y8q4Z8Q",target="_blank" rel="noopener noreferrer">原文链接</a>
