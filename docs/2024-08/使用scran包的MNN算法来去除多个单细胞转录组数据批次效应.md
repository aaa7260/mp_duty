---
title: "使用scran包的MNN算法来去除多个单细胞转录组数据批次效应"
date: 2024-08-05T06:45:50Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
使用scran包的MNN算法来去除多个单细胞转录组数据批次效应 by 单细胞天地
------
<div><section data-tools="新媒体管家" data-label="powered by xmt.cn"></section><p><br></p><section><blockquote><p>多个样本单细胞转录组数据整合算法以 mutual nearest neighbors (MNNs)和canonical correlation analysis (CCA) 最为出名，见 详细介绍<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247491021&amp;idx=1&amp;sn=23c795697cd70e190c54e3b3641178de&amp;scene=21#wechat_redirect" data-linktype="2">多个单细胞转录组样本的数据整合之CCA-Seurat包</a> </p></blockquote><p>这里我们使用一下scran包的 mutual nearest neighbors (MNNs)方法吧，主要就是读文档而已：https://bioconductor.org/packages/release/bioc/vignettes/scran/inst/doc/scran.html</p><h3><span>首先模拟一个表达矩阵</span></h3><p>这里简单的R矩阵使用<strong>scran</strong>包的<strong>SingleCellExperiment</strong>函数即可构建<strong>SingleCellExperiment</strong>对象：</p><pre><code><span>library</span>(scran)<br>ngenes &lt;- <span>10000</span><br>ncells &lt;- <span>200</span><br>mu &lt;- <span>2</span>^runif(ngenes, -<span>1</span>, <span>5</span>)<br>gene.counts &lt;- matrix(rnbinom(ngenes*ncells, mu=mu, size=<span>10</span>), nrow=ngenes)<br>sce &lt;- SingleCellExperiment(list(counts=gene.counts))<br>sce &lt;- computeSumFactors(sce)<br>sce &lt;- normalize(sce)<br></code></pre><h3><span>然后模拟一下批次效应</span></h3><p>同样也是很简单的一个随机数：</p><pre><code>b1 &lt;- sce<br>b2 &lt;- sce<br><span># Adding a very simple batch effect.</span><br>logcounts(b2) &lt;- logcounts(b2) + runif(nrow(b2), -<span>1</span>, <span>1</span>) <br>combined &lt;- cbind(b1, b2)<br>combined$batch &lt;- gl(<span>2</span>, ncol(b1))<br><span>library</span>(scater)<br>plotPCA(combined, colour_by=<span>"batch"</span>) + ggtitle(<span>"Without correction"</span>)<br></code></pre><p>可以看到批次效应清晰可见：</p><p><img data-ratio="0.8777943368107303" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQRhNf8MUFzM1ORc8KYwtyOIBITBxDvicibAwwK2aTVePicJlgiazIISF1DzQ6rA2TcEc4f9dPCQICs2g/640?wx_fmt=png" data-type="png" data-w="1342" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQRhNf8MUFzM1ORc8KYwtyOIBITBxDvicibAwwK2aTVePicJlgiazIISF1DzQ6rA2TcEc4f9dPCQICs2g/640?wx_fmt=png"></p><p>这里采用的是<strong>scater</strong>包的<strong>plotPCA</strong>函数对<strong>SingleCellExperiment</strong>这样的对象之间PCA运算并且可视化。</p><h3><span>接着使用scater包的fastMNN去除批次效应</span></h3><pre><code>out &lt;- fastMNN(b1, b2)<br>dim(out$corrected)<br>out$batch<br>reducedDim(combined, <span>"corrected"</span>) &lt;- out$correct<br>plotReducedDim(combined, <span>"corrected"</span>, colour_by=<span>"batch"</span>) + ggtitle(<span>"With correction"</span>)<br></code></pre><p>可以非常清楚的看到批次效应被去除了：</p><p><img data-ratio="0.855457227138643" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQRhNf8MUFzM1ORc8KYwtyOlS9ochjFNgdJib6lfd93kiaWPoauicdFUwAc8RBc8icuUXMLUaQ8agXSRw/640?wx_fmt=png" data-type="png" data-w="1356" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQRhNf8MUFzM1ORc8KYwtyOlS9ochjFNgdJib6lfd93kiaWPoauicdFUwAc8RBc8icuUXMLUaQ8agXSRw/640?wx_fmt=png"></p><h3><span>在scRNAseq包的表达矩阵测试</span><br></h3><p>这个包内置的是 Pollen et al. 2014 数据集，人类单细胞细胞，分成<strong>4类</strong>，分别是 pluripotent stem cells 分化而成的 neural progenitor cells (“NPC”) ，还有 “GW16” and “GW21” ，“GW21+3” 这种孕期细胞，理解这些需要一定的生物学背景知识，如果不感兴趣，可以略过。</p><p>这个R包大小是50.6 MB，下载需要一点点时间，先安装加载它们。</p><p>这个数据集很出名，截止2019年1月已经有近400的引用了，后面的人开发<code>R包算法</code>都会在其上面做测试，比如 SinQC 这篇文章就提到：We applied SinQC to a highly heterogeneous scRNA-seq dataset containing 301 cells (mixture of 11 different cell types) (Pollen et al., 2014).</p><p>不过本例子只使用了数据集的<strong>4种细胞类型</strong>而已，因为 scRNAseq 这个R包就提供了这些，完整的数据是 23730 features， 301 samples, 地址为https://hemberg-lab.github.io/scRNA.seq.datasets/human/tissues/ ， 这个网站非常值得推荐，简直是一个宝藏。</p><p>这里面的表达矩阵是由 RSEM (Li and Dewey 2011) 软件根据 hg38 RefSeq transcriptome 得到的，总是130个文库，每个细胞测了两次，测序深度不一样。</p><h4><span>首先拿出表达矩阵构建两个SingleCellExperiment对象</span><span> </span></h4><pre><code><span>library</span>(scRNAseq)<br><span>## ----- Load Example Data -----</span><br>data(fluidigm) <br>ct &lt;- floor(assays(fluidigm)$rsem_counts)<br>ct[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>] <br>sample_ann &lt;- as.data.frame(colData(fluidigm)) <br>table(sample_ann$Coverage_Type)<br>table(sample_ann$Biological_Condition) <br><br>kp=sample_ann$Coverage_Type==<span>'High'</span><br>sce &lt;- SingleCellExperiment(<br>  assays = list(counts = ct[,kp]), <br>  colData = sample_ann[kp,]<br>)<br>sce<br>sce &lt;- computeSumFactors(sce)<br>sce &lt;- normalize(sce)<br>b1 &lt;- sce<br>kp=sample_ann$Coverage_Type==<span>'Low'</span><br>sce &lt;- SingleCellExperiment(<br>  assays = list(counts = ct[,kp]), <br>  colData = sample_ann[kp,]<br>)<br>sce &lt;- computeSumFactors(sce)<br>sce &lt;- normalize(sce)<br>b2 &lt;- sce<br></code></pre><h4><span>然后绘制处理前的PCA图</span><span> </span></h4><pre><code>combined &lt;- cbind(b1, b2)<br>combined$batch &lt;- gl(<span>2</span>, ncol(b1))<br><span>library</span>(scater)<br>plotPCA(combined, colour_by=<span>"batch"</span>,shape_by=<span>'Biological_Condition'</span>) + ggtitle(<span>"Without correction"</span>)<br></code></pre><p>可以看到，不同测序深度的两类细胞分的非常开，就是技术差异批次效应：</p><p><img data-ratio="0.8628318584070797" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQRhNf8MUFzM1ORc8KYwtyO2NnBjtK1ia7K6ebYCfkzgYmBaoUMX0nJ4Dod59u4wx6Eks9IAUjSVLw/640?wx_fmt=png" data-type="png" data-w="1356" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQRhNf8MUFzM1ORc8KYwtyO2NnBjtK1ia7K6ebYCfkzgYmBaoUMX0nJ4Dod59u4wx6Eks9IAUjSVLw/640?wx_fmt=png"></p><p>上图中的NPC细胞，使用+表示的那些点，可以看到不同颜色的左右分很开，仅仅是因为他们的文库测序大小不一样。</p><h4><span>使用scater包的fastMNN去除批次效应</span><span> </span></h4><pre><code>out &lt;- fastMNN(b1, b2)<br>dim(out$corrected)<br>out$batch<br>reducedDim(combined, <span>"corrected"</span>) &lt;- out$correct<br>plotReducedDim(combined, <span>"corrected"</span>, shape_by =<span>"batch"</span>,colour_by=<span>'Biological_Condition'</span>) + ggtitle(<span>"With correction"</span>)<br></code></pre><p>可以看到大不一样，这个时候的NPC，就是下图深红色的，可以看到不同batch聚集的非常近，效果很棒！</p><p><img data-ratio="0.8664688427299704" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQRhNf8MUFzM1ORc8KYwtyOLGHGVeKrcp4PRVyllKL3MEHiccRB0c6O0Ok9Gfnvl5icG1JOF4qfQFEw/640?wx_fmt=png" data-type="png" data-w="1348" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQRhNf8MUFzM1ORc8KYwtyOLGHGVeKrcp4PRVyllKL3MEHiccRB0c6O0Ok9Gfnvl5icG1JOF4qfQFEw/640?wx_fmt=png"></p><h3><span>后记</span></h3><p>其实scran这个包，我们介绍最多的是Cell cycle phase assignment功能，也就是推断细胞周期。在我们的全网第一个单细胞基础课程里面有介绍到，看笔记：</p><ul type="disc"><li data-list-marker="●" data-list-text="●" data-list-id="bullet1r7s5m" data-list-cls="ace-line gutter-author-p-144115210534856334 line-list-type-bullet text-align-type-left pap-left-indent-2em pap-line-24pt pap-line-rule-exact emptyGutter"><p><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484464&amp;idx=1&amp;sn=cec394967fcd20a25c258bed892f2457&amp;chksm=ea1f02b2dd688ba4c2bb0659f7f66349c49d876ec340c84763c29c7bf080dba5cfea90d4b68e&amp;scene=21#wechat_redirect" data-linktype="2">单细胞转录组学习笔记-1</a></span></p></li><li data-list-marker="●" data-list-text="●" data-list-id="bullet1r7s5m" data-list-cls="ace-line gutter-author-p-144115210534856334 line-list-type-bullet text-align-type-left pap-left-indent-2em pap-line-24pt pap-line-rule-exact emptyGutter"><p><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484484&amp;idx=1&amp;sn=eb28c69645f8dbfda6c8a4afaf931883&amp;chksm=ea1f02c6dd688bd0ca7ab1caa3261d9c0f59dc9c83002ca3780bf88e11a94f0893bff3849900&amp;scene=21#wechat_redirect" data-linktype="2">单细胞转录组学习笔记-2</a></span></p></li><li data-list-marker="●" data-list-text="●" data-list-id="bullet1r7s5m" data-list-cls="ace-line gutter-author-p-144115210534856334 line-list-type-bullet text-align-type-left pap-left-indent-2em pap-line-24pt pap-line-rule-exact emptyGutter"><p><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484498&amp;idx=1&amp;sn=45a7aa58d726b68dac1c80d4b686f386&amp;chksm=ea1f02d0dd688bc64fd14e5f0370ec1889215fc5ef3837e34db84f1319f517598d3e69832fc2&amp;scene=21#wechat_redirect" data-linktype="2">单细胞转录组上游分析之shell回顾</a></span></p></li><li data-list-marker="●" data-list-text="●" data-list-id="bullet1r7s5m" data-list-cls="ace-line gutter-author-p-144115210534856334 line-list-type-bullet text-align-type-left pap-left-indent-2em pap-line-24pt pap-line-rule-exact emptyGutter"><p><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484551&amp;idx=1&amp;sn=f58786c646cad53047b28cdc4f9bcd9e&amp;chksm=ea1f0205dd688b1326aa5309e506452aacaa9edadf46e44d8cc9547f1126abc553362ed96800&amp;scene=21#wechat_redirect" data-linktype="2">获取Github代码包以及准备工作</a></span></p></li><li data-list-marker="●" data-list-text="●" data-list-id="bullet1r7s5m" data-list-cls="ace-line gutter-author-p-144115210534856334 line-list-type-bullet text-align-type-left pap-left-indent-2em pap-line-24pt pap-line-rule-exact emptyGutter"><p><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484603&amp;idx=1&amp;sn=6c13a90be81285a71b915c77caa30407&amp;chksm=ea1f0239dd688b2fce040852e8e799d410517e0924c45bb4cd00f749cafbe3972d8def3c2ead&amp;scene=21#wechat_redirect" data-linktype="2">常说的表达矩阵，那得到之后呢？</a></span></p></li><li data-list-marker="●" data-list-text="●" data-list-id="bullet1r7s5m" data-list-cls="ace-line gutter-author-p-144115210534856334 line-list-type-bullet text-align-type-left pap-left-indent-2em pap-line-24pt pap-line-rule-exact emptyGutter"><p><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484644&amp;idx=1&amp;sn=eb86415a435da0ef81c1c0ae3c2767fc&amp;chksm=ea1f0266dd688b7030db7bb57782490f0f23d91c79bb9b89a3e6135657544dd131a9cc26a503&amp;scene=21#wechat_redirect" data-linktype="2">由表达矩阵看内部异质性</a></span></p></li><li data-list-marker="●" data-list-text="●" data-list-id="bullet1r7s5m" data-list-cls="ace-line gutter-author-p-144115210534856334 line-list-type-bullet text-align-type-left pap-left-indent-2em pap-line-24pt pap-line-rule-exact emptyGutter"><p><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484658&amp;idx=1&amp;sn=c0c42921ad194abb76ebdd1bc800a7f7&amp;chksm=ea1f0270dd688b66eb730b2459eb65b885fe85a2f7478c26f2aafc3b3ae6a5054f4de75d7c2c&amp;scene=21#wechat_redirect" data-linktype="2">重复平均表达量和变异系数相关性散点图</a></span></p></li><li data-list-marker="●" data-list-text="●" data-list-id="bullet1r7s5m" data-list-cls="ace-line gutter-author-p-144115210534856334 line-list-type-bullet text-align-type-left pap-left-indent-2em pap-line-24pt pap-line-rule-exact emptyGutter"><p><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484689&amp;idx=1&amp;sn=6689a065d287b0308354b00c0a93bb13&amp;chksm=ea1f0393dd688a85faa81c61c8c2528290a00aa8e379da1f939f5d4f5cfa2127581228961835&amp;scene=21#wechat_redirect" data-linktype="2">聚类算法之PCA与tSNE</a></span></p></li><li data-list-marker="●" data-list-text="●" data-list-id="bullet1r7s5m" data-list-cls="ace-line gutter-author-p-144115210534856334 line-list-type-bullet text-align-type-left pap-left-indent-2em pap-line-24pt pap-line-rule-exact emptyGutter"><p><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484705&amp;idx=1&amp;sn=69b50b56286cd09bc1e9462b3218722d&amp;chksm=ea1f03a3dd688ab57971f11b5e6433e0951cc68fff4de007d01f2ee3237413832420b7ad771b&amp;scene=21#wechat_redirect" data-linktype="2">统计细胞检测的基因数量</a></span></p></li><li data-list-marker="●" data-list-text="●" data-list-id="bullet1r7s5m" data-list-cls="ace-line gutter-author-p-144115210534856334 line-list-type-bullet text-align-type-left pap-left-indent-2em pap-line-24pt pap-line-rule-exact emptyGutter"><p><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484714&amp;idx=1&amp;sn=c5a232af5b0be717b40af56f9f10f9e2&amp;chksm=ea1f03a8dd688abe0c61699db9d9fb1248c5e749abc9354677662a8fa216f3c78ac029f0fd90&amp;scene=21#wechat_redirect" data-linktype="2">乳腺癌领域之PAM50分类</a></span></p></li><li data-list-marker="●" data-list-text="●" data-list-id="bullet1r7s5m" data-list-cls="ace-line gutter-author-p-144115210534856334 line-list-type-bullet text-align-type-left pap-left-indent-2em pap-line-24pt pap-line-rule-exact emptyGutter"><p><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484719&amp;idx=1&amp;sn=c2e28e616261078936e7d34505b03120&amp;chksm=ea1f03addd688abb0e67f1416aef16167584de2b2231b242e1c612e6b873b02eccf1f9575d92&amp;scene=21#wechat_redirect" data-linktype="2">生物学背景知识之细胞周期推断</a></span></p></li></ul><ul type="disc"><li data-list-marker="●" data-list-text="●" data-list-id="bullet308kmo" data-list-cls="ace-line gutter-author-p-144115210534856334 line-list-type-bullet text-align-type-left pap-left-indent-4em pap-line-24pt pap-line-rule-exact emptyGutter"><p><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484749&amp;idx=1&amp;sn=f734117fc9fcb604071b9b6df1739aeb&amp;chksm=ea1f03cfdd688ad97a021f34d0b54fba7c253b7ea7c49cd00a6dc59ead3f2359b794b29576c7&amp;scene=21#wechat_redirect" data-linktype="2">RPKM概念及计算方法</a></span></p></li></ul><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247488803&amp;idx=1&amp;sn=96b8642121587d5c3a782998a601dcf0&amp;chksm=9b485598ac3fdc8edf0bfe90d6b20811bdbae6d93c966939712e1f229399c932e3576c78fba1&amp;scene=21#wechat_redirect" target="_blank" data-itemshowtype="0" data-linktype="2" hasload="1">生信技能树（爆款入门培训课）全国巡讲约你</a> </p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247489021&amp;idx=1&amp;sn=41e95d03cc53a562098cf8c1eac67b55&amp;chksm=9b485546ac3fdc50acead78f53127ea93897bff968e987cd8fbca8cc0ec973f7f2c301cce3b2&amp;scene=21#wechat_redirect" target="_blank" data-itemshowtype="0" data-linktype="2" hasload="1">全网第一个单细胞转录组数据分析实战视频教程(预售第二波通知)</a></p></li><li><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247490898&amp;idx=1&amp;sn=8648024a2a659d89f357e6e1e1127026&amp;chksm=9b485de9ac3fd4ff8030cee34d4fe2d6bf70d8994e22094f65c5d8415064a0671bdb36aa5c2c&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2"><span>全网第二个单细胞视频课程预售</span></a></p></li></ul><p><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=other" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=other"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-id="93668"><section><section data-width="95%"><section><section><section data-width="38%"><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=other" data-type="other" data-w="430" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=other"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/j5qKzR7LHVNp1v1wRAImQg",target="_blank" rel="noopener noreferrer">原文链接</a>
