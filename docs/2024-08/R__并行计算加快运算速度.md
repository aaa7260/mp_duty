---
title: "R! 并行计算加快运算速度"
date: 2024-08-06T01:21:50Z
draft: ["false"]
tags: [
  "fetched",
  "生信小博士"
]
categories: ["Acdemic"]
---
R! 并行计算加快运算速度 by 生信小博士
------
<div><p><strong><code><br></code></strong></p><p><strong><code>lapply</code>的并行版本包括<code><span>mclapply</span></code>（适用于Linux和MacOS系统）和<code>parLapply</code>（适用于所有平台）。此外，还可以使用<code>future</code>包来实现跨平台的并行计算。</strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span><span># 加载必要的包</span></span></code><code><span>library(GSVA)</span></code><code><span>library(parallel)</span></code><code><span><br></span></code><code><span><span># 定义一个函数来运行GSVA分析和保存结果</span></span></code><code><span>run_gsva &lt;- <span><span>function</span><span>(expr, genelist, output_file, ssgsea_norm)</span> </span>{</span></code><code><span>  gsva_mat &lt;- GSVA::gsva(expr = expr, verbose = <span>TRUE</span>,</span></code><code><span>                         gset.idx.<span>list</span> = genelist, </span></code><code><span>                         kcdf = <span>"Gaussian"</span>, <span>#"Gaussian" for logCPM, logRPKM, logTPM, "Poisson" for counts</span></span></code><code><span>                         method = <span>"ssgsea"</span>,  <span>#"gsva", , "zscore", "plage"</span></span></code><code><span>                         ssgsea.norm = ssgsea_norm, <span># 是否跳过 normalizing the scores by the absolute difference between the minimum and the maximum</span></span></code><code><span>                         parallel.sz = <span>1</span>)</span></code><code><span>  save(gsva_mat, file = output_file)</span></code><code><span>}</span></code><code><span><br></span></code><code><span><span># 定义输入参数</span></span></code><code><span>expr &lt;- gene_matrix</span></code><code><span>genelist &lt;- genelist</span></code><code><span><br></span></code><code><span><span># 定义两个任务</span></span></code><code><span>tasks &lt;- <span>list</span>(</span></code><code><span>  <span>list</span>(expr = expr, genelist = genelist, output_file = <span>"~/ipf_spatial_blem/mouse_blm/all_blm_signaling_metacell_ssgsea/phe_blm_metacell_ssgsea_C25_H_C3TF.rds"</span>, ssgsea_norm = <span>TRUE</span>),</span></code><code><span>  <span>list</span>(expr = expr, genelist = genelist, output_file = <span>"~/ipf_spatial_blem/mouse_blm/all_blm_signaling_metacell_ssgsea/phe_blm_metacell_ssgsea_C25_H_C3TF_norm_FALSE.rds"</span>, ssgsea_norm = <span>FALSE</span>)</span></code><code><span>)</span></code><code><span><br></span></code><code><span><span># 并行运行任务</span></span></code><code><span>results &lt;- mclapply(tasks, <span><span>function</span><span>(task)</span> </span>{</span></code><code><span>  run_gsva(task$expr, task$genelist, task$output_file, task$ssgsea_norm)</span></code><code><span>}, mc.cores = detectCores())</span></code><code><span><br></span></code></pre></section><p><br></p><p><strong>对于跨平台的并行计算，可以使用<code><span>future</span></code>包。以下是一个使用<code>future</code>和<code>furrr</code>包</strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span><span># 加载必要的包</span></span></code><code><span>library(GSVA)</span></code><code><span>library(future)</span></code><code><span>library(furrr)</span></code><code><span><br></span></code><code><span><span># 设置未来计划（计划）为多进程</span></span></code><code><span>plan(multisession, workers = detectCores())</span></code><code><span><br></span></code><code><span><span># 定义一个函数来运行GSVA分析和保存结果</span></span></code><code><span>run_gsva &lt;- <span><span>function</span><span>(expr, genelist, output_file, ssgsea_norm)</span> </span>{</span></code><code><span>  gsva_mat &lt;- GSVA::gsva(expr = expr, verbose = <span>TRUE</span>,</span></code><code><span>                         gset.idx.<span>list</span> = genelist, </span></code><code><span>                         kcdf = <span>"Gaussian"</span>, <span>#"Gaussian" for logCPM, logRPKM, logTPM, "Poisson" for counts</span></span></code><code><span>                         method = <span>"ssgsea"</span>,  <span>#"gsva", , "zscore", "plage"</span></span></code><code><span>                         ssgsea.norm = ssgsea_norm, <span># 是否跳过 normalizing the scores by the absolute difference between the minimum and the maximum</span></span></code><code><span>                         parallel.sz = <span>1</span>)</span></code><code><span>  save(gsva_mat, file = output_file)</span></code><code><span>}</span></code><code><span><br></span></code><code><span><span># 定义输入参数</span></span></code><code><span>expr &lt;- gene_matrix</span></code><code><span>genelist &lt;- genelist</span></code><code><span><br></span></code><code><span><span># 定义两个任务</span></span></code><code><span>tasks &lt;- <span>list</span>(</span></code><code><span>  <span>list</span>(expr = expr, genelist = genelist, output_file = <span>"~/ipf_spatial_blem/mouse_blm/all_blm_signaling_metacell_ssgsea/phe_blm_metacell_ssgsea_C25_H_C3TF.rds"</span>, ssgsea_norm = <span>TRUE</span>),</span></code><code><span>  <span>list</span>(expr = expr, genelist = genelist, output_file = <span>"~/ipf_spatial_blem/mouse_blm/all_blm_signaling_metacell_ssgsea/phe_blm_metacell_ssgsea_C25_H_C3TF_norm_FALSE.rds"</span>, ssgsea_norm = <span>FALSE</span>)</span></code><code><span>)</span></code><code><span><br></span></code><code><span><span># 并行运行任务</span></span></code><code><span>results &lt;- future_map(tasks, <span><span>function</span><span>(task)</span> </span>{</span></code><code><span>  run_gsva(task$expr, task$genelist, task$output_file, task$ssgsea_norm)</span></code><code><span>})</span></code><code><span><br></span></code></pre></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/LnfqFQzfChClfMMjMJAQ7w",target="_blank" rel="noopener noreferrer">原文链接</a>
