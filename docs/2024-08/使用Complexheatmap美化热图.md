---
title: "使用Complexheatmap美化热图"
date: 2024-08-21T04:30:27Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
使用Complexheatmap美化热图 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span></span><span>前情提要</span><span></span></h3><p data-tool="mdnice编辑器">上一篇推文整理了<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247524659&amp;idx=1&amp;sn=bbbefc21979ceda1068c6828ca013f5d&amp;scene=21#wechat_redirect" data-linktype="2">Doheatmap常用参数及美化</a></p><p data-tool="mdnice编辑器">一起了解了一下<strong>Doheatmap的常用参数、分组信息及颜色调整、标签信息和分隔线调整的方式</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100041297" data-ratio="0.7925925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQDD3BVNQgSSjXUyoLkU05ejRo0r4TgB6DH3Xa6XtgCDPZuNzwM1HI3CPAMicqJ0FYZCuJ4eDkeFDQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQDD3BVNQgSSjXUyoLkU05ejRo0r4TgB6DH3Xa6XtgCDPZuNzwM1HI3CPAMicqJ0FYZCuJ4eDkeFDQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">这期一起来了解学习一下——<strong>使用Complexheatmap绘制热图复杂热图</strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>Complexheatmap包简介</span><span></span></h3><p data-tool="mdnice编辑器"><code>ComplexHeatmap</code> 包是一个<strong>用于 R 语言的高级数据可视化工具，提供了一套强大的工具，用于创建和自定义复杂的热图，支持丰富的数据可视化需求，特别是在展示高通量生物信息学数据时。</strong></p><blockquote data-tool="mdnice编辑器"><span></span><p>详细介绍可以参考：https://jokergoo.github.io/ComplexHeatmap-reference/book/</p></blockquote><p data-tool="mdnice编辑器"><strong>Complexheatmap包功能简介：</strong></p><ol data-tool="mdnice编辑器"><li><section><p><strong>多种热图类型</strong>：支持创建传统热图、点图、线图等多种类型的热图。</p></section></li><li><section><p><strong>对象导向</strong>：采用面向对象的实现方式，包含多个类，如 <code>Heatmap</code> 类（单个热图）、<code>HeatmapList</code> 类（热图列表）和 <code>HeatmapAnnotation</code> 类（热图注释）。</p></section></li><li><section><p><strong>注释功能</strong>：可以在热图中添加行注释和列注释，可以是独立的组件或作为热图的一部分。</p></section></li><li><section><p><strong>颜色映射</strong>：通过 <code>ColorMapping</code> 类，可以定义值到颜色的映射。</p></section></li><li><section><p><strong>自定义注释</strong>：<code>AnnotationFunction</code> 类允许构建自定义注释，为创造个性化的注释图形提供基础。</p></section></li><li><section><p><strong>图例配置</strong>：配置热图图例和注释图例，以及如何创建自定义图例，以及在生成热图后添加自定义图形的方法。</p></section></li><li><section><p><strong>OncoPrint</strong>：可以制作肿瘤突变图（oncoPrint）以及如何将 <code>ComplexHeatmap</code> 的其他功能整合到 oncoPrint 中。</p></section></li><li><section><p><strong>UpSet 图</strong>：如何制作增强的 UpSet 图。</p></section></li></ol><h3 data-tool="mdnice编辑器"><span></span><span></span><span>Heatmap可视化</span><span></span></h3><p data-tool="mdnice编辑器">使用Complexheatmap包进行热图绘制，用到的是<strong>Heatmap</strong>去进行可视化，<strong>Heatmap</strong>可供调节的参数非常多！</p><p data-tool="mdnice编辑器">可以查看帮助文档，了解详细的参数调节内容。</p><pre data-tool="mdnice编辑器"><span></span><code><span>#加载R</span><br>library(ComplexHeatmap)<br><br>?Heatmap<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041298" data-ratio="1.011336032388664" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQDD3BVNQgSSjXUyoLkU05eVERCTHulMCEejjxkMQzlNDlmYTaicdPSTqN6z3NdKibT6zfxiaP8j7aMQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1235" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQDD3BVNQgSSjXUyoLkU05eVERCTHulMCEejjxkMQzlNDlmYTaicdPSTqN6z3NdKibT6zfxiaP8j7aMQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">用到的数据还是<strong>pbmc3k的示例数据，走完标准降维聚类分群流程之后，使用FindAllMarkers计算所有簇的Marker基因，并且可视化TOP5基因</strong></p><pre data-tool="mdnice编辑器"><span></span><code>pbmc.markers &lt;- FindAllMarkers(pbmc, only.pos = TRUE, min.pct = 0.25,  logfc.threshold = 0.25, verbose = FALSE)<br>top5 = pbmc.markers %&gt;% group_by(cluster) %&gt;% top_n(n = 5, wt = avg_log2FC)<br>g = unique(top5<span>$gene</span>)<br></code></pre><p data-tool="mdnice编辑器">因为需要输入的是<code>matrix</code>矩阵信息，所以需要<strong>对可视化的数据和基因进行整理</strong></p><blockquote data-tool="mdnice编辑器"><span></span><p>matrix	——A matrix. Either numeric or character. If it is a simple vector, it will be converted to a one-column matrix.</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span>#从单细胞矩阵中提取scale.data数据</span><br>sce.sub&lt;-subset(sce,downsample=30)<br><br>data &lt;- GetAssayData(sce.sub, slot = <span>"scale.data"</span>)<br><br><span>#整理亚群注释信息</span><br>celltype_info &lt;- sort(sce.sub<span>$celltype</span>)<br>table(celltype_info)<br><br>celltype_info&lt;-factor(celltype_info,levels = c(<span>"Naive CD4 T"</span>, <span>"CD14+ Mono"</span>, <span>"Memory CD4 T"</span>,<br>                                               <span>"B"</span>, <span>"CD8 T"</span>,<span>"FCGR3A+ Mono"</span>,  <span>"NK"</span>, <span>"DC"</span>,<span>"Platelet"</span>))<br>                                               <br><span>#将 data 中由变量 g 指定和行和 celltype_info 中的细胞类型对应的列转换为一个矩阵，并存储在 mat 变量中</span><br>mat &lt;- as.matrix(data[g, names(celltype_info)])<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041300" data-ratio="0.48487031700288186" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQDD3BVNQgSSjXUyoLkU05eMoNl5NZ0NcpZ1BSlZRysfhJ29Imjibiap3hC9fcZ538wktuhMM52klpg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1388" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQDD3BVNQgSSjXUyoLkU05eMoNl5NZ0NcpZ1BSlZRysfhJ29Imjibiap3hC9fcZ538wktuhMM52klpg/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>简单可视化</span><span></span></h4><ul data-tool="mdnice编辑器"><li><section>设置需要的颜色以及颜色渐变的范围</section></li><li><section>取消行列聚类，并且不展示细胞名字（列名），只展示基因名</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span>#简单可视化</span><br>Heatmap(mat,col = colorRamp2(c(0,2,4), c(<span>"#6395C7"</span>, <span>"white"</span>, <span>"firebrick3"</span>)),<br>        name = <span>"Expression"</span>,<br>        column_split = celltype_info,<br>        cluster_rows = FALSE,<br>        cluster_columns = FALSE,<br>        show_column_names = FALSE,<br>        show_row_names = TRUE)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041301" data-ratio="0.5856636471051595" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQDD3BVNQgSSjXUyoLkU05e9iaCk6c8WfoSMb1LHGw2e0lX28oPGabtS9UIibrv4b4O2ialbZnfwCobA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2539" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQDD3BVNQgSSjXUyoLkU05e9iaCk6c8WfoSMb1LHGw2e0lX28oPGabtS9UIibrv4b4O2ialbZnfwCobA/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>设置列标签的颜色</span><span></span></h4><ul data-tool="mdnice编辑器"><li><section>将列标签的col设置为和umap一样的配色，并且与亚群的数量统一起来</section></li><li><section>使用HeatmapAnnotation整理需要添加的列标签信息</section></li><li><section>在Heatmap中使用top_annotation添加上美化后的列标签信息</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span>#设置列标签颜色，并整理top_anno标签注释信息</span><br>col &lt;- mycolors<br>names(col) &lt;- levels(celltype_info)<br><br>top_anno &lt;- HeatmapAnnotation(<br>  cluster = anno_block(gp = gpar(fill = col), <span># 设置填充色</span><br>                       labels = levels(celltype_info),<br>                       labels_gp = gpar(cex = 0.5, col = <span>"white"</span>))) <span># 设置字体</span><br><br><br><span>#进行可视化</span><br>Heatmap(mat,name = <span>"Expression"</span>,<br>        row_order = 1:nrow(mat),<br>        col = colorRamp2(c(0,2,4), c(<span>"#6395C7"</span>, <span>"white"</span>, <span>"firebrick3"</span>)),<br>        cluster_rows = FALSE,<br>        cluster_columns = FALSE,<br>        show_column_names = F,<br>        border = T,<br>        row_names_gp = gpar(fontface = <span>'italic'</span>,fontsize = 8),<br>        column_split = celltype_info,<br>        top_annotation = top_anno, <span># 在热图上边增加注释</span><br>        column_title = NULL <span># 不需要列标题</span><br>) <br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041299" data-ratio="0.5814319433516916" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQDD3BVNQgSSjXUyoLkU05eSFc8ow9lJMN7bSmnjibZRZhpoBUnJCueHK7XsmPEazB4T81CY5kIribg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2542" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQDD3BVNQgSSjXUyoLkU05eSFc8ow9lJMN7bSmnjibZRZhpoBUnJCueHK7XsmPEazB4T81CY5kIribg/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>只展示特定基因</span><span></span></h4><ul data-tool="mdnice编辑器"><li><section>整理需要展示的基因集，which和%in%联用返回目标向量位置</section></li><li><section>使用rowAnnotation整理注释信息</section></li><li><section>使用right_annotation = row_anno将注释信息添加到需要的位置</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>gene &lt;- c(<span>"S100A9"</span>, <span>"CCR7"</span>,<span>"S100A8"</span>,<span>"MS4A1"</span>,<br>             <span>"CD79A"</span>, <span>"FCGR3A"</span>,<span>"CD8A"</span>,<span>"GZMB"</span>)<br><br>gene_pos &lt;- <span>which</span>(rownames(mat)%<span>in</span>%gene)<br><br>row_anno &lt;- rowAnnotation(gene=anno_mark(at = gene_pos,labels = gene))<br><br>Heatmap(mat,name = <span>"Expression"</span>,<br>        row_order = 1:nrow(mat),<br>        col = colorRamp2(c(0,2,4), c(<span>"#6395C7"</span>, <span>"white"</span>, <span>"firebrick3"</span>)),<br>        cluster_rows = FALSE,<br>        cluster_columns = FALSE,<br>        show_column_names = F,<br>        show_row_names = F,<br>        border = T,<br>        row_names_gp = gpar(fontface = <span>'italic'</span>,fontsize = 8),<br>        column_split = celltype_info,<br>        top_annotation = top_anno, <span># 在热图上边增加注释</span><br>        right_annotation = row_anno,<br>        column_title = NULL <span># 不需要列标题</span><br>) <br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041306" data-ratio="0.5492227979274611" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQDD3BVNQgSSjXUyoLkU05eicPVgs6u4eCZzB5Z9W2QtcmJBTibzRq2j8NwY5Z5vDHXFCoic0sEwJOAg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="965" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQDD3BVNQgSSjXUyoLkU05eicPVgs6u4eCZzB5Z9W2QtcmJBTibzRq2j8NwY5Z5vDHXFCoic0sEwJOAg/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>小结</span><span></span></h3><p data-tool="mdnice编辑器"><strong>使用Complexheatmap包进行热图绘制，除了可以简单添加列标签或者展示特定的基因外，还可以添加很多的注释信息</strong></p><p data-tool="mdnice编辑器">在推文<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527073&amp;idx=6&amp;sn=e9566b0337b2e1ef8a2f6e63447b31e4&amp;scene=21#wechat_redirect" data-linktype="2">scRNA｜ComplexHeatmap自定义单细胞转录组celltype-level 热图可视化</a>中整理了：</p><ol data-tool="mdnice编辑器"><li><section>添加celltype_mean中的细胞个数</section></li><li><section>meta信息中其他信息：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>计算每种celltype的 AUCell 均值</section></li><li><section>计算每种celltype 有多少样本注释到</section></li><li><section>计算不同celltype的sample/group 占比</section></li></ul><p data-tool="mdnice编辑器">除了Complexheatmap包可视化外，之前还简单测试了<a href="https://mp.weixin.qq.com/s?__biz=MzkxOTI0Mjc3Mw==&amp;mid=2247488593&amp;idx=1&amp;sn=2e0c65eecf2edb81c49507756d47f6fb&amp;scene=21#wechat_redirect" data-linktype="2">Scillus包美化热图</a>。</p><p data-tool="mdnice编辑器"><strong>如果你也想做单细胞转录组数据分析，最好是有自己的计算机资源哦，比如我们的<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528363&amp;idx=1&amp;sn=5e02f3e9b2e148191e23ebc2c0d780e7&amp;scene=21#wechat_redirect" data-linktype="2">2024的共享服务器交个朋友福利价仍然是800</a>，而且还需要有基本的生物信息学基础，也可以看看我们的<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247531929&amp;idx=1&amp;sn=f6f16b7bf6b907360d6d0052e3d10cf6&amp;scene=21#wechat_redirect" data-linktype="2">生物信息学马拉松授课</a>，你的生物信息学入门课。</strong></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/VMM9wF4zj39de1i6OqVeKA",target="_blank" rel="noopener noreferrer">原文链接</a>
