---
title: "使用MuSiC以及MuSiC2来根据单细胞转录组结果推断bulk转录组细胞比例"
date: 2022-12-31T01:28:39Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
使用MuSiC以及MuSiC2来根据单细胞转录组结果推断bulk转录组细胞比例 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>肿瘤微环境（TME）大家都比较熟悉了，肿瘤周围的组织、免疫细胞、血管、细胞外基质等元素共同形成了“肿瘤微环境”。我们讲了很多工具可以推断bulk转录组的微环境组成，目录是：</p></blockquote><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506740&amp;idx=3&amp;sn=46e12b5bc3413e52f544c6846481dfb3&amp;scene=21#wechat_redirect" data-linktype="2">estimate的两个打分值本质上就是两个基因集的ssGSEA分析</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506712&amp;idx=1&amp;sn=2700187268c3af5448eb4c236aa6c684&amp;scene=21#wechat_redirect" data-linktype="2">针对TCGA数据库全部的癌症的表达量矩阵批量运行estimate</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506712&amp;idx=2&amp;sn=33cbb66d8c21a484a9c5e61924078e4d&amp;scene=21#wechat_redirect" data-linktype="2">不同癌症内部按照estimate的两个打分值高低分组看蛋白编码基因表达量差异</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506811&amp;idx=1&amp;sn=e28d4c762094f7f3e00b729d7fd33c69&amp;scene=21#wechat_redirect" data-linktype="2">使用CIBERSORT算法推断全部tcga样品的免疫细胞比例</a></section></li></ul><p data-tool="mdnice编辑器">这些工具都是依据肿瘤病人的转录组测序表达量矩阵进行的分析，也有几百篇类似的数据挖掘文章了，它们总是喜欢落脚到estimate或者CIBERSORT结果的预后意义。</p><p data-tool="mdnice编辑器">虽然这些工具肿瘤微环境（TME）的思路是ok的，绝大部分的肿瘤相关的单细胞转录组研究我介绍过 <a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247488940&amp;idx=1&amp;sn=1cc8a8a74715087939b9721c0881775d&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现08—肿瘤单细胞数据第一次分群通用规则</a>，这个第一次分群规则是 ：</p><ul data-tool="mdnice编辑器"><li><section>immune (CD45+,PTPRC),</section></li><li><section>epithelial/cancer (EpCAM+,EPCAM),</section></li><li><section>stromal (CD10+,MME,fibo or CD31+,PECAM1,endo)</section></li></ul><p data-tool="mdnice编辑器">这3大单细胞亚群构成了肿瘤免疫微环境的复杂。绝大部分文章都是抓住免疫细胞亚群进行细分，包括淋巴系（T,B,NK细胞）和髓系（单核，树突，巨噬，粒细胞）的两大类作为第二次细分亚群。但是也有不少文章是抓住stromal 里面的fibo 和endo进行细分，并且编造生物学故事的。</p><p data-tool="mdnice编辑器">而TCGA等公共数据库数据库的转录组测序数据毕竟是bulk转录组测序，病人的肿瘤样品里面虽然是混合了各种各样的肿瘤微环境里面的基质细胞和免疫细胞，但是在数据层面被混杂成为了一个样品，并不是单细胞测序，所以并没有细胞比例信息。这个时候如果想推断细胞比例就需要借助于算法啦，有一个2019的综述文章：《Comprehensive evaluation of transcriptome-based cell-type quantification methods for immuno-oncology》比较了常见的免疫细胞比例推断工具的表现。</p><p data-tool="mdnice编辑器">但是这些工具都是在单细胞还没有流行开来的时候开发工具，虽然说它们确实是可以跑通流程，也可以进行细胞亚群比例推断。而现在各个疾病研究领域的单细胞转录组公开数据多如牛毛，我们自己对单细胞转录组数据的降维聚类分群和命名后的信息，如果可以用来推断bulk转录组细胞比例会更加精准。下面我们就介绍一下使用MuSiC以及MuSiC2来根据单细胞转录组结果推断bulk转录组细胞比例。</p><h3 data-tool="mdnice编辑器"><span></span>首先是安装MuSiC以及MuSiC2<span></span></h3><p data-tool="mdnice编辑器">比较麻烦的是MuSiC以及MuSiC2目前都是在github的包，所以安装起来有点麻烦，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span># BiocManager::install('TOAST')</span><br><span># devtools::install_github( repo = "crhisto/xbioc")</span><br><br><span># install devtools if necessary</span><br><span>if</span> (!<span>"devtools"</span> %<span>in</span>% rownames(installed.packages())) {<br>  install.packages(<span>'devtools'</span>)<br>}<br><span># install MuSiC package</span><br><span>if</span> (!<span>"MuSiC"</span> %<span>in</span>% rownames(installed.packages())) {<br>  devtools::install_github(<span>'xuranw/MuSiC'</span>)<br>}<br><span># install the MuSiC2 package</span><br><span>if</span> (!<span>"MuSiC2"</span> %<span>in</span>% rownames(installed.packages())) {<br>  devtools::install_github(<span>'Jiaxin-Fan/MuSiC2'</span>)<br>}<br></code></pre><p data-tool="mdnice编辑器">MuSiC以及MuSiC2目前都是在github的包，大家完全是可以下载其github的源代码压缩包，里面也有示例数据。分别有 bulk-eset.rds 和 EMTABesethealthy.rds</p><h3 data-tool="mdnice编辑器"><span></span>认识示例数据（bulk转录组矩阵和单细胞矩阵）<span></span></h3><p data-tool="mdnice编辑器">示例数据文件是 bulk-eset.rds 和 EMTABesethealthy.rds ，可以在MuSiC以及MuSiC2的github源代码找到。然后分别加载后熟悉一下：</p><pre data-tool="mdnice编辑器"><span></span><code><span>## Bulk RNA-seq data</span><br><span>#benchmark.eset = readRDS("https://xuranw.github.io/MuSiC/data/bulk-eset.rds")</span><br>benchmark.eset = readRDS(<span>"bulk-eset.rds"</span>)<br>benchmark.eset <br>table(benchmark.eset$group)<br>bulk.control.mtx = exprs(benchmark.eset)[, benchmark.eset$group == <span>'healthy'</span>]<br>bulk.case.mtx = exprs(benchmark.eset)[, benchmark.eset$group == <span>'t2d'</span>]<br>bulk.case.mtx[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br></code></pre><p data-tool="mdnice编辑器">可以看到的是bulk转录组矩阵存储成为了 ExpressionSet 对象，需要自己去熟悉它。如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; benchmark.eset <br>ExpressionSet (storageMode: lockedEnvironment)<br>assayData: 10000 features, 200 samples <br>  element names: exprs <br>protocolData: none<br>phenoData<br>  sampleNames: 1 10 ... 200 (200 total)<br>  varLabels: sampleID group<br>  varMetadata: labelDescription<br>featureData: none<br>experimentData: use <span>'experimentData(object)'</span><br>Annotation:  <br><br>&gt; table(benchmark.eset<span>$group</span>)<br><br>healthy     t2d <br>    100     100  <br>    <br>&gt; bulk.case.mtx[1:4,1:4]<br>            101    102    103    104<br>SFT2D1    16791   8362  17888  12894<br>TRAPPC13   8583   7823   6674   6626<br>C9orf89    6745   4659   8482   4790<br>RPS6     218932 142579 190503 160069<br></code></pre><p data-tool="mdnice编辑器">这样的转录组测序矩阵大家很容易自己拿到，看起来就是普普通通的counts矩阵，虽然bulk转录组矩阵存储成为了 ExpressionSet 对象，但是后续在使用MuSiC以及MuSiC2需要的都是从 ExpressionSet 对象里面拿到的普普通通的counts矩阵即可哦。</p><p data-tool="mdnice编辑器">然后熟悉一下单细胞表达量矩阵：</p><pre data-tool="mdnice编辑器"><span></span><code><span>## scRNA-seq data</span><br><span>#seger.sce = readRDS("https://xuranw.github.io/MuSiC/data/EMATBsce_healthy.rds")</span><br>seger.sce = readRDS(<span>"EMTABesethealthy.rds"</span>)<br>seger.sce<br><span># sc.sce  SingleCellExperiment for single cell data</span><br>tail(sort(table(seger.sce$cellType)))<br><span># 需要熟练掌握它们的对象，：一些单细胞转录组R包的对象 </span><br><span># https://mp.weixin.qq.com/s/lpoHhZqi-_ASUaIfpnX96w</span><br>seger.sce &lt;- SingleCellExperiment(<br>  assays = list(counts = exprs(seger.sce) ), <br>  colData =   seger.sce@phenoData@data<br>)<br>colData(seger.sce)<br><br></code></pre><p data-tool="mdnice编辑器">值得玩味的是作者给出来的示例数据里面的单细胞表达量矩阵居然也是一个 ExpressionSet 对象，其实对它的MuSiC以及MuSiC2来说是不合法的，我给它修改成为了SingleCellExperiment对象， 就合情合理啦。</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; seger.sce<br>ExpressionSet (storageMode: lockedEnvironment)<br>assayData: 25453 features, 1097 samples <br>  element names: exprs <br>protocolData: none<br>phenoData<br>  sampleNames: AZ_A10 AZ_A11 ... HP1509101_P9 (1097 total)<br>  varLabels: sampleID SubjectName cellTypeID cellType<br>  varMetadata: labelDescription<br>featureData: none<br>experimentData: use <span>'experimentData(object)'</span><br>Annotation:  <br><br>&gt; tail(sort(table(seger.sce<span>$cellType</span>)))<br><br> delta  gamma acinar ductal   beta  alpha <br>    59     75    112    135    171    443 <br>    <br>&gt; seger.sce<br>class: SingleCellExperiment <br>dim: 25453 1097 <br>metadata(0):<br>assays(1): counts<br>rownames(25453): SGIP1 AZIN2 ... KIR2DL2 KIR2DS3<br>rowData names(0):<br>colnames(1097): AZ_A10 AZ_A11 ... HP1509101_P8 HP1509101_P9<br>colData names(4): sampleID SubjectName cellTypeID cellType<br>reducedDimNames(0):<br>mainExpName: NULL<br>altExpNames(0):<br></code></pre><p data-tool="mdnice编辑器">可以看到其实单细胞转录组数据分析，就是对各种各样的R对象的理解而已。</p><h3 data-tool="mdnice编辑器"><span></span>运行MuSiC并且理解结果<span></span></h3><p data-tool="mdnice编辑器">其实就是一个平平无奇的 music_prop 函数而已：</p><pre data-tool="mdnice编辑器"><span></span><code><span># MuSiC</span><br>bulk.mtx = exprs(benchmark.eset)<br>prop_music=music_prop(bulk.mtx = bulk.mtx, sc.sce = seger.sce, <br>                      clusters = <span>'cellType'</span>, samples = <span>'sampleID'</span>,<br>                      select.ct = c(<span>'acinar'</span>,<span>'alpha'</span>, <span>'beta'</span>, <span>'delta'</span>, <span>'ductal'</span>,<span>'gamma'</span>),<br>                      verbose = <span>F</span>)$Est.prop.weighted<br><br>prop_all = cbind(<span>'proportion'</span>=c(prop_music),<br>                 <span>'celltype'</span>=rep(colnames(prop_music), <br>                                each=nrow(prop_music)), <br>                 <span>'sampleID'</span>=rep(rownames(prop_music),times=ncol(prop_music)),<br>                 <span>'Method'</span>=<span>'MuSiC'</span>)<br>prop_all=as.data.frame(prop_all)<br>prop_all$proportion=as.numeric(as.character(prop_all$proportion))<br></code></pre><p data-tool="mdnice编辑器">就得到了需要分解的单细胞亚群（ delta  gamma acinar ductal   beta  alpha ）在每个样品的比例情况；</p><h3 data-tool="mdnice编辑器"><span></span>运行MuSiC2并且理解结果<span></span></h3><p data-tool="mdnice编辑器">也是一个平平无奇的函数 music2_prop_t_statistics ：</p><pre data-tool="mdnice编辑器"><span></span><code><br><span># music2 deconvolution</span><br>set.seed(<span>1234</span>)<br><span>library</span>(scater)<br>est = music2_prop_t_statistics(bulk.control.mtx = bulk.control.mtx, <br>                               bulk.case.mtx = bulk.case.mtx, <br>                               sc.sce = seger.sce, <br>                               clusters = <span>'cellType'</span>, <br>                               samples = <span>'sampleID'</span>, <br>                               select.ct = c(<span>'acinar'</span>,<span>'alpha'</span>,<span>'beta'</span>,<span>'delta'</span>,<span>'ductal'</span>,<span>'gamma'</span>), <br>                               n_resample=<span>20</span>, sample_prop=<span>0.5</span>,cutoff_c=<span>0.05</span>,cutoff_r=<span>0.01</span>)<br><br>est.prop = est$Est.prop<br><br><span># plot estimated cell type proportions</span><br>prop_all = cbind(<span>'proportion'</span>=c(est.prop), <span>'sampleID'</span>=rep(rownames(est.prop),times=ncol(est.prop)), <span>'celltype'</span>=rep(colnames(est.prop), each=nrow(est.prop)))<br>prop_all = as.data.frame(prop_all)<br>prop_all$proportion = as.numeric(as.character(prop_all$proportion))<br>prop_all$group = ifelse(prop_all$sampleID %<span>in</span>% seq(from=<span>1</span>, to=<span>100</span>, by=<span>1</span>), <span>'Healthy'</span>, <span>'T2D'</span>)<br><br></code></pre><p data-tool="mdnice编辑器">就得到了需要分解的单细胞亚群（ delta  gamma acinar ductal   beta  alpha ）在每个样品的比例情况，可以看到它的区别居然是把需要分解的bulk转录组矩阵根据其表型分开了一下。</p><p data-tool="mdnice编辑器">如果你对两个函数（music_prop和music2_prop_t_statistics）有疑惑，可以去细看官方文档：https://xuranw.github.io/MuSiC/articles/pages/MuSiC2.html</p><p data-tool="mdnice编辑器">用法还是蛮简单的，自己准备好单细胞转录组矩阵以及bulk转录组矩阵即可，运行的速度也是很快；</p><p data-tool="mdnice编辑器">有了需要分解的单细胞亚群（ delta  gamma acinar ductal   beta  alpha ）在每个样品的比例情况，就可以很轻松的可视化，或者分组比较细胞比例差异：</p><p><img data-galleryid="" data-ratio="0.44783010156971376" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxlh3FeVib7KJibBmcLzuibZMJBwXyI9NzUXxFaC2GdLdeDDBLok7m2yxAs7C3tbPkRrDw4QQlgfNcWw/640?wx_fmt=png" data-type="png" data-w="2166" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxlh3FeVib7KJibBmcLzuibZMJBwXyI9NzUXxFaC2GdLdeDDBLok7m2yxAs7C3tbPkRrDw4QQlgfNcWw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>细胞比例差异</figcaption></figure><p data-tool="mdnice编辑器">可以看到在糖尿病组里面的 acinar单细胞亚群应该是统计学显著的比例上升了。</p></section><h4 data-tool="mdnice编辑器"><span>文末友情宣传</span></h4><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519083&amp;idx=1&amp;sn=61f07b390469617ca2e9924f5b3929ab&amp;scene=21#wechat_redirect" data-linktype="2">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li></ul><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/RwZBIhjnBVry4BWZL8x1Zg",target="_blank" rel="noopener noreferrer">原文链接</a>
