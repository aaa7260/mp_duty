---
title: "跟着NC学pseudotime| monocle2 拟时序分析 + 树形图"
date: 2022-12-12T14:19:53Z
draft: ["false"]
tags: [
  "fetched",
  "生信补给站"
]
categories: ["Acdemic"]
---
跟着NC学pseudotime| monocle2 拟时序分析 + 树形图 by 生信补给站
------
<div><section data-tools="新媒体管家" data-label="powered by xmt.cn"><br></section><section data-mpa-powered-by="yiban.io"><p><br></p><p>拟时（pseudotime）分析，又称细胞轨迹（cell trajectory）分析，<span>根据不同细胞亚群基因表达量随时间的变化情况</span>通过拟时分析可以来推断发育过程细胞的分化轨迹或细胞亚型的演化过程。<span>并非一定要不同时间段做实验的结果，因为细胞本身存在拟时序变化，细胞是有变化的，可以做拟时序分析。</span><span></span></p><p><span><br></span></p><p>本期分享2020年的<em>Nature Communications</em>文章 Single-cell analysis reveals new evolutionary complexity in uveal melanoma中的拟时序分析结果图，常规可视化的基础上添加了树形图，更直观。</p><p><img data-ratio="1.3882783882783882" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjDCklQPiawPDsYv4DFb6PtuibErqtcmibmJKwOoZD75ed4Hay2AhBqics9RFrdD2kzwX9AJ1DjcA8VlNw/640?wx_fmt=png" data-type="png" data-w="273" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjDCklQPiawPDsYv4DFb6PtuibErqtcmibmJKwOoZD75ed4Hay2AhBqics9RFrdD2kzwX9AJ1DjcA8VlNw/640?wx_fmt=png"></p><p><span></span></p><section><mp-common-profile data-weui-theme="light" data-id="MzIyNDI1MzgzOQ==" data-pluginname="mpprofile" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjCh1HyEjoPcBiaKy86NdKGZtju9o0oDBPicVK0lcoovRfticNuwPSj0Kib8cxqaVfBcTVCDAJ5icptybsg/0?wx_fmt=png" data-nickname="生信补给站" data-alias="Bioinfo_R_Python" data-signature="生信，R语言， Python，数据处理、统计检验、模型构建、数据可视化，我输出您输入！" data-from="1" data-is_biz_ban="0"></mp-common-profile></section><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><span></span></section><section mpa-from-tpl="t"><p>一 加载数据 R包<span></span></p></section></section></section></section></section><p><br></p><p><span>本次介绍monocle2进行拟时序分析</span><br></p><pre data-language="r">#BiocManager::install("monocle")<br>library(monocle)<br>#载入注释后的数据<br>load('pbmc_tutorial_singleR.RData')<br>pbmc<br><br>#An object of class Seurat <br>#13714 features across 2638 samples within 1 assay <br>#Active assay: RNA (13714 features, 2000 variable features)<br># 3 dimensional reductions calculated: pca, umap, tsne</pre><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><span></span></section><section mpa-from-tpl="t"><p>二 Monocle2分析<span></span></p></section></section></section></section></section><p><br></p><p><strong><span>2.1 通过seurat结果导入数据</span></strong><span></span><br></p><p><br></p><pre data-language="r">#Extract data, phenotype data, and feature data from the SeuratObject<br>data &lt;- as(as.matrix(pbmc@assays$RNA@counts), 'sparseMatrix')<br>pd &lt;- new('AnnotatedDataFrame', data = pbmc@meta.data)<br>fData &lt;- data.frame(gene_short_name = row.names(data), row.names = row.names(data))<br>fd &lt;- new('AnnotatedDataFrame', data = fData)<br><br>#构建S4对象，CellDataSet<br>HSMM &lt;- newCellDataSet(data,<br>                              phenoData = pd,<br>                              featureData = fd,<br>                              lowerDetectionLimit = 0.5,<br>                              expressionFamily = negbinomial.size())<br></pre><p><br></p><p><span>注意expressionFamily的选择：</span></p><p><span>单细胞稀疏矩阵的话用negbinomial.size()，如果是UMI的话<strong>不要标准化；</strong></span><br></p><p><span>FPKM值用tobit()；</span></p><p><span>logFPKM值用gau</span><span>ssianff()</span></p><p><br></p><h4><strong><span>2.2 </span><span>估计</span><span>size factors 和 dispersions （需要）</span></strong><span></span></h4><pre data-language="r">## <br>HSMM &lt;- estimateSizeFactors(HSMM)<br>HSMM &lt;- estimateDispersions(HSMM)</pre><p><br></p><h4><strong>2.3 过滤低质量细胞</strong></h4><pre data-language="r">HSMM &lt;- detectGenes(HSMM, min_expr = 3 )<br>print(head(fData(HSMM)))<br><br>expressed_genes &lt;- row.names(subset(fData(HSMM),<br>                                    num_cells_expressed &gt;= 10))<br><br>head(pData(HSMM))</pre><p><img data-ratio="0.27797513321492007" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBDgpHO9z18ia3pdFJYH1ibNHDAUpHfr0991Cd5CxzME7xsMxELpVYaqvJsUDFTLnK26kuicprUus2nw/640?wx_fmt=png" data-type="png" data-w="1126" width="563" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBDgpHO9z18ia3pdFJYH1ibNHDAUpHfr0991Cd5CxzME7xsMxELpVYaqvJsUDFTLnK26kuicprUus2nw/640?wx_fmt=png"></p><p><br></p><h4><strong>2.4 选择基因</strong></h4><pre data-language="r">diff_test_res &lt;- differentialGeneTest(HSMM[expressed_genes,],<br>                                      fullModelFormulaStr = "~ seurat_clusters")<br><br>ordering_genes &lt;- row.names (subset(diff_test_res, qval &lt; 0.1)) ## 不要也写0.1 ，而是要写0.01。<br><br>HSMM &lt;- setOrderingFilter(HSMM, ordering_genes)<br>plot_ordering_genes(HSMM)</pre><p><img data-ratio="0.7372262773722628" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBDgpHO9z18ia3pdFJYH1ibNHk35DDOQ0GIzHgfmibwRpDmj60J8ibKekJA1nm8YpxKibXqw0oxHiadzeXQ/640?wx_fmt=png" data-type="png" data-w="1096" width="548" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBDgpHO9z18ia3pdFJYH1ibNHk35DDOQ0GIzHgfmibwRpDmj60J8ibKekJA1nm8YpxKibXqw0oxHiadzeXQ/640?wx_fmt=png"></p><p>这里选择基因的方式有很多，说明文档中建议以下4种选择基因的方式</p><p><span>（1）选择发育差异表达基因</span></p><p><span>（2）选择clusters差异表达基因</span></p><p><span>（3）选择离散程度高的基因</span></p><p><span>（4）自定义发育marker基因</span></p><p><br></p><h4><strong>2.5 降维 &amp; 排序</strong></h4><pre data-language="r">HSMM &lt;- reduceDimension(HSMM, max_components = 3,<br>                        num_dim = 20,<br><p>method = 'DDRTree') # DDRTree方式</p><p><br></p>HSMM &lt;- orderCells(HSMM)</pre><p><br></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><span></span></section><section mpa-from-tpl="t"><p><span>三 Monocle2可视化</span><span></span></p></section></section></section></section></section><p><br></p><p><strong><span>3.1 基于各种“类型”可视化</span></strong><span></span><br></p><p><span>有了树结构后，分类颜色是可以自己指定的。</span>而且可以直接使用ggplot2的color设置，是不是觉得多了解一下ggplot2很有必要 </p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650394699&amp;idx=2&amp;sn=1f4c924798b4a74e336ff9b62270f367&amp;chksm=f01cb2abc76b3bbd063c0760326851cd71ef4d1957d847d5b18c9a4a18a23dd6cd47bcc93f2d&amp;scene=21#wechat_redirect" textvalue="ggplot2|详解八大基本绘图要素" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">详见：ggplot2|详解八大基本绘图要素</a></p><p><br></p><pre data-language="r">colour=c("#DC143C","#0000FF","#20B2AA","#FFA500","#9370DB","#98FB98","#F08080","#1E90FF","#7CFC00","#FFFF00",  <br>            "#808000","#FF00FF","#FA8072","#7B68EE","#9400D3","#800080","#A0522D","#D2B48C","#D2691E","#87CEEB","#40E0D0","#5F9EA0",<br>            "#FF1493","#0000CD","#008B8B","#FFE4B5","#8A2BE2","#228B22","#E9967A","#4682B4","#32CD32","#F0E68C","#FFFFE0","#EE82EE",<br>            "#FF6347","#6A5ACD","#9932CC","#8B008B","#8B4513","#DEB887")<br><br>a1 &lt;- plot_cell_trajectory(HSMM, color_by = "seurat_clusters") + scale_color_manual(values = colour)<br><br>a2 &lt;- plot_cell_trajectory(HSMM, color_by = "State") + scale_color_manual(values = colour)<br><br>a3 &lt;- plot_cell_trajectory(HSMM, color_by = "Pseudotime") <br><br>a4 &lt;- plot_cell_trajectory(HSMM, color_by = "labels")  + scale_color_manual(values = colour)<br><br>(a1 + a2) / (a3 + a4)</pre><p><img data-ratio="0.7394881170018281" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBDgpHO9z18ia3pdFJYH1ibNHwJJok2oViaf5soxwYcLrt60Ln7HTicDao10RNJibicOEGeAkUIzB6NQbTw/640?wx_fmt=png" data-type="png" data-w="1094" width="547" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBDgpHO9z18ia3pdFJYH1ibNHwJJok2oViaf5soxwYcLrt60Ln7HTicDao10RNJibicOEGeAkUIzB6NQbTw/640?wx_fmt=png"></p><p><br></p><p>分别为根据 seurat cluster ，State ，Pseudotime 和 singleR注释后的cell type 着色。<br></p><p><br></p><h4><strong>3.2 分面展示</strong></h4><p>可以使用分面单独查看各单一celltype的时序状态<strong><br></strong></p><pre data-language="r">#其他的类似<br>plot_cell_trajectory(HSMM, color_by = "labels") +<br>  facet_wrap(~labels, nrow = 2) #设置几行几列展示</pre><p><img data-ratio="0.739010989010989" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBDgpHO9z18ia3pdFJYH1ibNHYQzvSs7aEPLmtfOg214LaNiaTibRHIBz3bMfK60J1qdLUwJY7LzEvHzA/640?wx_fmt=png" data-type="png" data-w="1092" width="546" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBDgpHO9z18ia3pdFJYH1ibNHYQzvSs7aEPLmtfOg214LaNiaTibRHIBz3bMfK60J1qdLUwJY7LzEvHzA/640?wx_fmt=png"> </p><p><br></p><h4><strong>3.3 添加“树形图”</strong></h4><p>基本展示完了，那如何得到文章中的结果呢？</p><p>此处需要<code>plot_complex_cell_trajectory</code>函数添加“树形图”即可</p><pre data-language="r">p1 &lt;- plot_cell_trajectory(HSMM, x = 1, y = 2, color_by = "labels") + <br>  theme(legend.position='none',panel.border = element_blank()) + #去掉第一个的legend<br>  scale_color_manual(values = colour) <br>p2 &lt;- plot_complex_cell_trajectory(HSMM, x = 1, y = 2,<br>                                   color_by = "labels")+<br>  scale_color_manual(values = colour) +<br>  theme(legend.title = element_blank()) <br><br>p1 / p2</pre><p><img data-ratio="0.7001675041876047" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBDgpHO9z18ia3pdFJYH1ibNHerYibWdR7yH42vszhKDQwS5rTiaIhdgwf1BiaiatibazCJuJLyKCF2FvaNw/640?wx_fmt=png" data-type="png" data-w="1194" width="597" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBDgpHO9z18ia3pdFJYH1ibNHerYibWdR7yH42vszhKDQwS5rTiaIhdgwf1BiaiatibazCJuJLyKCF2FvaNw/640?wx_fmt=png"></p><p><br></p><p>其中：p1中没有展示legend， p2去掉legend的legend.title 。ggplot2的函数可以无缝链接，不想看一下吗？</p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650394998&amp;idx=1&amp;sn=3a37ee30062e880b70564633b51a87c8&amp;chksm=f01cb396c76b3a80a9a7afd05a990fb7e9f63026f877a863b32a483d037cbff3850e929085d5&amp;scene=21#wechat_redirect" textvalue="ggplot2|theme主题设置，详解绘图优化-“精雕细琢”" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">ggplot2|theme主题设置，详解绘图优化-“精雕细琢”</a><br></p><p><br></p><p><img data-ratio="0.7001675041876047" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBDgpHO9z18ia3pdFJYH1ibNHerYibWdR7yH42vszhKDQwS5rTiaIhdgwf1BiaiatibazCJuJLyKCF2FvaNw/640?wx_fmt=png" data-type="png" data-w="1194" width="597" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBDgpHO9z18ia3pdFJYH1ibNHerYibWdR7yH42vszhKDQwS5rTiaIhdgwf1BiaiatibazCJuJLyKCF2FvaNw/640?wx_fmt=png"></p><p><br></p><p><span><strong>参考资料：</strong></span><br></p><p>http://cole-trapnell-lab.github.io/monocle-release/docs/</p><p><br></p><section data-style-type="7" data-tools="新媒体排版" data-id="9190"><p><span data-txtless="spin" data-txtlessp="120">◆ </span><span></span><span>◆ </span><span></span><span data-txtless="spin" data-txtlessp="-120">◆  <span data-txtless="spin" data-txtlessp="120">◆ </span><span>◆</span></span><span></span></p></section><p cid="n94" mdtype="paragraph"><span md-inline="plain"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650398215&amp;idx=1&amp;sn=730225fb5ba3a51ceb8df0a531632515&amp;chksm=f01cbce7c76b35f1bebbf327d78a51d859770a46ae1329d362e3b705c4f8765ee2dc461d24dc&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" wah-hotarea="click">更多精心内容详见：精心整理（含图PLUS版）|R语言生信分析，可视化</a>（R统计，ggplot2绘图，生信图形可视化汇总）</span></p><p><br></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/RAmt509dNNCeknrUPqYkeQ",target="_blank" rel="noopener noreferrer">原文链接</a>
