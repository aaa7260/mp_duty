---
title: "单细胞基地 | 单细胞多样本数据整合 | 两万字大干货"
date: 2024-07-18T10:21:59Z
draft: ["false"]
tags: [
  "fetched",
  "生信小白要知道"
]
categories: ["Acdemic"]
---
单细胞基地 | 单细胞多样本数据整合 | 两万字大干货 by 生信小白要知道
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>时隔三个月，我带着新的单细胞笔记又来了。这是单细胞基础分析流程的最后一个板块，把这一部分搞懂之后，你就可以独立地完成一套标准的单细胞基础分析了，感兴趣的同学可以学起来呀！（当然，我们的笔记顺序并不是按照正常流程顺序来写的，所以我们后续也会专门做一篇整理性质的推送，为大家理清学习顺序的，这个大家不用担心！）</p></blockquote><p data-tool="mdnice编辑器">话不多说（那个那个，我，啊，这里的我是指小蛮要，咱们这篇文章是我们超级棒棒的小杨写的，酷毙了！那我就按照惯例多说几句好不啦哈哈哈哈哈，谢谢大家！），我们直接进入正题！</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004034" data-ratio="1.0185185185185186" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEsFISUX1kBfCIEibaJLSDdJpm5MOrVhRlfhAALadzZsiaPb0jG0Ub4m3A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEsFISUX1kBfCIEibaJLSDdJpm5MOrVhRlfhAALadzZsiaPb0jG0Ub4m3A/640?wx_fmt=png&amp;from=appmsg"></figure><ul><li><section><section><span>如果小伙伴们有需求的话，可以加入我们的交流群：</span><a href="https://mp.weixin.qq.com/s?__biz=Mzg5NjE1NTc1OA==&amp;mid=2247487413&amp;idx=1&amp;sn=747e60197c594360abe79830480c5413&amp;scene=21#wechat_redirect" data-linktype="2"><span>一定要知道 | 永久免费的环境友好型生信学习交流群又双叒叕来啦！| 伴随不定期群友好物分享</span></a><span>！在这里，你可以稍有克制地畅所欲言！</span></section></section></li><li><section><section><span>超级建议大家在入群前或入群后可以看一下这个：</span><a href="https://mp.weixin.qq.com/s?__biz=Mzg5NjE1NTc1OA==&amp;mid=2247486350&amp;idx=1&amp;sn=066dedbe912676f5c508b179167084a0&amp;scene=21#wechat_redirect" data-linktype="2"><span>干货满满 | 给生信小白的入门小建议 | 掏心掏肺版</span></a><span>！绝对干货满满！让你不虚此看！</span></section></section></li><li><section><section><span>如果有需要个性化定制分析服务的小伙伴，可以看看这里：</span><a href="https://mp.weixin.qq.com/s?__biz=Mzg5NjE1NTc1OA==&amp;mid=2247486984&amp;idx=1&amp;sn=b00b48d15e2e19e206803d3e14f05d23&amp;scene=21#wechat_redirect" data-linktype="2"><span>你要的个性化生信分析服务今天正式开启啦！定制你的专属解决方案！全程1v1答疑！</span></a><span>！绝对包你满意！</span></section></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span>为什么要做多样本整合？</span><span></span></h2><p data-tool="mdnice编辑器">上一篇笔记我们讲了单细胞测序下机数据的比对质控流程，获取了相应的结果并对其中的核心内容进行了解读，详见<a href="https://mp.weixin.qq.com/s?__biz=Mzg5NjE1NTc1OA==&amp;mid=2247487330&amp;idx=1&amp;sn=5e57d45f717b68ae808ced699a7fdabc&amp;scene=21#wechat_redirect" data-linktype="2">单细胞基地 | Cell Ranger 助你轻松搞定上游分析 | 10X Genomics 平台下机数据比对质控流程</a>。我们在文中提到了过滤矩阵文件夹<code>filtered_feature_bc_matrix</code>里面的信息已经满足后续分析的要求，可以直接进入seurat流程开展分析。但是呢，实际应用远没有理论情况那么理想，我们的过滤矩阵终究只是一个来自于单个样本的矩阵，无论是平行样本增加单细胞数据的生物学重复（理论上可以不用增加生物学重复，因为增加生物学重复说实在的就是在增加细胞数，但是现在的单细胞文章连细胞数都不卷的话，文章的竞争力也会大打折扣，可能发出来别人都不想相信），还是对照样本进行不同处理组间的比较分析，都涉及到多样本的情况，在标准工作流程下识别多个数据集中存在的细胞群可能会出现问题，因此多样本间的整合就很有必要。那么，<code>“这种多个样本数据集的分析应该如何实现呢？”</code>，这就是我们今天推送的主题--<strong><code>单细胞多样本数据整合</code><strong>。我将分成以下步骤进行阐述：</strong>准备工作</strong>、<strong>整合前样本的预处理</strong>、<strong>Seurat.v4多样本数据整合</strong>、<strong>Seurat.v5多样本数据整合</strong>。</p><h2 data-tool="mdnice编辑器"><span></span><span>0 准备工作</span><span></span></h2><p data-tool="mdnice编辑器">为了满足本篇笔记分析的需求，我从10X官网上下载了一组小鼠脑的单细胞测序下机数据，并按照上一篇笔记的教程<a href="https://mp.weixin.qq.com/s?__biz=Mzg5NjE1NTc1OA==&amp;mid=2247487330&amp;idx=1&amp;sn=5e57d45f717b68ae808ced699a7fdabc&amp;scene=21#wechat_redirect" data-linktype="2">单细胞基地 | Cell Ranger 助你轻松搞定上游分析 | 10X Genomics 平台下机数据比对质控流程</a>使用<strong>cellranger v8.0.0</strong>和小鼠的<strong>GRCm39</strong>版本的参考基因集对其进行了比对定量工作。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 下载数据并解压</span><br><span># 下载数据</span><br>$ cat download.sh <br><span># mouse_neuron_10k_1</span><br>wget https://s3-us-west-2.amazonaws.com/10x.files/samples/cell-exp/4.0.0/SC3_v3_NextGem_SI_Neuron_10K/SC3_v3_NextGem_SI_Neuron_10K_fastqs.tar<br><span># mouse_neuron_10k_2</span><br>wget https://s3-us-west-2.amazonaws.com/10x.files/samples/cell-exp/4.0.0/SC3_v3_NextGem_DI_Neuron_10K/SC3_v3_NextGem_DI_Neuron_10K_fastqs.tar<br><span># mouse_neuron_10k_3</span><br>wget https://s3-us-west-2.amazonaws.com/10x.files/samples/cell-exp/3.0.0/neuron_10k_v3/neuron_10k_v3_fastqs.tar<br><span># mouse_neuron_5k_1</span><br>wget https://s3-us-west-2.amazonaws.com/10x.files/samples/cell-exp/3.0.2/5k_neuron_v3/5k_neuron_v3_fastqs.tar<br><span># mouse_neuron_5k_2</span><br>wget https://s3-us-west-2.amazonaws.com/10x.files/samples/cell-exp/3.0.2/5k_neuron_v3_nextgem/5k_neuron_v3_nextgem_fastqs.tar<br><br><span># 解压</span><br><span>for</span> line <span>in</span> $(ls ./*.tar)<br><span>do</span><br>tar -xvf <span>${line}</span><br><span>done</span><br></code></pre><p data-tool="mdnice编辑器">批量比对定量：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 先创建一个与样品编号对应的分组编号表格</span><br>$ cat sample_list.txt<br>SC3_v3_NextGem_SI_Neuron_10K    mouse_neuron_1<br>SC3_v3_NextGem_DI_Neuron_10K    mouse_neuron_2<br>neuron_10k_v3   mouse_neuron_3<br>5k_neuron_v3    mouse_neuron_4<br>5k_neuron_v3_nextgem    mouse_neuron_5<br><br><span># 编写批量比对定量脚本</span><br>$ cat run_qc.sh<br>reference=/workdir/BIO/yangqi/02.project/01.note/01.quality_control/01.genome/refdata-gex-GRCm39-2024-A<br>fq_path=/workdir/BIO/yangqi/02.project/01.note/01.quality_control/02.rawdata<br><br>cat sample_list.txt | <span>while</span> <span>read</span> col1 col2<br><span>do</span> <br>        cellranger count --id=<span>$col2</span> \         <span># 输出文件的名字，即分析时的分组编号</span><br>        --transcriptome=<span>${reference}</span> \<br>        --fastqs=<span>${fq_path}</span>/<span>${col1}</span>_fastqs/ \ <span># 需要质控的下机fastq文件路径</span><br>        --sample=<span>$col1</span> \                      <br>        <span># sample是输入文件的名字，即样品编号，通常是两种，一种是SRR开头的编号，一种是10X的文件名去掉最后的_fastqs</span><br>        --create-bam=<span>true</span> \<br>        --localcores=20 \<br>        --localmem=200<br><span>done</span><br></code></pre><p data-tool="mdnice编辑器"><span>结果简单展示：</span><br></p><p data-tool="mdnice编辑器"><img data-imgfileid="100004031" data-ratio="0.6227027027027027" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNE2POnqpnJt71T9MeW00oZvVh8sRhXt3D4rC22REAzR4WH3nKfQCckbQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="925" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNE2POnqpnJt71T9MeW00oZvVh8sRhXt3D4rC22REAzR4WH3nKfQCckbQ/640?wx_fmt=png&amp;from=appmsg">同时呢，考虑到有的同学自身电脑配置不支持比对定量所需的配置要求，我也把比对定量的结果文件（去除了.bam文件的）上传到了百度网盘，链接我设置了长期有效，大家可以根据需求下载，<strong>链接如下</strong>：链接：https://pan.baidu.com/s/1oblJ47shAMTH5bqMrX7CAg?pwd=bten提取码：bten</p><p data-tool="mdnice编辑器">我们提供的文件信息如下图所示：<img data-imgfileid="100004030" data-ratio="0.6114718614718615" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEpjoQUbft0aprr6ce6dm5DK5uGqsANzMtuINIQpfC7pkoHIhwQQMGvQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="924" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEpjoQUbft0aprr6ce6dm5DK5uGqsANzMtuINIQpfC7pkoHIhwQQMGvQ/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器"><strong>注</strong>：我们提供了除.bam文件和与矩阵等效的.h5文件之外的其他文件，感兴趣的同学可以结合我们以前的内容<a href="https://mp.weixin.qq.com/s?__biz=Mzg5NjE1NTc1OA==&amp;mid=2247487330&amp;idx=1&amp;sn=5e57d45f717b68ae808ced699a7fdabc&amp;scene=21#wechat_redirect" data-linktype="2">单细胞基地 | Cell Ranger 助你轻松搞定上游分析 | 10X Genomics 平台下机数据比对质控流程</a>来理解输出文件内容，相信你会收获更多。</p><p data-tool="mdnice编辑器">好，做完这个准备工作，就让我们进入正题。</p><h2 data-tool="mdnice编辑器"><span></span><span>1 整合前单样本的预处理</span><span></span></h2><p data-tool="mdnice编辑器">预处理流程主要完成两件事，分别是<strong>去除非细胞mRNA的污染(选做)</strong> 和 <strong>去除可能的双胞</strong>，这两个处理是针对单个样本进行的处理。其中呢，<strong>去除非细胞mRNA的污染(选做)</strong> 并不算是一个主流的预处理方法，并且也不会对最后结果产生很大的影响，相反，他会把矩阵中的整数counts变成小数counts，所以大家根据需要酌情使用。我这里只是见到这一个过程做一下简单介绍，感兴趣的同学可以去看看，没有需要的同学我们直接跳转 <strong>1.2 去双胞</strong> 过程。</p><h3 data-tool="mdnice编辑器"><span></span><span>1.1 SoupX去除非细胞mRNA的污染(选做)</span><span></span></h3><p data-tool="mdnice编辑器"><strong>参考</strong>：https://github.com/constantAmateur/SoupX</p><p data-tool="mdnice编辑器"><strong>作用</strong>：用于估计和去除基于液滴的单细胞RNA-seq数据（10X的Chromium系统的油包水结构就是这种基于液滴的单细胞）中的非细胞mRNA污染。这一步做不做对后续分析影响不大，并且主流教程中也并没有过多涉及，大家可根据情况选择。</p><p data-tool="mdnice编辑器"><strong>安装</strong>：我这边使用mamba进行安装，同时也需要安装一些配套使用的包 (其中seurat是V4的)，安装命令如下：</p><pre data-tool="mdnice编辑器"><span></span><code>mamba install conda-forge::r-soupx<br>mamba install r::r-seurat<br>mamba install conda-forge::r-seuratobject=4.1.4<br>mamba install bioconda::bioconductor-dropletutils<br></code></pre><p data-tool="mdnice编辑器"><strong>代码解析</strong>：官网给的代码（https://github.com/constantAmateur/SoupX#quickstart）在实际运行过程中，直接运行load10X并不顺利，所以我结合了github官网上这个Issues45（https://github.com/constantAmateur/SoupX/issues/45）下面的作者回复，对代码进行了修改和整理，大家直接看下面的内容即可：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 加载需要的R包</span><br>library(SoupX)<br>library(Seurat)<br>library(DropletUtils)<br><br><span># 加载原始矩阵和过滤矩阵。作者给的命名，tod是cellranger结果中的原始矩阵；toc是过滤矩阵</span><br>tod &lt;- Seurat::Read10X(<span>'/workdir/BIO/yangqi/02.project/01.note/01.quality_control/03.run_qc/mouse_neuron_1/outs/raw_feature_bc_matrix'</span>, gene.column = 2)<br>toc &lt;- Seurat::Read10X(<span>'/workdir/BIO/yangqi/02.project/01.note/01.quality_control/03.run_qc/mouse_neuron_1/outs/filtered_feature_bc_matrix'</span>, gene.column = 2)<br></code></pre><p data-tool="mdnice编辑器">注：<strong>这里的gene.column为什么要等于2呢？</strong>(下面这点解释不用操作) </p><p data-tool="mdnice编辑器">这是因为在cellranger的输出矩阵中features.tsv.gz里面包含了三列信息，第一列是gene ID，第二列是gene symbol，第三列是"Gene Expression"这样的字样，我们直接使用第二列的gene symbol信息，就不用后面再转换了，更方便。我随便打开一个矩阵的features.tsv，如下所示：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004032" data-ratio="0.337037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEKvZ6Cv0szHzBYWjoMAUNbSHTlYuyQaCv4pUASGDPvvkWphCq85efxw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEKvZ6Cv0szHzBYWjoMAUNbSHTlYuyQaCv4pUASGDPvvkWphCq85efxw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">好的，我们继续回到soupx上来，作者提到了需要使用setClusters这个函数添加一下聚类信息，这个咱们没有，需要简单做一下，固定参数即可，这些就不细讲啥意思了。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 创建对象、标准化、降维、聚类、分群</span><br>object &lt;- CreateSeuratObject(toc)<br>object &lt;- SCTransform(object)<br>object &lt;- RunPCA(object, features = VariableFeatures(object), npcs = 50, verbose = F)<br>object &lt;- FindNeighbors(object, dims = 1:20)<br>object &lt;- FindClusters(object, resolution = 0.5)<br><br><span># 开始运行SoupX相关步骤</span><br><span># 创建一个 SoupChannel 对象，该对象包含单个样本污染评估相关的所有内容（也就是原始矩阵和过滤矩阵）。</span><br>sc = SoupChannel(tod, toc)<br><span># 提供聚类分群信息</span><br>sc = setClusters(sc, object@meta.data<span>$seurat_clusters</span>)<br><span># autoEstCont实现污染自动估计</span><br>sc = autoEstCont(sc)<br><span># adjustCounts调整产生新的矩阵</span><br>out = adjustCounts(sc)<br><span># 按照10X的格式在当前路径下输出调整后的矩阵</span><br>DropletUtils:::write10xCounts(<span>"soupX_matrix"</span>, out, version=<span>"3"</span>)<br></code></pre><p data-tool="mdnice编辑器">我们可以看到，经过SoupX处理之后确实发生了一些变化，本来矩阵中的 <strong>整数counts</strong> 都变成了 <strong>小数形式</strong>，数值经过了略微的调整，但是变化很小，所以这一步做不做影响都不会很大。</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; str(sc)<br>List of 5<br> $ toc        :Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  .. ..@ i       : int [1:46803316] 0 8 11 14 18 23 25 26 35 41 ...<br>  .. ..@ p       : int [1:12442] 0 4717 10065 14643 15306 21127 21967 26714 30156 34737 ...<br>  .. ..@ Dim     : int [1:2] 33696 12441<br>  .. ..@ Dimnames:List of 2<br>  .. .. ..$ : chr [1:33696] <span>"Xkr4"</span> <span>"Gm1992"</span> <span>"Gm19938"</span> <span>"Gm37381"</span> ...<br>  .. .. ..$ : chr [1:12441] <span>"AAACCAAAGCCTGTCC-1"</span> <span>"AAACCAAAGCTATCGA-1"</span> <span>"AAACCATTCACCACTT-1"</span> <span>"AAACCATTCGATTAAC-1"</span> ...<br>  .. ..@ x       : num [1:46803316] 6 1 3 2 1 1 8 1 1 1 ...<br>  .. ..@ factors : list()<br><br>&gt; str(out)<br>Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  ..@ i       : int [1:46803316] 0 8 11 14 18 23 25 26 35 41 ...<br>  ..@ p       : int [1:12442] 0 4717 10065 14643 15306 21127 21967 26714 30156 34737 ...<br>  ..@ Dim     : int [1:2] 33696 12441<br>  ..@ Dimnames:List of 2<br>  .. ..$ : chr [1:33696] <span>"Xkr4"</span> <span>"Gm1992"</span> <span>"Gm19938"</span> <span>"Gm37381"</span> ...<br>  .. ..$ : chr [1:12441] <span>"AAACCAAAGCCTGTCC-1"</span> <span>"AAACCAAAGCTATCGA-1"</span> <span>"AAACCATTCACCACTT-1"</span> <span>"AAACCATTCGATTAAC-1"</span> ...<br>  ..@ x       : num [1:46803316] 5.981 0.984 2.973 1.989 0.986 ...<br>  ..@ factors : list()<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>1.2 Doubletfinder去除双胞</span><span></span></h3><p data-tool="mdnice编辑器"><strong>参考</strong>：https://github.com/chris-mcginnis-ucsf/DoubletFinder</p><p data-tool="mdnice编辑器"><strong>作用</strong>：用于预测并去除数据中双胞。</p><p data-tool="mdnice编辑器"><strong>安装</strong>：Doubletfinder的数据结构随着seurat的版本更新进行了更新，更新的分界线是2.0.4，在2.0.4以前的版本，都是适配于seurat v4的；而在2.0.4及以后的版本都是依赖于seurat v5版本实现的。不过大家不要担心，我们这里会为大家准备两个不同版本的代码，大家可以按需选择，不过<strong>更推荐大家使用新版</strong>，及时适应seurat v5的数据结构。</p><pre data-tool="mdnice编辑器"><span></span><code>DoubletFinder v2.0.3 及配套seurat V4安装<br>R命令行安装：DoubletFinder<br>remotes::install_github(<span>'https://github.com/ekernf01/DoubletFinder'</span>, force = T)<br>shell命令行安装下述软件<br>mamba install r::r-seurat<br>mamba install conda-forge::r-seuratobject=4.1.4<br>mamba install bioconda::bioconductor-dropletutils<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>DoubletFinder v2.0.4 及配套seurat V5安装<br>R命令行安装：DoubletFinder<br>remotes::install_github(<span>'chris-mcginnis-ucsf/DoubletFinder'</span>)<br>shell命令行安装下述软件<br>mamba install conda-forge::r-seurat<br>mamba install bioconda::bioconductor-dropletutils<br></code></pre><p data-tool="mdnice编辑器"><strong>代码解析</strong>：首先呢，我们先要输入数据，关于输入的数据，官网提了两点要求：</p><ol data-tool="mdnice编辑器"><li><section>Do not apply DoubletFinder to aggregated scRNA-seq data representing multiple distinct samples (e.g., multiple 10X lanes).也就是说，DoubletFinder是对<strong>单个样本</strong>处理的，不要对多样本数据进行操作。</section></li><li><section>Ensure that input data is cleared of low-quality cell clusters.确保输入数据中不含低质量细胞簇。也就是说，我们需要<strong>提前对数据进行过滤</strong>。</section></li></ol><p data-tool="mdnice编辑器">那么，我们就先按照这两个要求对数据简单进行一个过滤处理吧。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 加载需要的R包</span><br>library(Seurat)<br>library(cowplot)<br>library(DropletUtils)<br>library(DoubletFinder)<br><br><span># 读入单细胞矩阵数据，并按照官网要求进行过滤预处理；我们先读取 filtered_feature_bc_matrix</span><br>object &lt;- Read10X(<span>'your/path/to/filtered_feature_bc_matrix'</span>, gene.column = 2)<br><br><span># 创建seurat对象</span><br>object &lt;- CreateSeuratObject(counts = object.data, project = <span>"brain_1"</span>, min.cells = 3, min.features = 200)<br><br><span># 计算线粒体基因百分比，0值补成非0的极小数</span><br>object[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(object, pattern = <span>"ATP6|ATP8|COX1|COX2|COX3|CYTB|ND1|ND2|ND3|ND4|ND4L|ND5|ND6"</span>)<br><span>if</span> (sum(object@meta.data<span>$percent</span>.mt) == 0){<br>    object@meta.data<span>$percent</span>.mt[1] &lt;- 0.000001<br>}<br><span># 按照相对宽泛的指标过滤</span><br><span># 这里呢，我简单的画了三个变量的小提琴图，评估了一下过滤指标，暂定范围如下：</span><br><span># 200 &lt; nFeature_RNA(单个细胞总基因数) &lt; 6000; </span><br><span># nCount_RNA(单个细胞总表达量数) &lt; 20000; </span><br><span># percent.mt(单个细胞内线粒体基因比例) &lt; 5</span><br><span># 注：这个是脑的数据，基因数相对来说会多一些，常规组织的话要根据组织特性设置。</span><br>object &lt;- subset(object, subset = nFeature_RNA &gt; 200 &amp; nFeature_RNA &lt; 6000 &amp; nCount_RNA &lt; 20000 &amp; percent.mt &lt; 5)<br></code></pre><p data-tool="mdnice编辑器">接着呢，官网让我们进行一下seurat的预处理流程，提供了经典的<strong>NormalizeData标准化</strong>和<strong>SCT标准化</strong>两种方法，大家按需任选其一即可，区别不大。如果选择困难的话，我这边选的是<strong>SCT</strong>。如果你用的是三步标准化的话，记得后面每一步的sct参数的值设置成<strong>FALSE</strong>。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 进行seurat流程的预处理(三步标准化和SCT标准化都可以，选其一即可，区别不大)</span><br><span># 三步标准化流程</span><br>object &lt;- NormalizeData(object)<br>object &lt;- FindVariableFeatures(object, selection.method = <span>"vst"</span>, nfeatures = 2000)<br>object &lt;- ScaleData(object)<br>object &lt;- RunPCA(object)<br>object &lt;- RunUMAP(object, dims = 1:20)<br><br><span># SCT标准化流程</span><br>object &lt;- SCTransform(object)<br>object &lt;- RunPCA(object)<br>object &lt;- RunUMAP(object, dims = 1:20)<br><br><span># 为什么比官网多了聚类分群这两步呢，因为后面需要给一个注释信息，我们用分群结果代替</span><br>object &lt;- FindNeighbors(object, reduction = <span>"pca"</span>, dims = 1:20)<br>object &lt;- FindClusters(object, resolution = 0.5)<br></code></pre><p data-tool="mdnice编辑器">然后，就进入到DoubletFinder的特定步骤了，我们简单解析一下，就是他需要一个<strong>pK值</strong>，在这个pK值下能<strong>保证DoubletFinder的最佳预测准确性</strong>。这个值怎么选呢，官网提供了一个BCmvn的指标(Mean-variance normalized bimodality coefficient (BCmvn) achieves this goal, featuring a single, easily-discernible maximum at pK values that optimize AUC.)，叫什么均值方差归一化双峰系数，在这个<strong>BCmvn值最大的时候对应的pK值</strong>就是我们需要的。明白了这一点，我们就开始整理和修改代码吧。</p><pre data-tool="mdnice编辑器"><span></span><code><span># pK值确认(这里官网提供了有真实值参考和无真实值参考两种代码，我们这里使用无真实值参考的)</span><br>sweep.res.list_object &lt;- paramSweep_v3(object, PCs = 1:20, sct = TRUE)<br>sweep.stats_object &lt;- summarizeSweep(sweep.res.list_object, GT = FALSE)<br>bcmvn_object &lt;- find.pK(sweep.stats_object)<br>dev.off()<br></code></pre><p data-tool="mdnice编辑器">这里find.pK函数会出一张图，看的是不同pK值下的BCmvn值，我们这里简单展示一下。横坐标是pK值，纵坐标是BCmvn值。<img data-imgfileid="100004033" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEQrNKcw5c5ehdYKqwQvrKiceoFiagPLDWnXia321y7ypT0hLiaeupenUptw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEQrNKcw5c5ehdYKqwQvrKiceoFiagPLDWnXia321y7ypT0hLiaeupenUptw/640?wx_fmt=png&amp;from=appmsg">但是呢，我们是需要取这个合适的pK值，所以还是看对应的BCmvn值的dataframe来选择。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 查看一下这个bcmvn_object</span><br>&gt; head(bcmvn_object)<br><span>#   ParamID    pK    MeanBC       VarBC  BCmetric</span><br><span># 1       1 0.005 0.7574656 0.002022751 374.47304</span><br><span># 2       2  0.01 0.7309493 0.002013150 363.08745</span><br><span># 3       3  0.02 0.7107600 0.003004541 236.56195</span><br><span># 4       4  0.03 0.6654097 0.004069111 163.52705</span><br><span># 5       5  0.04 0.6253637 0.006920117  90.36895</span><br><span># 6       6  0.05 0.6108826 0.015017486  40.67809</span><br><br><span># 我们选择BCmvn对应列BCmetric的最大值对应的pK值，代码如下：</span><br>pK_value &lt;- as.numeric(as.character(bcmvn_object<span>$pK</span>[bcmvn_object<span>$BCmetric</span> == max(bcmvn_object<span>$BCmetric</span>)]))<br><span># 注：官网上说pN对DoubletFinder的影响不大，那么我们就用默认的0.25</span><br><br><span># 同型双胞比例评估</span><br><span># 这里的第一行就是将聚类分群信息当作注释信息，用于后续分析</span><br>annotations &lt;- object@meta.data<span>$SCT_snn_res</span>.0.5<br>homotypic.prop &lt;- modelHomotypic(annotations)<br>nExp_poi &lt;- round(0.075*nrow(object@meta.data)) <span># 按照官网的标准，设定为7.5%</span><br>nExp_poi.adj &lt;- round(nExp_poi*(1-homotypic.prop)) <span># 调整校准nExp_poi</span><br><br><span># 使用不同的分类严格性运行DoubletFinder</span><br><span># 构造reuse.pANN参数的值pANN_value</span><br>pANN_value &lt;- paste0(<span>"pANN_0.25_"</span>, pK_value, <span>'_'</span>, nExp_poi)<br><span># 分别用正常值nExp_poi和矫正值nExp_poi.adj进行双胞计算</span><br>object &lt;- doubletFinder_v3(object, PCs = 1:30, pN = 0.25, pK = pK_value, nExp = nExp_poi, reuse.pANN = FALSE, sct = TRUE)<br>object &lt;- doubletFinder_v3(object, PCs = 1:30, pN = 0.25, pK = pK_value, nExp = nExp_poi.adj, reuse.pANN = pANN_value, sct = TRUE)<br></code></pre><p data-tool="mdnice编辑器">到这里，官网上的基础教程就做完了。接下来我们补充一个知识点：我们可以看到在代码结束之后官网上还有这么一张图，那么这个图上的 <strong>"Doublet-Low Confidence"</strong> 和 <strong>"Doublet-High Confidence"</strong> 是什么意思呢？什么是高可信度，什么是低可信度呢？<img data-imgfileid="100004035" data-ratio="0.5659340659340659" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEFtkFYwwlJNRm124b6V5ibzE01GmJ8e2V6tJy9Lx6Y4u5iahwhiaiaibVK2g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="728" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEFtkFYwwlJNRm124b6V5ibzE01GmJ8e2V6tJy9Lx6Y4u5iahwhiaiaibVK2g/640?wx_fmt=png&amp;from=appmsg">我这样讲，咱们最后在上面运行了两次"doubletFinder_v3"函数，两组函数的差别主要是 <strong>"nExp"</strong> 和 <strong>"reuse.pANN"</strong> 两个参数的值，其中呢，用 <strong>"nExp_poi.adj"</strong> 值确定的双胞是高可信度的双胞，而使用 <strong>"nExp_poi"</strong> 值确定的双胞包含了高可信度和低可信度的双胞。这个不重要，不过大家学东西最好学透。</p><p data-tool="mdnice编辑器">那我们接着就尝试把这些都区分一下吧。前面说过了，这个不重要，所以大家当作一个理解和熟悉meta.data的练习题吧。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 我们先查看一下meta.data的信息，可以看出来meta.data分成了11列，我们关注10和11列</span><br>&gt; head(object@meta.data)<br>                   orig.ident nCount_RNA nFeature_RNA percent.mt nCount_SCT<br>AAACCTGCACCAGTTA-1       D1_1      13672         3417  2.4575775       8262<br>AAACCTGCACCATGTA-1       D1_1      21279         3981  2.3826308       6867<br>AAACCTGGTGAAATCA-1       D1_1      12481         3365  3.4372246       8507<br>AAACCTGTCAGTCCCT-1       D1_1      25707         5562  2.1278251       7718<br>AAACGGGAGGACCACA-1       D1_1       8549         1423  0.9240847       8094<br>AAACGGGTCAAACCAC-1       D1_1      55970         6155  2.2583527       5830<br>                   nFeature_SCT SCT_snn_res.0.5 seurat_clusters<br>AAACCTGCACCAGTTA-1         3245               7               7<br>AAACCTGCACCATGTA-1         2253              10              10<br>AAACCTGGTGAAATCA-1         3298              16              16<br>AAACCTGTCAGTCCCT-1         3204              13              13<br>AAACGGGAGGACCACA-1         1422               3               3<br>AAACGGGTCAAACCAC-1         2364               2               2<br>                   pANN_0.25_0.03_183 DF.classifications_0.25_0.03_183<br>AAACCTGCACCAGTTA-1         0.08247423                          Singlet<br>AAACCTGCACCATGTA-1         0.20618557                          Singlet<br>AAACCTGGTGAAATCA-1         0.23711340                          Singlet<br>AAACCTGTCAGTCCCT-1         0.36082474                          Doublet<br>AAACGGGAGGACCACA-1         0.16494845                          Singlet<br>AAACGGGTCAAACCAC-1         0.09278351                          Singlet<br>                   DF.classifications_0.25_0.03_171<br>AAACCTGCACCAGTTA-1                          Singlet<br>AAACCTGCACCATGTA-1                          Singlet<br>AAACCTGGTGAAATCA-1                          Singlet<br>AAACCTGTCAGTCCCT-1                          Doublet<br>AAACGGGAGGACCACA-1                          Singlet<br>AAACGGGTCAAACCAC-1                          Singlet<br><br><span># 我们先看一下10和11列的不同信息的数量情况，能看出来，高可信度的双胞171个，低可信度的183-171=12个</span><br>&gt; table(object@meta.data<span>$DF</span>.classifications_0.25_0.03_183)<br>Doublet Singlet <br>    183    2254 <br>&gt; table(object@meta.data<span>$DF</span>.classifications_0.25_0.03_171)<br>Doublet Singlet <br>    171    2266<br><br><span># 那么，接下来就让我们分别把他们区分出来吧</span><br><span># 首先，把第10列赋值给新一列"DF_high.low"用来存储高低可信度的双胞。</span><br>object@meta.data[,<span>"Doublet"</span>] &lt;- object@meta.data[,10]<br><br><span># 接着，"DF_high.low"这一列中是"Doublet"，但是第11列中是"Singlet"的判定为"Doublet-Low Confidence"，我们给他命名为"Doublet_low"</span><br>object@meta.data<span>$Doublet</span>[<span>which</span>(object@meta.data<span>$Doublet</span> == <span>"Doublet"</span> &amp; object@meta.data[,11] == <span>"Singlet"</span>)] &lt;- <span>"Doublet_low"</span><br><br><span># 然后，"DF_high.low"这一列中还是"Doublet"就是"Doublet_high"了</span><br>object@meta.data<span>$Doublet</span>[<span>which</span>(object@meta.data<span>$Doublet</span> == <span>"Doublet"</span>)] &lt;- <span>"Doublet_high"</span><br><br><span># 大家感兴趣的话，也可以画一下类似上面的图，我用这个2000多细胞的数据画出来是这样的。可能效果不是很好，大家将就着看。</span><br>pdf(paste0(opts<span>$sample</span>, <span>"_dimplot.pdf"</span>), width=20, height=10)<br>plot1 &lt;- DimPlot(object, reduction = <span>"umap"</span>, group.by = <span>"Doublet"</span>, pt.size = 0.5)<br>plot2 &lt;- VlnPlot(object, group.by = <span>"Doublet"</span>, features = c(<span>"nCount_RNA"</span>, <span>"nFeature_RNA"</span>), pt.size = 0, ncol = 2)<br>plot1 + plot2<br>dev.off()<br></code></pre><p><img data-imgfileid="100004037" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEiaDia0fRAEBM0pQcFurOCue33DRDez8ZMrj33FJW3wMnRic39f9YWKpZA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEiaDia0fRAEBM0pQcFurOCue33DRDez8ZMrj33FJW3wMnRic39f9YWKpZA/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>DoubletFinder2</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 这样，我们就可以去除双胞，只取单胞了</span><br>object_Singlet &lt;- subset(x = object, subset = Doublet == <span>"Singlet"</span>)<br><span># 同样的，输出为10X的标准格式。</span><br>DropletUtils:::write10xCounts(<span>"singlet_matrix"</span>, object_Singlet@assays<span>$RNA</span>@counts, version=<span>"3"</span>)<br></code></pre><p data-tool="mdnice编辑器">最后，我们编写一下批量运行的脚本：(注意：脚本里面的参数大家可以根据自己的数据自行设置。)</p><pre data-tool="mdnice编辑器"><span></span><code>$ cat run_doubletfinder.sh<br>input_path=/workdir/BIO/yangqi/02.project/01.note/03.DoubletFinder/01.data<br>output_path=/workdir/BIO/yangqi/02.project/01.note/03.DoubletFinder/02.run_doubletfinder<br>R_path=/workdir/BIO/yangqi/01.software/mamba/mambaforge/envs/seurat.v4/bin<br><br><span>for</span> line <span>in</span> $(ls <span>${input_path}</span>/)<br><span>do</span><br>    <span>${R_path}</span>/Rscript ./run_doubletfinder.R -i <span>${input_path}</span>/<span>${line}</span> -s <span>${line}</span> -f 6000 -c 20000 -m 5 -o <span>${output_path}</span>/<span>${line}</span><br><span>done</span><br></code></pre><p data-tool="mdnice编辑器"><strong>关于DoubletFinder v2.0.4（即适配于seurat v5）的使用</strong></p><p data-tool="mdnice编辑器"><strong>1.改了什么？</strong></p><p data-tool="mdnice编辑器">详见DoubletFinder官网Updates部分（https://github.com/chris-mcginnis-ucsf/DoubletFinder?tab=readme-ov-file#updates）的(11/21/2023)这一行:</p><p data-tool="mdnice编辑器">Made compatible with Seurat v5 and removed '_v3' flag from relevant function names.</p><p data-tool="mdnice编辑器">翻译一下就是：改成了适应seurat v5的版本，以及修改了部分函数的命名。Seurat v5数据结构的变化，详细信息可以见这篇笔记<a href="https://mp.weixin.qq.com/s?__biz=Mzg5NjE1NTc1OA==&amp;mid=2247486885&amp;idx=1&amp;sn=99d0f9968a9d6412b3620875fe72218e&amp;scene=21#wechat_redirect" data-linktype="2">单细胞基地 | Seurat v5 基础分析流程及其改动 | v5 和 v4 到底有啥不一样嘞！</a></p><p data-tool="mdnice编辑器">函数名字修改就是"paramSweep_v3"变成了"paramSweep"; "doubletFinder_v3"变成了"doubletFinder"</p><p data-tool="mdnice编辑器"><strong>2.使用的时候应该注意什么？</strong></p><p data-tool="mdnice编辑器">注意两件事：</p><p data-tool="mdnice编辑器">① 配置个新环境（按照上面安装部分的 v2.0.4 的命令来）；</p><p data-tool="mdnice编辑器">② 脚本换一下（按照下面的来，跟上面的解析类似，这里就不逐行解析了）。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 加载需要的R包</span><br>library(Matrix)<br>library(Seurat)<br>library(cowplot)<br>library(DropletUtils)<br>library(DoubletFinder)<br><br><span># 读入单细胞矩阵数据，创建seurat对象，并按照要求进行过滤预处理</span><br>object &lt;- Read10X(<span>'your/path/to/filtered_feature_bc_matrix'</span>, gene.column = 2)<br>object &lt;- CreateSeuratObject(counts = object.data, project = <span>"brain_1"</span>, min.cells = 3, min.features = 200)<br>object[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(object, pattern = <span>"^mt-"</span>)<br><span>if</span> (sum(object@meta.data<span>$percent</span>.mt) == 0){<br>    object@meta.data<span>$percent</span>.mt[1] &lt;- 0.000001<br>}<br>object &lt;- subset(object, subset = nFeature_RNA &gt; 200 &amp; nFeature_RNA &lt; 6000 &amp; nCount_RNA &lt; 20000 &amp; percent.mt &lt; 5)<br><br><span># 进行seurat流程的预处理</span><br>object &lt;- SCTransform(object)<br>object &lt;- RunPCA(object)<br>object &lt;- RunUMAP(object, dims = 1:20)<br>object &lt;- FindNeighbors(object, reduction = <span>"pca"</span>, dims = 1:20)<br>object &lt;- FindClusters(object, resolution = 0.5)<br><br><span># pK值确认</span><br>sweep.res.list_object &lt;- paramSweep(object, PCs = 1:20, sct = TRUE)<br>sweep.stats_object &lt;- summarizeSweep(sweep.res.list_object, GT = FALSE)<br>bcmvn_object &lt;- find.pK(sweep.stats_object)<br>dev.off()<br>pK_value &lt;- as.numeric(as.character(bcmvn_object<span>$pK</span>[bcmvn_object<span>$BCmetric</span> == max(bcmvn_object<span>$BCmetric</span>)]))<br><br><span># 同型双胞比例评估</span><br>annotations &lt;- object@meta.data<span>$SCT_snn_res</span>.0.5<br>homotypic.prop &lt;- modelHomotypic(annotations)<br>nExp_poi &lt;- round(0.075*nrow(object@meta.data))<br>nExp_poi.adj &lt;- round(nExp_poi*(1-homotypic.prop))<br><br><span># 找双胞</span><br>pANN_value &lt;- paste0(<span>"pANN_0.25_"</span>, pK_value, <span>'_'</span>, nExp_poi)<br>object &lt;- doubletFinder(object, PCs = 1:20, pN = 0.25, pK = pK_value, nExp = nExp_poi, reuse.pANN = FALSE, sct=TRUE)<br>object &lt;- doubletFinder(object, PCs = 1:20, pN = 0.25, pK = pK_value, nExp = nExp_poi.adj, reuse.pANN = pANN_value, sct=TRUE)<br>object@meta.data[,<span>"Doublet"</span>] &lt;- object@meta.data[,10]<br>object@meta.data<span>$Doublet</span>[<span>which</span>(object@meta.data<span>$Doublet</span> == <span>"Doublet"</span> &amp; object@meta.data[,11] == <span>"Singlet"</span>)] &lt;- <span>"Doublet_low"</span><br>object@meta.data<span>$Doublet</span>[<span>which</span>(object@meta.data<span>$Doublet</span> == <span>"Doublet"</span>)] &lt;- <span>"Doublet_high"</span><br>object_Singlet &lt;- subset(x = object, subset = Doublet == <span>"Singlet"</span>)<br><br><span># 存储结果</span><br><span># v5的数据结构需要对其进行特定的转换</span><br>mtx &lt;- as.matrix(object_Singlet@assays<span>$RNA</span>@layers<span>$counts</span>)<br>rownames(mtx) &lt;- rownames(object_Singlet@assays<span>$RNA</span>@features)<br>colnames(mtx) &lt;- rownames(object_Singlet@assays<span>$RNA</span>@cells)<br>mtx &lt;- Matrix(mtx, sparse = TRUE)<br>DropletUtils:::write10xCounts(<span>"singlet_matrix"</span>, mtx, version=<span>"3"</span>)<br></code></pre><p data-tool="mdnice编辑器">上面我们做完了预处理的相关工作，接下来，我们就开始进行多样本的整合吧。由于v4和v5是有区别的，所以我们会分别进行解析，大家按需学习。</p><h2 data-tool="mdnice编辑器"><span></span><span>2 Seurat.v4多样本数据整合</span><span></span></h2><p data-tool="mdnice编辑器">这里我们先提前介绍一下我们会使用的整合方法，在标准化部分呢，我们会尝试<strong>NormalizeData标准化</strong> 和 <strong>SCTransform标准化</strong> (想要了解两者的区别，可以看曾老师的推送<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528944&amp;idx=1&amp;sn=b7330813932342771e81f0fc3ac96665&amp;scene=21#wechat_redirect" data-linktype="2">SCTransform真的能完美替代Seurat早期的3个函数吗</a>的全文和评论区；还有这个<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247521083&amp;idx=1&amp;sn=49fd8d5b415d792ca2f913a43d0926f0&amp;scene=21#wechat_redirect" data-linktype="2">结论</a>)；关于整合方法的话，我们会使用seurat官网的 <strong>CCA锚点整合</strong> 和 <strong>harmony整合</strong> 两种方法；至于其他的内容，我们暂时不做涉及。</p><h3 data-tool="mdnice编辑器"><span></span><span>2.0 准备工作</span><span></span></h3><p data-tool="mdnice编辑器">首先，我们先将去除双胞后的结果链接到新路径下</p><pre data-tool="mdnice编辑器"><span></span><code><span>for</span> line <span>in</span> {1..5}; <span>do</span> ln -s /workdir/BIO/yangqi/02.project/01.note/03.DoubletFinder/02.run_doubletfinder/mouse_neuron_<span>${line}</span>/singlet_matrix ./mouse_neuron_<span>${line}</span>; <span>done</span><br></code></pre><p data-tool="mdnice编辑器">接着，我们要读取每个样本的数据，计算相关的基础指标 (注意这里就不需要再过滤了)。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 载入需要的包</span><br>library(Seurat)<br>library(cowplot)<br><br><span># 获取数据路径</span><br>matrix_list &lt;- list.files(<span>"/workdir/BIO/yangqi/02.project/01.note/04.Integration/00.data"</span>)<br>Subset_Cells.list = vector()<br><br><span># 批量处理矩阵</span><br><span>for</span> (index <span>in</span> 1:length(matrix_list)) {<br><br>    matrix &lt;- matrix_list[index]<br><br>    matrix_path &lt;- paste0(<span>"/workdir/BIO/yangqi/02.project/01.note/04.Integration/00.data"</span>, <span>'/'</span>, matrix)<br><br>    object.data &lt;- Read10X(matrix_path, gene.column = 2)<br><br>    object &lt;- CreateSeuratObject(counts = object.data, project = matrix, min.cells = 3, min.features = 200)<br><br>    object[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(object, pattern = <span>"^mt-"</span>)<br>    <span>if</span> (sum(object@meta.data<span>$percent</span>.mt) == 0){<br>        object@meta.data<span>$percent</span>.mt[1] &lt;- 0.000001<br>    }<br><br>    Subset_Cells.list &lt;- append(Subset_Cells.list, object)<br>}<br></code></pre><p data-tool="mdnice编辑器">上面这个一个循环做了什么事情呢？我用一句话帮大家解释一下，就是<strong>批量读取了去双胞后产生的矩阵，然后用他们创建了seurat对象，并重新计算了过滤指标（但是不过滤），存储在一个list列表Subset_Cells.list里</strong>。现在让我们来查看一下这个 <strong>Subset_Cells.list</strong> 长什么样。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004036" data-ratio="0.7666666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEvKjpLG3iadgkdIJnWADoabg6ibr3HF80xaEkiaeUOyoAwdc1PMaicdazzQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEvKjpLG3iadgkdIJnWADoabg6ibr3HF80xaEkiaeUOyoAwdc1PMaicdazzQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">很明显可以看到，这个列表里面存储了5个seurat对象，分别对应我们上面的五个样本。</p><p data-tool="mdnice编辑器">准备工作完成后，我们接着该怎么处理呢？无非就是两种整合思路，seurat官网的锚点整合和harmony整合，我们逐个进行解析。</p><h3 data-tool="mdnice编辑器"><span></span><span>2.1 锚点整合</span><span></span></h3><p data-tool="mdnice编辑器"><strong>参考：</strong> seurat v4官网的整合教程：https://satijalab.org/seurat/archive/v4.3/integration_introduction</p><p data-tool="mdnice编辑器"><strong>代码详解：</strong>seurat官网上提示我们在整合之前，需要对每个矩阵做标准化处理，标准化有两种思路，分别是seurat流程中的<strong>NormalizeData标准化</strong> 和 <strong>SCTransform标准化</strong> ，我们分别介绍一下：</p><h4 data-tool="mdnice编辑器"><span></span><span>2.1.1 NormalizeData标准化 + 锚点整合CCA</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span># 对单个样本数据逐一进行标准化和找高变基因</span><br>Subset_Cells.list &lt;- lapply(X = Subset_Cells.list, FUN = <span>function</span>(x) {<br>    x &lt;- NormalizeData(x)<br>    x &lt;- FindVariableFeatures(x, selection.method = <span>"vst"</span>, nfeatures = 2000)<br>})<br><br><span># 寻找不同数据集中的都有的高变基因，用于数据集的整合</span><br>features &lt;- SelectIntegrationFeatures(object.list = Subset_Cells.list)<br><br><span># 用FindIntegrationAnchors函数识别锚点并使用IntegrateData函数根据这些锚点将多个数据集整合在一起</span><br>object.anchors &lt;- FindIntegrationAnchors(object.list = Subset_Cells.list, anchor.features = features)<br>object.combined &lt;- IntegrateData(anchorset = object.anchors)<br><br><span># 对整合后的数据进行分析，看整合的效果如何</span><br><span># 我们先切换到"integrated"这个矩阵中</span><br>DefaultAssay(immune.combined) &lt;- <span>"integrated"</span><br><br><span># 然后跑seurat的标准流程进行计算，里面的部分参数值需要根据自身数据情况自主设置，我这里图省事，用了官网现成的。</span><br>object.combined &lt;- ScaleData(object.combined, verbose = FALSE)<br>object.combined &lt;- RunPCA(object.combined, npcs = 30, verbose = FALSE)<br>object.combined &lt;- RunUMAP(object.combined, reduction = <span>"pca"</span>, dims = 1:30)<br>object.combined &lt;- FindNeighbors(object.combined, reduction = <span>"pca"</span>, dims = 1:30)<br>object.combined &lt;- FindClusters(object.combined, resolution = 0.5)<br><br><span># 我们按照样本分组可视化一下整合效果</span><br>pdf(<span>"Dimplot_group.pdf"</span>, width = 20, height = 10)<br>p1 &lt;- DimPlot(object.combined, reduction = <span>"umap"</span>, group.by = <span>"orig.ident"</span>, pt.size = 1.0)<br>p2 &lt;- DimPlot(object.combined, reduction = <span>"umap"</span>, label = TRUE, pt.size = 1.0)<br>p1 + p2<br>dev.off()<br><br>pdf(<span>"Dimplot_split.pdf"</span>, width = 50, height = 10)<br>DimPlot(object.combined, reduction = <span>"umap"</span>, split.by = <span>"orig.ident"</span>, ncol = 5, pt.size = 1.0)<br>dev.off()<br><br><span># 存储一下整合的结果</span><br>saveRDS(object.combined, file = <span>"integration_Normal_CCA.rds"</span>)<br></code></pre><p data-tool="mdnice编辑器">我们来看一下效果，至少从单样本UMAP图形状和细胞分群情况上来看挺好的。关于基因的表达情况，我们还未可知，不过我想不会太差。<img data-imgfileid="100004038" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEicHK0dLedgwBribCOMfpJ5cz5iaWicbonhrARcjyYjVDiaNCxREibYPAHIGw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEicHK0dLedgwBribCOMfpJ5cz5iaWicbonhrARcjyYjVDiaNCxREibYPAHIGw/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100004040" data-ratio="0.2" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEBQJxawef4Kbs5KSoxh2zBNnOYZOMDSwl6jGpcScZX7hic6ksk4Vsbnw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEBQJxawef4Kbs5KSoxh2zBNnOYZOMDSwl6jGpcScZX7hic6ksk4Vsbnw/640?wx_fmt=png&amp;from=appmsg"></p><h4 data-tool="mdnice编辑器"><span></span><span>2.1.2 SCTransform标准化 + 锚点整合CCA</span><span></span></h4><p data-tool="mdnice编辑器">这个部分唯一的区别就是标准化方法变成了SCTransform标准化，其他都不变，我就直接展示代码：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 批量SCT标准化</span><br>Subset_Cells.list &lt;- lapply(X = Subset_Cells.list, FUN = SCTransform)<br><br><span># CCA锚点整合，这里的标准化方法参数记得换成SCT</span><br>features &lt;- SelectIntegrationFeatures(object.list = Subset_Cells.list, nfeatures = 3000)<br>Subset_Cells.list &lt;- PrepSCTIntegration(object.list = Subset_Cells.list, anchor.features = features)<br>object.anchors &lt;- FindIntegrationAnchors(object.list = Subset_Cells.list, normalization.method = <span>"SCT"</span>, anchor.features = features)<br>object.combined &lt;- IntegrateData(anchorset = object.anchors, normalization.method = <span>"SCT"</span>)<br><br><span># seurat常规流程，降维聚类分群</span><br>object.combined &lt;- RunPCA(object.combined, npcs = 30, verbose = FALSE)<br>object.combined &lt;- RunUMAP(object.combined, reduction = <span>"pca"</span>, dims = 1:30)<br>object.combined &lt;- FindNeighbors(object.combined, reduction = <span>"pca"</span>, dims = 1:30)<br>object.combined &lt;- FindClusters(object.combined, resolution = 0.5)<br><br><span># 可视化结果</span><br>pdf(<span>"Dimplot_group_SCT_CCA.pdf"</span>, width = 20, height = 10)<br>p1 &lt;- DimPlot(object.combined, reduction = <span>"umap"</span>, group.by = <span>"orig.ident"</span>, pt.size = 1.0)<br>p2 &lt;- DimPlot(object.combined, reduction = <span>"umap"</span>, label = TRUE, pt.size = 1.0)<br>p1 + p2<br>dev.off()<br><br>pdf(<span>"Dimplot_split_SCT_CCA.pdf"</span>, width = 50, height = 10)<br>DimPlot(object.combined, reduction = <span>"umap"</span>, split.by = <span>"orig.ident"</span>, ncol = 5, pt.size = 1.0)<br>dev.off()<br><br><span># 存储结果</span><br>saveRDS(object.combined, file = <span>"integration_SCT_CCA.rds"</span>)<br></code></pre><p data-tool="mdnice编辑器">结果如下图所示，差别不是很大：<img data-imgfileid="100004043" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEvAnyUrmaot1P0eAziaNlxZv4AdoNFuE3nesgCPymD89Bj2mexposcyA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEvAnyUrmaot1P0eAziaNlxZv4AdoNFuE3nesgCPymD89Bj2mexposcyA/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100004044" data-ratio="0.2" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEr4Tzia9lqwOsRyWmZE0KcYmTfUspn30oc9w3aMlGl28rhswKU4wJuRw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEr4Tzia9lqwOsRyWmZE0KcYmTfUspn30oc9w3aMlGl28rhswKU4wJuRw/640?wx_fmt=png&amp;from=appmsg"></p><h3 data-tool="mdnice编辑器"><span></span><span>2.2 Harmony整合</span><span></span></h3><p data-tool="mdnice编辑器"><strong>参考：</strong> https://github.com/immunogenomics/harmony</p><p data-tool="mdnice编辑器"><strong>安装：</strong><strong>注意</strong>这里安装不要使用mamba，否则会导致harmony运行报错。详细信息见https://github.com/immunogenomics/harmony/issues/169</p><pre data-tool="mdnice编辑器"><span></span><code>devtools::install_github(<span>"eddelbuettel/harmony"</span>, force = TRUE)<br></code></pre><p data-tool="mdnice编辑器"><strong>代码解析：</strong>首先呢，我们依然可以使用准备工作中处理好的 <strong>Subset_Cells.list</strong>，同样地分为两种标准化方法，我们分别展示代码：</p><h4 data-tool="mdnice编辑器"><span></span><span>2.2.1 NormalizeData标准化 + Harmony整合</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span># 导入harmony包</span><br>library(harmony)<br><br><span># 将不同的样本数据merge在一块</span><br>object.combined &lt;- merge(Subset_Cells.list[[1]], y = Subset_Cells.list[-1], add.cell.ids = names(Subset_Cells.list), project = <span>"neuron"</span>)<br><br><span># seurat常规流程</span><br>object.combined &lt;- NormalizeData(object = object.combined, normalization.method = <span>"LogNormalize"</span>, scale.factor = 10000)<br>object.combined &lt;- FindVariableFeatures(object = object.combined, selection.method = <span>"vst"</span>, nfeatures = 2000)<br>object.combined &lt;- ScaleData(object = object.combined, verbose = FALSE)<br>object.combined &lt;- RunPCA(object = object.combined, npcs = 100, verbose = FALSE)<br><br><span># 跑harmony整合</span><br>object.combined &lt;- RunHarmony(object.combined, group.by.vars = <span>"orig.ident"</span>)<br><br><span># 降维，聚类</span><br>object.combined &lt;- RunUMAP(object.combined, reduction = <span>"harmony"</span>, dims = 1:30)<br>object.combined &lt;- FindNeighbors(object.combined, reduction = <span>"harmony"</span>, dims = 1:30)<br>object.combined &lt;- FindClusters(object.combined, resolution = 0.5)<br><br><span># 画图展示整合效果</span><br>pdf(<span>"Dimplot_group_Normal_Harmony.pdf"</span>, width = 20, height = 10)<br>p1 &lt;- DimPlot(object.combined, reduction = <span>"umap"</span>, group.by = <span>"orig.ident"</span>, pt.size = 1.0)<br>p2 &lt;- DimPlot(object.combined, reduction = <span>"umap"</span>, label = TRUE, pt.size = 1.0)<br>p1 + p2<br>dev.off()<br><br>pdf(<span>"Dimplot_split_Normal_Harmony.pdf"</span>, width = 50, height = 10)<br>DimPlot(object.combined, reduction = <span>"umap"</span>, split.by = <span>"orig.ident"</span>, ncol = 5, pt.size = 1.0)<br>dev.off()<br><br><span># 存储结果</span><br>saveRDS(object.combined, file = <span>"integration_Normal_Harmony.rds"</span>)<br></code></pre><p data-tool="mdnice编辑器">结果如下图所示，整合效果也不错：<img data-imgfileid="100004042" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNER4L1Oy4IONUaibMEpPqrv9QezdwibHC13Neg1qLLrIZWLV8M8GvzAhXw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNER4L1Oy4IONUaibMEpPqrv9QezdwibHC13Neg1qLLrIZWLV8M8GvzAhXw/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100004045" data-ratio="0.2" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEpkdz9wSia0BI8Xr4OsIZHTCCIIic3ib3IVSqnnQHw8bbaic8yjEvibO84Mw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEpkdz9wSia0BI8Xr4OsIZHTCCIIic3ib3IVSqnnQHw8bbaic8yjEvibO84Mw/640?wx_fmt=png&amp;from=appmsg"></p><h4 data-tool="mdnice编辑器"><span></span><span>2.1.2 SCTransform标准化 + Harmony整合</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span># 导入harmony包</span><br>library(harmony)<br><br><span># 将不同的样本数据merge在一块</span><br>object.combined &lt;- merge(Subset_Cells.list[[1]], y = Subset_Cells.list[-1], merge.data = TRUE)<br><br><span># SCT标准化</span><br>object.combined &lt;- SCTransform(object.combined, assay = <span>'RNA'</span>, return.only.var.genes = F, verbose = F)<br><span># PCA降维</span><br>object.combined &lt;- RunPCA(object.combined, npcs = 30, verbose = FALSE)<br><br><span># 跑harmony整合</span><br>object.combined &lt;- RunHarmony(object.combined, group.by.vars = <span>"orig.ident"</span>, assay.use = <span>'SCT'</span>)<br><br><span># 降维，聚类</span><br>object.combined &lt;- RunUMAP(object.combined, reduction = <span>"harmony"</span>)<br>object.combined &lt;- FindNeighbors(object.combined, reduction = <span>"pca"</span>, dims = 1:30)<br>object.combined &lt;- FindClusters(object.combined, resolution = 0.5)<br><br><span># 画图展示整合效果</span><br>pdf(<span>"Dimplot_group_SCT_Harmony.pdf"</span>, width = 20, height = 10)<br>p1 &lt;- DimPlot(object.combined, reduction = <span>"umap"</span>, group.by = <span>"orig.ident"</span>, pt.size = 1.0)<br>p2 &lt;- DimPlot(object.combined, reduction = <span>"umap"</span>, label = TRUE, pt.size = 1.0)<br>p1 + p2<br>dev.off()<br><br>pdf(<span>"Dimplot_split_SCT_Harmony.pdf"</span>, width = 50, height = 10)<br>DimPlot(object.combined, reduction = <span>"umap"</span>, split.by = <span>"orig.ident"</span>, ncol = 5, pt.size = 1.0)<br>dev.off()<br><br><span># 存储结果</span><br>saveRDS(object.combined, file = <span>"integration_SCT_Harmony.rds"</span>)<br></code></pre><p data-tool="mdnice编辑器">结果看起来也整合到一块了<img data-imgfileid="100004041" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEfMC5PJtHGhHAkDN200bmAN6HWmibAUHAUvHQ5JxXmvKhek2wTevg4hg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEfMC5PJtHGhHAkDN200bmAN6HWmibAUHAUvHQ5JxXmvKhek2wTevg4hg/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100004050" data-ratio="0.2" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEJmcUFQCxEvnSlxXVX5HVvCeRUHXMONAiau0cHng4JMccoqsgNqdGNww/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEJmcUFQCxEvnSlxXVX5HVvCeRUHXMONAiau0cHng4JMccoqsgNqdGNww/640?wx_fmt=png&amp;from=appmsg"></p><h2 data-tool="mdnice编辑器"><span></span><span>3 Seurat.v5多样本数据整合</span><span></span></h2><p data-tool="mdnice编辑器">Seurat v5部分的整合呢，官方把目前主流的一些方法也集成了进去，这些在官网上也有详细的说明，👉指路（https://satijalab.org/seurat/articles/seurat5_integration#perform-streamlined-one-line-integrative-analysis），概括起来说呢，基本上是以下五种： </p><p data-tool="mdnice编辑器">① 基于锚点的CCA整合 (method=CCAIntegration)</p><pre data-tool="mdnice编辑器"><span></span><code><span># 核心代码</span><br>obj &lt;- IntegrateLayers(object = obj, method = CCAIntegration, orig.reduction = <span>"pca"</span>, new.reduction = <span>"integrated.cca"</span>, verbose = FALSE)<br></code></pre><p data-tool="mdnice编辑器">② 基于锚点的RPCA整合 (method=RPCAIntegration)：更快、更保守（更少校正）</p><pre data-tool="mdnice编辑器"><span></span><code><span># 核心代码</span><br>obj &lt;- IntegrateLayers(object = obj, method = RPCAIntegration, orig.reduction = <span>"pca"</span>, new.reduction = <span>"integrated.rpca"</span>, verbose = FALSE)<br></code></pre><p data-tool="mdnice编辑器">③ Harmony整合 (method=HarmonyIntegration)</p><pre data-tool="mdnice编辑器"><span></span><code><span># 核心代码</span><br>obj &lt;- IntegrateLayers(object = obj, method = HarmonyIntegration, orig.reduction = <span>"pca"</span>, new.reduction = <span>"harmony"</span>, verbose = FALSE)<br></code></pre><p data-tool="mdnice编辑器">④ FastMNN整合 (method= FastMNNIntegration)</p><pre data-tool="mdnice编辑器"><span></span><code><span># 核心代码</span><br>obj &lt;- IntegrateLayers(object = obj, method = FastMNNIntegration, new.reduction = <span>"integrated.mnn"</span>, verbose = FALSE)<br></code></pre><p data-tool="mdnice编辑器">⑤ scVI整合 (method=scVIIntegration)</p><pre data-tool="mdnice编辑器"><span></span><code>obj &lt;- IntegrateLayers(object = obj, method = scVIIntegration, new.reduction = <span>"integrated.scvi"</span>, conda_env = <span>"../miniconda3/envs/scvi-env"</span>, verbose = FALSE)<br></code></pre><p data-tool="mdnice编辑器">不过这里呢，我们还是主要为大家展示主流的CCA和harmony，剩下的整合方法大家可以自主探索，这些方法没有太多的优劣之分，主要还是适合自己的就是最好的，大家酌情选择，核心代码一换，基本上都是适用的。</p><h3 data-tool="mdnice编辑器"><span></span><span>3.0 准备工作</span><span></span></h3><p data-tool="mdnice编辑器">首先呢，大家需要对seurat.v5的数据结构有一定的认识，我们在这篇笔记<a href="https://mp.weixin.qq.com/s?__biz=MzkwMTIwNjg2Mw==&amp;mid=2247484247&amp;idx=1&amp;sn=49d511885d2e7e2314e448f25ccd649b&amp;scene=21#wechat_redirect" data-linktype="2">单细胞基地 | Seurat v5 基础分析流程及其改动 | v5 和 v4 到底有啥不一样嘞！</a>做了简单的整理，大家可以先去补充一下相关知识。在这里我们简单地向大家说明一下seurat.v5数据集列表的构建，因为这是我们整合过程中的关键。</p><p data-tool="mdnice编辑器">首先呢，我们按照 <strong>2.0 准备工作</strong> 先批量读进矩阵创建列表<strong>Subset_Cells.list</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># 载入需要的包</span><br>library(Seurat)<br>library(cowplot)<br><br><span># 批量读取矩阵，创建seurat对象列表Subset_Cells.list</span><br>matrix_list &lt;- list.files(<span>"/workdir/BIO/yangqi/02.project/01.note/04.Integration/00.data"</span>)<br>Subset_Cells.list = vector()<br><span>for</span> (index <span>in</span> 1:length(matrix_list)) {<br>    matrix &lt;- matrix_list[index]<br>    matrix_path &lt;- paste0(<span>"/workdir/BIO/yangqi/02.project/01.note/04.Integration/00.data"</span>, <span>'/'</span>, matrix)<br>    object.data &lt;- Read10X(matrix_path, gene.column = 2)<br>    object &lt;- CreateSeuratObject(counts = object.data, project = matrix, min.cells = 3, min.features = 200)<br>    object[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(object, pattern = <span>"^mt-"</span>)<br>    <span>if</span> (sum(object@meta.data<span>$percent</span>.mt) == 0){<br>        object@meta.data<span>$percent</span>.mt[1] &lt;- 0.000001<br>    }<br>    Subset_Cells.list &lt;- append(Subset_Cells.list, object)<br>}<br></code></pre><p data-tool="mdnice编辑器">接着，就是重点操作，我们要如何把 <strong>Subset_Cells.list</strong> 改造成适合于seurat.v5的结构呢？我觉得官网上的示例数据的数据结构我们需要先学习一下，我们先看看seurat.v5官网上的示例数据的结构，然后按照这个结构将我们的数据改造一下吧。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 加载需要的R包</span><br>library(Seurat)<br>library(SeuratData)<br>library(patchwork)<br><br><span># 下载ifnb这个数据集</span><br>InstallData(<span>"ifnb"</span>)<br><br><span># 加载ifnb数据集</span><br>ifnb &lt;- LoadData(<span>"ifnb"</span>)<br><span># 查看一下此时ifnb的数据结构，可以看到是一个counts矩阵，一个data矩阵</span><br>&gt; str(ifnb)<br>Formal class <span>'Seurat'</span> [package <span>"SeuratObject"</span>] with 13 slots<br>  ..@ assays      :List of 1<br>  .. ..$ RNA:Formal class <span>'Assay5'</span> [package <span>"SeuratObject"</span>] with 8 slots<br>  .. .. .. ..@ layers    :List of 2<br>  .. .. .. .. ..$ counts:Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  .. .. .. .. .. .. ..@ i       : int [1:9787436] 20 27 37 64 65 83 87 131 139 175 ...<br>  .. .. .. .. .. .. ..@ p       : int [1:14000] 0 877 1590 2440 3549 4183 4740 5720 6301 7181 ...<br>  .. .. .. .. .. .. ..@ Dim     : int [1:2] 14053 13999<br>  .. .. .. .. .. .. ..@ Dimnames:List of 2<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. ..@ x       : num [1:9787436] 1 1 1 1 1 2 1 1 1 1 ...<br>  .. .. .. .. .. .. ..@ factors : list()<br>  .. .. .. .. ..$ data  :Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  .. .. .. .. .. .. ..@ i       : int [1:9787436] 20 27 37 64 65 83 87 131 139 175 ...<br>  .. .. .. .. .. .. ..@ p       : int [1:14000] 0 877 1590 2440 3549 4183 4740 5720 6301 7181 ...<br>  .. .. .. .. .. .. ..@ Dim     : int [1:2] 14053 13999<br>  .. .. .. .. .. .. ..@ Dimnames:List of 2<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. ..@ x       : num [1:9787436] 1 1 1 1 1 2 1 1 1 1 ...<br>  .. .. .. .. .. .. ..@ factors : list()<br>  .. .. .. ..@ cells     :Formal class <span>'LogMap'</span> [package <span>"SeuratObject"</span>] with 1 slot<br>  .. .. .. .. .. ..@ .Data: logi [1:13999, 1:2] TRUE TRUE TRUE TRUE TRUE TRUE ...<br>  .. .. .. .. .. .. ..- attr(*, <span>"dimnames"</span>)=List of 2<br>  .. .. .. .. .. .. .. ..$ : chr [1:13999] <span>"AAACATACATTTCC.1"</span> <span>"AAACATACCAGAAA.1"</span> <span>"AAACATACCTCGCT.1"</span> <span>"AAACATACCTGGTA.1"</span> ...<br>  .. .. .. .. .. .. .. ..$ : chr [1:2] <span>"counts"</span> <span>"data"</span><br>  .. .. .. .. .. ..$ dim     : int [1:2] 13999 2<br>  .. .. .. .. .. ..$ dimnames:List of 2<br>  .. .. .. .. .. .. ..$ : chr [1:13999] <span>"AAACATACATTTCC.1"</span> <span>"AAACATACCAGAAA.1"</span> <span>"AAACATACCTCGCT.1"</span> <span>"AAACATACCTGGTA.1"</span> ...<br>  .. .. .. .. .. .. ..$ : chr [1:2] <span>"counts"</span> <span>"data"</span><br>  .. .. .. ..@ features  :Formal class <span>'LogMap'</span> [package <span>"SeuratObject"</span>] with 1 slot<br>  .. .. .. .. .. ..@ .Data: logi [1:14053, 1:2] TRUE TRUE TRUE TRUE TRUE TRUE ...<br>  .. .. .. .. .. .. ..- attr(*, <span>"dimnames"</span>)=List of 2<br>  .. .. .. .. .. .. .. ..$ : chr [1:14053] <span>"AL627309.1"</span> <span>"RP11-206L10.2"</span> <span>"LINC00115"</span> <span>"NOC2L"</span> ...<br>  .. .. .. .. .. .. .. ..$ : chr [1:2] <span>"counts"</span> <span>"data"</span><br>  .. .. .. .. .. ..$ dim     : int [1:2] 14053 2<br>  .. .. .. .. .. ..$ dimnames:List of 2<br>  .. .. .. .. .. .. ..$ : chr [1:14053] <span>"AL627309.1"</span> <span>"RP11-206L10.2"</span> <span>"LINC00115"</span> <span>"NOC2L"</span> ...<br>  .. .. .. .. .. .. ..$ : chr [1:2] <span>"counts"</span> <span>"data"</span><br>  .. .. .. ..@ default   : int 1<br>  .. .. .. ..@ assay.orig: chr(0) <br>  .. .. .. ..@ meta.data :<span>'data.frame'</span>: 14053 obs. of  0 variables<br>  .. .. .. ..@ misc      : list()<br>  .. .. .. ..@ key       : chr <span>"rna_"</span><br></code></pre><p data-tool="mdnice编辑器">我们看到官网上依据<code>ifnb$stim</code>信息，把<code>ifnb</code>拆分了。那么我们在拆分前先看一下<code>ifnb$stim</code>里面是什么信息。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004046" data-ratio="0.5037037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNElRAyiazBZQAicbUt3KJdnLN0RB6OEl6S0rcHpiaC5X0muVicAwhzqYGwjQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNElRAyiazBZQAicbUt3KJdnLN0RB6OEl6S0rcHpiaC5X0muVicAwhzqYGwjQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">很明显这个数据集由两个样本构成的，分别是CTRL和STIM，这就是拆分的依据，我们按照官网的命令拆分一下吧。</p><pre data-tool="mdnice编辑器"><span></span><code>ifnb[[<span>"RNA"</span>]] &lt;- split(ifnb[[<span>"RNA"</span>]], f = ifnb<span>$stim</span>)<br>ifnb<br><br><span># 查看一下此时ifnb的数据结构，可以看到是两个counts矩阵，两个data矩阵</span><br><span># 说明ifnb被根据样本信息拆分成了两份。</span><br>str(ifnb)<br>Formal class <span>'Seurat'</span> [package <span>"SeuratObject"</span>] with 13 slots<br>  ..@ assays      :List of 1<br>  .. ..$ RNA:Formal class <span>'Assay5'</span> [package <span>"SeuratObject"</span>] with 8 slots<br>  .. .. .. ..@ layers    :List of 4<br>  .. .. .. .. ..$ counts.CTRL:Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  .. .. .. .. .. .. ..@ i       : int [1:4626015] 20 27 37 64 65 83 87 131 139 175 ...<br>  .. .. .. .. .. .. ..@ p       : int [1:6549] 0 877 1590 2440 3549 4183 4740 5720 6301 7181 ...<br>  .. .. .. .. .. .. ..@ Dim     : int [1:2] 14053 6548<br>  .. .. .. .. .. .. ..@ Dimnames:List of 2<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. ..@ x       : num [1:4626015] 1 1 1 1 1 2 1 1 1 1 ...<br>  .. .. .. .. .. .. ..@ factors : list()<br>  .. .. .. .. ..$ counts.STIM:Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  .. .. .. .. .. .. ..@ i       : int [1:5161421] 7 10 20 25 27 79 87 113 176 194 ...<br>  .. .. .. .. .. .. ..@ p       : int [1:7452] 0 588 1380 1964 2696 3242 4558 5140 5702 6210 ...<br>  .. .. .. .. .. .. ..@ Dim     : int [1:2] 14053 7451<br>  .. .. .. .. .. .. ..@ Dimnames:List of 2<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. ..@ x       : num [1:5161421] 15 1 1 1 1 1 1 1 1 1 ...<br>  .. .. .. .. .. .. ..@ factors : list()<br>  .. .. .. .. ..$ data.CTRL  :Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  .. .. .. .. .. .. ..@ i       : int [1:4626015] 20 27 37 64 65 83 87 131 139 175 ...<br>  .. .. .. .. .. .. ..@ p       : int [1:6549] 0 877 1590 2440 3549 4183 4740 5720 6301 7181 ...<br>  .. .. .. .. .. .. ..@ Dim     : int [1:2] 14053 6548<br>  .. .. .. .. .. .. ..@ Dimnames:List of 2<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. ..@ x       : num [1:4626015] 1 1 1 1 1 2 1 1 1 1 ...<br>  .. .. .. .. .. .. ..@ factors : list()<br>  .. .. .. .. ..$ data.STIM  :Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  .. .. .. .. .. .. ..@ i       : int [1:5161421] 7 10 20 25 27 79 87 113 176 194 ...<br>  .. .. .. .. .. .. ..@ p       : int [1:7452] 0 588 1380 1964 2696 3242 4558 5140 5702 6210 ...<br>  .. .. .. .. .. .. ..@ Dim     : int [1:2] 14053 7451<br>  .. .. .. .. .. .. ..@ Dimnames:List of 2<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. ..@ x       : num [1:5161421] 15 1 1 1 1 1 1 1 1 1 ...<br>  .. .. .. .. .. .. ..@ factors : list()<br>  .. .. .. ..@ cells     :Formal class <span>'LogMap'</span> [package <span>"SeuratObject"</span>] with 1 slot<br>  .. .. .. .. .. ..@ .Data: logi [1:13999, 1:4] TRUE TRUE TRUE TRUE TRUE TRUE ...<br>  .. .. .. .. .. .. ..- attr(*, <span>"dimnames"</span>)=List of 2<br>  .. .. .. .. .. .. .. ..$ : chr [1:13999] <span>"AAACATACATTTCC.1"</span> <span>"AAACATACCAGAAA.1"</span> <span>"AAACATACCTCGCT.1"</span> <span>"AAACATACCTGGTA.1"</span> ...<br>  .. .. .. .. .. .. .. ..$ : chr [1:4] <span>"counts.CTRL"</span> <span>"counts.STIM"</span> <span>"data.CTRL"</span> <span>"data.STIM"</span><br>  .. .. .. .. .. ..$ dim     : int [1:2] 13999 4<br>  .. .. .. .. .. ..$ dimnames:List of 2<br>  .. .. .. .. .. .. ..$ : chr [1:13999] <span>"AAACATACATTTCC.1"</span> <span>"AAACATACCAGAAA.1"</span> <span>"AAACATACCTCGCT.1"</span> <span>"AAACATACCTGGTA.1"</span> ...<br>  .. .. .. .. .. .. ..$ : chr [1:4] <span>"counts.CTRL"</span> <span>"counts.STIM"</span> <span>"data.CTRL"</span> <span>"data.STIM"</span><br>  .. .. .. ..@ features  :Formal class <span>'LogMap'</span> [package <span>"SeuratObject"</span>] with 1 slot<br>  .. .. .. .. .. ..@ .Data: logi [1:14053, 1:4] TRUE TRUE TRUE TRUE TRUE TRUE ...<br>  .. .. .. .. .. .. ..- attr(*, <span>"dimnames"</span>)=List of 2<br>  .. .. .. .. .. .. .. ..$ : chr [1:14053] <span>"AL627309.1"</span> <span>"RP11-206L10.2"</span> <span>"LINC00115"</span> <span>"NOC2L"</span> ...<br>  .. .. .. .. .. .. .. ..$ : chr [1:4] <span>"counts.CTRL"</span> <span>"counts.STIM"</span> <span>"data.CTRL"</span> <span>"data.STIM"</span><br>  .. .. .. .. .. ..$ dim     : int [1:2] 14053 4<br>  .. .. .. .. .. ..$ dimnames:List of 2<br>  .. .. .. .. .. .. ..$ : chr [1:14053] <span>"AL627309.1"</span> <span>"RP11-206L10.2"</span> <span>"LINC00115"</span> <span>"NOC2L"</span> ...<br>  .. .. .. .. .. .. ..$ : chr [1:4] <span>"counts.CTRL"</span> <span>"counts.STIM"</span> <span>"data.CTRL"</span> <span>"data.STIM"</span><br>  .. .. .. ..@ default   : int 2<br>  .. .. .. ..@ assay.orig: chr(0) <br>  .. .. .. ..@ meta.data :<span>'data.frame'</span>: 14053 obs. of  0 variables<br>  .. .. .. ..@ misc      : list()<br>  .. .. .. ..@ key       : chr <span>"rna_"</span><br></code></pre><p data-tool="mdnice编辑器">看完了官网的数据结构，我想我们也需要一个类似的数据结构，我们尝试构建一个吧。我找了一些笔记后，发现这两篇笔记<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247520177&amp;idx=1&amp;sn=2d4075bee8fc59cf78d16c1291db7353&amp;scene=21#wechat_redirect" data-linktype="2">seurat v5直播，一键完成五种数据整合：harmony，CCA，RPCA,FastMNN,scVI</a>、<a href="https://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651285870&amp;idx=1&amp;sn=618ebc33023387dbc3d226e1c249a05a&amp;scene=21#wechat_redirect" data-linktype="2">单细胞专题 | 14 Seurat v5版本融合多样本的单细胞数据以及一些报错问题</a>中提到的merge这个函数可以实现这一目的，我们操作一下看看。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 将不同的对象merge进一个对象中</span><br>&gt; object.combined &lt;- merge(Subset_Cells.list[[1]], y = Subset_Cells.list[-1], add.cell.ids = names(Subset_Cells.list), project = <span>"neuron"</span>)<br><br><span># 查看一下数据结构</span><br>&gt; str(object.combined)<br>Formal class <span>'Seurat'</span> [package <span>"SeuratObject"</span>] with 13 slots<br>  ..@ assays      :List of 1<br>  .. ..$ RNA:Formal class <span>'Assay5'</span> [package <span>"SeuratObject"</span>] with 8 slots<br>  .. .. .. ..@ layers    :List of 5<br>  .. .. .. .. ..$ counts.mouse_neuron_1:Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  .. .. .. .. .. .. ..@ i       : int [1:17520797] 0 7 10 11 13 16 22 28 31 36 ...<br>  .. .. .. .. .. .. ..@ p       : int [1:4829] 0 5132 9976 10443 14442 19667 24059 27643 32582 37329 ...<br>  .. .. .. .. .. .. ..@ Dim     : int [1:2] 23476 4828<br>  .. .. .. .. .. .. ..@ Dimnames:List of 2<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. ..@ x       : num [1:17520797] 15 2 3 1 2 8 17 1 1 1 ...<br>  .. .. .. .. .. .. ..@ factors : list()<br>  .. .. .. .. ..$ counts.mouse_neuron_2:Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  .. .. .. .. .. .. ..@ i       : int [1:17579967] 0 6 9 10 12 15 21 27 30 35 ...<br>  .. .. .. .. .. .. ..@ p       : int [1:4635] 0 5132 9974 13920 19103 23468 27006 31962 36700 41116 ...<br>  .. .. .. .. .. .. ..@ Dim     : int [1:2] 23449 4634<br>  .. .. .. .. .. .. ..@ Dimnames:List of 2<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. ..@ x       : num [1:17579967] 15 3 2 1 1 9 15 2 1 1 ...<br>  .. .. .. .. .. .. ..@ factors : list()<br>  .. .. .. .. ..$ counts.mouse_neuron_3:Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  .. .. .. .. .. .. ..@ i       : int [1:24534828] 0 5 18 35 41 52 58 84 90 92 ...<br>  .. .. .. .. .. .. ..@ p       : int [1:6590] 0 2889 7701 10902 14465 19720 24087 27646 30798 35197 ...<br>  .. .. .. .. .. .. ..@ Dim     : int [1:2] 22697 6589<br>  .. .. .. .. .. .. ..@ Dimnames:List of 2<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. ..@ x       : num [1:24534828] 6 1 1 1 4 6 2 4 1 1 ...<br>  .. .. .. .. .. .. ..@ factors : list()<br>  .. .. .. .. ..$ counts.mouse_neuron_4:Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  .. .. .. .. .. .. ..@ i       : int [1:14452170] 0 1 5 8 11 14 18 20 21 28 ...<br>  .. .. .. .. .. .. ..@ p       : int [1:3742] 0 4155 8053 13249 17362 21735 25762 28913 34211 34878 ...<br>  .. .. .. .. .. .. ..@ Dim     : int [1:2] 22104 3741<br>  .. .. .. .. .. .. ..@ Dimnames:List of 2<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. ..@ x       : num [1:14452170] 17 1 1 1 1 1 3 4 1 1 ...<br>  .. .. .. .. .. .. ..@ factors : list()<br>  .. .. .. .. ..$ counts.mouse_neuron_5:Formal class <span>'dgCMatrix'</span> [package <span>"Matrix"</span>] with 6 slots<br>  .. .. .. .. .. .. ..@ i       : int [1:12662480] 0 2 5 8 11 14 29 33 35 40 ...<br>  .. .. .. .. .. .. ..@ p       : int [1:3295] 0 4431 9270 11211 15271 19271 24435 28371 31396 33928 ...<br>  .. .. .. .. .. .. ..@ Dim     : int [1:2] 22275 3294<br>  .. .. .. .. .. .. ..@ Dimnames:List of 2<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. .. ..$ : NULL<br>  .. .. .. .. .. .. ..@ x       : num [1:12662480] 6 2 2 2 2 1 2 1 1 1 ...<br>  .. .. .. .. .. .. ..@ factors : list()<br>  .. .. .. ..@ cells     :Formal class <span>'LogMap'</span> [package <span>"SeuratObject"</span>] with 1 slot<br>  .. .. .. .. .. ..@ .Data: logi [1:23086, 1:5] TRUE TRUE TRUE TRUE TRUE TRUE ...<br>  .. .. .. .. .. .. ..- attr(*, <span>"dimnames"</span>)=List of 2<br>  .. .. .. .. .. .. .. ..$ : chr [1:23086] <span>"AAACCCACAAGAATAC-1_1"</span> <span>"AAACCCACAATAAGGT-1_1"</span> <span>"AAACCCACACCATAAC-1_1"</span> <span>"AAACCCACAGCCCACA-1_1"</span> ...<br>  .. .. .. .. .. .. .. ..$ : chr [1:5] <span>"counts.mouse_neuron_1"</span> <span>"counts.mouse_neuron_2"</span> <span>"counts.mouse_neuron_3"</span> <span>"counts.mouse_neuron_4"</span> ...<br>  .. .. .. .. .. ..$ dim     : int [1:2] 23086 5<br>  .. .. .. .. .. ..$ dimnames:List of 2<br>  .. .. .. .. .. .. ..$ : chr [1:23086] <span>"AAACCCACAAGAATAC-1_1"</span> <span>"AAACCCACAATAAGGT-1_1"</span> <span>"AAACCCACACCATAAC-1_1"</span> <span>"AAACCCACAGCCCACA-1_1"</span> ...<br>  .. .. .. .. .. .. ..$ : chr [1:5] <span>"counts.mouse_neuron_1"</span> <span>"counts.mouse_neuron_2"</span> <span>"counts.mouse_neuron_3"</span> <span>"counts.mouse_neuron_4"</span> ...<br>  .. .. .. ..@ features  :Formal class <span>'LogMap'</span> [package <span>"SeuratObject"</span>] with 1 slot<br>  .. .. .. .. .. ..@ .Data: logi [1:24771, 1:5] TRUE TRUE TRUE TRUE TRUE TRUE ...<br>  .. .. .. .. .. .. ..- attr(*, <span>"dimnames"</span>)=List of 2<br>  .. .. .. .. .. .. .. ..$ : chr [1:24771] <span>"Xkr4"</span> <span>"Gm1992"</span> <span>"Gm19938"</span> <span>"Gm37381"</span> ...<br>  .. .. .. .. .. .. .. ..$ : chr [1:5] <span>"counts.mouse_neuron_1"</span> <span>"counts.mouse_neuron_2"</span> <span>"counts.mouse_neuron_3"</span> <span>"counts.mouse_neuron_4"</span> ...<br>  .. .. .. .. .. ..$ dim     : int [1:2] 24771 5<br>  .. .. .. .. .. ..$ dimnames:List of 2<br>  .. .. .. .. .. .. ..$ : chr [1:24771] <span>"Xkr4"</span> <span>"Gm1992"</span> <span>"Gm19938"</span> <span>"Gm37381"</span> ...<br>  .. .. .. .. .. .. ..$ : chr [1:5] <span>"counts.mouse_neuron_1"</span> <span>"counts.mouse_neuron_2"</span> <span>"counts.mouse_neuron_3"</span> <span>"counts.mouse_neuron_4"</span> ...<br>  .. .. .. ..@ default   : int 5<br>  .. .. .. ..@ assay.orig: chr(0) <br>  .. .. .. ..@ meta.data :<span>'data.frame'</span>: 24771 obs. of  0 variables<br>  .. .. .. ..@ misc      : list()<br>  .. .. .. ..@ key       : chr <span>"rna_"</span><br></code></pre><p data-tool="mdnice编辑器">刚好是我们需要的数据格式，非常好，我们接着就开始按照官网的方式开始整合吧！</p><h3 data-tool="mdnice编辑器"><span></span><span>3.1 锚点整合</span><span></span></h3><p data-tool="mdnice编辑器"><strong>Seurat.v5</strong>也是两种标准化方法，我们逐个展示。</p><h4 data-tool="mdnice编辑器"><span></span><span>3.1.1 NormalizeData标准化 + 锚点整合CCA</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span># 首先是seurat标准流程</span><br>object.combined &lt;- NormalizeData(object.combined)<br>object.combined &lt;- FindVariableFeatures(object.combined)<br>object.combined &lt;- ScaleData(object.combined)<br>object.combined &lt;- RunPCA(object.combined)<br><br><span># 接着，运行CCA整合，这一步是v5特有的。</span><br>object.combined &lt;- IntegrateLayers(object = object.combined, method = CCAIntegration, orig.reduction = <span>"pca"</span>, new.reduction = <span>"integrated.cca"</span>, verbose = FALSE)<br><br><span># 使用JoinLayers()函数将矩阵融合，这一步也是v5特有的。</span><br><span># 这一步拆开看就是把object.combined@assays$RNA@layers$counts.mouse_neuron_1(2/3/4/5)</span><br><span># 融合成一个object.combined@assays$RNA@layers$counts</span><br>object.combined[[<span>"RNA"</span>]] &lt;- JoinLayers(object.combined[[<span>"RNA"</span>]])<br><br><span># 聚类、分群</span><br>object.combined &lt;- FindNeighbors(object.combined, reduction = <span>"integrated.cca"</span>, dims = 1:30)<br>object.combined &lt;- FindClusters(object.combined, resolution = 0.5)<br><br><span># UMAP降维</span><br>object.combined &lt;- RunUMAP(object.combined, dims = 1:30, reduction = <span>"integrated.cca"</span>)<br><br><span># 画图展示整合效果</span><br>pdf(<span>"Dimplot_group_Normal_CCA.pdf"</span>, width = 20, height = 10)<br>p1 &lt;- DimPlot(object.combined, reduction = <span>"umap"</span>, group.by = <span>"orig.ident"</span>, pt.size = 1.0)<br>p2 &lt;- DimPlot(object.combined, reduction = <span>"umap"</span>, label = TRUE, pt.size = 1.0)<br>p1 + p2<br>dev.off()<br><br>pdf(<span>"Dimplot_split_Normal_CCA.pdf"</span>, width = 50, height = 10)<br>DimPlot(object.combined, reduction = <span>"umap"</span>, split.by = <span>"orig.ident"</span>, ncol = 5, pt.size = 1.0)<br>dev.off()<br><br><span># 存储结果</span><br>saveRDS(object.combined, file = <span>"integration_Normal_CCA.rds"</span>)<br></code></pre><p data-tool="mdnice编辑器">整合结果如下：<img data-imgfileid="100004048" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNERhPpmt2NRSS0gV7TU9rBDNZnXAic1R51FzUQvpD8zbNyst15x8mtHKw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNERhPpmt2NRSS0gV7TU9rBDNZnXAic1R51FzUQvpD8zbNyst15x8mtHKw/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100004049" data-ratio="0.2" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEewspekY2RBcN0Jw5JxvmIiaMc55hZicQJiaDtjEKw21YsNXwHiavmVjfTg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEewspekY2RBcN0Jw5JxvmIiaMc55hZicQJiaDtjEKw21YsNXwHiavmVjfTg/640?wx_fmt=png&amp;from=appmsg"></p><h4 data-tool="mdnice编辑器"><span></span><span>3.1.1 SCTransform标准化 + 锚点整合CCA</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span># SCT标准化</span><br>object.combined &lt;- SCTransform(object.combined)<br>object.combined &lt;- RunPCA(object.combined)<br><br><span># 运行CCA整合</span><br>object.combined &lt;- IntegrateLayers(object.combined, method = CCAIntegration, orig.reduction = <span>"SCT"</span>, verbose = FALSE)<br><br><span># 聚类、分群</span><br>object.combined &lt;- FindNeighbors(object.combined, reduction = <span>"integrated.dr"</span>, dims = 1:30)<br>object.combined &lt;- FindClusters(object.combined, resolution = 0.5)<br><br><span># UMAP降维</span><br>object.combined &lt;- RunUMAP(object.combined, dims = 1:30, reduction = <span>"integrated.dr"</span>)<br><br><span># 画图展示整合效果</span><br>pdf(<span>"Dimplot_group_SCT_CCA.pdf"</span>, width = 20, height = 10)<br>p1 &lt;- DimPlot(object.combined, reduction = <span>"umap"</span>, group.by = <span>"orig.ident"</span>, pt.size = 1.0)<br>p2 &lt;- DimPlot(object.combined, reduction = <span>"umap"</span>, label = TRUE, pt.size = 1.0)<br>p1 + p2<br>dev.off()<br><br>pdf(<span>"Dimplot_split_SCT_CCA.pdf"</span>, width = 50, height = 10)<br>DimPlot(object.combined, reduction = <span>"umap"</span>, split.by = <span>"orig.ident"</span>, ncol = 5, pt.size = 1.0)<br>dev.off()<br><br><span># 存储结果</span><br>saveRDS(object.combined, file = <span>"integration_SCT_CCA.rds"</span>)<br></code></pre><p data-tool="mdnice编辑器">整合结果如下：<img data-imgfileid="100004047" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEeU3xX9QlEHFWUdlchMNVq3gB6Le3SXwiaBhN5BMiaibwvKluOKuEGNTEg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEeU3xX9QlEHFWUdlchMNVq3gB6Le3SXwiaBhN5BMiaibwvKluOKuEGNTEg/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100004055" data-ratio="0.2" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNE1n689nNytdFmypK4oOdDUUoUTOYq9tdNvl5Qm1cbKvazObhg4qr5tA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNE1n689nNytdFmypK4oOdDUUoUTOYq9tdNvl5Qm1cbKvazObhg4qr5tA/640?wx_fmt=png&amp;from=appmsg"></p><h3 data-tool="mdnice编辑器"><span></span><span>3.2 Harmony整合</span><span></span></h3><p data-tool="mdnice编辑器"><strong>安装：</strong>这个是可以用mamba直接安装的，并且安装出来时1.2.0版本的，我看官网都没有这个版本，不太清楚原因，但是能用，命令如下：</p><pre data-tool="mdnice编辑器"><span></span><code>mamba install bioconda::r-harmony<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>3.2.1 NormalizeData标准化 + Harmony整合</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span># 导入harmony包</span><br>library(harmony)<br><br><span># seurat标准流程</span><br>object.combined &lt;- NormalizeData(object.combined)<br>object.combined &lt;- FindVariableFeatures(object.combined)<br>object.combined &lt;- ScaleData(object.combined)<br>object.combined &lt;- RunPCA(object.combined)<br><br><span># 运行harmony整合</span><br>object.combined &lt;- IntegrateLayers(object.combined, method = HarmonyIntegration, orig.reduction = <span>"pca"</span>, new.reduction = <span>"harmony"</span>, verbose = FALSE)<br><br><span># 使用JoinLayers()函数将矩阵融合</span><br>object.combined[[<span>"RNA"</span>]] &lt;- JoinLayers(object.combined[[<span>"RNA"</span>]])<br><br><span># 聚类、分群、降维</span><br>object.combined &lt;- FindNeighbors(object.combined, reduction = <span>"harmony"</span>, dims = 1:30)<br>object.combined &lt;- FindClusters(object.combined, resolution = 0.5)<br>object.combined &lt;- RunUMAP(object.combined, reduction = <span>"harmony"</span>, dims = 1:30, reduction.name = <span>"harmony"</span>)<br><br><span># 画图展示整合效果</span><br>pdf(<span>"Dimplot_group_Normal_Harmony.pdf"</span>, width = 20, height = 10)<br>p1 &lt;- DimPlot(object.combined, reduction = <span>"harmony"</span>, group.by = <span>"orig.ident"</span>, pt.size = 1.0)<br>p2 &lt;- DimPlot(object.combined, reduction = <span>"harmony"</span>, label = TRUE, pt.size = 1.0)<br>p1 + p2<br>dev.off()<br><br>pdf(<span>"Dimplot_split_Normal_Harmony.pdf"</span>, width = 50, height = 10)<br>DimPlot(object.combined, reduction = <span>"harmony"</span>, split.by = <span>"orig.ident"</span>, ncol = 5, pt.size = 1.0)<br>dev.off()<br><br><span># 存储结果</span><br>saveRDS(object.combined, file = <span>"integration_Normal_Harmony.rds"</span>)<br></code></pre><p data-tool="mdnice编辑器">结果如下：<img data-imgfileid="100004051" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEldfmBTFHWwM031P7US7rwcftALvyKGPck6Hcu43I2BZwJVRNIkVftA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEldfmBTFHWwM031P7US7rwcftALvyKGPck6Hcu43I2BZwJVRNIkVftA/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100004054" data-ratio="0.2" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEyNyjJTcnLG40iaI14T3HHHSuck5icicwic4051umHUBuT4mTrsrXrMNOMA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEyNyjJTcnLG40iaI14T3HHHSuck5icicwic4051umHUBuT4mTrsrXrMNOMA/640?wx_fmt=png&amp;from=appmsg"></p><h4 data-tool="mdnice编辑器"><span></span><span>3.2.1 SCTransform标准化 + Harmony整合</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span># 导入harmony包</span><br>library(harmony)<br><br><span># SCT标准化</span><br>object.combined &lt;- SCTransform(object.combined)<br>object.combined &lt;- RunPCA(object.combined)<br><br><span># 运行harmony整合</span><br>object.combined &lt;- IntegrateLayers(object.combined, method = HarmonyIntegration, normalization.method = <span>"SCT"</span>, orig.reduction = <span>"pca"</span>, new.reduction = <span>"harmony"</span>,verbose = FALSE)<br><br><span># 聚类、分群、降维</span><br>object.combined &lt;- FindNeighbors(object.combined, reduction = <span>"harmony"</span>, dims = 1:30)<br>object.combined &lt;- FindClusters(object.combined, resolution = 0.5)<br>object.combined &lt;- RunUMAP(object.combined, dims = 1:30, reduction = <span>"harmony"</span>, reduction.name = <span>"harmony"</span>)<br><br><span># 画图展示整合效果</span><br>pdf(<span>"Dimplot_group_SCT_Harmony.pdf"</span>, width = 20, height = 10)<br>p1 &lt;- DimPlot(object.combined, reduction = <span>"harmony"</span>, group.by = <span>"orig.ident"</span>, pt.size = 1.0)<br>p2 &lt;- DimPlot(object.combined, reduction = <span>"harmony"</span>, label = TRUE, pt.size = 1.0)<br>p1 + p2<br>dev.off()<br><br>pdf(<span>"Dimplot_split_SCT_Harmony.pdf"</span>, width = 50, height = 10)<br>DimPlot(object.combined, reduction = <span>"harmony"</span>, split.by = <span>"orig.ident"</span>, ncol = 5, pt.size = 1.0)<br>dev.off()<br><br><span># 存储结果</span><br>saveRDS(object.combined, file = <span>"integration_SCT_Harmony.rds"</span>)<br></code></pre><p data-tool="mdnice编辑器">结果如下：<img data-imgfileid="100004052" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEO2XQia2jFOTOoXUn6x0vibfbLGDtwq4LtIPsUTNfJX8W4hvYKiah971WA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEO2XQia2jFOTOoXUn6x0vibfbLGDtwq4LtIPsUTNfJX8W4hvYKiah971WA/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100004053" data-ratio="0.2" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEI0pfHZQesRrCqE18lVzdBePHibUXMuPmCLDYjTAYHoXYCaJIrhyIFuw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEI0pfHZQesRrCqE18lVzdBePHibUXMuPmCLDYjTAYHoXYCaJIrhyIFuw/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">最后呢，我拿这个seurat.v5的 <strong>SCT + Harmony</strong> 的整合结果画了一些脑中经典marker基因的表达情况，基本上分布都挺特异的，进一步说明整合效果应该是挺好的，不过一些细节肯定是还需要再把控一下的。<img data-imgfileid="100004060" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEETaAt1pa0vom93UvV302DibrhnVTLwXSqZN0micibna9pchCn7GIc9xBQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLooCOea7KwzvBqrnNziczeNEETaAt1pa0vom93UvV302DibrhnVTLwXSqZN0micibna9pchCn7GIc9xBQ/640?wx_fmt=png&amp;from=appmsg"></p></section><section><span>OK! 那么到这里本次的笔记基本上也就结束了，本次笔记原理的部分介绍得可能相对较少，主要是为了理清楚流程，在拿到比对定量的矩阵数据后我们应该做哪些工作，以得到满足seurat标准流程分析的结果。在本教程中，我们为了展示整合后较好地消除了批次效果，用了固定参数对整合后的数据集进行了简单分析，大家在分析自己的数据时需要结合肘形图和clustertree的细胞分群树来确定相关参数，我们这里就不做扩展了。</span></section><p><span>另外呢，在这里提前做一个预告，为了方便大家的使用呢，我们将会在下一期更新一个合集系列，将我们的单细胞推文排排顺序（虽然只有六七篇，哈哈哈）。</span><span>同时呢，我们也将会理清楚我们已有的笔记，将他们封装整理成系统的脚本，大家按照要求配置好环境后，只需要向脚本传参即可实现相关的操作，大家可以尽情期待一下</span><span>。</span></p><p><span>最后的最后，如果大家觉得我们的推文对你的单细胞学习有帮助的话，欢迎大家点赞、关注、转发，让更多的人能够看到！</span></p><section><mp-common-profile data-pluginname="mpprofile" data-id="MzkwMTIwNjg2Mw==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/VB2YS1bz3lkjExNGtFNaqDspMmibzib8FvgaFs7jqTeoNIv5Kib0dVaC9aQQAKRIoH91ynFktJzYEaZ27sLSq9bibQ/0?wx_fmt=png" data-nickname="杨小杨的科研笔记" data-alias="Starherds" data-signature="科研笔记 &amp; 读研日常" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span>文末碎碎念</span><span></span></h2><p data-tool="mdnice编辑器">那今天的分享就到这里啦！我们下期再见哟！</p><p data-tool="mdnice编辑器">最后顺便给自己推荐一下嘿嘿嘿！</p><p data-tool="mdnice编辑器">如果我的分享对你有用的话，欢迎<strong>关注点赞在看转发分享</strong>阿巴阿巴阿巴阿巴巴巴！这可是我的第一原动力！</p><section>蟹蟹你们的喜欢和支持！！！</section></section><section><mp-common-profile data-pluginname="mpprofile" data-id="Mzg5NjE1NTc1OA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLpicdicvWNnpcaTbejCVgKe4FsicHqo48FOkqJTkziaengudibCF8AW86uyjgee0pxhmhM8JoylYDkSXug/0?wx_fmt=png" data-nickname="生信小白要知道" data-alias="Bioidiot" data-signature="主打小白保姆级教程，因为自己淋过雨，所以想给大家撑把伞！ 记录从小白到现在小灰的过程，希望以后可以成为小黑！" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/uhTB7vP45eeRId0lOayAlg",target="_blank" rel="noopener noreferrer">原文链接</a>
