---
title: "小鼠的5个样品的10x技术单细胞转录组上游定量（文末赠送全套代码）"
date: 2024-07-12T00:18:31Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
小鼠的5个样品的10x技术单细胞转录组上游定量（文末赠送全套代码） by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>新鲜出炉（2023年5月）的文章：《Fueling sentinel node via reshaping cytotoxic T lymphocytes with a flex-patch for post-operative immuno-adjuvant therapy》</p></blockquote><p data-tool="mdnice编辑器">看到了一个文献，它的单细胞转录组并没有给出来表达量矩阵，仅仅是测序数据：</p><blockquote data-tool="mdnice编辑器"><p>The single-cell RNA sequencing data generated in this study have been deposited in the Sequence Read Archive database with the accession code of PRJNA853539.</p></blockquote><p data-tool="mdnice编辑器">我就去 https://www.ncbi.nlm.nih.gov/sra?linkname=bioproject_sra_all&amp;from_uid=853539 看了看：</p><p><img data-galleryid="" data-ratio="0.7431372549019608" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wylMQtHROIAzIpRk6H6skhTcibibxTBzwPhYkLVOa8bVGU4f2RK80CMc2Lm2p8ZwkxZG6nWgQ3OArjw/640?wx_fmt=png" data-type="png" data-w="1020" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wylMQtHROIAzIpRk6H6skhTcibibxTBzwPhYkLVOa8bVGU4f2RK80CMc2Lm2p8ZwkxZG6nWgQ3OArjw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>仅仅是测序数据</figcaption></figure><p data-tool="mdnice编辑器">那就很简单的了，只需要下载这些数据即可，然后走cellranger的定量流程。</p><h3 data-tool="mdnice编辑器">cellranger的定量流程详解：</h3><blockquote data-tool="mdnice编辑器"><p>正常走cellranger的定量流程即可，代码我已经是多次分享了。参考：</p></blockquote><ul data-tool="mdnice编辑器"><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247512340&amp;idx=3&amp;sn=1b9609a8870a0209dd27ffdcbc3cac87&amp;chksm=9b4bf1afac3c78b90674678fcec66365b9faaa275ff4b0a2255e0a05fa8b905e15222a643bea&amp;scene=21#wechat_redirect" data-linktype="2">10X单细胞转录组原始测序数据的Cell Ranger流程（仅需800元）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247496813&amp;idx=1&amp;sn=4151bf2265618eff4e0123722c50e569&amp;scene=21#wechat_redirect" data-linktype="2">10X的单细胞转录组原始数据也可以在EBI下载</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247510920&amp;idx=1&amp;sn=c4561d34e984406693c014cdfe236c0f&amp;chksm=9b4beb33ac3c622542d894344c323ff7cca52f69119d02fc7aa4636af0cbe7df4b6c63dd5ba9&amp;scene=21#wechat_redirect" data-linktype="2">一个10x单细胞转录组项目从fastq到细胞亚群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513565&amp;idx=1&amp;sn=092e637017d176c43f00a295d3210592&amp;scene=21#wechat_redirect" data-linktype="2">一文打通单细胞上游：从软件部署到上游分析</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513605&amp;idx=1&amp;sn=e86a329c887745c6d00d3ededa39dcda&amp;chksm=9b4bf6beac3c7fa8523cef4e7189fb20b914460ddb61e6cd1dd520b5928e1b59a8b7827ce783&amp;scene=21#wechat_redirect" data-linktype="2">PRJNA713302这个10x单细胞fastq实战</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513968&amp;idx=1&amp;sn=f5a44a7bea0bdacd8af1a20c177763e5&amp;scene=21#wechat_redirect" data-linktype="2">一次曲折且昂贵的单细胞公共数据获取与上游处理</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514146&amp;idx=1&amp;sn=b9721433d49a2d963eeaab1ad47fc91b&amp;scene=21#wechat_redirect" data-linktype="2">只能下载bam文件的10x单细胞转录组项目数据处理</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511452&amp;idx=2&amp;sn=83ec97cbc3334a6095e6d63e05e9fd6e&amp;scene=21#wechat_redirect" data-linktype="2">不知道10x单细胞转录组样品和fastq文件的对应关系</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508521&amp;idx=2&amp;sn=2cf3158e74d37b3a741908d8bfc8f02f&amp;scene=21#wechat_redirect" data-linktype="2">10X单细胞转录组测序数据的 SRA转fastq踩坑那些事</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514395&amp;idx=2&amp;sn=96c505b76ae87dd0efa737c4c44e2270&amp;scene=21#wechat_redirect" data-linktype="2">10x的单细胞转录组fastq文件的R1和R2不能弄混哦</a></section></li></ul><p data-tool="mdnice编辑器">差不多几个小时就可以完成全部的样品的cellranger的定量流程。基础知识非常重要，我们在单细胞天地多次分享过<strong>cellranger</strong>流程的笔记（2019年5月），大家可以自行前往学习，如下：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484146&amp;idx=1&amp;sn=16e09b82d048eed1ff6100b22970abd5&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(一)数据下载</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484179&amp;idx=1&amp;sn=fe84f5243a6021fe6afea128e3ac273a&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(二) cell ranger使用前注意事项</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484206&amp;idx=1&amp;sn=edeebbdd092f79361aee87e9ce086d80&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(三) Cell Ranger使用初探</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484355&amp;idx=1&amp;sn=7860fe0c46073a55d2d3700822c3103b&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(四) Cell Ranger流程概览</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484402&amp;idx=1&amp;sn=95c2be0dc6499e4b1eb9a91d79e584d1&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(五) 理解cellranger count的结果</a></section></li></ul><h3 data-tool="mdnice编辑器">安装conda</h3><p data-tool="mdnice编辑器">自己下载安装自己的conda，自己配置哈。</p><pre data-tool="mdnice编辑器"><code><span># 首先下载文件，20M/S的话需要几秒钟即可</span><br>wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh<br><span># 接下来使用bash命令来运行我们下载的文件，记得是一路yes下去</span><br>bash Miniconda3-latest-Linux-x86_64.sh <br><span>#  安装成功后需要更新系统环境变量文件</span><br><span>source</span> ~/.bashrc<br></code></pre><p data-tool="mdnice编辑器">首先如果是在中国大陆，需要设置好镜像：</p><pre data-tool="mdnice编辑器"><code>conda config --add channels https://mirrors.bfsu.edu.cn/anaconda/cloud/bioconda/<br>conda config --add channels https://mirrors.bfsu.edu.cn/anaconda/cloud/conda-forge/<br>conda config --add channels https://mirrors.bfsu.edu.cn/anaconda/pkgs/free/<br>conda config --add channels https://mirrors.bfsu.edu.cn/anaconda/pkgs/main/<br>conda config --<span>set</span> show_channel_urls yes <br></code></pre><p data-tool="mdnice编辑器">然后使用自己的conda来安装 kingfisher 软件：</p><pre data-tool="mdnice编辑器"><code>conda install mamba<br>mamba create -n kingfisher python=3.8<br>mamba init<br>mamba list<br><span># 重启terminal：</span><br>mamba activate kingfisher<br>mamba install -c bioconda kingfisher<br></code></pre><p data-tool="mdnice编辑器">然后就一行代码下载数据</p><pre data-tool="mdnice编辑器"><code>kingfisher get -p PRJNA853539  -m ena-ascp ena-ftp prefetch aws-http<br></code></pre><p data-tool="mdnice编辑器">另外，值得注意的是，因为上面的代码耗时很久，一般来说需要使用nohup包裹一下，或者说开启screen命令：</p><p data-tool="mdnice编辑器"><code>screen</code>是一个非常有用的命令行工具，它允许你在单个终端窗口中创建、使用和管理多个终端会话。这在你需要在远程服务器上运行长时间的任务或同时运行多个任务时特别有用。</p><p data-tool="mdnice编辑器">以下是一些基本的<code>screen</code>命令：</p><ol data-tool="mdnice编辑器"><li><section><code>screen</code>：启动一个新的<code>screen</code>会话。</section></li><li><section><code>screen -S &lt;session_name&gt;</code>：启动一个新的<code>screen</code>会话，并给它一个名字，这样你可以更容易地记住和引用它。</section></li><li><section><code>screen -ls</code>：列出当前所有的<code>screen</code>会话。</section></li><li><section><code>screen -r &lt;session_name&gt;</code>：恢复（重新连接到）一个已经存在的<code>screen</code>会话。</section></li><li><section><code>screen -d &lt;session_name&gt;</code>：断开一个<code>screen</code>会话。这将保持会话中的进程运行，但会话将不再显示在你的终端窗口中。</section></li></ol><p data-tool="mdnice编辑器">在一个<code>screen</code>会话中，你可以使用一些特殊的命令来管理你的会话。这些命令通常以<code>Ctrl-a</code>开始，然后跟着一个字符来执行特定的操作。例如：</p><ol data-tool="mdnice编辑器"><li><section><code>Ctrl-a c</code>：在当前<code>screen</code>会话中创建一个新的窗口。</section></li><li><section><code>Ctrl-a n</code>和<code>Ctrl-a p</code>：在当前<code>screen</code>会话的窗口之间切换。</section></li><li><section><code>Ctrl-a d</code>：断开当前<code>screen</code>会话，使其在后台运行。</section></li><li><section><code>Ctrl-a k</code>：关闭当前窗口。</section></li><li><section><code>Ctrl-a ?</code>：显示<code>screen</code>的帮助信息，列出所有可用的命令和快捷键。</section></li></ol><p data-tool="mdnice编辑器">使用<code>screen</code>命令可以让你在单个终端窗口中更有效地管理你的工作，特别是在处理远程服务器或长时间运行的任务时。有类似功能的其他工具：</p><ol data-tool="mdnice编辑器"><li><section><code>tmux</code>：这是一个非常强大的终端复用器，它提供了许多<code>screen</code>没有的功能，如窗口分割、会话管理和自定义键绑定。<code>tmux</code>的学习曲线可能比<code>screen</code>稍微陡峭一些，但一旦你习惯了它，你可能会发现它比<code>screen</code>更强大、更灵活。</section></li><li><section><code>byobu</code>：这是一个在<code>screen</code>和<code>tmux</code>之上添加了一些额外功能的包装器。它提供了一个友好的用户界面，包括状态栏和系统通知，使得管理你的终端会话更加容易。</section></li><li><section><code>dtach</code>：这是一个非常轻量级的工具，它只做一件事：分离和重新连接到终端会话。如果你不需要<code>screen</code>或<code>tmux</code>的所有额外功能，<code>dtach</code>可能是一个好选择。</section></li><li><section><code>abduco</code>：这是另一个轻量级的终端复用器，类似于<code>dtach</code>，但提供了一些额外的功能，如会话列表和更好的终端支持。</section></li></ol><p data-tool="mdnice编辑器">这些工具都有各自的优点和缺点，所以你可能需要试用一下，看看哪一个最适合你的需求。</p><h3 data-tool="mdnice编辑器">查看10x技术单细胞转录组上游测序数据并且定量</h3><p data-tool="mdnice编辑器">前面的kingfisher下载了PRJNA853539里面的小鼠的5个样品的10x技术单细胞转录组上游测序数据，如下所示：</p><pre data-tool="mdnice编辑器"><code> ls -lh *z|cut -d<span>" "</span> -f 5-<br>4.5G 6月  21 17:35 SRR19904954_1.fastq.gz<br> 11G 6月  21 17:47 SRR19904954_2.fastq.gz<br>4.7G 6月  21 17:50 SRR19904955_1.fastq.gz<br> 11G 6月  21 17:58 SRR19904955_2.fastq.gz<br>5.3G 6月  21 18:08 SRR19904956_1.fastq.gz<br> 13G 6月  21 18:17 SRR19904956_2.fastq.gz<br>5.2G 6月  21 18:20 SRR19904957_1.fastq.gz<br> 13G 6月  21 18:26 SRR19904957_2.fastq.gz<br>4.4G 6月  21 18:28 SRR19904958_1.fastq.gz<br> 11G 6月  21 18:37 SRR19904958_2.fastq.gz<br></code></pre><p data-tool="mdnice编辑器">这些文件名字是需要改名的。。。。如果你熟悉10x单细胞转录组数据，就知道：</p><ul data-tool="mdnice编辑器"><li><section>首先，1-26个cycle就是测序得到了26个碱基，先是16个Barcode碱基，然后是10个UMI碱基；通常是R1文件</section></li><li><section>然后，27-34这8个cycle得到了8个碱基，就是i7的sample index；通常是I1文件</section></li><li><section>最后35-132个cycle得到了98个碱基，就是转录本reads（目前很多测序仪都是150bp了），通常是R2文件</section></li></ul><p data-tool="mdnice编辑器">也就是说R2 文件是真正的测序reads，肯定是文件最大。而且I1文件是可以省略的。。。</p><pre data-tool="mdnice编辑器"><code>ls *gz|cut -d<span>"_"</span> -f1 |sort -u | <span>while</span> <span>read</span> id ;<span>do</span>   <br>mv <span>${id}</span>_1*.gz <span>${id}</span>_S1_L001_R1_001.fastq.gz;<br>mv <span>${id}</span>_2*.gz <span>${id}</span>_S1_L001_R2_001.fastq.gz;<br><span>done</span><br></code></pre><p data-tool="mdnice编辑器">简单的修改名字后，如下所示：</p><pre data-tool="mdnice编辑器"><code>ls -lh *z|cut -d<span>" "</span> -f 5-<br>4.5G 6月  21 17:35 SRR19904954_S1_L001_R1_001.fastq.gz<br> 11G 6月  21 17:47 SRR19904954_S1_L001_R2_001.fastq.gz<br>4.7G 6月  21 17:50 SRR19904955_S1_L001_R1_001.fastq.gz<br> 11G 6月  21 17:58 SRR19904955_S1_L001_R2_001.fastq.gz<br>5.3G 6月  21 18:08 SRR19904956_S1_L001_R1_001.fastq.gz<br> 13G 6月  21 18:17 SRR19904956_S1_L001_R2_001.fastq.gz<br>5.2G 6月  21 18:20 SRR19904957_S1_L001_R1_001.fastq.gz<br> 13G 6月  21 18:26 SRR19904957_S1_L001_R2_001.fastq.gz<br>4.4G 6月  21 18:28 SRR19904958_S1_L001_R1_001.fastq.gz<br> 11G 6月  21 18:37 SRR19904958_S1_L001_R2_001.fastq.gz<br></code></pre><h3 data-tool="mdnice编辑器">然后配置cellranger的定量流程</h3><blockquote data-tool="mdnice编辑器"><p>正常走cellranger的定量流程即可，代码我已经是多次分享了。参考：</p></blockquote><ul data-tool="mdnice编辑器"><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247512340&amp;idx=3&amp;sn=1b9609a8870a0209dd27ffdcbc3cac87&amp;chksm=9b4bf1afac3c78b90674678fcec66365b9faaa275ff4b0a2255e0a05fa8b905e15222a643bea&amp;scene=21#wechat_redirect" data-linktype="2">10X单细胞转录组原始测序数据的Cell Ranger流程（仅需800元）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247496813&amp;idx=1&amp;sn=4151bf2265618eff4e0123722c50e569&amp;scene=21#wechat_redirect" data-linktype="2">10X的单细胞转录组原始数据也可以在EBI下载</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247510920&amp;idx=1&amp;sn=c4561d34e984406693c014cdfe236c0f&amp;chksm=9b4beb33ac3c622542d894344c323ff7cca52f69119d02fc7aa4636af0cbe7df4b6c63dd5ba9&amp;scene=21#wechat_redirect" data-linktype="2">一个10x单细胞转录组项目从fastq到细胞亚群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513565&amp;idx=1&amp;sn=092e637017d176c43f00a295d3210592&amp;scene=21#wechat_redirect" data-linktype="2">一文打通单细胞上游：从软件部署到上游分析</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513605&amp;idx=1&amp;sn=e86a329c887745c6d00d3ededa39dcda&amp;chksm=9b4bf6beac3c7fa8523cef4e7189fb20b914460ddb61e6cd1dd520b5928e1b59a8b7827ce783&amp;scene=21#wechat_redirect" data-linktype="2">PRJNA713302这个10x单细胞fastq实战</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513968&amp;idx=1&amp;sn=f5a44a7bea0bdacd8af1a20c177763e5&amp;scene=21#wechat_redirect" data-linktype="2">一次曲折且昂贵的单细胞公共数据获取与上游处理</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514146&amp;idx=1&amp;sn=b9721433d49a2d963eeaab1ad47fc91b&amp;scene=21#wechat_redirect" data-linktype="2">只能下载bam文件的10x单细胞转录组项目数据处理</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511452&amp;idx=2&amp;sn=83ec97cbc3334a6095e6d63e05e9fd6e&amp;scene=21#wechat_redirect" data-linktype="2">不知道10x单细胞转录组样品和fastq文件的对应关系</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508521&amp;idx=2&amp;sn=2cf3158e74d37b3a741908d8bfc8f02f&amp;scene=21#wechat_redirect" data-linktype="2">10X单细胞转录组测序数据的 SRA转fastq踩坑那些事</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514395&amp;idx=2&amp;sn=96c505b76ae87dd0efa737c4c44e2270&amp;scene=21#wechat_redirect" data-linktype="2">10x的单细胞转录组fastq文件的R1和R2不能弄混哦</a></section></li></ul><p data-tool="mdnice编辑器">差不多几个小时就可以完成全部的样品的cellranger的定量流程。基础知识非常重要，我们在单细胞天地多次分享过<strong>cellranger</strong>流程的笔记（2019年5月），大家可以自行前往学习，如下：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484146&amp;idx=1&amp;sn=16e09b82d048eed1ff6100b22970abd5&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(一)数据下载</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484179&amp;idx=1&amp;sn=fe84f5243a6021fe6afea128e3ac273a&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(二) cell ranger使用前注意事项</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484206&amp;idx=1&amp;sn=edeebbdd092f79361aee87e9ce086d80&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(三) Cell Ranger使用初探</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484355&amp;idx=1&amp;sn=7860fe0c46073a55d2d3700822c3103b&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(四) Cell Ranger流程概览</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484402&amp;idx=1&amp;sn=95c2be0dc6499e4b1eb9a91d79e584d1&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(五) 理解cellranger count的结果</a></section></li></ul><p data-tool="mdnice编辑器">理论上应该是去10x的官网下载cellranger软件和数据库文件，不过我们的共享服务器已经给大家准备了，在 /home/data/refdir/10x 文件夹里面</p><pre data-tool="mdnice编辑器"><code>ls -lh  /home/data/refdir/10x |cut -d<span>" "</span> -f 5-<br><br>391M 8月   8  2022 cellranger-6.0.1.tar.gz<br> 11G 8月   7  2022 refdata-gex-GRCh38-2020-A.tar.gz<br>9.9G 8月   7  2022 refdata-gex-GRCh38-and-mm10-2020-A.tar.gz<br>9.7G 8月   7  2022 refdata-gex-mm10-2020-A.tar.gz<br></code></pre><p data-tool="mdnice编辑器">在Linux中，你可以使用<code>tar</code>命令来解压一个<code>.tar.gz</code>文件，并将解压后的文件放到指定的文件夹。以下是具体的命令：</p><pre data-tool="mdnice编辑器"><code><br>tar -xzvf file.tar.gz -C /path/to/directory<br></code></pre><p data-tool="mdnice编辑器">在这个命令中：</p><ul data-tool="mdnice编辑器"><li><section><code>x</code>代表解压</section></li><li><section><code>z</code>代表gzip，表示文件是gzip格式的，需要进行解压</section></li><li><section><code>v</code>代表verbose，表示显示详细的解压过程</section></li><li><section><code>f</code>代表file，表示后面跟的是要解压的文件名</section></li><li><section><code>-C</code>代表change to directory，表示解压后的文件将被放到后面指定的目录</section></li></ul><p data-tool="mdnice编辑器">请将<code>file.tar.gz</code>替换为你的文件名，将<code>/path/to/directory</code>替换为你想要放置解压后文件的目录。</p><p data-tool="mdnice编辑器">那么，我们的命令就是：</p><pre data-tool="mdnice编辑器"><code>mkdir raw run soft <br>mv *gz raw<br>tar -xzvf /home/data/refdir/10x/cellranger-6.0.1.tar.gz  -C ./soft<br>tar -xzvf /home/data/refdir/10x/refdata-gex-mm10-2020-A.tar.gz  -C ./soft<br></code></pre><p data-tool="mdnice编辑器">值得注意的是<code>cellranger</code>是一直在更新的，所以推荐去官网下载最新版，这里<code>cellranger</code>的下载链接会失效 ，需要去官网获取：https://support.10xgenomics.com/single-cell-gene-expression/software/downloads/latest</p><p data-tool="mdnice编辑器">有了10x的官网下载cellranger软件和数据库文件，以及前面的kingfisher下载了PRJNA853539里面的小鼠的5个样品的10x技术单细胞转录组上游测序数据，接下来就可以跑cellranger啦，因为是共享服务器，如果不着急的话，可以一个个样品慢慢跑代码。也可以5个样品一起运行：</p><pre data-tool="mdnice编辑器"><code>ref=../soft/refdata-gex-mm10-2020-A/<br>cellranger=../soft/cellranger-7.1.0/cellranger<br>ls ../raw/*gz|cut -d<span>"_"</span> -f 1 |sort -u|cut -d<span>"/"</span> -f 3 | cut -d <span>"_"</span> -f 1 | uniq | <span>while</span> <span>read</span> id;<span>do</span><br>nohup <span>$cellranger</span> count --id=<span>$id</span> \<br>--transcriptome=<span>$ref</span> \<br>--fastqs=../raw \<br>--sample=<span>$id</span> \<br>--nosecondary \<br>--localcores=4 \<br>--localmem=30 &amp;<br><span>done</span><br></code></pre><p data-tool="mdnice编辑器">因为是5个样品一起运行，所以每个样品耗时三五个小时，合起来也是四五个小时就足够啦。虽然说5个样品一起运行会很快，但是大家的CPU和内存可能会不够，如果是共享服务器或者云服务器，另外一个门槛是硬盘。。。。</p><p data-tool="mdnice编辑器">有可能是硬盘也不够哦。。。。如果是这样的话，上面的代码大家千万不要添加 nohup  ，应该是把上面的代码写入脚本后一个个运行。</p><p data-tool="mdnice编辑器">然后简单的整理一下结果矩阵和报表即可：</p><pre data-tool="mdnice编辑器"><code>pro=outputs<br>pro_folder=<span>$pro</span><br>mkdir -p <span>$pro_folder</span><br>ls -lh  <span>$pro_folder</span><br> <br>mkdir -p <span>$pro_folder</span>/html <br>ls */outs/web_summary.html |<span>while</span> <span>read</span> id;<span>do</span> (cp <span>$id</span> <span>$pro_folder</span>/html/<span>${id%%/*}</span>.html );<span>done</span><br><br>mkdir -p <span>$pro_folder</span>/matrix <br>ls -d */outs/filtered_feature_bc_matrix |<span>while</span> <span>read</span> id;<span>do</span> (cp -r  <span>$id</span> <span>$pro_folder</span>/matrix/<span>${id%%/*}</span> );<span>done</span><br></code></pre><p data-tool="mdnice编辑器">很容易拿到了小鼠的5个样品的10x技术单细胞转录组上游定量后的表达量矩阵文件和报表，如下所示：</p><pre data-tool="mdnice编辑器"><code>$ tree -h outputs/<br>[ 128]  outputs/<br>├── [ 224]  html<br>│   ├── [2.0M]  SRR19904954.html<br>│   ├── [2.0M]  SRR19904955.html<br>│   ├── [2.1M]  SRR19904956.html<br>│   ├── [2.0M]  SRR19904957.html<br>│   └── [2.1M]  SRR19904958.html<br>└── [ 224]  matrix<br>    ├── [ 160]  SRR19904954<br>    │   ├── [ 46K]  barcodes.tsv.gz<br>    │   ├── [284K]  features.tsv.gz<br>    │   └── [ 73M]  matrix.mtx.gz<br>    ├── [ 160]  SRR19904955<br>    │   ├── [ 50K]  barcodes.tsv.gz<br>    │   ├── [284K]  features.tsv.gz<br>    │   └── [ 76M]  matrix.mtx.gz<br>    ├── [ 160]  SRR19904956<br>    │   ├── [ 47K]  barcodes.tsv.gz<br>    │   ├── [284K]  features.tsv.gz<br>    │   └── [ 74M]  matrix.mtx.gz<br>    ├── [ 160]  SRR19904957<br>    │   ├── [ 33K]  barcodes.tsv.gz<br>    │   ├── [284K]  features.tsv.gz<br>    │   └── [ 59M]  matrix.mtx.gz<br>    └── [ 160]  SRR19904958<br>        ├── [ 49K]  barcodes.tsv.gz<br>        ├── [284K]  features.tsv.gz<br>        └── [ 82M]  matrix.mtx.gz<br></code></pre><p data-tool="mdnice编辑器">全部的表达量矩阵在outputs下面的matrix文件夹，而报表在outputs下面的html文件夹，后续只需要简单的读取即可。大约200行代码需要预先熟悉一下：</p><pre data-tool="mdnice编辑器"><code><span>## </span><br><span>### ---------------</span><br><span>###</span><br><span>### Create: Jianming Zeng</span><br><span>### Date:  2023-01-16 20:53:22</span><br><span>### Email: jmzeng1314@163.com</span><br><span>### Blog: http://www.bio-info-trainee.com/</span><br><span>### Forum:  http://www.biotrainee.com/thread-1376-1-1.html</span><br><span>### CAFS/SUSTC/Eli Lilly/University of Macau</span><br><span>### Update Log: 2023-01-16  First version </span><br><span>###</span><br><span>### ---------------</span><br><br><br>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>) <br><span>source</span>(<span>'scRNA_scripts/lib.R'</span>)<br><br><span>###### step1:导入数据 ######   </span><br><span># 付费环节 800 元人民币</span><br> <br>dir=<span>'outputs/matrix/'</span> <br>samples=list.files( dir )<br>samples<br><br><span># samples = head(samples,10) </span><br>sceList = lapply(samples,<span>function</span>(pro){ <br>  <span># pro=samples[1] </span><br>  print(pro)  <br>  sce =CreateSeuratObject(counts =  Read10X(file.path(dir,pro )) ,<br>                          project = gsub(<span>'^GSM[0-9]*_'</span>,<span>''</span>,pro)  ,<span># pro, #</span><br>                          min.cells = <span>5</span>,<br>                          min.features = <span>500</span> )<br>  <span>return</span>(sce)<br>})<br>names(sceList) <br><br><span># gsub('^GSM[0-9]*','',samples)</span><br>sce.all=merge(x=sceList[[<span>1</span>]],<br>              y=sceList[ -<span>1</span> ],<br>              add.cell.ids =  gsub(<span>'^GSM[0-9]*_'</span>,<span>''</span>,samples)    )<br><span># gsub('_gene_cell_exprs_table.txt.gz','',</span><br><span>#      gsub('^GSM[0-9]*_','',samples) )  </span><br><br>as.data.frame(sce.all@assays$RNA@counts[<span>1</span>:<span>10</span>, <span>1</span>:<span>2</span>])<br>head(sce.all@meta.data, <span>10</span>)<br>table(sce.all$orig.ident) <br><br><br><span># 分组信息，通常是隐含在文件名，样品名字里面</span><br><span># phe=str_split( colnames(sce.all),'[-_]',simplify = T)</span><br><span># head(phe)</span><br><span># table(phe[,1])</span><br><span># sce.all$group= phe[,1]</span><br><br><span>#sce.all$group=toupper( substring(colnames(sce.all),1,5))</span><br><span># sce.all@meta.data$group =  ifelse(grepl('ne',sce.all$orig.ident),'ne','e')</span><br><span># sce.all$group=  gsub( '^[0-9]*_' ,'',sce.all$orig.ident) </span><br><span># sce.all$group = sce.all$orig.ident</span><br><span>#table(sce.all@meta.data$group)</span><br>table(sce.all@meta.data$orig.ident)<br><br><br><span>###### step2:QC质控 ######</span><br>dir.create(<span>"./1-QC"</span>)<br>setwd(<span>"./1-QC"</span>)<br><span># 如果过滤的太狠，就需要去修改这个过滤代码</span><br><span>source</span>(<span>'../scRNA_scripts/qc.R'</span>)<br>sce.all.filt = basic_qc(sce.all)<br>print(dim(sce.all))<br>print(dim(sce.all.filt))<br>setwd(<span>'../'</span>)<br><br><br>sp=<span>'mouse'</span><br><br><span>###### step3: harmony整合多个单细胞样品 ######</span><br>dir.create(<span>"2-harmony"</span>)<br>getwd()<br>setwd(<span>"2-harmony"</span>)<br><span>source</span>(<span>'../scRNA_scripts/harmony.R'</span>)<br><span># 默认 ScaleData 没有添加"nCount_RNA", "nFeature_RNA"</span><br><span># 默认的代码都是可以自由修改的，需要对全部的代码有基本的认识。</span><br>sce.all.int = run_harmony(sce.all.filt)<br>setwd(<span>'../'</span>)<br><br><span>###### step4: 降维聚类分群和看标记基因库 ######</span><br><span># 原则上分辨率是需要自己肉眼判断，取决于个人经验</span><br><span># 为了省力，我们直接看  0.1和0.8即可</span><br>table(Idents(sce.all.int))<br>table(sce.all.int$seurat_clusters)<br>table(sce.all.int$RNA_snn_res.0.1) <br>table(sce.all.int$RNA_snn_res.0.8) <br><br>getwd()<br>dir.create(<span>'check-by-0.1'</span>)<br>setwd(<span>'check-by-0.1'</span>)<br>sel.clust = <span>"RNA_snn_res.0.1"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br>dir.create(<span>'check-by-0.8'</span>)<br>setwd(<span>'check-by-0.8'</span>)<br>sel.clust = <span>"RNA_snn_res.0.8"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br>last_markers_to_check<br><br><br><span>###### step5: 确定单细胞亚群生物学名字 ######</span><br><span># 一般来说，为了节省工作量，我们选择0.1的分辨率进行命名</span><br><span># 因为命名这个步骤是纯人工 操作</span><br><span># 除非0.1确实分群太粗狂了，我们就选择0.8 </span><br><span>source</span>(<span>'scRNA_scripts/lib.R'</span>)<br><span># sce.all.int = readRDS('2-harmony/sce.all_int.rds')</span><br><span># sp='mouse'</span><br>colnames(sce.all.int@meta.data) <br>table(sce.all.int$RNA_snn_res.0.8)<br><br><span># keratinocyte：SFN</span><br><span>#melanocyte1 "MLANA" </span><br>selected_genes=c(<span>'MUC4'</span>, <span>'PI3'</span>, <span>'SIX3'</span>, <span># nose</span><br>                 <span>'SCGB1A1'</span>, <span>'TFF3'</span>,   <span>'KRT1'</span>,   <span>'KRT10'</span>,    <br>                 <span>'KRT5'</span>, <span>'TP63'</span>,   <span>'DLK2'</span>,<br>                 <span>'MKI67'</span>, <span>'TOP2A'</span>, <span>'CDC20'</span> ,<br>                 <span>'DMD'</span>,<span>'PUS7'</span>,<span>'PGAP1'</span>,<span>'IFI44L'</span>,<span>"MLANA"</span> ,<span>'SFN'</span>,<br>                 <span>'MUC5AC'</span> , <span>'MUC5B'</span>,<span># secretory cells</span><br>                 <span>'FOXJ1'</span>, <span>'TPPP3'</span>,  <span>'SNTN'</span>,  <span># multiciliated cells </span><br>                 <span>'DEUP1'</span>, <span>'FOXN4'</span>,  <span>'CDC20B'</span> <span># deuterosomal cells</span><br>)<br><span># p1 &lt;- DotPlot(sce.all.int, features = unique(str_to_upper(selected_genes)),</span><br><span>#               assay='RNA' ,group.by = 'RNA_snn_res.0.8'  )  + coord_flip() # +th</span><br><span># </span><br><span># p1</span><br><br>gplots::balloonplot(table(sce.all.int$RNA_snn_res.0.8,sce.all.int$orig.ident))<br><br><span># 前面的出图需要仔细看</span><br><span># 理论上可以把细胞周期回归掉</span><br><span># 也可以把文库大小回归掉</span><br><br><span># 付费环节 800 元人民币</span><br><span># 纯手工操作，非常耗时耗力</span><br><span># 这个时候可以自由选择不同的分辨率</span><br><span># 一般来说，为了偷懒就选择0.1的分辨率，但是不建议</span><br><span># 如果是自己的项目，建议起码选择0.8分辨率以上。</span><br><span># 会有不同的结果，但是影响不大。</span><br><br><span>if</span>(<span>F</span>){<br>  sce.all.int<br>  celltype=data.frame(ClusterID=<span>0</span>:<span>10</span> ,<br>                      celltype= <span>0</span>:<span>10</span>) <br>  <span>#定义细胞亚群        </span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>,<span>5</span> ),<span>2</span>]=<span>'Bcells'</span> <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>4</span> ),<span>2</span>]=<span>'plasma'</span>   <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>6</span>,<span>8</span>,<span>10</span> ),<span>2</span>]=<span>'myeloids'</span>   <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>1</span>,<span>9</span> ),<span>2</span>]=<span>'cd4_conv_Tcells'</span> <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>2</span> ),<span>2</span>]=<span>'cd8_Tcells'</span>   <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>3</span> ),<span>2</span>]=<span>'cd4_Treg_Tcells'</span> <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>7</span> ),<span>2</span>]=<span>'NK'</span>     <br>  <br>  head(celltype)<br>  celltype<br>  table(celltype$celltype)<br>  sce.all.int@meta.data$celltype = <span>"NA"</span><br>  <br>  <span>for</span>(i <span>in</span> <span>1</span>:nrow(celltype)){<br>    sce.all.int@meta.data[which(sce.all.int@meta.data$RNA_snn_res.0.1 == celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]}<br>  Idents(sce.all.int)=sce.all.int$celltype<br>  <br>  sel.clust = <span>"celltype"</span><br>  sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>  table(sce.all.int@active.ident) <br>  <br>  dir.create(<span>'check-by-celltype'</span>)<br>  setwd(<span>'check-by-celltype'</span>)<br>  <span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>  setwd(<span>'../'</span>) <br>  getwd()<br>}<br><br>phe=sce.all.int@meta.data<br>save(phe,file = <span>'phe.Rdata'</span>) <br></code></pre><p data-tool="mdnice编辑器">这个代码并不是最终的解决方案，仅仅是方便快速查看一个单细胞转录组项目而已，因为就耗时十分钟不到就可以出几十张图表，很方便的了解一个单细胞转录组项目的基本情况。而且我们也使用了这个代码处理了成百上千的公共数据集。可以看到基本上是就跟文章一模一样了:</p><p><img data-galleryid="" data-ratio="0.5583333333333333" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wylMQtHROIAzIpRk6H6skhTcNicbibwibJXiaADXGKiaM5u0U6Q6EUVxCFpCc8jB7C8cEYJpCebGha69sw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wylMQtHROIAzIpRk6H6skhTcNicbibwibJXiaADXGKiaM5u0U6Q6EUVxCFpCc8jB7C8cEYJpCebGha69sw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>基本上是就跟文章一模一样了</figcaption></figure><p data-tool="mdnice编辑器">有了这样的快速认知，后续就可以很容易的去深度解析这个数据集，进而复用它。如果你也想完成这个文章的单细胞环节的复现：《Fueling sentinel node via reshaping cytotoxic T lymphocytes with a flex-patch for post-operative immuno-adjuvant therapy》小鼠的5个样品的10x技术单细胞转录组上游定量，你首先需要服务器，如果你比较拮据，大概率是没办法自己采购自己的实体机服务器，可以去排队：<a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247522831&amp;idx=2&amp;sn=1744efdf428465425a145ff3a982198b&amp;chksm=9b4bdab4ac3c53a28fbecbbff4f254f470b54a7a20468bb753b295b930315e1ec45bcbabc10b&amp;scene=21#wechat_redirect" data-linktype="2">144线程640Gb内存服务器共享一年仍然是仅需800</a></p><p data-tool="mdnice编辑器">如果你仅仅是需要下游数据分析，理论上使用我们的代码即可，而且我们也在这个教程里面把定量弄好了，给大家矩阵和代码，打包成为文件夹，并且压缩成为了2023-PRJNA853539-mice_4t1_10x.zip ，这个约400M的压缩包。如果你需要它，稍微有一点门槛。（转发这个推文，并且转发的时候说：<strong>我需要单细胞代码</strong>）然后添加我们的“生信树”微信号去简单的审核即可，一般来说，一个小时内批量审核就会发给大家这个约400M的压缩包2023-PRJNA853539-mice_4t1_10x.zip ，理论上你解压后就可以无缝连接的完成一个单细胞转录组的基本流程啦，降维聚类分群和生物学命名。。。</p></section><p><span><span>还等什么呢，赶快扫描下面二维码添加微信领取代码吧！</span><span> <span>（需要转发这个推文，并且转发的时候说：</span><strong>我需要单细胞代码</strong><span>）</span></span><br></span></p><p data-tool="mdnice编辑器"><br></p><section><span>（添加好友务必备注 高校或者<strong>工作单位+姓名+单细胞</strong>，方便后续认识）</span></section><p><img data-ratio="1.1700680272108843" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxvmNvIclfRGEpWuxOMxdq2rJV1jmplnEuXDDDPfEsMLbHvLCWVX4uFobR9uj6JQfxMysCQyyK9wg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="294" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxvmNvIclfRGEpWuxOMxdq2rJV1jmplnEuXDDDPfEsMLbHvLCWVX4uFobR9uj6JQfxMysCQyyK9wg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/hPOnfJzT147nL1sUPCqy0w",target="_blank" rel="noopener noreferrer">原文链接</a>
