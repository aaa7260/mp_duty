---
title: "转录组数据提取技巧汇总"
date: 2024-07-22T07:49:44Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
转录组数据提取技巧汇总 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><span><strong>数据整理是数据分析的前提，而数据的正确提取则是数据整理的前提。</strong></span></p><p data-tool="mdnice编辑器">这次曾老师交代了一个作业，希望对两个GEO转录组的数据(GSE216943, GSE236049)进行差异分析。</p><p data-tool="mdnice编辑器">从GEO数据库中可以发现，这两个数据集都需要下载研究者整理好的原始数据进行整合。</p><h4 data-tool="mdnice编辑器"><span></span>GSE216943数据集：<span></span></h4><figure data-tool="mdnice编辑器"><img data-imgfileid="100000503" data-ratio="1.0562700964630225" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRwEkB4ggeUmfNrUfZ0pVySN719sx08fTE48z3UOGt5v8F34YARsEZHw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="622" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRwEkB4ggeUmfNrUfZ0pVySN719sx08fTE48z3UOGt5v8F34YARsEZHw/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>GSE236049数据集：<span></span></h4><figure data-tool="mdnice编辑器"><img data-imgfileid="100000502" data-ratio="0.5586319218241043" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRZiaarHFh4tWbmrU7stlhicNicicBv3Ria5q2sjDJeBMrbYF2m1DcgOJWXYA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="614" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRZiaarHFh4tWbmrU7stlhicNicicBv3Ria5q2sjDJeBMrbYF2m1DcgOJWXYA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">针对GSE216943数据集，我仅下载了count数据，然后循环读取(如下是其中一个count文件的样式，里边的列名是id和样本名称)</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100000504" data-ratio="0.44722222222222224" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRtliaMLOmnzdC1m872esALgoMvyBj3EicKMrhEBMeDAYSHTibvcvKov0uQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRtliaMLOmnzdC1m872esALgoMvyBj3EicKMrhEBMeDAYSHTibvcvKov0uQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">然而针对GSE236049数据集，我发现研究者把文件整理的很棒，但是对于生信菜鸟的我有点不知道怎么合理的读取并处理信息(如下是其中一个文件，里边有基因名称，FPKM,TPM等值)。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100000505" data-ratio="0.4722222222222222" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRF7enWVvEUTarXGccbFNu2kChVsgUAich7NCzhic71ibMOfq9Zwia94KztA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRF7enWVvEUTarXGccbFNu2kChVsgUAich7NCzhic71ibMOfq9Zwia94KztA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">没办法，只好去向曾老师求助了hhhh 。曾老师立刻发给我了一份其他高手处理的流程6666666。最后这位高手的代码也解决了困扰我的问题。</p><p data-tool="mdnice编辑器">为此，我也顺便把多种提取转录组数据的方法整理了一下，以供大家参考。</p><h3 data-tool="mdnice编辑器"><span></span>转录组数据提取技巧汇总<span></span></h3><p data-tool="mdnice编辑器">提取数据前，我们都需要注意获得的数据是count还是tpm数据(首选count数据），只有这两种格式的可以进行差异分析。其他类型的数据如log2cpm，fpkm，rpkm在进行差异表达分析时，需要重新修正为count或者tpm数据。</p><h4 data-tool="mdnice编辑器"><span></span>情况1.可以通过get_count_txt函数获得count数据<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(tinyarray)<br>get_count_txt(<span>"GSE242333"</span>)<br>exp = read.table(<span>"GSE242333_raw_counts_GRCh38.p13_NCBI.tsv.gz"</span>,check.names = <span>F</span>,row.names = <span>1</span>,header = <span>T</span>)<br></code></pre><p data-tool="mdnice编辑器">复制网址就可以自动下载数据，之后读取即可。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100000507" data-ratio="0.08875128998968008" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRWHXoNPPAWMQ29OOqwibuib180gacF2SiaLezQJ2QjEoswypCJGUlHDIgg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="969" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRWHXoNPPAWMQ29OOqwibuib180gacF2SiaLezQJ2QjEoswypCJGUlHDIgg/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100000508" data-ratio="0.30484988452655887" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zR26TtR5BaukpN4pVoxcwyQOJsXwJW8xKqv3teNNTcxciawhg7KowWxBw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="433" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zR26TtR5BaukpN4pVoxcwyQOJsXwJW8xKqv3teNNTcxciawhg7KowWxBw/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>情况2. 需自行下载数据，数据已经被研究者整合好了<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#下载后直接读取</span><br><span>#GSE121949</span><br>a = read.delim(<span>"GSE121949_RNAseq_Raw_and_RPKM.txt"</span>)<br><span>#GSE235017</span><br>dat = data.table::fread(<span>"GSE235017_ref_trans_full_table.txt"</span>,check.names = <span>F</span>, header = <span>T</span>)<br></code></pre><figure data-tool="mdnice编辑器"><br></figure><p><img data-galleryid="" data-imgfileid="100000522" data-ratio="0.2740740740740741" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRP02Pu1TvBYtDlicmhyS9vHdeBkmmgGicJL5g5gOKFtAhib2f5MSczlKww/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRP02Pu1TvBYtDlicmhyS9vHdeBkmmgGicJL5g5gOKFtAhib2f5MSczlKww/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p><img data-galleryid="" data-imgfileid="100000523" data-ratio="0.3685185185185185" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRmhzsgPaCynny0DJ1YAibAkpUKCibJwKwVzuqLqqBlykXcfriamu6L3GNg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRmhzsgPaCynny0DJ1YAibAkpUKCibJwKwVzuqLqqBlykXcfriamu6L3GNg/640?wx_fmt=png&amp;from=appmsg"></p><h4 data-tool="mdnice编辑器"><span></span>情况3. 原始数据可直接循环读取合并<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>file_directory = <span>"~/desktop/training/GSE216943_RAW"</span><br>fs=list.files(file_directory)<br>dat = do.call(cbind,lapply(fs, <span>function</span>(x){<br>  read.table(file.path(file_directory,x),<br>             header = <span>T</span>,sep = <span>'\t'</span>,row.names = <span>1</span>,quote = <span>""</span>)<br>}))<br>dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br></code></pre><p data-tool="mdnice编辑器">GSE216943数据集中的其中一个样本文件</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100000512" data-ratio="0.44722222222222224" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRtliaMLOmnzdC1m872esALgoMvyBj3EicKMrhEBMeDAYSHTibvcvKov0uQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRtliaMLOmnzdC1m872esALgoMvyBj3EicKMrhEBMeDAYSHTibvcvKov0uQ/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>情况4. Affymetrix的CEL文件读取合并及处理<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#BiocManager::install("affy")</span><br><span>library</span>(affy)<br>dir_cels=<span>'~/Desktop/GSE29330/GSE29330_RAW'</span><br>affy_data = ReadAffy(celfile.path=dir_cels)<br>eSet = rma(affy_data) <span>#rma函数去normalization</span><br><span>##要进行过滤</span><br>calls = mas5calls(affy_data) <span># get PMA calls</span><br>calls = exprs(calls)<br>absent = rowSums(calls == <span>'A'</span>) <span># how may samples are each gene 'absent' in all samples</span><br>absent = which(absent == ncol(calls)) <span># which genes are 'absent' in all samples</span><br>eSet = eSet[-absent,] <span># filters out the genes 'absent' in all samples</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000514" data-ratio="0.887987012987013" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRghq7LeEovox5ybY9rGjlNd1icKhyVJah8sUnn0BiaejGvKqibiaa4t9dBg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="616" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRghq7LeEovox5ybY9rGjlNd1icKhyVJah8sUnn0BiaejGvKqibiaa4t9dBg/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>情况5. 数据需要自行下载，并且文件内容中没有样本信息<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#代码来自 艾迪</span><br><span># 读取文件信息</span><br>exp.dirs&lt;-list.files(<span>"data/GSE236049_RAW/"</span>,full.names = <span>T</span>) <span>#读取完整文件及子文件路径信息</span><br>exp.names&lt;-list.files(<span>"data/GSE236049_RAW/"</span>) <span>#读取子文件的名称信息(区别在于full.name是否为T)</span><br><span>#提取样本名称信息</span><br><span>#需要提取的名称信息应根据实际情况而定</span><br>DirInfor &lt;- stringr::str_split(exp.names,<span>"_"</span>,n = <span>Inf</span>, simplify = <span>T</span>)%&gt;%<br>            as.data.frame()<br><span>#清洗raw文件并合并</span><br>expList &lt;- mapply(<span>function</span>(sampleDir, sampleName) {<br>    df1 &lt;- data.table::fread(sampleDir, data.table = <span>F</span>) %&gt;%  <br>    dplyr::select(<span>"Gene Name"</span>, <span>"FPKM"</span>, <span>"TPM"</span>) %&gt;% <span>#选择需要的列</span><br>    dplyr::rename(gene = <span>"Gene Name"</span>)%&gt;% <span>#重命名列</span><br>    dplyr::filter(!is.na(gene))%&gt;% <span>#过滤掉基因名为空的行</span><br>    dplyr::filter(!gene == <span>"-"</span>)%&gt;%  <span>#过滤掉基因名为 "-" 的行</span><br>    dplyr::filter(!duplicated(gene)) <span>#移除基因名重复的行</span><br>    names(df1)[<span>2</span>:<span>3</span>] &lt;- paste0(sampleName, <span>"_"</span>, names(df1)[<span>2</span>:<span>3</span>]) <span>#修改列名</span><br>    <span>return</span>(df1) }, <span>#返回处理后的列表</span><br>    sampleDir = exp.dirs, <span># 输入参数</span><br>    sampleName = DirInfor$V1, <span># 输入参数</span><br>    SIMPLIFY = <span>F</span>) <span>#结果不简化为矩阵或数组，而是保持为列表</span><br><br><span>#获取FPKM/TPM数据</span><br>exps &lt;- Reduce(<span>function</span>(x, y) merge(x, y, all = <span>TRUE</span>), expList) <br><span>#获取FPKM数据</span><br>fpkm &lt;- exps%&gt;%<br>        tibble::as_tibble()%&gt;%<br>        tibble::column_to_rownames(<span>"gene"</span>)%&gt;% <span>#将tibble的gene列转换为行名，并从数据中移除这一列</span><br>        dplyr::select(contains(<span>"FPKM"</span>))%&gt;% <span>#选择包含FPKM的列</span><br>        dplyr::rename_all(~ gsub(<span>"_FPKM"</span>, <span>""</span>, .))<br><br><span>#获取TPM数据</span><br>tpm &lt;- exps%&gt;%<br>       tibble::as_tibble()%&gt;%<br>       tibble::column_to_rownames(<span>"gene"</span>)%&gt;%<br>       dplyr::select(contains(<span>"TPM"</span>))%&gt;%<br>       dplyr::rename_all(~ gsub(<span>"_TPM"</span>, <span>""</span>, .))<br><br><span>#数据检查</span><br>tpm%&gt;%colSums()%&gt;%table()<br></code></pre><p data-tool="mdnice编辑器">类似于GSE236049数据集提供的原始数据样式</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100000515" data-ratio="0.4722222222222222" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRF7enWVvEUTarXGccbFNu2kChVsgUAich7NCzhic71ibMOfq9Zwia94KztA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRF7enWVvEUTarXGccbFNu2kChVsgUAich7NCzhic71ibMOfq9Zwia94KztA/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>情况6. 如果样本量大，原始文件中存在不想提取的数据<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#代码来自 艾迪</span><br>count.dirs&lt;-list.files(<span>"data/GSE216943_RAW/"</span>,<span>"counts"</span>,full.names = <span>T</span>) <span>#在目录下搜索包含count的文件</span><br>fpkm.dirs&lt;-list.files(<span>"data/GSE216943_RAW/"</span>,<span>"FPKM"</span>,full.names = <span>T</span>)<br><span>#读取count数据</span><br>count &lt;- lapply(count.dirs, <span>function</span>(x) df&lt;-data.table::fread(x))%&gt;%<br>         as.data.frame()%&gt;%<br>         tibble::column_to_rownames(<span>"id"</span>)%&gt;%<br>         dplyr::select(contains(<span>"NC"</span>)|contains(<span>"LPS"</span>))<br><span>#读取fpkm数据</span><br>fpkm&lt;-lapply(fpkm.dirs, <span>function</span>(x) df&lt;-data.table::fread(x))%&gt;%<br>  as.data.frame()%&gt;%<br>  tibble::column_to_rownames(<span>"id"</span>)%&gt;%<br>  dplyr::select(contains(<span>"NC"</span>)|contains(<span>"LPS"</span>))<br><span>#fpkm转换成TPM</span><br>fpkmToTpm &lt;- <span>function</span>(fpkm){(fpkm/sum(fpkm))*<span>10</span>^<span>6</span>} <span>#定义转换函数</span><br>tpm &lt;- apply(fpkm,<span>2</span>, fpkmToTpm) <span>#2的含义是针对每个样本</span><br><span>#数据检查</span><br>tpm%&gt;%colSums()%&gt;%table()<br></code></pre><p data-tool="mdnice编辑器">类似于GSE216943数据集提供的原始数据样式，假设数据集中的样本量很大的时候，我们手动勾选下载会比较麻烦。<img data-imgfileid="100000513" data-ratio="1.0562700964630225" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRwEkB4ggeUmfNrUfZ0pVySN719sx08fTE48z3UOGt5v8F34YARsEZHw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="622" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEd4Ny09G28JD3Fc9Vnv0zRwEkB4ggeUmfNrUfZ0pVySN719sx08fTE48z3UOGt5v8F34YARsEZHw/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器"><strong>小结</strong>：数据提取也不是那么容易的哦~</p><p data-tool="mdnice编辑器"><strong>致谢</strong>：感谢曾老师，艾迪，小洁老师以及生信技能树团队全体成员（部分代码来源：生信技能树马拉松和数据挖掘课程）。</p><p data-tool="mdnice编辑器"><strong>注</strong>：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(希望多多交流)。</p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/FdmfGws7CkafMXikr8pmdw",target="_blank" rel="noopener noreferrer">原文链接</a>
