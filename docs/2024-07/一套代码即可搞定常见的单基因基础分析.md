---
title: "一套代码即可搞定常见的单基因基础分析"
date: 2024-07-22T07:48:35Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
一套代码即可搞定常见的单基因基础分析 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">如何能够像网页工具一样，仅输入基因名称，通过一套代码就可以获得基因表达量在不同样本中的表达量差异图，基因表达量差异与临床病理参数之间的关系图以及表达量差异与生存的关系图呢？</p><p data-tool="mdnice编辑器"><span>生信菜鸟团既往内容链接：</span><br></p><p data-tool="mdnice编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512275&amp;idx=1&amp;sn=256979a8adce69f22329bed2227fc032&amp;chksm=fa4575eecd32fcf885905743bc89e748c4d1458651744d251de2adb1f3316efb115d8dfdae2b&amp;scene=21#wechat_redirect" textvalue="根据TMN以及stage和grade等临床信息查看TCGA的LIHC表达量矩阵的SLC25A11基因情况" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">根据TMN以及stage和grade等临床信息查看TCGA的LIHC表达量矩阵的SLC25A11基因情况</a><br></p><p data-tool="mdnice编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512281&amp;idx=1&amp;sn=f123dc68dfedfdc07f58597be70b7874&amp;chksm=fa4575e4cd32fcf2ba5e829236751aac6516285eeee65afebebd8d604fa9eae13c9e50b4d6e8&amp;scene=21#wechat_redirect" textvalue="细胞增值相关基因在任意癌症都是恶性高表达，而且预后差吧！" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">细胞增值相关基因在任意癌症都是恶性高表达，而且预后差吧！</a><br></p><p data-tool="mdnice编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512375&amp;idx=1&amp;sn=f9ab222072ebc6a9a38d91da12f70f07&amp;chksm=fa45740acd32fd1c405809a6d58105aa6e9de8295f700062afc68f7bca28e9b52e8712ebd997&amp;scene=21#wechat_redirect" textvalue="在癌症恶性高表达，而且预后差的基因那么多都值得研究吗？" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">在癌症恶性高表达，而且预后差的基因那么多都值得研究吗？</a></p><p data-tool="mdnice编辑器"><br></p><p data-tool="mdnice编辑器"><span>这次曾老师就交代了这样的作业，希望能够只输入基因名就能把A-E的图给呈现出来。</span><br></p><p data-tool="mdnice编辑器"><img data-imgfileid="100000477" data-ratio="1.3261802575107295" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtXMHicdraLicicEibOjLyicGVVXHnpo1TQeZkwXicmwOcU3Nartsd6QwiblbDA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="932" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtXMHicdraLicicEibOjLyicGVVXHnpo1TQeZkwXicmwOcU3Nartsd6QwiblbDA/640?wx_fmt=png&amp;from=appmsg">PMID：37789080<span></span></p><h1 data-tool="mdnice编辑器"><span>一、表达量分析前数据处理</span><br></h1><h1 data-tool="mdnice编辑器"></h1><ol data-tool="mdnice编辑器"><li><section>Xena下载TCGA-KIRC数据</section></li></ol><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165088996" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>rm(list=ls())<br>#打破下载时间的限制,改前60秒，改后1亿秒<br>options(timeout = 100000000) <br>options(scipen = 20)#不要以科学计数法表示<br>library(tidyverse)<br>library(data.table) <br><br>proj = "TCGA-KIRC"<br><br>#下载内容之前需要正确填写destfile的位置哦<br>if(T){<br>  download.file(url = paste0("https://gdc.xenahubs.net/download/",proj, ".htseq_counts.tsv.gz"),destfile = paste0("~/Desktop/KIRC_analysis/",proj,".htseq_counts.tsv.gz"))  ##表达数据<br>  download.file(url = paste0("https://gdc.xenahubs.net/download/",proj, ".GDC_phenotype.tsv.gz"),destfile = paste0("~/Desktop/KIRC_analysis/",proj,".GDC_phenotype.tsv.gz")) ##临床数据<br>  download.file(url = paste0("https://gdc.xenahubs.net/download/",proj, ".survival.tsv"),destfile = paste0("~/Desktop/KIRC_analysis/",proj,".survival.tsv")) ##生存数据<br>}<br><br>#读取数据<br>clinical = read.delim(paste0("~/Desktop/KIRC_analysis/",proj,".GDC_phenotype.tsv.gz"),fill = T,header = T,sep = "\t")<br>surv = read.delim(paste0("~/Desktop/KIRC_analysis/",proj,".survival.tsv"),header = T) <br>head(surv) #生存数据os和os.time<br>#1 TCGA-BP-4337-01A  1 TCGA-BP-4337       2<br>#2 TCGA-BP-4337-11A  1 TCGA-BP-4337       2<br>#3 TCGA-A3-A8CQ-01A  0 TCGA-A3-A8CQ       3<br>#4 TCGA-A3-A6NN-01A  0 TCGA-A3-A6NN       3<br>#5 TCGA-B4-5844-01A  0 TCGA-B4-5844       7<br>#6 TCGA-B4-5843-01A  0 TCGA-B4-5843      11<br></code></pre><p data-tool="mdnice编辑器">1.1 查看临床信息列名</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165088997" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>tmp = data.frame(colnames(clinical))<br>#这个环节有助于提取自己想要的数据<br></code></pre><p data-tool="mdnice编辑器">1.2 stage</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165088998" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>table(clinical$tumor_stage.diagnoses)      <br>#not reported      stage i     stage ii    stage iii     stage iv <br>#           4          481          102          237          161 <br></code></pre><p data-tool="mdnice编辑器">1.3 M分期</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165088999" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>table(clinical$pathologic_M)          <br>#     M0  M1  MX <br>#  2 794 155  34<br></code></pre><p data-tool="mdnice编辑器">1.4 T分期</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089000" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>table(clinical$pathologic_T)  <br>#T1 T1a T1b  T2 T2a T2b  T3 T3a T3b T3c  T4 <br>#37 250 205 101  15   8   7 234 102   4  22 <br></code></pre><p data-tool="mdnice编辑器">1.5 N分期</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089001" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>table(clinical$pathologic_N)    <br># N0  N1  NX <br>#446  30 509  <br></code></pre><p data-tool="mdnice编辑器">1.6 grade</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089002" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>table(clinical$neoplasm_histologic_grade) <br>#     G1  G2  G3  G4  GX <br>#  5  21 415 385 153   6 <br></code></pre><p data-tool="mdnice编辑器">2.处理表达矩阵和分组信息2.1 表达矩阵</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089003" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#dat = read.table(paste0("input/",proj,".htseq_counts.tsv.gz"),check.names = F,row.names = 1,header = T)<br>dat &lt;- data.table::fread(paste0("~/Desktop/KIRC_analysis/",proj,".htseq_counts.tsv.gz"),data.table = F) #全部是symbol<br><br>#head(dat)<br>#tail(dat)<br>a = dat[60484:60488,]<br>#dat的后五行是啥啊<br><br>#数据是log2(count+1)，因此需要逆转并cpm处理<br>dat = dat[1:60483,]<br>rownames(dat) = dat$Ensembl_ID<br>a = dat<br>a = a[,-1]<br>##逆转 log<br>a = as.matrix(2^a - 1)<br>a[1:4,1:4]<br>#                   TCGA-BP-4342-01A TCGA-A3-3387-01A TCGA-BP-4167-01A TCGA-B8-4620-01A<br>#ENSG00000000003.13             2847             2261             2170             4586<br>#ENSG00000000005.5                 2               17               10                3<br>#ENSG00000000419.11             1585             1642              979             1903<br>#ENSG00000000457.12             1372              895              457              505<br><br># 用apply转换为整数矩阵<br># 是因为后续edgeR分析时需要用到整数吗<br>exp = apply(a, 2, as.integer)<br>exp[1:4,1:4] #行名消失<br>#      TCGA-BP-4342-01A TCGA-A3-3387-01A TCGA-BP-4167-01A TCGA-B8-4620-01A<br># [1,]             2847             2260             2170             4586<br># [2,]                2               16               10                3<br># [3,]             1585             1641              979             1902<br># [4,]             1371              894              456              505<br><br>rownames(exp) = rownames(dat)<br>exp[1:4,1:4]<br>#                   TCGA-BP-4342-01A TCGA-A3-3387-01A TCGA-BP-4167-01A TCGA-B8-4620-01A<br>#ENSG00000000003.13             2847             2260             2170             4586<br>#ENSG00000000005.5                 2               16               10                3<br>#ENSG00000000419.11             1585             1641              979             1902<br>#ENSG00000000457.12             1371              894              456              505<br><br>#cpm处理<br>exp= log(edgeR::cpm(exp)+1)<br></code></pre><p data-tool="mdnice编辑器">2.2 表达矩阵行名ID转换：</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089004" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>library(stringr)<br>head(rownames(exp))<br>#[1] "ENSG00000000003.13" "ENSG00000000005.5"  "ENSG00000000419.11"<br>#[4] "ENSG00000000457.12" "ENSG00000000460.15" "ENSG00000000938.11"<br>library(AnnoProbe)<br>?annoGene<br>#怎么匹配不上呢？是因为ENSEMBL有小数？下面这句高级一点哈哈哈<br>rownames(exp) = substr(rownames(exp), 1, 15)<br>##rownames(exp) = str_split(rownames(exp),"\\.",simplify = T)[,1];head(rownames(exp))<br>#annoGene(rownames(exp),ID_type = "ENSEMBL") <br>re = annoGene(rownames(exp),ID_type = "ENSEMBL");head(re)<br>#       SYMBOL                           biotypes         ENSEMBL  chr start   end<br>#1     DDX11L1 transcribed_unprocessed_pseudogene ENSG00000223972 chr1 11869 14409<br>#2      WASH7P             unprocessed_pseudogene ENSG00000227232 chr1 14404 29570<br>#3   MIR6859-1                              miRNA ENSG00000278267 chr1 17369 17436<br>#4 MIR1302-2HG                             lncRNA ENSG00000243485 chr1 29554 31109<br>#6     FAM138A                             lncRNA ENSG00000237613 chr1 34554 36081<br>#7      OR4G4P             unprocessed_pseudogene ENSG00000268020 chr1 52473 53312<br>library(tinyarray)<br>#trans_array: transform rownames for microarray or rnaseq expression matrix<br>exp = trans_array(exp,ids = re,from = "ENSEMBL",to = "SYMBOL")<br>exp[1:4,1:4]<br>#            TCGA-BP-4342-01A TCGA-A3-3387-01A TCGA-BP-4167-01A TCGA-B8-4620-01A<br>#DDX11L1                    1                0                0                0<br>#WASH7P                    77               69               23               29<br>#MIR6859-1                  0                3                1                2<br>#MIR1302-2HG                2                0                0                0<br></code></pre><p data-tool="mdnice编辑器">2.4 保存数据</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089005" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>save(exp,proj,clinical,surv,file = paste0(proj,".Rdata"))<br></code></pre><h1 data-tool="mdnice编辑器"><span></span>二、统计学分析及样本间差异表达分析</h1><p data-tool="mdnice编辑器">1.加载数据和R包</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089006" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>rm(list = ls())<br>proj = "TCGA-KIRC"<br>load(paste0(proj,".Rdata"))<br>library(tidyr)<br>library(tibble)<br>library(ggpubr)<br>library(dplyr)<br>library(stringr)<br><br>gene = "KIFC1"<br></code></pre><p data-tool="mdnice编辑器">1.1 分组信息处理</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089007" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#根据样本ID的第14-15位，给样本分组（tumor和normal）<br>table(str_sub(colnames(exp),14,15))  <br># 01  05  11 <br>#534   1  72 <br>#这里的14-15位代表的样本的情况，其中01代表Primary Soild Tumor；05代表Additional -New Primary；11代表正常样本<br><br>Group = ifelse(as.numeric(str_sub(colnames(exp),14,15)) &lt; 10,'tumor','normal')  <br>Group = factor(Group,levels = c("normal","tumor"))<br>table(Group)<br># Group<br># normal  tumor <br>#     72    535<br></code></pre><p data-tool="mdnice编辑器">2.准备数据</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089008" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#提取想要的基因数据<br>exp_g &lt;- exp[gene,] #这里需要输入想要分析的基因<br>exp_g &lt;- as.data.frame(t(exp_g))<br><br>#准备数据<br>dat = t(exp_g) %&gt;% <br>  as.data.frame() %&gt;%  #上两步是转置信息并表格化<br>  rownames_to_column() %&gt;%  #把行名转成一列数据<br>  mutate(Group)<br>dim(dat)<br># [1] 603   3<br><br>pdat = dat%&gt;% <br>  pivot_longer(cols =(!rowname)&amp;(!Group), #除了 rowname 和 Group 之外的所有列<br>               names_to = "gene", #指定新的列名，用于存储原来列的名称<br>               values_to = "count") #指定新的列名，用于存储原来列中的值<br><br></code></pre><p data-tool="mdnice编辑器">3.正态性检验-对每一组数据进行正态性检验</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089009" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#分别提取normal和tumor数据<br>normality_N &lt;- pdat[pdat$Group == "normal",]<br>normality_T &lt;- pdat[pdat$Group == "tumor",]<br><br>#检验数据是否满足正态分布的常见方法有：<br># Shapiro-Wilk检验，Kolmogorov-Smirnov检验，Anderson-Darling检验，Lilliefors检验，Jarque-Bera检验，D'Agostino's K-squared检验<br><br>#最常用以下两种<br>#Shapiro-Wilk 正态性检验：最常用的正态性检验方法之一。适用于小样本数据(通常认为小于30)。<br>#shapiro.test(normality_N$count)<br>#shapiro.test(normality_T$count)<br><br>#Kolmogorov-Smirnov (K-S)正态性检验：这是一种基于经验分布函数的检验方法，适用于大样本数据。<br>ks.test(normality_N$count, "pnorm", mean(normality_N$count), sd(normality_N$count))<br># Exact one-sample Kolmogorov-Smirnov test<br># data:  normality_N$count<br># D = 0.16794, p-value = 0.03038<br># alternative hypothesis: two-sided<br>ks.test(normality_T$count, "pnorm", mean(normality_T$count), sd(normality_T$count))<br>#	Asymptotic one-sample Kolmogorov-Smirnov test<br># data:  normality_T$count<br># D = 0.059156, p-value = 0.0473<br># alternative hypothesis: two-sided<br>#看p值，若满足p-value&gt;0.05,则数据满足正态分布，若不满足则用非参数检验。<br>#同时我们注意到，即使是KS法对样本进行分析时，也还是会按照大样本的中样本量的多与少采取不同的分析方法“Exact”/“Asymptotic”。<br><br>#直方图<br>hist(normality_N$count, main="Histogram for frequency") #默认是probability = F, 频数直方图<br>hist(normality_N$count, main="Histogram for density", probability = T) #probability = T, 密度直方图，每个区间的频率除以该区间的宽度和总的数据点数量，从而得到密度<br>hist(normality_T$count, main="Histogram for frequency") <br>hist(normality_T$count, main="Histogram for density", probability = T) <br><br>#QQ图（Quantile-Quantile Plot）：这是一种图形方法，可以直观地检查数据是否接近正态分布。<br>#在QQ图中，如果数据点紧密地遵循参考线（45度线），则数据接近正态分布<br>qqnorm(normality_N$count)<br>qqline(normality_N$count)<br><br>qqnorm(normality_T$count)<br>qqline(normality_T$count)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000475" data-ratio="0.9053803339517625" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtvZ0OCwkmRgaOAZcQpGxRzYF5iaDSJxgzb8PkSMVp9HJ5dgzh3YSQ6fg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="539" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtvZ0OCwkmRgaOAZcQpGxRzYF5iaDSJxgzb8PkSMVp9HJ5dgzh3YSQ6fg/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100000476" data-ratio="0.9053803339517625" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHttTj76CmibnXb8muOzxjadOe5UUuHWRALaXzCrL74J28QprU2SHe1ibFg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="539" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHttTj76CmibnXb8muOzxjadOe5UUuHWRALaXzCrL74J28QprU2SHe1ibFg/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100000472" data-ratio="0.9053803339517625" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtCADxrlY3ECcOT1nxYpuO8RWL5SbvpKiczG5xap5arRHas75DxbAIubA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="539" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtCADxrlY3ECcOT1nxYpuO8RWL5SbvpKiczG5xap5arRHas75DxbAIubA/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100000473" data-ratio="0.9053803339517625" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtfcJOdRtUW1GPGj0vFGNTXtOB2YQLiaiaM8sfiaG4RLvbIxy8eyDQ2Z3Gw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="539" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtfcJOdRtUW1GPGj0vFGNTXtOB2YQLiaiaM8sfiaG4RLvbIxy8eyDQ2Z3Gw/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100000474" data-ratio="0.9053803339517625" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtndBXUu98AiarNvxLticbOWlCib0mkQA46gNYQAnPOy7QFHsXZ1x43FWbQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="539" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtndBXUu98AiarNvxLticbOWlCib0mkQA46gNYQAnPOy7QFHsXZ1x43FWbQ/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100000478" data-ratio="0.9053803339517625" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtbDLOWHUfAngFZT3m9RWdkV6sIWEdkwmkb7zHxB0ftIW4S5KCglzx1w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="539" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtbDLOWHUfAngFZT3m9RWdkV6sIWEdkwmkb7zHxB0ftIW4S5KCglzx1w/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">4.方差齐性检验</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089010" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#方差性（方差齐性）的检验，常用的方法是：<br># Bartlett's Test 适用于正态分布数据<br>bartlett.test(pdat$count ~ Group, data = pdat) <br># Levene's Test 适用于不确定数据是否符合正态分布的情况<br>library(car)<br>leveneTest(pdat$count ~ Group, data = pdat)<br>#P值小于0.05时，方差不齐<br><br>#Levene's Test for Homogeneity of Variance (center = median)<br>#       Df F value   Pr(&gt;F)   <br>#group   1  9.5624 0.002077 **<br>#      605                    <br>#---<br>#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1<br></code></pre><ol start="5" data-tool="mdnice编辑器"><li><section>绘图-目标基因</section></li></ol><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089011" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code># 该数据需采用两样本的非参数检验-wilcox.test<br># 绘制小提琴图和显著性标记<br>library(ggplot2)<br>library(ggpubr)<br>png("p.png",width = 1200,height = 1200,res = 300)<br>ggplot(data=pdat,aes(x=pdat$Group,y=pdat$count,<br>                   colour = pdat$Group))+ #fill参数不要设置，会不好看<br>      geom_violin(#color = 'grey',<br>      alpha = 0.8, #alpha = 0.8 参数控制着小提琴图的透明度。<br>      scale = 'width',#小提琴宽度<br>      #linewidth = 1, #外轮廓粗细<br>      trim = TRUE)+ # trim = TRUE 参数控制着小提琴图的形状。<br>      geom_boxplot(mapping=aes(x=pdat$Group,y=pdat$count,<br>                               colour=pdat$Group,fill=pdat$Group), #箱线图<br>                 alpha = 0.5,<br>                 size=1.5,<br>                 width = 0.3)+ <br>      geom_jitter(mapping=aes(x=pdat$Group,y=pdat$count,colour=pdat$Group), #散点<br>                 alpha = 0.3,size=3)+<br>      scale_fill_manual(limits=c("normal","tumor"), <br>                        values =c("#9E9E9E","#F5C96B"))+<br>      scale_color_manual(limits=c("normal","tumor"), <br>                         values=c("#9E9E9E","#F5C96B"))+ #颜色<br>      geom_signif(mapping=aes(x=pdat$Group,y=pdat$count), # 不同组别的显著性<br>                  comparisons = list(c("normal","tumor")), # 哪些组进行比较<br>                  map_signif_level=T, # T显示显著性，F显示p value<br>                  tip_length=c(0,0),#把向下的帽子去掉，分组数乘以2<br>                  y_position = c(4.5), # 设置显著性线的位置高度<br>                  size=1, # 修改线的粗细<br>                  textsize = 4, # 修改显著性标记的大小<br>                  test = "wilcox.test", # 检验的类型,可以更改<br>                  color = "black")+ # 设置显著性线的颜色<br>      theme_bw()+ #设置白色背景<br>      guides(fill = guide_legend(title = "Group"),  # 设置填充图例的标题<br>             color = guide_legend(title = "Group"))+  # 设置颜色图例的标题<br>      labs(title = "TCGA-KIRC",  # 设置标题<br>           x="",y= paste0("The mRNA expression of ",gene)) # 添加标题，x轴，y轴标签<br>dev.off()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000479" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtAKgAibMWGfJKKJjOSSG2JwRSn2abtp6JxgAgibjuUEXCDCGbXZzIe8Tw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtAKgAibMWGfJKKJjOSSG2JwRSn2abtp6JxgAgibjuUEXCDCGbXZzIe8Tw/640?wx_fmt=png&amp;from=appmsg"></figure><ol start="6" data-tool="mdnice编辑器"><li><section>绘图-管家基因</section></li></ol><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089012" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code><span>#查看典型管家基因（如：GAPDH、ACTB）的表达量，如果表达量高于正常值，说明我们数据没问题。</span><br>exp[<span>'GAPDH'</span>,]<br>exp[<span>'ACTB'</span>,]<br><br><span>#随机取样基因，对比管家基因的表达</span><br><span>#我们可以看到我们数据中两个管家基因的表达量都偏高，符合预期。</span><br>cg = exp[sample(nrow(exp), <span>3</span>), ]<br>boxplot(cg)<br><br><span>##所以数据也没啥问题</span><br></code></pre><h1 data-tool="mdnice编辑器"><span></span>三、临床特征分析前准备</h1><p data-tool="mdnice编辑器">1.数据处理</p><p data-tool="mdnice编辑器">表达矩阵需要tumor和normal，新表达矩阵数据命名为exprSet；临床信息需要进一步整理，成为生存分析需要的格式，新临床信息数据命名为meta。</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089013" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#加载数据和R包<br>rm(list=ls())<br>proj = "TCGA-KIRC"<br>load(paste0(proj,".Rdata"))<br>library(stringr)<br>library(dplyr)<br></code></pre><p data-tool="mdnice编辑器">1.1 数据准备</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089014" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#临床信息和表达矩阵取交集<br>rownames(clinical) &lt;- clinical$submitter_id.samples<br>meta &lt;- clinical<br>exprSet &lt;- exp<br>p &lt;- identical(rownames(meta),colnames(exprSet));p<br>if(!p) {<br>  s = intersect(rownames(meta),colnames(exprSet))<br>  exprSet = exprSet[,s]<br>  meta = meta[s,]<br>}<br></code></pre><p data-tool="mdnice编辑器">1.2 选列并简化列名</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089015" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>tmp &lt;- as.data.frame(colnames(meta))<br><br>#如果有其他感兴趣的指标可以多提取一些<br>meta = meta[,c(<br>  'submitter_id.samples',<br>  'neoplasm_histologic_grade',<br>  'pathologic_T' ,<br>  'pathologic_M',<br>  'pathologic_N',<br>  'age_at_index.demographic',<br>  'gender.demographic' ,<br>  'tumor_stage.diagnoses')]<br>colnames(meta)=c('ID','grade','T_stage','M_stage','N_stage','age','gender','stage')<br></code></pre><p data-tool="mdnice编辑器">1.3 简化、规范内容</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089016" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#检查各列的信息是否规范 没有冗余信息 缺失的信息用NA代替<br>#——Stage——————————————————————————————————<br>table(meta$stage)<br>#not reported      stage i     stage ii    stage iii     stage iv <br>#          3          294           69          139          102 <br>meta$stage = meta$stage %&gt;% <br>  str_replace("not reported",as.character(NA)) %&gt;% <br>  str_remove("stage ") %&gt;% <br>  str_to_upper()   # 罗马数字1、2、3、4小写变大写<br>stage = meta$stage<br>#下面这段内容可以在合适的情况下启用<br>#stage = case_when(stage == 'I'  ~ 'I',<br>           #       stage == 'II' ~ 'II',<br>           #       stage == 'III' ~ 'III',<br>           #       stage == 'IIIA'  ~ 'III',<br>           #       stage == 'IIIB' ~ 'III',<br>           #       stage == 'IIIC' ~ 'III',<br>           #       stage == 'IV'  ~ 'IV',<br>           #       stage == 'IVB' ~ 'IV',<br>           #       TRUE ~ as.character(T))<br>#table(stage) #如果上述这段启用了，后续需要赋值<br>#meta$stage = stage #如果上述这段启用了，后续需要赋值<br><br>#把缺失的值和不能确定的值都变为空值<br>#下面的代码是指把stage中不包含I的内容全部转换成字符型的NA数据<br>meta$stage[!str_detect(meta$stage,"I")]=as.character(NA) #na替换空<br>table(meta$stage,useNA = "always") #always的含义是总是计算NA<br>#   I   II  III   IV &lt;NA&gt; <br># 294   69  139  102    3 <br><br>#——T_stage——————————————————————————————————<br>T_stage = meta$T_stage<br>T_stage = case_when(T_stage == 'T1'  ~ 'T1',<br>                    T_stage == 'T1a' ~ 'T1',<br>                    T_stage == 'T1b' ~ 'T1',<br>                    T_stage == 'T2'  ~ 'T2',<br>                    T_stage == 'T2a' ~ 'T2',<br>                    T_stage == 'T2b' ~ 'T2',<br>                    T_stage == 'T3'  ~ 'T3',<br>                    T_stage == 'T3a' ~ 'T3',<br>                    T_stage == 'T3b' ~ 'T3',<br>                    T_stage == 'T3c' ~  'T3',<br>                    T_stage == 'T4' ~  'T4',<br>                    TRUE ~ as.character(T)) #对于所有其他情况，保持原来的值不变。<br>table(T_stage)<br>#T_stage<br># T1  T2  T3  T4 <br>#302  84 208  13  <br>meta$T_stage = T_stage<br>meta$T_stage[!str_detect(meta$T_stage,"T")]=as.character(NA) #na替换空<br>#meta$T_stage[str_detect(meta$T_stage,"TX")]=as.character(NA) #na替换空<br>#table(meta$T_stage)<br><br>#——grade————————————————————————————————————<br>table(meta$grade,useNA = "always")<br>#       G1   G2   G3   G4   GX &lt;NA&gt; <br>#   3   15  259  235   90    5    0<br>meta$grade[!str_detect(meta$grade,"G")]=as.character(NA) #na替换空<br>table(meta$grade,useNA = "always")<br>#  G1   G2   G3   G4   GX &lt;NA&gt; <br>#  15  259  235   90    5    3 <br><br>#——M_stage——————————————————————————<br>table(meta$M_stage,useNA = "always")<br>#       M0   M1   MX &lt;NA&gt; <br>#  2  477   97   31    0<br>meta$M_stage[!str_detect(meta$M_stage,"M")]=as.character(NA) #na替换空<br>meta$M_stage[str_detect(meta$M_stage,"MX")]=as.character(NA) #MX替换空<br>table(meta$M_stage,useNA = "always")<br>#       M0   M1 &lt;NA&gt; <br>#   2  477   97   31 <br>       <br>#——N_stage————————————————<br>meta$N_stage[!str_detect(meta$N_stage,"N")]=as.character(NA) #na替换空<br>meta$N_stage[str_detect(meta$N_stage,"NX")]=as.character(NA) #NX替换空<br>table(meta$N_stage,useNA = "always")<br>#  N0   N1 &lt;NA&gt; <br># 277   18  307  <br><br>#——gender——————————————————————<br>table(meta$gender,useNA = "always")<br><br>#——age————————————————————<br>table(meta$age,useNA = "always")<br>meta$age = ifelse(as.numeric(str_sub(meta$age)) &lt; 60,'&lt;=60','&gt;60')  <br>table(meta$age,useNA = "always")<br>#&lt;=60  &gt;60 &lt;NA&gt; <br># 276  331    0 <br></code></pre><p data-tool="mdnice编辑器">1.4 实现表达矩阵与临床信息的匹配</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089017" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#因为临床信息那一环节去除了没有生存的数据，所以样本量有了变化<br>#在保存之前重新匹配一下<br>rownames(meta) &lt;- meta$ID<br>s = intersect(rownames(meta),colnames(exprSet));length(s)<br>#[1] 607<br>exprSet = exprSet[,s]<br>identical(rownames(meta),colnames(exprSet))<br>#&gt; [1] TRUE<br></code></pre><p data-tool="mdnice编辑器">1.5 分组信息处理</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089018" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#这次分组完只要后面顺序不变样本不删除就没啥问题<br>#这里的分组是按照exprSet的列名去分的哦!  exprSet和meta的顺序是一致的<br>#根据样本ID的第14-15位，给样本分组（tumor和normal）<br>table(str_sub(colnames(exprSet),14,15))  <br>#这里的14-15位代表的样本的情况，其中01代表Primary Soild Tumor；05代表Additional -New Primary；11代表正常样本<br><br>Group = ifelse(as.numeric(str_sub(colnames(exprSet),14,15)) &lt; 10,'tumor','normal')  <br>Group = factor(Group,levels = c("normal","tumor"))<br>table(Group)<br># Group<br># normal  tumor <br>#     72    535<br></code></pre><ol start="2" data-tool="mdnice编辑器"><li><section>保存数据###</section></li></ol><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089019" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>save(meta,exprSet,Group,surv,proj,file = paste0(proj,"_clinical_exp.Rdata"))<br></code></pre><h1 data-tool="mdnice编辑器"><span></span>四、临床特征分析</h1><p data-tool="mdnice编辑器">1.加载数据和R包</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089020" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>rm(list = ls())<br>proj = "TCGA-KIRC"<br>load(paste0(proj,"_clinical_exp.Rdata"))<br>library(tidyr)<br>library(tibble)<br>library(ggpubr)<br>library(dplyr)<br>#该部分内容除了修改gene信息以外，还需要注意修改临床参数。因为不同数据中clinical参数会有不同<br>gene = "KIFC1"<br></code></pre><p data-tool="mdnice编辑器">2.准备数据</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089021" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#提取想要的基因数据<br>g &lt;- exprSet[gene,] <br>meta &lt;- cbind(meta,g)<br>#在把Group合并上去<br>meta &lt;- cbind(meta,Group)<br>#把临床信息分组情况做好标注<br>meta$grade &lt;- ifelse(meta$Group == "normal","Normal",meta$grade)<br>meta$stage &lt;- ifelse(meta$Group == "normal","Normal",meta$stage)<br>meta$T_stage &lt;- ifelse(meta$Group == "normal","Normal",meta$T_stage)<br>meta$N_stage &lt;- ifelse(meta$Group == "normal","Normal",meta$N_stage)<br>meta$M_stage &lt;- ifelse(meta$Group == "normal","Normal",meta$M_stage)<br></code></pre><p data-tool="mdnice编辑器">3.临床参数绘图</p><p data-tool="mdnice编辑器">3.1 T_stage</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089022" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code># 多分组数据可采用kruskal-wallis test<br># 其中两样本采用非参数检验-wilcox.test<br><br>#存在NA数据因此需要把数据单独提取出来之后去除NA行<br>meta_T &lt;- na.omit(meta[,c(3,9)])<br>meta_T$T_stage &lt;- factor(meta_T$T_stage, levels = c("Normal","T1","T2","T3","T4"))<br><br># 绘制小提琴图和显著性标记<br>library(ggplot2)<br>library(ggpubr)<br>png(paste0(gene,"_T_stage.png"),width = 1200,height = 1200,res = 300)<br>ggplot(data=meta_T,aes(x=T_stage,y=g,colour = T_stage))+ #fill参数不要设置，会不好看<br>      geom_violin(#color = 'grey',<br>      alpha = 0.8, #alpha = 0.8 参数控制着小提琴图的透明度。<br>      scale = 'width',#小提琴宽度<br>      #linewidth = 1, #外轮廓粗细<br>      trim = TRUE)+ # trim = TRUE 参数控制着小提琴图的形状。<br>      geom_boxplot(mapping=aes(x=T_stage,y=g,colour = T_stage,fill=T_stage), #箱线图<br>                 alpha = 0.5,size=1.5,width = 0.3)+ <br>      geom_jitter(mapping=aes(x=T_stage,y=g,colour = T_stage), #散点<br>                 alpha = 0.3,size=3)+<br>      scale_fill_manual(limits=c("Normal","T1","T2","T3","T4"), <br>                        values =c("#312613","#BFA16F","#FB8C82","#B0C8CA","#F7EEE2"))+<br>      scale_color_manual(limits=c("Normal","T1","T2","T3","T4"), <br>                      values=c("#312613","#BFA16F","#FB8C82","#B0C8CA","#F7EEE2"))+ #颜色<br>      geom_signif(mapping=aes(x=T_stage,y=g), # 不同组别的显著性<br>                  comparisons = list(c("Normal","T1"),<br>                                     c("Normal","T2"),<br>                                     c("Normal","T3"),<br>                                     c("Normal","T4"),<br>                                     c("T1","T2"),<br>                                     c("T1","T3"),<br>                                     c("T1","T4"),<br>                                     c("T2","T3"),<br>                                     c("T2","T4"),<br>                                     c("T3","T4")), # 哪些组进行比较<br>                  map_signif_level=T, # T显示显著性，F显示p value<br>                  tip_length=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),#把向下的帽子去掉，分组数乘以2<br>                  y_position = c(4.5,4.8,5.1,5.4,5.7,6,6.3,6.6,6.9,7.2), # 设置显著性线的位置高度<br>                  size=0.5, # 修改线的粗细<br>                  textsize = 2, # 修改显著性标记的大小<br>                  test = "wilcox.test", # 检验的类型,可以更改<br>                  color = "black")+ # 设置显著性线的颜色<br>      theme_bw()+ #设置白色背景<br>      guides(fill = guide_legend(title = "Group"),  # 设置填充图例的标题<br>             color = guide_legend(title = "Group"))+  # 设置颜色图例的标题<br>      labs(title = "TCGA-KIRC",  # 设置标题<br>           x="",y= paste0("The mRNA expression of ",gene)) # 添加标题，x轴，y轴标签<br>dev.off()<br></code></pre><p data-tool="mdnice编辑器">3.2 N_stage</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089023" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code># 多分组数据可采用kruskal-wallis test<br># 其中两样本采用非参数检验-wilcox.test<br><br>#存在NA数据因此需要把数据单独提取出来之后去除NA行<br>meta_N &lt;- na.omit(meta[,c(5,9)])<br>meta_N$N_stage &lt;- factor(meta_N$N_stage, levels = c("Normal", "N0", "N1"))<br><br># 绘制小提琴图和显著性标记<br>library(ggplot2)<br>library(ggpubr)<br>png(paste0(gene,"_N_stage.png"),width = 1200,height = 1200,res = 300)<br>ggplot(data=meta_N,aes(x=N_stage,y=g,colour = N_stage))+ #fill参数不要设置，会不好看<br>      geom_violin(#color = 'grey',<br>      alpha = 0.8, #参数控制着小提琴图的透明度。<br>      scale = 'width',#小提琴宽度<br>      #linewidth = 1, #外轮廓粗细<br>      trim = TRUE  #参数控制着小提琴图的形状<br>      ) + <br>      geom_boxplot(mapping=aes(x=N_stage,y=g,colour = N_stage,fill=N_stage), #箱线图<br>                 alpha = 0.5,size=1.5,width = 0.3)+ <br>      geom_jitter(mapping=aes(x=N_stage,y=g,colour = N_stage), <br>                 alpha = 0.3,size=3)+#散点<br>      scale_fill_manual(limits=c("Normal","N0","N1"), <br>                        values =c("#312613","#BFA16F","#FB8C82"))+<br>      scale_color_manual(limits=c("Normal","N0","N1"), <br>                      values=c("#312613","#BFA16F","#FB8C82"))+ #颜色<br>      geom_signif(mapping=aes(x=N_stage,y=g), # 不同组别的显著性<br>                  comparisons = list(c("Normal","N0"),<br>                                     c("Normal","N1"),<br>                                     c("N0","N1")), # 哪些组进行比较<br>                  map_signif_level=T, # T显示显著性，F显示p value<br>                  tip_length=c(0,0,0,0,0,0),#把向下的帽子去掉，分组数乘以2<br>                  y_position = c(4.5,4.8,5.1), # 设置显著性线的位置高度<br>                  size=0.5, # 修改线的粗细<br>                  textsize = 2, # 修改显著性标记的大小<br>                  test = "wilcox.test", # 检验的类型,可以更改<br>                  color = "black",<br>                  )+ # 设置显著性线的颜色<br>      theme_bw()+ #设置白色背景<br>      guides(fill = guide_legend(title = "Group"),  # 设置填充图例的标题<br>             color = guide_legend(title = "Group"))+  # 设置颜色图例的标题<br>      labs(title = "TCGA-KIRC",  # 设置标题<br>           x="",y= paste0("The mRNA expression of ",gene)) # 添加标题，x轴，y轴标签<br>dev.off()<br></code></pre><p data-tool="mdnice编辑器">3.3 M_stage</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089024" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code># 多分组数据可采用kruskal-wallis test<br># 其中两样本采用非参数检验-wilcox.test<br><br>#存在NA数据因此需要把数据单独提取出来之后去除NA行<br>meta_M &lt;- na.omit(meta[,c(4,9)])<br>meta_M$M_stage &lt;- factor(meta_M$M_stage, levels = c("Normal", "M0", "M1"))<br><br># 绘制小提琴图和显著性标记<br>library(ggplot2)<br>library(ggpubr)<br>png(paste0(gene,"_M_stage.png"),width = 1200,height = 1200,res = 300)<br>ggplot(data=meta_M,aes(x=M_stage,y=g,colour = M_stage))+ #fill参数不要设置，会不好看<br>      geom_violin(alpha = 0.8, #参数控制着小提琴图的透明度。<br>                  scale = 'width',#小提琴宽度<br>                  #linewidth = 1, #外轮廓粗细<br>                  trim = TRUE  ) + #参数控制着小提琴图的形状<br>      geom_boxplot(mapping=aes(x=M_stage,y=g,<br>                               colour = M_stage,fill=M_stage), #箱线图<br>                 alpha = 0.5,size=1.5,width = 0.3)+ <br>      geom_jitter(mapping=aes(x=M_stage,y=g,colour = M_stage), #散点<br>                 alpha = 0.3,size=3)+<br>      scale_fill_manual(limits=c("Normal","M0","M1"), <br>                        values =c("#312613","#BFA16F","#FB8C82"))+<br>      scale_color_manual(limits=c("Normal","M0","M1"), <br>                      values=c("#312613","#BFA16F","#FB8C82"))+ #颜色<br>      geom_signif(mapping=aes(x=M_stage,y=g), # 不同组别的显著性<br>                  comparisons = list(c("Normal","M0"),<br>                                     c("Normal","M1"),<br>                                     c("M0","M1")), # 哪些组进行比较<br>                  map_signif_level=T, # T显示显著性，F显示p value<br>                  tip_length=c(0,0,0,0,0,0),#把向下的帽子去掉，分组数乘以2<br>                  y_position = c(4.5,4.8,5.1), # 设置显著性线的位置高度<br>                  size=0.5, # 修改线的粗细<br>                  textsize = 2, # 修改显著性标记的大小<br>                  test = "wilcox.test", # 检验的类型,可以更改<br>                  color = "black",<br>                  )+ # 设置显著性线的颜色<br>      theme_bw()+ #设置白色背景<br>      guides(fill = guide_legend(title = "Group"),  # 设置填充图例的标题<br>             color = guide_legend(title = "Group"))+  # 设置颜色图例的标题<br>      labs(title = "TCGA-KIRC",  # 设置标题<br>           x="",y= paste0("The mRNA expression of ",gene)) # 添加标题，x轴，y轴标签<br>dev.off()<br></code></pre><p data-tool="mdnice编辑器">3.4 Grade_stage</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089025" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code># 多分组数据可采用kruskal-wallis test<br># 其中两样本采用非参数检验-wilcox.test<br><br>#存在NA数据因此需要把数据单独提取出来之后去除NA行<br>meta_grade &lt;- na.omit(meta[,c(2,9)])<br>meta_grade$grade &lt;- factor(meta_grade$grade, <br>                           levels = c("Normal","G1", "G2","G3","G4")) #自动把不要的数据变NA<br>meta_grade &lt;- na.omit(meta_grade)<br>#如果想要GX数据就修改参数和后面代码<br>#meta_grade$grade &lt;- factor(meta_grade$grade, levels = c("Normal","G1", "G2","G3","G4","GX"))<br><br># 绘制小提琴图和显著性标记<br>library(ggplot2)<br>library(ggpubr)<br>png(paste0(gene,"_grade.png"),width = 1200,height = 1200,res = 300)<br>ggplot(data=meta_grade,aes(x=grade,y=g,colour = grade))+ #fill参数不要设置，会不好看<br>      geom_violin(alpha = 0.8, #参数控制着小提琴图的透明度。<br>                  scale = 'width',#小提琴宽度<br>                  #linewidth = 1, #外轮廓粗细<br>                  trim = TRUE  #参数控制着小提琴图的形状<br>      ) + <br>      geom_boxplot(mapping=aes(x=grade,y=g,colour = grade,fill=grade), #箱线图<br>                 alpha = 0.5,size=1.5,width = 0.3)+ <br>      geom_jitter(mapping=aes(x=grade,y=g,colour = grade), #散点<br>                 alpha = 0.3,size=3)+<br>      scale_fill_manual(limits=c("Normal","G1","G2","G3","G4"), <br>                        values =c("#312613","#BFA16F","#FB8C82","#B0C8CA","#F7EEE2"))+<br>      scale_color_manual(limits=c("Normal","G1","G2","G3","G4"), <br>                      values=c("#312613","#BFA16F","#FB8C82","#B0C8CA","#F7EEE2"))+ #颜色<br>      geom_signif(mapping=aes(x=grade,y=g), # 不同组别的显著性<br>                  comparisons = list(c("Normal","G1"),<br>                                     c("Normal","G2"),<br>                                     c("Normal","G3"),<br>                                     c("Normal","G4"),<br>                                     c("G1","G2"),<br>                                     c("G1","G3"),<br>                                     c("G1","G4"),<br>                                     c("G2","G3"),<br>                                     c("G2","G4"),<br>                                     c("G3","G4")), # 哪些组进行比较<br>                  map_signif_level=T, # T显示显著性，F显示p value<br>                  tip_length=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),#把向下的帽子去掉，分组数乘以2<br>                  y_position = c(4.5,4.8,5.1,5.4,5.7,6,6.3,6.6,6.9,7.2), # 设置显著性线的位置高度<br>                  size=0.5, # 修改线的粗细<br>                  textsize = 2, # 修改显著性标记的大小<br>                  test = "wilcox.test", # 检验的类型,可以更改<br>                  color = "black",<br>                  )+ # 设置显著性线的颜色<br>      theme_bw()+ #设置白色背景<br>      guides(fill = guide_legend(title = "Group"),  # 设置填充图例的标题<br>             color = guide_legend(title = "Group"))+  # 设置颜色图例的标题<br>      labs(title = "TCGA-KIRC",  # 设置标题<br>           x="",y= paste0("The mRNA expression of ",gene)) # 添加标题，x轴，y轴标签<br>dev.off()<br></code></pre><p data-tool="mdnice编辑器">3.5 stage</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089026" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code># 多分组数据可采用kruskal-wallis test<br># 其中两样本采用非参数检验-wilcox.test<br><br>#存在NA数据因此需要把数据单独提取出来之后去除NA行<br>meta_stage &lt;- na.omit(meta[,c(8,9)])<br>meta_stage$stage &lt;- factor(meta_stage$stage, levels = c("Normal","I", "II","III","IV"))<br>meta_stage &lt;- na.omit(meta_stage) #这一步可以不删除，分期数会出现X<br><br># 绘制小提琴图和显著性标记<br>library(ggplot2)<br>library(ggpubr)<br>png(paste0(gene,"_stage.png"),width = 1200,height = 1200,res = 300)<br>ggplot(data=meta_stage,aes(x=stage,y=g,colour = stage))+ #fill参数不要设置，会不好看<br>      geom_violin(alpha = 0.8, #参数控制着小提琴图的透明度。<br>                  scale = 'width',#小提琴宽度<br>                  #linewidth = 1, #外轮廓粗细<br>                  trim = TRUE   ) + #参数控制着小提琴图的形状<br>      geom_boxplot(mapping=aes(x=stage,y=g,colour = stage,fill=stage), #箱线图<br>                   alpha = 0.5,size=1.5,width = 0.3)+ <br>      geom_jitter(mapping=aes(x=stage,y=g,colour = stage),alpha = 0.3,size=3)+#散点<br>      scale_fill_manual(limits=c("Normal","I","II","III","IV"), <br>                        values =c("#312613","#BFA16F","#FB8C82","#B0C8CA","#F7EEE2"))+<br>      scale_color_manual(limits=c("Normal","I","II","III","IV"), <br>                      values=c("#312613","#BFA16F","#FB8C82","#B0C8CA","#F7EEE2"))+ #颜色<br>      geom_signif(mapping=aes(x=stage,y=g), # 不同组别的显著性<br>                  comparisons = list(c("Normal","I"),<br>                                     c("Normal","II"),<br>                                     c("Normal","III"),<br>                                     c("Normal","IV"),<br>                                     c("I","II"),<br>                                     c("I","III"),<br>                                     c("I","IV"),<br>                                     c("II","III"),<br>                                     c("II","IV"),<br>                                     c("III","IV")), # 哪些组进行比较<br>                  map_signif_level=T, # T显示显著性，F显示p value<br>                  tip_length=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),#把向下的帽子去掉，分组数乘以2<br>                  y_position = c(4.5,4.8,5.1,5.4,5.7,6,6.3,6.6,6.9,7.2), # 设置显著性线的位置高度<br>                  size=0.5, # 修改线的粗细<br>                  textsize = 2, # 修改显著性标记的大小<br>                  test = "wilcox.test", # 检验的类型,可以更改<br>                  color = "black",<br>                  )+ # 设置显著性线的颜色<br>      theme_bw()+ #设置白色背景<br>      guides(fill = guide_legend(title = "Group"),  # 设置填充图例的标题<br>             color = guide_legend(title = "Group"))+  # 设置颜色图例的标题<br>      labs(title = "TCGA-KIRC",  # 设置标题<br>           x="",y= paste0("The mRNA expression of ",gene)) # 添加标题，x轴，y轴标签<br>dev.off()<br></code></pre><p data-tool="mdnice编辑器">3.6 age</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089027" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code># 其中两样本采用非参数检验-wilcox.test/或者符合正态分布就用t-test<br><br>#存在NA数据因此需要把数据单独提取出来之后去除NA行<br>meta_age &lt;- na.omit(meta[,c(6,9)])<br>meta_age &lt;- meta_age[Group == "tumor",]<br>meta_age$age &lt;- factor(meta_age$age, levels = c("&lt;=60","&gt;60"))<br>meta_age &lt;- na.omit(meta_age) #这一步可以不删除，也许出现X数据，因子化之后变NA去除<br><br># 绘制小提琴图和显著性标记<br>library(ggplot2)<br>library(ggpubr)<br>png(paste0(gene,"_age.png"),width = 1200,height = 1200,res = 300)<br>ggplot(data=meta_age,aes(x=age,y=g,colour = age))+ #fill参数不要设置，会不好看<br>      geom_violin(alpha = 0.8, #参数控制着小提琴图的透明度。<br>                  scale = 'width',#小提琴宽度<br>                  #linewidth = 1, #外轮廓粗细<br>                  trim = TRUE  ) + #参数控制着小提琴图的形状<br>      geom_boxplot(mapping=aes(x=age,y=g,colour = age,fill=age), #箱线图<br>                 alpha = 0.5,size=1.5,width = 0.3)+ <br>      geom_jitter(mapping=aes(x=age,y=g,colour = age), #散点<br>                 alpha = 0.3,size=3)+<br>      scale_fill_manual(limits=c("&lt;=60","&gt;60"), <br>                        values =c("#312613","#BFA16F"))+<br>      scale_color_manual(limits=c("&lt;=60","&gt;60"), <br>                      values=c("#312613","#BFA16F"))+ #颜色<br>      geom_signif(mapping=aes(x=age,y=g), # 不同组别的显著性<br>                  comparisons = list(c("&lt;=60","&gt;60")), # 哪些组进行比较<br>                  map_signif_level=T, # T显示显著性，F显示p value<br>                  tip_length=c(0,0),#把向下的帽子去掉，分组数乘以2<br>                  y_position = c(4.5), # 设置显著性线的位置高度<br>                  size=0.5, # 修改线的粗细<br>                  textsize = 2, # 修改显著性标记的大小<br>                  test = "wilcox.test", # 检验的类型,可以更改<br>                  color = "black",<br>                  )+ # 设置显著性线的颜色<br>      theme_bw()+ #设置白色背景<br>      guides(fill = guide_legend(title = "Group"),  # 设置填充图例的标题<br>             color = guide_legend(title = "Group"))+  # 设置颜色图例的标题<br>      labs(title = "TCGA-KIRC",  # 设置标题<br>           x="",y= paste0("The mRNA expression of ",gene)) # 添加标题，x轴，y轴标签<br>dev.off()<br></code></pre><p data-tool="mdnice编辑器">3.7 gender</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089028" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code><span># 其中两样本采用非参数检验-wilcox.test/或者符合正态分布就用t-test</span><br><br><span>#存在NA数据因此需要把数据单独提取出来之后去除NA行</span><br>meta_gender &lt;- na.omit(meta[,c(<span>7</span>,<span>9</span>)])<br>meta_gender &lt;- meta_gender[Group == <span>"tumor"</span>,]<br>meta_gender$gender &lt;- factor(meta_gender$gender, levels = c(<span>"male"</span>,<span>"female"</span>))<br>meta_gender &lt;- na.omit(meta_gender) <span>#这一步可以不删除，也许出现X数据，因子化之后变NA去除</span><br><br><span># 绘制小提琴图和显著性标记</span><br><span>library</span>(ggplot2)<br><span>library</span>(ggpubr)<br>png(paste0(gene,<span>"_gender.png"</span>),width = <span>1200</span>,height = <span>1200</span>,res = <span>300</span>)<br>ggplot(data=meta_gender,aes(x=gender,y=g,colour = gender))+ <span>#fill参数不要设置，会不好看</span><br>      geom_violin(alpha = <span>0.8</span>, <span>#参数控制着小提琴图的透明度。</span><br>                  scale = <span>'width'</span>,<span>#小提琴宽度</span><br>                  <span>#linewidth = 1, #外轮廓粗细</span><br>                  trim = <span>TRUE</span> ) +  <span>#参数控制着小提琴图的形状</span><br>      geom_boxplot(mapping=aes(x=gender,y=g,colour = gender,fill=gender), <span>#箱线图</span><br>                 alpha = <span>0.5</span>,size=<span>1.5</span>,width = <span>0.3</span>)+ <br>      geom_jitter(mapping=aes(x=gender,y=g,colour = gender), alpha = <span>0.3</span>,size=<span>3</span>)+<span>#散点</span><br>      scale_fill_manual(limits=c(<span>"male"</span>,<span>"female"</span>), <br>                        values =c(<span>"#312613"</span>,<span>"#BFA16F"</span>))+<br>      scale_color_manual(limits=c(<span>"male"</span>,<span>"female"</span>), <br>                      values=c(<span>"#312613"</span>,<span>"#BFA16F"</span>))+ <span>#颜色</span><br>      geom_signif(mapping=aes(x=gender,y=g), <span># 不同组别的显著性</span><br>                  comparisons = list(c(<span>"male"</span>,<span>"female"</span>)), <span># 哪些组进行比较</span><br>                  map_signif_level=<span>T</span>, <span># T显示显著性，F显示p value</span><br>                  tip_length=c(<span>0</span>,<span>0</span>),<span>#把向下的帽子去掉，分组数乘以2</span><br>                  y_position = c(<span>4.5</span>), <span># 设置显著性线的位置高度</span><br>                  size=<span>0.5</span>, <span># 修改线的粗细</span><br>                  textsize = <span>2</span>, <span># 修改显著性标记的大小</span><br>                  test = <span>"wilcox.test"</span>, <span># 检验的类型,可以更改</span><br>                  color = <span>"black"</span>,<br>                  )+ <span># 设置显著性线的颜色</span><br>      theme_bw()+ <span>#设置白色背景</span><br>      guides(fill = guide_legend(title = <span>"Group"</span>),  <span># 设置填充图例的标题</span><br>             color = guide_legend(title = <span>"Group"</span>))+  <span># 设置颜色图例的标题</span><br>      labs(title = <span>"TCGA-KIRC"</span>,  <span># 设置标题</span><br>           x=<span>""</span>,y= paste0(<span>"The mRNA expression of "</span>,gene)) <span># 添加标题，x轴，y轴标签</span><br>dev.off()<br></code></pre><p data-tool="mdnice编辑器"><img data-imgfileid="100000471" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtdOmlYzzMrezBvCPpiat93qwl75stWngnLExvtOy4Qo7JVXPmibxKsU4g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtdOmlYzzMrezBvCPpiat93qwl75stWngnLExvtOy4Qo7JVXPmibxKsU4g/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100000470" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHt4uLKSf7SkrAU51aA3x23dfic6Lj9XSd1X7meFUBfwOjRBgHhDtDpxcA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHt4uLKSf7SkrAU51aA3x23dfic6Lj9XSd1X7meFUBfwOjRBgHhDtDpxcA/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100000480" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtqmPoDIJGcm2qPCr6GtWOic7IuyTbXvY2Pqjq4Lhy52UxGanC09RNE8g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtqmPoDIJGcm2qPCr6GtWOic7IuyTbXvY2Pqjq4Lhy52UxGanC09RNE8g/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100000469" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtWZaLawDdhNjkcAhDxGmE9BqajM0bLPe3aq2HEB62FvKBovibP5zn0aA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtWZaLawDdhNjkcAhDxGmE9BqajM0bLPe3aq2HEB62FvKBovibP5zn0aA/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100000468" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtodHd9AHFjo5F7ohiay80uDFOcEDcADEXzeibLasggLUkfe4wt1YYoGNw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtodHd9AHFjo5F7ohiay80uDFOcEDcADEXzeibLasggLUkfe4wt1YYoGNw/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100000481" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtZIjiak9ibibiacIqf4mZ1y9FsxZ4Qc6ZCbFLYibGdV7hMPmGib2ZxSiaZrM2Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtZIjiak9ibibiacIqf4mZ1y9FsxZ4Qc6ZCbFLYibGdV7hMPmGib2ZxSiaZrM2Q/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100000467" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtjUM65oTbuQA9podqpSR6ib1XBNp3LRrfZ4xnBNzqReJHWgc6fhu7nag/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtjUM65oTbuQA9podqpSR6ib1XBNp3LRrfZ4xnBNzqReJHWgc6fhu7nag/640?wx_fmt=png&amp;from=appmsg"></p><h1 data-tool="mdnice编辑器"><span></span>五、生存分析前数据处理</h1><p data-tool="mdnice编辑器">1.生存和临床数据处理</p><p data-tool="mdnice编辑器">表达矩阵只需要tumor数据，不要normal，将其去掉，新表达矩阵数据命名为exprSet；临床信息需要进一步整理，成为生存分析需要的格式，新临床信息数据命名为meta。</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089029" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#加载数据和R包<br>rm(list = ls())<br>proj = "TCGA-KIRC"<br>load(paste0(proj,"_clinical_exp.Rdata"))<br>library(stringr)<br></code></pre><p data-tool="mdnice编辑器">1.1去除normal样本-先从临床数据取再跟表达矩阵取交集比较好</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089030" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>table(Group)<br>#Group<br>#normal  tumor <br>#    72    535 <br>meta &lt;- meta[Group == "tumor",]<br>table(str_sub(rownames(meta),14,15)) #确认数据是否都是tumor<br># 01  05 <br>#534   1  <br></code></pre><p data-tool="mdnice编辑器">1.2 生存和临床数据合并</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089031" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>library(dplyr)<br>nrow(surv)<br>#[1] 979<br>nrow(meta)<br>#[1] 535<br>meta = left_join(meta,surv,by = c("ID"= "sample"))<br>nrow(meta)<br>#[1] 535<br>meta &lt;- meta[,!colnames(meta) == "X_PATIENT"] #去除多余列<br></code></pre><p data-tool="mdnice编辑器">1.3 样本信息过滤</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089032" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#去掉生存信息不全或者生存时间小于30天的样本，样本纳排标准不唯一，且差别很大.<br>#仁者见仁智者见智，是否去除自己看着办<br>k1 = meta$OS.time &gt;= 30;table(k1)<br>#k1<br>#FALSE  TRUE <br>#   13   518 <br><br>#NA的数据是一定要去除的，生存分析不能有NA数据<br>k2 = !(is.na(meta$OS.time)|is.na(meta$OS));table(k2)<br>#k2<br>#FALSE  TRUE <br>#    4   531<br>meta = meta[k1&amp;k2,]<br></code></pre><p data-tool="mdnice编辑器">1.4 选列并简化列名</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089033" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>colnames(meta)=c('ID','grade','T_stage','M_stage','N_stage','age','gender','stage','event','time')<br></code></pre><p data-tool="mdnice编辑器">1.5 生存数据简化及规范</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089034" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#(1)生存时间 认清生存时间的单位（通常是月，也可以用天和年）;<br>range(meta$time)<br>#[1]   36 4537<br>meta$time = meta$time/30 #改成月<br>#meta$time = meta$time/12 #还可以进一步改成年<br>range(meta$time)<br>#[1]   1.2000 151.2333<br></code></pre><p data-tool="mdnice编辑器">1.6 实现表达矩阵与临床信息的匹配</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089035" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>rownames(meta) &lt;- meta$ID<br>s = intersect(rownames(meta),colnames(exprSet));length(s)<br>#[1] 518<br>exprSet = exprSet[,s]<br>#确认顺序<br>identical(rownames(meta),colnames(exprSet))<br>#[1] TRUE<br></code></pre><ol start="2" data-tool="mdnice编辑器"><li><section>保存数据</section></li></ol><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089036" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>save(meta,exprSet,proj,file = paste0(proj,"_sur_analysis.Rdata"))<br></code></pre><h1 data-tool="mdnice编辑器"><span></span>六、生存分析</h1><p data-tool="mdnice编辑器">1.输入数据</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089037" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>rm(list = ls())<br>proj = "TCGA-KIRC"<br>load(paste0(proj,"_sur_analysis.Rdata"))<br>ls() #显示当前载入的内容是哪些<br>exprSet[1:4,1:4]<br>str(meta)<br>library(stringr)<br>library(survival)<br>library(survminer)<br><br>#输入基因名<br>gene = "KIFC1"<br></code></pre><p data-tool="mdnice编辑器">2.修改基因行名</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089038" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>rownames(exprSet)= str_replace_all(rownames(exprSet),"-","_")<br></code></pre><ol start="3" data-tool="mdnice编辑器"><li><section>生存分析-中位值法</section></li></ol><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089039" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#for循环生存分析<br>#特异写了循环函数，假设基因数量多了之后可以修改后使用<br>for (g in gene) {<br><br>meta[[g]] = ifelse((exprSet[rownames(exprSet) == g,]) &lt;        <br>                    median(exprSet[rownames(exprSet) == g,]),'low','high')<br>meta[[g]] = factor(meta[[g]],levels = c("low","high"))<br>  <br>sfit &lt;- survfit(as.formula(paste("Surv(time, event) ~", g)), data=meta)<br>ggsurvplot(sfit,pval=TRUE)<br>png(filename = paste0(g,"_median.png"), width = 8, height = 6, units = "in", res = 300)<br>   p &lt;- ggsurvplot(<br>               sfit,<br>               censor.shape="|", <br>               censor.size = 4,<br>               conf.int = TRUE,<br>               conf.int.style = "ribbon",<br>               conf.int.alpha = 0.2,<br>               pval = TRUE,<br>               palette = "jco",<br>               #surv.median.line = "hv",<br>               ggtheme =theme_bw(),<br>               legend = "top",<br>               legend.labs = c("Low","High"),<br>               xlab = "OS_time(Month)",<br>               ylab = "Survival probability",<br>               title = paste0(g," Influence"),#将标题根据gene分别命名<br>               break.x.by = 24,#24个月界限<br>               break.y.by = 0.1,<br>               risk.table = TRUE,<br>               risk.table.col = "strata",<br>               risk.table.height = 0.2,<br>               risk.table.y.text = FALSE<br>  )<br>print(p)<br>dev.off()  # 关闭设备，完成保存<br>}<br><br></code></pre><p data-tool="mdnice编辑器">4.生存分析-最佳截断值法</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089040" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>#for循环生存分析<br>#特异写了循环函数，假设基因数量多了之后可以修改后使用<br>for (g in gene) {<br>  <br>  meta[[g]] = exprSet[rownames(exprSet) == g,] #不需要转置哦。自动转置<br>  <br>  res.cut = survminer::surv_cutpoint(meta, <br>                                     time = "time", <br>                                     event = "event", <br>                                     variables = g)<br>  cut = res.cut[["cutpoint"]][1, 1]<br>  meta[[paste0(g,"_group")]] = ifelse(meta[[g]] &lt; cut,'low','high')<br>  meta[[paste0(g,"_group")]] = factor(meta[[paste0(g,"_group")]],levels = c('low','high'))<br>  <br>  sfit &lt;- survfit(as.formula(paste("Surv(time, event) ~", paste0(g,"_group"))), data=meta)<br>  ggsurvplot(sfit,pval=TRUE)<br>  png(filename = paste0(g,"_best_cut.png"), width = 8, height = 6, units = "in", res = 300)<br>   p1 &lt;- ggsurvplot(<br>               sfit,<br>               censor.shape="|", <br>               censor.size = 4,<br>               conf.int = TRUE,<br>               conf.int.style = "ribbon",<br>               conf.int.alpha = 0.2,<br>               pval = TRUE,<br>               palette = "jco",<br>               #surv.median.line = "hv",<br>               ggtheme =theme_bw(),<br>               legend = "top",<br>               legend.labs = c("Low","High"),<br>               xlab = "OS_time(Month)",<br>               ylab = "Survival probability",<br>               title = paste0(g," Influence"),#将标题根据gene分别命名<br>               break.x.by = 24,#24个月界限<br>               break.y.by = 0.1,<br>               risk.table = TRUE,<br>               risk.table.col = "strata",<br>               risk.table.height = 0.2,<br>               risk.table.y.text = FALSE<br>  )<br>print(p1)<br>dev.off()  # 关闭设备，完成保存<br>}<br></code></pre><p data-tool="mdnice编辑器">5.生存分析-四分位法</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1716165089041" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code><span>#for循环生存分析</span><br><span>#特异写了循环函数，假设基因数量多了之后可以修改后使用</span><br><span>for</span> (g <span>in</span> gene) {<br>  <br>  meta[[g]] = exprSet[rownames(exprSet) == g,] <span>#不需要转置哦。自动转置</span><br>  <br>  <span># 计算四分位数</span><br>  quartiles &lt;- quantile(meta[[g]], probs = c(<span>0.25</span>, <span>0.5</span>, <span>0.75</span>))<br>  <br>  <span># 根据四分位数分组</span><br>  meta[[paste0(g, <span>"_group"</span>)]] &lt;- cut(meta[[g]], <br>                                     breaks = c(-<span>Inf</span>, quartiles, <span>Inf</span>), <br>                                     labels = c(<span>"Q1"</span>, <span>"Q2"</span>, <span>"Q3"</span>, <span>"Q4"</span>))<br>  <br>  <span># 确保分组变量是因子并设置因子水平顺序</span><br>  meta[[paste0(g, <span>"_group"</span>)]] &lt;- factor(meta[[paste0(g, <span>"_group"</span>)]], levels = c(<span>"Q1"</span>, <span>"Q2"</span>, <span>"Q3"</span>, <span>"Q4"</span>))<br>  <br>  sfit &lt;- survfit(as.formula(paste(<span>"Surv(time, event) ~"</span>, paste0(g,<span>"_group"</span>))), data=meta)<br>  ggsurvplot(sfit,pval=<span>TRUE</span>)<br>  png(filename = paste0(g,<span>"_quantile.png"</span>), width = <span>8</span>, height = <span>8</span>, units = <span>"in"</span>, res = <span>300</span>)<br>   p1 &lt;- ggsurvplot(<br>               sfit,<br>               censor.shape=<span>"|"</span>, <br>               censor.size = <span>4</span>,<br>               conf.int = <span>TRUE</span>,<br>               conf.int.style = <span>"ribbon"</span>,<br>               conf.int.alpha = <span>0.2</span>,<br>               pval = <span>TRUE</span>,<br>               palette = <span>"jco"</span>,<br>               <span>#surv.median.line = "hv",</span><br>               ggtheme =theme_bw(),<br>               legend = <span>"top"</span>,<br>               legend.labs = c(<span>"Q1"</span>, <span>"Q2"</span>, <span>"Q3"</span>, <span>"Q4"</span>),<br>               xlab = <span>"OS_time(Month)"</span>,<br>               ylab = <span>"Survival probability"</span>,<br>               title = paste0(g,<span>" Influence"</span>),<span>#将标题根据gene分别命名</span><br>               break.x.by = <span>24</span>,<span>#24个月界限</span><br>               break.y.by = <span>0.1</span>,<br>               risk.table = <span>TRUE</span>,<br>               risk.table.col = <span>"strata"</span>,<br>               risk.table.height = <span>0.2</span>,<br>               risk.table.y.text = <span>FALSE</span><br>  )<br>print(p1)<br>dev.off()  <span># 关闭设备，完成保存</span><br>}<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000464" data-ratio="0.75" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtfVdKDGYqH98malYh5p7AmjR86x0Z2fRuIicAfgYgTY6Nncia0GO1wg9w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtfVdKDGYqH98malYh5p7AmjR86x0Z2fRuIicAfgYgTY6Nncia0GO1wg9w/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100000465" data-ratio="0.75" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtia4cnHx1HmnKOyaT338MOL9ltdMllIkrJoh27LQpQXvoDtZgwhrCUSQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHtia4cnHx1HmnKOyaT338MOL9ltdMllIkrJoh27LQpQXvoDtZgwhrCUSQ/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100000466" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHt5nceFTFtiantjSQn56meH5yRDPdEWLfMzhSQzG8kfAicWDoHmjS0eADg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfJORHa6s2EufYgZK6KJHt5nceFTFtiantjSQn56meH5yRDPdEWLfMzhSQzG8kfAicWDoHmjS0eADg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>小结</strong>：这样的一套代码就可以基本解决单基因分析时常见的问题啦~。</p><p data-tool="mdnice编辑器"><strong>致谢</strong>：感谢曾老师，小洁老师以及生信技能树团队全体成员（部分代码来源：生信技能树马拉松和数据挖掘课程）。</p><p data-tool="mdnice编辑器"><strong>注</strong>：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(希望多多交流)。</p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/54B5ma2o-YolsHWdH0Ockw",target="_blank" rel="noopener noreferrer">原文链接</a>
