---
title: "什么？一个单细胞样本变成俩了？"
date: 2024-07-26T08:10:35Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
什么？一个单细胞样本变成俩了？ by 生信星球
------
<div><section data-mpa-powered-by="yiban.io"><img data-imgfileid="100011429" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-imgfileid="100011425" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第973天</strong></span></span><img data-imgfileid="100011426" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><section><span><span>   </span></span></section><section><section><figure><figcaption></figcaption></figure></section><section><section><section><figure><figcaption></figcaption></figure></section><figure><figcaption></figcaption></figure></section><figure><span></span><span></span></figure></section><section><figure><section><figure><figcaption></figcaption></figure></section></figure></section><section><figure><figcaption></figcaption></figure></section><section><figure><figcaption></figcaption></figure></section><section><figure><figcaption></figcaption></figure></section><section><blockquote><section><span>公众号里的文章大多数需要编程基础，如果因为代码看不懂，而跟不上正文的节奏，可以来找我学习，相当于给自己一个新手保护期。</span><span>我的课程都是循环开课。</span><span>下一期的时间，点进去咨询微信↓</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494891&amp;idx=1&amp;sn=17bcc587d8e4063965a15771d7f8721a&amp;chksm=fdfba4a9ca8c2dbf5293cb7bc8acf7e0a0e7f2b51c8b69d673c230c28f902885bac8e976d4eb&amp;scene=21#wechat_redirect" textvalue="生信分析直播课‍程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信分析直播课程</a></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494919&amp;idx=2&amp;sn=967d8dcf0f9a22047ae0bd442b9d4ee6&amp;chksm=fdfba545ca8c2c5396c3fb5caa93a5d30336626533fcac074abd7683e8d536cb2dcae31d6e7a&amp;scene=21#wechat_redirect" textvalue="生信新手保护‍学习‍小组" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">生信新手保护学习<span>‍</span>小组</a></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247495036&amp;idx=1&amp;sn=fe8bab2c3d21e7b0a919ad4f1641ca9c&amp;chksm=fdfba53eca8c2c286522b2accc0d4cb9dda7cd9a5b36695e66d393abb5bff396d6bcaa4c9cb8&amp;scene=21#wechat_redirect" textvalue="单细胞陪伴学习小组内测完成，长期招生中" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞陪伴学习小组</a></section></blockquote></section><section><section><section><section><h4><span>1.背景知识</span></h4><p>众所周知，单细胞转录组数据的输入文件是多种多样的，详见:<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzkzMjY4NDc5OQ==&amp;mid=2247483745&amp;idx=1&amp;sn=b25aa3c863aea548a9b70220814949e7&amp;scene=21#wechat_redirect" textvalue="不同文件格式单细胞数据读取流程 " linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2">不同文件格式单细胞数据读取流程 </a></p><p>除了标准三个文件的格式，就还有很多其他的！</p><p>今天来看一个小坑坑。</p><p>这个数据是GSM4453576，给的是txt.gz格式，gz是压缩格式，不用解压可以正常读取。</p><p>所以正常的读取方式应该是这样：</p><pre><code><span>a <span>=</span> data.table<span>::</span><span>fread</span>(<span>"GSM4453576_P1_exp.txt.gz"</span>,<span>data.table =</span> F)</span><br><span>a <span>=</span> tibble<span>::</span><span>column_to_rownames</span>(a,<span>"V1"</span>)</span><br><span>a[<span>1</span><span>:</span><span>4</span>,<span>1</span><span>:</span><span>4</span>]</span></code></pre><table width="NaN" height="NaN"><tbody><tr><td><br></td></tr></tbody></table><table cellspacing="0" width="892"><thead><tr><th align="left"><p><span> </span></p><p><span> </span></p></th><th align="right"><p><span>1_TAGGCTAAGCCG</span></p><p><span>&lt;int&gt;</span></p></th><th align="right"><p><span>1_CCGGCATATTCG</span></p><p><span>&lt;int&gt;</span></p></th><th align="right"><p><span>1_TCCGTAGACGTA</span></p><p><span>&lt;int&gt;</span></p></th><th align="right"><p><span>1_AAACTACAGTGC</span></p><p><span>&lt;int&gt;</span></p></th></tr></thead><tbody><tr><td align="left"><span>PWP1</span></td><td align="right"><span>8</span></td><td align="right"><span>2</span></td><td align="right"><span>3</span></td><td align="right"><span>5</span></td></tr><tr><td align="left"><span>FTH1</span></td><td align="right"><span>608</span></td><td align="right"><span>521</span></td><td align="right"><span>425</span></td><td align="right"><span>547</span></td></tr><tr><td align="left"><span>PERP</span></td><td align="right"><span>20</span></td><td align="right"><span>46</span></td><td align="right"><span>30</span></td><td align="right"><span>31</span></td></tr><tr><td align="left"><span>RPL37</span></td><td align="right"><span>130</span></td><td align="right"><span>195</span></td><td align="right"><span>153</span></td><td align="right"><span>119</span></td></tr></tbody></table><p><span>4 rows</span></p><p>然后把这个表达矩阵传递给counts参数即可：</p><pre><code><span><span>library</span>(Seurat)</span><br><span>seu.obj <span>&lt;-</span> <span>CreateSeuratObject</span>(<span>counts =</span> a, </span><br><span>                              <span>min.cells =</span> <span>3</span>, </span><br><span>                              <span>min.features =</span> <span>200</span>)</span><br><span><span>dim</span>(seu.obj)</span></code></pre><pre><code>## [1] 20769  5317</code></pre><h4><span>2.发现bug并找到源头</span></h4><p>但是呢，后面做质控小提琴图时就会发现，好好的一个样本居然被画在两个小提琴里了？按理来说单样本数据应该是只有一个才对。</p><pre><code><span><span>VlnPlot</span>(seu.obj,<span>"nCount_RNA"</span>)</span></code></pre><p><img data-imgfileid="100011443" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHoKV8eKmv7qVYib1x650PGwuyTX8fXQcvbvyTibIckPUA5DxHZxzy65x8CCv202OprLDq5X4npRiaB4g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHoKV8eKmv7qVYib1x650PGwuyTX8fXQcvbvyTibIckPUA5DxHZxzy65x8CCv202OprLDq5X4npRiaB4g/640?wx_fmt=png&amp;from=appmsg"></p><p>甚至有的数据是这样（来自学生）</p><p><img data-imgfileid="100011445" data-ratio="1.0324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoKV8eKmv7qVYib1x650PGwu8xLLtGNC8Xa0vRHYNSwYZpAk6oibPpFicOcsZ5QMunoiagKYE1nPhLvgw/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoKV8eKmv7qVYib1x650PGwu8xLLtGNC8Xa0vRHYNSwYZpAk6oibPpFicOcsZ5QMunoiagKYE1nPhLvgw/640?wx_fmt=jpeg&amp;from=appmsg"></p><p>不仔细看都看不出来横坐标有3个，其中第三个只有一个点(可能是读取的代码有啥毛病吧，谁做错了参考我的作为答案就行，手动狗头)。</p><p><img data-imgfileid="100011444" data-ratio="0.7796296296296297" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoKV8eKmv7qVYib1x650PGwupfJ9T1ON2du0SA2fvJ456MgEA5RmYu56y9EcIdIic3JsU2ibknOLUZng/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoKV8eKmv7qVYib1x650PGwupfJ9T1ON2du0SA2fvJ456MgEA5RmYu56y9EcIdIic3JsU2ibknOLUZng/640?wx_fmt=jpeg&amp;from=appmsg"></p><p>还给了个warning，让设置drop=F，我起初以为这个参数就是解决问题的，实际上它只能解决点的数量太少的”分组“被删掉的问题，例如上图中的”V5381”。并不能解决org.ident的问题。</p><p>VlnPlot不指定颜色的时候，就是按照orig.ident分配颜色的，所以问题出在orig.ident上面：</p><pre><code><span><span>table</span>(seu.obj<span>$</span>orig.ident)</span></code></pre><pre><code>## <br>##    1    2 <br>## 1596 3721</code></pre><p>果然，orig.ident分了1和2。正常的单样本数据应该是同一个值，默认是SeuratProject ，如果CreateSeuratObject时设置了project参数的话，那么orig.ident的值就会是设置的值，没啥用，设不设置都一样用。</p><p>name为啥会这样呢，是因为CreateSeuratObject默认的样本识别机制：</p><p>帮助文档里面有两个参数：</p><blockquote><p>names.field:For the initial identity class for each cell, choose this field from the cell’s name. E.g. If your cells are named as BARCODE_CLUSTER_CELLTYPE in the input matrix, set names.field to 3 to set the initial identities to CELLTYPE.</p></blockquote><blockquote><p>names.delim:or the initial identity class for each cell, choose this delimiter from the cell’s column name. E.g. If your cells are named as BARCODE-CLUSTER-CELLTYPE, set this to “-” to separate the cell name into its component parts for picking the relevant field.</p></blockquote><p>其中names.field是指定列名里面的第几部分是初始分类(初始分类就是样本) names.delim是分隔符，上面说索的”第几部分“指的是按照某分隔符分割后的”第几部分“，默认值是_。</p><p>所以按照帮助文档里的例子就很好理解了：假如列名是BARCODE_CLUSTER_CELLTYPE的格式，默认值就是把按照”<em>“为分隔符(names.delim的默认值为”</em>)拆分出来的第1部分(names.field默认值为1)作为orig.ident！</p><p>这样也就理解了它是怎么给我们把一个样本拆成两个的：</p><pre><code><span><span>library</span>(stringr)</span><br><span><span>colnames</span>(a) <span>%&gt;%</span></span><br><span>  <span>str_split_i</span>(<span>"_"</span>,<span>1</span>) <span>%&gt;%</span></span><br><span>  <span>table</span>()</span></code></pre><pre><code>## .<br>##    1    2 <br>## 1596 3721</code></pre><p>和上面table(seu.obj$orig.ident)的结果是呼应的。</p><p>所以问题就是列名第一部分不统一。</p><h4><span>3.解决办法</span></h4><p>有很多种办法可以解决：</p><p>例如names.field = 2，忽略第一部分，按照第二部分，但第二部分是真正的barcode，每个细胞都不一样，所以就和正常的、没有前缀的数据会同等处理，都设为一个值。</p><pre><code><span>seu.obj <span>&lt;-</span> <span>CreateSeuratObject</span>(<span>counts =</span> a, </span><br><span>                              <span>min.cells =</span> <span>3</span>, </span><br><span>                              <span>min.features =</span> <span>200</span>,</span><br><span>                              <span>names.field =</span> <span>2</span>)</span><br><span><span>table</span>(seu.obj<span>$</span>orig.ident)</span></code></pre><pre><code>## <br>## SeuratProject <br>##          5317</code></pre><p>再例如names.delim=“,”，逗号可以换成任何一个在列名里不存在的符号，这样就会把全部列名识别为第一个部分。</p><pre><code><span>seu.obj <span>&lt;-</span> <span>CreateSeuratObject</span>(<span>counts =</span> a, </span><br><span>                              <span>min.cells =</span> <span>3</span>, </span><br><span>                              <span>min.features =</span> <span>200</span>,</span><br><span>                              <span>names.delim =</span> <span>","</span>)</span><br><span><span>table</span>(seu.obj<span>$</span>orig.ident)</span></code></pre><pre><code>## <br>## SeuratProject <br>##          5317</code></pre><p>再例如改列名，删掉前缀，不过这种方法有点风险，某些抽风数据会有重复的barcode。</p><pre><code><span><span>colnames</span>(a) <span>=</span> <span>str_split_i</span>(<span>colnames</span>(a) ,<span>"_"</span>,<span>2</span>) </span><br><span>seu.obj <span>&lt;-</span> <span>CreateSeuratObject</span>(<span>counts =</span> a, </span><br><span>                              <span>min.cells =</span> <span>3</span>, </span><br><span>                              <span>min.features =</span> <span>200</span>)</span><br><span><span>table</span>(seu.obj<span>$</span>orig.ident)</span></code></pre><pre><code>## <br>## SeuratProject <br>##          5317</code></pre><p>其实还有别的方法，比如RenameIdents(),就不一一列举了。</p><h4><span>4.总结</span></h4><p>需要了解单细胞对象，多多积累经验，寻找bug源头并杜绝它。</p><p>我发现后时候大家是被动的去解决问题，而不是寻找源头来杜绝，比如某位学员的思维是<strong>把</strong><span><strong>1和2合并然后去批次！</strong></span></p><p>事实是这个数据是一个样本，被分成两个仅仅是函数的默认参数与数据实际情况不符，这不是真的两个样本，既然被错误的拆分，我们就应该避免这个错误，而不是在错误的基础上继续往前走，都没有批次效应，何来去批次之说呢？</p><p>越发感觉到<strong><span>培养解决问题的思维比解决问题本身更重要</span></strong>。</p></section></section></section></section></section><section><section><br></section></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/mIHqcKHHhRcTLqLZMSplfw",target="_blank" rel="noopener noreferrer">原文链接</a>
