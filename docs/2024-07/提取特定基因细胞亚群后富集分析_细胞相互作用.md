---
title: "提取特定基因细胞亚群后富集分析-细胞相互作用"
date: 2024-07-28T21:41:20Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
提取特定基因细胞亚群后富集分析-细胞相互作用 by 生信菜鸟团
------
<div><section><blockquote><p>下一次上课竟然是七夕，七夕还能有人听课？<br>不过于我，差别不大哈哈哈哈哈</p></blockquote><p>这一次的主题起源于，怎么说呢，随便的一个想法（做完了之后发现，很多事不是不能深挖和解读，而是责任方不在自己的话，不会放在心上）<br>①选取一个数据集，总注释<br>②取出T&amp;NK亚群，细分注释<br>③取出Treg亚群，注释<br>④提取出Treg亚群中某个基因阳性的细胞，GO和GSVA分析<br>⑤这次不用合并的方式了，使用match ID的方式把后面细分的亚群注释挪到①的总注释中，cellchat相互作用分析</p><pre><code>rm(list=ls())<br>options(stringsAsFactors = F)<br>library(Seurat)<br>library(ggplot2)<br>library(clustree)<br>library(cowplot)<br>library(dplyr)<br>source(<span>'../scRNA_scripts/lib.R'</span>)<br>source(<span>'../scRNA_scripts/mycolors.R'</span>)<br>getwd()<br>set.seed(<span>12345</span>)<br>sce.all=sce<br>table(sce.all$celltype)<br>sce1 = sce.all[, sce.all$celltype %<span>in</span>% c( <span>'Treg'</span> )]<br>LayerData(sce1, assay = <span>"RNA"</span>, layer = <span>"counts"</span>)<br>sce1 &lt;- JoinLayers(sce1)<br><br>as.data.frame(sce1@assays$RNA$counts[<span>1</span><span>:</span><span>10</span>, <span>1</span><span>:</span><span>2</span>])<br>head(sce1@meta.data, <span>10</span>)<br>table(sce1$orig.ident) <br><br>sce = sce1<br>sce &lt;- NormalizeData(sce, normalization.method =  <span>"LogNormalize"</span>,  <br>                     scale.factor = <span>1</span>e4)<br>GetAssay(sce,assay = <span>"RNA"</span>)<br>sce &lt;- FindVariableFeatures(sce, <br>                            selection.method = <span>"vst"</span>, nfeatures = <span>2000</span>)  <br>sce &lt;- ScaleData(sce) <br>sce &lt;- RunPCA(object = sce, pc.genes = VariableFeatures(sce)) <br>DimHeatmap(sce, dims = <span>1</span><span>:</span><span>12</span>, cells = <span>100</span>, balanced = TRUE)<br>ElbowPlot(sce) <br><br>sce &lt;- FindNeighbors(sce, dims = <span>1</span><span>:</span><span>15</span>)<br>sce &lt;- FindClusters(sce, resolution = <span>0</span>.<span>3</span>)<br>table(sce@meta.data$RNA_snn_res.<span>0</span>.<span>3</span>)  <br><br>set.seed(<span>321</span>)<br>sce &lt;- RunTSNE(object = sce, dims = <span>1</span><span>:</span><span>15</span>, <span>do</span>.fast = TRUE)<br><br>sce &lt;- RunUMAP(object = sce, dims = <span>1</span><span>:</span><span>5</span>, <span>do</span>.fast = TRUE)<br><br>p = DimPlot(sce,label=T,cols = mycolors) <br>p<br><br><br><span>###提取特定基因表达的细胞亚群</span><br>library(Seurat)<br>library(dplyr)<br>DimPlot(sce, label = T)+NoLegend()<br>FeaturePlot(sce, features = <span>'TNFRSF9'</span>, pt.size = <span>1</span>)<br><br><br>expr &lt;- sce@assays$RNA$data<br>gene_expression &lt;- expr %&gt;% .[<span>"TNFRSF9"</span>,] %&gt;% as.data.frame()<br>colnames(gene_expression) &lt;- <span>"TNFRSF9"</span><br>gene_expression$cell &lt;- rownames(gene_expression)<br><br><br><br><span>#选择4-1BB阳性细胞,提取阳性Treg亚群</span><br>gene_expression_sel &lt;- gene_expression[which(gene_expression$TNFRSF9&gt;<span>0</span>),]<br>phe = sce@meta.data<br>phe$celltype2 = <span>'NA'</span><br>table(phe$celltype2)<br><br>phe$celltype2 &lt;- ifelse(rownames(phe) %<span>in</span>% rownames(gene_expression_sel), <span>"TNFRSF9_Treg"</span>, <span>"nonTNFRSF9_Treg"</span>)<br>table(phe$celltype2)<br>sce@meta.data = phe<br></code></pre><figure><img data-imgfileid="100042440" data-ratio="0.9046296296296297" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzwe32AHibt9hrPJCyeic0spl3ppecKuWIUTfq4axg7M2maIR1ib1CYkia9A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" title="图片.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzwe32AHibt9hrPJCyeic0spl3ppecKuWIUTfq4axg7M2maIR1ib1CYkia9A/640?wx_fmt=png&amp;from=appmsg"></figure><pre><code><span>###下面进行GO和GSVA分析</span><br>library(Seurat)<br>library(ggplot2)<br>library(clustree)<br>library(cowplot)<br>library(dplyr)<br>library(clusterProfiler)<br><br><span>source</span>(<span>'../scRNA_scripts/lib.R'</span>)<br><span>source</span>(<span>'../scRNA_scripts/mycolors.R'</span>)<br>Idents(sce)<br><br><span>###热图表示GO富集分析</span><br>library(grid)<br>library(ggplot2)<br>library(gridExtra)<br>library(clusterProfiler)<br>library(org.Hs.eg.db)<br>library(enrichplot)<br>library(ggplot2)<br>library(org.Hs.eg.db)<br>library(GOplot)<br>Idents(sce) = sce<span>$celltype2</span><br><br><span>if</span> (!file.exists(<span>'Tregmarkers.csv'</span>)) {<br>  markers &lt;- FindAllMarkers(object = sce, only.pos = TRUE, <br>                            min.pct = 0.25, <br>                            thresh.use = 0.25)<br>  write.csv(markers,file=<span>'Tregmarkers.csv'</span>)<br>} <span>else</span> {<br><br>  markers = read.csv(<span>'Tregmarkers.csv'</span>,row.names = 1)<br>}<br><br>table(markers<span>$cluster</span>)<br>library(dplyr) <br><br>ge = markers[markers<span>$p_val</span> &lt;0.05 &amp; markers<span>$avg_log2FC</span> &gt;0.5,]<br>ge1 = ge[ge<span>$cluster</span> == <span>'TNFRSF9_Treg'</span>,]<br>symbol = ge1<span>$gene</span><br><br>entrezIDs = bitr(symbol, fromType = <span>"SYMBOL"</span>, toType = <span>"ENTREZID"</span>, OrgDb= <span>"org.Hs.eg.db"</span>, drop = TRUE)<br>gene&lt;- entrezIDs<span>$ENTREZID</span><br><br>marker_new = markers[markers<span>$gene</span> %<span>in</span>% entrezIDs<span>$SYMBOL</span>,]<br>marker_new = marker_new[!duplicated(marker_new<span>$gene</span>),]<br>identical(marker_new<span>$gene</span>, entrezIDs<span>$SYMBOL</span>)<br><br>p = identical(marker_new<span>$gene</span>, entrezIDs<span>$SYMBOL</span>);p<br><span>if</span>(!p) entrezIDs = entrezIDs[match(marker_new<span>$gene</span>,entrezIDs<span>$SYMBOL</span>),]<br>marker_new<span>$ID</span> = entrezIDs<span>$ENTREZID</span><br><br><br><span>## GO</span><br>gcSample=split(marker_new<span>$ID</span>, marker_new<span>$cluster</span>) <br><span>###参数可以更改，看看?compareCluster</span><br><span>#One of "groupGO", "enrichGO", "enrichKEGG", "enrichDO" or "enrichPathway" </span><br>xx &lt;- compareCluster(gcSample,<br>                     fun = <span>"enrichGO"</span>,<br>                     OrgDb = <span>"org.Hs.eg.db"</span>,<br>                     ont = <span>"BP"</span>,<br>                     pAdjustMethod = <span>"BH"</span>,<br>                     pvalueCutoff = 0.01,<br>                     qvalueCutoff = 0.05<br>)<br><br>p &lt;- dotplot(xx)<br>library(ggthemes)<br>p + theme(axis.text.x = element_text(<br>  angle = 45,<br>  vjust = 0.5, hjust = 0.5<br>))+theme_few()<br></code></pre><figure><img data-imgfileid="100042437" data-ratio="0.6898148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzT0IlyAjTm4X7C6rrmy7GxvRORGcsRWE7V0NYwibdxGJ461LvaQpYc5Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" title="图片.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzT0IlyAjTm4X7C6rrmy7GxvRORGcsRWE7V0NYwibdxGJ461LvaQpYc5Q/640?wx_fmt=png&amp;from=appmsg"></figure><pre><code><span>###GSVA分析</span><br><span>library</span>(Seurat)<br><span>library</span>(msigdbr)<br><span>library</span>(GSVA)<br><span>library</span>(tidyverse)<br><span>library</span>(clusterProfiler)<br><span>library</span>(patchwork)<br><span>library</span>(limma)<br><br><span>#这里可以选择通路H或者任意C，由于我想要总表格挑一挑，所以全选了</span><br>genesets &lt;- msigdbr(species = <span>"Homo sapiens"</span>) <br>genesets &lt;- subset(genesets, select = c(<span>"gs_name"</span>,<span>"gene_symbol"</span>)) %&gt;% as.data.frame()<br>genesets &lt;- split(genesets$gene_symbol, genesets$gs_name)<br><br>expr &lt;- AverageExpression(sce, assays = <span>"RNA"</span>, slot = <span>"data"</span>)[[<span>1</span>]]<br>expr &lt;- expr[rowSums(expr)&gt;<span>0</span>,]  <span>#选取非零基因</span><br>expr &lt;- as.matrix(expr)<br>head(expr)<br><br><span># gsva默认开启全部线程计算</span><br>gsva.res &lt;- gsva(expr, genesets, method=<span>"gsva"</span>) <br>saveRDS(gsva.res, <span>"gsva.res.rds"</span>)<br>gsva.df &lt;- data.frame(Genesets=rownames(gsva.res), gsva.res, check.names = <span>F</span>)<br>write.csv(gsva.df, <span>"gsva_res.csv"</span>, row.names = <span>F</span>)<br>gsva_d = gsva.res[sample(nrow(gsva.res),<span>30</span>),]<br>pheatmap::pheatmap(gsva_d, show_colnames = <span>T</span>, <br>                   scale = <span>"row"</span>,angle_col = <span>"45"</span>,<br>                   color = colorRampPalette(c(<span>"navy"</span>, <span>"white"</span>, <span>"firebrick3"</span>))(<span>50</span>))<br><br><br><span># 气泡图</span><br>gsva_long &lt;- melt(gsva_d, id.vars = <span>"Genesets"</span>)<br><br><span># 创建气泡图</span><br>ggplot(gsva_long, aes(x = Var2, y = Var1, size = value, color = value)) +<br>  geom_point(alpha = <span>0.7</span>) +  <span># 使用散点图层绘制气泡，alpha设置点的透明度</span><br>  scale_size_continuous(range = c(<span>1</span>, <span>6</span>)) +  <span># 设置气泡大小的范围</span><br>  theme_minimal() + <br>  scale_color_gradient(low=<span>'#427183'</span>,high=<span>'#D2D470'</span>) +<br>  labs(x = <span>"Gene Set"</span>, y = <span>"Sample"</span>, size = <span>"GSVA Score"</span>)+<br>  theme(axis.text.x = element_text(angle = <span>45</span>,vjust = <span>0.5</span>,hjust = <span>0.5</span>))<br><br><br>saveRDS(sce, <span>"Treg_sce_celltype.rds"</span>)<br></code></pre><figure><img data-imgfileid="100042441" data-ratio="0.6898148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yz0eLdtQ2Ck8PbT1m7E7hKFJ6Bsu85k8yZ6TknYCXQnQqpEfwiaTiav7RA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" title="图片.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yz0eLdtQ2Ck8PbT1m7E7hKFJ6Bsu85k8yZ6TknYCXQnQqpEfwiaTiav7RA/640?wx_fmt=png&amp;from=appmsg"></figure><figure><img data-imgfileid="100042438" data-ratio="0.6944444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzZvGCqBX9zWicUs7RCZEuNHOKk2W0YcH5LZfiag8snbVFPaF0qDVbJBpQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" title="图片.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzZvGCqBX9zWicUs7RCZEuNHOKk2W0YcH5LZfiag8snbVFPaF0qDVbJBpQ/640?wx_fmt=png&amp;from=appmsg"></figure>CellChat可以回答以下生物学问题:<ul><li><p><span>细胞与细胞之间的通讯是否增强?</span></p></li><li><p><span>细胞类型之间的相互作用发生显著变化?</span></p></li><li><p><span>主要来源和目标在不同情况下如何变化 ?</span></p></li></ul><pre><code><span>###突然想到一个事，可以不把sce合并进去，而是直接把注释完成的celltype2替换进去</span><br><span>#按道理来说跟在第一步直接注释没多大区别吧？</span><br><span>#细胞亚群之间相互作用</span><br>library(Seurat)<br>options(stringsAsFactors = F)<br>library(SeuratObject)<br>library(ggplot2)<br>library(clustree)<br>library(cowplot)<br>library(dplyr)<br>library(CellChat)<br>Treg=sce<br>TNKsce=readRDS( <span>"TNKsce_celltype.rds"</span>)<br>Allsce = readRDS( <span>"sce_celltype.rds"</span>)<br>Treg_phe = sce@meta.data<br>TNK_phe = TNKsce@meta.data<br>All_phe = Allsce@meta.data<br>colnames(All_phe)<br>All_phe$celltype3 = All_phe$celltype<br>table(All_phe$celltype3)<br><br><span>####把Treg中的注释转换到TNK中</span><br>identical(rownames(Treg_phe),rownames(TNK_phe[TNK_phe$celltype == <span>'Treg'</span>,]))<br><br>indices &lt;- match(rownames(TNK_phe[TNK_phe$celltype == <span>'Treg'</span>, ]), rownames(Treg_phe))<br><span># 检查indices是否所有值都找到了对应的行名</span><br><span>if</span> (any(is.na(indices))) {<br>  warning(<span>"TNK_phe中某些'Treg'类型的行名在Treg_phe中没有找到对应的行名"</span>)<br>}<br>table(TNK_phe$celltype)<br><br><span># 使用Treg_phe中的celltype列的值来替换TNK_phe中的celltype</span><br>table(Treg_phe$celltype2)<br>TNK_phe$celltype[TNK_phe$celltype == <span>'Treg'</span>] &lt;- Treg_phe$celltype2[indices]<br>table(TNK_phe$celltype)<br><br><span>##随便验证一下，看转换的怎么样</span><br><span>#GSM6204111_P03_CTGCTCAAGGCGAACT-1</span><br>a = TNK_phe[ TNK_phe$celltype == <span>'TNFRSF9_Treg'</span>,]<br>identical(rownames(a),rownames(Treg_phe[Treg_phe$celltype2 == <span>'TNFRSF9_Treg'</span>,]))<br><br><br><span>####把TNK中的注释转换到All中</span><br>table(All_phe$celltype)<br>identical(rownames(TNK_phe),rownames(All_phe[All_phe$celltype == <span>'T&amp;NK'</span>,]))<br>indices &lt;- match(rownames(All_phe[All_phe$celltype == <span>'T&amp;NK'</span>, ]), rownames(TNK_phe))<br><br><span># 检查indices是否所有值都找到了对应的行名</span><br><span>if</span> (any(is.na(indices))) {<br>  warning(<span>"All_phe中某些'TNK'类型的行名在TNK_phe中没有找到对应的行名"</span>)<br>}<br><br>table(All_phe$celltype)<br>table(TNK_phe$celltype)<br>All_phe$celltype[All_phe$celltype == <span>'T&amp;NK'</span>] &lt;- TNK_phe$celltype[indices]<br>table(All_phe$celltype)<br><br><span>##验证</span><br>a = All_phe[ All_phe$celltype == <span>'Unkown'</span>,]<br>identical(rownames(a),rownames(TNK_phe[TNK_phe$celltype == <span>'Unkown'</span>,]))<br><br>Allsce@meta.data = All_phe<br><br>sce = Allsce<br>colnames(All_phe)<br>table(sce$patient)<br>table(sce$celltype)<br>Idents(sce) = sce$celltype<br>colnames(sce@meta.data)<br><br>names(sce@assays$RNA@layers)<br>sce[[<span>"RNA"</span>]]$counts <br><span># Alternate accessor function with the same result</span><br>LayerData(sce, assay = <span>"RNA"</span>, layer = <span>"counts"</span>)<br>sce<br><br>table(sce$treat)<br>naive = sce[, sce$treat %in% c( <span>'naive'</span>)]<br>treat = sce[, sce$treat %in% c( <span>'treated'</span>)]<br><br>save(sce,naive,treat,file = <span>'celltype_input.Rdata'</span>)<br><br>cellchatA = function(sce){<br>  <span>#创建cellchat对象</span><br>  cellchat &lt;- createCellChat(sce@assays$RNA$data, meta = sce@meta.data, group.by = <span>"celltype"</span>)<br>  levels(cellchat@idents)<br>  groupSize &lt;- as.numeric(table(cellchat@idents)) <br>  CellChatDB &lt;- CellChatDB.human<span>#导入配受体库</span><br>  showDatabaseCategory(CellChatDB) <span>#查看描述该数据库组成的饼状图</span><br>  <span>#直接使用CellChatDB全库进行细胞通讯分析：</span><br>  <span>##CellChatDB.use &lt;- CellChatDB </span><br>  CellChatDB.use &lt;- subsetDB(CellChatDB, search = <span>"Secreted Signaling"</span>)<span>#选择特定的信号来进行分析，这里还可以选择ECM-receptor和Cell-Cell Contact。 </span><br>  cellchat@DB &lt;- CellChatDB.use<br><br>  <span>#预处理表达数据以进行细胞间通讯分析</span><br>  <span># subset the expression data of signaling genes for saving computation cost</span><br>  cellchat &lt;- subsetData(cellchat)<br>  cellchat &lt;- identifyOverExpressedGenes(cellchat)<br>  cellchat &lt;- identifyOverExpressedInteractions(cellchat)<br>  <span># project gene expression data onto PPI network (optional)</span><br>  cellchat &lt;- projectData(cellchat, PPI.human) <span>#PPI.human PPI.mouse</span><br><br><br>  <span>###2.细胞通讯预测</span><br>  <span>#计算通信概率并推断通信网络</span><br>  <span>#Compute the communication probability and iC3D1er cellular communication network</span><br>  cellchat &lt;- computeCommunProb(cellchat)<br>  <span># Filter out the cell-cell communication if there are only few number of cells in certain cell groups</span><br>  <span>#这里还是不要过滤了，不然有些细胞亚群细胞数量过少被过滤掉之后会造成数据不一致而无法进行后续分析</span><br>  <span>#cellchat &lt;- filterCommunication(cellchat, min.cells = 10)</span><br>  <span>#2）提取配受体对细胞通讯结果表：</span><br>  df.net &lt;- subsetCommunication(cellchat, slot.name = <span>'net'</span>)<br>  head(df.net) <span>#得到配受体对细胞通讯结果表</span><br>  <span># #或访问其它感兴趣/特定的细胞通讯结果：</span><br>  <span># df.net1 &lt;- subsetCommunication(cellchat,</span><br>  <span>#                                sources.use = c('LC'),</span><br>  <span>#                                targets.use = c('FBN1+ FIB')) #访问特定细胞对子集</span><br>  <span># head(df.net1)</span><br>  df.net2 &lt;- subsetCommunication(cellchat, signaling = c(<span>'MIF'</span>)) <span>#访问特定信号通路子集</span><br>  head(df.net2)<br>  <span>#3）提取信号通路水平的细胞通讯表：</span><br>  cellchat &lt;- computeCommunProbPathway(cellchat) <span>#计算信号通路水平上的通讯概率</span><br>  df.netp &lt;- subsetCommunication(cellchat, slot.name = <span>'netP'</span>) <span>#得到信号通路水平细胞通讯表</span><br>  head(df.netp)<br><br>  <span>#4）细胞互作关系展示：</span><br>  <span>#计算细胞对间通讯的数量和概率强度</span><br>  cellchat &lt;- aggregateNet(cellchat)<br>  <span>return</span>(cellchat)<br>} <br><br>allcellchat = cellchatA(sce)<br>naivecellchat = cellchatA(naive)<br>treatcellchat = cellchatA(treat)<br><br><br>object.list &lt;- list(all = allcellchat,naive = naivecellchat,treat = treatcellchat )<br>cellchat &lt;- mergeCellChat(object.list, add.names = names(object.list), cell.prefix = TRUE)<br><br>gg1 &lt;- compareInteractions(cellchat, show.legend = F, group = c(<span>1</span>,<span>2</span>,<span>3</span>), measure = <span>"count"</span>)<br>gg2 &lt;- compareInteractions(cellchat, show.legend = F, group = c(<span>1</span>,<span>2</span>,<span>3</span>), measure = <span>"weight"</span>)<br>p &lt;- gg1 + gg2<br>p<br>ggsave(<span>"Overview_number_strength.pdf"</span>, p, width = <span>10</span>, height = <span>7</span>)<br></code></pre><p>其实有个问题，这个通讯数量和通讯强度的分析跟细胞数量有关系么，如果单看all组的细胞之间关系，是没有联系的。给药后就是会减少细胞间相互作用的数量和强度。<br></p><figure><img data-imgfileid="100042439" data-ratio="0.7055555555555556" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzEMvfVFgworfgbta6XJ1h5tV8KJxwXzM94rYMzicKDcd47hQPAV8b9nA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" title="图片.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzEMvfVFgworfgbta6XJ1h5tV8KJxwXzM94rYMzicKDcd47hQPAV8b9nA/640?wx_fmt=png&amp;from=appmsg"></figure><pre><code>par(mfrow = c(<span>1</span>,<span>2</span>))<br><span>##设置比较组：与2相比，3红色上调，蓝色下调</span><br><span>#这里就可以大概得到我的结论了，分析可以结束了，再就是进一步论证了</span><br>netVisual_diffInteraction(cellchat, weight.scale = <span>T</span>,comparison = c(<span>2</span>,<span>3</span>))<br>netVisual_diffInteraction(cellchat, weight.scale = <span>T</span>, measure = <span>"weight"</span>,comparison = c(<span>2</span>,<span>3</span>))<br></code></pre><figure><img data-imgfileid="100042447" data-ratio="0.5296296296296297" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzdYuz4j1WHXYeKzpHoyHVibWeE0kvmqfw4LQxfibKgLzkrqU79DBt4Spg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" title="图片.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzdYuz4j1WHXYeKzpHoyHVibWeE0kvmqfw4LQxfibKgLzkrqU79DBt4Spg/640?wx_fmt=png&amp;from=appmsg"></figure><br>相互作用的差异数量或相互作用强度。顶部的彩色条形图表示热图<strong>（incoming, 传入信号）</strong>中显示的数值列的和。右边的彩色条形图表示一行值的和<strong>（outgoing, 输出信号）</strong>。在颜色条中，红色(或蓝色)表示与第二个数据集相比，第三个数据集中的信号增加(或减少)。<pre><code><span>#差异性heatmap</span><br><span>gg1</span> &lt;- netVisual_heatmap(cellchat,comparison = c(<span>2</span>,<span>3</span>))<br>gg2 &lt;- netVisual_heatmap(cellchat, measure = <span>"weight"</span>,comparison = c(<span>2</span>,<span>3</span>))<br>gg1 + gg2<br></code></pre><figure><img data-imgfileid="100042443" data-ratio="0.7092592592592593" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzGySnuSW4TTQPMpfB3OZXl7nPMHIsic8tcCfzUpg8jUyhjF8QO1YLjrw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" title="图片.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzGySnuSW4TTQPMpfB3OZXl7nPMHIsic8tcCfzUpg8jUyhjF8QO1YLjrw/640?wx_fmt=png&amp;from=appmsg"></figure><pre><code># 比较二维空间中传出和传入的交互强度，可以方便地识别在不同数据集之间发送或接收信号发生显著变化的细胞群。<br>#BiocManager::install(<span>'netAnalysis'</span>)<br>library(netAnalysis)<br># 计算每个网络对象的中心性得分<br><span>for</span> (i <span>in</span> <span>1</span>:length(object.list)) {<br>  object.list<span>[[i]]</span> &lt;- netAnalysis_computeCentrality(object.list<span>[[i]]</span>)<br>}<br><br># 计算链接的总数，不包括对角线上的值<br>num.link &lt;- sapply(object.list, <span><span>function</span><span>(x)</span></span> {rowSums(x@net$count) + colSums(x@net$count) - diag(x@net$count)})<br><br># 设置权重的最小值和最大值，用于控制不同数据集中点的大小<br>weight.MinMax &lt;- c(<span>min</span>(num.link), <span>max</span>(num.link))<br><br>gg &lt;- list()<br><span>for</span> (i <span>in</span> <span>1</span>:length(object.list)) {<br>  gg<span>[[i]]</span> &lt;- netAnalysis_signalingRole_scatter(object.list<span>[[i]]</span>, <br>                                               title = names(object.list)[i], <br>                                               weight.MinMax = weight.MinMax)<br>}<br><br>patchwork::wrap_plots(plots = gg)<br></code></pre><p>治疗后看起来没什么特异的source和targets，myeloid变化稍大。<br></p><figure><img data-imgfileid="100042444" data-ratio="0.537962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzAgYLj2BKN07uGicVpjF5yjXT30uXrjOhcCibRxTapsibB527lpjWys2XQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" title="图片.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzAgYLj2BKN07uGicVpjF5yjXT30uXrjOhcCibRxTapsibB527lpjWys2XQ/640?wx_fmt=png&amp;from=appmsg"><figcaption><br></figcaption></figure><pre><code><span>## 通路信号强度对比分析</span><br><span>#comparison可以修改</span><br><span>#红色的顶级信号通路在naive富集，而这些绿色的信号通路在treat富集。</span><br>gg1 &lt;- rankNet(cellchat, mode = <span>"comparison"</span>, stacked = T, <span>do</span>.stat = <span>TRUE</span>,comparison = c(<span>2</span>,<span>3</span>))<br>gg2 &lt;- rankNet(cellchat, mode = <span>"comparison"</span>, stacked = F, <span>do</span>.stat = <span>TRUE</span>,comparison = c(<span>2</span>,<span>3</span>))<br>p &lt;- gg1 + gg2<br>p<br></code></pre><p>明显可以看到红色的顶级信号通路在naive富集，而这些绿色的信号通路在treat富集。<br></p><figure><img data-imgfileid="100042445" data-ratio="0.5425925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yz6Iibq9kXicic6Za9eiauZVcRiaGvtlTydVXDyh69UHArCY0xSW0P1THKt9A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" title="图片.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yz6Iibq9kXicic6Za9eiauZVcRiaGvtlTydVXDyh69UHArCY0xSW0P1THKt9A/640?wx_fmt=png&amp;from=appmsg"><figcaption><br></figcaption></figure><pre><code>pathways.show &lt;- c(<span>"CXCL"</span>) <br>weight.<span>max</span> &lt;- getMaxWeight(object.list, slot.name = c(<span>"netP"</span>), attribute = pathways.show) <br>par(mfrow = c(<span>1</span>,<span>3</span>), xpd=TRUE)<br><span>for</span> (i <span>in</span> <span>1</span>:length(object.list)) {<br>  netVisual_aggregate(object.list<span>[[i]]</span>, signaling = pathways.show, layout = <span>"circle"</span>, <br>                      edge.weight.<span>max</span> = weight.<span>max</span>[<span>1</span>], edge.width.<span>max</span> = <span>10</span>, <br>                      signaling.name = paste(pathways.show, names(object.list)[i]))<br>}<br></code></pre><p>如果拿上面的结果看CXCL，确实是在treat中增加<br></p><figure><img data-imgfileid="100042442" data-ratio="0.3416666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzS2zlfZJP50V71uricBzmRyhnEJ49VrOpkGSVjeXIhy4G7oWbZPqV7lw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" title="图片.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibusicibiaib5aKxcRkafh7B8yzS2zlfZJP50V71uricBzmRyhnEJ49VrOpkGSVjeXIhy4G7oWbZPqV7lw/640?wx_fmt=png&amp;from=appmsg"><figcaption><br></figcaption></figure>到这里我的猜测可以得到初步结论，看后续还需要加一些什么分析。<br><strong>如果有任何疑问或建议，请随时提出~很高兴和大家交流</strong><p><br></p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/6PyGPO7vMNlr1OtGjZHFLw",target="_blank" rel="noopener noreferrer">原文链接</a>
