---
title: "使用人工智能优化一个数据库文件批量下载脚本"
date: 2024-07-12T00:06:26Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
使用人工智能优化一个数据库文件批量下载脚本 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>学完了生信技能树的马拉松授课，算是掌握了跟人工智能对话的基础，比如前些日子看到的练习题：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247531829&amp;idx=1&amp;sn=f19207a03463c4cb9380a32747ac2e2d&amp;scene=21#wechat_redirect" data-linktype="2">PDX小鼠模型的单细胞样品定量能选择人类参考基因组吗</a>，是需要下载这个CRA010501数据集里面的单细胞转录组样品的fq文件，然后走cellranger定量流程，选择人类以及小鼠参考基因组，各自走一遍定量流程，然后两个表达量矩阵分开做一下降维聚类分群哈， 看看背后是否有一些被忽略的生物学现象。</p></blockquote><p data-tool="mdnice编辑器">需要使用的数据库文件批量下载脚本是 ：</p><pre data-tool="mdnice编辑器"><span></span><code><span>for</span> i <span>in</span> {34..39};<span>do</span> (  axel -n 20 https://download.cncb.ac.cn/gsa2/CRA010501/CRR7274<span>${i}</span>/CRR7274<span>${i}</span>_f1.fq.gz );<span>done</span><br><span>for</span> i <span>in</span> {34..39};<span>do</span> (  axel -n 20 https://download.cncb.ac.cn/gsa2/CRA010501/CRR7274<span>${i}</span>/CRR7274<span>${i}</span>_r2.fq.gz );<span>done</span><br></code></pre><p data-tool="mdnice编辑器">如果网络好基本上也就是等一个晚上就下载完毕，<span><strong>但是大部分情况下，这个下载会中断！</strong></span></p><h3 data-tool="mdnice编辑器"><span></span><span>我首先让人工智能帮我解析了这个脚本</span><span></span></h3><p data-tool="mdnice编辑器">这段Shell脚本代码是一个简单的循环，用于在指定的数字范围内（34到39）执行一个下载命令。下面是对代码的逐行解析：</p><pre data-tool="mdnice编辑器"><span></span><code>for i in {34..39}; do<br></code></pre><ul data-tool="mdnice编辑器"><li><section><code>for i in {34..39}</code>：这是一个<code>for</code>循环，<code>i</code>是循环变量，<code>{34..39}</code>是一个序列表达式，表示从34开始到39结束的整数序列。每次循环，<code>i</code>依次取34, 35, 36, 37, 38, 39这些值。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>( axel -n 20 https://download.cncb.ac.cn/gsa2/CRA010501/CRR7274${i}/CRR7274${i}_f1.fq.gz )<br></code></pre><ul data-tool="mdnice编辑器"><li><section><code>axel</code>：这是一个下载工具，用于下载网络文件。它类似于<code>wget</code>，但通常提供更快的下载速度。</section></li><li><section><code>-n 20</code>：<code>axel</code>的选项，表示同时进行20个下载线程。</section></li><li><section><code>https://download.cncb.ac.cn/gsa2/CRA010501/CRR7274${i}/CRR7274${i}_f1.fq.gz</code>：这是下载文件的URL。<code>${i}</code>会被替换为当前循环的值，例如在第一次循环中，<code>${i}</code>会被替换为34，从而下载<code>CRR727434_f1.fq.gz</code>文件。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>done<br></code></pre><ul data-tool="mdnice编辑器"><li><section><code>done</code>：表示<code>for</code>循环的结束。</section></li></ul><p data-tool="mdnice编辑器">整个脚本的作用是使用<code>axel</code>工具并发下载序列34到39对应的<code>.fq.gz</code>文件。这些文件名遵循模式<code>CRR7274XX_f1.fq.gz</code>，其中<code>XX</code>是循环变量<code>i</code>的值。</p><p data-tool="mdnice编辑器">需要注意的是，这个脚本中的URL是硬编码的，假设文件结构和URL模式是匹配的。如果URL模式与实际文件结构不匹配，脚本将无法正确下载文件。此外，脚本没有错误处理机制，例如处理下载失败的情况。在实际使用中，可能需要添加适当的错误检查和日志记录。</p><h3 data-tool="mdnice编辑器"><span></span><span>然后让人工智能帮我修改了它</span><span></span></h3><p data-tool="mdnice编辑器"><strong>因为理论上这个代码应该是下载6个文件，但是经常运行卡死，然后就成功了3个文件，需要改进！！！</strong></p><p data-tool="mdnice编辑器">如果脚本在下载过程中卡死，但最终只成功下载了3个文件，可能是由于几个原因造成的，例如网络问题、服务器限制、本地磁盘写入问题或者<code>axel</code>命令的稳定性等。以下是一些建议来改进脚本：</p><ol data-tool="mdnice编辑器"><li><section><p><strong>增加错误处理</strong>：使用<code>set -e</code>来使脚本在遇到错误时立即退出，这样可以更快地发现问题所在。</p></section></li><li><section><p><strong>检查网络连接</strong>：确保网络连接稳定，如果可能的话，使用带有重试机制的下载工具，如<code>curl</code>或<code>wget</code>的重试选项。</p></section></li><li><section><p><strong>限制并发数</strong>：如果服务器对并发连接数有限制，可能需要减少<code>-n</code>参数指定的线程数。</p></section></li><li><section><p><strong>磁盘空间检查</strong>：确保有足够的磁盘空间来存储下载的文件。</p></section></li><li><section><p><strong>使用重试逻辑</strong>：为下载命令添加重试逻辑，例如使用<code>axel -a -n 20 URL</code>，其中<code>-a</code>选项会在下载失败时重试。</p></section></li><li><section><p><strong>日志记录</strong>：使用日志记录每个下载尝试的结果，便于事后分析问题。</p></section></li><li><section><p><strong>检查服务器限制</strong>：检查下载服务器是否有任何速率限制或IP封锁策略。</p></section></li><li><section><p><strong>使用其他下载工具</strong>：如果<code>axel</code>不稳定，可以尝试使用其他下载工具，比如<code>wget</code>或<code>curl</code>。</p></section></li><li><section><p><strong>增加延时</strong>：在循环中增加延时，避免同时对服务器发起过多请求。</p></section></li><li><section><p><strong>检查磁盘写入权限</strong>：确保脚本运行的用户有足够的权限在目标目录写入文件。</p></section></li><li><section><p><strong>使用断点续传</strong>：使用支持断点续传的下载工具，这样即使下载中断也可以从中断的地方继续下载。</p></section></li><li><section><p><strong>监控下载进度</strong>：使用<code>axel</code>的<code>--progress</code>选项来监控下载进度。</p></section></li><li><section><p><strong>使用脚本监控工具</strong>：使用如<code>screen</code>或<code>tmux</code>等工具来运行脚本，这样即使终端会话断开，下载进程也不会终止。</p></section></li></ol><p data-tool="mdnice编辑器">下面是添加了一些改进的脚本示例：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#</span><span>!/bin/bash</span><br><br>set -e  # 遇到错误立即退出<br><br>for i in {34..39}; do<br>    echo "开始下载文件：CRR7274${i}_f1.fq.gz"<br>    axel -q -a -n 20 https://download.cncb.ac.cn/gsa2/CRA010501/CRR7274${i}/CRR7274${i}_f1.fq.gz || true  # 重试逻辑，失败不退出<br>    if [ $? -eq 0 ]; then<br>        echo "下载成功：CRR7274${i}_f1.fq.gz"<br>    else<br>        echo "下载失败：CRR7274${i}_f1.fq.gz"<br>    fi<br>    sleep 1  # 增加延时<br>done<br></code></pre><p data-tool="mdnice编辑器">这个脚本在每次下载尝试失败后不会退出，而是继续尝试下载下一个文件，并且在每次下载尝试之间增加了一秒的延时。同时，脚本会在控制台输出每次下载的开始和结束状态。</p><p data-tool="mdnice编辑器">值得注意的是人工智能说其中<code>-a</code>选项会在下载失败时重试，但似乎这个知识点有问题！而且很明显上面的代码虽然说最后都会给出来很好的日志信息，但是并不能成功下载：</p><pre data-tool="mdnice编辑器"><span></span><code>cat nohup.out <br>开始下载文件：CRR727434_f1.fq.gz<br>SSL error: (null)<br>下载成功：CRR727434_f1.fq.gz<br>开始下载文件：CRR727435_f1.fq.gz<br>SSL error: (null)<br>下载成功：CRR727435_f1.fq.gz<br>开始下载文件：CRR727436_f1.fq.gz<br>下载成功：CRR727436_f1.fq.gz<br>开始下载文件：CRR727437_f1.fq.gz<br>SSL error: (null)<br>下载成功：CRR727437_f1.fq.gz<br>开始下载文件：CRR727438_f1.fq.gz<br>SSL error: (null)<br>下载成功：CRR727438_f1.fq.gz<br>开始下载文件：CRR727439_f1.fq.gz<br>下载成功：CRR727439_f1.fq.gz<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>最后我让它介绍了一下这个数据库本</span><span></span></h3><p data-tool="mdnice编辑器"><code>download.cncb.ac.cn</code> 是中国科学院北京基因组研究所（China National Center for Biotechnological Information, CNCB）提供的数据库下载站点。这个数据库主要提供与基因组学相关的数据下载服务，包括但不限于以下几类：</p><ol data-tool="mdnice编辑器"><li><section><p><strong>基因组序列数据</strong>：提供不同物种的完整基因组序列或特定区域的序列数据。</p></section></li><li><section><p><strong>转录组数据</strong>：包括RNA测序（RNA-Seq）数据，用于研究基因表达模式。</p></section></li><li><section><p><strong>蛋白质组数据</strong>：提供蛋白质鉴定和定量的数据。</p></section></li><li><section><p><strong>表观遗传学数据</strong>：如DNA甲基化、组蛋白修饰等数据。</p></section></li><li><section><p><strong>变异和多态性数据</strong>：包括单核苷酸多态性（SNPs）、插入/缺失（InDels）等。</p></section></li><li><section><p><strong>其他组学数据</strong>：例如代谢组学、微生物组学等。</p></section></li></ol><p data-tool="mdnice编辑器">关于ID系列的规则，不同的数据库可能有不同的命名规则，但通常这些ID遵循一定的命名约定，以确保它们是唯一的并能够提供关于数据的有用信息。例如：</p><ul data-tool="mdnice编辑器"><li><section><p><strong>项目或样本标识符</strong>：通常是一个独特的参考编号，如<code>CRA010501</code>或<code>CRR7274</code>，可能代表一个特定的研究项目或样本。</p></section></li><li><section><p><strong>序列标识符</strong>：可能包含序列类型和数字，如<code>f1.fq.gz</code>可能表示FASTQ格式的第一条序列。</p></section></li><li><section><p><strong>文件扩展名</strong>：指示文件格式，如<code>.gz</code>表示GZIP压缩文件，<code>.fq</code>或<code>.fastq</code>表示FASTQ文件。</p></section></li><li><section><p><strong>版本号或部分编号</strong>：有时ID可能包含版本信息或部分数据标识，如<code>1</code>、<code>2</code>等。</p></section></li><li><section><p><strong>组合ID</strong>：一些ID可能组合了多个元素，如<code>CRR7274${i}</code>，其中<code>${i}</code>是一个变量，代表序列中的特定部分或样本编号。</p></section></li></ul><p data-tool="mdnice编辑器">如果需要了解特定数据库的ID规则，通常可以查看数据库的用户指南或FAQ部分，或者直接联系数据库的管理员获取更详细的信息。由于数据库的具体规则可能随时更新，获取最新的信息总是一个好主意。对于<code>download.cncb.ac.cn</code>数据库，如果需要更具体的信息，建议访问其官方网站或联系他们的技术支持获取帮助。</p><h3 data-tool="mdnice编辑器"><span></span><span>其实是需要借助于高级工具（这一点目前人工智能无解啊）</span><span></span></h3><p data-tool="mdnice编辑器">其实是需要看官网了，因为人工智能并没有太多关于这个中国科学院北京基因组研究所（China National Center for Biotechnological Information, CNCB）提供的数据库下载站点的信息，所以它也很陌生，我是自己去看官网才发现：</p><p data-tool="mdnice编辑器"><strong>提示：HTTP下载速度有限，推荐使用Egde Turbo或FTP客户端（比如 FileZilla Client）下载数据。EgdeTurbo支持Linux命令行、Windows/Mac平台的Chrome、Edge和Firefox浏览器。就需要自己下载edgeturbo这个二进制软件，然后使用它的download 命令即可，在linux终端上输入以下命令进行下载软件：</strong></p><pre data-tool="mdnice编辑器"><span></span><code>mkdir -p ~/biosoft/<br><span>cd</span> ~/biosoft/<br>wget https://ngdc.cncb.ac.cn/ettrans/download/edgeturbo-client.linux.latest.cncb.tar.gz<br></code></pre><p data-tool="mdnice编辑器">然后解压即可使用啦</p><pre data-tool="mdnice编辑器"><span></span><code>tar -zxvf edgeturbo-client.linux.latest.cncb.tar.gz<br> ~/biosoft/edgeturbo-client/edgeturbo --<span>help</span> <br></code></pre><p data-tool="mdnice编辑器">比如我们上面练习题：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247531829&amp;idx=1&amp;sn=f19207a03463c4cb9380a32747ac2e2d&amp;scene=21#wechat_redirect" data-linktype="2">PDX小鼠模型的单细胞样品定量能选择人类参考基因组吗</a>，是需要下载这个CRA010501数据集里面的单细胞转录组样品的fq文件，只需要一行代码即可，非常方便！</p><pre data-tool="mdnice编辑器"><span></span><code> ~/biosoft/edgeturbo-client/edgeturbo  dl /gsa2/CRA010501/ <br></code></pre><p data-tool="mdnice编辑器">基本上两三个小时就下载完毕了；</p><pre data-tool="mdnice编辑器"><span></span><code>├── [4.0K]  CRR727434<br>│   ├── [10.0G]  CRR727434_f1.fq.gz<br>│   ├── [ 11G]  CRR727434_r2.fq.gz<br>│   └── [1.1K]  CRR727434_sta.xml<br>├── [4.0K]  CRR727435<br>│   ├── [ 12G]  CRR727435_f1.fq.gz<br>│   ├── [ 13G]  CRR727435_r2.fq.gz<br>│   └── [1.1K]  CRR727435_sta.xml<br>├── [4.0K]  CRR727436<br>│   ├── [ 17G]  CRR727436_f1.fq.gz<br>│   ├── [ 18G]  CRR727436_r2.fq.gz<br>│   └── [1.1K]  CRR727436_sta.xml<br>├── [4.0K]  CRR727437<br>│   ├── [ 14G]  CRR727437_f1.fq.gz<br>│   ├── [ 14G]  CRR727437_r2.fq.gz<br>│   └── [1.1K]  CRR727437_sta.xml<br>├── [4.0K]  CRR727438<br>│   ├── [ 12G]  CRR727438_f1.fq.gz<br>│   ├── [ 13G]  CRR727438_r2.fq.gz<br>│   └── [1.1K]  CRR727438_sta.xml<br>├── [4.0K]  CRR727439<br>│   ├── [ 12G]  CRR727439_f1.fq.gz<br>│   ├── [ 13G]  CRR727439_r2.fq.gz<br>│   └── [1.1K]  CRR727439_sta.xml<br>└── [ 876]  md5sum.txt<br><br>6 directories, 19 files<br></code></pre><p data-tool="mdnice编辑器">而且很容易检测 md5sum.txt，说明下载的文件是完整的。接下来就完完全全参考 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247522953&amp;idx=1&amp;sn=9e86346a6de21d02bc0c770f3d2734a6&amp;scene=21#wechat_redirect" data-linktype="2">小鼠的5个样品的10x技术单细胞转录组上游定量（文末赠送全套代码）</a>，走<strong>cellranger</strong>流程即可。而且大家在完成作业的时候可以根据留言选择</p><p><img data-galleryid="" data-imgfileid="100048250" data-ratio="0.4388888888888889" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz1wvCrCMZrsM6VAj05wA9cicK47qNOgIIYRusySNpJclJtOtjL2CcF69kZdC74wRGicRxbBfJQiafPw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz1wvCrCMZrsM6VAj05wA9cicK47qNOgIIYRusySNpJclJtOtjL2CcF69kZdC74wRGicRxbBfJQiafPw/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器"><br></p></section><p><img data-galleryid="" data-imgfileid="100048249" data-ratio="0.6714285714285714" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz1wvCrCMZrsM6VAj05wA9cW82myv8bDSUHdPJFHBxUW0Oo9bdoXST6sTRlv9mv3RCa6x7YE0z1HQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="840" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz1wvCrCMZrsM6VAj05wA9cW82myv8bDSUHdPJFHBxUW0Oo9bdoXST6sTRlv9mv3RCa6x7YE0z1HQ/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/zh6C968j6JSBKDKu6vLdQw",target="_blank" rel="noopener noreferrer">原文链接</a>
