---
title: "草履虫都会做的对角线渐变火山图(二)"
date: 2024-07-26T00:45:52Z
draft: ["false"]
tags: [
  "fetched",
  "MS driven Multiomics"
]
categories: ["Acdemic"]
---
草履虫都会做的对角线渐变火山图(二) by MS driven Multiomics
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span>对角线渐变火山图</span></h1><blockquote data-tool="mdnice编辑器"><p>拒绝千篇一律，<span>对角线<span>渐变</span>火山图</span>提供不一样的数据可视化形式</p></blockquote><p data-tool="mdnice编辑器">对角线火山图或者45°倾斜火山图：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100000664" data-ratio="0.8333333333333334" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVKBoAcM8dPe1ibf9S0Hu5tqico5IwgapsDBtLnxFscrZ7uP3eNdrTkuJfohtgbicJ16c6Zct3lPaFicg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVKBoAcM8dPe1ibf9S0Hu5tqico5IwgapsDBtLnxFscrZ7uP3eNdrTkuJfohtgbicJ16c6Zct3lPaFicg/640?wx_fmt=png&amp;from=appmsg"><figcaption>volcano</figcaption></figure><h2 data-tool="mdnice编辑器"><span><span>1</span></span><span>数据准备</span></h2><p data-tool="mdnice编辑器">inputfile中放入差异筛选结果(.xlsx，如下图demo.xlsx)和样本分组信息表(.csv，见下图group.csv)，demo数据中包括每个样本的intensity, 代谢物名称, VIP, P value以及Fold Change信息：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100000663" data-ratio="0.4564814814814815" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVKBoAcM8dPe1ibf9S0Hu5tqu1ib8ESJGwXQAFlKuBTJrfEoKKtWJfTSwd3cPmaiaodZeTMBRCnewXKg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVKBoAcM8dPe1ibf9S0Hu5tqu1ib8ESJGwXQAFlKuBTJrfEoKKtWJfTSwd3cPmaiaodZeTMBRCnewXKg/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20240103200012380</figcaption></figure><h2 data-tool="mdnice编辑器"><span><span>2</span></span><span>设置差异筛选阈值以及标签个数</span></h2><p data-tool="mdnice编辑器">设置差异筛选阈值 Fold change=1.5, p value&lt;0.05, VIP&gt;=1作为差异物筛选标准，设置labelNumber=10代表对上调和下调差异物中可信度最高的前10个进行展示(上调和下调各10个)：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br><span>library</span>(tidyverse)<br><span>#setting threshold </span><br>fold_change=<span>1.5</span><br>pvalue=<span>0.05</span><br>vip=<span>1</span><br>labelNumber=<span>10</span><span># the numbers of labeled metabolites in plot</span><br></code></pre><h2 data-tool="mdnice编辑器"><span><span>3</span></span><span>数据清洗和差异筛选</span></h2><p data-tool="mdnice编辑器">读取数据并按照上述阈值对代谢物进行差异筛选，同时计算差异物可信度得分值score：</p><pre data-tool="mdnice编辑器"><span></span><code><br>files.csv &lt;- fs::dir_ls(<span>"inputfile"</span>,recurse = <span>TRUE</span>,glob = <span>"*.csv"</span>)<br>dat.group &lt;-  map_dfc(files.csv,read_csv) <br><br><br><span>#loading and reshaping data</span><br>files &lt;- fs::dir_ls(<span>"inputfile"</span>,recurse = <span>TRUE</span>,glob = <span>"*.xlsx"</span>)<br>files_names &lt;- str_extract(files,<span>"(?&lt;=\\/).*(?=\\.)"</span>)<br>dat &lt;- map_dfr(files, openxlsx::read.xlsx) %&gt;% <br>  mutate(<br>    log2FC = log2(Fold_Change),<br>    Type = case_when(<br>      VIP &gt;= vip &amp; p_value &lt;= pvalue &amp; log2FC &gt;= log2(fold_change) ~ <span>"up-regulated"</span>,<br>      VIP &gt;= vip &amp; p_value &lt;= pvalue &amp; log2FC &lt;= log2(<span>1</span> / fold_change) ~ <span>"down-regulated"</span>,<br>      <span>TRUE</span> ~ <span>"insig"</span><br>    ),<br>    score = sqrt(VIP^<span>2</span> + log2FC^<span>2</span> + p_value^<span>2</span>)<br>  ) %&gt;% <br>  group_by(Type) %&gt;%<br>  arrange(Type, desc(score)) %&gt;%<br>  mutate(<br>    label = ifelse(<br>      Type %<span>in</span>% c(<span>"up-regulated"</span>, <span>"down-regulated"</span>) &amp; row_number() &lt;= min(<br>        labelNumber, sum(Type %<span>in</span>% c(<span>"up-regulated"</span>, <span>"down-regulated"</span>))),<br>      metabolites, <br>      <span>""</span><br>    )<br>  ) %&gt;%<br>  ungroup() %&gt;% <br>  mutate(<br>    label = case_when(<br>      Type == <span>"up-regulated"</span>&amp;label!=<span>""</span> ~ paste0(<span>"(up) "</span>, label),<br>      Type == <span>"down-regulated"</span>&amp;label!=<span>""</span> ~ paste0(<span>"(down) "</span>, label),<br>      <span>TRUE</span> ~ label<br>    )<br>  )<br></code></pre><h2 data-tool="mdnice编辑器"><span><span>4</span></span><span>绘图数据准备</span></h2><p data-tool="mdnice编辑器">计算每个代谢物的intensity在每个组中的均值：</p><pre data-tool="mdnice编辑器"><span></span><code>dat.plot &lt;- dat %&gt;% select(all_of(c(<span>"metabolites"</span>,dat.group$sample))) %&gt;% <br>  pivot_longer(!metabolites,names_to = <span>"sample"</span>,values_to = <span>"intensity"</span>) %&gt;% <br>  left_join(dat.group,by = <span>'sample'</span>) %&gt;% <br>  group_by(metabolites,group) %&gt;% <br>  summarise(mean = mean(intensity)) %&gt;% <br>  pivot_wider(names_from = group, values_from = mean, <br>              names_prefix = <span>"mean_"</span>, values_fn = list(mean = mean)) %&gt;% <br>  merge(dat,by = <span>'metabolites'</span>)<br></code></pre><p data-tool="mdnice编辑器">差异筛选条件作为Title，并加载本地配色方案colorpalettes.RData：</p><pre data-tool="mdnice编辑器"><span></span><code><br><span>#title</span><br>Title &lt;- paste0(<span>'Difference threshold: |log2FC|&gt;='</span>,round( log2(fold_change),<span>3</span>),<br>                <span>" &amp; pvalue&lt;"</span>,pvalue,<span>" &amp; VIP&gt;="</span>,vip)<br>load(<span>"colorpalettes.RData"</span>)<span>#color</span><br></code></pre><p data-tool="mdnice编辑器">将筛选阈值作为title，并加载本地配色方案<span>colorpalettes.RData</span>：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#title</span><br>Title &lt;- paste0(<span>'Difference threshold: |log2FC|&gt;='</span>,round( log2(fold_change),<span>3</span>),<br>                <span>" &amp; pvalue&lt;"</span>,pvalue,<span>" &amp; VIP&gt;="</span>,vip)<br>load(<span>"colorpalettes.RData"</span>)<span>#color</span><br></code></pre><h2 data-tool="mdnice编辑器"><span><span>5</span></span><span>可视化</span></h2><pre data-tool="mdnice编辑器"><span></span><code><span>#plotting</span><br>volcano &lt;- ggplot(data=dat.plot,aes(x=log10(mean_normal+<span>1</span>),y=log10(mean_disease+<span>1</span>))) +<br>  geom_point(aes(color =score,size=score)) + <br>  scale_color_gradientn(colors =colorpalettes)+<br>  scale_radius(range=c(<span>1</span>,<span>4</span>),guide=<span>NULL</span>)+<br>  labs(x = <span>"log10(Mean of Normal sample)"</span>, <br>       y = <span>"log10(Mean of Disease sample)"</span>, <br>       title = <span>"Volcano of metabolites"</span>,<br>       subtitle = Title) +<br>  theme_classic(base_size = <span>12</span>) +<br>  ggrepel::geom_text_repel(aes(label = label), <br>                           max.overlaps =labelNumber*<span>10</span>,<br>                           color = <span>"#3288BD"</span>, <br>                           vjust = <span>0.8</span>, size = <span>2.8</span>, alpha = <span>0.7</span>) +<br>  theme(plot.title = element_text(size = <span>15</span>, hjust = <span>0.5</span>),<br>        plot.subtitle = element_text(size = <span>10</span>, hjust = <span>0.5</span>))<br><span>#saving</span><br>ggsave(<span>"outputfile/volcano.png"</span>, plot=volcano, width=<span>6</span>, height=<span>5</span>, dpi=<span>300</span>)<br>ggsave(<span>"outputfile/volcano.pdf"</span>, plot=volcano, width =<span>6</span>, height = <span>5</span>,onefile=<span>F</span>)<br></code></pre><p data-tool="mdnice编辑器">volcano:<img data-imgfileid="100000671" data-ratio="0.8333333333333334" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVKBoAcM8dPe1ibf9S0Hu5tqico5IwgapsDBtLnxFscrZ7uP3eNdrTkuJfohtgbicJ16c6Zct3lPaFicg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVKBoAcM8dPe1ibf9S0Hu5tqico5IwgapsDBtLnxFscrZ7uP3eNdrTkuJfohtgbicJ16c6Zct3lPaFicg/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">需要注意<span>geom_text_repel()</span>函数中<span>max.overlaps</span>参数的设置，如果太小，可能会造成标签显示不全</p><blockquote data-tool="mdnice编辑器"><p>对角线火山图适合P值非常小的基因、蛋白或者代谢物较多的数据，但是此时不能将P或者有P参与的评价标准作为颜色或者尺寸映射；<br>对角线火山图配合渐变效果，也适合差异较少或者强调可信度较高的显著性差异物；<br>demo数据见Q群570484875</p></blockquote><figure data-tool="mdnice编辑器"><img data-croporisrc="https://mmbiz.qlogo.cn/mmbiz_jpg/yDgqbg2dgMVKBoAcM8dPe1ibf9S0Hu5tqDYpicaicwaowMZIoWqJR6Fo32P2qzwV8aQkZN6GIjScza4w4ognn0kLw/0?wx_fmt=jpeg&amp;from=appmsg" data-cropx1="157.4480286738351" data-cropx2="1060.7025089605734" data-cropy1="350.1146953405018" data-cropy2="1485.3978494623655" data-imgfileid="100000662" data-ratio="1.256921373200443" data-type="jpeg" data-w="903" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yDgqbg2dgMVKBoAcM8dPe1ibf9S0Hu5tqMEmUk4eKAQF3kLWSUCl4GAmS0w5tj0smIFgh7EQHGb7FAzXJhjUDFw/640?wx_fmt=jpeg" src="https://mmbiz.qpic.cn/mmbiz_jpg/yDgqbg2dgMVKBoAcM8dPe1ibf9S0Hu5tqMEmUk4eKAQF3kLWSUCl4GAmS0w5tj0smIFgh7EQHGb7FAzXJhjUDFw/640?wx_fmt=jpeg"><figcaption>f87dcde7eaf20ab6e2f0af83fa8e1f3</figcaption></figure></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/pkKxhUgGgSC5cS6kbmV-MA",target="_blank" rel="noopener noreferrer">原文链接</a>
