---
title: "CellPhoneDB的单细胞通讯结果的可视化之气泡图"
date: 2024-07-10T09:57:57Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
CellPhoneDB的单细胞通讯结果的可视化之气泡图 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>前些天的教程：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511214&amp;idx=2&amp;sn=f6de43b97f62b597b01e16e0b3b898ca&amp;scene=21#wechat_redirect" data-linktype="2">直接为CellPhoneDB创建一个独立的conda环境</a>，以及：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511169&amp;idx=1&amp;sn=c8da9ab475ee4a433025ad09f3043c5b&amp;scene=21#wechat_redirect" data-linktype="2">把Seurat对象里面表达量矩阵和细胞表型信息输出给CellPhoneDB做细胞通讯</a>，给大家演示了如何对pbmc3k单细胞数据集做细胞通讯，并且在：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511241&amp;idx=2&amp;sn=d6a907c9b2d16698a895f356d32b67e0&amp;scene=21#wechat_redirect" data-linktype="2">CellPhoneDB的单细胞通讯结果的理解</a> 给大家演示了细胞通讯结果的多个txt文件的含义，前面的代码是：</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>conda activate cellphonedb<br>cellphonedb method statistical_analysis test_meta.txt test_counts.txt  \<br>--counts-data hgnc_symbol --threads 4 <br><br><span># 必须要保证当前路径下面有前面的步骤输出的out文件夹哦 </span><br>cellphonedb plot dot_plot <br>cellphonedb plot heatmap_plot cellphonedb_meta.txt <br><span># 做完后为了跟前面的区分，我把 out文件夹，修改名字为 out-by-symbol 文件夹啦 </span><br></code></pre><p data-tool="mdnice编辑器">把 out文件夹，修改名字为 out-by-symbol文件夹，其结构如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>ls -lh out-by-symbol|cut -d<span>" "</span> -f 7-<br><br>  1.5K  2 12 09:43 count_network.txt<br>   64K  2 12 09:30 deconvoluted.txt<br>   11K  2 12 09:43 heatmap_count.pdf<br>   11K  2 12 09:43 heatmap_log_count.pdf<br>  113B  2 12 09:43 interaction_count.txt<br>  149K  2 12 09:30 means.txt<br>  803K  2 12 09:43 plot.pdf<br>  128K  2 12 09:30 pvalues.txt<br>   61K  2 12 09:30 significant_means.txt<br></code></pre><p data-tool="mdnice编辑器">如果你对这些文件的理解还不够，继续看 ：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511241&amp;idx=2&amp;sn=d6a907c9b2d16698a895f356d32b67e0&amp;scene=21#wechat_redirect" data-linktype="2">CellPhoneDB的单细胞通讯结果的理解</a></p><p data-tool="mdnice编辑器">接下来我们对这些文件进行高度定制化的可视化！</p><p data-tool="mdnice编辑器">我们肉眼看的：</p><pre data-tool="mdnice编辑器"><span></span><code> all_sum<br>Memory_CD4_T 101<br>B 105<br>CD14_Mono 157<br>NK 171<br>CD8_T 100<br>Naive_CD4_T 68<br>FCGR3A_Mono 241<br>DC 180<br>Platelet 60<br></code></pre><p data-tool="mdnice编辑器">同样是单核细胞， CD14_Mono 和 FCGR3A_Mono 的总通讯数量不一样，那就看看它们跟两种CD4的T细胞（Memory_CD4_T和Naive_CD4_T）的通讯情况吧。</p><p data-tool="mdnice编辑器">主要是因为细胞亚群太多了，如果全部可视化出来，也很难给大家讲清楚。</p><pre data-tool="mdnice编辑器"><span></span><code><br>rm(list = ls())<br>getwd()<br>setwd(<span>'pbmc3k-CellPhoneDB/'</span>)<br><br>mypvals &lt;- read.table(<span>"./out-by-symbol/pvalues.txt"</span>,header = <span>T</span>,sep = <span>"\t"</span>,stringsAsFactors = <span>F</span>)<br>mymeans &lt;- read.table(<span>"./out-by-symbol/means.txt"</span>,header = <span>T</span>,sep = <span>"\t"</span>,stringsAsFactors = <span>F</span>) <br><span># 我们重点看  CD14_Mono 和 FCGR3A_Mono  ，以及  Memory_CD4_T和Naive_CD4_T 的通讯情况。</span><br><br>kp = grepl(pattern = <span>"Mono"</span>, colnames(mypvals)) &amp; grepl(pattern = <span>"CD4_T"</span>, colnames(mypvals))<br>table(kp)<br>pos = (<span>1</span>:ncol(mypvals))[kp] <br>choose_pvalues &lt;- mypvals[,c(c(<span>1</span>,<span>5</span>,<span>6</span>,<span>8</span>,<span>9</span>),pos  )]<br>choose_means &lt;- mymeans[,c(c(<span>1</span>,<span>5</span>,<span>6</span>,<span>8</span>,<span>9</span>),pos)]<br>  <br>logi &lt;- apply(choose_pvalues[,<span>5</span>:ncol(choose_pvalues)]&lt;<span>0.05</span>, <span>1</span>, sum) <br><span># 只保留具有细胞特异性的一些相互作用对</span><br>choose_pvalues &lt;- choose_pvalues[logi&gt;=<span>1</span>,]<br><br><span># 去掉空值</span><br>logi1 &lt;- choose_pvalues$gene_a != <span>""</span><br>logi2 &lt;- choose_pvalues$gene_b != <span>""</span><br>logi &lt;- logi1 &amp; logi2<br>choose_pvalues &lt;- choose_pvalues[logi,]<br><br><span># 同样的条件保留choose_means</span><br>choose_means &lt;- choose_means[choose_means$id_cp_interaction %<span>in</span>% choose_pvalues$id_cp_interaction,]<br><br></code></pre><p data-tool="mdnice编辑器">得到了如下所示的两个变量，choose_means和   choose_pvalues ， 他们前面的5列是一样的，但是后面只有8列，并不是 4X4的16列，说明很多单细胞亚群的两两组合之间其实并没有统计学显著的细胞通讯受体和配体对哦。</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; head(choose_means,1)<br>   id_cp_interaction gene_a gene_b receptor_a receptor_b CD14_Mono.Memory_CD4_T CD14_Mono.Naive_CD4_T<br>40   CPI-SS0703338F5 LGALS9   CD44      False       True                  0.862                 0.803<br>   FCGR3A_Mono.Memory_CD4_T FCGR3A_Mono.Naive_CD4_T Memory_CD4_T.CD14_Mono Memory_CD4_T.FCGR3A_Mono<br>40                    0.949                    0.89                  0.552                     0.71<br>   Naive_CD4_T.CD14_Mono Naive_CD4_T.FCGR3A_Mono<br>40                 0.513                    0.67<br><br><br>&gt; head(choose_pvalues,1)<br>   id_cp_interaction gene_a gene_b receptor_a receptor_b CD14_Mono.Memory_CD4_T CD14_Mono.Naive_CD4_T<br>40   CPI-SS0703338F5 LGALS9   CD44      False       True                      0                     0<br>   FCGR3A_Mono.Memory_CD4_T FCGR3A_Mono.Naive_CD4_T Memory_CD4_T.CD14_Mono Memory_CD4_T.FCGR3A_Mono<br>40                        0                       0                  0.888                        0<br>   Naive_CD4_T.CD14_Mono Naive_CD4_T.FCGR3A_Mono<br>40                     1                       1<br><br></code></pre><p data-tool="mdnice编辑器">可以看到之前是 302行， 是90多列，也就是说9个细胞亚群，每个都是自己跟包括自己在内的9个单细胞亚群进行通讯分析结果都存在，81种两两组合都存在 ，但是现在只剩下8个单细胞亚群组合啦，而且仅仅是19个受体配体对啦 ：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; dim(mypvals)<br>[1] 302  92<br>&gt; dim(mymeans)<br>[1] 302  92<br>&gt; dim(choose_means)<br>[1] 19 13<br>&gt; dim(choose_pvalues)<br>[1] 19 13<br></code></pre><p data-tool="mdnice编辑器">接下来对这19个受体配体对，在8个单细胞亚群组合的结果进行简单的可视化，虽然说简单，但是代码也有点长啊 ：</p><pre data-tool="mdnice编辑器"><span></span><code><br><span># 将choose_pvalues和choose_means数据宽转长</span><br><span>library</span>(tidyverse)<br>meansdf &lt;- choose_means %&gt;% reshape2::melt()<br>meansdf &lt;- data.frame(interacting_pair = paste0(meansdf$gene_a,<span>"_"</span>,meansdf$gene_b),<br>                      CC = meansdf$variable,<br>                      means = meansdf$value)<br>pvalsdf &lt;- choose_pvalues %&gt;% reshape2::melt()<br>pvalsdf &lt;- data.frame(interacting_pair = paste0(pvalsdf$gene_a,<span>"_"</span>,pvalsdf$gene_b),<br>                      CC = pvalsdf$variable,<br>                      pvals = pvalsdf$value)<br><br><span># 合并p值和mean文件</span><br>pvalsdf$joinlab&lt;- paste0(pvalsdf$interacting_pair,<span>"_"</span>,pvalsdf$CC)<br>meansdf$joinlab&lt;- paste0(meansdf$interacting_pair,<span>"_"</span>,meansdf$CC)<br>pldf &lt;- merge(pvalsdf,meansdf,by = <span>"joinlab"</span>)<br><br><span># dotplot可视化</span><br>summary((filter(pldf,means &gt;<span>0</span>))$means)<br>head(pldf)<br>pcc =  pldf%&gt;% filter(means &gt;<span>0</span>) %&gt;% <br>  ggplot(aes(CC.x,interacting_pair.x) )+ <br>  geom_point(aes(color=means,size=-log10(pvals+<span>0.0001</span>)) ) +<br>  scale_size_continuous(range = c(<span>1</span>,<span>3</span>))+<br>  scale_color_gradient2(high=<span>"red"</span>,mid = <span>"yellow"</span>,low =<span>"darkblue"</span>,midpoint = <span>1</span>  )+ <br>  theme_bw()+ <br>  <span># scale_color_manual(values = rainbow(100))+</span><br>  theme(axis.text.x = element_text(angle = -<span>45</span>,hjust = -<span>0.1</span>,vjust = <span>0.8</span>))<br>pcc<br></code></pre><p data-tool="mdnice编辑器">如下所示：</p><p><img data-galleryid="" data-ratio="0.76103500761035" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzShuykISedCxxwtpAJp9OEqv7uQ30uXrfPfyDc5ud1XSDYyzbebqJ29ISvS2bGyd73ags4ytYicUw/640?wx_fmt=png" data-type="png" data-w="1314" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzShuykISedCxxwtpAJp9OEqv7uQ30uXrfPfyDc5ud1XSDYyzbebqJ29ISvS2bGyd73ags4ytYicUw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">可以看到，从mono到cd4方向的受体配体对，跟从 cd4到mono的，基本上是完全不一样的哦。这19个受体配体对具体信息如下所示</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; unique(pldf<span>$interacting_pair</span>.x)<br> [1] <span>"ALOX5_ALOX5AP"</span> <span>"ANXA1_FPR1"</span>    <span>"C5AR1_RPS19"</span>   <span>"CD2_CD58"</span>      <span>"CD28_CD86"</span>     <span>"CD47_SIRPG"</span>   <br> [7] <span>"CD52_SIGLEC10"</span> <span>"CD74_MIF"</span>      <span>"CD99_PILRA"</span>    <span>"HLA-F_LILRB1"</span>  <span>"HLA-F_LILRB2"</span>  <span>"LAMP1_VSTM1"</span>  <br>[13] <span>"LGALS9_CD44"</span>   <span>"LGALS9_CD47"</span>   <span>"LGALS9_SORL1"</span>  <span>"MIF_TNFRSF14"</span>  <span>"PLXNB2_SEMA4D"</span> <span>"SCGB3A1_MARCO"</span><br>[19] <span>"SELL_SELPLG"</span>  <br></code></pre><p data-tool="mdnice编辑器">而且，肉眼上看，是 CD74_MIF 和 C5AR1_RPS19 这两个配对比较明显， 让我们看看他们的表达量情况，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><br><span>library</span>(SeuratData) <span>#加载seurat数据集  </span><br>getOption(<span>'timeout'</span>)<br>options(timeout=<span>10000</span>)<br><span>#InstallData("sce")  </span><br>data(<span>"pbmc3k"</span>)  <br>sce &lt;- pbmc3k.final   <br><span>library</span>(Seurat)<br>table(Idents(sce))<br>sce = sce[,Idents(sce) %<span>in</span>% c(<span>'Naive CD4 T'</span>, <span>'Memory CD4 T'</span> ,  <span>'CD14+ Mono'</span>,<span>'FCGR3A+ Mono'</span>)]<br>DimPlot(sce,label = <span>T</span>,repel = <span>T</span>) <br><br>cg = unique(unlist(str_split(unique(pldf[,<span>2</span>]),<span>'_'</span>)) )<br><br><span>library</span>(ggplot2)<br>th=  theme(axis.text.x = element_text(angle = -<span>45</span>,hjust = -<span>0.1</span>,vjust = <span>0.8</span>))<br>pdopt &lt;- DotPlot(sce, features = cg, <br>              assay=<span>'RNA'</span>  )  + coord_flip() +th<br><span>library</span>(patchwork)<br>pdopt + DimPlot(sce,label = <span>T</span>,repel = <span>T</span>) <br>pdopt + pcc <br></code></pre><p data-tool="mdnice编辑器">出结果如下所示：</p><p><img data-galleryid="" data-ratio="0.5294974508375819" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzShuykISedCxxwtpAJp9OEQyrLsclb0hVhaX33NyVMh4mZtCTzl0CicfWofxLBrSTKC3mAQ3b1zTQ/640?wx_fmt=png" data-type="png" data-w="2746" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzShuykISedCxxwtpAJp9OEQyrLsclb0hVhaX33NyVMh4mZtCTzl0CicfWofxLBrSTKC3mAQ3b1zTQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">是不是很简单，前面的CD74_MIF 和 C5AR1_RPS19 这两个配对情况，在mono到cd4的方向比较明显，所以它们就是CD74和C5AR1在mono高表达，而MIF和RPS19在cd4的t细胞里面高表达。</p><h3 data-tool="mdnice编辑器"><span></span><span>所谓的细胞通讯，就是差异分析从一个基因单位到两个基因</span><span></span></h3><p data-tool="mdnice编辑器">我们差异分析很容易找到不同单细胞亚群各自的高表达量基因，但是这些基因在每个单细胞亚群是独立的列表，所谓的单细胞通讯，就是找到那些不同单细胞亚群的特异性基因的两两组合，而且是具有受体配体的生物学背景知识的那些。</p></section><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/iaP6Wr7rTdwhN5SPL2RfKw",target="_blank" rel="noopener noreferrer">原文链接</a>
