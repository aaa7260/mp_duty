---
title: "绘图练习 | 使用ggplot2绘制热图"
date: 2024-07-22T00:43:26Z
draft: ["false"]
tags: [
  "fetched",
  "被炸熟的虾"
]
categories: ["Acdemic"]
---
绘图练习 | 使用ggplot2绘制热图 by 被炸熟的虾
------
<div><p><span>本周的画图练习：和上一周的练习出自同一批数据，就当是一个单纯的画图练习了，尝试绘制类似风格的图片</span><span></span></p><p><img data-imgfileid="100004174" data-ratio="0.3712962962962963" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3KzHibDFYMPib7j9PNh9fKf3NibAuyibyribV9x99myRhanYhw9Cwfo9dZicwDY3Yh67JgOrHibkxvQlenBQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3KzHibDFYMPib7j9PNh9fKf3NibAuyibyribV9x99myRhanYhw9Cwfo9dZicwDY3Yh67JgOrHibkxvQlenBQ/640?wx_fmt=png&amp;from=appmsg"></p><section><strong><span>绘图思路：</span></strong><span>可以绘制热图的</span><span>R</span><span>包很多，最常用的莫过于</span><code>pheatmap</code><span>与</span><code>ComplexHeatmap</code><span>，但考虑到兼容问题与拼图，个人觉得</span><code>ggplot2</code><span>也是一个很不错的选择。</span></section><section><span>1、</span><span>热图主体：聚类树与热图颜色块需要分开绘制再拼接</span></section><ul><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzkwNDQwMDI5NQ==&amp;mid=2247486105&amp;idx=1&amp;sn=037a01f5f6fa4ea12ba409ea60f3e9b7&amp;scene=21#wechat_redirect" data-linktype="2"><span>R语言画图 | ggplot2绘制热图及个性化修饰</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzkwNDQwMDI5NQ==&amp;mid=2247486124&amp;idx=1&amp;sn=9df90f3e476c8b0af23b5cb0a856a413&amp;scene=21#wechat_redirect" data-linktype="2"><span>R语言画图 | ggplot2绘制离散值热图</span></a></section></li></ul><p><span>这里尝试使用一个</span><code>ggplot2</code><span>扩展包：</span><code>ggheatmap</code><span>包，其操作习惯贴近于</span><code>pheatmap</code><span>，使用也相当便捷，相当程度上解决了这些麻烦。</span></p><ul><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzkwNDQwMDI5NQ==&amp;mid=2247486196&amp;idx=1&amp;sn=2f31ba774d948fd79352b8976bfbab6f&amp;scene=21#wechat_redirect" data-linktype="2"><span>R语言画图 | ggheatmap绘制热图及个性化修饰</span></a></section></li></ul><section><span>2、</span><span>上方注释行：使用</span><code>ggplot2</code><span>包额外绘制，使用</span><code>aplot</code><span>拼接（逃不了</span><img data-ratio="1" data-w="128" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/2_05.png" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/2_05.png"><span>）。</span></section><h3><span><strong><span>数据准备：</span></strong></span></h3><pre><code>GSEAresults[<span>1</span>:<span>4</span>,<span>1</span>:<span>6</span>]<br>                                        <span># ACC      BLCA      BRCA     CESC       CHOL      COAD</span><br><span># HALLMARK_TNFA_SIGNALING_VIA_NFKB   1.184187 -2.261878 1.3051404 2.437144 -0.8717726 1.1612707</span><br><span># HALLMARK_IL2_STAT5_SIGNALING       1.753255 -1.932190 1.1944846 1.428444  1.4065875 0.8244767</span><br><span># HALLMARK_IL6_JAK_STAT3_SIGNALING   2.069123 -2.336764 1.3434724 1.972353  1.4132987 1.4577561</span><br><span># HALLMARK_INTERFERON_GAMMA_RESPONSE 2.026576 -2.898030 0.9625134 1.963144  1.8449375 1.0563797</span><br></code></pre><p><span>原图未进行<span>列</span>聚类，而是按照</span><span>INFLAMMATORY RESPONSE</span><span>得分排序：</span></p><pre><code>GSEAresults &lt;- GSEAresults[,order(GSEAresults[<span>"HALLMARK_INFLAMMATORY_RESPONSE"</span>,])]<br><span>###通路名简化</span><br>rownames(GSEAresults) &lt;- gsub(<span>"HALLMARK_"</span>,<span>""</span>,rownames(GSEAresults))<br>rownames(GSEAresults) &lt;- gsub(<span>"_"</span>,<span>" "</span>,rownames(GSEAresults))<br>GSEAresults[<span>1</span>:<span>4</span>,<span>1</span>:<span>6</span>]<br>                               <span># BLCA       UVM      PAAD      KIRC       LGG      KIRP</span><br><span># TNFA SIGNALING VIA NFKB   -2.261878 -2.025107 -2.599580 -1.501811 -1.962701 -1.923857</span><br><span># IL2 STAT5 SIGNALING       -1.932190 -1.802483 -1.962817 -1.760805 -1.817403 -1.852191</span><br><span># IL6 JAK STAT3 SIGNALING   -2.336764 -2.310521 -1.658775 -1.436405 -2.156273 -1.549789</span><br><span># INTERFERON GAMMA RESPONSE -2.898030 -2.870822 -2.536420 -1.753710 -2.815568 -1.253629</span><br></code></pre><p><span>上方注释行：准备</span><span>PD1</span><span>、</span><span>CTLA4</span><span> 的表达水平（分癌型计算</span><span>TPM</span><span>平均值后执行组间</span><span>scale</span><span>）、</span><span>INFLAMMATORY RESPONSE</span><span>的</span><span>NES</span><span>（使用</span><span>GSVA</span><span>得分似乎更好一点）：</span></p><pre><code>head(Radio_list)<br>      <span># Radio       PDL1      PDL2        PD1     CTLA4 Sample_id Yaxis     Score</span><br><span># 1 1.6283439 -1.5412000 0.6960133 -1.3513710 0.3676397       ACC     1  1.933834</span><br><span># 2 0.9483355  0.1515691 1.8366278 -0.3119960 1.8281247      BLCA     1 -2.849386</span><br><span># 3 1.0413159 -0.1305830 2.5654109 -0.1952726 1.8273108      BRCA     1  1.197187</span><br><span># 4 1.0376862  1.0226327 2.1594813  0.3849175 2.3278267      CESC     1  1.997576</span><br><span># 5 1.1618768 -0.6615259 1.2795407  0.5373076 1.3522130      CHOL     1  1.312263</span><br><span># 6 0.9970699 -0.4801488 1.5143937 -0.2327170 1.7903975      COAD     1  1.203434</span><br></code></pre><h3><span><strong><span>开始绘制：</span></strong></span></h3><h4><span><strong><span>1、热图主体</span></strong></span></h4><pre><code><span>library</span>(<span>"ggheatmap"</span>)<br>p1 &lt;- ggheatmap(GSEAresults[-<span>13</span>,],<br>                cluster_rows = <span>T</span>,cluster_cols = <span>F</span>,<span>#scale = "row",</span><br>                <span>#color = colorRampPalette(c("#053061","white","#67001f"))(100),</span><br>                border = <span>"white"</span>,<br>                levels_cols = rev(colnames(GSEAresults)))<br></code></pre><section><span>热图与行聚类树分别存储在</span><code>p1$plotlist[[1]]</code><span>与</span><code>p1$plotlist[[2]]</code><span>，利用</span><code>theme</code><span>修改美化一下热图</span></section><pre><code>p1$plotlist[[<span>1</span>]] &lt;- p1$plotlist[[<span>1</span>]] + <br>                    theme(axis.text.x = element_text(angle = <span>90</span>, size = <span>15</span>,hjust = <span>1</span>, vjust = <span>0.5</span>),<br>                          axis.text.y = element_text(size = <span>15</span>),<br>                          legend.title = element_text(size = <span>14</span>),<br>                          legend.text = element_text(size = <span>14</span>))+<br>                    scale_fill_gradient2(low = <span>"#053061"</span>, mid = <span>"white"</span>, high = <span>"#67001f"</span>, <br>                                         name = <span>"NES"</span>,<br>                                         limits = c(-<span>3.21</span>,<span>3</span>),midpoint = <span>0</span>,breaks = seq(-<span>3</span>,<span>3</span>,<span>2</span>)) <br></code></pre><p><img data-imgfileid="100004170" data-ratio="0.6472222222222223" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JGL7L8FzYB0azCzXZPqmNZ2DPqzaFa2sM4Bgo1pwsiaCq3iceBv9RcMMAicImcQYja7PkqdNDRTzqpw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JGL7L8FzYB0azCzXZPqmNZ2DPqzaFa2sM4Bgo1pwsiaCq3iceBv9RcMMAicImcQYja7PkqdNDRTzqpw/640?wx_fmt=png&amp;from=appmsg"></p><h4><span></span></h4><h4><span><strong><span>2、上方注释条</span></strong></span></h4><section><span>显示分组的条带也是一个小热图，使用</span><code>geom_tile</code><span>绘制，<strong>去除坐标轴与坐标标签</strong>。</span><span>PD1</span><span>、</span><span>CTLA4</span><span>的表达水平与</span><span>INFLAMMATORY RESPONSE</span><span>得分分批绘制：</span></section><pre><code><span>library</span>(ggplot2)<br>mytheme1 &lt;- theme(panel.grid = element_blank(),<br>                 legend.position = <span>"right"</span>,<br>                 legend.text = element_text(size = <span>14</span>),<br>                 legend.title = element_text(size = <span>14</span>),<br>                 axis.ticks.y = element_blank(),<br>                 axis.title = element_blank(),<br>                 axis.text.x =  element_blank(),<br>                 axis.text.y =  element_blank())     <br>Block_PDL1 &lt;- ggplot(data = Radio_list,aes(Sample_id,Yaxis,fill = PDL1))+<br>          geom_tile()+<br>          scale_fill_continuous(low = <span>"white"</span>, high = <span>"#f47720"</span>) + <br>          theme_void() + mytheme1<br>Block_CTLA4 &lt;- ggplot(data = Radio_list,aes(Sample_id,Yaxis,fill = CTLA4))+<br>          geom_tile()+<br>          scale_fill_gradient(low = <span>"white"</span>, high = <span>"#0074b3"</span>) + <br>          theme_void() + mytheme1   <br>Block_Score &lt;- ggplot(data = Radio_list,aes(Sample_id,Yaxis,fill = Score))+<br>          geom_tile()+<br>          scale_fill_continuous(name = <span>"INFLAMMATORY\nRESPONSE"</span>,<br>                          low = <span>"white"</span>, high = <span>"red"</span>) + <br>          theme_void() + mytheme1<br></code></pre><pre><code><span>library</span>(patchwork)<br>Block_Score + Block_PDL1 + Block_CTLA4 +  plot_layout(ncol = <span>1</span>,guides = <span>'collect'</span>)<br></code></pre><p><img data-imgfileid="100004169" data-ratio="0.5861733203505355" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JGL7L8FzYB0azCzXZPqmNZia1lEDOs6iayB9L0usH8vB5PsyJCZoZGprNrolWo1Uy48ibD5bkPMbS7Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1027" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JGL7L8FzYB0azCzXZPqmNZia1lEDOs6iayB9L0usH8vB5PsyJCZoZGprNrolWo1Uy48ibD5bkPMbS7Q/640?wx_fmt=png&amp;from=appmsg"></p><p><span>使用</span><code>aplot</code><span>包拼图：</span></p><pre><code><span>library</span>(aplot)<br>p_block &lt;- p1 %&gt;% insert_top(Block_Score,height = <span>0.06</span>) %&gt;%<br>           insert_top(Block_CTLA4,height = <span>0.06</span>) %&gt;%<br>     insert_top(Block_PDL1,height = <span>0.06</span>)<br>p_block<br></code></pre><p><img data-imgfileid="100004168" data-ratio="0.6398148148148148" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JGL7L8FzYB0azCzXZPqmNZ0cKE6l2pLmw23TjCsG5yKKRBVU0erDic1ZzLImmXUgfgpumNbbYmH9w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JGL7L8FzYB0azCzXZPqmNZ0cKE6l2pLmw23TjCsG5yKKRBVU0erDic1ZzLImmXUgfgpumNbbYmH9w/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span></p><p><span>下次再尝试使用</span><code>ComplexHeatmap</code><span>实现相同效果</span></p><section><br></section><h3><span></span></h3><section><span></span></section><section><img data-imgfileid="100003752" data-ratio="0.05278592375366569" data-type="png" data-w="341" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/1LTeQhNfr8sUH75oYsoDaqjPCTiaukEmS8tWricW7LnLKKfIE9jKBexibqamsrlibaaXmuc2nicaYibfDFBNCmqX5mBw/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp" src="https://mmbiz.qpic.cn/sz_mmbiz_png/1LTeQhNfr8sUH75oYsoDaqjPCTiaukEmS8tWricW7LnLKKfIE9jKBexibqamsrlibaaXmuc2nicaYibfDFBNCmqX5mBw/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp"></section><section data-tools="135编辑器" data-id="116886" draggable="true"><section><section><section><section><strong data-brushtype="text">被炸熟的虾</strong></section></section></section><section><section><section data-width="35%"><section><img data-cropselx1="0" data-cropselx2="115" data-cropsely1="0" data-cropsely2="115" data-imgfileid="100003750" data-ratio="1" data-type="jpeg" data-w="258" data-width="100%" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/dRYYdqiaan3JjDfj2H8p6gg3CB25AGthbwzrotao4ev5tIe0utthbZRK8yOoDOuTzOSoTSnPWn61IdDCnXsnaiag/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/dRYYdqiaan3JjDfj2H8p6gg3CB25AGthbwzrotao4ev5tIe0utthbZRK8yOoDOuTzOSoTSnPWn61IdDCnXsnaiag/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp"></section></section><section data-width="63%"><section><section><strong>自己的摸索，发现问题麻烦告诉作者，光速回来改正</strong><strong><img data-imgfileid="100003751" data-ratio="1" data-type="png" data-w="64" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3KLQGNxibvI4SdtUfxjINkz2DO8cGEPTgbcMJ357RvXJ7IvWU2p7anljpePpakI9oKu3icJxobBDp5w/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3KLQGNxibvI4SdtUfxjINkz2DO8cGEPTgbcMJ357RvXJ7IvWU2p7anljpePpakI9oKu3icJxobBDp5w/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp"></strong></section></section></section></section></section></section></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/kQfvaQMYm1qE4RnSf3vmoA",target="_blank" rel="noopener noreferrer">原文链接</a>
