---
title: "InstaPrism能否平替BayesPrism(贝叶斯棱镜)？"
date: 2024-07-18T15:09:40Z
draft: ["false"]
tags: [
  "fetched",
  "生信方舟"
]
categories: ["Acdemic"]
---
InstaPrism能否平替BayesPrism(贝叶斯棱镜)？ by 生信方舟
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">上一期内容提到了BayesPrism算法用于单细胞数据的反卷积，BayesPrism算法在实际应用中非常占用计算资源以及消耗使用者的时间。那么是否有较好的替代包呢？</p><p data-tool="mdnice编辑器">曾老师告诉了我一个R包—<strong>InstaPrism</strong>，他希望我将其和BayesPrism算法做个对比。</p><p data-tool="mdnice编辑器">开发者给InstaPrism的直接定义就是“<strong>用于快速实现BayesPrism</strong>”。</p><p data-tool="mdnice编辑器">简单来说这个包是基于BayesPrism分析框架分析并把里边非常耗时的Gibbs采样步骤替换成了fixed-point algorithm，从而减少了运行时间。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100000811" data-ratio="0.5099236641221374" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEb4ZQgiaE5u6NB2iben3X1knGWL8S3a9HrjCZ2rfpD9otKBibwTF6ibTPLUHRxSn0h1zfe8kSDZCMdtA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="655" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEb4ZQgiaE5u6NB2iben3X1knGWL8S3a9HrjCZ2rfpD9otKBibwTF6ibTPLUHRxSn0h1zfe8kSDZCMdtA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">接下来分别运行这两种算法并对结果做一个粗糙的对比。</p><p data-tool="mdnice编辑器">BayesPrism分析步骤详见推文：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkwMjYyMDA1OA==&amp;mid=2247484435&amp;idx=1&amp;sn=d7169a12f39410cc807cb92797c5fa9e&amp;chksm=c0a3f2e6f7d47bf00a0f16d2aba9b957cee8596d6d8d6359f96941c700ba354cd3395893dbc3&amp;scene=21#wechat_redirect" textvalue="BayesPrism(贝叶斯棱镜法)可提取单细胞数据去卷积后将信息映射至bulkRNA数据对其进行细胞分群" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">BayesPrism(贝叶斯棱镜法)可提取单细胞数据去卷积后将信息映射至bulkRNA数据对其进行细胞分群</a></p><h3 data-tool="mdnice编辑器"><span></span>BayesPrism<span></span></h3><h4 data-tool="mdnice编辑器"><span></span>1、输入数据情况<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>dim(sc.dat)<br><span>#[1]  5042 20124</span><br><br>dim(bk.dat)<br><span>#[1]   424 60533</span><br></code></pre><p data-tool="mdnice编辑器">sc.dat: 5042个细胞和20124个基因的单细胞数据</p><p data-tool="mdnice编辑器">bk.dat：424个样本和60533个基因的bulkRNA数据(TCGA-LIHC的count数据）</p><h4 data-tool="mdnice编辑器"><span></span>2、运行BayesPrism<span></span></h4><p data-tool="mdnice编辑器">关键步骤 bp.res &lt;- run.prism(prism = myPrism, n.cores=20)，设置了20线程</p><pre data-tool="mdnice编辑器"><span></span><code><span>#核心代码</span><br>start_time &lt;- Sys.time() <span># 记录初始时间</span><br>bp.res &lt;- run.prism(prism = myPrism, n.cores=<span>20</span>)<br>end_time &lt;- Sys.time() <span># 记录终止时间</span><br>end_time - start_time <span># 计算时间差</span><br><br><span># Time difference of 2.865344 hours</span><br></code></pre><p data-tool="mdnice编辑器">需要将近3个小时，如果能设置50线程的话时间可以进一步缩短。建议采用较高配置的电脑或者服务器运行。</p><h3 data-tool="mdnice编辑器"><span></span>InstaPrism-code from github<span></span></h3><h4 data-tool="mdnice编辑器"><span></span>1、安装及加载R包<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>if</span> (!<span>require</span>(<span>"BiocManager"</span>, quietly = <span>TRUE</span>))<br>    install.packages(<span>"BiocManager"</span>)<br><span>if</span> (!<span>require</span>(<span>"Biobase"</span>, quietly = <span>TRUE</span>))<br>    BiocManager::install(<span>"Biobase"</span>)<br><span>if</span> (!<span>require</span>(<span>"devtools"</span>, quietly = <span>TRUE</span>))<br>    install.packages(<span>"devtools"</span>)<br>devtools::install_github(<span>"humengying0907/InstaPrism"</span>)<br><br><span>library</span>(InstaPrism)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>2、数据处理<span></span></h4><p data-tool="mdnice编辑器"><img data-imgfileid="100000809" data-ratio="0.05042016806722689" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEb4ZQgiaE5u6NB2iben3X1kn0kKVCVU9GTkrCwbua8kya19jOVJu5TYHhice5yakfgsufvbkRxlfVGw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="833" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEb4ZQgiaE5u6NB2iben3X1kn0kKVCVU9GTkrCwbua8kya19jOVJu5TYHhice5yakfgsufvbkRxlfVGw/640?wx_fmt=png&amp;from=appmsg">开发者建议使用TPM或者count的bulkRNA数据，并且从例子来看TPM是更优选。但为了前后分析一致，本次运算仍使用count数据。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 处理单细胞数据</span><br>a &lt;- as.data.frame(GetAssayData(sc_dataset, layer = <span>"counts"</span>)) <span># 行为基因，列为细胞名/样本名</span><br><br>cell_meta &lt;- sc_dataset@meta.data    <span># 处理好的单细胞注释文件</span><br>a_ref &lt;- refPrepare(sc_Expr = a,<br>                    cell.type.labels = cell_meta$celltype, <span># 细胞类型</span><br>                    cell.state.labels = cell_meta$state_type, <span># 细胞状态</span><br>                    ) <br>head(a_ref)[<span>1</span>:<span>3</span>,<span>1</span>:<span>3</span>]<br><br><span># bulkRNA数据</span><br>b_bulk &lt;- exp <span># 行为基因，列为细胞名/样本名</span><br><br><span># 运行函数</span><br>start_time &lt;- Sys.time() <span># 记录初始时间</span><br>deconv_res &lt;- InstaPrism(bulk_Expr = exp, <span># bulkRNA数据</span><br>                         refPhi_cs = a_ref) <span># 单细胞数据</span><br>end_time &lt;- Sys.time() <span># 记录终止时间</span><br>end_time - start_time <span># 计算时间差</span><br><br><span># Time difference of 1.086436 mins</span><br></code></pre><p data-tool="mdnice编辑器">真的非常快哦。<strong>本来需要将近3小时，现在只需要1分钟</strong>。</p><h4 data-tool="mdnice编辑器"><span></span>3、提取数据<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span># 用@Post.ini.ct@theta可获得细胞的theta估计值</span><br>estimated_frac &lt;-  t(deconv_res@Post.ini.ct@theta)<br><br><span># 提取之前保存好的BayesPrism分析结果进行比较</span><br>theta &lt;- as.data.frame(theta) <span>#BayesPrism分析结果</span><br>estimated_frac &lt;- as.data.frame(estimated_frac) <span>#IntraPrism分析结果</span><br>names(theta) &lt;- c(<span>"BayesPrism_1"</span>,<span>"BayesPrism_2"</span>,<span>"BayesPrism_3"</span>)<br>head(theta)[<span>1</span>:<span>5</span>,<span>1</span>:<span>3</span>]<br><span>#                             BayesPrism_1 BayesPrism_2 BayesPrism_3</span><br><span>#TCGA-ZP-A9CY-01A-11R-A38B-07 4.718213e-07    0.9999993 2.523228e-07</span><br><span>#TCGA-DD-AAVZ-01A-11R-A41C-07 6.814688e-02    0.9314891 3.640295e-04</span><br><span>#TCGA-DD-A1EC-01A-21R-A131-07 5.272019e-01    0.4400359 3.276221e-02</span><br><span>#TCGA-DD-A1EC-11A-11R-A131-07 2.532253e-07    0.9999996 1.089799e-07</span><br><span>#TCGA-DD-AADN-01A-11R-A41C-07 3.301156e-01    0.5707665 9.911796e-02</span><br><br>names(estimated_frac) &lt;- c(<span>"InstaPrism_1"</span>,<span>"InstaPrism_2"</span>,<span>"InstaPrism_3"</span>)<br>head(estimated_frac)[<span>1</span>:<span>5</span>,<span>1</span>:<span>3</span>]<br><span>#                             InstaPrism_1 InstaPrism_2 InstaPrism_3</span><br><span>#TCGA-ZP-A9CY-01A-11R-A38B-07   0.01309068    0.9869093 1.698626e-12</span><br><span>#TCGA-DD-AAVZ-01A-11R-A41C-07   0.05282472    0.9471751 2.133425e-07</span><br><span>#TCGA-DD-A1EC-01A-21R-A131-07   0.18103636    0.8130102 5.953452e-03</span><br><span>#TCGA-DD-A1EC-11A-11R-A131-07   0.01004673    0.9899533 8.360430e-13</span><br><span>#TCGA-DD-AADN-01A-11R-A41C-07   0.45022208    0.4644255 8.535239e-02</span><br><br>identical(rownames(estimated_frac),rownames(theta))<br><span># [1] TRUE</span><br>dat &lt;- cbind(estimated_frac,theta)<br></code></pre><p data-tool="mdnice编辑器">其实从这里粗看就可以发现<strong>数据结果的差异还是非常大的</strong>。</p><h4 data-tool="mdnice编辑器"><span></span>4、相关性分析(粗糙的比较一下)<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span># 懒的写循环了，就三张图，徒手修改代码出图 hhh</span><br><span>library</span>(ggstatsplot)<br>colnames(dat)<br>ggscatterstats(<br>    data = dat,<br>    x = InstaPrism_1,  <br>    y = BayesPrism_1,   <br>    xlab = <span>"InstaPrism_1"</span>,<br>    ylab = <span>"BayesPrism_1"</span>,<br>    bf.message = <span>FALSE</span><br>  )<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000810" data-ratio="0.9576719576719577" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEb4ZQgiaE5u6NB2iben3X1knl4IniakicIVxicUt7wGsgyEntIYtdL6RaSOfGPCQrghy0xlGcicQ8csh2Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="567" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEb4ZQgiaE5u6NB2iben3X1knl4IniakicIVxicUt7wGsgyEntIYtdL6RaSOfGPCQrghy0xlGcicQ8csh2Q/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100000813" data-ratio="0.9576719576719577" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEb4ZQgiaE5u6NB2iben3X1knXicWHjADUrsFE7Ou0a57SXURCMOCVZibcpFbxLVljz59OT0gefJosgkg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="567" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEb4ZQgiaE5u6NB2iben3X1knXicWHjADUrsFE7Ou0a57SXURCMOCVZibcpFbxLVljz59OT0gefJosgkg/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100000812" data-ratio="0.9576719576719577" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEb4ZQgiaE5u6NB2iben3X1knc7AjwnUerM5vR7sedLlGf6uzdOqnEoqmkxf3gH3N6jrGYQiaDJDsAeQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="567" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyEb4ZQgiaE5u6NB2iben3X1knc7AjwnUerM5vR7sedLlGf6uzdOqnEoqmkxf3gH3N6jrGYQiaDJDsAeQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">相关性的值分别在<strong>0.84，0.87，0.67</strong>。说实话，这个相关性的数据，应该不能让使用者满意吧。</p><p data-tool="mdnice编辑器">为什么会出现这样的情况？目前能想到的有两个可能的主要原因，<strong>1、没有进行异常基因过滤</strong>；<strong>2、算法上的差异。</strong></p><p data-tool="mdnice编辑器">因此笔者重新回溯了开发者提供在github中的代码，发现<strong>并没有提供相应的过滤函数</strong>(英语不好，如果理解没有误的话)。同时笔者也尝试采用了BayesPrism算法中提供的<strong>过滤函数过滤了数据</strong>之后再跑IntraPrism，<strong>相关性更低了</strong>....</p><p data-tool="mdnice编辑器">接下来了解了Gibbs 采样和Fixed-Point算法。Gibbs 采样通常用于贝叶斯推断，特别是当直接采样较难实现时。它在处理高维分布和复杂模型时具有优势，而定点算法常用于确定性优化问题，例如在确定的条件下求解系统的稳定状态或最优解。Fixed-Point算法在某些特定的情况下可以替代Gibbs采样：1）当所使用的模型相对简单、确定且具有良好的收敛性质时，定点算法更适用；2）在计算资源有限或需要快速结果的情况下，定点算法的高效性显得尤为重要；3）在某些高维度数据分析中，如果定点算法能够被证明在这些维度上具有稳定的收敛性，它可能是一个更好的选择；4）当有较强的先验信息或假设可以指导模型的构建和优化时，定点算法可以利用这些信息进行快速收敛；5）在对模型的鲁棒性要求较低的情况下，定点算法可以作为替代。总而言之，<strong>要使用 Fixed-Point算法需要满足一定的条件</strong>。</p><p data-tool="mdnice编辑器"><strong>那么是否InstaPrism能平替BayesPrism呢? 恐怕大多数情况下还是不行的，还是老老实实的用BayesPrism进行分析吧</strong>~</p><p data-tool="mdnice编辑器"><strong>参考资料：</strong></p><p data-tool="mdnice编辑器">1、github：https://github.com/humengying0907/InstaPrism?tab=readme-ov-file</p><p data-tool="mdnice编辑器">2、生信碱移：https://mp.weixin.qq.com/s/NTOxq_soYmPVbSItXVKGPw</p><p data-tool="mdnice编辑器"><strong>致谢</strong>：感谢曾老师，小洁老师以及生信技能树团队全体成员。</p><p data-tool="mdnice编辑器"><strong>注</strong>：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(欢迎交流)。</p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/O7p1E0BIwqiI6BpqDjrQOQ",target="_blank" rel="noopener noreferrer">原文链接</a>
