---
title: "单细胞GSVA分析专用R包"
date: 2024-07-12T08:44:41Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
单细胞GSVA分析专用R包 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>单细胞转录组数据分析最基础的就是给每个细胞一个身份，通常是降维聚类分群后然后对每个亚群进行描述，首先可以描述每个亚群的高表达量的特异性基因，然后可以对基因进行生物学功能数据库注释。也可以直接对亚群进行打分，比如gsea和gsva算法，针对免疫或者代谢等基因集进行打分，也是拿到每个亚群的特异性生物学功能。</p></blockquote><p data-tool="mdnice编辑器">之前我们介绍过<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526904&amp;idx=1&amp;sn=4ea4c4289217c8ba815354370813540a&amp;scene=21#wechat_redirect" data-linktype="2">irGSEA：基于秩次的单细胞基因集富集分析整合框架</a>，针对<strong>17种常见的Functional Class Scoring (FCS)方法</strong>进行了benchmark，感兴趣的可以仔细读一下。最近恰好看到了密西根大学的Research Assistant Professor Neurology的Kai Guo的github也有一个打分工具：https://github.com/guokai8/scGSVA ，也值得介绍一下：</p><h3 data-tool="mdnice编辑器"><span></span><span>基于基因列表的生物学功能数据库注释</span><span></span></h3><p data-tool="mdnice编辑器">单细胞转录组降维聚类分群大家都应该是很熟悉了，有了分群结果就可以很容易找到每个亚群的特异性基因列表，然后基于每个亚群的基因列表就可以进行生物学功能数据库注释，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>###热图表示GO富集分析</span><br><span>library</span>(grid)<br><span>library</span>(ggplot2)<br><span>library</span>(gridExtra)<br><span>library</span>(clusterProfiler)<br><span>library</span>(org.Hs.eg.db)<br><span>library</span>(enrichplot)<br><span>library</span>(ggplot2)<br><span>library</span>(org.Hs.eg.db)<br><span>library</span>(GOplot)<br><br><span>if</span> (!file.exists(<span>'markers.csv'</span>)) {<br>  markers &lt;- FindAllMarkers(object = sce, only.pos = <span>TRUE</span>, <br>                            min.pct = <span>0.25</span>, <br>                            thresh.use = <span>0.25</span>)<br>  write.csv(markers,file=<span>'markers.csv'</span>)<br>} <span>else</span> {<br>  <br>  markers = read.csv(<span>'markers.csv'</span>,row.names = <span>1</span>)<br>}<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>2. 如下所示的差异基因结果</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>table(markers$cluster)<br><span>#&gt; </span><br><span>#&gt;               AT1               AT2   Cancer(CRABP2+)   Cancer(TM4SF1+) </span><br><span>#&gt;              1207               895               586               864 </span><br><span>#&gt;    Cancer(UBE2C+)    Ciliated cells       Clara cells Clara-like cancer </span><br><span>#&gt;              2278               676              2687               943</span><br><span>library</span>(dplyr) <br><br>gene = markers[markers$p_val &lt;<span>0.01</span> &amp; markers$avg_log2FC &gt;<span>2</span>,]$gene<br><br>entrezIDs = bitr(gene, fromType = <span>"SYMBOL"</span>, toType = <span>"ENTREZID"</span>, OrgDb= <span>"org.Hs.eg.db"</span>, drop = <span>TRUE</span>)<br><span>#&gt; Warning in bitr(gene, fromType = "SYMBOL", toType = "ENTREZID", OrgDb =</span><br><span>#&gt; "org.Hs.eg.db", : 7.1% of input gene IDs are fail to map...</span><br>gene&lt;- entrezIDs$ENTREZID<br><br>marker_new = markers[markers$gene %<span>in</span>% entrezIDs$SYMBOL,]<br>marker_new = marker_new[!duplicated(marker_new$gene),]<br>identical(marker_new$gene, entrezIDs$SYMBOL)<br><span>#&gt; [1] FALSE</span><br>p = identical(marker_new$gene, entrezIDs$SYMBOL);p<br><span>#&gt; [1] FALSE</span><br><span>if</span>(!p) entrezIDs = entrezIDs[match(marker_new$gene,entrezIDs$SYMBOL),]<br>marker_new$ID = entrezIDs$ENTREZID<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>3. 细胞亚群GO富集分析（基于compareCluster函数）</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>## GO</span><br>gcSample=split(marker_new$ID, marker_new$cluster) <br><span>###参数可以更改，看看?compareCluster</span><br><span>#One of "groupGO", "enrichGO", "enrichKEGG", "enrichDO" or "enrichPathway" </span><br>xx &lt;- compareCluster(gcSample,<br>                     fun = <span>"enrichGO"</span>,<br>                     OrgDb = <span>"org.Hs.eg.db"</span>,<br>                     ont = <span>"BP"</span>,<br>                     pAdjustMethod = <span>"BH"</span>,<br>                     pvalueCutoff = <span>0.01</span>,<br>                     qvalueCutoff = <span>0.05</span><br>)<br><br>p &lt;- dotplot(xx)<br><span>library</span>(ggthemes)<br>p + theme(axis.text.x = element_text(<br>  angle = <span>45</span>,<br>  vjust = <span>0.5</span>, hjust = <span>0.5</span><br>))+theme_few()<br></code></pre><p data-tool="mdnice编辑器">可以看到，每个单细胞亚群的生物学功能是有特异性的：</p><p><img data-galleryid="" data-imgfileid="100048232" data-ratio="0.962037037037037" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz1wvCrCMZrsM6VAj05wA9coZV742gGeiauhZ9L0nuWQ52BnGeMtenskicPicDvh0uLt9H3Ozum7HQkg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz1wvCrCMZrsM6VAj05wA9coZV742gGeiauhZ9L0nuWQ52BnGeMtenskicPicDvh0uLt9H3Ozum7HQkg/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span>基于单细胞表达量矩阵的gsea和gsva（需要生物学功能数据库）</span><span></span></h3><p data-tool="mdnice编辑器">很容易从Seurat对象里面的拿到了单细胞表达量矩阵，一般来说都是两三万个基因然后几万个甚至几十万细胞数量，所以不推荐这个方法学，因为计算资源消耗比较大而且很慢，而且单细胞表达量矩阵里面的drop-out非常严重，这个时候Functional Class Scoring (FCS)方法并不好用！</p><h3 data-tool="mdnice编辑器"><span></span><span>基于细胞亚型表达量矩阵的gsea和gsva（需要生物学功能数据库）</span><span></span></h3><p data-tool="mdnice编辑器">其实就是针对Seurat对象进行AverageExpression函数操作一下，之前的几万个甚至几十万细胞数量就变成了几个或者十几个细胞亚群啦。因为每个细胞内部的成百上千个细胞被汇总了，所以基本上就不存在drop-out现象了，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>###GSVA分析</span><br><span>library</span>(Seurat)<br><span>library</span>(msigdbr)<br><span>library</span>(GSVA)<br><span>library</span>(tidyverse)<br><span>library</span>(clusterProfiler)<br><span>library</span>(patchwork)<br><span>library</span>(limma) <br><span>#genesets &lt;- msigdbr(species = "Homo sapiens") </span><br>genesets &lt;- msigdbr(species = <span>"Homo sapiens"</span>, category = <span>"C2"</span>) <br>genesets &lt;- subset(genesets, select = c(<span>"gs_name"</span>,<span>"gene_symbol"</span>)) %&gt;% as.data.frame()<br>genesets &lt;- split(genesets$gene_symbol, genesets$gs_name)<br>Idents(sce) &lt;- sce$celltype<br>expr &lt;- AverageExpression(sce, assays = <span>"RNA"</span>, slot = <span>"data"</span>)[[<span>1</span>]]<br>expr &lt;- expr[rowSums(expr)&gt;<span>0</span>,]  <span>#选取非零基因</span><br>expr &lt;- as.matrix(expr)<br>head(expr)<br><span>#&gt;            Clara cells         AT2 Cancer(UBE2C+) Clara-like cancer</span><br><span>#&gt; AL627309.1 0.001611424 0.000000000   0.0012074311      0.0007027198</span><br><span>#&gt; AL669831.5 0.083969542 0.049562047   0.0552978566      0.0595487007</span><br><span>#&gt; FAM87B     0.000000000 0.000000000   0.0003532046      0.0000000000</span><br><span>#&gt; LINC00115  0.012537201 0.023884735   0.0211631772      0.0284589549</span><br><span>#&gt; FAM41C     0.091875324 0.032304186   0.0916539462      0.0353727547</span><br><span>#&gt; AL645608.3 0.000000000 0.002181691   0.0050477681      0.0000000000 </span><br><span># gsva默认开启全部线程计算</span><br>gsva.res &lt;- gsva(expr, genesets, method=<span>"gsva"</span>) <br><span>#&gt; Warning: Calling gsva(expr=., gset.idx.list=., method=., ...) is deprecated;</span><br><span>#&gt; use a method-specific parameter object (see '?gsva').</span><br><span>#&gt; Warning in .gsva(expr, mapped.gset.idx.list, method, kcdf, rnaseq, abs.ranking,</span><br><span>#&gt; : Some gene sets have size one. Consider setting 'min.sz &gt; 1'.</span><br><span>#&gt; Estimating GSVA scores for 6365 gene sets.</span><br><span>#&gt; Estimating ECDFs with Gaussian kernels </span><br><span># 。。。。。</span><br>gsva.df &lt;- data.frame(Genesets=rownames(gsva.res), gsva.res, check.names = <span>F</span>)<br>gsva_d = gsva.res[sample(nrow(gsva.res),<span>30</span>),]<br>pheatmap::pheatmap(gsva_d, show_colnames = <span>T</span>, <br>                   scale = <span>"row"</span>,angle_col = <span>"45"</span>,<br>                   color = colorRampPalette(c(<span>"navy"</span>, <span>"white"</span>, <span>"firebrick3"</span>))(<span>50</span>))<br></code></pre><p data-tool="mdnice编辑器">上面的gsva打分矩阵之后可以 pheatmap::pheatmap 的热图展示，也可以气泡图展现哈。</p><h3 data-tool="mdnice编辑器"><span></span><span>关于Kai Guo的scGSVA</span><span></span></h3><p data-tool="mdnice编辑器">我们可以首先借助ai了解一下，在生物信息学中，GSEA（Gene Set Enrichment Analysis）和GSVA（Gene Set Variation Analysis）是两种用于理解和解释基因表达数据的分析方法，它们都与基因集（通常是功能相关的一组基因）的分析有关。</p><h3 data-tool="mdnice编辑器"><span></span><span>GSEA（基因集富集分析）</span><span></span></h3><p data-tool="mdnice编辑器">GSEA 是一种计算方法，用于确定一个预先定义的基因集在某个生物状态下是否表现出显著的表达变化。这种分析方法基于排名，而不是统计测试，来评估基因集在不同样本或条件下的表达差异。<strong>GSEA的主要特点包括：</strong></p><ul data-tool="mdnice编辑器"><li><section><strong>基因集</strong>：使用预先定义的基因集，如功能相关的基因、已知的通路成员或特定生物学过程的基因。</section></li><li><section><strong>排名</strong>：基于基因表达的变化，对所有基因进行排名。</section></li><li><section><strong>统计检验</strong>：通过计算基因集成员在排名列表中的位置，评估基因集在特定状态下是否富集在排名的顶端或底端。</section></li><li><section><strong>多个测试</strong>：可以对多个基因集进行富集分析，以识别在特定条件下最受影响的生物学过程或通路。</section></li><li><section><strong>可视化</strong>：通常以图表形式展示结果，如富集得分（ES）和名义P值或校正P值。</section></li></ul><p data-tool="mdnice编辑器">GSEA的主要用途是识别在疾病状态、发育阶段或对治疗响应中起作用的生物学通路。</p><h3 data-tool="mdnice编辑器"><span></span><span>GSVA（基因集变异分析）</span><span></span></h3><p data-tool="mdnice编辑器">GSVA 是一种用于评估基因集在不同样本或条件下变异的方法，它可以提供基因集水平上的表达变化信息，而不是单个基因。<strong>GSVA的主要特点包括：</strong></p><ul data-tool="mdnice编辑器"><li><section><strong>表达矩阵</strong>：分析从RNA-seq或其他基因表达技术获得的表达矩阵。</section></li><li><section><strong>变异度量</strong>：计算基因集的平均表达水平，并评估其在不同样本或条件下的变异。</section></li><li><section><strong>平滑处理</strong>：使用平滑技术减少噪声，提高结果的可靠性。</section></li><li><section><strong>统计分析</strong>：通过比较不同组之间的基因集表达差异，进行统计检验。</section></li><li><section><strong>结果解释</strong>：识别在特定条件下表达变化显著的基因集，从而推断生物学过程或通路的变化。</section></li></ul><p data-tool="mdnice编辑器">GSVA的主要用途是识别在不同条件下基因集表达的变异性，这可能与疾病、发展或其他生物学变化有关。</p><h3 data-tool="mdnice编辑器"><span></span><span>区别和联系</span><span></span></h3><ul data-tool="mdnice编辑器"><li><section><strong>GSEA</strong>：侧重于基因集的富集分析，适用于探索特定生物学过程或通路在不同状态下的活性变化。</section></li><li><section><strong>GSVA</strong>：侧重于基因集表达的变异性分析，适用于评估基因集在不同条件下的整体表达变化。</section></li></ul><p data-tool="mdnice编辑器">两种方法都有助于从基因集的角度理解复杂的生物学数据，但它们在分析方法和应用场景上有所不同。GSEA更多用于识别特定状态下活跃的通路，而GSVA则用于评估基因集表达的变异性。在实际应用中，研究者可能会根据研究目的和数据类型选择合适的分析方法。</p><p data-tool="mdnice编辑器">让我们直接实战吧：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#Installation</span><br><span>library</span>(devtools)<br>install_github(<span>"guokai8/scGSVA"</span>)<br><span>#Examples</span><br>set.seed(<span>123</span>)   <br><span>library</span>(scGSVA)   <br>data(pbmcs)<br>hsko&lt;-buildAnnot(species=<span>"human"</span>,keytype=<span>"SYMBOL"</span>,anntype=<span>"KEGG"</span>)<br>res&lt;-scgsva(pbmcs,hsko,method=<span>"ssgsea"</span>) <span>## or use UCell</span><br>vlnPlot(res,features=<span>"Wnt.signaling.pathway"</span>,group_by=<span>"groups"</span>) <span>## split.plot = TRUE and split.by</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>拆解一下上面的代码</span><span></span></h3><p data-tool="mdnice编辑器">是3个环节，构建数据库+打分+可视化。</p><p data-tool="mdnice编辑器">其中构建数据库我前面使用的的是msigdbr这个包内置的 ：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(msigdbr) <br><span>#genesets &lt;- msigdbr(species = "Homo sapiens") </span><br>genesets &lt;- msigdbr(species = <span>"Homo sapiens"</span>, category = <span>"C2"</span>) <br>genesets &lt;- subset(genesets, select = c(<span>"gs_name"</span>,<span>"gene_symbol"</span>)) %&gt;% as.data.frame()<br>genesets &lt;- split(genesets$gene_symbol, genesets$gs_name)<br></code></pre><p data-tool="mdnice编辑器">Kai Guo使用的是buildAnnot函数，可以打开代码看看，是基于KEGGREST keggLink在线获取的。</p><p data-tool="mdnice编辑器">然后打分，首先是针对Seurat对象获取单细胞表达量矩阵</p><pre data-tool="mdnice编辑器"><span></span><code> input &lt;- GetAssayData(obj,assay = assay, layer = slot)<br>        input&lt;- input[tabulate(summary(input)<span>$i</span>) != 0, , drop = FALSE]<br>        input &lt;- as.matrix(input)<br></code></pre><p data-tool="mdnice编辑器">然后也是嫌弃gsva速度太慢了，所以拆分成为多个矩阵</p><pre data-tool="mdnice编辑器"><span></span><code>   split.data &lt;- split.data.matrix(matrix=input, chunk.size=batch)<br>            out&lt;- lapply(split.data,<span>function</span>(x).sgsva(input=x,annotation = annotation,<br>                                                      method=method,kcdf=kcdf,<br>                     abs.ranking=abs.ranking,<br>                     min.sz=min.sz,<br>                     max.sz=max.sz,cores=cores,<br>                     tau=tau,ssgsea.norm=ssgsea.norm,<br>                     verbose=verbose<br>        ))<br>            out &lt;- do.call(rbind,out)<br></code></pre><p data-tool="mdnice编辑器">当然了，也可以使用其它打分方法啦：</p><pre data-tool="mdnice编辑器"><span></span><code> out&lt;- suppressWarnings(UCell::ScoreSignatures_UCell(input, features=annotation,<br>                                                                chunk.size = batch, ncores = cores,<br>                                                     BPPARAM=SerialParam(progressbar=verbose),...))<br>        colnames(out)&lt;-gsub(<span>' '</span>,<span>'\\.'</span>,sub(<span>'_UCell'</span>,<span>''</span>,colnames(out)))<br>        out&lt;-as.data.frame(out)<br></code></pre><p data-tool="mdnice编辑器">最后是可视化，基本上就是Seurat包的5种可视化，打开源代码可以看到是重新使用ggplot2语法绘制了一下：</p><p><img data-galleryid="" data-imgfileid="100048233" data-ratio="0.5277777777777778" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz1wvCrCMZrsM6VAj05wA9cZwOLhU0V6eoPfticibHoXpHkbGjhjTccgzuL6qMMd5N62iby5RfSUwm9A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz1wvCrCMZrsM6VAj05wA9cZwOLhU0V6eoPfticibHoXpHkbGjhjTccgzuL6qMMd5N62iby5RfSUwm9A/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>5种可视化</figcaption></figure><p data-tool="mdnice编辑器">单细胞数据分析里面最基础的就是降维聚类分群，参考前面的例子：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497956&amp;idx=1&amp;sn=5d4deb7cf7b7848b3e2273cbd663bb6a&amp;scene=21#wechat_redirect" data-linktype="2">人人都能学会的单细胞聚类分群注释</a>  ，这个大家基本上问题不大了，使用seurat标准流程即可，不过它默认出图并不好看，详见以前我们做的投票：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247500816&amp;idx=1&amp;sn=25568540a54d63225def0804c05025f8&amp;scene=21#wechat_redirect" data-linktype="2">可视化单细胞亚群的标记基因的5个方法</a>，下面的5个基础函数相信大家都是已经烂熟于心了：</p><ul data-tool="mdnice编辑器"><li><section>VlnPlot(pbmc, features = c("MS4A1", "CD79A"))</section></li><li><section>FeaturePlot(pbmc, features = c("MS4A1", "CD79A"))</section></li><li><section>RidgePlot(pbmc, features = c("MS4A1", "CD79A"), ncol = 1)</section></li><li><section>DotPlot(pbmc, features = unique(features)) + RotatedAxis()</section></li><li><section>DoHeatmap(subset(pbmc, downsample = 100), features = features, size = 3)</section></li></ul><p data-tool="mdnice编辑器">其实pyscenic的转录因子分析结果也是一种打分，就可以去跟我们的降维聚类分群结合起来进行5种可视化展示。</p><p data-tool="mdnice编辑器">感兴趣的可以申请<span>kai-guo老师的博士哈</span> ，详见：https://experts.umich.edu/9854-kai-guo</p><p><img data-galleryid="" data-imgfileid="100048234" data-ratio="1.0518518518518518" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz1wvCrCMZrsM6VAj05wA9cCuFYJb9jkZtCicPIthpkiaiagb70WOZwm8vKgWQpj2ibv9XB2bxLWMKegA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz1wvCrCMZrsM6VAj05wA9cCuFYJb9jkZtCicPIthpkiaiagb70WOZwm8vKgWQpj2ibv9XB2bxLWMKegA/640?wx_fmt=png&amp;from=appmsg"></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/I8Gd3zYVrThlGWeu57OA2Q",target="_blank" rel="noopener noreferrer">原文链接</a>
