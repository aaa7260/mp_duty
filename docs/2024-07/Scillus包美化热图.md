---
title: "Scillus包美化热图"
date: 2024-07-18T05:50:44Z
draft: ["false"]
tags: [
  "fetched",
  "生信漫漫学"
]
categories: ["Acdemic"]
---
Scillus包美化热图 by 生信漫漫学
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span></span><span>写在开头</span><span></span></h3><p data-tool="mdnice编辑器"><strong>hhh再次体会到了背靠大树的优势，就是大佬们可以直接检查并指导学习成果！</strong></p><p data-tool="mdnice编辑器">昨天基于文章的Fig1的最后一张热图进行复现，并没有得到想要的结果——<a href="https://mp.weixin.qq.com/s?__biz=MzkxOTI0Mjc3Mw==&amp;mid=2247488570&amp;idx=1&amp;sn=d0a7e61e007040bfdca64b2ae4ef465a&amp;scene=21#wechat_redirect" data-linktype="2">GSE231920差异基因热图</a></p><p data-tool="mdnice编辑器">然后<strong>早上到办公室，曾老师就基于推文笔记指出了相应的问题！</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004924" data-ratio="0.8169014084507042" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTwloG5uXWrAzcevrXMUdYYJTrgYbwefejcz1O1X1YkXu5CuPVeykBJw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="426" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTwloG5uXWrAzcevrXMUdYYJTrgYbwefejcz1O1X1YkXu5CuPVeykBJw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>虽然刚刚入职一年——<a href="https://mp.weixin.qq.com/s?__biz=MzkxOTI0Mjc3Mw==&amp;mid=2247488526&amp;idx=1&amp;sn=6cda0852cc713626eee0bab6ebcd1680&amp;scene=21#wechat_redirect" data-linktype="2">工作一周年啦！</a>，但毫不夸张，我热爱这份工作hhh</strong></p><p data-tool="mdnice编辑器">言归正传，我们一起来<strong>看看使用FindMarker找差异基因然后可视化叭！</strong></p><p data-tool="mdnice编辑器"><strong>文献阅读笔记：</strong><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247524124&amp;idx=1&amp;sn=61dc3d99a26f452b090575c97481d393&amp;scene=21#wechat_redirect" data-linktype="2">外周T辅助细胞通过增强B细胞激活和分化来促进IgG4相关疾病的发展</a></p><p data-tool="mdnice编辑器"><strong>第一层次降维聚类分群：</strong><a href="https://mp.weixin.qq.com/s?__biz=MzkxOTI0Mjc3Mw==&amp;mid=2247488550&amp;idx=1&amp;sn=299cb4ac24fa5ae56f70034f23446c9e&amp;scene=21#wechat_redirect" data-linktype="2">GSE231920第一层次降维聚类分群</a></p><p data-tool="mdnice编辑器"><strong>GSE231920差异基因热图</strong>：<a href="https://mp.weixin.qq.com/s?__biz=MzkxOTI0Mjc3Mw==&amp;mid=2247488570&amp;idx=1&amp;sn=d0a7e61e007040bfdca64b2ae4ef465a&amp;scene=21#wechat_redirect" data-linktype="2">GSE231920差异基因热图</a></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>获取差异基因</span><span></span></h3><p data-tool="mdnice编辑器">文章的材料与方法部分的介绍，<strong>文章使用的是FindMarker，选择<code>test.use =  "MAST"</code>，得到结果之后，基于p_val &lt; 0.05以及|avg_log2FC| &gt; 0.58设置的阈值挑选差异基因</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004926" data-ratio="0.5605095541401274" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPT0vKQSmcsLRFkciaFgAXwbiaK9BabX8wRSFia79gCHf7RM68fdKGsfE7uw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="942" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPT0vKQSmcsLRFkciaFgAXwbiaK9BabX8wRSFia79gCHf7RM68fdKGsfE7uw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>基于热图可视化的结果来看，分别选取的是上下调的top20的基因，所以我们先获取到需要的基因</strong><img data-imgfileid="100004927" data-ratio="0.8129092609915809" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTfxibbLbedRorfx3UkiaXsx79XuvMyl0N0HlWUYftARroXML98P9ADfnQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1069" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTfxibbLbedRorfx3UkiaXsx79XuvMyl0N0HlWUYftARroXML98P9ADfnQ/640?wx_fmt=png&amp;from=appmsg"></p><pre data-tool="mdnice编辑器"><span></span><code>BiocManager::install(<span>"MAST"</span>)<br>library(MAST)<br><br>table(sce.all<span>$group</span>)<br>dfmarkers &lt;- FindMarkers(sce.all, ident.1 = <span>"IgG4-RPF"</span>, <br>                         group.by = <span>"group"</span>,<br>                         test.use =  <span>"MAST"</span>,<br>                         min.pct = 0.25, logfc.threshold = 0.25,verbose = F)<br><br><br>top20 &lt;- dfmarkers  %&gt;% <br>  dplyr::filter(p_val &lt; 0.05) %&gt;% <br>  dplyr::filter(avg_log2FC &gt; 0.58 ) %&gt;%<br>  slice_head(n = 20) %&gt;%<br>  ungroup()<br><br>down20 &lt;- dfmarkers  %&gt;% <br>  dplyr::filter(p_val &lt; 0.05) %&gt;%<br>  dplyr::filter(avg_log2FC &lt;  -0.58) %&gt;%<br>  slice_head(n = 20) %&gt;%<br>  ungroup()<br><br><span>test</span> &lt;- rbind(top20,down20)<br><br><span>test</span><span>$gene</span> &lt;- rownames(<span>test</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004925" data-ratio="1.8156182212581344" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTlmAlNSmV7KRmNmiccUicO4T7iarfrfSFKliaRpaDTibKVPGmicq82GV4oFsQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="461" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTlmAlNSmV7KRmNmiccUicO4T7iarfrfSFKliaRpaDTibKVPGmicq82GV4oFsQ/640?wx_fmt=png&amp;from=appmsg"><figcaption>差异基因</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>遇到的问题</span><span></span></h3><p data-tool="mdnice编辑器">昨天是直接基于降维聚类分群保留下来的结果进行的可视化，也就是里面的scaledata信息是2000个高变基因，所以当我们得到的需要的基因</p><p data-tool="mdnice编辑器">然后<strong>使用DotHeatmap可视化，但是因为默认选择<code>slot = "scale.data"</code>,然后我的小破电脑跑不动改成data的数据。所以导致很多差异基因在热图展示的时候展示不了。。。</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004923" data-ratio="0.8054662379421221" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTIC0reBj7KEmqZLTm56iaZ98Qp9Daxu60OXViawpfPzqKzjvapPS9l5fg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="622" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTIC0reBj7KEmqZLTm56iaZ98Qp9Daxu60OXViawpfPzqKzjvapPS9l5fg/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100004929" data-ratio="0.44198174706649285" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTGaVfWs3Zj5gPNbdMkHEr3RTshNR68eBw3OuF81hI7SRHXU4EhCMMMA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1534" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTGaVfWs3Zj5gPNbdMkHEr3RTshNR68eBw3OuF81hI7SRHXU4EhCMMMA/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>解决方法</span><span></span></h3><p data-tool="mdnice编辑器">需要<strong>基于我们得到的基因集重新使用scaledata()进行分析，然后得到需要的数据进行后续的可视化！</strong></p><pre data-tool="mdnice编辑器"><span></span><code>sce.Scale &lt;- ScaleData(subset(sce.all,downsample=100),features =  <span>test</span><span>$gene</span>  ) <br><br>DoHeatmap(sce.Scale,<br>          features =  <span>test</span><span>$gene</span>,<br>          group.by = <span>"group"</span>,<br>          assay = <span>'RNA'</span>, label = T)+<br>  scale_fill_gradientn(colors = c(<span>"white"</span>,<span>"grey"</span>,<span>"firebrick3"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004931" data-ratio="1.0204802259887005" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPT9KsBDWbaztytUaT2xar1xEfPU4Yas1RVibLcM0h3NemBM55qoOPakOQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1416" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPT9KsBDWbaztytUaT2xar1xEfPU4Yas1RVibLcM0h3NemBM55qoOPakOQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">还有一个需求，就是对热图进行美化，除了展示分组情况还需要加上细胞类群的情况，所以需要使用别的R包来实现</p><p data-tool="mdnice编辑器"><strong>这里用到的<code>Scillus</code>包，参考的教程是：生信补给站<a href="https://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650401013&amp;idx=1&amp;sn=7bd4fd1719bf6235a47d7892ab1bdcfa&amp;scene=21#wechat_redirect" data-linktype="2">scRNA分析| DoHeatmap 美化，dittoSeq ，scillus 一行代码出图，你PICK谁？</a></strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span><code>Scillus</code>包美化热图</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>#安装需要的R包</span><br>devtools::install_github(<span>"xmc811/Scillus"</span>)<br><br><span>#结果美化</span><br>library(Scillus)<br><span>source</span>(<span>"../scRNA_scripts/mycolors.R"</span>)<br>plot_heatmap(dataset = sce.Scale, <br>             markers = <span>test</span><span>$gene</span>,<br>             sort_var = c(<span>"group"</span>,<span>"celltype"</span>),<br>             anno_var = c(<span>"group"</span>,<span>"celltype"</span>),<br>             anno_colors = list(<span>"Set2"</span>,                <span># RColorBrewer palette</span><br>                                my36colors,<br>                                <span>"Reds"</span>,<br>                                <span>"Greens"</span>))<br></code></pre><p data-tool="mdnice编辑器">这里的<strong>sort_var以及anno_var是我们数据中的metadata信息，使用c("group","celltype")选择需要的分组，分组顺序可以按需进行调整。</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004928" data-ratio="0.2695035460992908" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTHGicMYG5z8fOpGMCIDSQoN9m7Sb8bAOrvJj71WEq5gIcx8gaxcMtPOw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="846" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTHGicMYG5z8fOpGMCIDSQoN9m7Sb8bAOrvJj71WEq5gIcx8gaxcMtPOw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">然后就得到了需要的结果，<strong>加上了细胞分群信息就可以更加清楚的知道富集到的基因属于哪个亚群！</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004930" data-ratio="0.9967707212055974" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTRkPgBWYstkvsYstPDnzHpKEWmrSayqQh1LWhJdZx3YYIIjs1ujRB9A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="929" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTRkPgBWYstkvsYstPDnzHpKEWmrSayqQh1LWhJdZx3YYIIjs1ujRB9A/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>正经结尾</span><span></span></h3><p data-tool="mdnice编辑器"><strong>今天还测试了自己的视频号，可以正常在电脑上开直播，hhh或许以后可以日常开播，让大家监督工作与学习。</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004932" data-ratio="0.596875" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTI4VOWBtb43zn5gBPgKicIFCp5zLfXnr9w0ibG6Lib3bZraic1vf7uibjWAw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2560" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9a2N77UP34LQug2oIQzftPTI4VOWBtb43zn5gBPgKicIFCp5zLfXnr9w0ibG6Lib3bZraic1vf7uibjWAw/640?wx_fmt=png&amp;from=appmsg"></figure></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ysJxAK14V-rRXS8xs5J6yg",target="_blank" rel="noopener noreferrer">原文链接</a>
