---
title: "比较copykat和infercnv这两个从单细胞转录组数据推断肿瘤拷贝数变异技术差异"
date: 2023-01-04T01:13:43Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
比较copykat和infercnv这两个从单细胞转录组数据推断肿瘤拷贝数变异技术差异 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>前面我们已经成功完成了《CNS图表复现专辑》的前20个关键图表的复现，现在开启<strong>第二波图表复现</strong>，会大量触及到补充图表。目录及前面的代码总结 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506769&amp;idx=1&amp;sn=d4e12f37f82760ad1b362918ef6958de&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现专辑第二波开启</a> 。</p></blockquote><p data-tool="mdnice编辑器">如果是现在才看到这个系列的小伙伴建议自己去先读一下CELL杂志的文章：Therapy-Induced Evolution of Human Lung Cancer Revealed by Single-Cell RNA Sequencing ，因为作者提供了全套代码，在：https://github.com/czbiohub/scell_lung_adenocarcinoma ，研究者们共收集到30位患者的49份活检样本（biopsy），分为三种类型：治疗前（TKI naive [TN]），靶向治疗后肿瘤消退或稳定（RD, residual disease state）以及靶向治疗后肿瘤仍然增长（PD, upon subsequent progressive disease），这样单细胞转录组数据就非常丰富！</p><p data-tool="mdnice编辑器">在 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506769&amp;idx=1&amp;sn=d4e12f37f82760ad1b362918ef6958de&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现专辑第二波开启</a> 可以看到前面的降维聚类分群，就是不知道为什么T和B这样的淋巴细胞和髓系都是有轻微混入了，而且它们跟上皮细胞居然在umap上面并不是泾渭分明的。<img data-ratio="0.4185185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwTT3rzovNvjjPVCd4F4KibAugvMIMqEsJXyzLmJhp6dXBEulVUic5FbIgU4okNiaFnBrXl8icfnXmHfA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwTT3rzovNvjjPVCd4F4KibAugvMIMqEsJXyzLmJhp6dXBEulVUic5FbIgU4okNiaFnBrXl8icfnXmHfA/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">难道是我因为我前面没有针对样品或者病人进行整合吗？我前面对  在 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506769&amp;idx=1&amp;sn=d4e12f37f82760ad1b362918ef6958de&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现专辑第二波开启</a>  教程里面的指出来smart-seq2 技术的单细胞， CCA整合并没有必要 ，主要是因为每个样品其实就几百个细胞而已，并不是10X技术那样的每个样品都是好几千个细胞。</p><p data-tool="mdnice编辑器">我们把一个肿瘤单细胞转录组数据进行初步降维聚类分群，并且各个单细胞亚群独立保存成为了seurat对象，接下来就很容易去<strong>抽取T和B淋巴细胞对象里面的表达量矩阵作为从单细胞转录组数据推断肿瘤拷贝数的正常二倍体参考细胞，然后对上皮细胞表达量矩阵进行肿瘤拷贝数推断！</strong></p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br>sce.all=readRDS( <span>"2-int/sce.all_int.rds"</span>)<br>sce.all<br>table(sce.all@meta.data$seurat_clusters)<br>load(file = <span>'3-cell/phe_by_markers.Rdata'</span>)<br>table(phe$celltype)<br><br>sce.all$celltype=phe$celltype<br>sce.all.list &lt;- SplitObject(sce.all , split.by = <span>"celltype"</span>)<br>sce.all.list<br><br><span>for</span> (i <span>in</span> names(sce.all.list)) {<br>  epi_mat = sce.all.list[[i]]@assays$RNA@counts<br>  epi_phe = sce.all.list[[i]]@meta.data<br>  sce=CreateSeuratObject(counts = epi_mat, <br>                         meta.data = epi_phe )<br>  sce<br>  table(sce@meta.data$orig.ident) <br>  save(sce,file = paste0(i,<span>'.Rdata'</span>))<br>}<br></code></pre><p data-tool="mdnice编辑器">得到的文件如下所示；</p><pre data-tool="mdnice编辑器"><span></span><code>   21M  8 19 16:46 B.Rdata<br>  9.2M  8 19 16:46 Mast.Rdata<br>   61M  8 19 16:46 T.Rdata<br>   18M  8 19 16:46 endo.Rdata<br>  161M  8 19 16:46 epi.Rdata<br>   58M  8 19 16:46 fibo.Rdata<br>  101M  8 19 16:45 myeloid.Rdata<br></code></pre><p data-tool="mdnice编辑器">另外，请不要再找我要这些Rdata文件了，但凡是你看完了前面的  <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506769&amp;idx=1&amp;sn=d4e12f37f82760ad1b362918ef6958de&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现专辑第二波开启</a>  教程，这些代码跑一下就自己制作出来了全部的数据文件！</p><p data-tool="mdnice编辑器">其实我们在教程：<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247488962&amp;idx=1&amp;sn=07981663c1b632c8c0f2b10f4dc6f14e&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现09—上皮细胞可以区分为恶性与否</a> 提到了<strong>五千多个上皮细胞里面只有三千七百左右是恶性细胞</strong>，但是 copykat 和 infercnv这两个从单细胞转录组数据推断肿瘤拷贝数变异技术差异还没有被探索过。</p><h3 data-tool="mdnice编辑器"><span></span>构建两个算法都需要的输入数据<span></span></h3><p data-tool="mdnice编辑器">其中 infercnv 算法需要3个文件，但是 copykat 只需一个文件即可，我们这里一起制作。</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(Seurat)<br>load(file = <span>'first_sce.Rdata'</span>)  <span># 这里面仅仅是上皮细胞哦</span><br>epiMat=as.data.frame(GetAssayData( sce , slot=<span>'counts'</span>,assay=<span>'RNA'</span>))<br>load(<span>'../Rdata-celltype/B.Rdata'</span>) <span># 这里面仅仅是B淋巴 细胞哦</span><br>B_cellMat=as.data.frame(GetAssayData( sce, slot=<span>'counts'</span>,assay=<span>'RNA'</span>))<br>load(<span>'../Rdata-celltype/T.Rdata'</span>) <span># 这里面仅仅是T淋巴 细胞哦</span><br>T_cellsMat=as.data.frame(GetAssayData( sce, slot=<span>'counts'</span>,assay=<span>'RNA'</span>))<br><br>B_cellMat=B_cellMat[,sample(<span>1</span>:ncol(B_cellMat),<span>800</span>)]<br>T_cellsMat=T_cellsMat[,sample(<span>1</span>:ncol(T_cellsMat),<span>800</span>)]<br>dat=cbind(epiMat,B_cellMat,T_cellsMat)<br><br>groupinfo=data.frame(v1=colnames(dat),<br>                     v2=c(rep(<span>'epi'</span>,ncol(epiMat)),<br>                          rep(<span>'spike-B_cell'</span>,<span>300</span>),<br>                          rep(<span>'ref-B_cell'</span>,<span>500</span>),<br>                          rep(<span>'spike-T_cells'</span>,<span>300</span>),<br>                          rep(<span>'ref-T_cells'</span>,<span>500</span>)))<br><br><span>library</span>(AnnoProbe)<br>geneInfor=annoGene(rownames(dat),<span>"SYMBOL"</span>,<span>'human'</span>)<br>colnames(geneInfor)<br>geneInfor=geneInfor[with(geneInfor, order(chr, start)),c(<span>1</span>,<span>4</span>:<span>6</span>)]<br>geneInfor=geneInfor[!duplicated(geneInfor[,<span>1</span>]),]<br>length(unique(geneInfor[,<span>1</span>]))<br>head(geneInfor)<br><span>## 这里可以去除性染色体</span><br><span># 也可以把染色体排序方式改变</span><br>dat=dat[rownames(dat) %<span>in</span>% geneInfor[,<span>1</span>],]<br>dat=dat[match( geneInfor[,<span>1</span>], rownames(dat) ),] <br>dim(dat)<br>expFile=<span>'expFile.txt'</span><br>write.table(dat,file = expFile,sep = <span>'\t'</span>,quote = <span>F</span>)<br>groupFiles=<span>'groupFiles.txt'</span><br>head(groupinfo)<br>write.table(groupinfo,file = groupFiles,sep = <span>'\t'</span>,quote = <span>F</span>,col.names = <span>F</span>,row.names = <span>F</span>)<br>head(geneInfor)<br>geneFile=<span>'geneFile.txt'</span><br>write.table(geneInfor,file = geneFile,sep = <span>'\t'</span>,quote = <span>F</span>,col.names = <span>F</span>,row.names = <span>F</span>)<br><br></code></pre><h3 data-tool="mdnice编辑器"><span></span>首先走inferCNV流程<span></span></h3><p data-tool="mdnice编辑器">有了前面的3个文件，接下来走inferCNV流程超级简单！真正的核心代码就 是 infercnv::run 函数，来源于  infercnv 这个包！</p><p data-tool="mdnice编辑器">代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(Seurat)<br><span>library</span>(gplots)<br><span>library</span>(ggplot2)<br><br>expFile=<span>'expFile.txt'</span> <br>groupFiles=<span>'groupFiles.txt'</span>  <br>geneFile=<span>'geneFile.txt'</span><br><br><span>library</span>(infercnv)<br>infercnv_obj = CreateInfercnvObject(raw_counts_matrix=expFile,<br>                                    annotations_file=groupFiles,<br>                                    delim=<span>"\t"</span>,<br>                                    gene_order_file= geneFile,<br>                                    ref_group_names=c(<span>"ref-B_cell"</span>,<span>'ref-T_cells'</span>))  <span>## 这个取决于自己的分组信息里面的</span><br><br> <br><span># cutoff=1 works well for Smart-seq2, and cutoff=0.1 works well for 10x Genomics</span><br>infercnv_obj2 = infercnv::run(infercnv_obj,<br>                              cutoff=<span>0.1</span>, <span># cutoff=1 works well for Smart-seq2, and cutoff=0.1 works well for 10x Genomics</span><br>                              out_dir= <span>"infercnv_output"</span>,  <span># dir is auto-created for storing outputs</span><br>                              cluster_by_groups=<span>F</span>,   <span># cluster</span><br>                              hclust_method=<span>"ward.D2"</span>, plot_steps=<span>F</span>)<br></code></pre><p data-tool="mdnice编辑器">得出如下所示的结果：</p><p><img data-galleryid="" data-ratio="0.94375" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wy1LXdRlBOH7zkakEdXH0yjlFVw4owauhunLLJuvrt2Aib3EIQ2Dojcqp4BbYbugElnqQhKLA7PiauA/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wy1LXdRlBOH7zkakEdXH0yjlFVw4owauhunLLJuvrt2Aib3EIQ2Dojcqp4BbYbugElnqQhKLA7PiauA/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>infercnv</figcaption></figure><p data-tool="mdnice编辑器">可以很容易看出来，我们特意加进去的normal细胞确实是被判定为了normal细胞，与此同时，约三分之一的上皮细胞也会被判定为normal细胞 。跟前面的教程：<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247488962&amp;idx=1&amp;sn=07981663c1b632c8c0f2b10f4dc6f14e&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现09—上皮细胞可以区分为恶性与否</a> 提到了<strong>五千多个上皮细胞里面只有三千七百左右是恶性细胞</strong>，是一致的。</p><h3 data-tool="mdnice编辑器"><span></span>然后走copykat流程<span></span></h3><p data-tool="mdnice编辑器">有了前面的3个文件，接下来走copykat流程超级简单！真正的核心代码就 是 copykat 函数，来源于  copykat这个包！</p><p data-tool="mdnice编辑器">代码如下：</p><pre data-tool="mdnice编辑器"><span></span><code>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(Seurat)<br><span>library</span>(gplots)<br><span>library</span>(ggplot2)<br><br>expFile=<span>'expFile.txt'</span> <br>groupFiles=<span>'groupFiles.txt'</span>  <br>geneFile=<span>'geneFile.txt'</span> <br><br><span>library</span>(copykat)<br>exp.File &lt;- read.delim( expFile , row.names=<span>1</span>)<br>exp.File[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>groupFiles &lt;- read.delim( groupFiles , header=<span>FALSE</span>)<br>head(groupFiles)<br> <br>head( colnames(exp.File))<br>colnames(exp.File)=gsub(<span>'^X'</span>,<span>''</span>, colnames(exp.File))<br>colnames(exp.File)=gsub(<span>'[.]'</span>,<span>'-'</span>, colnames(exp.File))<br>head( colnames(exp.File))<br><br>table(groupFiles$V2)<br>normalCells &lt;-  colnames(exp.File)[grepl(<span>"ref"</span>,groupFiles$V2)]<br>head(normalCells)<br>Sys.time()<br>res &lt;- copykat(rawmat=exp.File,  <span># 准备好的表达量矩阵 </span><br>                           id.type=<span>"S"</span>, <span># 选择 symbol，因为我们的表达量矩阵 里面是它</span><br>                           ngene.chr=<span>5</span>, <br>                           win.size=<span>25</span>, <br>                           KS.cut=<span>0.1</span>, <br>                           sam.name=<span>"test"</span>,  <span># 输出的一系列文件的前缀</span><br>                           distance=<span>"euclidean"</span>, <br>                           norm.cell.names=normalCells, <span># 正常细胞的名字</span><br>                           n.cores=<span>1</span>,<br>                           output.seg=<span>"FLASE"</span>)<br>Sys.time()<br>save(res,file = <span>'ref-of-copykat.Rdata'</span>)<br><br></code></pre><p data-tool="mdnice编辑器">可以看到：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; Sys.time()<br>[1] <span>"2021-12-02 10:14:49 CST"</span><br><span># 本身  copykat 函数运行过程也会自己记录时间 </span><br>[1] <span>"running copykat v1.0.5 updated 07/15/2021"</span><br>[1] <span>"step1: read and filter data ..."</span><br>[1] <span>"22493 genes, 6830 cells in raw data"</span><br>[1] <span>"12355 genes past LOW.DR filtering"</span><br>[1] <span>"step 2: annotations gene coordinates ..."</span><br>[1] <span>"start annotation ..."</span><br>[1] <span>"step 3: smoothing data with dlm ..."</span><br>[1] <span>"step 4: measuring baselines ..."</span><br>[1] <span>"896 known normal cells found in dataset"</span><br>[1] <span>"run with known normal..."</span><br>[1] <span>"baseline is from known input"</span><br>[1] <span>"step 5: segmentation..."</span><br>[1] <span>"step 6: convert to genomic bins..."</span><br>[1] <span>"step 7: adjust baseline ..."</span><br>[1] <span>"step 8: final prediction ..."</span><br>[1] <span>"step 9: saving results..."</span><br>[1] <span>"step 10: ploting heatmap ..."</span><br>Time difference of 4.091698 hours<br>&gt; Sys.time()<br>[1] <span>"2021-12-02 14:20:19 CST"</span><br></code></pre><p data-tool="mdnice编辑器">可以看到，不到7000个细胞还是需要运行4个小时之久，不过也是可以通过设置 线程数量 来加快这个进度！很不幸的是这个功能在Windows系统平台不支持：</p><pre data-tool="mdnice编辑器"><span></span><code>Error <span>in</span> parallel::mclapply(<span>1</span>:ncol(norm.mat), dlm.sm, mc.cores = n.cores) : <br>  <span>'mc.cores'</span> &gt; <span>1</span> is not supported on Windows <br></code></pre><p data-tool="mdnice编辑器">不过，如果你也可以通过拆分样品的然后并行全部的样品的方式进行曲线救国，也算是并行计算：</p><pre data-tool="mdnice编辑器"><span></span><code>ls -d S*|<span>while</span> <span>read</span> id;<span>do</span><br><span>echo</span> <span>$id</span>;<br><span>cd</span> <span>$id</span>;<br>nohup Rscript.exe ../scripts/step4-run-copykat.R &amp;<br><span>cd</span> ../<br><span>done</span><br></code></pre><p data-tool="mdnice编辑器">比如你在每个 样品文件夹（以S开头的文件夹）里面都存放 文件名是 expFile.txt 的矩阵</p><p data-tool="mdnice编辑器">任何就可以制作一个脚本：step4-run-copykat.R 进行如上所示的并行啦。</p><p><img data-galleryid="" data-ratio="1.2306451612903226" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wy1LXdRlBOH7zkakEdXH0yjiaeotz91mt9NunYdZYjL4q7w1jWZgokzNLzKficWweWg44m03Kjlq8qQ/640?wx_fmt=png" data-type="png" data-w="620" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wy1LXdRlBOH7zkakEdXH0yjiaeotz91mt9NunYdZYjL4q7w1jWZgokzNLzKficWweWg44m03Kjlq8qQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>Windows的并行</figcaption></figure><p data-tool="mdnice编辑器">这样的话每个病人运行十几分钟即可，超级快！</p><p data-tool="mdnice编辑器">然后我们一起看看copykat针对全部的病人混合群里的结果吧！</p><p><img data-galleryid="" data-ratio="0.9375" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wy1LXdRlBOH7zkakEdXH0yj6yObrPZxREPMsbd8OozaXF5Xf0qY0EUKgfPqYBUpdzkopjDoERPtvQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wy1LXdRlBOH7zkakEdXH0yj6yObrPZxREPMsbd8OozaXF5Xf0qY0EUKgfPqYBUpdzkopjDoERPtvQ/640?wx_fmt=jpeg"></p><figure data-tool="mdnice编辑器"><figcaption>test_copykat_heatmap</figcaption></figure><p data-tool="mdnice编辑器">很神奇的是，这个算法对上皮细胞的恶性判断有点宽松啊，我们肉眼看到的大量的非整倍体的恶性细胞，居然都被算法给漏掉了。被这个算法定义为恶性上皮细胞的居然只有不到一千个细胞 ：</p><pre data-tool="mdnice编辑器"><span></span><code>               aneuploid diploid<br>  epi                 851    3965<br>  ref-B_cell            1     411<br>  ref-T_cells           0     480<br>  spike-B_cell          1     228<br>  spike-T_cells         0     288<br></code></pre><p data-tool="mdnice编辑器">确实好奇怪啊，因为非常多的其它细胞我们肉眼看起来也是很恶性的，应该是 aneuploid，不知道为什么会被这个算法错误的判断为 diploid ，可能是我们的这个数据集是smart-seq2，并不是常见的10x数据集？</p></section><h3 data-tool="mdnice编辑器">文末友情推荐</h3><p data-tool="mdnice编辑器">与十万人一起学生信，你值得拥有下面的学习班：</p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508762&amp;idx=1&amp;sn=c411bc6007b02e1828235317465fa458&amp;chksm=9b4be3a1ac3c6ab7e649381f828aace86ac811e3edcd152a0a981118d39af4cd87260933b2dc&amp;scene=21#wechat_redirect" textvalue="数据挖掘（GEO,TCGA,单细‍胞）2021第9期" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">数据挖掘（GEO,TCGA,单细胞）2021第10期</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508762&amp;idx=2&amp;sn=d1eb0963f32da5ca35a6d873658d0179&amp;chksm=9b4be3a1ac3c6ab78521bec4b27b380f6f560cf8feaabdb744e545e8c7aa2bcfa007fc27dd0d&amp;scene=21#wechat_redirect" textvalue="生信爆款入门-2021第‍9期" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">生信爆款入门-2021第9期</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508448&amp;idx=1&amp;sn=3283fafda88479411c6fab4e54166fa0&amp;chksm=9b4be15bac3c684d6e9b5c245ce759491c54ab97f39517b266f4d9e9a68f65f2dba56b910a5b&amp;scene=21#wechat_redirect" textvalue="（千呼万唤始出来）生信技能树知识整理实习生在哪里" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">（千呼万唤始出来）生信技能树知识整理实习生在哪里</a></section></li></ul><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/WwpB--FDgZ-csCQJCx8rFg",target="_blank" rel="noopener noreferrer">原文链接</a>
