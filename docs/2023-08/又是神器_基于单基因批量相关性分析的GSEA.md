---
title: "又是神器！基于单基因批量相关性分析的GSEA"
date: 2023-08-25T08:21:59Z
draft: ["false"]
tags: [
  "fetched",
  "果子学生信"
]
categories: ["Acdemic"]
---
又是神器！基于单基因批量相关性分析的GSEA by 果子学生信
------
<div><section><h4><span>有这样的使用场景么？</span></h4><p>1.已经确定研究的基因，但是想探索他潜在的功能，可以通过跟这个基因表达最相关的基因来反推他的功能，这种方法在英语中称为guilt of association，协同犯罪。<br>2.我们的注释方法依赖于TCGA大样本，既然他可以注释基因，那么任何跟肿瘤相关的基因都可以被注释，包括长链非编码RNA。</p><p>这个方法以前阐述过：<br><a href="https://mp.weixin.qq.com/s?__biz=MzIyMzA2MTcwMg==&amp;mid=2650733008&amp;idx=1&amp;sn=b66e3fd527f99ddf19dcf6c2501e5be3&amp;chksm=f029aa79c75e236f8951b87e17a51dc6a7dfeb555b983d8dc6d5a8c756b3eacc21829f19dc86&amp;token=1035043907&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">单基因批量相关性分析的妙用</a></p><p>但是这个方法有个小缺陷，并不知道最后富集的通路是正向影响还是反向影响，也就是无法判断方向。判断方向的工具也不是没有，GSEA就是一个。所以，我想能不能把批量相关性分析和GSEA结合起来。</p><p>GSEA需要的gene set是现成的没有问题，但是genelist没有，这里我们可以把所有基因跟单个基因的相关性系数当做LogFC，有正有负，就解决了geneList的问题。这个想法不是我的，是我的一个学员的，不过他要解决的是microRNA把基因的问题。</p><p>下面来实战一下：</p><h4><span>1.首先加载数据</span></h4><p>这个数据是我下载了TPM数据，然后提取出乳腺癌的数据得来的。</p><pre><code><span>load</span>(<span>file</span> = <span>"BRCA_mRNA_exprSet.Rdata"</span>)<br>exprSet &lt;- mRNA_exprSet<br><span>test</span> &lt;- exprSet[<span>1</span>:<span>10</span>,<span>1</span>:<span>10</span>]<br></code></pre><figure><img data-ratio="0.44857142857142857" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0qRVNEtPABSRknGMHlPTvzEo7ATeUYx3SYgQREVAaOFj9ibFfKX3xus62ukRKYhEz1uS14sciaGVNg/640?wx_fmt=png" data-type="png" data-w="700" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0qRVNEtPABSRknGMHlPTvzEo7ATeUYx3SYgQREVAaOFj9ibFfKX3xus62ukRKYhEz1uS14sciaGVNg/640?wx_fmt=png"></figure><h4><span>2.写一个函数批量计算相关性</span></h4><p>这个函数只要输入一个基因，他就会批量计算这个基因跟其他编码基因的相关性，返回相关性系数和p值。</p><pre><code>batch_cor &lt;- <span><span>function</span><span>(gene)</span></span>{<br>  y &lt;- <span>as</span>.numeric(exprSet[gene,])<br>  rownames &lt;- rownames(exprSet)<br>  <span>do</span>.call(rbind,future_lapply(rownames, <span><span>function</span><span>(x)</span></span>{<br>    dd  &lt;- cor.test(<span>as</span>.numeric(exprSet[x,]),y,type=<span>"spearman"</span>)<br>    data.frame(gene=gene,mRNAs=x,cor=dd$estimate,p.value=dd$p.value )<br>  }))<br>}<br></code></pre><h4><span>3.并行化运行函数</span></h4><p>以<code>PCDC1</code>这个基因为例</p><pre><code><span>library</span>(<span>future</span><span>.apply</span>)<br><span>plan</span>(<span>multiprocess</span>)<br><span>system</span><span>.time</span>(<span>dd</span> &lt;<span>-</span> <span>batch_cor</span>("<span>PDCD1</span>"))<br></code></pre><p>这是返回的结果<br></p><figure><img data-ratio="1.1294765840220387" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0qRVNEtPABSRknGMHlPTvzV4icOULPcET44ib6Xx3D8etX1zLSRNfyzqdtxOeND6unLa0xoGXbp1fA/640?wx_fmt=png" data-type="png" data-w="363" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0qRVNEtPABSRknGMHlPTvzV4icOULPcET44ib6Xx3D8etX1zLSRNfyzqdtxOeND6unLa0xoGXbp1fA/640?wx_fmt=png"></figure><h4><span>4.制作genelist</span></h4><pre><code>gene &lt;- dd$mRNAs<br><span>## 转换</span><br>library(clusterProfiler)<br>gene = bitr(gene, fromType=<span>"SYMBOL"</span>, toType=<span>"ENTREZID"</span>, OrgDb=<span>"org.Hs.eg.db"</span>)<br><span>## 去重</span><br>gene &lt;- dplyr::distinct(gene,SYMBOL,.keep_all=<span>TRUE</span>)<br><br>gene_df &lt;- data.frame(logFC=dd$cor,<br>                      SYMBOL = dd$mRNAs)<br>gene_df &lt;- merge(gene_df,gene,by=<span>"SYMBOL"</span>)<br><br><span>## geneList 三部曲</span><br><span>## 1.获取基因logFC</span><br>geneList &lt;- gene_df$logFC<br><span>## 2.命名</span><br>names(geneList) = gene_df$ENTREZID<br><span>## 3.排序很重要</span><br>geneList = sort(geneList, decreasing = <span>TRUE</span>)<br></code></pre><h4><span>5.运行GSEA分析</span></h4><pre><code><span>library</span>(clusterProfiler)<br><span>## 读入hallmarks gene set，从哪来？</span><br>hallmarks &lt;- read.gmt(<span>"h.all.v6.2.entrez.gmt"</span>)<br><span># 需要网络</span><br>y &lt;- GSEA(geneList,TERM2GENE =hallmarks)<br></code></pre><p>作图看整体分布</p><pre><code><span>### 看整体分布</span><br>library(ggplot2)<br>dotplot(<span>y</span>,showCategory=<span>12</span>,<span>split</span>=<span>".sign"</span>)+facet_grid(~.sign)<br></code></pre><p>本次结果中全是激活的<br></p><figure><img data-backh="513" data-backw="574" data-before-oversubscription-url="https://mmbiz.qlogo.cn/mmbiz_png/NDy5aEnReX0qRVNEtPABSRknGMHlPTvzr8BQtRkfto19yL9yfkXygwicIF92dIErlzphxjWCna4B8vibk6MMUcFg/0?wx_fmt=png" data-ratio="0.8932038834951457" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0qRVNEtPABSRknGMHlPTvzr8BQtRkfto19yL9yfkXygwicIF92dIErlzphxjWCna4B8vibk6MMUcFg/640?wx_fmt=png" data-type="png" data-w="721" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0qRVNEtPABSRknGMHlPTvzr8BQtRkfto19yL9yfkXygwicIF92dIErlzphxjWCna4B8vibk6MMUcFg/640?wx_fmt=png"></figure><h4><span>6.特定通路作图</span></h4><pre><code>yd &lt;- data.frame(y)<br><span>library</span>(enrichplot)<br>gseaplot2(y,<span>"HALLMARK_INTERFERON_ALPHA_RESPONSE"</span>,color = <span>"red"</span>,pvalue_table = <span>T</span>)<br></code></pre><figure><img data-backh="295" data-backw="574" data-before-oversubscription-url="https://mmbiz.qlogo.cn/mmbiz_png/NDy5aEnReX0qRVNEtPABSRknGMHlPTvzicbuqU2Zd3zxpYWT2zptMf77CvVuYMlseSaa3WOVn2uPibL7nibT0ibT0g/0?wx_fmt=png" data-ratio="0.5151237396883593" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0qRVNEtPABSRknGMHlPTvzicbuqU2Zd3zxpYWT2zptMf77CvVuYMlseSaa3WOVn2uPibL7nibT0ibT0g/640?wx_fmt=png" data-type="png" data-w="1091" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0qRVNEtPABSRknGMHlPTvzicbuqU2Zd3zxpYWT2zptMf77CvVuYMlseSaa3WOVn2uPibL7nibT0ibT0g/640?wx_fmt=png"></figure><p><code>PCDC1</code>跟阿拉法干扰素正相关，这个事情没什么好说的吧。</p><p>好了，我们又掌握了一个特别强悍，实用的技能。我是果子，明天见。</p></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/sZJPW8OWaLNBiXXrs7UYFw",target="_blank" rel="noopener noreferrer">原文链接</a>
