---
title: "estimate 算法计算转录组数据的肿瘤纯度"
date: 2023-08-25T07:55:26Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
estimate 算法计算转录组数据的肿瘤纯度 by 生信星球
------
<div><p data-mpa-powered-by="yiban.io"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第766天</strong></span></span><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></p><hr><p><span><span>   </span><span>大神一句话，菜鸟跑半年。我不是大神，但我可以缩短你走弯路的半年~</span></span></p><p><span>   就像歌儿唱的那样，如果你不知道该往哪儿走，就留在这学点生信好不好~</span></p><p><span>   这里有豆豆和花花的学习历程，从新手到进阶，生信路上有你有我!</span></p><section><h3><span>0.肿瘤纯度</span></h3><blockquote><p>Tumour purity is the proportion of cancer cells in the admixture. <span>出自</span></p><p>https://www.nature.com/articles/ncomms9971#MOESM1235</p></blockquote><p>最近在一篇文献中看到了肿瘤纯度，当作背景知识补充一下。</p><h3><span>1.方法介绍</span></h3><p>ESTIMATE算法，可以根据表达数据估计肿瘤样本的基质分数(stromal score )和免疫分数(immune score)，用于代表基质和免疫细胞的存在。两个分数相加即得到estimate score，可用于估计肿瘤纯度。</p><p>该算法于2013年发表在NC上:</p><p>https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3826632/</p><p>2015年又有一篇NC<span>(</span><strong>以下简称15年NC</strong><span>)</span>:</p><p>https://www.nature.com/articles/ncomms9971#MOESM1235。用4种方法计算了TCGA样本的肿瘤纯度，其中就有ESTIMATE。</p><blockquote><p>如果仅仅需要肿瘤纯度，15年的这篇文章附件里有计算好的结果哦。我是为了学习根据普通转录组count如何计算出肿瘤纯度。</p></blockquote><h3><span>2.问题</span></h3><p>作者的提供的帮助文档里只有芯片数据计算方式，而<strong>未提到转录组数据如何处理</strong>。我探索了一下发现，是可以计算的，作者在estimate网站上也提供了部分TCGA project的计算结果。</p><h3><span>3.搜索ing</span></h3><p>一番搜索找到曾老板写的帖子，可谓一站式找齐了，就差操练一下：</p><p>关于<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247490228&amp;idx=2&amp;sn=037e7b0b154b47257d0eecbc4efa745d&amp;scene=21#wechat_redirect" textvalue="算法" tab="innerlink" data-linktype="2">算法</a>，介绍了算法的基本原理和方法。</p><p>关于<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486598&amp;idx=1&amp;sn=80cb6240eb615991de6a1743a22d861a&amp;scene=21#wechat_redirect" textvalue="R包的用法" tab="innerlink" data-linktype="2">R包的用法</a>，介绍了芯片数据如何得到三个score和肿瘤纯度</p><p><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247493432&amp;idx=1&amp;sn=9552c110e5fc99815530561a980f9faa&amp;scene=21#wechat_redirect" textvalue="转录组数据计算" tab="innerlink" data-linktype="2">转录组数据计算</a>，介绍了转录组count数据如何得到三个score和肿瘤纯度</p><h3><span>4.操练起来</span></h3><pre><code><span>library</span>(utils)<br>rforge &lt;- <span>"http://r-forge.r-project.org"</span><br><span>if</span>(!<span>require</span>(<span>"estimate"</span>))install.packages(<span>"estimate"</span>, repos=rforge, dependencies=<span>TRUE</span>)<br><span>library</span>(estimate)<br><span>#help(package="estimate")</span><br></code></pre><h4><span><span> </span>4.1 从count数据计算estimate score</span></h4><p>找了TCGA的ACC count数据作为示例数据。如果你想要我的示例数据，请在生信星球公众号后台回复“<strong>est766</strong>”。用自己的count数据也可以噢。</p><pre><code><span>load</span>("<span>exprSet</span><span>.Rdata</span>")<br><span>exprSet</span><span>[1:3,1:3]</span><br></code></pre><pre><code><span>#</span><span><span>#         TCGA-OR-A5JP-01A TCGA-OR-A5JG-01A TCGA-OR-A5K1-01A</span></span><br><span>#</span><span><span># MT-RNR2           810396          1190259          1206077</span></span><br><span>#</span><span><span># MT-CO1            579888          1298037          1400198</span></span><br><span>#</span><span><span># MT-ND4            623896           768059          1050890</span></span><br></code></pre><p>这是曾老板写的函数，转录组数据与芯片数据计算过程不同的地方是<code>platform</code>是illumina。</p><pre><code>dat=log2(edgeR::cpm(exprSet)+<span>1</span>)<br>library(estimate)<br>estimate &lt;- <span><span>function</span><span>(dat,pro)</span></span>{<br>  <span>input</span>.f=paste0(pro,<span>'_estimate_input.txt'</span>)<br>  <span>output</span>.f=paste0(pro,<span>'_estimate_gene.gct'</span>)<br>  <span>output</span>.ds=paste0(pro,<span>'_estimate_score.gct'</span>)<br>  <span>write</span>.<span>table</span>(dat,file = <span>input</span>.f,sep = <span>'\t'</span>,quote = F)<br>  library(estimate)<br>  filterCommonGenes(<span>input</span>.f=<span>input</span>.f,<br>                    <span>output</span>.f=<span>output</span>.f ,<br>                    id=<span>"GeneSymbol"</span>)<br>  estimateScore(<span>input</span>.ds = <span>output</span>.f,<br>                <span>output</span>.ds=<span>output</span>.ds,<br>                platform=<span>"illumina"</span>)   ## 注意platform<br>  scores=<span>read</span>.<span>table</span>(<span>output</span>.ds,skip = <span>2</span>,header = T)<br>  rownames(scores)=scores[,<span>1</span>]<br>  scores=t(scores[,<span>3</span>:ncol(scores)])<br>  <span>return</span>(scores)<br>}<br>pro=<span>'ACC'</span><br>scores=estimate(dat,pro)<br></code></pre><pre><code><span>## [1] <span>"Merged dataset includes 10221 genes (191 mismatched)."</span></span><br><span>## [1] <span>"1 gene set: StromalSignature  overlap= 139"</span></span><br><span>## [1] <span>"2 gene set: ImmuneSignature  overlap= 141"</span></span><br></code></pre><pre><code>head(scores)<br></code></pre><pre><code>##                  <span>StromalScore</span> <span>ImmuneScore</span> <span>ESTIMATEScore</span><br>## <span>TCGA</span><span>.OR</span><span>.A5JP</span><span>.01A</span>    <span>-773</span><span>.8226</span>  <span>-1143</span><span>.9749</span>    <span>-1917</span><span>.7975</span><br>## <span>TCGA</span><span>.OR</span><span>.A5JG</span><span>.01A</span>    <span>-878</span><span>.7773</span>   <span>-685</span><span>.5286</span>    <span>-1564</span><span>.3059</span><br>## <span>TCGA</span><span>.OR</span><span>.A5K1</span><span>.01A</span>    <span>-663</span><span>.8511</span>   <span>-360</span><span>.2218</span>    <span>-1024</span><span>.0729</span><br>## <span>TCGA</span><span>.OR</span><span>.A5JR</span><span>.01A</span>    <span>-931</span><span>.0601</span>   <span>-344</span><span>.3306</span>    <span>-1275</span><span>.3907</span><br>## <span>TCGA</span><span>.OR</span><span>.A5KU</span><span>.01A</span>    <span>-925</span><span>.6045</span>  <span>-1222</span><span>.4672</span>    <span>-2148</span><span>.0717</span><br>## <span>TCGA</span><span>.OR</span><span>.A5L9</span><span>.01A</span>    <span>-247</span><span>.1255</span>    404<span>.5509</span>      157<span>.4254</span><br></code></pre><h4><span><span> </span>4.2 发现输出结果里没有TumorPurity列</span></h4><p>affy芯片输出结果是有这一列的。</p><p>我对比了一下15年的那篇NC的方法部分，他们计算使用的是 level 3 RNA-seq profiles (RNAseqV2 normalized RSEM)数据，用estimate包计算了scores，用13年NC文章中的公式计算了肿瘤纯度。</p><p><strong>公式是：</strong></p><p><code>Tumour purity=cos (0.6049872018+0.0001467884 × ESTIMATE score)</code></p><p>不要忘了R语言是个好计算器</p><pre><code>TumorPurity = cos(0.6049872018+0.0001467884 * scores[,3])<br>head(TumorPurity)<br></code></pre><pre><code>## <span>TCGA</span><span>.OR</span><span>.A5JP</span><span>.01A</span> <span>TCGA</span><span>.OR</span><span>.A5JG</span><span>.01A</span> <span>TCGA</span><span>.OR</span><span>.A5K1</span><span>.01A</span> <span>TCGA</span><span>.OR</span><span>.A5JR</span><span>.01A</span> <br>##        0<span>.9481360</span>        0<span>.9303738</span>        0<span>.8984081</span>        0<span>.9139941</span> <br>## <span>TCGA</span><span>.OR</span><span>.A5KU</span><span>.01A</span> <span>TCGA</span><span>.OR</span><span>.A5L9</span><span>.01A</span> <br>##        0<span>.9583367</span>        0<span>.8091481</span><br></code></pre><h4><span><span> </span>4.3 拿原文的rsem数据来计算</span></h4><p>15年的文章给出了计算结果，我复现一下他的计算。RNAseqV2 normalized RSEM 数据不好找，我是从firehouse找到的，并进行了一些整理，让它变成了规范的表达矩阵。</p><pre><code><span>load</span>("<span>exprSet2</span><span>.Rdata</span>")<br><span>exprSet2</span><span>[1:3,1:3]</span><br></code></pre><pre><code>##       <span>TCGA-OR-A5J1-01A</span> <span>TCGA-OR-A5J2-01A</span> <span>TCGA-OR-A5J3-01A</span><br>## <span>A1BG</span>           16<span>.3305</span>           9<span>.5987</span>          20<span>.7377</span><br>## <span>A1CF</span>            0<span>.0000</span>           0<span>.0000</span>           0<span>.5925</span><br>## <span>A2BP1</span>          17<span>.2911</span>           5<span>.6368</span>           8<span>.8876</span><br></code></pre><pre><code><span>dat2</span>=log2(exprSet2+<span>1</span>)<br><span>scores2</span>=estimate(dat2,pro)<br></code></pre><pre><code><span>## [1] <span>"Merged dataset includes 10412 genes (0 mismatched)."</span></span><br><span>## [1] <span>"1 gene set: StromalSignature  overlap= 141"</span></span><br><span>## [1] <span>"2 gene set: ImmuneSignature  overlap= 141"</span></span><br></code></pre><pre><code>head(scores2)<br></code></pre><pre><code>##                  <span>StromalScore</span> <span>ImmuneScore</span> <span>ESTIMATEScore</span><br>## <span>TCGA</span><span>.OR</span><span>.A5J1</span><span>.01A</span>   <span>-1161</span><span>.6834</span>  <span>-524</span><span>.37956</span>    <span>-1686</span><span>.0629</span><br>## <span>TCGA</span><span>.OR</span><span>.A5J2</span><span>.01A</span>    <span>-569</span><span>.1191</span>  <span>-765</span><span>.96407</span>    <span>-1335</span><span>.0831</span><br>## <span>TCGA</span><span>.OR</span><span>.A5J3</span><span>.01A</span>   <span>-1295</span><span>.4628</span> <span>-1070</span><span>.18777</span>    <span>-2365</span><span>.6506</span><br>## <span>TCGA</span><span>.OR</span><span>.A5J5</span><span>.01A</span>   <span>-1710</span><span>.5108</span>  <span>-918</span><span>.61256</span>    <span>-2629</span><span>.1234</span><br>## <span>TCGA</span><span>.OR</span><span>.A5J6</span><span>.01A</span>    <span>-730</span><span>.8294</span>    64<span>.28074</span>     <span>-666</span><span>.5487</span><br>## <span>TCGA</span><span>.OR</span><span>.A5J7</span><span>.01A</span>   <span>-1191</span><span>.5230</span> <span>-1013</span><span>.01517</span>    <span>-2204</span><span>.5382</span><br></code></pre><pre><code>TumorPurity2 = cos(0.6049872018+0.0001467884 * scores2[,3])<br>head(TumorPurity2)<br></code></pre><pre><code>## <span>TCGA</span><span>.OR</span><span>.A5J1</span><span>.01A</span> <span>TCGA</span><span>.OR</span><span>.A5J2</span><span>.01A</span> <span>TCGA</span><span>.OR</span><span>.A5J3</span><span>.01A</span> <span>TCGA</span><span>.OR</span><span>.A5J5</span><span>.01A</span> <br>##        0<span>.9367771</span>        0<span>.9175140</span>        0<span>.9669692</span>        0<span>.9761016</span> <br>## <span>TCGA</span><span>.OR</span><span>.A5J6</span><span>.01A</span> <span>TCGA</span><span>.OR</span><span>.A5J7</span><span>.01A</span> <br>##        0<span>.8741344</span>        0<span>.9606713</span><br></code></pre><p>我把这个计算结果与15年的NC做了比较，一毛不差，开心。</p><h4><span><span> </span>4.4 比较cpm和rsem结果</span></h4><p>我把两个数据处理得到的结果组成一个表格来比较一下：</p><pre><code>TumorPurity2 = TumorPurity2[match(names(TumorPurity),names(TumorPurity2))]<br>compare = cbind(TumorPurity,TumorPurity2)<br><span>round(compare,4)[1:10,]</span><br></code></pre><pre><code>##                  <span>TumorPurity</span> <span>TumorPurity2</span><br>## <span>TCGA</span><span>.OR</span><span>.A5JP</span><span>.01A</span>      0<span>.9481</span>       0<span>.9493</span><br>## <span>TCGA</span><span>.OR</span><span>.A5JG</span><span>.01A</span>      0<span>.9304</span>       0<span>.9344</span><br>## <span>TCGA</span><span>.OR</span><span>.A5K1</span><span>.01A</span>      0<span>.8984</span>       0<span>.9003</span><br>## <span>TCGA</span><span>.OR</span><span>.A5JR</span><span>.01A</span>      0<span>.9140</span>       0<span>.9133</span><br>## <span>TCGA</span><span>.OR</span><span>.A5KU</span><span>.01A</span>      0<span>.9583</span>       0<span>.9603</span><br>## <span>TCGA</span><span>.OR</span><span>.A5L9</span><span>.01A</span>      0<span>.8091</span>       0<span>.8106</span><br>## <span>TCGA</span><span>.OR</span><span>.A5JQ</span><span>.01A</span>      0<span>.8303</span>       0<span>.8306</span><br>## <span>TCGA</span><span>.OR</span><span>.A5K4</span><span>.01A</span>      0<span>.9829</span>       0<span>.9852</span><br>## <span>TCGA</span><span>.OR</span><span>.A5JL</span><span>.01A</span>      0<span>.9416</span>       0<span>.9434</span><br>## <span>TCGA</span><span>.OR</span><span>.A5LS</span><span>.01A</span>      0<span>.9748</span>       0<span>.9774</span><br></code></pre><p>其实count数据里还少了两个基因(有mismatch)。不过计算结果也相差无几咯。非常完美的结果。</p><h4><span><span> </span>5.一点争议</span></h4><p>illumina输出结果不带有Tumorpurity列，这是包自身的设置。</p><p>在biostars上面看到一个讨论，有人认为estimate score 计算肿瘤纯度的公式是根据Affymetrix的芯片数据得出的，是专门针对芯片数据使用，因此不可以用于转录组。建议只计算出estimate score，用这个分数来代替肿瘤纯度的绝对数值用于后续分析。</p><p>原帖讨论见：https://www.biostars.org/p/279853/</p><p>然而NC 15年就已经发了这篇文章，五年来没人反对，可以认为人家做的是可用的，用就是了呗。</p></section><section><blockquote><p><strong>插个小广告！</strong></p><p><strong><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247487729&amp;idx=2&amp;sn=c8075ff6c06998a939cc398b486e9ae1&amp;chksm=fdf858b3ca8fd1a5eaefc81fd5c0481b89b84cdc858e9c7e590dfd9301c00f03a2215068fdc0&amp;scene=21#wechat_redirect" textvalue="生信零基础入门学习小组" data-itemshowtype="0" tab="innerlink" data-linktype="2">生信零基础入门学习小组</a></strong></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247489745&amp;idx=3&amp;sn=318973f08f6e7173671d739e0a07b50c&amp;chksm=fdf85093ca8fd98549b8ebb16aa86257d5291cc17681462de51734b47f7da1c1a850d134756f&amp;scene=21#wechat_redirect" textvalue="生信入门班（四周线上直播课，长期开班）" data-itemshowtype="11" tab="innerlink" data-linktype="2"><strong>生信入门班（四周线上直播课，长期开班）</strong></a></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247489745&amp;idx=2&amp;sn=644459ef386fde140f8459f7641eeca8&amp;chksm=fdf85093ca8fd985a31f441f07516238c15660ecdd300049c7fc08adfab973078f421b5b101f&amp;scene=21#wechat_redirect" textvalue="数据挖掘线上班（三周线上直播课，长期开班）" data-itemshowtype="11" tab="innerlink" data-linktype="2"><strong>数据挖掘班（医生/医学生首选，三周线上直播课，长期开班）</strong></a></p><p><strong><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247487032&amp;idx=2&amp;sn=fe2100fb70e84f7b4da00cb744c565a3&amp;chksm=fdf8467aca8fcf6ce40679d990a45c13c6c2b409a826e82be8a3c2db383845eca743553be9a9&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">一起来学单细胞吗？</a></strong></p><p><strong>答疑公告：</strong><strong><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247487050&amp;idx=2&amp;sn=aac649edf53957bb876d466af728311f&amp;chksm=fdf84608ca8fcf1e2571ad8aba6e0c721ef056f48693905b0575549d2228946fff4cb3deff19&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">生信星球答疑公告-2020年全年有效</a></strong><span></span></p></blockquote></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ux6SWASZWvBxQerPnzt5Uw",target="_blank" rel="noopener noreferrer">原文链接</a>
