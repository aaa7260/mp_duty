---
title: "ROC曲线的省版面费版本"
date: 2023-08-13T00:59:51Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
ROC曲线的省版面费版本 by 生信星球
------
<div><section data-mpa-powered-by="yiban.io"><span>‍</span><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第924天</strong></span></span><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><section><span><span>   </span><span>大神一句话，菜鸟跑半年。我不是大神，但我可以缩短你走弯路的半年~</span></span></section><section><span>   就像歌儿唱的那样，如果你不知道该往哪儿走，就留在这学点生信好不好~</span></section><p><span>   这里有豆豆和花花的学习历程，从新手到进阶，生信路上有你有我！</span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>0.需求</span><span><span> </span></span></h4><p data-tool="mdnice编辑器">学生听讲座看到一个图，想复现一下，找到了我。。。<img data-ratio="0.7691218130311614" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrAOfLovJSfqiajquvsNMrnib0p0svaLt44w8CicIZ2A84FAeCVtEicR54mPKx0E8kKAk0rXTKAicgzdOw/640?wx_fmt=png" data-type="png" data-w="706" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrAOfLovJSfqiajquvsNMrnib0p0svaLt44w8CicIZ2A84FAeCVtEicR54mPKx0E8kKAk0rXTKAicgzdOw/640?wx_fmt=png">他的需求描述如下</p><p data-tool="mdnice编辑器">目的：</p><p data-tool="mdnice编辑器">希望将timeROC曲线的9根线的信息展现在柱状图上</p><p data-tool="mdnice编辑器">疑问：</p><p data-tool="mdnice编辑器">柱子的高度对应AUC的值；</p><p data-tool="mdnice编辑器">误差棒的值在哪得到？</p><p data-tool="mdnice编辑器">上方的统计检验如何添加？</p><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>1.数据</span><span><span> </span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>load(<span>"model_genes_survs.Rdata"</span>)<br>library(survival)<br>library(timeROC)<br>result = list()<br>p = list()<br><span>for</span>(i <span>in</span> 1:3){<br>  result[[i]] &lt;-with(survs[[i]], timeROC(T=time,<br>                                         delta=event,<br>                                         marker=fp,<br>                                         cause=1,<br>                                         <span>times</span>=c(365,1095,1825),<br>                                         iid = TRUE))<br>  dat = data.frame(fpr = as.numeric(result[[i]]<span>$FP</span>),<br>                   tpr = as.numeric(result[[i]]<span>$TP</span>),<br>                   time = rep(as.factor(c(365,1095,1825)),each = nrow(result[[i]]<span>$TP</span>)))<br><br>  library(ggplot2)<br>  p[[i]] = ggplot() + <br>    geom_line(data = dat,aes(x = fpr, y = tpr,color = time),size = 1) + <br>    scale_color_manual(name = NULL,values = c(<span>"#92C5DE"</span>, <span>"#F4A582"</span>, <span>"#66C2A5"</span>),<br>                       labels = paste0(<span>"AUC of "</span>,c(1,3,5),<span>"-y survival: "</span>,<br>                                       format(round(result[[i]]<span>$AUC</span>,2),nsmall = 2)))+<br>    geom_line(aes(x=c(0,1),y=c(0,1)),color = <span>"grey"</span>)+<br>    theme_bw()+<br>    theme(panel.grid = element_blank(),<br>          legend.background = element_rect(linetype = 1, size = 0.2, colour = <span>"black"</span>),<br>          legend.position = c(0.765,0.125))+<br>    scale_x_continuous(expand = c(0.005,0.005))+<br>    scale_y_continuous(expand = c(0.005,0.005))+<br>    labs(x = <span>"1 - Specificity"</span>,<br>         y = <span>"Sensitivity"</span>)+<br>    coord_fixed()<br>}<br>library(patchwork)<br>wrap_plots(p)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.3333333333333333" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrAOfLovJSfqiajquvsNMrnibicBLFuWqaUd2LGOEiaMafickZ3WeRTGVsI6icmrPRVdjSAJgESgiaAblWIQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrAOfLovJSfqiajquvsNMrnibicBLFuWqaUd2LGOEiaMafickZ3WeRTGVsI6icmrPRVdjSAJgESgiaAblWIQ/640?wx_fmt=png"><figcaption>image.png</figcaption></figure><p data-tool="mdnice编辑器">这是上课多个数据批量绘制timeROC曲线的代码。</p><p data-tool="mdnice编辑器">result是3个数据分别timeROC得到的3个结果，p是三个图。</p><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>2.误差棒可以表示什么</span><span><span> </span></span></h4><p data-tool="mdnice编辑器">误差棒（error bars）是一种用于可视化数据不确定性的图形元素。它们通常用于表示统计数据中的变异程度，如标准差、标准误差、置信区间等。</p><p data-tool="mdnice编辑器">误差棒一般绘制在数据点或柱状图的上方和下方，以展示数据的范围或不确定性。常见的误差棒类型包括：</p><p data-tool="mdnice编辑器">1.标准差误差棒（Standard Deviation Error Bars）：基于数据的标准差来表示不确定性，显示了数据分布的散布情况。</p><p data-tool="mdnice编辑器">2.标准误差误差棒（Standard Error Error Bars）：基于样本均值和样本大小来估计总体均值的不确定性。</p><p data-tool="mdnice编辑器">3.置信区间误差棒（Confidence Interval Error Bars）：基于统计方法计算出的置信区间来表示不确定性，通常使用较为常见的95%或99%置信水平。</p><p data-tool="mdnice编辑器">误差棒的长度可以根据需要进行调整，以反映不确定性的大小。较长的误差棒表示较大的不确定性，而较短的误差棒表示较小的不确定性。</p><p data-tool="mdnice编辑器">绘制误差棒有助于观察数据的变异性和比较不同组之间的差异，同时提供了关于数据可靠性和置信度的信息。这种可视化方法有助于更全面地理解和解释数据分析结果。</p><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>3.探索timeROC计算结果</span><span><span> </span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>result[[1]]<span>$AUC</span><br><span>##     t=365    t=1095    t=1825 </span><br><span>## 0.9044373 0.9271197 0.8987427</span><br><br>confint(result[[1]], level = 0.95)<span>$CI_AUC</span><br><br><span>##         2.5% 97.5%</span><br><span>## t=365  87.58 93.31</span><br><span>## t=1095 89.84 95.59</span><br><span>## t=1825 86.13 93.62</span><br></code></pre><p data-tool="mdnice编辑器">画图所需的数据就是AUC的值和置信区间呗。上面的代码就可以得到。</p><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>4.搞数据，画图</span><span><span> </span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>dats = lapply(1:3,<span>function</span>(i){<br>  dat = data.frame(x = factor(1:3),<br>                   y = result[[i]]<span>$AUC</span>,<br>                   confint(result[[i]], level = 0.95)<span>$CI_AUC</span> *0.01)<br>  colnames(dat)[3:4] = c(<span>"min"</span>,<span>"max"</span>)<br>  dat<span>$category</span> = paste0(<span>"dat"</span>,i)<br>  <span>return</span>(dat)<br>})<br>dats = do.call(rbind,dats)<br>dats<br><br><span>##         x         y    min    max category</span><br><span>## t=365   1 0.9044373 0.8758 0.9331     dat1</span><br><span>## t=1095  2 0.9271197 0.8984 0.9559     dat1</span><br><span>## t=1825  3 0.8987427 0.8613 0.9362     dat1</span><br><span>## t=3651  1 0.6754528 0.6019 0.7491     dat2</span><br><span>## t=10951 2 0.7570410 0.6986 0.8155     dat2</span><br><span>## t=18251 3 0.7568955 0.6960 0.8178     dat2</span><br><span>## t=3652  1 0.7734769 0.7180 0.8290     dat3</span><br><span>## t=10952 2 0.8281020 0.7802 0.8760     dat3</span><br><span>## t=18252 3 0.8514874 0.8048 0.8982     dat3</span><br></code></pre><p data-tool="mdnice编辑器">数据有咯。画图搞起。</p><pre data-tool="mdnice编辑器"><span></span><code>ggplot(dats, aes(x = category, y = y, fill = x)) +<br>  geom_bar(<span>stat</span> = <span>"identity"</span>, position = <span>"dodge"</span>) +<br>  geom_text(aes(label = round(y,2)), vjust = 4, size = 3,<br>            position = position_dodge(width = 0.9)) +<br>  geom_errorbar(aes(ymin = min, ymax = max), <br>                width = 0.2,<br>                position = position_dodge(width = 0.9)) +<br>  <span>#ggpubr::stat_compare_means(aes(group = x, label = after_stat(p.signif)))+</span><br>  scale_fill_brewer(palette = <span>"Set2"</span>)+<br>  theme_bw()<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrAOfLovJSfqiajquvsNMrnibW6MpYwKDlp2xCsEz1wlk0jz19R8cLoco59cZu9Km6YjGhb7FdAe4rg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrAOfLovJSfqiajquvsNMrnibW6MpYwKDlp2xCsEz1wlk0jz19R8cLoco59cZu9Km6YjGhb7FdAe4rg/640?wx_fmt=png">组间比较没画，stat_compare_means只能给出每个组内部的总体p值或者显著性，组内两两比较要手动去搞，这个应该也没啥必要吧。为什么希望一年三年五年生存率的预测准确程度是有差别的啊。<span></span></p></section><section><figure data-tool="mdnice编辑器"><span></span></figure></section><section><figure data-tool="mdnice编辑器"><span></span></figure></section><section><figure data-tool="mdnice编辑器"></figure></section><section><blockquote><section><span>如果因为代码看不懂，而跟不上正文的节奏，可以来找我，相当于来一个新手保护期。我的</span><span>课程都是循环开课。</span><span>下一期的时间，点进去咨询微信咯</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247493441&amp;idx=1&amp;sn=95e2cc24fda53117ae312d6644c1b221&amp;chksm=fdfbaf03ca8c2615d80969e56cf8863219c0afd2efd0dca01b907a3c815b73ef9f77d90bdb0c&amp;scene=21#wechat_redirect" textvalue="新的一年，你要不要来找我‍们学‍习生信" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">找我<span>‍</span>们学习<span>‍</span>生信</a><br></section></blockquote></section><section><section><br></section></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/KcYMFBaGpmtXaAq5DPrqSw",target="_blank" rel="noopener noreferrer">原文链接</a>
