---
title: "空转 | 我，SPOTlight，用解卷积，解决空间转录组spot注释！"
date: 2023-08-04T04:24:44Z
draft: ["false"]
tags: [
  "fetched",
  "生信补给站"
]
categories: ["Acdemic"]
---
空转 | 我，SPOTlight，用解卷积，解决空间转录组spot注释！ by 生信补给站
------
<div><p><span>前面介绍过<span>整合scRNA-seq和空间转录组数据主要有（1）映射（Mapping）和<span>（2）去卷积（Deconvolution）</span>两种方法。前面<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650400985&amp;idx=1&amp;sn=c0a78b0e8f732ef4b5fca1a367f55862&amp;chksm=f01c8a39c76b032fb86ae163e13f7c995678ca8cc8261709513fb0cf97ef1fa8c36baded2c75&amp;scene=21#wechat_redirect" textvalue="空转 | 结合scRNA完成空转spot注释（Seurat Mapping） &amp;  彩蛋（封面的空转主图代码）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">空转 | 结合scRNA完成空转spot注释（Seurat Mapping） &amp;  彩蛋（封面的空转主图代码）</a></span></span><span>介绍了使用Seurat Mapping的方式进行spot注释，本文介绍一种经典的解卷积方法</span><span><span>-</span></span><span>SPOTlight</span><span>。</span></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><p><span>一 载入R包，数据 </span></p></section></section></section></section></section><p><br></p><p><span>直接使用前面Seurat<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650400985&amp;idx=1&amp;sn=c0a78b0e8f732ef4b5fca1a367f55862&amp;chksm=f01c8a39c76b032fb86ae163e13f7c995678ca8cc8261709513fb0cf97ef1fa8c36baded2c75&amp;scene=21#wechat_redirect" textvalue="空转 | 结合scRNA完成空转spot注释（Seurat Mapping） &amp;  彩蛋（封面的空转主图代码）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">空转</a>得到的空转和单细胞转录组的结果。</span><br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span>library(SPOTlight)</span></code><code><span>library(Seurat)</span></code><code><span>library(ggplot2)</span></code><code><span>library(SingleCellExperiment)</span></code><code><span>library(scater)</span></code><code><span>library(scran)</span></code><code><span><br></span></code><code><span><span>#load data</span></span></code><code><span><span>load</span>(<span>"Brain_ST_scRNA.sBio.Rdata"</span>)</span></code><code><span><span>head</span>(Brain_scRNA)</span></code><code><span><span>head</span>(Brain_ST)</span></code></pre></section><p><img data-ratio="0.3731481481481482" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHtxyKdKQK08icerib3vzPhAicsTjtyTGEVR3C4asianEF4IESia7YjSdtR8A/640?wx_fmt=png" data-type="png" data-w="1080" width="1040.8" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHtxyKdKQK08icerib3vzPhAicsTjtyTGEVR3C4asianEF4IESia7YjSdtR8A/640?wx_fmt=png"></p><p>准备工作详见前面，单细胞数据最好完成了注释。</p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><p><span>二 SPOTlight 分析 </span></p></section></section></section></section></section><p><br></p><h3><span><strong>1，数据处理</strong></span></h3><p><span>先将数据转为SingleCellExperiment<span> 对象，然后按照官网文档<span>https://github.com/MarcElosua/SPOTlight/blob/HEAD/vignettes/SPOTlight_kidney.Rmd </span>进行处理</span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>sce &lt;- <span>as</span>.SingleCellExperiment(Brain_scRNA)</span></code><code><span><br></span></code><code><span><span>### Feature selection</span></span></code><code><span>sce &lt;- logNormCounts(sce)</span></code><code><span><br></span></code><code><span><span>### Variance modelling</span></span></code><code><span><span># 去掉核糖体和线粒体基因</span></span></code><code><span>genes &lt;- !grepl(pattern = <span>"^RP[L|S]|MT"</span>, x = rownames(sce))</span></code><code><span>dec &lt;- modelGeneVar(sce , subset.row = genes)</span></code><code><span><br></span></code><code><span><span># 计算高变基因</span></span></code><code><span>hvg &lt;- getTopHVGs(dec, n = <span>3000</span>)</span></code><code><span><br></span></code><code><span><span># 加上细胞注释信息</span></span></code><code><span>colLabels(sce) &lt;- colData(sce)$celltype</span></code><code><span><br></span></code><code><span><span># Compute marker genes</span></span></code><code><span>mgs &lt;- scoreMarkers(sce, subset.row = genes)</span></code><code><span><br></span></code><code><span><span># 保留最相关的marker基因</span></span></code><code><span>mgs_fil &lt;- lapply(names(mgs), <span><span>function</span><span>(i)</span> </span>{</span></code><code><span>  x &lt;- mgs[[i]]</span></code><code><span>  <span># Filter and keep relevant marker genes, those with AUC &gt; 0.8</span></span></code><code><span>  x &lt;- x[x$mean.AUC &gt; <span>0.8</span>, ]</span></code><code><span>  <span># Sort the genes from highest to lowest weight</span></span></code><code><span>  x &lt;- x[order(x$mean.AUC, decreasing = <span>TRUE</span>), ]</span></code><code><span>  <span># Add gene and cluster id to the dataframe</span></span></code><code><span>  x$gene &lt;- rownames(x)</span></code><code><span>  x$cluster &lt;- i</span></code><code><span>  data.frame(x)</span></code><code><span>})</span></code><code><span>mgs_df &lt;- <span>do</span>.call(rbind, mgs_fil)</span></code></pre></section><p><img data-ratio="0.38796296296296295" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHCXsxbdibznH9h0TTAd1tS6ZbmicpILib1n3GetwDtPeib0OHpApUouicpnw/640?wx_fmt=png" data-type="png" data-w="1080" width="926.4" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHCXsxbdibznH9h0TTAd1tS6ZbmicpILib1n3GetwDtPeib0OHpApUouicpnw/640?wx_fmt=png"></p><p><span>使用<span>lapply</span>函数批量得到每种celltype的marker 基因，这里是根据<strong><span>AUC的阈值（0.8）</span></strong>进行筛选，其中0.8 可以根据需要自行更改。</span></p><h3><span><strong>2，</strong></span><span><strong>SPOTlight分析</strong></span></h3><p><span><span>使用SPOTlight主函数进行分析，</span><span><strong><span>注新版本的是SPOTlight函数，而不是</span><span>spotlight_deconvolution函数</span></strong></span><span>了。</span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="properties"><code><span><span>### Deconvolution</span></span></code><code><span><span>res</span> <span>&lt;- SPOTlight(</span></span></code><code><span>  <span>x</span> = <span>sce, </span></span></code><code><span>  <span>y</span> = <span>Brain_ST,</span></span></code><code><span><span>  groups </span>=<span> as.character(sce$celltype), # 也可以是cluster，</span></span></code><code><span>  <span>mgs</span> = <span>mgs_df,</span></span></code><code><span>  <span>hvg</span> = <span>hvg,</span></span></code><code><span>  <span>weight_id</span> = <span>"mean.AUC",</span></span></code><code><span><span>  group_id </span>=<span> "cluster",</span></span></code><code><span>  <span>gene_id</span> = <span>"gene")</span></span></code><code><span><span>  </span></span></code><code><span><span>#Extract data from `SPOTlight`:</span></span></code><code><span><span>str(res) #查看结果类型</span> <span></span></span></code><code><span><span>decon_mtrx</span> <span>&lt;- res$mat</span></span></code><code><span><span>#这里重命名，非必要</span></span></code><code><span><span>colnames(decon_mtrx)</span> <span>&lt;- paste(colnames(decon_mtrx),"Spotlight",sep = "_")</span></span></code></pre></section><p><img data-ratio="0.2712962962962963" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHiasXDQT4qrbw1kaDCdQqN9Jia6r6D8RMoGAZOy5euMeLAPbicoaCibaR1w/640?wx_fmt=png" data-type="png" data-w="1080" width="908.8" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHiasXDQT4qrbw1kaDCdQqN9Jia6r6D8RMoGAZOy5euMeLAPbicoaCibaR1w/640?wx_fmt=png"></p><p><span>结果得到的是每个spot的 各个celltype的占比，这里<span><strong>重命名是为了区分</strong></span>（比如后面使用其他方法进行注释）。</span></p><p><span>和Seurat一致，也可以</span><span>2种保存方式</span></p><p><span>（1）</span><span><strong>添加至metadata.</strong></span></p><p><span>（2）虽然<span>res</span> 不是</span><span><strong>SeuratObject </strong></span><span>，但是也可以构建为<strong><span>新的slot </span></strong>。</span></p><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="perl"><code><span><span>#meta 方式添加</span></span></code><code><span>Brain_ST@meta.data &lt;- cbind(Brain_ST@meta.data, decon_mtrx)</span></code><code><span>head(Brain_ST)</span></code><code><span><br></span></code><code><span><span>#构建新的 slot</span></span></code><code><span>Brain_ST[[<span>"SPOTlight"</span>]] &lt;- CreateAssayObject(t(res$mat))</span></code><code><span>DefaultAssay(Brain_ST) &lt;- <span>"SPOTlight"</span></span></code></pre></section><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><p><span>三 SPOTlight 结果可视化 </span></p></section></section></section></section></section><p><br></p><h3><span><strong>1，提取SPOTlight结果</strong></span></h3><section><ul><li><li><li><li><li></ul><pre data-lang="perl"><code><span><span>## 提取结果</span></span></code><code><span>head(mat &lt;- res$mat)[, seq_len(<span>length</span>(unique(sce$celltype)))]</span></code><code><span>mod &lt;- res$NMF</span></code><code><span><br></span></code><code><span>res.data &lt;- (mat &lt;- res$mat)[, seq_len(<span>length</span>(unique(sce$celltype)))]</span></code></pre></section><p><span><strong>2，topic对细胞类型的拟合情况</strong></span><br></p><p><span>使用</span><span>plotTopicProfiles 函数绘制拟合情况图</span></p><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span><span>## 检查topic对细胞类型的拟合情况</span></span></code><code><span>plotTopicProfiles(</span></code><code><span>  x = mod,</span></code><code><span>  y = sce$celltype,  <span>#</span></span></code><code><span>  facet = <span>FALSE</span>,</span></code><code><span>  min_prop = <span>0.01</span>,</span></code><code><span>  ncol = <span>1</span>) +</span></code><code><span>  theme(aspect.ratio = <span>1</span>)</span></code></pre></section><p><img data-ratio="0.8795411089866156" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHTzFc0L1hxwKoUj1viargHItf7Oy8zMPvs1Qh0bosbVdQNhJz1BWhbxA/640?wx_fmt=png" data-type="png" data-w="523" width="418.4" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHTzFc0L1hxwKoUj1viargHItf7Oy8zMPvs1Qh0bosbVdQNhJz1BWhbxA/640?wx_fmt=png"></p><p><span><strong>3，Correlation Matrix 和 Co-localization</strong></span><span></span></p><section><ul><li><li><li><li><li></ul><pre data-lang="nginx"><code><span><span>## Spatial Correlation Matrix</span></span></code><code><span><span>p1</span> &lt;- plotCorrelationMatrix(mat)</span></code><code><span><span>## Co-localization</span></span></code><code><span>p2 &lt;- plotInteractions(mat, <span>"heatmap"</span>)</span></code><code><span>plotInteractions(mat, <span>"network"</span>)</span></code></pre></section><p><img data-ratio="0.4046296296296296" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHIiaXE18tz6jvNJibvjFjFYgKD3kApgv9NaNB4XLH2icoBcAYVzvXaQGRg/640?wx_fmt=png" data-type="png" data-w="1080" width="968" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHIiaXE18tz6jvNJibvjFjFYgKD3kApgv9NaNB4XLH2icoBcAYVzvXaQGRg/640?wx_fmt=png"></p><p><strong><span><span>4，Scatterpie 饼图</span></span></strong></p><p><span>这时SPOTlight 注释spot后的核心图，将每个spot中的各celltype比例绘制为饼图，可以<strong><span>绘制到切片tiff</span></strong>背景上（左图），也可以同样的形状绘制在白板上（右图）。</span><span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="properties"><code><span><span>ct</span> <span>&lt;- colnames(mat)</span></span></code><code><span><span>mat[mat</span> <span>&lt; 0.1] &lt;- 0</span></span></code><code><span><span>#自定义颜色</span></span></code><code><span><span>paletteMartin</span> <span>&lt;- c(</span></span></code><code><span>  <span>"#000000",</span> <span>"#004949", "#009292", "#ff6db6", "#ffb6db", </span></span></code><code><span><span>  "#490092", "#006ddb", "#b66dff", "#6db6ff", "#b6dbff",</span></span></code><code><span>  <span>"#920000",</span> <span>"#924900", "#db6d00", "#24ff24", "#ffff6d")</span></span></code><code><span><span>pal</span> <span>&lt;- colorRampPalette(paletteMartin)(length(ct))</span></span></code><code><span><br></span></code><code><span><span>names(pal) &lt;- ct</span></span></code><code><span><br></span></code><code><span><span>p3</span> <span>&lt;- plotSpatialScatterpie(</span></span></code><code><span>  <span>x</span> = <span>Brain_ST,</span></span></code><code><span>  <span>y</span> = <span>mat,</span></span></code><code><span>  <span>cell_types</span> = <span>colnames(mat),</span></span></code><code><span><span>  img </span>=<span> T, #以tiff为背景</span></span></code><code><span>  <span>scatterpie_alpha</span> = <span>1,</span></span></code><code><span>  <span>pie_scale</span> = <span>0.4, </span></span></code><code><span><span>  # Rotate the image 90 degrees counterclockwise</span></span></code><code><span>  <span>degrees</span> = <span>-90,</span></span></code><code><span><span>  # Pivot the image on its x axis</span></span></code><code><span>  <span>axis</span> = <span>"h") +</span></span></code><code><span>  <span>scale_fill_manual(</span></span></code><code><span>    <span>values</span> = <span>pal,</span></span></code><code><span>    <span>breaks</span> = <span>names(pal))</span></span></code><code><span>    </span></code><code><span><span>p4</span> <span>&lt;- plotSpatialScatterpie(</span></span></code><code><span>  <span>x</span> = <span>Brain_ST,</span></span></code><code><span>  <span>y</span> = <span>mat,</span></span></code><code><span>  <span>cell_types</span> = <span>colnames(mat),</span></span></code><code><span>  <span>img</span> = <span>FALSE,</span></span></code><code><span>  <span>scatterpie_alpha</span> = <span>1,</span></span></code><code><span>  <span>pie_scale</span> = <span>0.4) +</span></span></code><code><span>  <span>scale_fill_manual(</span></span></code><code><span>    <span>values</span> = <span>pal,</span></span></code><code><span>    <span>breaks</span> = <span>names(pal))</span></span></code><code><span><span>p3 + p4</span></span></code></pre></section><p><img data-ratio="0.4009259259259259" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHCuWUFfdErHFVAcJDbDiaMlmsq9Sb5qoqiaSs3f4xdRO3qplzZr0rnVrw/640?wx_fmt=png" data-type="png" data-w="1080" width="975.2" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHCuWUFfdErHFVAcJDbDiaMlmsq9Sb5qoqiaSs3f4xdRO3qplzZr0rnVrw/640?wx_fmt=png"></p><p>注意：<span>（1）可以</span><span>通</span><span>过</span><span>img 是否添加背景</span><span> ；</span><span> </span></p><p><span>（2）</span><span>pal</span><span> 自定义颜色，注意长度 与celltype个数一致</span><span> ；</span></p><p><span></span><span>（3）</span><span>degrees</span><span> 调整翻转角度 和 </span><span>tiff</span><span>图</span><span>片一致</span></p><p><strong>5，批量绘制解析后的结果</strong></p><p><span>前面Seurat的 四<span> 彩蛋- 空转主图可视化 部分了</span>介绍了<span>lapply </span></span>得到list然后自定义拼图的方式，这里介绍一下<span><strong><span>SpatialFeaturePlot</span></strong></span>进行绘制的方式<span><span>。</span> </span></p><p><strong><span>注意要用 &amp; 而不是 + ，否则后续的theme等设置只会对最后一张图有效果。 </span></strong><span></span></p><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="makefile"><code><span>celltypes = rownames(Brain_ST)</span></code><code><span>SpatialFeaturePlot(Brain_ST, features = celltypes, </span></code><code><span>                   pt.size.factor = 1.6, </span></code><code><span>                   ncol = 4, </span></code><code><span>                   crop = TRUE) &amp;</span></code><code><span>  DarkTheme() &amp;   </span></code><code><span>  theme(text=element_text(size=14)) &amp; </span></code><code><span>  theme(text=element_text(face = <span>"bold"</span>)) &amp;</span></code><code><span>  theme(legend.text=element_text(size=7))</span></code></pre></section><p><img data-ratio="0.6425925925925926" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHhib3UlrnR0dPkPbia9HaDlSteOrtR1ic8icsU2sucvjdCG4I4aMibDkx3EQ/640?wx_fmt=png" data-type="png" data-w="1080" width="968" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjD2vrV78lzPN4Rds5cdJMxHhib3UlrnR0dPkPbia9HaDlSteOrtR1ic8icsU2sucvjdCG4I4aMibDkx3EQ/640?wx_fmt=png"></p><blockquote data-type="2" data-url="" data-author-name="" data-content-utf8-length="145" data-source-title=""><section><section>https://github.com/satijalab/seurat/issues/3698   </section><section><span>That is because of differences between patchwork and ggplot2. Simply use patchwork theming </span><span>&amp;</span><span> instead of ggplot2 </span><span>+</span><span>.</span></section></section></blockquote><p><span><br></span></p><p><strong><span>参考资料：</span></strong><span></span><br></p><p>https://github.com/MarcElosua/SPOTlight/blob/HEAD/vignettes/SPOTlight_kidney.Rmd</p><p><br></p><section data-style-type="7" data-tools="新媒体排版" data-id="9190"><p><span><span data-txtless="spin" data-txtlessp="120">◆ </span><span>◆ </span><span data-txtless="spin" data-txtlessp="-120">◆  <span data-txtless="spin" data-txtlessp="120">◆ </span><span>◆</span></span></span></p><section><mp-common-profile data-pluginname="mpprofile" data-id="MzIyNDI1MzgzOQ==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjCh1HyEjoPcBiaKy86NdKGZtju9o0oDBPicVK0lcoovRfticNuwPSj0Kib8cxqaVfBcTVCDAJ5icptybsg/0?wx_fmt=png" data-nickname="生信补给站" data-alias="Bioinfo_R_Python" data-signature="生信，R语言， Python，数据处理、统计检验、模型构建、数据可视化，我输出您输入！" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><p><span><span data-txtless="spin" data-txtlessp="-120"><span></span></span></span></p></section><p cid="n94" mdtype="paragraph"><span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650398215&amp;idx=1&amp;sn=730225fb5ba3a51ceb8df0a531632515&amp;chksm=f01cbce7c76b35f1bebbf327d78a51d859770a46ae1329d362e3b705c4f8765ee2dc461d24dc&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">精心整理（含图PLUS版）|R语言生信分析，可视化</a>（R统计，ggplot2绘图，生信图形可视化汇总）</span></p><p cid="n94" mdtype="paragraph"><span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650400742&amp;idx=1&amp;sn=dca078db8e6c0c742264dcb0bf56a8e2&amp;chksm=f01c8506c76b0c107782efb89c5f5c0e244a9d664c15ea2b9d16dc70067b7249bd0e7ea9f9ae&amp;scene=21#wechat_redirect" textvalue="RNAseq纯生信挖掘思路分享？不，主要是送你代码！（建议收藏）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">RNAseq纯生信挖掘思路分享？不，主要是送你代码！（建议收藏）</a></span></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/n5nbe7U9_iagK0lpnPCI_A",target="_blank" rel="noopener noreferrer">原文链接</a>
