---
title: "药物预测之差异基因为什么不行"
date: 2023-08-16T00:09:53Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
药物预测之差异基因为什么不行 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>有了前面的教程：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247507359&amp;idx=1&amp;sn=e1b1602338792b6bbd7283bbcc07fe81&amp;scene=21#wechat_redirect" data-linktype="2">药物预测之认识表达量矩阵和药物IC50</a> 的背景知识铺垫，认识了Cancer Therapeutics Response Portal (CTRP) 和 Genomics of Drug Sensitivity in Cancer (<strong>GDSC</strong>) 两个数据库资源。也介绍了2021年7月新鲜出炉的 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247507376&amp;idx=1&amp;sn=6993a13200be452c9dfa527e9fdc8ae4&amp;scene=21#wechat_redirect" data-linktype="2">药物预测R包之oncoPredict</a>的用法以及一个超级老旧的R包的用法，见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247507397&amp;idx=1&amp;sn=b275cc5fab6bf9bd4d7df2272cfb8961&amp;scene=21#wechat_redirect" data-linktype="2">药物预测R包之pRRophetic</a></p></blockquote><p data-tool="mdnice编辑器">现在可以尝试一下理解药物预测的原理啦，首先呢在前面的教程 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247507531&amp;idx=1&amp;sn=20ada7f20600549897f07bab9a9c7665&amp;scene=21#wechat_redirect" data-linktype="2">药物预测之相关性为什么不行</a>，我们发现简简单单的表达量相关性居然都可以勉勉强强得到还算是合理的结果啊！现在让我们一起看看差异基因能不能进行药物预测!</p><p data-tool="mdnice编辑器">本次仍然是使用Genomics of Drug Sensitivity in Cancer (<strong>GDSC</strong>) 这个数据库资源里面的Bortezomib这个药物的表达量矩阵和药物信息，参考前面的教程 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247507531&amp;idx=1&amp;sn=20ada7f20600549897f07bab9a9c7665&amp;scene=21#wechat_redirect" data-linktype="2">药物预测之相关性为什么不行</a>，代码是：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br><span>library</span>(pRRophetic)   <br><span>if</span>(!file.exists(<span>'Bortezomib_in_cgp2016.Rdata'</span>)){<br>  <span># pRRophetic的安装方式 见 ；https://mp.weixin.qq.com/s/avETGVE8_5I5CrvljG2Tqg  </span><br>  <span>library</span>(pRRophetic)     <br>  <span># 都是 pRRophetic 包的内置数据集，来源于 公共数据库哦 ！</span><br>  data(cgp2016ExprRma)<br>  dim(cgp2016ExprRma)<br>  data(PANCANCER_IC_Tue_Aug_9_15_28_57_2016)<br>  length(unique(drugData2016$Drug.name))<br>  unique(drugData2016$Drug.name)<br><br>  cgp2016ExprRma[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  drugData2016[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br>  Bort_drugs=drugData2016[drugData2016$Drug.name==<span>'Bortezomib'</span>,]<br>  dim(Bort_drugs)<br>  kp =  Bort_drugs$Cell.line.name %<span>in</span>% colnames(cgp2016ExprRma)<br>  table(kp)<br>  Bort_drugs=Bort_drugs[kp,]<br>  pos=match( Bort_drugs$Cell.line.name ,colnames(cgp2016ExprRma)  )<br>  Bort_ExprRma=cgp2016ExprRma[,pos]<br>  identical(colnames(Bort_ExprRma),Bort_drugs$Cell.line.name)<br>  save(Bort_ExprRma,Bort_drugs,file = <span>'Bortezomib_in_cgp2016.Rdata'</span>)<br>}<br><br>load(file = <span>'Bortezomib_in_cgp2016.Rdata'</span>)<br>identical(colnames(Bort_ExprRma),Bort_drugs$Cell.line.name)<br><br></code></pre><p data-tool="mdnice编辑器">获取如下所示的表达量矩阵和药物信息：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; Bort_ExprRma[1:4,1:4]<br>          MC-CAR      ES3       ES5      ES7<br>TSPAN6  3.238273 8.690198  8.233101 8.333466<br>TNMD    2.982254 3.091473  2.824687 3.966757<br>DPM1   10.235491 9.992487 10.015884 9.793991<br>SCYL3   4.856061 4.572198  4.749715 3.976923<br>&gt; Bort_drugs[1:4,1:4]<br>       Drug.name Drug.Id Cell.line.name Cosmic.sample.Id<br>14878 Bortezomib     104         MC-CAR           683665<br>14879 Bortezomib     104            ES3           684055<br>14880 Bortezomib     104            ES5           684057<br>14881 Bortezomib     104            ES7           684059<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>做多次差异分析<span></span></h3><p data-tool="mdnice编辑器">这个时候 Bortezomib这个药物的 IC50 可以把全部的细胞系进行高低分组 ：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; fivenum(Bort_drugs<span>$IC50</span>)<br>[1] -9.9718999 -6.7907169 -5.9342808 -4.8832931 -0.5923361<br></code></pre><p data-tool="mdnice编辑器">分组有多种策略，比如中位值划分，以及top10%和bottom10%的划分，我们这里把多种组合都做一下差异。参考：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506712&amp;idx=2&amp;sn=33cbb66d8c21a484a9c5e61924078e4d&amp;scene=21#wechat_redirect" data-linktype="2">不同癌症内部按照estimate的两个打分值高低分组看蛋白编码基因表达量差异</a>，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><br>load(file = <span>'Bortezomib_in_cgp2016.Rdata'</span>)<br>identical(colnames(Bort_ExprRma),Bort_drugs$Cell.line.name)<br>Bort_ExprRma[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>Bort_drugs[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>fivenum(Bort_drugs$IC50)<br>od=order(Bort_drugs$IC50,decreasing = <span>T</span>)<br><span>library</span>(limma)<br>deg_by_limma &lt;- <span>function</span>(exprSet, design, contrast.matrix){<br>  <span># step 1线性模型拟合</span><br>  fit   &lt;- lmFit(exprSet, design)<br>  <span># step 2贝叶斯检验</span><br>  fit2  &lt;- contrasts.fit(fit, contrast.matrix)<br>  fit2  &lt;- eBayes(fit2)<br>  <span># step 3</span><br>  allDiffOut &lt;- topTable(fit2, coef = <span>1</span>, n=<span>Inf</span>)<br>  nrDEG &lt;- na.omit(allDiffOut)<br>  <span># write.csv(nrDEG2,"limma_notrend.results.csv",quote = F)</span><br>  <span>return</span>(nrDEG)}<br><br>deg_list &lt;- lapply(<span>1</span>:<span>5</span>, <span>function</span>(i){<br>  <span># i=1</span><br>  res_ExprRma=Bort_ExprRma[,head(od,i*floor(length(od)/<span>10</span>))]<br>  sens_ExprRma=Bort_ExprRma[,tail(od,i*floor(length(od)/<span>10</span>))]<br>  expr=cbind(res_ExprRma,sens_ExprRma)<br>  group_list=c(rep(<span>'res'</span>,ncol(res_ExprRma)),<br>               rep(<span>'sens'</span>,ncol(sens_ExprRma)))<br>  options(digits = <span>4</span>)   <span># 设置全局的数字有效位数为4</span><br>  <span># 指定任意两组进行差异分析</span><br>  design &lt;- model.matrix(~<span>0</span>+factor(group_list))<br>  colnames(design) &lt;- levels(factor(group_list))<br>  rownames(design) &lt;- colnames(expr)<br>  <span># contrast.matrix这个矩阵声明哪个分组去和哪个分组进行差异分析比较</span><br>  contrast.matrix  &lt;- makeContrasts(<span>'sens-res'</span>,<br>                                    levels = design)<br>  allDiff &lt;- deg_by_limma(expr, design, contrast.matrix)<br>  <span>return</span>(allDiff)<br>})<br></code></pre><p data-tool="mdnice编辑器">这样我们就做了五次差异分析， 各种差异分析的上下调基因统计一下，代码如下：</p><pre data-tool="mdnice编辑器"><span></span><code><br>logFC_cut = <span>1</span><br>padj_cut = <span>0.05</span><br>colnames(deg_list[[<span>1</span>]])<br>stat = lapply( deg_list , <span>function</span>(DEG){<br>  DEG_sig = subset(DEG, abs(logFC)&gt; logFC_cut &amp;<br>                     adj.P.Val&lt; padj_cut)<br>  tb=table(DEG_sig$logFC&gt;<span>0</span>)<br>  up_total = as.numeric(tb[<span>"TRUE"</span>])<br>  down_total = as.numeric(tb[<span>"FALSE"</span>])<br>  <span>return</span>(c(up_total, down_total))<br>})<br>stat = as.data.frame(do.call(rbind,stat))<br>colnames(stat) = c(<span>"UP"</span>,<span>"DOWN"</span>)<br>rownames(stat) =  names(deg_list)<br>stat$Type = rownames(stat)<br>stat<br><span># stat_reshaped=reshape2::melt(stat)</span><br><span># head(stat_reshaped)</span><br>stat_up = subset(stat, select = -DOWN)<br>stat_up$group = <span>"UP"</span><br>stat_down = subset(stat, select = -UP)<br>stat_down$label = stat_down$DOWN<br>stat_down$DOWN = -<span>1</span>*stat_down$DOWN<br>stat_down$group = <span>"DOWN"</span><br>p_multi_DEG=ggplot() +<br>  geom_bar(data = stat_up, aes(x=Type, y=UP, fill=group),stat = <span>"identity"</span>,position = <span>'dodge'</span>) +<br>  geom_text(data = stat_up, aes(x=Type,  y=UP, label=UP, vjust=-<span>0.25</span>)) +<br>  geom_bar(data = stat_down, aes(x=Type, y=DOWN, fill=group),stat = <span>"identity"</span>,position = <span>'dodge'</span>)+<br>  geom_text(data = stat_down, aes(x=Type,  y=DOWN, label=label, vjust= <span>1.25</span>)) +<br>  scale_fill_manual(values=c(<span>"#0072B5"</span>,<span>"#BC3C28"</span>)) +<br>  theme(axis.text.x = element_text(angle = <span>45</span>, vjust = <span>0.8</span>, hjust=<span>0.8</span>, size = <span>12</span>)) +<br>  xlab(label = <span>""</span>) + ylab(label = <span>"DEG numbers"</span>) +<br>  ggtitle(<span>"logFC cut-off : 1\nPadj cut-off : 0.05"</span>)<br>p_multi_DEG<br></code></pre><p data-tool="mdnice编辑器">结果如下所示：</p><p><img data-galleryid="" data-ratio="0.648876404494382" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxXQmyDJTibZfr6FpcOibB0WIPwuF5aTRGI36suzQGVCYKZQX6FMFkSs9Pu4nHcE4v9bfFveSRWWh7A/640?wx_fmt=png" data-type="png" data-w="1424" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxXQmyDJTibZfr6FpcOibB0WIPwuF5aTRGI36suzQGVCYKZQX6FMFkSs9Pu4nHcE4v9bfFveSRWWh7A/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">可以看到，按照中位值把全部的样品划分为高低两个分组然后差异基因有统计学显著的数量就很少，目前看来，top30%的和bottom 30%的样品分组，得到的差异基因数量是最多的。</p><p data-tool="mdnice编辑器">不过也并不是说，差异基因数量越多越好啦。这里仅仅是展现一个分析方法而已。</p><h3 data-tool="mdnice编辑器"><span></span>使用ssgsea方法来根据前面的上下调基因进行预测<span></span></h3><p data-tool="mdnice编辑器">首先获取需要预测的表达量矩阵；</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(GSVA)<br><span>library</span>(limma)<br><span>library</span>(GSEABase)<br><span>library</span>(data.table)<br>data(bortezomibData)<br>dim(exprDataBortezomib)<br>exprDataBortezomib[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>boxplot(exprDataBortezomib[,<span>1</span>:<span>4</span>])<br><span># 264个样品的表达量矩阵</span><br>table(studyResponse)<br></code></pre><p data-tool="mdnice编辑器">然后把前面的上下调基因做出基因集格式：</p><pre data-tool="mdnice编辑器"><span></span><code><br>colnames(deg_list[[<span>1</span>]])<br>upG = lapply( deg_list , <span>function</span>(DEG){<br>  <span>#DEG=deg_list[[1]]</span><br>  DEG_sig = subset(DEG, abs(logFC)&gt; logFC_cut &amp;<br>                     adj.P.Val&lt; padj_cut)<br>  <span>return</span>(rownames(DEG_sig[DEG_sig$logFC&gt;<span>0</span>,]))<br>})<br>names(upG)=paste0(<span>'upG_top_per_'</span>,<span>1</span>:<span>5</span>)<br>downG = lapply( deg_list , <span>function</span>(DEG){<br>  <span>#DEG=deg_list[[1]]</span><br>  DEG_sig = subset(DEG, abs(logFC)&gt; logFC_cut &amp;<br>                     adj.P.Val&lt; padj_cut)<br>  <span>return</span>(rownames(DEG_sig[DEG_sig$logFC &lt; <span>0</span>,]))<br>})<br>names(downG)=paste0(<span>'downG_top_per_'</span>,<span>1</span>:<span>5</span>)<br>cg=c(upG,downG)<br>cg<br>as.matrix(exprDataBortezomib)[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br>geneSet &lt;- GeneSetCollection(mapply(<span>function</span>(geneIds, keggId) {<br>  GeneSet(geneIds, geneIdType=EntrezIdentifier(),<br>          collectionType=KEGGCollection(keggId),<br>          setName=keggId)<br>}, cg, names(cg)))<br>geneSet<br></code></pre><p data-tool="mdnice编辑器">然后运行ssgsea即可：</p><pre data-tool="mdnice编辑器"><span></span><code>ssgseaScore=gsva(as.matrix(exprDataBortezomib), geneSet,<br>                 method=<span>'ssgsea'</span>, kcdf=<span>'Gaussian'</span>,<br>                 abs.ranking=<span>TRUE</span>)<br>ssgseaScore=as.data.frame(t(ssgseaScore))<br>head(ssgseaScore)<br><span>library</span>(pheatmap)<br>pheatmap(ssgseaScore)<br></code></pre><p data-tool="mdnice编辑器">可以看到上调基因集在几乎全部的样品里面都是正向富集，而下调基因集在几乎全部的样品里面都是负向富集 ：</p><p><img data-galleryid="" data-ratio="0.6750348675034867" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxXQmyDJTibZfr6FpcOibB0WI2Cf5j8kKKCgpwGjFiaeCYibQXQk97De639XYicpibOrkhF4q3sV26R6Z0A/640?wx_fmt=png" data-type="png" data-w="1434" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxXQmyDJTibZfr6FpcOibB0WI2Cf5j8kKKCgpwGjFiaeCYibQXQk97De639XYicpibOrkhF4q3sV26R6Z0A/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>上下调基因的得分</figcaption></figure><p data-tool="mdnice编辑器">理论上 ssgsea 算法应该是无需考虑不同表达量矩阵批次效应的， 前面的数据库训练得到的药物敏感组相当于药物耐受组的上调基因，居然在我们的待预测表达量矩阵里面全部是正向富集，意味着我们的待预测样品基本上全部的药物敏感！</p><p data-tool="mdnice编辑器">这个与实际情况不符合，待预测表达量矩阵本来就有药物信息，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; table(studyResponse)<br>studyResponse<br>PGx_Responder = IE PGx_Responder = NR  PGx_Responder = R<br>                25                126                113<br></code></pre><p data-tool="mdnice编辑器">我们任意选择一个差异基因列表的ssgsea的打分划分高低分组，看看是否跟待预测表达量矩阵本来就有的药物信息匹配：</p><pre data-tool="mdnice编辑器"><span></span><code>studyResponse        FALSE TRUE<br>  PGx_Responder = IE    13   12<br>  PGx_Responder = NR    67   59<br>  PGx_Responder = R     52   61<br></code></pre><p data-tool="mdnice编辑器">可以看到，完全没有任何预测价值，ssgsea的打分高低与否跟PGx_Responder不匹配。</p><p data-tool="mdnice编辑器">对全部的10个基因集进行预测，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>t(<br>  apply(ssgseaScore, <span>2</span>, <span>function</span>(x){<br>    <span># x=ssgseaScore[,1]</span><br>    table(studyResponse,x&gt;median(x) )<br>  })<br>)<br><br></code></pre><p data-tool="mdnice编辑器">结果如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>                [,1] [,2] [,3] [,4] [,5] [,6]<br>upG_top_per_1     13   67   52   12   59   61<br>upG_top_per_2     16   67   49    9   59   64<br>upG_top_per_3     15   65   52   10   61   61<br>upG_top_per_4     11   63   58   14   63   55<br>upG_top_per_5     11   63   58   14   63   55<br>downG_top_per_1   12   69   51   13   57   62<br>downG_top_per_2   17   64   51    8   62   62<br>downG_top_per_3   16   65   51    9   61   62<br>downG_top_per_4   16   65   51    9   61   62<br>downG_top_per_5   15   66   51   10   60   62<br></code></pre><p data-tool="mdnice编辑器">可以看到，全部的10个基因集都完全没有任何预测价值，ssgsea的打分高低与否跟PGx_Responder不匹配。</p><h3 data-tool="mdnice编辑器"><span></span>结果很有意思<span></span></h3><p data-tool="mdnice编辑器">无论我们使用什么样的阈值分组来对Bortezomib这个药物划分敏感和耐受，进行表达量差异分析，得到了统计学显著的上下调基因列表，去看我们待预测的样品里面是否倾向于包含这样的基因列表，都没有预测价值！那我们根据药物敏感程度分组后的差异基因一般来说会作为该药物的特征基因集，如果它没有太大的意义，前面几万篇文章都错了吗？</p><p data-tool="mdnice编辑器">同样的我们在一个随机群体里面 预测一个人的财富情况，选取穷人和富人进行差异分析，发现富人绝大部分都是北京人，从政，年龄大的，而穷人都是东北的，无业的，20岁。有了这样的背景知识，接下来我们开始随机预测一个人，发现它是30岁附近，无业，也是东北人，但是它并不穷啊，因为它姓王，王八的王。</p><p data-tool="mdnice编辑器">那么，我们到底该如何去根据表达量信息预测其药物敏感程度呢？<strong>这个问题，跟如何根据身高体重籍贯工作等属性预测一个人的财富情况类似</strong>，都很难啊！</p></section><h3 data-tool="mdnice编辑器">文末友情推荐</h3><p><span>做教学我们是认真的，如果你对我们的<strong>马拉松授课（直播一个月互动教学）</strong>有疑问，可以看完我们从2000多个提问互动交流里面精选的200个问答！ <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247505193&amp;idx=1&amp;sn=bd55341f6409948188a0515f1552e2e3&amp;chksm=9b4b9592ac3c1c848b7f8965270cf9234945e0031e11ca3f559afc17247ca6098f57670cf192&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" wah-hotarea="click">2021第二期_生信入门班_微信群答疑整理</a>，以及 <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247505071&amp;idx=2&amp;sn=29727136d3907dd3b315232cbbb8d72d&amp;chksm=9b4b9414ac3c1d02c2ccd9639e01411d17347aa56c4e0eb3f254a8b159a50bde9aa7e20d2d2a&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" wah-hotarea="click">2021第二期_数据挖掘班_微信群答疑笔记</a></span></p><p data-tool="mdnice编辑器"><span>与十万人一起学生信，你值得拥有下面的学习班：</span></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247507009&amp;idx=2&amp;sn=f1c813866b3314a10463c317f62c3426&amp;chksm=9b4b9cfaac3c15ecc1325c17283d933650f27e4b2f84a1a423d64973dc7821eac58c1d46e838&amp;scene=21#wechat_redirect" textvalue="生信入门课-2021第8期" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">生信入门课-2021第8期</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247507009&amp;idx=1&amp;sn=c1c9efd3ed6663df6e710bf7a5a249c6&amp;chksm=9b4b9cfaac3c15ec63b5a2c9e6f5a7c328f0575c1e04b245ce6ab6d594320fa33a824e5f7d6d&amp;scene=21#wechat_redirect" textvalue="数据挖掘（GEO,TCGA,单细胞）2021第8期" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">数据挖掘（GEO,TCGA,单细胞）2021第8期</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247498002&amp;idx=1&amp;sn=c55c54c256cb99593af99d4325803e28&amp;chksm=ea1cff90dd6b76865a18d50a4aaea4b3b584b36c80b42423a9399d79d8acdaeb06d908a05172&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">单细胞数据分析（一折起）</a></p></li></ul><p><br></p><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/wqva1EJH1zKoCw57VFMpMA",target="_blank" rel="noopener noreferrer">原文链接</a>
