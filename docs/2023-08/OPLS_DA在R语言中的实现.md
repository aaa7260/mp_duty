---
title: "OPLS-DA在R语言中的实现"
date: 2023-08-27T08:56:51Z
draft: ["false"]
tags: [
  "fetched",
  "PLANTOMIX"
]
categories: ["Acdemic"]
---
OPLS-DA在R语言中的实现 by PLANTOMIX
------
<div><section data-role="outer" label="Powered by 135editor.com"><p><br></p><section data-tools="135编辑器" data-id="94863"><section><section><img data-ratio="0.7050359712230215" data-src="https://mmbiz.qpic.cn/mmbiz_gif/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPSLGyl7MnrgooDjFYqkCrHgDaibXOPDYDwAmCRicckLDmKKxic05N8t3Ng/640?wx_fmt=gif" data-type="gif" data-w="139" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPSLGyl7MnrgooDjFYqkCrHgDaibXOPDYDwAmCRicckLDmKKxic05N8t3Ng/640?wx_fmt=gif"></section><section><section data-brushtype="text" hm_fix="327:682"><span>点击上方<span>👆</span></span><span>蓝</span><span>字，关注我们<img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblP7P9UFVQpmBcc4JLQVAQicyLOElWoF1GqV98LiaXChO7eIc0E2o2UbFHg/640?wx_fmt=png" data-type="png" data-w="20" src="https://mmbiz.qpic.cn/mmbiz_png/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblP7P9UFVQpmBcc4JLQVAQicyLOElWoF1GqV98LiaXChO7eIc0E2o2UbFHg/640?wx_fmt=png"></span></section></section></section></section><section data-role="paragraph"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p><img data-ratio="0.3511450381679389" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/GTgKK7iaBvZOkqA2RriagSPMtafRVXBBPwc1UKURvIAKnA5LLxiboXFpRMUAJwHW56xZn57tVAic4ve0ksdIcT3kVA/640?wx_fmt=png" data-type="png" data-w="1441" src="https://mmbiz.qpic.cn/mmbiz_png/GTgKK7iaBvZOkqA2RriagSPMtafRVXBBPwc1UKURvIAKnA5LLxiboXFpRMUAJwHW56xZn57tVAic4ve0ksdIcT3kVA/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">【<span>PS：</span><span>后面要分析代谢组数据，先</span><span>看看</span><span>代谢组中常用的PLS分析</span><span>。</span><span></span>】</p><hr><p data-tool="mdnice编辑器">主成分分析（Principal Component Analysis，PCA）是一种无监督的降维方法，能够有效对高维数据进行处理。但 PCA 对相关性较小的变量不敏感，而 PLS-DA（Partial Least Squares-Discriminant Analysis，偏最小二乘判别分析）能够有效解决这个问题。而 OPLS-DA（正交偏最小二乘判别分析）结合了正交信号和 PLS-DA 来筛选差异变量。<br></p><p><img data-ratio="0.3698630136986301" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPy4lgG8Er08CuFlwgfcp003zBS5jZFVJkj7SRgibY88SO1Jjc7O5MDzw/640?wx_fmt=png" data-type="png" data-w="949" src="https://mmbiz.qpic.cn/mmbiz_png/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPy4lgG8Er08CuFlwgfcp003zBS5jZFVJkj7SRgibY88SO1Jjc7O5MDzw/640?wx_fmt=png"></p><p data-tool="mdnice编辑器"><span>图片来自：https://www.r-bloggers.com/2013/07/orthogonal-partial-least-squares-opls-in-r/</span></p><section data-tools="135编辑器" data-id="97518"><section><section><section><section><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png" data-type="png" data-w="35" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png"></section></section><section><img data-ratio="0.06666666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png" data-type="png" data-w="75" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png"></section><section><section><section data-width="70%"><br></section><section data-brushtype="text" hm_fix="330:840">安装和加载包</section></section></section></section></section></section><pre data-tool="mdnice编辑器"><span></span><code><span># install ropls</span><br><span>if</span> (<span>F</span>) {<br>  <span>if</span> (!requireNamespace(<span>"BiocManager"</span>, quietly = <span>TRUE</span>))<br>    install.packages(<span>"BiocManager"</span>)<br>  <br>  BiocManager::install(<span>"ropls"</span>)<br>}<br><br><span># load  packages</span><br><span>library</span>(ropls)<br><span>library</span>(ggplot2)<br><span>library</span>(ggsci)<br><span>library</span>(Cairo)<br><span>library</span>(tidyverse)<br><span>library</span>(extrafont)<br>loadfonts()<br></code></pre><section data-tools="135编辑器" data-id="97518"><section><section><section><section><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png" data-type="png" data-w="35" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png"></section></section><section><img data-ratio="0.06666666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png" data-type="png" data-w="75" data-width="100%" title="" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png"></section><section><section><section data-width="70%"><br></section><section data-brushtype="text" hm_fix="272:833">示例数据</section></section></section></section></section></section><pre data-tool="mdnice编辑器"><span></span><code><span># load data</span><br>data(sacurine)<br>names(sacurine)<br><br><span># view data information</span><br><span>attach</span>(sacurine)<br>strF(dataMatrix)<br>strF(sampleMetadata)<br>strF(variableMetadata)<br></code></pre><p data-tool="mdnice编辑器">这个数据集是不同年龄、性别和 BMI 的 183 个人的尿液中 109 种代谢物的浓度差异<span><span role="presentation" data-formula="^{[1]}" data-formula-type="inline-equation"><svg xmlns="http://www.w3.org/2000/svg" role="img" focusable="false" viewbox="0 -893.3 796.7 893.3" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="TeXAtom" transform="translate(0, 363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(278, 0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(778, 0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></g></g></svg></span></span>。下面的分析主要以性别为分组变量来研究不同性别人群尿液中代谢物的差异。下面的分析主要包含 PCA、PLS-DA 和 OPLS-DA。</p><section data-tools="135编辑器" data-id="97518"><section><section><section><section><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png" data-type="png" data-w="35" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png"></section></section><section><img data-ratio="0.06666666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png" data-type="png" data-w="75" data-width="100%" title="" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png"></section><section><section><section data-width="70%"><br></section><section data-brushtype="text" hm_fix="317:822">PCA 分析</section></section></section></section></section></section><pre data-tool="mdnice编辑器"><span></span><code><span># PCA analysis</span><br>pca = opls(dataMatrix)<br>genderFc = sampleMetadata[, <span>"gender"</span>]<br><br>pdf(file = <span>'figures/PCA.pdf'</span>, width = <span>5</span>, height = <span>5</span>)<br>plot(pca, typeVc = <span>"x-score"</span>,<br>     parAsColFcVn = genderFc, parEllipsesL = <span>TRUE</span>)<br>dev.off()<br></code></pre><p><img data-ratio="0.9674267100977199" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPqDyk7FuicTuEI10sbZB9H7u5xxCQe19LYb45rmMqFqaa3G2XFIz3K8w/640?wx_fmt=jpeg" data-type="jpeg" data-w="921" src="https://mmbiz.qpic.cn/mmbiz_jpg/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPqDyk7FuicTuEI10sbZB9H7u5xxCQe19LYb45rmMqFqaa3G2XFIz3K8w/640?wx_fmt=jpeg"></p><p data-tool="mdnice编辑器">可以看到的是如果用 PCA 的话，不同性别的人群是混在一起的。</p><section data-tools="135编辑器" data-id="97518"><section><section><section><section><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png" data-type="png" data-w="35" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png"></section></section><section><img data-ratio="0.06666666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png" data-type="png" data-w="75" data-width="100%" title="" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png"></section><section><section><section data-width="70%"><br></section><section data-brushtype="text" hm_fix="305:835">PLS-DA</section></section></section></section></section></section><pre data-tool="mdnice编辑器"><span></span><code><span># PLSDA analysis</span><br>plsda = opls(dataMatrix,genderFc)<br><br><span># sample scores plot</span><br>sample.score = plsda@scoreMN %&gt;% <br>  as.data.frame() %&gt;%<br>  mutate(gender = sacurine[[<span>"sampleMetadata"</span>]][[<span>"gender"</span>]])<br>  <br>p1 = ggplot(sample.score, aes(p1, p2, color = gender)) +<br>  geom_hline(yintercept = <span>0</span>, linetype = <span>'dashed'</span>, size = <span>0.5</span>) +<br>  geom_vline(xintercept = <span>0</span>, linetype = <span>'dashed'</span>, size = <span>0.5</span>) +<br>  geom_point() +<br>  geom_point(aes(-<span>10</span>,-<span>10</span>), color = <span>'white'</span>) +<br>  labs(x = <span>'P1(10.0%)'</span>,y = <span>'P2(9%)'</span>) +<br>  stat_ellipse(level = <span>0.95</span>, linetype = <span>'solid'</span>, <br>               size = <span>1</span>, show.legend = <span>FALSE</span>) +<br>  scale_color_manual(values = c(<span>'#008000'</span>,<span>'#FFA74F'</span>)) +<br>  theme_bw() +<br>  theme(legend.position = c(<span>0.9</span>,<span>0.8</span>),<br>    legend.text = element_text(color = <span>'black'</span>,size = <span>12</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>    panel.background = element_blank(),<br>    panel.grid = element_blank(),<br>    axis.text = element_text(color = <span>'black'</span>,size = <span>15</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>    axis.title = element_text(color = <span>'black'</span>,size = <span>15</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>    axis.ticks = element_line(color = <span>'black'</span>))<br>ggsave(p1, filename = <span>'figures/pls.pdf'</span>, <br>       width = <span>5</span>, height = <span>5</span>, device = cairo_pdf)<br></code></pre><p><img data-ratio="0.9901423877327492" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPFeMDHMCGV4XwxnQGT8BtDGPumQnIevDzwp2IGAkXzIUE0nO0gaq6Ug/640?wx_fmt=jpeg" data-type="jpeg" data-w="913" src="https://mmbiz.qpic.cn/mmbiz_jpg/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPFeMDHMCGV4XwxnQGT8BtDGPumQnIevDzwp2IGAkXzIUE0nO0gaq6Ug/640?wx_fmt=jpeg"></p><p data-tool="mdnice编辑器">和 PCA 相比，PLS-DA 的效果相对较好。PLS-DA 分析的目的是找到差异变量（本例中是 109 种代谢物的某几种）。因此，需要找到 VIP 值大于等于 1 的变量（代谢物）：</p><pre data-tool="mdnice编辑器"><span></span><code><span># VIP scores plot</span><br>vip.score = as.data.frame(plsda@vipVn)<br>colnames(vip.score) = <span>'vip'</span><br>vip.score$metabolites = rownames(vip.score)<br>vip.score = vip.score[order(-vip.score$vip),]<br>vip.score$metabolites = factor(vip.score$metabolites,<br>                               levels = vip.score$metabolites)<br><br>loading.score = plsda@loadingMN %&gt;% as.data.frame()<br>loading.score$metabolites = rownames(loading.score)<br><br>all.score = merge(vip.score, loading.score, by = <span>'metabolites'</span>)<br><br>all.score$cat = paste(<span>'A'</span>,<span>1</span>:nrow(all.score), sep = <span>''</span>)<br><br>p2 = ggplot(all.score[all.score$vip &gt;= <span>1</span>,], aes(cat, vip)) +<br>  geom_segment(aes(x = cat, xend = cat,<br>                   y = <span>0</span>, yend = vip)) +<br>  geom_point(shape = <span>21</span>, size = <span>5</span>, color = <span>'#008000'</span> ,fill = <span>'#008000'</span>) +<br>  geom_point(aes(<span>1</span>,<span>2.5</span>), color = <span>'white'</span>) +<br>  geom_hline(yintercept = <span>1</span>, linetype = <span>'dashed'</span>) +<br>  scale_y_continuous(expand = c(<span>0</span>,<span>0</span>)) +<br>  labs(x = <span>''</span>, y = <span>'VIP value'</span>) +<br>  theme_bw() +<br>  theme(legend.position = <span>'none'</span>,<br>        legend.text = element_text(color = <span>'black'</span>,size = <span>12</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>        panel.background = element_blank(),<br>        panel.grid = element_blank(),<br>        axis.text = element_text(color = <span>'black'</span>,size = <span>15</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>        axis.text.x = element_text(angle = <span>90</span>),<br>        axis.title = element_text(color = <span>'black'</span>,size = <span>15</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>        axis.ticks = element_line(color = <span>'black'</span>),<br>        axis.ticks.x = element_blank())<br>ggsave(p2, filename = <span>'figures/pls_VIP.pdf'</span>, <br>       width = <span>8</span>, height = <span>5</span>, device = cairo_pdf)<br></code></pre><p data-tool="mdnice编辑器">下面这些物质就是差异代谢物（VIP 值大于等于 1）：</p><pre data-tool="mdnice编辑器"><span></span><code> [<span>1</span>] (gamma)Glu-Leu/Ile                                                                  <br> [<span>2</span>] <span>2</span>-acetamido-<span>4</span>-methylphenyl acetate                                                  <br> [<span>3</span>] <span>2</span>-Methylhippuric acid                                                               <br> [<span>4</span>] <span>3</span>-Methylcrotonylglycine                                                             <br> [<span>5</span>] <span>3</span>,<span>4</span>-Dihydroxybenzeneacetic acid                                                     <br> [<span>6</span>] <span>3</span>,<span>5</span>-dihydroxybenzoic acid/<span>3</span>,<span>4</span>-dihydroxybenzoic acid                                 <br> [<span>7</span>] <span>4</span>-Acetamidobutanoic acid isomer <span>3</span>                                                   <br> [<span>8</span>] <span>6</span>-(carboxymethoxy)-hexanoic acid                                                    <br> [<span>9</span>] Acetaminophen glucuronide                                                           <br>[<span>10</span>] Acetylphenylalanine                                                                 <br>[<span>11</span>] alpha-N-Phenylacetyl-glutamine                                                      <br>[<span>12</span>] Asp-Leu/Ile isomer <span>1</span>                                                                <br>[<span>13</span>] Citric acid                                                                         <br>[<span>14</span>] Dehydroepiandrosterone <span>3</span>-glucuronide                                                <br>[<span>15</span>] Dehydroepiandrosterone sulfate                                                      <br>[<span>16</span>] Gluconic acid and/or isomers                                                        <br>[<span>17</span>] Glucuronic acid and/or isomers                                                      <br>[<span>18</span>] Glyceric acid                                                                       <br>[<span>19</span>] Hippuric acid                                                                       <br>[<span>20</span>] Hydroxybenzyl alcohol isomer                                                        <br>[<span>21</span>] Malic acid                                                                          <br>[<span>22</span>] Methyl (hydroxymethyl)pyrrolidine-carboxylate/Methyl (hydroxy)piperidine-carboxylate<br>[<span>23</span>] Monoethyl phthalate                                                                 <br>[<span>24</span>] N-Acetyl-aspartic acid                                                              <br>[<span>25</span>] Oxoglutaric acid                                                                    <br>[<span>26</span>] p-Anisic acid                                                                       <br>[<span>27</span>] p-Hydroxyhippuric acid                                                              <br>[<span>28</span>] Pantothenic acid                                                                    <br>[<span>29</span>] Pentose                                                                             <br>[<span>30</span>] Phe-Tyr-Asp (and isomers)                                                           <br>[<span>31</span>] Pyruvic acid                                                                        <br>[<span>32</span>] Testosterone glucuronide                                                            <br>[<span>33</span>] Threonic acid/Erythronic acid                                                       <br>[<span>34</span>] Valerylglycine isomer <span>1</span>                                                             <br>[<span>35</span>] Valerylglycine isomer <span>2</span>                                                              <br></code></pre><p data-tool="mdnice编辑器">将它们的 VIP 值得进行可视化（某些代谢物名称太长，进行转换表示）：</p><p><img data-ratio="0.6140625" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPUBZ6lQ3l2JHtcbgIFR9NTuibwhT3hz3kicNUhoRWTC1yzhJ7zicciapHpA/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_jpg/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPUBZ6lQ3l2JHtcbgIFR9NTuibwhT3hz3kicNUhoRWTC1yzhJ7zicciapHpA/640?wx_fmt=jpeg"></p><section data-tools="135编辑器" data-id="97518"><section><section><section><section><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png" data-type="png" data-w="35" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png"></section></section><section><img data-ratio="0.06666666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png" data-type="png" data-w="75" data-width="100%" title="" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png"></section><section><section><section data-width="70%"><br></section><section data-brushtype="text" hm_fix="300:821">OPLS-DA 分析</section></section></section></section></section></section><pre data-tool="mdnice编辑器"><span></span><code><span># OPLS-DA analysis</span><br>oplsda = opls(dataMatrix, genderFc, predI = <span>1</span>, orthoI = <span>NA</span>)<br><br><span># sample scores plot</span><br>sample.score = oplsda@scoreMN %&gt;% <br>  as.data.frame() %&gt;%<br>  mutate(gender = sacurine[[<span>"sampleMetadata"</span>]][[<span>"gender"</span>]],<br>         o1 = oplsda@orthoScoreMN[,<span>1</span>])<br><br>p3 = ggplot(sample.score, aes(p1, o1, color = gender)) +<br>  geom_hline(yintercept = <span>0</span>, linetype = <span>'dashed'</span>, size = <span>0.5</span>) +<br>  geom_vline(xintercept = <span>0</span>, linetype = <span>'dashed'</span>, size = <span>0.5</span>) +<br>  geom_point() +<br>  <span>#geom_point(aes(-10,-10), color = 'white') +</span><br>  labs(x = <span>'P1(5.0%)'</span>,y = <span>'to1'</span>) +<br>  stat_ellipse(level = <span>0.95</span>, linetype = <span>'solid'</span>, <br>               size = <span>1</span>, show.legend = <span>FALSE</span>) +<br>  scale_color_manual(values = c(<span>'#008000'</span>,<span>'#FFA74F'</span>)) +<br>  theme_bw() +<br>  theme(legend.position = c(<span>0.1</span>,<span>0.85</span>),<br>        legend.title = element_blank(),<br>        legend.text = element_text(color = <span>'black'</span>,size = <span>12</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>        panel.background = element_blank(),<br>        panel.grid = element_blank(),<br>        axis.text = element_text(color = <span>'black'</span>,size = <span>15</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>        axis.title = element_text(color = <span>'black'</span>,size = <span>15</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>        axis.ticks = element_line(color = <span>'black'</span>))<br>ggsave(p3, filename = <span>'figures/opls.pdf'</span>, <br>       width = <span>5</span>, height = <span>5</span>, device = cairo_pdf)<br></code></pre><p><img data-ratio="1.0032751091703056" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPRsNj8IvVHVNj5bx4B0r5FickFD7o9p2HdEpPnUYiaSzdQjHyBl8m5vPA/640?wx_fmt=jpeg" data-type="jpeg" data-w="916" src="https://mmbiz.qpic.cn/mmbiz_jpg/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPRsNj8IvVHVNj5bx4B0r5FickFD7o9p2HdEpPnUYiaSzdQjHyBl8m5vPA/640?wx_fmt=jpeg"></p><p data-tool="mdnice编辑器">可以看到的是 OPLS-DA 的效果比 PLS-DA 更好一些。</p><p data-tool="mdnice编辑器">同样进行差异代谢物筛选：</p><pre data-tool="mdnice编辑器"><span></span><code><span># VIP scores plot</span><br>vip.score = as.data.frame(oplsda@vipVn)<br>colnames(vip.score) = <span>'vip'</span><br>vip.score$metabolites = rownames(vip.score)<br>vip.score = vip.score[order(-vip.score$vip),]<br>vip.score$metabolites = factor(vip.score$metabolites,<br>                               levels = vip.score$metabolites)<br><br>loading.score = oplsda@loadingMN %&gt;% as.data.frame()<br>loading.score$metabolites = rownames(loading.score)<br><br>all.score = merge(vip.score, loading.score, by = <span>'metabolites'</span>)<br><br>all.score$cat = paste(<span>'A'</span>,<span>1</span>:nrow(all.score), sep = <span>''</span>)<br><br>p4 = ggplot(all.score[all.score$vip &gt;= <span>1</span>,], aes(cat, vip)) +<br>  geom_segment(aes(x = cat, xend = cat,<br>                   y = <span>0</span>, yend = vip)) +<br>  geom_point(shape = <span>21</span>, size = <span>5</span>, color = <span>'#008000'</span> ,fill = <span>'#008000'</span>) +<br>  geom_point(aes(<span>1</span>,<span>2.5</span>), color = <span>'white'</span>) +<br>  geom_hline(yintercept = <span>1</span>, linetype = <span>'dashed'</span>) +<br>  scale_y_continuous(expand = c(<span>0</span>,<span>0</span>)) +<br>  labs(x = <span>''</span>, y = <span>'VIP value'</span>) +<br>  theme_bw() +<br>  theme(legend.position = <span>'none'</span>,<br>        legend.text = element_text(color = <span>'black'</span>,size = <span>12</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>        panel.background = element_blank(),<br>        panel.grid = element_blank(),<br>        axis.text = element_text(color = <span>'black'</span>,size = <span>15</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>        axis.text.x = element_text(angle = <span>90</span>),<br>        axis.title = element_text(color = <span>'black'</span>,size = <span>15</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>        axis.ticks = element_line(color = <span>'black'</span>),<br>        axis.ticks.x = element_blank())<br>p4<br>ggsave(p4, filename = <span>'figures/opls_VIP.pdf'</span>, <br>       width = <span>8</span>, height = <span>5</span>, device = cairo_pdf)<br></code></pre><p data-tool="mdnice编辑器">下面的是差异代谢物：</p><pre data-tool="mdnice编辑器"><span></span><code> [<span>1</span>] (gamma)Glu-Leu/Ile                                                                  <br> [<span>2</span>] <span>2</span>-acetamido-<span>4</span>-methylphenyl acetate                                                  <br> [<span>3</span>] <span>2</span>-Methylhippuric acid                                                               <br> [<span>4</span>] <span>3</span>-Methylcrotonylglycine                                                             <br> [<span>5</span>] <span>3</span>,<span>4</span>-Dihydroxybenzeneacetic acid                                                     <br> [<span>6</span>] <span>3</span>,<span>5</span>-dihydroxybenzoic acid/<span>3</span>,<span>4</span>-dihydroxybenzoic acid                                 <br> [<span>7</span>] <span>4</span>-Acetamidobutanoic acid isomer <span>3</span>                                                   <br> [<span>8</span>] <span>6</span>-(carboxymethoxy)-hexanoic acid                                                    <br> [<span>9</span>] Acetaminophen glucuronide                                                           <br>[<span>10</span>] Acetylphenylalanine                                                                 <br>[<span>11</span>] alpha-N-Phenylacetyl-glutamine                                                      <br>[<span>12</span>] Asp-Leu/Ile isomer <span>1</span>                                                                <br>[<span>13</span>] Citric acid                                                                         <br>[<span>14</span>] Dehydroepiandrosterone <span>3</span>-glucuronide                                                <br>[<span>15</span>] Dehydroepiandrosterone sulfate                                                      <br>[<span>16</span>] Gluconic acid and/or isomers                                                        <br>[<span>17</span>] Glucuronic acid and/or isomers                                                      <br>[<span>18</span>] Glyceric acid                                                                       <br>[<span>19</span>] Hippuric acid                                                                       <br>[<span>20</span>] Hydroxybenzyl alcohol isomer                                                        <br>[<span>21</span>] Malic acid                                                                          <br>[<span>22</span>] Methyl (hydroxymethyl)pyrrolidine-carboxylate/Methyl (hydroxy)piperidine-carboxylate<br>[<span>23</span>] Monoethyl phthalate                                                                 <br>[<span>24</span>] N-Acetyl-aspartic acid                                                              <br>[<span>25</span>] Oxoglutaric acid                                                                    <br>[<span>26</span>] p-Anisic acid                                                                       <br>[<span>27</span>] p-Hydroxyhippuric acid                                                              <br>[<span>28</span>] Pantothenic acid                                                                    <br>[<span>29</span>] Pentose                                                                             <br>[<span>30</span>] Phe-Tyr-Asp (and isomers)                                                           <br>[<span>31</span>] Pyruvic acid                                                                        <br>[<span>32</span>] Testosterone glucuronide                                                            <br>[<span>33</span>] Threonic acid/Erythronic acid                                                       <br>[<span>34</span>] Valerylglycine isomer <span>1</span>                                                             <br>[<span>35</span>] Valerylglycine isomer <span>2</span>                                                             <br></code></pre><p><img data-ratio="0.60703125" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPxGNtvsmgTicWNUVXDWPrxiaql43ESboN48lOgm4Th6sGwfcmSFuPns4Q/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_jpg/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblPxGNtvsmgTicWNUVXDWPrxiaql43ESboN48lOgm4Th6sGwfcmSFuPns4Q/640?wx_fmt=jpeg"></p><section data-tools="135编辑器" data-id="97518"><section><section><section><section><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png" data-type="png" data-w="35" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png"></section></section><section><img data-ratio="0.06666666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png" data-type="png" data-w="75" data-width="100%" title="" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png"></section><section><section><section data-width="70%"><br></section><section data-brushtype="text" hm_fix="309:821">模型训练与预测</section></section></section></section></section></section><p data-tool="mdnice编辑器">这些降维的方法都属于机器学习算法，那就可以对模型进行训练，并用这个模型去预测未知的数据。</p><p data-tool="mdnice编辑器">模型训练很简单：</p><pre data-tool="mdnice编辑器"><span></span><code><span># model training</span><br>oplsda.2 = opls(dataMatrix, genderFc, predI = <span>1</span>, orthoI = <span>NA</span>,subset = <span>"odd"</span>) <br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>OPLS-DA<br><span>92</span> samples x <span>109</span> variables and <span>1</span> response<br>standard scaling of predictors and response(s)<br>      R2X(cum) R2Y(cum) Q2(cum)<br>Total     <span>0.26</span>    <span>0.825</span>   <span>0.608</span><br>      RMSEE RMSEP pre ort<br>Total <span>0.213</span> <span>0.341</span>   <span>1</span>   <span>2</span><br>Warning message:<br><span>'permI'</span> set to <span>0</span> because train/test partition is selected.<br></code></pre><p data-tool="mdnice编辑器">可以看到使用了 92 个样本进行训练。</p><p data-tool="mdnice编辑器">先看看模型在训练集上的准确率：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 模型在训练集上的准确率</span><br>trainVi = getSubsetVi(oplsda.2)<br>tab = table(genderFc[trainVi], fitted(oplsda.2))<br>print(paste(<span>'模型准确率：'</span>,round(sum(diag(tab))/sum(tab)*<span>100</span>, <span>2</span>),<span>'%'</span>, sep = <span>''</span>))<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>   M  <span>F</span><br>  M <span>50</span>  <span>0</span><br>  <span>F</span>  <span>0</span> <span>42</span><br>[<span>1</span>] <span>"模型准确率：100%"</span><br></code></pre><p data-tool="mdnice编辑器">看模型在训练集上的准确率是没有什么意义的，要是在训练集的表现都不好，那模型一定不好。那看看模型在未知数据上的预测准确率吧：</p><pre data-tool="mdnice编辑器"><span></span><code><span># model on test data</span><br>tab2 = table(genderFc[-trainVi],predict(oplsda.2, dataMatrix[-trainVi, ]))<br>print(paste(<span>'模型准确率：'</span>,round(sum(diag(tab2))/sum(tab2)*<span>100</span>, <span>2</span>),<span>'%'</span>, sep = <span>''</span>))<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>     M  <span>F</span><br>  M <span>43</span>  <span>7</span><br>  <span>F</span>  <span>7</span> <span>34</span><br>[<span>1</span>] <span>"模型准确率：84.62%"</span><br></code></pre><p data-tool="mdnice编辑器">这个准确率已经很棒了。</p><section data-tools="135编辑器" data-id="97518"><section><section><section><section><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png" data-type="png" data-w="35" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png"></section></section><section><img data-ratio="0.06666666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png" data-type="png" data-w="75" data-width="100%" title="" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png"></section><section><section><section data-width="70%"><br></section><section data-brushtype="text">差异代谢物的其他筛选方法</section></section></section></section></section></section><p data-tool="mdnice编辑器">除了用 (O) PLS-DA 中的 VIP 值对代谢物进行筛选，还可以用别的方法进行筛选，如 <code>log2FC</code> 等。通常是绘制火山图来展示。</p><pre data-tool="mdnice编辑器"><span></span><code><span># volcano plot</span><br>df = dataMatrix %&gt;% as.data.frame()<br>df$gender = sacurine[[<span>"sampleMetadata"</span>]][[<span>"gender"</span>]]<br>df = df[order(df$gender),]<br>df = df[,-<span>110</span>]<br><br>M.mean = apply(df[<span>1</span>:<span>100</span>,],<span>2</span>,FUN = mean)<br>F.mean = apply(df[<span>101</span>:<span>183</span>,],<span>2</span>,FUN = mean)<br><br>FC = M.mean / F.mean<br>log2FC = log(FC,<span>2</span>)<br><br>pvalue = apply(df, <span>2</span>, <span>function</span>(x)<br>  {t.test(x[<span>1</span>:<span>100</span>],x[<span>101</span>:<span>183</span>])$p.value})<br><br>p.adj = p.adjust(pvalue, method = <span>'BH'</span>)<br>p.adj.log = -log10(p.adj)<br><br>colcano.df = data.frame(log2FC,p.adj, p.adj.log)<br>colcano.df$cat = ifelse(colcano.df$log2FC &gt;= <span>1</span> &amp; colcano.df$p.adj &lt; <span>0.05</span>,<span>'Up'</span>,<br>                        ifelse(colcano.df$log2FC &lt;= -<span>1</span> &amp; colcano.df$p.adj &lt; <span>0.05</span>,<span>'Down'</span>,<span>'NS'</span>))<br><br>p5 = ggplot(colcano.df, aes(log2FC, p.adj.log)) +<br>  geom_point() +<br>  labs(y = <span>'-log10(p-value.adj)'</span>) +<br>  theme_bw() +<br>  theme(legend.position = <span>'none'</span>,<br>        legend.text = element_text(color = <span>'black'</span>,size = <span>12</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>        panel.background = element_blank(),<br>        panel.grid = element_blank(),<br>        axis.text = element_text(color = <span>'black'</span>,size = <span>15</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>        axis.text.x = element_text(angle = <span>90</span>),<br>        axis.title = element_text(color = <span>'black'</span>,size = <span>15</span>, family = <span>'Arial'</span>, face = <span>'plain'</span>),<br>        axis.ticks = element_line(color = <span>'black'</span>),<br>        axis.ticks.x = element_blank())<br>p5<br>ggsave(p5, filename = <span>'20201214PLSDA分析/figures/volcano.pdf'</span>, <br>       width = <span>5</span>, height = <span>5</span>, device = cairo_pdf)<br></code></pre><p><img data-ratio="0.991332611050921" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblP8P0ic14uxa5bia9CMsT6wCmzANKZU17m4sc0j7nZOV3o7kICm7BtU9dQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="923" src="https://mmbiz.qpic.cn/mmbiz_jpg/GTgKK7iaBvZMx6IpO98E8J7vaicic2aAiblP8P0ic14uxa5bia9CMsT6wCmzANKZU17m4sc0j7nZOV3o7kICm7BtU9dQ/640?wx_fmt=jpeg"></p><p data-tool="mdnice编辑器">可能是这个例子中的代谢物太少了，导致算完以后都没有差异代谢物了。</p><section data-tools="135编辑器" data-id="97518"><section><section><section><section><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png" data-type="png" data-w="35" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFBonwZOeX18X00b0icqa2IbhXyzIRlusEibEEy2s36zbLnGW8FLd1KwjA/640?wx_fmt=png"></section></section><section><img data-ratio="0.06666666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png" data-type="png" data-w="75" data-width="100%" title="" src="https://mmbiz.qpic.cn/mmbiz_png/YUyZ7AOL3okNXQklxyEOGf8O3njpw5lFzPye7qfrQJM755MHibGWB1YeYVjWITDumvsvyXAmaaVibPkmicg8qhOQw/640?wx_fmt=png"></section><section><section><section data-width="70%"><br></section><section data-brushtype="text" hm_fix="285:815">参考文献</section></section></section></section></section></section><blockquote data-tool="mdnice编辑器"><p>[1] Thévenot E A, Roux A, Xu Y, et al. Analysis of the human adult urinary metabolome variations with age, body mass index, and gender by implementing a comprehensive workflow for univariate and OPLS statistical analyses[J]. <em><strong>Journal of proteome research</strong></em>, 2015, 14(8): 3322-3335.</p></blockquote></section><p><img data-ratio="0.38984375" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/GTgKK7iaBvZNVrfE2VT3AZ9sfgEMia33R46UVVNfhobrMeQEfshVHLSzuN2KCDjfYYlrKZY635WoKKSlcPj87sAg/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/GTgKK7iaBvZNVrfE2VT3AZ9sfgEMia33R46UVVNfhobrMeQEfshVHLSzuN2KCDjfYYlrKZY635WoKKSlcPj87sAg/640?wx_fmt=png"></p></section></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/lGrHVnp2W3ilRhuZ12apFA",target="_blank" rel="noopener noreferrer">原文链接</a>
