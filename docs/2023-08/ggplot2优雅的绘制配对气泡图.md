---
title: "ggplot2优雅的绘制配对气泡图"
date: 2023-08-12T07:33:33Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
ggplot2优雅的绘制配对气泡图 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">去年年底看到闫哥公众号<strong>R语言数据分析指南</strong>发过一个帖子<a href="https://mp.weixin.qq.com/s?__biz=Mzg3MzQzNTYzMw==&amp;mid=2247500448&amp;idx=1&amp;sn=4c2a69f0a9289b62e17179984c3ddce1&amp;scene=21#wechat_redirect" data-linktype="2">《ggplot2优雅的绘制配对连线云雨图》</a>。本文也给出我的一个绘图方案，也是我平时一直在用的代码：</p><h3 data-tool="mdnice编辑器"><span></span>Step1. R包和数据加载、主题设置<span></span></h3><p data-tool="mdnice编辑器">测试数据在：</p><p data-tool="mdnice编辑器">链接：https://pan.baidu.com/s/1MuMgMZZCcdO-IGS7_ysfkQ?pwd=1234提取码：1234</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(dplyr)<br><span>library</span>(ggplot2)<br><span>library</span>(ggpubr)<br><span>library</span>(rstatix)<br><span>#### 1.读入数据</span><br>pan.meta = readRDS(<span>"./Paired_test.data.rds"</span>)<br><br>head(pan.meta)<br><span>#   ID    Group Type      paired Expression</span><br><span># 1 TCGA-BL-A13J-01A tumor BLCA TCGA-BL-A13J   5.418168</span><br><span># 2 TCGA-BT-A20N-01A tumor BLCA TCGA-BT-A20N   2.472168</span><br><span># 3 TCGA-BT-A20Q-01A tumor BLCA TCGA-BT-A20Q   5.149659</span><br><span># 4 TCGA-BT-A20R-01A tumor BLCA TCGA-BT-A20R   5.590747</span><br><span># 5 TCGA-BT-A20U-01A tumor BLCA TCGA-BT-A20U   6.717855</span><br><span># 6 TCGA-BT-A20W-01A tumor BLCA TCGA-BT-A20W   7.140064</span><br></code></pre><p data-tool="mdnice编辑器">ID是TCGA的barcode，Group是肿瘤与对照样本，paired是配对的barcode信息，Expression则是目标基因的表达量。</p><p data-tool="mdnice编辑器"><strong>然后设置主题和颜色：</strong></p><pre data-tool="mdnice编辑器"><span></span><code>mytheme &lt;- theme(plot.margin=unit(c(<span>0.5</span>,<span>0.5</span>,<span>0.5</span>,<span>0.5</span>),units=,<span>"cm"</span>),<br>                 axis.line = element_line(color = <span>"black"</span>,size = <span>0.4</span>),<br>                 panel.grid.minor = element_blank(),<br>                 panel.grid.major = element_line(size = <span>0.2</span>,color = <span>"#e5e5e5"</span>),<br>                 axis.text.y = element_text(color=<span>"black"</span>,size=<span>10</span>),<br>                 axis.text.x = element_text(angle = <span>45</span>, hjust = <span>1</span> ,color=<span>"black"</span>,size=<span>10</span>),<br>                 legend.position = <span>"none"</span>,<br>                 panel.spacing = unit(<span>0</span>,<span>"lines"</span>))<br>fill.color = c(normal=<span>"#56B4E9"</span>,tumor= <span>"#E69F00"</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>Step2. 可视化绘图<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>p1 = ggplot(pan.meta, aes(x = Group,y = Expression,fill = Group)) +<br>  geom_line(aes(group=paired),position = position_dodge(<span>0.2</span>),color=<span>"grey80"</span>) +<br>  geom_point(aes(group=paired,size=Expression),<br>             pch=<span>21</span>,<br>             size=<span>3</span>,<br>             <span># position = position_dodge(0),</span><br>             position = position_jitter(w = <span>0.1</span>))+<br>  stat_summary(fun.data = <span>'mean_se'</span>, geom = <span>"errorbar"</span>, color = <span>"red"</span>, <br>               width = <span>0.25</span>, size = <span>0.8</span>, position = position_dodge( <span>.9</span>)) +<br>  <span># scale_size_continuous(range=c(1,3)) +</span><br>  facet_wrap(.~Type,scales = <span>"free_y"</span>,ncol = <span>11</span>) +<br>  scale_fill_manual(values = fill.color) +<br>  <span># scale_y_continuous(limits = c(-4,4),minor_breaks = seq(0,90,1)) +</span><br>  labs(x= <span>NULL</span>,y=<span>"Gene expression"</span>)+<br>  stat_compare_means(aes(group =  Group),<br>                     paired = <span>T</span>,<br>                     <span># label.y = 3.5, </span><br>                     label.x = <span>1.5</span>,<br>                     method = <span>"t.test"</span>,<br>                     label = <span>"p.signif"</span>,<br>                     size = <span>4</span>) + <br>  theme_bw() + mytheme<br>p1<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.31574074074074077" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXUEBNEsSGkfExcLLDNd2Pw2CLcicvVaz7z1zLZx1F5WZfRdpg5AKAXVXAeu9xS0kTh22ZsLO4fUxQ/640?wx_fmt=other" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXUEBNEsSGkfExcLLDNd2Pw2CLcicvVaz7z1zLZx1F5WZfRdpg5AKAXVXAeu9xS0kTh22ZsLO4fUxQ/640?wx_fmt=other"><figcaption>image-20230616113300005</figcaption></figure><p data-tool="mdnice编辑器">上面的P值是用<code>stat_compare_means</code>计算的，其实多组间的两两比较还可以考虑用校正后的P值，可以使用<code>rstatix</code>包进行计算：</p><pre data-tool="mdnice编辑器"><span></span><code>stat.test&lt;- pan.meta %&gt;%<br>  group_by(Type) %&gt;%<br>  t_test(Expression~Group) %&gt;%<br>  adjust_pvalue(method = <span>"bonferroni"</span>) %&gt;%<br>  add_significance(<span>"p.adj"</span>)%&gt;%<br>  add_xy_position(x=<span>"Group"</span>,dodge = <span>0.8</span>)<br>stat.test<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.24074074074074073" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXUEBNEsSGkfExcLLDNd2PwJGHESWyPbibEibibjY0Uib6IlicrlArGxNYXKia6PQEKnShNab7ymoN0ytMA/640?wx_fmt=other" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXUEBNEsSGkfExcLLDNd2PwJGHESWyPbibEibibjY0Uib6IlicrlArGxNYXKia6PQEKnShNab7ymoN0ytMA/640?wx_fmt=other"><figcaption>image-20230616112934079</figcaption></figure><p data-tool="mdnice编辑器">可视化绘图：</p><pre data-tool="mdnice编辑器"><span></span><code>p2 = ggplot(pan.meta, aes(x = Group, y = Expression)) + <br>  geom_line(aes(group=paired),position = position_dodge(<span>0.2</span>),color=<span>"grey80"</span>) +<br>  geom_point(aes(group=paired,size=Expression,<br>                 <span># alpha=Expression,</span><br>                 fill= Group),pch=<span>21</span>,size=<span>3</span>,<br>             position = position_jitter(w = <span>0.1</span>))+<br>  stat_summary(fun.data = <span>'mean_se'</span>, geom = <span>"errorbar"</span>, color = <span>"red"</span>, <br>               width = <span>0.25</span>, size = <span>0.8</span>, position = position_dodge( <span>.9</span>)) +<br>  facet_wrap(~Type ,scale=<span>"free_y"</span>,nrow = <span>2</span>) + <br>  scale_fill_manual(values= fill.color) +<br>  scale_x_discrete( labels=<span>NULL</span> ) + <br>  stat_pvalue_manual(stat.test,label = <span>"p.adj"</span>, <span>#p.adj.signif</span><br>                     tip.length = <span>0.05</span>,<br>                     <span># y.position = 6,</span><br>                     remove.bracket = <span>T</span>,hjust=<span>1</span>)+<br>  labs(x= <span>NULL</span>,y=<span>"Gene expression"</span>)+<br>  theme_bw() + mytheme<br>p2<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.2972222222222222" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXUEBNEsSGkfExcLLDNd2PwickXnG7dGUTwqTUwBMlqQ73l2KLZ8UDxPI7mgyCKcatQNHNqAchY3icQ/640?wx_fmt=other" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXUEBNEsSGkfExcLLDNd2PwickXnG7dGUTwqTUwBMlqQ73l2KLZ8UDxPI7mgyCKcatQNHNqAchY3icQ/640?wx_fmt=other"><figcaption>image-20230616113955079</figcaption></figure><p data-tool="mdnice编辑器">P值太长了，这里可以用星号，或者是科学计数法显示保留前两位小数：</p><ul data-tool="mdnice编辑器"><li><section>用星号</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span>###用星号</span><br>p3 = ggplot(pan.meta, aes(x = Group, y = Expression)) + <br>  geom_line(aes(group=paired),position = position_dodge(<span>0.2</span>),color=<span>"grey80"</span>) +<br>  geom_point(aes(group=paired,size=Expression,<br>                 <span># alpha=Expression,</span><br>                 fill= Group),pch=<span>21</span>,size=<span>3</span>,<br>             position = position_jitter(w = <span>0.1</span>))+<br>  stat_summary(fun.data = <span>'mean_se'</span>, geom = <span>"errorbar"</span>, color = <span>"red"</span>, <br>               width = <span>0.25</span>, size = <span>0.8</span>, position = position_dodge( <span>.9</span>)) +<br>  facet_wrap(~Type ,scale=<span>"free_y"</span>,nrow = <span>2</span>) + <br>  scale_fill_manual(values= fill.color) +<br>  scale_x_discrete( labels=<span>NULL</span> ) + <br>  stat_pvalue_manual(stat.test,label = <span>"p.adj.signif"</span>,<br>                     tip.length = <span>0.05</span>,<br>                     <span># y.position = 6,</span><br>                     remove.bracket = <span>F</span>)+<br>  labs(x= <span>NULL</span>,y=<span>"Gene expression"</span>)+<br>  theme_bw() + mytheme<br>p3<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.2537037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXUEBNEsSGkfExcLLDNd2Pw9lZjuEtdcRQ4HibFtsdNYhyJysIks86v2FD293ISU9o7g40q66Msxaw/640?wx_fmt=other" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXUEBNEsSGkfExcLLDNd2Pw9lZjuEtdcRQ4HibFtsdNYhyJysIks86v2FD293ISU9o7g40q66Msxaw/640?wx_fmt=other"><figcaption>image-20230616114931024</figcaption></figure><ul data-tool="mdnice编辑器"><li><section>科学计数法显示保留前两位小数</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span>###科学计数法显示保留前两位小数</span><br>stat.test$p.adj &lt;- format(stat.test$p.adj, scientific = <span>TRUE</span>) %&gt;% as.numeric()<br>stat.test$p.adj &lt;- sprintf(<span>"%.2e"</span>, stat.test$p.adj)<br>stat.test$p.adj = ifelse(as.numeric(stat.test$p.adj) &gt; <span>0.05</span>,<span>"NS"</span>,stat.test$p.adj)<br><br>p4 = ggplot(pan.meta, aes(x = Group, y = Expression)) + <br>  geom_line(aes(group=paired),position = position_dodge(<span>0.2</span>),color=<span>"grey80"</span>) +<br>  geom_point(aes(group=paired,size=Expression,<br>                 <span># alpha=Expression,</span><br>                 fill= Group),pch=<span>21</span>,size=<span>3</span>,<br>             position = position_jitter(w = <span>0.1</span>))+<br>  stat_summary(fun.data = <span>'mean_se'</span>, geom = <span>"errorbar"</span>, color = <span>"red"</span>, <br>               width = <span>0.25</span>, size = <span>0.8</span>, position = position_dodge( <span>.9</span>)) +<br>  facet_wrap(~Type ,scale=<span>"free_y"</span>,nrow = <span>2</span>) + <br>  scale_fill_manual(values= fill.color) +<br>  scale_x_discrete( labels=<span>NULL</span> ) + <br>  stat_pvalue_manual(stat.test,label = <span>"p.adj"</span>, <span>#p.adj.signif</span><br>                     tip.length = <span>0.05</span>,<br>                     <span># y.position = 6,</span><br>                     remove.bracket = <span>T</span>,hjust=<span>1</span>)+<br>  labs(x= <span>NULL</span>,y=<span>"Gene expression"</span>)+<br>  theme_bw() + mytheme<br>p4<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.2722222222222222" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXUEBNEsSGkfExcLLDNd2PwtDdppfw9pI1XWbH3OeGicia4LMAI306wZlkHKFPAUYRGglGoNOoBAzAw/640?wx_fmt=other" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXUEBNEsSGkfExcLLDNd2PwtDdppfw9pI1XWbH3OeGicia4LMAI306wZlkHKFPAUYRGglGoNOoBAzAw/640?wx_fmt=other"><figcaption>image-20230616114710231</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>写在最后<span></span></h3><p data-tool="mdnice编辑器">其实我的ggplot2功底也不是很好，没有很系统的去钻研ggplot2的语法和结构。因为我认为我只要会修改别人的ggplot2绘图代码，然后把自己想要绘制的各种元素，能转化为语言去进行网络搜索，这样想绘制的图，基于上都可以根据百度谷歌和工具书去实现。绘图当然很重要，但是科研节奏这么紧张，ggplot2的学习到底应该投入多少时间（当然也看悟性），这点见仁见智。最后给大家分享一本我经常翻阅的ggplot2工具书：</p><p data-tool="mdnice编辑器">链接：https://pan.baidu.com/s/1MuMgMZZCcdO-IGS7_ysfkQ?pwd=1234提取码：1234</p><blockquote data-tool="mdnice编辑器"><p><strong>心情记录</strong></p><p>一晃六月了，我的博三已接近尾声，马上就是博四了，毕业压力，毕设压力，还有就业压力扑面而来。马上奔三了，这种复杂的心情应该只有局内人才能体会。小小吐槽一下，国内大多数的博士点的薪资真的太少了。。。</p><p>我不想贩卖焦虑，我想记录下生活的点滴。数年之后回首这段时光，应该会有很多酸甜苦辣的回忆。也希望自己能够保持初心，屠龙少年不要成为恶龙。</p><p>这应该是我第一次在这个公众号里分享一些与数据分析无关的私人心情。。。</p><p>加油，尚在奋斗的各位！</p></blockquote><span>- END -</span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/p9mROjsPLDIM8G37Lf1UoQ",target="_blank" rel="noopener noreferrer">原文链接</a>
