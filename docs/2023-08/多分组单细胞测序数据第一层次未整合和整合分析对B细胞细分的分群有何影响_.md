---
title: "多分组单细胞测序数据第一层次未整合和整合分析对B细胞细分的分群有何影响？"
date: 2023-08-29T13:57:22Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
多分组单细胞测序数据第一层次未整合和整合分析对B细胞细分的分群有何影响？ by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247514120&amp;idx=1&amp;sn=c8892e9fcb5b3b07807a34ce9a69140a&amp;chksm=ea1cbe8add6b379cdd5555bdc4165f4ede4a915a24f7d34463c7f37df18cce27f44a09e79e79&amp;scene=21&amp;cur_album_id=3019915773533913092#wechat_redirect" data-linktype="2">今年暑假一起学单细胞吧（附上游数据下载tips）</a></p><blockquote data-tool="mdnice编辑器"><p>这个新专辑有以下几点希冀：</p><ul><li><section>带着像我一样的单细胞小白，一步步利用我们生信技能树、生信菜鸟团、单细胞天地的资源，掌握基本的scRNAseq流程</section></li><li><section>在学习的过程中，探索出合适的学习路径，帮助大家更好地利用已有资源</section></li><li><section>对过往推文中出现的错误、更新的软件进行审查，推陈出新</section></li><li><section>在过去的基本内容上深入挖掘影响小白学习的障碍，提炼总结，拓宽深度宽度</section></li><li><section>和大家讨论我在从零开始学习过程中遇到的问题，老师们在评论区指出我的不足提出建议</section></li></ul><p>而我在将自己的学习笔记排版成推文时也会遵循以下行文特点：</p><ul><li><section>务必详实逐步复现，如展示原推文中没展示的过程结果，添加参考资料帮助理解</section></li><li><section>重点推陈出新，如果原推文足够详细且我没遇到其他问题，可能会直接带过这篇学习推文，只在推文中展示结果，但是仍会告诉大家我看了啥，以便梳理小白学习路径</section></li></ul></blockquote><p data-tool="mdnice编辑器">这期学习这篇推文：<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247506108&amp;idx=1&amp;sn=95db177523783de8df96f9393d0a31ee&amp;chksm=fa451d81cd329497f84a7d4b8d9892f046d09ecdf990bae1363deaaf9a83cb88c81bc26935b9&amp;scene=21&amp;cur_album_id=2546857217690632193#wechat_redirect" data-linktype="2">多分组单细胞转录组测序样本第一层次未整合和整合数据的B细胞细分对比</a></p><p data-tool="mdnice编辑器">一开始这篇推文的学习我是很有想法的，因为曾老师给我分享了一篇投稿，投稿中使用根据病人进行批次拆分单独处理后通过anchor进行integrate（CCA, 区别于直接merge）达到去除批次效应的目的，而不是像我们之前那样直接harmony</p><figure data-tool="mdnice编辑器"><img data-ratio="0.2796296296296296" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDu73tlibFicfRej5et5cr4UL9LcwodzNib101AELiakyrEpYxFmyzXqyiagg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDu73tlibFicfRej5et5cr4UL9LcwodzNib101AELiakyrEpYxFmyzXqyiagg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">我打算拿这篇推文数据来进行研究：<strong>拆分批次单独处理后通过anchor进行integrate(CCA)和harmony的效果有什么区别</strong></p><p data-tool="mdnice编辑器">但随着研究的进行，我发现其实这个数据集其实并不需要去除批次效应，所以我们还是像原推文那样<strong>研究“多分组单细胞转录组测序样本第一层次未整合和整合数据的B细胞细分对比”，学习一下这个拆分、merge的操作</strong></p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">某个数据集需不需要去批次，什么时候去批次，去批次的影响，可以参考上一期推文：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515454&amp;idx=1&amp;sn=9baf3f82940d8cb2685bc140122fb686&amp;chksm=ea1cbbbcdd6b32aad5953a0d0e80766f0ec50e232c2df6208b8f2c340ff0f04a9a2c54a20726&amp;scene=21#wechat_redirect" textvalue="harmony、不harmony，这是个问题" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">harmony、不harmony，这是个问题</a></p><figure data-tool="mdnice编辑器"><img data-ratio="0.5796296296296296" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDoIFn8icOOnIQzHAicMyiaX6DEEib6gf7qXef8wCvVcpvxKL1Sy7F6RKFibA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDoIFn8icOOnIQzHAicMyiaX6DEEib6gf7qXef8wCvVcpvxKL1Sy7F6RKFibA/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.5731481481481482" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDBLicNorcePicWJh2s8PMicDpslIlPUbCmmsvDydia6WI0FlyyJH6lmhRFw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDBLicNorcePicWJh2s8PMicDpslIlPUbCmmsvDydia6WI0FlyyJH6lmhRFw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">不同sampletype看似存在差异，有免疫细胞、非免疫细胞、外周血白细胞，但实验设计批次上还是根据病人来的，几乎每个病人都有这三种sampletype，病人没批次效应，sampletype之间的差异应该就是生物学差异</p><p data-tool="mdnice编辑器">所以这里我们并不根据病人批次走harmony，以免抹除真正的差异</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">原推文使用的是整理好的数据，我们这里从头开始</p><h2 data-tool="mdnice编辑器"><span></span>intro</h2><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247506108&amp;idx=1&amp;sn=95db177523783de8df96f9393d0a31ee&amp;chksm=fa451d81cd329497f84a7d4b8d9892f046d09ecdf990bae1363deaaf9a83cb88c81bc26935b9&amp;scene=21&amp;cur_album_id=2546857217690632193#wechat_redirect" data-linktype="2">多分组单细胞转录组测序样本第一层次未整合和整合数据的B细胞细分对比</a></p><p data-tool="mdnice编辑器">GSE164690  GEO Accession viewer</p><p data-tool="mdnice编辑器">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE164690</p><p data-tool="mdnice编辑器">头颈部鳞状细胞癌（HNSCC）</p><p data-tool="mdnice编辑器">免疫细胞（CD45+ ）；非免疫细胞（CD45-）；外周血白细胞（PBL）</p><p data-tool="mdnice编辑器">51个样本，18例 treatment-naive patients （6 HPV+ and 12HPV– HNSCC 癌症病人），其中15例 CD45+, CD45-, PBL 为配对数据。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6185185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDoAIicNoUkH1KoTI8424ibaFMs7SK9wIcJHcOUCvM8Fwtdibqk8T17ueMQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDoAIicNoUkH1KoTI8424ibaFMs7SK9wIcJHcOUCvM8Fwtdibqk8T17ueMQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">头颈部鳞状细胞癌（HNSCC）的特征是肿瘤微环境（TME）中基质细胞、上皮细胞和免疫细胞之间的复杂关系。为了开发更有效的治疗方法，我们旨在使用单细胞RNA测序（scRNAseq）研究6例人乳头瘤病毒（HPV）+和12例HPV-HNSCC患者肿瘤和匹配的外周血样本中抑制性非免疫和免疫细胞群的异质性、独特细胞群的特征以及细胞间相互作用。使用134606个细胞的数据集，我们显示了与炎症和HPV状态相关的细胞类型特异性特征，描述了在HPV+TME中具有弹性分化的成纤维细胞的负面预后价值，预测了治疗靶向的检查点受体-配体相互作用，并显示肿瘤相关巨噬细胞是TME中PD-L1和其他免疫检查点配体的主要贡献者。我们对形成HNSCC微环境的细胞内在机制和细胞间通讯提出了全面的单细胞观点。</p><blockquote data-tool="mdnice编辑器"><p>对GSE164690数据集分别进行未整合和整合数据分析。</p><p>多分组未整合数据：<strong>CD45+ ，CD45-，PBL三组数据未整合分别进行降维分群，等进行B细胞细分的时候再merge到一块</strong>（第一层次分析数据由曾老师提供，在此感谢）。</p><p>多分组整合数据：<strong>CD45+ ，CD45-，PBL三组数据从一开始整合进行第一层次降维分群，再进行B细胞细分</strong>（该数据由齐兵提供，在此感谢）。</p><p>对曾老师的数据进行处理：首先进行了第一次B细胞细分，去除干扰亚群，而后又进行第二次B细胞细分（分辨率选用的0.8）。</p><p>齐兵的数据选用的分辨率也是0.8，其去除干扰亚群后没有再进行细分。</p><p>之后就直接用两组已对细胞亚群进行生物学命名的数据来进行对比。</p></blockquote><h2 data-tool="mdnice编辑器"><span></span>数据下载</h2><p data-tool="mdnice编辑器">拿到ftp下载地址</p><figure data-tool="mdnice编辑器"><img data-ratio="0.3960703205791106" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbD8ortlukBfiaDZcZuUCcMCjicx2Y0BuIOdOia9C6CM2EP3wMMtoIa8iaefg/640?wx_fmt=png" data-type="png" data-w="967" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbD8ortlukBfiaDZcZuUCcMCjicx2Y0BuIOdOia9C6CM2EP3wMMtoIa8iaefg/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.5061224489795918" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDicocZKxZ7EBPianP9NZH7wtibN2dfRYjM1ibJk0AeWL9DShgRUsk7rJkQw/640?wx_fmt=png" data-type="png" data-w="980" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDicocZKxZ7EBPianP9NZH7wtibN2dfRYjM1ibJk0AeWL9DShgRUsk7rJkQw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE164nnn/GSE164690/suppl/GSE164690_RAW.tar</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5188679245283019" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDKB7uTwlpx61pOiaw1BBmLdsfCvOwA988jwmzg1bNNhgT0IYicHsvP5uw/640?wx_fmt=png" data-type="png" data-w="954" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDKB7uTwlpx61pOiaw1BBmLdsfCvOwA988jwmzg1bNNhgT0IYicHsvP5uw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>整理数据</h2><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247514316&amp;idx=1&amp;sn=139a39771f22b6e7a484523313909f4c&amp;chksm=ea1cbe4edd6b3758f6c9564ca49ff66db7ea727ddf9d2391fa4a88132ac8f582a336ffcfd157&amp;scene=21&amp;cur_album_id=3019915773533913092#wechat_redirect" data-linktype="2">初探单细胞下游</a></p><p>可以记住这个10X技术输出文件目录和格式，以后使用 <code>Read10X</code>函数读取Seurat对象时可以检查一下</p></blockquote><p data-tool="mdnice编辑器">使用Read10X函数读取，整理文件路径:</p><pre data-tool="mdnice编辑器"><span></span><code>#!/bin/bash<br><br># 遍历当前目录下的所有.gz文件<br>for file in *.gz<br>do<br>    # 提取文件名中的编号部分<br>    filename=$(basename "$file" .gz)<br>    gsm_number=$(echo "$filename" | awk -F "_" '{print $1}')<br>  <br>    # 创建对应的文件夹（如果不存在）<br>    mkdir -p "$gsm_number"<br>  <br>    # 移动文件到对应的文件夹中<br>    mv "$file" "$gsm_number"<br>done<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5703703703703704" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDe2tEsk7F1UQ5Xuy60utFH2cHKMSkOOYSwouNdXwG7FY3FoRiardnsRA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDe2tEsk7F1UQ5Xuy60utFH2cHKMSkOOYSwouNdXwG7FY3FoRiardnsRA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">将所有文件夹下这三个文件前缀全部去除:</p><pre data-tool="mdnice编辑器"><span></span><code>#!/bin/bash<br><br># 遍历文件夹<br>for folder in GSM*/<br>do<br>    # 进入文件夹<br>    cd "$folder"<br>  <br>    # 对三个文件进行重命名<br>    for file in *_barcodes.tsv.gz<br>    do<br>        mv "$file" "barcodes.tsv.gz"<br>    done<br><br>    for file in *_features.tsv.gz<br>    do<br>        mv "$file" "features.tsv.gz"<br>    done<br><br>    for file in *_matrix.mtx.gz<br>    do<br>        mv "$file" "matrix.mtx.gz"<br>    done<br>  <br>    # 返回上一级目录<br>    cd ..<br>done<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.4925925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDeQaCE45fLzgm8AaVHBSQbAroAH1tLgCc22lwSIGv6nib3AjyHdOCJ5A/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDeQaCE45fLzgm8AaVHBSQbAroAH1tLgCc22lwSIGv6nib3AjyHdOCJ5A/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">获取sampletype：</p><pre data-tool="mdnice编辑器"><span></span><code><span>$less</span> GSE164690_series_matrix.txt.gz |grep <span>"Sample_title"</span>| awk -F <span>"\""</span> <span>'{ for (i=2; i&lt;=NF; i+=2) printf("%s,", $i) }'</span> | sed <span>'s/,$/\n/'</span> &gt; sample_types.txt<br></code></pre><hr data-tool="mdnice编辑器"><pre data-tool="mdnice编辑器"><span></span><code>library(Seurat)<br>library(tidyverse)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>dir="./GSE164690_RAW/"<br>samples=list.files(dir)<br>samples %&gt;% head()<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>sceList &lt;- lapply(samples, function(pro){<br>  print(pro)<br>  sce &lt;- CreateSeuratObject(counts = Read10X(file.path(dir,pro)),<br>                            project = gsub("^GSM[0-9]*_","",pro),<br>                            min.cells = 5,<br>                            min.features = 500)<br>  return(sce)<br>})<br>names(sceList)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.11296296296296296" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDY4ibMiam9Iqqib0VhO6mFicBXIQmd0897twoGG5CW9J2N6I7iax9d5jIYUw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDY4ibMiam9Iqqib0VhO6mFicBXIQmd0897twoGG5CW9J2N6I7iax9d5jIYUw/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.25462962962962965" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDE8DNmpTLaJhYTrwGyWDFRrE8g7XW8W848t9wu05Iae5M84AOibn7DuA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDE8DNmpTLaJhYTrwGyWDFRrE8g7XW8W848t9wu05Iae5M84AOibn7DuA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">发现GEO提供的一个样本的barcodes文件受损</p><p data-tool="mdnice编辑器">去除该受损样本文件，继续：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>library(Seurat)<br>library(tidyverse)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>dir="./GSE164690_RAW/"<br>samples=list.files(dir)<br>samples %&gt;% head()<br></code></pre><p data-tool="mdnice编辑器">GSM5017045样本barcode文件受损，剔除HN10_PBL cells</p><pre data-tool="mdnice编辑器"><span></span><code># &gt; which(samples=="GSM5017045")<br># [1] 25<br>samples &lt;- samples[-which(samples=="GSM5017045")]<br></code></pre><p data-tool="mdnice编辑器">18例 treatment-naive patients （6 HPV+ and 12HPV– HNSCC 癌症病人）免疫细胞（CD45+ ）；非免疫细胞（CD45-）；外周血白细胞（PBL）</p><pre data-tool="mdnice编辑器"><span></span><code>sceList &lt;- lapply(samples, function(pro){<br>  print(pro)<br>  sce &lt;- CreateSeuratObject(counts = Read10X(file.path(dir,pro)),<br>                            project = gsub("^GSM[0-9]*_","",pro),<br>                            min.cells = 5,<br>                            min.features = 500)<br>  return(sce)<br>})<br>names(sceList)<br></code></pre><p data-tool="mdnice编辑器">一开始就merge的</p><pre data-tool="mdnice编辑器"><span></span><code>sce.all=merge(x=sceList[[1]],<br>              y=sceList[ -1 ],<br>              add.cell.ids =  gsub('^GSM[0-9]*_','',samples))<br>sce.all.bp &lt;- sce.all<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.18055555555555555" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbD4WMK6DTurZRG2oJxhEeMjVQWwxtqIueGw3o3utUHGuBfNXQxUWY0tQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbD4WMK6DTurZRG2oJxhEeMjVQWwxtqIueGw3o3utUHGuBfNXQxUWY0tQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">本文根据CD45+ ，CD45-，PBL三组sample_type数据拆分而不是参考文（拆分批次单独处理后通过anchor进行integrate）中的每个病人批次</p><p data-tool="mdnice编辑器">按照sampletype拆分：</p><pre data-tool="mdnice编辑器"><span></span><code>sample_types &lt;- read.table("sample_types.txt",header = FALSE,sep = ",",quote = "TRUE")<br>sampletype &lt;- t(sample_types[1,][-25])<br>sampletype &lt;- ifelse(grepl("CD45\\+",sampletype),"CD45+",<br>                     ifelse(grepl("CD45\\-",sampletype),"CD45-","PBL"))<br>sampletype<br>table(sampletype)<br># CD45- CD45+   PBL <br>#    15    18    17 <br>sampletype_df &lt;- data.frame(sample_GSM = levels(sce.all@active.ident),<br>                         sampletype = sampletype)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code># sce.all &lt;- sce.all.bp<br>sce.all@meta.data$sampletype &lt;- "NA"<br>for (i in 1:nrow(sampletype_df)){<br>  sce.all@meta.data[which(sce.all@meta.data$orig.ident==sampletype_df$sample_GSM[i]), "sampletype"] &lt;- sampletype_df$sampletype[i]<br>}<br>table(sce.all$sampletype)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>sce.list &lt;- SplitObject(sce.all, split.by = "sampletype")<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.2323439099283521" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDcPNn86Aks3EI1Cpib9iaGonL1NN2ibPbQ0o7a5nL7YdlocicSy90VfWLuw/640?wx_fmt=png" data-type="png" data-w="977" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDcPNn86Aks3EI1Cpib9iaGonL1NN2ibPbQ0o7a5nL7YdlocicSy90VfWLuw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">若根据病人拆分：</p><pre data-tool="mdnice编辑器"><span></span><code>patient_df &lt;- data.frame(sample_GSM = levels(sce.all@active.ident),<br>                         patient = c(rep("01",3),rep(c("02","03","04"),each=2),<br>                                     rep(c("05","06","07","08","09","10","11","12","13","14","15","16","17","18"),each=3))[-25]<br>                         )<br><br>sce.all@meta.data$patientid &lt;- "NA"<br>for (i in 1:nrow(patient_df)){<br>  sce.all@meta.data[which(sce.all@meta.data$orig.ident==patient_df$sample_GSM[i]), "patientid"] &lt;- patient_df$patient[i]<br>}<br>table(sce.all$patientid)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>sce.patient_list &lt;- SplitObject(sce.all, split.by = "patientid")<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5676300578034682" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDia2wg6V70c7Q3xOHGeU5kohibFo8sqhNrkV4LnVRy3d0Ev15bsKlIUCw/640?wx_fmt=png" data-type="png" data-w="865" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDia2wg6V70c7Q3xOHGeU5kohibFo8sqhNrkV4LnVRy3d0Ev15bsKlIUCw/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>整合pipeline</h1><h2 data-tool="mdnice编辑器"><span></span>数据质控</h2><pre data-tool="mdnice编辑器"><span></span><code>sce.all@meta.data$project &lt;- "HNSCC"<br>sce.all &lt;- SetIdent(sce.all, value = "project")<br>## 计算细胞中线粒体基因比例<br>sce.all[["percent.mt"]] &lt;- PercentageFeatureSet(sce.all, pattern = "^MT-")<br>## 使用小提琴图可视化QC指标<br>VlnPlot(sce.all, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = 0)<br># 点太多挡住小提琴图 pt.size 0<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>## FeatureScatter于可视化特征-特征关系<br>plot1 &lt;- FeatureScatter(sce.all, feature1 = "nCount_RNA", feature2 = "percent.mt")<br>plot2 &lt;- FeatureScatter(sce.all, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")<br>plot1 + plot2<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>## 过滤<br>## 官方推荐过滤掉独特特征计数超过2500或小于200的细胞，或者过滤掉超过5%线粒体基因比例的细胞<br>sce.all.fit &lt;- subset(sce.all, subset = nFeature_RNA &gt; 200 &amp; nFeature_RNA &lt; 2500 &amp; percent.mt &lt; 5)<br>sce.all.fit<br>sce.all<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.2759259259259259" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbD3EZvEBncdSr0I5QEziaR2UrG9z1cNuaTIeEgBWGRqXicQztlRc2oU2Vw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbD3EZvEBncdSr0I5QEziaR2UrG9z1cNuaTIeEgBWGRqXicQztlRc2oU2Vw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>数据标准化</h2><pre data-tool="mdnice编辑器"><span></span><code>sce.all.fit &lt;- NormalizeData(sce.all.fit, normalization.method = "LogNormalize", scale.factor = 1e4)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>识别高变基因</h2><pre data-tool="mdnice编辑器"><span></span><code>sce.all.fit &lt;- FindVariableFeatures(sce.all.fit, selection.method = "vst", nfeatures = 2000) #返回两千个高变基因<br><br>## 提取前10的高变基因<br>top10 &lt;- head(VariableFeatures(sce.all.fit), 10)<br>top10<br><br>## 展示高变基因<br>plot1 &lt;- VariableFeaturePlot(sce.all.fit)<br>plot2 &lt;- LabelPoints(plot = plot1, points = top10, repel = TRUE)<br>plot1 + plot2<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>数据归一化</h2><pre data-tool="mdnice编辑器"><span></span><code>#######数据归一化##########<br>sce.all.fit &lt;- ScaleData(sce.all.fit, vars.to.regress = "percent.mt")<br></code></pre><p data-tool="mdnice编辑器">这一步比较消耗计算资源，几次在共享服务器上做喜提warning邮件</p><h2 data-tool="mdnice编辑器"><span></span>降维</h2><pre data-tool="mdnice编辑器"><span></span><code>sce.all.fit &lt;- RunPCA(sce.all.fit, features = VariableFeatures(object = sce.all.fit)) ##默认会输出5个主成分<br>sce.all.fit &lt;- FindNeighbors(sce.all.fit, dims = 1:10)<br>sce.all.fit &lt;- FindClusters(sce.all.fit, resolution = 0.8)  # 和原推文一致<br>## 查看前5分析细胞聚类数ID<br>head(Idents(sce.all.fit), 5)<br><br><br>## 查看每个类别多少个细胞<br>table(sce.all.fit@meta.data$seurat_clusters)<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.08981481481481482" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDNwekWib0Lic7yRmsfBpN7bXpWFiaicmmZoOuB8RTEhl0DFHyibgrEiaZcNUQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDNwekWib0Lic7yRmsfBpN7bXpWFiaicmmZoOuB8RTEhl0DFHyibgrEiaZcNUQ/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>UMAP/tSNE可视化</h2><pre data-tool="mdnice编辑器"><span></span><code>sce.all.fit &lt;- RunUMAP(sce.all.fit, dims = 1:10)  # Which dimensions to use as input features, used only if features is NULL<br>p1 &lt;- DimPlot(sce.all.fit, reduction = "umap", label = T, label.size = 5)<br>sce.all.fit &lt;- RunTSNE(sce.all.fit, dims = 1:10)<br>p2 &lt;- DimPlot(sce.all.fit, reduction = "tsne", label = T, label.size = 5)<br>p1+p2<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5351851851851852" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDT5kcM3MRZhj0H6icd79xbaEXIGyWQlBC8sI8bIMOXooTZBTdia6ZphXA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDT5kcM3MRZhj0H6icd79xbaEXIGyWQlBC8sI8bIMOXooTZBTdia6ZphXA/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>初步marker鉴定细胞</h2><p data-tool="mdnice编辑器"><strong>查看marker表达情况</strong></p><p data-tool="mdnice编辑器">参考：</p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247506108&amp;idx=1&amp;sn=95db177523783de8df96f9393d0a31ee&amp;chksm=fa451d81cd329497f84a7d4b8d9892f046d09ecdf990bae1363deaaf9a83cb88c81bc26935b9&amp;scene=21&amp;cur_album_id=2546857217690632193#wechat_redirect" data-linktype="2">多分组单细胞转录组测序样本第一层次未整合和整合数据的B细胞细分对比</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247517249&amp;idx=2&amp;sn=9dd886ddf817e863294b9fb7bfaff926&amp;scene=21#wechat_redirect" data-linktype="2">B细胞细分亚群</a></p><blockquote data-tool="mdnice编辑器"><p>仅仅是区分了 B细胞和 Plasma细胞。</p><p>现在我们就从文献《Single-cell landscape and clinical outcomes of infiltrating B cells in colorectal cancer》来说一下B细胞的细分亚群。它是一个单细胞数据挖掘文章，主要是关心结直肠癌的肿瘤免疫微环境里面的B细胞，两个单细胞数据集：</p><ul><li><section>scRNA profiles of 63,689 cells from 25 CRC tumor and 10 peritumor tissue samples</section></li><li><section>..........</section></li></ul><p>首先 B cells (form marker gene: CD79A)  可以细分成为：</p><ul><li><section>CD20+ B cells</section></li><li><section>CD138+ plasma cells</section></li></ul><p>然后第一个CD20+ B cells 又是可以细分成为：</p><ul><li><section>naïve B cells (CD20+, CD27−, and CD38−),  主要的基因是 IGHD, FCER2, TCL1A, and IL4R,</section></li><li><section>memory B cells (CD20+, CD27+, and CD38–), 主要的基因是 CD27, AIM2, TNFRSF13B</section></li><li><section>germinal center (GC) B cells (CD20+, CD27+, CD38+, and CD138−),主要的基因是S1PI2, LRMP, SUGCT, MME, MKI67, and AICDA</section></li></ul><p>而第二个 CD138+ plasma cells  可以细分成为：</p><ul><li><section>IgA plasma</section></li><li><section>IgG plasma cells</section></li></ul></blockquote><blockquote data-tool="mdnice编辑器"><figure><img data-ratio="0.709051724137931" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDhJBLWnQZLbImNHbV2Jr93Z8HoA2esvicOicvicJwcOx9ia89ib8mMClxxWQ/640?wx_fmt=png" data-type="png" data-w="928" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDhJBLWnQZLbImNHbV2Jr93Z8HoA2esvicOicvicJwcOx9ia89ib8mMClxxWQ/640?wx_fmt=png"></figure></blockquote><pre data-tool="mdnice编辑器"><span></span><code>DotPlot(sce.all.fit, features = c("CD3D","CD3E","CD8A",  # Tcells<br>  "CD19","CD79A","MS4A1",  # Bcells<br>  "IGHG1","MZB1","SDC1",  # Plasma cells<br>  "CD68","CD163","CD14",  # Monocytes and macrophages<br>  "FGFBP2","FCG3RA","CX3CR1",  # NK cells<br>  "EPCAM"  # epi or tumor<br>  ))+RotatedAxis()<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.7204100652376515" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDHjfeicyLnrb9rLx4QMe713iannU5V60ZVRC8Q7woIVe8H3oXicsCWz7SQ/640?wx_fmt=png" data-type="png" data-w="1073" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDHjfeicyLnrb9rLx4QMe713iannU5V60ZVRC8Q7woIVe8H3oXicsCWz7SQ/640?wx_fmt=png">T 0,1,2,3,5,7,8,10,19</p><p data-tool="mdnice编辑器">B 6, 22</p><p data-tool="mdnice编辑器">Plasma 12, 15, 20,21,23</p><p data-tool="mdnice编辑器">Mono 4,11,17,18</p><p data-tool="mdnice编辑器">NK 9</p><p data-tool="mdnice编辑器">Unknown 13, 14, 16, 24</p><pre data-tool="mdnice编辑器"><span></span><code>celltype=data.frame(ClusterID=0:24 ,<br>                      celltype= 0:24) <br>#定义细胞亚群  <br>celltype[celltype$ClusterID %in% c( 0,1,2,3,5,7,8,10,19 ),2]='Tcells'   <br>celltype[celltype$ClusterID %in% c( 6, 22 ),2]='Bcells' <br>celltype[celltype$ClusterID %in% c( 12, 15, 20,21,23 ),2]='plasma'   <br>celltype[celltype$ClusterID %in% c( 4,11,17,18 ),2]='Mono'   <br>celltype[celltype$ClusterID %in% c( 9 ),2]='NK'  <br>celltype[celltype$ClusterID %in% c( 13, 14, 16, 24 ),2]='Unknown' <br> <br>  <br>head(celltype)<br>celltype<br>table(celltype$celltype)<br><br>sce.all.fit@meta.data$celltype = "NA"<br>  <br>for(i in 1:nrow(celltype)){<br>  sce.all.fit@meta.data[which(sce.all.fit@meta.data$RNA_snn_res.0.8 == celltype$ClusterID[i]),'celltype'] &lt;- celltype$celltype[i]}<br>Idents(sce.all.fit)=sce.all.fit$celltype<br>  <br>sel.clust = "celltype"<br>sce.all.fit &lt;- SetIdent(sce.all.fit, value = sel.clust)<br>table(sce.all.fit@active.ident)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>gplots::balloonplot(table(sce.all.fit$RNA_snn_res.0.8,sce.all.fit$celltype))<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7735490009514748" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDS9M7BlibpHRKhIq1oLs1xvuMFPdWVOGXIvGeIiaVaxOdwz5vBvjm0DFQ/640?wx_fmt=png" data-type="png" data-w="1051" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDS9M7BlibpHRKhIq1oLs1xvuMFPdWVOGXIvGeIiaVaxOdwz5vBvjm0DFQ/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>DimPlot(sce.all.fit, reduction = "umap", label = TRUE, pt.size = 0.5)+NoLegend()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6907378335949764" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDzxiaciamPv5lTUf1suibmZCUicLSmSJnWhuDicfKTribiaNH56YVhIkQ92CeQ/640?wx_fmt=png" data-type="png" data-w="637" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDzxiaciamPv5lTUf1suibmZCUicLSmSJnWhuDicfKTribiaNH56YVhIkQ92CeQ/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>重新降维和细分亚群Bcells</h2><pre data-tool="mdnice编辑器"><span></span><code># 提取指定Bcells<br>sce.all.fit<br>sce.Bcells=sce.all.fit[,sce.all.fit$celltype=='Bcells']<br><br># 重新降维分组<br>sce.Bcells=CreateSeuratObject(counts = sce.Bcells@assays$RNA@counts,<br>                       meta.data = sce.Bcells@meta.data[,1:7])<br>sce.Bcells &lt;- NormalizeData(sce.Bcells, normalization.method =  "LogNormalize",  <br>                     scale.factor = 1e4)<br>GetAssay(sce.Bcells,assay = "RNA")<br>sce.Bcells &lt;- FindVariableFeatures(sce.Bcells, <br>                            selection.method = "vst", nfeatures = 2000)  <br>sce.Bcells &lt;- ScaleData(sce.Bcells) <br>sce.Bcells &lt;- RunPCA(object = sce.Bcells, pc.genes = VariableFeatures(sce.Bcells)) <br>DimHeatmap(sce.Bcells, dims = 1:12, cells = 100, balanced = TRUE)<br>ElbowPlot(sce.Bcells)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6482889733840305" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDO3SAmfRQGA9dKYkibWDqsnrvtNtlgoQ0pMFsFuuzDbx51SbVCrZYicpw/640?wx_fmt=png" data-type="png" data-w="526" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDO3SAmfRQGA9dKYkibWDqsnrvtNtlgoQ0pMFsFuuzDbx51SbVCrZYicpw/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>sce.Bcells &lt;- FindNeighbors(sce.Bcells, dims = 1:15)  # 输入维度<br>sce.Bcells &lt;- FindClusters(sce.Bcells, resolution = 0.8)<br>table(sce.Bcells@meta.data$RNA_snn_res.0.8)  <br><br>set.seed(123)<br>sce.Bcells &lt;- RunUMAP(object = sce.Bcells, dims = 1:15, do.fast = TRUE)<br>DimPlot(sce.Bcells,reduction = "umap",label=T)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7439222042139384" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDPiaeQeSIaf100jts0OSKQz2V5Ee9JJvdaquRF8eDV0kiaDic8ayiaq7vgQ/640?wx_fmt=png" data-type="png" data-w="617" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDPiaeQeSIaf100jts0OSKQz2V5Ee9JJvdaquRF8eDV0kiaDic8ayiaq7vgQ/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.6584734799482536" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbD4bbUp39ZYpiaf0r8e6g9xR7HylpmBIvlT2fOVaYj0EkD95nLl3o4pzw/640?wx_fmt=png" data-type="png" data-w="773" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbD4bbUp39ZYpiaf0r8e6g9xR7HylpmBIvlT2fOVaYj0EkD95nLl3o4pzw/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>sce.Bcells &lt;- SetIdent(sce.Bcells, value = "seurat_clusters")<br>DotPlot(sce.Bcells, features = c("IGHD","FCER2","TCL1A","IL4R",  # naive<br>                                 "CD27",<br>                                 "AIM2","TNFRSF13B",  # memory<br>                                 "S1PI2","LRMP","SUGCT","MME","MKI67","AICDA",  # GC<br>                                 "IGHG1",  # IgG plasma cells<br>                                 "IGHA1"  # IgA plasma<br>                                 ))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5268518518518519" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDEKdPjvXa9dbBByNiadSUmJ1wL3pr3tx4LDtRXo8xSJPenUQBX3zbpVA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDEKdPjvXa9dbBByNiadSUmJ1wL3pr3tx4LDtRXo8xSJPenUQBX3zbpVA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">不光看marker表达情况，还看降维可视化（plasma和memory分不开）：</p><p data-tool="mdnice编辑器">naive 1,2,9</p><p data-tool="mdnice编辑器">memory 10,11,14,16</p><p data-tool="mdnice编辑器">GC  7,13,15,17</p><p data-tool="mdnice编辑器">IgG plasma、IgA plasma 感觉分不开，先看plasma，再往下看</p><p data-tool="mdnice编辑器">plasma CD27除memory  0,3,4,5,6,8,12</p><p data-tool="mdnice编辑器">IgG plasma、IgA plasma联系降维可视化也分不开 算了</p><pre data-tool="mdnice编辑器"><span></span><code>sce.Bcells.bp &lt;- sce.Bcells<br>celltype=data.frame(ClusterID=0:17 ,<br>                      celltype= 0:17) <br>#定义细胞亚群  <br>celltype[celltype$ClusterID %in% c( 1,2,9 ),2]='naive'   <br>celltype[celltype$ClusterID %in% c( 10,11,14,16 ),2]='memory' <br>celltype[celltype$ClusterID %in% c( 0,3,4,5,6,8,12 ),2]='plasma'   <br>celltype[celltype$ClusterID %in% c( 7,13,15,17 ),2]='GC'   <br> <br>  <br>head(celltype)<br>celltype<br>table(celltype$celltype)<br><br>sce.Bcells@meta.data$celltype = "NA"<br>  <br>for(i in 1:nrow(celltype)){<br>  sce.Bcells@meta.data[which(sce.Bcells@meta.data$RNA_snn_res.0.8 == celltype$ClusterID[i]),'celltype'] &lt;- celltype$celltype[i]}<br>Idents(sce.Bcells)=sce.Bcells$celltype<br>  <br>sel.clust = "celltype"<br>sce.Bcells &lt;- SetIdent(sce.Bcells, value = sel.clust)<br>table(sce.Bcells@active.ident)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>gplots::balloonplot(table(sce.Bcells$RNA_snn_res.0.8,sce.Bcells$celltype))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7349768875192604" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDkkxuvCTibyaGWjmqYMaZzcQVpdnnRsicibXZyiaTAoBMicuCQHYOTQuibwzA/640?wx_fmt=png" data-type="png" data-w="649" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDkkxuvCTibyaGWjmqYMaZzcQVpdnnRsicibXZyiaTAoBMicuCQHYOTQuibwzA/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>DimPlot(sce.Bcells, reduction = "umap", label = TRUE, pt.size = 0.5)+NoLegend()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6977848101265823" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDZfu5icwu64KHJDqXXqicU85W48knicNE4b0oEgmLicWibpWYSurtxzK3U3g/640?wx_fmt=png" data-type="png" data-w="632" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDZfu5icwu64KHJDqXXqicU85W48knicNE4b0oEgmLicWibpWYSurtxzK3U3g/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>先拆分后在细分B细胞时merge合并pipeline</h1><p data-tool="mdnice编辑器">前面的流程整合到函数里：</p><pre data-tool="mdnice编辑器"><span></span><code>pipeline &lt;- function(sce.obj){<br>  sce.obj<br>  sce.obj@meta.data$project &lt;- "HNSCC"<br>  sce.obj &lt;- SetIdent(sce.obj, value = "project")<br>  ## 计算细胞中线粒体基因比例<br>  sce.obj[["percent.mt"]] &lt;- PercentageFeatureSet(sce.obj, pattern = "^MT-")<br>  ## 过滤<br>  ## 官方推荐过滤掉独特特征计数超过2500或小于200的细胞，或者过滤掉超过5%线粒体基因比例的细胞<br>  sce.obj.fit &lt;- subset(sce.obj, subset = nFeature_RNA &gt; 200 &amp; nFeature_RNA &lt; 2500 &amp; percent.mt &lt; 5)<br>  ## 数据标准化<br>  sce.obj.fit &lt;- NormalizeData(sce.obj.fit, normalization.method = "LogNormalize", scale.factor = 1e4)<br>  ## 识别高变基因<br>  sce.obj.fit &lt;- FindVariableFeatures(sce.obj.fit, selection.method = "vst", nfeatures = 2000) #返回两千个高变基因<br>  #######数据归一化##########<br>  sce.obj.fit &lt;- ScaleData(sce.obj.fit, vars.to.regress = "percent.mt")<br>  ## 降维<br>  sce.obj.fit &lt;- RunPCA(sce.obj.fit, features = VariableFeatures(object = sce.obj.fit)) ##默认会输出5个主成分<br>  sce.obj.fit &lt;- FindNeighbors(sce.obj.fit, dims = 1:10)<br>  sce.obj.fit &lt;- FindClusters(sce.obj.fit, resolution = 0.8)  # 和原推文一致<br>  ## UMAP/tSNE可视化<br>  sce.obj.fit &lt;- RunUMAP(sce.obj.fit, dims = 1:10)  # Which dimensions to use as input features, used only if features is NULL<br>  p1 &lt;- DimPlot(sce.obj.fit, reduction = "umap", label = T, label.size = 5)<br>  sce.obj.fit &lt;- RunTSNE(sce.obj.fit, dims = 1:10)<br>  p2 &lt;- DimPlot(sce.obj.fit, reduction = "tsne", label = T, label.size = 5)<br>  p1+p2<br>  return(sce.obj.fit)<br>}<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>clustered.sce.list &lt;- lapply(sce.list, pipeline)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6889460154241646" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDtheOSoBw0SUCibsnsXuS2gWTiaxNxZiaoLOJsUxKQfDlH1M6AecZkJEmw/640?wx_fmt=png" data-type="png" data-w="778" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDtheOSoBw0SUCibsnsXuS2gWTiaxNxZiaoLOJsUxKQfDlH1M6AecZkJEmw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>初步分型</h2><p data-tool="mdnice编辑器">定义函数：</p><pre data-tool="mdnice编辑器"><span></span><code>dimplot &lt;- function(sce.obj.fit){<br>  sce.obj.fit<br>  ## UMAP/tSNE可视化<br>  # sce.obj.fit &lt;- RunUMAP(sce.obj.fit, dims = 1:10)  # Which dimensions to use as input features, used only if features is NULL<br>  p1 &lt;- DimPlot(sce.obj.fit, reduction = "umap", label = T, label.size = 5)<br>  # sce.obj.fit &lt;- RunTSNE(sce.obj.fit, dims = 1:10)<br>  p2 &lt;- DimPlot(sce.obj.fit, reduction = "tsne", label = T, label.size = 5)<br>  return(p1+p2)<br>}<br><br>lapply(clustered.sce.list, dimplot)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>dotplot &lt;- function(sce.obj){<br>  dp &lt;- DotPlot(sce.obj, features = c("CD3D","CD3E","CD8A",  # Tcells<br>  "CD19","CD79A","MS4A1",  # Bcells<br>  "IGHG1","MZB1","SDC1",  # Plasma cells<br>  "CD68","CD163","CD14",  # Monocytes and macrophages<br>  "FGFBP2","FCG3RA","CX3CR1",  # NK cells<br>  "EPCAM"  # epi or tumor<br>  ))+RotatedAxis()<br>  return(dp)<br>}<br>lapply(clustered.sce.list, dotplot)<br></code></pre><p data-tool="mdnice编辑器">细胞亚型注释函数</p><pre data-tool="mdnice编辑器"><span></span><code>celltype_anno &lt;- function(celltype, sce.obj){<br>  sce.obj@meta.data$celltype = "NA"<br>    <br>  for(i in 1:nrow(celltype)){<br>    sce.obj@meta.data[which(sce.obj@meta.data$RNA_snn_res.0.8 == celltype$ClusterID[i]),'celltype'] &lt;- celltype$celltype[i]}<br>  Idents(sce.obj)=sce.obj$celltype<br>    <br>  sel.clust = "celltype"<br>  sce.obj &lt;- SetIdent(sce.obj, value = sel.clust)<br>  table(sce.obj@active.ident) <br>  <br>  balloonPlot &lt;- gplots::balloonplot(table(sce.obj$RNA_snn_res.0.8,sce.obj$celltype))<br>  <br>  dimplot &lt;- DimPlot(sce.obj, reduction = "umap", label = TRUE, pt.size = 0.5)+NoLegend()<br>  <br>  balloonPlot<br>  dimplot<br>}<br></code></pre><p data-tool="mdnice编辑器">开始注释：</p><pre data-tool="mdnice编辑器"><span></span><code>lapply(clustered.sce.list, dimplot)<br>lapply(clustered.sce.list, dotplot)<br></code></pre><p data-tool="mdnice编辑器">PBL</p><pre data-tool="mdnice编辑器"><span></span><code># sce.PBL &lt;- clustered.sce.list$PBL<br>celltype=data.frame(ClusterID=0:16 ,<br>                      celltype= 0:16) <br>#定义细胞亚群  <br>celltype[celltype$ClusterID %in% c( 1,2,4,5,7,10,12 ),2]='Tcells'   <br>celltype[celltype$ClusterID %in% c( 9 ),2]='Bcells' <br>celltype[celltype$ClusterID %in% c( 15,16 ),2]='plasma'   <br>celltype[celltype$ClusterID %in% c( 0,8,11,13,14 ),2]='Mono'   <br>celltype[celltype$ClusterID %in% c( 3,6 ),2]='NK'  <br>  <br>head(celltype)<br>celltype<br>table(celltype$celltype)<br><br>celltype_anno(celltype,clustered.sce.list$PBL)<br><br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="1.243034055727554" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDD6YYiaUiaab5MdwiaZy5C0GIus6MI3nMyD0JxR4cdOOYJOYdGQtHIcHGg/640?wx_fmt=png" data-type="png" data-w="646" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDD6YYiaUiaab5MdwiaZy5C0GIus6MI3nMyD0JxR4cdOOYJOYdGQtHIcHGg/640?wx_fmt=png">T 1,2,4,5,7,10,12</p><p data-tool="mdnice编辑器">B 9</p><p data-tool="mdnice编辑器">Plasma 15,16</p><p data-tool="mdnice编辑器">Mono 0,8,11,13,14</p><p data-tool="mdnice编辑器">NK 3,6</p><p data-tool="mdnice编辑器">Unknown</p><figure data-tool="mdnice编辑器"><img data-ratio="1.0808383233532934" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDcH6ic8c0ibeSBdBZStyTw7anicXhwTbBic6ic4UWUTKsh05D2aNEdZhic7qA/640?wx_fmt=png" data-type="png" data-w="668" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDcH6ic8c0ibeSBdBZStyTw7anicXhwTbBic6ic4UWUTKsh05D2aNEdZhic7qA/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">CD45+</p><pre data-tool="mdnice编辑器"><span></span><code>celltype=data.frame(ClusterID=0:19 ,<br>                      celltype= 0:19) <br>#定义细胞亚群  <br>celltype[celltype$ClusterID %in% c( 0,1,2,3,5,6,8,9,10,11 ),2]='Tcells'   <br>celltype[celltype$ClusterID %in% c( 4,18),2]='Bcells' <br>celltype[celltype$ClusterID %in% c( 14,15 ),2]='plasma'   <br>celltype[celltype$ClusterID %in% c( 7,12,16,17,19 ),2]='Mono'   <br>celltype[celltype$ClusterID %in% c( 13 ),2]='NK'  <br>  <br>head(celltype)<br>celltype<br>table(celltype$celltype)<br><br>celltype_anno(celltype,clustered.sce.list$`CD45+`)<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.287962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDBbq3O91jojE9P0qt3ibicZRIbILgSxeEVfPCKWZ1OH1DtgzwCEhKKI8A/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDBbq3O91jojE9P0qt3ibicZRIbILgSxeEVfPCKWZ1OH1DtgzwCEhKKI8A/640?wx_fmt=png">T 0,1,2,3,5,6,8,9,10,11</p><p data-tool="mdnice编辑器">B 4,18</p><p data-tool="mdnice编辑器">Plasma 14,15</p><p data-tool="mdnice编辑器">Mono 7,12,16,17,19</p><p data-tool="mdnice编辑器">NK 13</p><p data-tool="mdnice编辑器">Unknown</p><figure data-tool="mdnice编辑器"><img data-ratio="1.1904047976011993" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDOWaTBew7nHTdib5iayUaMXYp6qibHmT0iaPCOqyBSKiavqSibADmRzIsl1Xw/640?wx_fmt=png" data-type="png" data-w="667" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDOWaTBew7nHTdib5iayUaMXYp6qibHmT0iaPCOqyBSKiavqSibADmRzIsl1Xw/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">CD45-</p><pre data-tool="mdnice编辑器"><span></span><code>celltype=data.frame(ClusterID=0:19 ,<br>                      celltype= 0:19) <br>#定义细胞亚群  <br>celltype[celltype$ClusterID %in% c(4,5,6,7 ),2]='Tcells'   <br>celltype[celltype$ClusterID %in% c( 8),2]='Bcells' <br>celltype[celltype$ClusterID %in% c( 1,2,10,11,12,14,16 ),2]='plasma'   <br>celltype[celltype$ClusterID %in% c(9,17,18),2]='Mono'   <br>celltype[celltype$ClusterID %in% c( 3,15,19 ),2]='Unknown'  <br>  <br>head(celltype)<br>celltype<br>table(celltype$celltype)<br><br>celltype_anno(celltype,clustered.sce.list$`CD45-`)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.231012658227848" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDqNTIMibX7e54bScaKABukq7zkDmpAIH56FmWsGWpZuFLmrlf44ricO1Q/640?wx_fmt=png" data-type="png" data-w="632" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDqNTIMibX7e54bScaKABukq7zkDmpAIH56FmWsGWpZuFLmrlf44ricO1Q/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">T 4,5,6,7</p><p data-tool="mdnice编辑器">B 8</p><p data-tool="mdnice编辑器">Plasma 1,2,10,11,12,14,16</p><p data-tool="mdnice编辑器">Mono 9,17,18</p><p data-tool="mdnice编辑器">NK</p><p data-tool="mdnice编辑器">Unknown 3,15,19</p><blockquote data-tool="mdnice编辑器"><p>个人感觉：拆分后初步判断亚型比整合一起好区分，Unknown少</p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="1.0892307692307692" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDyBIgTPdDDiaVN9zibNkbPibibAobVkW0Qf0yPIeWianooIAVHvC0BGdAIkw/640?wx_fmt=png" data-type="png" data-w="650" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDyBIgTPdDDiaVN9zibNkbPibibAobVkW0Qf0yPIeWianooIAVHvC0BGdAIkw/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span>将3sampletype分组各B细胞合并</h2><p data-tool="mdnice编辑器">sce.Bcells=sce.all.fit[,sce.all.fit$celltype=='Bcells']</p><pre data-tool="mdnice编辑器"><span></span><code>sce.Bcells1 &lt;- clustered.sce.list$PBL[,clustered.sce.list$PBL$seurat_clusters == 9]<br>sce.Bcells2 &lt;- clustered.sce.list$`CD45+`[,clustered.sce.list$`CD45+`$seurat_clusters %in% c(4,18)]<br>sce.Bcells3 &lt;- clustered.sce.list$`CD45-`[,clustered.sce.list$`CD45-`$seurat_clusters == 8]<br><br>sce.Bcells.all &lt;- merge(x=sce.Bcells1,<br>              y=list(sce.Bcells2,sce.Bcells3),<br>              # add.cell.ids =  gsub('^GSM[0-9]*_','',samples),<br>              add.cell.ids =  c("sce.Bcells1", "sce.Bcells2", "sce.Bcells3"))<br><br>sce.Bcells.all=CreateSeuratObject(counts = sce.Bcells.all@assays$RNA@counts,<br>                       meta.data = sce.Bcells@meta.data[,1:7])<br></code></pre><p data-tool="mdnice编辑器">这一步merge时如果不add.cell.ids会报错：Error in merge.Seurat(x = sce.Bcells1, y = list(sce.Bcells2, sce.Bcells3), :Please provide a cell identifier for each object provided to merge</p><figure data-tool="mdnice编辑器"><img data-ratio="0.2537037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDq0XKhDs0DcNgaqztVKkJGhdRYoVqRe3XwzRjnd7w2TuBCnhB2edhTg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDq0XKhDs0DcNgaqztVKkJGhdRYoVqRe3XwzRjnd7w2TuBCnhB2edhTg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">此外，还需要注意：</p><p data-tool="mdnice编辑器">参考</p><blockquote data-tool="mdnice编辑器"><p><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247514451&amp;idx=1&amp;sn=c33bfd7bab912935a11ac51d511f3c95&amp;chksm=ea1cbfd1dd6b36c70b516ad0a63b27420756a0457952b971a01e1a18cb75d7d7f8b4a4050813&amp;scene=21&amp;cur_album_id=3019915773533913092#wechat_redirect" data-linktype="2">Seurat对象内部结构</a><img data-ratio="0.5851851851851851" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDh3WWr0yVFsz4Ib8OHlmHRd97s8ic8yRcYjrbwQkeMfwiaLUntbRCWa6A/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDh3WWr0yVFsz4Ib8OHlmHRd97s8ic8yRcYjrbwQkeMfwiaLUntbRCWa6A/640?wx_fmt=png"></p></blockquote><p data-tool="mdnice编辑器"><strong>所以需要把counts提出来再重新创建一个Seurat对象：</strong></p><pre data-tool="mdnice编辑器"><span></span><code>sce.Bcells.all=CreateSeuratObject(counts = sce.Bcells.all@assays<span>$RNA</span>@counts,<br>                       meta.data = sce.Bcells@meta.data[,1:7])<br></code></pre><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span>Bcells细分</h2><pre data-tool="mdnice编辑器"><span></span><code>sce.Bcells.all &lt;- NormalizeData(sce.Bcells.all, normalization.method =  "LogNormalize",  <br>                     scale.factor = 1e4)<br>GetAssay(sce.Bcells.all,assay = "RNA")<br>sce.Bcells.all &lt;- FindVariableFeatures(sce.Bcells.all, <br>                            selection.method = "vst", nfeatures = 2000)  <br>sce.Bcells.all &lt;- ScaleData(sce.Bcells.all) <br>sce.Bcells.all &lt;- RunPCA(object = sce.Bcells.all, pc.genes = VariableFeatures(sce.Bcells.all)) <br>DimHeatmap(sce.Bcells.all, dims = 1:12, cells = 100, balanced = TRUE)<br>ElbowPlot(sce.Bcells.all)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>sce.Bcells.all &lt;- FindNeighbors(sce.Bcells.all, dims = 1:15)  # 输入维度<br>sce.Bcells.all &lt;- FindClusters(sce.Bcells.all, resolution = 0.8)<br>table(sce.Bcells.all@meta.data$RNA_snn_res.0.8)  <br><br>set.seed(123)<br>sce.Bcells.all &lt;- RunUMAP(object = sce.Bcells.all, dims = 1:15, do.fast = TRUE)<br>DimPlot(sce.Bcells.all,reduction = "umap",label=T)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6815476190476191" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDaQ70iay5ZAzU4Of5Let3MBVe0dPEKDQsPgqapxp1CuGbvCXAF6ibZncw/640?wx_fmt=png" data-type="png" data-w="672" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDaQ70iay5ZAzU4Of5Let3MBVe0dPEKDQsPgqapxp1CuGbvCXAF6ibZncw/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>sce.Bcells.all &lt;- SetIdent(sce.Bcells.all, value = "seurat_clusters")<br>DotPlot(sce.Bcells.all, features = c("IGHD","FCER2","TCL1A","IL4R",  # naive<br>                                 "CD27",<br>                                 "AIM2","TNFRSF13B",  # memory<br>                                 "S1PI2","LRMP","SUGCT","MME","MKI67","AICDA",  # GC<br>                                 "IGHG1",  # IgG plasma cells<br>                                 "IGHA1"  # IgA plasma<br>                                 ))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5601851851851852" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDAia4TcLtHPRtfybxmTibIUFHkPxIrkrKos0fEI95Qia2Wd8rbH3ZKicfQQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDAia4TcLtHPRtfybxmTibIUFHkPxIrkrKos0fEI95Qia2Wd8rbH3ZKicfQQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">不光看marker表达情况，还看降维可视化（plasma和memory分不开）：</p><p data-tool="mdnice编辑器">naive 1,2,8</p><p data-tool="mdnice编辑器">memory  0,3,4,5,6,10,</p><p data-tool="mdnice编辑器">GC  9,12,14,17</p><p data-tool="mdnice编辑器">plasma CD27除memory  7,11,13,15,16,18</p><p data-tool="mdnice编辑器">(7因为15很像特别是纠结的CD27所以给plasma)</p><pre data-tool="mdnice编辑器"><span></span><code>sce.Bcells.all.bp &lt;- sce.Bcells.all<br>celltype=data.frame(ClusterID=0:18 ,<br>                      celltype= 0:18) <br>#定义细胞亚群  <br>celltype[celltype$ClusterID %in% c( 1,2,8 ),2]='naive'   <br>celltype[celltype$ClusterID %in% c( 0,3,4,5,6,10 ),2]='memory' <br>celltype[celltype$ClusterID %in% c( 7,11,13,15,16,18 ),2]='plasma'   <br>celltype[celltype$ClusterID %in% c( 9,12,14,17 ),2]='GC'   <br> <br>  <br>head(celltype)<br>celltype<br>table(celltype$celltype)<br><br>sce.Bcells.all@meta.data$celltype = "NA"<br>  <br>for(i in 1:nrow(celltype)){<br>  sce.Bcells.all@meta.data[which(sce.Bcells.all@meta.data$RNA_snn_res.0.8 == celltype$ClusterID[i]),'celltype'] &lt;- celltype$celltype[i]}<br>Idents(sce.Bcells.all)=sce.Bcells.all$celltype<br>  <br>sel.clust = "celltype"<br>sce.Bcells.all &lt;- SetIdent(sce.Bcells.all, value = sel.clust)<br>table(sce.Bcells.all@active.ident)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>gplots::balloonplot(table(sce.Bcells.all$RNA_snn_res.0.8,sce.Bcells.all$celltype))<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>DimPlot(sce.Bcells.all, reduction = "umap", label = TRUE, pt.size = 0.5)+NoLegend()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.0807174887892377" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDpUG8ZMQIDLgB6pL1sf3FVTO19VaBbEVEYibwm2gCvmmqahT2tIU210g/640?wx_fmt=png" data-type="png" data-w="669" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDpUG8ZMQIDLgB6pL1sf3FVTO19VaBbEVEYibwm2gCvmmqahT2tIU210g/640?wx_fmt=png"></figure><h1 data-tool="mdnice编辑器"><span></span>两套pipelines B细胞划分结果列联分析</h1><pre data-tool="mdnice编辑器"><span></span><code>sce.Bcells.all$celltype %&gt;% head()<br>sce.Bcells$celltype %&gt;% head()<br></code></pre><p data-tool="mdnice编辑器">修改names</p><pre data-tool="mdnice编辑器"><span></span><code>ls &lt;- sce.Bcells.all$celltype %&gt;% names() %&gt;% str_split_fixed("_",3)<br>tmp &lt;- sce.Bcells.all$celltype<br>names(tmp) &lt;- paste(ls[,2],ls[,3],sep = "_")<br><br>tmp %&gt;% head()<br>sce.Bcells$celltype %&gt;% head()<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>keep &lt;- intersect(names(tmp), names(sce.Bcells$celltype))<br>gplots::balloonplot(table(tmp[keep], sce.Bcells$celltype[keep]))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5673624288425048" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDBUUMqeibUf4CibInvUUW56E8aWpiaFDeaYiaiaSx0uzQCUfEt430zXgRvMQ/640?wx_fmt=png" data-type="png" data-w="527" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDBUUMqeibUf4CibInvUUW56E8aWpiaFDeaYiaiaSx0uzQCUfEt430zXgRvMQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">可以发现我这里plasma和memory在拆分前后存在非常大变化，基本上就是exchange了。。。其它的还行</p><p data-tool="mdnice编辑器">这跟我选择的marker和自定义分组也有关，这两个在亚型定义的时候就不是很好区分（我的技术也不好，肉眼看这个我目前感觉有点反人类，后面我了解到一些辅助确定亚群名称的方法，如AUcell、MACA、scGate【flag】）</p><p data-tool="mdnice编辑器">原推文小韩师姐的结果就没这么明显的exchange：</p><blockquote data-tool="mdnice编辑器"><figure><img data-ratio="0.4546296296296296" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDyQE8tsK7bw2cKIebWq7vcq19WLDJIjgGzdyJYsfow4l5WFf5fzOFPQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRCsSaLfHCzsKuFjOh7WfbDyQE8tsK7bw2cKIebWq7vcq19WLDJIjgGzdyJYsfow4l5WFf5fzOFPQ/640?wx_fmt=png"></figure><p>因此，来回答开头提出的问题，从该组数据对比来看，多分组单细胞测序数据第一层次未整合和整合分析对B细胞细分的分群基本无影响。</p></blockquote><p data-tool="mdnice编辑器">这里因为原推文相当于就拿两种方法处理好的结果可视化看看列联表，具体参数和使用marker未知。</p></section><section><section data-style-type="5" data-tools="新媒体排版" data-id="2440476"><section><section><section><section><img data-ratio="0.9495798319327731" data-src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif" data-type="gif" data-w="119" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif"></section><section data-brushtype="text">往期回顾</section><section><br></section></section></section></section><section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515528&amp;idx=1&amp;sn=0e7ae1c1981bed1c50fd38ee89548598&amp;chksm=ea1cbb0add6b321cde1a5bd2b592c92d673d29b9ed3a740dec3b3b8b9684b606b4723fc073bb&amp;scene=21#wechat_redirect" textvalue="2013-2023年度技术十年 | 单细胞的群星闪耀时" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>2013-2023年度技术十年 | 单细胞的群星闪耀时</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515486&amp;idx=1&amp;sn=8843633037afc6e5f375d3433465db73&amp;chksm=ea1cbbdcdd6b32ca66bafc6e30e38209222605a65e55eb73ac3acc27657364eb5765959a3d84&amp;scene=21#wechat_redirect" textvalue="Libra：单细胞差异分析算法的全家桶" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>Libra：单细胞差异分析算法的全家桶</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515454&amp;idx=1&amp;sn=9baf3f82940d8cb2685bc140122fb686&amp;chksm=ea1cbbbcdd6b32aad5953a0d0e80766f0ec50e232c2df6208b8f2c340ff0f04a9a2c54a20726&amp;scene=21#wechat_redirect" textvalue="harmony、不harmony，这是个问题" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>harmony、不harmony，这是个问题</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515453&amp;idx=1&amp;sn=f40ed42113ad6550cfe7569ea01a3965&amp;chksm=ea1cbbbfdd6b32a9931f234fbfb5a2aeb5497af145500c7b96733a546a38603d76dec950d063&amp;scene=21#wechat_redirect" textvalue="NK细胞的单细胞层面细分亚群" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>NK细胞的单细胞层面细分亚群</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515439&amp;idx=1&amp;sn=fdfcf89ec937c27ec4727f166d508630&amp;chksm=ea1cbbaddd6b32bb1beeb51934efeeadbc0ec46cc4d5d0bf146799a5ba36bb94da697f1965c6&amp;scene=21#wechat_redirect" textvalue="被忽视的真相 | 细胞亚群内互作" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>被忽视的真相 | 细胞亚群内互作</span></a><br></p></section></section><hr><p><br></p></section><section data-style-type="5" data-tools="新媒体排版" data-id="2440475"><hr><p><br></p><hr><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524240&amp;idx=1&amp;sn=94c9ef8c3d8080c30c8372d4fb5999ab&amp;chksm=9b4bdf2bac3c563def9232bb78f43bcaa13d7c3442b00cf83aaa32ae98f4500883fa8803fb98&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课9月班" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信入门&amp;数据挖掘线上直播课9月班</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">时隔5年，我们的生信技能树VIP学徒继续招生啦</a><br></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">千呼万唤始出来的独享生物信息学云服务器</a></p></li></ul><p><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-id="93668"><section><section data-width="95%"><section><section><section data-width="38%"><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg" data-type="other" data-w="258" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/9FdbU-MuUvDSL49s-yk6vQ",target="_blank" rel="noopener noreferrer">原文链接</a>
