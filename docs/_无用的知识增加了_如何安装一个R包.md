---
title: "【无用的知识增加了】如何安装一个R包"
date: 2022-12-11T13:30:50Z
draft: ["false"]
tags: [
  "fetched",
  "果子学生信"
]
categories: ["Acdemic"]
---
【无用的知识增加了】如何安装一个R包 by 果子学生信
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">太长不看版</p><ul data-tool="mdnice编辑器"><li><section>magick的安装需要底层的imagemagick支持</section></li><li><section>Ubuntu16.04由于版本老旧，安装的旧版imagemagick无法使用</section></li><li><section>使用spack自己安装新版，可以解决编译问题。</section></li></ul><p data-tool="mdnice编辑器">果子老师向我求助，让我帮忙安装一个R包, magick。这个R包，我在自己的CentOS系统的服务器上安装过，在我的Mac上装过，我觉得应该不是个大问题。</p><p data-tool="mdnice编辑器">然而，从最后我所花的时间来看，这确实是个大问题，因为这是果子老师提出的问题，但凡是他提出的问题，他肯定是前期花了点时间的，也就是常规的路子都走过了，实在没法子才来找我出手。</p><p data-tool="mdnice编辑器">这个信息的报错消息如下</p><pre data-tool="mdnice编辑器"><span></span><code>magick.so: undefined symbol: _ZNK6Magick8GeometrycvNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEEv<br></code></pre><p data-tool="mdnice编辑器">我通过检索，发现有人通过设置<code>~/.R/Makevars</code>里的C++配置解决过</p><pre data-tool="mdnice编辑器"><span></span><code>CXX11=/usr/bin/g++<br></code></pre><p data-tool="mdnice编辑器">但是，我测试过了这个方法，并不可行。不过，在这个思路下，我有两个猜测</p><ul data-tool="mdnice编辑器"><li><section>R语言版本或许要最新版4.2.2，这是最简单的思路。很大一部分问题都可以通过升级R来解决。</section></li><li><section>GCC版本低，无法提供magick所要求的库。</section></li></ul><p data-tool="mdnice编辑器">对于第一个猜想，我编译了最新R4.2.2, 但是发现并不是原因。</p><p data-tool="mdnice编辑器">对于第二个猜想，我得编译一个gcc，这个我在2018年的【无root权限下解决编译时的依赖问题】中介绍过，但是那个操作太复杂了，现如今可以考虑用spack(https://spack.io/)。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 关于spack的安装和使用，不在此文介绍</span><br>spack install gcc<br>spack load gcc<br></code></pre><p data-tool="mdnice编辑器">但是，基于最新的GCC去编译R包依旧不行，甚至，基于最新的GCC编译的最新的R也不行。此时，我的心态有点暴躁，于是，我想着要不要就不在这台服务器上编译了，用另一台Ubuntu服务器编译好，复制过来不就好了吗？</p><p data-tool="mdnice编辑器">但是，由于两台机子的Ubuntu版本不同，结果有依赖库的问题</p><pre data-tool="mdnice编辑器"><span></span><code>错误: package or namespace load failed <span>for</span> ‘magick’ <span>in</span> dyn.load(file, DLLpath = DLLpath, <span>...</span>):<br> 无法载入共享目标对象‘/home/xzg/R/x86_64-pc-linux-gnu-<span>library</span>/<span>4.2</span>/magick/libs/magick.so’：:<br>  libMagick++-<span>6.</span>Q16.so.8: cannot open shared object file: No such file or directory<br><br></code></pre><p data-tool="mdnice编辑器">这个情况，有一种偷懒的方式，就是用ln 做了软连接</p><pre data-tool="mdnice编辑器"><span></span><code>ln -s   /usr/lib/x86_64-linux-gnu/libMagick++-6.Q16.so /usr/lib/x86_64-linux-gnu/libMagick++-6.Q16.so.8  <br></code></pre><p data-tool="mdnice编辑器">然而，依旧报错（好消息不是之前的错误）</p><pre data-tool="mdnice编辑器"><span></span><code>  /home/xzg/R/x86_64-pc-linux-gnu-<span>library</span>/<span>4.2</span>/magick/libs/magick.so: <br>  undefined symbol: _ZN6Magick5Image10fontWeightEm<br></code></pre><p data-tool="mdnice编辑器">尽管失败了，但是我有了一个新的猜想， 那就是系统自带的Magick的版本低了。有没有一种可能，在R里，我安装旧版本的magick就可以避免这个问题呢？于是，我找到了它的历史存档 https://cran.r-project.org/src/contrib/Archive/magick/，从1.0测试到2.6 ，无一成功。</p><p data-tool="mdnice编辑器">好吧，这条路也走不通，那我只能去编译一个最新的imagemagick</p><pre data-tool="mdnice编辑器"><span></span><code>spack install imagemagick<br>spack load imagemagick<br><br><span># 动态库，没有这行命令，编译过程最后一步还是失败</span><br><span>export</span> LD_LIBRARY_PATH=/home/xzg/spack/opt/spack/linux-ubuntu18.04-skylake_avx512/gcc-7.5.0/imagemagick-7.0.8-7-663acxuiasjhkjxymveygisoduukdmpa/lib:<span>$LD_LIBRARY_PATH</span><br><br></code></pre><p data-tool="mdnice编辑器">然后安装magick，终于这条路成功了！</p><p data-tool="mdnice编辑器">终于，我可以断定，果子老师之所以安装不了magick是因为它的Ubuntu系统里没有安装最新的imagemagick底层库。之所以，他没法用下面的语句安装最新的imagemagick底层库，是因为它用的是16.04版本Ubuntu。</p><pre data-tool="mdnice编辑器"><span></span><code>sudo apt-get update<br>sudo apt-get install -y libmagick++-dev<br></code></pre><p data-tool="mdnice编辑器">不过，问题还是没有顺利的解决，因为我们希望这个包是给所有人用的，而非自己用。</p><p data-tool="mdnice编辑器">有两种方法，一种是让其他用户添加一个环境变量，LD_LIBRARY_PATH。</p><p data-tool="mdnice编辑器">另一种方式，当你是root用户，你就可以在 <code>/etc/ld.so.conf.d/</code>里加上一个配置文件，比如说我的是，imagemagick-7.0.8-7-663.conf，里面是lib路径</p><pre data-tool="mdnice编辑器"><span></span><code>/home/xzg/spack/opt/spack/linux-ubuntu18.04-skylake_avx512/gcc-7.5.0/imagemagick-7.0.8-7-663acxuiasjhkjxymveygisoduukdmpa/lib<br></code></pre><p data-tool="mdnice编辑器">然后调用<code>ldconfig</code> 让配置生效，就可以让我们自己编译的动态库变成系统级。</p><p data-tool="mdnice编辑器">故事到这里基本就结束了，只有最后一个小插曲，那就是果子老师最终目标是安装spatialLIBD</p><pre data-tool="mdnice编辑器"><span></span><code>BiocManager::install(<span>"spatialLIBD"</span>)<br></code></pre><p data-tool="mdnice编辑器">但是安装过程中,另一个R包textshaping出错，提示信息如下</p><pre data-tool="mdnice编辑器"><span></span><code>--------------------------- [ANTICONF] --------------------------------<br>Configuration failed to find the harfbuzz freetype2 fribidi library. Try installing:<br> * deb: libharfbuzz-dev libfribidi-dev (Debian, Ubuntu, etc)<br> * rpm: harfbuzz-devel fribidi-devel (Fedora, EPEL)<br> * csw: libharfbuzz_dev libfribidi_dev (Solaris)<br> * brew: harfbuzz fribidi (OSX)<br>If harfbuzz freetype2 fribidi is already installed, check that <span>'pkg-config'</span> is <span>in</span> your<br>PATH and PKG_CONFIG_PATH contains a harfbuzz freetype2 fribidi.pc file. If pkg-config<br>is unavailable you can <span>set</span> INCLUDE_DIR and LIB_DIR manually via:<br>R CMD INSTALL --configure-vars=<span>'INCLUDE_DIR=... LIB_DIR=...'</span><br>-------------------------- [ERROR MESSAGE] ---------------------------<br>&lt;stdin&gt;:1:10: fatal error: hb-ft.h: No such file or directory<br>compilation terminated.<br>--------------------------------------------------------------------<br>ERROR: configuration failed <span>for</span> package ‘textshaping’<br>* removing ‘/opt/R-4.2.1/lib/R/library/textshaping’<br></code></pre><p data-tool="mdnice编辑器">其实解决思路很简单，也就是用 <code>apt install libharfbuzz-dev libfribidi-dev</code>去安装这个依赖就好。然而，没有那么顺利</p><pre data-tool="mdnice编辑器"><span></span><code>下列软件包有未满足的依赖关系：<br> libfribidi-dev : 依赖: libfribidi0 (= 0.19.7-1) 但是 0.19.7-2 正要被安装<br>E: 无法修正错误，因为您要求某些软件包保持现状，就是它们破坏了软件包间的依赖关系<br></code></pre><p data-tool="mdnice编辑器">不过，无所谓了，我直接用 spack自己装一份fribidi就好了。</p><p data-tool="mdnice编辑器">参考资料</p><ul data-tool="mdnice编辑器"><li><section>https://github.com/ropensci/magick/issues/300</section></li></ul></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Cb5MEsThcXNDXCFrE3spsg",target="_blank" rel="noopener noreferrer">原文链接</a>
