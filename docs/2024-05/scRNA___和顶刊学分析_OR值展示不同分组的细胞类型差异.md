---
title: "scRNA | 和顶刊学分析，OR值展示不同分组的细胞类型差异"
date: 2024-05-29T03:15:52Z
draft: ["false"]
tags: [
  "fetched",
  "生信补给站"
]
categories: ["Acdemic"]
---
scRNA | 和顶刊学分析，OR值展示不同分组的细胞类型差异 by 生信补给站
------
<div><p><span>在对单细胞数据进行注释后，通常会使用柱形图比较 不同分组 之间的cluster/celltype差异 <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650399486&amp;idx=1&amp;sn=f8dbab56a677525e45548096d88d90df&amp;chksm=f01c801ec76b09085154e34918f1c276b485a8a87a86686fb67b30eae32e78605f00153bf926&amp;scene=21#wechat_redirect" textvalue="scRNA分析|单细胞文献Fig1中的分组umap图和细胞比例柱形图" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">scRNA分析|单细胞文献Fig1中的分组umap图和细胞比例柱形图</a>，本文介绍张老师2021年发表于SCIENCE的Pan-cancer single-cell landscape of tumor-infiltrating T cells 文献中OR比值的方法（<span>OR&gt;1.5标示倾向在该分组中分布，OR&lt;0.5标示不倾向在该分组中分布，详见文献methods</span>），来</span><span><span>比较不同分组（正常组织，肿瘤组织，PBMC，用药前后等）间</span><span>cluster/celltype</span><span>之间的分布差异 。该方法在越来越多的文献中出现。</span></span><ne-clipboard source="https%3A%2F%2Fwww.yuque.com%2Fxiyoudonghang%2Fvu7d83%2Frwmarhcm9gqletnc"></ne-clipboard></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section><section mpa-from-tpl="t"><p><span><span>一 载入R包，</span>数据</span></p></section></section></section></section></section><p><br></p><p><span><strong>1 ，载入必要的R包</strong></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="cpp"><code><span>#remotes::install_github("Japrin/sscVis")</span></code><code><span>library("sscVis")</span></code><code><span>library("data.table")</span></code><code><span>library("grid")</span></code><code><span>library("cowplot")</span></code><code><span>library("ggrepel")</span></code><code><span>library("readr")</span></code><code><span>library("plyr")</span></code><code><span>library("ggpubr")</span></code><code><span>library("tidyverse")</span></code><code><span>library(viridis)</span></code><code><span>library(Seurat)</span></code><code><span>library(pheatmap)</span></code></pre></section><h3><span><strong>2，载入函数</strong></span></h3><p><span>这里使用24年NG文献<span>Multi-omic profiling of clear cell renal cell carcinoma identifies metabolic reprogramming associated with disease progression中</span>提供的OR分析的2个主函数</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="swift"><code><span>do.tissueDist &lt;- function(cellInfo.tb = cellInfo.tb,</span></code><code><span>                          meta.cluster = cellInfo.tb$meta.cluster,</span></code><code><span>                          colname.patient = "patient",</span></code><code><span>                          loc = cellInfo.tb$loc,</span></code><code><span>                          out.prefix,</span></code><code><span>                          pdf.width=3,</span></code><code><span>                          pdf.height=5,</span></code><code><span>                          verbose=0){</span></code><code><span>  ##input data </span></code><code><span>  library(data.table)</span></code><code><span>  dir.create(dirname(out.prefix),F,T)</span></code><code><span><br></span></code><code><span>  cellInfo.tb = data.table(cellInfo.tb)</span></code><code><span>  cellInfo.tb$meta.cluster = as.character(meta.cluster)</span></code><code><span><br></span></code><code><span>  if(is.factor(loc)){</span></code><code><span>    cellInfo.tb$loc = loc</span></code><code><span>  }else{cellInfo.tb$loc = as.factor(loc)}</span></code><code><span><br></span></code><code><span>  loc.avai.vec &lt;- levels(cellInfo.tb[["loc"]])</span></code><code><span>  count.dist &lt;- unclass(cellInfo.tb[,table(meta.cluster,loc)])[,loc.avai.vec]</span></code><code><span>  freq.dist &lt;- sweep(count.dist,1,rowSums(count.dist),"/")</span></code><code><span>  freq.dist.bin &lt;- floor(freq.dist * 100 / 10)</span></code><code><span>  print(freq.dist.bin)</span></code><code><span><br></span></code><code><span>  {</span></code><code><span>    count.dist.melt.ext.tb &lt;- test.dist.table(count.dist)</span></code><code><span>    p.dist.tb &lt;- dcast(count.dist.melt.ext.tb,rid~cid,value.var="p.value")</span></code><code><span>    OR.dist.tb &lt;- dcast(count.dist.melt.ext.tb,rid~cid,value.var="OR")</span></code><code><span>    OR.dist.mtx &lt;- as.matrix(OR.dist.tb[,-1])</span></code><code><span>    rownames(OR.dist.mtx) &lt;- OR.dist.tb[[1]]</span></code><code><span>  }</span></code><code><span><br></span></code><code><span>  sscVis::plotMatrix.simple(OR.dist.mtx,</span></code><code><span>                            out.prefix=sprintf("%s.OR.dist",out.prefix),</span></code><code><span>                            show.number=F,</span></code><code><span>                            waterfall.row=T,par.warterfall = list(score.alpha = 2,do.norm=T),</span></code><code><span>                            exp.name=expression(italic(OR)),</span></code><code><span>                            z.hi=4,</span></code><code><span>                            palatte=viridis::viridis(7),</span></code><code><span>                            pdf.width = 4, pdf.height = pdf.height)</span></code><code><span>  if(verbose==1){</span></code><code><span>    return(list("count.dist.melt.ext.tb"=count.dist.melt.ext.tb,</span></code><code><span>                "p.dist.tb"=p.dist.tb,</span></code><code><span>                "OR.dist.tb"=OR.dist.tb,</span></code><code><span>                "OR.dist.mtx"=OR.dist.mtx))</span></code><code><span>  }else{</span></code><code><span>    return(OR.dist.mtx)</span></code><code><span>  }</span></code><code><span>}</span></code><code><span><br></span></code><code><span>test.dist.table &lt;- function(count.dist,min.rowSum=0)</span></code><code><span>{</span></code><code><span>  count.dist &lt;- count.dist[rowSums(count.dist)&gt;=min.rowSum,,drop=F]</span></code><code><span>  sum.col &lt;- colSums(count.dist)</span></code><code><span>  sum.row &lt;- rowSums(count.dist)</span></code><code><span>  count.dist.tb &lt;- as.data.frame(count.dist)</span></code><code><span>  setDT(count.dist.tb,keep.rownames=T)</span></code><code><span>  count.dist.melt.tb &lt;- melt(count.dist.tb,id.vars="rn")</span></code><code><span>  colnames(count.dist.melt.tb) &lt;- c("rid","cid","count")</span></code><code><span>  count.dist.melt.ext.tb &lt;- as.data.table(ldply(seq_len(nrow(count.dist.melt.tb)), function(i){</span></code><code><span>    this.row &lt;- count.dist.melt.tb$rid[i]</span></code><code><span>    this.col &lt;- count.dist.melt.tb$cid[i]</span></code><code><span>    this.c &lt;- count.dist.melt.tb$count[i]</span></code><code><span>    other.col.c &lt;- sum.col[this.col]-this.c</span></code><code><span>    this.m &lt;- matrix(c(this.c,</span></code><code><span>                       sum.row[this.row]-this.c,</span></code><code><span>                       other.col.c,</span></code><code><span>                       sum(sum.col)-sum.row[this.row]-other.col.c),</span></code><code><span>                     ncol=2)</span></code><code><span>    res.test &lt;- fisher.test(this.m)</span></code><code><span>    data.frame(rid=this.row,</span></code><code><span>               cid=this.col,</span></code><code><span>               p.value=res.test$p.value,</span></code><code><span>               OR=res.test$estimate)</span></code><code><span>  }))</span></code><code><span>  count.dist.melt.ext.tb &lt;- merge(count.dist.melt.tb,count.dist.melt.ext.tb,</span></code><code><span>                                  by=c("rid","cid"))</span></code><code><span>  count.dist.melt.ext.tb[,adj.p.value:=p.adjust(p.value,"BH")]</span></code><code><span>  return(count.dist.melt.ext.tb)</span></code><code><span>}</span></code></pre></section><p><span>该分析只需要 <strong>分组信息</strong> 和 <strong><span>cluster/celltype</span></strong>结果 ，也就是meta.data 中的两列信息。</span></p><section data-mpa-template="t" mpa-from-tpl="t"><section mpa-from-tpl="t"><section><section mpa-from-tpl="t"><p><span>二 OR分析</span></p></section></section></section></section><p><span><br></span></p><p><span><strong><span>1，载入单细胞数据</span></strong></span></p><p><span><span>仍然使用之前的sce2数据，为减少计算量提取Myeloid亚群做示例 ，注意该分析 需要</span><strong>不同分组</strong><span> 的 </span><strong><span>cluster/celltype</span></strong><span>细胞数<span><strong>均不为 0</strong></span>。</span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="cs"><code><span>load("sce.anno.RData")</span></code><code><span>sce.Mye &lt;- subset(sce2,celltype %in% c("Myeloid" ) )</span></code><code><span>sce.Mye &lt;- NormalizeData(sce.Mye)</span></code><code><span>sce.Mye &lt;- FindVariableFeatures(sce.Mye, selection.method = "vst", nfeatures = 2000)</span></code><code><span>sce.Mye &lt;- ScaleData(sce.Mye)</span></code><code><span>sce.Mye &lt;- RunPCA(sce.Mye, npcs = 20)</span></code><code><span>#标准流程，参数不变</span></code><code><span>sce.Mye &lt;- sce.Mye %&gt;% </span></code><code><span>  RunUMAP(dims = 1:20) %&gt;% </span></code><code><span>  FindNeighbors(dims = 1:20) %&gt;% </span></code><code><span>  FindClusters(resolution = c(0.05, 0.1,0.2,0.4,0.5)) </span></code><code><span>DimPlot(sce.Mye, group.by = "RNA_snn_res.0.2",label = F)</span></code><code><span><br></span></code><code><span>table(sce.Mye$group ,sce.Mye$RNA_snn_res.0.2)</span></code><code><span>#        0   1   2   3   4   5</span></code><code><span>#  MET   9   4  10 162 156   7</span></code><code><span>#  PT  588 399 205  21  19  35</span></code></pre></section><h3><span><strong>2，计算OR值</strong></span></h3><p><span>由于do.tissueDist函数限定了meta.cluster = cellInfo.tb$meta.cluster, loc = cellInfo.tb$loc, 为减少报错 <strong><span>建议修改我们输入矩阵的名字来适配函数</span></strong> 。</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>meta &lt;- sce.Mye@meta.data</span></code><code><span># 修改名字</span></code><code><span>meta$loc &lt;- meta$group</span></code><code><span>meta$meta.cluster &lt;- meta$RNA_snn_res.0.2</span></code><code><span># 指定输出文件路径及前缀</span></code><code><span>out.prefix &lt;- "./Fig_OR"</span></code><code><span><br></span></code><code><span>#主分析函数</span></code><code><span>OR.immune.list &lt;- do.tissueDist(cellInfo.tb=meta,</span></code><code><span>                                out.prefix=sprintf("%s.Immune_cell",out.prefix),</span></code><code><span>                                pdf.width=4,pdf.height=8,verbose=1</span></code><code><span>)</span></code></pre></section><p><img data-imgfileid="502918479" data-ratio="1.317829457364341" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjCicQGgdA5oXPk9VJpKtqV3tA6Eu7Xl5FjvPoNibYP821olRo8eOHDkaUBGChPgvliaI3icMyFLwn3iceg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="516" width="412.8" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjCicQGgdA5oXPk9VJpKtqV3tA6Eu7Xl5FjvPoNibYP821olRo8eOHDkaUBGChPgvliaI3icMyFLwn3iceg/640?wx_fmt=png&amp;from=appmsg"></p><p><span>结果存放在OR.immune.list的列表中，含有OR值 以及 对应的P值 ，提取对应的数据绘制可视化热图 。</span></p><p><span>这就完成了真实数据的OR分析，受限细胞数 和 分组，本图不是很美观。</span></p><h3><strong><span>3，使用文献panT数据（图更好看）</span></strong></h3><p><span>文献中的int.CD8.S35.meta.tb.rds就是meta.data矩阵文件，和上面的是一样的，只是问了颜值高一点。</span></p><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="cs"><code><span>meta &lt;- read_rds("int.CD8.S35.meta.tb.rds")</span></code><code><span>head(meta)</span></code><code><span><br></span></code><code><span>OR.immune.list &lt;- do.tissueDist(cellInfo.tb=meta,</span></code><code><span>                                out.prefix=sprintf("%s.Immune_cell",out.prefix),</span></code><code><span>                                pdf.width=4,pdf.height=8,verbose=1</span></code><code><span>)</span></code></pre></section><p><img data-imgfileid="502918482" data-ratio="0.2740740740740741" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjCicQGgdA5oXPk9VJpKtqV3tMGqvTA0y1NuAnKDnjC6q6LhS7kgjHYQ9arkricTX0F6icfckW1ibA9WiaQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="897.6" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjCicQGgdA5oXPk9VJpKtqV3tMGqvTA0y1NuAnKDnjC6q6LhS7kgjHYQ9arkricTX0F6icfckW1ibA9WiaQ/640?wx_fmt=png&amp;from=appmsg"></p><p>其中loc 和 meta.cluster均有 ，因此无需更改名字直接函数分析即可。</p><h3><span><strong>4，可视化</strong></span></h3><p><span>函数默认使用sscVis::plotMatrix.simple绘制，热图中没有P值的结果。<span>前面提到结果存放在OR.immune.list 列表中，那么就可以分别提取OR结果 和 p值结果，然后使用pheatmap自定义绘制热图 或者 其他可视化形式。</span></span></p><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span># a 存OR值结果</span></code><code><span>a=OR.immune.list[["OR.dist.tb"]]</span></code><code><span>a &lt;- as.data.frame(a)</span></code><code><span>rownames(a) &lt;- a$rid</span></code><code><span>a &lt;- a[,-1]</span></code><code><span>a &lt;- na.omit(a)</span></code><code><span>a</span></code></pre></section><p><img data-imgfileid="502918480" data-ratio="0.5757121439280359" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjCicQGgdA5oXPk9VJpKtqV3trmgECX0kcQDJNwZLVpVHuQdXKicoEicianeFgLTglUZtoWG94ehGIJyBw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="667" width="533.6" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjCicQGgdA5oXPk9VJpKtqV3trmgECX0kcQDJNwZLVpVHuQdXKicoEicianeFgLTglUZtoWG94ehGIJyBw/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li><li></ul><pre data-lang="php"><code><span># b存P值结果</span></code><code><span>b &lt;- OR.immune.list$count.dist.melt.ext.tb[,c(1,2,6)]</span></code><code><span>b &lt;- spread(b,key = "cid", value = "adj.p.value")</span></code><code><span>b &lt;- data.frame(b[,-1],row.names = b$rid)</span></code><code><span>b &lt;- b[rownames(a),]</span></code><code><span>b</span></code></pre></section><p><img data-imgfileid="502918481" data-ratio="0.4860050890585242" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjCicQGgdA5oXPk9VJpKtqV3tnrxNDD6CXbjkGIGARt9x2R6kHCcX84UpzBibwTmw5H4bbRVIMhI91zA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="786" width="628.8" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjCicQGgdA5oXPk9VJpKtqV3tnrxNDD6CXbjkGIGARt9x2R6kHCcX84UpzBibwTmw5H4bbRVIMhI91zA/640?wx_fmt=png&amp;from=appmsg"></p><p><span>将P值改为*的展示形式，绘制热图展示P值结果 。</span></p><p><span>考虑到OR值在文献中定义的0.5 和 1.5 值，这里设置bk参数。</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="perl"><code><span>col &lt;- viridis(11,option = "D")</span></code><code><span>b = ifelse(b &gt;= 0.05&amp;(a&gt;1.5|a&lt;0.5), "",</span></code><code><span>           ifelse(b&lt;0.0001&amp;(a&gt;1.5|a&lt;0.5),"****",</span></code><code><span>                  ifelse(b&lt;0.001&amp;(a&gt;1.5|a&lt;0.5),"***",</span></code><code><span>                         ifelse(b&lt;0.01&amp;(a&gt;1.5|a&lt;0.5),"**",</span></code><code><span>                                ifelse(b &lt; 0.05&amp;(a&gt;1.5|a&lt;0.5),"*","")))))</span></code><code><span><br></span></code><code><span>bk=c(seq(0,0.99,by=0.01),seq(1,2,by=0.01))</span></code><code><span><br></span></code><code><span>pheatmap(a[,], border_color = "NA", fontsize = 9,cellheight = 12,cellwidth = 20,clustering_distance_rows="correlation",</span></code><code><span>         display_numbers = b,number_color="black",fontsize_number=10,</span></code><code><span>         cluster_col=F, cluster_rows=T, border= NULL, breaks=bk, treeheight_row = 20,treeheight_col = 20,</span></code><code><span>         color = c(colorRampPalette(colors = col[1:6])(length(bk)/2),</span></code><code><span>                   colorRampPalette(colors = col[6:11])(length(bk)/<span>2</span>)))</span></code></pre></section><p><img data-imgfileid="502918483" data-ratio="0.8629213483146068" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjCicQGgdA5oXPk9VJpKtqV3tQbgriayasnqVKqicChADXSmialQO94DwrwGqibAyQ4GWHxwysyJIUSSicew/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="445" width="356" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjCicQGgdA5oXPk9VJpKtqV3tQbgriayasnqVKqicChADXSmialQO94DwrwGqibAyQ4GWHxwysyJIUSSicew/640?wx_fmt=png&amp;from=appmsg"></p><p><span>OK，CNS或者大子刊文献的组间细胞类型比较 Get ！</span><br></p><p>参考资料：AndersonHu85/ccRCC_multiomics (github.com)</p><p><br></p><section data-style-type="7" data-tools="新媒体排版" data-id="9190"><p><span><span data-txtless="spin" data-txtlessp="120">◆ </span><span>◆ </span><span data-txtless="spin" data-txtlessp="-120">◆  <span data-txtless="spin" data-txtlessp="120">◆ </span><span>◆</span></span></span></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650398215&amp;idx=1&amp;sn=730225fb5ba3a51ceb8df0a531632515&amp;chksm=f01cbce7c76b35f1bebbf327d78a51d859770a46ae1329d362e3b705c4f8765ee2dc461d24dc&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">精心整理（含图PLUS版）|R语言生信分析，可视化</a><span>（R统计，ggplot2绘图，生信图形可视化汇总）</span><span></span></p></section><p cid="n94" mdtype="paragraph"><span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650400742&amp;idx=1&amp;sn=dca078db8e6c0c742264dcb0bf56a8e2&amp;chksm=f01c8506c76b0c107782efb89c5f5c0e244a9d664c15ea2b9d16dc70067b7249bd0e7ea9f9ae&amp;scene=21#wechat_redirect" textvalue="RNAseq纯生信挖掘思路分享？不，主要是送你代码！（建议收藏）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">RNAseq纯生信挖掘思路分享？不，主要是送你代码！（建议收藏）</a></span><span></span></p><section><mp-common-profile data-pluginname="mpprofile" data-id="MzIyNDI1MzgzOQ==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjCh1HyEjoPcBiaKy86NdKGZtju9o0oDBPicVK0lcoovRfticNuwPSj0Kib8cxqaVfBcTVCDAJ5icptybsg/300?wx_fmt=png&amp;wxfrom=19" data-nickname="生信补给站" data-alias="Bioinfo_R_Python" data-signature="生信，R语言， Python，数据处理、统计检验、模型构建、数据可视化，我输出您输入！" data-from="2" data-origin_num="178" data-isban="0" data-biz_account_status="0" data-index="0" data-is_biz_ban="0"></mp-common-profile></section><section><br></section><section><span><span>觉得对您有点帮助的希望可以点赞，在看，转发！</span></span><span></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/IVb7sTigJCZcOKSFsvBB5Q",target="_blank" rel="noopener noreferrer">原文链接</a>
