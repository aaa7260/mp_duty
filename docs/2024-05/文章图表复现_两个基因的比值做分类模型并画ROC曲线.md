---
title: "文章图表复现：两个基因的比值做分类模型并画ROC曲线"
date: 2024-05-14T10:26:42Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
文章图表复现：两个基因的比值做分类模型并画ROC曲线 by 生信星球
------
<div><section data-mpa-powered-by="yiban.io"><br></section><section><span>‍</span></section><section><img data-imgfileid="100011038" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-imgfileid="100011041" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第954天</strong></span></span><img data-imgfileid="100011040" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><section><span><span>   </span></span></section><section><section><figure><figcaption></figcaption></figure></section><section><section><section><figure><figcaption></figcaption></figure></section><figure><figcaption></figcaption></figure></section><figure><span></span><span></span></figure></section><section><figure><section><figure><figcaption></figcaption></figure></section></figure></section><section><figure><figcaption></figcaption></figure></section><section><figure><figcaption></figcaption></figure></section><section><figure><figcaption></figcaption></figure></section><section><blockquote><section><strong><span>明天（2024.5.15）送书昂，出版社给了咱一本《<strong><span>基础统计学</span>》</strong>。</span></strong></section><section><span>公众号里的文章大多数需要编程基础，如果因为代码看不懂，而跟不上正文的节奏，可以来找我学习，相当于给自己一个新手保护期。</span><span>我的课程都是循环开课。</span><span>下一期的时间，点进去咨询微信↓</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494547&amp;idx=1&amp;sn=90165024f9fe55db558502c3ab5dde6e&amp;chksm=fdfba3d1ca8c2ac7d81212b631784044b635a7f11bb921d41eaaa7677623fb9c07aebbfdb994&amp;scene=21#wechat_redirect" textvalue="生信分析直播课‍程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信分析直播课程</a></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494009&amp;idx=1&amp;sn=035d253f973f65c0d1069e515eec2ce8&amp;chksm=fdfba13bca8c282de5a9222a2ab8bc0caa2ddf60cab543c2181e6d4a90b553f4dcde5f154adf&amp;scene=21#wechat_redirect" textvalue="生信新手保护学习小组‍" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信新手保护学习小组</a></section></blockquote></section><section><section><section><h4><span><span> </span>0.背景知识</span></h4><p>在医学研究中，ROC曲线是一种常用的工具，用于评估分类模型的性能，诊断模型就是分类模型的一种。</p><p>这是一篇25分的文献，不过已经是多年前的了。</p><p>https://www.atsjournals.org/doi/10.1164/rccm.201502-0355OC</p><p>文中的fig.2C：</p><figure><img data-imgfileid="100011060" data-ratio="0.6617100371747212" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHo4s2LKsdwoUTDFFZCxeV4iajqfyuU1bBficH3yphWSQ3VgqbLicndlgicJUWuxPEDuay58QNDgZy31NA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="538" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHo4s2LKsdwoUTDFFZCxeV4iajqfyuU1bBficH3yphWSQ3VgqbLicndlgicJUWuxPEDuay58QNDgZy31NA/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><blockquote><p>Dot plot and receiver operating characteristics of the FAIM3:PLAC8 gene expression ratio in discriminating CAP and no-CAP patients. Horizontal red line in dot plot denotes the threshold value (0.757).</p><p>Area under curve (AUC) and 95% confidence interval (CI) analysis was performed by bootstrap resampling (2,000 stratified replicates). Horizontal black bars denote medians.</p></blockquote><p>与平常的ROC曲线不同的有两个点：</p><p>1.预测值不是用机器学习模型预测出来的，也不是一个基因的表达量，而是用两个基因表达量的比值。</p><p>2.用”bootstrap resampling (2,000 stratified replicates)” 这个方法来计算置信区间，翻译成中文是：“自助重采样（2,000个分层重复）”。看起来很高级，但是其实这是ROC计算时的一个默认参数，没错默认就是这样计算的<br></p><figure><img data-imgfileid="100011061" data-ratio="0.2594594594594595" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHo4s2LKsdwoUTDFFZCxeV4iaicxYECTIWfs6YgEObWhia9bibeF1mWZAgygN7InjhiapEowa6lNKSK9dQg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="740" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHo4s2LKsdwoUTDFFZCxeV4iaicxYECTIWfs6YgEObWhia9bibeF1mWZAgygN7InjhiapEowa6lNKSK9dQg/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><h4><span><span> </span>1.安装和加载R包</span></h4><pre><code><span>if</span>(!<span>require</span>(pROC))install.packages(<span>"pROC"</span>)<br><span>if</span>(!<span>require</span>(ggplot2))install.packages(<span>"ggplot2"</span>)<br><span>if</span>(!<span>require</span>(devtools))install.packages(<span>"devtools"</span>)<br><span>if</span>(!<span>require</span>(tinyarray))devtools::install_github(<span>"xjsun1221/tinyarray"</span>,upgrade = <span>FALSE</span>,dependencies = <span>TRUE</span>)<br><span>#恼火，最近(2024.5.4)tinyarray因为一些形式主义的问题被移除了，暂时只能用github的方式装了，已经重新投，等待回复ing。</span><br><span>library</span>(pROC)<br><span>library</span>(ggplot2)<br><span>library</span>(tinyarray)<br></code></pre><h4><span><span> </span>2.加载数据</span></h4><p>加载<code>TCGA-KIRC.Rdata</code>其中包含了基因表达矩阵。</p><p>在生信星球公众号对话框回复<strong>“953<span>roc</span>”</strong>获取我的示例数据</p><p><img data-galleryid="" data-imgfileid="100011065" data-ratio="0.1354679802955665" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHo4s2LKsdwoUTDFFZCxeV4iaRLqSM1pf3wmCa7nO8WUKLLo8gFgOJib9vSHSMA9IwZ3JNWE4IcIjZ0w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="406" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHo4s2LKsdwoUTDFFZCxeV4iaRLqSM1pf3wmCa7nO8WUKLLo8gFgOJib9vSHSMA9IwZ3JNWE4IcIjZ0w/640?wx_fmt=png&amp;from=appmsg"></p><pre><code>rm(list = ls())<br>load("TCGA-KIRC.Rdata")<br>ls()<br><span><br>#</span><span># [1] "clinical" "exp"      "Group"    "proj"</span><br><span><br>#</span><span>只需用到exp（表达矩阵）</span><br>exp[1:4,1:4]<br><span><br>#</span><span>#            TCGA-CW-5584-01A-01R-1541-07 TCGA-BP-5195-01A-02R-1426-07</span><br><span>#</span><span># WASH7P                               14                           38</span><br><span>#</span><span># MIR6859-1                             2                            1</span><br><span>#</span><span># CICP27                                0                            1</span><br><span>#</span><span># AL627309.6                            4                           23</span><br><span>#</span><span>#            TCGA-AK-3455-01A-01R-0864-07 TCGA-BP-4347-01A-01R-1289-07</span><br><span>#</span><span># WASH7P                              120                          120</span><br><span>#</span><span># MIR6859-1                             1                            9</span><br><span>#</span><span># CICP27                                1                            1</span><br><span>#</span><span># AL627309.6                           19                           48</span><br><br>library(tinyarray)<br>g = as.numeric(make_tcga_group(exp))-1<br>g<br><span><br>#</span><span>#   [1] 1 1 1 1 1 1 0 1 1 1 1 0 1 1 1 1 1 0 1 1 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1</span><br><span>#</span><span>#  [38] 1 0 1 1 1 0 1 1 0 1 1 1 1 1 1 1 0 1 1 0 1 1 1 1 1 0 1 1 1 1 1 0 1 1 1 0 1</span><br><span>#</span><span>#  [75] 1 1 1 0 1 1 1 1 0 1 0 1 1 1 0 1 1 0 1 1 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1</span><br><span>#</span><span># [112] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span><br><span>#</span><span># [149] 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span><br><span>#</span><span># [186] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1</span><br><span>#</span><span># [223] 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1 1 0 1 1 1 1 1 0 1 1 1 1 1 1 1 0 1 1 1 1 1 1</span><br><span>#</span><span># [260] 0 1 1 1 1 1 1 1 1 0 1 1 1 1 0 1 0 1 1 1 1 1 1 1 1 1 0 1 1 1 0 1 1 0 1 0 1</span><br><span>#</span><span># [297] 1 1 1 1 0 1 1 1 1 1 1 0 1 1 0 1 1 1 1 0 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1 1 0</span><br><span>#</span><span># [334] 1 1 0 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1</span><br><span>#</span><span># [371] 1 1 0 1 1 1 1 0 1 0 1 1 0 1 1 1 1 1 1 1 1 1 1 1 1 0 1 0 1 1 1 1 1 1 1 1 1</span><br><span>#</span><span># [408] 1 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 0 1 1 1 0</span><br><span>#</span><span># [445] 1 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1 0 1 1 1 1 0 1 1 1 1</span><br><span>#</span><span># [482] 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1 1 1 1 1 0 0 1 1 1 1 1 0 1 1 1 1 1 1</span><br><span>#</span><span># [519] 1 1 0 1 0 1 0 1 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1 1 0</span><br><span>#</span><span># [556] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 0</span><br><span>#</span><span># [593] 1 0 1 1 1 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span><br></code></pre><p>生成分组，表示样本是肿瘤（1）还是正常（0）：</p><h4><span><span> </span>3.计算预测值</span></h4><p>以两个基因的表达值比值作为预测值，以PLAC8和TP53为例</p><pre><code>predicted = <span>exp</span>[<span>"PLAC8"</span>,]/<span>exp</span>[<span>"TP53"</span>,]<br></code></pre><h4><span><span> </span>4.计算ROC曲线和AUC</span></h4><p>使用pROC包中的<code>roc</code>函数计算ROC曲线对象，并计算AUC及其95%置信区间：</p><pre><code>roc_obj &lt;- roc(g, predicted, ci = TRUE);roc_obj<br><span><br>#</span><span># </span><br><span>#</span><span># Call:</span><br><span>#</span><span># roc.default(response = g, predictor = predicted, ci = TRUE)</span><br><span>#</span><span># </span><br><span>#</span><span># Data: predicted in 72 controls (g 0) &lt; 541 cases (g 1).</span><br><span>#</span><span># Area under the curve: 0.785</span><br><span>#</span><span># 95% CI: 0.7208-0.8493 (DeLong)</span><br><br>aucs &lt;- round(ci.auc(roc_obj),3);aucs<br><span><br>#</span><span># [1] 0.721 0.785 0.849</span><br></code></pre><h4><span><span> </span>5.绘制ROC曲线</span></h4><p>使用ggplot2包和pROC包的<code>ggroc</code>函数来绘制ROC曲线，并添加AUC和95%置信区间的注释：</p><pre><code>lb = paste0(<span>"AUC:"</span>, aucs[2], <span>"\n"</span>,<br>            <span>"95%CI:"</span>, aucs[1], <span>"-"</span>, aucs[3])<br>ggroc(roc_obj, color = <span>"darkred"</span>, legacy.axes = T, linewidth = 1) +<br>  annotate(<span>"segment"</span>, x = 0, y = 0, xend = 1, yend = 1, linetype = <span>"dashed"</span>) +<br>  coord_cartesian(xlim = c(-0.01, 1.01), ylim = c(-0.01, 1.01), expand = F) +<br>  annotate(<span>"text"</span>, x = 0.9, y = 0.25, label = lb, hjust = 1) +<br>  theme_bw() +<br>  theme(panel.grid = element_blank())<br></code></pre><figure><img data-imgfileid="100011062" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHo4s2LKsdwoUTDFFZCxeV4iaQwqdkWLDSo8PEmTvgPT2eJaUdH4UkP6z0SgjHV5CrVh5w29sK22Zhg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHo4s2LKsdwoUTDFFZCxeV4iaQwqdkWLDSo8PEmTvgPT2eJaUdH4UkP6z0SgjHV5CrVh5w29sK22Zhg/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><p>搞定咯</p></section></section></section></section><section><section><br></section></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/2W41Pro53miZtkegbxKEUg",target="_blank" rel="noopener noreferrer">原文链接</a>
