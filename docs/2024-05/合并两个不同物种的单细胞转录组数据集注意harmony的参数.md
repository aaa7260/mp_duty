---
title: "合并两个不同物种的单细胞转录组数据集注意harmony的参数"
date: 2024-05-30T01:06:08Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
合并两个不同物种的单细胞转录组数据集注意harmony的参数 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>学员在交流群反馈在处理一个2020的文章里面的GSE155513和GSE155512这两个单细胞转录组数据集遇到了两个物种数据集整合失败问题。</p></blockquote><p data-tool="mdnice编辑器">这两个数据集分别是人和鼠的SMC异质性探索的，文献标题是：《Single-Cell Genomics Reveals a Novel Cell State During Smooth Muscle Cell Phenotypic Switching and Potential Therapeutic Targets for Atherosclerosis in Mouse and Human》，可以看到GSE155513和GSE155512这两个单细胞转录组表达量矩阵是可以很好的整合：</p><p><img data-galleryid="" data-imgfileid="100047194" data-ratio="0.3675925925925926" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcpSWBZwMicUibygZbKCMe3J2PwAohXkmMic6cGy5D7tykkeFI2mpLOvmPg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcpSWBZwMicUibygZbKCMe3J2PwAohXkmMic6cGy5D7tykkeFI2mpLOvmPg/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>两个单细胞转录组表达量矩阵是可以很好的整合</figcaption></figure><p data-tool="mdnice编辑器">其中小鼠的样品比较多：https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE155513</p><pre data-tool="mdnice编辑器"><span></span><code>GSM4705592_RPS003_matrix.txt.gz 6.9 Mb<br>GSM4705593_RPS004_matrix.txt.gz 6.0 Mb<br>GSM4705594_RPS011_matrix.txt.gz 5.1 Mb<br>GSM4705595_RPS012_matrix.txt.gz 2.7 Mb<br>GSM4705596_RPS007_matrix.txt.gz 9.8 Mb<br>GSM4705597_RPS008_matrix.txt.gz 5.0 Mb<br>GSM4705598_RPS001_matrix.txt.gz 11.4 Mb<br>GSM4705599_RPS002_matrix.txt.gz 5.0 Mb<br>GSM4705600_RPS017_matrix.txt.gz 6.9 Mb<br>GSM4705601_RPS018_matrix.txt.gz 4.0 Mb<br>GSM4705602_RPS013_matrix.txt.gz 7.6 Mb<br>GSM4705603_RPS014_matrix.txt.gz 3.3 Mb<br>GSM4705604_RPS015_matrix.txt.gz 8.2 Mb<br>GSM4705605_RPS016_matrix.txt.gz 4.4 Mb<br></code></pre><p data-tool="mdnice编辑器">然后人类的是3个样品：https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE155512</p><pre data-tool="mdnice编辑器"><span></span><code>GSM4705589_RPE004_matrix.txt.gz 6.8 Mb<br>GSM4705590_RPE005_matrix.txt.gz 9.1 Mb<br>GSM4705591_RPE006_matrix.txt.gz 6.1 Mb<br><br></code></pre><p data-tool="mdnice编辑器">两个单细胞转录组表达量矩阵都是可以独立的降维聚类分群哦，然后有各自的的Seurat对象，接下来就试试看整合，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>mouse = readRDS(<span>'../GSE155513-鼠/2-harmony/sce.all_int.rds'</span>) <br>mouse$study = <span>'mouse'</span><br>table(mouse$orig.ident)<br>human = readRDS(<span>'../GSE155512-人/2-harmony/sce.all_int.rds'</span>)<br>human$study = <span>'human'</span><br>table(human$orig.ident) <br>mouse_ct = mouse@assays$RNA$counts<br>rownames(mouse_ct)=toupper(rownames(mouse_ct))<br>human_ct = human@assays$RNA$counts<br>ids=intersect(rownames(human_ct),rownames(mouse_ct))<br>mouse_ct = mouse_ct[ids,]<br>human_ct = human_ct[ids,] <br><br></code></pre><p data-tool="mdnice编辑器">可以看到的是我简简单单的把小鼠表达量矩阵的基因名字修改为了大写的，因为小鼠基因的命名规则通常包括将所有字母转换为小写，这与人类基因的命名规则不同，后者通常以大写字母开头。其实在进行跨物种的基因研究时，研究人员需要仔细核对基因的命名和序列信息，以确保研究的准确性。可以使用如Ensembl、UniProt或NCBI Gene等数据库来获取不同物种中基因的准确信息。</p><p data-tool="mdnice编辑器">简简单单的把小鼠表达量矩阵的基因名字修改为了大写肯定是有很多基因会损失掉，比如人类：TP53（肿瘤蛋白p53）和小鼠：Trp53（与人类TP53同源）就基因名字不一样了，而不仅仅是大小写问题哦。</p><p data-tool="mdnice编辑器">所以我对两个表达量矩阵取了共有基因的交集，然后就可以合并这两个矩阵啦， 如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>sceList = list(<br>  mouse = CreateSeuratObject(<br>    counts = mouse_ct,<br>    meta.data = mouse@meta.data<br>  ), <br>  human = CreateSeuratObject(<br>    counts = human_ct ,<br>    meta.data = human@meta.data<br>  )<br>)<br>sce.all=merge(x=sceList[[<span>1</span>]],<br>              y=sceList[ -<span>1</span> ],<br>              add.cell.ids = c(<span>'mouse'</span>,<span>'human'</span>)  ) <br>names(sce.all@assays$RNA@layers)<br>sce.all[[<span>"RNA"</span>]]$counts <br><br><span># Alternate accessor function with the same result</span><br>LayerData(sce.all, assay = <span>"RNA"</span>, layer = <span>"counts"</span>)<br>sce.all &lt;- JoinLayers(sce.all)<br>dim(sce.all[[<span>"RNA"</span>]]$counts ) <br>as.data.frame(sce.all@assays$RNA$counts[<span>1</span>:<span>10</span>, <span>1</span>:<span>2</span>])<br>head(sce.all@meta.data, <span>10</span>)<br>table(sce.all$orig.ident) <br><br></code></pre><p data-tool="mdnice编辑器">接下来就是常规的降维聚类分群哦，但是我们默认的流程里面的针对的仅仅是样品层面的整合，代码如下所示；</p><pre data-tool="mdnice编辑器"><span></span><code>  seuratObj &lt;- RunHarmony(input_sce, c(<span>"orig.ident"</span>,<span>"study"</span>))<br></code></pre><p data-tool="mdnice编辑器">其实会看到如下所示的警告信息：</p><pre data-tool="mdnice编辑器"><span></span><code>Harmony 1/10<br>0%   10   20   30   40   50   60   70   80   90   100%<br>[----|----|----|----|----|----|----|----|----|----|<br>**************************************************|<br>0%   10   20   30   40   50   60   70   80   90   100%<br>[----|----|----|----|----|----|----|----|----|----|<br>**************************************************|<br>Harmony 2/10<br>0%   10   20   30   40   50   60   70   80   90   100%<br>[----|----|----|----|----|----|----|----|----|----|<br>**************************************************|<br>0%   10   20   30   40   50   60   70   80   90   100%<br>[----|----|----|----|----|----|----|----|----|----|<br>**************************************************|<br>Harmony 3/10<br>0%   10   20   30   40   50   60   70   80   90   100%<br>[----|----|----|----|----|----|----|----|----|----|<br>**************************************************|<br>0%   10   20   30   40   50   60   70   80   90   100%<br>[----|----|----|----|----|----|----|----|----|----|<br>**************************************************|<br>Harmony converged after 3 iterations<br>Warning: The default method <span>for</span> RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric<br></code></pre><p data-tool="mdnice编辑器">而且在后面的降维聚类分群也可以看到其实是整合效果不好， 两个物种仍然是泾渭分明的， 如下所示：</p><p><img data-galleryid="" data-imgfileid="100047195" data-ratio="0.8870370370370371" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcpXAu6ibMTGNDvU50S4hicSpE9XKslb3NJoGeHEHicpO9loeCPaZLO7KLg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcpXAu6ibMTGNDvU50S4hicSpE9XKslb3NJoGeHEHicpO9loeCPaZLO7KLg/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>两个物种仍然是泾渭分明的</figcaption></figure><p data-tool="mdnice编辑器">但是一般人都会忽略它，其实是RunHarmony函数可以修改参数的，比如同时抹去样品和数据集的差异，代码如下所示；</p><pre data-tool="mdnice编辑器"><span></span><code>  seuratObj &lt;- RunHarmony(input_sce, c(<span>"orig.ident"</span>,<span>"study"</span>))<br></code></pre><p data-tool="mdnice编辑器">可以看到这时候harmony走了10轮 ：</p><pre data-tool="mdnice编辑器"><span></span><code>**************************************************|<br>Harmony 10/10<br>0%   10   20   30   40   50   60   70   80   90   100%<br>[----|----|----|----|----|----|----|----|----|----|<br>**************************************************|<br>0%   10   20   30   40   50   60   70   80   90   100%<br>[----|----|----|----|----|----|----|----|----|----|<br>**************************************************|<br></code></pre><p data-tool="mdnice编辑器">这个时候，两个物种就比较好的整合在一起啦：</p><p><img data-galleryid="" data-imgfileid="100047196" data-ratio="0.8870370370370371" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcj5G6s03d7c3jO1mExWmzicdcEWx07maRz6Fo8eSpqTf00XyV3vQo9xA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcj5G6s03d7c3jO1mExWmzicdcEWx07maRz6Fo8eSpqTf00XyV3vQo9xA/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>两个物种就比较好的整合在一起</figcaption></figure><p data-tool="mdnice编辑器">而且也是可以比较好的进行亚群的命名，<strong>跟原文一样的有两个泾渭分明的内皮细胞，然后就是t细胞和巨噬细胞代表的淋巴细胞和髓系免疫细胞啦 ，同样的文献里面的巨噬细胞和平滑肌细胞的界限也是模糊不清</strong>：</p><p><img data-galleryid="" data-imgfileid="100047197" data-ratio="0.48055555555555557" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcPzh6XziaxG5qOgKg3x6mDIib6PAB2yiczdGTaA5GBPjPNW9PDTyWtWhLw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcPzh6XziaxG5qOgKg3x6mDIib6PAB2yiczdGTaA5GBPjPNW9PDTyWtWhLw/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>巨噬细胞和平滑肌细胞的界限也是模糊不清</figcaption></figure><p data-tool="mdnice编辑器">全部的代码，我整理好了放在百度云网盘里面，付费获取哈：(  --来自百度网盘超级会员v9的分享 )</p><p><mp-pay-preview-filter data-offset="32"></mp-pay-preview-filter></p></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/fe4OfiGg7ZKAsf_HrVWQXw",target="_blank" rel="noopener noreferrer">原文链接</a>
