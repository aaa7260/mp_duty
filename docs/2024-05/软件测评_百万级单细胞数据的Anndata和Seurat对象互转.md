---
title: "软件测评：百万级单细胞数据的Anndata和Seurat对象互转"
date: 2024-05-20T08:11:23Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
软件测评：百万级单细胞数据的Anndata和Seurat对象互转 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>这里做一个勘误，dior包并不提供h5ad的转换方法，dior包可以将seurat转为h5文件然后用python读取，但是dior包的seurat转为h5不是特别快：dior::seurat_write_h5(seurat.data,file='./Outdata/scdata.h5',object.type = 'seurat')</p><p>因此，旧文文末给的代码实际是我总结的最佳读取和转存策略，也就是组合不同的R包，达到最快的读和存的目的，总结来说：用dior包快速读h5ad为seurat，用sceasy将seurat快速转为h5ad文件。</p><p>虽然旧文的小错误不影响代码的运行，但是仍给读者带来了一些误解，在此非常抱歉！</p><p>勘误版本如下：</p></blockquote><p data-tool="mdnice编辑器">随着单细胞相关研究成果的井喷式爆发，单细胞领域已进入百万级甚至千万级细胞量的时代。因此有不少R语言党（包括我）开始学习Python，使用Scanpy流程。但是，由于习惯了Seurat流程，有些时候需要把Anndata对象的单细胞数据转为Seurat对象，然后使用R语言进行一些分析。而最大的问题在于，如何丝滑的将Anndata对象的h5ad格式与Seurat对象相互转换。本文基于一个百万级的单细胞测试数据，对多种互转软件进行测评并总结。希望能够帮助到大家~</p><h3 data-tool="mdnice编辑器"><span>一. 测试数据</span></h3><p data-tool="mdnice编辑器">首先，测试数据来自这篇系统性红斑狼疮的PBMC文章《Single-cell RNA-seq reveals cell type–specific molecular and genetic associations to lupus》，数据储存于GEO数据库GSE174188，储存格式为h5ad，包含了约120w单细胞。点击下载之后，我们开始测评互转软件。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100038390" data-ratio="0.6612377850162866" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibePeKCqOMLVVRT2bd8xVzMp7viazNzH5ibAKRlqbUAK0TS2TRWPAsAgSS9GmC7jtnbRGUbdd8T1fiaQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="614" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibePeKCqOMLVVRT2bd8xVzMp7viazNzH5ibAKRlqbUAK0TS2TRWPAsAgSS9GmC7jtnbRGUbdd8T1fiaQ/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240321174743755</figcaption></figure><p data-tool="mdnice编辑器">下载后的h5ad数据解压后命名为GSE174188_CLUES1_adjusted.h5ad，约为10.6GB大小。</p><h3 data-tool="mdnice编辑器"><span>二. 互转测评</span></h3><p data-tool="mdnice编辑器">我收集了XX种nndata对象的h5ad格式与Seurat对象互转方法，包括</p><ul data-tool="mdnice编辑器"><li><section><p>R包SeuratDisk，这个是Seurat配套的算法。如果好用的话，我们就没必要折腾别的包了，所以可想而知，这个算法肯定不好使。。</p></section></li><li><section><p>R包sceasy；</p></section></li><li><section><p>R包MuDataSeurat；</p></section></li><li><section><p>R包和Python包scDIOR，这个算法在我之前的帖子里经常用到，非常推荐，但是环境部署有点麻烦。</p></section></li></ul><p data-tool="mdnice编辑器"><strong>下面进行一一测评：</strong></p><h4 data-tool="mdnice编辑器"><span>1. R包SeuratDisk</span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(Seurat)<br><span>library</span>(SeuratDisk)<br><br><span># 1.1 h5ad转为Seurat</span><br>time.py2R = system.time({<br>  Convert(<span>'./Rawdata/GSE174188_CLUES1_adjusted.h5ad'</span>, <span>"h5seurat"</span>,<br>          overwrite = <span>TRUE</span>,assay = <span>"RNA"</span>)<br>})<br>print(time.py2R)<br><br>time.read = system.time({<br>  seurat_obj &lt;- LoadH5Seurat(<span>"./Rawdata/GSE174188_CLUES1_adjusted.h5ad"</span>)<br>})<br>print(time.read)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100038387" data-ratio="0.6388888888888888" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibePeKCqOMLVVRT2bd8xVzMeFEnhD2Eplhj4oIpVp50Ju9cJYZ04fibFbNticPPc8YYK4rlVaxuictaQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="396" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibePeKCqOMLVVRT2bd8xVzMeFEnhD2Eplhj4oIpVp50Ju9cJYZ04fibFbNticPPc8YYK4rlVaxuictaQ/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240321181135420</figcaption></figure><p data-tool="mdnice编辑器"><strong>R语言下的转换运行崩溃了，没出结果...</strong></p><p data-tool="mdnice编辑器"><strong>这里再试试Seurat转为h5ad：</strong></p><pre data-tool="mdnice编辑器"><span></span><code>seurat_object = qread(<span>"./Outdata/Step1.seurat.data.Clean.qs"</span>)<br><br><span># 1.2 Seurat转为h5ad</span><br>time.R2py = system.time({<br>  seu = DietSeurat(<br>    seurat_object,<br>    counts = <span>TRUE</span>, <span># so, raw counts save to adata.raw.X</span><br>    data = <span>TRUE</span>, <span># so, log1p counts save to adata.X</span><br>    scale.data = <span>FALSE</span>, <span># set to false, or else will save to adata.X</span><br>    features = rownames(seurat_object), <span># export all genes, not just top highly variable genes</span><br>    assays = <span>"RNA"</span>,<br>    dimreducs = c(<span>"pca"</span>,<span>"umap"</span>),<br>    graphs = c(<span>"RNA_nn"</span>, <span>"RNA_snn"</span>), <span># to RNA_nn -&gt; distances, RNA_snn -&gt; connectivities</span><br>    misc = <span>TRUE</span><br>  )<br>  <br>  <span># step 2: factor to character, or else your factor will be number in adata</span><br>  i &lt;- sapply(seu@meta.data, is.factor)<br>  seu@meta.data[i] &lt;- lapply(seu@meta.data[i], as.character)<br>  <br>  <span># step 3: convert</span><br>  SaveH5Seurat(seu, filename = <span>"./Outdata/SeuratDisk.h5seurat"</span>, overwrite = <span>TRUE</span>)<br>  Convert(<span>"./Outdata/SeuratDisk.h5seurat"</span>, <span>"./Outdata/SeuratDisk.h5ad"</span>, assay=<span>"RNA"</span>, overwrite = <span>TRUE</span>)<br>})<br>print(time.R2py)<br></code></pre><blockquote data-tool="mdnice编辑器"><p>user system elapsed 577.649 32.573 611.104</p></blockquote><p data-tool="mdnice编辑器"><strong>使用SeuratDisk包进行Seurat转h5ad，百万级单细胞花了611.104多秒，速度比较慢。</strong></p><h4 data-tool="mdnice编辑器"><span>2. R包sceasy</span></h4><p data-tool="mdnice编辑器">R包sceasy的安装有点麻烦，需要先在linux下安装一些软件：</p><pre data-tool="mdnice编辑器"><span></span><code>conda install anndata==<span>0.6</span><span>.19</span> scipy==<span>1.2</span><span>.1</span> -c bioconda<br>conda install loompy -c biocond<br></code></pre><p data-tool="mdnice编辑器">然后在R语言中安装：</p><pre data-tool="mdnice编辑器"><span></span><code>devtools::install_github(<span>"cellgeni/sceasy"</span>)<br><span>if</span> (!requireNamespace(<span>"BiocManager"</span>, quietly = TRUE))<br>    install.packages(<span>"BiocManager"</span>)<br>BiocManager::install(c(<span>"LoomExperiment"</span>, <span>"SingleCellExperiment"</span>))<br>install.packages(<span>'reticulate'</span>) <br></code></pre><p data-tool="mdnice编辑器">然后就可以运行sceasy了：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(sceasy)<br><span>library</span>(reticulate)<br><span>library</span>(Seurat)<br><br><span># 2.1 h5ad转为Seurat</span><br>time.py2R = system.time({<br>  sceasy::convertFormat(obj = <span>"./Rawdata/GSE174188_CLUES1_adjusted.h5ad"</span>, from=<span>"anndata"</span>,<br>                        to=<span>"seurat"</span>,outFile = <span>'sceasy.rds'</span>)<br>})<br>print(time.py2R)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100038391" data-ratio="0.10648148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibePeKCqOMLVVRT2bd8xVzMKN1icjqQjAwDkxpX0SiaF6MW5RpzM87rg2giafk8N7ibsrCVUibxQ7mQj4Q/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibePeKCqOMLVVRT2bd8xVzMKN1icjqQjAwDkxpX0SiaF6MW5RpzM87rg2giafk8N7ibsrCVUibxQ7mQj4Q/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240321194652273</figcaption></figure><p data-tool="mdnice编辑器"><strong>似乎是单细胞量太大了，报错了。</strong></p><p data-tool="mdnice编辑器"><strong>试试Seurat转为h5ad：</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># 2.2 Seurat转为h5ad</span><br>time.R2py = system.time({<br>  sceasy::convertFormat(seurat_object, <span>from</span>=<span>"seurat"</span>, to=<span>"anndata"</span>,<br>                        outFile=<span>'./Outdata/sceasy.h5ad'</span>)<br>})<br>print(time.R2py)<br></code></pre><blockquote data-tool="mdnice编辑器"><p>user system elapsed 243.205 22.359 267.202</p></blockquote><p data-tool="mdnice编辑器"><strong>使用sceasy包进行Seurat转h5ad，百万级单细胞花了267多秒，速度比较快。</strong></p><h4 data-tool="mdnice编辑器"><span>3. R包MuDataSeurat</span></h4><p data-tool="mdnice编辑器">R包MuDataSeurat安装比较简单：</p><pre data-tool="mdnice编辑器"><span></span><code>remotes::install_github(<span>"zqfang/MuDataSeurat"</span>, ref=<span>'dev'</span>, force = <span>T</span>)<br></code></pre><p data-tool="mdnice编辑器">然后开始转换：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(MuDataSeurat)<br><br><span># 3.1 h5ad转为Seurat</span><br>time.py2R = system.time({<br>  seurat.data = MuDataSeurat::ReadH5AD(file = <span>"./Outdata/GSE174188_CLUES1_adjusted.h5ad"</span>)<br>})<br>print(time.py2R)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100038389" data-ratio="0.49722222222222223" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibePeKCqOMLVVRT2bd8xVzMhMLUJ02qF242gcO8H0DcHfhvlSUIT9tXNQAnMb7EQksC73CibrrXkCw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibePeKCqOMLVVRT2bd8xVzMhMLUJ02qF242gcO8H0DcHfhvlSUIT9tXNQAnMb7EQksC73CibrrXkCw/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240321202345088</figcaption></figure><p data-tool="mdnice编辑器"><strong>报错了。</strong></p><p data-tool="mdnice编辑器"><strong>试试Seurat转为h5ad：</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># 3.2 Seurat转为h5ad</span><br>time.R2py = system.time({<br>  MuDataSeurat::WriteH5AD(seurat_object, <span>"MuDataSeurat.h5ad"</span>, assay=<span>"RNA"</span>)<br>})<br>print(time.R2py)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100038388" data-ratio="0.2682291666666667" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibePeKCqOMLVVRT2bd8xVzMD6eicS88rsMicMb9pciaiadNxEAQ20pqg8ibvwEKYwZiaLyBu25I6iboCIzwg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="768" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibePeKCqOMLVVRT2bd8xVzMD6eicS88rsMicMb9pciaiadNxEAQ20pqg8ibvwEKYwZiaLyBu25I6iboCIzwg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240321202804306</figcaption></figure><p data-tool="mdnice编辑器"><strong>还是报错。</strong></p><h4 data-tool="mdnice编辑器"><span>4. R包dior和Python包scDIOR</span></h4><p data-tool="mdnice编辑器">这个算法在我之前的帖子里经常用到，安装比较麻烦，依赖包有版本的限制，否则就会报错。所以我的建议是设置一个scdiopy的Conda小环境：</p><pre data-tool="mdnice编辑器"><span></span><code>conda create -n scdiopy python==3.8<br>conda activate scdiopy<br><span>#</span><span> <span>for</span> python</span><br>pip install diopy<br>pip install scanpy==1.9.6 numpy==1.21.3 numba==0.57.1<br></code></pre><p data-tool="mdnice编辑器">然后在R语言中安装：</p><pre data-tool="mdnice编辑器"><span></span><code>devtools::install_github(<span>'JiekaiLab/dior'</span>)<br></code></pre><p data-tool="mdnice编辑器">接下来，在R语言中测序转换：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(Seurat)<br><span>library</span>(dior)<br><br><span># 4.1 h5ad转为Seurat</span><br>time.py2R = system.time({<br>  seurat.data &lt;- read_h5ad(file = <span>'./Rawdata/GSE174188_CLUES1_adjusted.h5ad'</span>,<br>                           assay_name = <span>'RNA'</span>, <br>                         target.object = <span>'seurat'</span>)<br>})<br>print(time.py2R)<br></code></pre><blockquote data-tool="mdnice编辑器"><p>user system elapsed 239.829 82.604 322.756</p></blockquote><p data-tool="mdnice编辑器"><strong>h5ad转Seurat花了322多秒。</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># 4.2 Seurat转为h5</span><br>time.R2py = system.time({<br> dior::seurat_write_h5(seurat.data,file=<span>'./Outdata/scdata.h5'</span>,object.type = <span>'seurat'</span>)<br>})<br>print(time.R2py)<br></code></pre><p data-tool="mdnice编辑器"><strong>dior包的Seurat转h5运行不是特别快。</strong></p><p data-tool="mdnice编辑器"><strong>因此，如果需要将Seurat转h5ad数据用于python环境读取的话，非常推荐搭配sceasy包：</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># 4.2 Seurat转为h5ad</span><br>time.R2py = system.time({<br>  sceasy::convertFormat(seurat_object, from=<span>"seurat"</span>, to=<span>"anndata"</span>,<br>                        outFile=<span>'./Outdata/<span>sceasy.h5ad</span>'</span>)<br>})<br>print(time.R2py)<br></code></pre><h3 data-tool="mdnice编辑器"><span>三. 总结</span></h3><p data-tool="mdnice编辑器"><strong></strong></p><p><strong>如果需要将百万级细胞数量的数据从Anndata/h5ad格式转换为Seurat对象，我非常推荐使用R包dior。它的优点是运行速度快，数据兼容性强；缺点是依赖包有版本限制，容易报错。</strong></p><p><strong>而对于将Seurat对象转换为h5ad格式，R包sceasy是一个不错的选择，转换速度非常快；相对而言，R包SeuratDisk的速度较慢，不推荐使用。</strong></p><p data-tool="mdnice编辑器"><strong></strong></p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/8fwJSc9Dnp8h_Suv76oXVA",target="_blank" rel="noopener noreferrer">原文链接</a>
