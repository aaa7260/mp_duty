---
title: "GSE196756-10X数据下载及分析"
date: 2024-05-06T00:19:51Z
draft: ["false"]
tags: [
  "fetched",
  "学R时习之"
]
categories: ["Acdemic"]
---
GSE196756-10X数据下载及分析 by 学R时习之
------
<div><p><code>GSE196756</code><span>是ESCA的scRNA-seq数据，包含3个正常及3 个肿瘤样本。在</span><code>PMID38700434</code><span>中，作者仅读取肿瘤样本进行后续分析。</span><img data-imgfileid="100003257" data-ratio="0.5601851851851852" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhRQpziaVutQSwf1XXZVTJZQ8DowIwiaHsU7RQLe9vksxEziamMJjApaajg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="596" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhRQpziaVutQSwf1XXZVTJZQ8DowIwiaHsU7RQLe9vksxEziamMJjApaajg/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100003254" data-ratio="0.44351851851851853" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhAsEiaK8pLAlCia6PK5MgK59baIyZgdpP8iaKaXFk58X0ZNicWOkGxWVs0Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="593" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhAsEiaK8pLAlCia6PK5MgK59baIyZgdpP8iaKaXFk58X0ZNicWOkGxWVs0Q/640?wx_fmt=png&amp;from=appmsg"><ne-clipboard source="https%3A%2F%2Fwww.yuque.com%2Fgaodashitou%2Fxggbo7%2Fpfr5udxsoep0yh5q"></ne-clipboard></p><p><span>下面简单进行复现，由于本人能力有限，有许多不足及错误之处，还望多多指教。</span><br></p><h2><span>step01. 数据下载及整理</span></h2><ul><li><p><span>首先从</span><code><span>GEO</span></code><span>数据库下载</span><code><span>GSE196756_RAW.tar</span></code></p></li><li><p><span>解压后，按照</span><code><span>10X</span></code><span>格式整理好数据</span></p></li></ul><p><img data-imgfileid="100003255" data-ratio="0.712037037037037" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhnsiaSN39aqlIdnut4010rdsy06YVicpRn7GpgSRnib45FXpVM4q2Uicdlg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="622" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhnsiaSN39aqlIdnut4010rdsy06YVicpRn7GpgSRnib45FXpVM4q2Uicdlg/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100003258" data-ratio="2.1365461847389557" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhau0Iic8l7iaTs2vXEc7SWtib1QqKy3LgSHDHZaFSnJOuMYbGTeIxUm1ag/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="498" width="249" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhau0Iic8l7iaTs2vXEc7SWtib1QqKy3LgSHDHZaFSnJOuMYbGTeIxUm1ag/640?wx_fmt=png&amp;from=appmsg"></p><hr><h1><span>step02.数据读取</span></h1><p><span>批量读取数据</span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>librarian::shelf(tidyverse)<br>librarian::shelf(Seurat)<br>librarian::shelf(harmony)<br>dir.create(<span>"results"</span>)<br><br><span>##### step01.数据读取 #####</span><br><span>if</span>(F){<br>  dir = <span>"./GSE196756_RAW/"</span><br>  f = list.dirs(dir, full.names = T, recursive = F)<br>  datalist = list()<br>  <span># 循环遍历每个样本文件夹</span><br>  <span>for</span> (folder <span>in</span> f) {<br>    data = Read10X(data.dir = folder)<br>    seurat_obj = CreateSeuratObject(counts = data, project = basename(folder))<br>    datalist[[basename(folder)]] = seurat_obj<br>    datalist[[basename(folder)]][[<span>"percent.mt"</span>]]=PercentageFeatureSet(datalist[[basename(folder)]], pattern = <span>"^MT-"</span>)}<span># 计算线粒体占比</span><br>    names(datalist)<br>    <span># 仅提取肿瘤样本分析</span><br>    index &lt;- c(<span>"GSM5900215_1T"</span>, <span>"GSM5900217_2T"</span>,<span>"GSM5900219_3T"</span>)<br>    datalist &lt;- datalist[index]<br>    names(datalist)<br>    sce.all &lt;- merge(x=datalist[[1]],<br>                     y=datalist[-1],<br>                     add.cell.ids = names(datalist))<br>    sce.all<br>    table(sce.all<span>$orig</span>.ident)<br>    <span># 33538 features across 17476 samples within 1 assay </span><br>    <span># GSM5900215_1T GSM5900217_2T GSM5900219_3T </span><br>    <span># 7068          2900          7508 </span><br>  }<span></span></code></pre></section><hr><h1><span>step03.数据预处理</span></h1><p><span>首先根据文章过滤条件进行过滤：</span></p><p><img data-imgfileid="100003256" data-ratio="0.4861111111111111" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElh38sSBZjJdnZichB2JraMU9UNtdbnbLCg64BiaqvHNxJYZAQCAsOntYJQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="708" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElh38sSBZjJdnZichB2JraMU9UNtdbnbLCg64BiaqvHNxJYZAQCAsOntYJQ/640?wx_fmt=png&amp;from=appmsg"></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code><span>if</span>(F){<br>  <span># 数据过滤</span><br>  head(sce.all@meta.data)<br>  plot1 &lt;- VlnPlot(sce.all, features = c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>, <span>"percent.mt"</span>), ncol = 3)<br>  plot1a &lt;- FeatureScatter(sce.all, feature1 = <span>"nCount_RNA"</span>, feature2 = <span>"percent.mt"</span>)<br>  plot1b &lt;- FeatureScatter(sce.all, feature1 = <span>"nCount_RNA"</span>, feature2 = <span>"nFeature_RNA"</span>)<br>  plot1c &lt;- FeatureScatter(sce.all, feature1 = <span>"nFeature_RNA"</span>, feature2 = <span>"percent.mt"</span>)<br>  p1 &lt;- plot1/(plot1a+plot1b+plot1c)<br>  p1<br>  <br>  sce.all &lt;- subset(sce.all, subset = nFeature_RNA &gt; 200 &amp; nFeature_RNA &lt; 10000 &amp; percent.mt &lt; 10)<br>  sce.all<br>  <span># 53316 samples, 22064 features</span><br>  plot2 &lt;- VlnPlot(sce.all, features = c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>, <span>"percent.mt"</span>), ncol = 3)<br>  plot2a &lt;- FeatureScatter(sce.all, feature1 = <span>"nCount_RNA"</span>, feature2 = <span>"nFeature_RNA"</span>)<br>  plot2b &lt;- FeatureScatter(sce.all, feature1 = <span>"nCount_RNA"</span>, feature2 = <span>"percent.mt"</span>)<br>  plot2c &lt;- FeatureScatter(sce.all, feature1 = <span>"nFeature_RNA"</span>, feature2 = <span>"percent.mt"</span>)<br>  p2 &lt;- plot2/(plot2a+plot2b+plot2c)<br>  saveRDS(sce.all, <span>"results/sce_all_qc.rds"</span>)<br>}</code></pre></section><p><img data-imgfileid="100003264" data-ratio="0.5537037037037037" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhAfryw8yj86qXRQsSBSd6vCpvRguSunv9O1V8YLNjxJ5byuoanjpj7w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="1639" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhAfryw8yj86qXRQsSBSd6vCpvRguSunv9O1V8YLNjxJ5byuoanjpj7w/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100003263" data-ratio="0.5166666666666667" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElh1AUQyEh4xODTiby32icLvwdOUCAM7f7xn2UEaCsZmO2ahRuBM515WtuQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="1551" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElh1AUQyEh4xODTiby32icLvwdOUCAM7f7xn2UEaCsZmO2ahRuBM515WtuQ/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p><span>接着进行单细胞分析标准化流程：</span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code>sce=readRDS(<span>"results/sce_all_qc.rds"</span>)<br>sce &lt;- NormalizeData(sce)<br>sce &lt;- FindVariableFeatures(sce)<br>sce &lt;- ScaleData(sce)<br>sce &lt;- RunPCA(sce, features = VariableFeatures(object = sce)) <br>DimPlot(sce, reduction = <span>"pca"</span>) <span>#图片显示，样本不能很好的混在一起，要去除批次效应</span><br><br><span># harmony去除批次效应</span><br>sce &lt;- RunHarmony(sce, <br>                  group.by.vars = <span>"orig.ident"</span>,<br>                  max.iter.harmony = 20,<br>                  lambda = 0.5)<br><br>names(sce@reductions)<br><span>## [1] "pca"     "harmony"</span><br>sce &lt;- RunUMAP(sce,  dims = 1:30, reduction = <span>"harmony"</span>)<br>sce &lt;- RunTSNE(sce, dims = 1:30,reduction = <span>'harmony'</span>)<br><br>DimPlot(sce,reduction = <span>"harmony"</span>,label=T) <span>#样本能很好的混合在一起</span><br>DimPlot(sce, reduction = <span>"umap"</span>,label = T)<br><br><span># 聚类</span><br>sce &lt;- FindNeighbors(sce,reduction = <span>"harmony"</span>,dims = 1:30)<br>sce &lt;- FindClusters(sce, resolution = 0.1) <span>#默认选择 0.1分辨率</span><br><br><span># 结果聚成几类，用Idents查看</span><br>length(levels(Idents(sce)))<br><span>## [1] 11</span><br>table(sce@active.ident) <br><br>DimPlot(sce, reduction = <span>"tsne"</span>, label = T)<br>pdf(<span>'results/seurat_clusters.pdf'</span>,width = 6,height=6)<br>DimPlot(sce,reduction = <span>"umap"</span>,label=T ) <br>dev.off()<span></span></code></pre></section><p><img data-imgfileid="100003259" data-ratio="0.9796296296296296" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhquS4JfFgG7HYQiar94ia8wwSEC2HPW5PosUnP5ch7NpLbEiaxldsB5xZA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="593" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhquS4JfFgG7HYQiar94ia8wwSEC2HPW5PosUnP5ch7NpLbEiaxldsB5xZA/640?wx_fmt=png&amp;from=appmsg"></p><hr><h1><span>step04.细胞注释</span></h1><p><span>进行细胞注释，先粗分大群，再细分小群</span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code><span>#细胞注释，先粗分大群，再细分小群</span><br>genes_to_check &lt;- c(<span>"PTPRC"</span>, <span># immune PTPRC又称CD45</span><br>                    <span>"EPCAM"</span>, <span># epithelial/cancer</span><br>                    <span>"MME"</span>, <span>"PECAM1"</span>, <span># stromal</span><br>                    <span>"CD3G"</span>, <span>"CD3E"</span>, <span>"CD79A"</span>)<br>pdf(file = <span>"results/DotPlot.pdf"</span>,width = 6,height = 6)<br>DotPlot(sce, features = unique(genes_to_check),<br>        assay=<span>'RNA'</span>,group.by = <span>"RNA_snn_res.0.1"</span>)+<br>  NoLegend()<br>dev.off()<br><br>immu &lt;- c(<span>"0"</span>,1,3,4,6,7,8,9)<br>epi &lt;- c(<span>"2"</span>)<br>stromal &lt;- c(<span>"10"</span>,5)<br>sce@meta.data<span>$immune_annotation</span> &lt;- ifelse(sce@meta.data<span>$seurat_clusters</span>  %<span>in</span>% immu ,<span>'immune'</span>,<br>                                          ifelse(sce@meta.data<span>$seurat_clusters</span>  %<span>in</span>% epi ,<span>'epi'</span>,<span>'stromal'</span>) )<br>table(sce<span>$immune_annotation</span>)<br>DimPlot(sce,reduction = <span>"umap"</span>,group.by = <span>"immune_annotation"</span>)<br><span>#细分亚群,手工注释</span><br>genes_to_check = c(<span>'PTPRC'</span>, <span>'CD2'</span>,<span>'CD3D'</span>,<span>'CD3E'</span>,<span>'CD3G'</span>,<span>"CD8A"</span>,<span>"CD4"</span>,<span>#T cells</span><br>                   <span>'MS4A1'</span>,<span>#B cells</span><br>                   <span>'MS4A7'</span>,<span>'CD68'</span>,<span>'FCGR3A'</span>,<span>'CD163'</span>, <span>#Macrophage cells</span><br>                   <span>'MZB1'</span>, <span>#Plasma B cells</span><br>                   <span>'FPR2'</span>,<span>'PROK2'</span>,<span>'CMTM2'</span>,<span>"CXCR2"</span>, <span>#Neutrophils</span><br>                   <span>"NKG7"</span>,<span>"GNLY"</span>,<span>"KLRD1"</span>, <span>#NK cells</span><br>                   <span>'CTSG'</span>,<span>'ADCYAP1'</span>,<span>'TPSD1'</span>,<span>'GCSAML'</span>, <span>#Mast cell</span><br>                   <span>'S100A9'</span>, <span>'S100A8'</span>, <span>'MMP19'</span>,<span># monocyte</span><br>                   <span>'CLDN5'</span>,<span>'PECAM1'</span>, <span>'VWF'</span>,<span>'TM4SF1'</span>,  <span>## endothelial </span><br>                   <span>'LUM'</span>,<span>'COL1A1'</span>,<span>'COL3A1'</span>,<span>'FAP'</span>,<span>'THY1'</span>,<span>'MYLK'</span>,<span>'DCN'</span>,<span>'COL6A3'</span>,<span>'MME'</span>, <span>'ACTA2'</span>,<span>#Myofibroblast</span><br>                   <span>'EPCAM'</span>, <span>'KRT18'</span>,<span>'KRT8'</span>,<span>'CDH1'</span> <span># Epithelial cells</span><br>)<br>DotPlot(sce, features = unique(genes_to_check),<br>        assay=<span>'RNA'</span>,group.by = <span>"RNA_snn_res.0.1"</span>)+<br>  NoLegend()+<br>  coord_flip()<br><span>#writeLines(paste0(0:9,","))</span><br>celltype &lt;- read.table(<span>"results/anno.txt"</span>,header = F, sep = <span>","</span>)<br>head(celltype)<br>new.cluster.ids &lt;- celltype<span>$V2</span><br>names(new.cluster.ids) &lt;- levels(sce)<br>sce<span>$celltype</span> &lt;- plyr::mapvalues(sce<span>$seurat_clusters</span>,<br>                                from = 0:9,<br>                                to=celltype<span>$V2</span>)<br>DimPlot(sce, reduction = <span>"umap"</span>, group.by = c(<span>"celltype"</span>,<span>'seurat_clusters'</span>),label = T)</code></pre></section><p><img data-imgfileid="100003261" data-ratio="0.4898148148148148" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElht5ShPL8vyQxqqfNhyHXicf9xQ76KpT2iab8qeeG5QByPnexuibm3gRvtA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="1618" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElht5ShPL8vyQxqqfNhyHXicf9xQ76KpT2iab8qeeG5QByPnexuibm3gRvtA/640?wx_fmt=png&amp;from=appmsg"></p><hr><h1><span>step05.提取Neutrophils 再聚类</span></h1><p><span>最后针对</span><code><span>Neutrophils</span></code><span>，再进行聚类分析。PMID38700434分为两个亚群，咱们复现得到 3 个亚群，与原文稍有出入。</span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code>sce_neu &lt;- subset(sce,celltype %<span>in</span>% c(<span>'Neutrophils'</span>))<br>sce_neu &lt;- RunPCA(sce_neu)<br>ElbowPlot(sce_neu,  ndims = 50)<br><br><br>sce_neu &lt;- RunUMAP(sce_neu, dims = 1:20)<br>sce_neu &lt;- FindNeighbors(sce_neu, dims = 1:20)<br><br><span>for</span> (i <span>in</span> c(0.2, 0.3, 0.4, 0.5, 1, 2)) {<br>  sce_neu &lt;- FindClusters(sce_neu, resolution = i)<br>  <span>print</span>(DimPlot(sce_neu, reduction = <span>"umap"</span>, label = T) + labs(title = paste0(<span>"resolution: "</span>, i)))<br>}<br><br>table(sce_neu@meta.data<span>$RNA_snn_res</span>.0.5)<br>Idents(sce_neu) &lt;- sce_neu@meta.data<span>$RNA_snn_res</span>.0.5<br>DimPlot(sce_neu,reduction = <span>"umap"</span>,group.by = <span>"RNA_snn_res.0.5"</span>, label = T)+NoLegend()</code></pre></section><p><img data-imgfileid="100003260" data-ratio="0.8685185185185185" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhict3AI22XbqH1OCqzOS9I3Lnd4RfCzmAkMCZGxfVeklUJsibCZoPVP5A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="721" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDGzgQJxQiaQnDNTvT3CUgElhict3AI22XbqH1OCqzOS9I3Lnd4RfCzmAkMCZGxfVeklUJsibCZoPVP5A/640?wx_fmt=png&amp;from=appmsg"></p><hr><p><span>备注：本文绝大部分代码均学习整理自生信技能树、单细胞天地等，仅供交流学习，禁止用于商业用途，如有侵权，请联系删除。鉴于本人水平有限，某些内容难免理解不到位，还请各位大佬多多指教。</span></p><p><span>参考链接：</span></p><ul><li><p><span>Using single-cell RNA sequencing and bulk RNA sequencingdata to reveal a correlation between smoking and neutrophilactivation in esophageal carcinoma patients.(2024.05,PMID: 38700434)</span></p></li><li><p><a href="https://mp.weixin.qq.com/s?__biz=MzkxMjU0MjM0NQ==&amp;mid=2247485615&amp;idx=1&amp;sn=8b9e6be931f03eb5af78af5baf897e64&amp;scene=21#wechat_redirect" data-href="https://mp.weixin.qq.com/s?__biz=MzkxMjU0MjM0NQ==&amp;mid=2247485615&amp;idx=1&amp;sn=8b9e6be931f03eb5af78af5baf897e64&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2"><span>单细胞转录组：手动/自动注释细胞亚群</span></a></p></li><li><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247529601&amp;idx=1&amp;sn=e2b082386a067cf8b428b4938a21b7e5&amp;scene=21#wechat_redirect" data-href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247529601&amp;idx=1&amp;sn=e2b082386a067cf8b428b4938a21b7e5&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2"><span>单细胞亚群的生物学命名的4个规则</span></a></p></li><li><p><a href="https://mp.weixin.qq.com/s?__biz=Mzk0MzY1MDI4Mg==&amp;mid=2247484126&amp;idx=1&amp;sn=7e0148334ed4b658278105702aa7fb60&amp;scene=21#wechat_redirect" data-href="https://mp.weixin.qq.com/s?__biz=Mzk0MzY1MDI4Mg==&amp;mid=2247484126&amp;idx=1&amp;sn=7e0148334ed4b658278105702aa7fb60&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2"><span>单细胞专题 | 细胞类型注释的十八般武艺</span></a></p></li></ul><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/RLGYMcl48qfbO77sJQp7ww",target="_blank" rel="noopener noreferrer">原文链接</a>
