---
title: "师姐开发了一个软件！"
date: 2024-05-09T23:14:26Z
draft: ["false"]
tags: [
  "fetched",
  "东林的扯淡小屋"
]
categories: ["Acdemic"]
---
师姐开发了一个软件！ by 东林的扯淡小屋
------
<div><p><img data-galleryid="" data-imgfileid="100026110" data-ratio="0.18425925925925926" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBpt3fB4BMFwJUpcYnYl3DhO2Q4keehbUMFkHeNPXHf6PMLpQO9D2XuvBuDBtzUEaVbLbepev4kq4A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBpt3fB4BMFwJUpcYnYl3DhO2Q4keehbUMFkHeNPXHf6PMLpQO9D2XuvBuDBtzUEaVbLbepev4kq4A/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-galleryid="" data-imgfileid="100026112" data-ratio="0.5555555555555556" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBpt3fB4BMFwJUpcYnYl3DhO33Sn5crjov7GzVUTAeMydtcU2CeicAhFSOoV6icJImBViaxhJVIsMPjiaw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBpt3fB4BMFwJUpcYnYl3DhO33Sn5crjov7GzVUTAeMydtcU2CeicAhFSOoV6icJImBViaxhJVIsMPjiaw/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-galleryid="" data-imgfileid="100026115" data-ratio="0.5555555555555556" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBpt3fB4BMFwJUpcYnYl3DhO7R1XqNk8Oibg9KibWbyPCsSHRdTWib5MzQ24ynHOPIicvQibcl1MP3Jqq9Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBpt3fB4BMFwJUpcYnYl3DhO7R1XqNk8Oibg9KibWbyPCsSHRdTWib5MzQ24ynHOPIicvQibcl1MP3Jqq9Q/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="perl"><code><span><span># if (! requireNamespace("devtools")) </span></span></code><code><span><span>#   install.packages("devtools")</span></span></code><code><span><span># devtools::install_github('weilin-genomics/rSuperFeat')</span></span></code><code><span><span># if (!require("BiocManager", quietly = TRUE))</span></span></code><code><span><span>#   install.packages("BiocManager")</span></span></code><code><span><span># </span></span></code><code><span><span># BiocManager::install("signatureSearch")</span></span></code><code><span>library(rSuperFeat)</span></code><code><span>library(Seurat)</span></code><code><span><br></span></code><code><span>myscores &lt;- scoreStates(pbmc_small@assays$RNA@data, <span>state</span> = c(<span>"CellCycle"</span>,<span>"EMT"</span>,<span>"Exhaustion"</span>,<span>"Hypoxia"</span>))</span></code><code><span><br></span></code><code><span><span># set n.chunks if large amount of cells</span></span></code><code><span>myscores &lt;- scoreStates(pbmc_small@assays$RNA@data, <span>state</span> = c(<span>"CellCycle"</span>,<span>"EMT"</span>,<span>"Exhaustion"</span>,<span>"Hypoxia"</span>), n.chunks = <span>20</span>)</span></code><code><span>@myscores &lt;- scoreStates(pbmc_small@assays$RNA@data, <span>state</span> = c(<span>"CellCycle"</span>), n.chunks = <span>20</span>)</span></code><code><span><br></span></code><code><span><span># add myscores to seurat object to visualize</span></span></code><code><span>pbmc_small = AddMetaData(pbmc_small, metadata = myscores)</span></code><code><span><br></span></code><code><span><span># show top features for specific status</span></span></code><code><span>printTopWeights(stateName = <span>"EMT"</span>, showN = <span>150</span>, <span>print</span> = T)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span>library(signatureSearch)</span></code><code><span>library(org.Hs.eg.db)</span></code><code><span>library(AnnotationDbi)</span></code><code><span>library(ggplot2)</span></code><code><span><br></span></code><code><span><span># LINCS L1000</span></span></code><code><span>eh &lt;- ExperimentHub()</span></code><code><span>lincs_path &lt;- eh[[<span>'EH3226'</span>]]</span></code><code><span>geneList = printTopWeights(stateName = <span>"EMT"</span>,showN=<span>150</span>)</span></code><code><span>upset = mapIds(org.Hs.eg.db, as.character(geneList$pos$gene), <span>'ENTREZID'</span>, <span>'SYMBOL'</span>) </span></code><code><span>dnset = mapIds(org.Hs.eg.db, as.character(geneList$neg$gene), <span>'ENTREZID'</span>, <span>'SYMBOL'</span>) </span></code><code><span><br></span></code><code><span>qsig_lincs &lt;- qSig(query = list(upset=upset, downset=dnset), </span></code><code><span>                   gess_method=<span>"LINCS"</span>, refdb=lincs_path)</span></code><code><span>lincs &lt;- gess_lincs(qsig_lincs, sortby=<span>"NCS"</span>, tau=FALSE, workers=<span>1</span>)</span></code><code><span>result_lincs&lt;-result(lincs) </span></code><code><span>result_lincs_filter = result_lincs[result_lincs$trend == <span>'down'</span>,]</span></code><code><span>result_lincs_filter = result_lincs_filter[order(result_lincs_filter$WTCS),]</span></code><code><span>drugs &lt;- unique(result_lincs_filter$pert[<span>1</span>:<span>10</span>])</span></code><code><span>celltypes &lt;- unique(result_lincs_filter$cell[<span>1</span>:<span>10</span>])</span></code><code><span>g = gess_res_vis(result_lincs, drugs = drugs, col = <span>"WTCS"</span>) </span></code><code><span>ggplot(g$data,aes(<span>x</span>=pert,<span>y</span>=WTCS,color=cell_type,shape=cell_class)) +</span></code><code><span>  geom_point() + xlab(NULL) + ylab(<span>"Weighted Connectivity Score"</span>) +</span></code><code><span>  theme_bw(base_size = <span>16</span>) + </span></code><code><span>  theme(plot.margin = unit(c(<span>2</span>,<span>1</span>,<span>0</span>,<span>1</span>),<span>'cm'</span>), legend.background = element_rect(fill=<span>"transparent"</span>),</span></code><code><span>        axis.text.x = element_text(angle = <span>315</span>, vjust = <span>1</span>, hjust = <span>0</span>)) + </span></code><code><span>  ggsci::scale_color_ucscgb() + </span></code><code><span>  guides(color = guide_legend(title = <span>"cell line"</span>, keyheight = unit(<span>0</span>.<span>2</span>,<span>"cm"</span>), ncol = <span>2</span>, override.aes = aes(size = <span>2.5</span>)), </span></code><code><span>         shape = guide_legend(title = <span>"cell class"</span>, override.aes = aes(size = <span>2.5</span>))) +</span></code><code><span>  scale_shape_manual(<span>values</span> = c(<span>"normal"</span>=<span>16</span>,<span>"tumor"</span>=<span>17</span>))</span></code><code><span>ggsave(<span>'results/dot.lincs.pdf'</span>, width = <span>7</span>, height = <span>4</span>)</span></code><code><span><br></span></code><code><span><span># CMap</span></span></code><code><span>eh &lt;- ExperimentHub()</span></code><code><span>cmap_path &lt;- eh[[<span>"EH3223"</span>]]</span></code><code><span>qsig_cmap &lt;- qSig(query = list(upset=upset, downset=dnset), </span></code><code><span>                  gess_method=<span>"CMAP"</span>, refdb=cmap_path)</span></code><code><span>cmap &lt;- gess_cmap(qSig=qsig_cmap, chunk_size=<span>5000</span>, workers=<span>1</span>)</span></code><code><span>result_cmap&lt;-result(cmap) </span></code><code><span>result_cmap_filter = result_cmap[result_cmap$trend == <span>'down'</span>,]</span></code><code><span>result_cmap_filter = result_cmap_filter[order(result_cmap_filter$raw_score),]</span></code><code><span>drugs &lt;- unique(result_cmap_filter$pert[<span>1</span>:<span>10</span>])</span></code><code><span>g = gess_res_vis(result_cmap, drugs = drugs, col = <span>"raw_score"</span>) </span></code><code><span>ggplot(g$data,aes(<span>x</span>=pert,<span>y</span>=raw_score,color=cell_type,shape=cell_class)) +</span></code><code><span>  geom_point() + xlab(NULL) + ylab(<span>"raw score"</span>) +</span></code><code><span>  theme_bw(base_size = <span>16</span>) + </span></code><code><span>  theme(plot.margin = unit(c(<span>2</span>,<span>1</span>,<span>0</span>,<span>1</span>),<span>'cm'</span>), legend.background = element_rect(fill=<span>"transparent"</span>),</span></code><code><span>        axis.text.x = element_text(angle = <span>315</span>, vjust = <span>1</span>, hjust = <span>0</span>)) + </span></code><code><span>  ggsci::scale_color_ucscgb() + </span></code><code><span>  guides(color = guide_legend(title = <span>"cell line"</span>, keyheight = unit(<span>0</span>.<span>2</span>,<span>"cm"</span>), ncol = <span>1</span>, override.aes = aes(size = <span>2.5</span>)), </span></code><code><span>         shape = guide_legend(title = <span>"cell class"</span>, override.aes = aes(size = <span>2.5</span>))) +</span></code><code><span>  scale_shape_manual(<span>values</span> = c(<span>"normal"</span>=<span>16</span>,<span>"tumor"</span>=<span>17</span>))</span></code><code><span>ggsave(<span>'results/dot.cmap.pdf'</span>, width = <span>6</span>, height = <span>4</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span>getMatrix(pbmc_small, column = <span>"groups"</span>, state1 = <span>"g2"</span>, <span>state</span><span>0</span> = <span>"g1"</span>, prefix = <span>"./data/train"</span>)</span></code><code><span>myscores &lt;- scoreStates_selftrain(seuObj@assays$RNA@data, w1_file = <span>"models/w1.csv"</span>, b1_file = <span>"models/b1.csv"</span>)</span></code><code><span>seuObj = AddMetaData(seuObj, metadata = myscores)</span></code><code><span>geneList = printTopWeights(w1_file=<span>"models/w1.csv"</span>,myStateName = <span>"newState"</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code></pre></section><p>参考链接：</p><p>https://www.biorxiv.org/content/10.1101/2023.09.16.558051v1.full</p><p>https://github.com/weilin-genomics/rSuperFeat/tree/main</p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/1kDXIJMsutKhBnBtZda_Zw",target="_blank" rel="noopener noreferrer">原文链接</a>
