---
title: "两个表达量矩阵去除批次效应之前是否需要归一化"
date: 2024-05-30T23:39:42Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
两个表达量矩阵去除批次效应之前是否需要归一化 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>前面我们视频号直播了一个表达量芯片数据处理，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247530640&amp;idx=1&amp;sn=03353e9ec82e2e0898da9825223c3852&amp;scene=21#wechat_redirect" data-linktype="2">这样去除表达量芯片的批次效应可能不妥</a>，这个物信息学数据挖掘的标题是：《<strong>Novel ferroptosis gene biomarkers and immune infiltration profiles in diabetic kidney disease via bioinformatics</strong>》，直播回放的视频在：</p></blockquote><section><mp-common-videosnap data-pluginname="mpvideosnap" data-url="https://findermp.video.qq.com/251/20304/stodownload?encfilekey=rjD5jyTuFrIpZ2ibE8T7Ym3K77SEULgkia5jgmXAgEE5mExBrbREACm1dtpuDRaWqAViaUwqzxhSX7b7ic3mcJvkWPxK2IrwkibnsWceGyvmf0Q1OmjFH5beTRw&amp;token=cztXnd9GyrGJ0G9ibccb1l8CBElSOCWibUY6TL3uaHZyeSLES1D3aRJNicnGcGjqvib80m0w49dfy81UAMPNl9gFay80pDNISLzKLSek1kicmFtn52PeCl7HZEMicNUI1f23Fia&amp;idx=1&amp;dotrans=0&amp;hy=SZ&amp;m=&amp;scene=2&amp;uzid=2" data-headimgurl="http://wx.qlogo.cn/finderhead/PiajxSqBRaEI7scvWIPdECSfnUpSjTib9Y7RI14r1VVzxaA57PjcCERw/0" data-username="v2_060000231003b20faec8c7e1881bcad2ca06ec35b07788412aec898c89eb1e34f9a354475e8c@finder" data-nickname="生信技能树" data-desc="表达量芯片矩阵去批次" data-nonceid="16670157296477733836" data-type="video" data-mediatype="undefined" data-authiconurl="" data-from="new" data-width="1920" data-height="1080" data-id="export/UzFfAgtgekIEAQAAAAAAMMQBrq26bgAAAAstQy6ubaLX4KHWvLEZgBPEypNIayFkEImEzNPgMIt5_eJGT_23Vcu2yTxOBRFk"></mp-common-videosnap></section><p data-tool="mdnice编辑器">我们之所以要对两个表达量矩阵做去除批次效应的处理，就是因为两个表达量矩阵的取值范围就不一样，而且每个矩阵内部的每个样品或者每个基因的分布范围也不一样，做去除批次效应的处理就是为了抹去两个矩阵的系统性差异。</p><p data-tool="mdnice编辑器">批次效应（Batch Effect）是指在生物样本的基因表达数据中，由于实验设计、样本处理、数据采集和处理等非生物学因素导致的样本之间的差异。这些差异可能掩盖或模糊了生物学上真实的变异，因此需要通过去除批次效应来揭示数据中真实的生物学信息。以下是去除批次效应处理的具体解释：</p><ol data-tool="mdnice编辑器"><li><section><p><strong>取值范围不同</strong>：</p></section></li></ol><ul><li><section>不同的表达量矩阵可能由于实验条件、测量技术或数据标准化流程的差异，导致每个矩阵的基因表达量取值范围不同。例如，一个矩阵的表达量可能在1-10,000，而另一个矩阵的表达量可能在0.1-100。</section></li></ul><li><section><p><strong>矩阵内部样本或基因分布差异</strong>：</p></section></li><ul><li><section>即使在同一个矩阵内部，不同样本或基因也可能表现出不同的表达量分布特征，如均值、方差、偏度等统计特性。</section></li></ul><li><section><p><strong>系统性差异</strong>：</p></section></li><ul><li><section>批次效应导致的系统性差异是指由于批次因素引起的一致性偏差，这些偏差可能在不同批次的样本之间导致可重复性问题，影响后续分析的准确性。</section></li></ul><li><section><p><strong>去除批次效应的目的</strong>：</p></section></li><ul><li><section><strong>抹去系统性差异</strong>：通过各种统计和计算方法，如主成分分析（PCA）、多变量回归模型、批次校正算法等，来调整和消除批次效应的影响。</section></li><li><section><strong>增强可比性</strong>：去除批次效应后，不同批次、不同平台甚至不同实验室的数据可以进行比较和综合分析，提高了数据的可比性。</section></li><li><section><strong>揭示真实变异</strong>：去除批次效应有助于更准确地识别生物学上真实的变异，如疾病状态、药物响应等。</section></li></ul><li><section><p><strong>常用方法</strong>：</p></section></li><ul><li><section><strong>数据标准化</strong>：如使用Z分数（Z-score normalization）或量化归一化（quantile normalization）等方法，使不同数据集的表达量数据具有可比性。</section></li><li><section><strong>批次校正算法</strong>：如Combat、MNN（Minimum Covariance Determinant）等，这些算法可以识别并调整批次效应，减少其对数据分析的影响。</section></li><li><section><strong>多变量分析</strong>：利用PCA、因子分析等方法识别批次效应，并在后续分析中考虑或排除这些效应。</section></li></ul><li><section><p><strong>后续分析</strong>：</p></section></li><ul><li><section>在去除批次效应后，可以进行差异表达分析、聚类分析、路径分析等，以探索样本之间的生物学关系和基因功能。</section></li></ul><p data-tool="mdnice编辑器">总之，去除批次效应是基因表达数据分析中的重要步骤，它有助于提高数据质量，确保研究结果的可靠性和生物学意义。</p><p data-tool="mdnice编辑器">那么，问题就来了，两个表达量矩阵去除批次效应之前是否需要归一化呢？</p><h3 data-tool="mdnice编辑器"><span></span><span>处理GSE47185表达量矩阵</span><span></span></h3><p data-tool="mdnice编辑器">直接使用作者上传的表达量矩阵即可，如下所示的代码，因为这个GSE47185表达量矩阵样品数量非常多，分组很复杂，但是就选择了第一个数据集的Diabetic的14个样品，全部的代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(AnnoProbe)<br><span>library</span>(GEOquery) <br><span>library</span>(ggplot2)<br><span>library</span>(ggstatsplot)<br><span>library</span>(patchwork)<br><span>library</span>(reshape2)<br><span>library</span>(stringr)<br>getOption(<span>'timeout'</span>)<br>options(timeout=<span>10000</span>)<br><br>gse_number &lt;- <span>'GSE47185'</span> <br>list.files() <br><span>if</span>(<span>F</span>){gset &lt;- geoChina(gse_number)}<br><span>if</span>(<span>T</span>){ gset = getGEO(<span>"GSE47185"</span>, destdir = <span>'.'</span>, getGPL = <span>F</span>) }<br>a=gset[[<span>1</span>]] <br>dat=exprs(a) <span>#a现在是一个对象，取a这个对象通过看说明书知道要用exprs这个函数</span><br>dim(dat)<span>#看一下dat这个矩阵的维度</span><br>dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>] <span>#查看dat这个矩阵的1至4行和1至4列，逗号前为行，逗号后为列</span><br>pd = pData(a)<br>head(pd)<br>kp =  grepl(<span>'Diabetic '</span>, pd$title )<br>table(kp)<br>pd=pd[kp,]<br>dat=dat[,kp]<br><br><span>library</span>(org.Hs.eg.db)<br><span>library</span>(clusterProfiler)<br>ids &lt;- bitr( rownames(dat) ,fromType = <span>"ENTREZID"</span>,<br>           toType = c(<span>"SYMBOL"</span>),<br>           OrgDb = org.Hs.eg.db)<br>head(ids)<br>colnames(ids) =c(<span>'ID'</span>,<span>'symbol'</span>)<br></code></pre><p data-tool="mdnice编辑器">上面的表达量矩阵并不是基因的symbol，所以我们做了一个简单的id的转换哦。很简单的转换代码，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>if</span>(<span>T</span>){<br>  <span>#探针基因ID对应以及去冗余</span><br>  ids=ids[ids$symbol != <span>''</span>,]<br>  dat=dat[rownames(dat) %<span>in</span>% ids$ID,]<br>  ids=ids[match(rownames(dat),ids$ID),]<br>  head(ids) <br>  colnames(ids)=c(<span>'probe_id'</span>,<span>'symbol'</span>)  <br>  ids$probe_id=as.character(ids$probe_id)<br>  rownames(dat)=ids$probe_id<br>  dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>] <br>  <br>  ids=ids[ids$probe_id %<span>in</span>%  rownames(dat),]<br>  dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]   <br>  dat=dat[ids$probe_id,] <br>  probe_exp = dat<br>  probe_info = ids<br>  <br>  ids$median=apply(dat,<span>1</span>,median) <span>#ids新建median这一列，列名为median，同时对dat这个矩阵按行操作，取每一行的中位数，将结果给到median这一列的每一行</span><br>  ids=ids[order(ids$symbol,ids$median,decreasing = <span>T</span>),]<span>#对ids$symbol按照ids$median中位数从大到小排列的顺序排序，将对应的行赋值为一个新的ids</span><br>  ids=ids[!duplicated(ids$symbol),]<span>#将symbol这一列取取出重复项，'!'为否，即取出不重复的项，去除重复的gene ，保留每个基因最大表达量结果s</span><br>  dat=dat[ids$probe_id,] <span>#新的ids取出probe_id这一列，将dat按照取出的这一列中的每一行组成一个新的dat</span><br>  rownames(dat)=ids$symbol<span>#把ids的symbol这一列中的每一行给dat作为dat的行名</span><br>  dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]  <span>#保留每个基因ID第一次出现的信息</span><br>  <br>  fivenum(dat[<span>'ACTB'</span>,])<br>  fivenum(dat[<span>'GAPDH'</span>,])<br>}<br><br>save(gse_number,dat,<span>#group_list,</span><br>    <span>#  probe_exp,probe_info,pd,</span><br>     file = <span>'step1-output.Rdata'</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>与第一个表达量矩阵合并（基于zscore表达量矩阵）</span><span></span></h3><p data-tool="mdnice编辑器">只需要读取两个表达量矩阵，然后使用sva包的ComBat函数即可</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls()) <br>options(stringsAsFactors = <span>F</span>) <br>load(<span>'../03-GSE47185/GSE47185/step1-output.Rdata'</span>)<br>GSE47185_dat =  dat<br>GSE47185_g  = as.factor(rep(<span>'Diabetic'</span>,ncol(GSE47185_dat)))<br><br>load(<span>'../01-GSE30122/GSE30122/step1-output.Rdata'</span>)<br>GSE30122_dat =  dat<br>GSE30122_g  = group_list<br>table(GSE30122_g)<br><br>ids=intersect(rownames(GSE30122_dat),<br>              rownames(GSE47185_dat))<br>merge_dat = cbind(GSE30122_dat[ids,],<br>                  GSE47185_dat[ids,] )<br>meta=data.frame(<br>  gse_number = c(rep(<span>'GSE30122'</span>,length(GSE30122_g)),<br>                 rep(<span>'GSE47185'</span>,length(GSE47185_g))), <br>  group = c(GSE30122_g,GSE47185_g)<br>)<br><br><span>library</span>(sva)<br>table(meta)<br>table(meta$gse_number)<br>combat_edata1 = ComBat(dat=as.matrix(merge_dat), <br>                       batch=meta$gse_number, mod=<span>NULL</span>, <br>                       par.prior=<span>T</span>, prior.plots=<span>F</span>)<br>combat_edata1[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>boxplot(combat_edata1)<br>dat=combat_edata1<br>group_list=meta$group<br><br>boxplot(combat_edata1,col=as.numeric(as.factor(meta$gse_number)))<br><br></code></pre><p data-tool="mdnice编辑器">因为GSE30122数据集本身就是使用了作者提供的zscore后的，所以批次效应抹除后也是总体上的矩阵偏向于0附近哦，如下所示：</p><p><img data-galleryid="" data-imgfileid="100047207" data-ratio="0.33883579496090355" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcKdvZja3CMvmeR0YicBqd5BxVn4iamSDJtcUHwB8mbvrS3UnFHLVfaNXA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2302" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcKdvZja3CMvmeR0YicBqd5BxVn4iamSDJtcUHwB8mbvrS3UnFHLVfaNXA/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">值得注意是的，前面的GSE47185数据集的Diabetic的14个样品居然也是有批次效应的， 但是后面主要是做 control 和 Diabetic的差异分析，所以GSE47185数据集内部的异质性这个时候无伤大雅哈：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; table(meta)<br>          group<br>gse_number control Diabetic<br>  GSE30122      50       19<br>  GSE47185       0       14<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>与第二个表达量矩阵合并（基于基于cel文件）</span><span></span></h3><p data-tool="mdnice编辑器">同样的，读取两个表达量矩阵后有使用sva包的ComBat函数即可</p><p><img data-galleryid="" data-imgfileid="100047206" data-ratio="0.6402027027027027" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcyuC5GFHrKX2kd7V3r7nwUAJvK341xSgicdiaGqsY2ibcict15ibs82Kic2kA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1184" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcyuC5GFHrKX2kd7V3r7nwUAJvK341xSgicdiaGqsY2ibcict15ibs82Kic2kA/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span>两个不同策略后的差异分析结果的对比</span><span></span></h3><p data-tool="mdnice编辑器">同样的对比方式：</p><pre data-tool="mdnice编辑器"><span></span><code>      zscore_deg<br>cel_deg   down stable    up<br>  down     104     73     0<br>  stable    46  10358    49<br>  up         0     53   244<br></code></pre><p data-tool="mdnice编辑器">而且也是可以看到， 冲突的基因列表和一致性的基因列表，都是有生物学功能的：</p><p><img data-galleryid="" data-imgfileid="100047208" data-ratio="0.831304347826087" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcThtnicCdgvic7xMu5fGNxnT6qocQYAOd3SeEZGZbVT4ib3eBR9kQ45HvQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2300" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwporF1ToEKZWYF0iapfGvPcThtnicCdgvic7xMu5fGNxnT6qocQYAOd3SeEZGZbVT4ib3eBR9kQ45HvQ/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>image-20240526195013864</figcaption></figure><p data-tool="mdnice编辑器">原文里面的做法肯定是不可取的，一个矩阵是zscore的另外一个不是，这样的两个矩阵去去除批次效应总是有点奇怪，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247530640&amp;idx=1&amp;sn=03353e9ec82e2e0898da9825223c3852&amp;scene=21#wechat_redirect" data-linktype="2">这样去除表达量芯片的批次效应可能不妥</a>，这个物信息学数据挖掘的标题是：《<strong>Novel ferroptosis gene biomarkers and immune infiltration profiles in diabetic kidney disease via bioinformatics</strong>》</p></section><h3 data-tool="mdnice编辑器"><span>文末友情宣传</span></h3><p data-tool="mdnice编辑器"><strong>强烈建议你推荐给身边的博士后以及年轻生物学PI，多一点数据认知，让他们的科研上一个台阶：</strong></p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247530001&amp;idx=1&amp;sn=676dcf224f9be23b288189775292aeeb&amp;chksm=9b4b36aaac3cbfbc3e3bb0865bd789d5093e3a643f3f345332995f707b7f209ae924e9e9529e&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买‍一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;scene=21#wechat_redirect" data-linktype="2">时隔5年，我们的生信技能树VIP学徒继续招生啦</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528363&amp;idx=1&amp;sn=5e02f3e9b2e148191e23ebc2c0d780e7&amp;scene=21#wechat_redirect" data-linktype="2">2024的共享服务器交个朋友福利价仍然是800</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;scene=21#wechat_redirect" data-linktype="2">千呼万唤始出来的独享生物信息学云服务器</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528144&amp;idx=1&amp;sn=be4d7e542d1077921024c86a4c130f16&amp;scene=21#wechat_redirect" data-linktype="2">永久免费的生信进阶培训（线下）</a></section></li></ul><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/YRct97GmJKhu60hWbqgkMg",target="_blank" rel="noopener noreferrer">原文链接</a>
