---
title: "无监督分类利器：用 ConsensusClusterPlus 发现未知群体"
date: 2024-05-28T10:35:15Z
draft: ["false"]
tags: [
  "fetched",
  "生信小博士"
]
categories: ["Acdemic"]
---
无监督分类利器：用 ConsensusClusterPlus 发现未知群体 by 生信小博士
------
<div><section><section><section><section><section>普通转录组，如何做亚群亚群分析？这就是我们今天要分享的内容~</section></section></section></section></section><section><section powered-by="xiumi.us"><section><section><section><br></section><section><span><strong><span>在癌症研究中，无监督分类发现是一项非常有用的技术。研究人员可以用这种方法找出数据集中那些共享生物特征但尚未知晓的内在群体。Consensus Clustering (CC) 方法为估算数据集中无监督类别的数量提供了定量和视觉上的稳定性证据。ConsensusClusterPlus 在 R 语言中实现了 CC 方法，并扩展了新功能和可视化，包括项目跟踪、项目共识和集群共识图。这些新功能为用户提供了详细的信息，使得在无监督分类发现中能够做出更具体的决策。</span></strong></span></section><section><strong><span><br></span></strong></section><section data-tools="135编辑器" data-id="135403"><section><section data-tools="135编辑器" data-id="135403"><section><h2 data-tool="mdnice编辑器"><section>简介</section></h2></section></section></section></section><section><strong><span>无监督分类发现是一种数据挖掘技术，用于基于内在特征而非外部信息来检测未知的可能群体。</span></strong><span>研究人员通过这种技术可以回答两个问题：数据集中有多少个群体，以及对群体数量和成员的信心度有多高。Consensus Clustering (CC) 是一种流行的评估方法，特别是在癌症研究中，例如肺腺癌。CC 通过重复子采样和聚类提供定量和视觉上的“稳定性”证据。<strong>CC 的结果对于采样变异性是稳健的。</strong>GenePattern 软件中已经实现了 CC 方法，ConsensusClusterPlus 则在 R 语言中实现了 CC 方法，并添加了新的功能和可视化。</span></section><blockquote data-type="2" data-url="" data-author-name="" data-content-utf8-length="24" data-source-title=""><section><section>简单来说，就是对样本进行聚类，发现未知的聚类群体</section></section></blockquote><section><strong><span><br></span></strong></section><section data-tools="135编辑器" data-id="135403"><section><section data-tools="135编辑器" data-id="135403"><section><h2 data-tool="mdnice编辑器"><section>1. 软件的输入与输出</section></h2></section></section></section></section><blockquote data-type="2" data-url="" data-author-name="" data-content-utf8-length="24" data-source-title=""></blockquote><section><span>ConsensusClusterPlus 的<strong>输入是数据矩</strong><strong>阵</strong>和用户指定的选项。数据矩阵表示一组样本（项目）的特征集合，例如微阵列项目和基因表达特征。<strong>输出则是给定群体数量 (k) 的稳定性证据和集群分配</strong>。输出包括 R 数据对象、文本文件、图形图和日志文件。</span></section><section><br></section><section data-tools="135编辑器" data-id="135403"><section><section data-tools="135编辑器" data-id="135403"><section><h2 data-tool="mdnice编辑器"><section>2. 算法详解</section></h2></section></section></section></section><blockquote data-type="2" data-url="" data-author-name="" data-content-utf8-length="24" data-source-title=""></blockquote><section><span>ConsensusClusterPlus 扩展了 CC 算法。算法首先从数据矩阵中子采样一定比例的项目和特征。<strong>每个子样本然后通过用户指定的聚类算法（如凝聚层次聚类、k-means 或自定义算法）分配到 k 个组中。</strong>这个过程重复指定次数。成对共识值（定义为“在多次聚类运行中，两项被归为同一组的比例”）被计算并存储在每个 k 的共识矩阵 (CM) 中。对于每个 k，最终使用距离 1−共识值的凝聚层次共识聚类完成，并修剪为 k 组，即所谓的共识集群。<br></span></section><section><span><br></span></section><section><span>ConsensusClusterPlus 算法的新功能包括 2D 特征和项目子采样，可根据特定分布（如基因变异性）进行，并允许使用自定义聚类算法。2D 子采样提供了对集群对项目和特征采样变异性的敏感性评估。因为可以使用自定义聚类算法生成共识，用户可以利用 R 中现有的多种聚类算法或编写自己的算法。</span></section><section><span>ConsensusClusterPlus 生成的图形扩展了 CC 的可视化。<strong>对于每个 k，CM 图显示共识值，颜色从白色到蓝色，按共识聚类顺序排列，且在树状图和共识值之间标有项目的共识集群。</strong><strong>这一新功能使得快速准确地可视化集群边界成为可能。</strong><span>CM 图的目的是找到“最干净”的集群划分，即项目几乎总是聚集在一起（深蓝色）或不聚集在一起（白色）。</span>经验累积分布函数 (CDF) 图显示每个 k 的共识分布。CDF 图的目的是找到分布达到近似最大值的 k，这表明最大稳定性，之后的划分相当于随机选择而不是真实的集群结构。</span></section><section><span>项目跟踪图显示各 k 下项目的共识集群，允许用户跟踪项目在不同 k 下的集群分配，识别暗示弱类成员的“多情”项目，并可视化各 k 下的集群大小分布。项目共识 (IC) 是项目与共识集群成员之间的平均共识值，因此在 k 时会有多个 IC 值对应 k 个集群。IC 图显示项目作为彩色矩形条，其高度对应 IC 值。共识集群的项目标有彩色星号。IC 图允许用户查看哪些样本是集群的高度代表，哪些样本有混合集群关联，并可能选择集群代表样本。集群共识 (CLC) 是共识集群中项目的平均成对 IC。CLC 图显示这些值作为每个 k 下的柱状图。CLC 图允许用户评估新增集群对现有集群 CLC 值的影响。CM、项目跟踪、IC 和 CLC 图的颜色方案是协调的，便于交叉图分析。颜色方案的规则是：如果一个 k 的集群在 k−1 的多数成员共享，则赋予相同颜色，否则分配新颜色。</span></section><section data-tools="135编辑器" data-id="135403"><section><section data-tools="135编辑器" data-id="135403"><section><h2 data-tool="mdnice编辑器"><section>3. 代码实操</section></h2></section></section></section></section><section><br></section><section><strong><span>使用 ConsensusClusterPlus 主要分为四个步骤：</span></strong></section><section><strong><span>1. 准备输入数据</span></strong></section><section><strong><span>2 .</span><span>运行程序</span></strong></section><section><strong><span>3. 生成集群共识和项目共识。</span></strong></section><section><strong>4. 可视化分析</strong><br></section><section><br></section><h3><span><strong>3.1 准备输入数据</strong></span></h3><section>第一步是收集用于聚类分析的数据。这些数据可以是实验的结果，如 mRNA 表达微阵列或免疫组化染色强度。输入数据格式为一个矩阵，列表示样本（项目），行表示特征，单元格为数值。在本教程中，我们使用来自 ALL 库的 ALL 基因表达数据。可以看到矩阵 d 已经是合适的格式。列名和行名分别对应样本和基因名，并将在输出中保留。</section><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="apache"><section><code><span># 加载 ALL 库并获取数据</span></code><code><span>library(ALL)</span></code><code><span>data(ALL)</span></code><code><span>d = exprs(ALL)</span></code><code><span><br></span></code><code><span># 查看矩阵的前五行和前五列</span></code><code><span>d[1:5, 1:5]</span></code></section></pre></section><section><img data-galleryid="" data-imgfileid="100003377" data-ratio="0.36450381679389315" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSymKyGDhuboXq5Nh8QZT5jI45MUfFAQyAwcxQbrXYY7aZvJwrI8YDEQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="524" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSymKyGDhuboXq5Nh8QZT5jI45MUfFAQyAwcxQbrXYY7aZvJwrI8YDEQ/640?wx_fmt=png&amp;from=appmsg"></section><section><br></section><section><span><strong><span>为了选择对分类检测最具信息的基因，我们将数据集缩减为中位数绝对偏差 (MAD) 最高的前 5,000 个基因。</span></strong><span>选择 5,000 个基因和 MAD 是可以替代的，用户可以决定使用其他统计变异性过滤器或跳过过滤。另一种选择是为采样基因提供权重，详见附加选项中的 weightsFeatures。</span></span></section><section><ul><li><li><li><li><li><li></ul><pre data-lang="ini"><section><code><span># 计算每个基因的中位数绝对偏差</span></code><code><span>mads = apply(d, 1, mad)</span></code><code><span><br></span></code><code><span># 选择 MAD 最高的前 5000 个基因</span></code><code><span>d = d[rev(order(mads))[1:5000], ]</span></code><code><span><br></span></code></section></pre></section><section><img data-galleryid="" data-imgfileid="100003378" data-ratio="0.3351851851851852" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTScF4EATGIzhqtRwvnEzuTQ60BsNnO3EHcmSJiaMGwYWYpr2bBNR9FI2A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="540" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTScF4EATGIzhqtRwvnEzuTQ60BsNnO3EHcmSJiaMGwYWYpr2bBNR9FI2A/640?wx_fmt=png&amp;from=appmsg"></section><section><span><br></span></section><section><br></section><section><strong><span>如果需要转换或标准化数据</span></strong><span>，可以使用其他 Bioconductor 方法或简单语句进行操作。我们选择使用基于 Pearson 相关距离的凝聚层次聚类算法的默认设置，因此可以使用以下简单语句对基因进行中位数中心化：</span></section><section><ul><li><li><li></ul><pre data-lang="ini"><section><code><span># 基因中位数中心化</span></code><code><span>d = sweep(d, 1, apply(d, 1, median, na.rm = TRUE))</span></code><code><span><br></span></code></section></pre></section><section><img data-galleryid="" data-imgfileid="100003379" data-ratio="0.2849740932642487" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSPg3CZlEPdMjHcjjpQEtEAibBxLAFAbF9kuPolVQN2wHK1UibwlENIIPg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="579" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSPg3CZlEPdMjHcjjpQEtEAibBxLAFAbF9kuPolVQN2wHK1UibwlENIIPg/640?wx_fmt=png&amp;from=appmsg"></section><section><strong><span>现在，数据矩阵 d 已准备好进行 ConsensusClusterPlus 分析。</span></strong></section><hr><section><br></section><section><br></section><h3><span><strong>3.2 运行 ConsensusClusterPlus</strong></span></h3><section>在本教程中，我们选择了以下参数进行 ConsensusClusterPlus 分析：</section><ul><li><section>主要包含了以下几个参数：<br></section></li></ul><ol><li><section><span>pItem</span>：样品的抽样比例。例如，pItem=0.8 表示选择80%的样本进行重复抽样。</section></li><li><section><span>pFeature</span>：特征的抽样比例。</section></li><li><section><span>maxK</span>：聚类结果中分类的最大 K 值，必须是整数。</section></li><li><section><span>reps</span>：重复抽样的次数。</section></li><li><section><span>clusterAlg</span>：使用的聚类算法。"hc" 表示层次聚类，"pam" 表示 PAM（Partitioning Around Medoids）算法，"km" 表示 K-Means 算法，也可以自定义函数。</section></li><li><section><span>distance</span>：计算距离的方法，有 pearson、spearman、euclidean、binary、maximum、canberra、minkowski。</section></li><li><section><span>title</span>：输出结果的文件夹名称，包含输出的图片。</section></li><li><section><span>seed</span>：随机种子，用于确保结果可重复。</section></li><li><section><span>tmyPal</span>：指定共识矩阵使用的颜色，默认使用白到蓝色。</section></li><li><section><span>plot</span>：如果不设置，图片结果仅输出到屏幕，也可以设置输出为 'pdf'、'png'、'pngBMP'。</section></li><li><section><span>writeTable</span>：如果为 TRUE，则将共识矩阵、ICL 和 log 输出到 CSV 文件。</section></li><li><section><strong>注意：在实际应用中，建议使用更高的 reps 值，如 1000，以及更高的聚类数，如 20。</strong></section></li></ol><section><ul><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="makefile"><section><code><span># 加载 ConsensusClusterPlus 库</span></code><code><span>library(ConsensusClusterPlus)</span></code><code><span><br></span></code><code><span># 设置输出标题</span></code><code><span>title = tempdir()</span></code><code><span><br></span></code><code><span># 运行 ConsensusClusterPlus</span></code><code><span>results = ConsensusClusterPlus(d, maxK = 6, reps = 50, pItem = 0.8, pFeature = 1,</span></code><code><span>                               title = title, clusterAlg = "hc", distance = "pearson", </span></code><code><span>                               seed = 1262118388.71279, plot = "png")</span></code><code><span><br></span></code></section></pre></section><section><br></section><section><strong><span>ConsensusClusterPlus 的输出是一个列表，每个列表元素对应于 k 聚类的结果。例如，</span></strong><strong></strong><strong><code>results[[2]]</code><span> 是 k=2 时的结果。seed 选项指定了一个随机数种子，用于确保本教程的可重复性。列表元素包含以下内容：</span></strong><br></section><section><img data-galleryid="" data-imgfileid="100003381" data-ratio="0.8578052550231839" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSkuIGamU5CdTxLD7lLjSoHuZqfSa1VvXdpkNbiaMfkIRZhRnYKlBcicOg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="647" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSkuIGamU5CdTxLD7lLjSoHuZqfSa1VvXdpkNbiaMfkIRZhRnYKlBcicOg/640?wx_fmt=png&amp;from=appmsg"></section><section><img data-galleryid="" data-imgfileid="100003380" data-ratio="0.6670886075949367" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSlul3WJWRJDsBHNbgLjzAZibTtfx3icF0CEUKVo7QiaibZnib6II4ibpS4DLA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="790" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSlul3WJWRJDsBHNbgLjzAZibTtfx3icF0CEUKVo7QiaibZnib6II4ibpS4DLA/640?wx_fmt=png&amp;from=appmsg"></section><hr><section><br></section><h3><span><strong>3.3 生成聚类共识和项目共识</strong></span></h3><section>执行 ConsensusClusterPlus 之后，可以选择通过以下命令<strong>计算聚类共识和项目共识结果：</strong></section><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="markdown"><section><code><span># 计算聚类共识和项目共识</span></code><code><span>icl = calcICL(results, title = title, plot = "png")</span></code><code><span><br></span></code><code><span># 查看聚类共识</span></code><code><span>icl[["clusterConsensus"]]</span></code><code><span><br></span></code><code><span># 查看项目共识</span></code><code><span>icl[["itemConsensus"]][1:5,]</span></code><code><span><br></span></code></section></pre></section><section><strong><span>calcICL 返回一个包含两个元素的列表：</span></strong></section><section><img data-galleryid="" data-imgfileid="100003382" data-ratio="0.7990074441687345" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSs6l6lV5ic0FaD1LZBWr4Y66d0EC01cw6NFyQJY8ANtyichxcUmiaq43tg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="403" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSs6l6lV5ic0FaD1LZBWr4Y66d0EC01cw6NFyQJY8ANtyichxcUmiaq43tg/640?wx_fmt=png&amp;from=appmsg"></section><section><strong><span>根据获得详细的聚类和项目共识结果，以便进一步分析和解读。</span></strong></section><hr><section><img data-galleryid="" data-imgfileid="100003383" data-ratio="0.6399521531100478" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSBmuzHFkdAVavHefRfyuJhKaz4cGp1vfMAiadPh9ZaRtl3UicK1hpUL5w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="836" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSBmuzHFkdAVavHefRfyuJhKaz4cGp1vfMAiadPh9ZaRtl3UicK1hpUL5w/640?wx_fmt=png&amp;from=appmsg"></section><section><br></section><section><br></section><h3><strong><span>3.4.图形输出描述</span></strong></h3><section>ConsensusClusterPlus 的输出包括图形和数值数据。图形可以显示在屏幕上，也可以生成 'pdf' 或 'png' 文件，这取决于 plot 选项。对于大型数据集，图形显示可能会很大，绘制共识树状图（dendrogram）可能不可行。此时，可以使用 'pngBMP' 选项，它不生成共识矩阵树状图，并使用 bitmap 函数。Bitmap 在 Linux 系统上通常可用，但也可以在其他系统上安装。</section><section><br></section><h4><strong><span>3.4.1 共识矩阵（Consensus Matrices）</span></strong></h4><section><span>在使用 ConsensusClusterPlus 进行聚类分析时，生成的图形中最重要的部分之一就是共识矩阵。对于 k = 2, 3, 4, 5，每个 k 值都有一个共识矩阵热图，具体描述如下</span>：</section><ul><li><section><span>共识矩阵的结构</span>：</section></li><ul><li><section><span>行和列</span>：共识矩阵的行和列都代表数据项（在这个例子中是微阵列）。也就是说，如果有 n 个数据项，共识矩阵将是 n x n 的。</section></li><li><section><span>共识值</span>：矩阵中的每个值表示一对数据项在多次重采样和聚类中被聚类到一起的频率。共识值的范围从 0 到 1，其中 0 表示两个数据项从未被聚类到一起，1 表示两个数据项总是被聚类到一起。颜色编码为白色（共识值为0）到深蓝色（共识值为1），通过颜色深浅表示共识值的大小。</section></li></ul><li><section><span>共识聚类的顺序</span>：</section></li><ul><li><section>共识矩阵根据共识聚类的结果进行排序。共识聚类的结果在热图的上方用树状图（dendrogram）表示。树状图展示了数据项之间的层次关系，帮助识别不同聚类之间的关系。</section></li></ul><li><section><span>聚类成员标记</span>：</section></li><ul><li><section>在树状图和热图之间，有彩色矩形标记每个簇的成员。颜色根据图例标识，这使得用户能够在共识上下文中比较簇的成员数量。</section></li></ul><section><img data-galleryid="" data-imgfileid="100003384" data-ratio="1.0300187617260788" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSXia6KWJ7AeJNFGqeuYyGiaT4kCQxbqicG8liazS2NpPmfeiadkqaUDupKYg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="533" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSXia6KWJ7AeJNFGqeuYyGiaT4kCQxbqicG8liazS2NpPmfeiadkqaUDupKYg/640?wx_fmt=png&amp;from=appmsg"></section><section><img data-galleryid="" data-imgfileid="100003389" data-ratio="0.9946808510638298" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSBuofG04m7nXmjWGxicibUc2BDDsiaNqt13jZYEVyxdCuFmF8H4zJuInQA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="564" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSBuofG04m7nXmjWGxicibUc2BDDsiaNqt13jZYEVyxdCuFmF8H4zJuInQA/640?wx_fmt=png&amp;from=appmsg"></section><li><section><span>颜色图例</span>：显示共识颜色图例。</section><section><img data-galleryid="" data-imgfileid="100003388" data-ratio="0.9946428571428572" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSvXrYA5ovdPjbcic9J5yM7MDsiaJU8AK5T0JI70WnlvFVvUphpg6b4w6w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="560" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSvXrYA5ovdPjbcic9J5yM7MDsiaJU8AK5T0JI70WnlvFVvUphpg6b4w6w/640?wx_fmt=png&amp;from=appmsg"></section></li><li><section><span>热图（Heatmap）</span>：接下来的图形是不同 k 值（k = 2, 3, 4, 5）的共识矩阵热图。共识矩阵的行和列都是数据项（在此例中是微阵列），共识值从 0 到 1，颜色从白色到深蓝色表示这些值。</section></li><li><section><span>树状图（Dendrogram）</span>：热图上方是共识聚类生成的树状图。通过树状图可以看出不同聚类之间的关系。</section></li><li><section><span>簇标记</span>：热图和树状图之间的彩色矩形表示每个簇的成员。这些矩形的颜色根据图例标识。这个特性帮助用户在共识上下文中比较簇的成员数量。</section></li></ul><section><br></section><h4><strong><span>4.2 共识累计分布函数（CDF）图</span></strong></h4><section>共识累计分布函数图显示了不同 k 值下共识矩阵的 CDF。这张图通过直方图（100 个区间）估计每个 k 的 CDF：</section><ul><li><section><span>目的</span>：帮助用户确定在哪个 k 值下，CDF 达到近似最大值，即共识和聚类置信度在此 k 值下达到最大。</section><section><br></section></li><li><section><img data-galleryid="" data-imgfileid="100003392" data-ratio="0.9794168096054888" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTS6HZ1BiclczFia6sOrlG85ECbRZTuS5ZxQopRGXLJt3FESy6gf0zibIEGw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="583" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTS6HZ1BiclczFia6sOrlG85ECbRZTuS5ZxQopRGXLJt3FESy6gf0zibIEGw/640?wx_fmt=png&amp;from=appmsg"></section></li><li><section><span>解读</span>：当 CDF 曲线趋于平缓或达到最大时，这通常是选择 k 的最佳点。</section><section><br></section></li></ul><h4><strong><span>4.3 Delta Area 图</span></strong></h4><section>Delta Area 图显示了相邻 k 值之间 CDF 曲线下面积的相对变化：</section><ul><li><section><span>k = 2</span>：对于 k = 2，没有 k - 1，所以直接显示总面积。</section></li><li><section><span>目的</span>：帮助用户确定 k 值，在哪个 k 值处，共识的相对增加不再显著。</section><section><img data-galleryid="" data-imgfileid="100003390" data-ratio="1.0034305317324186" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSstCcJdXiaAf7LRr3VO8ddeDV4XCPwc1rolBC0ZCXfepDlxEsEfvu6Ew/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="583" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSstCcJdXiaAf7LRr3VO8ddeDV4XCPwc1rolBC0ZCXfepDlxEsEfvu6Ew/640?wx_fmt=png&amp;from=appmsg"></section></li><li><section><span>解读</span>：如果相邻 k 值的面积变化很小，表示进一步增加 k 不会显著提升聚类稳定性。</section><section><br></section></li></ul><section><br></section><h4><span><strong>4.4 跟踪图（Tracking Plot）</strong></span></h4><section>跟踪图展示了每个数据项在不同 k 值下的聚类分配情况：</section><ul><li><section><span>颜色</span>：每列表示一个数据项，颜色表示该数据项在不同 k 值下的聚类分配。</section></li><li><section><span>标记</span>：列下面的刻度表示数据项/样本。</section></li><li><section><span>目的</span>：帮助用户跟踪每个数据项在不同聚类数量下的聚类变化。</section><section><br></section></li><li><section><img data-galleryid="" data-imgfileid="100003391" data-ratio="1.0017921146953406" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSDAAric7FYJjBzMLnUNe6TJ4ADCY1T4iaAY3UvYISwRbcZaj3IXk6Z47g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="558" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSDAAric7FYJjBzMLnUNe6TJ4ADCY1T4iaAY3UvYISwRbcZaj3IXk6Z47g/640?wx_fmt=png&amp;from=appmsg"></section></li><li><section><span>解读</span>：如果一个数据项在不同 k 值下频繁改变聚类（颜色变化频繁），这表明该数据项的聚类不稳定。</section></li></ul><h4><strong><span>4.5 簇共识图（Cluster-Consensus Plot）</span></strong></h4><section>簇共识图显示了每个 k 值下各簇的共识值：</section><ul><li><section><span>簇共识值</span>：表示一个簇内所有成员之间成对共识值的平均值。</section></li><li><section><span>颜色</span>：颜色表示不同簇，颜色方案与共识矩阵和跟踪图一致。</section></li><li><section><span>目的</span>：帮助用户查看每个 k 值下的簇共识，并在不同 k 值之间比较簇的稳定性。</section></li><li><section><span>解读</span>：高共识值表示簇稳定性高，低共识值表示簇稳定性低。</section></li></ul><h4><br></h4><h4><span><strong>4.6 项目共识图  item-Consensus Plot（样本一致性图）</strong></span></h4><section>项目共识图显示了每个数据项在不同 k 值下的项目共识值：</section><ul><li><section><span>项目共识值</span>：表示一个数据项与特定簇内所有数据项的平均共识值。</section></li><li><section><span>条形图</span>：每个 k 值的条形图表示项目共识值，颜色表示不同簇。</section></li><li><section><span>目的</span>：帮助用户查看数据项在各个簇中的纯度。<img data-galleryid="" data-imgfileid="100003387" data-ratio="0.9981549815498155" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTS3pVibHSugRYB0MCTnElpGdrOWtRASJAIg228OJxNicWBXUMMhmlczUXw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="542" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTS3pVibHSugRYB0MCTnElpGdrOWtRASJAIg228OJxNicWBXUMMhmlczUXw/640?wx_fmt=png&amp;from=appmsg"></section></li><li><section><span>解读</span>：高纯度数据项在某个簇内有较高的共识值。如果一个数据项在多个簇中有较高的共识值，这表明该数据项不稳定或“不纯”。这些值可以用于选择高代表性的“核心”样本，或帮助决定合适的聚类数量。</section></li></ul><section>通过以上图形分析，用户可以全面了解数据的聚类结构，判断聚类的稳定性，并选择最适合的数据聚类数量。</section><section><br></section><h4><strong><span>4.7 通过算法确定最佳聚类个数</span></strong></h4><section><span>选择最佳K值的方法可以通过分析上述结果初步确定分类的子组数量，但这种方法有时带有主观性。为了更加客观地确定最佳聚类数目，可以使用PAC（Proportion of Ambiguous Clustering）法。以下是如何使用PAC法确定最佳K值的代码示例</span></section><section><br></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="makefile"><section><code><span># 定义要测试的K值范围</span></code><code><span>Kvec = 2:20</span></code><code><span><br></span></code><code><span># 定义中间子区间的阈值</span></code><code><span>x1 = 0.1</span></code><code><span>x2 = 0.9</span></code><code><span><br></span></code><code><span># 初始化PAC值</span></code><code><span>PAC = rep(NA, length(Kvec))</span></code><code><span>names(PAC) = paste("K=", Kvec, sep="")</span></code><code><span><br></span></code><code><span># 计算每个K值对应的PAC</span></code><code><span>for (i in Kvec) {</span></code><code><span>  M = results[[i]]$consensusMatrix</span></code><code><span>  Fn = ecdf(M[lower.tri(M)])  # 计算共识矩阵的经验累积分布函数</span></code><code><span>  PAC[i-1] = Fn(x2) - Fn(x1)</span></code><code><span>}</span></code><code><span><br></span></code><code><span># 确定PAC最小值对应的最佳K值</span></code><code><span>optK = Kvec[which.min(PAC)]</span></code><code><span><br></span></code></section></pre></section><section><img data-galleryid="" data-imgfileid="100003394" data-ratio="0.4878444084278768" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSsqb11aqybRFG5SwNVarEpsYFzUXeLAlWn8Qxxic5IBRuKvUsZr5yp2w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="617" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSsqb11aqybRFG5SwNVarEpsYFzUXeLAlWn8Qxxic5IBRuKvUsZr5yp2w/640?wx_fmt=png&amp;from=appmsg"></section><section><strong><span><br></span></strong></section><section><strong><span>然后，根据确定的最佳K值重新绘制热图（以下示例中以k=7为例）：</span></strong></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><section><code><span><br></span></code><code><span># 选取自己感兴趣的基因集</span></code><code><span>intersection_geneExp=d</span></code><code><span><br></span></code><code><span>intersection_geneExp[1:3, 1:3]</span></code><code><span><br></span></code><code><span># 创建注释列数据框</span></code><code><span>annCol &lt;- data.frame(results = paste0("Cluster", results[[7]][['consensusClass']]),</span></code><code><span>                     row.names = colnames(intersection_geneExp))</span></code><code><span>head(annCol)</span></code><code><span>dim(d)</span></code><code><span># 加载RColorBrewer和pheatmap库</span></code><code><span>library(RColorBrewer)</span></code><code><span>library(pheatmap)</span></code><code><span><br></span></code><code><span># 定义颜色</span></code><code><span>mycol &lt;- brewer.pal(7, "Set3")</span></code><code><span><br></span></code><code><span>annColors &lt;- list(results = c("Cluster1" = mycol[1],</span></code><code><span>                              "Cluster2" = mycol[2],</span></code><code><span>                              "Cluster3" = mycol[3], </span></code><code><span>                              "Cluster4" = mycol[4], </span></code><code><span>                              "Cluster5" = mycol[5], </span></code><code><span><br></span></code><code><span>                                            "Cluster6" = mycol[6], </span></code><code><span>                              "Cluster7" = mycol[7]))</span></code><code><span><br></span></code><code><span># 获取共识矩阵</span></code><code><span>heatdata &lt;- results[[7]][["consensusMatrix"]]</span></code><code><span>dimnames(heatdata) &lt;- list(colnames(intersection_geneExp), colnames(intersection_geneExp))</span></code><code><span>heatdata[1:3, 1:3]</span></code><code><span><br></span></code><code><span># 绘制热图</span></code><code><span>result &lt;- pheatmap(mat = heatdata,</span></code><code><span>                   color = colorRampPalette((c("white", "steelblue")))(100),</span></code><code><span>                   border_color = NA,</span></code><code><span>                   annotation_col = annCol,</span></code><code><span>                   annotation_colors = annColors,</span></code><code><span>                   show_colnames = FALSE,</span></code><code><span>                   show_rownames = FALSE)</span></code><code><span><br></span></code><code><span><br></span></code></section></pre></section><section><img data-galleryid="" data-imgfileid="100003395" data-ratio="0.6851851851851852" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSRK9iaAe0l4t5ecU2UhLmw6xqu7o2gjplNictrxhPL3LdAIpPksoawpnA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuiaHEHtWIBNTYuBe2hkSoTSRK9iaAe0l4t5ecU2UhLmw6xqu7o2gjplNictrxhPL3LdAIpPksoawpnA/640?wx_fmt=png&amp;from=appmsg"></section><section><br></section><section><span><strong>最后，我们可以根据分类的结果去做生存分析，看哪个分型与生存或者预后相关</strong></span></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>library(tidyverse)</span></code><code><span><br></span></code><code><span>Cluster_res &lt;- annCol %&gt;% <span>as</span>.data.frame %&gt;% rownames_to_column(<span>"patient_ID"</span>) </span></code><code><span>table(Cluster_res$results) </span></code><code><span><span>## </span></span></code><code><span><span>## Cluster1 Cluster2 Cluster3 Cluster4 Cluster5 Cluster6 Cluster7 </span></span></code><code><span><span>##      132       94       37       57       38       48        6 </span></span></code><code><span><br></span></code><code><span><span>#合并预后数据进行生存分析 </span></span></code><code><span>STAD_clinical &lt;- read_tsv(<span>"STAD_clinical.txt"</span>) </span></code><code><span>STAD_clinical$time &lt;- ifelse(STAD_clinical$vital_status==<span>'Alive'</span>, STAD_clinical$days_to_last_follow_up, STAD_clinical$days_to_death) <span># 如果患者已经死亡则选择days_to_death，如果患者处于活着状态，则选择days_to_last_follow_up</span></span></code><code><span>STAD_clinical$status &lt;- ifelse(STAD_clinical$vital_status==<span>'Alive'</span>, <span>0</span>, <span>1</span>)</span></code><code><span><br></span></code><code><span>Cluster_res &lt;- Cluster_res %&gt;% inner_join(STAD_clinical, <span>"patient_ID"</span>) </span></code><code><span>head(Cluster_res) </span></code><code><span><span>##                     patient_ID  results age gender tissue_or_organ_of_origin               primary_diagnosis vital_status ajcc_pathologic_stage year_of_birth days_to_last_follow_up year_of_death days_to_death time status</span></span></code><code><span><span>##  1 TCGA-BR-A4J4-01A-12R-A251-31 Cluster1  39   male            Gastric antrum             Adenocarcinoma, NOS        Alive            Stage IIIB          1973                     16            NA            NA   16      0</span></span></code><code><span><span>##  2 TCGA-BR-A4IZ-01A-32R-A251-31 Cluster1  45 female            Gastric antrum         Carcinoma, diffuse type         Dead            Stage IIIB          1967                     24            NA           273  273      1</span></span></code><code><span><span>##  3 TCGA-RD-A7C1-01A-11R-A32D-31 Cluster2  82   male         Fundus of stomach         Carcinoma, diffuse type         Dead              Stage IB          1923                     NA          2006           507  507      1</span></span></code><code><span><span>##  4 TCGA-BR-6852-01A-11R-1884-13 Cluster2  64 female               Cardia, NOS             Adenocarcinoma, NOS        Alive             Stage IIA          1947                   1367            NA            NA 1367      0</span></span></code><code><span><span>##  5 TCGA-BR-7851-01A-11R-2203-13 Cluster2  74   male           Body of stomach Adenocarcinoma, intestinal type         Dead             Stage IIB          1937                    574            NA            NA   NA      1</span></span></code><code><span><span>##  6 TCGA-BR-A4J1-01A-11R-A251-31 Cluster2  63   male            Gastric antrum             Adenocarcinoma, NOS         Dead            Stage IIIA          1949                     NA          2012            22   22      1</span></span></code><code><span><br></span></code><code><span><span>#进行生存分析 </span></span></code><code><span>library(survival)</span></code><code><span>library(survminer)</span></code><code><span><br></span></code><code><span>fit &lt;- survfit(Surv(time, status) ~ results, data = Cluster_res) </span></code><code><span><br></span></code><code><span>ggsurvplot(fit, data = Cluster_res,  </span></code><code><span>           main = <span>"Survival curve"</span>, <span># 添加标题</span></span></code><code><span>           surv.median.line = <span>"hv"</span>, <span># 添加中位数生存时间线</span></span></code><code><span>           font.main = c(<span>16</span>, <span>"bold"</span>, <span>"darkblue"</span>), <span># 设置标题字体大小、格式和颜色</span></span></code><code><span>           font.x = c(<span>14</span>, <span>"bold.italic"</span>, <span>"red"</span>), <span># 设置x轴字体大小、格式和颜色</span></span></code><code><span>           font.y = c(<span>14</span>, <span>"bold.italic"</span>, <span>"darkred"</span>), <span># 设置y轴字体大小、格式和颜色</span></span></code><code><span>           font.tickslab = c(<span>12</span>, <span>"plain"</span>, <span>"darkgreen"</span>), <span># 设置坐标轴刻度字体大小、格式和颜色</span></span></code><code><span>           legend = c(<span>0.9</span>, <span>0.15</span>), <span># 通过坐标指定图例位置</span></span></code><code><span>           legend.title = <span>"Cluster"</span>, legend.labs = c(<span>"Cluster1"</span>,<span>"Cluster2"</span>,<span>"Cluster3"</span>,<span>"Cluster4"</span>,<span>"Cluster5"</span>,<span>"Cluster6"</span>,<span>"Cluster7"</span>), <span># 更改图例标题和标签</span></span></code><code><span>           size = <span>1</span>,  <span># 改变线条大小</span></span></code><code><span>           linetype = <span>"strata"</span>, <span># 按组更改线型</span></span></code><code><span>           <span>break</span>.time.by = <span>250</span>, <span># 将时间轴以250作为打断</span></span></code><code><span>           <span># palette = "Dark2" # 使用 brewer 调色板“Dark2”</span></span></code><code><span>           palette = c(<span>'#E5D2DD'</span>, <span>'#53A85F'</span>, <span>'#F1BB72'</span>, <span>'#F3B1A0'</span>, <span>'#D6E7A3'</span>, <span>'#57C3F3'</span>, <span>'#476D87'</span>), <span># 自定义调色板</span></span></code><code><span>           ggtheme = theme_bw(), <span># 修改主题</span></span></code><code><span>           <span># conf.int = TRUE, # 添加置信区间</span></span></code><code><span>           pval = <span>TRUE</span>, <span># 添加p值</span></span></code><code><span>           risk.table = <span>TRUE</span>, risk.table.y.text.col = <span>TRUE</span>, <span># 添加风险表,并按层更改风险表y 文本颜色  </span></span></code><code><span>           tables.height = <span>0.2</span>, <span># 设置风险表的高度</span></span></code><code><span>           tables.theme = theme_cleantable(), <span># 设置风险表的主题</span></span></code><code><span>           xlim = c(<span>0</span>, <span>1050</span>) <span># 更改 x 轴范围</span></span></code><code><span>)  </span></code><code><span><br></span></code><code><span>tsne分析</span></code><code><span><br></span></code><code><span><span># 将数据框中字符型数据转化为数值型</span></span></code><code><span>intersection_tumor &lt;- <span>as</span>.data.frame(lapply(intersection_geneExp, <span>as</span>.numeric))</span></code><code><span>row.names(intersection_tumor) &lt;- row.names(intersection_geneExp)</span></code><code><span>colnames(intersection_tumor) &lt;- colnames(tumor_matrix)</span></code><code><span>intersection_tumor = na.omit(intersection_tumor)</span></code><code><span>intersection_tumor &lt;- <span>as</span>.matrix(intersection_tumor)</span></code><code><span><br></span></code><code><span>library(Rtsne)</span></code><code><span><br></span></code><code><span>tSNE_res&lt;- Rtsne(t(intersection_tumor), dims= <span>2</span>, perplexity= <span>10</span>, verbose= F, max_iter= <span>500</span>, check_duplicates= F) </span></code><code><span><br></span></code><code><span>tsne&lt;- data.frame(tSNE1 = tSNE_res[[<span>"Y"</span>]][,<span>1</span>], tSNE2= tSNE_res[[<span>"Y"</span>]][,<span>2</span>], cluster = annCol$results) </span></code><code><span><br></span></code><code><span>ggplot(tsne, aes(x= tSNE1, y= tSNE2, color= cluster)) + </span></code><code><span>  geom_point(size= <span>4.5</span>, alpha= <span>0.5</span>) + </span></code><code><span>  stat_ellipse(level= <span>0.85</span>, show.legend = F) + </span></code><code><span>  theme(legend.position= <span>"top"</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code></pre></section><section><br></section><section><br></section><section><br></section><section><mp-common-profile data-pluginname="mpprofile" data-id="Mzg2NDcxMzYwNg==" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Sks7JhVxUX46ZKxPSob6ptqIZgnIEnHOn5VMwCX8sN6MQy1Pq4XXFEOJ6grAmsoQugyCDKOZictDBHA/0?wx_fmt=png" data-nickname="生信小博士" data-alias="bioinformatics_Dr" data-signature="【生物信息学】R语言开始，学习生信。Seurat，单细胞测序，空间转录组。 Python，scanpy，cell2location。资料分享" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><section><ul><li><li><li><li></ul><pre data-lang="ruby"><section><code><span>参考：</span></code><code><span>https://bioconductor.org/packages/release/bioc/vignettes/ConsensusClusterPlus/inst/doc/ConsensusClusterPlus.pdf</span></code><code><span>https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2881355/</span></code><code><span>https://www.jianshu.com/p/04d8a0e4a002</span></code></section></pre></section><section><img data-imgfileid="100003371" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"><br></section><section><img data-imgfileid="100003370" data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></section><section><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></section></section></section></section></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Bv5wcc28IAuaep8EOs1C4g",target="_blank" rel="noopener noreferrer">原文链接</a>
