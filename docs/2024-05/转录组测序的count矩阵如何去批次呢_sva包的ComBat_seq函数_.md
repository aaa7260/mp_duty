---
title: "转录组测序的count矩阵如何去批次呢（sva包的ComBat_seq函数）"
date: 2024-05-05T23:02:57Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
转录组测序的count矩阵如何去批次呢（sva包的ComBat_seq函数） by 生信菜鸟团
------
<div><p><strong><span><span>酒香也怕巷子深：好像大家不怎么知道我们</span><span>生信技能树</span><span>团队有一个</span></span><span><strong><span>生物信息学入门课</span></strong></span><span>，详见；</span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247530001&amp;idx=1&amp;sn=676dcf224f9be23b288189775292aeeb&amp;chksm=9b4b36aaac3cbfbc3e3bb0865bd789d5093e3a643f3f345332995f707b7f209ae924e9e9529e&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买‍一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"><span>生物信息学马拉松授课（买一得五）</span></a><span> ，你值得拥有！</span></strong></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>转录组测序定量流程大家都很熟悉了，一般来说我们推荐经典的4步：</p></blockquote><ul data-tool="mdnice编辑器"><li><section><p>1.数据准备（找公司测序的话，或者下载公共数据集）</p></section></li><li><section><p>2.质量控制（质控前用fastqc与multiqc初看数据效果、trim-galore进行质控过滤 ）</p></section></li><li><section><p>3.使用Hisat2比对</p></section></li><li><section><p>4.使用featureCounts定量</p></section></li></ul><p data-tool="mdnice编辑器">很容易就拿到了count矩阵，但是早期大家喜欢RPKM（Reads Per Kilobase per Million reads）、FPKM（Fragments Per Kilobase of transcript per Million fragments）和TPM（Transcripts Per Million），这三种常用标准化指标。</p><p data-tool="mdnice编辑器">目前我们还是就纯粹的count矩阵即可，如果大家的count矩阵来源于多个数据集，理论上就需要去批次啦。</p><h3 data-tool="mdnice编辑器"><span></span><span>首先我们有4个不同数据集的表达量矩阵</span><span></span></h3><p data-tool="mdnice编辑器">需要进行如下所示的简单的合并即可：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 数据框 dat1, dat2, dat3, dat4 行名取交集</span><br>common_rows &lt;- intersect(rownames(dat1), <br>                         intersect(rownames(dat2), <br>                                   intersect(rownames(dat3), <br>                                             rownames(dat4))))<br><br><span># 使用 cbind 合并数据框</span><br>exp &lt;- cbind(<br>  dat1[common_rows, ],<br>  dat2[common_rows, ],<br>  dat3[common_rows, ],<br>  dat4[common_rows, ]<br>)<br><br>Group = c(group_list1,group_list2,group_list3,group_list4)<br>table(Group)<br>getwd()<br>save(dat1,dat2,dat3,dat4,common_rows,Group,exp,file = <span>"Rdata/exp.Rdata"</span>)<br><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>然后使用sva包的ComBat_seq函数针对转录组测序的count矩阵去批次</span><span></span></h3><p data-tool="mdnice编辑器">如下所示的代码：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>load(<span>"Rdata/exp.Rdata"</span>)<br><br><span>#处理批次效应(combat)</span><br><span>library</span>(sva)<br><span>#ComBat_seq是基于ComBat框架的改进模型，专门针对 RNA-Seq 计数（即count矩阵）数据</span><br>batch &lt;- c(rep(<span>"A"</span>, ncol(dat1)), rep(<span>"B"</span>, ncol(dat2)), <br>           rep(<span>"C"</span>, ncol(dat3)), rep(<span>"D"</span>, ncol(dat4)))<br>mod = model.matrix(~Group)<br>exp2 = ComBat_seq(counts = as.matrix(exp), batch = batch,group = Group)<br>class(exp2)<br>dat = log2(edgeR::cpm(exp2)+<span>1</span>)<br>save(exp,exp2,dat,Group,file = <span>"Rdata/dat.Rdata"</span>)<br><br></code></pre><p data-tool="mdnice编辑器">去除前后的表达量矩阵可以简单的看看主成分分析结果，如下所示，可以看到不同数据集的差异被抹除了 ：</p><p><img data-galleryid="" data-imgfileid="100038132" data-ratio="0.7896039603960396" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmmYc71vEWPiaD96qZkbvpK68dniaxibxonwwSeX8p1g5t9Cg1jdzpibiaKiak2iaL4gbTm3YodKJibZB3Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1616" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmmYc71vEWPiaD96qZkbvpK68dniaxibxonwwSeX8p1g5t9Cg1jdzpibiaKiak2iaL4gbTm3YodKJibZB3Q/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>不同数据集的差异被抹除了</figcaption></figure><p data-tool="mdnice编辑器">而且 它去除前后的表达量矩阵，都是count格式：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; exp[1:4,1:4]<br>         GC_B13 GC_B14 GC_B2 GC_B30<br>TSPAN6     1276   1022  1417   1150<br>DPM1        798    767  1269   1023<br>SCYL3        91    108    38     50<br>C1orf112     75     86    71     33<br><br>&gt; exp2[1:4,1:4]<br>         GC_B13 GC_B14 GC_B2 GC_B30<br>TSPAN6      392    204   702    405<br>DPM1        294    283   470    379<br>SCYL3        97    108    49     59<br>C1orf112     46     57    43     15<br></code></pre><p data-tool="mdnice编辑器">是可以走后面的常规的转录组差异分析流程的！</p></section><h3 data-tool="mdnice编辑器"><span>文末友情宣传</span></h3><p data-tool="mdnice编辑器"><strong>强烈建议你推荐给身边的博士后以及年轻生物学PI，多一点数据认知，让他们的科研上一个台阶：</strong></p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247530001&amp;idx=1&amp;sn=676dcf224f9be23b288189775292aeeb&amp;chksm=9b4b36aaac3cbfbc3e3bb0865bd789d5093e3a643f3f345332995f707b7f209ae924e9e9529e&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买‍一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;scene=21#wechat_redirect" data-linktype="2">时隔5年，我们的生信技能树VIP学徒继续招生啦</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528363&amp;idx=1&amp;sn=5e02f3e9b2e148191e23ebc2c0d780e7&amp;scene=21#wechat_redirect" data-linktype="2">2024的共享服务器交个朋友福利价仍然是800</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;scene=21#wechat_redirect" data-linktype="2">千呼万唤始出来的独享生物信息学云服务器</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528144&amp;idx=1&amp;sn=be4d7e542d1077921024c86a4c130f16&amp;scene=21#wechat_redirect" data-linktype="2">永久免费的生信进阶培训（线下）</a></section></li></ul><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/O2z67WVGtPmBCDyhDrMpRQ",target="_blank" rel="noopener noreferrer">原文链接</a>
