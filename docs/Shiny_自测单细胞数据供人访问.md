---
title: "Shiny|自测单细胞数据供人访问"
date: 2023-01-09T03:56:30Z
draft: ["false"]
tags: [
  "fetched",
  "朴素的科研打工仔"
]
categories: ["Acdemic"]
---
Shiny|自测单细胞数据供人访问 by 朴素的科研打工仔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span>写在前面的话</span></h3><p><span>         </span><span><span>人工智能领域的卷反而降低了入门新领域的门槛，从ChatGPT了解使用Shiny包构建基于Seruat包的单细胞数据可视化平台---（汇报神器），代码记录~</span></span></p><p><span><span>后续重点会放在空转文献分享和工具学习，看好23年空转井喷式爆发！！</span></span></p><h3 data-tool="mdnice编辑器"><span>利用ChatGPT初步了解</span></h3><figure data-tool="mdnice编辑器"><img data-ratio="2.473846153846154" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc645gZXia5AhfIM9ribqYHyKrnyaXznGBoIPdfbPXHRCgWpauvqUjJdfX2ibUyM653nGEzXp7BL12eZWg/640?wx_fmt=png" data-type="png" data-w="975" src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc645gZXia5AhfIM9ribqYHyKrnyaXznGBoIPdfbPXHRCgWpauvqUjJdfX2ibUyM653nGEzXp7BL12eZWg/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span>Server.R</span></h3><p data-tool="mdnice编辑器"><span>为了减轻rds文件的大小，读取后再进行数据处理。</span></p><pre data-tool="mdnice编辑器"><span></span><code>library(shiny)<br>library(Seurat)<br>library(ggpubr)<br>options(shiny.maxRequestSize=<span>200000</span>*<span>1024</span>^<span>2</span>)<br>scRNA&lt;- readRDS(<span>"data/scRNA.rds"</span>)<br>scRNA1&lt;- readRDS(<span>"data/human_pig.rds"</span>)<br>DefaultAssay(scRNA) &lt;- <span>"RNA"</span><br>scRNA<span>@assays</span>$RNA<span>@data</span> &lt;- scRNA<span>@assays</span>$RNA<span>@counts</span><br>scRNA &lt;- NormalizeData(scRNA, normalization.method = <span>"LogNormalize"</span>, scale.factor = <span>10000</span>)<br>scRNA &lt;- ScaleData(scRNA, features = rownames(scRNA))<br>DefaultAssay(scRNA1) &lt;- <span>"RNA"</span><br>scRNA1<span>@assays</span>$RNA<span>@data</span> &lt;- scRNA1<span>@assays</span>$RNA<span>@counts</span><br>scRNA1 &lt;- NormalizeData(scRNA1, normalization.method = <span>"LogNormalize"</span>, scale.factor = <span>10000</span>)<br>scRNA1 &lt;- ScaleData(scRNA1, features = rownames(scRNA1))<br><br># Define server logic required to draw a histogram<br>color_cluster=c(<span>"#6AB3F4"</span>,<span>"#D459A2"</span>,<span>"#3A8F93"</span>,<span>"#FACC13"</span>,<br><span>"#5A7FF8"</span>,<span>"#3A3AC8"</span>,<br><span>"#8747E0"</span>,<span>"#12C2C4"</span>,<span>"#FF7B78"</span>,<br><span>"#B27EEC"</span>,<span>"#CE1222"</span>,<br><span>"#45CFCF"</span>,<span>"#EBA8A6"</span>,<span>"#FF6347"</span>,<span>"#F14764"</span>,<br><span>"#159CA1"</span>,<span>"#A21A6D"</span>,<br><span>"#EBA8A6"</span>,<span>"#e9148f"</span>,<br><span>"#AE6800"</span>,<span>"#32C35E"</span>,<span>"#5AC722"</span>)<br>names(color_cluster)=c(<span>"NK/NKT cells"</span>, <span>"T cells"</span>,<span>"Proliferation"</span>,<span>"Cycling NKT cells"</span>,<br><span>"Neutrophil-myeloid progenitors"</span>,<span>"Cycling T cells"</span>,<br><span>"Monocytes"</span>, <span>"cDC2"</span>,<span>"cDC1"</span>,<br><span>"B cells"</span>,<span>"Plasma B cells"</span>,<br><span>"Mesenchymal cells"</span>,<span>"HSC"</span>,<span>"Endothelial cells"</span>,<span>"Kupffer cells"</span>,<br><span>"Neutrophils"</span>,<span>"Myelocytes"</span>,<br><span>"Hepatocytes"</span>,<span>"Cholangiocytes"</span>,<br><span>"pDC"</span>,<span>"Basophils"</span>,<span>"Erythroid cells"</span>)<br>color_cluster1=c(<span>"#6AB3F4"</span>,<span>"#D459A2"</span>,<br><span>"#5A7FF8"</span>,<br><span>"#8747E0"</span>,<span>"#12C2C4"</span>,<span>"5AC722"</span>,<br><span>"#B27EEC"</span>,<br><span>"#45CFCF"</span>,<span>"#EBA8A6"</span>,<span>"#FF6347"</span>,<span>"#F14764"</span>,<br><span>"#159CA1"</span>,<span>"#A21A6D"</span>,<br><span>"#EBA8A6"</span>,<span>"#e9148f"</span>,<br><span>"#32C35E"</span>,<span>"#5AC722"</span>)<br>names(color_cluster1)=c(<span>"NK/NKT cells"</span>, <span>"T cells"</span>,<br><span>"Neutrophil-myeloid progenitors"</span>,<br><span>"Monocytes"</span>, <span>"cDC"</span>,<span>"Late erythroid"</span>,<br><span>"B/Plasma cells"</span>,<br><span>"Mesenchymal cells"</span>,<span>"HSC"</span>,<span>"Endothelial cells"</span>,<span>"Macrophage cells"</span>,<br><span>"Neutrophils"</span>,<span>"Myelocytes"</span>,<br><span>"Hepatocytes"</span>,<span>"Cholangiocytes"</span>,<br><span>"Basophils"</span>,<span>"Early/Mid erythroid"</span>)<br>color_group=c(<span>"#98BCDA"</span>,<span>"#EBA8A6"</span>)<br>names(color_group)=c(<span>"NBW"</span>,<span>"IUGR"</span>)<br>resubset&lt;-function(scRNA,gender,cluster){<br>  Idents(scRNA) &lt;- <span>"gender"</span><br>  scRNA &lt;- subset(scRNA,idents = gender)<br>  Idents(scRNA) &lt;- <span>"celltype"</span><br>  scRNA &lt;- subset(scRNA,idents = cluster)<br>}<br>plot&lt;-function(scRNA,gene,plot){<br>  <span>if</span>(plot == <span>"Vlnplot"</span>){<br>    VlnPlot(scRNA,features =gene,split.by = <span>"group"</span>,pt.size = <span>0.01</span>)+theme_bw()+<br>      theme(panel.grid = element_blank(), axis.text.x=element_text(hjust = <span>1</span>,vjust=<span>0.5</span>))}<br>  <span>else</span> <span>if</span>(plot == <span>"FeaturePlot"</span>){<br>    FeaturePlot(scRNA,features =gene,split.by = <span>"group"</span>,pt.size = <span>2</span>)}<br>  <span>else</span> <span>if</span>(plot == <span>"Dotplot"</span>){<br>    DotPlot(scRNA,features =gene,split.by = <span>"group"</span>)+theme_bw()+coord_flip()}<br>}<br><br><br>shinyServer(function(input, output){<br>    # Create the UMAP visualization and render it in the plot<br>    output$umap &lt;- renderPlot({<br>      DimPlot(scRNA, reduction = <span>"umap"</span>,label = T,label.box = T,cols = color_cluster,repel = T)+ NoLegend()<br>    })<br>    doplot &lt;- eventReactive(input$action,{<br>      plot(resubset(scRNA,input$gender,input$cluster),input$gene,input$method)})<br>    output$plot1 &lt;- renderPlot({doplot()})<br>    output$cluster&lt;-renderUI({<br>      clusterlist&lt;-unique(scRNA<span>@meta</span>.data$celltype)<br>      selectInput(<span>"cluster"</span>,<span>'Please select the cell type you are interested in:'</span>,list=as.vector(clusterlist))<br>    })<br>    output$gender&lt;-renderUI({<br>      genderlist&lt;-unique(scRNA<span>@meta</span>.data$gender)<br>      selectInput(<span>"gender"</span>,<span>'Please select the gender you are interested in:'</span>,list=as.vector(genderlist))<br>    })<br>    output$method&lt;-renderUI({<br>      selectInput(<span>"method"</span>,<span>'Please select the method to display'</span>,list=c(<span>"Vlnplot"</span>,<span>"FeaturePlot"</span>,<span>"Dotplot"</span>))<br>    })<br>    output$umap1&lt;- renderPlot({<br>      DimPlot(scRNA1, reduction = <span>"umap"</span>,label = T,label.box = T,cols = color_cluster1,repel = T)+ NoLegend()<br>    })<br>    doplot1 &lt;- eventReactive(input$action1,{<br>      plot(subset(scRNA1,idents=input$cluster1),input$gene1,input$method1)})<br>    output$plot2 &lt;- renderPlot({doplot1()})<br>    output$dataset &lt;- DT::renderDataTable({<br>      markers&lt;- read.csv(<span>"data/markers.csv"</span>,row.names = <span>1</span>)<br>      DT::datatable(markers,extensions = <span>'Buttons'</span>,<br>                    options = list(dom=<span>'Bfrtip'</span>,<br>                                   buttons=c(<span>'copy'</span>, <span>'csv'</span>, <span>'excel'</span>, <span>'print'</span>, <span>'pdf'</span>)),<br>                    caption=<span>"Table 1. irisdata"</span>,filter = <span>"top"</span>)})<br>    output$dataset1 &lt;- DT::renderDataTable({<br>      markers1&lt;- read.csv(<span>"data/markers1.csv"</span>,row.names = <span>1</span>)<br>      DT::datatable(markers1,extensions = <span>'Buttons'</span>,<br>                    options = list(dom=<span>'Bfrtip'</span>,<br>                                   buttons=c(<span>'copy'</span>, <span>'csv'</span>, <span>'excel'</span>, <span>'print'</span>, <span>'pdf'</span>)),<br>                    caption=<span>"Table 2. irisdata"</span>,filter = <span>"top"</span>)})<br>    output$plotDown &lt;- downloadHandler(<br>      filename = function(){<br>        paste0(input$gene, <span>'.'</span>,input$extPlot)<br>      },<br>      content = function(file){<br>        <span>if</span>(input$extPlot == <span>'pdf'</span>){<br>          pdf(file)<br>        }<span>else</span> <span>if</span>(input$extPlot == <span>'png'</span>){<br>          png(file)<br>        }<span>else</span>{<br>          jpeg(file)<br>        }<br>        print(plot(resubset(scRNA,input$gender,input$cluster),input$gene,input$method))<br>        dev.off()<br>      }<br>    )<br>    output$plotDown1 &lt;- downloadHandler(<br>      filename = function(){<br>        paste0(input$gene1, <span>'.'</span>,input$extPlot1)<br>      },<br>      content = function(file){<br>        <span>if</span>(input$extPlot == <span>'pdf'</span>){<br>          pdf(file)<br>        }<span>else</span> <span>if</span>(input$extPlot == <span>'png'</span>){<br>          png(file)<br>        }<span>else</span>{<br>          jpeg(file)<br>        }<br>        print(plot(subset(scRNA1,idents=input$cluster1),input$gene1,input$method1))<br>        dev.off()<br>      }<br>    )<br>  })<br></code></pre><h3 data-tool="mdnice编辑器"><span>ui.R</span></h3><pre data-tool="mdnice编辑器"><span></span><code>library(shiny)<br>scRNA&lt;- readRDS(<span>"data/scRNA.rds"</span>)<br>scRNA1&lt;- readRDS(<span>"data/human_pig.rds"</span>)<br><br># <span>Define UI <span>for</span> application that draws a histogram<br><span>shinyUI</span><span>(fluidPage(<br>  # Add a plot of the UMAP visualization<br>    navbarPage(<span>'WangLab'</span>,inverse = T,collapsible = T,<br>             tabPanel(<span>"Guide"</span>,titlePanel(<span>"Comprehensive single-cell transcriptional profile of IUGR piglet liver with high homology to human"</span>)</span><br>                      ,<span>h2</span><span>(<span>"Vignettes"</span>)</span>,<span>h3</span><span>(<span>"Intrauterine growth restriction (IUGR) is a problem in both human medicine and animal husbandry, and it has a direct impact on both the health and economy. This urgent event requires us to uncover the molecular mechanisms of the disease in order to create more potent interventional strategies. Herein, we constructed single-cell transcriptome profiles (n=41,969) of IUGRs and NBWs (female n=1, male n=3) one-week after birth. We discussed the difference in male and female IUGR, and established that pigs could sever as a useful model for researching on IUGR in humans.<br>                                          "</span>)</span>,<span>h3</span><span>(<span>"On this site, you may explore the variation in expression of IUGRs and NBWs across various subpopulations on the 'IUGR Piglets' page. Additionally on the 'Human and pigs' page, where the list of genes could be retrieved and downloaded, you could examine the levels of gene expression within different subpopulations of pigs and humans."</span>)</span><br>                      ,<span>h2</span><span>(<span>"Statement"</span>)</span>,<span>h3</span><span>(<span>"The dataset combines the following two studies."</span>)</span>,<br>                      <span>h4</span><span>(<span>"1.Popescu DM, Botting RA, Stephenson E, Green K, Webb S, Jardine L, Calderbank EF, Polanski K, Goh I, Efremova M, Acres M, Maunder D, Vegh P, Gitton Y, Park JE, Vento-Tormo R, Miao Z, Dixon D, Rowell R, McDonald D, Fletcher J, Poyner E, Reynolds G, Mather M, Moldovan C, Mamanova L, Greig F, Young MD, Meyer KB, Lisgo S, Bacardit J, Fuller A, Millar B, Innes B, Lindsay S, Stubbington MJT, Kowalczyk MS, Li B, Ashenberg O, Tabaka M, Dionne D, Tickle TL, Slyper M, Rozenblatt-Rosen O, Filby A, Carey P, Villani AC, Roy A, Regev A, Roberts I, Behjati S, Laurenti E, Teichmann SA, Haniffa M. Decoding human fetal liver haematopoiesis. Nature. 2019 Oct;574(7778):365-371. doi: 10.1038/s41586-019-1652-y<span title="DOI: 10.1038/s41586-019-1652-y" es-id-type="DOI" es-id="10.1038/s41586-019-1652-y" es-collect-button-id="6"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 1000 1000" enable-background="new 0 0 1000 1000" height="1em"></svg><br>        <br>        </span>. Epub 2019 Oct 9. PMID: 31597962<span title="PMID: 31597962" es-id-type="PMID" es-id="31597962" es-collect-button-id="7"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 1000 1000" enable-background="new 0 0 1000 1000" height="1em"></svg><br>        <br>        </span>; PMCID: PMC6861135<span title="PMCID: 6861135" es-id-type="PMCID" es-id="6861135" es-collect-button-id="8"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 1000 1000" enable-background="new 0 0 1000 1000" height="1em"></svg><br>        <br>        </span>.<br>                          "</span>)</span>,<span>h4</span><span>(<span>"2.Ramachandran P, Dobie R, Wilson-Kanamori JR, Dora EF, Henderson BEP, Luu NT, Portman JR, Matchett KP, Brice M, Marwick JA, Taylor RS, Efremova M, Vento-Tormo R, Carragher NO, Kendall TJ, Fallowfield JA, Harrison EM, Mole DJ, Wigmore SJ, Newsome PN, Weston CJ, Iredale JP, Tacke F, Pollard JW, Ponting CP, Marioni JC, Teichmann SA, Henderson NC. Resolving the fibrotic niche of human liver cirrhosis at single-cell level. Nature. 2019 Nov;575(7783):512-518. doi: 10.1038/s41586-019-1631-3<span title="DOI: 10.1038/s41586-019-1631-3" es-id-type="DOI" es-id="10.1038/s41586-019-1631-3" es-collect-button-id="9"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 1000 1000" enable-background="new 0 0 1000 1000" height="1em"></svg><br>        <br>        </span>. Epub 2019 Oct 9. PMID: 31597160<span title="PMID: 31597160" es-id-type="PMID" es-id="31597160" es-collect-button-id="10"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 1000 1000" enable-background="new 0 0 1000 1000" height="1em"></svg><br>        <br>        </span>; PMCID: PMC6876711<span title="PMCID: 6876711" es-id-type="PMCID" es-id="6876711" es-collect-button-id="11"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 1000 1000" enable-background="new 0 0 1000 1000" height="1em"></svg><br>        <br>        </span>."</span>)</span><br>                      ), <br>             <span>tabPanel</span><span>(<span>"IUGR Piglets"</span>,plotOutput(<span>"umap"</span>,width=<span>'60%'</span>,height=<span>'800px'</span>)</span>,<br>                      <span>sidebarLayout</span><span>(<br>                        sidebarPanel(<br>                          conditionalPanel(condition = <span>"input == ture"</span>,<br>                                           selectInput(<span>"gene"</span>, <span>"Please select the genes you are interested in:"</span>,<br>                                                       c(as.list(rownames(scRNA@assays$RNA@counts)</span>),"nCount_RNA","nFeature_RNA",<br>                                                         "percent_mito","percent_ribo","percent_hb"))),<br>                          <span>conditionalPanel</span><span>(condition = <span>"input.cluster==true"</span>,<br>                                           selectInput(<span>"cluster"</span>, <span>"Please select the cell type you are interested in:"</span>,<br>                                                       as.list(levels(scRNA)</span>))),<br>                          <span>conditionalPanel</span><span>(condition = <span>"input.gender==true"</span>,<br>                                           selectInput(<span>"gender"</span>, <span>"Please select the gender you are interested in:"</span>,<br>                                                       choices = c(<span>"female"</span>,<span>"male"</span>)</span>)),<br>                          <span>conditionalPanel</span><span>(condition = <span>"input.method==true"</span>,<br>                                           selectInput(<span>"method"</span>, <span>"Please select the method to display"</span>,<br>                                                       choices = c(<span>"Vlnplot"</span>,<span>"FeaturePlot"</span>,<span>"Dotplot"</span>)</span>)),<br>                          <span>actionButton</span><span>(<span>"action"</span>, <span>"Plot Expression"</span>,icon=icon(<span>'angle-double-right'</span>)</span>),<br>                          <span>radioButtons</span><span>(<span>'extPlot'</span>, <span>'Plot output format'</span>,<br>                                       choices = c(<span>"PNG"</span>=<span>'png'</span>, <span>'PDF'</span>=<span>'pdf'</span>,<span>'JPEG'</span>=<span>'jpeg'</span>)</span>, inline </span>= T),<br>                          helpText(<span>'Please choose the format of table and plot that you need, the download <br>               buttons are placed in respective tabs'</span>),<br>                          tags$style(<span>'#plotDown {background-color: red; color: white}'</span>)<br>                        ),<br>                        mainPanel(<br>                          plotOutput(<span>"plot1"</span>),downloadButton(<span>'plotDown'</span>,label=<span>"Download Plot"</span>),<br>                          DT::dataTableOutput(<span>"dataset"</span>)))),<br>             <br>             tabPanel(<span>"Human and pigs"</span>,plotOutput(<span>"umap1"</span>,width=<span>'60%'</span>,height=<span>'800px'</span>),<br>                      sidebarLayout(<br>                        sidebarPanel(<br>                          conditionalPanel(condition = <span>"input == ture"</span>,<br>                                           selectInput(<span>"gene1"</span>, <span>"Please select the genes you are interested in:"</span>,<br>                                                       c(as.list(rownames(scRNA1<span>@assays</span>$RNA<span>@counts</span>)),<span>"nCount_RNA"</span>,<span>"nFeature_RNA"</span>,<br>                                                         <span>"percent_mito"</span>,<span>"percent_ribo"</span>,<span>"percent_hb"</span>))),<br>                          conditionalPanel(condition = <span>"input.cluster==true"</span>,<br>                                           selectInput(<span>"cluster1"</span>, <span>"Please select the cell type you are interested in:"</span>,<br>                                                       as.list(levels(scRNA1)))),<br>                          conditionalPanel(condition = <span>"input.method==true"</span>,<br>                                           selectInput(<span>"method1"</span>, <span>"Please select the method to display"</span>,<br>                                                       choices = c(<span>"Vlnplot"</span>,<span>"FeaturePlot"</span>,<span>"Dotplot"</span>))),<br>                          actionButton(<span>"action1"</span>, <span>"Plot Expression"</span>,icon=icon(<span>'angle-double-right'</span>)),<br>                          radioButtons(<span>'extPlot1'</span>, <span>'Plot output format'</span>,<br>                                       choices = c(<span>"PNG"</span>=<span>'png'</span>, <span>'PDF'</span>=<span>'pdf'</span>,<span>'JPEG'</span>=<span>'jpeg'</span>), inline = T),<br>                          helpText(<span>'Please choose the format of table and plot that you need, the download <br>               buttons are placed in respective tabs'</span>),<br>                          tags$style(<span>'#plotDown1 {background-color: red; color: white}'</span>)<br>                        ),<br>                        mainPanel(<br>                          plotOutput(<span>"plot2"</span>),downloadButton(<span>'plotDown1'</span>,label=<span>"Download Plot"</span>),<br>                          DT::dataTableOutput(<span>"dataset1"</span>)))))<br>))<br><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>#最后就是运行啦，数据可以放在data文件下，新写函数放在www.文件下<br>runAPP()<br></code></pre><p data-tool="mdnice编辑器">最后效果如图：<img data-ratio="1.084070796460177" data-src="https://mmbiz.qpic.cn/mmbiz_gif/Ze2f5C6nc645gZXia5AhfIM9ribqYHyKrnRQCEQ9pTBk76p8J4dPOr2eJUgSw3icahicB3IicfXS1avl2XPZ3AGF3BA/640?wx_fmt=gif" data-type="gif" data-w="904" src="https://mmbiz.qpic.cn/mmbiz_gif/Ze2f5C6nc645gZXia5AhfIM9ribqYHyKrnRQCEQ9pTBk76p8J4dPOr2eJUgSw3icahicB3IicfXS1avl2XPZ3AGF3BA/640?wx_fmt=gif"></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/kq5xrjzdAHmYHv8t5m1JuA",target="_blank" rel="noopener noreferrer">原文链接</a>
