---
title: "copykat为什么没有infercnv直观呢"
date: 2023-01-04T01:21:11Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
copykat为什么没有infercnv直观呢 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>前些天我们在《生信技能树》公众号 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247509311&amp;idx=1&amp;sn=0f3f36330b0cbd5ef6f98b535a54e1b9&amp;scene=21#wechat_redirect" data-linktype="2">比较了copykat和infercnv这两个从单细胞转录组数据推断肿瘤拷贝数变异技术差异</a> ，发现了一个很有意思的现象，两者的拷贝数推断，从视觉呈现效果来说，基本上没有差别。都是可以看到我们人为掺入的normal细胞确实是没有拷贝数变异，而每个病人各自的拷贝数变异是差异很大的，但是总体上来说，都是有变异，可惜的是虽然infercnv判断水平细胞的恶性与否，符合我们前面的教程：<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247488962&amp;idx=1&amp;sn=07981663c1b632c8c0f2b10f4dc6f14e&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现09—上皮细胞可以区分为恶性与否</a> 提到了<strong>五千多个上皮细胞里面只有三千七百左右是恶性细胞</strong>，但是copykat却失败了！</p></blockquote><p data-tool="mdnice编辑器">其实 copykat 仅仅是算法判别的时候不如人意，但是可视化的时候仍然是肉眼可以明显区分二倍体正常细胞和非整倍体的癌症细胞，所以我们想看看具体做什么改进，可以绕过这个bug，首选项我们把全部的上皮细胞按照病人进行了拆分，得到如下所示 的每个病人独立的文件夹以及每个文件夹下面的expFile.txt   ！</p><pre data-tool="mdnice编辑器"><span></span><code>   81M <span>12</span>  <span>2</span> <span>10</span>:<span>09</span> S11/expFile.txt<br>  123M <span>12</span>  <span>2</span> <span>10</span>:<span>22</span> S21/expFile.txt<br>   84M <span>12</span>  <span>2</span> <span>10</span>:<span>41</span> S47/expFile.txt<br>   75M <span>12</span>  <span>2</span> <span>10</span>:<span>54</span> S50/expFile.txt<br>   78M <span>12</span>  <span>2</span> <span>11</span>:<span>05</span> S53/expFile.txt<br>   95M <span>12</span>  <span>2</span> <span>11</span>:<span>20</span> S56/expFile.txt<br>   95M <span>12</span>  <span>2</span> <span>11</span>:<span>34</span> S57/expFile.txt<br>   78M <span>12</span>  <span>2</span> <span>11</span>:<span>49</span> S58/expFile.txt<br>  107M <span>12</span>  <span>2</span> <span>12</span>:<span>01</span> S63/expFile.txt<br>   77M <span>12</span>  <span>2</span> <span>12</span>:<span>17</span> S65/expFile.txt<br>   87M <span>12</span>  <span>2</span> <span>12</span>:<span>29</span> S66/expFile.txt<br>   87M <span>12</span>  <span>2</span> <span>12</span>:<span>42</span> S69/expFile.txt<br>   79M <span>12</span>  <span>2</span> <span>12</span>:<span>56</span> S71/expFile.txt<br>   75M <span>12</span>  <span>2</span> <span>13</span>:<span>08</span> S72/expFile.txt<br>   76M <span>12</span>  <span>2</span> <span>13</span>:<span>19</span> S74/expFile.txt<br>   78M <span>12</span>  <span>2</span> <span>13</span>:<span>34</span> S78/expFile.txt<br>   77M <span>12</span>  <span>2</span> <span>13</span>:<span>45</span> S79/expFile.txt<br>   77M <span>12</span>  <span>2</span> <span>13</span>:<span>57</span> S81/expFile.txt<br>   84M <span>12</span>  <span>2</span> <span>14</span>:<span>09</span> S82/expFile.txt<br></code></pre><p data-tool="mdnice编辑器">这样我只需要写一个简单的脚本 step4-run-copykat.R  ，就可以并行全部的样品的方式进行曲线救国，也算是并行计算。</p><p data-tool="mdnice编辑器">这个 简单的脚本 step4-run-copykat.R   内容在 《生信技能树》公众号 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247509311&amp;idx=1&amp;sn=0f3f36330b0cbd5ef6f98b535a54e1b9&amp;scene=21#wechat_redirect" data-linktype="2">比较了copykat和infercnv这两个从单细胞转录组数据推断肿瘤拷贝数变异技术差异</a> 。</p><p data-tool="mdnice编辑器">下面的shell脚本  ：</p><pre data-tool="mdnice编辑器"><span></span><code>ls -d S*|<span>while</span> <span>read</span> id;<span>do</span><br><span>echo</span> <span>$id</span>;<br><span>cd</span> <span>$id</span>;<br>nohup Rscript.exe ../scripts/step4-run-copykat.R &amp;<br><span>cd</span> ../<br><span>done</span><br></code></pre><p data-tool="mdnice编辑器">很容易看到了每个病人的单细胞水平细胞表达量矩阵跑这个copykat流程耗费时间：</p><pre data-tool="mdnice编辑器"><span></span><code>S11/nohup.out:Time difference of 54.33337 mins<br>S21/nohup.out:Time difference of 1.20906 hours<br>S47/nohup.out:Time difference of 54.88378 mins<br>S50/nohup.out:Time difference of 43.44914 mins<br>S53/nohup.out:Time difference of 51.72247 mins<br>S56/nohup.out:Time difference of 1.020941 hours<br>S57/nohup.out:Time difference of 1.001784 hours<br>S58/nohup.out:Time difference of 52.24233 mins<br>S63/nohup.out:Time difference of 1.096883 hours<br>S65/nohup.out:Time difference of 45.49075 mins<br>S66/nohup.out:Time difference of 56.40917 mins<br>S69/nohup.out:Time difference of 56.40654 mins<br>S71/nohup.out:Time difference of 52.58897 mins<br>S72/nohup.out:Time difference of 42.06179 mins<br>S74/nohup.out:Time difference of 47.09917 mins<br>S78/nohup.out:Time difference of 49.3231 mins<br>S79/nohup.out:Time difference of 50.86545 mins<br>S81/nohup.out:Time difference of 44.29561 mins<br>S82/nohup.out:Time difference of 45.59241 mins<br></code></pre><p data-tool="mdnice编辑器">而且我简单看了看这些病人的二倍体正常细胞和非整倍体细胞的判别差异：</p><pre data-tool="mdnice编辑器"><span></span><code>tail -n  6  S*/nohup.out<br>==&gt; S11/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                177       0<br>  ref-Bcells           7     389<br>  ref-Tcells           0     478<br>  spike-Bcells         6     235<br>  spike-Tcells         0     289<br><br>==&gt; S21/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                935      23<br>  ref-Bcells           9     393<br>  ref-Tcells           0     480<br>  spike-Bcells         4     241<br>  spike-Tcells         0     289<br><br>==&gt; S47/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                195      13<br>  ref-Bcells           9     385<br>  ref-Tcells           0     477<br>  spike-Bcells         6     232<br>  spike-Tcells         0     289<br><br>==&gt; S50/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                 27       8<br>  ref-Bcells         316      77<br>  ref-Tcells          20     457<br>  spike-Bcells       184      55<br>  spike-Tcells        24     265<br><br>==&gt; S53/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                 74      27<br>  ref-Bcells           0     393<br>  ref-Tcells           0     477<br>  spike-Bcells         1     238<br>  spike-Tcells         0     289<br><br>==&gt; S56/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                348     114<br>  ref-Bcells           0     399<br>  ref-Tcells           0     477<br>  spike-Bcells         0     241<br>  spike-Tcells         0     289<br><br>==&gt; S57/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                104     356<br>  ref-Bcells           0     395<br>  ref-Tcells           0     477<br>  spike-Bcells         0     239<br>  spike-Tcells         0     289<br><br>==&gt; S58/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                 96       2<br>  ref-Bcells         311      82<br>  ref-Tcells          16     461<br>  spike-Bcells       180      60<br>  spike-Tcells        18     271<br><br>==&gt; S63/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                605      80<br>  ref-Bcells           0     400<br>  ref-Tcells           1     477<br>  spike-Bcells         0     243<br>  spike-Tcells         0     289<br><br>==&gt; S65/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                 56      28<br>  ref-Bcells         307      84<br>  ref-Tcells          32     445<br>  spike-Bcells       190      45<br>  spike-Tcells        29     257<br><br>==&gt; S66/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                266      19<br>  ref-Bcells          16     379<br>  ref-Tcells           0     478<br>  spike-Bcells         9     234<br>  spike-Tcells         2     287<br><br>==&gt; S69/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                290       3<br>  ref-Bcells           7     391<br>  ref-Tcells           0     479<br>  spike-Bcells         5     238<br>  spike-Tcells         0     289<br><br>==&gt; S71/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                 71      52<br>  ref-Bcells           0     393<br>  ref-Tcells           0     477<br>  spike-Bcells         0     240<br>  spike-Tcells         0     289<br><br>==&gt; S72/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                 28       2<br>  ref-Bcells         317      75<br>  ref-Tcells          29     448<br>  spike-Bcells       188      47<br>  spike-Tcells        32     254<br><br>==&gt; S74/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                 48      25<br>  ref-Bcells           0     393<br>  ref-Tcells           0     477<br>  spike-Bcells         1     238<br>  spike-Tcells         0     289<br><br>==&gt; S78/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                 94       8<br>  ref-Bcells         317      75<br>  ref-Tcells          35     442<br>  spike-Bcells       192      44<br>  spike-Tcells        31     255<br><br>==&gt; S79/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                 46      53<br>  ref-Bcells         313      80<br>  ref-Tcells          28     449<br>  spike-Bcells       183      57<br>  spike-Tcells        31     258<br><br>==&gt; S81/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                 75       3<br>  ref-Bcells         309      83<br>  ref-Tcells          21     456<br>  spike-Bcells       187      49<br>  spike-Tcells        20     266<br><br>==&gt; S82/nohup.out &lt;==<br>               aneuploid diploid<br>  epi                 70      15<br>  ref-Bcells          83     308<br>  ref-Tcells         455      22<br>  spike-Bcells        49     186<br>  spike-Tcells       259      27<br></code></pre><p data-tool="mdnice编辑器">这样就很有意思，可以看到是有一半的病人里面的单细胞出现非常诡异的判别，比如这个S82/nohup.out ，它里面的大量的ref和spike都被判定为恶性细胞。让我们看看它的图表：</p><p><img data-galleryid="" data-ratio="0.625" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjR4rPQnwncvxRjfpUmgxibc3EPz9nHLG6C4YmDn88Sib5ohibABRDapWicZP9FW1gpSibwna2vZBXy9QPA/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjR4rPQnwncvxRjfpUmgxibc3EPz9nHLG6C4YmDn88Sib5ohibABRDapWicZP9FW1gpSibwna2vZBXy9QPA/640?wx_fmt=jpeg"></p><figure data-tool="mdnice编辑器"><figcaption>test_copykat_heatmap</figcaption></figure><p data-tool="mdnice编辑器">确实有点奇特哦，这个时候肉眼跟软件其实是一样的！而且我去看了它的inferCNV结果，如下所示：</p><p><img data-galleryid="" data-ratio="0.94375" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR4rPQnwncvxRjfpUmgxibc3zyC0vCicFov2TLjzyqlzicuQjclcyJ094rCPicHbS2RSEibIqjqgTH0bIw/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR4rPQnwncvxRjfpUmgxibc3zyC0vCicFov2TLjzyqlzicuQjclcyJ094rCPicHbS2RSEibIqjqgTH0bIw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>infercnv</figcaption></figure><p data-tool="mdnice编辑器">可以看到，copykat 仅仅是没有infercnv直观，但是在这样的恶性细胞比例不高的病人数据里面，确实效果上没有太多区别，跟肉眼判断细胞恶性与否的结论也比较吻合！copykat 虽然把大量的ref和spike错误的判定为恶性细胞，但是很明显我们看图就会反过来把前面的恶性上皮细胞定义为正常细胞。这个时候根据有一些唯心主义的嫌疑了。</p><p data-tool="mdnice编辑器">虽然 copykat 仅仅是没有infercnv直观，但是copykat至少给出来了 aneuploid 和 diploid的判断，inferCNV给出来的结果文件，仍然是需要自己读取，自己计算cnv打分，自己去给一个阈值来区分细胞的恶性与否。这个步骤也很考验大家的编程功底。至少需要熟读下面的5个教程：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247489282&amp;idx=1&amp;sn=d81a74aa99bdc3a69acada89cd1b7131&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现13—使用inferCNV来区分肿瘤细胞的恶性与否</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247489339&amp;idx=1&amp;sn=d39302fdced178133152119a078f1d5b&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现14—检查文献的inferCNV流程</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247489344&amp;idx=1&amp;sn=d9f6737e936b529f5632b8881551baee&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现15—inferCNV流程输入数据差异大揭秘</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247489430&amp;idx=1&amp;sn=4927b01a07638b14d8cf78b471ac8950&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现16—inferCNV结果解读及利用</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247489446&amp;idx=1&amp;sn=7e38ae02c7918d6c9af5c840946bc560&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现17—inferCNV结果解读及利用之进阶</a></section></li></ul><p data-tool="mdnice编辑器">如果你也有自己的肿瘤相关单细胞数据的拷贝数变异分析需求， 而且自己多方尝试总是报错，欢迎留言委托我们哈。<span>肿瘤相关单细胞数据的拷贝数变异</span>单项分析2400，如果需要前面的降维聚类分群需要再多加800，提供区分样品的独立copykat和infercnv流程，以及合并的copykat和infercnv流程的全部结果和代码文件夹。</p><p data-tool="mdnice编辑器">需要注意的是，我们并不会保留中间的txt等文件，因为它实在是太耗费磁盘空间了，比如我们演示的这个项目就20多个病人的不到7000个上皮细胞，走这个copykat和infercnv流程流程，得到了接近100G的文件：</p><pre data-tool="mdnice编辑器"><span></span><code> 11G ./4-3-only-Epi<br>478M ./Rdata-celltype<br> 81G ./epi-one-by-one<br></code></pre><p data-tool="mdnice编辑器">确实有点可怕，这些东西上传到云盘就需要一两年了，如果不开通超级会员的话。</p></section><ul data-tool="mdnice编辑器" data-darkmode-bgcolor-16340316661513="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16340316661513="#fff|rgb(255, 255, 255)" data-darkmode-color-16340316661513="rgb(163, 163, 163)" data-darkmode-original-color-16340316661513="#fff|rgb(0, 0, 0)" data-style='margin-top: 8px; margin-bottom: 8px; padding-left: 25px; width: 577.422px; white-space: normal; outline: 0px; letter-spacing: 0.544px; background-color: rgb(255, 255, 255); caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, "PingFang SC", Cambria, Cochin, Georgia, Times, "Times New Roman", serif; font-size: 16px; text-align: left; text-size-adjust: auto;'><li><p data-darkmode-bgcolor-16340316661513="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16340316661513="#fff|rgb(255, 255, 255)" data-darkmode-color-16340316661513="rgb(163, 163, 163)" data-darkmode-original-color-16340316661513="#fff|rgb(0, 0, 0)"><span data-darkmode-bgcolor-16340316661513="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16340316661513="#fff|rgb(255, 255, 255)" data-darkmode-color-16340316661513="rgb(163, 163, 163)" data-darkmode-original-color-16340316661513="#fff|rgb(0, 0, 0)">扫描下面二维码即可添加微信咨询！</span></p><section data-darkmode-bgcolor-16340316661513="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16340316661513="#fff|rgb(255, 255, 255)" data-darkmode-color-16340316661513="rgb(163, 163, 163)" data-darkmode-original-color-16340316661513="#fff|rgb(0, 0, 0)">（添加好友务必备注 高校或者工作单位+姓名，方便后续认识）</section></li><li><p data-darkmode-bgcolor-16340316661513="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16340316661513="#fff|rgb(255, 255, 255)" data-darkmode-color-16340316661513="rgb(163, 163, 163)" data-darkmode-original-color-16340316661513="#fff|rgb(0, 0, 0)|rgb(62, 62, 62)" data-style='outline: 0px; caret-color: rgb(51, 51, 51); text-size-adjust: auto; letter-spacing: 2px; color: rgb(62, 62, 62); font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif; font-size: 15px; word-spacing: 2px; text-align: center;'><img data-ratio="1.1700680272108843" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxvmNvIclfRGEpWuxOMxdq2rJV1jmplnEuXDDDPfEsMLbHvLCWVX4uFobR9uj6JQfxMysCQyyK9wg/640?wx_fmt=png" data-type="png" data-w="294" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxvmNvIclfRGEpWuxOMxdq2rJV1jmplnEuXDDDPfEsMLbHvLCWVX4uFobR9uj6JQfxMysCQyyK9wg/640?wx_fmt=png"></p></li></ul></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/EtnWWJm9wCA_u49doVeb5w",target="_blank" rel="noopener noreferrer">原文链接</a>
