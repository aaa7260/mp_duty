---
title: "用小饼图代替点图里的点"
date: 2023-01-10T07:54:27Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
用小饼图代替点图里的点 by 生信星球
------
<div><section data-mpa-powered-by="yiban.io"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第891天</strong></span></span><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><p><span><span>   </span><span>大神一句话，菜鸟跑半年。我不是大神，但我可以缩短你走弯路的半年~</span></span></p><p><span>   就像歌儿唱的那样，如果你不知道该往哪儿走，就留在这学点生信好不好~</span></p><p><span>   这里有豆豆和花花的学习历程，从新手到进阶，生信路上有你有我!</span></p><h3 data-tool="mdnice编辑器"><span></span></h3><p>0.起因</p><span></span><section>最近在群里看到一个图，棒棒糖图的点用饼图代替了。</section><section><figure data-tool="mdnice编辑器"><img data-ratio="0.31382978723404253" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6s18sZpIRnxk3atz0BAOrEofHjUVX0XhHTJicM02UmjiaIdbBLmLf0jDw/640?wx_fmt=jpeg" data-type="jpeg" data-w="1128" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6s18sZpIRnxk3atz0BAOrEofHjUVX0XhHTJicM02UmjiaIdbBLmLf0jDw/640?wx_fmt=jpeg"></figure></section><section>然后又看到一个文章里，用饼图代替了富集分析的点图，妙啊~</section><section><figure data-tool="mdnice编辑器"><img data-ratio="0.6545123062898814" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6AXFMhCxyT2Sibxn4MbazI6urBrnXyPh5mPwibq4qOLc0kY9SddCXIvVw/640?wx_fmt=png" data-type="png" data-w="1097" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6AXFMhCxyT2Sibxn4MbazI6urBrnXyPh5mPwibq4qOLc0kY9SddCXIvVw/640?wx_fmt=png"></figure></section><section>这个地球上有什么漂亮的图能躲过我的小胖手呢？画他！</section><h3 data-tool="mdnice编辑器"><span></span><span>1.搜索</span><span></span></h3><section>试了几个不同的关键词，最后这样搜到了。</section><section><figure data-tool="mdnice编辑器"><img data-ratio="0.7403225806451613" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6jliata5Oz4qgVLCLibdygzuukV9ZjCROj4mgAm31bhkqcv4lQ3R6y11A/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6jliata5Oz4qgVLCLibdygzuukV9ZjCROj4mgAm31bhkqcv4lQ3R6y11A/640?wx_fmt=png"></figure></section><section>答案指向一个包，名叫scatterpie。一看作者，啊，这不是Y叔嘛~</section><h3 data-tool="mdnice编辑器"><span></span><span>2. 跑示例代码</span><span></span></h3><h4 data-tool="mdnice编辑器"><span>2.1 示例数据</span></h4><pre data-tool="mdnice编辑器"><span></span><section>set.seed(123)<br>long &lt;- rnorm(50, sd=100)<br>lat &lt;- rnorm(50, sd=50)<br>d &lt;- data.frame(long=long, lat=lat)<br>d &lt;- with(d, d[abs(long) &lt; 150 &amp; abs(lat) &lt; 70,])<br>n &lt;- nrow(d)<br>d<span>$region</span> &lt;- factor(1:n)<br>d<span>$A</span> &lt;- abs(rnorm(n, sd=1))<br>d<span>$B</span> &lt;- abs(rnorm(n, sd=2))<br>d<span>$C</span> &lt;- abs(rnorm(n, sd=3))<br>d<span>$D</span> &lt;- abs(rnorm(n, sd=4))<br>d[1, 4:7] &lt;- d[1, 4:7] * 3<br>head(d)<br><br><span>##          long        lat region          A        B        C        D</span><br><span>## 1  -56.047565  12.665926      1 2.13121969 8.663359 3.928711 8.676792</span><br><span>## 2  -23.017749  -1.427338      2 0.25688371 1.403569 1.375096 4.945092</span><br><span>## 4    7.050839  68.430114      3 0.24669188 0.524395 3.189978 5.138863</span><br><span>## 5   12.928774 -11.288549      4 0.34754260 3.144288 3.789556 2.295894</span><br><span>## 8 -126.506123  29.230687      5 0.95161857 3.029335 1.048951 2.471943</span><br><span>## 9  -68.685285   6.192712      6 0.04502772 3.203072 2.596539 4.439393</span><br></section></pre><h4 data-tool="mdnice编辑器"><span>2.2 示例图片</span></h4><pre data-tool="mdnice编辑器"><span></span><section>library(ggplot2)<br>library(scatterpie)<br>ggplot() + <br>  geom_scatterpie(aes(x=long, <br>                      y=lat), <br>                  data=d,<br>                  cols=LETTERS[1:4]) + <br>  coord_equal()<br></section></pre><section><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6dEvFHg9d0UGLh2cFB0XV9UQapTPw8oqjdypKxOz8DZ9KibAXS7x9iccw/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6dEvFHg9d0UGLh2cFB0XV9UQapTPw8oqjdypKxOz8DZ9KibAXS7x9iccw/640?wx_fmt=png"></figure></section><h3 data-tool="mdnice编辑器"><span></span><span>3.仿造示例数据并画图</span><span></span></h3><h4 data-tool="mdnice编辑器"><span>3.1找个数据做差异分析</span></h4><pre data-tool="mdnice编辑器"><span></span><section>library(tinyarray)<br>library(dplyr)<br>library(org.Hs.eg.db)<br>gse = <span>"GSE42872"</span><br>geo = geo_download(gse)<br>Group = rep(c(<span>"control"</span>,<span>"treat"</span>),each = 3)<br>Group = factor(Group)<br>find_anno(geo<span>$gpl</span>)<br><br><span>## [1] "`library(hugene10sttranscriptcluster.db);ids &lt;- toTable(hugene10sttranscriptclusterSYMBOL)` and `ids &lt;- AnnoProbe::idmap('GPL6244')` are both avaliable"</span><br><br>ids &lt;- AnnoProbe::idmap(geo<span>$gpl</span>,destdir = tempdir())<br>deg = get_deg(geo<span>$exp</span>,Group,ids,logFC_cutoff = 2)<br>head(deg)<br><br><span>##       logFC   AveExpr         t      P.Value    adj.P.Val        B probe_id</span><br><span>## 1  5.780170  7.370282  82.94833 3.495205e-12 1.163798e-07 16.32898  8133876</span><br><span>## 2 -4.212683  9.106625 -68.40113 1.437468e-11 2.393169e-07 15.71739  7965335</span><br><span>## 3  5.633027  8.763220  57.61985 5.053466e-11 4.431880e-07 15.04752  7972259</span><br><span>## 4 -3.801663  9.726468 -57.21112 5.324059e-11 4.431880e-07 15.01709  7972217</span><br><span>## 5  3.263063 10.171635  50.51733 1.324638e-10 8.821294e-07 14.45166  8129573</span><br><span>## 6 -3.843247  9.667077 -45.87910 2.681063e-10 1.487856e-06 13.97123  8015806</span><br><span>##   symbol change ENTREZID</span><br><span>## 1   CD36     up      948</span><br><span>## 2  DUSP6   down     1848</span><br><span>## 3    DCT     up     1638</span><br><span>## 4  SPRY2   down    10253</span><br><span>## 5  MOXD1     up    26002</span><br><span>## 6   ETV4   down     2118</span><br><br>table(deg<span>$change</span>)<br><br><span>## </span><br><span>##   down stable     up </span><br><span>##     48  18092     82</span><br></section></pre><h4 data-tool="mdnice编辑器"><span>3.2 用差异基因做富集分析</span></h4><pre data-tool="mdnice编辑器"><span></span><section>gene_up = deg<span>$symbol</span>[deg<span>$change</span>==<span>"up"</span>]<br>gene_down = deg<span>$symbol</span>[deg<span>$change</span>==<span>"down"</span>]<br>gene_diff = c(gene_up,gene_down)<br>length(gene_diff)<br><br><span>## [1] 130</span><br><br>head(gene_diff)<br><br><span>## [1] "CD36"       "DCT"        "MOXD1"      "NUPR1"      "ST6GALNAC2"</span><br><span>## [6] "TXNIP"</span><br><br>g = quick_enrich(gene_diff,kkgo_file = <span>"kk_gop.Rdata"</span>)<br><br>dat = g<span>$go</span>@result %&gt;% <br>  arrange(pvalue) %&gt;% <br>  filter(ONTOLOGY==<span>"BP"</span>) %&gt;% <br>  head(10) %&gt;% <br>  mutate(Description = factor(Description,levels = Description))<br><br>p1 = ggplot(dat)+<br>  geom_point(aes(x = -log10(pvalue),y = Description))+<br>  theme_bw()<br>p1<br></section></pre><section><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6cU7vxDIxYUhHF1SCb2NibC3nL6JlnIibK8tTkE4fiazpZgPbznmIMy5Dg/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6cU7vxDIxYUhHF1SCb2NibC3nL6JlnIibK8tTkE4fiazpZgPbznmIMy5Dg/640?wx_fmt=png"></figure></section><h4 data-tool="mdnice编辑器"><span>3.3 计算每条term的上下调基因数量</span></h4><pre data-tool="mdnice编辑器"><span></span><section>library(stringr)<br>p = str_split(dat<span>$geneID</span>,<span>"/"</span>)<br>names(p) = dat<span>$ID</span><br>get_num = <span>function</span>(x){<br>  c(sum(x %<span>in</span>% gene_up),sum(x %<span>in</span>% gene_down))<br>}<br>re = sapply(p, get_num) %&gt;% t() %&gt;% as.data.frame()<br>rownames(re) = names(p)<br>colnames(re) = c(<span>"up"</span>,<span>"down"</span>)<br></section></pre><h4 data-tool="mdnice编辑器"><span>3.4 仿制示例数据并画图</span></h4><section>试了一下，如果纵坐标是分类变量是会报错的。。。</section><section>所以曲线救国，先生成一组连续型数据，然后改刻度值。</section><section>而需要保持饼图的形状是圆的，又需要固定坐标系,横纵坐标刻度是一样的。</section><section>这时候难度就来了，需要生成的纵坐标得是和横坐标范围一致的等差数列，用seq函数。</section><pre data-tool="mdnice编辑器"><span></span><section>dp = cbind(lp = -log10(dat<span>$pvalue</span>),<br>           Description = dat<span>$Description</span>,<br>           re)<br>dp<span>$lab</span> = seq(min(dp<span>$lp</span>), max(dp<span>$lp</span>), length.out = nrow(dp))<br>head(dp)<br><br><span>##                  lp                                            Description up</span><br><span>## GO:0071900 7.264160 regulation of protein serine/threonine kinase activity  5</span><br><span>## GO:0050673 6.929666                          epithelial cell proliferation  8</span><br><span>## GO:0043405 6.351294                      regulation of MAP kinase activity  5</span><br><span>## GO:0009314 5.748852                                  response to radiation  6</span><br><span>## GO:0010165 5.691160                                      response to X-ray  0</span><br><span>## GO:0071214 5.635287                  cellular response to abiotic stimulus  6</span><br><span>##            down      lab</span><br><span>## GO:0071900   10 5.525307</span><br><span>## GO:0050673    8 5.718513</span><br><span>## GO:0043405    5 5.911719</span><br><span>## GO:0009314    8 6.104925</span><br><span>## GO:0010165    5 6.298131</span><br><span>## GO:0071214    6 6.491337</span><br><br>p2 = ggplot() + <br>  geom_scatterpie(aes(x=lp, <br>                      y=lab), <br>                  data=dp,<br>                  cols=colnames(re),<br>                  pie_scale = 1.5) +<br>  theme_bw()+<br>  scale_fill_manual(values = c(<span>"#f87669"</span>, <span>"#2874C5"</span>))+<br>  scale_y_continuous(labels = dp<span>$Description</span>,breaks = dp<span>$lab</span>)+<br>  labs(x = <span>"-log10(pvalue)"</span>,y = <span>"Description"</span>)+<br>  coord_equal()<br>p2<br></section></pre><section><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6uaYicHUJRpm7KmMWiciceeRtPgmrtDvkU4q4dpwzbwg37FQ28p8V29iadg/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6uaYicHUJRpm7KmMWiciceeRtPgmrtDvkU4q4dpwzbwg37FQ28p8V29iadg/640?wx_fmt=png"></figure></section><h4 data-tool="mdnice编辑器"><span>3.5 要棒棒糖还不简单嘛</span></h4><pre data-tool="mdnice编辑器"><span></span><section>p2 + geom_segment(data = dp, aes(x=as.integer(min(dp<span>$lp</span>)), xend=lp, y=lab, yend=lab))<br></section></pre><section><figure data-tool="mdnice编辑器"><img data-croporisrc="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E62aKnsMDxfDSKrbTMHPfQlM4s0rZDUW17VXhzhLHlhbOSCMuB7zOsaw/640?wx_fmt=png" data-cropx1="0" data-cropx2="1080" data-cropy1="0" data-cropy2="599.7923875432526" data-ratio="0.5555555555555556" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6L7rSQupXktd8dicEpWhqoPDRe42VUfjMaGDScTKZXVUfGYybxibyrSEQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHrNeAPN0HveUPaVxbCe91E6L7rSQupXktd8dicEpWhqoPDRe42VUfjMaGDScTKZXVUfGYybxibyrSEQ/640?wx_fmt=jpeg"></figure></section><p><span><br></span></p><section><blockquote><section><span>如果因为代码看不懂，而跟不上正文的节奏，可以来找我，系统学习。我的</span><span>课程都是循环开课。</span><span>下一期的时间，点进去咨询微信咯</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247492627&amp;idx=1&amp;sn=614671537676eece45244aa1cbe94b15&amp;chksm=fdfbac51ca8c25475c71ed3b7b3506391a8d08149acfd62d0666193e382b33634382bef4f80d&amp;scene=21#wechat_redirect" textvalue="产假结束，核酸尚阴，期待遇见2023年的你" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">产假结束，核酸尚阴，期待遇见2023年的你</a><br></section></blockquote></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/U32FRF2hh-Y3hsy_0hfe3g",target="_blank" rel="noopener noreferrer">原文链接</a>
