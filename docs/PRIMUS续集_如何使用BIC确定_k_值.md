---
title: "PRIMUS续集：如何使用BIC确定 k 值"
date: 2023-01-29T14:03:39Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
PRIMUS续集：如何使用BIC确定 k 值 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">接上篇</p><h1 data-tool="mdnice编辑器"><span></span>贝叶斯信息准则</h1><p data-tool="mdnice编辑器">在上篇提到，PRIMUS 的k值很关键，但还没有指出如何确定k值。作者提及Bayesian information criterion (BIC) 是一个统计学概念。在统计学中，贝叶斯信息准则（BIC）是在有限的模型集合中选择模型的准则；通常首选BIC较低的型号。它部分基于似然函数，与Akaike信息准则（AIC）密切相关。 </p><p data-tool="mdnice编辑器">BIC=k*ln(n)-2 ln(L)</p><p data-tool="mdnice编辑器">注：L是在该模型下的最大似然，n是数据数量，k是模型的变量个数。</p><p data-tool="mdnice编辑器">那么如何实现PRIMUS BIC分析？</p><h1 data-tool="mdnice编辑器"><span></span>BIC 代码实现</h1><p data-tool="mdnice编辑器">我们回到前面的代码：</p><p data-tool="mdnice编辑器"><span>读入数据</span></p><pre data-tool="mdnice编辑器"><span></span><code>rm(list= ls())<br>library(SingleCellExperiment)<br>library(scuttle)<br>library(data.table)<br>library(dplyr)<br>rm(list = ls())<br><span>#</span><span><span># 数据准备</span></span><br>counts = fread('./dataset4/myData_pancreatic_5batches.txt.gz') %&gt;% as.data.frame()<br>rownames(counts) &lt;- counts$V1; counts &lt;- counts[,2:ncol(counts)]<br>dim(counts)<br>head(counts)[1:5,1:2]<br>meta = fread('./dataset4/mySample_pancreatic_5batches.txt.gz',) %&gt;% as.data.frame()<br>rownames(meta) &lt;- meta$V1; meta &lt;- meta[,2:ncol(meta)]<br>head(meta)[1:5,1:3]<br>colnames(meta)<br>dim(meta)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>抽样（考虑后续循环次数较多，减少细胞量）<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>table(meta$</span><span>celltype, meta<span>$batch</span>) </span><br><span>#</span><span>&gt;                  1    2    3    4    5</span><br><span>#</span><span>&gt;   acinar        958  219  185    6    0</span><br><span>#</span><span>&gt;   alpha        2326  812  886  190  886</span><br><span>#</span><span>&gt;   beta         2525  448  270  111  472</span><br><span>#</span><span>&gt;   delta         601  193  114    9   49</span><br><span>#</span><span>&gt;   ductal       1077  245  386   96    0</span><br><span>#</span><span>&gt;   endothelial   252   21   16    0    0</span><br><span>#</span><span>&gt;   epsilon        18    3    7    0    0</span><br><span>#</span><span>&gt;   gamma         255  101  197   18   85</span><br><span>#</span><span>&gt;   macrophage     55    0    0    0    0</span><br><span>#</span><span>&gt;   mast           25    0    7    0    0</span><br><span>#</span><span>&gt;   mesenchymal     0   80    0   27    0</span><br><span>#</span><span>&gt;   MHC class II    0    0    5    0    0</span><br><span>#</span><span>&gt;   schwann        13    0    0    0    0</span><br><span>#</span><span>&gt;   stellate      457    0   54    0    0</span><br><span>#</span><span>&gt;   t_cell          7    0    0    0    0</span><br>allCells=rownames(meta)<br>allbatch = levels(factor(meta$batch))<br>choose_Cells = unlist(lapply(allbatch, function(x){<br>  cgCells = allCells[meta$batch == x]<br>  cg=sample(cgCells,100,replace = F)  # 减少至100 个<br>  cg<br>}))<br><br>Ct &lt;- counts[,choose_Cells]<br>mt &lt;- meta[choose_Cells,]<br><span><br>table(mt$</span><span>celltype, mt<span>$batch</span>)             </span><br><span>#</span><span>&gt;                1  2  3  4  5</span><br><span>#</span><span>&gt;   acinar      13 11  9  1  0</span><br><span>#</span><span>&gt;   alpha       25 40 36 36 53</span><br><span>#</span><span>&gt;   beta        27 23 16 24 38</span><br><span>#</span><span>&gt;   delta        6 11  9  3  3</span><br><span>#</span><span>&gt;   ductal      14 11 18 22  0</span><br><span>#</span><span>&gt;   endothelial  3  0  1  0  0</span><br><span>#</span><span>&gt;   gamma        3  3  9  5  6</span><br><span>#</span><span>&gt;   mesenchymal  0  1  0  9  0</span><br><span>#</span><span>&gt;   stellate     9  0  2  0  0</span><br></code></pre><h4 data-tool="mdnice编辑器"><span></span>构建SingleCellExperiment对象<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>simData = logNormCounts(SingleCellExperiment(assays = list(counts = Ct )))<br><br>simData<br>library(prism) # 使用作者推荐的方式prism::prism.gain 获取 scaling factor<br>Ct &lt;- as.matrix(Ct)<br>dim(Ct)<br><span>mt$</span><span>sizeFactor  &lt;- prism::prism.gain(X = Ct,method = <span>'poi'</span>,alpha = 1 )<span>$v</span></span><br><br></code></pre><h4 data-tool="mdnice编辑器"><span></span>PRIMUS 运算<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>library(PRIMUS)<br><br>labels2weights &lt;- function(L, levels = sort(unique(L)))<br>  return (outer(L, levels, `==`) + 0L)<br><br>D = t(labels2weights(mt$batch))<br><br>library(tidyverse)<br><span>#</span><span><span>## 使用循环，设置k值1-20， 每个循环5次</span></span><br>fits &lt;- lapply(seq.int(5),function(x)<br>    {<br>    set.seed(x*1234)<br>    lapply(seq.int(20),function(x){<br>    runPrimus(Y = Ct, D = D, g = mt$sizeFactor,<br>            k = x, max.iter = 100)<br>})}<br>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>BIC 运算<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#</span><span><span>## 求BIC值</span></span><br>BIC &lt;- lapply(fits,function(x){<br>  PRIMUS::calcBIC(Y = Ct,g = mt$sizeFactor,fits = x)<br>  })<br><span>#</span><span><span>## 数据处理，为可视化做准备</span></span><br>BIC &lt;- as.data.frame(BIC)<br>colnames(BIC) &lt;- seq.int(5)<br>BIC &lt;- cbind(k=rownames(BIC),BIC)<br>df &lt;- reshape::melt(BIC)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>可视化<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>library(ggplot2)<br><span>df$</span><span>k&lt;- factor(df<span>$k</span>,levels = seq.int(20))</span><br>ggplot(df,aes(x=k, y= value))+<br>  geom_boxplot()+theme_bw()+<br>  geom_vline(aes(xintercept=14),colour='#AA0000')<br></code></pre><h4 data-tool="mdnice编辑器"></h4><figure data-tool="mdnice编辑器"><img data-ratio="0.5468975468975469" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicI2FIVFXWnfOENicVfM3DBPJmGP1ibWRENT8d3HWGLJdIbmgtPJibiab0icqqtcqJYkfeJrCqkibC8icnyw/640?wx_fmt=png" data-type="png" data-w="693" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicI2FIVFXWnfOENicVfM3DBPJmGP1ibWRENT8d3HWGLJdIbmgtPJibiab0icqqtcqJYkfeJrCqkibC8icnyw/640?wx_fmt=png"><figcaption><br></figcaption></figure><h1 data-tool="mdnice编辑器"><span></span>结束语</h1><p data-tool="mdnice编辑器">至此，完成了PRIMUS的整合的全部流程及k值的选择过程。在本例中，由于fits 值单程计算费时，故在k =1~20 之后并未再进一步运算，后续进一步扩大k值范围，可能能够找到最低点。考虑到该份数据来自于真实数据，各个对应的细胞类型是否能再次细分暂未可知，后续根据BIC值计算的最佳k值&gt;&gt; 实际细胞类别数与此又是否有关联。不求甚解，到此为止。</p></section><section><section data-style-type="5" data-tools="新媒体排版" data-id="2440476"><section><section><section><section><img data-ratio="0.9495798319327731" data-src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif" data-type="gif" data-w="119" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif"></section><section data-brushtype="text">往期回顾</section><section><br></section></section></section></section><section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247510149&amp;idx=1&amp;sn=4c7e8f840785500fd751d8d74c16df2c&amp;chksm=ea1cae07dd6b2711f95f88545df466ba400756ed5cdf782413492bee69d0e241c545ea0fcea0&amp;scene=21#wechat_redirect" textvalue="CellphoneDB及可视化" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">CellphoneDB及可视化</a></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247510096&amp;idx=1&amp;sn=8bbcc0affa4d8d87dd89d766fff3f84d&amp;chksm=ea1caed2dd6b27c4d607083572b21c6d7bd7296e18ac5eba317322ff942e8c47d3c781fe7887&amp;scene=21#wechat_redirect" textvalue="单细胞测序揭示 MDA5+ 皮肌炎的特有适应性免疫特征" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞测序揭示 MDA5+ 皮肌炎的特有适应性免疫特征</a></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247510077&amp;idx=1&amp;sn=96fd3e828b409d6d5b8de302031acad5&amp;chksm=ea1caebfdd6b27a96a57293dcc17d3d666700ae7f92b04216c1050c8583bcd85a56f73efa9bf&amp;scene=21#wechat_redirect" textvalue="单细胞多组学ATAC-Signac包-概述" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">单细胞多组学ATAC-Signac包-概述</a></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247510012&amp;idx=1&amp;sn=3c62d3b03151dc455bb7d7e1ac388c45&amp;chksm=ea1ca17edd6b28687cc3089de48d89ee89c58e85935c76459860b9e2c52795ffad10a6b46eff&amp;scene=21#wechat_redirect" textvalue="金虎辞岁、玉兔迎春|2022单细胞天地推文汇总" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">金虎辞岁、玉兔迎春|2022单细胞天地推文汇总</a><br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247509977&amp;idx=1&amp;sn=d198d47fb0408c81fe7e2fb3e81b3b00&amp;chksm=ea1ca15bdd6b284dac03fdb0a96793d10a6ed61e933d2cceee167d80492d1ad3b958ff04e753&amp;scene=21#wechat_redirect" textvalue="单细胞分析工具--Palantir轨迹分析" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞分析工具--Palantir轨迹分析</a></p></section></section><hr><p><br></p></section><section data-style-type="5" data-tools="新媒体排版" data-id="2440475"><hr><p><br></p><hr><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247510150&amp;idx=1&amp;sn=0783070ae829e63a4da73e85b04d36eb&amp;chksm=ea1cae04dd6b2712de2f846ae79bdad175684a3e1b693490d687994fd27ef3bacf7b66c5fcd3&amp;scene=21#wechat_redirect" textvalue="新年新气象|生信入门/数据挖掘马拉松线上直播课正月初九要开课啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>新年新气象|生信入门/数据挖掘马拉松线上直播课正月初九要开课啦</span></a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247518195&amp;idx=1&amp;sn=d6d82ceda8531ebdc294dab0bf9d5519&amp;chksm=9b4bc748ac3c4e5e5c68748241e194638ed0ab33daac9dd6b6ec3fdb647ff782e6dd182b7c69&amp;scene=21#wechat_redirect" textvalue="在全新服务器配置转录组测序数据处理环境" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">在全新服务器配置转录组测序数据处理环境</a></p></li></ul><p><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-id="93668"><section><section data-width="95%"><section><section><section data-width="38%"><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg" data-type="other" data-w="430" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><p><br></p></section></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/YXcUxmiYgz9Z8K_n5cps_g",target="_blank" rel="noopener noreferrer">原文链接</a>
