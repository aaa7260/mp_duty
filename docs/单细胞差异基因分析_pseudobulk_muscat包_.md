---
title: "单细胞差异基因分析：pseudobulk（muscat包）"
date: 2023-02-07T13:51:32Z
draft: ["false"]
tags: [
  "fetched",
  "KS科研分享与服务"
]
categories: ["Acdemic"]
---
单细胞差异基因分析：pseudobulk（muscat包） by KS科研分享与服务
------
<div><h1><span>觉得小编内容有用的、有意思的，点赞、分享、关注一下呗！</span><br></h1><blockquote data-tool="mdnice编辑器"><span>❝</span><p><span>1、《KS科研分享与服务》公众号有QQ交流群，但是进入门槛是20元，请考虑清楚。群里有推文的注释代码和示例数据，付费内容半价，还可以与大家交流。</span></p><p><br></p><p><span>2、单细胞转录组全流程代码需收费，收费代码包含公众号付费内容，也有很多新增加的内容。<strong>需进群或者需单细胞代码的小伙伴请添加作者微信了解，请备注目的，除此之外请勿添加，谢谢！</strong></span></p><p><br></p><p><strong><span>3、</span></strong><span>付费文章集合有打包价哦！</span></p><p><br></p><p><span>详情请联系作者：</span></p><p><span><strong><span data-raw-text="。" data-textnode-index-1652195285479="1" data-index-1652195285479="198"><strong><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/0nG6iazO80N1cL4xWNPsrucw2xh523TuRS5ICXsww3O5jSMYngxbIh9NlYqtemfgjjZjlDloIoqU8icJv6ckiaHpA/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="jpeg" data-w="430" src="https://mmbiz.qpic.cn/mmbiz_jpg/0nG6iazO80N1cL4xWNPsrucw2xh523TuRS5ICXsww3O5jSMYngxbIh9NlYqtemfgjjZjlDloIoqU8icJv6ckiaHpA/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></strong></span></strong></span></p><span>❞</span></blockquote><section data-support="96编辑器" data-style-id="42067"><section><section><section><p><strong>单细胞差异基因的分析很多人一直使用的是Seurat自带函数Findmarkers。但是也有人提出这个分析结果不准确，之前有篇Nature communications专门研究过不同的分析方法，文章链接：</strong><span>https://www.nature.com/articles/s41467-021-25960-2</span><strong>。</strong></p><p><strong><br></strong></p><p><strong><strong><span>众所周知，我们做单细胞差异基因的目的是为了分析两组间细胞的差异，而不是单个细胞本身的差异。</span></strong></strong><strong>这里我们使用muscat包的pseudobulk分析，<strong>muscat可以进行多组分析，我们</strong>看一看差异分析效果，并与<strong>Findmarkers比较一下结果！</strong></strong></p><p><strong><br></strong></p><p><strong>muscat的官方说明和流程见如下链接：</strong></p><p><span>http://www.bioconductor.org/packages/release/bioc/vignettes/muscat/inst/doc/analysis.html</span></p><p><strong></strong></p><p><strong>However，无论是哪种方法，都可以任人使用，很多高分文章中也在使用Findmarkers，不能说它不好吧。接下来，我们跟随muscat的标准流程做一下分析。</strong><span><strong><span>详细注释代码和示例数据已上传群文件，请自行下载使用！！！</span></strong></span></p><p><strong><br></strong></p><p><strong>安装加载包：<br></strong></p><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="nginx"><code><span>library(Seurat)</span></code><code><span>library(muscat)</span></code><code><span>library(SingleCellExperiment)</span></code><code><span>library(dplyr)</span></code><code><span><span>human_data</span> &lt;- readRDS(<span>"D:/KS项目/公众号文章/human_data.rds"</span>)</span></code><code><span>human_sce &lt;- subset(human_data, celltype==<span>'Mast'</span>, invert=T)</span></code><code><span>human_sce<span>$celltype</span> = droplevels(human_sce<span>$celltype</span>,</span></code><code><span>                                exclude = setdiff(levels(human_sce<span>$celltype</span>),</span></code><code><span>                                                  unique(human_sce<span>$celltype</span>)))</span></code></pre></section><p><strong><span>转化对象：</span></strong><br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="javascript"><code><span>DefaultAssay(human_sce) &lt;- <span>"RNA"</span></span></code><code><span>human_sce &lt;- <span>as</span>.SingleCellExperiment(human_sce)</span></code><code><span>human_sce &lt;- prepSCE(human_sce,</span></code><code><span>                     kid = <span>"celltype"</span>,</span></code><code><span>                     gid = <span>"group"</span>,#group——id，</span></code><code><span>                     sid = <span>"orig.ident"</span>,#sample_id, </span></code><code><span>                     drop=T)</span></code><code><span>human_sce$group_id &lt;- factor(human_sce$group_id, levels=c(<span>"BM"</span>, <span>"GM"</span>))</span></code><code><span><br></span></code><code><span>nk &lt;- length(kids &lt;- levels(human_sce$cluster_id))</span></code><code><span>ns &lt;- length(sids &lt;- levels(human_sce$sample_id))</span></code><code><span>names(kids) &lt;- kids</span></code><code><span>names(sids) &lt;- sids</span></code><code><span>t(table(human_sce$cluster_id, human_sce$sample_id))</span></code></pre></section><p><strong><span>将单细胞数据聚合为pseudobulk data，看看分群！</span></strong></p><section><ul><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span>pb &lt;- aggregateData(human_sce,</span></code><code><span>                    assay = <span>"counts"</span>, </span></code><code><span>                    <span><span>fun</span> = "sum",</span></span></code><code><span>                    <span>by</span> = c(<span>"cluster_id"</span>, <span>"sample_id"</span>))</span></code><code><span>(pb_mds &lt;- pbMDS(pb))</span></code></pre></section><p><strong><img data-ratio="0.9231707317073171" data-src="https://mmbiz.qpic.cn/mmbiz_png/0nG6iazO80N3P4R5Zkt8BINVVuZba88y5hh0DSQiaibibMCqmntq1Dmdf73QbsYJJkHIYF5pFnG1JXfbbBcAkXsppg/640?wx_fmt=png" data-type="png" data-w="820" src="https://mmbiz.qpic.cn/mmbiz_png/0nG6iazO80N3P4R5Zkt8BINVVuZba88y5hh0DSQiaibibMCqmntq1Dmdf73QbsYJJkHIYF5pFnG1JXfbbBcAkXsppg/640?wx_fmt=png"></strong></p><p><strong>差异分析：<br></strong></p><section><ul><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>pb$group_id &lt;- factor(pb$group_id, levels=c(<span>"BM"</span>, <span>"GM"</span>))</span></code><code><span>res &lt;- pbDS(pb, verbose = <span>FALSE</span>)<span>#pseudobulk DS analysis</span></span></code><code><span>tmp &lt;- human_sce</span></code><code><span>counts(tmp) &lt;- <span>as</span>.matrix(counts(tmp))</span></code><code><span>result_table &lt;- resDS(tmp, res, bind = <span>"row"</span>, frq = <span>FALSE</span>, cpm = <span>FALSE</span>)</span></code><code><span>rm(tmp)</span></code></pre></section><p><strong>将表达某一基因的BM/GM细胞群中的比例添加到结果中，类似于Findmarker分析结果中的pct1和pct2.</strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="ruby"><code><span>human_sce &lt;- subset(human_data, celltype==<span>'Mast'</span>, invert=T)</span></code><code><span>count_mat &lt;- as.matrix(human_sce[[<span>"RNA"</span>]]@data) &gt; <span>0</span></span></code><code><span>cluster_list &lt;- unique(result_table$cluster_id)</span></code><code><span><br></span></code><code><span>result_table$BM.frq &lt;- <span>0</span></span></code><code><span>BM_cells &lt;- colnames(human_sce)[human_sce$group == <span>"BM"</span>]</span></code><code><span><span>for</span>(i <span>in</span> <span>1</span><span>:length</span>(cluster_list)){</span></code><code><span>  cluster_cells &lt;- colnames(human_sce)[human_sce$celltype == cluster_list[i]]</span></code><code><span>  test_cells &lt;- intersect(BM_cells, cluster_cells)</span></code><code><span>  row_ind &lt;- which(result_table$cluster_id == cluster_list[i])</span></code><code><span>  frq &lt;- rowSums(count_mat[result_table$gene[row_ind],test_cells]) / length(test_cells)</span></code><code><span>  result_table$BM.frq[row_ind] &lt;- frq</span></code><code><span>}</span></code><code><span><br></span></code><code><span><br></span></code><code><span>GM_cells &lt;- colnames(human_sce)[human_sce$group == <span>"GM"</span>]</span></code><code><span>result_table$GM.frq &lt;- <span>0</span></span></code><code><span><span>for</span>(i <span>in</span> <span>1</span><span>:length</span>(cluster_list)){</span></code><code><span>  cluster_cells &lt;- colnames(human_sce)[human_sce$celltype == cluster_list[i]]</span></code><code><span>  test_cells &lt;- intersect(GM_cells, cluster_cells)</span></code><code><span>  row_ind &lt;- which(result_table$cluster_id == cluster_list[i])</span></code><code><span>  frq &lt;- rowSums(count_mat[result_table$gene[row_ind],test_cells]) / length(test_cells)</span></code><code><span>  result_table$GM.frq[row_ind] &lt;- frq</span></code><code><span>}</span></code><code><span><br></span></code><code><span><br></span></code><code><span>write.csv(result_table, file = <span>"result_table.csv"</span>, row.names = F)</span></code></pre></section><p><strong>对比下结果：set1是Findmarkers，set2是muscat，可以看出差异基因共同的不少，但是不相同的也挺多。</strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>Mac &lt;- subset(human_data, celltype==<span>"Macrophage"</span>)</span></code><code><span>Mac_DEGs &lt;- FindMarkers(human_data,</span></code><code><span>                        min.pct = <span>0</span>,</span></code><code><span>                        logfc.threshold = <span>0.25</span>,</span></code><code><span>                        group.by = <span>'group'</span>,</span></code><code><span>                        ident<span>.1</span> =<span>"GM"</span>,</span></code><code><span>                        ident<span>.2</span>=<span>"BM"</span>)</span></code><code><span><br></span></code><code><span>Mac_DEGs_Findmarker_sig &lt;- Mac_DEGs[Mac_DEGs$p_val &lt; <span>0.05</span> &amp;</span></code><code><span>                                      abs(Mac_DEGs$avg_log2FC) &gt; <span>0.25</span>, ]</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>####muscat</span></span></code><code><span>Mac_muscat_DEGs &lt;- subset(result_table, cluster_id==<span>'Macrophage'</span>)</span></code><code><span>Mac_muscat_DEGs_sig &lt;- Mac_muscat_DEGs[Mac_muscat_DEGs$p_val &lt; <span>0.05</span> &amp;</span></code><code><span>                                         abs(Mac_muscat_DEGs$logFC) &gt; <span>0.25</span>&amp;</span></code><code><span>                                         Mac_muscat_DEGs$BM.frq&gt;<span>0.1</span>&amp;</span></code><code><span>                                         Mac_muscat_DEGs$GM.frq&gt;<span>0.1</span>, ]</span></code><code><span>rownames(Mac_muscat_DEGs_sig) &lt;- Mac_muscat_DEGs_sig$gene</span></code><code><span><br></span></code><code><span>library(devtools)</span></code><code><span>install_github(<span>"js229/Vennerable"</span>)</span></code><code><span>library(Vennerable)</span></code><code><span><br></span></code><code><span>Set1 &lt;- <span>as</span>.<span>list</span>(rownames(Mac_DEGs_Findmarker_sig))</span></code><code><span>Set2 &lt;- <span>as</span>.<span>list</span>(Mac_muscat_DEGs_sig$gene)</span></code><code><span>example &lt;-<span>list</span>(Set1=Set1,Set2=Set2)</span></code><code><span><br></span></code><code><span><br></span></code><code><span>Veenplot &lt;- Venn(example)</span></code><code><span>Veenplot&lt;-Veenplot[, c(<span>"Set1"</span>, <span>"Set2"</span>)]</span></code><code><span>plot(Veenplot, doWeights = <span>TRUE</span>)</span></code></pre></section><p><strong><img data-ratio="0.7925736235595391" data-src="https://mmbiz.qpic.cn/mmbiz_png/0nG6iazO80N3P4R5Zkt8BINVVuZba88y5C5Zpz8grQaicicjDT4xrtSYD2I9lwBwUEe3PS65MicBQphTxaPSBD550Q/640?wx_fmt=png" data-type="png" data-w="781" src="https://mmbiz.qpic.cn/mmbiz_png/0nG6iazO80N3P4R5Zkt8BINVVuZba88y5C5Zpz8grQaicicjDT4xrtSYD2I9lwBwUEe3PS65MicBQphTxaPSBD550Q/640?wx_fmt=png"></strong></p><p><strong>做一下共同1099个基因的相关性。<br></strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span>same_gene &lt;- <span>Veenplot@</span>IntersectionSets$`<span>11</span>`</span></code><code><span><span>data</span> &lt;- cbind(Mac_DEGs_Findmarker_sig[same_gene,][,<span>2</span>],</span></code><code><span>              Mac_muscat_DEGs_sig[same_gene,][,<span>3</span>])</span></code><code><span>colnames(<span>data</span>) &lt;- c(<span>"Seurat"</span>, <span>"Muscat"</span>)</span></code><code><span><span>data</span> &lt;- <span>as</span>.<span>data</span>.frame(<span>data</span>)</span></code><code><span><br></span></code><code><span>library(ggpubr)</span></code><code><span>ggscatter(<span>data</span>,x=<span>"Seurat"</span>,y=<span>"Muscat"</span>,</span></code><code><span>          add = <span>"reg.line"</span>,</span></code><code><span>          conf.int = T,</span></code><code><span>          color = <span>'#0f8096'</span>)+</span></code><code><span>  stat_cor(label.x = <span>0.2</span>, label.y = <span>0</span>)</span></code></pre></section><p><strong><img data-ratio="0.8550135501355014" data-src="https://mmbiz.qpic.cn/mmbiz_png/0nG6iazO80N3P4R5Zkt8BINVVuZba88y585CYxKeo9anjaUzhhW6ItLticUddzKzrsNevozJ3CWhXFjQCbk7ukNw/640?wx_fmt=png" data-type="png" data-w="738" src="https://mmbiz.qpic.cn/mmbiz_png/0nG6iazO80N3P4R5Zkt8BINVVuZba88y585CYxKeo9anjaUzhhW6ItLticUddzKzrsNevozJ3CWhXFjQCbk7ukNw/640?wx_fmt=png"></strong></p><p><strong>可以看出，两种方法共同的差异基因上下调是一致的，只有一个基因相反。还是那句话，方法无所谓好坏，都可以使用，主要是讲顺自己的故事。好了这就是所有内容了，关于单细胞差异基因的分析方法还有很多，这里的muscat只是一个，其他的感兴趣的可以去探索。<br></strong></p><p><strong><br></strong></p><p><strong>觉得分享有用的，点个赞再走呗！！！</strong></p><p><br></p></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ZHH8CnBFPb1kX4uovRYbSw",target="_blank" rel="noopener noreferrer">原文链接</a>
