---
title: "时间序列转录组多次差异分析以及时序分析"
date: 2023-11-04T09:30:24Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
时间序列转录组多次差异分析以及时序分析 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>学员做了一个时间序列<strong>转录组测序</strong>项目，我们帮忙处理了一下，实验设计如下所示：</p></blockquote><p><img data-galleryid="" data-ratio="0.5143769968051118" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELahMOGfdvhjVTRrFtAF3EQ01OSopE4baHNxlqh2yMYSOY0ibmRvIBRj0Q/640?wx_fmt=png" data-type="png" data-w="626" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELahMOGfdvhjVTRrFtAF3EQ01OSopE4baHNxlqh2yMYSOY0ibmRvIBRj0Q/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>实验设计</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>首先是质量控制<span></span></h3><p data-tool="mdnice编辑器">可以看到是12d和48h处理的效果不一样，其中48h的处理跟control更接近，而12d的处理很明显影响很大：</p><p><img data-galleryid="" data-ratio="0.32015065913371" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELaN4wrynPficRibgic13iaA580aDEyEwJkuEKWb8GQBgiaho28V6UticRMSAjA/640?wx_fmt=png" data-type="png" data-w="1062" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELaN4wrynPficRibgic13iaA580aDEyEwJkuEKWb8GQBgiaho28V6UticRMSAjA/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>而12d的处理很明显影响很大</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>需要多次差异分析<span></span></h3><p data-tool="mdnice编辑器">因为是很简单的3分组，0是control组，然后是12d和48h两个不同时间点的处理组，起码可以做如下所示的四次差异分析</p><ul data-tool="mdnice编辑器"><li><section><strong>12d和48h都是treat组，去跟control对比</strong></section></li><li><section><strong>12d，去跟control对比</strong></section></li><li><section><strong>48h，去跟control对比</strong></section></li><li><section><strong>12d和48h对比</strong></section></li></ul><p data-tool="mdnice编辑器">每次差异分析都可以出几千个图，非常可怕！就跟单细胞转录组降维聚类分群一样的容易数据集一个标准流程也是出几千个图，但是我们有一个找核心的方法！不同差异分析结果，可以韦恩图，散点图，各种。。。</p><h3 data-tool="mdnice编辑器"><span></span>推荐时间序列分析（mfuzz）<span></span></h3><p data-tool="mdnice编辑器">时序分析可以找核心变化，其实就是针对基因的聚类分群而已，wgcna算法也是如此！</p><h3 data-tool="mdnice编辑器"><span></span>实战演练<span></span></h3><p data-tool="mdnice编辑器">一般来说，差异分析流程适用于两两比较， 但实际科研中的实验设计会比较复杂，比如：https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE116439</p><p data-tool="mdnice编辑器">里面的其中一个细胞系的一种药物的不同浓度不同时间段处理数据如下：</p><pre data-tool="mdnice编辑器"><span></span><code>GSM3232610 A498_cisplatin_0nM_24h<br>GSM3232611 A498_cisplatin_0nM_2h<br>GSM3232612 A498_cisplatin_0nM_6h<br>GSM3232613 A498_cisplatin_15000nM_24h<br>GSM3232614 A498_cisplatin_15000nM_2h<br>GSM3232615 A498_cisplatin_15000nM_6h<br>GSM3232616 A498_cisplatin_3000nM_24h<br>GSM3232617 A498_cisplatin_3000nM_2h<br>GSM3232618 A498_cisplatin_3000nM_6h<br></code></pre><p data-tool="mdnice编辑器">这个项目本身很复杂，Drug-induced change in gene expression across NCI-60 cell lines after exposure to 15 anticancer agents for 2, 6 and 24h (cisplatin)</p><p data-tool="mdnice编辑器">但是，我们只需要针对里面的一个细胞系的一种药物的不同浓度不同时间段处理做一个简单的时间序列转录组多次差异分析以及时序分析！</p><p data-tool="mdnice编辑器">总体上来说，数据分析思路，跟前面的时间序列转录组测序多次差异分析以及时序分析一样的，前面的是转录组测序，现在举例的这个GSE116439是转录组的表达量芯片！我们在GEO的官网下载：https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE116439  如下所示的文件：</p><pre data-tool="mdnice编辑器"><span></span><code>  2.4M Jun 29  2018 GSM3232610_A498_cisplatin_0nM_24h_U133A.CEL.gz<br>  2.4M Jun 29  2018 GSM3232611_A498_cisplatin_0nM_2h_U133A.CEL.gz<br>  2.5M Jun 29  2018 GSM3232612_A498_cisplatin_0nM_6h_U133A.CEL.gz<br>  2.5M Jun 29  2018 GSM3232613_A498_cisplatin_15000nM_24h_U133A.CEL.gz<br>  2.4M Jun 29  2018 GSM3232614_A498_cisplatin_15000nM_2h_U133A.CEL.gz<br>  2.4M Jun 29  2018 GSM3232615_A498_cisplatin_15000nM_6h_U133A.CEL.gz<br>  2.4M Jun 29  2018 GSM3232616_A498_cisplatin_3000nM_24h_U133A.CEL.gz<br>  2.4M Jun 29  2018 GSM3232617_A498_cisplatin_3000nM_2h_U133A.CEL.gz<br>  2.4M Jun 29  2018 GSM3232618_A498_cisplatin_3000nM_6h_U133A.CEL.gz<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>处理表达量芯片的cel文件成为表达量矩阵<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())  <span>## 魔幻操作，一键清空~</span><br>options(stringsAsFactors = <span>F</span>) <br>getOption(<span>'timeout'</span>)<br>options(timeout=<span>10000</span>) <br><span>library</span>(oligo)<br><span>library</span>(ggplot2) <br><span># BiocManager::install('pd.ht.hg.u133a')</span><br>celFiles &lt;- list.celfiles(<span>'GSE116439_RAW/'</span>,listGzipped = <span>T</span>,<br>                          full.name=<span>TRUE</span>)<br>celFiles<br>exon_data &lt;- oligo::read.celfiles( celFiles ) <br>dim(exprs(exon_data)) <br>exprs(exon_data)[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span>### 标准化(一步完成背景校正、分位数校正标准化和RMA (robust multichip average) 表达整合)</span><br>exon_data_rma &lt;- oligo::rma(exon_data  ) <br>exp_probe &lt;- Biobase::exprs(exon_data_rma)<br>exp_probe[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>boxplot(exp_probe[,<span>1</span>:<span>4</span>],las=<span>2</span>)<br>dat = exp_probe<br>boxplot(dat[,<span>1</span>:<span>4</span>],las=<span>2</span>)  <br><span>library</span>(limma)<br><span>#dat=normalizeBetweenArrays(dat)</span><br>boxplot(dat[,<span>1</span>:<span>4</span>],las=<span>2</span>)  <br><span>library</span>(stringr)<br><span>#pd=pData(a) </span><br>pd = as.data.frame(str_split(colnames(dat),<span>'_'</span>,simplify = <span>T</span>)[,c(<span>4</span>,<span>5</span>)])<br><span>#通过查看说明书知道取对象a里的临床信息用pData</span><br><span>## 挑选一些感兴趣的临床表型。</span><br><span>library</span>(stringr) <br><span># pd=pd[1:43,]</span><br><span># dat=dat[,1:43]</span><br>phe=pd <br><br><span># 这里一定要人工干预，每个数据集项目的分组不一样</span><br><span># 是主观判断，自己选择  </span><br><span>#group_list=ifelse(grepl('Healthy',phe$title),'healthy','patient')</span><br>group_list=phe$V2<br>table(group_list)<br><span>#tmp = pd[group_list=='healthy',]</span><br><span>#  996 samples analyzed of which 72 are Healthy controls and 924 are SLE; </span><br>dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]  <br>dim(dat)<br><span>library</span>(AnnoProbe)  <br>ids=idmap(<span>'GPL571'</span>,<span>'soft'</span>)<br>head(ids)<br>ids=ids[ids$symbol != <span>''</span>,]<br>dat=dat[rownames(dat) %<span>in</span>% ids$ID,]<br>ids=ids[match(rownames(dat),ids$ID),]<br>head(ids) <br>colnames(ids)=c(<span>'probe_id'</span>,<span>'symbol'</span>)  <br>ids$probe_id=as.character(ids$probe_id)<br>rownames(dat)=ids$probe_id<br>dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>] <br><br>ids=ids[ids$probe_id %<span>in</span>%  rownames(dat),]<br>dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]   <br>dat=dat[ids$probe_id,] <br><br>ids$median=apply(dat,<span>1</span>,median) <span>#ids新建median这一列，列名为median，同时对dat这个矩阵按行操作，取每一行的中位数，将结果给到median这一列的每一行</span><br>ids=ids[order(ids$symbol,ids$median,decreasing = <span>T</span>),]<span>#对ids$symbol按照ids$median中位数从大到小排列的顺序排序，将对应的行赋值为一个新的ids</span><br>ids=ids[!duplicated(ids$symbol),]<span>#将symbol这一列取取出重复项，'!'为否，即取出不重复的项，去除重复的gene ，保留每个基因最大表达量结果s</span><br>dat=dat[ids$probe_id,] <span>#新的ids取出probe_id这一列，将dat按照取出的这一列中的每一行组成一个新的dat</span><br>rownames(dat)=ids$symbol<span>#把ids的symbol这一列中的每一行给dat作为dat的行名</span><br>dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]  <span>#保留每个基因ID第一次出现的信息</span><br><br>dat[<span>'ACTB'</span>,]<br>dat[<span>'GAPDH'</span>,]<br>save(dat,group_list,phe,file = <span>'step1-output.Rdata'</span>)<br><br><span>source</span>(<span>'step2-check.R'</span>)<br><span># 被迫忽略这个浓度信息</span><br> <br></code></pre><h3 data-tool="mdnice编辑器"><span></span>质量控制发现3个时间点确实是差异很大<span></span></h3><p data-tool="mdnice编辑器">质量控制的代码在 source('step2-check.R') 里面，可以看到：</p><p><img data-galleryid="" data-ratio="0.24814814814814815" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELaZ6O2Lt9sxhpr5bmib6RXYjMqJBIyscHpmaZsicvXdgXTS9UXqhAqRthg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELaZ6O2Lt9sxhpr5bmib6RXYjMqJBIyscHpmaZsicvXdgXTS9UXqhAqRthg/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>3个时间点确实是差异很大</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>两两组合的差异分析<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())  <span>## 魔幻操作，一键清空~</span><br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(clusterProfiler)<br><span>library</span>(stringr)<br><span>library</span>(limma)<br><br>run &lt;- <span>function</span>(){<br>  <br>  getwd()<br>  <span>source</span>(<span>'../functions/run_check.R'</span>)<br>  run_check(dat, group_list, target_gene=<span>'GAPDH'</span>, pro=gse_number,path=<span>'./'</span>)<br>  <br>  <span>source</span>(<span>'../functions/run_DEG.R'</span>)<br>  group_list<br>  table(group_list)<br>  deg=run_DEG(dat, group_list, pro=gse_number,path=<span>'./'</span>,<br>              target_gene=c(<span>'GAPDH'</span>))<br>  head(deg)<br>  <br>  <span>source</span>(<span>'../functions/run_ORA_KEGG.R'</span>)<br>  <span># Reading KEGG annotation online:</span><br>  run_ORA_KEGG(deg, path=<span>'./'</span>)<br>  <br>  <span>source</span>(<span>'../functions/run_ORA_GO.R'</span>)<br>  run_ORA_GO(deg, path=<span>'./'</span>)<br>  <br>  load(file = <span>'anno_DEG.Rdata'</span>)<br>  <span>source</span>(<span>'../functions/run_GSEA_KEGG.R'</span>)<br>  run_GSEA_KEGG(DEG, path=<span>'./'</span>)<br>  <br>}<br><br><br>load(file = <span>'step1-output.Rdata'</span>)<br>table(group_list)<br><span># 每次都要检测数据</span><br>dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br>raw_dat = dat<br>raw_gp = group_list<br><br>pro=<span>'6h-vs-2h'</span><br>dir.create(pro)<br>setwd(pro) <br>table(raw_gp)<br>kp = raw_gp != <span>'24h'</span><br>table(kp)<br>dat = raw_dat[,kp]<br>group_list = raw_gp[kp]<br>gse_number = pro<br>save( gse_number,<br>      dat,group_list, <br>      file = <span>'step1-output.Rdata'</span>) <br>load(file = <span>'step1-output.Rdata'</span>)<br>run()<br>setwd(<span>'../'</span>)<br>getwd()<br><br><br>pro=<span>'24h-vs-2h'</span><br>dir.create(pro)<br>setwd(pro) <br>table(raw_gp)<br>kp = raw_gp != <span>'6h'</span><br>table(kp)<br>dat = raw_dat[,kp]<br>group_list = raw_gp[kp]<br>gse_number = pro<br>save( gse_number,<br>      dat,group_list, <br>      file = <span>'step1-output.Rdata'</span>) <br>load(file = <span>'step1-output.Rdata'</span>)<br>run()<br>setwd(<span>'../'</span>)<br>getwd()<br><br><br>pro=<span>'24h-vs-6h'</span><br>dir.create(pro)<br>setwd(pro) <br>table(raw_gp)<br>kp = raw_gp != <span>'2h'</span><br>table(kp)<br>dat = raw_dat[,kp]<br>group_list = raw_gp[kp] <br>gse_number = pro<br>save( gse_number,<br>      dat,group_list, <br>      file = <span>'step1-output.Rdata'</span>) <br>load(file = <span>'step1-output.Rdata'</span>)<br>run()<br>setwd(<span>'../'</span>)<br>getwd()<br><br><br></code></pre><p data-tool="mdnice编辑器">只需要从原始的表达量矩阵里面任意提取需要的二分组表达量矩阵即可批量做差异分析富集分析，而且每次分析都有大量的图表结果， 如下学习：</p><p><img data-galleryid="" data-ratio="0.9670103092783505" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELaFdOnHeDtzOiczeTkxib38v2GdibDbZIUnMF46yCWgrRUf2LGnF2puHtow/640?wx_fmt=png" data-type="png" data-w="970" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELaFdOnHeDtzOiczeTkxib38v2GdibDbZIUnMF46yCWgrRUf2LGnF2puHtow/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>大量的图表结果</figcaption></figure><p data-tool="mdnice编辑器">我们当然是可以具体去看每次差异分析的上下调基因和通路，但是它不够聚焦，尤其是时间点变多的时候，差异分析的两两分组组合起来可以是几十次分析， 图表就成千上万了！</p><h3 data-tool="mdnice编辑器"><span></span>核心基因和通路分析<span></span></h3><p data-tool="mdnice编辑器">那就是mfuzz这样的时序分析啦，说简单一点就是把基因进行分组而已，代码也很简单，分组可以自定义需要多少组，我这里随意举例是9个分组，如下所示：</p><p><img data-galleryid="" data-ratio="0.5768518518518518" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELac2R54L5vKe5pDbST28Vibm0LVc0AB0MNIazZ6S7FI0dL3HAmgMMJsVw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELac2R54L5vKe5pDbST28Vibm0LVc0AB0MNIazZ6S7FI0dL3HAmgMMJsVw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>随意举例是9个分组</figcaption></figure><p data-tool="mdnice编辑器">因为最开始我们就选择了3次差异分析的统计学显著的基因，就不到600个，所以拆分成为了9个分组后每个分组里面的基因数量并不多</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; table(group_g<span>$group</span>)<br><br>c1 c2 c3 c4 c5 c6 c7 c8 c9 <br>48 38 54 57 57 49 53 51 77 <br></code></pre><p data-tool="mdnice编辑器">简单的统计学功能注释如下所示：</p><p><img data-galleryid="" data-ratio="0.662962962962963" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELagJHTxULjtDfWahk4JicjemG3psSDt5mQsz4aKXibGciaJ6aiaFBPJExnsQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELagJHTxULjtDfWahk4JicjemG3psSDt5mQsz4aKXibGciaJ6aiaFBPJExnsQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>统计学功能注释</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>确实是代码有点多<span></span></h3><p data-tool="mdnice编辑器">我简单的看了看，仅仅是每个函数就都是一百多行啦，是我过去半年的“大杂烩”：</p><pre data-tool="mdnice编辑器"><span></span><code> wc -l <span>functions</span>/*<br> <br>      84 <span>functions</span>/enrich.R<br>     137 <span>functions</span>/run_DEG.R<br>     122 <span>functions</span>/run_DEG_by_DESeq2.R<br>      75 <span>functions</span>/run_GSEA_KEGG.R<br>      64 <span>functions</span>/run_ORA_GO.R<br>      93 <span>functions</span>/run_ORA_KEGG.R<br>     116 <span>functions</span>/run_check.R<br>     122 <span>functions</span>/run_gseKEGG.R<br></code></pre><h3 data-tool="mdnice编辑器">有偿获取上面的全部代码<span>（18.8元）</span></h3><p data-tool="mdnice编辑器">从表达量芯片的cel文件开始处理得到表达量矩阵，提取3个分组信息，两两组合差异分析3次，然后mfuzz分析对差异基因进行分组，分组后进行生物学功能数据库注释，<span>如果是从零开始可以根据我的代码慢慢学习，肯定是可以跑通！（我写的代码持续分享了十多年，广受大家好评）</span></p><p data-tool="mdnice编辑器"><strong>群聊组建费用18.8元，一个简单的门槛隔绝那些不怀好意的广告营销号！</strong><span><strong> </strong>前200名可以直接扫描进群（进群后仍然需要18.8门票），</span><span><strong>满200人后我们才会统一收款</strong></span><span>！（每个人都是</span><strong>18.8 元</strong><span>，如果</span><strong>你不同意这个象征性收费</strong><span>，请不要进群哈！）</span></p><p><img data-galleryid="" data-ratio="1.608695652173913" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELaRghhlqVVx5J5rZfwfibwewJoQI55Vv2TEEfq7rRkg7tMDFaRACsvibcA/640?wx_fmt=png" data-type="png" data-w="276" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyNz9A7vllNyRIlMClqKELaRghhlqVVx5J5rZfwfibwewJoQI55Vv2TEEfq7rRkg7tMDFaRACsvibcA/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>交流群</figcaption></figure><p data-tool="mdnice编辑器">如果上面的群聊二维码满员了，<strong>大家可以扫描下面的二维码添加我的秘书凭借付款截图索取代码或者进群！</strong></p><p data-tool="mdnice编辑器">（每天晚上十点钟统一给大家发放代码并且拉群）<span>（名额有限，先到先得！</span><span>！</span><span>！</span><span>）</span></p><p><mp-pay-preview-filter data-offset="55"></mp-pay-preview-filter></p></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/zJ_fmCvDk_gqHg6a78SrPw",target="_blank" rel="noopener noreferrer">原文链接</a>
