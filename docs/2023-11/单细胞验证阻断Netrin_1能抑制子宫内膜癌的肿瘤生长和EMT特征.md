---
title: "单细胞验证阻断Netrin-1能抑制子宫内膜癌的肿瘤生长和EMT特征"
date: 2023-11-12T10:43:47Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
单细胞验证阻断Netrin-1能抑制子宫内膜癌的肿瘤生长和EMT特征 by 生信菜鸟团
------
<div><section><blockquote><p>这篇文章中规中矩，应该是药企推出的免疫治疗药物最后做了个科研探索治疗机制。分析得比较浅，不过人家主要看疗效~</p></blockquote><figure><img data-ratio="0.6421845574387948" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ywrVcop7WuicOMpbye8ViaqrbfV5GJZUSic19tIAJic96ib3uEL00UzermlQ/640?wx_fmt=png" data-type="png" data-w="1062" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ywrVcop7WuicOMpbye8ViaqrbfV5GJZUSic19tIAJic96ib3uEL00UzermlQ/640?wx_fmt=png"></figure><h2><span>1.下载数据并QC聚类分群</span></h2><p>首先下载数据<br>https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE225689<br></p><figure><img data-ratio="0.5333333333333333" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yXPgyYR6YbIeSX2ae5YfnD81WlPqXQe384ViaSuwPUJkEwnwicWsicZ7FA/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yXPgyYR6YbIeSX2ae5YfnD81WlPqXQe384ViaSuwPUJkEwnwicWsicZ7FA/640?wx_fmt=png"></figure><br>前面的QC和降维聚类流程就不放了。<br>很简单的注释<br><figure><img data-ratio="0.22556390977443608" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yds1ibGURHXFU8Fs1u3rv3NhHicRtaDU5jz4kUWTWmEBicPhW1QrokfhAQ/640?wx_fmt=png" data-type="png" data-w="1064" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yds1ibGURHXFU8Fs1u3rv3NhHicRtaDU5jz4kUWTWmEBicPhW1QrokfhAQ/640?wx_fmt=png"></figure><pre><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><span>library</span>(SingleR)<br><span>library</span>(celldex)<br><span>library</span>(singleseqgset)<br><span>library</span>(devtools)<br>getwd()<br>dir.create(<span>"3-cell"</span>)<br>setwd(<span>'3-cell/'</span>)<br>sce.all=readRDS( <span>"../2-harmony/sce.all_int.rds"</span>)<br>sce.all<br><br><span>#文章中给的信息</span><br><span>#tumour cells (expressing EpCAM, PGR and TFF3—all markers of ECs21), </span><br><span>#immune cells (marked by CD45+(PTPRC) expression), </span><br><span>#cancer-associated fibroblasts (CAFs, marked by αSMA+(ACTA2)) and </span><br><span>#endothelial cells (PECAM1 positive)</span><br><span>library</span>(ggplot2) <br>genes_to_check = c(<span>'PTPRC'</span>,    <span># immune</span><br>                   <span>'EPCAM'</span>, <span>'KRT19'</span>, <span>'PROM1'</span>, <span>'ALDH1A1'</span>, <span># tumor</span><br>                   <span>'PECAM1'</span>,<span>'VWF'</span>, <span>#endothelial</span><br>                   <span>'ACTA2'</span>,<span>'FGF7'</span> ) <span>#CAFs</span><br><span>library</span>(stringr)  <br>p_paper_markers &lt;- DotPlot(sce.all, features = genes_to_check,<br>                           assay=<span>'RNA'</span>  )  + coord_flip()<br><br>p_paper_markers<br>ggsave(plot=p_paper_markers,<br>       filename=<span>"check_paper_marker_by_seurat_cluster.pdf"</span>,width = <span>12</span>)<br><br><br>p_umap=DimPlot(sce.all, reduction = <span>"umap"</span>,<br>               group.by = <span>"RNA_snn_res.0.1"</span>,label = <span>T</span>) <br><span>library</span>(patchwork)<br>p_paper_markers+p_umap<br><span>#ggsave('markers_umap.pdf',width = 15)</span><br>DimPlot(sce.all, reduction = <span>"umap"</span>,split.by = <span>'orig.ident'</span>,<br>        group.by = <span>"RNA_snn_res.0.8"</span>,label = <span>T</span>) <br><span>#ggsave('orig.ident_umap.pdf',width = 45)</span><br></code></pre><figure><img data-ratio="0.4444444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ycBrX9bXW9PKV5IDKjh1O4p4JTpdcBm6QoBKerm1FEgX1pbJr0TwmTQ/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ycBrX9bXW9PKV5IDKjh1O4p4JTpdcBm6QoBKerm1FEgX1pbJr0TwmTQ/640?wx_fmt=png"></figure><h2><span>2.注释亚群</span></h2><pre><code><span># 需要自行看图，定细胞亚群： </span><br>celltype=data.frame(ClusterID=<span>0</span><span>:</span><span>9</span> ,<br>                    celltype= <span>0</span><span>:</span><span>9</span>) <br><span>#定义细胞亚群   </span><br>celltype[celltype$ClusterID %<span>in</span>% c( <span>1</span>,<span>3</span>,<span>4</span>,<span>9</span>),<span>2</span>]=<span>'Immune'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>5</span>),<span>2</span>]=<span>'Endothelial'</span>  <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>7</span>),<span>2</span>]=<span>'CAFs'</span>  <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>,<span>6</span>,<span>8</span> ),<span>2</span>]=<span>'Tumor'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>2</span> ),<span>2</span>]=<span>'Unknown'</span> <br><br>head(celltype)<br>celltype<br>table(celltype$celltype)<br>sce.all@meta.data$celltype = <span>"NA"</span><br><br><span>for</span>(i <span>in</span> <span>1</span><span>:nrow</span>(celltype)){<br>  sce.all@meta.data[which(sce.all@meta.data$RNA_snn_res.<span>0</span>.<span>1</span> == celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]}<br>table(sce.all@meta.data$celltype)<br>th=theme(axis.text.x = element_text(angle = <span>45</span>, <br>                                    vjust = <span>0</span>.<span>5</span>, hjust=<span>0</span>.<span>5</span>)) <br>library(patchwork)<br>p_all_markers=DotPlot(sce.all, features = genes_to_check,<br>                      assay=<span>'RNA'</span> ,group.by = <span>'celltype'</span> )  + coord_flip()+th<br>p_umap=DimPlot(sce.all, reduction = <span>"umap"</span>, group.by = <span>"celltype"</span>,label = T)<br>p_all_markers+p_umap<br><span>#ggsave('markers_umap_by_celltype.pdf',width = 12,height = 8)</span><br><br>sce.all<br>table(Idents(sce.all))  <br>Idents(sce.all)=sce.all$celltype<br>table(Idents(sce.all))  <br></code></pre><p>挺有趣的，看来每次还是得看一下所有的marker表达，不然出现unknown就尴尬。<br></p><figure><img data-ratio="0.4685185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yKEwiahAwMFo1hicUQ8alcDeULHWibkFe4PI9zhY2ZN8yno0pE0PRjN2uQ/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yKEwiahAwMFo1hicUQ8alcDeULHWibkFe4PI9zhY2ZN8yno0pE0PRjN2uQ/640?wx_fmt=png"></figure><pre><code>col =c(<span>"#3176B7"</span>,<span>"#F78000"</span>,<span>"#3FA116"</span>,<span>"#CE2820"</span>,<span>"#9265C1"</span>,<br>               <span>"#885649"</span>,<span>"#DD76C5"</span>,<span>"#BBBE00"</span>,<span>"#41BED1"</span>)<br><br>DimPlot(sce.all, reduction = <span>"umap"</span>,split.<span>by</span> = <span>'orig.ident'</span>,<br>        <span>group</span>.<span>by</span> = <span>"celltype"</span>,label = T,cols = col,label.box=T) <br></code></pre><p>很明显可以看出来，在C3D1时Tumor细胞减少了很多<br></p><figure><img data-ratio="0.5453703703703704" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yWuJIUPz66uuAgmNBdJe7Yiaiaj4ib4nzD7nGQZt9FOIrwQyzovdUxF4CA/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yWuJIUPz66uuAgmNBdJe7Yiaiaj4ib4nzD7nGQZt9FOIrwQyzovdUxF4CA/640?wx_fmt=png"></figure><br>Unkown这一群竟然增加了挺多，来看看这一群到底是什么吧<pre><code><span>###看看2这一细胞亚群是什么</span><br>genes_to_check = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <span>'CD4'</span>,<span>'CD8A'</span>,<br>                   <span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span> ,<br>                   <span>'IGHG1'</span>, <span>'MZB1'</span>, <span>'SDC1'</span>,<br>                   <span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>, <br>                   <span>'TPSAB1'</span> , <span>'TPSB2'</span>,  <span># mast cells,</span><br>                   <span>'RCVRN'</span>,<span>'FPR1'</span> , <span>'ITGAM'</span> ,<br>                   <span>'C1QA'</span>,  <span>'C1QB'</span>,  <span># mac</span><br>                   <span>'S100A9'</span>, <span>'S100A8'</span>, <span>'MMP19'</span>,<span># monocyte</span><br>                   <span>'FCGR3A'</span>,<br>                   <span>'LAMP3'</span>, <span>'IDO1'</span>,<span>'IDO2'</span>,<span>## DC3 </span><br>                   <span>'CD1E'</span>,<span>'CD1C'</span>, <span># DC2</span><br>                   <span>'KLRB1'</span>,<span>'NCR1'</span>, <span># NK </span><br>                   <span>'FGF7'</span>,<span>'MME'</span>, <span>'ACTA2'</span>, <span>## fibo </span><br>                   <span>'DCN'</span>, <span>'LUM'</span>,  <span>'GSN'</span> , <span>## mouse PDAC fibo </span><br>                   <span>'MKI67'</span> , <span>'TOP2A'</span>, <br>                   <span>'PECAM1'</span>, <span>'VWF'</span>,  <span>## endo </span><br>                   <span>'EPCAM'</span> , <span>'KRT19'</span>, <span>'PROM1'</span>, <span>'ALDH1A1'</span> )<br><br>p &lt;- DotPlot(sce.all, features = genes_to_check,<br>             assay=<span>'RNA'</span> ,<span>group</span>.<span>by</span> = <span>'RNA_snn_res.0.1'</span> )  + coord_flip()<br><br>p<br></code></pre><p><br></p><p>看起来这一群是plasma<br></p><figure><img data-ratio="0.6296296296296297" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2y8DSJMrerWDvxUt6e4jm3nErlVJcjrscxnSL0f2dRkBGwnWbQQsTb3w/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2y8DSJMrerWDvxUt6e4jm3nErlVJcjrscxnSL0f2dRkBGwnWbQQsTb3w/640?wx_fmt=png"></figure><h2><span>3.featureplot&amp;heatmap</span></h2><pre><code><span>library</span>(grid)<br><span>library</span>(ggplot2)<br><span>library</span>(gridExtra)<br><span>##基因在细胞中的表达</span><br><span>##EPCAM，PGR,TFF3</span><br><span>#PTPRC</span><br><span>#PECAM1</span><br><span>#ACTA2</span><br>tumor_cellmarker &lt;- c(<span>'EPCAM'</span>,<span>'PGR'</span>,<span>'TFF3'</span>)<br>immune_cellmarker &lt;- c(<span>"PTPRC"</span>)<br>endo_cellmarker &lt;- c(<span>"PECAM1"</span>)<br>CAFs_cellmarker &lt;- c(<span>"ACTA2"</span>)<br><br>FeaturePlot(sce.all,features = tumor_cellmarker,cols = c(<span>"lightgrey"</span> ,<span>"#DE1F1F"</span>),ncol=<span>3</span>,raster=<span>FALSE</span>)<br>FeaturePlot(sce.all,features = immune_cellmarker,cols = c(<span>"lightgrey"</span> ,<span>"#DE1F1F"</span>),raster=<span>FALSE</span>)<br>FeaturePlot(sce.all,features = endo_cellmarker,cols = c(<span>"lightgrey"</span> ,<span>"#DE1F1F"</span>),raster=<span>FALSE</span>)<br>FeaturePlot(sce.all,features = CAFs_cellmarker,cols = c(<span>"lightgrey"</span> ,<span>"#DE1F1F"</span>),raster=<span>FALSE</span>)<br><br>plot1 &lt;- FeaturePlot(sce.all,features = CAFs_cellmarker,cols = c(<span>"lightgrey"</span> ,<span>"#DE1F1F"</span>),raster=<span>FALSE</span>)<br><span># 添加标题</span><br>title &lt;- textGrob(<span>"CAFs"</span>, gp = gpar(fontsize = <span>20</span>, fontface = <span>"bold"</span>))<br><span># 将标题放在图片上方</span><br>plot_with_title &lt;- grid.arrange(top = title, plot1)<br></code></pre><figure><img data-ratio="0.3768518518518518" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ys6Cu5lI1OGLA1eNS1baoapft3ibK5Qpud1g08ZzibUictJCIicRDmrP6Ew/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ys6Cu5lI1OGLA1eNS1baoapft3ibK5Qpud1g08ZzibUictJCIicRDmrP6Ew/640?wx_fmt=png"></figure><br><figure><img data-ratio="0.8564814814814815" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yNzZKWQfJKSNx3srWr54MYKlxiavBe4qxLUMj2EuAKCar1zyqd0uPNXg/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yNzZKWQfJKSNx3srWr54MYKlxiavBe4qxLUMj2EuAKCar1zyqd0uPNXg/640?wx_fmt=png"></figure><pre><code><span>#2.热图</span><br>Idents(sce.all)<br>sce.markers &lt;- FindAllMarkers(object = sce.all, only.pos = <span>TRUE</span>, <br>                              min.pct = <span>0.25</span>, <br>                              thresh.<span>use</span> = <span>0.25</span>)<br>DT::datatable(sce.markers)<br><span>#pro='markers'</span><br><span>#write.csv(sce.markers,file=paste0(pro,'_sce.markers.csv'))</span><br>library(dplyr) <br>top10 &lt;- sce.markers %&gt;% group_by(cluster) %&gt;% top_n(<span>10</span>, avg_log2FC)<br><span>#为了防止数据量太大不好出图，这里在每个亚群提取出来100个</span><br>DoHeatmap(subset(sce.all,downsample=<span>100</span>),top10$gene,size=<span>3</span>)+scale_fill_gradientn(colors=c(<span>"#94C4E1"</span>,<span>"white"</span>,<span>"red"</span>))<br></code></pre><p>看看每个群里差异表达的基因<br></p><figure><img data-ratio="0.8435185185185186" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2y5QSY4gz8qM62c1FHSnOSY0hxgtHxvp1dh7jj3EibLjGo4eqQ3foy6iaA/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2y5QSY4gz8qM62c1FHSnOSY0hxgtHxvp1dh7jj3EibLjGo4eqQ3foy6iaA/640?wx_fmt=png"></figure><h2><span>4.治疗前后细胞亚群比例</span></h2><pre><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><span>library</span>(celldex)<br><span>library</span>(singleseqgset)<br><span>library</span>(devtools)<br>getwd()<br>dir.create(<span>"4-prop"</span>)<br>setwd(<span>'4-prop/'</span>)<br>sce.all=readRDS( <span>"3-cell/sce_celltype.rds"</span>)<br>sce.all<br><br><br><span>##堆积柱状图</span><br><span>library</span>(tidyr)<br><span>library</span>(reshape2)<br><br>tb=table(sce.all$group, sce.all$celltype)<br>head(tb)<br><span>library</span> (gplots) <br>balloonplot(tb)<br></code></pre><p><br></p><p>看看C1D1和C3D1组中细胞亚群的比例<br></p><figure><img data-ratio="0.6268518518518519" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yqwIicsYRnxCxncic6MUsic70DvbhnrPAOhIGXUdHUAOq79BDtibnm6rByg/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yqwIicsYRnxCxncic6MUsic70DvbhnrPAOhIGXUdHUAOq79BDtibnm6rByg/640?wx_fmt=png"></figure><pre><code>bar_data &lt;- as.data.frame(tb)<br><br>bar_per &lt;- bar_data %&gt;% <br>  group_by(Var1) %&gt;%<br>  mutate(sum(Freq)) %&gt;%<br>  mutate(percent = Freq / `sum(Freq)`)<br>head(bar_per) <br><span>#write.csv(bar_per,file = "celltype_by_group_percent.csv")</span><br>col =c(<span>"#3176B7"</span>,<span>"#F78000"</span>,<span>"#3FA116"</span>,<span>"#CE2820"</span>,<span>"#9265C1"</span>,<br>                <span>"#885649"</span>,<span>"#DD76C5"</span>,<span>"#7F7F7F"</span>,<span>"#BBBE00"</span>,<span>"#41BED1"</span>)<br>colnames(bar_per)<br>p1 = ggplot(bar_per, aes(x = Freq, y = Var1)) +<br>  geom_bar(aes(fill = Var2) , stat = <span>"identity"</span>) + coord_flip() +<br>  theme(axis.ticks = element_line(linetype = <span>"blank"</span>),<br>        legend.position = <span>"top"</span>,<br>        panel.grid.minor = element_line(colour = <span>NA</span>,linetype = <span>"blank"</span>), <br>        panel.background = element_rect(fill = <span>NA</span>),<br>        plot.background = element_rect(colour = <span>NA</span>)) +<br>  labs(y = <span>" "</span>, fill = <span>NULL</span>)+labs(x = <span>'Total cell number'</span>)+<br>  scale_fill_manual(values=col)+<br>  theme_classic()+<br>  theme(plot.title = element_text(size=<span>12</span>,hjust=<span>0.5</span>))<br>p1<br><br>p2 = ggplot(bar_per, aes(x = percent, y = Var1)) +<br>  geom_bar(aes(fill = Var2) , stat = <span>"identity"</span>) + coord_flip() +<br>  theme(axis.ticks = element_line(linetype = <span>"blank"</span>),<br>        legend.position = <span>"top"</span>,<br>        panel.grid.minor = element_line(colour = <span>NA</span>,linetype = <span>"blank"</span>), <br>        panel.background = element_rect(fill = <span>NA</span>),<br>        plot.background = element_rect(colour = <span>NA</span>)) +<br>  labs(y = <span>" "</span>, fill = <span>NULL</span>)+labs(x = <span>'Relative proportion(%)'</span>)+<br>  scale_fill_manual(values=col)+<br>  theme_classic()+<br>  theme(plot.title = element_text(size=<span>12</span>,hjust=<span>0.5</span>))<br><br>p1 + p2<br></code></pre><p>治疗后肿瘤细胞明显减少，plasma增加。<br></p><figure><img data-ratio="0.7768518518518519" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ytjyAxsG16dRwk3U1DD9VSvgEP8IeAUogGzicskExPTA9hSP29BsNObg/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ytjyAxsG16dRwk3U1DD9VSvgEP8IeAUogGzicskExPTA9hSP29BsNObg/640?wx_fmt=png"></figure><h2><span>5.EMT_score评分</span></h2><figure><img data-ratio="0.24714828897338403" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yuS1zicdxfQJmswJvRHjArT99l1QAOiaTv1NXiaQKNh2tJoJ6CCwQibyaXQ/640?wx_fmt=png" data-type="png" data-w="1052" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yuS1zicdxfQJmswJvRHjArT99l1QAOiaTv1NXiaQKNh2tJoJ6CCwQibyaXQ/640?wx_fmt=png"></figure><br>先找到基因集<pre><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><span>library</span>(celldex)<br><span>library</span>(singleseqgset)<br><span>library</span>(devtools)<br>getwd()<br>sce.all=readRDS( <span>"3-cell/sce_celltype.rds"</span>)<br>sce.all<br><br><span># BiocManager::install("msigdbr")</span><br><span>library</span>(msigdbr)<br><span>#https://www.gsea-msigdb.org/gsea/msigdb/cards/HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION</span><br><br>?msigdbr<br><span>#EMT评分基因集在hallmark里</span><br>m = msigdbr(species = <span>"Homo sapiens"</span>, category = <span>"H"</span>)<br><br>m_EMT = m[m$gs_name == <span>'HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION'</span>,]<br><br><span>#评分计算</span><br><span>#BiocManager::install("UCell")</span><br><span>library</span>(UCell)<br>EMT &lt;- list(m_EMT$gene_symbol)<span>#将基因整成list</span><br>names(EMT)[<span>1</span>] &lt;- <span>'EMT'</span><br>DefaultAssay(sce.all) &lt;- <span>'RNA'</span><br>EMT_score &lt;- AddModuleScore_UCell(sce.all,<br>                                         features=EMT,<br>                                         name=<span>"Hallmark_EMT_score"</span>)<br><br>EMT_score$EMTHallmark_EMT_score<br><span>library</span>(viridis)<br>FeaturePlot(EMT_score,features = <span>"EMTHallmark_EMT_score"</span>,<br>            order = <span>T</span>,cols = viridis(<span>256</span>), split.by = <span>'orig.ident'</span>)<br><br><span>#提取数据</span><br><span>library</span>(ggpubr)<br>df&lt;- FetchData(EMT_score,vars = c(<span>"orig.ident"</span>,<span>"EMTHallmark_EMT_score"</span>))<br><br><span>#设置比较组</span><br>my_comparisons &lt;- list(c(<span>"C1D1"</span>, <span>"C3D1"</span>)) <br><br>colnames(df)<br>colnames(df)[<span>2</span>] = <span>"Hallmark_EMT_score"</span><br><span>#小提琴图</span><br>ggplot(df,aes(x=orig.ident,y=Hallmark_EMT_score,fill=orig.ident))+<br>  geom_violin(color=<span>'black'</span>,size=<span>1</span>)+<span>#小提琴</span><br>  theme_classic() + <br>  theme(text = element_text(size=<span>10</span>, colour = <span>"black"</span>)) + <br>  theme(plot.title = element_text(hjust = <span>0.5</span>, size = <span>15</span>),<br>        axis.text.x = element_text(colour = <span>"black"</span>, size = <span>12</span>),<br>        axis.text.y = element_text(colour = <span>"black"</span>, size = <span>10</span>),<br>        axis.title.y = element_text(color = <span>'black'</span>, size = <span>12</span>),<br>        axis.line = element_line(size = <span>1</span>))+ <br>  theme(legend.position=<span>"none"</span>) +  <br>  xlab(<span>NULL</span>)+<br>  geom_boxplot(width=<span>0.1</span>, fill=<span>"white"</span>, outlier.shape = <span>NA</span>) +<span>#箱线图</span><br>  stat_compare_means(method=<span>"t.test"</span>,hide.ns = <span>F</span>,<br>                     comparisons =c(my_comparisons),<br>                     label=<span>"p.signif"</span>,<br>                     bracket.size=<span>0.8</span>,<br>                     size=<span>6</span>)<span>#添加显著性比较</span><br></code></pre><figure><img data-ratio="0.8814814814814815" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yUn92EVMicNFg0R85k3TYc9lgqR9kSibecgNCbUdjeT4rtvr10zux5PNA/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yUn92EVMicNFg0R85k3TYc9lgqR9kSibecgNCbUdjeT4rtvr10zux5PNA/640?wx_fmt=png"></figure><h2><span>6.肿瘤细胞重聚类分群</span></h2><p>细胞分亚群重新降维聚类</p><pre><code><span>## create subsets ----</span><br>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br>getwd()<br>sce.all=readRDS( <span>"3-cell/sce_celltype.rds"</span>)<br>table(Idents(sce.all))<br>immune &lt;- subset(sce.all, idents = <span>"Immune"</span>)<br>epithelial &lt;- subset(sce.all, idents = <span>"Tumor"</span>)<br>endothelial &lt;- subset(sce.all, idents = <span>"Endothelial"</span>)<br>CAFs &lt;- subset(sce.all, idents = <span>"CAFs"</span>)<br><br>saveRDS(immune, <span>"immune.rds"</span>)<br>saveRDS(epithelial, <span>"epithelial.rds"</span>)<br>saveRDS(endothelial, <span>"endothelial.rds"</span>)<br>saveRDS(CAFs, <span>"CAFs.rds"</span>)<br><br><span>####肿瘤细胞重聚类####</span><br>sce=readRDS( <span>"epithelial.rds"</span>)<br>DefaultAssay(sce) &lt;- <span>"RNA"</span><br>table(sce$orig.ident)<br><br>table(sce$celltype)<br>table(sce$group,sce$celltype)<br>sce=CreateSeuratObject(counts = sce@assays$RNA@counts,<br>                       meta.data = sce@meta.data) <br><br>sce &lt;- NormalizeData(sce, normalization.method =  <span>"LogNormalize"</span>,  <br>                     scale.factor = <span>1e4</span>)<br>GetAssay(sce,assay = <span>"RNA"</span>)<br>sce &lt;- FindVariableFeatures(sce, <br>                            selection.method = <span>"vst"</span>, nfeatures = <span>2000</span>)  <br>sce &lt;- ScaleData(sce) <br>sce &lt;- RunPCA(object = sce, pc.genes = VariableFeatures(sce)) <br>DimHeatmap(sce, dims = <span>1</span>:<span>12</span>, cells = <span>100</span>, balanced = <span>TRUE</span>)<br>ElbowPlot(sce) <br><br>sce &lt;- FindNeighbors(sce, dims = <span>1</span>:<span>15</span>)<br>sce &lt;- FindClusters(sce, resolution = <span>0.1</span>)<br>table(sce@meta.data$RNA_snn_res.0.1)  <br><br>set.seed(<span>123</span>)<br>sce &lt;- RunTSNE(object = sce, dims = <span>1</span>:<span>15</span>, do.fast = <span>TRUE</span>)<br>sce &lt;- RunUMAP(object = sce, dims = <span>1</span>:<span>15</span>, do.fast = <span>TRUE</span>)<br>DimPlot(sce,reduction = <span>"umap"</span>,label=<span>T</span>) <br>head(sce@meta.data)<br>DimPlot(sce,reduction = <span>"umap"</span>,label=<span>T</span>,group.by = <span>'orig.ident'</span>)<br><br>mycolors &lt;-c(<span>'#E5D2DD'</span>, <span>'#53A85F'</span>, <span>'#F1BB72'</span>, <span>'#F3B1A0'</span>, <span>'#D6E7A3'</span>, <span>'#57C3F3'</span>,<br>                      <span>'#E95C59'</span>, <span>'#E59CC4'</span>, <span>'#AB3282'</span>,  <span>'#BD956A'</span>, <br>                      <span>'#9FA3A8'</span>, <span>'#E0D4CA'</span>,  <span>'#C5DEBA'</span>, <span>'#F7F398'</span>,<br>                      <span>'#C1E6F3'</span>, <span>'#6778AE'</span>, <span>'#91D0BE'</span>, <span>'#B53E2B'</span>,<br>                      <span>'#712820'</span>, <span>'#DCC1DD'</span>, <span>'#CCE0F5'</span>,  <span>'#CCC9E6'</span>, <span>'#625D9E'</span>, <span>'#68A180'</span>, <span>'#3A6963'</span>,<br>                      <span>'#968175'</span>)<br><span>library</span>(harmony)<br><span>library</span>(patchwork)<br><span>library</span>(RColorBrewer)<br><span>library</span>(scales)<br>col4&lt;-colorRampPalette(brewer.pal(<span>8</span>,<span>'Set2'</span>))(<span>12</span>)<br>DimPlot(sce, reduction = <span>'umap'</span>,pt.size = <span>2</span>,cols = mycolors,label = <span>T</span>,group.by = <span>"RNA_snn_res.0.1"</span>,label.size = <span>6</span>) <br><br><span>#####治疗前后之间的差异</span><br>DimPlot(sce, reduction = <span>'umap'</span>,pt.size = <span>1</span>,cols = col4,label = <span>T</span>,split.by = <span>'orig.ident'</span>,label.size = <span>6</span>,raster=<span>FALSE</span>) <br><span>#ggsave(filename = 'umap_sce_recluster_treatment.pdf',width = 10,height = 6.5) </span><br></code></pre><p>跟文中趋势一致，基本上治疗后每个细胞群都降低了一些。<br></p><figure><img data-ratio="0.5175925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2y5Fjl2wPRMUry6ia9M7A5XzKRO7uE3vHabaicUibAKnvDRv57Qbwib1T0eg/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2y5Fjl2wPRMUry6ia9M7A5XzKRO7uE3vHabaicUibAKnvDRv57Qbwib1T0eg/640?wx_fmt=png"></figure><pre><code><span>###看看比例</span><br><span>library</span>(tidyr)<br><span>library</span>(reshape2)<br><br>tb=table(sce$group, sce$RNA_snn_res.0.1)<br>head(tb)<br><span>library</span> (gplots) <br>balloonplot(tb)<br>bar_data &lt;- as.data.frame(tb)<br><br>bar_per &lt;- bar_data %&gt;% <br>  group_by(Var1) %&gt;%<br>  mutate(sum(Freq)) %&gt;%<br>  mutate(percent = Freq / `sum(Freq)`)<br>head(bar_per) <br><span>#write.csv(bar_per,file = "celltype_by_group_percent.csv")</span><br>col =c(<span>"#3176B7"</span>,<span>"#F78000"</span>,<span>"#3FA116"</span>,<span>"#CE2820"</span>,<span>"#9265C1"</span>,<br>                <span>"#885649"</span>,<span>"#DD76C5"</span>,<span>"#7F7F7F"</span>,<span>"#BBBE00"</span>,<span>"#41BED1"</span>)<br>colnames(bar_per)<br>p1 = ggplot(bar_per, aes(x = Freq, y = Var1)) +<br>                  geom_bar(aes(fill = Var2) , stat = <span>"identity"</span>) + coord_flip() +<br>                  theme(axis.ticks = element_line(linetype = <span>"blank"</span>),<br>                        legend.position = <span>"top"</span>,<br>                        panel.grid.minor = element_line(colour = <span>NA</span>,linetype = <span>"blank"</span>), <br>                        panel.background = element_rect(fill = <span>NA</span>),<br>                        plot.background = element_rect(colour = <span>NA</span>)) +<br>                  labs(y = <span>" "</span>, fill = <span>NULL</span>)+labs(x = <span>'Total cell number'</span>)+<br>                  scale_fill_manual(values=col)+<br>                  theme_classic()+<br>                  theme(plot.title = element_text(size=<span>12</span>,hjust=<span>0.5</span>))<br>p1<br><br>p2 = ggplot(bar_per, aes(x = percent, y = Var1)) +<br>                  geom_bar(aes(fill = Var2) , stat = <span>"identity"</span>) + coord_flip() +<br>                  theme(axis.ticks = element_line(linetype = <span>"blank"</span>),<br>                        legend.position = <span>"top"</span>,<br>                        panel.grid.minor = element_line(colour = <span>NA</span>,linetype = <span>"blank"</span>), <br>                        panel.background = element_rect(fill = <span>NA</span>),<br>                        plot.background = element_rect(colour = <span>NA</span>)) +<br>                  labs(y = <span>" "</span>, fill = <span>NULL</span>)+labs(x = <span>'Relative proportion(%)'</span>)+<br>                  scale_fill_manual(values=col)+<br>                  theme_classic()+<br>                  theme(plot.title = element_text(size=<span>12</span>,hjust=<span>0.5</span>))<br><br>p1 + p2<br></code></pre><p>可以看到0这一个亚群，降低的特别明显。<br></p><figure><img data-ratio="0.5055555555555555" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2y02pp8KEbaf5rF5mrtIc6fdjEkfciaJlCfoo8B3OP1Cp7ibhu0icHT1oeg/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2y02pp8KEbaf5rF5mrtIc6fdjEkfciaJlCfoo8B3OP1Cp7ibhu0icHT1oeg/640?wx_fmt=png"></figure><pre><code><span>##EMT评分</span><br>library(msigdbr)<br><span>#EMT评分基因集在hallmark里</span><br>m = msigdbr(species = <span>"Homo sapiens"</span>, category = <span>"H"</span>)<br>m_EMT = m[m$gs_name == <span>'HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION'</span>,]<br><br><span>#评分计算</span><br>library(UCell)<br>EMT &lt;- <span>list</span>(m_EMT$gene_symbol)<span>#将基因整成list</span><br>names(EMT)[<span>1</span>] &lt;- <span>'EMT'</span><br>DefaultAssay(sce.all) &lt;- <span>'RNA'</span><br>EMT_score &lt;- AddModuleScore_UCell(sce,<br>                                  features=EMT,<br>                                  name=<span>"Hallmark_EMT_score"</span>)<br><br>EMT_score$EMTHallmark_EMT_score<br>library(viridis)<br>FeaturePlot(EMT_score,features = <span>"EMTHallmark_EMT_score"</span>,<br>            order = T,cols = viridis(<span>256</span>))<br></code></pre><figure><img data-ratio="0.9111111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yt43ZtIG1wb2XlL74Yxdm0jIah9oNSw6xlf8uJIrVsptFHGbibZkKeDw/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yt43ZtIG1wb2XlL74Yxdm0jIah9oNSw6xlf8uJIrVsptFHGbibZkKeDw/640?wx_fmt=png"></figure><pre><code><span>##看看另一种评分方式</span><br><span>#AddModuleScore不是Ucell哦</span><br>Inscore &lt;- AddModuleScore(sce,<br>                          features = EMT,<br>                          ctrl = <span>100</span>,<br>                          name = <span>"Hallmark_EMT_score"</span>)<br>colnames(Inscore@meta.data)<br>VlnPlot(Inscore,features = <span>'Hallmark_EMT_score1'</span>, <br>        pt.size = <span>0</span>, adjust = <span>2</span>,group.<span>by</span> = <span>"orig.ident"</span>)<br></code></pre><figure><img data-ratio="0.9166666666666666" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ykJeKAzqSotdVJV9HaOMbckb48EBic83kxhzeehTae7yTMb2CsAibx5hQ/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ykJeKAzqSotdVJV9HaOMbckb48EBic83kxhzeehTae7yTMb2CsAibx5hQ/640?wx_fmt=png"></figure><pre><code><span>###密度图</span><br><span>library</span>(UCell)<br><span>library</span>(irGSEA)<br><span>library</span>(Nebulosa)<br><span>library</span>(decoupleR)<br><span>library</span>(AUCell)<br><span>library</span>(irGSEA)<br>install.packages(<span>'Nebulosa'</span>)<br>BiocManager::install(<span>'Nebulosa'</span>)<br>BiocManager::install(<span>'decoupleR'</span>)<br>BiocManager::install(<span>'AUCell'</span>)<br><br><span>if</span> (!requireNamespace(<span>"irGSEA"</span>, quietly = <span>TRUE</span>)) {<br>  devtools::install_github(<span>"chuiqin/irGSEA"</span>)<br>}<br>?<br>sce.final &lt;- irGSEA.score(object = sce, assay = <span>"RNA"</span>,<br>                            slot = <span>"data"</span>, msigdb = <span>T</span>, species = <span>"Homo sapiens"</span>,<br>                            category = <span>"H"</span>, geneid = <span>"symbol"</span>,<br>                            method = c(<span>"AUCell"</span>, <span>"UCell"</span>, <span>"singscore"</span>, <span>"ssgsea"</span>), kcdf = <span>'Gaussian'</span>)<br>irGSEA.density.scatterplot(object = sce.final,<br>                                  method = <span>"singscore"</span>,<br>                                  show.geneset = <span>"HALLMARK-EPITHELIAL-MESENCHYMAL-TRANSITION"</span>,<br>                                  reduction = <span>"umap"</span>)<br></code></pre><p>这里是使用 singscore的评分方式。<br>所以密度图真的比FeaturePlot更为直观一点，颜色更为分明。<br>看出主要是0这一群EMT特征更强，治疗后0这一群显著减少，寿命治疗后抑制了EMT。<br></p><figure><img data-ratio="0.9185185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2y9rzyDCVubXk5XSlK1gcQWor6cLv90eGcKy786ibKqaXKtHlYGfRXKgg/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2y9rzyDCVubXk5XSlK1gcQWor6cLv90eGcKy786ibKqaXKtHlYGfRXKgg/640?wx_fmt=png"></figure><h2><span>7.免疫细胞重聚类分群</span></h2><p>下面就是免疫细胞的细分亚群</p><pre><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br>getwd()<br>sce=readRDS( <span>"immune.rds"</span>)<br>DefaultAssay(sce) &lt;- <span>"RNA"</span><br>table(sce$orig.ident)<br><br>table(sce$celltype)<br>table(sce$group,sce$celltype)<br>sce=CreateSeuratObject(counts = sce@assays$RNA@counts,<br>                       meta.data = sce@meta.data) <br><br>sce &lt;- NormalizeData(sce, normalization.method =  <span>"LogNormalize"</span>,  <br>                     scale.factor = <span>1e4</span>)<br>GetAssay(sce,assay = <span>"RNA"</span>)<br>sce &lt;- FindVariableFeatures(sce, <br>                            selection.method = <span>"vst"</span>, nfeatures = <span>2000</span>)  <br>sce &lt;- ScaleData(sce) <br>sce &lt;- RunPCA(object = sce, pc.genes = VariableFeatures(sce)) <br>DimHeatmap(sce, dims = <span>1</span>:<span>12</span>, cells = <span>100</span>, balanced = <span>TRUE</span>)<br>ElbowPlot(sce) <br><br>sce &lt;- FindNeighbors(sce, dims = <span>1</span>:<span>15</span>)<br>sce &lt;- FindClusters(sce, resolution = <span>0.5</span>)<br>table(sce@meta.data$RNA_snn_res.0.5)  <br><br>set.seed(<span>123</span>)<br>sce &lt;- RunTSNE(object = sce, dims = <span>1</span>:<span>15</span>, do.fast = <span>TRUE</span>)<br>sce &lt;- RunUMAP(object = sce, dims = <span>1</span>:<span>15</span>, do.fast = <span>TRUE</span>)<br>DimPlot(sce,reduction = <span>"umap"</span>,label=<span>T</span>) <br>head(sce@meta.data)<br>DimPlot(sce,reduction = <span>"umap"</span>,label=<span>T</span>,group.by = <span>'orig.ident'</span>)<br><br>mycolors &lt;-c(<span>'#E5D2DD'</span>, <span>'#53A85F'</span>, <span>'#F1BB72'</span>, <span>'#F3B1A0'</span>, <span>'#D6E7A3'</span>, <span>'#57C3F3'</span>,<br>                      <span>'#E95C59'</span>, <span>'#E59CC4'</span>, <span>'#AB3282'</span>,  <span>'#BD956A'</span>, <br>                      <span>'#9FA3A8'</span>, <span>'#E0D4CA'</span>,  <span>'#C5DEBA'</span>, <span>'#F7F398'</span>,<br>                      <span>'#C1E6F3'</span>, <span>'#6778AE'</span>, <span>'#91D0BE'</span>, <span>'#B53E2B'</span>,<br>                      <span>'#712820'</span>, <span>'#DCC1DD'</span>, <span>'#CCE0F5'</span>,  <span>'#CCC9E6'</span>, <span>'#625D9E'</span>, <span>'#68A180'</span>, <span>'#3A6963'</span>,<br>                      <span>'#968175'</span>)<br>                      <span>library</span>(harmony)<br><span>library</span>(patchwork)<br><span>library</span>(RColorBrewer)<br><span>library</span>(scales)<br>col4&lt;-colorRampPalette(brewer.pal(<span>8</span>,<span>'Set2'</span>))(<span>13</span>)<br>DimPlot(sce, reduction = <span>'umap'</span>,pt.size = <span>2</span>,cols = mycolors,label = <span>T</span>,group.by = <span>"RNA_snn_res.0.5"</span>,label.size = <span>6</span>) <br><br><span>#####治疗前后之间的差异</span><br>DimPlot(sce, reduction = <span>'umap'</span>,pt.size = <span>1</span>,cols = col4,label = <span>T</span>,split.by = <span>'orig.ident'</span>,label.size = <span>6</span>,raster=<span>FALSE</span>) <br><span>#ggsave(filename = 'umap_sce_recluster_treatment.pdf',width = 10,height = 6.5) </span><br></code></pre><figure><img data-ratio="0.6324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ypQ5BFhqIyAtHlm2JCf8ry8BgToTMt7FayeWexL3WrXyfgtfxziaj8KA/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ypQ5BFhqIyAtHlm2JCf8ry8BgToTMt7FayeWexL3WrXyfgtfxziaj8KA/640?wx_fmt=png"></figure><br>使用singleR注释<pre><code>library(SingleR)<br>library(celldex)<br>library(Seurat)<br>library(dplyr)<br>library(stringr)<br>library(pheatmap)<br>library(ReactomeGSA)<br>library(monocle)<br>library(limma)<br>library(ggplot2)<br>library(msigdbr)<br>library(singleseqgset)<br>library(devtools)<br><span>#install_github("arc85/singleseqgset")</span><br><br><span># singleR注释</span><br><span>#hpca.se &lt;- HumanPrimaryCellAtlasData()</span><br><span>#save(hpca.se,file = 'hpca.RData')</span><br>load(<span>'hpca.RData'</span>)<br>unique(hpca.se$label.main)<br>unique(hpca.se$label.fine)<br>unique(bpe.se$label.main)<br>unique(bpe.se$label.fine)<br><span>#bpe.se &lt;- BlueprintEncodeData()</span><br><span>#save(bpe.se,file = 'bpe.RData')</span><br>load(<span>'bpe.RData'</span>)<br><br>str(sce)<br>anno &lt;- SingleR(sce@assays$RNA$data,<br>                <span>ref</span> = list(BP=bpe.se,HPCA=hpca.se),<br>                labels = list(bpe.se$label.fine,hpca.se$label.main),<br>                clusters = sce@meta.data$seurat_clusters<br>)<br><br>plotScoreHeatmap(anno,clusters = anno@rownames,show_colnames = T)<br>table(anno$labels)<br><br>celltype = data.frame(ClusterID=rownames(anno), <br>                      celltype=anno$labels, <br>                      stringsAsFactors = F) <br><br>sce@meta.data$singleR = celltype[match(sce@meta.data$seurat_clusters,celltype$ClusterID),<span>'celltype'</span>]<br><br>DimPlot(sce, reduction = <span>"umap"</span>,<br>        group.by = <span>"singleR"</span>,label = T,cols = col,label.box=T) <br></code></pre><figure><img data-ratio="0.8398148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yiachQ4LicsNnnLnTudeoZOctTDGWptnEA9eJib2OMrxxF8BK4alE5mp0Q/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yiachQ4LicsNnnLnTudeoZOctTDGWptnEA9eJib2OMrxxF8BK4alE5mp0Q/640?wx_fmt=png"></figure><h2><span>8.细胞间相互作用</span></h2><p>有一点不理解的是，本来前面一直运行的好好的，突然上一步变成了Assay5，于是卡住。难道是在不知不觉中由于更新或安装某个包，Seurat就变成了 v5？<br>首先装一下Y叔的Seurat4_4.4.0</p><pre><code>rm(list=ls())<br>install.packages(<span>"Seurat4_4.4.0.tar.gz"</span>, repos = <span>NULL</span>, <span>type</span> = <span>"source"</span>)<br><span>library</span>(Seurat4)<br>options(stringsAsFactors = F)<br><span>library</span>(SeuratObject)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br>getwd()<br>sce_immue=readRDS( <span>"immune_sce_celltype.rds"</span>)<br>sce_tumor=readRDS( <span>"epithelial.rds"</span>)<br><span>library</span>(CellChat)<br><span>library</span>(tidyverse)<br><span>library</span>(ggalluvial)<br><span>table</span>(sce_tumor@meta.data$celltype)<br><span>table</span>(sce_immue$orig.ident)<br><br>sce_tumor$singleR = <span>'tumor'</span><br><span>table</span>(sce_tumor$singleR)<br>merge_sce &lt;- <span>merge</span>(sce_immue, y = sce_tumor, add.cell.ids = c(<span>"immue"</span>, <span>"tumor"</span>), <span>project</span> = <span>"CD"</span>,merge.data = <span>TRUE</span>)<br><span>table</span>(merge_sce$singleR)<br><span>table</span>(Idents(merge_sce))<br>Idents(merge_sce) = merge_sce$singleR<br><br><span>#将这些细胞类型提取出来</span><br><span>table</span>(merge_sce$singleR)<br>con1 &lt;- merge_sce$singleR %<span>in</span>% c(<span>"CD8+ Tem"</span>,<span>"NK_cell"</span>,<span>"Tregs"</span> ,<span>"tumor"</span>)<br>con2 &lt;- merge_sce$singleR %<span>in</span>% c(<span>"DC"</span>,<span>"Macrophages"</span>,<span>"Monocytes"</span>,<span>"tumor"</span>)<br><br>con3 &lt;- merge_sce$orig.ident %<span>in</span>% c(<span>"C1D1"</span>)<br>con4 &lt;- merge_sce$orig.ident %<span>in</span>% c(<span>"C3D1"</span>)<br><br><span>#C1D1-T-tumor</span><br><span>#C1D1-APC-tumor</span><br><span>#C3D1-T-tumor</span><br><span>#C3D1-APC-tumor</span><br>sce.T_C1D1 &lt;- merge_sce[,con1&amp;con3]<br>sce.T_C3D1 &lt;- merge_sce[,con1&amp;con4]<br>sce.APC_C1D1 &lt;- merge_sce[,con2&amp;con3]<br>sce.APC_C3D1 &lt;- merge_sce[,con2&amp;con4]<br><br><span>##超过三个了，循环一下</span><br>conditions = c(<span>"sce.T_C1D1"</span> , <span>"sce.T_C3D1"</span>, <span>"sce.APC_C1D1"</span>, <span>"sce.APC_C3D1"</span>)<br>cellchat_object = <span>list</span>()<br><span>for</span> (i <span>in</span> <span>1</span>:<span>length</span>(conditions)) {<br>  <span># 提取input数据并添加生成meta信息</span><br>  input_data &lt;- GetAssayData(<span>get</span>(conditions[i]), assay = <span>"RNA"</span>, slot = <span>"data"</span>)<br>  labels &lt;- Idents(<span>get</span>(conditions[i]))<br>  meta_data &lt;- data.frame(<span>group</span> = labels, row.names = <span>names</span>(labels))<br><br>  <span># 建立CellChat对象</span><br>  cellchat_object[[i]] &lt;- createCellChat(<span>object</span> = input_data, meta = meta_data, group.by = <span>"group"</span>)<br><br>}<br><br><span>#设置配体-受体相互作用数据库</span><br>CellChatDB &lt;- CellChatDB.human<br>CellChatDB.use &lt;- CellChatDB<br><br><span>#这部分的处理包括：</span><br><span>#预处理表达数据以进行细胞间通讯分析；</span><br><span>#计算通信概率并推断通信网络；</span><br><span>#推断信号通路水平的细胞间通讯；</span><br><span>#计算聚合的cell-cell通信网络。</span><br>cc.fun &lt;- <span>function</span>(cellchat){<br>  <span>levels</span>(cellchat@idents)<br>  <span>#cellchat对象中增加DB插槽</span><br>  cellchat@DB &lt;- CellChatDB.use<br>  <span>#预处理表达数据以进行细胞间通讯分析</span><br>  <span># subset the expression data of signaling genes for saving computation cost</span><br>  cellchat &lt;- subsetData(cellchat)<br>  cellchat &lt;- identifyOverExpressedGenes(cellchat)<br>  cellchat &lt;- identifyOverExpressedInteractions(cellchat)<br>  <span># project gene expression data onto PPI network (optional)</span><br>  cellchat &lt;- projectData(cellchat, PPI.mouse) <span>#PPI.human PPI.mouse</span><br>  <span>#计算通信概率并推断通信网络</span><br>  <span>#Compute the communication probability and iC3D1er cellular communication network</span><br>  cellchat &lt;- computeCommunProb(cellchat)<br>  <span># Filter out the cell-cell communication if there are only few number of cells in certain cell groups</span><br>  <span>#这里还是不要过滤了，不然有些细胞亚群细胞数量过少被过滤掉之后会造成数据不一致而无法进行后续分析</span><br>  <span>#cellchat &lt;- filterCommunication(cellchat, min.cells = 10)</span><br>  <span>#推断信号通路水平的细胞间通讯</span><br>  cellchat &lt;- computeCommunProbPathway(cellchat)<br>  <span>#计算聚合的cell-cell通信网络</span><br>  cellchat &lt;- aggregateNet(cellchat)<br>  <span># Compute the network centrality scores</span><br>  cellchat &lt;- netAnalysis_computeCentrality(cellchat, slot.name = <span>"netP"</span>) <br>  <span># the slot 'netP' means the iC3D1erred intercellular communication network of signaling pathways</span><br>}<br><br>cellc = <span>list</span>()<br><span>#样本处理</span><br><span>for</span> (i <span>in</span> <span>1</span>:<span>length</span>(conditions)) {<br>  cellchat &lt;- cellchat_object[[i]]<br>  cellc[[i]] &lt;- cc.fun(cellchat)<br>}<br><br>conditions<br>object.list &lt;- <span>list</span>(C1D1_T = cellc[[<span>1</span>]], C3D1_T = cellc[[<span>2</span>]])<br>cellchat1 &lt;- mergeCellChat(object.list, add.names = <span>names</span>(object.list))<br><span>#比较相互作用的连接数和连接强度</span><br>gg1 &lt;- compareInteractions(cellchat1, show.legend = F, <span>group</span> = c(<span>1</span>,<span>2</span>), measure = <span>"count"</span>)<br>gg2 &lt;- compareInteractions(cellchat1, show.legend = F, <span>group</span> = c(<span>1</span>,<span>2</span>), measure = <span>"weight"</span>)<br>gg1 + gg2<br></code></pre><p>很明显治疗后tumor和T细胞间的连接和强度都比治疗前高。<br></p><figure><img data-ratio="0.47314814814814815" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yKSSSSBNMwrw4dG5g7ibLZAmwogpaYWUc7RpLQHe8QJ139PJQa52s87Q/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yKSSSSBNMwrw4dG5g7ibLZAmwogpaYWUc7RpLQHe8QJ139PJQa52s87Q/640?wx_fmt=png"></figure><pre><code><span># 比较不同细胞亚群间的连接数和连接强度的差异-网络图</span><br>par(mfrow = c(1,2), xpd=TRUE)<br>cellchat1@meta$datasets<br>g3 = netVisual_diffInteraction(cellchat1, weight.scale = T, measure = <span>"count"</span>, color.edge = c(<span>"#b2182b"</span>, <span>"#2166ac"</span>))<br>g4 = netVisual_diffInteraction(cellchat1,weight.scale = T, measure = <span>"weight"</span>, color.edge = c(<span>"#b2182b"</span>, <span>"#2166ac"</span>))<br></code></pre><p>这里的对比顺序，呈现红色线条和蓝色线条的顺序，需要看看Levels<br></p><figure><img data-ratio="0.40185185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yruRAa9XUBmsiayrKJJwOuibaSw7ruvMiaLblcckHsbqvYkPS04N7O0P4g/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yruRAa9XUBmsiayrKJJwOuibaSw7ruvMiaLblcckHsbqvYkPS04N7O0P4g/640?wx_fmt=png"></figure><pre><code>weight.<span>max</span> &lt;- getMaxWeight(object.list, attribute = c(<span>"idents"</span>,<span>"count"</span>))<br>par(mfrow = c(<span>1</span>,<span>2</span>), xpd=TRUE)<br><span>for</span> (i <span>in</span> <span>1</span>:length(object.list)) {<br>  netVisual_circle(object.list<span>[[i]]</span>@net$count, weight.scale = T, label.edge= F, edge.weight.<span>max</span> = weight.<span>max</span>[<span>2</span>], edge.width.<span>max</span> = <span>12</span>, title.name = paste0(<span>"Number of interactions - "</span>, names(object.list)[i]))<br>}<br></code></pre><p>可以看出C3D1相比于C1D1，tumor和免疫细胞之间的连接强度大了很多<br></p><figure><img data-ratio="0.4203703703703704" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ym4By4jU69u7IFvBpdnZCnQaMSUrEn2ZV8840h8hY3pk19KaJGKlUpA/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ym4By4jU69u7IFvBpdnZCnQaMSUrEn2ZV8840h8hY3pk19KaJGKlUpA/640?wx_fmt=png"></figure><br>文中还显示在MHC-I和MHC-II在C3D1中增加<pre><code>gg7 &lt;- rankNet(cellchat1, mode = <span>"comparison"</span>, stacked = T, <span>do</span>.stat = <span>TRUE</span>)<br>gg8 &lt;- rankNet(cellchat1, mode = <span>"comparison"</span>, stacked = F, <span>do</span>.stat = <span>TRUE</span>)<br>gg7 + gg8<br></code></pre><figure><img data-ratio="0.6953703703703704" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ycjLpGqVSHZrhfQNufbr5yhNnWNGJZmcXBI0zHx4Fhwpdcyx7nQuNNA/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ycjLpGqVSHZrhfQNufbr5yhNnWNGJZmcXBI0zHx4Fhwpdcyx7nQuNNA/640?wx_fmt=png"></figure><br>接下是tumor和APC之间的相互作用<pre><code><span>####再看看另外两组<br>conditions<br>object.list <span>&lt;<span>-</span> <span>list</span>(<span>C1D1_APC</span> = <span>cellc[[3]],</span> <span>C3D1_APC</span> = <span>cellc[[4]])</span><br><span>cellchat</span> &lt;<span>-</span> <span>mergeCellChat</span>(<span>object.list</span>, <span>add.names</span> = <span>names(object.list))</span><br>#比较相互作用的连接数和连接强度<br><span>gg11</span> &lt;<span>-</span> <span>compareInteractions</span>(<span>cellchat</span>, <span>show.legend</span> = <span>F,</span> <span>group</span> = <span>c(1,2),</span> <span>measure</span> = <span>"count"</span>)<br><span>gg22</span> &lt;<span>-</span> <span>compareInteractions</span>(<span>cellchat</span>, <span>show.legend</span> = <span>F,</span> <span>group</span> = <span>c(1,2),</span> <span>measure</span> = <span>"weight"</span>)<br><span>gg11</span> + <span>gg22</span><br><br># 比较不同细胞亚群间的连接数和连接强度的差异<span>-</span>网络图<br><span>par</span>(<span>mfrow</span> = <span>c(1,2),</span> <span>xpd</span>=<span>TRUE)</span><br><span>cellchat</span>@<span>meta</span>$<span>datasets</span><br><span>g33</span> = <span>netVisual_diffInteraction(cellchat,</span> <span>weight.scale</span> = <span>T,</span> <span>measure</span> = <span>"count"</span>, <span>color.edge</span> = <span>c(</span>"#<span>b2182b</span>", "#<span>2166ac</span>"))<br><span>g44</span> = <span>netVisual_diffInteraction(cellchat,weight.scale</span> = <span>T,</span> <span>measure</span> = <span>"weight"</span>, <span>color.edge</span> = <span>c(</span>"#<span>b2182b</span>", "#<span>2166ac</span>"))<br></span></span></code></pre><p>治疗后tumor和抗原递呈细胞间的连接和强度都比治疗前高。<br></p><figure><img data-ratio="0.5472222222222223" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ya4CvAENa6yvYoribkiawhJseuwLp8D6ZLHmEKq6PPMoRO6mjqGQNwG8g/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2ya4CvAENa6yvYoribkiawhJseuwLp8D6ZLHmEKq6PPMoRO6mjqGQNwG8g/640?wx_fmt=png"></figure><br><figure><img data-ratio="0.475" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yibfl8ZIcx38roib9dWU2bwtHzNiaX6buKicfqTLteicoRKlcQD0Vgfib6Hew/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2yibfl8ZIcx38roib9dWU2bwtHzNiaX6buKicfqTLteicoRKlcQD0Vgfib6Hew/640?wx_fmt=png"></figure><br>可以看出一点治疗后，tumor和DC之间的连接变多，但是DC和单核细胞之间更明显，所以并没有看到文中说治疗后tumor-monocyte转变为tumor-DC的趋势。<br><figure><img data-ratio="0.4787037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2y6HHCCPdhN7nUfNulfh0LOcLFSFkNNPeD1adywibN7gcYFpO7JaFdaKQ/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HuEoKZVCOtXDJgPxeZl2y6HHCCPdhN7nUfNulfh0LOcLFSFkNNPeD1adywibN7gcYFpO7JaFdaKQ/640?wx_fmt=png"></figure></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/NcBfRKv5111014yKMOmtzw",target="_blank" rel="noopener noreferrer">原文链接</a>
