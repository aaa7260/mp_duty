---
title: "肿瘤单细胞转录组的第一层次降维聚类分群"
date: 2023-11-17T04:52:08Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
肿瘤单细胞转录组的第一层次降维聚类分群 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>前些天在《生信技能树》的微信视频号做了一个肿瘤单细胞转录组的数据分析直播，文章是：《Delineating the dynamic evolution from preneoplasia to invasive lung adenocarcinoma by integrating single-cell RNA sequencing and spatial transcriptomics》详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247525924&amp;idx=1&amp;sn=aaa305d856a835adda2f842840b96ec2&amp;scene=21#wechat_redirect" data-linktype="2">换一个分析策略会导致文章的全部论点都得推倒重来吗</a>。</p></blockquote><p data-tool="mdnice编辑器">主要的分析就是第一层次降维聚类分群，然后大概认识一下有什么亚群，以及比例差异情况，最后就是把每个亚群都细分一下做同样的分析即可。</p><h3 data-tool="mdnice编辑器"><span></span>认识GEO数据库里面的单细胞转录组数据文件格式<span></span></h3><p data-tool="mdnice编辑器">我们《生信菜鸟团》的单细胞周更专辑作者分享过好几次了基础文件读取技巧啦，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247511915&amp;idx=1&amp;sn=6c63ddde0d992068b799dec51e302038&amp;scene=21#wechat_redirect" data-linktype="2">读取不同格式的单细胞转录组数据及遇到问题的解决办法</a>。其中最常见的就是使用Read10X读取3个文件，但是Read10X读取3个文件还得注意版本，而且必须保证3个文件名字完全一样，要么是</p><pre data-tool="mdnice编辑器"><span></span><code>barcodes.tsv.gz  features.tsv.gz  matrix.mtx.gz<br></code></pre><p data-tool="mdnice编辑器">或者说是：</p><pre data-tool="mdnice编辑器"><span></span><code>barcodes.tsv  genes.tsv  matrix.mtx<br></code></pre><p data-tool="mdnice编辑器">只有这样才能把表达量矩阵读入进去。而这个数据集是如下所示的文件：</p><pre data-tool="mdnice编辑器"><span></span><code>GSM5699777_TD1_barcodes.tsv.gz 73.7 Kb<br>GSM5699777_TD1_features.tsv.gz 297.6 Kb<br>GSM5699777_TD1_matrix.mtx.gz 71.4 Mb<br><br><br>GSM5699778_TD2_barcodes.tsv.gz 86.0 Kb<br>GSM5699778_TD2_features.tsv.gz 297.6 Kb<br>GSM5699778_TD2_matrix.mtx.gz 77.3 Mb<br></code></pre><p data-tool="mdnice编辑器">所以是需要改名的！</p><h3 data-tool="mdnice编辑器"><span></span>整理和组织文件夹<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>├── [4.0K]  TD1<br>│   ├── [ 74K]  barcodes.tsv.gz<br>│   ├── [298K]  features.tsv.gz<br>│   └── [ 71M]  matrix.mtx.gz<br>├── [4.0K]  TD2<br>│   ├── [ 86K]  barcodes.tsv.gz<br>│   ├── [298K]  features.tsv.gz<br>│   └── [ 77M]  matrix.mtx.gz<br></code></pre><p data-tool="mdnice编辑器">如下所示：</p><p><img data-galleryid="" data-ratio="1.1986970684039089" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyZKL3gyoCJBpZFEZg9wd1RZ51cgJpuuGr8F0pwUmXe0fZV9Ltf71pTodDyCgHOqEHf7EhsFLZ8dg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="614" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyZKL3gyoCJBpZFEZg9wd1RZ51cgJpuuGr8F0pwUmXe0fZV9Ltf71pTodDyCgHOqEHf7EhsFLZ8dg/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>组织文件夹</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>构建Seurat对象<span></span></h3><p data-tool="mdnice编辑器">包的Read10X函数是可以读取单个样品的一个文件夹路径，但是我们是需要循环读取每个文件夹，所以是lapply这样的读取方式：</p><pre data-tool="mdnice编辑器"><span></span><code>dir=<span>'GSE189357_RAW/outputs/'</span> <br>samples=list.files( dir )<br>samples<br><br><span># samples = head(samples,10) </span><br>sceList = lapply(samples,<span>function</span>(pro){ <br>  <span># pro=samples[1] </span><br>  print(pro)  <br>  sce =CreateSeuratObject(counts =  Read10X(file.path(dir,pro )) ,<br>                          project = gsub(<span>'^GSM[0-9]*_'</span>,<span>''</span>,<br>                                         gsub(<span>'filtered_feature_bc_matrix'</span>,<span>''</span>,pro) )  ,<span># pro, #</span><br>                          min.cells = <span>5</span>,<br>                          min.features = <span>500</span> )<br>  <span>return</span>(sce)<br>}) <br>sce.all=merge(x=sceList[[<span>1</span>]],<br>              y=sceList[ -<span>1</span> ],<br>              add.cell.ids =  gsub(<span>'^GSM[0-9]*_'</span>,<span>''</span>,<br>                                   gsub(<span>'filtered_feature_bc_matrix'</span>,<span>''</span>,samples))    ) <br></code></pre><p data-tool="mdnice编辑器">这个seurat对象的结构非常复杂，值得细细品读！</p><h3 data-tool="mdnice编辑器"><span></span>质量控制：<span></span></h3><p data-tool="mdnice编辑器">值得注意是我们依赖于这个V4的版本的Seurat流程做出来了大量的公共数据集的单细胞转录组降维聚类分群流程，100多个公共单细胞数据集全部的处理，链接：https://pan.baidu.com/s/1MzfqW07P9ZqEA_URQ6rLbA?pwd=3heo</p><p data-tool="mdnice编辑器">下面的scRNA_scripts文件夹的r代码都在上面的百度云网盘链接（https://pan.baidu.com/s/1MzfqW07P9ZqEA_URQ6rLbA?pwd=3heo）里面哦：</p><pre data-tool="mdnice编辑器"><span></span><code><span>###### step2:QC质控 ######</span><br>dir.create(<span>"./1-QC"</span>)<br>setwd(<span>"./1-QC"</span>)<br><span># 如果过滤的太狠，就需要去修改这个过滤代码</span><br><span>source</span>(<span>'../scRNA_scripts/qc.R'</span>)<br>sce.all.filt = basic_qc(sce.all)<br>print(dim(sce.all))<br>print(dim(sce.all.filt))<br>setwd(<span>'../'</span>)<br></code></pre><p data-tool="mdnice编辑器">如果是Seurat版本问题，参考我们前面的降级方式：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526354&amp;idx=1&amp;sn=a4fb075968d8a78ecda292067ba18204&amp;scene=21#wechat_redirect" data-linktype="2">假如你不喜欢最新版的Seurat包的单细胞理念</a></p><h3 data-tool="mdnice编辑器"><span></span>整合后再降维聚类分群<span></span></h3><p data-tool="mdnice编辑器">单细胞的每个样品其实都是批次，原则上这样的批次是不可以矫正的，所以这个时候我们把这个步骤称作是整合。</p><pre data-tool="mdnice编辑器"><span></span><code> wc -l scRNA_scripts/*<br> <br>     368 scRNA_scripts/check-all-markers.R<br>      48 scRNA_scripts/harmony.R<br>      14 scRNA_scripts/lib.R<br>     102 scRNA_scripts/qc.R<br></code></pre><p data-tool="mdnice编辑器">scRNA_scripts文件夹的r代码都在上面的百度云网盘链接（https://pan.baidu.com/s/1MzfqW07P9ZqEA_URQ6rLbA?pwd=3heo）里面哈。</p><h3 data-tool="mdnice编辑器"><span></span>确定分辨率<span></span></h3><p data-tool="mdnice编辑器">我们默认会看看 0.1和0.8这两个分辨率的情况：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 为了省力，我们直接看  0.1和0.8即可</span><br>table(Idents(sce.all.int))<br>table(sce.all.int$seurat_clusters)<br>table(sce.all.int$RNA_snn_res.0.1) <br>table(sce.all.int$RNA_snn_res.0.8) <br><br>getwd()<br>dir.create(<span>'check-by-0.1'</span>)<br>setwd(<span>'check-by-0.1'</span>)<br>sel.clust = <span>"RNA_snn_res.0.1"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br>dir.create(<span>'check-by-0.8'</span>)<br>setwd(<span>'check-by-0.8'</span>)<br>sel.clust = <span>"RNA_snn_res.0.8"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br></code></pre><p data-tool="mdnice编辑器">如下所示的0.1分辨率群就很少：</p><p><img data-galleryid="" data-ratio="0.5166666666666667" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyZKL3gyoCJBpZFEZg9wd1RdKQHzM9KM0AFT2IzDGKgnmicYXacAw8Ajzer4n0DL65g5lP5se3dnYg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyZKL3gyoCJBpZFEZg9wd1RdKQHzM9KM0AFT2IzDGKgnmicYXacAw8Ajzer4n0DL65g5lP5se3dnYg/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>0.1分辨率群就很少</figcaption></figure><p data-tool="mdnice编辑器">如下所示的0.8分辨率群就很多：</p><p><img data-galleryid="" data-ratio="0.3925925925925926" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyZKL3gyoCJBpZFEZg9wd1Rlnxh51oTkYm6L6ic2dkWrOicAX3tWMgCibibIhFAJswMsYFoUKIzoGKA8Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyZKL3gyoCJBpZFEZg9wd1Rlnxh51oTkYm6L6ic2dkWrOicAX3tWMgCibibIhFAJswMsYFoUKIzoGKA8Q/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>0.8分辨率群就很多</figcaption></figure><p data-tool="mdnice编辑器">在上面的0.1的分辨率下面，b细胞和plasma细胞是没办法区分的，但是在0.8的分辨率下面可以看到2群是b细胞但是13群是plasma细胞。</p><h3 data-tool="mdnice编辑器"><span></span>人工注释单细胞亚群<span></span></h3><blockquote data-tool="mdnice编辑器"><p>肺癌单细胞数据集也有好几十个了，拿到表达量矩阵后的第一层次降维聚类分群通常是：</p></blockquote><ul data-tool="mdnice编辑器"><li><section>immune (CD45+,PTPRC),</section></li><li><section>epithelial/cancer (EpCAM+,EPCAM),</section></li><li><section>stromal (CD10+,MME,fibo or CD31+,PECAM1,endo)</section></li></ul><p data-tool="mdnice编辑器">参考我前面介绍过 <a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247488940&amp;idx=1&amp;sn=1cc8a8a74715087939b9721c0881775d&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现08—肿瘤单细胞数据第一次分群通用规则</a>，这3大单细胞亚群构成了肿瘤免疫微环境的复杂。所以是很容易降维聚类分群啦，我们都是人工命名，比如上面的0.1的分辨率下面就可以人工判断给出来下面的亚群名字：</p><pre data-tool="mdnice编辑器"><span></span><code>  <span>#定义细胞亚群        </span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span> ),<span>2</span>]=<span>'Tcells'</span> <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>2</span> ),<span>2</span>]=<span>'Bcells'</span> <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>1</span>   ),<span>2</span>]= <span>'myeloids'</span> <span># </span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>4</span> ),<span>2</span>]=<span>'mast'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>5</span> ),<span>2</span>]=<span>'endo'</span><br>  <br>  celltype[celltype$ClusterID %<span>in</span>% c(<span>6</span>),<span>2</span>]=<span>'fibro'</span>  <br>  celltype[celltype$ClusterID %<span>in</span>% c(<span>8</span>),<span>2</span>]=<span>'cycle'</span>  <br>   <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>3</span>,<span>7</span>,<span>9</span> ),<span>2</span>]=<span>'epi'</span>   <br></code></pre><p data-tool="mdnice编辑器">整体来说这个复现的代码在百度云分享给大家：链接：https://pan.baidu.com/s/1niFqyAiUU3yXK1W26b8RvQ?pwd=nbmj</p><h3 data-tool="mdnice编辑器"><span></span>如果是其它数据集<span></span></h3><p data-tool="mdnice编辑器">重点看数据文件如何读入，然后看细胞亚群如何人工确定名字！我们依赖于这个V4的版本的Seurat流程做出来了大量的公共数据集的单细胞转录组降维聚类分群流程，100多个公共单细胞数据集全部的处理，链接：https://pan.baidu.com/s/1MzfqW07P9ZqEA_URQ6rLbA?pwd=3heo</p><p data-tool="mdnice编辑器">上面的代码演示都是在《生信技能树》的微信视频号，应该是很容易关注后看里面的回放哦！</p><p><img data-galleryid="" data-ratio="1.3296398891966759" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyZKL3gyoCJBpZFEZg9wd1R1MO93icwsbpETgvcM2CoAQKFF11Jn7auIziab7NicbWmShG4zq5tMJz9Q/640?wx_fmt=jpeg&amp;from=appmsg" data-type="png" data-w="722" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyZKL3gyoCJBpZFEZg9wd1R1MO93icwsbpETgvcM2CoAQKFF11Jn7auIziab7NicbWmShG4zq5tMJz9Q/640?wx_fmt=jpeg&amp;from=appmsg"></p><section><br></section></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/asY88XCSI1thBUxdgTJogQ",target="_blank" rel="noopener noreferrer">原文链接</a>
