---
title: "如何标注部分标签避免重叠并优化优雅的写成 grob?"
date: 2023-11-05T09:07:11Z
draft: ["false"]
tags: [
  "fetched",
  "老俊俊的生信笔记"
]
categories: ["Acdemic"]
---
如何标注部分标签避免重叠并优化优雅的写成 grob? by 老俊俊的生信笔记
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-mpa-powered-by="yiban.io"><h4 data-tool="mdnice编辑器"><span></span></h4><section><mp-common-profile data-pluginname="mpprofile" data-id="MzkyMTI1MTYxNA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/G5jjcE4usey42oX5qyLTVibLRO9dz8ic5G4TpEHQc9rICYlpS4MHg6Et8cgXrQDqibvibXombicTro8t9cekJRlDBcw/0?wx_fmt=png" data-nickname="老俊俊的生信笔记" data-alias="JunJunLab" data-signature="老俊俊的生信技能和知识分享,我不是巨人,但你可以站在我的肩膀上更进一步!" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><h4 data-tool="mdnice编辑器"><span></span></h4><h2 data-tool="mdnice编辑器"><span><span>1</span></span><span>引言</span><span></span></h2><blockquote data-tool="mdnice编辑器"><p>在绘制分类数据较多的时候,不可避免的会出现大量重叠的样本名称,一个常见的情况就是绘制基因表达热图的时候基因多了,标记基因名就会重叠看不清,此外如果标记一部分基因名, <strong>如果它们靠的太近,也会出现重叠看不清的情况</strong>, <strong>一个好的解决方法是充分利用剩余的空间来将这些标签放置分配好</strong>。比较好的例子就是 <strong>ComplexHeatmap</strong> 包里的 <strong>anno_mark</strong> 函数可以指定标出部分基因。下面即示例:</p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oYYWBjsH2zmIA91lTvqehhKXlKPg0YWHQHIdeb6msyTynGHqIooSzzw/640?wx_fmt=png" data-type="png" data-w="1344" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oYYWBjsH2zmIA91lTvqehhKXlKPg0YWHQHIdeb6msyTynGHqIooSzzw/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p>那么如何去自己手动写一个自动绘制标签位置的小工具,方便可以应用在不同的场景呢?我们可以写一个 <strong>grob</strong>, 关于如何计算调整后的标签的位置, <strong>一个简单的思路就是把空白的绘图区域等份的给每个标签的位置,然后用线将原来的位置的新的位置连接起来即可</strong>。</p></blockquote><blockquote data-tool="mdnice编辑器"><p>当然你也可以使用 <strong>ComplexHeatmap</strong> 包里的方法, 该包提供了 <strong>smartAlign2</strong> 函数,来通过原始位置计算调整后的位置,下面看看示例:</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(ComplexHeatmap)<br><br>range = c(<span>0</span>, <span>10</span>)<br>pos1 = rbind(c(-<span>0.5</span>, <span>2</span>), c(<span>5</span>, <span>7</span>))<br>smartAlign2(pos1, range = range, plot = <span>TRUE</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7367491166077739" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oQf4dqcXE39gzWRdEWq4yky3VvMibeZ0Up7w7XTnFo3P62TvvenTGbWg/640?wx_fmt=png" data-type="png" data-w="566" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oQf4dqcXE39gzWRdEWq4yky3VvMibeZ0Up7w7XTnFo3P62TvvenTGbWg/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p>好了,我们可以先按自己的思路编写代码,然后加入 <strong>smartAlign2</strong> 选项就比较完美了,然后再增强一下可视化。</p></blockquote><h2 data-tool="mdnice编辑器"><span><span>2</span></span><span>参数</span><span></span></h2><p data-tool="mdnice编辑器">经过不断地 debug,测试,终于完成的差不多了,下面是一些参数:</p><pre data-tool="mdnice编辑器"><span></span><code>smartLabelAlignGrob &lt;- <span>function</span>(all.label = <span>NULL</span>,<br>                                mark.label = <span>NULL</span>,<br>                                x = <span>0.5</span>,y = <span>0.5</span>,<br>                                use.smartAlign2 = <span>FALSE</span>,<br>                                link.line.length = <span>0.025</span>,<br>                                link.label.space = <span>0.02</span>,<br>                                mark.scale = c(<span>0.01</span>,<span>0.99</span>),<br>                                link.label.gp = gpar(fontsize = <span>10</span>),<br>                                link.line.gp = gpar(fill = <span>"black"</span>,col = <span>"black"</span>),<br>                                link.circle.start.gp = gpar(fill = <span>"black"</span>,col = <span>"black"</span>),<br>                                link.circle.end.gp = gpar(fill = <span>"black"</span>,col = <span>"black"</span>),<br>                                link.start.type = c(<span>"line"</span>,<span>"circle"</span>,<span>"arrow"</span>),<br>                                link.end.type = c(<span>"line"</span>,<span>"circle"</span>,<span>"arrow"</span>),<br>                                circle.arrow.size = c(<span>0.01</span>,<span>0.01</span>),<br>                                pos = c(<span>"right"</span>,<span>"left"</span>,<span>"top"</span>,<span>"bottom"</span>),<br>                                name = <span>NULL</span>,<br>                                gp = <span>NULL</span>, vp = <span>NULL</span>){<br><br>  lst &lt;- list(all.label = all.label,<br>              mark.label = mark.label,<br>              x = x,y = y,<br>              use.smartAlign2 = use.smartAlign2,<br>              link.line.length = link.line.length,<br>              link.label.space = link.label.space,<br>              mark.scale = mark.scale,<br>              link.label.gp = link.label.gp,<br>              link.line.gp = link.line.gp,<br>              link.circle.start.gp = link.circle.start.gp,<br>              link.circle.end.gp = link.circle.end.gp,<br>              link.start.type = link.start.type,<br>              link.end.type = link.end.type,<br>              circle.arrow.size = circle.arrow.size,<br>              pos = pos,<br>              name = name, gp = gp, vp = vp,<br>              cl = <span>"smartLabelAlignGrob"</span>)<br><br>  do.call(gTree,lst)<br>}<br></code></pre><h2 data-tool="mdnice编辑器"><span><span>3</span></span><span>测试</span><span></span></h2><h3 data-tool="mdnice编辑器"><span></span><span>位置标签均匀分布</span><span></span></h3><p data-tool="mdnice编辑器">假如我们画 50 个标签,想要标出其中一些, 你需要提供 <strong>所有的标签名称</strong> 和 <strong>需要标记的标签名称</strong>:</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(grid)<br><span>library</span>(tidyverse)<br><br>data(USArrests)<br>all.label &lt;- rownames(USArrests)<br>mark.label &lt;- sample(all.label,<span>15</span>,replace = <span>F</span>)<br><br><br>pagelabel &lt;- <span>function</span>(hjust = <span>1</span>,x = <span>0.48</span>){<br>  grid.newpage()<br>  pushViewport(viewport(width = <span>0.5</span>,height = <span>0.9</span>,yscale = c(<span>0.5</span>,<span>50.5</span>)))<br>  grid.text(x = x,y = unit(<span>1</span>:<span>50</span>,<span>"native"</span>),<br>            label = all.label,<br>            hjust = hjust)<br>}<br><br>pagelabel()<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                              mark.label = mark.label))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.347507331378299" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4osce9s5XWu1UjGkPUoq2FiaTpGyWYPKbVHM6nDoXxyPy5bxzEQtBnUTw/640?wx_fmt=png" data-type="png" data-w="682" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4osce9s5XWu1UjGkPUoq2FiaTpGyWYPKbVHM6nDoXxyPy5bxzEQtBnUTw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">设置起始和终止连接的形状:</p><pre data-tool="mdnice编辑器"><span></span><code>pagelabel()<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    link.start.type = <span>"circle"</span>,<br>                    link.end.type = <span>"arrow"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.2907801418439717" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4omRkicBYtSfia0HJcg3skREfJFf0USKPVibXRfNpWUwUoC8AxRgCTJWDxQ/640?wx_fmt=png" data-type="png" data-w="705" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4omRkicBYtSfia0HJcg3skREfJFf0USKPVibXRfNpWUwUoC8AxRgCTJWDxQ/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>pagelabel()<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    link.start.type = <span>"arrow"</span>,<br>                    link.end.type = <span>"arrow"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.327459618208517" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oyUFpnXV8uCL64gdvf50xF3FA7tXCupUuVMVGAfuia2VKhyhGcErJcsQ/640?wx_fmt=png" data-type="png" data-w="681" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oyUFpnXV8uCL64gdvf50xF3FA7tXCupUuVMVGAfuia2VKhyhGcErJcsQ/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>pagelabel()<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    link.start.type = <span>"circle"</span>,<br>                    link.end.type = <span>"circle"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.3441176470588236" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oiayq0nWLe5hrPxWxia8XbjepceZsX8OStEwSJWoC7t8fv6qiaVGeKKxKg/640?wx_fmt=png" data-type="png" data-w="680" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oiayq0nWLe5hrPxWxia8XbjepceZsX8OStEwSJWoC7t8fv6qiaVGeKKxKg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">设置一些颜色,大小:</p><pre data-tool="mdnice编辑器"><span></span><code>pagelabel()<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    link.start.type = <span>"circle"</span>,<br>                    link.end.type = <span>"circle"</span>,<br>                    circle.arrow.size = c(<span>0.01</span>,<span>0.03</span>),<br>                    link.circle.end.gp = gpar(fill = rainbow(<span>15</span>)),<br>                    link.circle.start.gp = gpar(fill = rainbow(<span>15</span>)),<br>                    link.label.gp = gpar(fontface = <span>"bold.italic"</span>)))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.2851123595505618" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4o2vo3DqyMchSrFf3T1qXkNke1RVWgCvIQ9bbZdl9exoKUuiaWHYWg37Q/640?wx_fmt=png" data-type="png" data-w="712" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4o2vo3DqyMchSrFf3T1qXkNke1RVWgCvIQ9bbZdl9exoKUuiaWHYWg37Q/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h3 data-tool="mdnice编辑器"><span></span><span>smartAlign2 调用</span><span></span></h3><p data-tool="mdnice编辑器">设置 <strong>use.smartAlign2 = T</strong> 即可转换为 <strong>smartAlign2</strong> 计算的位置:</p><pre data-tool="mdnice编辑器"><span></span><code>pagelabel()<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    use.smartAlign2 = <span>T</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.3226277372262774" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4ofGuGUeTtiaq5ia7EmBoxFt85QOBYM6YZZKST3Q5C9ia8oujvYcDwYwokg/640?wx_fmt=png" data-type="png" data-w="685" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4ofGuGUeTtiaq5ia7EmBoxFt85QOBYM6YZZKST3Q5C9ia8oujvYcDwYwokg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">其它设置也可以:</p><pre data-tool="mdnice编辑器"><span></span><code>pagelabel()<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    link.start.type = <span>"circle"</span>,<br>                    link.end.type = <span>"circle"</span>,<br>                    circle.arrow.size = c(<span>0.01</span>,<span>0.03</span>),<br>                    link.circle.end.gp = gpar(fill = rainbow(<span>15</span>)),<br>                    link.label.gp = gpar(fontface = <span>"bold.italic"</span>),<br>                    use.smartAlign2 = <span>T</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.3014285714285714" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oaa0qFpqibaITFBchVqleIMqSXGuaxXxDsiauVWlVdpSMKNT5icauIfyRw/640?wx_fmt=png" data-type="png" data-w="700" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oaa0qFpqibaITFBchVqleIMqSXGuaxXxDsiauVWlVdpSMKNT5icauIfyRw/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h3 data-tool="mdnice编辑器"><span></span><span>调整方向</span><span></span></h3><p data-tool="mdnice编辑器">当然你也可以调整方向:</p><pre data-tool="mdnice编辑器"><span></span><code>pagelabel(hjust = <span>0</span>,x = <span>0.52</span>)<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    pos = <span>"left"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.3742424242424243" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oz8KS8KgOF9FFcEm7uoqPhWRKKJu5ibjwpYMTjLRtFhN0hdeMeQWoHOg/640?wx_fmt=png" data-type="png" data-w="660" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oz8KS8KgOF9FFcEm7uoqPhWRKKJu5ibjwpYMTjLRtFhN0hdeMeQWoHOg/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>pagelabel(hjust = <span>0</span>,x = <span>0.52</span>)<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    pos = <span>"left"</span>,<br>                    link.start.type = <span>"circle"</span>,<br>                    link.end.type = <span>"circle"</span>,<br>                    circle.arrow.size = c(<span>0.01</span>,<span>0.03</span>),<br>                    link.circle.end.gp = gpar(fill = rainbow(<span>15</span>)),<br>                    link.label.gp = gpar(fontface = <span>"bold.italic"</span>)))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.3357664233576643" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4o9SlLncTR5HO2ZJUckWNWdWicicc5icHaIGD0cxTIjGicMMiadgtXibDgwIMQ/640?wx_fmt=png" data-type="png" data-w="685" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4o9SlLncTR5HO2ZJUckWNWdWicicc5icHaIGD0cxTIjGicMMiadgtXibDgwIMQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">上下方向:</p><pre data-tool="mdnice编辑器"><span></span><code>pagelabel &lt;- <span>function</span>(hjust = <span>1</span>,y = <span>0.48</span>){<br>  grid.newpage()<br>  pushViewport(viewport(width = <span>0.9</span>,height = <span>0.9</span>,xscale = c(<span>0.5</span>,<span>50.5</span>)))<br>  grid.text(x = unit(<span>1</span>:<span>50</span>,<span>"native"</span>),y = y,<br>            label = all.label,<br>            hjust = hjust,<br>            rot = <span>90</span>)<br>}<br><br>pagelabel()<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    pos = <span>"top"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.40193164933135217" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oezHgecvco3ORg4zcicUjZ4W8l6bneDdJEh2vu54ubqfGzVa1ibSa0AlQ/640?wx_fmt=png" data-type="png" data-w="1346" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oezHgecvco3ORg4zcicUjZ4W8l6bneDdJEh2vu54ubqfGzVa1ibSa0AlQ/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>pagelabel()<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    pos = <span>"top"</span>,<br>                    link.start.type = <span>"circle"</span>,<br>                    link.end.type = <span>"circle"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.37845923709798057" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4ouXbIVbfxrQ6THaD7xQ7AvEwG9y982KFwzvQqGaak9ZBRKsw3ib28cLQ/640?wx_fmt=png" data-type="png" data-w="1337" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4ouXbIVbfxrQ6THaD7xQ7AvEwG9y982KFwzvQqGaak9ZBRKsw3ib28cLQ/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>pagelabel(hjust = <span>0</span>,y = <span>0.52</span>)<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    pos = <span>"bottom"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.38148984198645597" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4og86qicL3dYJH0RDD3mQkZ3CgZ95nTfObeJPmoFVLPy8eOruTNaoCDBw/640?wx_fmt=png" data-type="png" data-w="1329" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4og86qicL3dYJH0RDD3mQkZ3CgZ95nTfObeJPmoFVLPy8eOruTNaoCDBw/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>pagelabel(hjust = <span>0</span>,y = <span>0.52</span>)<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    pos = <span>"bottom"</span>,<br>                    link.start.type = <span>"circle"</span>,<br>                    link.end.type = <span>"circle"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.36473247927656366" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oqsxm7icf3TqevibTkV5LRUxFwicj3iczTspeY8xuUMJDr6HbLD4LhtUamw/640?wx_fmt=png" data-type="png" data-w="1327" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oqsxm7icf3TqevibTkV5LRUxFwicj3iczTspeY8xuUMJDr6HbLD4LhtUamw/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>pagelabel(hjust = <span>0</span>,y = <span>0.52</span>)<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    pos = <span>"bottom"</span>,<br>                    link.start.type = <span>"circle"</span>,<br>                    link.end.type = <span>"circle"</span>,<br>                    circle.arrow.size = c(<span>0.01</span>,<span>0.03</span>),<br>                    link.circle.end.gp = gpar(fill = rainbow(<span>15</span>)),<br>                    link.label.gp = gpar(fontface = <span>"bold.italic"</span>)))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.3832960477255779" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oJWnTX1dX7ic8kTyJgGmg7P1HxfVOqLWTNqRTibZV833EUbh75Xqbj3NQ/640?wx_fmt=png" data-type="png" data-w="1341" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oJWnTX1dX7ic8kTyJgGmg7P1HxfVOqLWTNqRTibZV833EUbh75Xqbj3NQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">调用 smartAlign2 :</p><pre data-tool="mdnice编辑器"><span></span><code>pagelabel(hjust = <span>0</span>,y = <span>0.52</span>)<br>grid.draw(smartLabelAlignGrob(all.label = all.label,<br>                    mark.label = mark.label,<br>                    pos = <span>"bottom"</span>,<br>                    link.start.type = <span>"circle"</span>,<br>                    link.end.type = <span>"circle"</span>,<br>                    circle.arrow.size = c(<span>0.01</span>,<span>0.025</span>),<br>                    link.circle.end.gp = gpar(fill = rainbow(<span>15</span>)),<br>                    link.label.gp = gpar(fontface = <span>"bold.italic"</span>),<br>                    use.smartAlign2 = <span>T</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.3737971872686899" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4o7OT8icD5uDegnLsicZp9dobub7QOQxT9rFhrDULicVcibLZpaa2ntc2t5w/640?wx_fmt=png" data-type="png" data-w="1351" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4o7OT8icD5uDegnLsicZp9dobub7QOQxT9rFhrDULicVcibLZpaa2ntc2t5w/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span><span>4</span></span><span>应用</span><span></span></h2><blockquote data-tool="mdnice编辑器"><p>既然是 <strong>grob</strong> 就可以应用在 <strong>ggplot</strong> 上面, 我们可以使用 <strong>annotation_custom</strong> 来插入到图里。下面举个例子, 顺便使用 <strong>ggh4x</strong> 来给热图添加聚类树, <strong>然后你需要获取聚类后所有标签的顺序才好正确的注释</strong>:</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span># ==============================================================================</span><br><span>library</span>(ggplot2)<br><span>library</span>(ggh4x)<br><br><span># get long data</span><br>scale.data &lt;- t(scale(t(USArrests)))<br>df.long &lt;- reshape2::melt(scale.data)<br><br>clusters.y &lt;- hclust(dist(USArrests), <span>"ave"</span>)<br><br><span># ==============================================================================</span><br><span># create anno grobs</span><br>all.label &lt;- rownames(USArrests)[clusters.y$order]<br>mark.label &lt;- sample(all.label,<span>15</span>,replace = <span>F</span>)<br><br>anno.grob &lt;- smartLabelAlignGrob(all.label = all.label,<br>                                 mark.label = mark.label,<br>                                 pos = <span>"right"</span>,<br>                                 link.start.type = <span>"circle"</span>,<br>                                 link.end.type = <span>"circle"</span>,<br>                                 circle.arrow.size = c(<span>0.01</span>,<span>0.025</span>),<br>                                 link.circle.end.gp = gpar(fill = rainbow(<span>15</span>)),<br>                                 link.label.gp = gpar(fontface = <span>"bold.italic"</span>))<br></code></pre><p data-tool="mdnice编辑器">然后画图,设置一下 <strong>clip = "off"</strong> 关闭剪裁选项:</p><pre data-tool="mdnice编辑器"><span></span><code>ggplot(df.long) +<br>  geom_tile(aes(x = Var2,y = Var1,fill = value)) +<br>  theme_bw() + xlab(<span>""</span>) + ylab(<span>""</span>) +<br>  scale_fill_gradient2(low = <span>"blue"</span>,mid = <span>"white"</span>,high = <span>"red"</span>,midpoint = <span>0</span>) +<br>  scale_y_dendrogram(hclust = clusters.y) +<br>  theme(legend.position = <span>"top"</span>,<br>        plot.margin = margin(r = <span>5</span>,unit = <span>"cm"</span>)) +<br>  coord_cartesian(clip = <span>"off"</span>) +<br>  annotation_custom(grob = anno.grob,<br>                    xmin = <span>1</span>,<br>                    xmax = <span>8.5</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.2230769230769232" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oK6K0ROmztOriaXXETkf8IT8d28Vas9DDiaRqBDhicZPhG2Q04G22MibBuw/640?wx_fmt=png" data-type="png" data-w="650" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oK6K0ROmztOriaXXETkf8IT8d28Vas9DDiaRqBDhicZPhG2Q04G22MibBuw/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p>可以看到注释的位置是正确的,使用 <strong>smartAlign2</strong> 看看,就不展示代码了:</p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="1.333955223880597" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4o0dcrdrwNuLF435uVjmgQjKamicMibhgmWiaXVpWNialwD08Ah5a45VNYicw/640?wx_fmt=png" data-type="png" data-w="536" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4o0dcrdrwNuLF435uVjmgQjKamicMibhgmWiaXVpWNialwD08Ah5a45VNYicw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span><span>5</span></span><span>结尾</span><span></span></h2><blockquote data-tool="mdnice编辑器"><p><strong>路漫漫其修远兮,吾将上下而求索。</strong></p></blockquote><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">欢迎加入生信交流群。加我微信我也拉你进 <strong>微信群聊</strong> <strong>老俊俊生信交流群</strong> <strong>(微信交流群需收取 20 元入群费用,一旦交费,拒不退还!(防止骗子和便于管理))</strong> 。QQ 群可免费加入, 记得进群按格式修改备注哦。</p><section data-tool="mdnice编辑器"><section><p><strong>老俊俊微信：</strong></p><figure><img data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4owOgJpJib2y4kMbuEfRpLneyHs5TR0LHH0aZbBCf7nhTs9PtFTdwqSBA/640?wx_fmt=png" data-type="png" data-w="430" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4owOgJpJib2y4kMbuEfRpLneyHs5TR0LHH0aZbBCf7nhTs9PtFTdwqSBA/640?wx_fmt=png"></figure><figure><img data-ratio="1.3668430335097002" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oJ4y7bPnjs5T5bJiaaYpE3bO3ORVib9ayiar7B0bZhfgOnSgttMiaXkzpkg/640?wx_fmt=png" data-type="png" data-w="567" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oJ4y7bPnjs5T5bJiaaYpE3bO3ORVib9ayiar7B0bZhfgOnSgttMiaXkzpkg/640?wx_fmt=png"></figure></section><section><p><strong>知识星球：</strong></p><figure><img data-ratio="1.5896226415094339" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oA9Ut1licSFWv960YoG2FpIQcaibHx6FzRhcdvYoejeISk3ic6ecPMX4uw/640?wx_fmt=jpeg" data-type="jpeg" data-w="1060" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/G5jjcE4usewIBX03nt2ueicmQzicibZYM4oA9Ut1licSFWv960YoG2FpIQcaibHx6FzRhcdvYoejeISk3ic6ecPMX4uw/640?wx_fmt=jpeg"></figure></section></section><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器"><br></p><center data-tool="mdnice编辑器"><strong> 往期回顾目录</strong></center><blockquote data-tool="mdnice编辑器"><center><strong><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247510341&amp;idx=1&amp;sn=1147931c1184c852f86ff294c1099ab0&amp;chksm=c1849334f6f31a22e0e0e238a528f4d4fd5da5e3789d394ed24ba78203912b6138fff24cd598&amp;token=431980242&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">环形热图探索</a></strong></center><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247510297&amp;idx=1&amp;sn=9232131249c4cb2cc76f835f924bd47e&amp;chksm=c1849368f6f31a7eb57b2c55cdf8a8c11a932147352414845361cba1e94afac91ce541b7ef43&amp;token=431980242&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">圈圈补充</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247510275&amp;idx=1&amp;sn=d4c77bf68fe00e941dc138ec91bdc46d&amp;chksm=c1849372f6f31a6406981ab57abae8c46d04a255b4288a93509dae26c42e4dd82a519edea531&amp;token=353264504&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">画一些圈圈</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247510256&amp;idx=1&amp;sn=65060b32f4a74337f0c6f02f775f2ef9&amp;chksm=c1849281f6f31b974683049e26c7132fd24d9e0f08aa347cbe595b7b25f6b62a0ad7bdfbc856&amp;token=61740346&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">grid 进阶: 构建自己的 grob 对象</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247510209&amp;idx=1&amp;sn=ea595989806aeaf116fab44f808d295e&amp;chksm=c18492b0f6f31ba6832f666ee1734d258dcb0ad852a2982443668f735e46e86f2a9456a1059d&amp;token=61740346&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">ChIP-seq 绘图设计&lt;&lt;续&gt;&gt;</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247510169&amp;idx=1&amp;sn=865c3e3652f75419a39df29acee16f33&amp;chksm=c18492e8f6f31bfe00a052989ee7f2ccc84df46e8e3e90bdc134a928451c9520a77532c93b31&amp;token=1624839730&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">如何获取基因的转录起始/终止位点(TSS/TES)?</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247510151&amp;idx=1&amp;sn=de70b667d6eb7f581a68fd3fc231b1fc&amp;chksm=c18492f6f6f31be05a57cb681d802fb813e36ac67f3d70fb05d26a6ea1aeee14bd17a91844e7&amp;token=1624839730&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">ChIP-seq 绘图设计</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247510122&amp;idx=1&amp;sn=f06cfbecb15ee4f133c9b3d49791743a&amp;chksm=c184921bf6f31b0d471e37ef63fdc4c7caf63df2a6598bd1f3c04d9b1505e2e103ef4f60eb66&amp;token=1598639854&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">ggChIPvis 可视化基因组富集信号</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247510122&amp;idx=1&amp;sn=f06cfbecb15ee4f133c9b3d49791743a&amp;chksm=c184921bf6f31b0d471e37ef63fdc4c7caf63df2a6598bd1f3c04d9b1505e2e103ef4f60eb66&amp;token=1598639854&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">ggChIPvis 可视化基因组富集信号</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247510110&amp;idx=1&amp;sn=5b8a12b864509d65c243b61d080350a9&amp;chksm=c184922ff6f31b3943a3681def268998388a3a930b2c384f3d8ea33ff17a437cc4513fc1b286&amp;token=819162780&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">ChIP-seq 可视化探索</a></center></strong><p><br></p></blockquote></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/i4sGex77aTWkkPYAKx661w",target="_blank" rel="noopener noreferrer">原文链接</a>
