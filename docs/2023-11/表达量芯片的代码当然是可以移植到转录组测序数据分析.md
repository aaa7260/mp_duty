---
title: "表达量芯片的代码当然是可以移植到转录组测序数据分析"
date: 2023-11-05T05:10:25Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
表达量芯片的代码当然是可以移植到转录组测序数据分析 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>前面我们分享了：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526087&amp;idx=1&amp;sn=a056f317f5c4216d6547ecf8846010ee&amp;scene=21#wechat_redirect" data-linktype="2">时间序列转录组多次差异分析以及时序分析</a>，这里面的开头是三分组的转录组测序数据，但是后面代码演示的时候是不同时间点处理的肿瘤细胞系表达量芯片数据。</p></blockquote><p data-tool="mdnice编辑器">因为代码是收费的，所以需要简单的回复一下读者的提问，就是<strong>大家感兴趣这个代码到底该如何移植到转录组测序数据分析，而且读者给出来了一个案例</strong>，就是2020的文章《Transcriptomic profiling across the nonalcoholic fatty liver disease spectrum reveals gene signatures  for steatohepatitis and fibrosis》，它对应的数据集是：GSE135251，在其页面可以看到是216 snap frozen liver biopsies, comprising 206 NAFLD cases with different fibrosis stages and 10 controls were studied.</p><p data-tool="mdnice编辑器"><strong>关心的是：non-alcoholic fatty liver disease (NAFLD) 的疾病进展，详见：https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE135251</strong></p><h3 data-tool="mdnice编辑器"><span></span>我们首先读取GSE135251的转录组测序表达量矩阵：<span></span></h3><p data-tool="mdnice编辑器">需要自行下载  https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE135251&amp;format=file 这个压缩包文件，并且解压在 GSE135251_RAW 文件夹里面：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())  <span>## 魔幻操作，一键清空~</span><br>options(stringsAsFactors = <span>F</span>)<br><br>getOption(<span>'timeout'</span>)<br>options(timeout=<span>10000</span>)<br><br><span>if</span>(<span>T</span>){<br>  <span># https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE135251</span><br>  <span>library</span>(AnnoProbe)<br>  <span>library</span>(GEOquery)  <br>  gset &lt;- getGEO(<span>"GSE135251"</span>,getGPL = <span>F</span>) <br>  gset<br>  gset[[<span>1</span>]]<br>  a=gset[[<span>1</span>]] <span>#</span><br>  phe=pData(a)<br>  <span># dat=exprs(a) #a现在是一个对象，取a这个对象通过看说明书知道要用exprs这个函数</span><br>  <span># dim(dat)#看一下dat这个矩阵的维度 </span><br>  <span># dat[1:4,1:4] #查看dat这个矩阵的1至4行和1至4列，逗号前为行，逗号后为列</span><br>  <span># boxplot(dat[,1:4],las=2)</span><br>  <span># zscore的矩阵</span><br>  <span># 发现并不需要log了，所以注释了下面的代码</span><br>  <span>#dat=log2(dat)</span><br>  pd=phe[,(ncol(phe)-<span>4</span>):ncol(phe)]<br>} <br><span>library</span>(ggplot2) <br>fs=list.files(<span>'GSE135251_RAW/'</span>, full.names = <span>T</span>)<br>fs<br><br><span>library</span>(data.table)<br>tmp = fread(fs[<span>1</span>],data.table = <span>F</span>) <br>head(tmp)<br>gid=fread(fs[<span>1</span>],data.table = <span>F</span>)[,<span>1</span>]<br>head(gid)<br><br>rawcount = do.call(cbind,<br>                   lapply(fs, <span>function</span>(x){<br>                     fread(x,data.table = <span>F</span>)[,<span>2</span>]<br>                   }))<br>rawcount[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>mat = rawcount<br>rownames(mat) = gsub(<span>'[.][0-9]*'</span>,<span>''</span>, gid)  <br><span># str_split(fs,'[/.]',simplify = T)[,2]</span><br>colnames(mat) = substring(basename(fs),<span>1</span>,<span>10</span>) <br>keep_feature &lt;- rowSums (mat &gt; <span>1</span>) &gt; <span>1</span><br>colSums(mat)/<span>1000000</span><br>table(keep_feature)<br>mat &lt;- mat[keep_feature, ] <br>ensembl_matrix=mat<br>ensembl_matrix[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>colnames(ensembl_matrix) <br><span>library</span>(AnnoProbe)<br>head(rownames(ensembl_matrix))<br>ids=annoGene(rownames(ensembl_matrix),<span>'ENSEMBL'</span>,<span>'human'</span>)<br>head(ids)<br>ids=ids[!duplicated(ids$SYMBOL),]<br>ids=ids[!duplicated(ids$ENSEMBL),]<br>symbol_matrix= ensembl_matrix[match(ids$ENSEMBL,rownames(ensembl_matrix)),]<br><br>rownames(symbol_matrix) = ids$SYMBOL<br>symbol_matrix[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br><span>#通过查看说明书知道取对象a里的临床信息用pData</span><br><span>## 挑选一些感兴趣的临床表型。</span><br><span>library</span>(stringr)  <br>phe=pd  <br><span># 这里一定要人工干预，每个数据集项目的分组不一样</span><br><span># 是主观判断，自己选择  </span><br><span>#group_list=ifelse(grepl('Healthy',phe$title),'healthy','patient')</span><br>group_list=phe$`disease:ch1` <br>save(dat,group_list,phe,symbol_matrix,file = <span>'step1-output.Rdata'</span>)<br><br><span>source</span>(<span>'step2-check.R'</span>)<br><span># control和disease分组的样品数量差异很大 </span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span>然后是7次差异分析：<span></span></h3><p data-tool="mdnice编辑器">首先可以看到：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; as.data.frame(table(phe$`group <span>in</span> paper:ch1`))<br>        Var1 Freq<br>1    control   10<br>2       NAFL   51<br>3 NASH_F0-F1   34<br>4    NASH_F2   53<br>5    NASH_F3   54<br>6    NASH_F4   14<br></code></pre><p data-tool="mdnice编辑器">分组需要结合背景知识：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; table(phe$`group <span>in</span> paper:ch1`,phe$`fibrosis stage:ch1`)<br>            <br>              0  1  2  3  4<br>  control     8  1  1  0  0<br>  NAFL       33 18  0  0  0<br>  NASH_F0-F1  5 29  0  0  0<br>  NASH_F2     0  0 53  0  0<br>  NASH_F3     0  0  0 54  0<br>  NASH_F4     0  0  0  0 14<br></code></pre><p data-tool="mdnice编辑器">"NASH" 是脂肪性肝病（Non-Alcoholic Steatohepatitis）的缩写，这是一种与酒精无关的脂肪肝炎，通常与代谢综合症、肥胖和糖尿病等相关。评分系统用于评估NASH疾病的严重程度和患者的风险。以下是四种常见的NASH评分系统：</p><ol data-tool="mdnice编辑器"><li><section><strong>NAFLD Activity Score (NAS) / NASH分数</strong>：</section></li></ol><ul><li><section>描述：NAS是一种常用于评估NASH严重程度的评分系统，它考察肝组织切片中的三个主要特征：脂肪变性（steatosis）、细胞损伤（ballooning）、和炎症（lobular inflammation）。</section></li><li><section>评分范围：通常从0到8，分数越高表示NASH的严重程度越高。</section></li><li><section>解释：NAS分数通常用于确定NASH的严重程度，分数≥5表示NASH，分数≥3表示NAFLD。</section></li></ul><li><section><strong>Fibrosis-4指数（FIB-4）</strong>：</section></li><ul><li><section>描述：FIB-4用于评估NAFLD患者的肝纤维化程度，而不是NASH本身的严重程度。它使用年龄、AST（天门冬氨酸转氨酶）和ALT（丙氨酸转氨酶）水平以及血小板计数来计算。</section></li><li><section>评分范围：通常从1到3，分数越高表示肝纤维化的风险越高。</section></li><li><section>解释：FIB-4指数通常用于筛查哪些NAFLD患者可能有肝纤维化，而不是评估NASH的严重程度。</section></li></ul><li><section>**AST to Platelet Ratio Index (APRI)**：</section></li><ul><li><section>描述：类似于FIB-4，APRI也用于评估肝纤维化程度。它使用AST和血小板计数来计算。</section></li><li><section>评分范围：通常从0到2，分数越高表示肝纤维化的风险越高。</section></li><li><section>解释：APRI指数用于估计NAFLD患者的肝纤维化风险。</section></li></ul><li><section><strong>BARD评分</strong>：</section></li><ul><li><section>描述：BARD评分是一种用于评估NASH患者的肝纤维化风险的系统。它使用BMI（体重指数）、AST/ALT比率和糖尿病状况来评分。</section></li><li><section>评分范围：通常从0到4，分数越高表示肝纤维化的风险越高。</section></li><li><section>解释：BARD评分通常用于识别那些患有NASH并且存在较高肝纤维化风险的患者。</section></li></ul><p data-tool="mdnice编辑器">前面我们获取了非常详细的样品信息，文章是进行了4+3次差异分析，如下所示：</p><p><img data-cropselx1="0" data-cropselx2="558" data-cropsely1="0" data-cropsely2="448" data-galleryid="" data-ratio="0.5083333333333333" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww6QlrkZxicyO5BoXZCqoVG767QWgibLCD84RpM5T75caFjqjOb2mjZ2gxKicRl9MrOwDjMyIBApBQMA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww6QlrkZxicyO5BoXZCqoVG767QWgibLCD84RpM5T75caFjqjOb2mjZ2gxKicRl9MrOwDjMyIBApBQMA/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>进行了4+3次差异分析</figcaption></figure><p data-tool="mdnice编辑器">这些是可以使用我们的代码进行批量差异分析的：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())  <span>## 魔幻操作，一键清空~</span><br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(clusterProfiler)<br><span>library</span>(stringr)<br><span>library</span>(limma)<br><br>run &lt;- <span>function</span>(){<br>  <br>  getwd()<br>  <span>source</span>(<span>'../functions/run_check.R'</span>)<br>  run_check(dat, group_list, target_gene=<span>'GAPDH'</span>, pro=gse_number,path=<span>'./'</span>)<br>  <br>  <span>source</span>(<span>'../functions/run_DEG_by_DESeq2.R'</span>)<br>  group_list<br>  table(group_list)<br>  deg=run_DEG(dat, symbol_matrix,group_list, pro=gse_number,path=<span>'./'</span>,<br>              target_gene=c(<span>'GAPDH'</span>))<br>  head(deg)<br>  <br>  <span>source</span>(<span>'../functions/run_ORA_KEGG.R'</span>)<br>  <span># Reading KEGG annotation online:</span><br>  run_ORA_KEGG(deg, path=<span>'./'</span>)<br>  <br>  <span>source</span>(<span>'../functions/run_ORA_GO.R'</span>)<br>  run_ORA_GO(deg, path=<span>'./'</span>)<br>  <br>  load(file = <span>'anno_DEG.Rdata'</span>)<br>  <span>source</span>(<span>'../functions/run_GSEA_KEGG.R'</span>)<br>  run_GSEA_KEGG(DEG, path=<span>'./'</span>)<br>  <br>}<br><br><br>load(file = <span>'step1-output.Rdata'</span>)<br>table(group_list)<br>table(phe$`fibrosis stage:ch1`)<br>as.data.frame(table(phe$`group in paper:ch1`))<br>table(phe$`group in paper:ch1`,phe$`fibrosis stage:ch1`)<br><br><span># 每次都要检测数据</span><br>dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>] <br>raw_dat = dat<br>raw_symbol_matrix = symbol_matrix<br>raw_gp = phe$`group in paper:ch1`<br><span>#  NAFL NASH_F0-F1    NASH_F2    NASH_F3    NASH_F4 </span><br><br><span>## 需要 写一个循环，7次差异分析</span><br><br>{<br>  pro=<span>'NASH_F4-vs-NAFL'</span><br>  dir.create(pro)<br>  setwd(pro) <br>  table(raw_gp)<br>  kp = raw_gp %<span>in</span>% c(<span>'NAFL'</span> ,<span>'NASH_F4'</span>  )<br>  table(kp)<br>  dat = raw_dat[,kp]<br>  group_list = raw_gp[kp]<br>  symbol_matrix = raw_symbol_matrix[,kp]<br>  gse_number = pro<br>  save( gse_number,<br>        dat,group_list, <br>        file = <span>'step1-output.Rdata'</span>) <br>  <span>#load(file = 'step1-output.Rdata')</span><br>  run()<br>  setwd(<span>'../'</span>)<br>  getwd()<br>}<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>关键分析应该是mfuzz或者wgcna<span></span></h3><p data-tool="mdnice编辑器">文章仅仅是根据这些样品的表达量矩阵计算了距离后进行最简单的无监督的层次聚类，然后认为的划分成为了两个亚群，但是实际上这两个亚群跟临床特征几乎是没有关联。。。。</p><p><img data-galleryid="" data-ratio="0.8037037037037037" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww6QlrkZxicyO5BoXZCqoVG7Qxiaz1av5WIWB8nvDzaoDph8icTuKBkowmCEddF9XJubbOlibHCuxKGCw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww6QlrkZxicyO5BoXZCqoVG7Qxiaz1av5WIWB8nvDzaoDph8icTuKBkowmCEddF9XJubbOlibHCuxKGCw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>两个亚群跟临床特征几乎是没有关联</figcaption></figure><p data-tool="mdnice编辑器"><span><strong>我怀疑应该是这个队列里面的最大的差异来源是取样时候的样品的细胞比例，它会最大程度影响样品本身的表达量组成，它就是无监督层次聚类的2分组的背后的决定性因素</strong></span>，而取样的时候的样品细胞比例状态是不可控的，所以它这个层次聚类代分组就没什么意义了。</p><p data-tool="mdnice编辑器">当然了，这个仅仅是我的推测啦。即使是抛开它这个无监督层次聚类的2分组不谈，它多次差异分析取交集来定位到25个基因，这样的操作也不可取，其实mfuzz或者wgcna更好，可以参考前面我们分享的代码：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526087&amp;idx=1&amp;sn=a056f317f5c4216d6547ecf8846010ee&amp;scene=21#wechat_redirect" data-linktype="2">时间序列转录组多次差异分析以及时序分析</a>，比如也是默认的9个分组的基因集：</p><p><img data-galleryid="" data-ratio="0.6148148148148148" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww6QlrkZxicyO5BoXZCqoVG712S36tFU0YTZjILO2oJsJ6ASmeM2UtxcUa60icj9sAugRZc3WZkVBMw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww6QlrkZxicyO5BoXZCqoVG712S36tFU0YTZjILO2oJsJ6ASmeM2UtxcUa60icj9sAugRZc3WZkVBMw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>默认的9个分组的基因集合</figcaption></figure><p data-tool="mdnice编辑器">肉眼可以看到9个分组的基因集里面的，其中c1是持续下降，c4和c8是持续上升啦，但是c4和c8也有细微区别。</p><p data-tool="mdnice编辑器">然后针对这9个基因集进行功能富集，<strong>因为c4和c8也有细微表达量趋势变化区别所以它们背后的功能非常类似比如都是ECM和focal adhesion但是也有差异比如ebv病毒感染。</strong></p><p><img data-galleryid="" data-ratio="0.6148148148148148" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww6QlrkZxicyO5BoXZCqoVG7TTg11ap5WusT64M5zyvx8OQiaRQYAmySZVMrb4U8pGP0ProMQwwmy9A/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww6QlrkZxicyO5BoXZCqoVG7TTg11ap5WusT64M5zyvx8OQiaRQYAmySZVMrb4U8pGP0ProMQwwmy9A/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">但是因为我不熟悉"NASH" 这个脂肪性肝病（Non-Alcoholic Steatohepatitis），所以<span><strong>没办法编造一个生物学故事啦，我虽然说可以继续wgcna分析它，但是无非是多一些图表罢了。。。。</strong></span></p><p data-tool="mdnice编辑器">参考前面我们分享的代码：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526087&amp;idx=1&amp;sn=a056f317f5c4216d6547ecf8846010ee&amp;scene=21#wechat_redirect" data-linktype="2">时间序列转录组多次差异分析以及时序分析</a>即可完成这样的图表和数据挖掘啦，超级简单！</p></section><h4 data-tool="mdnice编辑器">文末友情宣传</h4><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526014&amp;idx=1&amp;sn=44afb387fc49b89276386e5182db7bc9&amp;chksm=9b4b26c5ac3cafd35616b2fe9df7fea664e59d75e9970feb322a477beb222ac023f7daebb3dc&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买一得‍五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">时隔5年，我们的生信技能树VIP学徒继续招生啦</a><br></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247522831&amp;idx=2&amp;sn=1744efdf428465425a145ff3a982198b&amp;chksm=9b4bdab4ac3c53a28fbecbbff4f254f470b54a7a20468bb753b295b930315e1ec45bcbabc10b&amp;scene=21#wechat_redirect" textvalue="144线程640Gb内存服务器共享一年‍仍然是仅需800" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">144线程640Gb内存服务器共享一年仍然是仅需800</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">千呼万唤始出来的独享生物信息学云服务器</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"></a><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524275&amp;idx=1&amp;sn=fa592ee29f636f34387491d0fceadd8e&amp;chksm=9b4bdf08ac3c561e0881974b3817beb0a0e514dc1a8df4c34c2b6653da6fa78e09acb03c70c2&amp;scene=21#wechat_redirect" textvalue="生信技能树知识整理实习生又又又开放申请啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信技能树知识整理实习生又又又开放申请啦</a><span><strong>（不招了，谢谢）</strong></span></section></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524432&amp;idx=1&amp;sn=5b33b0c6807a9e6939c332c58fabff89&amp;chksm=9b4b20ebac3ca9fdb3d8bfaf2bef5552f64eb70e7fae557cc7197fb1a23b3e8bc31b585bf829&amp;scene=21#wechat_redirect" textvalue="生信共享办公室出租" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信共享办公室出租</a></p></li></ul><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Ae-ckcbNtEnixSKKdfl_dQ",target="_blank" rel="noopener noreferrer">原文链接</a>
