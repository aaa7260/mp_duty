---
title: "R session中软件包依赖关系网络"
date: 2023-11-16T23:39:53Z
draft: ["false"]
tags: [
  "fetched",
  "方圆之处"
]
categories: ["Acdemic"]
---
R session中软件包依赖关系网络 by 方圆之处
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>本文通过Google翻译将原始的英文博文翻译成中文，会存在文不达意的情况。</p></blockquote><p data-tool="mdnice编辑器">在R markdown文档中将<code>sessionInfo()</code>放在末尾几乎已经成为一种标准。<code>sessionInfo()</code>能够打印出加载到R session中的的包的列表。但这些包之间的依赖关系又如何呢？在这篇博文中，让我们来看看。</p><p data-tool="mdnice编辑器">让我们打开一个新的R session并仅加载ggplot2包：</p><pre data-tool="mdnice编辑器"><code><span>library</span>(ggplot2)<br></code></pre><p data-tool="mdnice编辑器">接下来我们运行<code>sessionInfo()</code>：</p><pre data-tool="mdnice编辑器"><code>x1 = sessionInfo()<br></code></pre><p data-tool="mdnice编辑器">打印<code>x1</code>：</p><pre data-tool="mdnice编辑器"><code>x1<br><span>## R version 4.3.1 (2023-06-16)</span><br><span>## Platform: x86_64-apple-darwin20 (64-bit)</span><br><span>## Running under: macOS Ventura 13.2.1</span><br><span>## </span><br><span>## Matrix products: default</span><br><span>## BLAS:   /Library/Frameworks/R.framework/Versions/4.3-x86_64/Resources/lib/libRblas.0.dylib </span><br><span>## LAPACK: /Library/Frameworks/R.framework/Versions/4.3-x86_64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0</span><br><span>## </span><br><span>## locale:</span><br><span>## [1] C/UTF-8/C/C/C/C</span><br><span>## </span><br><span>## time zone: Europe/Berlin</span><br><span>## tzcode source: internal</span><br><span>## </span><br><span>## attached base packages:</span><br><span>## [1] stats     graphics  grDevices utils     datasets  methods   base     </span><br><span>## </span><br><span>## other attached packages:</span><br><span>## [1] ggplot2_3.4.4</span><br><span>## </span><br><span>## loaded via a namespace (and not attached):</span><br><span>##  [1] utf8_1.2.3       R6_2.5.1         tidyselect_1.2.0 magrittr_2.0.3   gtable_0.3.4    </span><br><span>##  [6] glue_1.6.2       tibble_3.2.1     pkgconfig_2.0.3  generics_0.1.3   dplyr_1.1.3     </span><br><span>## [11] lifecycle_1.0.3  cli_3.6.1        fansi_1.0.5      scales_1.2.1     grid_4.3.1      </span><br><span>## [16] vctrs_0.6.4      withr_2.5.1      compiler_4.3.1   munsell_0.5.0    pillar_1.9.0    </span><br><span>## [21] colorspace_2.1-0 rlang_1.1.1</span><br></code></pre><p data-tool="mdnice编辑器">只有二十几个包被载入，看起来不是很多。</p><p data-tool="mdnice编辑器"><code>x1</code>是一个列表，其中包含直接或间接加载的包列表。这些包可以分为三组：</p><ul data-tool="mdnice编辑器"><li><section>基础包：R附带的基础包，例如 <strong>grid</strong>、<strong>methods</strong>。注意像<strong>lattice</strong>或<strong>MASS</strong>这样的包，虽然也随R一起提供，但它们是“推荐包”。</section></li><li><section>其他包：例如通过<code>library()</code>加载的包。它们将在搜索路径上可见（通过<code>search()</code>函数）。</section></li><li><section>加载包：其他包也通过“其他包”加载到R session中，但在搜索路径上不可见。</section></li></ul><pre data-tool="mdnice编辑器"><code>base_pkgs = x1$basePkgs<br>other_pkgs = sapply(x1$otherPkgs, <span>function</span>(x) x$Package)<br>loaded_pkgs = sapply(x1$loadedOnly, <span>function</span>(x) x$Package)<br></code></pre><p data-tool="mdnice编辑器">对于session中的包，我们需要知道它们的依赖关系。这里我们使用<strong>pkgndep</strong>包。所有本地安装的包都作为“包数据库”用来来查询依赖关系。</p><pre data-tool="mdnice编辑器"><code><span>library</span>(pkgndep)<br>db = reformat_db(installed.packages())<br></code></pre><p data-tool="mdnice编辑器">现在我们遍历每个“其他包”并获取其直接和间接的依赖关系。这里我们只使用“强”依赖，即依赖关系为“Depends”、“Imports”和“LinkingTo”的包。</p><pre data-tool="mdnice编辑器"><code>mat = matrix(nrow = <span>0</span>, ncol = <span>3</span>)<br><br><span>for</span>(pkg <span>in</span> other_pkgs) {<br>    mat = rbind(mat, db$package_dependencies(pkg, recursive = <span>TRUE</span>, which = <span>"strong"</span>))<br>}<br>mat = unique(mat)<br></code></pre><p data-tool="mdnice编辑器">基础包绑定到R中，因此我们删除依赖与基础包的依赖关系。我们只将包限制为“其他包”和“加载包”。</p><pre data-tool="mdnice编辑器"><code>all_pkgs = c(other_pkgs, loaded_pkgs)<br>mat = mat[mat[, <span>1</span>] %<span>in</span>% all_pkgs &amp; mat[, <span>2</span>] %<span>in</span>% all_pkgs, , drop = <span>FALSE</span>]<br>mat = mat[!mat[, <span>1</span>] %<span>in</span>% pkgndep:::BASE_PKGS | mat[, <span>2</span>] %<span>in</span>% pkgndep:::BASE_PKGS, , drop = <span>FALSE</span>]<br>head(mat)<br><span>##      package   dependency  dep_fields</span><br><span>## [1,] "ggplot2" "cli"       "Imports" </span><br><span>## [2,] "ggplot2" "glue"      "Imports" </span><br><span>## [3,] "ggplot2" "grid"      "Imports" </span><br><span>## [4,] "ggplot2" "gtable"    "Imports" </span><br><span>## [5,] "ggplot2" "lifecycle" "Imports" </span><br><span>## [6,] "ggplot2" "rlang"     "Imports"</span><br></code></pre><p data-tool="mdnice编辑器">接下来我们使用<strong>DiagrammeR</strong>包来可视化依赖关系。我们首先生成DOT代码：</p><pre data-tool="mdnice编辑器"><code>all_nodes = unique(c(mat[, <span>1</span>], mat[, <span>2</span>], other_pkgs, loaded_pkgs))<br>node_col = rep(<span>"black"</span>, length(all_nodes))<br>node_col[all_nodes %<span>in</span>% other_pkgs] = <span>"red"</span><br>node_col[all_nodes %<span>in</span>% loaded_pkgs] = <span>"blue"</span><br><br><span>library</span>(glue)<br>nodes = glue(<span>"  \"{all_nodes}\" [color=\"{node_col}\"];"</span>, collapse = <span>FALSE</span>)<br><br>dep_col = c(<span>2</span>, <span>4</span>, <span>3</span>, <span>5</span>, <span>6</span>)<br>dep_col = rgb(t(col2rgb(dep_col)), max = <span>255</span>)<br>names(dep_col) = c(<span>"Depends"</span>, <span>"Imports"</span>, <span>"LinkingTo"</span>, <span>"Suggests"</span>, <span>"Enhances"</span>)<br><br>edges = glue(<span>"  \"{mat[, 1]}\" -&gt; \"{mat[, 2]}\" [color=\"{dep_col[mat[, 3]]}\"];"</span>, collapse = <span>FALSE</span>)<br><br>dot = paste(<br>    c(<span>"digraph {"</span>,<br>      <span>"  nodesep=0.05"</span>,<br>      <span>"  rankdir=LR;"</span>, <br>      <span>"  graph [overlap = true];"</span>,<br>      <span>"  node[shape = box];"</span>,<br>      nodes,<br>      edges,<br>      <span>"}"</span>),<br>    collapse = <span>"\n"</span><br>)<br></code></pre><p data-tool="mdnice编辑器">然后我们使用<code>grViz()</code>生成依赖关系网络图。</p><pre data-tool="mdnice编辑器"><code>DiagrammeR::grViz(dot)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000755" data-ratio="0.799249530956848" data-src="https://mmbiz.qpic.cn/mmbiz_png/8yoFdJolUibdeWfczQpKPBpdsIrL0SgPnvv4JxedZd7yWhCHS01YMLZoBE8ic6WXlEzcSzrTmUIzWtN1ZWu2lDZQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1066" src="https://mmbiz.qpic.cn/mmbiz_png/8yoFdJolUibdeWfczQpKPBpdsIrL0SgPnvv4JxedZd7yWhCHS01YMLZoBE8ic6WXlEzcSzrTmUIzWtN1ZWu2lDZQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">看起来依赖关系比简单列出包要复杂。图中还有一些未连接到<strong>ggplot2</strong>的包，例如<strong>dplyr</strong>。它们由<strong>ggplot2</strong>或其上游包作为“弱依赖项”间接加载到R session中。</p><p data-tool="mdnice编辑器">我们将代码包装为将重复使用的函数。在内部，我们使用<strong>callr</strong>包在一个新的R session中调用<code>library(pkg)</code>和获取session信息。</p><pre data-tool="mdnice编辑器"><code>loaded_pkgs = <span>function</span>(pkg) {<br>    <span>for</span>(i <span>in</span> seq_along(pkg)) {<br>        <span>library</span>(pkg[i], character.only=<span>TRUE</span>)<br>    }<br>    session_info = sessionInfo()<br><br>    base_pkgs = session_info$basePkgs<br>    other_pkgs = sapply(session_info$otherPkgs, <span>function</span>(x)x$Package)<br>    loaded_pkgs = sapply(session_info$loadedOnly, <span>function</span>(x)x$Package)<br><br>    lt = list(base_pkgs = base_pkgs,<br>              other_pkgs = other_pkgs,<br>              loaded_pkgs = loaded_pkgs)<br><br>    jsonlite::toJSON(lt)<br>}<br><br>dep_in_session = <span>function</span>(pkg, db, dep_group = <span>"strong"</span>, rankdir = <span>"LR"</span>) {<br><br>    session_info = jsonlite::fromJSON(callr::r(loaded_pkgs, args = list(pkg = pkg)))<br><br>    base_pkgs = session_info$base_pkgs<br>    other_pkgs = session_info$other_pkgs<br>    loaded_pkgs = session_info$loaded_pkgs<br><br>    mat = matrix(nrow = <span>0</span>, ncol = <span>3</span>)<br><br>    <span>for</span>(pkg <span>in</span> other_pkgs) {<br>        mat = rbind(mat, db$package_dependencies(pkg, recursive = <span>TRUE</span>, which = dep_group))<br>    }<br>    mat = unique(mat)<br>    mat = mat[!mat[, <span>1</span>] %<span>in</span>% pkgndep:::BASE_PKGS | mat[, <span>2</span>] %<span>in</span>% pkgndep:::BASE_PKGS, , drop = <span>FALSE</span>]<br><br>    all_pkgs = c(other_pkgs, loaded_pkgs)<br>    mat = mat[mat[, <span>1</span>] %<span>in</span>% all_pkgs &amp; mat[, <span>2</span>] %<span>in</span>% all_pkgs, , drop = <span>FALSE</span>]<br><br>    all_nodes = unique(c(mat[, <span>1</span>], mat[, <span>2</span>], other_pkgs, loaded_pkgs))<br>    node_col = rep(<span>"black"</span>, length(all_nodes))<br>    node_col[all_nodes %<span>in</span>% other_pkgs] = <span>"red"</span><br>    node_col[all_nodes %<span>in</span>% loaded_pkgs] = <span>"blue"</span><br><br>    nodes = glue::glue(<span>"  \"{all_nodes}\" [color=\"{node_col}\"];"</span>, collapse = <span>FALSE</span>)<br><br>    dep_col = c(<span>2</span>, <span>4</span>, <span>3</span>, <span>5</span>, <span>6</span>)<br>    dep_col = rgb(t(col2rgb(dep_col)), max = <span>255</span>)<br>    names(dep_col) = c(<span>"Depends"</span>, <span>"Imports"</span>, <span>"LinkingTo"</span>, <span>"Suggests"</span>, <span>"Enhances"</span>)<br><br>    edges = glue::glue(<span>"  \"{mat[, 1]}\" -&gt; \"{mat[, 2]}\" [color=\"{dep_col[mat[, 3]]}\"];"</span>, collapse = <span>FALSE</span>)<br><br>    dot = paste(<br>        c(<span>"digraph {"</span>,<br>          <span>"  nodesep=0.05"</span>,<br>          glue::glue(<span>"  rankdir={rankdir};"</span>), <br>          <span>"  graph [overlap = true];"</span>,<br>          <span>"  node[shape = box];"</span>,<br>          nodes,<br>          edges,<br>          <span>"}"</span>),<br>        collapse = <span>"\n"</span><br>    )<br><br>    DiagrammeR::grViz(dot)<br>}<br></code></pre><p data-tool="mdnice编辑器">在前面的示例中，我们只考虑<strong>ggplot2</strong>上游的“强依赖关系”。如果我们包含所有依赖关系会怎样？</p><pre data-tool="mdnice编辑器"><code>dep_in_session(<span>"ggplot2"</span>, db = db, dep_group = <span>"all"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000756" data-ratio="0.36273701566364386" data-src="https://mmbiz.qpic.cn/mmbiz_png/8yoFdJolUibdeWfczQpKPBpdsIrL0SgPn3PIgiaz02qPSanNufMgb5OBDO0A1LChS3PXSSH7TCrENJiaVWYAphvuw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2426" src="https://mmbiz.qpic.cn/mmbiz_png/8yoFdJolUibdeWfczQpKPBpdsIrL0SgPn3PIgiaz02qPSanNufMgb5OBDO0A1LChS3PXSSH7TCrENJiaVWYAphvuw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">它变得更加复杂！特别是我们可以看到存在许多双向依赖关系，例如， <code>A &lt;-&gt; B</code>，其中A是B的强依赖项，而B是A的弱依赖项。</p><p data-tool="mdnice编辑器">接下来让我们检查一下一个Bioconductor包<strong>DESeq2</strong>。</p><p data-tool="mdnice编辑器">我们首先只考虑<strong>DESeq2</strong>上游的强依赖性。</p><pre data-tool="mdnice编辑器"><code>dep_in_session(<span>"DESeq2"</span>, db = db, dep_group = <span>"strong"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000757" data-ratio="0.7947421638018201" data-src="https://mmbiz.qpic.cn/mmbiz_png/8yoFdJolUibdeWfczQpKPBpdsIrL0SgPnaCKtptDbiauhUv6b1Nc5WSUeFibgodpx9WnicfjvGFvXcOIxkUpicLrhibg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1978" src="https://mmbiz.qpic.cn/mmbiz_png/8yoFdJolUibdeWfczQpKPBpdsIrL0SgPnaCKtptDbiauhUv6b1Nc5WSUeFibgodpx9WnicfjvGFvXcOIxkUpicLrhibg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">它已经非常复杂，但仍然有趣的是,<strong>DESeq2</strong>的依赖项可以很好地分为两组。第一组与Bioconductor包相关，其中很多直接被附加到搜索路径（红色框：在搜索路径中可见；红色链接：“Depends”关系）；第二组主要与<strong>ggplot2</strong>及其上游包相关，它们都间接加载到 R 会话中（蓝色链接：“Imports”关系）。</p><p data-tool="mdnice编辑器">如果我们包含所有依赖类型会怎样？现在我们需要将布局更改为“TB”样式（上下）。正如我们所看到的，一个简单的命令<code>library(DESeq2)</code>给你的 R session带来了一个dependency monster。</p><pre data-tool="mdnice编辑器"><code>dep_in_session(<span>"DESeq2"</span>, db = db, dep_group = <span>"all"</span>, rankdir = <span>"TB"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000758" data-ratio="1.930921052631579" data-src="https://mmbiz.qpic.cn/mmbiz_png/8yoFdJolUibdeWfczQpKPBpdsIrL0SgPnl0h7u3gmRwhdezbrCzRbbKdxqmG9qEn0rzO1siawjZdzqGOW15AvG8Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1216" src="https://mmbiz.qpic.cn/mmbiz_png/8yoFdJolUibdeWfczQpKPBpdsIrL0SgPnl0h7u3gmRwhdezbrCzRbbKdxqmG9qEn0rzO1siawjZdzqGOW15AvG8Q/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">最后，让我们检查一下如果仅载入<strong>Seurat</strong>包。</p><pre data-tool="mdnice编辑器"><code>dep_in_session(<span>"Seurat"</span>, db = db, dep_group = <span>"strong"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000759" data-ratio="1.8925619834710743" data-src="https://mmbiz.qpic.cn/mmbiz_png/8yoFdJolUibdeWfczQpKPBpdsIrL0SgPn3e2Mpk7q2EiauDO29dx337GJOBl1LMvhNBMFt83MQfTPJjv2YBaibZBg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1210" src="https://mmbiz.qpic.cn/mmbiz_png/8yoFdJolUibdeWfczQpKPBpdsIrL0SgPn3e2Mpk7q2EiauDO29dx337GJOBl1LMvhNBMFt83MQfTPJjv2YBaibZBg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">眼花缭乱！</p><p data-tool="mdnice编辑器">如果包含<strong>Seurat</strong>所有的依赖关系，你可以尝试下面的代码。我不会在本文档中执行它，因为它异常庞大和复杂。</p><pre data-tool="mdnice编辑器"><code>dep_in_session(<span>"Seurat"</span>, db = db, dep_group = <span>"all"</span>)<br></code></pre><p data-tool="mdnice编辑器">大家可以试着运行<code>dep_in_session()</code>到其他软件包上，看看你的R session是不是要爆炸了。</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/mKm97haa_L2WIeJPz8SKzA",target="_blank" rel="noopener noreferrer">原文链接</a>
