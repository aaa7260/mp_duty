---
title: "单细胞多样本整合之Scanorama"
date: 2023-11-16T13:54:33Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
单细胞多样本整合之Scanorama by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">关于单细胞多样本整合分析，我前期已介绍了很多种算法了，例如在R语言中运行CCA、RPCA、Harmony、BBKNN等算法：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484318&amp;idx=1&amp;sn=daf04a599413de0514afda07928eecb9&amp;scene=21#wechat_redirect" data-linktype="2">CCA单细胞多样本整合和插槽选择（一）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484384&amp;idx=1&amp;sn=e114a00e1594e8996bed895df64303a2&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之RPCA</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484506&amp;idx=1&amp;sn=98d7fe9265243c073a1444030fcd4a30&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之Harmony，LIGER和LISI</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247485666&amp;idx=1&amp;sn=ae0da39f47190da11c0d379c2b5bbefb&amp;scene=21#wechat_redirect" data-linktype="2">R版BBKNN整合去批次</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247515099&amp;idx=1&amp;sn=02d4a6448e3fec0ed76e2f8c85494320&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之R语言版scVI</a></section></li></ul><p data-tool="mdnice编辑器">我也有用python做过BBKNN、Harmony、scVI和scANVI：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484778&amp;idx=1&amp;sn=45f99192489b835d895bd2bd4d93e774&amp;scene=21#wechat_redirect" data-linktype="2">巧用Python加速单细胞分析</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247487358&amp;idx=1&amp;sn=a9dff19083623ef3063df6ccce9ee411&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之scVI和scANVI</a></section></li></ul><p data-tool="mdnice编辑器">本次我们再介绍一款python下的整合去批次工具Scanorama。Scanorama发表于2019年的NB，目前被引500+。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004025" data-ratio="0.44104134762633995" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXBspYyricUg7lZXliaRjEYMPwphJENDp4h2dMDld6JfZcQVG5icVCfWOVydCsdhHw9zAJe7QVPeCArQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="653" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXBspYyricUg7lZXliaRjEYMPwphJENDp4h2dMDld6JfZcQVG5icVCfWOVydCsdhHw9zAJe7QVPeCArQ/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231116204014015</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>一. 环境部署<span></span></h3><p data-tool="mdnice编辑器">与python下的其他整合方法一样，建议给Scanorama安装一个新的conda环境，<strong>以避免python包的版本冲突</strong>：</p><pre data-tool="mdnice编辑器"><span></span><code>mamba create -n scan python=3.9<br>conda activate scan<br><br>pip install anndata numpy scanpy scanorama<br></code></pre><p data-tool="mdnice编辑器">如果需要衔接<code>Jupyter notebook</code>使用的话，需要在<code>scan</code>这个环境里安装一下几个插件，然后就能在<code>Jupyter notebook</code>里选择<code>scan</code>这个环境（ps：我用的是<code>JupyterLab</code>，和<code>Jupyter notebook</code>是差不多的）：</p><pre data-tool="mdnice编辑器"><span></span><code>mamba install -y nb_conda_kernels ipykernel<br>python -m ipykernel install --user --name scan --display-name scan<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>二. 运行示例数据<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> scanpy <span>as</span> sc<br><span>import</span> numpy <span>as</span> np<br><span>import</span> scanorama<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>## 绘图参数设置</span><br>sc.settings.verbosity = <span>3</span> <span># 设置日志等级: errors (0), warnings (1), info (2), hints (3)</span><br>sc.logging.print_header()<br>sc.settings.set_figure_params(dpi=<span>80</span>, facecolor=<span>'white'</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>Step1. 读入数据<span></span></h4><p data-tool="mdnice编辑器">示例数据使用Seurat提供的ifnb外周血数据。</p><pre data-tool="mdnice编辑器"><span></span><code>adata = sc.read_h5ad( <span>"./Step1.seurat.data_for_python.h5ad"</span>)<br>adata<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>    An object of class Seurat </span><br><span>    14053 features across 13999 samples within 1 assay </span><br><span>    Active assay: RNA (14053 features, 2000 variable features)</span><br><span>     4 dimensional reductions calculated: pca, harmony, umap, tsne</span><br></code></pre><p data-tool="mdnice编辑器">ifnb外周血数据有2个分组：</p><pre data-tool="mdnice编辑器"><span></span><code>adata.obs; batch_ID="group"<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004024" data-ratio="0.3905325443786982" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXBspYyricUg7lZXliaRjEYMPsMDZuEw46b46xdicOQGnicXmVzj0f8C99LsB8auufDAF8sqPZhawxpmg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1014" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXBspYyricUg7lZXliaRjEYMPsMDZuEw46b46xdicOQGnicXmVzj0f8C99LsB8auufDAF8sqPZhawxpmg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231116210204088</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>Step2. 使用Scanorama进行整合分析<span></span></h4><p data-tool="mdnice编辑器"><strong>2.1 按照分组拆分单细胞数据为list</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># List of adata per batch</span><br>batch_cats = adata.obs[batch_ID].cat.categories.tolist()<br>adata_list = [adata[adata.obs[batch_ID] == b].copy() <span>for</span> b <span>in</span> batch_cats]<br></code></pre><p data-tool="mdnice编辑器"><strong>2.2 运行Scanorama对list对象进行整合分析</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># adatas=[adata_list[0],adata_list[1]]</span><br>scanorama.integrate_scanpy(adata_list)<br><br>adata.obsm[<span>"X_scanorama"</span>] = np.zeros((adata.shape[<span>0</span>], adata_list[<span>0</span>].obsm[<span>"X_scanorama"</span>].shape[<span>1</span>]))<br><span>for</span> i, b <span>in</span> enumerate(batch_cats):<br>    adata.obsm[<span>"X_scanorama"</span>][adata.obs[batch_ID] == b] = adata_list[i].obsm[<span>"X_scanorama"</span>]<br>adata<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>    Found 14053 genes among all datasets</span><br><span>    [[0.         0.62477092]</span><br><span>     [0.         0.        ]]</span><br><span>    Processing datasets (0, 1)</span><br><span>    AnnData object with n_obs × n_vars = 13999 × 14053</span><br><span>    obs: 'orig.ident', 'nCount_RNA', 'nFeature_RNA', 'stim', 'seurat_annotations', 'RNA_snn_res.0.5', 'seurat_clusters', 'group'</span><br><span>    var: 'name'</span><br><span>    obsm: 'X_umap.cca', 'X_umap.fastmnn', 'X_umap.harmony', 'X_umap.liger', 'X_umap.rpca', 'X_unintegrated', 'Scanorama', 'X_scanorama'</span><br><span>    layers: 'counts'</span><br></code></pre><p data-tool="mdnice编辑器"><strong>2.3 降维聚类</strong></p><pre data-tool="mdnice编辑器"><span></span><code>sc.pp.neighbors(adata, use_rep=<span>"X_scanorama"</span>)<br>sc.tl.umap(adata)<br></code></pre><p data-tool="mdnice编辑器">可视化:</p><pre data-tool="mdnice编辑器"><span></span><code>sc.settings.set_figure_params(dpi=<span>80</span>, dpi_save=<span>300</span>, figsize=(<span>5</span>,<span>5</span>))<br>sc.pl.embedding(adata,basis=<span>"umap"</span>, color=[<span>"seurat_annotations"</span>, <span>"group"</span>], <br>                frameon=<span>False</span>, title=<span>'Scanorama'</span>,<br>                legend_loc=<span>'right margin'</span>, legend_fontsize=<span>12</span>,<br>                legend_fontweight=<span>'normal'</span>, legend_fontoutline=<span>6</span>,<br>                palette=<span>None</span>, cmap=<span>None</span><br>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004023" data-ratio="0.390832328106152" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXBspYyricUg7lZXliaRjEYMPKiamUdXXtZnFIkYMWZ4iaFyoJ1VRph065SU7n8QR5PqHHPibQgQtgsXQg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="829" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXBspYyricUg7lZXliaRjEYMPKiamUdXXtZnFIkYMWZ4iaFyoJ1VRph065SU7n8QR5PqHHPibQgQtgsXQg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231116210655009</figcaption></figure><p data-tool="mdnice编辑器">尴尬的是，似乎效果没有harmony好呀......下图是harmony的：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004022" data-ratio="0.4597014925373134" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXBspYyricUg7lZXliaRjEYMPyQRUBj7VYelmoYfRJbcaZibnbwhMq63BxWryy7usSXS15ia6zibhmMn7g/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="670" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqXBspYyricUg7lZXliaRjEYMPyQRUBj7VYelmoYfRJbcaZibnbwhMq63BxWryy7usSXS15ia6zibhmMn7g/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231116210919455</figcaption></figure><p data-tool="mdnice编辑器">虽然但是，Scanorama速度挺快，内存消耗小，整合效果比较温和，值得一试！</p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/6C9NOsV58L8ZsNr0JicEjA",target="_blank" rel="noopener noreferrer">原文链接</a>
