---
title: "Msigdbr和enrichKEGG函数用的KEGG基因集是不一样的"
date: 2023-01-06T06:12:41Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
Msigdbr和enrichKEGG函数用的KEGG基因集是不一样的 by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">有老铁问我Msigdbr和enrichKEGG函数里用的KEGG基因集竟然是不一样，然后如何把enrichKEGG用的geneset提取出来。其实这个问题我很早之前就发现了，今天用实践来探索这个问题。其次，由于KEGG数据库的不稳定性，enrichKEGG函数有时会运行失败，因此健明老师在 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514395&amp;idx=1&amp;sn=97fd9130fdf5fb63a55ce23a336f8313&amp;scene=21#wechat_redirect" data-linktype="2">KEGG数据库倒闭了吗</a> 给出了一个解决方案。这里另一个解决方案是将enrichKEGG用的geneset提取出来，用的时候本地加载一下就行。</p><h3 data-tool="mdnice编辑器">一. Msigdbr数据库的KEGG通路文件下载</h3><p data-tool="mdnice编辑器">首先是获取Msigdbr数据库的KEGG基因集，一种是网站下载，另一种是R语言本地下载。</p><p data-tool="mdnice编辑器">网站在http://www.gsea-msigdb.org/gsea/msigdb/collections.jsp，除了KEGG通路，当然还有其他如GO，Hallmark和Reactome通路等等：</p><figure data-tool="mdnice编辑器"><img data-ratio="1.0835543766578248" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1agiaYTWwxODaGC4MOLXbxtFwdgXNFprBeMSBzCrwiaz5mXDL6CucLPaA/640?wx_fmt=other" data-type="other" data-w="754" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1agiaYTWwxODaGC4MOLXbxtFwdgXNFprBeMSBzCrwiaz5mXDL6CucLPaA/640?wx_fmt=other"><figcaption>image-20230105221338813</figcaption></figure><p data-tool="mdnice编辑器">这里包括Gene symbols和Entrez ID两种格式的文件。如果不知道这两种格式的区别，可以参阅 <a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483932&amp;idx=1&amp;sn=1e2fe2f459032ad440d28817c238e670&amp;scene=21#wechat_redirect" data-linktype="2">关于基因ID转换，一文就够了</a></p><p data-tool="mdnice编辑器">用代码也可以下载Msigdbr数据库：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 加载R包</span><br><span>library</span>(msigdbr)<br><span>library</span>(dplyr)<br><br><span>#查看msigdbr包里自带的物种</span><br>msigdbr_show_species()<br><br><span># 下载KEGG</span><br>kegg.df &lt;- msigdbr(species = <span>"Homo sapiens"</span>, <span># 物种拉丁名</span><br>             category = <span>"C2"</span>,<br>             subcategory = <span>"CP:KEGG"</span>) <br>             #subcategory = <span>"CP:KEGG"</span>) <br>kegg.df<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.3488372093023256" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1laVmz4Kwy6qqLXFsDo4axHia0iaORnQ4oIDFoiamVoiabVHIqeBic401HJA/640?wx_fmt=other" data-type="other" data-w="989" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1laVmz4Kwy6qqLXFsDo4axHia0iaORnQ4oIDFoiamVoiabVHIqeBic401HJA/640?wx_fmt=other"><figcaption>image-20230105223420826</figcaption></figure><p data-tool="mdnice编辑器">下载下来的是一个data.frame，要做富集分析的话需要进行进一步的整理：</p><pre data-tool="mdnice编辑器"><span></span><code>kegg.list &lt;- select(kegg.df, gs_name, gene_symbol) %&gt;% <br>  as.data.frame %&gt;% <br>  split(., .$gs_name) %&gt;% <br>  lapply(., <span>function</span>(x)(x$gene_symbol))<br>str(kegg.list)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.2298076923076923" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1lSFvtLOBjz3nsWh68pClEMDAM7f80Xjd22bLOofMIHqdkDFwM1oQ9w/640?wx_fmt=other" data-type="other" data-w="1040" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1lSFvtLOBjz3nsWh68pClEMDAM7f80Xjd22bLOofMIHqdkDFwM1oQ9w/640?wx_fmt=other"><figcaption>image-20230105222917957</figcaption></figure><p data-tool="mdnice编辑器">这里可以直接保存为Rdata，也可以保存为gmt格式。保存为gmt格式麻烦一点，需要自己理解gmt格式写一个函数，这里我已经写好了：<a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484879&amp;idx=1&amp;sn=ccca3e26ced4a35e0bd4c5297c36f020&amp;scene=21#wechat_redirect" data-linktype="2">处理gmt文件的一些技巧</a></p><pre data-tool="mdnice编辑器"><span></span><code><span># 保存到文件，方便以后重复使用</span><br>save(gs, file = <span>"msigdbr.KEGG.gs.RData"</span>)<br><br><span># 或者保存为gmt格式</span><br><span># 自编函数</span><br>write.list2gmt &lt;- <span>function</span>(list,file){<br>  sink(file)<br>  lapply(names(list), <span>function</span>(i){<br>    cat( paste(c(i,<span>'tmp'</span>,list[[i]]),collapse=<span>'\t'</span>) )<br>    cat(<span>'\n'</span>)<br>  })<br>  sink()<br>}<br><br><span>#从list文件输出为gmt文件</span><br>write.list2gmt(kegg.list,file = <span>"./msigdbr.KEGG.symbols.gmt"</span>)<br></code></pre><p data-tool="mdnice编辑器">保存下来的gmt文件可以用Excel打开：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6167315175097277" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu157j9BsILgnjl0uqBU4DzlKg7axnflkibgOF4r6FjtHQFGFsiaPtZic3cw/640?wx_fmt=other" data-type="other" data-w="1542" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu157j9BsILgnjl0uqBU4DzlKg7axnflkibgOF4r6FjtHQFGFsiaPtZic3cw/640?wx_fmt=other"><figcaption>image-20230105223103154</figcaption></figure><p data-tool="mdnice编辑器"><strong>当然，如果你有强迫症，不喜欢第二列是“tmp”，希望用KEGG ID填充，input的数据格式和自编函数都需要进行变化。</strong></p><p data-tool="mdnice编辑器">首先是对kegg.df和kegg.list进行加工处理：</p><pre data-tool="mdnice编辑器"><span></span><code>set_info = kegg.df[!duplicated(kegg.df$gs_name),] %&gt;% <br>  select(gs_name,gs_cat,<br>         gs_subcat,gs_exact_source,<br>         gs_url)<br><br>kegg.gs =  list(gs = kegg.list,<br>                set_info = set_info)<br></code></pre><p data-tool="mdnice编辑器">然后改造一下write.list2gmt函数为write.gs2gmt：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#改造一下write.list2gmt函数为write.gs2gmt</span><br>write.gs2gmt &lt;- <span>function</span>(gs,note,file){<br>  sink(file)<br>  list = gs$gs<br>  set_info = gs$set_info<br>  lapply(names(list), <span>function</span>(i){<br>    cat( paste(c(i,set_info[,note][row.names(set_info) == i],<br>                 list[[i]]),collapse=<span>'\t'</span>) )<br>    cat(<span>'\n'</span>)<br>  })<br>  sink()<br>}<br><br><span>#运行</span><br>write.gs2gmt(kegg.gs,note = <span>"gs_exact_source"</span>,<br>             file = <span>"./msigdbr.KEGG.symbols_V2.gmt"</span>)<br></code></pre><p data-tool="mdnice编辑器">Excel打开看一下成功了：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.3992560446373218" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1Wp6J6uLS2kwTxBXakiaFcK4uGHJXtx3QQ3tqNL0uibASIH1QkNiaRcbuQ/640?wx_fmt=other" data-type="other" data-w="1613" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1Wp6J6uLS2kwTxBXakiaFcK4uGHJXtx3QQ3tqNL0uibASIH1QkNiaRcbuQ/640?wx_fmt=other"><figcaption>image-20230105225057452</figcaption></figure><h3 data-tool="mdnice编辑器">二. enrichKEGG函数采用的KEGG基因集</h3><p data-tool="mdnice编辑器">然后是下载enrichKEGG函数所用的KEGG基因集，这里使用Y叔的clusterProfiler内置函数下载：</p><pre data-tool="mdnice编辑器"><span></span><code>hsa_kegg &lt;- clusterProfiler::download_KEGG(<span>"hsa"</span>)<br></code></pre><p data-tool="mdnice编辑器">然而下载失败了：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.14243614931237722" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1GGCApjT2CGIiaFQoKkCHtbE6TezCcchTrVZF1MG75hpjQB4FM6m8ouQ/640?wx_fmt=other" data-type="other" data-w="1018" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1GGCApjT2CGIiaFQoKkCHtbE6TezCcchTrVZF1MG75hpjQB4FM6m8ouQ/640?wx_fmt=other"><figcaption>image-20230105225416096</figcaption></figure><p data-tool="mdnice编辑器">用健明老师在 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514395&amp;idx=1&amp;sn=97fd9130fdf5fb63a55ce23a336f8313&amp;scene=21#wechat_redirect" data-linktype="2">KEGG数据库倒闭了吗</a> 给出的解决方案：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#install.packages('R.utils')</span><br>R.utils::setOption( <span>"clusterProfiler.download.method"</span>,<span>'auto'</span>)<br>hsa_kegg &lt;- clusterProfiler::download_KEGG(<span>"hsa"</span>)<br>str(hsa_kegg)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.29069767441860467" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1WwKep4Ln91paaMTE700Cu2QoBseDwk1pna3hVa1Lg0ia9qzd0Ia5Svw/640?wx_fmt=other" data-type="other" data-w="774" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1WwKep4Ln91paaMTE700Cu2QoBseDwk1pna3hVa1Lg0ia9qzd0Ia5Svw/640?wx_fmt=other"><figcaption>image-20230105225638699</figcaption></figure><p data-tool="mdnice编辑器">这是一个list结构，一个是KEGG的通路编号和基因编号的关系，另一个是KEGG通路编号和名字的关系，需要进一步的处理：</p><pre data-tool="mdnice编辑器"><span></span><code>PATH2ID &lt;- hsa_kegg$KEGGPATHID2EXTID<br>PATH2NAME &lt;- hsa_kegg$KEGGPATHID2NAME<br>PATH_ID_NAME &lt;- merge(PATH2ID, PATH2NAME, by=<span>"from"</span>)<br>colnames(PATH_ID_NAME) &lt;- c(<span>"KEGGID"</span>, <span>"entrezgene_id"</span>, <span>"DESCRPTION"</span>)<br>head(PATH_ID_NAME)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.2763385146804836" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu15OrWSyHWvFIGqHKUmzem27r0v8hJslxYWFicibCwia0NGSRsROqUiay5CA/640?wx_fmt=other" data-type="other" data-w="579" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu15OrWSyHWvFIGqHKUmzem27r0v8hJslxYWFicibCwia0NGSRsROqUiay5CA/640?wx_fmt=other"><figcaption>image-20230105230552745</figcaption></figure><p data-tool="mdnice编辑器">给的是ENTREID，这里又涉及到一个基础知识基因ID转换，可以参考 <a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483932&amp;idx=1&amp;sn=1e2fe2f459032ad440d28817c238e670&amp;scene=21#wechat_redirect" data-linktype="2">关于基因ID转换，一文就够了</a>，用org.Hs.eg.db包简单一些，但是因为这个包比较老，会丢失一些基因，更严谨一点的话可以用biomaRt包：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 后台回复GEO 可获取biomaRt_ensembl_annotation.Rdata</span><br><span>library</span>(clusterProfiler)<br><span>library</span>(biomaRt)<br>load(file = <span>"./biomaRt_ensembl_annotation.Rdata"</span>)<br><br>gene.df &lt;- bitr(PATH_ID_NAME$entrezgene_id, <br>                fromType = <span>"entrezgene_id"</span>,<br>                toType = c(<span>"hgnc_symbol"</span>),<br>                OrgDb = human)<br>head(gene.df)<br><span># entrezgene_id hgnc_symbol</span><br><span># 1            10        NAT2</span><br><span># 2           100         ADA</span><br><span># 3         10000        AKT3</span><br><span># 4     100008587   RNA5-8SN5</span><br><span># 5         10005       ACOT8</span><br><span># 6         10007      GNPDA1</span><br><br><span>#合并</span><br>PATH_ID_NAME2 = merge(PATH_ID_NAME,gene.df)<br><span># entrezgene_id   KEGGID                            DESCRPTION hgnc_symbol</span><br><span># 1            10 hsa00232                   Caffeine metabolism        NAT2</span><br><span># 2            10 hsa00983       Drug metabolism - other enzymes        NAT2</span><br><span># 3            10 hsa01100                    Metabolic pathways        NAT2</span><br><span># 4            10 hsa05204 Chemical carcinogenesis - DNA adducts        NAT2</span><br><span># 5           100 hsa01232                 Nucleotide metabolism         ADA</span><br><span># 6           100 hsa05340              Primary immunodeficiency         ADA</span><br></code></pre><p data-tool="mdnice编辑器">然后处理一下输出为gmt格式：</p><pre data-tool="mdnice编辑器"><span></span><code><span># Step1.首先是gene list</span><br>kegg.list.new = split(PATH_ID_NAME2$hgnc_symbol,PATH_ID_NAME2$DESCRPTION) %&gt;% <br>lapply(., <span>function</span>(x){g=unique(x);g[g!=""]})<br>str(kegg.list.new)<br>length(kegg.list.new)<br><span>#352</span><br><br><span># Step2.然后是gene list ID</span><br>set_info.new = PATH_ID_NAME2[!duplicated(PATH_ID_NAME2$DESCRPTION),] %&gt;% <br>  select(DESCRPTION,KEGGID) %&gt;% as.data.frame()<br>row.names(set_info.new) = set_info.new$DESCRPTION<br>head(set_info.new)<br><span>#                                                                DESCRPTION   KEGGID</span><br><span># Caffeine metabolism                                     Caffeine metabolism hsa00232</span><br><span># Drug metabolism - other enzymes             Drug metabolism - other enzymes hsa00983</span><br><span># Metabolic pathways                                       Metabolic pathways hsa01100</span><br><span># Chemical carcinogenesis - DNA adducts Chemical carcinogenesis - DNA adducts hsa05204</span><br><span># Nucleotide metabolism                                 Nucleotide metabolism hsa01232</span><br><span># Primary immunodeficiency                           Primary immunodeficiency hsa05340</span><br><br><span>#Step3.组合起来</span><br>kegg.gs.new =  list(gs = kegg.list.new,<br>                set_info = set_info.new)<br><br><span>#输出为gmt格式</span><br>write.gs2gmt(kegg.gs.new ,note = <span>"KEGGID"</span>,<br>             file = <span>"./KEGG.database.symbols.gmt"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5068382944489139" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1XiaK7ibmPbNmFtWXLos28NKMia3uu5ojzcqqMwDsdsP80LNQKtKEngSsA/640?wx_fmt=other" data-type="other" data-w="1243" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqVAWk5rUPe8rEuG2cLHBxu1XiaK7ibmPbNmFtWXLos28NKMia3uu5ojzcqqMwDsdsP80LNQKtKEngSsA/640?wx_fmt=other"><figcaption>image-20230105231658696</figcaption></figure><p data-tool="mdnice编辑器">首先，enrichKEGG函数用的是KEGG官方数据库提供的最新版的基因集，这里可以看到一共有352个基因集，而Msigdbr数据库的其实比较老，仅包含了186条terms。因此是推荐大家用KEGG官方数据库提供的最新版的基因集。</p><p data-tool="mdnice编辑器">所有生成的gmt文件已上传到百度网盘，后台回复: GEO 即可获取。</p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/0UiA9iOY3NZponZQHhKIVA",target="_blank" rel="noopener noreferrer">原文链接</a>
