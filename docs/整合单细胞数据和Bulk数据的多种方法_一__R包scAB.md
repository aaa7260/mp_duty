---
title: "整合单细胞数据和Bulk数据的多种方法（一）：R包scAB"
date: 2023-01-27T02:09:22Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
整合单细胞数据和Bulk数据的多种方法（一）：R包scAB by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">最近刷到NAR最新的一篇算法文章《scAB detects multiresolution cell states with clinical significance by integrating single-cell genomics and bulk sequencing data》，DOI10.1093/nar/gkac1109。<strong>通过整合单细胞基因组学（包括scRNA-seq和sc-ATAC-seq数据）和Bulk RNA 测序数据及表型信息，在这里作者提出了一种称为 scAB 的新算法。</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="0.5483415666901905" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los8qaN7VJ0O9GunlavFmX4PX6hch7MsRnneGWL3eIonj8RNVumUicxjlx9NhUT511OPN1gFH0uT8VyA/640?wx_fmt=other" data-type="other" data-w="1417" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los8qaN7VJ0O9GunlavFmX4PX6hch7MsRnneGWL3eIonj8RNVumUicxjlx9NhUT511OPN1gFH0uT8VyA/640?wx_fmt=other"><figcaption>image-20230125113311867</figcaption></figure><p data-tool="mdnice编辑器">值得一提的是，这篇文章的通讯作者Jin，也是R包CellChat的第一作者。前面我已多次分享了CellChat的经验帖：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247505973&amp;idx=1&amp;sn=2af24cf413aa52d9ab3ec4999be267fa&amp;scene=21#wechat_redirect" data-linktype="2">CellChat细胞通讯分析（一）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247485750&amp;idx=1&amp;sn=16158c79b809bcf8ace0c7d560f059fb&amp;scene=21#wechat_redirect" data-linktype="2">CellChat细胞通讯分析（二）可视化篇</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247485612&amp;idx=1&amp;sn=bc4e53b8905c5d61efc5a7057d422856&amp;scene=21#wechat_redirect" data-linktype="2">CellChat细胞通讯分析（三）多组别比较分析</a></section></li></ul><p data-tool="mdnice编辑器">实际上，随着单细胞测序技术的蓬勃发展，目前已经提出了层出不穷的方法用于衔接单细胞数据和Bulk测序数据，例如Scissor， scPrognosis 和DEGAS 等工具。其他工具我们后面再做介绍。<strong>本文将介绍：</strong></p><ul data-tool="mdnice编辑器"><li><section>scAB算法的工作流程；</section></li><li><section>使用R实现方法（github: https://github.com/jinworks/scAB）。</section></li></ul><h3 data-tool="mdnice编辑器">一. scAB算法的工作流程</h3><figure data-tool="mdnice编辑器"><img data-ratio="0.9797297297297297" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los8qaN7VJ0O9GunlavFmX4PXAqoBZEjBoYGx0PJ0uskVnTh02e7z3fiaBNoYY5qaebEX3qlT43VgbiaQ/640?wx_fmt=other" data-type="other" data-w="740" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los8qaN7VJ0O9GunlavFmX4PXAqoBZEjBoYGx0PJ0uskVnTh02e7z3fiaBNoYY5qaebEX3qlT43VgbiaQ/640?wx_fmt=other"><figcaption>image-20230125114158312</figcaption></figure><p data-tool="mdnice编辑器">具体的算法作者在method部分写的很清楚，但是我不是学数学的，这部分对我来说确实有点晦涩难懂。简单来说的话，</p><p data-tool="mdnice编辑器">（A）输入数据为</p><ul data-tool="mdnice编辑器"><li><section>单细胞数据，可以是scATAC-seq或者scRNA-seq数据；</section></li><li><section>其次是对应组织的Bulk RNA-seq数据，以及表型数据。</section></li></ul><p data-tool="mdnice编辑器">（B）然后，scAB基于单细胞和Bulk RNA-seq数据计算单个细胞和Bulk样本之间的成对的 Pearson 相关性，生成<strong>相似性矩阵</strong>。通过对单个细胞和bulk数据的每个样本之间的<strong>相似性矩阵</strong>进行知识和图形引导的矩阵分解，揭示了一组细胞分层模式。每个模式通常对应于与特定表型相关的已知生物过程/信号，是从模型输出的细胞加载矩阵的每一行中获得的。加载值（即权重）表示每个细胞在每个模式中的贡献，具有高加载值的细胞被定义为表型相关细胞。</p><p data-tool="mdnice编辑器">（C）scAB 能够从推断的细胞加载矩阵 H 中同时检测<strong>粗粒和细粒表型相关细胞状态</strong>。每个细粒细胞状态由每个学习模式中的表型相关细胞组成，粗粒表型相关细胞状态由所有细粒细胞状态的表型相关细胞的联合定义。不同的细粒细胞亚群可能与某些共有和特定的肿瘤标志物相关。</p><p data-tool="mdnice编辑器">（D） 使用Bulk RNA-seq 数据集评估识别的表型相关细胞状态和特征的临床意义，揭示了临床相关的基因特征，这些特征能够进行各种预后分析，例如<strong>生存分析、免疫疗法疗效预测和协同治疗预测</strong>。</p><h3 data-tool="mdnice编辑器">二. scAB的代码实现</h3><p data-tool="mdnice编辑器">scAB R包github在 https://github.com/jinworks/scAB.</p><p data-tool="mdnice编辑器"><strong>安装：</strong></p><pre data-tool="mdnice编辑器"><span></span><code>devtools::install_github(<span>"jinworks/scAB"</span>)<br></code></pre><p data-tool="mdnice编辑器"><strong>Installation of other dependencies if not automatically installed</strong></p><ul data-tool="mdnice编辑器"><li><section>Install Seurat using <code>install.packages('Seurat')</code>.</section></li><li><section>Install diptest using <code>install.packages('diptest')</code>.</section></li><li><section>Install multimode using <code>install.packages('multimode')</code>.</section></li><li><section>Install preprocessCore using <code>if (!require("BiocManager", quietly = TRUE)) install.packages("BiocManager"); BiocManager::install("preprocessCore")</code>.</section></li></ul><h4 data-tool="mdnice编辑器">Step1. R包加载：</h4><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(Seurat)<br><span>library</span>(preprocessCore)<br><span>library</span>(scAB)<br></code></pre><h4 data-tool="mdnice编辑器">Step2. 加载数据</h4><p data-tool="mdnice编辑器">如上所述，该算法需要三种类型的数据输入:</p><ul data-tool="mdnice编辑器"><li><section>单细胞RNA-seq数据是Seurat对象，</section></li><li><section>Bulk RNA-seq表达矩阵，</section></li><li><section>表型数据可以是一个有两列的矩阵，时间和状态，也可以是一个向量。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>data("data_survival")<br>dim(sc_dataset)<br>sc_dataset<br># An object of class Seurat <br># 21287 features across 8853 samples within 1 assay <br># Active assay: RNA (21287 features, 0 variable features)<br><br>head(bulk_dataset[,1:10])<br>head(phenotype)<br>#                 time status<br># TCGA-2Y-A9GS-01  724      1<br># TCGA-2Y-A9GT-01 1624      1<br># TCGA-2Y-A9GU-01 1939      0<br># TCGA-2Y-A9GV-01 2532      1<br># TCGA-2Y-A9GW-01 1271      1<br># TCGA-2Y-A9GX-01 2442      0<br>#样本名称需保持一致<br>colnames(bulk_dataset) == row.names(phenotype)<br></code></pre><p data-tool="mdnice编辑器"><strong>这里的表型数据是“生存与否”。</strong></p><h4 data-tool="mdnice编辑器">Step3. 处理单细胞数据</h4><p data-tool="mdnice编辑器">示例的单细胞数据sc_dataset是Seurat对象，可以看到并没有进行过降维聚类等处理。</p><p data-tool="mdnice编辑器">作者提供了一个run_seurat函数，进行常规处理：</p><pre data-tool="mdnice编辑器"><span></span><code>sc_dataset &lt;- run_seurat(sc_dataset,verbose = <span>FALSE</span>)<br>sc_dataset<br>An object of class Seurat <br><span># 21287 features across 8853 samples within 1 assay </span><br><span># Active assay: RNA (21287 features, 3000 variable features)</span><br><span>#  2 dimensional reductions calculated: pca, umap</span><br><br>UMAP_celltype &lt;- DimPlot(sc_dataset, reduction =<span>"umap"</span>,<br>                         group.by=<span>"celltype"</span>,label = <span>T</span>)<br>UMAP_celltype<br></code></pre><img data-ratio="0.7714285714285715" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los8qaN7VJ0O9GunlavFmX4PXgcjtPdJqKwZbpSyp60z2RVAxZia0gh43Fowv4JtO8EVWQQnMH2WOibcg/640?wx_fmt=other" data-type="other" data-w="735" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los8qaN7VJ0O9GunlavFmX4PXgcjtPdJqKwZbpSyp60z2RVAxZia0gh43Fowv4JtO8EVWQQnMH2WOibcg/640?wx_fmt=other"><p data-tool="mdnice编辑器">run_seurat本质上就是把标准化、高变基因特征选择、归一化、PCA、降维聚类等基本流程打包为一个函数，最后用预先注释好的信息进行可视化。</p><h4 data-tool="mdnice编辑器">Step4. 创建scAB对象</h4><p data-tool="mdnice编辑器">使用“create_scAB”函数计算样本细胞相似度矩阵和样本表型得分。</p><pre data-tool="mdnice编辑器"><span></span><code>scAB_data &lt;- create_scAB(sc_dataset,bulk_dataset,phenotype)<br></code></pre><h4 data-tool="mdnice编辑器">Step5. 选择K值</h4><p data-tool="mdnice编辑器">函数'select_K'可以帮助选择k。当重构误差下降趋势减缓时，k是一个合适的值。</p><pre data-tool="mdnice编辑器"><span></span><code>K &lt;- select_K(scAB_data)<br>K<br># [1] 4<br></code></pre><p data-tool="mdnice编辑器">Step5和Step6的运行速度比较慢。</p><h4 data-tool="mdnice编辑器">Step6. 运行scAB模型</h4><p data-tool="mdnice编辑器">使用默认参数运行scAB模型。正则化参数α1和α2也可以通过'select_alpha'函数进行交叉验证。</p><pre data-tool="mdnice编辑器"><span></span><code>scAB_result &lt;- scAB(Object=scAB_data, K=K)<br>sc_dataset &lt;- findSubset(sc_dataset, <br>                         scAB_Object = scAB_result, <br>                         tred = 2)<br>table(sc_dataset$scAB_select)<br># Other cells scAB+ cells <br># 7938         915<br></code></pre><p data-tool="mdnice编辑器">识别到915个scAB+细胞。</p><h4 data-tool="mdnice编辑器">Step7. 可视化与表型相关的细胞</h4><pre data-tool="mdnice编辑器"><span></span><code>UMAP_scAB &lt;- DimPlot(sc_dataset,group.by=<span>"scAB_select"</span>,<br>                     cols=c(<span>"#80b1d3"</span>,<span>"red"</span>),<br>                     pt.size=<span>0.001</span>,<br>                     order=c(<span>"scAB+ cells"</span>,<span>"Other cells"</span>))<br>patchwork::wrap_plots(plots = list(UMAP_celltype,UMAP_scAB), ncol = <span>2</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.3941717791411043" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los8qaN7VJ0O9GunlavFmX4PX46vSMIXDF6NQ2FOPlMDkKicGevW5Ebib1WwguiaORNKDwXbaCriboMN8dA/640?wx_fmt=other" data-type="other" data-w="1304" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los8qaN7VJ0O9GunlavFmX4PX46vSMIXDF6NQ2FOPlMDkKicGevW5Ebib1WwguiaORNKDwXbaCriboMN8dA/640?wx_fmt=other"><figcaption>image-20230125152609569</figcaption></figure><p data-tool="mdnice编辑器">除了识别到scAB+细胞以外，scAB还利用findSubset函数对所有的scAB+细胞进行亚群细分。</p><pre data-tool="mdnice编辑器"><span></span><code>UMAP_subset3 &lt;- DimPlot(sc_dataset,group.by=<span>"scAB_Subset3"</span>,<br>                        cols=c(<span>"#80b1d3"</span>,<span>"red"</span>),<br>                        pt.size=<span>0.001</span>,<br>                        order=c(<span>"scAB+ cells"</span>,<span>"Other cells"</span>))<br>UMAP_subset5 &lt;- DimPlot(sc_dataset,<br>                        group.by=<span>"scAB_Subset4"</span>,<br>                        cols=c(<span>"#80b1d3"</span>,<span>"red"</span>),<br>                        pt.size=<span>0.001</span>,<br>                        order=c(<span>"scAB+ cells"</span>,<span>"Other cells"</span>))<br>UMAP_subset &lt;- patchwork::wrap_plots(plots = list(UMAP_subset3,<br>                                                  UMAP_subset5), <br>                                     ncol = <span>2</span>)<br>UMAP_subset<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.3961685823754789" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los8qaN7VJ0O9GunlavFmX4PXAicicJV6oFeLjNWicndp3z3eBUoiaU6OWMkGuB1kEDONictVjuRtJicKJGzA/640?wx_fmt=other" data-type="other" data-w="1305" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los8qaN7VJ0O9GunlavFmX4PXAicicJV6oFeLjNWicndp3z3eBUoiaU6OWMkGuB1kEDONictVjuRtJicKJGzA/640?wx_fmt=other"><figcaption>image-20230125155420595</figcaption></figure><p data-tool="mdnice编辑器">作者使用logfc.threshold = 1和p_val_adj &lt; 0.05作为截断点来识别差异表达最多的特征基因，这有助于选择潜在的生物标志物。截止值可能取决于特定的数据集，用户可以调整该参数值。较低的截断值导致更多的候选特征基因：</p><pre data-tool="mdnice编辑器"><span></span><code>markers &lt;- FindMarkers(sc_dataset, ident.1 = <span>"scAB+ cells"</span>, <br>                       group.by = <span>'scAB_select'</span>, <br>                       logfc.threshold = <span>1</span>)<br>markers &lt;- markers[which(markers$p_val_adj&lt;<span>0.05</span>),]<br>head(markers)<br><span>#         p_val avg_log2FC pct.1 pct.2 p_val_adj</span><br><span># CFHR1     0   1.860090 0.314 0.014         0</span><br><span># APOB      0   1.385898 0.439 0.045         0</span><br><span># CPS1      0   1.182203 0.306 0.016         0</span><br><span># TF        0   3.084592 0.487 0.044         0</span><br><span># AHSG      0   3.219864 0.405 0.046         0</span><br><span># KNG1      0   2.078271 0.374 0.030         0</span><br></code></pre><p data-tool="mdnice编辑器">总体来说，这个R包还是很不错的。一个小问题是，因为这个算法依赖NMF非负矩阵和相关系数矩阵，导致运行速度比较慢，测试数据只有8000多个细胞，但运行整个流程需要花好数个小时，因此如果有python版本的话，会不会更适合当前的大样本单细胞数据？</p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/2cLFOgaOecDrDypmv7mBpA",target="_blank" rel="noopener noreferrer">原文链接</a>
