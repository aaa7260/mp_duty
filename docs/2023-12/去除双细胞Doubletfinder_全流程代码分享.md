---
title: "去除双细胞Doubletfinder-全流程代码分享"
date: 2023-12-11T12:13:30Z
draft: ["false"]
tags: [
  "fetched",
  "生信小博士"
]
categories: ["Acdemic"]
---
去除双细胞Doubletfinder-全流程代码分享 by 生信小博士
------
<div><p><strong><span><strong><span>大家好</span></strong></span></strong><strong><span><strong><span>，在单细胞RNA测序实验中，双细胞（Doublet）的存在会影响数据质量和结果的准确性。双细胞是指两个或更多个细胞在被溶解并用于测序之前被误认为是一个单一的细胞。由于双细胞含有两种或更多种不同细胞类型的RNA，因此会导致基因表达分析的偏差，从而产生虚假的细胞亚群或混淆不同类型细胞之间的差异。</span></strong></span></strong></p><hr><p>DoubletFinder是一个R包，旨在识别和过滤出双细胞，以保证单细胞RNA测序数据的准确性和可靠性。该软件包使用两种方法来检测双细胞：（1）单细胞表达谱聚类；（2）特定基因对的共表达。使用这些方法，DoubletFinder可以快速、高效地筛选出单细胞测序数据中的双细胞，从而减少误差和提高数据质量。<img data-imgfileid="100001189" data-ratio="0.20555555555555555" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skt1CWIxHrn6ZZEbtVFziasBsibdf4xK58BwDlYorPVFibb46Qsno4E82m9L6mpr9HWdMHSfTvfKrX9tQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skt1CWIxHrn6ZZEbtVFziasBsibdf4xK58BwDlYorPVFibb46Qsno4E82m9L6mpr9HWdMHSfTvfKrX9tQ/640?wx_fmt=png&amp;from=appmsg"></p><p>测序过程中产生的双细胞是有规律的 ,<span>10x平台的双细胞率（符合泊松分布</span><span>）</span>，如下图。</p><p><img data-imgfileid="100001185" data-ratio="0.7267144319344934" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skt1CWIxHrn6ZZEbtVFziasBsick6AdTTZNfd1LymO1QtZapMtV8c2FYLR6trR3a1hr4hjMNiaFibfdCgw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="977" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skt1CWIxHrn6ZZEbtVFziasBsick6AdTTZNfd1LymO1QtZapMtV8c2FYLR6trR3a1hr4hjMNiaFibfdCgw/640?wx_fmt=png&amp;from=appmsg"></p><p><strong><span>假设我们已经获取的了seurat对象，但是我们还想要判断一下seurat对象里是否存在双细胞，并且去掉这些双细胞</span></strong></p><p><br></p><ul><li><p><strong><span>1 加载pbmc和r包 <br></span></strong></p></li></ul><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="ruby"><code><span>.libPaths(c( <span>"/home/data/t040413/R/x86_64-pc-linux-gnu-library/4.2"</span>,</span></code><code><span>             <span>"/home/data/t040413/R/yll/usr/local/lib/R/site-library"</span>,  </span></code><code><span>             <span>"/home/data/refdir/Rlib/"</span>, <span>"/usr/local/lib/R/library"</span>))</span></code><code><span><br></span></code><code><span>sessionInfo()</span></code><code><span>getwd()</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span>library(dplyr)</span></code><code><span>library(cowplot)</span></code><code><span>library(Seurat)</span></code><code><span>library(DoubletFinder)</span></code><code><span><br></span></code><code><span><br></span></code><code><span>dir.create(<span>"~/gzh/doubletfinder"</span>)</span></code><code><span>setwd(<span>"~/gzh/doubletfinder"</span>)</span></code><code><span><br></span></code><code><span>pbmc=readRDS(<span>"~/gzh/featureplot_dotplot_vlnplot/pbmc3k_final.rds"</span>)</span></code><code><span><span># head(pbmc<span>@meta</span>.data)</span></span></code><code><span><span># table(pbmc$cell.type)</span></span></code><code><span><span># #之前命名有点问题，现在改一下</span></span></code><code><span><span># pbmc=RenameIdents(pbmc,'Memory CD4 T'='CD14 Mono')</span></span></code><code><span><span># pbmc=RenameIdents(pbmc,'CD14+ Mono'="Memory CD4 T cell")</span></span></code><code><span><span># DimPlot(pbmc,label = TRUE)</span></span></code><code><span><span># saveRDS(pbmc,file ="~/gzh/featureplot_dotplot_vlnplot/pbmc3k_final.rds" )</span></span></code><code><span><br></span></code><code><span><span># 1取出count-----</span></span></code><code><span><span>case</span>.data &lt;-pbmc@assays$RNA@counts</span></code><code><span><br></span></code></pre></section><p><strong><span></span></strong></p><ul><li><p><strong><span>2 先看下去除双细胞之前的样子</span></strong></p></li></ul><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="nginx"><code><span><span># 2先看下去除双细胞之前的样子 pre_doubletfinder-----</span></span></code><code><span><span>pre</span> &lt;- CreateSeuratObject(counts = cbind(case.data), project = <span>"case"</span>)</span></code><code><span>pre</span></code><code><span>rownames(pre)</span></code><code><span>ncol(pre)</span></code><code><span>str(pre)</span></code><code><span><br></span></code><code><span>pre[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(pre, pattern = <span>"^MT-"</span>)</span></code><code><span>pre</span></code><code><span><br></span></code><code><span>pdf(<span>"1_pre_doubletfinder.pdf"</span>)</span></code><code><span>VlnPlot(pre, features = c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>,<span>"percent.mt"</span>), ncol = <span>3</span>)</span></code><code><span>dev.<span>off</span>()</span></code></pre></section><p><strong><span></span></strong></p><p><img data-galleryid="" data-imgfileid="100001186" data-ratio="0.7726027397260274" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skt1CWIxHrn6ZZEbtVFziasBssZZ0AdC5UhSVodqF51ZA389F7Ea7Dvibic1z2FkocHOcj9ZQUbjumW5A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="730" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skt1CWIxHrn6ZZEbtVFziasBssZZ0AdC5UhSVodqF51ZA389F7Ea7Dvibic1z2FkocHOcj9ZQUbjumW5A/640?wx_fmt=png&amp;from=appmsg"></p><p><strong><span></span></strong></p><ul><li><p><strong><span>3 doubletfinder去除双细胞全代码</span></strong></p></li></ul><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span><span>#3如果是自己的数据，应该从cellranger的下机数据开始读取最好------</span></span></code><code><span><span>case</span> &lt;- CreateSeuratObject(counts = <span>case</span>.data, project = <span>"case"</span>)</span></code><code><span>dim(<span>case</span>)</span></code><code><span><br></span></code><code><span>load_number &lt;- dim(<span>case</span>)</span></code><code><span>load_number</span></code><code><span><br></span></code><code><span><span>case</span> &lt;- NormalizeData(<span>case</span>, normalization.method = <span>"LogNormalize"</span>, scale.factor = <span>10000</span>)</span></code><code><span><span>case</span> &lt;- FindVariableFeatures(<span>case</span>, selection.method = <span>"vst"</span>, nfeatures = <span>2000</span>)</span></code><code><span><span>case</span> &lt;- ScaleData(<span>case</span>)</span></code><code><span><span>case</span> &lt;- RunPCA(<span>case</span>)</span></code><code><span><span>case</span> &lt;- RunUMAP(<span>case</span>, dims = <span>1</span>:<span>30</span>)</span></code><code><span><span>#####pK identification####################</span></span></code><code><span><span>#options("repos"=c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))</span></span></code><code><span><br></span></code><code><span><span># BiocManager::install('devtools')</span></span></code><code><span><span># devtools::install_github('chris-mcginnis-ucsf/DoubletFinder',force = TRUE)</span></span></code><code><span><span># devtools::install_github('chris-mcginnis-ucsf/DoubletFinder')</span></span></code><code><span>library(<span>'DoubletFinder'</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span>sweep.res.<span>list</span> &lt;- DoubletFinder::paramSweep_v3(<span>case</span>, PCs = <span>1</span>:<span>30</span>, sct = <span>FALSE</span>)</span></code><code><span>sweep.stats &lt;- summarizeSweep(sweep.res.<span>list</span>, GT = <span>FALSE</span>)</span></code><code><span>sweep.stats</span></code><code><span><br></span></code><code><span>bcmvn &lt;- find.pK(sweep.stats)</span></code><code><span>mpK &lt;- <span>as</span>.numeric(<span>as</span>.vector(bcmvn$pK[which.max(bcmvn$BCmetric)]))</span></code><code><span>dim(<span>case</span>) <span>#2638</span></span></code><code><span>nExp_poi &lt;- round(<span>0.02</span>*ncol(<span>case</span>))        <span>## 3000~2.3%</span></span></code><code><span>nExp_poi</span></code><code><span><br></span></code><code><span><span>case</span> &lt;- doubletFinder_v3(<span>case</span>, PCs = <span>1</span>:<span>30</span>, pN = <span>0.25</span>, pK = mpK, nExp = nExp_poi, reuse.pANN = <span>FALSE</span>, sct = <span>FALSE</span>)</span></code><code><span><span>case</span></span></code><code><span><br></span></code><code><span>paste(<span>"DF.classifications_"</span>, <span>"0.25_"</span>, mpK, <span>"_"</span>, nExp_poi, sep=<span>""</span>)</span></code><code><span>pdf(<span>"1_doubletFinder_case.pdf"</span>)</span></code><code><span>DimPlot(<span>case</span>, pt.size = <span>1</span>, label = <span>TRUE</span>, label.size = <span>5</span>, reduction = <span>"umap"</span>, group.by = <span>"DF.classifications_0.25_0.02_53"</span>)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span>case_filter &lt;- subset(<span>case</span>, DF.classifications_0<span>.25</span>_0<span>.02</span>_53 == <span>"Singlet"</span> )<span># </span></span></code><code><span>case_filter</span></code><code><span>DoubletFinder_number &lt;- dim(case_filter)</span></code><code><span>DoubletFinder_number</span></code><code><span><span>##############</span></span></code><code><span><br></span></code><code><span>write.table(<span>as</span>.matrix(GetAssayData(object = case_filter, slot = <span>"counts"</span>)),<span>'case_doubletfinder.csv'</span>, sep = <span>','</span>, row.names = T, col.names = T, quote = F)</span></code><code><span>write.table(rbind(load_number,DoubletFinder_number), <span>'case_filter_cell_number.csv'</span>, sep = <span>','</span>, row.names = T, col.names = F, quote = F)</span></code><code><span><span>#########################################################</span></span></code><code><span><span>############################################################</span></span></code><code><span><span>####################################################################</span></span></code><code><span><span>###########################################################</span></span></code><code><span><br></span></code></pre></section><p><strong>我们看到有少量的双细胞</strong><br></p><p><img data-galleryid="" data-imgfileid="100001187" data-ratio="0.7743732590529248" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skt1CWIxHrn6ZZEbtVFziasBsY7jwGQNdBVXiahZeBCoWhZcvYmK2iboEI4vcK1DzHzfiasrPA4I9ouw2A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="718" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skt1CWIxHrn6ZZEbtVFziasBsY7jwGQNdBVXiahZeBCoWhZcvYmK2iboEI4vcK1DzHzfiasrPA4I9ouw2A/640?wx_fmt=png&amp;from=appmsg"></p><p><span><span></span></span></p><ul><li><p><strong><span>4  去除双细胞之后，重新降维聚类分群<br></span></strong></p></li></ul><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span>after.<span>data</span> &lt;- cbind(<span>as</span>.matrix(GetAssayData(<span>object</span> = case_filter, slot = <span>"counts"</span>)))</span></code><code><span>head(after.<span>data</span>)[,<span>1</span>:<span>9</span>]</span></code><code><span>dim(after.<span>data</span>)</span></code><code><span>after &lt;- CreateSeuratObject(counts = after.<span>data</span>, project = <span>"case"</span>)</span></code><code><span>after[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(after, pattern = <span>"^MT-"</span>)</span></code><code><span>pdf(<span>"1_after_doubletfinder.pdf"</span>)</span></code><code><span>VlnPlot(after, features = c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>,<span>"percent.mt"</span>), ncol = <span>3</span>)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span>dim(after.<span>data</span>)</span></code><code><span><br></span></code><code><span>#标准流程------</span></code><code><span><br></span></code><code><span>subset_data =  after%&gt;%</span></code><code><span>  Seurat::NormalizeData(verbose = FALSE) %&gt;%  </span></code><code><span>  FindVariableFeatures(selection.method = <span>"vst"</span>, nfeatures = <span>2000</span>) %&gt;%</span></code><code><span>  ScaleData(verbose = FALSE) %&gt;%</span></code><code><span>  RunPCA(npcs = <span>50</span>, verbose = FALSE) %&gt;%</span></code><code><span>  RunUMAP(dims = <span>1</span>:<span>30</span>) %&gt;%</span></code><code><span>  RunTSNE(dims = <span>1</span>:<span>30</span>) %&gt;%</span></code><code><span>  FindNeighbors() %&gt;%</span></code><code><span>  FindClusters()</span></code><code><span>ElbowPlot(subset_data, ndims = <span>50</span>)</span></code><code><span>VlnPlot(subset_data, features = c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>, <span>"percent.mt"</span>), ncol = <span>3</span>)</span></code><code><span><br></span></code></pre></section><p><img data-galleryid="" data-imgfileid="100001188" data-ratio="0.8024096385542169" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skt1CWIxHrn6ZZEbtVFziasBsia8DiavlAqU1qIyJFcALgukToyV4icbuBz3zQqlric9J71xJeIknmTbNwA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="830" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skt1CWIxHrn6ZZEbtVFziasBsia8DiavlAqU1qIyJFcALgukToyV4icbuBz3zQqlric9J71xJeIknmTbNwA/640?wx_fmt=png&amp;from=appmsg"></p><p><strong><span><br></span></strong></p><ul><li><p><strong><span>5 最后就是细胞命名，可以看下之前的直播</span></strong></p></li></ul><section><iframe data-vidtype="2" data-mpvid="wxv_3221672071441809409" data-cover="http%3A%2F%2Fmmbiz.qpic.cn%2Fsz_mmbiz_jpg%2FxVhD7345SktQhy9htaYapsqzYGbYD1s44icCSaB2JTS4bEKGNQWcTvqdibTEZ9upeZX6Xia266p30XXWfVXanOhTw%2F0%3Fwx_fmt%3Djpeg" allowfullscreen="" frameborder="0" data-ratio="1.7777777777777777" data-w="1920" data-src="https://mp.weixin.qq.com/mp/readtemplate?t=pages/video_player_tmpl&amp;action=mpvideo&amp;auto=0&amp;vid=wxv_3221672071441809409"></iframe></section><section><iframe data-vidtype="2" data-mpvid="wxv_3215014016864092165" data-cover="http%3A%2F%2Fmmbiz.qpic.cn%2Fsz_mmbiz_jpg%2FxVhD7345SkuDYxS1hbicJ4YYtlqKp6sJxt8eGn4qJZ8S5Vl4yrUwy9w4xbTxT131rkMbR996M7IALZQYkH5eJlw%2F0%3Fwx_fmt%3Djpeg" allowfullscreen="" frameborder="0" data-ratio="1.7777777777777777" data-w="1920" data-src="https://mp.weixin.qq.com/mp/readtemplate?t=pages/video_player_tmpl&amp;action=mpvideo&amp;auto=0&amp;vid=wxv_3215014016864092165"></iframe></section><p><img data-imgfileid="100001193" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"><br></p><p><img data-imgfileid="100001192" data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/NY2PHQUG54nLeTvkxe4nxw",target="_blank" rel="noopener noreferrer">原文链接</a>
