---
title: "tidymodels决策树规则网格超参数调优"
date: 2023-12-28T02:25:52Z
draft: ["false"]
tags: [
  "fetched",
  "医学和生信笔记"
]
categories: ["Acdemic"]
---
tidymodels决策树规则网格超参数调优 by 医学和生信笔记
------
<div><section><span>关注公众号，发送</span><strong>R语言</strong><span>或</span><strong>python</strong><span>，可获取资料</span><span></span></section><section><mp-common-profile data-pluginname="mpprofile" data-id="MzUzOTQzNzU0NA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R9YDc8IDhqWAHTrZsMuhDpFlw4scqOl1ZVWpeY77cdibaSzPeGALfkEhdVpwHzVibHCRSYZg4csB43g/0?wx_fmt=png" data-nickname="医学和生信笔记" data-alias="yxhsxbj" data-signature="外科医生👨‍⚕️的R语言和生信学习🔖" data-from="2" data-weuitheme="light"></mp-common-profile></section><section data-role="outer" label="edit by 135editor"><section data-role="paragraph"><section data-role="outer" label="edit by 135editor"><section data-role="paragraph"><section data-role="outer" label="edit by 135editor"><section data-role="paragraph"><section data-role="outer"><section data-role="outer" label="edit by 135editor"><section data-tools="135编辑器" data-id="28"><p data-brushtype="text" hm_fix="440:185"><span>💡专注R语言在🩺生物医学中的使用</span></p></section></section></section></section></section><hr><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><span><span>设为“</span><strong><span>星标</span></strong><span>”，精彩不错过</span></span><br></p><hr><p data-tool="mdnice编辑器"><span><strong></strong></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">之前为大家介绍了<code>dials</code>包：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247500283&amp;idx=1&amp;sn=99a6c295f41a3441467b713335f5d48c&amp;scene=21#wechat_redirect" data-linktype="2">tidymodels使用dials设定超参数的值和范围</a>，作为<code>tidymodels</code>的一部分，主要作用是设置超参数的值和范围。</p><p data-tool="mdnice编辑器">并且介绍了几个比较重要的概念：<strong>规则网格和不规则网格</strong>，<strong>空间填充设计</strong>，<strong>生成网格的多种方法（随机网格、拉丁超立方、最大熵设计）</strong></p><p data-tool="mdnice编辑器">有了超参数之后，我们要做的就是选择模型表现最好的一组超参数，寻找这组超参数的过程就是超参数调优。</p><p data-tool="mdnice编辑器">在<code>tidymodels</code>中超参数的调节是通过<code>tune</code>包实现的。</p><p data-tool="mdnice编辑器">今天给大家简单介绍下如何使用<code>tune</code>配合<code>dials</code>完成超参数调优。在此之前我建议你先读一下之前的推文：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247493301&amp;idx=1&amp;sn=075bb82c31e7b6051f1a0f88112382eb&amp;scene=21#wechat_redirect" data-linktype="2">tidymodels用于机器学习的一些使用细节</a>，读完之后好对<code>tidymodels</code>有一个整体的认识。其实这个超参数调优在之前已经介绍过很多次了。</p><p data-tool="mdnice编辑器">后台回复<strong>tidymodels</strong>也可获取相关推文合集。</p><p data-tool="mdnice编辑器">我们以决策树的超参数为例，演示<code>tune</code>包的使用。</p><h2 data-tool="mdnice编辑器"><span></span><span>加载数据和R包</span><span></span></h2><p data-tool="mdnice编辑器">使用<code>cells</code>数据集，这个数据集一共有2019行，58列，这是一个二分类数据集，其中<code>class</code>是结果变量，是因子型（factor），其余列是预测变量，预测变量都是数值（numeric和integer）。</p><p data-tool="mdnice编辑器">这个数据集是关于乳腺癌细胞分类的，其中记录了细胞不同部分的形状和强度等信息，预测变量之间存在高度的相关性，且部分预测变量明显呈偏态分布。</p><pre data-tool="mdnice编辑器"><code>rm(list = ls())<br><br><span>library</span>(tidymodels)  <br><span>library</span>(rpart.plot)  <br><span>library</span>(vip)         <br><br>data(cells, package = <span>"modeldata"</span>)<br>cells<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## # A tibble: 2,019 × 58</span><br><span>##    case  class angle_ch_1 area_ch_1 avg_inten_ch_1 avg_inten_ch_2 avg_inten_ch_3</span><br><span>##    &lt;fct&gt; &lt;fct&gt;      &lt;dbl&gt;     &lt;int&gt;          &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;</span><br><span>##  1 Test  PS        143.         185           15.7           4.95           9.55</span><br><span>##  2 Train PS        134.         819           31.9         207.            69.9 </span><br><span>##  3 Train WS        107.         431           28.0         116.            63.9 </span><br><span>##  4 Train PS         69.2        298           19.5         102.            28.2 </span><br><span>##  5 Test  PS          2.89       285           24.3         112.            20.5 </span><br><span>##  6 Test  WS         40.7        172          326.          654.           129.  </span><br><span>##  7 Test  WS        174.         177          260.          596.           124.  </span><br><span>##  8 Test  PS        180.         251           18.3           5.73          17.2 </span><br><span>##  9 Test  WS         18.9        495           16.1          89.5           13.7 </span><br><span>## 10 Test  WS        153.         384           17.7          89.9           20.4 </span><br><span>## # ℹ 2,009 more rows</span><br><span>## # ℹ 51 more variables: avg_inten_ch_4 &lt;dbl&gt;, convex_hull_area_ratio_ch_1 &lt;dbl&gt;,</span><br><span>## #   convex_hull_perim_ratio_ch_1 &lt;dbl&gt;, diff_inten_density_ch_1 &lt;dbl&gt;,</span><br><span>## #   diff_inten_density_ch_3 &lt;dbl&gt;, diff_inten_density_ch_4 &lt;dbl&gt;,</span><br><span>## #   entropy_inten_ch_1 &lt;dbl&gt;, entropy_inten_ch_3 &lt;dbl&gt;,</span><br><span>## #   entropy_inten_ch_4 &lt;dbl&gt;, eq_circ_diam_ch_1 &lt;dbl&gt;,</span><br><span>## #   eq_ellipse_lwr_ch_1 &lt;dbl&gt;, eq_ellipse_oblate_vol_ch_1 &lt;dbl&gt;, …</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>数据划分</span><span></span></h2><p data-tool="mdnice编辑器">以决策树为例，决策树在<code>tidymodels</code>中只有3个可以调节的超参数（这点比<code>mlr3</code>差远了）。</p><p data-tool="mdnice编辑器">决策树的超参数调优之前专门介绍过，并配套了多种可视化方法，可参考：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247500489&amp;idx=1&amp;sn=ae6037900af2d6283ee8b05a5f79f835&amp;scene=21#wechat_redirect" data-linktype="2">R语言决策树超参数调优及可视化</a>，今天选择决策树主要是为了演示<code>tidymodels</code>的用法。</p><p data-tool="mdnice编辑器">训练集，测试集划分：</p><pre data-tool="mdnice编辑器"><code>set.seed(<span>123</span>)<br>cell_split &lt;- initial_split(cells %&gt;% select(-case), strata = class)<br>cell_train &lt;- training(cell_split)<br>cell_test  &lt;- testing(cell_split)<br></code></pre><p data-tool="mdnice编辑器">选择重抽样方法：<code>tidymodels</code>中的重抽样也是非常具有特色的，可参考：tidymodels中的数据划分方法</p><pre data-tool="mdnice编辑器"><code>set.seed(<span>234</span>)<br>cell_folds &lt;- vfold_cv(cell_train)<br></code></pre><p data-tool="mdnice编辑器">选择算法，也就是<strong>模型设定</strong>，模型设定（model specification）也是<code>tidymodels</code>团队在<code>parsnip</code>中提出的概念，<code>parsnip</code>实现了<strong>R语言中模型选择语法的大一统</strong>，同时在多个建模流程中实现了语法和逻辑的一致性，大大提高代码简洁性、可读性、易学性，非常强大！详情请参考：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247499637&amp;idx=1&amp;sn=78839cf5f70b409ad93f6d43bfb2d970&amp;scene=21#wechat_redirect" data-linktype="2">tidymodels之parsnip的强大之处</a></p><p data-tool="mdnice编辑器">这里选择的模型设定是决策树：</p><pre data-tool="mdnice编辑器"><code><span># 这里我们选择2个超参数</span><br>tune_spec &lt;- <br>  decision_tree(<br>    cost_complexity = tune(), <span># 损失参数，不理解可参考之前的推文</span><br>    tree_depth = tune() <span># 树的深度</span><br>  ) %&gt;% <br>  set_engine(<span>"rpart"</span>) %&gt;% <br>  set_mode(<span>"classification"</span>)<br><br>tune_spec<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## Decision Tree Model Specification (classification)</span><br><span>## </span><br><span>## Main Arguments:</span><br><span>##   cost_complexity = tune()</span><br><span>##   tree_depth = tune()</span><br><span>## </span><br><span>## Computational engine: rpart</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>生成超参数网格</span><span></span></h2><p data-tool="mdnice编辑器">这里选择的是规则网格，这是大家最常见的一种网格设计。具体可参考上一篇推文：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247500283&amp;idx=1&amp;sn=99a6c295f41a3441467b713335f5d48c&amp;scene=21#wechat_redirect" data-linktype="2">tidymodels使用dials设定超参数的值和范围</a></p><pre data-tool="mdnice编辑器"><code>tree_grid &lt;- grid_regular(cost_complexity(),<br>                          tree_depth(),<br>                          levels = <span>5</span>)<br></code></pre><p data-tool="mdnice编辑器">可以看看超参数的取值和数量：</p><pre data-tool="mdnice编辑器"><code>tree_grid %&gt;% <br>  count(tree_depth)<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## # A tibble: 5 × 2</span><br><span>##   tree_depth     n</span><br><span>##        &lt;int&gt; &lt;int&gt;</span><br><span>## 1          1     5</span><br><span>## 2          4     5</span><br><span>## 3          8     5</span><br><span>## 4         11     5</span><br><span>## 5         15     5</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>开始调参</span><span></span></h2><p data-tool="mdnice编辑器"><code>tidymodels</code>强推<code>workflow</code>，这个<code>workflow</code>的用法以后会经常出现！建议还不懂的赶紧翻看之前的推文：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247498288&amp;idx=1&amp;sn=2ac77e29b3803a0a50d4edd6393248cd&amp;scene=21#wechat_redirect" data-linktype="2">tidymodels工作流：workflow</a></p><p data-tool="mdnice编辑器">在<code>tidymodels</code>中实现网格调参的主函数是<code>tune_grid</code>，主要参数就4个：</p><ul data-tool="mdnice编辑器"><li><section>工作流对象</section></li><li><section>重抽样对象</section></li><li><section>超参数网格</section></li><li><section>控制选项</section></li></ul><p data-tool="mdnice编辑器"><code>tune_grid</code>对于不同的任务类型（比如回归和分类）是有默认的性能指标的，你也可以使用<code>metrics</code>自己指定。</p><pre data-tool="mdnice编辑器"><code>set.seed(<span>345</span>)<br><br><span># 建立工作流对象</span><br>tree_wf &lt;- workflow() %&gt;%<br>  add_model(tune_spec) %&gt;%<br>  add_formula(class ~ .)<br><br><span># 调参过程中的一些设置</span><br>ctrl &lt;- control_grid(verbose = <span>FALSE</span>, save_pred = <span>TRUE</span>)<span>#保存评估集结果</span><br><br><span># 使用tune_grid进行网格搜索调参</span><br>tree_res &lt;- <br>  tree_wf %&gt;% <br>  tune_grid(<br>    resamples = cell_folds,<br>    grid = tree_grid, <span># 也可以直接提供一个数字</span><br>    control = ctrl<br>    )<br><br>tree_res<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## # Tuning results</span><br><span>## # 10-fold cross-validation </span><br><span>## # A tibble: 10 × 5</span><br><span>##    splits             id     .metrics          .notes           .predictions</span><br><span>##    &lt;list&gt;             &lt;chr&gt;  &lt;list&gt;            &lt;list&gt;           &lt;list&gt;      </span><br><span>##  1 &lt;split [1362/152]&gt; Fold01 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    </span><br><span>##  2 &lt;split [1362/152]&gt; Fold02 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    </span><br><span>##  3 &lt;split [1362/152]&gt; Fold03 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    </span><br><span>##  4 &lt;split [1362/152]&gt; Fold04 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    </span><br><span>##  5 &lt;split [1363/151]&gt; Fold05 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    </span><br><span>##  6 &lt;split [1363/151]&gt; Fold06 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    </span><br><span>##  7 &lt;split [1363/151]&gt; Fold07 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    </span><br><span>##  8 &lt;split [1363/151]&gt; Fold08 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    </span><br><span>##  9 &lt;split [1363/151]&gt; Fold09 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    </span><br><span>## 10 &lt;split [1363/151]&gt; Fold10 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>查看结果</span><span></span></h2><p data-tool="mdnice编辑器">查看模型在训练集的表现：</p><pre data-tool="mdnice编辑器"><code>tree_res %&gt;% <br>  collect_metrics()<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## # A tibble: 50 × 8</span><br><span>##    cost_complexity tree_depth .metric  .estimator  mean     n std_err .config   </span><br><span>##              &lt;dbl&gt;      &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;     </span><br><span>##  1    0.0000000001          1 accuracy binary     0.732    10  0.0148 Preproces…</span><br><span>##  2    0.0000000001          1 roc_auc  binary     0.777    10  0.0107 Preproces…</span><br><span>##  3    0.0000000178          1 accuracy binary     0.732    10  0.0148 Preproces…</span><br><span>##  4    0.0000000178          1 roc_auc  binary     0.777    10  0.0107 Preproces…</span><br><span>##  5    0.00000316            1 accuracy binary     0.732    10  0.0148 Preproces…</span><br><span>##  6    0.00000316            1 roc_auc  binary     0.777    10  0.0107 Preproces…</span><br><span>##  7    0.000562              1 accuracy binary     0.732    10  0.0148 Preproces…</span><br><span>##  8    0.000562              1 roc_auc  binary     0.777    10  0.0107 Preproces…</span><br><span>##  9    0.1                   1 accuracy binary     0.732    10  0.0148 Preproces…</span><br><span>## 10    0.1                   1 roc_auc  binary     0.777    10  0.0107 Preproces…</span><br><span>## # ℹ 40 more rows</span><br></code></pre><p data-tool="mdnice编辑器">结果可视化：</p><pre data-tool="mdnice编辑器"><code>tree_res %&gt;%<br>  collect_metrics() %&gt;%<br>  mutate(tree_depth = factor(tree_depth)) %&gt;%<br>  ggplot(aes(cost_complexity, mean, color = tree_depth)) +<br>  geom_line(size = <span>1.5</span>, alpha = <span>0.6</span>) +<br>  geom_point(size = <span>2</span>) +<br>  facet_wrap(~ .metric, scales = <span>"free"</span>, nrow = <span>2</span>) +<br>  scale_x_log10(labels = scales::label_number()) +<br>  scale_color_viridis_d(option = <span>"plasma"</span>, begin = <span>.9</span>, end = <span>0</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016954" data-ratio="1" data-type="png" data-w="504" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RibibH1tMwPlfcRp4hJWMO117h2MMOibKdmOQibglibw5KjeiaFhB2YZ1yJKx9Y6siamWWg0laB5ZwCxEWcw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RibibH1tMwPlfcRp4hJWMO117h2MMOibKdmOQibglibw5KjeiaFhB2YZ1yJKx9Y6siamWWg0laB5ZwCxEWcw/640?wx_fmt=png&amp;from=appmsg"><figcaption>plot of chunk unnamed-chunk-9</figcaption></figure><p data-tool="mdnice编辑器">其实就是1句代码即可：</p><pre data-tool="mdnice编辑器"><code>autoplot(tree_res)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016952" data-ratio="1" data-type="png" data-w="504" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RibibH1tMwPlfcRp4hJWMO117iaqQ3stOJ1pX5Nhm81PicwH4VXVlOj10xbicHbH0dzZPB75ZOvvgAYqJg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RibibH1tMwPlfcRp4hJWMO117iaqQ3stOJ1pX5Nhm81PicwH4VXVlOj10xbicHbH0dzZPB75ZOvvgAYqJg/640?wx_fmt=png&amp;from=appmsg"><figcaption>plot of chunk unnamed-chunk-10</figcaption></figure><p data-tool="mdnice编辑器">上面是查看模型表现，也就是各种衡量模型性能的指标（参考：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247500491&amp;idx=1&amp;sn=ed38955bcd74274cc14072c1d27131eb&amp;scene=21#wechat_redirect" data-linktype="2">tidymodels衡量模型性能</a>）。</p><p data-tool="mdnice编辑器">下面是查看模型对训练集的预测结果，当然这个结果是来自于评估集的（分析集/评估集也是<code>tidymodels</code>中的重要概念，对于理解机器学习的模型拟合过程也非常有帮助，可参考：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247500493&amp;idx=1&amp;sn=6591f5adcde07d1ae04f8396f70a71dd&amp;scene=21#wechat_redirect" data-linktype="2">tidymodels数据划分方法</a>），前提是使用了<code>save_pred = TRUE</code>参数。</p><pre data-tool="mdnice编辑器"><code>tree_res %&gt;% collect_predictions()<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## # A tibble: 37,850 × 9</span><br><span>##    id     .pred_PS .pred_WS  .row cost_complexity tree_depth .pred_class class</span><br><span>##    &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;           &lt;dbl&gt;      &lt;int&gt; &lt;fct&gt;       &lt;fct&gt;</span><br><span>##  1 Fold01    0.401   0.599      1    0.0000000001          1 WS          PS   </span><br><span>##  2 Fold01    0.922   0.0778    18    0.0000000001          1 PS          PS   </span><br><span>##  3 Fold01    0.922   0.0778    26    0.0000000001          1 PS          PS   </span><br><span>##  4 Fold01    0.922   0.0778    35    0.0000000001          1 PS          PS   </span><br><span>##  5 Fold01    0.401   0.599     47    0.0000000001          1 WS          PS   </span><br><span>##  6 Fold01    0.401   0.599     51    0.0000000001          1 WS          PS   </span><br><span>##  7 Fold01    0.922   0.0778    56    0.0000000001          1 PS          PS   </span><br><span>##  8 Fold01    0.922   0.0778    57    0.0000000001          1 PS          PS   </span><br><span>##  9 Fold01    0.401   0.599     58    0.0000000001          1 WS          PS   </span><br><span>## 10 Fold01    0.922   0.0778    71    0.0000000001          1 PS          PS   </span><br><span>## # ℹ 37,840 more rows</span><br><span>## # ℹ 1 more variable: .config &lt;chr&gt;</span><br></code></pre><p data-tool="mdnice编辑器">预测结果的可视化：</p><pre data-tool="mdnice编辑器"><code>augment(tree_res) %&gt;% <br>  ggplot(aes(angle_ch_1, .pred_PS, color=class))+<br>  geom_point(show.legend = <span>F</span>)+<br>  facet_wrap(~ class)+<br>  theme_bw()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016953" data-ratio="1" data-type="png" data-w="504" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RibibH1tMwPlfcRp4hJWMO117PuWicSlJNvxgHPWibswqchT1RSUP3u2fgvmVykib8nQWx5WoiataVSGU7w/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RibibH1tMwPlfcRp4hJWMO117PuWicSlJNvxgHPWibswqchT1RSUP3u2fgvmVykib8nQWx5WoiataVSGU7w/640?wx_fmt=png&amp;from=appmsg"><figcaption>plot of chunk unnamed-chunk-12</figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>选择最好的结果</span><span></span></h2><p data-tool="mdnice编辑器">展示模型表现最好的超参数，模型评价指标选择准确度accuracy：</p><pre data-tool="mdnice编辑器"><code>tree_res %&gt;%<br>  show_best(<span>"accuracy"</span>)<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## # A tibble: 5 × 8</span><br><span>##   cost_complexity tree_depth .metric  .estimator  mean     n std_err .config    </span><br><span>##             &lt;dbl&gt;      &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;      </span><br><span>## 1    0.0000000001          4 accuracy binary     0.807    10  0.0119 Preprocess…</span><br><span>## 2    0.0000000178          4 accuracy binary     0.807    10  0.0119 Preprocess…</span><br><span>## 3    0.00000316            4 accuracy binary     0.807    10  0.0119 Preprocess…</span><br><span>## 4    0.000562              4 accuracy binary     0.807    10  0.0119 Preprocess…</span><br><span>## 5    0.1                   4 accuracy binary     0.786    10  0.0124 Preprocess…</span><br></code></pre><p data-tool="mdnice编辑器">选择模型表现最好的超参数：</p><pre data-tool="mdnice编辑器"><code>best_tree &lt;- tree_res %&gt;%<br>  select_best(<span>"accuracy"</span>)<br><br>best_tree<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## # A tibble: 1 × 3</span><br><span>##   cost_complexity tree_depth .config              </span><br><span>##             &lt;dbl&gt;      &lt;int&gt; &lt;chr&gt;                </span><br><span>## 1    0.0000000001          4 Preprocessor1_Model06</span><br></code></pre><p data-tool="mdnice编辑器">把这组超参数重新应用于模型中：</p><pre data-tool="mdnice编辑器"><code>final_wf &lt;- <br>  tree_wf %&gt;% <br>  finalize_workflow(best_tree)<br><br>final_wf<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## ══ Workflow ════════════════════════════════════════════════════════════════════</span><br><span>## Preprocessor: Formula</span><br><span>## Model: decision_tree()</span><br><span>## </span><br><span>## ── Preprocessor ────────────────────────────────────────────────────────────────</span><br><span>## class ~ .</span><br><span>## </span><br><span>## ── Model ───────────────────────────────────────────────────────────────────────</span><br><span>## Decision Tree Model Specification (classification)</span><br><span>## </span><br><span>## Main Arguments:</span><br><span>##   cost_complexity = 1e-10</span><br><span>##   tree_depth = 4</span><br><span>## </span><br><span>## Computational engine: rpart</span><br></code></pre><p data-tool="mdnice编辑器">重新<strong>在训练集建模</strong>，在测试集查看模型表现：</p><pre data-tool="mdnice编辑器"><code>final_fit &lt;- <br>  final_wf %&gt;%<br>  last_fit(cell_split) <span># 注意这里是 cell_split</span><br><br><span># 查看测试集表现</span><br>final_fit %&gt;%<br>  collect_metrics()<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## # A tibble: 2 × 4</span><br><span>##   .metric  .estimator .estimate .config             </span><br><span>##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span><br><span>## 1 accuracy binary         0.802 Preprocessor1_Model1</span><br><span>## 2 roc_auc  binary         0.840 Preprocessor1_Model1</span><br></code></pre><pre data-tool="mdnice编辑器"><code>final_fit %&gt;%<br>  collect_predictions() %&gt;% <br>  roc_curve(class, .pred_PS) %&gt;% <br>  autoplot()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016956" data-ratio="1" data-type="png" data-w="504" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RibibH1tMwPlfcRp4hJWMO117AN07OT7Ir8uwz2QicgdtfHxICd4XnbGPEKmLM3afMMkKrfChf6xeTfg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RibibH1tMwPlfcRp4hJWMO117AN07OT7Ir8uwz2QicgdtfHxICd4XnbGPEKmLM3afMMkKrfChf6xeTfg/640?wx_fmt=png&amp;from=appmsg"><figcaption>plot of chunk unnamed-chunk-16</figcaption></figure><p data-tool="mdnice编辑器">从训练好的模型中提取workflow：</p><pre data-tool="mdnice编辑器"><code>final_tree &lt;- extract_workflow(final_fit)<br>final_tree<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## ══ Workflow [trained] ══════════════════════════════════════════════════════════</span><br><span>## Preprocessor: Formula</span><br><span>## Model: decision_tree()</span><br><span>## </span><br><span>## ── Preprocessor ────────────────────────────────────────────────────────────────</span><br><span>## class ~ .</span><br><span>## </span><br><span>## ── Model ───────────────────────────────────────────────────────────────────────</span><br><span>## n= 1514 </span><br><span>## </span><br><span>## node), split, n, loss, yval, (yprob)</span><br><span>##       * denotes terminal node</span><br><span>## </span><br><span>##  1) root 1514 539 PS (0.64398943 0.35601057)  </span><br><span>##    2) total_inten_ch_2&lt; 41732.5 642  33 PS (0.94859813 0.05140187)  </span><br><span>##      4) shape_p_2_a_ch_1&gt;=1.251801 631  27 PS (0.95721078 0.04278922) *</span><br><span>##      5) shape_p_2_a_ch_1&lt; 1.251801 11   5 WS (0.45454545 0.54545455) *</span><br><span>##    3) total_inten_ch_2&gt;=41732.5 872 366 WS (0.41972477 0.58027523)  </span><br><span>##      6) fiber_width_ch_1&lt; 11.37318 406 160 PS (0.60591133 0.39408867)  </span><br><span>##       12) avg_inten_ch_1&lt; 145.4883 293  85 PS (0.70989761 0.29010239) *</span><br><span>##       13) avg_inten_ch_1&gt;=145.4883 113  38 WS (0.33628319 0.66371681)  </span><br><span>##         26) total_inten_ch_3&gt;=57919.5 33  10 PS (0.69696970 0.30303030) *</span><br><span>##         27) total_inten_ch_3&lt; 57919.5 80  15 WS (0.18750000 0.81250000) *</span><br><span>##      7) fiber_width_ch_1&gt;=11.37318 466 120 WS (0.25751073 0.74248927)  </span><br><span>##       14) eq_ellipse_oblate_vol_ch_1&gt;=1673.942 30   8 PS (0.73333333 0.26666667)  </span><br><span>##         28) var_inten_ch_3&gt;=41.10858 20   2 PS (0.90000000 0.10000000) *</span><br><span>##         29) var_inten_ch_3&lt; 41.10858 10   4 WS (0.40000000 0.60000000) *</span><br><span>##       15) eq_ellipse_oblate_vol_ch_1&lt; 1673.942 436  98 WS (0.22477064 0.77522936) *</span><br></code></pre><p data-tool="mdnice编辑器">从workflow中提取模型并可视化：</p><pre data-tool="mdnice编辑器"><code>final_tree %&gt;%<br>  extract_fit_engine() %&gt;%<br>  rpart.plot(roundint = <span>FALSE</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016955" data-ratio="1" data-type="png" data-w="504" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RibibH1tMwPlfcRp4hJWMO1177LZFv1NO1N426bnojF3ogxuHtEZqzhiaSAVa5XgS04w3yzSXJzTx1Lw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RibibH1tMwPlfcRp4hJWMO1177LZFv1NO1N426bnojF3ogxuHtEZqzhiaSAVa5XgS04w3yzSXJzTx1Lw/640?wx_fmt=png&amp;from=appmsg"><figcaption>plot of chunk unnamed-chunk-18</figcaption></figure><p data-tool="mdnice编辑器">查看模型中变量的重要性：</p><pre data-tool="mdnice编辑器"><code><span>library</span>(vip)<br><br>final_tree %&gt;% <br>  extract_fit_parsnip() %&gt;% <br>  vip()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016957" data-ratio="1" data-type="png" data-w="504" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RibibH1tMwPlfcRp4hJWMO1179wHx7ZftpWfluuPicVn0LHlIValiawgFBJ464GpEoqjBtKlZuPxY52BQ/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RibibH1tMwPlfcRp4hJWMO1179wHx7ZftpWfluuPicVn0LHlIValiawgFBJ464GpEoqjBtKlZuPxY52BQ/640?wx_fmt=png&amp;from=appmsg"><figcaption>plot of chunk unnamed-chunk-19</figcaption></figure><p data-tool="mdnice编辑器">以上就是一个完整的规则网格超参数调整的流程了，可以看到在<code>tidymodels</code>中，这个过程还是非常清晰流畅的。大家有问题欢迎留言或者加入我们的QQ群交流群！</p><p data-tool="mdnice编辑器">后台回复<strong>tidymodels</strong>获取相关推文合集。</p></section><p><span><br></span></p><hr><blockquote><p><span><strong>联系我们，关注我们</strong></span></p><ol><li><section>免费QQ交流群1：613637742（已满）</section></li><li><section>免费QQ交流群2：608720452</section></li><li><section>公众号消息界面关于作者获取联系方式</section></li><li><section>知乎、CSDN、简书同名账号</section></li><li><section>哔哩哔哩：阿越就是我</section></li></ol></blockquote></section></section></section></section></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/7SHbk4lVakdgjTrMgfCy6A",target="_blank" rel="noopener noreferrer">原文链接</a>
