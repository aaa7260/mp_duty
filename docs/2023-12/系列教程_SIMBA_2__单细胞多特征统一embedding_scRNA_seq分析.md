---
title: "系列教程：SIMBA（2）-单细胞多特征统一embedding-scRNA-seq分析"
date: 2023-12-05T02:43:12Z
draft: ["false"]
tags: [
  "fetched",
  "TOP生物信息"
]
categories: ["Acdemic"]
---
系列教程：SIMBA（2）-单细胞多特征统一embedding-scRNA-seq分析 by TOP生物信息
------
<div><h1><span><span data-raw-text-1697268228246="【" data-textnode-index-1697268228246="0" data-index-1697268228246="0" data-index-len-1697268228246="0">【</span><span data-raw-text-1697268228246="基" data-textnode-index-1697268228246="0" data-index-1697268228246="1" data-index-len-1697268228246="1">基</span><span data-raw-text-1697268228246="于" data-textnode-index-1697268228246="0" data-index-1697268228246="2" data-index-len-1697268228246="2">于</span><span data-raw-text-1697268228246="p" data-textnode-index-1697268228246="0" data-index-1697268228246="3" data-index-len-1697268228246="3">p</span><span data-raw-text-1697268228246="y" data-textnode-index-1697268228246="0" data-index-1697268228246="4" data-index-len-1697268228246="4">y</span><span data-raw-text-1697268228246="t" data-textnode-index-1697268228246="0" data-index-1697268228246="5" data-index-len-1697268228246="5">t</span><span data-raw-text-1697268228246="h" data-textnode-index-1697268228246="0" data-index-1697268228246="6" data-index-len-1697268228246="6">h</span><span data-raw-text-1697268228246="o" data-textnode-index-1697268228246="0" data-index-1697268228246="7" data-index-len-1697268228246="7">o</span><span data-raw-text-1697268228246="n" data-textnode-index-1697268228246="0" data-index-1697268228246="8" data-index-len-1697268228246="8">n</span><span data-raw-text-1697268228246="的" data-textnode-index-1697268228246="0" data-index-1697268228246="9" data-index-len-1697268228246="9">的</span><span data-raw-text-1697268228246="单" data-textnode-index-1697268228246="0" data-index-1697268228246="10" data-index-len-1697268228246="10">单</span><span data-raw-text-1697268228246="细" data-textnode-index-1697268228246="0" data-index-1697268228246="11" data-index-len-1697268228246="11">细</span><span data-raw-text-1697268228246="胞" data-textnode-index-1697268228246="0" data-index-1697268228246="12" data-index-len-1697268228246="12">胞</span><span data-raw-text-1697268228246="分" data-textnode-index-1697268228246="0" data-index-1697268228246="13" data-index-len-1697268228246="13">分</span><span data-raw-text-1697268228246="析" data-textnode-index-1697268228246="0" data-index-1697268228246="14" data-index-len-1697268228246="14">析</span><span data-raw-text-1697268228246="】" data-textnode-index-1697268228246="0" data-index-1697268228246="15" data-index-len-1697268228246="15">】</span><span data-raw-text-1697268228246="回" data-textnode-index-1697268228246="0" data-index-1697268228246="16" data-index-len-1697268228246="16">回</span><span data-raw-text-1697268228246="顾" data-textnode-index-1697268228246="0" data-index-1697268228246="17" data-index-len-1697268228246="17">顾</span><span data-raw-text-1697268228246="：" data-textnode-index-1697268228246="0" data-index-1697268228246="18" data-index-len-1697268228246="18">：</span></span></h1><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247487099&amp;idx=1&amp;sn=2d843211c4b26610b232da20b4829c61&amp;chksm=c251756cf526fc7ae3502412cecd5e9737014cb53827e508875760bcdcbe1490cdc17023cacd&amp;scene=21#wechat_redirect" textvalue="基于Scanpy的单细胞数据质控、聚类、标注" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span data-raw-text-1697268228246="基" data-textnode-index-1697268228246="1" data-index-1697268228246="19" data-index-len-1697268228246="19">基</span><span data-raw-text-1697268228246="于" data-textnode-index-1697268228246="1" data-index-1697268228246="20" data-index-len-1697268228246="20">于</span><span data-raw-text-1697268228246="S" data-textnode-index-1697268228246="1" data-index-1697268228246="21" data-index-len-1697268228246="21">S</span><span data-raw-text-1697268228246="c" data-textnode-index-1697268228246="1" data-index-1697268228246="22" data-index-len-1697268228246="22">c</span><span data-raw-text-1697268228246="a" data-textnode-index-1697268228246="1" data-index-1697268228246="23" data-index-len-1697268228246="23">a</span><span data-raw-text-1697268228246="n" data-textnode-index-1697268228246="1" data-index-1697268228246="24" data-index-len-1697268228246="24">n</span><span data-raw-text-1697268228246="p" data-textnode-index-1697268228246="1" data-index-1697268228246="25" data-index-len-1697268228246="25">p</span><span data-raw-text-1697268228246="y" data-textnode-index-1697268228246="1" data-index-1697268228246="26" data-index-len-1697268228246="26">y</span><span data-raw-text-1697268228246="的" data-textnode-index-1697268228246="1" data-index-1697268228246="27" data-index-len-1697268228246="27">的</span><span data-raw-text-1697268228246="单" data-textnode-index-1697268228246="1" data-index-1697268228246="28" data-index-len-1697268228246="28">单</span><span data-raw-text-1697268228246="细" data-textnode-index-1697268228246="1" data-index-1697268228246="29" data-index-len-1697268228246="29">细</span><span data-raw-text-1697268228246="胞" data-textnode-index-1697268228246="1" data-index-1697268228246="30" data-index-len-1697268228246="30">胞</span><span data-raw-text-1697268228246="数" data-textnode-index-1697268228246="1" data-index-1697268228246="31" data-index-len-1697268228246="31">数</span><span data-raw-text-1697268228246="据" data-textnode-index-1697268228246="1" data-index-1697268228246="32" data-index-len-1697268228246="32">据</span><span data-raw-text-1697268228246="质" data-textnode-index-1697268228246="1" data-index-1697268228246="33" data-index-len-1697268228246="33">质</span><span data-raw-text-1697268228246="控" data-textnode-index-1697268228246="1" data-index-1697268228246="34" data-index-len-1697268228246="34">控</span><span data-raw-text-1697268228246="、" data-textnode-index-1697268228246="1" data-index-1697268228246="35" data-index-len-1697268228246="35">、</span><span data-raw-text-1697268228246="聚" data-textnode-index-1697268228246="1" data-index-1697268228246="36" data-index-len-1697268228246="36">聚</span><span data-raw-text-1697268228246="类" data-textnode-index-1697268228246="1" data-index-1697268228246="37" data-index-len-1697268228246="37">类</span><span data-raw-text-1697268228246="、" data-textnode-index-1697268228246="1" data-index-1697268228246="38" data-index-len-1697268228246="38">、</span><span data-raw-text-1697268228246="标" data-textnode-index-1697268228246="1" data-index-1697268228246="39" data-index-len-1697268228246="39">标</span><span data-raw-text-1697268228246="注" data-textnode-index-1697268228246="1" data-index-1697268228246="40" data-index-len-1697268228246="40">注</span><br></a></section><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247487189&amp;idx=1&amp;sn=34279346e448e9735133af6a53ce7946&amp;chksm=c25175c2f526fcd4fa6db6109b0d456e20452aa9b5efa1eb35e948dedb55bd3bfc1257ef9b7a&amp;scene=21#wechat_redirect" textvalue="基于COSG的单细胞数据marker基因鉴定" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span data-raw-text-1697268228246="基" data-textnode-index-1697268228246="2" data-index-1697268228246="41" data-index-len-1697268228246="41">基</span><span data-raw-text-1697268228246="于" data-textnode-index-1697268228246="2" data-index-1697268228246="42" data-index-len-1697268228246="42">于</span><span data-raw-text-1697268228246="C" data-textnode-index-1697268228246="2" data-index-1697268228246="43" data-index-len-1697268228246="43">C</span><span data-raw-text-1697268228246="O" data-textnode-index-1697268228246="2" data-index-1697268228246="44" data-index-len-1697268228246="44">O</span><span data-raw-text-1697268228246="S" data-textnode-index-1697268228246="2" data-index-1697268228246="45" data-index-len-1697268228246="45">S</span><span data-raw-text-1697268228246="G" data-textnode-index-1697268228246="2" data-index-1697268228246="46" data-index-len-1697268228246="46">G</span><span data-raw-text-1697268228246="的" data-textnode-index-1697268228246="2" data-index-1697268228246="47" data-index-len-1697268228246="47">的</span><span data-raw-text-1697268228246="单" data-textnode-index-1697268228246="2" data-index-1697268228246="48" data-index-len-1697268228246="48">单</span><span data-raw-text-1697268228246="细" data-textnode-index-1697268228246="2" data-index-1697268228246="49" data-index-len-1697268228246="49">细</span><span data-raw-text-1697268228246="胞" data-textnode-index-1697268228246="2" data-index-1697268228246="50" data-index-len-1697268228246="50">胞</span><span data-raw-text-1697268228246="数" data-textnode-index-1697268228246="2" data-index-1697268228246="51" data-index-len-1697268228246="51">数</span><span data-raw-text-1697268228246="据" data-textnode-index-1697268228246="2" data-index-1697268228246="52" data-index-len-1697268228246="52">据</span><span data-raw-text-1697268228246="m" data-textnode-index-1697268228246="2" data-index-1697268228246="53" data-index-len-1697268228246="53">m</span><span data-raw-text-1697268228246="a" data-textnode-index-1697268228246="2" data-index-1697268228246="54" data-index-len-1697268228246="54">a</span><span data-raw-text-1697268228246="r" data-textnode-index-1697268228246="2" data-index-1697268228246="55" data-index-len-1697268228246="55">r</span><span data-raw-text-1697268228246="k" data-textnode-index-1697268228246="2" data-index-1697268228246="56" data-index-len-1697268228246="56">k</span><span data-raw-text-1697268228246="e" data-textnode-index-1697268228246="2" data-index-1697268228246="57" data-index-len-1697268228246="57">e</span><span data-raw-text-1697268228246="r" data-textnode-index-1697268228246="2" data-index-1697268228246="58" data-index-len-1697268228246="58">r</span><span data-raw-text-1697268228246="基" data-textnode-index-1697268228246="2" data-index-1697268228246="59" data-index-len-1697268228246="59">基</span><span data-raw-text-1697268228246="因" data-textnode-index-1697268228246="2" data-index-1697268228246="60" data-index-len-1697268228246="60">因</span><span data-raw-text-1697268228246="鉴" data-textnode-index-1697268228246="2" data-index-1697268228246="61" data-index-len-1697268228246="61">鉴</span><span data-raw-text-1697268228246="定" data-textnode-index-1697268228246="2" data-index-1697268228246="62" data-index-len-1697268228246="62">定</span></a></p><p><span data-raw-text-1697268228246="正" data-textnode-index-1697268228246="3" data-index-1697268228246="76" data-index-len-1697268228246="76"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247487274&amp;idx=1&amp;sn=9ecd04a53f1f313c65e299bddb1705b2&amp;chksm=c251743df526fd2bdb2b36e1951b34e1c6d9fe00062644572c377b7beb28cfbc76ffcccc32c5&amp;scene=21#wechat_redirect" textvalue="【基于python的单细胞分析】使用scVI实现批次效应校正" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">【基于python的单细胞分析】使用scVI实现批次效应校正</a><br></span></p><p><span><span data-raw-text-1697268228246="如" data-textnode-index-1697268228246="4" data-index-1697268228246="77" data-index-len-1697268228246="77">如</span><span data-raw-text-1697268228246="何" data-textnode-index-1697268228246="4" data-index-1697268228246="78" data-index-len-1697268228246="78">何</span><span data-raw-text-1697268228246="进" data-textnode-index-1697268228246="4" data-index-1697268228246="79" data-index-len-1697268228246="79">进</span><span data-raw-text-1697268228246="行" data-textnode-index-1697268228246="4" data-index-1697268228246="80" data-index-len-1697268228246="80">行</span><span data-raw-text-1697268228246="细" data-textnode-index-1697268228246="4" data-index-1697268228246="81" data-index-len-1697268228246="81">细</span><span data-raw-text-1697268228246="胞" data-textnode-index-1697268228246="4" data-index-1697268228246="82" data-index-len-1697268228246="82">胞</span><span data-raw-text-1697268228246="类" data-textnode-index-1697268228246="4" data-index-1697268228246="83" data-index-len-1697268228246="83">类</span><span data-raw-text-1697268228246="型" data-textnode-index-1697268228246="4" data-index-1697268228246="84" data-index-len-1697268228246="84">型</span><span data-raw-text-1697268228246="注" data-textnode-index-1697268228246="4" data-index-1697268228246="85" data-index-len-1697268228246="85">注</span><span data-raw-text-1697268228246="释" data-textnode-index-1697268228246="4" data-index-1697268228246="86" data-index-len-1697268228246="86">释</span></span></p><p><span></span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247489613&amp;idx=1&amp;sn=0b27c70cfa5c07b7f8860d9599d6c60a&amp;chksm=c251635af526ea4cd86465be7fbf478d4f3632484902d7b036608acc3d0cbf2cf7df4abf2a54&amp;scene=21#wechat_redirect" textvalue="scanpy绘图函数介绍-上" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">scanpy绘图函数介绍-上</a></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247489664&amp;idx=1&amp;sn=d90f808b6654f3606ce6d08d55256855&amp;chksm=c2516397f526ea812452d47aff14f4ac4b5c42666912450f84e3e64c4c7ece5a164533add5f3&amp;scene=21#wechat_redirect" textvalue="scanpy绘图函数介绍-下" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">scanpy绘图函数介绍-下</a><br></p><p><br></p><h1><span><span data-raw-text-1697268228246="【" data-textnode-index-1697268228246="0" data-index-1697268228246="0" data-index-len-1697268228246="0">【SIMBA系列教程</span><span data-raw-text-1697268228246="】" data-textnode-index-1697268228246="0" data-index-1697268228246="15" data-index-len-1697268228246="15">】</span><span data-raw-text-1697268228246="回" data-textnode-index-1697268228246="0" data-index-1697268228246="16" data-index-len-1697268228246="16">回</span><span data-raw-text-1697268228246="顾" data-textnode-index-1697268228246="0" data-index-1697268228246="17" data-index-len-1697268228246="17">顾</span><span data-raw-text-1697268228246="：" data-textnode-index-1697268228246="0" data-index-1697268228246="18" data-index-len-1697268228246="18">：</span></span></h1><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247490431&amp;idx=1&amp;sn=8d9cf4db6377b4f5afff9fe40892137e&amp;chksm=c2516068f526e97e6bcadd938a345f137c32276d9eb322c64d0d0a807f6eb0050b3d43a9fa63&amp;scene=21#wechat_redirect" textvalue="系列教程：SIMBA（1）-单细胞多特征统一embedding-算法介绍" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">系列教程：SIMBA（1）-单细胞多特征统一embedding-算法介绍</a><br></section><section><br></section><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span><span data-raw-text-1697268228246="一" data-textnode-index-1697268228246="48" data-index-1697268228246="1508" data-index-len-1697268228246="1508">一</span><span data-raw-text-1697268228246="、" data-textnode-index-1697268228246="48" data-index-1697268228246="1509" data-index-len-1697268228246="1509">、文章简介</span></span></h2><p><span>《SIMBA: single-cell embedding along with features》于今年5月29日发表在Nature Methods上。我们将用一期推送，介绍SIMBA的文章，然后使用五期推送，系统介绍SIMBA算法的相关应用，以及代码复现，<strong>包括scRNA-seq分析、scATAC-seq分析、scRNA+scATAC-seq分析、<strong>scRNA+scATAC-seq推断GRN、</strong>scRNA-seq批次效应校正和scRNA+scATAC-seq整合分析。</strong></span><span></span></p><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span><span data-raw-text-1697268228246="二" data-textnode-index-1697268228246="71" data-index-1697268228246="1709" data-index-len-1697268228246="1709">二</span><span data-raw-text-1697268228246="、" data-textnode-index-1697268228246="71" data-index-1697268228246="1710" data-index-len-1697268228246="1710">、算</span></span><span>法介绍</span></h2><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span>一、概述</span><span></span></h3><p data-tool="mdnice编辑器"><span>对于每个任务，SIMBA 构造一个图，其中不同的实体(即Cell和Feature,即基因或者Peaks)被表示为节点，这些实体之间的关系被编码为边(构建一张图）。一旦图形构建完成，SIMBA 然后应用源自社交网络技术的多关系图嵌入算法以及基于 Softmax 的转换来将节点或实体嵌入到公共的低维空间中，其中细胞和特征可以根据它们的距离进行分析。</span></p><h3 data-tool="mdnice编辑器"><span></span><span>二、指标说明</span><span></span></h3><p data-tool="mdnice编辑器"><span>SIMBA还提供了几个定量指标（称为“SIMBA指标”），包括最大值、基尼指数、标准差（s.d.）和熵，用于评估各种特征的细胞类型特异性，而不需要先验知识，如预定义的细胞类型。</span></p><p data-tool="mdnice编辑器"><span>SIMBA通过计算将一个特征分配给一个细胞的概率得分（表示为点乘），为每个特征生成了所有细胞的概率分布。基于这个概率分布或其派生的概率分布（如SIMBA条码图所示），可以从不同角度评估每个特征的细胞类型特异性。</span></p><p data-tool="mdnice编辑器"><span><br></span></p><h4 data-tool="mdnice编辑器"><span></span><span>最大值（Max Score）：</span><span></span></h4><p data-tool="mdnice编辑器"><span>max score是计算前50个细胞的归一化概率的平均值，用作对细胞类型分配的置信度指标，有助于过滤噪声（较高的值表示较高细胞类型特异性)</span></p><span data-tool="mdnice编辑器"><section role="presentation" data-formula="\max \left(f_{j}\right)=\frac{\sum_{i=1}^{k} \operatorname{norm}\left(x_{i}\right)}{k}" data-formula-type="block-equation"><embed src="https://mmbiz.qpic.cn/mmbiz_svg/574VdhMFwaHhy5SRMrVnQIp10wUxxcOA46qfnyZJ2oMFmOo3gRicwVrmRmicZHpBycHyS9Wibes24NzykWHic2Jr1WWfhZiaKtGxa/0?wx_fmt=svg&amp;from=appmsg" data-type="svg+xml" data-imgfileid="100006738"></embed></section><section role="presentation" data-formula="\max \left(f_{j}\right)=\frac{\sum_{i=1}^{k} \operatorname{norm}\left(x_{i}\right)}{k}" data-formula-type="block-equation"><br></section></span><h4 data-tool="mdnice编辑器"><span></span><span>基尼指数（Gini Index）：</span><span></span></h4><p data-tool="mdnice编辑器">基尼指数是从Softmax转换后的概率分布计算得出的，用于评估与完全均匀分布的偏差，因此显示不平衡分布（即细胞类型特异性）的特征具有较高的Gini指数值（<strong>较高的值表示较高的细胞类型特异性</strong>）</p><span data-tool="mdnice编辑器"><section role="presentation" data-formula="\operatorname{gini}\left(f_{j}\right)=\frac{\sum_{i=1}^{n}(2 i-n-1) \times p_{c_{i}, f_{j}}}{n \sum_{i=1}^{n} p_{c_{i}, f_{j}}}" data-formula-type="block-equation"><embed src="https://mmbiz.qpic.cn/mmbiz_svg/574VdhMFwaHhy5SRMrVnQIp10wUxxcOAoOdj4NAAq2lrOr3MdORtg5CFicJzFhaawq8MvPH2fFHrtcwQ6Xmcu6ibiayBv8wn7bq/0?wx_fmt=svg&amp;from=appmsg" data-type="svg+xml" data-imgfileid="100006735"></embed></section><section role="presentation" data-formula="\operatorname{gini}\left(f_{j}\right)=\frac{\sum_{i=1}^{n}(2 i-n-1) \times p_{c_{i}, f_{j}}}{n \sum_{i=1}^{n} p_{c_{i}, f_{j}}}" data-formula-type="block-equation"><br></section></span><h4 data-tool="mdnice编辑器"><span>标准差（s.d.）：</span><span></span></h4><p data-tool="mdnice编辑器">标准差测量概率分布中的变化量，较高的值表示细胞之间的偏差较大（即细胞类型特异性）（<strong>较高的值表示较高的细胞类型特异性</strong>）。</p><span data-tool="mdnice编辑器"><section role="presentation" data-formula="s. d. \left(f_{j}\right)=\sqrt{\frac{1}{n-1} \sum_{i=1}^{n}\left(x_{c_{i}, f_{j}}-\mu\right)^{2}}" data-formula-type="block-equation"><embed src="https://mmbiz.qpic.cn/mmbiz_svg/574VdhMFwaHhy5SRMrVnQIp10wUxxcOA6iaia6f9Xf7ZtOFuRxKrOpdjyg7SdF3R0TQAVeOib0U0N9fhSGG5jVQWsjmwTgiaEwGI/0?wx_fmt=svg&amp;from=appmsg" data-type="svg+xml" data-imgfileid="100006736"></embed></section><section role="presentation" data-formula="s. d. \left(f_{j}\right)=\sqrt{\frac{1}{n-1} \sum_{i=1}^{n}\left(x_{c_{i}, f_{j}}-\mu\right)^{2}}" data-formula-type="block-equation"><br></section></span><h4 data-tool="mdnice编辑器"><span></span><span>熵（Entropy）：</span></h4><p data-tool="mdnice编辑器"><span>熵测量信息内容，并捕捉细胞在Softmax转换后的概率分布上分布的程度；较低的熵表示分布几乎集中在一个细胞子集上（即细胞类型特异性）（较低的值表示较高的细胞类型特异性)。</span></p><span data-tool="mdnice编辑器"><section role="presentation" data-formula="\operatorname{entropy}\left(f_{j}\right)=-\sum_{i=1}^{n} p_{c_{i}, f_{j}} \log \left(p_{c_{i}, f_{j}}\right)" data-formula-type="block-equation"><embed src="https://mmbiz.qpic.cn/mmbiz_svg/574VdhMFwaHhy5SRMrVnQIp10wUxxcOAiaibqZSdbJ6F9oFM8xmVOrPfPCVZIMibx3eof54iaDwiawhNhSqQ3VCAQV2eEia5fp0WMg/0?wx_fmt=svg&amp;from=appmsg" data-type="svg+xml" data-imgfileid="100006737"></embed><br></section></span></section><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span><span data-raw-text-1697268228246="二" data-textnode-index-1697268228246="71" data-index-1697268228246="1709" data-index-len-1697268228246="1709">三</span><span data-raw-text-1697268228246="、" data-textnode-index-1697268228246="71" data-index-1697268228246="1710" data-index-len-1697268228246="1710">、scRNA-seq分析</span></span></h2><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">在构建细胞和基因的图时，如果一个基因在给定的细胞中表达，则在细胞和基因之间添加一条边。为了区分每条边的强度，提出了一种分箱过程，将基因表达值分为不同水平，同时保留原始分布。不同水平的基因表达通过不同类型的关系进行编码。具体而言，首先使用基于k均值聚类的过程来近似归一化基因表达矩阵中非零值的分布，并将细胞和基因之间的边的强度定义为离散化为5个等级（取值为0，1，2，3，4，5），进而生成scRNA-seq图。</p><p data-tool="mdnice编辑器">SIMBA 通过图形嵌入过程生成这些节点的初步embedding（低维表示），然后使用Softmax函数将这些低维表示投影到相同的低维表示空间，这些相同空间的低维表示可以用于可视化（计算Umap图），相关流程如下图所示。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100006774" data-ratio="0.20925925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17H6icD67v8kibS7O3pycETBAr42wbYkLMSKa95GuWGboH4Iqp2CmqSYAQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17H6icD67v8kibS7O3pycETBAr42wbYkLMSKa95GuWGboH4Iqp2CmqSYAQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">我们可以通过Umap图可视化出<strong>细胞的二维投影图（上图）</strong>，以及<strong>细胞和基因联合embedding的结果（下图），其中灰色为基因，其他颜色为细胞类型</strong>。如下图所示 我们可以看到细胞和基因联合embedding的Umap图保留了细胞Umap图的特征，同时将基因和细胞投影在了同一张Umap图上。</p><p data-tool="mdnice编辑器">并且可以发现一些基因在Umap上的位置，处于特定的细胞亚群之中，这种基因往往是这类细胞的标记基因（<strong>如图中的MS4A1基因在B细胞的位置，IL7R基因在CD4细胞位置，NKG7基因在CD8 T细胞和NK细胞的位置</strong>等……）</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100006776" data-ratio="0.5266106442577031" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17qUQxqtUAicCIL3ubIDrfISO1XaybDO7vibRzCibBGU4rwcsicicSrJWcaTg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="714" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17qUQxqtUAicCIL3ubIDrfISO1XaybDO7vibRzCibBGU4rwcsicicSrJWcaTg/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100006775" data-ratio="1.061919504643963" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17hq1tsXdOOLJs2nW4LpXgiaRADs9iaprrOI64mOZyo2iaSia77Kf3Md3pFw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="646" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17hq1tsXdOOLJs2nW4LpXgiaRADs9iaprrOI64mOZyo2iaSia77Kf3Md3pFw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">我们SIMBA 可以可视化亚群的特异性基因。如下图所示，纵轴是 SIMBA 将<strong>特征分配给细胞的估计概率</strong>（即这个基因出现在这个细胞中的概率，个人理解），横轴是按估计概率大小进行排序的细胞，颜色代表细胞类型。</p><p data-tool="mdnice编辑器">概率的不平衡表明了一个基因与细胞的一个亚群（通常对应已知的细胞类型）的关联（通常是特异性基因，如CST3基因，MS4A1基因和NKG7基因），而均匀的概率分布则表示一个非细胞类型特异性的基因（如GAPHD基因）。</p><p data-tool="mdnice编辑器"><strong>对于标记基因（如CST3对单核细胞和树突状细胞、MS4A1对B细胞以及NGK7对NK细胞和CD8 T细胞），我们观察到将每个基因分配给它们相应的细胞类型的概率明显超过了其他细胞类型。相反地，对于基因GAPDH这样的管家基因，我们观察到更均匀的分布</strong>，并且将该基因与排名靠前的细胞相关联的概率较低。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100006773" data-ratio="0.49515738498789347" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib1794B1LYcrXkuS1EMLF3hxXCozH86aEzr2kVF2VCch59XaW7libQRiakCA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="826" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib1794B1LYcrXkuS1EMLF3hxXCozH86aEzr2kVF2VCch59XaW7libQRiakCA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">通过检查最大值与基尼指数的基因指标图（其中横轴为Max Score，纵轴为基尼指数，较高的值表示较高的细胞类型特异性），我们观察到标记基因（例如CST3、NKG7、MS4A1）<strong>位于右上角</strong>，而管家基因（例如GAPDH）<strong>位于左下角</strong>。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100006772" data-ratio="0.9098837209302325" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17qUPZvkO0mLRibLfzuZO3Uzt4F2zwxpy7aUFqnBdW0jk0f3Nl60Qc3Mg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="344" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17qUPZvkO0mLRibLfzuZO3Uzt4F2zwxpy7aUFqnBdW0jk0f3Nl60Qc3Mg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">作者也通过Umap图可视化了相关基因的表达情况，发现确实标记基因（例如CST3、NKG7、MS4A1）具有细胞类型特异性，而管家基因（例如GAPDH）不具有细胞类型特异性。</p><p><img data-imgfileid="100006778" data-ratio="0.2462962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17U7nPciaCItZS6Vpadnk4gprfEcxYszCn5RVANGm6UjrHZKJOIGeWsWg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17U7nPciaCItZS6Vpadnk4gprfEcxYszCn5RVANGm6UjrHZKJOIGeWsWg/640?wx_fmt=png&amp;from=appmsg"></p></section><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span><span data-raw-text-1697268228246="二" data-textnode-index-1697268228246="71" data-index-1697268228246="1709" data-index-len-1697268228246="1709">四</span><span data-raw-text-1697268228246="、" data-textnode-index-1697268228246="71" data-index-1697268228246="1710" data-index-len-1697268228246="1710">、代码实战</span></span></h2><p>首先我们下载SIMBA包及其依赖，并且导入这些包。</p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code>!pip install git+https://github.com/pinellolab/simba_pbg.git<br>!pip install git+https://github.com/huidongchen/simba<br><span>import</span> os <br><span>import</span> simba <span>as</span> si<br><br></code></pre><p data-tool="mdnice编辑器">然后我们读取测试数据，这里的数据可以替换为你自己需要分析的数据集，只要保证输入数据的格式为anndata格式即可，这里我们使用的是pbmc3k数据集，这也是一个非常经典的公共数据集。</p><pre data-tool="mdnice编辑器"><span></span><code>workdir = <span>'result_simba_rnaseq'</span><br>si.settings.set_workdir(workdir)<br>si.settings.set_figure_params(dpi=<span>80</span>,<br>                              style=<span>'white'</span>,<br>                              fig_size=[<span>5</span>,<span>5</span>],<br>                              rc={<span>'image.cmap'</span>: <span>'viridis'</span>})<br><span># make plots prettier</span><br><span>from</span> matplotlib_inline.backend_inline <span>import</span> set_matplotlib_formats<br>set_matplotlib_formats(<span>'retina'</span>)<br>adata_CG = si.datasets.rna_10xpmbc3k()<br><br></code></pre><p data-tool="mdnice编辑器">然后我们对测试数据集进行质控和过滤，以滤除表达量较低的基因，这样可以减小数据维度，降低数据稀疏性并提高下游分析的速度和准确性。</p><pre data-tool="mdnice编辑器"><span></span><code>si.pp.filter_genes(adata_CG,min_n_cells=<span>3</span>)<br>si.pp.cal_qc_rna(adata_CG)<br>si.pl.violin(adata_CG,list_obs=[<span>'n_counts'</span>,<span>'n_genes'</span>,<span>'pct_mt'</span>])<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006744" data-ratio="0.40807651434643993" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17M5o0C56WMxoLCGpicoosFeUr1voFic9PmP2huF1jTbQuMcUNDpbjnDcQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="941" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17M5o0C56WMxoLCGpicoosFeUr1voFic9PmP2huF1jTbQuMcUNDpbjnDcQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">我们根据人为设定的阈值过滤低质量细胞，并对计数矩阵的表达值做标准化和对数化处理，然后计算前2000个高变基因并对其可视化。</p><p data-tool="mdnice编辑器">请注意，是否计算高变基因对图嵌入的结果并没有本质影响，但是计算高变基因可以降低模型的计算时间，与之相对于，如果仅使用高变基因进行图嵌入计算，最终生成的低维表示图中也只包含高变基因。</p><pre data-tool="mdnice编辑器"><span></span><code>si.pp.filter_cells_rna(adata_CG,min_n_genes=<span>100</span>)<br>si.pp.normalize(adata_CG,method=<span>'lib_size'</span>)<br>si.pp.log_transform(adata_CG)<br>si.pp.select_variable_genes(adata_CG, n_top_genes=<span>2000</span>)<br>si.pl.variable_genes(adata_CG,show_texts=<span>True</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006745" data-ratio="0.996694214876033" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17ALtg29FkfxcPMaBxCyveFicqglgVxlGklT7NjRMx9yAiaiczKE16cic2GQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="605" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17ALtg29FkfxcPMaBxCyveFicqglgVxlGklT7NjRMx9yAiaiczKE16cic2GQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">接下来我们将计数矩阵的表达值做离散化处理，离散化的表达值将用于构建基因-细胞图中的基因-细胞边的权重。</p><pre data-tool="mdnice编辑器"><span></span><code>si.tl.discretize(adata_CG,n_bins=<span>5</span>)<br>si.pl.discretize(adata_CG,kde=<span>False</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006742" data-ratio="0.9978401727861771" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17uyXujts3DCDHQfcXI5PHjJLys1TjSX0HSsPdKO0cLmKqsDIOmY5ehA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="926" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17uyXujts3DCDHQfcXI5PHjJLys1TjSX0HSsPdKO0cLmKqsDIOmY5ehA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">然后我们就可以构建图网络了。</p><p data-tool="mdnice编辑器">list_CG中指定的anndata对象为输入编码数据，adata.var_names和data.obs_names将被编码为节点，对于基因表达数据，在默认情况下，不同水平的基因表达是由不同权重的节点-节点之间边编码的。</p><pre data-tool="mdnice编辑器"><span></span><code>si.tl.gen_graph(list_CG=[adata_CG],<br>                layer=<span>'simba'</span>,<br>                use_highly_variable=<span>False</span>,<br>                dirname=<span>'graph0'</span>)<br>si.settings.pbg_params<br></code></pre><p data-tool="mdnice编辑器">接下来我们可以训练模型了。作者给出了修改模型训练参数的代码，但是在一般情况下，我们使用默认参数就可以很好的训练模型。</p><pre data-tool="mdnice编辑器"><span></span><code>si.tl.pbg_train(auto_wd=<span>True</span>, save_wd=<span>True</span>, output=<span>'model'</span>)<br><span># modify parameters</span><br>dict_config = si.settings.pbg_params.copy()<br><span># dict_config['wd'] = 0.015521</span><br>dict_config[<span>'wd_interval'</span>] = <span>10</span> <span># we usually set `wd_interval` to 10 for scRNA-seq datasets for a slower but finer training</span><br>dict_config[<span>'workers'</span>] = <span>12</span> <span>#The number of CPUs.</span><br><br><span>## start training</span><br>si.tl.pbg_train(pbg_params = dict_config, auto_wd=<span>True</span>, save_wd=<span>True</span>, output=<span>'model'</span>)<br></code></pre><p data-tool="mdnice编辑器">我们也可以可视化出模型训练指标的变化情况。通过绘制训练指标以监控过度拟合并评估最终模型。理想情况下，经过一定数量的训练后，度量曲线应该保持稳定。默认情况下，这行代码会显示了训练损失(越低越好)以及验证损失(越低越好)和 MRR (越高越好)。</p><pre data-tool="mdnice编辑器"><span></span><code>si.pl.pbg_metrics(fig_ncol=<span>1</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006743" data-ratio="1.7772151898734176" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17UXvnRE8oHibfh32xGoLGQMZnK9oGaaWdNalLjV2vg0D5BzRcWOa6Xpg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="790" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17UXvnRE8oHibfh32xGoLGQMZnK9oGaaWdNalLjV2vg0D5BzRcWOa6Xpg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">然后我们可以保存训练模型，并且输出生成的图联合embedding结果</p><p data-tool="mdnice编辑器">C代表Cell，可以发现2700个细胞都生成了50维的低维表示。G代表Gene，可以发现13714个基因都计算出了其对应的50维的低维表示</p><pre data-tool="mdnice编辑器"><span></span><code><span># load back 'graph0'</span><br>si.load_graph_stats()<br><span># load back 'model' that was trained on 'graph0'</span><br>si.load_pbg_config()<br><br><span># load back 'graph1'</span><br>si.load_graph_stats(path=<span>'/content/result_simba_rnaseq/pbg/graph0/'</span>)<br><span># load back 'model2' that was trained on 'graph1'</span><br>si.load_pbg_config(path=<span>'/content/result_simba_rnaseq/pbg/graph0/model/'</span>)<br><span># read in entity embeddings obtained from pbg training.</span><br>dict_adata = si.read_embedding()<br>dict_adata<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006741" data-ratio="0.12096774193548387" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17eZZF50v3WYRrkFL2Q8TSdwcGrqHHiafz4bnNqfxZcR5ERBib04NqeODQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="620" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17eZZF50v3WYRrkFL2Q8TSdwcGrqHHiafz4bnNqfxZcR5ERBib04NqeODQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">接下来我们首先可视化出细胞的Umap图，基于这50维低维表示，我们可以将其作为umap计算的输入，并且得到其Umap坐标，并可视化，如下图所示。</p><pre data-tool="mdnice编辑器"><span></span><code>palette_celltype={<span>'B'</span>:<span>'#1f77b4'</span>,<br>                  <span>'CD4 T'</span>:<span>'#ff7f0e'</span>,<br>                  <span>'CD8 T'</span>:<span>'#279e68'</span>,<br>                  <span>'Dendritic'</span>:<span>"#aa40fc"</span>,<br>                  <span>'CD14 Monocytes'</span>:<span>'#d62728'</span>,<br>                  <span>'FCGR3A Monocytes'</span>:<span>'#b5bd61'</span>,<br>                  <span>'Megakaryocytes'</span>:<span>'#e377c2'</span>,<br>                  <span>'NK'</span>:<span>'#8c564b'</span>}<br>                  <br><br>si.tl.umap(adata_C,n_neighbors=<span>15</span>,n_components=<span>2</span>)<br>si.pl.umap(adata_C,color=[<span>'celltype'</span>],<br>           dict_palette={<span>'celltype'</span>: palette_celltype},<br>           fig_size=(<span>6</span>,<span>4</span>),<br>           drawing_order=<span>'random'</span>)<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006747" data-ratio="0.6207605344295992" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17svKiamSkWQ6uN8h2XsTiabLzqXnqiah3xaq1SuTiaOpgUog0SeWH9c3kMg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="973" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17svKiamSkWQ6uN8h2XsTiabLzqXnqiah3xaq1SuTiaOpgUog0SeWH9c3kMg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">然后我们可以计算并得到细胞和基因的联合embedding，并将其可视化在Umap图上。</p><p data-tool="mdnice编辑器">如下图所示，除了蓝灰色是基因以外，其他的颜色都是不同类型的细胞。</p><pre data-tool="mdnice编辑器"><span></span><code><span># embed cells and genes into the same space</span><br>adata_all = si.tl.embed(adata_ref=adata_C,list_adata_query=[adata_G])<br>adata_all.obs.head()<br><span>## add annotations of cells and genes</span><br>adata_all.obs[<span>'entity_anno'</span>] = <span>""</span><br>adata_all.obs.loc[adata_C.obs_names, <span>'entity_anno'</span>] = adata_all.obs.loc[adata_C.obs_names, <span>'celltype'</span>]<br>adata_all.obs.loc[adata_G.obs_names, <span>'entity_anno'</span>] = <span>'gene'</span><br>adata_all.obs.head()<br>palette_entity_anno = palette_celltype.copy()<br>palette_entity_anno[<span>'gene'</span>] = <span>"#607e95"</span><br>si.tl.umap(adata_all,n_neighbors=<span>15</span>,n_components=<span>2</span>)<br>si.pl.umap(adata_all,color=[<span>'id_dataset'</span>,<span>'entity_anno'</span>],<br>           dict_palette={<span>'entity_anno'</span>: palette_entity_anno},<br>           drawing_order=<span>'original'</span>,<br>           fig_size=(<span>6</span>,<span>5</span>))<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006750" data-ratio="0.3861111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17lEticIMo6IAHufmnUiaRpg2vahqqhwF1abuLQzG2zyT7AvODTHqt0fpg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17lEticIMo6IAHufmnUiaRpg2vahqqhwF1abuLQzG2zyT7AvODTHqt0fpg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">作者同样提供了工具，帮助我们可视化出不同基因在Umap图上的位置，并且给出文字表示。</p><p data-tool="mdnice编辑器">图中除了GAPDH基因和B2M基因是管家基因，其他基因都是特定细胞亚群的标记基因。在Umap图上，实际上这些Marker基因的Umap坐标都处于对应的亚群内，而管家基因的坐标则不具有亚群特异性。</p><pre data-tool="mdnice编辑器"><span></span><code><span># highlight some marker genes in the co-embedding space</span><br>marker_genes = [<span>'IL7R'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span>, <span>'CD8A'</span>, <span>'CD8B'</span>, <span>'LYZ'</span>, <span>'CD14'</span>,<br>                <span>'LGALS3'</span>, <span>'S100A8'</span>, <span>'GNLY'</span>, <span>'NKG7'</span>, <span>'KLRB1'</span>,<br>                <span>'FCGR3A'</span>, <span>'MS4A7'</span>, <span>'FCER1A'</span>, <span>'CST3'</span>, <span>'PPBP'</span>]<br>si.pl.umap(adata_all[::<span>-1</span>,],color=[<span>'entity_anno'</span>],dict_palette={<span>'entity_anno'</span>: palette_entity_anno},<br>           drawing_order=<span>'original'</span>,<br>           texts=marker_genes + [<span>'GAPDH'</span>, <span>'B2M'</span>],<br>           show_texts=<span>True</span>,<br>           fig_size=(<span>8</span>,<span>6</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006749" data-ratio="0.7055555555555556" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib173HznrUaEicKYbiawnXwGf5t8rVlFLLIhbwsO3xhibAcTDTdypIFCwLeUA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib173HznrUaEicKYbiawnXwGf5t8rVlFLLIhbwsO3xhibAcTDTdypIFCwLeUA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">我们也可以只可视化高变基因的embedding，而不是所有基因的细胞embedding。</p><pre data-tool="mdnice编辑器"><span></span><code><span># obtain variable genes</span><br>si.pp.select_variable_genes(adata_CG, n_top_genes=<span>3000</span>)<br>var_genes = adata_CG.var_names[adata_CG.var[<span>'highly_variable'</span>]].tolist()<br><span># obtain SIMBA embeddings of cells and variable genes</span><br>adata_all2 = adata_all[list(adata_C.obs_names) + var_genes,].copy()<br><span># visualize them using UMAP</span><br>si.tl.umap(adata_all2,n_neighbors=<span>15</span>,n_components=<span>2</span>)<br>si.pl.umap(adata_all2,color=[<span>'entity_anno'</span>],<br>           dict_palette={<span>'entity_anno'</span>: palette_entity_anno},<br>           drawing_order=<span>'original'</span>,<br>           fig_size=(<span>6</span>,<span>5</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006748" data-ratio="0.7860082304526749" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17I7foP6sMgYj2ibVVFM7TibdicQvu7Wtt0rlel3UgYEHhvt7lD01JjwBhg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="972" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17I7foP6sMgYj2ibVVFM7TibdicQvu7Wtt0rlel3UgYEHhvt7lD01JjwBhg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">接下来，作者提供了自动计算指标的函数，我们可以计算每个基因在四个指标（如上文所示）上的大小。</p><pre data-tool="mdnice编辑器"><span></span><code>adata_cmp = si.tl.compare_entities(adata_ref=adata_C, adata_query=adata_G)<br>adata_cmp.var.head()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006746" data-ratio="0.4204355108877722" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17FQg3c66icZMOGQKGkuDmbLPJtIVH70ibibDO1ODbz5micNrqgScsx43PGg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="597" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17FQg3c66icZMOGQKGkuDmbLPJtIVH70ibibDO1ODbz5micNrqgScsx43PGg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">同时我们也可以通过散点图对其进行可视化，并且标注出我们想要研究基因的位置。</p><pre data-tool="mdnice编辑器"><span></span><code><span># SIMBA metrics can be visualized using the following function:</span><br>si.pl.entity_metrics(adata_cmp,<br>                     x=<span>'max'</span>,<br>                     y=<span>'gini'</span>,<br>                     show_contour=<span>False</span>,<br>                     texts=marker_genes + [<span>'GAPDH'</span>, <span>'B2M'</span>],<br>                     show_texts=<span>True</span>,<br>                     show_cutoff=<span>True</span>,<br>                     size=<span>5</span>,<br>                     text_expand=(<span>1.3</span>,<span>1.5</span>),<br>                     cutoff_x=<span>1.</span>,<br>                     cutoff_y=<span>0.3</span>,<br>                     save_fig=<span>False</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006753" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17MRjOUQZd2ibxtW7RIS02ufiaAneYba5Y1GPic85sFIOn5VNOaFqHNEicbw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="766" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17MRjOUQZd2ibxtW7RIS02ufiaAneYba5Y1GPic85sFIOn5VNOaFqHNEicbw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">我们也可以使用SIMBA 条形码图基于边缘置信度可视化特征细胞概率:-不平衡表示细胞类型特异性基因-均匀分布表示非特异性基因。</p><pre data-tool="mdnice编辑器"><span></span><code><span># add annoations of cells</span><br>adata_cmp.obs[<span>'celltype'</span>] = adata_CG.obs.loc[adata_cmp.obs_names,<span>'celltype'</span>]<br>list_genes = [<span>'CST3'</span>, <span>'NKG7'</span>, <span>'MS4A1'</span>, <span>'GAPDH'</span>]<br>si.pl.entity_barcode(adata_cmp,<br>                     layer=<span>'softmax'</span>,<br>                     entities=list_genes,<br>                     anno_ref=<span>'celltype'</span>,<br>                     show_cutoff=<span>True</span>,<br>                     cutoff=<span>0.001</span>,<br>                     palette=palette_celltype,<br>                     fig_size=(<span>6</span>, <span>2.5</span>),<br>                     save_fig=<span>False</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006754" data-ratio="1.5802219979818366" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib175aFZyMXvYDwPcFgnaZeFQVcxvtvDF9pCuX4FZINKUnVT32YmE7ic3ng/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="991" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib175aFZyMXvYDwPcFgnaZeFQVcxvtvDF9pCuX4FZINKUnVT32YmE7ic3ng/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">最后，我们也可以通过umap图直接可视化特定基因的表达情况，如预期所示，marker基因的分布具有细胞特异性，而管家基因则不具有特异性。</p><pre data-tool="mdnice编辑器"><span></span><code><span># The same list of genes can also be visualized on UMAP to confirm their cell type specificity</span><br>adata_CG.obsm[<span>'X_umap'</span>] = adata_C[adata_CG.obs_names,].obsm[<span>'X_umap'</span>].copy()<br>si.pl.umap(adata_CG,<br>           color=[<span>'CST3'</span>, <span>'NKG7'</span>, <span>'MS4A1'</span>, <span>'GAPDH'</span>],<br>           drawing_order=<span>'sorted'</span>,<br>           size=<span>5</span>,<br>           alpha=<span>0.9</span>,<br>           fig_ncol=<span>4</span>,<br>           fig_size=(<span>4</span>,<span>4</span>),<br>           save_fig=<span>False</span>)<br></code></pre><figure data-tool="mdnice编辑器"></figure></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p><img data-imgfileid="100006778" data-ratio="0.2462962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17U7nPciaCItZS6Vpadnk4gprfEcxYszCn5RVANGm6UjrHZKJOIGeWsWg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2ZaiasUQpDK8V9tmhUqnRib17U7nPciaCItZS6Vpadnk4gprfEcxYszCn5RVANGm6UjrHZKJOIGeWsWg/640?wx_fmt=png&amp;from=appmsg"></p></section><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器" data-remoteid="c1701602853937"><span><span data-raw-text-1697268228246="二" data-textnode-index-1697268228246="71" data-index-1697268228246="1709" data-index-len-1697268228246="1709">四</span><span data-raw-text-1697268228246="、" data-textnode-index-1697268228246="71" data-index-1697268228246="1710" data-index-len-1697268228246="1710">、总结</span></span></h2><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><span>其实你会发现，SIMBA在scRNA-seq分析里并没有实现非常出乎人意料的效果，其找到的差异基因我们也可以通过Scanpy自带的差异基因表达分析函数，或者人为的先验知识找到。</span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><span></span><span>对此，我们认为，SIMBA的优点是可以整合不同方法得到的基因，比如细胞通讯、MOFA（多组学因子分析，一种多组学分析算法）的feature、GLUE的GRN（高歌老师开发的scRNA-seq+scATAC-seq配对算法生成的转录因子调控网络）、pySCENIC生成的调节子活性矩阵、还有细胞的marker，可以在embedding层面，研究他们的相关性和特征。</span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><span>此外，我们认为，SIMBA在scATAC-seq分析，scRNA+scATAC-seq整合分析的层面，可能会有更好的效果，因为SIMBA能在同一embe</span><span>dding空间研究不同特征的关系，也提供了相应的工具。</span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">本文介绍了SIMBA在scRNA-seq数据分析中的应用，给出了实战代码与结果。实际上，对于scRNA-seq数据分析，我们认为SIMBA的应用不应只局限于基因表达的研究，也许我们也可以整合pySCENIC得到的调节子活性，或者其他计数矩阵结构的信息，并且进行联合embedding，但是这些只是猜想，目前还没得到实际的验证，仅供大家参考。</p><p data-tool="mdnice编辑器"><span>本文为《系列教程：SIMBA-单细胞多特征统一embedding》的第二篇文章，介绍了SIMBA在scRNA-seq数据分析中的应用，在下一篇推送中，我们将介绍SIMBA在</span><strong>scATAC-seq分析</strong><span>中的应用情况。</span></p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span><span data-raw-text-1697268228246="、" data-textnode-index-1697268228246="76" data-index-1697268228246="1813" data-index-len-1697268228246="1813">Reference</span></span></h2><p><span><span data-raw-text-1697289516448="h" data-textnode-index-1697289516448="247" data-index-1697289516448="5051" data-index-len-1697289516448="5051"></span></span></p><p>https://simba-bio.readthedocs.io/en/latest<span><span data-raw-text-1697289516448="/" data-textnode-index-1697289516448="248" data-index-1697289516448="5121" data-index-len-1697289516448="5121"></span></span></p><p>Chen, H., Ryu, J., Vinyard, M.E. <em>et al.</em> SIMBA: single-cell embedding along with features. <em>Nat Methods</em> (2023). https://doi.org/10.1038/s41592-023-01899-8<span></span></p><section><mp-common-profile data-pluginname="mpprofile" data-id="MzkzMzE5NTM4NA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aJMzXzvekL6pv5hnSGnwsxWcOUF8av7a9VEiaicBGia4CRy0DUOeaFuFZY2BPLmRQSf4lkibg5l31Ttw/0?wx_fmt=png" data-nickname="TOP生物信息" data-alias="" data-signature="生信人，当自强。" data-from="0" data-is_biz_ban="0"></mp-common-profile><span></span></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Is_H6yQ8C5BoPW0IWr1LHQ",target="_blank" rel="noopener noreferrer">原文链接</a>
