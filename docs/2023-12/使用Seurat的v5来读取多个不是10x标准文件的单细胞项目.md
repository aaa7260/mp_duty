---
title: "使用Seurat的v5来读取多个不是10x标准文件的单细胞项目"
date: 2023-12-28T02:17:41Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
使用Seurat的v5来读取多个不是10x标准文件的单细胞项目 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>前面我们在 <a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518295&amp;idx=1&amp;sn=f97bd58d2c21122ba5c7d250f7fa709e&amp;scene=21#wechat_redirect" data-linktype="2">初试Seurat的V5版本</a> 的推文里面演示了10x单细胞样品的标准3文件的读取，而且在<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518314&amp;idx=1&amp;sn=b53feba8104cfb9a377518852e871c66&amp;scene=21#wechat_redirect" data-linktype="2">使用Seurat的v5来读取多个10x的单细胞转录组矩阵</a> 的推文里面演示了多个10x单细胞样品的标准3文件的读取。</p></blockquote><p data-tool="mdnice编辑器">但是留下来了一个悬念， 就是如果我们的单细胞转录组并不是10x的标准3文件，而是tsv或者csv或者txt等文本文件表达量矩阵信息，就有点麻烦了。接下来我们以2020的文章：《<strong>Single-Cell Transcriptome Analysis Reveals Dynamic Cell Populations and Differential Gene Expression Patterns in Control and Aneurysmal Human Aortic Tissue</strong>》举例说明，它的数据集是 https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE155468</p><p data-tool="mdnice编辑器">可以看到，作者这个时候给出来的是：</p><pre data-tool="mdnice编辑器"><span></span><code>GSM4704931_Con4.txt.gz 9.2 Mb<br>GSM4704932_Con6.txt.gz 3.0 Mb<br>GSM4704933_Con9.txt.gz 10.0 Mb<br>GSM4704934_TAA1.txt.gz 7.7 Mb<br>GSM4704935_TAA2.txt.gz 5.8 Mb<br>GSM4704936_TAA3.txt.gz 7.2 Mb<br>GSM4704937_TAA4.txt.gz 12.5 Mb<br>GSM4704938_TAA5.txt.gz 11.7 Mb<br>GSM4704939_TAA6.txt.gz 8.1 Mb<br>GSM4704940_TAA7.txt.gz 18.7 Mb<br>GSM4704941_TAA8.txt.gz 6.4 Mb<br></code></pre><p data-tool="mdnice编辑器">是11个单细胞转录组样品，8 patients with ATAA (4 women and 4 men) and 3 controls (2 women and 1 man). 每个样品都是一个独立的txt文本文件蕴藏着其表达量矩阵信息。</p><p data-tool="mdnice编辑器">值得注意的是这个2020的数据集还被2023的文章引用了，感兴趣的可以去看看，Genome-wide association study of thoracic aortic aneurysm and dissection in the Million Veteran Program. <em>Nat Genet</em> 2023 Jul;55(7):1106-1115. PMID: 37308786</p><p data-tool="mdnice编辑器">前面提到了，如果是没有样品的txt独立读取后，再merge的时候成为的Seurat对象里面的各个样品的表达量矩阵的分开的，就会导致所有的后面的步骤都失败。而它每个样品并不是10x单细胞样品的标准3文件，所以没办法使用前面的策略。</p><h3 data-tool="mdnice编辑器"><span></span>第一种方法是把每个样品的矩阵对齐<span></span></h3><p data-tool="mdnice编辑器">每个样品的txt仍然是独立的读取，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>dir=<span>'GSE155468_RAW/'</span> <br>samples=list.files( dir ,pattern = <span>'gz'</span>)<br>samples <br><span>library</span>(data.table)<br>ctList = lapply(samples,<span>function</span>(pro){ <br>  <span># pro=samples[1] </span><br>  print(pro)<br>  ct=fread(file.path( dir ,pro),data.table = <span>F</span>)<br>  ct[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  rownames(ct)=ct[,<span>1</span>]<br>  colnames(ct) = paste(gsub(<span>'.txt.gz'</span>,<span>''</span>,pro),<br>                       colnames(ct) ,sep = <span>'_'</span>)<br>  ct=ct[,-<span>1</span>] <br>  <span>return</span>(ct)<br>})<br><br></code></pre><p data-tool="mdnice编辑器">上面的代码返回了 ctList 这个list，它里面有每个单细胞样品的表达量矩阵，但是每个样品的基因数量和细胞数量都是不一样的哦。然后提前把矩阵合并之前需要首先把基因数量对齐，合并后才构建对象：</p><pre data-tool="mdnice编辑器"><span></span><code>lapply(ctList, dim)<br>tmp =table(unlist(lapply(ctList, rownames)))<br>cg = names(tmp)[tmp==length(samples)]<br>bigct = do.call(cbind,<br>                lapply(ctList,<span>function</span>(ct){ <br>                  ct = ct[cg,] <br>                  <span>return</span>(ct)<br>                }))<br>sce.all=CreateSeuratObject(counts =  bigct, <br>                       min.cells = <span>5</span>,<br>                       min.features = <span>300</span>)<br>sce.all<br>as.data.frame(sce.all@assays$RNA$counts[<span>1</span>:<span>10</span>, <span>1</span>:<span>2</span>])<br>head(sce.all@meta.data, <span>10</span>)<br>table(sce.all@meta.data$orig.ident) <br></code></pre><p data-tool="mdnice编辑器">可以看到，我这个时候做了一个处理，就是每个样品的基因数量都对齐了，如果某个基因在某个样品里面特有其实它不会被考虑，因为我考虑的是绝大部分基因。</p><p data-tool="mdnice编辑器">因为多个样品合并成为了一个超级大的表达量矩阵，就是 bigct 这个变量，所以后面直接针对它来使用CreateSeuratObject函数去构建Seurat对象，就是完美的下游分析的输入数据啦。</p><h3 data-tool="mdnice编辑器"><span></span>第二种方法是把矩阵还原成为10x的3文件<span></span></h3><p data-tool="mdnice编辑器">前面我们指出来了，它每个样品并不是10x单细胞样品的标准3文件，每个样品都是一个独立的txt文本文件蕴藏着其表达量矩阵信息，所以没办法使用前面的策略。但是，我们其实可以根据这个txt文件去把它还原成为10x的3文件，早在<em>2020-03-16</em>其实我就写个一个简单的笔记：<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247490226&amp;idx=1&amp;sn=4fb0e8e871478acbd0fbfda504e7fa26&amp;scene=21#wechat_redirect" data-linktype="2">表达矩阵逆转为10X的标准输出3个文件</a>，但是那个时候的代码略微有点麻烦，我们其实可以把它写成一个函数，接下来让我们演示一下吧。</p><p data-tool="mdnice编辑器">每个样品的txt仍然是独立的读取，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>dir=<span>'GSE155468_RAW/'</span> <br>samples=list.files( dir ,pattern = <span>'gz'</span>)<br>samples <br><span>library</span>(data.table)<br>ctList = lapply(samples,<span>function</span>(pro){ <br>  <span># pro=samples[1] </span><br>  print(pro)<br>  ct=fread(file.path( dir ,pro),data.table = <span>F</span>)<br>  ct[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  rownames(ct)=ct[,<span>1</span>]<br>  colnames(ct) = paste(gsub(<span>'.txt.gz'</span>,<span>''</span>,pro),<br>                       colnames(ct) ,sep = <span>'_'</span>)<br>  ct=ct[,-<span>1</span>] <br>  <span>return</span>(ct)<br>})<br><br></code></pre><p data-tool="mdnice编辑器">上面的代码返回了 ctList 这个list，它里面有每个单细胞样品的表达量矩阵，但是每个样品的基因数量和细胞数量都是不一样的哦。接下来我们构造一个自定义函数，把表达量矩阵转为10x的3个文件，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>to10x &lt;- <span>function</span>(ct)<br>  {<br>  write.table(data.frame(rownames(ct),rownames(ct)),file = <span>'features.tsv'</span>,<br>              quote = <span>F</span>,sep = <span>'\t'</span>,<br>              col.names = <span>F</span>,row.names = <span>F</span>)<br>  write.table(colnames(ct),file = <span>'barcodes.tsv'</span>,quote = <span>F</span>,<br>              col.names = <span>F</span>,row.names = <span>F</span>)<br>  file=<span>"matrix.mtx"</span><br>  sink(file)<br>  cat(<span>"%%MatrixMarket matrix coordinate integer general\n"</span>)<br>  cat(<span>"%\n"</span>)<br>  cat(paste(nrow(ct),ncol(ct),sum(ct&gt;<span>0</span>),<span>"\n"</span>)) <br>  sink()<br>  tmp=ct[<span>1</span>:<span>5</span>,<span>1</span>:<span>4</span>]<br>  tmp<br>  tmp=do.call(rbind,lapply(<span>1</span>:ncol(ct),<span>function</span>(i){<br>    <span>return</span>(data.frame(row=<span>1</span>:nrow(ct),<br>                      col=i,<br>                      exp=ct[,i]))<br>  }) )<br>  tmp=tmp[tmp$exp&gt;<span>0</span>,]<br>  head(tmp)<br>  write.table(tmp,file = <span>'matrix.mtx'</span>,quote = <span>F</span>,<br>              col.names = <span>F</span>,row.names = <span>F</span>,append = <span>T</span> )<br>}<br></code></pre><p data-tool="mdnice编辑器">比较简单，接下来就针对前面的表达量列表去循环使用这个函数即可，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code> <br>lapply(samples,<span>function</span>(pro){ <br>  <span># pro=samples[1] </span><br>  pro=gsub(<span>'.txt.gz'</span>,<span>''</span>,pro)<br>  print(pro)<br>  ct = ctList[[<span>1</span>]]<br>  dir.create(pro)<br>  setwd(pro)<br>  to10x(ct)<br>  setwd(<span>'../'</span>)<br>  })<br><br></code></pre><p data-tool="mdnice编辑器">说实话，函数运行效率确实有点低，不过没关系，反正是练习的代码，我们大概是还是会选择前面的矩阵合并的方式，并不需要把表达量矩阵转为10x的3个文件。成功后可以看到如下所示的文件夹结构：</p><pre data-tool="mdnice编辑器"><span></span><code>│   ├── [ 160]  GSM4704935_TAA2<br>│   │   ├── [115K]  barcodes.tsv<br>│   │   ├── [291K]  features.tsv<br>│   │   └── [ 95M]  matrix.mtx<br>│   ├── [ 160]  GSM4704936_TAA3<br>│   │   ├── [115K]  barcodes.tsv<br>│   │   ├── [291K]  features.tsv<br>│   │   └── [ 95M]  matrix.mtx<br></code></pre><p data-tool="mdnice编辑器">值得注意的是每个样品这个时候里面的3文件其实是并没有压缩，所以很耗费空间哦。而且因为这个时候我给出来的名字是features.tsv所以如果想使用Seurat的Read10X读取，就需要把每个样品文件夹里面的3文件gz压缩一下哦！然后把每个样品的文件夹归纳整理到 outputs 文件夹里面，就可以使用如下所示的代码啦。</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(Seurat)<br>tmp = list.dirs(<span>'outputs'</span>)[-<span>1</span>]<br>tmp<br>ct = Read10X(tmp) <br>sce.all=CreateSeuratObject(counts = ct  , <br>                           min.cells = <span>5</span>,<br>                           min.features = <span>300</span>,) <br></code></pre><p data-tool="mdnice编辑器">如下所示的文件夹架构哦：</p><p><img data-galleryid="" data-imgfileid="100043522" data-ratio="1.6177777777777778" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzcHHr4SS1lRw5zGyWr3NHBW51yAxmNnMjTU0VlKMnIwicZ4NXic1KXlC6Rbmc0iaHToxyz0gbNvrGicw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="450" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzcHHr4SS1lRw5zGyWr3NHBW51yAxmNnMjTU0VlKMnIwicZ4NXic1KXlC6Rbmc0iaHToxyz0gbNvrGicw/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>文件夹架构</figcaption></figure><p data-tool="mdnice编辑器">同样的，只需有了sce.all对象，后面的降维聚类分群就是我们之前的代码即可啦。明天中午直播一下这个全部的流程哈！</p><section><mp-common-videosnap data-pluginname="mpvideosnap" data-headimgurl="https://wx.qlogo.cn/finderhead/PiajxSqBRaEI7scvWIPdECSfnUpSjTib9Y7RI14r1VVzxaA57PjcCERw/0" data-username="v2_060000231003b20faec8c7e1881bcad2ca06ec35b07788412aec898c89eb1e34f9a354475e8c@finder" data-nickname="生信技能树" data-desc="将在12月25日 12:00 直播" data-livewording="预约" data-intro="使用Seurat的V5处理任意单细胞转录组数据" data-type="live" data-status="0" data-noticeid="finderlivenotice-v2_060000231003b20faec8c7e1881bcad2ca06ec35b07788412aec898c89eb1e34f9a354475e8c@finder-1703401098228661-1531398801" data-isdisabled="0" data-errortips=""></mp-common-videosnap></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/tw7lygmGDAbpzMTx57VvFw",target="_blank" rel="noopener noreferrer">原文链接</a>
