---
title: "RNAseq-ML|CoxBoost生存分析完成预后模型变量筛选以及预测"
date: 2023-12-12T01:29:05Z
draft: ["false"]
tags: [
  "fetched",
  "生信补给站"
]
categories: ["Acdemic"]
---
RNAseq-ML|CoxBoost生存分析完成预后模型变量筛选以及预测 by 生信补给站
------
<div><p><ne-text><span>机器学习构建预后模型的文章很多，且越来越卷，动不动就是</span></ne-text><ne-text><span><strong><span>10种模型的101种组合</span></strong></span></ne-text><ne-text><span>，这个系列会逐一的介绍这些常用于预后模型变量筛选和模型构建的机器学习方法。</span></ne-text></p><section><span>机器学习模型1-<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650400318&amp;idx=1&amp;sn=7c72b9353829d9c36cc0be43dda8719e&amp;chksm=f01c84dec76b0dc8e2ef640226f949de3fdd647a9316edef4734747c73e602919e51170513da&amp;scene=21#wechat_redirect" textvalue="RNAseq|Lasso构建预后模型，绘制风险评分的KM 和 ROC曲线" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">RNAseq|Lasso构建预后模型，绘制风险评分的KM 和 ROC曲线</a> </span></section><section><span>机器学习模型2-</span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650401396&amp;idx=1&amp;sn=095999ccfb46c1cc6790d15c03398ac8&amp;chksm=f01c8894c76b01828a0770604fcb0ba47f760feb0f6ba8a0b0962c7745efcc2715a74fca6f67&amp;scene=21#wechat_redirect" textvalue="RNAseq-ML|randomForestSRC完成随机森林生存分析-预后模型库+1" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"><span>RNAseq-ML|randomForestSRC完成随机森林生存分析-预后模型库+1</span></a></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650401535&amp;idx=1&amp;sn=bb2c079cabd83e2adfcd1bd2a723a6be&amp;chksm=f01c881fc76b010972e5828ea1280072612881cdcec0ba4c2871e7329ae329c108f8704ab5be&amp;scene=21#wechat_redirect" textvalue="RNAseq-ML|弹性网络回归算法Enet（Elastic Net）完成预后模型变量筛选-模型库+2" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>机器学习模型3-</span>RNAseq-ML|弹性网络回归算法Enet（Elastic Net）完成预后模型变量筛选-模型库+2</a><br></section><p><span>本次介绍</span><span>CoxBoost生存分析，一种<span>用boosting做COX模型</span>的方法，同样既可以用于变量筛选 也可以用于 直接预测。</span></p><p><span><strong><span>友情提示最后的lapply方式批量得到多个数据集的模型Cindex结果，很实用。</span></strong></span><span></span></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><p><span><strong><span><span>一 </span><span>数据输入，处理</span></span></strong></span><span> </span></p></section></section></section></section></section><p><ne-p data-lake-id="u74985541"><span><br></span></ne-p><ne-p data-lake-id="u74985541"><span>沿袭使用前面<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650400318&amp;idx=1&amp;sn=7c72b9353829d9c36cc0be43dda8719e&amp;chksm=f01c84dec76b0dc8e2ef640226f949de3fdd647a9316edef4734747c73e602919e51170513da&amp;scene=21#wechat_redirect" textvalue="RNAseq|Lasso构建预后模型，绘制风险评分的KM 和 ROC曲线" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">Lasso</a>得到的SKCM.uni-COX2.RData数据（<strong>筛选过的单因素预后显著的基因</strong>），后面的更多机器学习的推文均会使用该数据，后台回复“<span><strong>机器学习</strong></span><span>”即可。</span></span></ne-p></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="css"><code><span><span>library</span>(<span>tidyverse</span>)</span></code><code><span><span>library</span>(<span>survival</span>)</span></code><code><span><span>library</span>(<span>survminer</span>)</span></code><code><span><span>library</span>(<span>CoxBoost</span>)</span></code><code><span><br></span></code><code><span><span>load</span>("<span>SKCM</span><span>.uni-COX2</span><span>.RData</span>")</span></code><code><span><span>module_expr</span><span>.cox</span> &lt;<span>-</span> <span>module_expr</span><span>.cox</span> %&gt;% <span>select</span>(<span>-</span> "_<span>PATIENT</span>") %&gt;% </span></code><code><span>  <span>column_to_rownames</span>("<span>sample</span>")</span></code><code><span><br></span></code><code><span># 7<span>:3</span> 拆分</span></code><code><span><span>set</span><span>.seed</span>(1234) #</span></code><code><span><span>ind</span> &lt;<span>-</span> <span>sample</span>(<span>nrow</span>(<span>module_expr</span><span>.cox2</span>),<span>nrow</span>(<span>module_expr</span><span>.cox2</span>) * 0<span>.7</span> )</span></code><code><span><span>train</span> &lt;<span>-</span> <span>module_expr</span><span>.cox2</span><span>[ind,]</span></span></code><code><span><span>test</span> &lt;<span>-</span> <span>module_expr</span><span>.cox2</span><span>[-ind,]</span></span></code><code><span>## 确保训练集和验证集的基因一致 </span></code><code><span><span>gene_com</span> &lt;<span>-</span> <span>intersect</span>(<span>colnames</span>(<span>train</span>) ,<span>colnames</span>(<span>test</span>))</span></code><code><span><span>training</span> &lt;<span>-</span> <span>train</span> %&gt;% <span>select</span>(<span>gene_com</span>)</span></code><code><span><span>testing</span> &lt;<span>-</span> <span>test</span> %&gt;% <span>select</span>(<span>gene_com</span>)</span></code><code><span><br></span></code><code><span><span>training</span><span>[1:4,1:4]</span></span></code><code><span>#                <span>OS</span> <span>OS</span><span>.time</span>      <span>TYRP1</span>   <span>IGKV4_1</span></span></code><code><span><span>#TCGA-D3-A5GO-06A</span>  0    4195  0<span>.3807211</span> 2<span>.1135527</span></span></code><code><span><span>#TCGA-D3-A1Q8-06A</span>  1     854  0<span>.5981395</span> 7<span>.5734985</span></span></code><code><span><span>#TCGA-FW-A5DY-06A</span>  0     587  0<span>.2427982</span> 8<span>.5617523</span></span></code><code><span><span>#TCGA-EE-A29B-06A</span>  1    2588 10<span>.3296179</span> 0<span>.4794816</span></span></code></pre></section><ne-p data-lake-id="u74985541"><span>添加seed可以保证training 和 testing 一致，可复现以及比较不同机器学习方法的好坏。</span></ne-p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><p><span><strong><span>二 构建CoxBoost模型</span></strong> </span></p></section></section></section></section></section><p><span><br></span></p><p><span>CoxBoost函数使用如下，可以看到除了随访时间和结局外，还有stepno 和 penalty两个参数需要确认。</span></p><section><ul><li><li><li></ul><pre data-lang="properties"><code><span><span>CoxBoost(time</span>=<span>obs.time,status=status,x=x,</span></span></code><code><span>         <span>stepno</span>=<span>100,</span></span></code><code><span>         <span>penalty</span>=<span>100)</span></span></code></pre></section><h3><span><strong>1，确定最优<span>penalty </span></strong></span></h3><h3><ne-clipboard source="https%3A%2F%2Fwww.yuque.com%2Fxiyoudonghang%2Fhe6cos%2Fxxuz71ehwtpab3z3"></ne-clipboard></h3><p><span>使用</span><span>optimCoxBoostPenalty函数</span><span>筛选当前数据的最优penalty ，将得到的pen$penalty 定为最终模型的参数</span></p><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>pen &lt;- optimCoxBoostPenalty(training[,<span>'OS.time'</span>],</span></code><code><span>                            training[,<span>'OS'</span>],</span></code><code><span>                            <span>as</span>.matrix(training[,-c(<span>1</span>,<span>2</span>)]),</span></code><code><span>                            trace=<span>TRUE</span>,</span></code><code><span>                            <span>#start.penalty=500,</span></span></code><code><span>                            parallel = T)</span></code><code><span><br></span></code><code><span><span>#&gt; pen$penalty</span></span></code><code><span><span>#[1] 5400</span></span></code></pre></section><h3><span><strong>2，确定最优<span>stepno</span></strong></span></h3><p><span>使用</span><span>cv.CoxBoost函数确定最优</span><span>stepno，取cv.res$optimal.step的值</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span><span>#number of folds to be used for cross-validation</span></span></code><code><span>cv.res &lt;- cv.CoxBoost(training[,<span>'OS.time'</span>],</span></code><code><span>                      training[,<span>'OS'</span>],</span></code><code><span>                      as.matrix(training[,-c(1,2)]),</span></code><code><span>                      maxstepno=500,</span></code><code><span>                      K=5,</span></code><code><span>                      <span>type</span>=<span>"verweij"</span>,</span></code><code><span>                      penalty= pen<span>$penalty</span>,</span></code><code><span>                      multicore=1)</span></code><code><span><br></span></code><code><span><span>#&gt; cv.res$optimal.step</span></span></code><code><span><span>#[1] 86</span></span></code></pre></section><h3><strong><span>3，</span>构建模型</strong></h3><p><span>使用上面得到的参数构建CoxBoost模型</span></p><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="nginx"><code><span><span>fit</span> &lt;- CoxBoost(training[,<span>'OS.time'</span>],</span></code><code><span>                training[,<span>'OS'</span>],</span></code><code><span>                as.matrix(training[,-c(<span>1</span>,<span>2</span>)]),</span></code><code><span>                stepno=cv.res<span>$optimal</span>.step,</span></code><code><span>                penalty=pen<span>$penalty</span>)</span></code><code><span>summary(fit)</span></code><code><span>plot(fit)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="502917895" data-ratio="0.22321428571428573" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjA0BR9o2qv6tTWJNlG0HX5micM6t0A1UoMPfhBoxgqy5qLia01Xt3W6Nhr4GtvHkHTvHGZ8mWxTth3Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="896" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjA0BR9o2qv6tTWJNlG0HX5micM6t0A1UoMPfhBoxgqy5qLia01Xt3W6Nhr4GtvHkHTvHGZ8mWxTth3Q/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-imgfileid="502917893" data-ratio="0.9470198675496688" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjA0BR9o2qv6tTWJNlG0HX5mmBd3ic7IiaFicG6iaz7INicP4qSbHGvYMzeZut5GpeuvFX6tLXJ7aoy3vVg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="755" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjA0BR9o2qv6tTWJNlG0HX5mmBd3ic7IiaFicG6iaz7INicP4qSbHGvYMzeZut5GpeuvFX6tLXJ7aoy3vVg/640?wx_fmt=png&amp;from=appmsg"></p><p><span>可以在summary中复制筛选后的基因，也可以使用以下方式获取</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span>step.logplik&lt;-predict(fit,newdata=as.matrix(training[,-c(1,2)]),</span></code><code><span>                      newtime=training[,<span>'OS.time'</span>],</span></code><code><span>                      newstatus=training[,<span>'OS'</span>],</span></code><code><span>                      at.step=0:69,</span></code><code><span>                      <span>type</span>=<span>"logplik"</span>)</span></code><code><span><br></span></code><code><span><span>print</span>(fit<span>$xnames</span>[fit<span>$coefficients</span>[which.max(step.logplik),]!=0])</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#[1] "CYTL1"    "KIT"      "CCDC8"    "ABCC2"    "IFITM1"   "CRABP2"   "BOK"      "TTYH2"    "CXCL11"  </span></span></code><code><span><span>#[10] "PYROXD2"  "HSPA7"    "MT2A"     "NEAT1"    "DYNLT3"   "MIR4664"  "KIAA0040" "HPDL"     "UBA7"</span></span></code></pre></section><p><span>和summary得到的结果是一样的，这样<span>方便后续函数中自动化的</span><span>变量筛选，验证。</span></span></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><p><span><strong><span>三 CoxBoost模型验证</span></strong> </span></p></section></section></section></section></section><p><br></p><h3></h3><p><span>同样介绍两种预后模型的验证方式：一是筛选变量然后构建COX预后模型，二是直接预测，验证预后效果。<br></span></p><h3><span><strong><span>1，筛选变量构建COX模型</span></strong></span></h3><h3></h3><p><span>直接在矩阵文件中筛选上述的基因，然后构建COX模型，以及后续的一系列分析，参考前面即可。</span></p><p><span><strong>2，直接预测结果预后</strong><br></span></p><p><span>不筛选变量直接预测，直接预测得到Cindex值，这里介绍使用<span><strong>lapply</strong></span>的方式一次得到多个数据集的Cindex结果。</span></p><p><strong><span>当多个数据集，多种构建模型的方法都如下输出时候，就是101组合机器学习的雏形了。</span></strong><span><br></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>val_dd_list &lt;- <span>list</span>(train=training,</span></code><code><span>                    test1=testing)</span></code><code><span>result &lt;- data.frame()</span></code><code><span>set.seed(<span>1234</span>)</span></code><code><span><br></span></code><code><span>rs &lt;- lapply(val_dd_list,<span><span>function</span><span>(x)</span></span>{cbind(x[,<span>1</span>:<span>2</span>],</span></code><code><span>                                           RS=<span>as</span>.numeric(predict(fit,</span></code><code><span>                                                                 newdata=x[,-c(<span>1</span>,<span>2</span>)],</span></code><code><span>                                                                 newtime=x[,<span>1</span>], </span></code><code><span>                                                                 newstatus=x[,<span>2</span>], </span></code><code><span>                                                                 type=<span>"lp"</span>)))})</span></code><code><span><br></span></code><code><span>cc &lt;- data.frame(Cindex=sapply(rs,<span><span>function</span><span>(x)</span></span>{</span></code><code><span>  <span>as</span>.numeric(summary(coxph(Surv(OS.time,OS)~RS,x))$concordance[<span>1</span>])}))%&gt;%</span></code><code><span>  rownames_to_column(<span>'ID'</span>)</span></code><code><span>cc$Model &lt;- paste0(<span>'CoxBoost'</span>)</span></code><code><span>result &lt;- rbind(result,cc)</span></code><code><span><br></span></code><code><span>result</span></code></pre></section><section><ul><li><li><li></ul><pre data-lang="properties"><code><span>     ID    Cindex    Model</span></code><code><span>1 train 0.6987871 CoxBoost</span></code><code><span>2 test1 0.6429533 CoxBoost</span></code></pre></section><p><span>后续还可以做的更多分析这里就不赘述了，参考之前的推文。</span><br></p><p><br></p><p><ne-p data-lake-id="ua3e3f75a"><span><strong><span>参考资料:</span></strong><br></span></ne-p></p><p><span>[1] A machine learning framework develops a DNA replication stress model for predicting clinical outcomes and therapeutic vulnerability in primary prostate cancer</span></p><p><ne-p data-lake-id="ua3e3f75a"><span>[2] <span>Machine learning-based integration develops an immune-derived lncRNA signature for improving outcomes in colorectal cancer</span></span></ne-p></p><section data-style-type="7" data-tools="新媒体排版" data-id="9190"><p><span><span data-txtless="spin" data-txtlessp="120">◆ </span><span>◆ </span><span data-txtless="spin" data-txtlessp="-120">◆  <span data-txtless="spin" data-txtlessp="120">◆ </span><span>◆</span></span></span></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650398215&amp;idx=1&amp;sn=730225fb5ba3a51ceb8df0a531632515&amp;chksm=f01cbce7c76b35f1bebbf327d78a51d859770a46ae1329d362e3b705c4f8765ee2dc461d24dc&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1"><span>精心整理（含图PLUS版）|R语言生信分析，可视化</span></a><span>（R统计，ggplot2绘图，生信图形可视化汇总）</span></p></section><p cid="n94" mdtype="paragraph"><span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650400742&amp;idx=1&amp;sn=dca078db8e6c0c742264dcb0bf56a8e2&amp;chksm=f01c8506c76b0c107782efb89c5f5c0e244a9d664c15ea2b9d16dc70067b7249bd0e7ea9f9ae&amp;scene=21#wechat_redirect" textvalue="RNAseq纯生信挖掘思路分享？不，主要是送你代码！（建议收藏）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">RNAseq纯生信挖掘思路分享？不，主要是送你代码！（建议收藏）</a></span></p><section><mp-common-profile data-pluginname="mpprofile" data-id="MzIyNDI1MzgzOQ==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjCh1HyEjoPcBiaKy86NdKGZtju9o0oDBPicVK0lcoovRfticNuwPSj0Kib8cxqaVfBcTVCDAJ5icptybsg/300?wx_fmt=png&amp;wxfrom=19" data-nickname="生信补给站" data-alias="Bioinfo_R_Python" data-signature="生信，R语言， Python，数据处理、统计检验、模型构建、数据可视化，我输出您输入！" data-from="2" data-is_biz_ban="0" data-origin_num="167" data-isban="0" data-biz_account_status="0" data-index="0"></mp-common-profile></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/jLxIQQ5CLUbPGp4BVbb3Dg",target="_blank" rel="noopener noreferrer">原文链接</a>
