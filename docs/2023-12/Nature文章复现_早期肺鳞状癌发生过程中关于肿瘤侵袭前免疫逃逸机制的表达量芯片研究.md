---
title: "Nature文章复现|早期肺鳞状癌发生过程中关于肿瘤侵袭前免疫逃逸机制的表达量芯片研究"
date: 2023-12-29T13:06:59Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
Nature文章复现|早期肺鳞状癌发生过程中关于肿瘤侵袭前免疫逃逸机制的表达量芯片研究 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">上文见【安捷伦芯片原始数据处理】<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247518532&amp;idx=1&amp;sn=00b2e03f0b62cc461345824b7cc7aa82&amp;scene=21#wechat_redirect" data-linktype="2">安捷伦芯片原始数据处理</a></p><p data-tool="mdnice编辑器">在上文我们已经对芯片原始数据完成了读入</p><p data-tool="mdnice编辑器">现在我们尝试对他的WGCNA和富集分析结果进行复现。</p><h2 data-tool="mdnice编辑器"><span></span><span>载入R包</span></h2><p data-tool="mdnice编辑器">我们先下载需要载入的R包，代码来源于文献提供的代码：</p><p data-tool="mdnice编辑器">GitHub - Precancer/SCC: Immune evasion before tumor invasion in early squamous lung cell carcinogenesis<sup>[1]</sup></p><pre data-tool="mdnice编辑器"><span></span><code><span>## @Author Jennifer Beane, Kahkeshan Hijazi</span><br><span>## Section of Computational Biomedicine, Department of Medicine, Boston University School of Medicine, Boston</span><br><br><span>## 1. Runs mixed-effects model on probes on 9 stages (factor variable)</span><br><span>## 2. Weighted-gene correlation network analysis on the significant genes from step 1</span><br>rm(list=ls())<br>load(<span>'step1-output.Rdata'</span>)<br><br><span>if</span> (!requireNamespace(<span>"BiocManager"</span>, quietly = <span>TRUE</span>))<br>  install.packages(<span>"BiocManager"</span>)<br><span>if</span>(!<span>require</span>(<span>"GO.db"</span>,character.only = <span>TRUE</span>)) {<br>  BiocManager::install(<span>"GO.db"</span>)<br>}<br><span>if</span>(!<span>require</span>(<span>"impute"</span>)) {<br>  BiocManager::install(<span>"impute"</span>)<br>}<br><span>if</span>(!<span>require</span>(<span>"minet"</span>)) {<br>  BiocManager::install(<span>"minet"</span>)<br>}<br><span>if</span>(!<span>require</span>(<span>"org.Hs.eg.db"</span>)) {<br>  BiocManager::install(<span>"org.Hs.eg.db"</span>)<br>}<br><span>if</span>(!<span>require</span>(nlme)) {<br>  install.packages(<span>"nlme"</span>)<br>}<br><span>if</span>(!<span>require</span>(WGCNA)) {<br>  install.packages(<span>"WGCNA"</span>, dep = <span>T</span>)<br>}<br><span>if</span> (!<span>require</span>(<span>"heatmap3"</span>,character.only = <span>TRUE</span>)) {<br>  BiocManager::install(<span>"heatmap3"</span>,dep=<span>TRUE</span>)<br>}<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>数据清洗</span></h2><p data-tool="mdnice编辑器">然后是数据清洗，我们第一步读入的M矩阵只做了预处理，其实没有清洗干净，我们使用小提琴图或箱线图观察单个样本基因总体表达量的分布。</p><pre data-tool="mdnice编辑器"><span></span><code><span>#检查表达矩阵</span><br>dim(dat1)<br>head(dat1)<br>dat1-&gt;data<br><span>library</span>(vioplot)<br><span>library</span>(limma)<br><span>#vioplot(data)</span><br><br><span>#小提琴图显示有7个样品有点问题，看MAplot进行过滤</span><br><span>#MAplot显示为：4，39，43，60，61，62，64</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035619" data-ratio="0.6033057851239669" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibDD0YQwNlpddFHELvybeaLoq9cnwYc4l7XGXBraZjZHUMWRz5akjCkA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="605" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibDD0YQwNlpddFHELvybeaLoq9cnwYc4l7XGXBraZjZHUMWRz5akjCkA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">可以看到有七个样本预处理后Cy5/Cy3比较奇怪，去上文我们质控生成的normalized_MAplot文件夹下面看，</p><p data-tool="mdnice编辑器">下图的右上三个就是异常样本。</p><p data-tool="mdnice编辑器">我们先找到对应小提琴图的七个样本的MAplot，然后清洗掉后作小提琴图，发现方差齐性不佳，因此使用normalizeBetweenArrays进行芯片间标准化，具体代码如下，因篇幅问题图片不过多展示：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100035622" data-ratio="1.3645533141210375" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibfc0tDoJ3K0XtNYE5KsLiaP1ic4ibgt4jw0OuKoJ2kHo0bOaU5aczjZ21Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="694" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibfc0tDoJ3K0XtNYE5KsLiaP1ic4ibgt4jw0OuKoJ2kHo0bOaU5aczjZ21Q/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>#1.尝试使用normalizeBetweenArrays，但是结果不太好，stage5的平均表达量明显高于其他stage</span><br><span>#所以注释掉，使用方法2</span><br><span>#normalizeBetweenArrays(data)-&gt;data</span><br><br><span>#2.干脆去除在小提琴图中异常的样本</span><br><span>#2.1画去除七个样本的小提琴图，因为样本多跑的慢所以我注释掉了</span><br><span>#下面的小提琴图最好自己跑一遍体会数据清洗的过程</span><br><span>#vioplot(data[,-c(4,39,43,60,61,62,64)])</span><br>data[,-c(<span>4</span>,<span>39</span>,<span>43</span>,<span>60</span>,<span>61</span>,<span>62</span>,<span>64</span>)]-&gt;data<br><span>#vioplot(data)</span><br><span>#去除离群样本后，方差齐性扔不佳，芯片间标准化</span><br>normalizeBetweenArrays(data)-&gt;data<br><span>#vioplot(data)</span><br><br><span>#define phenotypic variables</span><br><span>#因为清洗掉了7个样本所以需要从group_list和phe中删去对应的信息</span><br>group_list[-c(<span>4</span>,<span>39</span>,<span>43</span>,<span>60</span>,<span>61</span>,<span>62</span>,<span>64</span>)]-&gt;group_list<br>phe[-c(<span>4</span>,<span>39</span>,<span>43</span>,<span>60</span>,<span>61</span>,<span>62</span>,<span>64</span>),]-&gt;phe<br><br>table(group_list)<br>factor(group_list)-&gt;stage<br>stage&lt;-gsub(<span>"normal normofluorescent"</span>,<span>1</span>,stage)<br>stage&lt;-gsub(<span>"normal hypofluorescent"</span>,<span>2</span>,stage)<br>stage&lt;-gsub(<span>"hyperplasia"</span>,<span>3</span>,stage)<br>stage&lt;-gsub(<span>"metaplasia"</span>,<span>4</span>,stage)<br>stage&lt;-gsub(<span>"mild dysplasia"</span>,<span>5</span>,stage)<br>stage&lt;-gsub(<span>"moderate dysplasia"</span>,<span>6</span>,stage)<br>stage&lt;-gsub(<span>"severe dysplasia"</span>,<span>7</span>,stage)<br>stage&lt;-gsub(<span>"carcinoma in situ"</span>,<span>8</span>,stage)<br>stage&lt;-gsub(<span>"squamous cell carcinoma"</span>,<span>9</span>,stage)<br>stage&lt;-as.factor(stage)<br>table(stage)<br><br>save(data,group_list,phe,file = <span>"step1_washed.RData"</span>)<br></code></pre><p data-tool="mdnice编辑器">清洗后结果：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100035623" data-ratio="0.599009900990099" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibRVjWapm6lZNDWjuWemk6Jn9v7zPw2EMWptom5LiaoKI39JC751eX4jA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="606" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibRVjWapm6lZNDWjuWemk6Jn9v7zPw2EMWptom5LiaoKI39JC751eX4jA/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>差异基因</span></h2><p data-tool="mdnice编辑器">首先我们需要找到用于WGCNA构建基因网络输入的差异基因。</p><p data-tool="mdnice编辑器">其来源通常有：</p><ol data-tool="mdnice编辑器"><li><section><p>方差前5000基因（也可以是四千等其他数量）</p></section></li><li><section><p>差异表达分析得到的上下调基因</p></section></li></ol><p data-tool="mdnice编辑器">而本文使用<strong>「线性混合模型（linear mixed effects model，LMM）」</strong>，辨别出与癌症发生中的九个组织学阶段相关的4700个基因（padjust&lt;0.001），受限于篇幅，本文不多做介绍线性混合模型和wgcna的原理，如读者感兴趣可以在评论区评论，作者会考虑在后续更新中介绍。</p><p data-tool="mdnice编辑器">代码如下：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(stringr)<br><span>#这里是将phe中的性别，年龄，</span><br><span>#组织来源（122个样本来自77个病人，病人个体间的差异也可以考虑进来），吸烟情况（曾经，现在）</span><br><span>#提取出来用于线性混合模型</span><br>gender&lt;-as.factor(phe$pd..gender.ch1.)<br>age&lt;-as.numeric(phe$pd..age.ch1.)<br>pat&lt;-as.factor(phe$pd..patient.ch1.)<br>smoke&lt;-as.factor(phe$pd..smoking.status.ch1.)<br><br><span>#以下代码是文章作者提供的</span><br><span>#而我们没在GEO数据库中找到previous.lung.cancer和批次信息，先注释掉</span><br><span>#p.lc&lt;-as.factor(s$previous.lung.cancer)</span><br><span>#batch&lt;-as.factor(s$Hybridization.day.Run)</span><br><br><br><span>#Run mixed effect model</span><br><span>#线性混合模型，线性混合模型的学习在本文讨论范围之外</span><br><span>#这里大家只需要知道我们在找类似top5000方差和差异表达分析得到的基因，用于后续WGCNA的输入</span><br>res&lt;-c();<br>good.ind&lt;-c();<br><span>for</span>(i <span>in</span> <span>1</span>:nrow(data))  {<br>  <span># y is the expression levels of gene i</span><br>  y &lt;- as.numeric(data[i,])<br>  <span># runs the linear model with patient as the random effect</span><br>  <span>if</span>(class(<span>try</span>( lme(y ~ gender+age+smoke+stage, random = ~<span>1</span>|pat, method=<span>"ML"</span>))) != <span>"try-error"</span>) {<br>    <span>if</span>(class(<span>try</span>( lme(y ~ gender+age+smoke, random = ~<span>1</span>|pat, method=<span>"ML"</span>))) != <span>"try-error"</span>) {<br>      <br>      model1 &lt;- lme(y~ gender+age+smoke+stage, random = ~<span>1</span>|pat, method=<span>"ML"</span>)<br>      <span># runs the baseline model, removing the cancer term that you're interested in</span><br>      model2 &lt;- lme(y ~ gender+age+smoke, random = ~<span>1</span>|pat, method=<span>"ML"</span>)<br>      <span>#跑成功的编号i会存在good.ind里面</span><br>      good.ind&lt;-c(good.ind,i);<br>      <span># save the coefficient (betas) from the full model for the site and cancer terms</span><br>      coefficients &lt;- c(summary(model1)$coefficients$fixed)<br>      <span># save the T Values from the full model for the site and cancer terms</span><br>      tvals &lt;- c(summary(model1)$tTable[,<span>4</span>:<span>5</span>])<br>      <span># calculate the ANOVA model comparison for the cancer term</span><br>      pvals &lt;- anova(model1, model2)$p[<span>2</span>]<br>      next.row &lt;- c(coefficients,tvals,pvals)<br>      res &lt;- rbind(res, next.row)<br>    }<br>  }<br>}<br><br>save(res,good.ind,model1,dat1,file = <span>"LMM_res.RData"</span>)<br><span>#</span><br><br>load(<span>"LMM_res.RData"</span>)<br>load(<span>"step1_washed.RData"</span>)<br><br>colnames(res)&lt;-c(rep(names(summary(model1)$coefficients$fixed),<span>3</span>),<span>"ANOVAp"</span>)<br><span>#取res最后一列ANOVAp做p值矫正</span><br>res.fdr &lt;- p.adjust(res[,dim(res)[<span>2</span>]], method=<span>"fdr"</span>)<br>res &lt;- cbind(res, res.fdr)<br><span>#提取跑成功的good.ind会，从data提取对应行名赋给res</span><br><span>#粗略检查res行数是否与good.ind长度相等</span><br>nrow(res)==length(good.ind)<br><span>#讲表达矩阵的行名既基因名赋给res</span><br>rownames(res)&lt;-rownames(data)[good.ind]<br>write.table(res, <span>"stage_factor.txt"</span>, sep=<span>"\t"</span>)<br><br><span>#提取p校正值显著的</span><br>sig.ind&lt;-which(res[,dim(res)[<span>2</span>]]&lt;<span>0.01</span>)<br>write.table(res[sig.ind,], <span>"stage_factor_fdr001.txt"</span>, sep=<span>"\t"</span>)<br>dim(res[sig.ind,])<br></code></pre><p data-tool="mdnice编辑器">运行的过程中会产生非常多的error，但是并不代表代码运行不成功，它应该是对表达矩阵其中一行的基因失败了了，跑通的结果会存在res里面，good.ind会记录哪些行（基因）跑通了，哪些没跑通。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100035620" data-ratio="0.08294930875576037" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibnC1x8koNfrDPA4qAZyH2QHFnLBPOSHUdy8o2s7xns0iaNOpZYTiaKocA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="868" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibnC1x8koNfrDPA4qAZyH2QHFnLBPOSHUdy8o2s7xns0iaNOpZYTiaKocA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">跑的真的很慢，花了我45min。没有时间的小伙伴用方差前5000的基因来做也是差不多的。</p><h2 data-tool="mdnice编辑器"><span></span><span>WGCNA：</span></h2><p data-tool="mdnice编辑器">软阈值选取，可以看到软阈值计算出来选择6是最佳的</p><pre data-tool="mdnice编辑器"><span></span><code><span>#conduct WGCNA analysis</span><br>allowWGCNAThreads()<br><span>#define input data matrix</span><br>set&lt;-t(data[match(rownames(res)[sig.ind],rownames(data)),])<br><br><span>#Choose a set of soft-thresholding powers</span><br>powers = c(c(<span>1</span>:<span>10</span>), seq(from = <span>12</span>, to=<span>20</span>, by=<span>2</span>))<br><span>#Call the network topology analysis function</span><br><span>#最佳软阈值为6</span><br>sft = pickSoftThreshold(set, powerVector = powers, verbose = <span>5</span>)<br><span>#Plot the results:</span><br>sizeGrWindow(<span>9</span>, <span>5</span>)<br>par(mfrow = c(<span>1</span>,<span>2</span>));<br>cex1 = <span>0.9</span>;<br><br><span># Scale-free topology fit index as a function of the soft-thresholding power</span><br>plot(sft$fitIndices[,<span>1</span>], -sign(sft$fitIndices[,<span>3</span>])*sft$fitIndices[,<span>2</span>],<br>     xlab=<span>"Soft Threshold (power)"</span>,ylab=<span>"Scale Free Topology Model Fit,signed R^2"</span>,type=<span>"n"</span>,<br>     main = paste(<span>"Scale independence"</span>));<br>text(sft$fitIndices[,<span>1</span>], -sign(sft$fitIndices[,<span>3</span>])*sft$fitIndices[,<span>2</span>],<br>     labels=powers,cex=cex1,pos = <span>1</span>,col=<span>"red"</span>);<br>points(sft$fitIndices[,<span>1</span>], <br>       -sign(sft$fitIndices[,<span>3</span>])*sft$fitIndices[,<span>2</span>],<br>       type = <span>"p"</span>,col=<span>"red"</span>)<br>abline(h=-sign(sft$fitIndices[<span>6</span>,<span>3</span>])*sft$fitIndices[<span>6</span>,<span>2</span>],col=<span>"red"</span>)<br><br><span>#this line corresponds to using an R^2 cut-off of h</span><br><span>#Mean connectivity as a function of the soft-thresholding power</span><br>plot(sft$fitIndices[,<span>1</span>], sft$fitIndices[,<span>5</span>],<br>     xlab=<span>"Soft Threshold (power)"</span>,ylab=<span>"Mean Connectivity"</span>, type=<span>"n"</span>,<br>     main = paste(<span>"Mean connectivity"</span>))<br>text(sft$fitIndices[,<span>1</span>], sft$fitIndices[,<span>5</span>], labels=powers, cex=cex1,col=<span>"red"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035621" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibS2dDic76uYG06EhJ6VaAkmM0atWvhIN1ibad0uvdPWGMkmKmXSZGg20Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="480" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibS2dDic76uYG06EhJ6VaAkmM0atWvhIN1ibad0uvdPWGMkmKmXSZGg20Q/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">构建网络与模块识别</p><pre data-tool="mdnice编辑器"><span></span><code><span>#很多包都有cor函数，这里是把WGCNA包的cor函数设为优先级最高的</span><br>cor &lt;- WGCNA::cor<br>net = WGCNA::blockwiseModules(set, power = <span>6</span>, minModuleSize = <span>50</span>,<br>                       reassignThreshold = <span>0</span>, mergeCutHeight = <span>0.3</span>, networkType=<span>"signed"</span>,<br>                       numericLabels = <span>TRUE</span>, pamRespectsDendro = <span>FALSE</span>,<br>                       saveTOMs = <span>TRUE</span>,<br>                       saveTOMFileBase = <span>"TOM"</span>,<br>                       verbose = <span>3</span>)<br><span>#改回去</span><br>cor&lt;-stats::cor<br>MEs &lt;- net$MEs<br>table(net$colors)<br><span>#若遇到以下报错，则说明cor函数没有使用WGCNA包的，</span><br><span>#可能调用了stats包或别的包的cor函数，需要将WGCNA包的cor函数设为优先级最高的</span><br><span>#Error in (new("standardGeneric", .Data = function (x, y = NULL, use = "everything",  : </span><br><span>#参数没有用(weights.x = NULL, weights.y = NULL, cosine = FALSE)</span><br><br><span>###############Make dendogram#####################</span><br><span># open a graphics window</span><br><span>#sizeGrWindow(12, 9)</span><br><span># Convert labels to colors for plotting</span><br>mergedColors = labels2colors(net$colors)<br><span># Plot the dendrogram and the module colors underneath</span><br>plotDendroAndColors(net$dendrograms[[<span>1</span>]], mergedColors[net$blockGenes[[<span>1</span>]]],<br>                    <span>"Module colors"</span>,<br>                    dendroLabels = <span>FALSE</span>, hang = <span>0.03</span>,<br>                    addGuide = <span>TRUE</span>, guideHang = <span>0.05</span>)<br><br><span>#########################</span><br>moduleLabels &lt;- net$colors<br>save(moduleLabels , file = <span>"genesInModule.RData"</span>)<br>moduleColors &lt;- labels2colors(net$colors)<br>MEs &lt;- net$MEs<br><br>table(net$colors)<br>table(mergedColors[net$blockGenes[[<span>1</span>]]])<br><span>#复现：</span><br><span>#0    1    2    3    4    5    6    7 </span><br><span>#101 1251  584  404  259  226  218  200 </span><br><span># black      blue     brown     green      grey       red turquoise    yellow </span><br><span>#200       584       404       226       101       218      1251       259</span><br><span>#文献：</span><br><span>#   0    1    2    3    4    5    6    7 </span><br><span>#  18 2662 1256  280  192  183   79   64 </span><br><br><span>#grey module is the junk module and contains genes that cannot be placed in co-expression modules</span><br><span>#在复现中对应0号模块</span><br><br><span>###see how similar MEs are</span><br>dissimME=(<span>1</span>-t(cor(MEs, method=<span>"p"</span>)))/<span>2</span><br>hclustdatME=hclust(as.dist(dissimME), method=<span>"average"</span> )<br><span># Plot the eigengene dendrogram</span><br>par(mfrow=c(<span>1</span>,<span>1</span>))<br>plot(hclustdatME, main=<span>"Clustering tree based of the module eigengenes"</span>)<br></code></pre><p data-tool="mdnice编辑器">层次聚类树，下面的颜色条代表识别到的不同模块，灰色为不在模块里的基因</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100035626" data-ratio="0.7129629629629629" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibk7BcdmQNZqWsYzjEeBQ7QCpHsQw0jcWBtNbkYibPiaAvTXcHicYxBhbPw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibk7BcdmQNZqWsYzjEeBQ7QCpHsQw0jcWBtNbkYibPiaAvTXcHicYxBhbPw/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>可视化：</span></h2><p data-tool="mdnice编辑器">我们要复现的是这篇文章figure2的图b，文章通过上述代码流程识别到模块之后，使用mSigDB数据库的cancer hallmarks进行富集分析。构建了癌症hallmarker的时间顺序。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100035627" data-ratio="2.3138297872340425" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibEzgcXeLwRibWWfZQDBRDicHqgQwmkC797fXzCrLCpZqlyx6WkwbadP9w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="376" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibEzgcXeLwRibWWfZQDBRDicHqgQwmkC797fXzCrLCpZqlyx6WkwbadP9w/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100035628" data-ratio="0.9215442092154421" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib7uMhicYjRvthtsAsjGx7OpdzdOg3Vsk0b02gwMb7Ipp3p47IepwfShg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="803" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib7uMhicYjRvthtsAsjGx7OpdzdOg3Vsk0b02gwMb7Ipp3p47IepwfShg/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>load(<span>"genesInModule.RData"</span>)<br>load(<span>'step1_washed.Rdata'</span>)<br>table(moduleLabels)<br>moduleLabels-&gt;m<br>m[names(m)!=<span>""</span>]-&gt;m<br><br>factor(group_list)-&gt;stage<br>stage&lt;-gsub(<span>"normal normofluorescent"</span>,<span>1</span>,stage)<br>stage&lt;-gsub(<span>"normal hypofluorescent"</span>,<span>2</span>,stage)<br>stage&lt;-gsub(<span>"hyperplasia"</span>,<span>3</span>,stage)<br>stage&lt;-gsub(<span>"metaplasia"</span>,<span>4</span>,stage)<br>stage&lt;-gsub(<span>"mild dysplasia"</span>,<span>5</span>,stage)<br>stage&lt;-gsub(<span>"moderate dysplasia"</span>,<span>6</span>,stage)<br>stage&lt;-gsub(<span>"severe dysplasia"</span>,<span>7</span>,stage)<br>stage&lt;-gsub(<span>"carcinoma in situ"</span>,<span>8</span>,stage)<br>stage&lt;-gsub(<span>"squamous cell carcinoma"</span>,<span>9</span>,stage)<br>stage&lt;-as.numeric(stage)<br>table(stage)<br><br><br><span>#每个模块循环画一次图</span><br><span>#这里mSigdb_enrich_function.R脚本的内容在推文最后</span><br><span>source</span>(<span>"mSigdb_enrich_function.R"</span>)<br><span>library</span>(ggplot2)<br>table(m)<br><span>for</span>(i <span>in</span> <span>1</span>:<span>7</span>){<br>  data[names(m[m==i]),]-&gt;exp<br>  <span>#模块内基因平均表达量</span><br>  apply(exp, <span>2</span>, mean)-&gt;module_mean_exp<br>  data.frame()-&gt;plotdf<br>  <span>for</span> (j <span>in</span> <span>1</span>:<span>9</span>) {<br>    <span>if</span>(j==<span>1</span>) {<br>      c(mean(module_mean_exp[stage==j]),j)-&gt;plotdf<br>      as.data.frame(plotdf)-&gt;plotdf<br>      t(plotdf)-&gt;plotdf<br>      }<br>    <span>else</span> {<br>      c(mean(module_mean_exp[stage==j]),j)-&gt;mergedf<br>      as.data.frame(mergedf)-&gt;mergedf<br>      t(mergedf)-&gt;mergedf<br>      rbind(plotdf,mergedf)-&gt;plotdf<br>    }<br>  }<br>  <span>#可视化</span><br>  <span>#构建画图用的数据框</span><br>  plotdf&lt;-as.data.frame(plotdf)<br>  colnames(plotdf)&lt;-c(<span>"exp"</span>,<span>"stage"</span>)<br>  plotdf$color&lt;-c(<span>"A"</span>,<span>"A"</span>,<span>"A"</span>,<span>"B"</span>,<span>"B"</span>,<span>"B"</span>,<span>"C"</span>,<span>"C"</span>,<span>"D"</span>)<br>  <span>#绘制点线图</span><br>  p&lt;-ggplot(data=plotdf, mapping=aes(x=stage, y=exp)) +<br>    geom_line(linetype=<span>"solid"</span>, color=<span>"black"</span>, size=<span>1</span>) +<br>    geom_point(mapping=aes(colour = color ), size=<span>10</span> ) +<br>    geom_point(color=<span>"black"</span>, size=<span>8</span> ,shape = <span>1</span> ) +<br>    ggtitle(paste(<span>"n="</span>,nrow(exp)))+<br>    xlab(<span>""</span>)+<br>    ylab(<span>""</span>)+<br>    theme_classic(base_line_size = <span>1</span>)+<br>    theme(axis.text.y =element_text(size=<span>15</span>),<br>          axis.title.x = element_blank(),<br>          axis.text.x = element_blank(),<br>          axis.ticks.x = element_blank(),<br>          plot.title = element_text(hjust = <span>0.5</span>,size = <span>20</span>))+<br>    theme(legend.position = <span>"none"</span>)<br>  assign(paste0(<span>"p"</span>,i),p)<br>  <span>#富集分析</span><br>  <span>library</span>(org.Hs.eg.db)<br>  <span>#自己造的轮子做富集，函数记录在mSigdb_enrich_function.R脚本中</span><br>  res&lt;-mSigdb_enrich(rownames(exp),padjust_cutoff = <span>0.05</span>)<br>  <span>library</span>(stringr)<br>  str_replace_all(str_replace(rownames(res),<span>"HALLMARK_"</span>,<span>""</span>),<span>"_"</span>,<span>" "</span>)-&gt;res$Term<br>  <span>#按p.adjust升序排列</span><br>  res[order(res$p_padj,decreasing = <span>T</span>),]-&gt;res<br>  <span>#可视化条形图</span><br>  <span>#gsub函数的内容用于将y轴的坐标标签每隔一个空格换行一次，是我个人喜欢的绘图代码，可以直接用Term画图</span><br>  e&lt;-ggplot(res,aes(x = reorder(gsub(<span>"(([^[:space:]]+[[:space:]]+){1}[^[:space:]]+)[[:space:]]+"</span>, <span>"\\1\n"</span>, Term),order(p_padj, decreasing = <span>T</span>)),<br>                    y = -log10(p_padj),<br>                    fill = Rich_Factor))+<br>    geom_col(position = position_dodge(width = <span>0.1</span>),width = <span>0.5</span>)+<br>    coord_flip() +<br>    xlab(<span>""</span>)+<br>    scale_x_discrete(position = <span>"top"</span>)+<br>    ylab(<span>""</span>)+<br>    theme_classic(base_line_size = <span>1</span>)+<br>    theme(axis.text.x =element_text(size=<span>15</span>),<br>          axis.text.y =element_text(size=<span>15</span>),<br>          axis.title.x = element_blank(),<br>          axis.ticks.y = element_blank())<br>  assign(paste0(<span>"e"</span>,i),e)<br>  <span>#保存富集分析结果</span><br>  write.csv(res,file=paste0(<span>"mSigdb_ora_Enrich_"</span>,i,<span>".csv"</span>))<br>  <br>  <span>#保存图片</span><br>  ggsave(p,filename = paste0(i,<span>"_dotplot.png"</span>),width = <span>10</span>,height = <span>5</span>)<br>  ggsave(e,filename = paste0(i,<span>"_barplot.png"</span>))<br>}<br><br><span>#拼图</span><br><span>library</span>(patchwork)<br>p1+e1+p2+e2+p3+e3+p4+e4+p5+e5+p6+e6+p7+e7+<br>  plot_layout(widths = c(<span>3</span>, <span>1</span>))-&gt;P<br>ggsave(P,filename = <span>"summary.pdf"</span>,height = <span>40</span>,width = <span>15</span>)<br></code></pre><p data-tool="mdnice编辑器">结果如下，在原文献中stage5也有点奇怪，其他8个stage的趋势是比较符合他的生物学故事的。</p><p data-tool="mdnice编辑器">且富集到的通路都能对应上，就是图顺序乱了，不影响解读：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100035625" data-ratio="2.7210031347962382" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib6MlWHZnMPaH690KwqzeFhnyW0x5gickstc8sFPkv02xNgu7In3Wia8bw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="319" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib6MlWHZnMPaH690KwqzeFhnyW0x5gickstc8sFPkv02xNgu7In3Wia8bw/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>附注</span></h2><p data-tool="mdnice编辑器">附：mSigdb_enrich_function.R脚本内容，是我自己简单造的一个用于mSigDB数据库富集分析的轮子，用了顾叔的提速富集分析代码：</p><p data-tool="mdnice编辑器">【提速ORA富集分析20倍】<a href="https://mp.weixin.qq.com/s?__biz=Mzg4MjUzODM4Ng==&amp;mid=2247484287&amp;idx=1&amp;sn=2c8cc00888c559403f7ecabc298b6ef9&amp;scene=21#wechat_redirect" data-linktype="2">提速ORA富集分析20倍</a></p><pre data-tool="mdnice编辑器"><span></span><code><span>#mSigDB数据库ORA富集分析函数 enrichment function written by Xiao Chen</span><br><br><span>#输入为ENTREZID，通路中默认最少要包含10个基因，物种默认为人类</span><br><span>#p值校正方法BH法，结果显示阈值：p值小于0.05，padjust结果显示阈值为空</span><br>mSigdb_enrich&lt;-<span>function</span>(gene,min_gene=<span>5</span>,org=<span>"org.Hs.eg.db"</span>,method=<span>"BH"</span>,<br>                 pvalue_cutoff=<span>0.05</span>,padjust_cutoff=<span>NULL</span>){<br>  <span>library</span>(AnnotationDbi)<br>  <span>library</span>(msigdbr)<br>  <br>  df&lt;-msigdbr(species = <span>"Homo sapiens"</span>, category = <span>"H"</span>, subcategory = <span>NULL</span>)<br>  df[,c(<span>"gs_name"</span>,<span>"gene_symbol"</span>,<span>"entrez_gene"</span>,<span>"ensembl_gene"</span>)]-&gt;gs2id<br>  <br>  <span>#生成一个列表geneIngs，下面每个元素名字为基因集名，内容为包含基因</span><br>  names(table(gs2id$gs_name))-&gt;gsname<br>  list()-&gt;geneIngs<br>  <span>for</span>(i <span>in</span> <span>1</span>:length(table(gs2id$gs_name))){<br>    as.vector(gs2id[gs2id$gs_name==gsname[i],<span>"gene_symbol"</span>])-&gt;geneIngs[i]<br>    names(geneIngs)[i]&lt;-gsname[i]<br>  }<br>  universe&lt;-df$gene_symbol[!duplicated(df$gene_symbol)]<br>  <br>  <span>library</span>(Rcpp)<br>  sourceCpp(code = <span>'<br>// [[Rcpp::plugins(cpp11)]]<br><br>#include &lt;Rcpp.h&gt;<br>#include &lt;unordered_set&gt;<br>using namespace Rcpp;<br><br>// [[Rcpp::export]]<br>List intersectToList(List lt, StringVector x) {<br><br>    int n = lt.size();<br>    List out(n);<br><br>    std::unordered_set&lt;String&gt; seen;<br>    seen.insert(x.begin(), x.end());<br><br>    for(int i = 0; i &lt; n; i++) {<br><br>        StringVector v = as&lt;StringVector&gt;(lt[i]);<br>        LogicalVector l(v.size());<br><br>        std::unordered_set&lt;String&gt; seen2;<br><br>        for(int j = 0; j &lt; v.size(); j ++) {<br>            l[j] = seen.find(v[j]) != seen.end() &amp;&amp; seen2.insert(v[j]).second;<br>        }<br><br>        out[i] = v[l];<br>    }<br><br>    return out;<br>}<br>'</span>)<br>  <br>  ora_v3 = <span>function</span>(genes, gene_sets, universe ,symbol ,min_gene ,<br>                    method ,pvalue, padjust) {<br>    <br>    <span>#基因集的名字</span><br>    gs_names = names(gene_sets)<br>    <span>#universe中包含mSigdb hallmarker中的所有基因</span><br>    genes = intersect(genes, universe)<br>    <span>#函数intersectToList()可以在R中使用。它接受两个参数。</span><br>    <span>#第一个是一个包含了若干向量的列表（lt），第二个参数是一个向量（x）。</span><br>    <span>#其中x会和lt中的每一个向量进行intersection。在Cpp代码中，我也去掉了lt中每一个向量中重复的元素。</span><br>    n_universe = length(universe)<br>    n_genes = length(genes)<br>    <br>    <span>#对基因集列表每一个子列表进行循环，判断基因是否在通路中</span><br>    genes_in_set&lt;-intersectToList(gene_sets, genes)<br>    <span>#每个通路中富集到基因的数量</span><br>    x = sapply(genes_in_set, length)<br>    <span>#要求最少富集到min_gene个基因</span><br>    x&gt;=min_gene -&gt; keep<br>    gene_sets[keep]-&gt;gene_sets<br>    genes_in_set[keep]-&gt;genes_in_set<br>    x = x[keep]<br>    <span>#基因集中总的基因数量</span><br>    m = sapply(gene_sets, length)<br>    <span>#GeneRatio:x/k,BgRatio:m/n_universe</span><br>    n = n_universe - m<br>    <span>#差异表达基因数量</span><br>    k = n_genes<br>    <br>    GeneRatio = paste(x,k,sep=<span>"/"</span>)<br>    BgRatio = paste(m,n_universe,sep=<span>"/"</span>)<br>    Fold_Enrichment=(x*n_universe)/(k*m)<br>    Rich_Factor=x/k<br>    <br>    <span>#可以尝试下不用phyer函数，自己写</span><br>    p = phyper(x - <span>1</span>, m, n, k, lower.tail = <span>FALSE</span>)<br>    <span>#可以自己写BH法的p.adjust</span><br>    p_padj &lt;- p.adjust(p, method = method)<br>    <br>    <br>    output&lt;-data.frame(GeneRatio=GeneRatio,BgRatio=BgRatio,<br>                       count=x,pvalue=p,p_padj=p_padj,<br>                       Fold_Enrichment=Fold_Enrichment,Rich_Factor=Rich_Factor)<br>    rownames(output)&lt;-gs_names[keep]<br>    <br>    <span>if</span>(is.null(padjust)){<br>      output[output$pvalue &lt; pvalue,]-&gt;output<br>    }<br>    <span>else</span>{<br>      output[output$pvalue &lt; padjust,]-&gt;output<br>    }<br>    <br>    <span>return</span>(output)<br>  }<br>  <br>    Res&lt;-ora_v3(gene,geneIngs,universe,<br>                symbol=symbol ,min_gene=min_gene ,method=method,<br>                pvalue=pvalue_cutoff, padjust=padjust_cutoff)<br>  <span>return</span>(Res)<br>}<br></code></pre><h3 data-tool="mdnice编辑器"><span>Reference</span></h3><section data-tool="mdnice编辑器"><span><span>[1] </span><p>GitHub - Precancer/SCC: Immune evasion before tumor invasion in early squamous lung cell carcinogenesis: <span>https://github.com/Precancer/SCC</span></p></span></section></section><p><br></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h4 data-tool="mdnice编辑器">文末友情宣传</h4><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526014&amp;idx=1&amp;sn=44afb387fc49b89276386e5182db7bc9&amp;chksm=9b4b26c5ac3cafd35616b2fe9df7fea664e59d75e9970feb322a477beb222ac023f7daebb3dc&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买一得‍五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">时隔5年，我们的生信技能树VIP学徒继续招生啦</a><br></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247525661&amp;idx=2&amp;sn=a0662fa3a9ebc7c840d45049eaca2c8c&amp;chksm=9b4b25a6ac3cacb0e9ba90eeb97452a9ee4eaed6bbbab1133f7a4836631047451c0cf295c93b&amp;scene=21#wechat_redirect" textvalue="搭配GPU服务再升级—256线程2Tb内存服务器共享一年仍然是仅需800" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">搭配GPU服务再升级—256线程2Tb内存服务器共享一年仍然是仅需800</a></section></li></ul></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/wRQuu8fXOrUEq6D3UPhAYQ",target="_blank" rel="noopener noreferrer">原文链接</a>
