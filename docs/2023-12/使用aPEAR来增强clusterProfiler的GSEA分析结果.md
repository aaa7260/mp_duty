---
title: "使用aPEAR来增强clusterProfiler的GSEA分析结果"
date: 2023-12-28T02:10:28Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
使用aPEAR来增强clusterProfiler的GSEA分析结果 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>前些天我在 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526714&amp;idx=1&amp;sn=aba39bc658288a9f607b13bfdf0a0346&amp;scene=21#wechat_redirect" data-linktype="2">生物学功能注释三板斧</a>，提到了简单的超几何分布检验，复杂一点可以是gsea和gsva，更复杂一点的可以是DoRothEA和PROGENy类似的打分。 </p></blockquote><p data-tool="mdnice编辑器">其中 GO（Gene Ontology）和KEGG（Kyoto Encyclopedia of Genes and Genomes）数据库是两个常用的生物学功能注释数据库，但是GO数据库 注释通常包括三个方面的信息：分子功能（Molecular Function）、细胞组分（Cellular Component）和生物过程（Biological Process）。而前面我们演示了：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527022&amp;idx=1&amp;sn=93fc5b2ab8c7c0b38c8d18b941201eb6&amp;scene=21#wechat_redirect" data-linktype="2">使用topGO增强你的GO数据库注释结果的可视化</a>，是超几何分布检验的结果的可视化，主要是展示GO数据库的有向无环图结构。接下来我们聊聊使用clusterProfiler的GSEA方法针对GO数据库进行注释后的结果的可视化，所以是需要大家自己提前弄清楚GSEA方法和超几何分布检验方法的区别哦！</p><h4 data-tool="mdnice编辑器"><span></span>首先是简单的转录组差异分析<span></span></h4><p data-tool="mdnice编辑器">首先我们获取airway这个包里面的airway表达量矩阵，它有8个样品，分成了两组，我们命名为'control','case' ，如下所示代码：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(data.table)<br><span>library</span>(airway,quietly = <span>T</span>)<br>data(airway) <br>mat &lt;- assay(airway)  <br>keep_feature &lt;- rowSums (mat &gt; <span>1</span>) &gt; <span>1</span> <br>ensembl_matrix &lt;- mat[keep_feature, ]  <br><span>library</span>(AnnoProbe) <br>ids=annoGene(rownames(ensembl_matrix),<span>'ENSEMBL'</span>,<span>'human'</span>) <br>ids=ids[!duplicated(ids$SYMBOL),]<br>ids=ids[!duplicated(ids$ENSEMBL),]<br>symbol_matrix= ensembl_matrix[match(ids$ENSEMBL,rownames(ensembl_matrix)),] <br>rownames(symbol_matrix) = ids$SYMBOL <br>group_list = as.character(airway@colData$dex);group_list<br>group_list=ifelse(group_list==<span>'untrt'</span>,<span>'control'</span>,<span>'case'</span> ) <br>group_list = factor(group_list,levels = c(<span>'control'</span>,<span>'case'</span> ))  <br></code></pre><p data-tool="mdnice编辑器">然后针对上面的airway这个包里面的airway表达量矩阵，是一个简单的转录组测序后的count矩阵，可以走DESeq2进行转录组差异分析，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>(colData &lt;- data.frame(row.names=colnames(symbol_matrix), <br>                       group_list=group_list) )<br>dds &lt;- DESeqDataSetFromMatrix(countData = symbol_matrix,<br>                              colData = colData,<br>                              design = ~ group_list)<br>dds &lt;- DESeq(dds) <br>res &lt;- results(dds, <br>               contrast=c(<span>"group_list"</span>,<br>                          levels(group_list)[<span>2</span>],<br>                          levels(group_list)[<span>1</span>]))<br>resOrdered &lt;- res[order(res$padj),] <br>DEG =as.data.frame(resOrdered)<br>DEG_deseq2 = na.omit(DEG)<br></code></pre><p data-tool="mdnice编辑器">差异分析的结果矩阵比较简单：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; head(DEG_deseq2)  <br>          baseMean log2FoldChange      lfcSE     <span>stat</span>        pvalue          padj<br>SPARCL1   997.2841       4.601648 0.21173761 21.73278 1.005191e-104 1.751345e-100<br>STOM    11193.6206       1.450654 0.08458760 17.14973  6.314974e-66  5.501289e-62<br>PER1      776.4988       3.183045 0.20133158 15.80996  2.656240e-56  1.542656e-52<br>PHC2     2738.0273       1.386358 0.09161873 15.13182  9.988847e-52  4.350892e-48<br>MT2A     3656.0130       2.202678 0.14718400 14.96547  1.234488e-50  4.301697e-47<br>DUSP1    3408.8006       2.948154 0.20174509 14.61326  2.311720e-48  6.712850e-45<br></code></pre><p data-tool="mdnice编辑器">上面的这些列的简要介绍在前面演示的有：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527022&amp;idx=1&amp;sn=93fc5b2ab8c7c0b38c8d18b941201eb6&amp;scene=21#wechat_redirect" data-linktype="2">使用topGO增强你的GO数据库注释结果的可视化</a></p><h4 data-tool="mdnice编辑器"><span></span>然后使用clusterProfiler的GSEA方法针对GO数据库进行注释<span></span></h4><p data-tool="mdnice编辑器">前面的DESeq2进行转录组差异分析后的表格里面有两万多个基因，需要对它们根据里面的log2FoldChange对基因排序后的<strong>全部的基因的列表</strong>，而前面我们演示了：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527022&amp;idx=1&amp;sn=93fc5b2ab8c7c0b38c8d18b941201eb6&amp;scene=21#wechat_redirect" data-linktype="2">使用topGO增强你的GO数据库注释结果的可视化</a>，是超几何分布检验的结果的可视化只需要统计学<strong>显著的上下调的几百个基因</strong>即可。</p><p data-tool="mdnice编辑器">代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>nrDEG=DEG_deseq2[,c(<span>"log2FoldChange"</span>,   <span>"padj"</span>)] <br>colnames(nrDEG)=c(<span>'logFC'</span>,<span>'P.Value'</span>)<br><span>library</span>(org.Hs.eg.db)<br><span>library</span>(clusterProfiler)<br>gene &lt;- bitr(rownames(nrDEG), fromType = <span>"SYMBOL"</span>,<br>             toType =  <span>"ENTREZID"</span>,<br>             OrgDb = org.Hs.eg.db) <br>nrDEG = nrDEG[rownames(nrDEG) %<span>in</span>% gene$SYMBOL,]<br>nrDEG$ENTREZID = gene$ENTREZID[match(rownames(nrDEG) , gene$SYMBOL)]<br><span># https://www.ncbi.nlm.nih.gov/gene/?term=SPARCL1</span><br>geneList=nrDEG$logFC<br>names(geneList)=nrDEG$ENTREZID<br>geneList=sort(geneList,decreasing = <span>T</span>)<br>head(geneList)<br>go_BP_enrich &lt;- gseGO(geneList, OrgDb = org.Hs.eg.db, ont = <span>'BP'</span>)<br>head(go_BP_enrich@result)<br></code></pre><p data-tool="mdnice编辑器">产生的结果也是非常复杂，如下所示 ：</p><p><img data-galleryid="" data-ratio="0.3708609271523179" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwDhUatIZLtuYIEJiaOE5Yaicib8dqGXzlqrfdWOlOQFL5wH065apjrb2ev8PcrFfibsmliaYb4kwMJLAg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2114" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwDhUatIZLtuYIEJiaOE5Yaicib8dqGXzlqrfdWOlOQFL5wH065apjrb2ev8PcrFfibsmliaYb4kwMJLAg/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>GSEA方法针对GO数据库结果</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>默认的可视化<span></span></h4><p data-tool="mdnice编辑器">可以是针对具体的每个通路进行gsea可视化，如下所示代码：</p><pre data-tool="mdnice编辑器"><span></span><code>enrichplot::gseaplot2( go_BP_enrich, geneSetID = go_BP_enrich@result[1,1],  pvalue_table =T)<br></code></pre><p data-tool="mdnice编辑器">效果如下所示：</p><p><img data-galleryid="" data-ratio="0.5844298245614035" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwDhUatIZLtuYIEJiaOE5YaicVlKzbAb5uk2daP94LRa7UQHETwzjEtjp8DwtwUBRycGjk2F46xqM0g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1824" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwDhUatIZLtuYIEJiaOE5YaicVlKzbAb5uk2daP94LRa7UQHETwzjEtjp8DwtwUBRycGjk2F46xqM0g/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>具体的通路进行gsea可视化</figcaption></figure><p data-tool="mdnice编辑器">也可以是汇总这个GO数据库进行注释结果表格后展现其上下调的最显著的通路，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#～～～取前6个上调通路和6个下调通路～～～</span><br>kk=go_BP_enrich<br>up_k &lt;- kk[head(order(kk$enrichmentScore,decreasing = <span>T</span>)),];up_k$group=<span>1</span><br>down_k &lt;- kk[tail(order(kk$enrichmentScore,decreasing = <span>T</span>)),];down_k$group=-<span>1</span><br><br>dat=rbind(up_k,down_k)<br>colnames(dat)<br>dat$pvalue = -log10(dat$pvalue)<br>dat$pvalue=dat$pvalue*dat$group <br>dat=dat[order(dat$pvalue,decreasing = <span>F</span>),]<br><br>p7 &lt;- ggplot(dat, aes(x=reorder(Description,order(pvalue, decreasing = <span>F</span>)), y=pvalue, fill=group)) + <br>  geom_bar(stat=<span>"identity"</span>) + <br>  scale_fill_gradient(low=<span>"#34bfb5"</span>,high=<span>"#ff6633"</span>,guide = <span>FALSE</span>) + <br>  scale_x_discrete(name =<span>"Pathway names"</span>) +<br>  scale_y_continuous(name =<span>"log10P-value"</span>) +<br>  coord_flip() + <br>  theme_ggstatsplot()+<br>  theme(plot.title = element_text(size = <span>15</span>,hjust = <span>0.5</span>),  <br>        axis.text = element_text(size = <span>12</span>,face = <span>'bold'</span>),<br>        panel.grid = element_blank())+<br>  ggtitle(<span>"Pathway Enrichment"</span>) <br>p7<br><br></code></pre><p data-tool="mdnice编辑器">如下所示：</p><p><img data-galleryid="" data-ratio="0.5988888888888889" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwDhUatIZLtuYIEJiaOE5YaicuWmCMt99oFziaMvBMichMtedaib8fnzFbTMAf9JL6ol12O9DTCib8xpeicA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1800" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwDhUatIZLtuYIEJiaOE5YaicuWmCMt99oFziaMvBMichMtedaib8fnzFbTMAf9JL6ol12O9DTCib8xpeicA/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>前6个上调通路和6个下调通路～</figcaption></figure><p data-tool="mdnice编辑器">可以看到，使用clusterProfiler的GSEA方法针对GO数据库进行注释，和前面的 ：使用topGO增强你的GO数据库注释结果的可视化，是超几何分布检验的结果，差异很多哦！</p><h4 data-tool="mdnice编辑器"><span></span>最后使用aPEAR来增强<span></span></h4><p data-tool="mdnice编辑器">同样的，也是一行代码：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#install.packages("aPEAR") </span><br><span>library</span>(aPEAR)<br>enrichmentNetwork(go_BP_enrich@result)<br></code></pre><p data-tool="mdnice编辑器">可以看到，确实是效果不一样了，这也就是为什么网络可视化非常受大家欢迎。</p><p><img data-galleryid="" data-ratio="0.6564580559254327" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwDhUatIZLtuYIEJiaOE5YaiczjspeybGE220PSXhB7k1N7ndkFicqj2Ym6J5zb2XTuO9IvVPx2RvgTw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1502" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwDhUatIZLtuYIEJiaOE5YaiczjspeybGE220PSXhB7k1N7ndkFicqj2Ym6J5zb2XTuO9IvVPx2RvgTw/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>enrichmentNetwork的效果</figcaption></figure><p data-tool="mdnice编辑器">当然了，这个包（aPEAR）肯定是不会就这一个 enrichmentNetwork 函数，更多好玩的用法和参数，可以看官方文档：</p><ul data-tool="mdnice编辑器"><li><section>https://github.com/kerseviciute/aPEAR</section></li><li><section>aPEAR: an R package for enrichment network visualisation</section></li><li><section>aPEAR: an R package for autonomous visualisation of pathway enrichment networks. BioRxiv. 2023 Mar 29; doi: 10.1101/2023.03.28.534514</section></li></ul></section><h4 data-tool="mdnice编辑器">文末友情宣传</h4><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526646&amp;idx=1&amp;sn=d1728d9102f72d2ce5c425162549499d&amp;chksm=9b4b284dac3ca15b83972f3dcb45977fc78eb65b607e7961658f8586f8a4b7be2c2c43883684&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授‍课（买一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">时隔5年，我们的生信技能树VIP学徒继续招生啦</a><br></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247522831&amp;idx=2&amp;sn=1744efdf428465425a145ff3a982198b&amp;chksm=9b4bdab4ac3c53a28fbecbbff4f254f470b54a7a20468bb753b295b930315e1ec45bcbabc10b&amp;scene=21#wechat_redirect" textvalue="144线程640Gb内存服务器共享一年‍仍然是仅需800" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">144线程640Gb内存服务器共享一年仍然是仅需800</a></section></li></ul><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/q5KHfQv3LoJupAX4TCiZfQ",target="_blank" rel="noopener noreferrer">原文链接</a>
