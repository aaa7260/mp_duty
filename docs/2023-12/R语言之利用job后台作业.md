---
title: "R语言之利用job后台作业"
date: 2023-12-28T01:52:35Z
draft: ["false"]
tags: [
  "fetched",
  "学R时习之"
]
categories: ["Acdemic"]
---
R语言之利用job后台作业 by 学R时习之
------
<div><p><span>用R分析数据时，有些代码跑的时间比较久，长时间占用控制台，常规情况下可以凑这个时间摸摸鱼啥的……</span><ne-clipboard source="https%3A%2F%2Fwww.yuque.com%2Fgaodashitou%2Ffra44d%2Ftlchb4ch1wa3ve17"></ne-clipboard></p><p><span>但是光这样等着也不是事吧，是不是有什么方法把这个任务放到后台（Linux有</span><code><span><strong><span>nohup [command] &amp;</span></strong></span></code><span>。是否R里面也有呢？</span></p><p><code><span><strong><span>nohup</span></strong></span></code><span>: no hang up的缩写, 不挂断的运行命令。</span></p><p><code><span><strong><span>&amp;</span></strong></span></code><span>: 在后台运行，当用户退出（挂起）的时候，命令自动跟着结束。</span></p><p><span>通常</span><code><span><strong><span>nohup</span></strong></span></code><span>和</span><code><span><strong><span>&amp;</span></strong></span></code><span>结合使用，让命令在后台长期运行。</span></p><p><span>TLDR: 学习下</span><code><span>job::job({&lt;your code&gt;})</span></code><span>神仙函数。</span></p><h2><span>job包简介</span></h2><h1></h1><p>先来看看<code>job</code>包的功能👉🏻解放你的Rstudio控制台。</p><p>通过<code>job::job()</code>在Rstudio的<code>Background Jobs</code>运行代码块，即在后台运行代码块，从而解放控制台。</p><p><img data-imgfileid="100002567" data-ratio="0.2759259259259259" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrMGRp3j8icdgMzor42AjCBsd53dACAgicTFsc7MiaoYdJOeMz2e86S7OGw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="870" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrMGRp3j8icdgMzor42AjCBsd53dACAgicTFsc7MiaoYdJOeMz2e86S7OGw/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100002563" data-ratio="0.35" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrYibJtibIXcWXGcZLlwnf23UT7AZQ29FuGHupvfmAyY1IXxdc82NPe0lQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="800" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrYibJtibIXcWXGcZLlwnf23UT7AZQ29FuGHupvfmAyY1IXxdc82NPe0lQ/640?wx_fmt=png&amp;from=appmsg"></p><h2><span>Minimal example</span></h2><p><code>job::job()</code>的格式是<code>job::job({your code})</code>，所以咱们只需要把代码用<code>job::job({})</code>包装下即可。</p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code>job::job({<br>  foo = 10<br>  bar = rnorm(5)<br>})<span></span></code></pre></section><p><img data-imgfileid="100002564" data-ratio="0.20462962962962963" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrtLWiaeDvWnc3ibjibzziaFdqvGqczub7VnWtLpnxeM9LgCOdUVIlABkeAA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="1384" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrtLWiaeDvWnc3ibjibzziaFdqvGqczub7VnWtLpnxeM9LgCOdUVIlABkeAA/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100002565" data-ratio="0.2111111111111111" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrzJO1vjyBNr5J0obqBaQ9NnF4sEZgDSG4KicyxlicicOicfnDUyQtVM8gLw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="1355" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrzJO1vjyBNr5J0obqBaQ9NnF4sEZgDSG4KicyxlicicOicfnDUyQtVM8gLw/640?wx_fmt=png&amp;from=appmsg"></p><h2><span>Typical usuage</span></h2><p>下面展示<code>job::job()</code>的经典用法，以<code>brms</code>为例。</p><p>brms: Bayesian Regression Models using 'Stan', 使用stan实现贝叶斯多级模型。</p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>librarian::shelf(brms)<br><br>data = mtcars[mtcars<span>$hp</span> &gt; 100, ]<br>model1 = mpg ~ hp * wt<br>model2 = mpg ~ hp + wt<br><br>job::job({<br>  fit1 = brm(model1, data)<br>})<br>job::job({<br>  fit2 = brm(model2, data)<br>})<span></span></code></pre></section><p><img data-imgfileid="100002566" data-ratio="0.26944444444444443" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrGrmupbhhtxXAFKjiclx3QszKRo6NkosicHYOJXOKNibfWH1iajz51lDQeQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="1268" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrGrmupbhhtxXAFKjiclx3QszKRo6NkosicHYOJXOKNibfWH1iajz51lDQeQ/640?wx_fmt=png&amp;from=appmsg"></p><h2><span>Tweak your jobs</span></h2><p>上面是经典的用法，下面给要运行的代码块起个名字。</p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code><span># Name the code block to return as environment</span><br>job::job(brm_result = {<br>  <span># Job-specific settings</span><br>  options(mc.cores = 3)<br>  <br>  <span># Compute stuff</span><br>  fit = brm(model1, data)<br>  fit = add_criterion(fit, <span>"loo"</span>)<br>  the_test = hypothesis(fit, <span>"hp &gt; 0"</span>)<br>  <br>  <span># Print stuff inside the job</span><br>  <span>print</span>(summary(fit))<br>  <br>  <span># Control what is returned to the main session</span><br>  job::<span>export</span>(c(fit, the_test))<br>}, import = c(data, model1))<br><span></span><br></code></pre></section><pre data-language="r"><img data-imgfileid="100002570" data-ratio="0.3972222222222222" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrosSOWPZmOXwSNUlxZicFNiasgkIQp3VDpfM4s6MibAhjcDwqaBKbe2Aicg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="1172" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrosSOWPZmOXwSNUlxZicFNiasgkIQp3VDpfM4s6MibAhjcDwqaBKbe2Aicg/640?wx_fmt=png&amp;from=appmsg"><br></pre><p><br></p><p>生成的<code>brm_results</code>是<code>Environment</code>对象，神奇的是里面竟然包含当时运行的代码，大爱。</p><p><img data-imgfileid="100002568" data-ratio="0.48148148148148145" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrbBpB7lbC6gG2eKc1QZNn43Tt4aalEUTbAAZoewic4Qia1tzjNib2RwuQw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="972" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrbBpB7lbC6gG2eKc1QZNn43Tt4aalEUTbAAZoewic4Qia1tzjNib2RwuQw/640?wx_fmt=png&amp;from=appmsg"></p><h2><span>实例1_Cibersort免疫细胞浸润</span></h2><p>下面具体展示下如何用到具体分析中，以<code>IOBR</code>的十示例数据为例。<code>eset_stad</code>共10个样本，就要跑好久。</p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>librarian::shelf(tidyverse, IOBR)<br><br>eset &lt;- count2tpm(countMat = eset_stad, <span>source</span> = <span>"local"</span>, idType = <span>"ensembl"</span>)<br><br>job::job(cibersort_result={cibersort_result&lt;-deconvo_cibersort(eset = eset,<br>                                              project = <span>"TCGA-STAD"</span>, <br>                                              arrays = FALSE, <br>                                              absolute = FALSE, <br>                                              perm = 500)})<span></span></code></pre></section><p><img data-imgfileid="100002571" data-ratio="0.3472222222222222" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxr5OB5P2ibq4zqnpSfA40dYGzTibXx7Wiaylia0UCm66Ib09KSQ5tAKgfsXg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="1363" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxr5OB5P2ibq4zqnpSfA40dYGzTibXx7Wiaylia0UCm66Ib09KSQ5tAKgfsXg/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p>生成的结果：<code>cibersort_results</code>是一个<code>Environment</code>，包含任务的相关信息及结果。共10个样本，用时20min，如果有500个样本，50*20=1000min，1000/60=16.67h，还是比较耗时的。</p><p><img data-imgfileid="100002572" data-ratio="0.3138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrKIkI8pibSmv5lrtMmLn5UMU660XxDHqXl8JzoXKgqt0P3J1x8wbjMtQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="1349" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrKIkI8pibSmv5lrtMmLn5UMU660XxDHqXl8JzoXKgqt0P3J1x8wbjMtQ/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100002569" data-ratio="0.41944444444444445" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrBY5SsEgzI0LEouBkPicy4KCyzSPgR6zBqZdezJ8ucNtzJtV4z6iapgzQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="839" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrBY5SsEgzI0LEouBkPicy4KCyzSPgR6zBqZdezJ8ucNtzJtV4z6iapgzQ/640?wx_fmt=png&amp;from=appmsg"></p><h2><span>实例2_SVM筛选特征变量</span></h2><p>输入数据</p><p><img data-imgfileid="100002573" data-ratio="0.2935185185185185" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrVErPCqMNSGVvHPyQBFRlbFcmr84n4v7hfApd0duH787aicYXFiabQTicA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="542" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrVErPCqMNSGVvHPyQBFRlbFcmr84n4v7hfApd0duH787aicYXFiabQTicA/640?wx_fmt=png&amp;from=appmsg"></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code><span>source</span>(<span>"msvmRFE.R"</span>)<br><br><span>#构建机器学习-支持向量机递归特征消除算法(SVM-RFE)，10折交叉验证</span><br>svmRFE(data, k=10, halve.above=50)<br>nfold=10<br>geneNum=nrow(data)<br>folds=rep(1:nfold, len=geneNum)[sample(geneNum)]<br>folds=lapply(1:nfold, <span>function</span>(x) <span>which</span>(folds == x))<br>results=lapply(folds, svmRFE.wrap, data, k=10, halve.above=50)<br><br><span>#基因的重要性进行排序</span><br>top.features=WriteFeatures(results, data, save=F)<br><span>#输出基因重要性排序的结果</span><br>write.table(top.features, file=<span>"feature_svm.txt"</span>, sep=<span>"\t"</span>, quote=F,row.names=F)<br><br>job::job({featsweep=lapply(1:30, FeatSweep.wrap, results, data)<br>          no.info=min(prop.table(table(data[,1])))<br>          errors=sapply(featsweep, <span>function</span>(x) ifelse(is.null(x), NA, x<span>$error</span>))<br>})<br>  <br>  <br>  <span>#绘制交叉验证误差的图形</span><br>  pdf(file=<span>"errors.pdf"</span>, width=5, height=5)<br>  PlotErrors(errors, no.info=no.info)<br>  dev.off()<br>  <br>  <span>#绘制交叉验证准确性的图形</span><br>  pdf(file=<span>"accuracy.pdf"</span>, width=5, height=5)<br>  Plotaccuracy(1-errors, no.info=no.info)<br>  dev.off()<br>  <br>  <span>#输出SVM机器学习方法得到的疾病特征基因</span><br>  featureGenes=top.features[1:which.min(errors),1,drop=F]<br>  write.table(file=<span>"SVM-RFE.gene.txt"</span>, featureGenes, sep=<span>"\t"</span>, quote=F, row.names=F, col.names=F)<br></code></pre></section><p><img data-imgfileid="100002574" data-ratio="0.2638888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrZjm0asOpA2OEOWJ53SUUcoDXjRFMeSs67OR3yJicfrnQh0NJFGHqNGQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="1330" src="https://mmbiz.qpic.cn/sz_mmbiz_png/C0nicuvoMeDExTarXbXyibDLP7O5fVbIxrZjm0asOpA2OEOWJ53SUUcoDXjRFMeSs67OR3yJicfrnQh0NJFGHqNGQ/640?wx_fmt=png&amp;from=appmsg"><span></span></p><p>参考链接：</p><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg4MTczODE5NQ==&amp;mid=2247483904&amp;idx=1&amp;sn=19d258b3735857a71821b64a7bbb13a7&amp;scene=21#wechat_redirect" data-href="https://mp.weixin.qq.com/s?__biz=Mzg4MTczODE5NQ==&amp;mid=2247483904&amp;idx=1&amp;sn=19d258b3735857a71821b64a7bbb13a7&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2">R语言之利用SVM-RFE机器学习算法筛选关键因子</a></p><p>Zeng D, Fang Y et al(2023) IOBR2: Decoding Tumor Microenvironment for Clinical Translation in Immuno-Oncology. bioRxiv.</p><p><span>声明：本文仅供学习交流用，禁止用于商业用途，如有侵权，请联系删除。</span></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/yrPJrJ8B17WNU3tD4QFIvg",target="_blank" rel="noopener noreferrer">原文链接</a>
