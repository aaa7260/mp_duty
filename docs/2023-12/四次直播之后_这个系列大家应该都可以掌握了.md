---
title: "四次直播之后，这个系列大家应该都可以掌握了"
date: 2023-12-04T01:12:09Z
draft: ["false"]
tags: [
  "fetched",
  "生信小博士"
]
categories: ["Acdemic"]
---
四次直播之后，这个系列大家应该都可以掌握了 by 生信小博士
------
<div><section><section powered-by="xiumi.us"><section><section><section><section powered-by="xiumi.us"><section><section><p><strong><span></span></strong></p><p><strong><span>“</span></strong><span> <span>本系列涉及单细胞数据的前期数据处理，以及后续的可视化。把整个流程都打通</span>。<strong><span>”</span></strong></span></p><p><span><strong>本系列月更，写满12篇。第一篇主要是单细胞下游分析的全流程，后续11篇会着重写实践中常见的画图需求。</strong></span></p><p><span><strong><br></strong></span></p><p><span><strong>全文分为三部分</strong></span></p><ul><li><p><span><strong>01：单细胞<strong>降维聚类分群</strong></strong></span></p></li><li><p><span><strong>02：单细胞</strong></span><span><strong><strong>celltypist自动命名，省去人工注释烦恼</strong></strong></span></p></li><li><p><span><strong>03：单细胞</strong></span><span><strong><strong>曼哈顿图，批量差异分析、富集分析</strong></strong></span></p></li></ul><p><span><span></span></span></p></section></section></section></section></section></section></section></section><section><section powered-by="xiumi.us"><section><section><p><span>01</span></p><p><span>—</span></p></section></section></section></section><p><br></p><p><br></p><p><span><span><strong>1</strong><strong>.降维聚类分群</strong></span></span></p><p><br></p><section><section powered-by="xiumi.us"><section><section><p>第一部分的正文内容从这里开始。</p><p><br></p></section></section></section></section><hr><p><strong>首先从geo下载<span>GSE104154</span>数据，并解压拿到rawdata<br></strong></p><section><ul><li><li><li><li><li><li></ul><pre data-lang="makefile"><code><span><span>#设置工作路径</span></span></code><code><span>path=<span>"/home/data/t040413/ipf/GSE104154_scRNA-seq_fibrotic MC_bleomycin"</span></span></code><code><span>dir.create(path)</span></code><code><span>setwd(path)</span></code><code><span>getwd()</span></code><code><span>list.files()</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="makefile"><code><span><br></span></code><code><span><span>#read表达矩阵</span></span></code><code><span>raw_counts=read.csv(<span>"/home/data/t040413/ipf/GSE104154_scRNA-seq_fibrotic MC_bleomycin/GSE104154_d0_d21_sma_tm_Expr_raw/GSE104154_d0_d21_sma_tm_Expr_raw.csv"</span></span></code><code><span>                      )</span></code><code><span><span>head(raw_counts)[1:4,1:4]</span></span></code><code><span>counts=raw_counts[,-1]</span></code><code><span><span>head(counts)[1:4,1:4]</span></span></code><code><span>rownames(counts)=counts$symbol</span></code><code><span><br></span></code><code><span><span>head(raw_counts)[1:4,1:4]</span></span></code></pre></section><p><img data-galleryid="" data-ratio="0.1562043795620438" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazyc4fltibZicVzTia9u0vdFhk3OHibtq6Tib9w9yPJc6hzKaYMEpTlQhhbeSAw/640?wx_fmt=png" data-type="png" data-w="685" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazyc4fltibZicVzTia9u0vdFhk3OHibtq6Tib9w9yPJc6hzKaYMEpTlQhhbeSAw/640?wx_fmt=png"></p><p><span>注意：这个</span><span>数据</span><span>使用了ensem</span><span>ble </span><span>id作为基因名，后续需要换为gene symbol</span></p><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="makefile"><code><span><span>head(raw_counts)[1:4,1:4]</span></span></code><code><span>counts=raw_counts[,-2]</span></code><code><span><span>head(counts)[1:4,1:4]</span></span></code><code><span>rownames(counts)=counts$id</span></code><code><span><span>head(counts)[,1:5]</span></span></code><code><span>counts=counts[,-1]</span></code><code><span><span>head(counts)[,1:5]</span></span></code><code><span><br></span></code><code><span><br></span></code></pre></section><p><img data-galleryid="" data-ratio="0.29641350210970463" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycpBsNMaYgucjnvlPDG4Ttg6L6u5RtQ0UhPGxZC5E4Xm6ib1lzvyyznbA/640?wx_fmt=png" data-type="png" data-w="948" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycpBsNMaYgucjnvlPDG4Ttg6L6u5RtQ0UhPGxZC5E4Xm6ib1lzvyyznbA/640?wx_fmt=png"></p><p><strong>创建seurat对象</strong></p><section><ul><li><li><li><li><li></ul><pre data-lang="makefile"><code><span>library(Seurat)</span></code><code><span><span>#https://zhuanlan.zhihu.com/p/385206713</span></span></code><code><span>rawdata=CreateSeuratObject(counts = counts,project = <span>"blem"</span>,assay = <span>"RNA"</span>)</span></code><code><span><br></span></code><code><span><br></span></code></pre></section><p><span>这里的seurat对象行名是ensemble id，改为gene symbol 比较容易看，如何改呢？</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="makefile"><code><span><span>#去重  取得唯一基因</span></span></code><code><span>ids=raw_counts[,1:2]</span></code><code><span>head(ids)</span></code><code><span>colnames(ids)= c('ENSEMBL','SYMBOL')</span></code><code><span>head(ids)</span></code><code><span>dim(ids) <span># [1] 16428 </span></span></code><code><span>ids=na.omit(ids)</span></code><code><span>dim(ids) <span># [1] 15504 </span></span></code><code><span>length(unique(ids$SYMBOL)) <span># [1] 15494 </span></span></code><code><span><span># 这里的关系超级乱，互相之间都不是一对一 </span></span></code><code><span><span># 凡是混乱的ID一律删除即???</span></span></code><code><span>ids=ids[!duplicated(ids$SYMBOL),]</span></code><code><span>ids=ids[!duplicated(ids$ENSEMBL),]</span></code><code><span>dim(ids)</span></code><code><span>pos=match(ids$ENSEMBL,rownames(rawdata) )</span></code><code><span>hp_sce=rawdata[pos,]</span></code><code><span>hp_sce</span></code></pre></section><p><img data-galleryid="" data-ratio="0.42" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazyc8tGfsZS4VyyKP67XNV8SxQS69jwY3qrHzQVGmJD2Ktic3Lq1qfQY6lA/640?wx_fmt=png" data-type="png" data-w="200" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazyc8tGfsZS4VyyKP67XNV8SxQS69jwY3qrHzQVGmJD2Ktic3Lq1qfQY6lA/640?wx_fmt=png"></p><p><br></p><p><img data-galleryid="" data-ratio="0.4229471316085489" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazyc18V0iaWZlKahN8KYBsuDaiag42MT517oAibkegY82fpTPQWzXsdGd2jxA/640?wx_fmt=png" data-type="png" data-w="889" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazyc18V0iaWZlKahN8KYBsuDaiag42MT517oAibkegY82fpTPQWzXsdGd2jxA/640?wx_fmt=png"></p><p><strong>把seurat对象中的ensemble id 改为gene symble</strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="perl"><code><span><span>#创建函数 改名</span></span></code><code><span>RenameGenesSeurat &lt;- function(obj , </span></code><code><span>                              newnames ) { </span></code><code><span>  <span># Replace gene names in different slots of a Seurat object. Run this before integration. Run this before integration. </span></span></code><code><span>  <span># It only changes obj@assays$RNA@counts, @data and @scale.data.</span></span></code><code><span>  <span>print</span>(<span>"Run this before integration. It only changes obj@assays$RNA@counts, @data and @scale.data."</span>)</span></code><code><span>  RNA &lt;- obj@assays$RNA</span></code><code><span>  </span></code><code><span>  <span>if</span> (nrow(RNA) == <span>length</span>(newnames)) {</span></code><code><span>    <span>if</span> (<span>length</span>(RNA@counts)) RNA@counts@Dimnames[[<span>1</span>]]            &lt;- newnames</span></code><code><span>    <span>if</span> (<span>length</span>(RNA@data)) RNA@data@Dimnames[[<span>1</span>]]                &lt;- newnames</span></code><code><span>    <span>if</span> (<span>length</span>(RNA@scale.data)) RNA@scale.data@Dimnames[[<span>1</span>]]    &lt;- newnames</span></code><code><span>  } <span>else</span> {<span>"Unequal gene sets: nrow(RNA) != nrow(newnames)"</span>}</span></code><code><span>  obj@assays$RNA &lt;- RNA</span></code><code><span>  <span>return</span>(obj)</span></code><code><span>}</span></code><code><span><br></span></code><code><span>hp_sce=RenameGenesSeurat(obj = hp_sce, </span></code><code><span>                      newnames = ids$SYMBOL)</span></code><code><span>getwd()</span></code><code><span><span>#save(hp_sce,file = 'first_sce.Rdata')</span></span></code><code><span>hp_sce</span></code></pre></section><p><strong>改名成功</strong></p><p><img data-galleryid="" data-ratio="0.47191011235955055" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycwgCmjnLStYJ6Mruhj0Nic2w8DFaOx0RCPwKSXW6m9OwFoXPjXm3iaOfQ/640?wx_fmt=png" data-type="png" data-w="890" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycwgCmjnLStYJ6Mruhj0Nic2w8DFaOx0RCPwKSXW6m9OwFoXPjXm3iaOfQ/640?wx_fmt=png"></p><section><ul><li></ul><pre data-lang="makefile"><code><span>rownames(hp_sce)[grepl('^mt-',rownames(hp_sce))]</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>rownames(hp_sce)[grepl(<span>'^Rp[sl]'</span>,rownames(hp_sce))]</span></code><code><span>hp_sce[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(hp_sce, pattern = <span>"^mt-"</span>)</span></code><code><span>fivenum(hp_sce[[<span>"percent.mt"</span>]][,<span>1</span>])</span></code><code><span>rb.genes &lt;- rownames(hp_sce)[grep(<span>"^Rp[sl]"</span>,rownames(hp_sce))]</span></code><code><span>C&lt;-GetAssayData(object = hp_sce, slot = <span>"counts"</span>)</span></code><code><span>percent.ribo &lt;- Matrix::colSums(C[rb.genes,])/Matrix::colSums(C)*<span>100</span></span></code><code><span>hp_sce &lt;- AddMetaData(hp_sce, percent.ribo, col.name = <span>"percent.ribo"</span>)</span></code><code><span><br></span></code><code><span>getwd()</span></code><code><span>plot1 &lt;- FeatureScatter(hp_sce, feature1 = <span>"nCount_RNA"</span>, feature2 = <span>"percent.mt"</span>)</span></code><code><span>plot2 &lt;- FeatureScatter(hp_sce, feature1 = <span>"nCount_RNA"</span>, feature2 = <span>"nFeature_RNA"</span>)</span></code><code><span>CombinePlots(plots = <span>list</span>(plot1, plot2))</span></code><code><span><br></span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>查看质控</span></code><code><span>rownames(hp_sce)[grepl(<span>'^mt-'</span>,rownames(hp_sce))]</span></code><code><span>rownames(hp_sce)[grepl(<span>'^Rp[sl]'</span>,rownames(hp_sce))]</span></code><code><span>hp_sce[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(hp_sce, pattern = <span>"^mt-"</span>)</span></code><code><span>fivenum(hp_sce[[<span>"percent.mt"</span>]][,<span>1</span>])</span></code><code><span>rb.genes &lt;- rownames(hp_sce)[grep(<span>"^Rp[sl]"</span>,rownames(hp_sce))]</span></code><code><span>C&lt;-GetAssayData(object = hp_sce, slot = <span>"counts"</span>)</span></code><code><span>percent.ribo &lt;- Matrix::colSums(C[rb.genes,])/Matrix::colSums(C)*<span>100</span></span></code><code><span>hp_sce &lt;- AddMetaData(hp_sce, percent.ribo, col.name = <span>"percent.ribo"</span>)</span></code><code><span><br></span></code><code><span>getwd()</span></code><code><span>plot1 &lt;- FeatureScatter(hp_sce, feature1 = <span>"nCount_RNA"</span>, feature2 = <span>"percent.mt"</span>)</span></code><code><span>plot2 &lt;- FeatureScatter(hp_sce, feature1 = <span>"nCount_RNA"</span>, feature2 = <span>"nFeature_RNA"</span>)</span></code><code><span>CombinePlots(plots = <span>list</span>(plot1, plot2))</span></code><code><span><br></span></code><code><span>VlnPlot(hp_sce, features = c(<span>"percent.ribo"</span>, <span>"percent.mt"</span>), ncol = <span>2</span>)</span></code><code><span>VlnPlot(hp_sce, features = c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>), ncol = <span>2</span>)</span></code><code><span>VlnPlot(hp_sce, features = c(<span>"percent.ribo"</span>, <span>"nCount_RNA"</span>), ncol = <span>2</span>)</span></code><code><span>hp_sce</span></code><code><span><span>#为了演示celltypeist，把物种改为human的gene symbol</span></span></code><code><span>hp_sce=RenameGenesSeurat(obj = hp_sce, </span></code><code><span>                            newnames = toupper(rownames(hp_sce)))</span></code><code><span>hp_sce1 &lt;- subset(hp_sce, subset = nFeature_RNA &gt; <span>200</span> &amp; nCount_RNA &gt; <span>1000</span> &amp; percent.mt &lt; <span>20</span>)</span></code><code><span>hp_sce1</span></code></pre></section><p><img data-galleryid="" data-ratio="0.8076923076923077" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycdd387oMuicSxqZ2LfCM91AMKvwjX42AbAtKiabhJ78HoYn6JkHTQxZEg/640?wx_fmt=png" data-type="png" data-w="676" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycdd387oMuicSxqZ2LfCM91AMKvwjX42AbAtKiabhJ78HoYn6JkHTQxZEg/640?wx_fmt=png"></p><p><strong>设置组别<br></strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="perl"><code><span>sce=hp_sce1</span></code><code><span>sce</span></code><code><span>colnames(sce)</span></code><code><span><span>grep</span>(colnames(sce),pattern = <span>".1"</span>)</span></code><code><span><span>grep</span>(colnames(sce),pattern = <span>".2"</span>)</span></code><code><span>sce@meta.data$stim &lt;-c(rep(<span>"PBS"</span>, <span>length</span>(<span>grep</span>(<span>"1$", sce@assays$RNA@counts@Dimnames[[2]]))), </span></span></code><code><span><span>                       rep("</span>PBS<span>", length(grep("</span><span>2</span>$", sce@assays$RNA@counts@Dimnames[[<span>2</span>]]))),</span></code><code><span>                       rep(<span>"PBS"</span>, <span>length</span>(<span>grep</span>(<span>"3$", sce@assays$RNA@counts@Dimnames[[2]]))),</span></span></code><code><span><span>                       rep("</span>Bleomycin<span>", length(grep("</span><span>4</span>$", sce@assays$RNA@counts@Dimnames[[<span>2</span>]]))),</span></code><code><span>                       rep(<span>"Bleomycin"</span>, <span>length</span>(<span>grep</span>(<span>"5$", sce@assays$RNA@counts@Dimnames[[2]]))),</span></span></code><code><span><span>                       rep("</span>Bleomycin<span>", length(grep("</span><span>6</span>$", sce@assays$RNA@counts@Dimnames[[<span>2</span>]])))</span></code><code><span>                        ) <span>## 8186,7947;</span></span></code><code><span><br></span></code><code><span>table(sce$stim)</span></code><code><span><br></span></code><code><span>library(dplyr)</span></code><code><span>sce[[<span>"RNA"</span>]]@meta.features &lt;- data.frame(row.names = rownames(sce[[<span>"RNA"</span>]]))</span></code></pre></section><p><strong>seurat标准流程 ：</strong><br></p><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="makefile"><code><span>All = sce%&gt;%Seurat::NormalizeData(verbose = FALSE) %&gt;%  </span></code><code><span>  FindVariableFeatures(selection.method = <span>"vst"</span>, nfeatures = 2000) %&gt;%</span></code><code><span>  ScaleData(verbose = FALSE)</span></code><code><span>All = RunPCA(All, npcs = 50, verbose = FALSE)</span></code><code><span><br></span></code><code><span>pdf(<span>"2_ElbowPlot.pdf"</span>)</span></code><code><span>ElbowPlot(All, ndims = 50)</span></code><code><span>dev.off()</span></code></pre></section><p><br></p><p><img data-galleryid="" data-ratio="0.9808612440191388" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycEMNhb50WKPiaVeaTCEKibDZduwbge1UGI6ILOn9OobVuicia7NCcndfs5Q/640?wx_fmt=png" data-type="png" data-w="627" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycEMNhb50WKPiaVeaTCEKibDZduwbge1UGI6ILOn9OobVuicia7NCcndfs5Q/640?wx_fmt=png"></p><p><strong>使用harmony降维聚类分群</strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span>library(cowplot)</span></code><code><span>#<span>All@</span>meta.<span>data</span>$stim &lt;- c(rep(<span>"case"</span>, length(grep(<span>"1$"</span>, <span>All@</span>assays$<span>RNA@</span><span>counts@</span>Dimnames[[<span>2</span>]]))), rep(<span>"ctrl"</span>, length(grep(<span>"2$"</span>, <span>All@</span>assays$<span>RNA@</span><span>counts@</span>Dimnames[[<span>2</span>]])))) ## <span>8186</span>,<span>7947</span>;</span></code><code><span>pdf(<span>"2_pre_harmony_harmony_plot.pdf"</span>)</span></code><code><span>options(repr.plot.height = <span>5</span>, repr.plot.width = <span>12</span>)</span></code><code><span>p1 &lt;- DimPlot(<span>object</span> = All, reduction = <span>"pca"</span>, pt.size = .<span>1</span>, group.<span>by</span> = <span>"stim"</span>)</span></code><code><span>p2 &lt;- VlnPlot(<span>object</span> = All, features = <span>"PC_1"</span>, group.<span>by</span> = <span>"stim"</span>, pt.size = .<span>1</span>)</span></code><code><span>plot_grid(p1, p2)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span><br></span></code><code><span>##########################run harmony</span></code><code><span>library(harmony)</span></code><code><span>All &lt;- All %&gt;% RunHarmony(<span>"stim"</span>, plot_convergence = TRUE)</span></code><code><span>harmony_embeddings &lt;- Embeddings(All, <span>'harmony'</span>) </span></code><code><span><br></span></code><code><span>pdf(<span>"2_after_harmony_harmony_plot.pdf"</span>)</span></code><code><span>options(repr.plot.height = <span>5</span>, repr.plot.width = <span>12</span>)</span></code><code><span>p3 &lt;- DimPlot(<span>object</span> = All, reduction = <span>"harmony"</span>, pt.size = .<span>1</span>, group.<span>by</span> = <span>"stim"</span>)</span></code><code><span>p4 &lt;- VlnPlot(<span>object</span> = All, features = <span>"harmony_1"</span>, group.<span>by</span> = <span>"stim"</span>, pt.size = .<span>1</span>)</span></code><code><span>plot_grid(p3, p4)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span>#############cluster</span></code><code><span>library(harmony)</span></code><code><span>All &lt;- All %&gt;% </span></code><code><span>  RunUMAP(reduction = <span>"harmony"</span>, dims = <span>1</span>:<span>30</span>) %&gt;% </span></code><code><span>  RunTSNE(reduction = <span>"harmony"</span>, dims = <span>1</span>:<span>30</span>) %&gt;% </span></code><code><span>  FindNeighbors(reduction = <span>"harmony"</span>, dims = <span>1</span>:<span>30</span>)</span></code><code><span>All&lt;-All%&gt;% FindClusters(resolution = <span>3</span>) %&gt;% identity()</span></code></pre></section><p><img data-galleryid="" data-ratio="0.827639751552795" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycYXr8eia6JiacpmC0x0axvzSib80gS9uJOTdc79uuT9GmVdESBaw90k7Jw/640?wx_fmt=png" data-type="png" data-w="644" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycYXr8eia6JiacpmC0x0axvzSib80gS9uJOTdc79uuT9GmVdESBaw90k7Jw/640?wx_fmt=png"></p><p><img data-galleryid="" data-ratio="0.7892376681614349" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycY9e4Swwaw8HStDibpv2xNcIMqDaojXWRtqZt5Kibedo4ffnGk89kb43Q/640?wx_fmt=png" data-type="png" data-w="669" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycY9e4Swwaw8HStDibpv2xNcIMqDaojXWRtqZt5Kibedo4ffnGk89kb43Q/640?wx_fmt=png"></p><p><strong>保存 重新加载</strong></p><section><ul><li><li></ul><pre data-lang="cpp"><code><span><span>#save(All,file =<span>"/home/data/t040413/ipf/GSE104154_scRNA-seq_fibrotic MC_bleomycin/All_for_clustering.rds"</span> )</span></span></code><code><span>load(<span>"/home/data/t040413/ipf/GSE104154_scRNA-seq_fibrotic MC_bleomycin/All_for_clustering.rds"</span>)</span></code></pre></section><p><strong>计算marker基因</strong><br></p><section><ul><li><li><li><li><li><li></ul><pre data-lang="http"><code><span><span>library(Seurat)</span></span></code><code><span>DimPlot(All,label = T,reduction = 'tsne')</span></code><code><span>DimPlot(All,label = T,reduction = 'umap',group.by = 'stim')</span></code><code><span>getwd()</span></code><code><span>Disease.markers &lt;- FindAllMarkers(All, min.pct = 0.35, logfc.threshold = 0.35, only.pos = T)</span></code><code><span>openxlsx::write.xlsx(Disease.markers,file ="G:/silicosis/geo/GSE104154_scRNA-seq_fibrotic MC_bleomycin/markers_for_all.xlsx" )</span></code></pre></section><p><br></p><hr><section><section powered-by="xiumi.us"><section><section><section><section powered-by="xiumi.us"><section><section><p><span><span>“</span><span> 分群之后，如何给细胞命名呢，可以使用celltypist自动命名，省去人工烦恼。<span>”</span></span></span></p></section></section></section></section></section></section></section></section><p><br></p><section><section powered-by="xiumi.us"><section><section><p><span>02</span></p><p><span>—</span></p></section></section></section></section><p><span><strong>2.分群之后，如何给细胞命名呢，可以使用celltypist自动命名，省去人工烦恼</strong></span></p><p><br></p><section><section powered-by="xiumi.us"><section><section><p>此部分的正文内容从这里开始。</p><p><br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="http"><code><span>#<span>https://mp.weixin.qq.com/s/CdhAp7lO5nRJW4cnLWGwLQ</span></span></code><code><span>.libPaths(c("/home/data/t040413/R/x86_64-pc-linux-gnu-library/4.2","/home/data/t040413/R/yll/usr/local/lib/R/site-library",  "/usr/local/lib/R/library"))</span></code><code><span>library(Seurat)</span></code><code><span>load("/home/data/t040413/ipf/GSE104154_scRNA-seq_fibrotic MC_bleomycin/All_for_clustering.rds")</span></code><code><span>toupper()</span></code><code><span><br></span></code><code><span>#为了演示celltypeist，把物种改为human的gene symbol</span></code><code><span>All.merge=All</span></code><code><span><br></span></code><code><span>DimPlot(All.merge,label = T)</span></code><code><span><br></span></code><code><span>#在r中创建如下环境========================================</span></code><code><span>#conda create -n celltypist python=3.8</span></code><code><span>#conda activate celltypist</span></code><code><span><br></span></code><code><span>## 两种方法安装 pip or conda</span></code><code><span>#pip install celltypist  -i  https://pypi.douban.com/simple/  --use-pep517</span></code><code><span>#mamba install -c bioconda -c conda-forge celltypist</span></code><code><span>#使用use_condaenv()函数仅在当前R会话中激活指定的Conda环境。如果您希望在多个会话中使用相同的Conda环境，需要在每个会话中都执行相应的use_condaenv()函数调用。</span></code><code><span>#如果您使用的是conda而不是mamba，请将上述的mamba命令替换为conda命令进行安装。</span></code><code><span>#use_condaenv("celltypist")  #如果您的Conda环境在默认路径中，您可以省略路径参数，仅提供环境的名称</span></code><code><span><br></span></code><code><span>library(reticulate)</span></code><code><span>use_condaenv("/home/data/t040413/anaconda3/envs/celltypist")#celltypist应该是环境的名称，而不是环境文件夹的名称。如果您的Conda环境文件夹名为celltypist，则上述代码应该可以正确激活环境。</span></code><code><span><br></span></code><code><span>## 载入python模块</span></code><code><span>scanpy = import("scanpy")</span></code><code><span>celltypist = import("celltypist")</span></code><code><span>pandas &lt;- import("pandas")</span></code><code><span>numpy = import("numpy")</span></code><code><span><br></span></code><code><span>#### 下载参考数据集</span></code><code><span>celltypist$models$download_models(force_update = T) </span></code><code><span><br></span></code><code><span>library(Seurat)</span></code><code><span>#library(SeuratData)</span></code><code><span>library(ggplot2)</span></code><code><span>library(patchwork)</span></code><code><span>library(dplyr)</span></code><code><span>library(stringr)</span></code><code><span>library(readr)</span></code><code><span>library(cowplot)</span></code><code><span>library(reticulate)</span></code><code><span>1#Step1. 加载上述下载好的参考数据集</span></code><code><span><br></span></code><code><span># 首先确认用户存放.pkl文件的位置，默认在</span></code><code><span>celltypist$models$celltypist_path #   [1] "/home/data/t040413/.celltypist"</span></code><code><span><br></span></code><code><span># 加载所有的参考数据集</span></code><code><span>model_type = list.files("~/.celltypist/data/models/") </span></code><code><span>names(model_type) = str_split(string = model_type,pattern = "\\.", simplify = T)[,1]</span></code><code><span>model_type</span></code><code><span>model_type[grep(pattern = "Mouse",model_type)]</span></code><code><span>names(model_type) </span></code><code><span><br></span></code><code><span>1.1#根据需要选择，，，，，这里我只选2个模型</span></code><code><span>model_type=model_type[c("Human_Lung_Atlas","Human_IPF_Lung")]</span></code><code><span>model_type</span></code><code><span><br></span></code><code><span>1.2#这个model_list非常重要，用于最后不同模型的可视化</span></code><code><span>model_list = lapply(model_type, function(x){</span></code><code><span>  celltypist$models$Model$load(model = x)})</span></code><code><span>model_list</span></code><code><span>2.#加载数据</span></code><code><span><br></span></code><code><span>#load("/home/data/t040413/ipf/gse132771_colgen_fibroblasts/step1_get_matrix_ipf/All.merge.rds")</span></code><code><span>ifnb.data=All.merge</span></code><code><span>seurat.data=All.merge</span></code><code><span><br></span></code><code><span><br></span></code><code><span>2.1 #Seurat对象转为celltypist所需要的对象：</span></code><code><span>adata = scanpy$AnnData(X = numpy$array(as.matrix(t(as.matrix(ifnb.data[['RNA']]@counts)))),</span></code><code><span>                       obs = pandas$DataFrame(ifnb.data@meta.data),</span></code><code><span>                       var = pandas$DataFrame(data.frame(gene = rownames(ifnb.data[['RNA']]@counts),</span></code><code><span>                                                         row.names = rownames(ifnb.data[['RNA']]@counts)))</span></code><code><span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>adata_copy &lt;- adata$copy() #in order  to edit array or otherwise Error</span>: ValueError: output array is read-only</span></code><code><span><span>scanpy$pp$normalize_total(adata_copy, target_sum = 1e4)</span></span></code><code><span>scanpy$pp$log1p(adata_copy)</span></code><code><span>adata=adata_copy</span></code><code><span>3.# 细胞亚群预测和可视化</span></code><code><span># Add cluster information to adata</span></code><code><span>adata$obs$seurat_clusters &lt;- ifnb.data$seurat_clusters</span></code><code><span><br></span></code><code><span><br></span></code><code><span># Update the neighborhood graph using cluster information</span></code><code><span>#scanpy::tl.louvain(adata, key_added = "seurat_clusters")</span></code><code><span><br></span></code><code><span>3.1#根据上面对各个参考数据集的介绍，我这里先用Human_IPF_Lung参考数据集预测看看：</span></code><code><span>### 1. Human_IPF_Lung</span></code><code><span>predictions = celltypist$annotate(adata, model = model_list[["Human_IPF_Lung"]], majority_voting = T)</span></code><code><span>## 把这些信息加入到seurat对象中去</span></code><code><span>seurat.data  = AddMetaData(seurat.data, predictions$predicted_labels$majority_voting, col.name ="Human_IPF_Lung") </span></code><code><span>### 2. Human_Lung_Atlas</span></code><code><span>predictions = celltypist$annotate(adata, model = model_list[["Human_Lung_Atlas"]], majority_voting = T)</span></code><code><span>## 把这些信息加入到seurat对象中去</span></code><code><span>seurat.data  = AddMetaData(seurat.data, predictions$predicted_labels$majority_voting, col.name ="Human_Lung_Atlas") </span></code><code><span><br></span></code><code><span>head(ifnb.data@meta.data)</span></code><code><span>head(predictions$predicted_labels)</span></code><code><span>table(predictions$predicted_labels$majority_voting)</span></code><code><span>table(predictions$predicted_labels$predicted_labels)</span></code><code><span><br></span></code><code><span>3.2### 3. 可视化</span></code><code><span>p0 = DimPlot(seurat.data , reduction = "umap",label = T,label.box = T,group.by = "seurat_clusters")+ NoLegend();p0</span></code><code><span>p1 = DimPlot(seurat.data ,group.by = "Human_IPF_Lung", reduction = "umap", label = TRUE) </span></code><code><span>p2 = DimPlot(seurat.data ,group.by = "Human_Lung_Atlas", reduction = "umap", label = TRUE,repel = T) </span></code><code><span>p0 + p2 </span></code><code><span><br></span></code><code><span>pdf("celltypist.pdf",height=10,width=15)</span></code><code><span>print(p0 + p2 )</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span>head(seurat.data@meta.data)</span></code><code><span><br></span></code><code><span>4.# 写函数批量运行</span></code><code><span>celltypist_vis = function(adata,</span></code><code><span>                          seurat_Data,</span></code><code><span>                          model = Immune_All_Low.pkl,</span></code><code><span>                          title = "Immune_All_Low"){</span></code><code><span>  ### 4.开始预测</span></code><code><span>  predictions = celltypist$annotate(adata, model = model, majority_voting = T)</span></code><code><span>  # predictions$predicted_labels %&gt;% head()</span></code><code><span>  </span></code><code><span>  #model=model_type[1]</span></code><code><span>  #### 5.把这些信息加入到seurat对象中去</span></code><code><span>  print(paste("运行到这里了__1:",names(model)))</span></code><code><span>  seurat_Data  = AddMetaData(seurat_Data , predictions$predicted_labels) </span></code><code><span>  </span></code><code><span>  # model=model_list[[1]]</span></code><code><span>  # model$load(model = model)</span></code><code><span>  #names(model) </span></code><code><span>  print(paste("运行到这里了__2:",names(model), paste(names(model),"_celltype_labels")))</span></code><code><span>  head(seurat_Data )</span></code><code><span>  </span></code><code><span>  seurat_Data  = SetIdent(seurat_Data , value = "predicted_labels") #"majority_voting"</span></code><code><span>  p.umap = DimPlot(seurat_Data, reduction = "umap", label = TRUE, pt.size = 0.5,label.box = T,repel = T) + </span></code><code><span>    NoLegend() + ggtitle(title)</span></code><code><span>  return(p.umap)</span></code><code><span>}</span></code><code><span><br></span></code><code><span>### 批量预测</span></code><code><span>plot.list = list()</span></code><code><span>for (i in 1:length(model_list)) {</span></code><code><span>  plot.list[[i]] = celltypist_vis(adata = adata,</span></code><code><span>                                  seurat_Data = ifnb.data,  ###输入自己的</span></code><code><span>                                  model = model_list[[i]],</span></code><code><span>                                  title = names(model_list[i])  )  </span></code><code><span>  print(paste0("done==plot==",names(model_list)))</span></code><code><span>  </span></code><code><span>}  </span></code><code><span><br></span></code><code><span>p.ct = wrap_plots(plot.list,ncol = 4) + p0</span></code><code><span>p.ct</span></code><code><span>ggsave(p.ct, filename = "./annotation_celltypist---.jpeg",limitsize = FALSE,</span></code><code><span>       width = 60,height = 20)</span></code></pre></section><p><br></p></section></section></section></section><p><img data-galleryid="" data-ratio="0.3535749265426053" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycMDAyrCAzSCxh7lHOicq4hhGyoicAGKrNHRTn4ehMic13h1XDiaTyYvgDqw/640?wx_fmt=png" data-type="png" data-w="1021" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycMDAyrCAzSCxh7lHOicq4hhGyoicAGKrNHRTn4ehMic13h1XDiaTyYvgDqw/640?wx_fmt=png"></p><p><img data-galleryid="" data-ratio="0.4915590863952334" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycMTO8vokRcFZCNUWWyS5TeYM8RiaNCWicxcRC0JULFS3dvbURjiciaPAKxA/640?wx_fmt=png" data-type="png" data-w="1007" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycMTO8vokRcFZCNUWWyS5TeYM8RiaNCWicxcRC0JULFS3dvbURjiciaPAKxA/640?wx_fmt=png"></p><p><img data-galleryid="" data-ratio="0.671120246659815" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycKAicDHsib5VHzCDJw9ibeSN10qQfoLvLu7Ow0xFibSwaxqft8JOSOheMqw/640?wx_fmt=png" data-type="png" data-w="973" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkvcFYywehicPUJNicIFs3iazycKAicDHsib5VHzCDJw9ibeSN10qQfoLvLu7Ow0xFibSwaxqft8JOSOheMqw/640?wx_fmt=png"></p><p>这样就可以依据上面的细胞类型来命名了</p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="javascript"><code><span>#细胞类型命名，这里只是举例子，不是实际的数据</span></code><code><span>All.merge=RenameIdents(All.merge,</span></code><code><span>                       <span>"1"</span>=<span>"SMC"</span>,<span>"2"</span>=<span>"SMC"</span>,</span></code><code><span>                       <span>"7"</span>=<span>"Pericyte"</span>,                     </span></code><code><span>                       <span>"13"</span>=<span>"Myofibroblast"</span>,<span>"14"</span>=<span>"Myofibroblast"</span>,                  </span></code><code><span>                       <span>"4"</span>=<span>"Myofibroblast"</span>,<span>"10"</span>=<span>"Myofibroblast"</span>,<span>"0"</span>=<span>"Myofibroblast"</span>,   </span></code><code><span>                       <span>"5"</span>=<span>"Fibroblast"</span>,</span></code><code><span>                       </span></code><code><span>                       <span>"12"</span>=<span>"AT2"</span>,</span></code><code><span>                       <span>"15"</span>=<span>"AT1"</span>,</span></code><code><span>                       <span>"21"</span>=<span>"Mesothelial"</span>,</span></code><code><span>                       <span>"20"</span>=<span>"Goblet"</span>,</span></code><code><span>                       <span>"19"</span>=<span>"Ciliated"</span>,</span></code><code><span>                       </span></code><code><span>                       <span>"16"</span>=<span>"B Plasma"</span>,</span></code><code><span>                       <span>"22"</span>=<span>"Mast"</span>,</span></code><code><span>                       <span>"9"</span>=<span>"T/NK"</span>,</span></code><code><span>                       <span>"17"</span>=<span>"B cells"</span>,</span></code><code><span>                       <span>"24"</span>=<span>"Plasmacytoid DCs"</span>,</span></code><code><span>                       </span></code><code><span>                       <span>"23"</span>=<span>"Macrophage"</span>,</span></code><code><span>                       <span>"3"</span>=<span>"Macrophage"</span>,</span></code><code><span>                       <span>"11"</span>=<span>"DCs"</span>,<span>"18"</span>=<span>"DCs"</span>,</span></code><code><span>                       <span>"8"</span>=<span>"Monocyte"</span>,</span></code><code><span>                       </span></code><code><span>                       <span>"6"</span>=<span>"Endothelial"</span>,</span></code><code><span>                       <span>"25"</span>=<span>"Endothelial"</span></span></code><code><span>)</span></code></pre></section><hr><section><section powered-by="xiumi.us"><section><section><section><section powered-by="xiumi.us"><section><section><p><span><strong><span>“</span></strong><span> 下面部分着重一些常规的画图。<strong><span>”</span></strong></span></span></p></section></section></section></section></section></section></section></section><section><section powered-by="xiumi.us"><section><section><p><span>03</span></p><p><span>—</span></p></section></section></section></section><p>批量差异分析画图 groupgo富集分析<br></p><section><section powered-by="xiumi.us"><section><section><p>此部分的正文内容从这里开始。</p></section><section><p><br></p><p><strong><span><span>1.首先来画曼哈顿图</span></span></strong><span><span></span></span></p></section></section></section></section><p><img data-galleryid="" data-ratio="0.6987104337631888" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktbFdG2qg8cHONogj9lZH4EyrSpu9XzuHibzqXCmx3jHOp6oIdxdA8LhniaVmnhkFLu5lWVCFfibtH3w/640?wx_fmt=png" data-type="png" data-w="853" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktbFdG2qg8cHONogj9lZH4EyrSpu9XzuHibzqXCmx3jHOp6oIdxdA8LhniaVmnhkFLu5lWVCFfibtH3w/640?wx_fmt=png"></p><p><span><strong>数据准备：</strong></span><br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="ruby"><code><span>pbmc$celltype.group=pbmc$celltype.stim</span></code><code><span>pbmc$celltype=pbmc$seurat_clusters</span></code><code><span>Idents(pbmc)=pbmc$celltype.group</span></code><code><span><br></span></code><code><span>cellfordeg&lt;-levels(pbmc$celltype)</span></code><code><span>data_forplot=data.frame()</span></code><code><span><br></span></code><code><span><span>for</span>(i <span>in</span> <span>1</span><span>:length</span>(cellfordeg)){ <span>#</span></span></code><code><span>  CELLDEG &lt;- FindMarkers(pbmc, ident.<span>1</span> = paste<span>0</span>(cellfordeg[i],<span>"_PT"</span>), ident.<span>2</span> = paste<span>0</span>(cellfordeg[i],<span>"_sham"</span>), verbose = FALSE)</span></code><code><span>  CELLDEG$gene=rownames(CELLDEG)</span></code><code><span>  CELLDEG$cluster=cellfordeg[i]</span></code><code><span>  write.csv(CELLDEG,paste<span>0</span>(cellfordeg[i],<span>"PT_VS_Sham.CSV"</span>))</span></code><code><span>  data_forplot=rbind(CELLDEG,data_forplot)</span></code><code><span> </span></code><code><span>}</span></code><code><span>head(data_forplot)</span></code></pre></section><p><img data-galleryid="" data-ratio="0.4351851851851852" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktbFdG2qg8cHONogj9lZH4E4nC3uujeu8vfrhheEsXSsk2GibrZ3NBMFz5sCIQVcQfnlicez8uSpoOA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktbFdG2qg8cHONogj9lZH4E4nC3uujeu8vfrhheEsXSsk2GibrZ3NBMFz5sCIQVcQfnlicez8uSpoOA/640?wx_fmt=png"></p><p><img data-galleryid="" data-ratio="0.2074074074074074" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktbFdG2qg8cHONogj9lZH4E53PBIuIf5cbJ4uU6S3VUVoIiad062WXLygskondWyHxDicF8nYyfibRGQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktbFdG2qg8cHONogj9lZH4E53PBIuIf5cbJ4uU6S3VUVoIiad062WXLygskondWyHxDicF8nYyfibRGQ/640?wx_fmt=png"></p><section><strong><span>对上述数据进行可视化</span></strong><span></span><br></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="perl"><code><span>.libPaths(c( <span>"/home/data/t040413/R/x86_64-pc-linux-gnu-library/4.2"</span>,<span>"/home/data/t040413/R/yll/usr/local/lib/R/site-library"</span>,  <span>"/home/data/refdir/Rlib/"</span>, <span>"/usr/local/lib/R/library"</span>))</span></code><code><span>library(Seurat)</span></code><code><span>library(scRNAtoolVis)</span></code><code><span>library(colourpicker)</span></code><code><span>markers_for_all_3groups=data_forplot</span></code><code><span>head(markers_for_all_3groups)</span></code><code><span>getwd()</span></code><code><span><span># plot</span></span></code><code><span>jjVolcano(diffData = markers_for_all_3groups, </span></code><code><span>          legend.position = c(<span>0</span>.<span>93</span>, <span>0</span>.<span>99</span>), </span></code><code><span>          topGeneN=<span>2</span>,<span>#top genes to be labeled in plot, default 5.</span></span></code><code><span>          cluster.order=se<span>q(0,23,1)</span>,</span></code><code><span>          pSize=<span>0</span>.<span>4</span>,</span></code><code><span>          tile.col = c(<span>"#EE3B3B"</span>, <span>"#FF7F00"</span>, <span>"#CD6600"</span>, <span>"#8B2323"</span>, <span>"#DEB887"</span>, <span>"#76EEC6"</span>, </span></code><code><span>                     <span>"#F0FFFF"</span>, <span>"#008B8B"</span>, <span>"#FFB90F"</span>, <span>"#F5F5DC"</span>, <span>"#1F1F1F"</span>, <span>"#66CD00"</span>, </span></code><code><span>                     <span>"#0000FF"</span>, <span>"#97FFFF"</span>, <span>"#528B8B"</span>, <span>"#9400D3"</span>, <span>"#EE1289"</span>, <span>"#00BFFF"</span>, </span></code><code><span>                     <span>"#00FF00"</span>, <span>"#191970"</span>, <span>"#FFFF00"</span>, <span>"#4A708B"</span>, <span>"#00FF7F"</span>, <span>"#8B8B00"</span>, </span></code><code><span>                     <span>"#FF1493"</span>, <span>"#FFA500"</span>, <span>"#8B4513"</span>))</span></code></pre></section><p><br></p><p><strong>2.画各种基础的图 featureplot dimplot</strong><br></p><p><span>数据处理</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span><span>#request 2</span></span></code><code><span>.libPaths(c( <span>"/home/data/t040413/R/x86_64-pc-linux-gnu-library/4.2"</span>,<span>"/home/data/t040413/R/yll/usr/local/lib/R/site-library"</span>,  <span>"/home/data/refdir/Rlib/"</span>, <span>"/usr/local/lib/R/library"</span>))</span></code><code><span>library(Seurat)</span></code><code><span>getwd()</span></code><code><span>dir.create(<span>"/home/data/t040413/ipf/GSE104154_scRNA-seq_fibrotic MC_bleomycin/enrichments"</span>)</span></code><code><span>setwd(<span>"/home/data/t040413/ipf/GSE104154_scRNA-seq_fibrotic MC_bleomycin/enrichments"</span>)</span></code><code><span>getwd()</span></code><code><span>library(dplyr)</span></code><code><span><br></span></code><code><span>load(<span>"~/silicosis/silicosis_cluster_merge.rds"</span>)</span></code><code><span>All.merge<span>$Cell_subtype</span>=All.merge<span>$cell</span>.<span>type</span></span></code><code><span>table(Idents(All.merge))</span></code><code><span>subset_data=All.merge</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="cs"><code><span><span>##############################################dimp plot </span></span></code><code><span><span>if</span>(TRUE){</span></code><code><span>  pdf(<span>"2__all_celltype_tsne.pdf"</span>,width = <span>8</span>,height = <span>6</span>)</span></code><code><span>  p=DimPlot(subset_data,label = T,<span>group</span>.<span>by</span> = <span>"Cell_subtype"</span>,reduction = <span>"tsne"</span>,raster=FALSE,repel = T)</span></code><code><span>  print(p)</span></code><code><span>  dev.off()</span></code><code><span>  </span></code><code><span>  pdf(<span>"2__all_cellsubtype_tsne_split.pdf"</span>,width = <span>18</span>,height = <span>6</span>)</span></code><code><span>  p=DimPlot(subset_data,label = T,<span>group</span>.<span>by</span> = <span>"Cell_subtype"</span>,split.<span>by</span> = <span>"stim"</span>,reduction = <span>"tsne"</span>,raster=FALSE,repel = T)</span></code><code><span>  print(p)</span></code><code><span>  dev.off()</span></code><code><span> </span></code><code><span>  pdf(<span>"2_all_cellsubtype_umap.pdf"</span>,width = <span>8</span>,height = <span>6</span>)</span></code><code><span>  p=DimPlot(subset_data,label = T,<span>group</span>.<span>by</span> = <span>"Cell_subtype"</span>,raster=FALSE,repel = T)</span></code><code><span>  print(p)</span></code><code><span>  dev.off()</span></code><code><span> </span></code><code><span>  pdf(<span>"2_all_cellsubtype_umap_split.pdf"</span>,width = <span>18</span>,height = <span>6</span>)</span></code><code><span>  p=DimPlot(subset_data,label = T,<span>group</span>.<span>by</span> = <span>"Cell_subtype"</span>,split.<span>by</span> = <span>"stim"</span>,raster=FALSE,repel = T,reduction = <span>"umap"</span>)</span></code><code><span>  print(p)</span></code><code><span>  dev.off()</span></code><code><span>  </span></code><code><span>}</span></code></pre></section><p>展示其中一张<br></p><p><img data-galleryid="" data-ratio="0.6091101694915254" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksmGc2sDRSY2VTC3Ckjl7Xa2reicnohJYvt8j6kEITqRfcr9JdUafqL1vicqmVpncM1EicPInzMxF1Jg/640?wx_fmt=png" data-type="png" data-w="944" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksmGc2sDRSY2VTC3Ckjl7Xa2reicnohJYvt8j6kEITqRfcr9JdUafqL1vicqmVpncM1EicPInzMxF1Jg/640?wx_fmt=png"></p><p><br></p><p><strong>2.2 heatmap</strong><br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="http"><code><span><span>markers=FindAllMarkers(subset_data,only.pos = T,logfc.threshold = 1.1)</span></span></code><code><span>head(markers)</span></code><code><span>markers$gene=rownames(markers)</span></code><code><span>write.csv(markers,file = "markers.csv")</span></code><code><span>openxlsx::write.xlsx(markers,file = "markers.xlsx")</span></code><code><span>getwd()</span></code><code><span><br></span></code><code><span>markers %&gt;%</span></code><code><span>  group_by(cluster) %&gt;%</span></code><code><span>  top_n(n = 20, wt = avg_log2FC) -&gt; top20</span></code><code><span>DoHeatmap(subset_data, features = top20$gene)   #+ NoLegend()</span></code><code><span><br></span></code><code><span>pdf("top20_heatmap_celltypes_Legend__order_by_averageExpression.pdf")</span></code><code><span>p=DoHeatmap(subset_data, features = top20$gene)  #+  # scale_color_discrete(name = "Identity", labels = rep("",13))</span></code><code><span>print(p)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span>head(markers_for_Three_cd8subset)</span></code><code><span>#--------------------------------------------------</span></code><code><span>markers%&gt;%</span></code><code><span>  group_by(cluster) %&gt;%</span></code><code><span>  top_n(n = 5, wt = -p_val_adj) -&gt; top5</span></code><code><span>DoHeatmap(subset_data, features = top5$gene)   #+ NoLegend()</span></code><code><span><br></span></code><code><span>pdf("top5_heatmap_celltypes_Legend__order_by_p_val_adj.pdf")</span></code><code><span>p=DoHeatmap(subset_data, features = top5$gene)  #+  # scale_color_discrete(name = "Identity", labels = rep("",13))</span></code><code><span>print(p)</span></code><code><span>dev.off()</span></code><code><span><br></span></code></pre></section><p><img data-galleryid="" data-ratio="0.9545454545454546" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksmGc2sDRSY2VTC3Ckjl7XadhWbpkusWUpKmBeRITMw4QWqZEkVMptN2iaWkA4GiazPPpICeABYEZtQ/640?wx_fmt=png" data-type="png" data-w="792" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksmGc2sDRSY2VTC3Ckjl7XadhWbpkusWUpKmBeRITMw4QWqZEkVMptN2iaWkA4GiazPPpICeABYEZtQ/640?wx_fmt=png"></p><p><strong>3.如何利用单细胞数据画下面的富集分析图<br></strong></p><p><br></p><p><img data-galleryid="" data-ratio="1.4703703703703703" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksmGc2sDRSY2VTC3Ckjl7XaiaWFR7M2Y4bLBgSMXBLALmQ7VJgYjNCxiaI7qp6FwvJgSicpaasXWKWlQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksmGc2sDRSY2VTC3Ckjl7XaiaWFR7M2Y4bLBgSMXBLALmQ7VJgYjNCxiaI7qp6FwvJgSicpaasXWKWlQ/640?wx_fmt=png"></p><p><img data-galleryid="" data-ratio="1.5629629629629629" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksmGc2sDRSY2VTC3Ckjl7Xa2h2P3up0ZLvhBekrUI3Ljicia53gkziazWVZicJA6OZ9kKXpU7zXUoXviaw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksmGc2sDRSY2VTC3Ckjl7Xa2h2P3up0ZLvhBekrUI3Ljicia53gkziazWVZicJA6OZ9kKXpU7zXUoXviaw/640?wx_fmt=png"></p><p><br></p><p><br></p><p>3.1首先进行批量差异分析</p><p><span>输入数据要求</span></p><p><img data-galleryid="" data-ratio="0.23425925925925925" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksmGc2sDRSY2VTC3Ckjl7XaawwQtYTnR60wJA0DqqIZjviaoBDpWF4kIHQwGZ80oyCkBgex9aNfuTw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksmGc2sDRSY2VTC3Ckjl7XaawwQtYTnR60wJA0DqqIZjviaoBDpWF4kIHQwGZ80oyCkBgex9aNfuTw/640?wx_fmt=png"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span><span>#--------------------------------------=======================--------批量差异分析差异分析</span></span></code><code><span>DimPlot(subset_data,label = T)</span></code><code><span>table(Idents(subset_data))</span></code><code><span>head(subset_data@meta.data)</span></code><code><span>all_degs=data.frame()</span></code><code><span><br></span></code><code><span>gsub(pattern = <span>"/"</span>,replacement = <span>"_"</span>,x = <span>"yofibroblast/vascular smooth muscle cell degs.csv"</span>)</span></code><code><span><br></span></code><code><span><span>for</span> (eachgroup <span>in</span> levels(subset_data<span>$Cell_subtype</span>) ) {</span></code><code><span>  </span></code><code><span> <span># # eachgroup="nLung"</span></span></code><code><span> <span>#  subset_data2=subset_data</span></span></code><code><span> <span>#  Idents(subset_data2)=subset_data2$stim</span></span></code><code><span> <span>#  subset_data2=subset(subset_data2,idents=eachgroup)</span></span></code><code><span> <span>#  </span></span></code><code><span> <span>#  Idents(subset_data2)=subset_data2$Cell_subtype</span></span></code><code><span> <span>#  table(Idents(subset_data2))</span></span></code><code><span> <span>#  degs=FindMarkers(subset_data2,ident.1 = "SiO2_56",ident.2 = "NS_56")</span></span></code><code><span> </span></code><code><span>  subset_data2=subset(subset_data,idents = eachgroup)</span></code><code><span>  Idents(subset_data2)=subset_data2<span>$stim</span></span></code><code><span>  degs=FindMarkers(subset_data2,ident.1 = <span>"SiO2_56"</span>,ident.2 = <span>"NS_56"</span>)</span></code><code><span>  </span></code><code><span>   degs<span>$gene</span>=rownames(degs)</span></code><code><span>  degs<span>$group</span>=eachgroup</span></code><code><span>  <span>#防止类似文件名称引起的报错 Myofibroblast/vascular smooth muscle cell degs.csv': No such file or directory</span></span></code><code><span>  write.csv(degs,file = paste(gsub(pattern = <span>"/"</span>,<span>"_"</span>,x = eachgroup),<span>"degs.csv"</span>))</span></code><code><span>  <span>print</span>(paste0(eachgroup,<span>"__done"</span>))</span></code><code><span>  all_degs=rbind(degs,all_degs)</span></code><code><span>}</span></code><code><span>head(all_degs)</span></code><code><span>dim(all_degs)</span></code><code><span>write.csv(all_degs,file = <span>"./all_degs.csv"</span>)</span></code></pre></section><p><img data-galleryid="" data-ratio="0.258148631029987" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksmGc2sDRSY2VTC3Ckjl7XajFAHVmIe0aOUJz9V7cKznkJXNhiaL1EjdD9nVAZ1LIacTiaDSIsspXwg/640?wx_fmt=png" data-type="png" data-w="767" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksmGc2sDRSY2VTC3Ckjl7XajFAHVmIe0aOUJz9V7cKznkJXNhiaL1EjdD9nVAZ1LIacTiaDSIsspXwg/640?wx_fmt=png"></p><p>3.2 使用上述的all_degs进行分组批量富集分析<span>析</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>DimPlot(subset_data,label = T)</span></code><code><span>table(Idents(subset_data))</span></code><code><span>head(subset_data@meta.data)</span></code><code><span>all_degs=data.frame()</span></code><code><span>gsub(pattern = <span>"/"</span>,replacement = <span>"_"</span>,x = <span>"yofibroblast/vascular smooth muscle cell degs.csv"</span>)</span></code><code><span><br></span></code><code><span><span>for</span> (eachgroup in levels(subset_data$Cell_subtype) ) {</span></code><code><span>  </span></code><code><span> <span># # eachgroup="nLung"</span></span></code><code><span> <span>#  subset_data2=subset_data</span></span></code><code><span> <span>#  Idents(subset_data2)=subset_data2$stim</span></span></code><code><span> <span>#  subset_data2=subset(subset_data2,idents=eachgroup)</span></span></code><code><span> <span>#  </span></span></code><code><span> <span>#  Idents(subset_data2)=subset_data2$Cell_subtype</span></span></code><code><span> <span>#  table(Idents(subset_data2))</span></span></code><code><span> <span>#  degs=FindMarkers(subset_data2,ident.1 = "SiO2_56",ident.2 = "NS_56")</span></span></code><code><span> </span></code><code><span>  subset_data2=subset(subset_data,idents = eachgroup)</span></code><code><span>  Idents(subset_data2)=subset_data2$stim</span></code><code><span>  degs=FindMarkers(subset_data2,ident<span>.1</span> = <span>"SiO2_56"</span>,ident<span>.2</span> = <span>"NS_56"</span>)</span></code><code><span>  </span></code><code><span>   degs$gene=rownames(degs)</span></code><code><span>  degs$group=eachgroup</span></code><code><span>  <span>#防止类似文件名称引起的报错 Myofibroblast/vascular smooth muscle cell degs.csv': No such file or directory</span></span></code><code><span>  write.csv(degs,file = paste(gsub(pattern = <span>"/"</span>,<span>"_"</span>,x = eachgroup),<span>"degs.csv"</span>))</span></code><code><span>  <span>print</span>(paste0(eachgroup,<span>"__done"</span>))</span></code><code><span>  all_degs=rbind(degs,all_degs)</span></code><code><span>}</span></code><code><span><br></span></code><code><span>head(all_degs)</span></code><code><span>dim(all_degs)</span></code><code><span>write.csv(all_degs,file = <span>"./all_degs.csv"</span>)</span></code><code><span>getwd()</span></code><code><span><br></span></code><code><span><span>#all_degs=read.csv()</span></span></code><code><span><span>##########################----------------------enrichment analysis==================================================</span></span></code><code><span><span>#https://mp.weixin.qq.com/s/WyT-7yKB9YKkZjjyraZdPg</span></span></code><code><span>df=all_degs</span></code><code><span><span>##筛选阈值确定：p＜0.05，|log2FC|＞1</span></span></code><code><span>p_val_adj = <span>0.05</span></span></code><code><span>avg_log2FC = <span>0.6</span></span></code><code><span><span>#根据阈值添加上下调分组标签：</span></span></code><code><span>df$direction &lt;- case_when(</span></code><code><span>  df$avg_log2FC &gt; avg_log2FC &amp; df$p_val_adj &lt; p_val_adj ~ <span>"up"</span>,</span></code><code><span>  df$avg_log2FC &lt; -avg_log2FC &amp; df$p_val_adj &lt; p_val_adj ~ <span>"down"</span>,</span></code><code><span>  <span>TRUE</span> ~ <span>'none'</span></span></code><code><span>)</span></code><code><span>head(df)</span></code><code><span><br></span></code><code><span>df=df[df$direction!=<span>"none"</span>,]</span></code><code><span>head(df)</span></code><code><span>dim(df)</span></code><code><span>df$mygroup=paste(df$group,df$direction,sep = <span>"_"</span>)</span></code><code><span>head(df)</span></code><code><span>dim(df)</span></code><code><span><span>##########################----------------------enrichment analysis==================================================</span></span></code><code><span><span>#https://mp.weixin.qq.com/s/WyT-7yKB9YKkZjjyraZdPg</span></span></code><code><span>{</span></code><code><span>  library(clusterProfiler)</span></code><code><span>  library(org.Hs.eg.db) <span>#人</span></span></code><code><span>  library(org.Mm.eg.db) <span>#鼠</span></span></code><code><span>  library(ggplot2)</span></code><code><span> <span># degs_for_nlung_vs_tlung$gene=rownames(degs_for_nlung_vs_tlung)</span></span></code><code><span>  sce.markers=df</span></code><code><span>  head(sce.markers)</span></code><code><span>  </span></code><code><span>  ids=bitr(sce.markers$gene,<span>'SYMBOL'</span>,<span>'ENTREZID'</span>,<span>"org.Mm.eg.db"</span>) <span>#'org.Hs.eg.db'</span></span></code><code><span>  head(ids)</span></code><code><span>  head(sce.markers)</span></code><code><span>  sce.markers=merge(sce.markers,ids,by.x=<span>'gene'</span>,by.y=<span>'SYMBOL'</span>)</span></code><code><span>  head(sce.markers)</span></code><code><span>  dim(sce.markers)</span></code><code><span>  sce.markers=sce.markers[sce.markers$group!=<span>"none"</span>,]</span></code><code><span>  dim(sce.markers)</span></code><code><span>  head(sce.markers)</span></code><code><span>  sce.markers$cluster=sce.markers$mygroup</span></code><code><span>  dim(sce.markers)</span></code><code><span>  gcSample=split(sce.markers$ENTREZID, sce.markers$cluster)</span></code><code><span>  gcSample <span># entrez id , compareCluster </span></span></code><code><span>   <span>print</span>(<span>"===========开始go============"</span>)</span></code><code><span>  xx &lt;- compareCluster(gcSample, fun=<span>"enrichGO"</span>,OrgDb=<span>"org.Mm.eg.db"</span> ,   <span>#'org.Hs.eg.db',</span></span></code><code><span>                       pvalueCutoff=<span>0.05</span>) <span>#organism="hsa",</span></span></code><code><span> </span></code><code><span>   <span>print</span>(<span>"===========开始 kegg============"</span>)</span></code><code><span>  gg&lt;-clusterProfiler::compareCluster(gcSample,fun = <span>"enrichKEGG"</span>,</span></code><code><span>                                      keyType = <span>'kegg'</span>,  <span>#KEGG 富集</span></span></code><code><span>                                      organism=<span>'mmu'</span>,<span>#"rno",</span></span></code><code><span>                                      pvalueCutoff = <span>0.05</span> <span>#指定 p 值阈值（可指定 1 以输出全部</span></span></code><code><span>  )</span></code><code><span>  </span></code><code><span>  p=dotplot(xx) </span></code><code><span>  p=p+ theme(axis.text.x = element_text(angle = <span>90</span>, </span></code><code><span>                                      vjust = <span>0.5</span>, hjust=<span>0.5</span>))</span></code><code><span>  p</span></code><code><span>  ggsave(<span>'degs_compareCluster-GO_enrichment.pdf'</span>,plot = p,width = <span>17</span>,height = <span>25</span>,limitsize = F)</span></code><code><span>  ggsave(<span>'degs_compareCluster-GO_enrichment.png'</span>,plot = p,width = <span>17</span>,height = <span>25</span>,limitsize = F)</span></code><code><span>  </span></code><code><span>  xx</span></code><code><span>  write.csv(xx,file = <span>"compareCluster-GO_enrichment.csv"</span>)</span></code><code><span> </span></code><code><span>  p=dotplot(gg) </span></code><code><span>  p4=p+ theme(axis.text.x = element_text(angle = <span>90</span>, </span></code><code><span>                                         vjust = <span>0.5</span>, hjust=<span>0.5</span>))</span></code><code><span>  p4</span></code><code><span>  <span>print</span>(paste(<span>"保存位置"</span>,getwd(),sep = <span>"  :   "</span>))</span></code><code><span>  ggsave(<span>'degs_compareCluster-KEGG_enrichment-2.pdf'</span>,plot = p4,width = <span>16</span>,height = <span>25</span>,limitsize = F)</span></code><code><span>  ggsave(<span>'degs_compareCluster-KEGG_enrichment-2.png'</span>,plot = p4,width = <span>16</span>,height = <span>25</span>,limitsize = F)</span></code><code><span>  </span></code><code><span>  gg</span></code><code><span>  openxlsx::write.xlsx(gg,file = <span>"compareCluster-KEGG_enrichment.xlsx"</span>)</span></code><code><span>  </span></code><code><span>  </span></code><code><span>  <span>if</span> (F) { <span>#大鼠</span></span></code><code><span>    <span>print</span>(<span>"===========开始go============"</span>)</span></code><code><span>    xx &lt;-clusterProfiler::compareCluster(gcSample, fun=<span>"enrichGO"</span>,OrgDb=<span>"org.Rn.eg.db"</span>,</span></code><code><span>                                         readable=<span>TRUE</span>,</span></code><code><span>                                         ont = <span>'ALL'</span>,  <span>#GO Ontology，可选 BP、MF、CC，也可以指定 ALL 同时计算 3 者</span></span></code><code><span>                                         pvalueCutoff=<span>0.05</span>) <span>#organism="hsa", #'org.Hs.eg.db',</span></span></code><code><span>    </span></code><code><span>    <span>print</span>(<span>"===========开始 kegg============"</span>)</span></code><code><span>    gg&lt;-clusterProfiler::compareCluster(gcSample,fun = <span>"enrichKEGG"</span>,</span></code><code><span>                                        keyType = <span>'kegg'</span>,  <span>#KEGG 富集</span></span></code><code><span>                                        organism=<span>"rno"</span>,</span></code><code><span>                                        pvalueCutoff = <span>0.05</span> <span>#指定 p 值阈值（可指定 1 以输出全部</span></span></code><code><span>    )</span></code><code><span>    </span></code><code><span>    p=dotplot(xx) </span></code><code><span>    p2=p+ theme(axis.text.x = element_text(angle = <span>90</span>, </span></code><code><span>                                           vjust = <span>0.5</span>, hjust=<span>0.5</span>))</span></code><code><span>    p2</span></code><code><span>    ggsave(<span>'degs_compareCluster-GO_enrichment-2.pdf'</span>,plot = p2,width = <span>6</span>,height = <span>20</span>,limitsize = F)</span></code><code><span>    xx</span></code><code><span>    openxlsx::write.xlsx(xx,file = <span>"compareCluster-GO_enrichment.xlsx"</span>)</span></code><code><span>    <span># -----  </span></span></code><code><span>    p=dotplot(gg) </span></code><code><span>    p4=p+ theme(axis.text.x = element_text(angle = <span>90</span>, </span></code><code><span>                                           vjust = <span>0.5</span>, hjust=<span>0.5</span>))</span></code><code><span>    p4</span></code><code><span>    <span>print</span>(paste(<span>"保存位置"</span>,getwd(),sep = <span>"  :   "</span>))</span></code><code><span>    ggsave(<span>'degs_compareCluster-KEGG_enrichment-2.pdf'</span>,plot = p4,width = <span>6</span>,height = <span>12</span>,limitsize = F)</span></code><code><span>    gg</span></code><code><span>    openxlsx::write.xlsx(gg,file = <span>"compareCluster-KEGG_enrichment.xlsx"</span>)   </span></code><code><span>}  </span></code><code><span>}</span></code><code><span><br></span></code></pre></section><p><br></p><p><br></p><p>4.显著性分析</p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/T9f225KoZ2nmjJZ6TY9s8g",target="_blank" rel="noopener noreferrer">原文链接</a>
