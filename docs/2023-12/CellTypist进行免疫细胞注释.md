---
title: "CellTypist进行免疫细胞注释"
date: 2023-12-15T20:03:07Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
CellTypist进行免疫细胞注释 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">CellTypist是一个人类免疫细胞注释为主的自动注释方法，通过python和command line运行，当然了强行在R中运行也是可以的，具体参考曾老师的推文：使用 CellTypist 进行免疫细胞类型分类-腾讯云开发者社区-腾讯云 (tencent.com)</p><p data-tool="mdnice编辑器">这里还是在jupyter notebook上进行python代码运行，并且比较与其他自动注释的结果：</p><p data-tool="mdnice编辑器">首先因为目前大多数单细胞数据还是通过seurat对象在R中运行，而python中我们需要scanpy对象，这里我们进行输入数据的转换以便适配python代码：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#####转换成h5d</span><br><span>library</span>(SeuratDisk)<br>load(<span>'./scRNA_after_scMayoMap.Rdata'</span>)<br>SaveH5Seurat(sce,filename = <span>'scRNA_after_scMayoMap.h5Seurat'</span>)<br>Convert(<span>'scRNA_after_scMayoMap.h5Seurat'</span>,dest = <span>'h5ad'</span>)<br></code></pre><p data-tool="mdnice编辑器">这样我们便得到了scRNA_after_scMayoMap.h5ad这个scanpy对象</p><p data-tool="mdnice编辑器">接下来在jupyter notebook上运行如下代码：</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> os, sys<br><span>import</span> scanpy <span>as</span> sc<br><span>import</span> celltypist<br><span>from</span> celltypist <span>import</span> models<br><span>import</span> matplotlib<br><span>import</span> matplotlib.pyplot <span>as</span> plt<br><span>import</span> matplotlib.gridspec <span>as</span> gridspec<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>PublicData = <span>'./scRNA_after_scMayoMap.h5ad'</span><br>Prefix = <span>'nafld_'</span><br>OutDir = <span>'./NAFLD_celltypist_py_res'</span><br><br><span># import model</span><br>model = models.Model.load(model = <span>'Immune_All_Low.pkl'</span>)<br><span># load data</span><br>adata = sc.read_h5ad(PublicData)<br><span># annotate</span><br>predictions = celltypist.annotate(adata, model = model, majority_voting = <span>True</span>)<br><br><span># using built-in function to save results</span><br>os.mkdir(OutDir)<br>predictions.to_table(folder = OutDir, prefix = Prefix, xlsx = <span>True</span>)<br>predictions.to_plots(folder = OutDir, format = <span>'pdf'</span>, prefix = Prefix)<br><br><span># convert into adata</span><br>adata = predictions.to_adata()<br><br><span># re-plot using scanpy</span><br>fig = plt.figure(figsize=(<span>15</span>,<span>12</span>))<br>gs = gridspec.GridSpec(<span>2</span>, <span>2</span>, figure=fig)<br><span>for</span> i <span>in</span> range(<span>2</span>):<br>    <span>for</span> j <span>in</span> range(<span>2</span>):<br>        fig.add_subplot(gs[i,j])<br><br>axes = fig.axes<br><span>for</span> i <span>in</span> range(<span>4</span>):<br>    ax = axes[i]<br>    group = [<span>'seurat_clusters'</span>,<span>'predicted_labels'</span>,<span>'over_clustering'</span>,<span>'majority_voting'</span>][i]<br>    sc.pl.umap(adata, color=group, frameon=<span>False</span>, show=<span>False</span>, ax=ax, title=group, size=<span>20</span>)<br><br>plt.subplots_adjust(bottom=<span>0.1</span>, wspace=<span>0.5</span>, hspace=<span>0.2</span>)<br>plt.savefig(os.path.join(OutDir, Prefix + <span>'UMAP_by_celltype.png'</span>), dpi=<span>300</span>, bbox_inches=<span>'tight'</span>)<br><br>fig, ax = plt.subplots(figsize=(<span>12</span>,<span>8</span>))<br>celltypist.dotplot(predictions, use_as_reference=<span>'predicted_labels'</span>, use_as_prediction=<span>'majority_voting'</span>, show=<span>False</span>, ax=ax)<br>fig.savefig(os.path.join(OutDir, Prefix + <span>'dotplot_between_pred_major.png'</span>), dpi=<span>300</span>, bbox_inches=<span>'tight'</span>)<br><br><span>###########################</span><br>custom_model = celltypist.train(X=adata, labels=<span>'predicted_labels'</span>,<br>    use_SGD=<span>True</span>, n_jobs=<span>1</span>,<br>    feature_selection=<span>True</span>,<br>    details=<span>'pbmc1k'</span>,<br>    date=<span>'2023-10-26'</span>)<br><br><span># write into default path</span><br>custom_model.write(<span>f'<span>{models.models_path}</span>/CustomModel.pkl'</span>)<br></code></pre><p data-tool="mdnice编辑器">最终我们得到了nafld_annotation_result.xlsx这个文件，如下：</p><figure data-tool="mdnice编辑器"><p><img data-galleryid="" data-ratio="0.4371327849588719" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKibeCMWtWeMmibiaK5VJFF6LEdHhhPR51glvJVnAO4eKBTarkKL8JVSliacRm2pd6Z6fMJqL09SQwUqw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="851" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKibeCMWtWeMmibiaK5VJFF6LEdHhhPR51glvJVnAO4eKBTarkKL8JVSliacRm2pd6Z6fMJqL09SQwUqw/640?wx_fmt=png&amp;from=appmsg"></p><figcaption><br></figcaption></figure><p data-tool="mdnice编辑器">我们将这个结果重新赋值回sce这个seurat对象，在R中运行：</p><pre data-tool="mdnice编辑器"><span></span><code><span>####从py中回来，读取result结果</span><br><span># 安装包</span><br><span>#install.packages("openxlsx")</span><br><span>library</span>(openxlsx)<br><span># 文件名+sheet的序号</span><br>data&lt;- read.xlsx(<span>"./NAFLD_celltypist_py_res/nafld_annotation_result.xlsx"</span>, sheet = <span>1</span>)<br><span>#View(data)</span><br><span>#赋值回sce</span><br>sce@meta.data$cell&lt;-rownames(sce@meta.data)<br>colnames(data)[<span>1</span>]&lt;-<span>'cell'</span><br>sce@meta.data&lt;-merge(sce@meta.data,data,by = <span>'cell'</span>)<br><span>library</span>(Seurat)<br><span>library</span> (gplots) <br>balloonplot (table (sce$majority_voting,sce$customclassif))<br></code></pre><p data-tool="mdnice编辑器">但是我们发现结果还是有点多，足足细分成了23个细胞类型，在细胞探索初期，我们只需要分成大类即可，因此，我们手动重新分组：</p><pre data-tool="mdnice编辑器"><span></span><code>rownames(sce@meta.data)&lt;-sce$cell<br>length(unique(sce$majority_voting))<br><span>###</span><br>sce@meta.data$celltypist = <span>"NA"</span><br>Idents(sce)&lt;-<span>'majority_voting'</span><br>levels(Idents(sce)) <span>#查看细胞亚群</span><br>new.cluster.ids &lt;- c(<span>"Kupffer cells"</span>, <span>"Macrophages"</span>, <span>"T"</span>, <span>"T"</span>, <span>"NK"</span>, <span>"T"</span>,<span>"T"</span>,<br>                     <span>"NK"</span>, <span>"monocytes"</span>, <span>"T"</span>,<span>"Macrophages"</span>,<span>"monocytes"</span>,<span>"B"</span>,<span>"T"</span>,<br>                     <span>"B"</span>,<span>"Mast cells"</span>,<span>"B"</span>,<span>"Endothelial"</span>,<span>"DC"</span>,<span>"Epithelial"</span>,<span>"DC"</span>,<br>                     <span>"DC"</span>,<span>"B"</span>)<br>names(new.cluster.ids) &lt;- levels(sce)<br>sce &lt;- RenameIdents(sce, new.cluster.ids)<br>levels(sce) <br><span>#[1] "Kupffer cells" "Macrophages"   "T"             "NK"            "monocytes"    </span><br><span>#[6] "B"             "Mast cells"    "Endothelial"   "DC"            "Epithelial"  </span><br><br></code></pre><p data-tool="mdnice编辑器">oK，现在我们得到了上述几个大类细胞，并且我们比较与scType的结果：</p><pre data-tool="mdnice编辑器"><span></span><code>balloonplot (table (Idents(sce),sce$customclassif))<br></code></pre><figure data-tool="mdnice编辑器"><p><img data-galleryid="" data-ratio="0.6370370370370371" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKibeCMWtWeMmibiaK5VJFF6LEyCtTp8mWZlZpia8mPiaaRib4RmHbQDvx3Ksfwia5fya6j2Bre8x8ICiapCQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKibeCMWtWeMmibiaK5VJFF6LEyCtTp8mWZlZpia8mPiaaRib4RmHbQDvx3Ksfwia5fya6j2Bre8x8ICiapCQ/640?wx_fmt=png&amp;from=appmsg"></p><figcaption><br></figcaption></figure><p data-tool="mdnice编辑器">（横坐标是CellTypist，纵坐标是scType）</p><p data-tool="mdnice编辑器">结果发现大类上还是挺靠谱的。</p><p data-tool="mdnice编辑器">但是继续与scMayoMap对比，</p><figure data-tool="mdnice编辑器"><p><img data-galleryid="" data-ratio="0.662962962962963" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKibeCMWtWeMmibiaK5VJFF6LEwtD4YR45lvSwPeicAZX9h5lSf6lXic1qa7PWN3vvZn1dgQiaTVaEcUB8A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKibeCMWtWeMmibiaK5VJFF6LEwtD4YR45lvSwPeicAZX9h5lSf6lXic1qa7PWN3vvZn1dgQiaTVaEcUB8A/640?wx_fmt=png&amp;from=appmsg"></p><figcaption><br></figcaption></figure><p data-tool="mdnice编辑器">（横坐标是CellTypist，纵坐标是scMayoMap）</p><p data-tool="mdnice编辑器">发现由于参考数据集细胞种类的不同，scMayoMap鉴定出来的Kupffer细胞中包含了很多的T、NK细胞，这显然更加说明参考数据集的重要性，不过总得来说，CellTypist对免疫细胞进行注释，还是比较对症的，比较推荐，而且注释的速度也不算很慢，可以接受，远远不像scHCL那么抽象。</p><p data-tool="mdnice编辑器">ps：后续会更新python跑单细胞转录组全程代码，尤其是高级分析更加需要python。</p></section><section><section data-style-type="5" data-tools="新媒体排版" data-id="2440476"><section><section><section><section><img data-imgfileid="100034455" data-ratio="0.9495798319327731" data-src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif" data-type="gif" data-w="119" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif"></section><section data-brushtype="text">往期回顾</section><section><br></section></section></section></section><section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518100&amp;idx=2&amp;sn=72fd74bbb98f20ad99c114498934bbcb&amp;chksm=ea1c8116dd6b080070fa96a5901765f6b28236b3694e9bb025f3c9a964a5f24f8bfe6eb32aa1&amp;scene=21#wechat_redirect" textvalue="EcoTyper代码实操（二）：从scRNA-seq数据恢复细胞状态和生态型" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>EcoTyper代码实操（二）：从scRNA-seq数据恢复细胞状态和生态型</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518076&amp;idx=1&amp;sn=dd14899754ae8ff5e28049447427c3b8&amp;chksm=ea1c81fedd6b08e8db1761f94ff68adb5610ab5c57bf7eb40489304252cb5232fe46fc32083f&amp;scene=21#wechat_redirect" textvalue="scMayoMap-说明文档版" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>scMayoMap-说明文档版</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518084&amp;idx=1&amp;sn=47c1b5d69c2aa482479a2a969534fd82&amp;chksm=ea1c8106dd6b08101b08e8cabeea76eddf22c7f99baeca45ddd5ba0439e640c0ce0dab0dda15&amp;scene=21#wechat_redirect" textvalue="心肌梗死后心脏成纤维细胞中胶原三螺旋重复序列(CTHRC1)的重要作用" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>心肌梗死后心脏成纤维细胞中胶原三螺旋重复序列(CTHRC1)的重要作用</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247517655&amp;idx=1&amp;sn=661d1bb5d5c2112d60a572de239c88f9&amp;chksm=ea1c8355dd6b0a43f1acebd4f571e832be9fbcf685c0be3f9eb41765172935edbce0c0bd5e46&amp;scene=21#wechat_redirect" textvalue="端到端的单细胞管道SCP-整合流程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>端到端的单细胞管道SCP-整合流程</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515825&amp;idx=2&amp;sn=5122e66e005b04194ee21569d8c8245f&amp;chksm=ea1cb833dd6b312560d4da99a3ed73c7110d5ce84ae71bb8f9d3ab565de3f077521f0ff04ad0&amp;scene=21#wechat_redirect" textvalue="单细胞测序最好的教程（十）：万能的Transformer与细胞注释" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞测序最好的教程（十）：万能的Transformer与细胞注释</span></a><br></p></section></section><hr><p><br></p></section><section data-style-type="5" data-tools="新媒体排版" data-id="2440475"><hr><p><br></p><hr><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526646&amp;idx=1&amp;sn=d1728d9102f72d2ce5c425162549499d&amp;chksm=9b4b284dac3ca15b83972f3dcb45977fc78eb65b607e7961658f8586f8a4b7be2c2c43883684&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课12月班" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信入门&amp;数据挖掘线上直播课12月班</a><br></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">时隔5年，我们的生信技能树VIP学徒继续招生啦</a><br></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526168&amp;idx=1&amp;sn=ebc4a9d53d675e3f7d20b1e2f97901b8&amp;chksm=9b4b27a3ac3caeb5ee0828c38f816c229067d1946be224bcaf4bac0dbdfc9eff863c621097e2&amp;scene=21#wechat_redirect" textvalue="生物信息学江湖的开创性产品-共享服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学江湖的开创性产品-共享服务器</a></p></li></ul><p><img data-imgfileid="100034454" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-imgfileid="100034453" data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-id="93668"><section><section data-width="95%"><section><section><section data-width="38%"><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg" data-type="other" data-w="258" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" data-imgfileid="100034457" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/gUYm7bVbmI1SjeSUWwbCTQ",target="_blank" rel="noopener noreferrer">原文链接</a>
