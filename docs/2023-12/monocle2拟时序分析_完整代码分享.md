---
title: "monocle2拟时序分析-完整代码分享"
date: 2023-12-07T11:17:49Z
draft: ["false"]
tags: [
  "fetched",
  "生信小博士"
]
categories: ["Acdemic"]
---
monocle2拟时序分析-完整代码分享 by 生信小博士
------
<div><p><strong><span>大家好，关于mono</span></strong><strong><span>cle2的教程有很多，但是没看到谁放了全代码的，今天我们分享monocle2全流程代码</span></strong></p><p><strong><span>1 加载相关r包和数据</span></strong></p><p><strong><span>这里特别注意，r包之间不要有冲突，如果连第一段代码都报错，就没必要继续运行啦，说明你r包有冲突</span></strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span><span>#数据太大转到Linux服务器处理</span></span></code><code><span>.libPaths(c(<span>"/home/data/refdir/Rlib/"</span>, </span></code><code><span>            <span>"/home/data/t040413/R/x86_64-pc-linux-gnu-library/4.2"</span>, <span>"/usr/local/lib/R/library"</span>))</span></code><code><span>library(dplyr)</span></code><code><span>library(tibble)</span></code><code><span>library(ggplot2)</span></code><code><span><br></span></code><code><span>library(Seurat)</span></code><code><span><br></span></code><code><span>getwd()</span></code><code><span><br></span></code><code><span>dir.create(<span>"/home/data/t040413/p_/monocle"</span>)</span></code><code><span>setwd(<span>"/home/data/t040413/p_/monocle"</span>)</span></code><code><span><br></span></code><code><span>load(<span>"./neutrophil(rTEM+not_rTEM).rds"</span>)</span></code><code><span><br></span></code></pre></section><p><strong><span>如果有冲突，后续会出现这种报错：</span></strong><br></p><section><ul><li><li><li></ul><pre data-lang="kotlin"><code><span>cell_metadata &lt;-methods:: new(<span>'AnnotatedDataFrame'</span>,<span>data</span>=<span>subset_data@</span>meta.<span>data</span>)</span></code><code><span>Error <span>in</span> getClass(Class, <span>where</span> = topenv(parent.frame())) : </span></code><code><span>  “AnnotatedDataFrame” <span>is</span> not a defined <span><span>class</span></span></span></code></pre></section><p><br></p><p><strong><span>2 下面准备数据前期处理</span></strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span><span>subset_data@</span>meta.<span>data</span> %&gt;%head()</span></code><code><span>subset_data$celltype=subset_data$groups</span></code><code><span><br></span></code><code><span><br></span></code><code><span>DimPlot(subset_data,label = T,group.<span>by</span> = <span>"celltype"</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span>##############################################################<span>33</span>###monocle</span></code><code><span>#################################################</span></code><code><span><br></span></code><code><span>subset_data$cell.type=Idents(subset_data)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span>#Idents(subset_data)=subset_data$Idents.subset_data.</span></code><code><span><br></span></code><code><span><br></span></code><code><span>###注意使用RNA 还是SCT</span></code><code><span><br></span></code><code><span>DefaultAssay(subset_data)</span></code><code><span>DefaultAssay(subset_data)=<span>"RNA"</span></span></code><code><span>table(duplicated(rownames(subset_data)))</span></code><code><span>table(duplicated(colnames(subset_data)))</span></code><code><span>table(Idents(subset_data))</span></code><code><span>DefaultAssay(subset_data)</span></code><code><span>new.metadata &lt;- merge(<span>subset_data@</span>meta.<span>data</span>,</span></code><code><span>                      <span>data</span>.frame(Idents(subset_data)),</span></code><code><span>                      <span>by</span> = <span>"row.names"</span>,sort = FALSE)</span></code><code><span>head(new.metadata)</span></code><code><span>rownames(new.metadata)&lt;-new.metadata[,<span>1</span>]</span></code><code><span><br></span></code><code><span>#可选</span></code><code><span>head(<span>subset_data@</span>meta.<span>data</span>)</span></code><code><span>new.metadata=new.metadata[,-<span>1</span>]</span></code><code><span>head(<span>subset_data@</span>meta.<span>data</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span>identical(rownames(new.metadata),rownames(<span>subset_data@</span>meta.<span>data</span>))</span></code><code><span><br></span></code><code><span><span>subset_data@</span>meta.<span>data</span>&lt;-new.metadata</span></code><code><span>table(subset_data$cell.type,Idents(subset_data))</span></code><code><span>head(subset_data)</span></code><code><span><br></span></code><code><span>expression_matrix &lt;- <span>as</span>(<span>as</span>.matrix(<span>subset_data@</span>assays$<span>RNA@</span>counts), <span>'sparseMatrix'</span>)</span></code><code><span>head(expression_matrix)</span></code><code><span>identical(colnames(expression_matrix),rownames(new.metadata))</span></code><code><span><br></span></code><code><span><br></span></code><code><span>cell_metadata &lt;-methods:: new(<span>'AnnotatedDataFrame'</span>,<span>data</span>=<span>subset_data@</span>meta.<span>data</span>)</span></code><code><span>head(<span>subset_data@</span>meta.<span>data</span>)</span></code><code><span>head(cell_metadata)</span></code><code><span><br></span></code><code><span>gene_annotation &lt;- new(<span>'AnnotatedDataFrame'</span>,<span>data</span>=<span>data</span>.frame(gene_short_name = row.names(subset_data),</span></code><code><span>                                                            row.names = row.names(subset_data)))</span></code><code><span><br></span></code><code><span><br></span></code></pre></section><p><strong><span>3 准备好之后，看下输入数据的要求</span></strong><br></p><p><img data-galleryid="" data-imgfileid="100001123" data-ratio="0.25318940137389595" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iacAXrPG68IfNlGt9ew6mTVH3yAY7L3wVzLiaA5Zv2v9KczvSUWFo2jGPA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1019" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iacAXrPG68IfNlGt9ew6mTVH3yAY7L3wVzLiaA5Zv2v9KczvSUWFo2jGPA/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-galleryid="" data-imgfileid="100001124" data-ratio="0.2661668228678538" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iac7iadusqow5nRK7ibjhL2PcYQ90iaGhTSVW9t59nnqAcpwcRMTyqBm1iaLw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1067" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iac7iadusqow5nRK7ibjhL2PcYQ90iaGhTSVW9t59nnqAcpwcRMTyqBm1iaLw/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-galleryid="" data-imgfileid="100001125" data-ratio="0.1097972972972973" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iac5u9s4bQLsHlibvx1jMhAKXiaSE0hiaBxcq8YvFLaQ4zF9JFYkwQEXlZSw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="592" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iac5u9s4bQLsHlibvx1jMhAKXiaSE0hiaBxcq8YvFLaQ4zF9JFYkwQEXlZSw/640?wx_fmt=png&amp;from=appmsg"></p><p>如果你看不懂这些数据格式，可以听下我之前的直播，有助于你理解单细胞的数据结构：</p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2NDcxMzYwNg==&amp;mid=2247484627&amp;idx=4&amp;sn=95b0fc04c59cb2fafa481e66a452e2f5&amp;chksm=ce646a3af913e32c71b02593d1d016d85eb6884af7b54a372eab79e93606d965ef7f393a10f2&amp;scene=21#wechat_redirect" textvalue="单细胞直播三seurat数据结构与数据可视化" linktype="text" imgurl="" imgdata="null" data-itemshowtype="5" tab="innerlink" data-linktype="2">单细胞直播三seurat数据结构与数据可视化</a></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2NDcxMzYwNg==&amp;mid=2247484627&amp;idx=2&amp;sn=ef098ff5ff88d4ef49304dad02ca351c&amp;chksm=ce646a3af913e32c23be312723f1fb92d8bb30de13ef990df94664247231bb6c1ff1f7e2f9b8&amp;scene=21#wechat_redirect" textvalue="单细胞直播一理解seurat数据结构与pbmc处理流程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="5" tab="innerlink" data-linktype="2">单细胞直播一理解seurat数据结构与pbmc处理流程</a><br><br></p><p><strong><span>4 然后就需要我们加载monocle2这个r包</span></strong></p><p><strong><span>这里需要注意：去github找monocle_2.26.0有人修改好的版本，如果通过官网教程安装的monocle2，很容易报错</span></strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="properties"><code><span><span>devtools</span>:<span>:load_all("/home/data/t040413/ipf/diseased_lung_covid20/monocle/")</span></span></code><code><span><br></span></code><code><span><span>monocle_cds</span> <span>&lt;- monocle::newCellDataSet(expression_matrix,</span></span></code><code><span>                                       <span>phenoData</span> = <span>cell_metadata,</span></span></code><code><span>                                       <span>featureData</span> = <span>gene_annotation,</span></span></code><code><span>                                       <span>lowerDetectionLimit</span> = <span>0.5,</span></span></code><code><span>                                       <span>expressionFamily</span> = <span>negbinomial.size())</span></span></code><code><span><br></span></code><code><span><span>###################################################################################</span></span></code><code><span><br></span></code><code><span><span>##归一化######</span></span></code><code><span><span>cds</span> <span>&lt;- monocle_cds</span></span></code><code><span><span>cds</span> <span>&lt;- estimateSizeFactors(cds)</span></span></code><code><span><span>cds</span> <span>&lt;- estimateDispersions(cds)  ## Removing 110 outliers  #下面的cell.type 为subset_Data 的meta信息</span></span></code><code><span><span>library("BiocGenerics")#并行计算</span></span></code><code><span><span>devtools</span>:<span>:load_all("/home/data/t040413/ipf/diseased_lung_covid20/monocle/")</span></span></code><code><span><br></span></code><code><span><span>diff_test_res</span> <span>&lt;- differentialGeneTest(cds,fullModelFormulaStr = "~ cell.type")</span></span></code><code><span><br></span></code><code><span><span>### inference the pseudotrajectory########################################################</span></span></code><code><span><span># step1: select genes for orderding setOrderingFilter() #</span></span></code><code><span><span>ordering_genes</span> <span>&lt;- row.names (subset(diff_test_res, qval &lt; 0.01))</span></span></code><code><span><span>length(ordering_genes)#</span> <span>6354</span></span></code><code><span><span>cds</span> <span>&lt;- setOrderingFilter(cds, ordering_genes)  </span></span></code><code><span><span># step2: dimension reduction=&gt; reduceDimension()  DDRTree #</span></span></code><code><span><span>cds</span> <span>&lt;- reduceDimension(cds, max_components = 2,method = 'DDRTree')</span></span></code><code><span><br></span></code><code><span><span>#package.version(pkg = "monocle")</span></span></code><code><span><span># step3: ordering the cells=&gt; orderCells()</span></span></code><code><span><span>#getwd()</span></span></code><code><span><span>#source("./order_cells.R")</span></span></code><code><span><span>#unloadNamespace('monocle')</span></span></code><code><span><span>#devtools::load_all("../monocle_2.26.0 (1).tar/monocle_2.26.0 (1)/monocle/")</span></span></code><code><span><span>devtools</span>:<span>:load_all("/home/data/t040413/ipf/diseased_lung_covid20/monocle/")</span></span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>cds</span> <span>&lt;- orderCells(cds)</span></span></code><code><span><br></span></code></pre></section><p><br></p><p><strong><span>5 最后就是monocle2画图</span></strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span><br></span></code><code><span>pdf(<span>"1.pseudutime.cell.type.pre.order.pdf"</span>)</span></code><code><span>plot_cell_trajectory(cds, color_by = <span>"cell.type"</span>)  </span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span>pdf(<span>"1.pseudutime.stim.pre.order.pdf"</span>)</span></code><code><span>plot_cell_trajectory(cds, color_by = <span>"stim"</span>)  </span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span>pdf(<span>"1.pseudutime.State.pre.order.pdf"</span>)</span></code><code><span>plot_cell_trajectory(cds, color_by = <span>"State"</span>)  </span></code><code><span>dev.off()</span></code><code><span><span>###### split ########</span></span></code><code><span>pdf(<span>"2.split.pseudutime.Seurat.cell.type.pdf"</span>)</span></code><code><span>plot_cell_trajectory(cds, color_by = <span>'cell.type'</span>) + facet_wrap(~cell.type)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span>pdf(<span>"2.split.pseudutime.stim.pdf"</span>)</span></code><code><span>plot_cell_trajectory(cds, color_by = <span>"stim"</span>) + facet_wrap(~stim)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span><br></span></code><code><span>pdf(<span>"4.split.pseudutime.Seurat.State.pdf"</span>)</span></code><code><span>plot_cell_trajectory(cds, color_by = <span>'cell.type'</span>) + facet_wrap(~State)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span><br></span></code><code><span>pdf(<span>"3.split.pseudutime.Seurat.cell.type_State.pdf"</span>)</span></code><code><span>plot_cell_trajectory(cds, color_by = <span>'State'</span>) + facet_wrap(~cell.type)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span>table(pData(cds)<span>$State</span>,pData(cds)<span>$cell</span>.<span>type</span>)</span></code><code><span>openxlsx::write.xlsx(table(pData(cds)<span>$State</span>,pData(cds)<span>$cell</span>.<span>type</span>), <span>"State_cellType_summary.xlsx"</span>, colnames=T, rownames=T)</span></code><code><span><br></span></code><code><span>table(pData(cds)<span>$State</span>,pData(cds)<span>$stim</span>)</span></code><code><span>openxlsx::write.xlsx(table(pData(cds)<span>$State</span>,pData(cds)<span>$stim</span>), <span>"State_Stim_summary.xlsx"</span>, colnames=T, rownames=T)</span></code><code><span><br></span></code><code><span>getwd()</span></code></pre></section><p><strong><span>6 monocle2产生的结果：</span></strong><br></p><p><img data-galleryid="" data-imgfileid="100001127" data-ratio="0.42838874680306904" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iacwiaXrDl7z0NIr8zk3lMbk6RHZib6ibIUJtKEQc1L9Xw0zOJ0K9gJpmRBQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="782" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iacwiaXrDl7z0NIr8zk3lMbk6RHZib6ibIUJtKEQc1L9Xw0zOJ0K9gJpmRBQ/640?wx_fmt=png&amp;from=appmsg"></p><p><strong><span>7 如果想要改monocle结果的root，这个时候我们可以改root ，然后使用上面的代码重新画图</span></strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><span>##we set the state 2 as root ########state 2 with most cells in Endothelial cells</span><code><span><span>#这里设置谁为root？？</span></span></code><code><span>DimPlot(subset_data,label = T)</span></code><code><span>table(Idents(subset_data))</span></code><code><span>DefaultAssay(subset_data)</span></code><code><span>DefaultAssay(subset_data)&lt;-<span>"SCT"</span></span></code><code><span>DefaultAssay(subset_data)&lt;-<span>"RNA"</span></span></code><code><span>DimPlot(subset_data,label = T)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span>table(subset_data<span>$cell</span>.<span>type</span>)</span></code><code><span>getwd()</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#设置root</span></span></code><code><span>ds &lt;- orderCells(cds,root_state=1)</span></code><code><span><br></span></code><code><span>getwd()<span># "/home/data/t040413/ipf/fibro_myofibro_recluster/+meso_monocle"</span></span></code><code><span><br></span></code><code><span>pdf(<span>"4.pseudutime.Pseudotime.pdf"</span>)</span></code><code><span>p=plot_cell_trajectory(cds, color_by = <span>"Pseudotime"</span>)  </span></code><code><span><span>print</span>(p)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span>save(cds,file=<span>"./cds_fibroblast_using_RNA_slot.rds"</span>)</span></code><code><span><span>#######################################################</span></span></code><code><span><br></span></code><code><span><br></span></code></pre></section><p><strong><span>最后会产生这些图，涉及隐私就不全放了</span></strong><br></p><p><img data-croporisrc="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iacKjktyrRu8RR51b3nhZf7ibyvkctNq5pMNpkzsPQMLTs4YPNJojuo1dQ/640?wx_fmt=png&amp;from=appmsg" data-cropx1="0" data-cropx2="617" data-cropy1="37.36159169550173" data-cropy2="615.9325259515571" data-galleryid="" data-imgfileid="100001128" data-ratio="0.9384116693679092" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iacgPdVe0iawaZxR2xcNgxoiaX8DzpO6d2w0cPylvl98XPgsEG0ictCBAttw/640?wx_fmt=jpeg" data-type="jpeg" data-w="617" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iacgPdVe0iawaZxR2xcNgxoiaX8DzpO6d2w0cPylvl98XPgsEG0ictCBAttw/640?wx_fmt=jpeg"></p><p><img data-galleryid="" data-imgfileid="100001129" data-ratio="1.001610305958132" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iacYIH2pExCNXw35aib3Et50sWrh9SiblRW6N8FuftbHdYibZnicbM39SPDFA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="621" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SksMqp7xPZ9QeoxvBDPPr5iacYIH2pExCNXw35aib3Et50sWrh9SiblRW6N8FuftbHdYibZnicbM39SPDFA/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-imgfileid="100001131" data-ratio="1" data-type="gif" data-w="240" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"><br></p><p><img data-imgfileid="100001130" data-ratio="0.05278592375366569" data-type="other" data-w="341" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p><p><strong><span><br></span></strong></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/bVzbU-shlNgKiT-qF436Kw",target="_blank" rel="noopener noreferrer">原文链接</a>
