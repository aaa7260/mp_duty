---
title: "一起学之---单细胞三大高级分析：Monocle2（一）"
date: 2023-12-26T14:46:25Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
一起学之---单细胞三大高级分析：Monocle2（一） by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">单细胞高级分析包括：SCENIC转录因子分析；Monocle拟时序分析；细胞通讯分析</p><p data-tool="mdnice编辑器">首先是拟时序分析，目前常用的拟时序分析有很多，如<strong>Monocle2</strong>、<strong>SCUBA、Wanderlust、Wishbone、SLICER、SCOUP、Waterfall、Mpath、Monocle、TSCAN</strong>等。最常用的还是Monocle2，Monocle3目前由于稳定性差以及解读困难，因此还是Monocle2为主，本次以自己的单细胞数据为例，完整运行Monocle2代码。</p><p data-tool="mdnice编辑器">首先，如果直接安装最新版的Monocle2，在运行orderCells有个经典报错：</p><p><img data-galleryid="" data-ratio="0.1410488245931284" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxIiaAbFZwY7sGjoSDAya3Sxic6iaB1IHlKE2bpy4ibuwyVeGyicfU6sE0ibuAWwiaviaqB9SxesETXZ1eicN1g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="553" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxIiaAbFZwY7sGjoSDAya3Sxic6iaB1IHlKE2bpy4ibuwyVeGyicfU6sE0ibuAWwiaviaqB9SxesETXZ1eicN1g/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">根据生信技能树既往的推文<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247520437&amp;idx=1&amp;sn=c005c1561fc36681f70507872176d615&amp;scene=21#wechat_redirect" data-linktype="2">哪怕是在Linux服务器也可以解决monocle2的orderCells报错</a>，进行解决：</p><pre data-tool="mdnice编辑器"><span></span><code># 先在命令行 wget 安装包<br>cd ~<span>/<br>wget -c https:/</span><span>/github.com/</span>cole-trapnell-lab/monocle-release/files/<span>10134172</span>/monocle_2<span>.26</span><span>.0</span>.tar.gz<br></code></pre><p data-tool="mdnice编辑器">然后再在 Rstudio 上安装，采用源码安装的方式：</p><pre data-tool="mdnice编辑器"><span></span><code>install.packages(<span>"./monocle_2.26.0.tar.gz"</span>, repos = <span>NULL</span>, type=<span>"source"</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>####</span><br>rm(list = ls())<br>dir.create(<span>"monocleDir_test"</span>)  <span>###创建分析目录</span><br>setwd(dir = <span>"monocleDir_test"</span>) <span>### 设置工作路径</span><br><span>require</span>(monocle) <br><span>require</span>(Seurat)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>########################### 创建 Monocle 对象 #######################</span><br>load(<span>'../scRNA_after_sctype.Rdata'</span>)<br>SObjectNew&lt;-sce[,sce@meta.data$customclassif%<span>in</span>%c(<span>'Macrophages'</span>,<span>'Endothelial'</span>,<span>'Dendritic cells'</span>)]<br><span># 提取表达矩阵</span><br>Counts&lt;-GetAssayData(object = SObjectNew, slot = <span>'counts'</span>,assay=<span>"RNA"</span>)<br><span># 获取基因注释信息</span><br>gene_annotation &lt;- data.frame(gene_short_name=rownames(Counts),biotype=rep(<span>"protein_coding"</span>,nrow(Counts)))<br>rownames(gene_annotation)&lt;-rownames(Counts)<br><span># 获取细胞注释信息</span><br>sample_sheet&lt;-as.data.frame(SObjectNew@meta.data)<br>sample_sheet&lt;-cbind(rownames(sample_sheet),sample_sheet)<br>colnames(sample_sheet)[<span>1</span>]&lt;-<span>"cell"</span><br><span># 细胞注释信息与表达矩阵信息细胞对齐</span><br>sample_sheet&lt;-as.data.frame(t(subset(t(sample_sheet),select=colnames(Counts))))<br><span># 创建 monocle Object</span><br>pd &lt;- new(<span>"AnnotatedDataFrame"</span>, data = sample_sheet)<br>fd &lt;- new(<span>"AnnotatedDataFrame"</span>, data = gene_annotation)<br>HSMM &lt;- newCellDataSet(Counts,phenoData = pd, featureData = fd,expressionFamily = negbinomial.size())<br><span>#fData(HSMM)</span><br><span>########################### 数据预处理 #######################</span><br><span># 估计尺度因子</span><br>HSMM &lt;- estimateSizeFactors(HSMM)<br><span># 估计离散度</span><br>HSMM &lt;- estimateDispersions(HSMM)<br><span># 过滤基因</span><br>HSMM &lt;- detectGenes(HSMM, min_expr = <span>1.0</span>) <span>#</span><br>expressed_genes &lt;- row.names(subset(fData(HSMM),num_cells_expressed &gt;= <span>50</span>))<br><span># 计算Cluster间的marker基因</span><br>diff_test_res &lt;- differentialGeneTest(HSMM[expressed_genes,],fullModelFormulaStr = <span>"~customclassif"</span>)<br><span># 筛选差异基因</span><br>ordering_genes &lt;- row.names (subset(diff_test_res, qval &lt; <span>0.001</span>))<br>HSMM &lt;- setOrderingFilter(HSMM, ordering_genes)<br><span># 指定Cluster颜色分配</span><br><span>library</span>(<span>"scales"</span>)<br>cluster_vec &lt;- as.character(seq(from=<span>0</span>,to=<span>10</span>,by=<span>1</span>))<br>hex_codes2 &lt;- hue_pal()(length(cluster_vec))<br>names(hex_codes2)&lt;-cluster_vec<br>hex_codes2&lt;-hex_codes2[<span>1</span>:<span>9</span>]<br><span># 可视化数据分布</span><br>plotg&lt;-plot_ordering_genes(HSMM)<br>plotg<br></code></pre><p><img data-galleryid="" data-ratio="0.9915611814345991" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxIiaAbFZwY7sGjoSDAya3SxiclYQobx86rGkicEWoFdNGm6INTVEukEib761q4yOPnD2tMGvibNgfBcibvw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="948" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxIiaAbFZwY7sGjoSDAya3SxiclYQobx86rGkicEWoFdNGm6INTVEukEib761q4yOPnD2tMGvibNgfBcibvw/640?wx_fmt=png&amp;from=appmsg"></p><pre data-tool="mdnice编辑器"><span></span><code><span>########################### 构建树细胞排序 #######################</span><br><span># DDRTree 降维</span><br>HSMM_myo &lt;- reduceDimension(HSMM, max_components = <span>2</span>, method = <span>'DDRTree'</span>)<br><span># 细胞排序计算假时间（默认）</span><br><span>#save(HSMM_myo,file = 'tem_HSMM_myo.Rdata')</span><br>print(<span>'已经保存好HSMM_myo了'</span>)<br><span>#load('./monocleDir/tem_HSMM_myo.Rdata')</span><br>HSMM_myo &lt;- orderCells(HSMM_myo)<br><span># 根据细胞状态划分进行排序。</span><br><span># HSMM_myo1 &lt;- orderCells(HSMM_myo ,root_state =2)</span><br><span># 可视化</span><br>p1&lt;-plot_cell_trajectory(HSMM_myo, color_by = <span>"customclassif"</span>)+theme(legend.position=<span>"right"</span>)+ scale_color_manual(values = hex_codes2, name = <span>"customclassif"</span>)<br>ggsave(filename = <span>"plot_cell_trajectory.customclassif.png"</span>,width = <span>6</span>,height = <span>6</span>,plot = p1)<br><br></code></pre><p><img data-galleryid="" data-ratio="0.9851851851851852" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxIiaAbFZwY7sGjoSDAya3SxicpVxRBat7lcS7TOBm9PQ46BkRIOLW8USKmExKSfclh5sScR1sxS1c5Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="945" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxIiaAbFZwY7sGjoSDAya3SxicpVxRBat7lcS7TOBm9PQ46BkRIOLW8USKmExKSfclh5sScR1sxS1c5Q/640?wx_fmt=png&amp;from=appmsg"></p><pre data-tool="mdnice编辑器"><span></span><code><span>##############假时间及状态展示</span><br>p&lt;-plot_cell_trajectory(HSMM_myo, color_by = <span>"Pseudotime"</span>)+theme(legend.position=<span>"right"</span>)<br>ggsave(filename = <span>"plot_cell_trajectory.Pseudotime.png"</span>,width = <span>4</span>,height = <span>4</span>,plot = p)<br><br>p&lt;-plot_cell_trajectory(HSMM_myo, color_by = <span>"State"</span>)<br>ggsave(filename = <span>"plot_cell_trajectory.State.png"</span>,width = <span>5</span>,height = <span>4</span>,plot = p)<br><br>p&lt;-plot_cell_trajectory(HSMM_myo, color_by = <span>"customclassif"</span>) +facet_wrap(~customclassif, nrow = <span>1</span>)<br>p&lt;-p+theme(legend.position=<span>"right"</span>)+ scale_color_manual(values = hex_codes2, name = <span>"customclassif"</span>)<br>ggsave(filename = <span>"plot_cell_trajectory.customclassif.facet_wrap.png"</span>,width = <span>13</span>,height = <span>4</span>,plot = p)<br>print(<span>'monocle完成'</span>)<br></code></pre><p><img data-ratio="1.0042780748663103" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxIiaAbFZwY7sGjoSDAya3SxiciaWibBgRfYQpQ4UYL6yVLAjGAdtiaDu6QvYiahwMFYI0U4WS1w0PUYgF0Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="935" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxIiaAbFZwY7sGjoSDAya3SxiciaWibBgRfYQpQ4UYL6yVLAjGAdtiaDu6QvYiahwMFYI0U4WS1w0PUYgF0Q/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-ratio="0.7925925925925926" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxIiaAbFZwY7sGjoSDAya3SxicBvNuzKiap5sKFJalickQ7lG3Vm1SFSAM5NoQCu4JKg6IH4oYBgfLdSxw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxIiaAbFZwY7sGjoSDAya3SxicBvNuzKiap5sKFJalickQ7lG3Vm1SFSAM5NoQCu4JKg6IH4oYBgfLdSxw/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-ratio="0.3055555555555556" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxIiaAbFZwY7sGjoSDAya3SxiclzFPrKbeBLMGyq3LPsFdIU4rY5ibe6OFm8eiaTRxO1QpjkicWEAkRohmg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxIiaAbFZwY7sGjoSDAya3SxiclzFPrKbeBLMGyq3LPsFdIU4rY5ibe6OFm8eiaTRxO1QpjkicWEAkRohmg/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">另外，本次所用的对象SObjectNew：</p><pre data-tool="mdnice编辑器"><span></span><code>An object of class Seurat <br>19739 features across 3671 samples within 1 assay <br>Active assay: RNA (19739 features, 2000 variable features)<br> 3 dimensional reductions calculated: pca, harmony, umap<br></code></pre><p data-tool="mdnice编辑器">这是一个3671个细胞的seurat对象，运行时长大概不到半个小时，在测试35000多个细胞的seurat对象时，整整用了7、8个小时，因此用linux后台运行比较稳定。</p><p data-tool="mdnice编辑器">因此可以在Linux终端运行如下代码：</p><pre data-tool="mdnice编辑器"><span></span><code>nohup Rscript monocle_script_test.R&gt;monocle1122.log &amp;<br></code></pre><p data-tool="mdnice编辑器">nohup &amp;是后台运行的意思，R脚本是monocle_script_test.R，运行日志保存在monocle1122.log中，我们可以在脚本中加入一些提示词，帮助我们定位可能的出错。</p><p data-tool="mdnice编辑器">下一篇，我们结合生物学意义对Monocle2结果进行解读。</p></section><section><p><br></p><p><br></p><section data-style-type="5" data-tools="新媒体排版" data-id="2440476"><section><section><section><section><img data-ratio="0.9495798319327731" data-src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif" data-type="gif" data-w="119" data-width="100%" data-imgfileid="100034731" src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif"></section><section data-brushtype="text">往期回顾</section><section><br></section></section></section></section><section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518349&amp;idx=1&amp;sn=d407b6d09adacbdfe8c9f047106068b0&amp;chksm=ea1c8e0fdd6b0719f800a495c2ea2718d3e1c3d17d0c10c88e766165fe44068207e04c98f6ad&amp;scene=21#wechat_redirect" textvalue="晚期胆道癌微环境中不同免疫群体的单细胞图谱" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>晚期胆道癌微环境中不同免疫群体的单细胞图谱</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518314&amp;idx=1&amp;sn=b53feba8104cfb9a377518852e871c66&amp;chksm=ea1c8ee8dd6b07fe16b1b6e2f7b28e81aeaf17d0f4b159dd56112b6dd1d0585c7d60f2cad8fb&amp;scene=21#wechat_redirect" textvalue="使用Seurat的v5来读取多个10x的单细胞转录组矩阵" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>使用Seurat的v5来读取多个10x的单细胞转录组矩阵</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518295&amp;idx=1&amp;sn=f97bd58d2c21122ba5c7d250f7fa709e&amp;chksm=ea1c8ed5dd6b07c326ad45dad30e1e718b84e8dfd80c0369b0d3d662040405292d0d2bbd13cb&amp;scene=21#wechat_redirect" textvalue="初试Seurat的V5版本" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>初试Seurat的V5版本</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518268&amp;idx=1&amp;sn=81a80b2b0de4aa7bd30b3fe7950f8080&amp;chksm=ea1c8ebedd6b07a8fa798adecdd76f9cb25d3a06bc7923c8e89bc8d7dba3f6426f51e95d6235&amp;scene=21#wechat_redirect" textvalue="一起学之---单细胞Symphony自动注释" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>一起学之---单细胞Symphony自动注释</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518268&amp;idx=2&amp;sn=311746134d9a1478e6edf4208e974546&amp;chksm=ea1c8ebedd6b07a8131a1e6f047177e3f3bcb216ef54354abd7cd9d30b42c90e8453ca714433&amp;scene=21#wechat_redirect" textvalue="一起学之---scType自动注释" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>一起学之---scType自动注释</span></a><br></p></section></section><hr><p><br></p></section><section data-style-type="5" data-tools="新媒体排版" data-id="2440475"><hr><p><br></p><hr><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527207&amp;idx=1&amp;sn=fb9ca814003fc24e9ec8b1bcecbd1d56&amp;chksm=9b4b2b9cac3ca28afc5b68047e5f0587b6636d52879051decd573009e38313c5f7d6b0d1927d&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课2024年1月班" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"><span>生信入门&amp;数据挖掘线上直播课2024年1月班</span></a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"><span>时隔5年，我们的生信技能树VIP学徒继续招生啦</span></a><br></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526168&amp;idx=1&amp;sn=ebc4a9d53d675e3f7d20b1e2f97901b8&amp;chksm=9b4b27a3ac3caeb5ee0828c38f816c229067d1946be224bcaf4bac0dbdfc9eff863c621097e2&amp;scene=21#wechat_redirect" textvalue="生物信息学江湖的开创性产品-共享服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"><span>生物信息学江湖的开创性产品-共享服务器</span></a></p></li></ul><p><img data-imgfileid="100034727" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-imgfileid="100034729" data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-id="93668"><section><section data-width="95%"><section><section><section data-width="38%"><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-imgfileid="100034728" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg" data-type="other" data-w="258" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><p><br></p></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/rgT5VCT0fqvhrTwZOtnaWA",target="_blank" rel="noopener noreferrer">原文链接</a>
