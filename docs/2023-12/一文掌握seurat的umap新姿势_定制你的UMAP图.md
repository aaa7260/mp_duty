---
title: "一文掌握seurat的umap新姿势，定制你的UMAP图"
date: 2023-12-01T08:38:21Z
draft: ["false"]
tags: [
  "fetched",
  "生信小博士"
]
categories: ["Acdemic"]
---
一文掌握seurat的umap新姿势，定制你的UMAP图 by 生信小博士
------
<div><p><strong><span>大家好，欢迎来到单细胞</span><span>图片美化专辑！本文ump图，大致有四种中，欢迎个性化定制。</span></strong></p><hr><p><span>目录：</span></p><ul><li><p>1#1 将坐标轴进行缩放</p></li><li><p><span>2#2 给umap添加圆圈</span></p></li><li><p>3 #3.1美化标签<br></p></li><li><p>3#3.2 配色调整</p></li><li><p>4 # 4 我认为最美umap 图</p><p><br></p></li></ul><p><strong>首先读取seruat官网的pbmc示例数据，待画个性umap图</strong><br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="makefile"><code><span>.libPaths(c( "/home/data/t040413/R/x86_64-pc-linux-gnu-library/4.2",</span></code><code><span>             "/home/data/t040413/R/yll/usr/local/lib/R/site-library",  </span></code><code><span>             "/home/data/refdir/Rlib/", "/usr/local/lib/R/library"))</span></code><code><span>library(Seurat)</span></code><code><span>library(SeuratData)</span></code><code><span>library(dplyr)</span></code><code><span><br></span></code><code><span><br></span></code><code><span>pbmc=readRDS("~/gzh/featureplot_dotplot_vlnplot/pbmc3k_final.rds")</span></code><code><span><br></span></code><code><span>DimPlot(pbmc,label=TRUE)</span></code><code><span><br></span></code></pre></section><p><br></p><ul><li><p><strong>1 将坐标轴进行缩放,这样的umap图你喜欢吗</strong></p></li></ul><p><img data-galleryid="" data-imgfileid="100000980" data-ratio="0.7484662576687117" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skvpia77y7TL0kjxkia1mhgHqkn59fVc6LibdCX9UwYSJZNBOia8Xv5NtjS16w0vpwickPL2hoVHxgVjAsQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="815" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skvpia77y7TL0kjxkia1mhgHqkn59fVc6LibdCX9UwYSJZNBOia8Xv5NtjS16w0vpwickPL2hoVHxgVjAsQ/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>1#将坐标轴进行缩放</span></code><code><span><br></span></code><code><span>##调用第三方包</span></code><code><span>#install.packages('tidydr')</span></code><code><span>library(tidydr)</span></code><code><span>library(ggplot2)</span></code><code><span>##绘图</span></code><code><span>DimPlot(pbmc, reduction = "umap", label = TRUE, pt.size = 1.2) + </span></code><code><span>  tidydr::theme_dr(xlength = 0.2, </span></code><code><span>           ylength = 0.2,</span></code><code><span>           arrow = arrow(length = unit(0.2, "inches"),type = "closed")) +</span></code><code><span>  theme(panel.grid = element_blank(),</span></code><code><span>        axis.title = element_text(face = 2,hjust = 0.03)) +</span></code><code><span>  NoLegend()</span></code><code><span><br></span></code></pre></section><p><br></p><p><br></p><ul><li><p><strong>2给umap添加圆圈，代码分为两步</strong></p></li></ul><p><img data-galleryid="" data-imgfileid="100000981" data-ratio="0.7247191011235955" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skvpia77y7TL0kjxkia1mhgHqk5Cha8NWFdibfuW8frKI7GV9rYu3yH9nTTpn28v964qBrkznbET3PmibA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="890" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skvpia77y7TL0kjxkia1mhgHqk5Cha8NWFdibfuW8frKI7GV9rYu3yH9nTTpn28v964qBrkznbET3PmibA/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="perl"><code><span><br></span></code><code><span>2#-给umap添加圆圈</span></code><code><span><br></span></code><code><span><br></span></code><code><span>2.1###首先提取umap数据</span></code><code><span>table( pbmc@active.ident)</span></code><code><span>pbmc[['cellType']] = pbmc@active.ident</span></code><code><span>umap = pbmc@reductions$umap@cell.embeddings %&gt;%  </span></code><code><span>  as.data.frame() %&gt;% </span></code><code><span>  cbind(cellType = pbmc@meta.data$cellType)</span></code><code><span><br></span></code><code><span>head(umap)</span></code><code><span><br></span></code><code><span>2.2##调用第三方包</span></code><code><span>library(ggunchull)</span></code><code><span>##绘图</span></code><code><span>ggplot(umap,aes(x = UMAP_1, y = UMAP_2,fill = cellType, color = cellType)) +</span></code><code><span>  theme_dr(xlength = 0.2, </span></code><code><span>           ylength = 0.2,</span></code><code><span>           arrow = arrow(length = unit(0.2, "inches"),type = "closed")) +</span></code><code><span>  stat_unchull(alpha = 0.7, size = 0.5,lty = 2) +</span></code><code><span>  geom_point(size = 0.3,show.legend = F) +</span></code><code><span>  theme(</span></code><code><span>    aspect.ratio = 1,</span></code><code><span>    panel.background = element_blank(),</span></code><code><span>    panel.grid = element_blank(),</span></code><code><span>    axis.line = element_line(arrow = arrow(type = "closed")),</span></code><code><span>    axis.title = element_text(face = 2,hjust = 0.03)) +</span></code><code><span>  guides(fill = guide_legend(override.aes = list(colour = "white", linetype = 1, size = 1)))</span></code><code><span><br></span></code><code><span><br></span></code></pre></section><p><br></p><ul><li><p><strong>3.1给umap图加方框</strong><br></p></li></ul><p><img data-galleryid="" data-imgfileid="100000982" data-ratio="0.7444574095682613" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skvpia77y7TL0kjxkia1mhgHqkY5wThBYLXZsdO9A26XoFoicHLTjaSdScLBhkwMOyuiaPRYoI1ib72ztNw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="857" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skvpia77y7TL0kjxkia1mhgHqkY5wThBYLXZsdO9A26XoFoicHLTjaSdScLBhkwMOyuiaPRYoI1ib72ztNw/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="xml"><code><span><br></span></code><code><span>3 #3.1美化标签----</span></code><code><span>##调用第三方包</span></code><code><span>library(ggrepel)</span></code><code><span>##提取umap数据</span></code><code><span>pbmc[['cellType']] = pbmc@active.ident</span></code><code><span>umap = pbmc@reductions$umap@cell.embeddings %&gt;%  </span></code><code><span>  as.data.frame() %&gt;% </span></code><code><span>  cbind(cellType = pbmc@meta.data$cellType)</span></code><code><span><br></span></code><code><span>##计算标签中心位置区域</span></code><code><span>celltypepos &lt;- umap %&gt;%</span></code><code><span>  group_by(cellType) %&gt;%</span></code><code><span>  summarise(</span></code><code><span>    umap_1 = median(UMAP_1),</span></code><code><span>    umap_2 = median(UMAP_2))</span></code><code><span><br></span></code><code><span>##画图</span></code><code><span>p &lt;-  DimPlot(pbmc, reduction = "umap", label = FALSE, pt.size = 1.2) + </span></code><code><span>  theme_dr(xlength = 0.2, </span></code><code><span>           ylength = 0.2,</span></code><code><span>           arrow = arrow(length = unit(0.2, "inches"),type = "closed")) +</span></code><code><span>  theme(panel.grid = element_blank(),</span></code><code><span>        axis.title = element_text(face = 2,hjust = 0.03)) +</span></code><code><span>  NoLegend() +</span></code><code><span>  geom_label_repel(aes(x = umap_1,y = umap_2,label = cellType,color = cellType), </span></code><code><span>                   fontface = "bold",</span></code><code><span>                   data = celltypepos,</span></code><code><span>                   box.padding = 0.5)</span></code><code><span>p</span></code><code><span><br></span></code></pre></section><p><br></p><p><br></p><p><br></p><ul><li><p><strong>3.2 不同杂志的配色方案，<span>可以自定义配色方案。。</span>这里列举四例</strong><br></p></li></ul><p><img data-galleryid="" data-imgfileid="100000983" data-ratio="0.7157407407407408" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skvpia77y7TL0kjxkia1mhgHqkPFtH2cPtNxbFdWQLKoEr547R2lcGh2DUSG7yB6icRCdFfaw7ZYAvgqg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skvpia77y7TL0kjxkia1mhgHqkPFtH2cPtNxbFdWQLKoEr547R2lcGh2DUSG7yB6icRCdFfaw7ZYAvgqg/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="cpp"><code><span><br></span></code><code><span>3#3.2 配色调整----</span></code><code><span><br></span></code><code><span><br></span></code><code><span>##调用第三方包</span></code><code><span>library(ggsci)</span></code><code><span>##随机选取四种色系展示</span></code><code><span>p1 &lt;- p + scale_color_aaas() + labs(title = "aaas", tag = "A")</span></code><code><span>p2 &lt;- p + scale_color_npg() + labs(title = "npg", tag = "B")</span></code><code><span>p3 &lt;- p + scale_color_igv() + labs(title = "igv", tag = "C")</span></code><code><span>p4 &lt;- p + scale_color_jco() + labs(title = "jco", tag = "D")</span></code><code><span>##图形组合</span></code><code><span>patchwork::wrap_plots(p1,p2,p3,p4,ncol = 2)</span></code><code><span><br></span></code></pre></section><p><br></p><ul><li><p><strong><span></span>4. 我认为最美的个性化umap图</strong><br></p></li></ul><p><img data-galleryid="" data-imgfileid="100000984" data-ratio="0.850925925925926" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skvpia77y7TL0kjxkia1mhgHqkOzQfXOZ8Z54Kicwwyc1NtpZz3ibMibBOpR2zaF1fU43Pc0ZODMBBWBOwQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Skvpia77y7TL0kjxkia1mhgHqkOzQfXOZ8Z54Kicwwyc1NtpZz3ibMibBOpR2zaF1fU43Pc0ZODMBBWBOwQ/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="ruby"><code><span><br></span></code><code><span>4 # 4 最美umap 图 -------</span></code><code><span>4.1 #添加标签在图上 ，计算每个cluster的median 坐标位置</span></code><code><span>pbmc[['cell_type']] = pbmc@active.ident</span></code><code><span>umap = pbmc@reductions$umap@cell.embeddings %&gt;%    #坐标信息</span></code><code><span>  as.data.frame() %&gt;% </span></code><code><span>  cbind(cell_type = pbmc@meta.data$cell_type) # 注释后的cell_type信息</span></code><code><span>head(umap)</span></code><code><span>4.2 #计算每个细胞类型的median 坐标位置，留作在图上加标签</span></code><code><span>cell_type_med &lt;- umap %&gt;%</span></code><code><span>  group_by(cell_type) %&gt;%</span></code><code><span>  summarise(</span></code><code><span>    UMAP_1 = median(UMAP_1),</span></code><code><span>    UMAP_2 = median(UMAP_2)</span></code><code><span>  )</span></code><code><span>head(cell_type_med)</span></code><code><span><br></span></code><code><span>4.3 #设定自己喜欢的颜色</span></code><code><span>allcolour=c("#DC143C","#0000FF","#20B2AA","#FFA500","#9370DB","#98FB98","#F08080","#1E90FF","#7CFC00","#FFFF00",            "#808000","#FF00FF","#FA8072","#7B68EE","#9400D3","#800080","#A0522D","#D2B48C","#D2691E","#87CEEB","#40E0D0","#5F9EA0",            "#FF1493","#0000CD","#008B8B","#FFE4B5","#8A2BE2","#228B22","#E9967A","#4682B4","#32CD32","#F0E68C","#FFFFE0","#EE82EE",            "#FF6347","#6A5ACD","#9932CC","#8B008B","#8B4513","#DEB887")</span></code><code><span>p &lt;- ggplot(umap,aes(x= UMAP_1 , y = UMAP_2 ,color = cell_type)) +  </span></code><code><span>  geom_point(size = 1 , alpha =1 )  + </span></code><code><span>  scale_color_manual(values = allcolour);p</span></code><code><span><br></span></code><code><span>p  +</span></code><code><span>  theme(</span></code><code><span>    legend.title = element_blank(), #去掉legend.title </span></code><code><span>    legend.key=element_rect(fill='white'), #</span></code><code><span>    legend.text = element_text(size=20), #设置legend标签的大小</span></code><code><span>    legend.key.size=unit(1,'cm') ) +  # 设置legend标签之间的大小</span></code><code><span>  guides(color = guide_legend(override.aes = list(size=5)))  + #设置legend中 点的大小 </span></code><code><span><br></span></code><code><span>  #缩放坐标轴</span></code><code><span>  tidydr:: theme_dr(xlength = 0.2, </span></code><code><span>                    ylength = 0.2,</span></code><code><span>                    arrow = arrow(length = unit(0.2, "inches"),type = "closed")) +</span></code><code><span>  #添加圈圈</span></code><code><span>  ggunchull::stat_unchull(alpha = 0.1, size = 0.5,lty = 2)  +</span></code><code><span><br></span></code><code><span><br></span></code><code><span>  #添加注释 repel防止标签重叠，把注释加到图片的点上去</span></code><code><span>  ggrepel:: geom_label_repel(aes(label=cell_type), fontface="bold",data = cell_type_med,</span></code><code><span>                             point.padding=unit(0.3, "lines")) +</span></code><code><span><br></span></code><code><span>  # #去掉legend</span></code><code><span>  # ggrepel::geom_label_repel(aes(label=cell_type), fontface="bold",data = cell_type_med,</span></code><code><span>  #                  point.padding=unit(0.5, "lines")) +</span></code><code><span>  theme(legend.position = "none") +</span></code><code><span><br></span></code><code><span>  #去掉网格</span></code><code><span>  theme(panel.grid = element_blank(),</span></code><code><span>        axis.title = element_text(face = 2,hjust = 0.03))</span></code><code><span><br></span></code><code><span>head(umap)</span></code><code><span><br></span></code><code><span># #去掉网格线，坐标轴和背景色</span></code><code><span># theme(panel.grid.major = element_blank(), #主网格线</span></code><code><span>#       panel.grid.minor = element_blank(), #次网格线</span></code><code><span>#       panel.border = element_blank(), #边框</span></code><code><span>#       axis.title = element_blank(),  #轴标题</span></code><code><span>#       axis.text = element_blank(), # 文本</span></code><code><span>#       axis.ticks = element_blank(),</span></code><code><span>#       panel.background = element_rect(fill = 'white'), #背景色</span></code><code><span>#       plot.background=element_rect(fill="white"))  +</span></code><code><span>#调整标签大小，标签点的大小以及 标签之间的距离</span></code><code><span><br></span></code></pre></section><p><br></p><p><strong>如果你对umap画图所用到的数据不理解，可以回看我的第三场直播，让你举一反三、触类旁通</strong></p><section><iframe data-vidtype="2" data-mpvid="wxv_3216457957320818693" data-cover="http%3A%2F%2Fmmbiz.qpic.cn%2Fsz_mmbiz_jpg%2FxVhD7345SkuDYxS1hbicJ4YYtlqKp6sJxRicTllQmkJDMeFb8YnowXIz3ibnt6m3NyddzwrvF3MHVyiafHEW8K3TUw%2F0%3Fwx_fmt%3Djpeg" allowfullscreen="" frameborder="0" data-ratio="1.7777777777777777" data-w="1920" data-src="https://mp.weixin.qq.com/mp/readtemplate?t=pages/video_player_tmpl&amp;action=mpvideo&amp;auto=0&amp;vid=wxv_3216457957320818693"></iframe></section><p><br></p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/qFqDMS9huCSibYtF85ri4w",target="_blank" rel="noopener noreferrer">原文链接</a>
