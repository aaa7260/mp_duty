---
title: "我以为热图只能画数值型数据，万万没想到..."
date: 2023-12-11T00:46:02Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
我以为热图只能画数值型数据，万万没想到... by 生信星球
------
<div><section data-mpa-powered-by="yiban.io"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第780天</strong></span></span><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><section><span><span>   </span><span>大神一句话，菜鸟跑半年。我不是大神，但我可以缩短你走弯路的半年~</span></span></section><section><span>   就像歌儿唱的那样，如果你不知道该往哪儿走，就留在这学点生信好不好~</span></section><section><span>   这里有豆豆和花花的学习历程，从新手到进阶，生信路上有你有我!</span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h4 data-tool="mdnice编辑器"><span>0.需求</span></h4><p data-tool="mdnice编辑器">今天在群里看到一个非常漂亮的热图，我以为是什么奇怪的新R包画的，转了一圈发现原来还是大名鼎鼎的ComplexHeatmap丫。今天的代码都是在作者写的书基础上探索学习的，书在：https://jokergoo.github.io/ComplexHeatmap-reference/book/</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6338709677419355" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosibBD5zhePSk2arGAse0IGVL6sEvjCS0n1IDLL4INDialolF9IgXqUMicVQ/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosibBD5zhePSk2arGAse0IGVL6sEvjCS0n1IDLL4INDialolF9IgXqUMicVQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">这个图和普通热图的不同点：</p><ul data-tool="mdnice编辑器"><li><section>数据是离散型的，与常规的数值型热图不同。</section></li><li><section>每行单独配色，颜色逐行变化</section></li><li><section>左右两边都有文字</section></li><li><section>划分的不同板块有格子</section></li></ul><h4 data-tool="mdnice编辑器"><span>1.学习普通的离散型热图</span></h4><p data-tool="mdnice编辑器">以前画的热图无一例外都是连续型数值，这次是离散型数据咯，矩阵里面只有四个取值，所以就只有四个颜色。如果不指定的话，颜色就是随机的：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>library(ComplexHeatmap)<br>library(RColorBrewer)<br>library(circlize)<br>discrete_mat = matrix(sample(letters[1:4], 100, replace = TRUE), 10, 10)<br>Heatmap(t(discrete_mat), <br>        column_split = discrete_mat[, 1],<br>        top_annotation = HeatmapAnnotation(group = discrete_mat[, 1]),<br>        border = T)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosiboKWWJ0aiboNiaTkicVb0adfibH9KYLMs0qZRzqqDRHHxaMfXlzZZrSaz2w/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosiboKWWJ0aiboNiaTkicVb0adfibH9KYLMs0qZRzqqDRHHxaMfXlzZZrSaz2w/640?wx_fmt=png"><figcaption>请忽略配色</figcaption></figure><p data-tool="mdnice编辑器"><strong>切割、加边框、加注释</strong>这样的操作，参数还是蛮好找的。</p><p data-tool="mdnice编辑器">编一个类似于上面那张图的输入数据，画画看。每一行都是有重复值的不同向量，并且向量的取值数量都是有限的。</p><pre data-tool="mdnice编辑器"><span></span><code>sl = <span>function</span>(letter,n = sample(2:4,1),ncol = 100){<br>  sample(paste0(letter,1:n),ncol,replace = T)<br>}<br>table(sl(<span>"a"</span>))<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>## </span><br><span>## a1 a2 a3 a4 </span><br><span>## 21 31 25 23</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>dat = t(sapply(letters[1:10], sl))<br>rownames(dat) = LETTERS[1:10]<br>colnames(dat) = paste0(<span>"M"</span>,1:ncol(dat))<br>dat[1:4,1:4]<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>##   M1   M2   M3   M4  </span><br><span>## A "a1" "a2" "a1" "a2"</span><br><span>## B "b2" "b2" "b2" "b2"</span><br><span>## C "c1" "c1" "c1" "c2"</span><br><span>## D "d2" "d1" "d2" "d3"</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>col_group = rep(c(<span>"C1"</span>,<span>"C2"</span>,<span>"C3"</span>),<span>times</span> = c(30,40,30))<br>row_group = rep(c(<span>"x"</span>,<span>"y"</span>),<span>times</span> = c(6,4))<br><br>Heatmap(dat, name = <span>"mat"</span>, <br>        top_annotation = HeatmapAnnotation(cluster = col_group),<br>        left_annotation = rowAnnotation(foo1 = row_group),<br>        column_split = col_group,<br>        row_split = row_group,<br>        border = T,show_column_names = F)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosibNhmPtYjGulCqsReWXF5858p2Lb1Zic96m8Ax4dUICSUiclDjUpiaicBTdg/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosibNhmPtYjGulCqsReWXF5858p2Lb1Zic96m8Ax4dUICSUiclDjUpiaicBTdg/640?wx_fmt=png"><figcaption>请忽略配色</figcaption></figure><h4 data-tool="mdnice编辑器"><span>2.自定义颜色</span></h4><p data-tool="mdnice编辑器">ComplexHeatmap有一个特点，如果你不指定配色的话，<strong>每次运行相同代码出来的图配色都不一样哦</strong>，所以接下来自己定义颜色。</p><p data-tool="mdnice编辑器">这里用到一个函数：colorRamp2，出自circlize包，可以根据你指定的几个颜色，生成一组渐变色。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 主体热图的颜色</span><br>m = apply(dat,1,<span>function</span>(x){length(unique(x))})<br><br>col_fun = colorRamp2(breaks = seq(0, 1, length.out = 12),<br>                     colors = brewer.pal(12,<span>"Set3"</span>))<br>qz = sort(unique(as.character(dat)));length(qz)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>## [1] 28</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>colors = col_fun(seq(0, 1, length.out = length(qz)))<br>names(colors) = qz<br>head(colors)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>##          a1          a2          b1          b2          b3          c1 </span><br><span>## "#8DD3C7FF" "#BFE5BFFF" "#ECF7B7FF" "#F2EFBDFF" "#D8D3CDFF" "#C2B8D6FF"</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span># 注释条的颜色</span><br>color_an = brewer.pal(length(unique(col_group)),<span>"Dark2"</span>)<br>names(color_an) = unique(col_group)<br>color_an<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>##        C1        C2        C3 </span><br><span>## "#1B9E77" "#D95F02" "#7570B3"</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>#顶部注释</span><br>top_annotation = HeatmapAnnotation(cluster = col_group,col = list(cluster = color_an),show_legend = F,show_annotation_name = F)<br><br>f = Heatmap(dat, col = colors,<br>        top_annotation = top_annotation,<br>        row_split = ifelse(row_group==<span>"x"</span>,<span>""</span>,<span>" "</span>), <span>#这一句是为了隐藏行分组的名字</span><br>        column_split = col_group,<br>        show_heatmap_legend = F,<br>        border = T,show_column_names = F,row_names_side = <span>"left"</span>,<br>        right_annotation = rowAnnotation(score = anno_text(1:nrow(dat)))<br>        )<br>f<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosiba6K8xia6N0LGVexW6dIhicEcp3VQ2liaJYTTmI7H0rx5nRcexIWDOa9zA/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosiba6K8xia6N0LGVexW6dIhicEcp3VQ2liaJYTTmI7H0rx5nRcexIWDOa9zA/640?wx_fmt=png"><figcaption>隐藏图例了</figcaption></figure><h4 data-tool="mdnice编辑器"><span>3.自定义图例</span></h4><p data-tool="mdnice编辑器">前面有个参数是<code>show_heatmap_legend = F</code>，<code>show_legend = F</code>,是不显示主体与注释图例的意思。这里之所以不显示是为了自定义图例。否则呢，主体热图的图例就会全部放在一起，不能按行来显示哦。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 主体热图的图例</span><br>k = 1<br>lgd = list()<br><span>for</span>(i <span>in</span> 1:10){<br>  un = sort(unique(dat[i,]))<br>  ti = rownames(dat)[i]<br>  lgd[[i]] = Legend(seq(0, 1, length.out = length(un)), labels = un,<br>               title = ti, legend_gp = gpar(fill =colors[k:(k+length(un)-1)]))<br>  k = k + length(un)<br>}<br><span># 注释的图例</span><br>cld = Legend(labels = c(<span>"a1"</span>,<span>"a2"</span>,<span>"a3"</span>), title = <span>"cluster"</span>, <br>        legend_gp = gpar(fill = color_an))<br><br><span># 把各个图例合并在一起</span><br>p = packLegend(list = c(cld,lgd),<br>               direction = <span>"horizontal"</span>,gap = unit(0.6, <span>"cm"</span>))<br><br>draw(p)<br></code></pre><figure data-tool="mdnice编辑器"><img data-croporisrc="https://mmbiz.qlogo.cn/mmbiz_png/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosibcibxia5C3QstiaJmyKcaBBIc4fGpWVVnRFMjT4Q6ZA7Yeiaf5pY8rUACkg/0?wx_fmt=png" data-cropx1="0" data-cropx2="1240" data-cropy1="335.89873417721515" data-cropy2="549.367088607595" data-ratio="0.1717741935483871" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosibPykInnr8Hc9icxYDuoq3rC03hm5NpENGQALWicibQ0aU5JO7wTeFrR4nw/640?wx_fmt=jpeg" data-type="jpeg" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosibPykInnr8Hc9icxYDuoq3rC03hm5NpENGQALWicibQ0aU5JO7wTeFrR4nw/640?wx_fmt=jpeg"><figcaption>全部的图例哦</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 主体和图例画到一起</span><br>draw(f,heatmap_legend_list = p,heatmap_legend_side = <span>"bottom"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosibp5F4CEgKJhlnVJpsicYkJNAaCa04gqwXiaHpn9YK4Wv6J6lLlyfVW2ew/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHp0Y0cicVrnm4r7BYLSMvosibp5F4CEgKJhlnVJpsicYkJNAaCa04gqwXiaHpn9YK4Wv6J6lLlyfVW2ew/640?wx_fmt=png"><figcaption>收工</figcaption></figure></section></section><section><blockquote><section><strong>插个小广告！</strong></section><section><strong><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247487729&amp;idx=2&amp;sn=c8075ff6c06998a939cc398b486e9ae1&amp;chksm=fdf858b3ca8fd1a5eaefc81fd5c0481b89b84cdc858e9c7e590dfd9301c00f03a2215068fdc0&amp;scene=21#wechat_redirect" textvalue="生信零基础入门学习小组" data-itemshowtype="0" tab="innerlink" data-linktype="2">生信零基础入门学习小组</a></strong></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247489926&amp;idx=2&amp;sn=5cbf84d816149854a71f5519bd3f7336&amp;chksm=fdf851c4ca8fd8d27cf7327b307dccf9da758466a704dabfb24ef374c3ec78ed03d2c3480dde&amp;scene=21#wechat_redirect" textvalue="生信入门班（四周线上直播课，长期开班）" data-itemshowtype="11" tab="innerlink" data-linktype="2"><strong>生信入门班（四周线上直播课，长期开班）</strong></a></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247489926&amp;idx=1&amp;sn=3216ca5f151b7b42e8e462098c5dcdbc&amp;chksm=fdf851c4ca8fd8d21670f875b1aada7779c0d7a3b276a7b8a6f5cfd9600214976e26e8e22553&amp;scene=21#wechat_redirect" textvalue="数据挖掘班（医生/医学生首选，三周线上直播课，长期开班）" data-itemshowtype="11" tab="innerlink" data-linktype="2"><strong>数据挖掘班（医生/医学生首选，三周线上直播课，长期开班）</strong></a></section><section><strong><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247487032&amp;idx=2&amp;sn=fe2100fb70e84f7b4da00cb744c565a3&amp;chksm=fdf8467aca8fcf6ce40679d990a45c13c6c2b409a826e82be8a3c2db383845eca743553be9a9&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">一起来学单细胞吗？</a></strong></section><section><strong><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247487050&amp;idx=2&amp;sn=aac649edf53957bb876d466af728311f&amp;chksm=fdf84608ca8fcf1e2571ad8aba6e0c721ef056f48693905b0575549d2228946fff4cb3deff19&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">生信星球答疑公告</a></strong><span></span></section></blockquote></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/oUfsu-xowJxcO1kJjp0YVQ",target="_blank" rel="noopener noreferrer">原文链接</a>
