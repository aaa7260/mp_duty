---
title: "本地安装jupyterlab，并创建conda小环境——以空间转录组细胞互作之stlearn安装为例"
date: 2023-12-15T20:01:38Z
draft: ["false"]
tags: [
  "fetched",
  "生信小博士"
]
categories: ["Acdemic"]
---
本地安装jupyterlab，并创建conda小环境——以空间转录组细胞互作之stlearn安装为例 by 生信小博士
------
<div><p><strong><span>大家好</span></strong><strong><span>，又到周五了，今天主要聊一聊空间转录组 空间细胞互作神器——stlearn的安装与代码实战。在介绍之前</span></strong><strong><span>先预告一下我周日晚上八点的直播，主要内容是</span></strong><span><strong>代码实操</strong></span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2NDcxMzYwNg==&amp;mid=2247484857&amp;idx=1&amp;sn=4ca19c4a3b3bc6aec4ef3422c2832c71&amp;chksm=ce646b50f913e246682144f87034c63dfa533a595ad58389c48936e4be098766cbb9c5479419&amp;scene=21#wechat_redirect" textvalue="富集分析结果不理想：如何从上千个term中找到自己想要所有term？" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">富集分析结果不理想：如何从上千个term中找到自己想要所有term？</a><strong><span>感兴趣可以提前预约下~</span></strong><br></p><p><strong></strong></p><section><mp-common-videosnap data-pluginname="mpvideosnap" data-headimgurl="https://wx.qlogo.cn/finderhead/AbruuZ3ILCma0K5wdnWcqD7MO78TupASRzTckmew1Mr9OYcGovvFrQ/0" data-username="v2_060000231003b20faec8c6e0811dc4ddcd03ec34b07729e2e700557f345bc19418b924d76c50@finder" data-nickname="生信小博士" data-desc="将在12月17日 20:10 直播" data-livewording="预约" data-intro="干湿结合：多个富集分析通路，如何选下一步研究方向？&lt;br&gt;本周日晚八点半，东南大学博士与你：代码实操、直播互动~" data-type="live" data-status="0" data-noticeid="finderlivenotice-v2_060000231003b20faec8c6e0811dc4ddcd03ec34b07729e2e700557f345bc19418b924d76c50@finder-1702445521918309-1009036207" data-isdisabled="0" data-errortips=""></mp-common-videosnap></section><hr><ul><li><section><strong><span>首先看下图，对stlearn空间细胞互作有个大概印象。</span></strong></section></li></ul><section><strong><span><img data-imgfileid="100001385" data-ratio="0.5508474576271186" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0obNW8VRvGsbQrWTf27G5zvmnNQ8pDT0emmYWMzPLqn8lFhf9Fw5EEOQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="944" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0obNW8VRvGsbQrWTf27G5zvmnNQ8pDT0emmYWMzPLqn8lFhf9Fw5EEOQ/640?wx_fmt=png&amp;from=appmsg"></span></strong></section><hr><section><strong><span>下面正式进入今天分享的内容：stlearn安装与代码实操。</span></strong></section><section><strong><span>本文为两个部分：</span></strong></section><ol><li><section><strong><span>一部分是本地安装stlearn，</span></strong></section></li><li><section><strong><span>代码实操不管在本地还是服务器都一样的。</span></strong><br></section></li></ol><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><p>01</p></section></section></section></section></section></section><section powered-by="xiumi.us"><section><img data-imgfileid="100001384" data-ratio="1.21580547112462" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_gif/MVPvEL7Qg0EgrwdibaKqfTqpyFcSD7uE2JcEGETKYmdVA1UNUhbaXBa2qqazjc44k52ezTYYvRyoGAIOgrUNVhg/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-w="329" width="100%" src="https://mmbiz.qpic.cn/sz_mmbiz_gif/MVPvEL7Qg0EgrwdibaKqfTqpyFcSD7uE2JcEGETKYmdVA1UNUhbaXBa2qqazjc44k52ezTYYvRyoGAIOgrUNVhg/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></section></section><ul><li><section powered-by="xiumi.us"><strong><span>1 stlearn本地安装</span></strong><section><br></section></section></li></ul><section><br></section><ul><li><p><strong><span>1.1 安装stlearn，需要python环境，所以我们使用anaconda来安装stlearn .。下面两个链接都可以下载annaconda</span></strong></p></li></ul><p><span><strong><span><strong><span>https://www.anaconda.com/download </span></strong><strong><span>或者去清华镜像下载   https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/  </span></strong></span></strong></span></p><p><img data-galleryid="" data-imgfileid="100001388" data-ratio="0.05155746509129968" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0odPxrhE0iapgt0uuZibm5N8UmnYiaIJ4UonP9o4Mibc7ejmXKxLNPn3QuJw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="931" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0odPxrhE0iapgt0uuZibm5N8UmnYiaIJ4UonP9o4Mibc7ejmXKxLNPn3QuJw/640?wx_fmt=png&amp;from=appmsg"></p><ul><li><p><strong><span>1.2 双击exe文件，安装anaconda</span></strong></p></li></ul><p><strong><span>针对所有用户安装，没选only me选项</span></strong></p><ul><li><p><strong><span>1.2.1注意安装路径，我放在了d盘</span></strong></p></li></ul><p><img data-galleryid="" data-imgfileid="100001398" data-ratio="0.7595541401273885" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oXhibqGrIbDickkW24ibaHm30IMAyTDEr7VoOKVMV5Qp1zv9ImHnGUlnxw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="628" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oXhibqGrIbDickkW24ibaHm30IMAyTDEr7VoOKVMV5Qp1zv9ImHnGUlnxw/640?wx_fmt=png&amp;from=appmsg"></p><section><br></section><ul><li><section><strong><span>1.2.2安装完成后，同时记得设置环境变量</span></strong><br></section></li></ul><p><img data-galleryid="" data-imgfileid="100001399" data-ratio="0.4842592592592593" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oica1o4NC6YCCIpMlQeaHOxE2WT6k5BcMmkwiczb8Hu39VCF1slDHv3sw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oica1o4NC6YCCIpMlQeaHOxE2WT6k5BcMmkwiczb8Hu39VCF1slDHv3sw/640?wx_fmt=png&amp;from=appmsg"></p><section><strong><span>如果你是安装在c盘下面，添加如下：</span></strong></section><p><img data-galleryid="" data-imgfileid="100001400" data-ratio="0.24423963133640553" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0okwrMicVGMQiaWVG3Y8q9zIRWmBO7DRnRKomCPJia62FezATBPkWfeHn4A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="651" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0okwrMicVGMQiaWVG3Y8q9zIRWmBO7DRnRKomCPJia62FezATBPkWfeHn4A/640?wx_fmt=png&amp;from=appmsg"></p><ul><li><section><strong><span>1.2.3这个时候，如果直接使用anaconda，可能会报错，比如这个报错：</span></strong></section></li></ul><section><span><img data-imgfileid="100001401" data-ratio="0.7795648060548723" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0ooHdftspmA8XicwkaWicIibLNYZZVMSRfGOMic1Jgm9KxFrRJ0XaBRicfmOg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1057" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0ooHdftspmA8XicwkaWicIibLNYZZVMSRfGOMic1Jgm9KxFrRJ0XaBRicfmOg/640?wx_fmt=png&amp;from=appmsg"></span></section><p><strong><span>那么你就需要</span></strong></p><p><img data-imgfileid="100001402" data-ratio="0.2833333333333333" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0ox0ibzc0LiaicOlMeDM4nHxvQrQH857fOEqzyWBas0ZbvkKXfxYabWlmsQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="300" height="85" width="300" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0ox0ibzc0LiaicOlMeDM4nHxvQrQH857fOEqzyWBas0ZbvkKXfxYabWlmsQ/640?wx_fmt=png&amp;from=appmsg"></p><p><strong><span>查看condrc位置，并删除他</span></strong></p><p><img data-imgfileid="100001403" data-ratio="0.8605072463768116" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oHzbF9hR1VEIndWsFSvP4mL0IwEMj2a9jC1qzbibw1icxOcPavQ86KYwg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="552" height="475" width="552" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oHzbF9hR1VEIndWsFSvP4mL0IwEMj2a9jC1qzbibw1icxOcPavQ86KYwg/640?wx_fmt=png&amp;from=appmsg"></p><ul><li><p><strong><span>1.2.4因为是在cmd里面，所有使用del命令删除然后就可以安装自己的小环境了</span></strong></p></li></ul><p><img data-imgfileid="100001404" data-ratio="0.8002645502645502" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oa0r8L296Ca7CfG4PYsQXibjVWYZIKgP8eNdvHicbicwE7mqqJAsP6I7Mg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="756" height="605" width="756" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oa0r8L296Ca7CfG4PYsQXibjVWYZIKgP8eNdvHicbicwE7mqqJAsP6I7Mg/640?wx_fmt=png&amp;from=appmsg"></p><ul><li><section><strong><span>1.2.5这个时候就可以使用anaconda创建自己的stlearn小环境了</span></strong></section></li></ul><section><ul><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="properties"><code><span><span>conda</span> <span>create -n stlearn python=3.8</span></span></code><code><span><span>conda</span> <span>activate stlearn</span></span></code><code><span><span>pip</span> <span>install -U stlearn  -i https://pypi.tuna.tsinghua.edu.cn/simple</span></span></code><code><span><br></span></code><code><span><br></span></code><code><span>或者使用conda安装</span></code><code><span><span>conda</span> <span>create -n stlearn python=3.8</span></span></code><code><span><span>conda</span> <span>activate stlearn</span></span></code><code><span><span>conda</span> <span>install -c conda-forge stlearn</span></span></code><code><span><br></span></code></pre></section><ul><li><p><span>1.2.6 然后在小环境里面使用ipykernel注册一下</span></p></li></ul><section><ul><li></ul><pre data-lang="sql"><code><span>python -m ipykernel <span>install</span> <span>--user --name=stlearn</span></span></code></pre></section><p><br></p><section><span>最后就需要加装1.22版的numpy，防止后面报错。</span><br></section><p><span><strong>奇怪的事：如果你使用windows本地安装stlearn包，就不需要加装。如果是Linux就需要加装。</strong></span></p><section><ul><li></ul><pre data-lang="nginx"><code><span><span>conda</span> install NumPy=<span>1</span>.<span>22</span></span></code></pre></section><p><br></p><ul><li><p><strong><span>1.2.7然后回到anaconda界面版本，就可以可以在小环境里面安装jupyterlab，然后就可以使用jupyterlab啦</span></strong></p></li></ul><p><img data-imgfileid="100001407" data-ratio="0.5305555555555556" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oU4dHrhwo4NF84zB5EnfStVtAHiaeBzibvu9IICIRwFZBH94zYMEmcIQQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" height="975" width="1200" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oU4dHrhwo4NF84zB5EnfStVtAHiaeBzibvu9IICIRwFZBH94zYMEmcIQQ/640?wx_fmt=png&amp;from=appmsg"></p><p><strong><span>可以看到注册好的stlearn小环境 </span></strong></p><p><img data-imgfileid="100001406" data-ratio="0.6157407407407407" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0ornWKjPQHDPCmejZoAyCuQnsZ44dEFm9PXgpAp1rqmI2m3wumv6yGqg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" height="696" width="1130" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0ornWKjPQHDPCmejZoAyCuQnsZ44dEFm9PXgpAp1rqmI2m3wumv6yGqg/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><p>02</p></section></section></section></section></section></section><section powered-by="xiumi.us"><section><img data-imgfileid="100001408" data-ratio="1.21580547112462" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_gif/MVPvEL7Qg0EgrwdibaKqfTqpyFcSD7uE2JcEGETKYmdVA1UNUhbaXBa2qqazjc44k52ezTYYvRyoGAIOgrUNVhg/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-w="329" width="100%" src="https://mmbiz.qpic.cn/sz_mmbiz_gif/MVPvEL7Qg0EgrwdibaKqfTqpyFcSD7uE2JcEGETKYmdVA1UNUhbaXBa2qqazjc44k52ezTYYvRyoGAIOgrUNVhg/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></section></section><ul><li><section><strong><span>2stlearn代码实战</span></strong></section><section><br></section></li></ul><p><span>https://stlearn.readthedocs.io/en/latest/tutorials/Working_with_scanpy.html</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span>#<span>1</span> 首先加载示例数据，并从scanpy对象转为stlearn对象-----https:<span>//stlearn.readthedocs.io/en/latest/tutorials/Working_with_scanpy.html</span></span></code><code><span><span>import</span> stlearn <span>as</span> st</span></code><code><span><span>import</span> scanpy <span>as</span> sc</span></code><code><span># Read Visium <span>data</span> <span>by</span> scanpy</span></code><code><span>adata = sc.datasets.visium_sge()</span></code><code><span># Convert AnnData <span>object</span> to work with stLearn</span></code><code><span>adata = st.convert_scanpy(adata)</span></code><code><span><br></span></code><code><span>#<span>2</span>走官方 stlearn流程 https:<span>//stlearn.readthedocs.io/en/latest/tutorials/stLearn-CCI.html</span></span></code><code><span><br></span></code><code><span><span>import</span> stlearn <span>as</span> st</span></code><code><span><span>import</span> numpy <span>as</span> np</span></code><code><span><span>import</span> pandas <span>as</span> pd</span></code><code><span><span>import</span> matplotlib.pyplot <span>as</span> plt</span></code><code><span><br></span></code><code><span>##########<span>3</span></span></code><code><span><br></span></code><code><span><span>data</span>=adata</span></code><code><span><br></span></code><code><span>#自己创建一个随机的label给每个spot</span></code><code><span><br></span></code><code><span>labels=<span>data</span>.obs.index</span></code><code><span><br></span></code><code><span><span>import</span> numpy <span>as</span> np</span></code><code><span><br></span></code><code><span># Generate random labels</span></code><code><span>labels_rand = np.random.randint(<span>1</span>, <span>11</span>, size=len(labels))</span></code><code><span>labels_rand= [<span>'cluster_'</span> + str(bc) <span>for</span> bc <span>in</span>  np.random.randint(<span>1</span>, <span>11</span>, size=len(labels)).tolist() ]</span></code><code><span>labels_rand</span></code><code><span><br></span></code><code><span># Assign random labels to <span>data</span></span></code><code><span><span>data</span>.obs[<span>'cell_type'</span>] = labels_rand</span></code><code><span>labels=labels_rand</span></code><code><span># NOTE: using the same key <span>in</span> <span>data</span>.obs &amp; <span>data</span>.uns</span></code><code><span><span>data</span>.obs[<span>'cell_type'</span>] = labels # Adding the dominant cell type labels per spot</span></code><code><span><span>data</span>.obs[<span>'cell_type'</span>] = <span>data</span>.obs[<span>'cell_type'</span>].astype(<span>'category'</span>)</span></code><code><span><span>data</span>.uns[<span>'cell_type'</span>] =  <span>data</span>.obs.imagecol # Adding the cell type scores</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code></pre></section><ul><li><p><strong><span>2.1运行完上述代码之后，得到stlearn的对象</span></strong><br></p></li></ul><p><img data-galleryid="" data-imgfileid="100001383" data-ratio="0.597775718257646" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oxwn7nPuK2vSfaJDcYLKibKJMVDkqKNQNfcukcEwib5OLafiaeiaqJ2x8rA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1079" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oxwn7nPuK2vSfaJDcYLKibKJMVDkqKNQNfcukcEwib5OLafiaeiaqJ2x8rA/640?wx_fmt=png&amp;from=appmsg"></p><ul><li><p><strong><span>2.2stlearn初步质控、换图</span></strong><br></p></li></ul><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>labels_rand= [<span>'cluster_'</span> + str(bc) <span>for</span> bc <span>in</span>  np.random.randint(<span>1</span>, <span>11</span>, size=len(labels)).tolist() ]</span></code><code><span>labels_rand</span></code><code><span><span>#labels_rand.astype('category') #'list' object has no attribute 'astype'</span></span></code><code><span>st.pl.cluster_plot(data, use_label=<span>'cell_type'</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#加载受体配体库# Loading the LR databases available within stlearn (from NATMI)</span></span></code><code><span>lrs = st.tl.cci.load_lrs([<span>'connectomeDB2020_lit'</span>], species=<span>'mouse'</span>)</span></code><code><span>print(len(lrs))</span></code><code><span>print(lrs)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><span># Running the analysis #</span></span></code><code><span>st.tl.cci.run(data, lrs,</span></code><code><span>                  min_spots = <span>20</span>, <span>#Filter out any LR pairs with no scores for less than min_spots</span></span></code><code><span>                  distance=<span>None</span>, <span># None defaults to spot+immediate neighbours; distance=0 for within-spot mode</span></span></code><code><span>                  n_pairs=<span>100</span>, <span># Number of random pairs to generate; low as example, recommend ~10,000</span></span></code><code><span>                  n_cpus=<span>4</span>, <span># Number of CPUs for parallel. If None, detects &amp; use all available.</span></span></code><code><span>                  )</span></code><code><span><br></span></code><code><span>lr_info = data.uns[<span>'lr_summary'</span>] <span># A dataframe detailing the LR pairs ranked by number of significant spots.</span></span></code><code><span>print(<span>'\n'</span>, lr_info)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#调整p值</span></span></code><code><span>st.tl.cci.adj_pvals(data, correct_axis=<span>'spot'</span>,</span></code><code><span>                   pval_adj_cutoff=<span>0.05</span>, adj_method=<span>'fdr_bh'</span>)</span></code><code><span><br></span></code><code><span><span># Showing the rankings of the LR from a global and local perspective.</span></span></code><code><span><span># Ranking based on number of significant hotspots.</span></span></code><code><span>st.pl.lr_summary(data, n_top=<span>500</span>)</span></code><code><span>st.pl.lr_summary(data, n_top=<span>50</span>, figsize=(<span>10</span>,<span>3</span>))</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#诊断图 diagosis</span></span></code><code><span>st.pl.lr_diagnostics(data, figsize=(<span>10</span>,<span>2.5</span>))</span></code><code><span><br></span></code><code><span>st.pl.lr_n_spots(data, n_top=<span>50</span>, figsize=(<span>11</span>, <span>3</span>),</span></code><code><span>                    max_text=<span>100</span>)</span></code><code><span>st.pl.lr_n_spots(data, n_top=<span>500</span>, figsize=(<span>11</span>, <span>3</span>),</span></code><code><span>                    max_text=<span>100</span>)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="100001410" data-ratio="0.8481675392670157" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oTwVo8TSK6Fgn9KTUDbx4tq4ToEk29GgxZBWGI8hjwGMODaaQOGTrmw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="764" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oTwVo8TSK6Fgn9KTUDbx4tq4ToEk29GgxZBWGI8hjwGMODaaQOGTrmw/640?wx_fmt=png&amp;from=appmsg"></p><ul><li><p><strong><span>2</span></strong><strong><span>.stlearn可视化代码</span></strong></p><p><strong><span></span></strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="http"><code><span><br></span></code><code><span><br></span></code><code><span><span>#lr可视化</span></span></code><code><span>best_lr = data.uns[<span>'lr_summary'</span>].index.values[<span>0</span>] <span># Just choosing one of the top from lr_summary</span></span></code><code><span>stats = [<span>'lr_scores'</span>, <span>'p_vals'</span>, <span>'p_adjs'</span>, <span>'-log10(p_adjs)'</span>]</span></code><code><span>fig, axes = plt.subplots(ncols=len(stats), figsize=(<span>16</span>,<span>6</span>))</span></code><code><span><span>for</span> i, stat <span>in</span> enumerate(stats):</span></code><code><span>    st.pl.lr_result_plot(data, use_result=stat, use_lr=best_lr, show_color_bar=<span>False</span>, ax=axes[i])</span></code><code><span>    axes[i].set_title(<span>f'<span>{best_lr}</span> <span>{stat}</span>'</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span>fig, axes = plt.subplots(ncols=<span>2</span>, figsize=(<span>8</span>,<span>6</span>))</span></code><code><span>st.pl.lr_result_plot(data, use_result=<span>'-log10(p_adjs)'</span>, use_lr=best_lr, show_color_bar=<span>False</span>, ax=axes[<span>0</span>])</span></code><code><span>st.pl.lr_result_plot(data, use_result=<span>'lr_sig_scores'</span>, use_lr=best_lr, show_color_bar=<span>False</span>, ax=axes[<span>1</span>])</span></code><code><span>axes[<span>0</span>].set_title(<span>f'<span>{best_lr}</span> -log10(p_adjs)'</span>)</span></code><code><span>axes[<span>1</span>].set_title(<span>f'<span>{best_lr}</span> lr_sig_scores'</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span>st.pl.lr_plot(data, best_lr, inner_size_prop=<span>0.1</span>, outer_mode=<span>'binary'</span>, pt_scale=<span>5</span>,</span></code><code><span>              use_label=<span>None</span>, show_image=<span>True</span>,</span></code><code><span>              sig_spots=<span>False</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span>st.pl.lr_plot(data, best_lr, outer_size_prop=<span>1</span>, outer_mode=<span>'binary'</span>, pt_scale=<span>20</span>,</span></code><code><span>              use_label=<span>None</span>, show_image=<span>True</span>,</span></code><code><span>              sig_spots=<span>True</span>)</span></code><code><span><br></span></code></pre></section></li></ul><p><img data-galleryid="" data-imgfileid="100001411" data-ratio="0.3316582914572864" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oryNxQReeMOrcIpwvGiazW7dnmDibWIIsNE8icV0GibibJ6dHvY7z6gCXqHQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="995" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oryNxQReeMOrcIpwvGiazW7dnmDibWIIsNE8icV0GibibJ6dHvY7z6gCXqHQ/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>st.pl.lr_plot(data, best_lr, outer_size_prop=<span>1</span>, outer_mode=<span>'binary'</span>, pt_scale=<span>20</span>,</span></code><code><span>              use_label=<span>None</span>, show_image=<span>True</span>,</span></code><code><span>              sig_spots=<span>True</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#基因共表达</span></span></code><code><span><span># Only significant spots #</span></span></code><code><span>st.pl.lr_plot(data, best_lr,</span></code><code><span>              inner_size_prop=<span>0.04</span>, middle_size_prop=<span>.07</span>, outer_size_prop=<span>.4</span>,</span></code><code><span>              outer_mode=<span>'continuous'</span>, pt_scale=<span>60</span>,</span></code><code><span>              use_label=<span>None</span>, show_image=<span>True</span>,</span></code><code><span>              sig_spots=<span>True</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#添加方向</span></span></code><code><span>st.pl.lr_plot(data, best_lr,</span></code><code><span>              inner_size_prop=<span>0.08</span>, middle_size_prop=<span>.3</span>, outer_size_prop=<span>.5</span>,</span></code><code><span>              outer_mode=<span>'binary'</span>, pt_scale=<span>50</span>,</span></code><code><span>              show_image=<span>True</span>, arrow_width=<span>10</span>, arrow_head_width=<span>10</span>,</span></code><code><span>              sig_spots=<span>True</span>, show_arrows=<span>True</span>)</span></code><code><span><br></span></code><code><span><span>#Binary LR coexpression with Spot Annotations</span></span></code><code><span><span>#带有细胞注释的共表达</span></span></code><code><span><span>#The outter spot shows the expression of ligand (red), the receptor (green), and coexpression (blue). The inner spot is coloured by the dominant spot cell type.</span></span></code><code><span><span>#红色为配体 绿色为受体，蓝色共表达</span></span></code><code><span>st.pl.lr_plot(data, best_lr,</span></code><code><span>              inner_size_prop=<span>0.08</span>, middle_size_prop=<span>.3</span>, outer_size_prop=<span>.5</span>,</span></code><code><span>              outer_mode=<span>'binary'</span>, pt_scale=<span>150</span>,</span></code><code><span>              use_label=<span>'cell_type'</span>, show_image=<span>True</span>,</span></code><code><span>              sig_spots=<span>True</span>)</span></code><code><span><br></span></code></pre></section><p><img data-galleryid="" data-imgfileid="100001412" data-ratio="0.9669902912621359" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oxtiaQ7GHnjzVp3g7xicPpC49X35SwjEokvN2VGvPJXO1glWW1cZG0hqg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="515" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oxtiaQ7GHnjzVp3g7xicPpC49X35SwjEokvN2VGvPJXO1glWW1cZG0hqg/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-galleryid="" data-imgfileid="100001413" data-ratio="0.7990654205607477" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0o5VyC7RunLqwj2DwFrnZYJ6UVBLXVnN73LLXL4ic5rukR4z43f2UXm7g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="642" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0o5VyC7RunLqwj2DwFrnZYJ6UVBLXVnN73LLXL4ic5rukR4z43f2UXm7g/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="http"><code><span><br></span></code><code><span><br></span></code><code><span><span># Running the counting of co-occurence of cell types and LR expression hotspots #</span></span></code><code><span><span>#预测细胞间相互作用</span></span></code><code><span>st.tl.cci.run_cci(data, <span>'cell_type'</span>, <span># Spot cell information either in data.obs or data.uns</span></span></code><code><span>                  min_spots=<span>3</span>, <span># Minimum number of spots for LR to be tested.</span></span></code><code><span>                  spot_mixtures=<span>False</span>, <span># If True will use the label transfer scores,##如果报错请检查</span></span></code><code><span>                                      <span># so spots can have multiple cell types if score&gt;cell_prop_cutoff</span></span></code><code><span>                  cell_prop_cutoff=<span>0.2</span>, <span># Spot considered to have cell type if score&gt;0.2</span></span></code><code><span>                  sig_spots=<span>True</span>, <span># Only consider neighbourhoods of spots which had significant LR scores.</span></span></code><code><span>                  n_perms=<span>1000</span> <span># Permutations of cell information to get background, recommend ~1000</span></span></code><code><span>                 )</span></code><code><span><br></span></code><code><span><span>#Diagnostic plot: check interaction and cell type frequency correlation</span></span></code><code><span>st.pl.cci_check(data, <span>'cell_type'</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#可视化 弦图</span></span></code><code><span><span># Visualising the no. of interactions between cell types across all LR pairs #</span></span></code><code><span>pos_1 = st.pl.ccinet_plot(data, <span>'cell_type'</span>, return_pos=<span>True</span>)</span></code><code><span><br></span></code><code><span><span># Just examining the cell type interactions between selected pairs #</span></span></code><code><span>lrs = data.uns[<span>'lr_summary'</span>].index.values[<span>0</span>:<span>3</span>]</span></code><code><span><span>for</span> best_lr <span>in</span> lrs[<span>0</span>:<span>3</span>]:</span></code><code><span>    st.pl.ccinet_plot(data, <span>'cell_type'</span>, best_lr, min_counts=<span>2</span>,</span></code><code><span>                         figsize=(<span>10</span>,<span>7.5</span>), pos=pos_1,</span></code><code><span>                      )</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#可视化 弦图</span></span></code><code><span>st.pl.lr_chord_plot(data, <span>'cell_type'</span>)</span></code><code><span><br></span></code><code><span><span>for</span> lr <span>in</span> lrs:</span></code><code><span>    st.pl.lr_chord_plot(data, <span>'cell_type'</span>, lr)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#热图</span></span></code><code><span><span># This will automatically select the top interacting CCIs and their respective LRs #</span></span></code><code><span>st.pl.lr_cci_map(data, <span>'cell_type'</span>, lrs=<span>None</span>, min_total=<span>100</span>, figsize=(<span>20</span>,<span>4</span>))</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span># You can also put in your own LR pairs of interest #</span></span></code><code><span><span>#放入自己想要展示的受体配体对</span></span></code><code><span>st.pl.lr_cci_map(data, <span>'cell_type'</span>, lrs=lrs, min_total=<span>100</span>, figsize=(<span>20</span>,<span>4</span>))</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#This is a heatmap equivalent to the network diagrams and chordplots, it has more quantitative benefits.</span></span></code><code><span><span># of interactions refers to the number of times a spot with the reciever cell type expressed the ligand and the source cell type expressed the receptor in the same neighbourhood.</span></span></code><code><span>st.pl.cci_map(data, <span>'cell_type'</span>)</span></code><code><span><br></span></code><code><span>lrs = data.uns[<span>'lr_summary'</span>].index.values[<span>0</span>:<span>3</span>]</span></code><code><span>print(lrs)</span></code><code><span><span>for</span> lr <span>in</span> lrs[<span>0</span>:<span>3</span>]:</span></code><code><span>    st.pl.cci_map(data, <span>'cell_type'</span>, lr)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="100001414" data-ratio="0.5139664804469274" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oMzvoRItkat55phGvPwRZ591ek1OQlCLaM8PVJia0AYwhLibUPLAFavBQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1074" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oMzvoRItkat55phGvPwRZ591ek1OQlCLaM8PVJia0AYwhLibUPLAFavBQ/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-galleryid="" data-imgfileid="100001415" data-ratio="0.9774096385542169" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oEo5r0T3c0icVk4ibuWl9fHZia5Rs51cUdjH6cWHBpapBengyuu9LeQZug/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="664" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SktAcr7uBP9bl5bOZY1nFh0oEo5r0T3c0icVk4ibuWl9fHZia5Rs51cUdjH6cWHBpapBengyuu9LeQZug/640?wx_fmt=png&amp;from=appmsg"></p><ul><li><p><strong><span>可以看到stlearn画图的颜值还是很高的</span></strong></p></li></ul><p><br></p><p><strong><span>最后别忘记来直播间聊聊哦~</span></strong></p><section><mp-common-videosnap data-pluginname="mpvideosnap" data-headimgurl="https://wx.qlogo.cn/finderhead/AbruuZ3ILCma0K5wdnWcqD7MO78TupASRzTckmew1Mr9OYcGovvFrQ/0" data-username="v2_060000231003b20faec8c6e0811dc4ddcd03ec34b07729e2e700557f345bc19418b924d76c50@finder" data-nickname="生信小博士" data-desc="将在12月17日 20:10 直播" data-livewording="预约" data-intro="干湿结合：多个富集分析通路，如何选下一步研究方向？&lt;br&gt;本周日晚八点半，东南大学博士与你：代码实操、直播互动~" data-type="live" data-status="0" data-noticeid="finderlivenotice-v2_060000231003b20faec8c6e0811dc4ddcd03ec34b07729e2e700557f345bc19418b924d76c50@finder-1702445521918309-1009036207" data-isdisabled="0" data-errortips=""></mp-common-videosnap></section><p><br></p><p><br></p><p><img data-imgfileid="100001387" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"><br></p><p><img data-imgfileid="100001386" data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p><p><br></p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/RAUqMpvhdCjIk5E7B-qKAw",target="_blank" rel="noopener noreferrer">原文链接</a>
