---
title: "多分组芯片数据的差异分析"
date: 2022-08-30T04:56:11Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
多分组芯片数据的差异分析 by 生信菜鸟团
------
<div><p><br></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><span>继上周二对二分组的芯片进行差异基因分析及富集分析后，今天我们趁热打铁，试试看多分组的芯片能不能行~</span></p><h2 data-tool="mdnice编辑器"><span><span>1</span></span><span>背景知识</span></h2><blockquote data-tool="mdnice编辑器"><p>数据集在这里：(https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE210306)</p></blockquote><p data-tool="mdnice编辑器">可以看到是一个很新的数据集，文章还没有出来，先了解一下基本的设计</p><blockquote data-tool="mdnice编辑器"><p>Cells received 15 sequential fractions of 2 Gy week, allowing irradiated cell populations a period of recovery between exposures.</p><p>Non-irradiated controls were handled identically to the irradiated cells without radiation exposure.</p><p>All of the experiments were performed within 4–10 passages after the final irradiation</p></blockquote><p data-tool="mdnice编辑器">共有8个样品，2个细胞系，那如何进行分组呢？可以这样试试看</p><blockquote data-tool="mdnice编辑器"><p>MCF-7 vs MCF-7RR （对照/放疗）</p><p>MDA-MB-231 vs MDA-MB-231RR （对照/放疗）</p><p>MCF-7RR vs MDA-MB-231RR  （不同细胞系放疗后）</p></blockquote><section data-tool="markdown编辑器" data-website="https://markdown.com.cn/editor"><p data-tool="markdown.com.cn编辑器">GEO数据库里面的表达量芯片数据处理，主要的难点是表达量矩阵获取和探针的基因名字转换，搞定后只需要一定的生物学背景对数据进行合理的分组后就是标准的差异分析，富集分析。<strong>主要是参考我八年前的笔记：</strong></p><ul data-tool="markdown.com.cn编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486063&amp;idx=1&amp;sn=156bee5397e979722b36b78284188538&amp;scene=21#wechat_redirect" data-linktype="2">解读GEO数据存放规律及下载，一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486054&amp;idx=1&amp;sn=209975adee162228cfe6e6c5065c5c8c&amp;scene=21#wechat_redirect" data-linktype="2">解读SRA数据库规律一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486087&amp;idx=1&amp;sn=1e775a1c3e215384e381953a9fa74ec3&amp;scene=21#wechat_redirect" data-linktype="2">从GEO数据库下载得到表达矩阵 一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486090&amp;idx=1&amp;sn=62374fbdd4f20c3185beb6568bbeb3e9&amp;scene=21#wechat_redirect" data-linktype="2">GSEA分析一文就够（单机版+R语言版）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486112&amp;idx=1&amp;sn=67a2104c62222bcb139623699f874a6c&amp;scene=21#wechat_redirect" data-linktype="2">根据分组信息做差异分析- 这个一文不够的</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486120&amp;idx=1&amp;sn=14d7892c1beec2fb9cdfc0ec0aba3e4e&amp;scene=21#wechat_redirect" data-linktype="2">差异分析得到的结果注释一文就够</a></section></li></ul></section><h2 data-tool="mdnice编辑器"><span><span>2</span></span><span>代码实操</span></h2><h3 data-tool="mdnice编辑器"><span></span><span>数据集下载</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())  <span>##清屏</span><br><br>options(stringsAsFactors = <span>F</span>)<br>getOption(<span>'timeout'</span>)<br>options(timeout=<span>10000</span>)<br><br><span>##加载包</span><br><span>library</span>(AnnoProbe)<br><span>library</span>(GEOquery)<br><span>#install.packages("do")</span><br><span>library</span>(do)<br><span>library</span>(stringr) <br><span>##方法1</span><br>getGEO(<span>"GSE210306"</span>)<br><span>if</span>(<span>F</span>){<br>  gset &lt;- geoChina(<span>"GSE210306"</span>)<br>  gset<br>}<br><span>##方法2</span><br><span>#浏览器下载 https://ftp.ncbi.nlm.nih.gov/geo/series/GSE210nnn/GSE210306/matrix/GSE210306_series_matrix.txt.gz</span><br>gset &lt;- getGEO(<span>"GSE210306"</span>,<br>               filename = <span>'GSE210306_series_matrix.txt.gz'</span>,<br>               AnnotGPL = <span>FALSE</span>, getGPL = <span>FALSE</span>)<br>gset <span>##查看得到的芯片数据</span><br>a=gset  <span>#</span><br>exp=exprs(a) <span>##提取表达矩阵</span><br>dim(exp)<br>exp[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>] <span>#查看dat矩阵的前4行和4列</span><br>range(exp) <span>## 一般在20以内的基本都是log2转化后的</span><br>dat=exp<br><span># 发现并不需要log，所以注释了下面的代码</span><br><span>#dat=log2(dat)</span><br>boxplot(dat[,<span>1</span>:<span>4</span>],las=<span>2</span>)  <br><span>library</span>(limma)<br>dat=normalizeBetweenArrays(dat)<br>boxplot(dat[,<span>1</span>:<span>4</span>],las=<span>2</span>)  <br>pd=pData(a) <span>##提取临床信息</span><br>phe=pd <br>phe$title<br><br><span>##生成分组向量</span><br>group_list&lt;-str_remove_all(phe$title,<span>"\\d"</span>) <span>#\\d表示去除数字</span><br>group_list&lt;-str_split(group_list,<span>','</span>,simplify = <span>TRUE</span>)[,<span>1</span>]<br>group_list&lt;-str_remove_all(group_list,<span>"- parental"</span>)<br>group_list&lt;-gsub(<span>'-'</span>,<span>''</span>,group_list)  <span>##组名最好不要出现符号"-"</span><br>table(group_list)<br>group_list=factor(group_list,levels = c(<span>"MCF"</span>,<span>"MCFRR"</span>,<span>"MDAMB"</span>,<span>"MDAMBRR"</span>))<br><br><br><span>##探针注释方法1----------</span><br><span>library</span>(data.table)<br><span>library</span>(stringr)<br><span># if(!require(tinyarray))install.packages("tinyarray")</span><br><span># if(!require(devtools))install.packages("devtools")</span><br><span># if(!require(tinyarray))devtools::install_github("xjsun1221/tinyarray",upgrade = F)</span><br><span>library</span>(tinyarray)<br><span>library</span>(tidyverse)<br>b=fread(<span>'GPL6244-17930.txt'</span>,data.table = <span>F</span>)<br>head(b)<br>ids=data.frame(<br>  ID=b$ID,  <span>##注意这里的ID要与dat的行名对应 head(dat)</span><br>  symbol=str_split(b$gene_assignment,<span>' // '</span>,simplify = <span>T</span>)[,<span>2</span>]<br>)<br>head(ids)<br>ids=ids[ids$symbol != <span>''</span>,]<br>head(ids) <br>colnames(ids)=c(<span>'probe_id'</span>,<span>'symbol'</span>) <br>ids$probe_id=as.character(ids$probe_id)  <br><span>##将probe_id这一列转为字符，否则在取子集时容易报错：subscript out of bounds</span><br><br><span>##探针注释方法2--------</span><br><span>##基因注释和整理</span><br><span># gpl&lt;-gset@annotation</span><br><span># #http://www.bio-info-trainee.com/1399.html</span><br><span># #hgu133plus2</span><br><span># if(F){</span><br><span>#   if(!require(hgu133a.db))BiocManager::install("hgu133a.db")</span><br><span>#   library(hgu133a.db)</span><br><span>#   ls("package:hgu133a.db")</span><br><span>#   ids &lt;- toTable(hgu133aSYMBOL)</span><br><span>#   head(ids)</span><br><span># }else if(F){</span><br><span>#   getGEO(gpl,destdir = ".")</span><br><span>#   ids = data.table::fread(paste0(gpl,".soft"),header = T,skip = "ID",data.table = F)</span><br><span>#   ids = ids[,c("ID","Gene Symbol")]</span><br><span>#   colnames(ids) = c("probe_id","symbol")</span><br><span># }else if(T){</span><br><span>#   ids = idmap(gpl,type = "bioc")</span><br><span># }</span><br><br><span>#####取出dat矩阵中与探针对应的probe_id</span><br>ids=ids[ids$probe_id %<span>in</span>%  rownames(dat),]<br>dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]  <br>dat=dat[ids$probe_id,] <br><br><br><span>##计算基因的表达量</span><br>ids$median=apply(dat,<span>1</span>,median) <span>#ids新建median这一列，列名为median，同时对dat这个矩阵按行操作，取每一行的中位数，将结果给到median这一列的每一行</span><br>ids=ids[order(ids$symbol,ids$median,decreasing = <span>T</span>),]<span>#对ids$symbol按照ids$median中位数从大到小排列的顺序排序，将对应的行赋值为一个新的ids</span><br>ids=ids[!duplicated(ids$symbol),]<span>#将symbol这一列取取出重复项，'!'为否，即取出不重复的项，去除重复的gene ，保留每个基因最大表达量结果s</span><br>dat=dat[ids$probe_id,] <span>#新的ids取出probe_id这一列，将dat按照取出的这一列中的每一行组成一个新的dat</span><br>rownames(dat)=ids$symbol<span>#把ids的symbol这一列中的每一行给dat作为dat的行名</span><br>dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]  <br><br>dat[<span>'ACTB'</span>,]<br>dat[<span>'GAPDH'</span>,]<br>save(gset,exp,ids,dat,group_list,phe,file = <span>'step1-output.Rdata'</span>)<br><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>差异基因分析</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>load(<span>'step1-output.Rdata'</span>)<br><br><span># if (!require("BiocManager", quietly = TRUE))</span><br><span>#   install.packages("BiocManager")</span><br><span># BiocManager::install("Glimma")</span><br><span>library</span>(limma)<br><span>library</span>(Glimma)<br><br><span>#创建一个desigen矩阵</span><br>design&lt;-model.matrix(~<span>0</span>+group_list)<br>colnames(design)&lt;-gsub(<span>"group_list"</span>,<span>""</span>,colnames(design))<br><span>#用makeContrasts函数设定组间对比</span><br>px = levels(group_list)<br>contr.matrix&lt;-makeContrasts(<br>  paste0(px[<span>2</span>],<span>"-"</span>,px[<span>1</span>]), <br>  paste0(px[<span>4</span>],<span>"-"</span>,px[<span>3</span>]), <br>  paste0(px[<span>4</span>],<span>"-"</span>,px[<span>2</span>]),<br>    levels = colnames(design))  <span>#对照组放在levels的第一个位置</span><br><br>par (mfrow=c (<span>1</span>,<span>2</span>)) <span>##实现一页多图</span><br><br><span>##方法1---------</span><br><span>#从表达计数数据中删除异方差</span><br><span>#原文见于CSDN:使用limma、Glimma和edgeR,RNA-seq数据分析</span><br>v&lt;-voom(dat,design,plot=<span>TRUE</span>)<br>vfit&lt;-lmFit(v,design)<br>vfit&lt;-contrasts.fit(vfit,contrasts = contr.matrix)<br>efit&lt;-eBayes(vfit)<br>plotSA(efit,main=<span>"Final model:Mean-variance trend"</span>)<br><br><span># #检查差异基因数量</span><br>dt=decideTests(efit,p.value = <span>0.05</span>,lfc = <span>0.5</span>)<br>summary(dt)<br><br><span># MCFRR-MCF MDAMBRR-MDAMB MDAMBRR-MCFRR</span><br>Down          <span>19</span>             <span>7</span>           <span>249</span><br>NotSig     <span>23274</span>         <span>23295</span>         <span>22577</span><br>Up            <span>14</span>             <span>5</span>           <span>481</span><br>vennDiagram(dt[,<span>1</span>:<span>3</span>],circle.col =c(<span>"turquoise"</span>,<span>"salmon"</span>,<span>"cornflowerblue"</span>))<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.1758034026465027" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8uoPKspehlftuln2gxpXdxznGv8QcmibX9EavEzXrv0Offm5hx8Gc6oZeoO8gUoBflS9iaz08rSn1Q/640?wx_fmt=png" data-type="png" data-w="529" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8uoPKspehlftuln2gxpXdxznGv8QcmibX9EavEzXrv0Offm5hx8Gc6oZeoO8gUoBflS9iaz08rSn1Q/640?wx_fmt=png"><figcaption>venn</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code><span>##方法2--------</span><br><span>##1:3是因为共有3次组间比较</span><br>deg = lapply(<span>1</span>:<span>3</span>, <span>function</span>(i){<br>  topTable(efit,coef = i,number = <span>Inf</span>)<br>})<br>names(deg) = colnames(contr.matrix)<br><br><span>###选择任意两个分组进行差异表达可视化</span><br>plotMD(efit,column = <span>1</span>,<br>       status = decideTests(efit)[,<span>3</span>],<br>       main=colnames(efit)[<span>1</span>] )<br><br><span>##给deg增加上下调信息------</span><br><span>library</span>(dplyr)<br><span>library</span>(clusterProfiler)<br><span>library</span>(org.Hs.eg.db)<br><br>head(deg[[<span>1</span>]]) <span>##随时查看数据</span><br><br><span>for</span>(i <span>in</span> <span>1</span>:<span>3</span>){<br>  <span>#1.加基因列</span><br>  deg[[i]] &lt;- mutate(deg[[i]],symbol=rownames(deg[[i]]))<br>  deg[[i]] &lt;- inner_join(deg[[i]],ids,by=<span>"symbol"</span>)<br>  <span>#去重</span><br>  deg[[i]] &lt;- deg[[i]][!duplicated(deg[[i]]$symbol),]<br>  logFC_t=with(deg[[i]],mean(abs(logFC)))<br>  P.Value_t=<span>0.05</span><br>  <span>#3.change</span><br>  {logFC_t=<span>0.5</span><br>    P.Value_t = <span>0.05</span><br>    change=ifelse(deg[[i]] $P.Value&gt;P.Value_t,<span>'stable'</span>, <br>                  ifelse( deg[[i]]$logFC &gt;logFC_t,<span>'up'</span>, <br>                          ifelse( deg[[i]]$logFC &lt; -logFC_t,<span>'down'</span>,<span>'stable'</span>) )<br>    )<br>    deg[[i]] &lt;- mutate(deg[[i]],change)<br>    print(table(deg[[i]]$change))<br>    deg[[i]] &lt;- mutate(deg[[i]],v = -log10(P.Value))<br>  }<br>  <span>#4.加ENTREZID列，后面富集分析要用</span><br>  s2e &lt;- bitr(unique(deg[[i]]$symbol), fromType = <span>"SYMBOL"</span>,<br>              toType = c( <span>"ENTREZID"</span>),<br>              OrgDb = org.Hs.eg.db)<br>  deg[[i]] &lt;- inner_join(deg[[i]],s2e,by=c(<span>"symbol"</span>=<span>"SYMBOL"</span>))<br>  <br>}<br><br><span>#down stable     up </span><br>    <span>19</span>  <span>23274</span>     <span>14</span><br><span>#down stable     up </span><br>     <span>7</span>  <span>23294</span>      <span>6</span><br><span>#down stable     up </span><br>   <span>250</span>  <span>22576</span>    <span>481</span><br><br>save(deg,contr.matrix,file = <span>"step2output.Rdata"</span>)<br><br></code></pre><p data-tool="mdnice编辑器">上下调基因并不是很多，这是为什么呢？答案可能在后续的paper中，大家可以期待一下</p><h3 data-tool="mdnice编辑器"><span></span><span>可视化</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br><br><span>##加载包</span><br><span>library</span>(tinyarray)<br><span>library</span>(dplyr)<br><br>load(<span>"step1-output.Rdata"</span>)<br>load( <span>"step2output.Rdata"</span>)<br><br><br>pca_plot &lt;- draw_pca(exp,group_list)<br>volc = lapply(<span>1</span>:length(deg),<span>function</span>(k){<br>  draw_volcano(deg[[k]],<br>               lab = colnames(contr.matrix)[k],<br>               pkg = <span>2</span>,  <span>##需查看参数的意义</span><br>               logFC_cutoff  = <span>0.5</span>,<br>               pvalue_cutoff = <span>0.05</span>,<br>               symmetry = <span>T</span>)<br>})<br><br>dev.off()<br>volc[[<span>3</span>]] <span>##挑选一个看看效果</span><br><br><br>cgs = list()<br><span>for</span>(k <span>in</span> <span>1</span>:<span>3</span>){<br>  cgs[[k]] = filter(deg[[k]],abs(logFC) &gt; logFC &amp; P.Value &lt; <span>0.05</span>) %&gt;% <br>    dplyr::select(probe_id)<br>}<br>cg = intersect(intersect(cgs[[<span>1</span>]]$probe_id,cgs[[<span>2</span>]]$probe_id),cgs[[<span>3</span>]]$probe_id)<br>cg = union(union(cgs[[<span>1</span>]]$probe_id,cgs[[<span>2</span>]]$probe_id),cgs[[<span>3</span>]]$probe_id)<br>cg = c(head(sort(cg),<span>200</span>),tail(sort(cg),<span>200</span>))  <br>h = draw_heatmap(exp[cg,],group_list,cluster_cols = <span>F</span>)  <span>##exp行名要求是探针名</span><br><br><br><span>library</span>(patchwork)<br>plotlist = c(list(h,pca_plot),volc)<br>layout &lt;- <span>'<br>AAABBB<br>AAABBB<br>CCDDEE<br>'</span><br>wrap_plots(plotlist) + plot_layout(design = layout)+ plot_layout(guides = <span>'collect'</span>)<br><br><span>library</span>(ggplot2)<br>ggsave(<span>"patch_work.pdf"</span>)<br></code></pre><p data-tool="mdnice编辑器">仔细观察，可以发现dat和exp这两个矩阵是有区别的，可以利用dat进行后续的go和kegg富集分析，有兴趣的同学可以接着往下试试看</p><figure data-tool="mdnice编辑器"><img data-ratio="0.75" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los8uoPKspehlftuln2gxpXdxATnbCLVWwTVCEtKB3DxG3IBkI0xrqvdkC3n2vyT8Ro4ocj10icFtLDA/640?wx_fmt=jpeg" data-type="jpeg" data-w="7680" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los8uoPKspehlftuln2gxpXdxATnbCLVWwTVCEtKB3DxG3IBkI0xrqvdkC3n2vyT8Ro4ocj10icFtLDA/640?wx_fmt=jpeg"><figcaption>patch_work_1</figcaption></figure><blockquote data-tool="mdnice编辑器"><p>这里是粗心的小编打的补丁，补上上周两分组分析中缺失的"kegg_plot_function.R"</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span>### ---------------</span><br><span>###</span><br><span>### Create: Jianming Zeng</span><br><span>### Date: 2018-07-09 20:11:07</span><br><span>### Email: jmzeng1314@163.com</span><br><span>### Blog: http://www.bio-info-trainee.com/</span><br><span>### Forum:  http://www.biotrainee.com/thread-1376-1-1.html</span><br><span>### CAFS/SUSTC/Eli Lilly/University of Macau</span><br><span>### Update Log: 2018-07-09  First version</span><br><span>###</span><br><br><span>### Update: Xiaojie Liang</span><br><span>### Date: 2021-07-12 23:38:07</span><br><span>### Email: liangxiaojiecom@163.com</span><br><span>### ---------------</span><br><span>library</span>(ggthemes)<br><span>library</span>(ggplot2)<br>kegg_plot &lt;- <span>function</span>(up.data,down.data){<br>  dat=rbind(up.data,down.data)<br>  colnames(dat)<br>  dat$pvalue = -log10(dat$pvalue)<br>  dat$pvalue=dat$pvalue*dat$group <br>  <br>  dat=dat[order(dat$pvalue,decreasing = <span>F</span>),]<br>  <br>  gk_plot &lt;- ggplot(dat,aes(reorder(Description, pvalue), y=pvalue)) +<br>    geom_bar(aes(fill=factor((pvalue&gt;<span>0</span>)+<span>1</span>)),stat=<span>"identity"</span>, width=<span>0.7</span>, position=position_dodge(<span>0.7</span>)) +<br>    coord_flip() +<br>    scale_fill_manual(values=c(<span>"#0072B2"</span>, <span>"#B20072"</span>), guide=<span>"none"</span>) +<br>    labs(x=<span>""</span>, y=<span>""</span> ) +<br>    theme_pander()  +<br>    theme(panel.grid.major = element_blank(),<br>          panel.grid.minor = element_blank(),<br>          <span>#axis.ticks.x = element_blank(),</span><br>          axis.line.x = element_line(size = <span>0.3</span>, colour = <span>"black"</span>),<span>#x轴连线</span><br>          axis.ticks.length.x = unit(-<span>0.20</span>, <span>"cm"</span>),<span>#修改x轴刻度的高度，负号表示向上</span><br>          axis.text.x = element_text(margin = margin(t = <span>0.3</span>, unit = <span>"cm"</span>)),<span>##线与数字不要重叠</span><br>          axis.ticks.x = element_line(colour = <span>"black"</span>,size = <span>0.3</span>) ,<span>#修改x轴刻度的线                         </span><br>          axis.ticks.y = element_blank(),<br>          axis.text.y  = element_text(hjust=<span>0</span>),<br>          panel.background = element_rect(fill=<span>NULL</span>, colour = <span>'white'</span>)<br>    )<br>}<br></code></pre><p data-tool="mdnice编辑器">以上就是内容的全部，其实还有另外一个包可以更快捷地完成多分组的差异分析，下次给大家演示看吧</p></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/w4FGC6ppCTx57wL2jVV7nA",target="_blank" rel="noopener noreferrer">原文链接</a>
