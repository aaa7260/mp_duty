---
title: "解决monocle中orderCells报错的一波三折"
date: 2022-09-22T10:09:46Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
解决monocle中orderCells报错的一波三折 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>我的很多单细胞教程是三五年前写的了，虽然降维聚类分群的主体思路没有变化，但是很多包用法因为作者对包的更新导致我的教程失效了。讨论最多的就是拟时序分析也转录因子分析，后来看到了群里的大家讨论的结果是：<strong>如果是monocle（2.24.1版本）拟时序分析时遇到报错，改用monocle（2.22.0），解决报错。SCENIC(1.1.2)改用SCENIC(1.3.1)解决报错</strong></p></blockquote></section><p>恰好这两天有一个学徒也是遇到了同样的报错，没有第一时间去修改版本，而是尝试读源代码方式解决：</p><p><span>因为服务器网络临时出现了问题，但是项目比较急，就不得不本地跑单细胞拟时序分析的monocle2包 ，运行脚本如下：</span></p><p><img data-ratio="0.6686893203883495" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAbdGwd5L89M2yFGpKq8yJtiaGJj0PF1kGBTFNPLbwRHZ0wyqlaYiaFdMQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="1648" width="824" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAbdGwd5L89M2yFGpKq8yJtiaGJj0PF1kGBTFNPLbwRHZ0wyqlaYiaFdMQ/640?wx_fmt=jpeg"></p><p><span>到cds &lt;- orderCells(cds)这一步的时候报错了</span></p><p><span></span></p><p><span>  if(class(projection) != 'matrix')                 -&gt; error</span></p><p><span>    projection &lt;- as.matrix(projection)</span></p><p><span></span></p><p><span>将问题复制粘贴到bing搜索框，看到了github上关于这个问题的讨论，其中这个解答就是大家总结出来的解决方法：</span></p><p>https://github.com/cole-trapnell-lab/monocle-release/issues/434#issuecomment-1159781524</p><p><img data-ratio="0.8978494623655914" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGA7O2D3t5DP9GfMiafctJmKqpLVjjIG46X2XicEBibW7vBib4Vibqt8PnyFYg/640?wx_fmt=jpeg" data-type="jpeg" data-w="1488" width="744" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGA7O2D3t5DP9GfMiafctJmKqpLVjjIG46X2XicEBibW7vBib4Vibqt8PnyFYg/640?wx_fmt=jpeg"></p><p><span>我们按照上面提供的方法一步步操作</span></p><p><span>1.从这个网址上下载monocle</span></p><p>https://www.bioconductor.org/packages/3.15/bioc/src/contrib/Archive/monocle/</p><p><img data-ratio="0.2607329842931937" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAnODteuYayFic4Yicd7MEESm6EPTno91cKMaSVdvicTm9wrbXdBm4a6T1w/640?wx_fmt=png" data-type="png" data-w="1910" width="1910" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAnODteuYayFic4Yicd7MEESm6EPTno91cKMaSVdvicTm9wrbXdBm4a6T1w/640?wx_fmt=png"></p><p><span>2.解压之后得到一个monocle文件夹</span></p><p><span>3.打开这个文件夹R文件夹下面的order_cells.R脚本</span></p><p><img data-ratio="0.4096958174904943" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAn2448mBlnhic7GXkfmd6PZ72aPWSKlDW2Ry2TFbCRMhlvI0sPYjkSqQ/640?wx_fmt=png" data-type="png" data-w="2104" width="2104" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAn2448mBlnhic7GXkfmd6PZ72aPWSKlDW2Ry2TFbCRMhlvI0sPYjkSqQ/640?wx_fmt=png"></p><p><span>打开脚本，将1620和1621行的代码从</span></p><p><span>if(class(projection) != 'matrix')<br></span><span>projection &lt;- as.matrix(projection)</span></p><p><span>修改为</span></p><p><span>projection &lt;- as.matrix(projection)</span></p><p><span></span></p><p><img data-ratio="0.8356973995271868" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAdX2g83uE8tOAnnCjvt08jFFXnI5icjnxLzIiaTLgeLj1xUCIbbicibibA2w/640?wx_fmt=jpeg" data-type="jpeg" data-w="1692" width="846" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAdX2g83uE8tOAnnCjvt08jFFXnI5icjnxLzIiaTLgeLj1xUCIbbicibibA2w/640?wx_fmt=jpeg"></p><p><span></span></p><p><span>保存脚本，在R studio 的Console的位置用.libPaths()查找出R包的安装位置如下：</span></p><p><span>.libPaths()<br></span><span>[1] "/Library/Frameworks/R.framework/Versions/4.2/Resources/library"</span></p><p><span>根据这个路径找到library文件夹（如果是mac电脑，直接将以上文件路径复制到聚焦搜索框就能快速定位到文件位置）</span></p><p><span>将改好的monocle文件拖进library文件夹后，在</span><span> R studio,中输入以下命令来加载这个包</span></p><p><span>devtools::load_all("path to the location/monocle")</span></p><p><span>然后再次运行</span><span>orderCells函数，问题就解决了！（这个回答是这么说的）</span></p><p><span>但是！！！当我满心欢喜期待问题解决的时候，运行orderCells仍然出现同样的报错，问题依然存在！</span></p><p><span>于是我怀疑刚刚改过的包并没有被成功加载，加载的，是之前新版本的monocle包，于是我重启R studio ，重新来了一遍，发现到monocle加载不了，显示没有这个包，推测这是因为我修改后的monocle包虽然被我拖到library文件夹中了，但是并没有被成功安装，然后继续查看刚刚github中的回答，发现有这么一条</span></p><p><img data-ratio="0.8450704225352113" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGA4oJsKwCwsFKaXfRib0ibDBzHOfR8o5EGJ7Nlf5pxgTZbNSVPKaXNMZlQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="1562" width="781" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGA4oJsKwCwsFKaXfRib0ibDBzHOfR8o5EGJ7Nlf5pxgTZbNSVPKaXNMZlQ/640?wx_fmt=jpeg"></p><p><span>按照这个方法install这个包，然后再load，仍然不成功</span></p><p><span>这时候出现了一个我之前一直不知道的R包的安装方法，那就是</span></p><p><span><strong>在monocle文件夹下新建一个Rproj文件，然后打开这个文件，右上方的install and restart按钮，包就会被安装上。</strong></span></p><p><img data-ratio="0.673182173573104" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAgPV5WnSMK4ReohkXOibiaVeWOt9A5hw3q3V7LfZ0dU6qPXk1KIclxH2A/640?wx_fmt=jpeg" data-type="jpeg" data-w="2558" width="1279" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAgPV5WnSMK4ReohkXOibiaVeWOt9A5hw3q3V7LfZ0dU6qPXk1KIclxH2A/640?wx_fmt=jpeg"></p><p><span>用这个方法安装上monocle包之后，再load，成功了，再次运行orderCells，成功了！</span></p><p><span>到此，这个问题成功解决！！！！</span><span>然而？</span><span></span></p><p><span>问题真的解决了吗？</span></p><p><span>继续运行脚本，在运行到</span><span>BEAM函数运行的时候又出现了如下报错：</span></p><p><span>&gt; BEAM_res &lt;- BEAM(cds[expressed_genes[1:20],], branch_point = 1, cores = 1)</span></p><p><span>Error in if (progenitor_method == "duplicate") { :</span></p><p><span>  the condition has length &gt; 1</span></p><p><span>Called from: buildBranchCellDataSet(cds = cds, branch_states = branch_states,</span></p><p><span>    branch_point = branch_point, branch_labels = branch_labels,</span></p><p><span>    ...)</span></p><p><span>截图如下：</span></p><p><img data-ratio="0.948905109489051" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAgzjKzJPXp2U9l6jXGFJSib3khENkn8AklCYV6llCseGBX4hYsTtR0mg/640?wx_fmt=png" data-type="png" data-w="1644" width="822" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAgzjKzJPXp2U9l6jXGFJSib3khENkn8AklCYV6llCseGBX4hYsTtR0mg/640?wx_fmt=png"></p><p><span>然而在服务器上运行同样的代码，其实也出现了同样的提示，但不是Error是warning，然后代码仍然可以继续运行下去，截图如下：</span></p><p><img data-ratio="0.9868421052631579" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAB9fgKrlpBhUFT7gXVT4uFWeNXxqUzuV8GBbUCrejOmOQiaFWS71TNPQ/640?wx_fmt=png" data-type="png" data-w="1368" width="684" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAB9fgKrlpBhUFT7gXVT4uFWeNXxqUzuV8GBbUCrejOmOQiaFWS71TNPQ/640?wx_fmt=png"></p><p><span>仔细看github上关于这个问题的讨论， 发现有人和我碰到了一样的问题</span></p><p>https://github.com/cole-trapnell-lab/monocle-release/issues/434#issuecomment-1162077298</p><p><img data-ratio="0.509829619921363" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAZImzxG6P3dDJUxENOkjianhLkZ983uhetkkm05PceIHKq2P0gNQASYw/640?wx_fmt=jpeg" data-type="jpeg" data-w="1526" width="763" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAZImzxG6P3dDJUxENOkjianhLkZ983uhetkkm05PceIHKq2P0gNQASYw/640?wx_fmt=jpeg"></p><p><span>当然往后翻，是有人给出解决方法的，又是<strong>和order cells一样，去修改源代码</strong></span></p><p><img data-ratio="0.9005524861878453" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAWbbmbYcbEiaf67dqicZN7IMutFbxzRlE9T1MQZSwibatAUVSMedShoiajw/640?wx_fmt=jpeg" data-type="jpeg" data-w="1448" width="724" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyYPrLV2299XMsBG8EL5wGAWbbmbYcbEiaf67dqicZN7IMutFbxzRlE9T1MQZSwibatAUVSMedShoiajw/640?wx_fmt=jpeg"></p><p><span>但到这里，我已经不想改了，暂时放弃在本地运行monocle</span></p><p><span>总结一下，这次debug，最初始的问题是解决了但是从整体来看又不算完全解决，<strong>或许最干脆的方法是降级R和/或R studio，不然不知道下次在哪个函数上又碰到报错要去修改源代码。</strong></span></p><p><span>不过在这个过程中，我对R包的认识又上了一个新的台阶，以前只知道安装它，加载它，除了这个包叫什么名字，有哪几个常用函数之外，其他一概不了解。<strong>这是第一次深入R包内部看到它的源代码，看到我们用一个函数实现的功能的背后是动辄几千行代码，由衷佩服，致敬所有R包开发人员！</strong></span></p><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/byRJYvTkC7BSUXvmQuXc2g",target="_blank" rel="noopener noreferrer">原文链接</a>
