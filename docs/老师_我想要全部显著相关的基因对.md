---
title: "老师，我想要全部显著相关的基因对"
date: 2023-01-26T01:13:21Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
老师，我想要全部显著相关的基因对 by 生信星球
------
<div><section data-mpa-powered-by="yiban.io"><img data-ratio="1" data-type="png" data-w="20" width="20px" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-ratio="1" data-type="png" data-w="20" width="20px" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第895天</strong></span></span><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><p><span><span>   </span><span>大神一句话，菜鸟跑半年。我不是大神，但我可以缩短你走弯路的半年~</span></span></p><p><span>   就像歌儿唱的那样，如果你不知道该往哪儿走，就留在这学点生信好不好~</span></p><p><span>   这里有豆豆和花花的学习历程，从新手到进阶，生信路上有你有我!</span></p><section><h4><span>0.需求</span></h4><p>这是我的直播课学员提的需求，觉得挺有意义的，就帮他实现了一下。</p><p>想要找出一个表达矩阵里所有相关性r&gt;0.8且p&lt;0.05的基因对。</p><p>不是直接从矩阵或者里看，而是得到若干对基因作为输出结果。</p><h4><span>1.编一个表达矩阵</span></h4><pre><code>set.seed(<span>10086</span>)<br><span>exp</span> = matrix(rnorm(<span>600</span>,sd = <span>10</span>),nrow = <span>60</span>)<br>rownames(<span>exp</span>) = paste<span>0</span>(<span>"gene"</span>,<span>1</span>:nrow(<span>exp</span>))<br>colnames(<span>exp</span>) = paste<span>0</span>(<span>"sample"</span>,<span>1</span>:ncol(<span>exp</span>))<br><span>exp</span>[<span>1</span>:<span>10</span>,] = <span>exp</span>[<span>1</span>:<span>10</span>,] + <span>5</span><br><span>exp</span>[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br><span>##         sample1    sample2   sample3    sample4</span><br><span>## gene1  10.49789   4.964393 -0.473901 13.6810594</span><br><span>## gene2 -22.44959  19.323965 15.036701 -0.6999084</span><br><span>## gene3  10.66458 -11.270693  3.908851 14.5247626</span><br><span>## gene4   9.85479   3.768001 -4.621285 10.5618159</span><br><br>boxplot(<span>exp</span>)<br></code></pre><figure><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrRz4OlwD80w3oPqjGicicleoXjd5rea766a32fKhr80HM11o7n5j4U9YtamKWsyOtNJI7tnqJnicpvA/640?wx_fmt=png" data-type="png" data-w="1240" title="" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrRz4OlwD80w3oPqjGicicleoXjd5rea766a32fKhr80HM11o7n5j4U9YtamKWsyOtNJI7tnqJnicpvA/640?wx_fmt=png"></figure><h4><span>2.计算基因相关性和p值</span></h4><p>cor.test函数不支持矩阵化计算，所以使用corrplot里的函数cor.mtest。</p><pre><code>library(corrplot)<br><br><span>## corrplot 0.92 loaded</span><br><br>corm = cor(t(exp)) <br>copm = cor.mtest(t(exp))$p<br><span>pheatmap::pheatmap(corm)</span><br></code></pre><figure><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrRz4OlwD80w3oPqjGicicleoHsZDsicbZhaeiaxW0fdtpvlrDnlEWGKWl2dIaiaIkwyTd5BjQYevZhfBw/640?wx_fmt=png" data-type="png" data-w="1240" title="" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrRz4OlwD80w3oPqjGicicleoHsZDsicbZhaeiaxW0fdtpvlrDnlEWGKWl2dIaiaIkwyTd5BjQYevZhfBw/640?wx_fmt=png"></figure><h4><span>3.宽变长</span></h4><p>两个矩阵分别宽变长。然后合并到一起</p><pre><code>library(tidyverse)<br>corm2 = corm %&gt;% <br>  <span>as</span>.data.frame() %&gt;% <br>  rownames_to_column(<span>"G1"</span>) %&gt;% <br>  pivot_longer(cols = starts_with(<span>"gene"</span>),<br>               names_to = <span>"G2"</span>,<br>               values_to = <span>"correlation"</span>)<br>copm2 = copm %&gt;% <br>  <span>as</span>.data.frame() %&gt;% <br>  rownames_to_column(<span>"G1"</span>) %&gt;% <br>  pivot_longer(cols = starts_with(<span>"gene"</span>),<br>               names_to = <span>"G2"</span>,<br>               values_to = <span>"pvalue"</span>)<br>identical(copm2$G1,corm2$G1)<br><span>## [1] TRUE</span><br>identical(copm2$G2,corm2$G2)<br><span>## [1] TRUE</span><br>dat = mutate(corm2,pvalue = copm2$pvalue)<br>head(dat)<br><span>## # A tibble: 6 × 4</span><br><span>##   G1    G2    correlation pvalue</span><br><span>##   &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;</span><br><span>## 1 gene1 gene1     1       0     </span><br><span>## 2 gene1 gene2    -0.513   0.129 </span><br><span>## 3 gene1 gene3     0.579   0.0795</span><br><span>## 4 gene1 gene4     0.427   0.218 </span><br><span>## 5 gene1 gene5     0.122   0.737 </span><br><span>## 6 gene1 gene6     0.00537 0.988</span><br></code></pre><h4><span>4.去重复</span></h4><p>现在，G1-G2组成的基因对也是有重复的，给你看个例子就明白了。</p><pre><code>dat[c(2,61),]<br><span>#</span><span><span># # A tibble: 2 × 4</span></span><br><span>#</span><span><span>#   G1    G2    correlation pvalue</span></span><br><span>#</span><span><span>#   &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;</span></span><br><span>#</span><span><span># 1 gene1 gene2      -0.513  0.129</span></span><br><span>#</span><span><span># 2 gene2 gene1      -0.513  0.129</span></span><br></code></pre><p>所以这样的行只保留一行即可。</p><p>直接按照三四列去重也不是不行，但不怕一万就怕万一啊，基因数量多了的话那谁说得准的。。留下这个bug，万一以后踩雷了岂不学术造假。</p><p>观察宽变长的规律可以发现，基因的排列是有顺序的。第一列是由行名来的，重复了60次(111222333这样的)，第二列是由列名变来的，重复了60轮(123123123这样的)。所以思路就是把原来的矩阵对角线及以上的格子去掉即可。</p><pre><code>dat$x = rep(<span>1</span>:<span>60</span>,<span>each</span> = <span>60</span>)<br>dat$y = rep(<span>1</span>:<span>60</span>,<span>times</span> = <span>60</span>)<br><span># x&lt;y或者x&gt;y都行，反正只留一半。</span><br>dat2 = filter(dat,<span>x</span>&lt;<span>y</span>)<br></code></pre><h4><span>5. 筛选符合要求的基因对</span></h4><p>相关系数大于0.8且p值小于0.05</p><pre><code>filter(dat2,abs(correlation)&gt;0.8 &amp; pvalue&lt;0.05)<br><span>#</span><span><span># # A tibble: 8 × 6</span></span><br><span>#</span><span><span>#   G1     G2     correlation    pvalue     x     y</span></span><br><span>#</span><span><span>#   &lt;chr&gt;  &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt; &lt;int&gt;</span></span><br><span>#</span><span><span># 1 gene3  gene55      -0.844 0.00213       3    55</span></span><br><span>#</span><span><span># 2 gene14 gene20       0.804 0.00508      14    20</span></span><br><span>#</span><span><span># 3 gene15 gene18      -0.859 0.00146      15    18</span></span><br><span>#</span><span><span># 4 gene15 gene39      -0.832 0.00284      15    39</span></span><br><span>#</span><span><span># 5 gene18 gene42      -0.803 0.00512      18    42</span></span><br><span>#</span><span><span># 6 gene29 gene57       0.853 0.00169      29    57</span></span><br><span>#</span><span><span># 7 gene31 gene60       0.812 0.00431      31    60</span></span><br><span>#</span><span><span># 8 gene33 gene38       0.938 0.0000599    33    38</span></span><br></code></pre></section><p><span></span></p><section><blockquote><section><span>如果因为代码看不懂，而跟不上正文的节奏，可以来找我，系统学习。我的</span><span>课程都是循环开课。</span><span>下一期的时间，点进去咨询微信咯</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247492627&amp;idx=1&amp;sn=614671537676eece45244aa1cbe94b15&amp;chksm=fdfbac51ca8c25475c71ed3b7b3506391a8d08149acfd62d0666193e382b33634382bef4f80d&amp;scene=21#wechat_redirect" textvalue="产假结束，核酸尚阴，期待遇见2023年的你" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">产假结束，核酸尚阴，期待遇见2023年的你</a><br></section></blockquote></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/P71yIJttlaXp5XuOKFYFtA",target="_blank" rel="noopener noreferrer">原文链接</a>
