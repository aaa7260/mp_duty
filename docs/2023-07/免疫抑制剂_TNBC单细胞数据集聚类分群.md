---
title: "免疫抑制剂-TNBC单细胞数据集聚类分群"
date: 2023-07-23T09:23:26Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
免疫抑制剂-TNBC单细胞数据集聚类分群 by 生信菜鸟团
------
<div><section><blockquote><p>选这个题是因为最近涉及到TNBC较多，解析这篇文章对我有着较大的意义。再者我在组会上讲过这篇文章，一时间就想到了。然而…</p><p>对了时隔一个月再次登录这个公众号，看到了墨眉大佬的留言（PS：经常在群里看到大家讨论问题），代码都是现成的，搬运工辛苦一点没事啦~话说也不辛苦，当是工作之余的额外消遣了。<br></p><p>谁知道制药行业也要用到初级的R...最近在看R语言实战3补知识，还需要点医学统计学了，进而需要药代动力学，临床药理学...是的学不过来了，但有些知识简直是一通百通。</p></blockquote><p>首先是准备工作<br></p><figure><img data-ratio="0.5296296296296297" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDm12GOZ4m9iaQeia9dibA1bpEx2jFEtR4aTFJsHs70tANTZbaZXfiaJtiasw/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDm12GOZ4m9iaQeia9dibA1bpEx2jFEtR4aTFJsHs70tANTZbaZXfiaJtiasw/640?wx_fmt=png"></figure>开始找数据<br><figure><img data-ratio="0.25555555555555554" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDyvmAEtGkDJK9EQDM0Nr6jkxOKcq3u7ibXuvIfVGMibreIK7l8j0E4QOw/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDyvmAEtGkDJK9EQDM0Nr6jkxOKcq3u7ibXuvIfVGMibreIK7l8j0E4QOw/640?wx_fmt=png"></figure>重新浏览一遍文章，问题来了。之前讲解这篇文章时，也没注意到这么多细胞</section><section><figure><img data-ratio="0.2833333333333333" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDf2m6c40RZ75T3prSPGGgTNcCogpLdUOTHPUic8C7ibPeEvjed2H928Cg/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDf2m6c40RZ75T3prSPGGgTNcCogpLdUOTHPUic8C7ibPeEvjed2H928Cg/640?wx_fmt=png"></figure>对，于是有问题了，<br><figure><img data-ratio="1.647887323943662" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDic0iafibkfbTzZwsib2LdiatKRqBq2FiaczL4R35S1wfBMWtv6shicuInPXsg/640?wx_fmt=png" data-type="png" data-w="355" title="7ce92c97e6038c55125911430d03fcb.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDic0iafibkfbTzZwsib2LdiatKRqBq2FiaczL4R35S1wfBMWtv6shicuInPXsg/640?wx_fmt=png"></figure><br><strong>然后就是花费了从早上9点至下午4点的运行过程，流程是初级流程，时间是好几倍，这时间可以跑完别的一整篇了，果然不可高攀。</strong><br>乍一看去，这些图不算难呀，可能这个PI和TI的设定得多花点时间琢磨一下<br><figure><img data-ratio="0.5046296296296297" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDMxtL0oIibynM0TCJxn8Am3biaVib9ZK30QH1RL86Od4GVEnkwhfdsK9Eg/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDMxtL0oIibynM0TCJxn8Am3biaVib9ZK30QH1RL86Od4GVEnkwhfdsK9Eg/640?wx_fmt=png"></figure><br>PI的公式<br><figure><img data-ratio="0.07962962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDrM9DVryt7ZLCnSQa6fAM4L5xU8b8NYpRlZb3o1g6FiarexQBRIypLGQ/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDrM9DVryt7ZLCnSQa6fAM4L5xU8b8NYpRlZb3o1g6FiarexQBRIypLGQ/640?wx_fmt=png"></figure><br>TI的公式<br><figure><img data-ratio="0.06574074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDI57yToZ9Q0ykTMQSsEpFrIWB1WhZiasGNAbpwsVV6H5XG8fCAC0Lx6Q/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDI57yToZ9Q0ykTMQSsEpFrIWB1WhZiasGNAbpwsVV6H5XG8fCAC0Lx6Q/640?wx_fmt=png"></figure><figure><br></figure>好了，开始聚类分群。<br><strong>1.读取数据，质控</strong><pre><code><span>###### step1:导入数据 ###### </span><br><span>rm</span>(list=ls())<br><span>options</span>(stringsAsFactors = F) <br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><br><span>samples</span>=list.files('GSE169246_scRNA_RAW/')<br><span>samples</span> <br><br><span>library</span>(Matrix)<br><span>mtx</span>=readMM('GSE169246_scRNA_RAW/GSE169246_TNBC_RNA.counts.mtx.gz')<br><span>mtx</span>[1:4,1:4]<br><span>dim</span>(mtx)<br><br><span>library</span>(data.table)<br><span>cl</span>=fread('GSE169246_scRNA_RAW/GSE169246_TNBC_RNA.barcode.tsv.gz',<br>         <span>header</span> = F,data.table = F ) <br><span>head</span>(cl)<br><br><span>rl</span>=fread('GSE169246_scRNA_RAW/GSE169246_TNBC_RNA.feature.tsv.gz',<br>         <span>header</span> = F,data.table = F ) <br><span>head</span>(cl)<br><span>head</span>(rl)<br><span>dim</span>(mtx)<br><br><span>rownames</span>(mtx) &lt;- rl$V1 <br><span>colnames</span>(mtx)=cl$V1<br><span>sce</span>.<span>all</span>=CreateSeuratObject(counts = mtx )<br><br><span>as</span>.data.frame(sce.<span>all</span>@assays$RNA@counts[1:10, 1:2])<br><span>head</span>(sce.<span>all</span>@meta.data, 10)<br><span>table</span>(sce.<span>all</span>@meta.data$orig.ident) <br><br><span>sce</span>.<span>all</span><br><span>library</span>(stringr)<br><span>phe</span>=str_split(rownames(sce.<span>all</span>@meta.data),'[.]',simplify = T)<br><span>sce</span>.<span>all</span>@meta.data$orig.ident = phe[,2]<br><span>phe</span>=as.data.frame(str_split( phe[,2] ,'_',simplify = T))<br><span>head</span>(phe)<br><span>sce</span>.<span>all</span>@meta.data$treat = phe$V1<br><span>sce</span>.<span>all</span>@meta.data$patient = phe$V2<br><span>sce</span>.<span>all</span>@meta.data$type = phe$V3<br><br><span>table</span>(sce.<span>all</span>@meta.data$orig.ident)<br><br><br><span>###### step2:QC质控 ######</span><br><span>dir</span>.create(<span>"./1-QC"</span>)<br><span>setwd</span>(<span>"./1-QC"</span>)<br><span># sce.all=readRDS("../sce.all_raw.rds")</span><br><span>#计算线粒体基因比例</span><br><span># 人和鼠的基因名字稍微不一样 </span><br><span>mito_genes</span>=rownames(sce.<span>all</span>)[grep(<span>"^MT-"</span>, rownames(sce.<span>all</span>))] <br><span>mito_genes</span> #13个线粒体基因<br><span>sce</span>.<span>all</span>=PercentageFeatureSet(sce.<span>all</span>, <span>"^MT-"</span>, col.name = <span>"percent_mito"</span>)<br><span>fivenum</span>(sce.<span>all</span>@meta.data$percent_mito)<br><span>#计算核糖体基因比例</span><br><span>ribo_genes</span>=rownames(sce.<span>all</span>)[grep(<span>"^Rp[sl]"</span>, rownames(sce.<span>all</span>),ignore.case = T)]<br><span>ribo_genes</span><br><span>sce</span>.<span>all</span>=PercentageFeatureSet(sce.<span>all</span>, <span>"^RP[SL]"</span>, col.name = <span>"percent_ribo"</span>)<br><span>fivenum</span>(sce.<span>all</span>@meta.data$percent_ribo)<br><span>#计算红血细胞基因比例</span><br><span>rownames</span>(sce.<span>all</span>)[grep(<span>"^Hb[^(p)]"</span>, rownames(sce.<span>all</span>),ignore.case = T)]<br><span>sce</span>.<span>all</span>=PercentageFeatureSet(sce.<span>all</span>, <span>"^HB[^(P)]"</span>, col.name = <span>"percent_hb"</span>)<br><span>fivenum</span>(sce.<span>all</span>@meta.data$percent_hb)<br><span>#可视化细胞的上述比例情况</span><br><span>feats</span> &lt;- c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>, <span>"percent_mito"</span>, <span>"percent_ribo"</span>, <span>"percent_hb"</span>)<br><span>feats</span> &lt;- c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>)<br><span>p1</span>=VlnPlot(sce.<span>all</span>, group.by = <span>"orig.ident"</span>, features = feats, pt.size = 0.01, ncol = 2) + <br>  <span>NoLegend</span>()<br><span>p1</span><br><span>library</span>(ggplot2) <br><span>ggsave</span>(filename=<span>"Vlnplot1.pdf"</span>,plot=p1,width = 10,height = 7.5)<br><span>feats</span> &lt;- c(<span>"percent_mito"</span>, <span>"percent_ribo"</span>, <span>"percent_hb"</span>)<br><span>p2</span>=VlnPlot(sce.<span>all</span>, group.by = <span>"orig.ident"</span>, features = feats, pt.size = 0.01, ncol = 3, same.y.lims=T) + <br>  <span>scale_y_continuous</span>(breaks=seq(0, 100, 5)) +<br>  <span>NoLegend</span>()<br><span>p2</span>    <br><span>ggsave</span>(filename=<span>"Vlnplot2.pdf"</span>,plot=p2,width = 10,height = 7.5)<br><br><span>p3</span>=FeatureScatter(sce.<span>all</span>, <span>"nCount_RNA"</span>, <span>"nFeature_RNA"</span>, group.by = <span>"orig.ident"</span>, pt.size = 0.5)<br><span>ggsave</span>(filename=<span>"Scatterplot.pdf"</span>,plot=p3,width = 10,height = 7.5)<br><span>#根据上述指标，过滤低质量细胞/基因</span><br><span>#过滤指标1:最少表达基因数的细胞&amp;最少表达细胞数的基因</span><br><span>selected_c</span> &lt;- WhichCells(sce.<span>all</span>, expression = nFeature_RNA &gt; 300)<br><span>selected_f</span> &lt;- rownames(sce.<span>all</span>)[Matrix::rowSums(sce.<span>all</span>@assays$RNA@counts &gt; 0 ) &gt; 3]<br><br><span>sce</span>.<span>all</span>.filt &lt;- subset(sce.<span>all</span>, features = selected_f, cells = selected_c)<br><span>dim</span>(sce.<span>all</span>) <br><span>dim</span>(sce.<span>all</span>.filt) <br><span>#  可以看到，主要是过滤了基因，其次才是细胞</span><br><br><span>#过滤指标2:线粒体/核糖体基因比例(根据上面的violin图)</span><br><span>selected_mito</span> &lt;- WhichCells(sce.<span>all</span>.filt, expression = percent_mito &lt; 20)<br><span>selected_ribo</span> &lt;- WhichCells(sce.<span>all</span>.filt, expression = percent_ribo &gt; 3)<br><span>selected_hb</span> &lt;- WhichCells(sce.<span>all</span>.filt, expression = percent_hb &lt; 0.1)<br><span>length</span>(selected_hb)<br><span>length</span>(selected_ribo)<br><span>length</span>(selected_mito)<br><br><br><span>sce</span>.<span>all</span>.filt &lt;- subset(sce.<span>all</span>.filt, cells = selected_mito)<br><span>sce</span>.<span>all</span>.filt &lt;- subset(sce.<span>all</span>.filt, cells = selected_ribo)<br><span>sce</span>.<span>all</span>.filt &lt;- subset(sce.<span>all</span>.filt, cells = selected_hb)<br><span>dim</span>(sce.<span>all</span>.filt)<br><br><span>table</span>(sce.<span>all</span>.filt$orig.ident) <br><br><span>#可视化过滤后的情况</span><br><span>feats</span> &lt;- c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>)<br><span>p1_filtered</span>=VlnPlot(sce.<span>all</span>.filt, group.by = <span>"orig.ident"</span>, features = feats, pt.size = 0.1, ncol = 2) + <br>  <span>NoLegend</span>()<br><span>ggsave</span>(filename=<span>"Vlnplot1_filtered.pdf"</span>,plot=p1_filtered,width = 10,height = 7.5)<br><br><span>feats</span> &lt;- c(<span>"percent_mito"</span>, <span>"percent_ribo"</span>, <span>"percent_hb"</span>)<br><span>p2_filtered</span>=VlnPlot(sce.<span>all</span>.filt, group.by = <span>"orig.ident"</span>, features = feats, pt.size = 0.1, ncol = 3) + <br>  <span>NoLegend</span>()<br><span>ggsave</span>(filename=<span>"Vlnplot2_filtered.pdf"</span>,plot=p2_filtered,width = 10,height = 7.5)<br><br><span>#过滤指标3:过滤特定基因</span><br><span># Filter MALAT1 管家基因</span><br><span>sce</span>.<span>all</span>.filt &lt;- sce.<span>all</span>.filt[!grepl(<span>"MALAT1"</span>, rownames(sce.<span>all</span>.filt),ignore.case = T), ]<br><span># Filter Mitocondrial 线粒体基因</span><br><span>sce</span>.<span>all</span>.filt &lt;- sce.<span>all</span>.filt[!grepl(<span>"^MT-"</span>, rownames(sce.<span>all</span>.filt),ignore.case = T), ]<br><span># 当然，还可以过滤更多</span><br><br><span>dim</span>(sce.<span>all</span>.filt) <br><br><span>#细胞周期评分</span><br><span>sce</span>.<span>all</span>.filt = NormalizeData(sce.<span>all</span>.filt)<br><span>s</span>.genes=Seurat::cc.genes.updated.2019$s.genes<br><span>g2m</span>.genes=Seurat::cc.genes.updated.2019$g2m.genes<br><span>sce</span>.<span>all</span>.filt=CellCycleScoring(object = sce.<span>all</span>.filt, <br>                              <span>s</span>.features = s.genes, <br>                              <span>g2m</span>.features = g2m.genes, <br>                              <span>set</span>.ident = TRUE)<br><span>p4</span>=VlnPlot(sce.<span>all</span>.filt, features = c(<span>"S.Score"</span>, <span>"G2M.Score"</span>), group.by = <span>"orig.ident"</span>, <br>           <span>ncol</span> = 2, pt.size = 0.1)<br><span>ggsave</span>(filename=<span>"Vlnplot4_cycle.pdf"</span>,plot=p4,width = 10,height = 7.5)<br><br><span>sce</span>.<span>all</span>.filt@meta.data  %&gt;% ggplot(aes(S.Score,G2M.Score))+geom_point(aes(color=Phase))+<br>  <span>theme_minimal</span>()<br><span>ggsave</span>(filename=<span>"cycle_details.pdf"</span> )<br><span># S.Score较高的为S期，G2M.Score较高的为G2M期，都比较低的为G1期</span><br><br><span>dim</span>(sce.<span>all</span>) <br><br><span>saveRDS</span>(sce.<span>all</span>.filt, <span>"sce.all_qc.rds"</span>)<br><br><br><span>setwd</span>('../')<br></code></pre><figure><img data-ratio="0.3269230769230769" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodD8LGibQL5VCO3WYvbfnqHWs2veRXgaibh0EtuMshBQ5VrKw24oA2OzOKQ/640?wx_fmt=png" data-type="png" data-w="416" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodD8LGibQL5VCO3WYvbfnqHWs2veRXgaibh0EtuMshBQ5VrKw24oA2OzOKQ/640?wx_fmt=png"></figure>过滤最后剩下<br><figure><img data-ratio="0.21962616822429906" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDvrFl7nB1m98LxRybgOgE8eAxqoJLWOUSep4oXLJXCO1cFvnyfXuqwg/640?wx_fmt=png" data-type="png" data-w="428" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDvrFl7nB1m98LxRybgOgE8eAxqoJLWOUSep4oXLJXCO1cFvnyfXuqwg/640?wx_fmt=png"></figure><br><strong>2.聚类分群</strong><pre><code>rm(list=ls())<br>options(stringsAsFactors = F)<br>library(Seurat)<br>library(ggplot2)<br>library(clustree)<br>library(cowplot)<br>library(dplyr)<br>getwd()<br><br>dir.create(<span>"2-harmony"</span>)<br>getwd()<br>setwd(<span>"2-harmony"</span>)<br>sce=readRDS(<span>"../1-QC/sce.all_qc.rds"</span>)<br>sce<br><br>sce &lt;- FindVariableFeatures(sce)<br>sce &lt;- ScaleData(sce)<br>sce &lt;- RunPCA(sce, features = VariableFeatures(<span>object</span> = sce))<br><br>library(harmony)<br>table(sce$orig.ident)<br>seuratObj &lt;- RunHarmony(sce, <span>"orig.ident"</span>)<br>names(seuratObj@reductions)<br>seuratObj &lt;- RunUMAP(seuratObj,  dims = <span>1</span>:<span>15</span>, <br>                     reduction = <span>"harmony"</span>)<br>DimPlot(seuratObj,reduction = <span>"umap"</span>,label=T ) <br><br>sce=seuratObj<br>sce &lt;- FindNeighbors(sce, reduction = <span>"harmony"</span>,<br>                     dims = <span>1</span>:<span>15</span>) <br>sce.all=sce<br><span>#设置不同的分辨率，观察分群效果(选择哪一个？)</span><br><span>for</span> (<span>res <span>in</span> <span>c</span>(<span><span>0.01</span>, <span>0.05</span>, <span>0.1</span>, <span>0.2</span>, <span>0.3</span>, <span>0.5</span>,<span>0.8</span>,<span>1</span></span>)) </span>{<br>  sce.all=FindClusters(sce.all, <br>                       resolution = res, algorithm = <span>1</span>)<br>}<br>colnames(sce.all@meta.data)<br>apply(sce.all@meta.data[,grep(<span>"RNA_snn"</span>,colnames(sce.all@meta.data))],<span>2</span>,table)<br><br>p1_dim=plot_grid(ncol = <span>3</span>, DimPlot(sce.all, reduction = <span>"umap"</span>, <span>group</span>.<span>by</span> = <span>"RNA_snn_res.0.01"</span>) + <br>                   ggtitle(<span>"louvain_0.01"</span>), DimPlot(sce.all, reduction = <span>"umap"</span>, <span>group</span>.<span>by</span> = <span>"RNA_snn_res.0.1"</span>) + <br>                   ggtitle(<span>"louvain_0.1"</span>), DimPlot(sce.all, reduction = <span>"umap"</span>, <span>group</span>.<span>by</span> = <span>"RNA_snn_res.0.2"</span>) + <br>                   ggtitle(<span>"louvain_0.2"</span>))<br>ggsave(plot=p1_dim, filename=<span>"Dimplot_diff_resolution_low.pdf"</span>,width = <span>14</span>,height = <span>7</span>)<br><br>p1_dim=plot_grid(ncol = <span>3</span>, DimPlot(sce.all, reduction = <span>"umap"</span>, <span>group</span>.<span>by</span> = <span>"RNA_snn_res.0.8"</span>) + <br>                   ggtitle(<span>"louvain_0.8"</span>), DimPlot(sce.all, reduction = <span>"umap"</span>, <span>group</span>.<span>by</span> = <span>"RNA_snn_res.1"</span>) + <br>                   ggtitle(<span>"louvain_1"</span>), DimPlot(sce.all, reduction = <span>"umap"</span>, <span>group</span>.<span>by</span> = <span>"RNA_snn_res.0.3"</span>) + <br>                   ggtitle(<span>"louvain_0.3"</span>))<br>ggsave(plot=p1_dim, filename=<span>"Dimplot_diff_resolution_high.pdf"</span>,width = <span>18</span>,height = <span>7</span>)<br><br><br>p2_tree=clustree(sce.all@meta.data, prefix = <span>"RNA_snn_res."</span>)<br>ggsave(plot=p2_tree, filename=<span>"Tree_diff_resolution.pdf"</span>)<br><br><br><span>#接下来分析，按照分辨率为0.3进行 </span><br>sel.clust = <span>"RNA_snn_res.0.3"</span><br>sce.all &lt;- SetIdent(sce.all, <span>value</span> = sel.clust)<br>table(sce.all@active.ident) <br>saveRDS(sce.all, <span>"sce.all_int.rds"</span>)<br><br><br><span>#可视化细胞的上述比例情况</span><br>feats &lt;- c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>, <span>"percent_mito"</span>, <span>"percent_ribo"</span>, <span>"percent_hb"</span>)<br>feats &lt;- c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>)<br>p1=VlnPlot(sce.all, features = feats, pt.size = <span>0</span>, ncol = <span>2</span>) + <br>  NoLegend()<br><span>p1<br><span>library</span>(<span>ggplot2</span>) <br><span>ggsave</span>(<span>filename=<span>"Vlnplot1.pdf"</span>,plot=p1</span>)<br><br>feats &lt;- <span>c</span>(<span><span>"percent_mito"</span>, <span>"percent_ribo"</span>, <span>"percent_hb"</span></span>)<br>p2</span>=VlnPlot(sce.all,  features = feats, pt.size = <span>0</span>, ncol = <span>3</span>, same.y.lims=T) + <br>  scale_y_continuous(breaks=seq(<span>0</span>, <span>100</span>, <span>5</span>)) +<br>  NoLegend()<br><span>p2    <br><span>ggsave</span>(<span>filename=<span>"Vlnplot2.pdf"</span>,plot=p2</span>)<br><br>p3</span>=FeatureScatter(sce.all, <span>"nCount_RNA"</span>, <span>"nFeature_RNA"</span>, <br>                  pt.size = <span>0.5</span>)<br>ggsave(filename=<span>"Scatterplot.pdf"</span>,plot=p3)<br><br><span>###### step5:检查常见分群情况  ######</span><br>setwd(<span>'../'</span>)<br>dir.create(<span>"3-cell"</span>)<br>setwd(<span>"3-cell"</span>)  <br>sce.all$<span>patient<br><span>DimPlot</span>(<span>sce.all, reduction = <span>"umap"</span>, <span>group</span>.<span>by</span> = <span>"patient"</span>,label = T,raster=FALSE</span>) <br><span>ggsave</span>(<span><span>'umap_by_patient.pdf'</span>,width = <span>9</span>,height = <span>7</span></span>)<br><span>DimPlot</span>(<span>sce.all, reduction = <span>"umap"</span>, <span>group</span>.<span>by</span> = <span>"RNA_snn_res.0.3"</span>,label = T,raster=FALSE</span>) <br><span>ggsave</span>(<span><span>'umap_by_RNA_snn_res.0.3.pdf'</span>,width = <span>9</span>,height = <span>7</span></span>)<br><br><span>library</span>(<span>ggplot2</span>) <br>genes_to_check </span>= c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <span>'CD4'</span>,<span>'CD8A'</span>,<br>                   <span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span> ,<br>                   <span>'IGHG1'</span>, <span>'MZB1'</span>, <span>'SDC1'</span>,<br>                   <span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>, <br>                   <span>'TPSAB1'</span> , <span>'TPSB2'</span>,  <span># mast cells,</span><br>                   <span>'RCVRN'</span>,<span>'FPR1'</span> , <span>'ITGAM'</span> ,<br>                   <span>'C1QA'</span>,  <span>'C1QB'</span>,  <span># mac</span><br>                   <span>'S100A9'</span>, <span>'S100A8'</span>, <span>'MMP19'</span>,<span># monocyte</span><br>                   <span>'FCGR3A'</span>,<br>                   <span>'LAMP3'</span>, <span>'IDO1'</span>,<span>'IDO2'</span>,<span>## DC3 </span><br>                   <span>'CD1E'</span>,<span>'CD1C'</span>, <span># DC2</span><br>                   <span>'KLRB1'</span>,<span>'NCR1'</span>, <span># NK </span><br>                   <span>'FGF7'</span>,<span>'MME'</span>, <span>'ACTA2'</span>, <span>## fibo </span><br>                   <span>'DCN'</span>, <span>'LUM'</span>,  <span>'GSN'</span> , <span>## mouse PDAC fibo </span><br>                   <span>'MKI67'</span> , <span>'TOP2A'</span>, <br>                   <span>'PECAM1'</span>, <span>'VWF'</span>,  <span>## endo </span><br>                   <span>'EPCAM'</span> , <span>'KRT19'</span>, <span>'PROM1'</span>, <span>'ALDH1A1'</span> )<br>library(stringr)  <br>p_all_markers &lt;- DotPlot(sce.all, features = genes_to_check,<br>                         assay=<span>'RNA'</span>  )  + coord_flip()<br><br><span>p_all_markers<br><span>ggsave</span>(<span>plot=p_all_markers, filename=<span>"check_all_marker_by_seurat_cluster.pdf"</span>,<br>       width = <span>9</span>,height = <span>7</span></span>)<br><br><br>p_umap</span>=DimPlot(sce.all, reduction = <span>"umap"</span>,<br>               <span>group</span>.<span>by</span> = <span>"RNA_snn_res.0.3"</span>,label = T,raster=FALSE) <br>library(patchwork)<br>p_all_markers+<span>p_umap<br><span>ggsave</span>(<span><span>'markers_umap.pdf'</span>,width = <span>15</span>,height = <span>7</span></span>)<br><span>DimPlot</span>(<span>sce.all, reduction = <span>"umap"</span>,split.<span>by</span> = <span>'orig.ident'</span>,<br>        <span>group</span>.<span>by</span> = <span>"RNA_snn_res.0.3"</span>,label = T</span>) <br><span>ggsave</span>(<span><span>'orig.ident_umap.pdf'</span>,width = <span>45</span>,height = <span>7</span></span>)<br></span></code></pre><figure><img data-ratio="0.7685185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDibwYs0EhYxh9j5Iw9HPRGtGUUhPTyOn3icwf8PC63820KWZ779XrXicrw/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDibwYs0EhYxh9j5Iw9HPRGtGUUhPTyOn3icwf8PC63820KWZ779XrXicrw/640?wx_fmt=png"></figure><br><strong>3.注释细胞群</strong><br>主打清奇配色。<pre><code>rm(list=ls())<br>options(stringsAsFactors = F)<br>library(Seurat)<br>library(ggplot2)<br>library(clustree)<br>library(cowplot)<br>library(dplyr)<br>getwd()<br>setwd(<span>'3-cell/'</span>)<br>sce.all=readRDS( <span>"../2-harmony/sce.all_int.rds"</span>)<br>sce.all<br><br><span># 看图，定细胞亚群：</span><br>celltype=data.frame(ClusterID=<span>0</span><span>:</span><span>21</span>,<br>                    celltype= <span>0</span><span>:</span><span>21</span>) <br><span>#定义细胞亚群</span><br>celltype[celltype$ClusterID %<span>in</span>% c( <span>12</span>,<span>14</span>),<span>2</span>]=<span>'DC'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>,<span>1</span>,<span>3</span>,<span>20</span>,<span>5</span>,<span>6</span>,<span>7</span>),<span>2</span>]=<span>'Tcells'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>11</span> ),<span>2</span>]=<span>'plasma'</span><br>celltype[celltype$ClusterID %<span>in</span>% c(<span>2</span>,<span>17</span>,<span>18</span>,<span>19</span> ),<span>2</span>]=<span>'Bcells'</span> <br><br>celltype[celltype$ClusterID %<span>in</span>% c(<span>10</span>,<span>16</span> ),<span>2</span>]=<span>'cycling'</span>  <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>4</span> ),<span>2</span>]=<span>'mono1'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>9</span> ),<span>2</span>]=<span>'mono2'</span> <br><br>celltype[celltype$ClusterID %<span>in</span>% c( <span>8</span>,<span>15</span> ),<span>2</span>]=<span>'mac'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>13</span>,<span>21</span> ),<span>2</span>]=<span>'mast'</span> <br><br>head(celltype)<br>celltype<br>table(celltype$celltype)<br>sce.all@meta.data$celltype = <span>"NA"</span><br><span>for</span>(i <span>in</span> <span>1</span><span>:nrow</span>(celltype)){<br>  sce.all@meta.data[which(sce.all@meta.data$RNA_snn_res.<span>0</span>.<span>3</span> == celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]}<br>table(sce.all@meta.data$celltype)<br><br>mycolors &lt;-c(<span>'#E5D2DD'</span>, <span>'#53A85F'</span>, <span>'#F1BB72'</span>, <span>'#F3B1A0'</span>, <span>'#D6E7A3'</span>, <span>'#57C3F3'</span>,<br>                      <span>'#E95C59'</span>, <span>'#E59CC4'</span>, <span>'#AB3282'</span>,  <span>'#BD956A'</span>, <br>                      <span>'#9FA3A8'</span>, <span>'#E0D4CA'</span>,  <span>'#C5DEBA'</span>, <span>'#F7F398'</span>,<br>                      <span>'#C1E6F3'</span>, <span>'#6778AE'</span>, <span>'#91D0BE'</span>, <span>'#B53E2B'</span>,<br>                      <span>'#712820'</span>, <span>'#DCC1DD'</span>, <span>'#CCE0F5'</span>,  <span>'#CCC9E6'</span>, <span>'#625D9E'</span>, <span>'#68A180'</span>, <span>'#3A6963'</span>,<br>                      <span>'#968175'</span>)<br>col =c(<span>"#3176B7"</span>,<span>"#F78000"</span>,<span>"#3FA116"</span>,<span>"#CE2820"</span>,<span>"#9265C1"</span>,<br>                                      <span>"#885649"</span>,<span>"#DD76C5"</span>,<span>"#7F7F7F"</span>,<span>"#BBBE00"</span>,<span>"#41BED1"</span>)<br><br>library(patchwork)<br>p_all_markers=DotPlot(sce.all, features = genes_to_check,<br>                      assay=<span>'RNA'</span> ,group.by = <span>'celltype'</span> )  + coord_flip()+th<br>p_umap=DimPlot(sce.all, reduction = <span>"umap"</span>, group.by = <span>"celltype"</span>,label = T,<br>               label.box=T,raster=FALSE,cols = col)<br>p_all_markers+p_umap<br>ggsave(<span>'markers_umap_by_celltype.pdf'</span>,width = <span>14</span>,height = <span>8</span>)<br>p_harmony=DimPlot(sce.all, reduction = <span>"harmony"</span>, group.by = <span>"celltype"</span>,label = T,raster=FALSE)<br>p_all_markers+p_harmony<br>ggsave(<span>'markers_harmony_by_celltype.pdf'</span>,width = <span>12</span>,height = <span>8</span>)<br><br>sce.all=RunTSNE(sce.all,  dims = <span>1</span><span>:</span><span>15</span>, <br>                reduction = <span>"harmony"</span>)<br>p_tsne=DimPlot(sce.all, reduction = <span>"tsne"</span>, group.by = <span>"celltype"</span>,label = T,raster=FALSE,cols = col)<br>p_all_markers+p_tsne<br>ggsave(<span>'markers_tsne_by_celltype.pdf'</span>,width = <span>12</span>,height = <span>8</span>)<br><br>phe=sce.all@meta.data<br>save(phe,file = <span>'phe-by-markers.Rdata'</span>)<br><br><br>sce.all<br>table(Idents(sce.all))  <br>Idents(sce.all)=sce.all$celltype<br>table(Idents(sce.all))  <br>saveRDS(sce.all, <span>"sce.all_celltype.rds"</span>)<br></code></pre><figure><img data-ratio="0.5527777777777778" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDV8jj4Jp1dJG2uhlhdMDhTGUAmT7qGNN7yibg5EpGwIBRLAqkJM7hIcQ/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8u2t7zSibqia7le6IzXByodDV8jj4Jp1dJG2uhlhdMDhTGUAmT7qGNN7yibg5EpGwIBRLAqkJM7hIcQ/640?wx_fmt=png"></figure><figure>写在最后：其实图画多了之后，是有一种模糊又朦胧的感觉的，知道哪类数据用什么图形展示，看到某个图怎么能画出来。</figure></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/CsL2CGdydt6ecrkdhwt0Mw",target="_blank" rel="noopener noreferrer">原文链接</a>
