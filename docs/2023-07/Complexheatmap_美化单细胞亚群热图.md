---
title: "Complexheatmap 美化单细胞亚群热图"
date: 2023-07-30T15:48:13Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
Complexheatmap 美化单细胞亚群热图 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span>❝</span><p>这周继续figure美化系列, 一般来说单细胞里面的热图都直接用Doheatmap函数来进行可视化了，可以改动的地方有限，因此就想用Complexheatmap来DIY一下，Complexheatmap热图是一个很强大的R包，除了常规热图外，还可以做瀑布图，或者是拼图热图，很值得学习一下，我这里用的只是这个包很小部分的功能。</p><span>❞</span></blockquote><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br><br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><span>library</span>(ComplexHeatmap)<br><span>library</span>(RColorBrewer)<br><br>getwd()<br>dir.create(<span>"./3-cell"</span>)<br>setwd(<span>"./3-cell"</span>)  <br>load(<span>"sce.all_by_celltype.Rdata"</span>)<br><br>DimPlot(sce.all, reduction = <span>"umap"</span>, group.by = <span>"seurat_clusters"</span>,label = <span>T</span>) <br>table(sce.all$RNA_snn_res.0.8)<br>pumap&lt;-DimPlot(sce.all, reduction = <span>"umap"</span>, group.by = <span>"RNA_snn_res.0.5"</span><br>               ,label = <span>T</span>,label.box = <span>T</span>) <br>ggsave(<span>'umap_by_RNA_snn_res.0.5.pdf'</span>)<br><br>table(sce.all$celltype)<br>DimPlot(sce.all, reduction = <span>"umap"</span>, group.by = <span>"celltype"</span>,label = <span>T</span>)<br><br>sce.all<br>table(Idents(sce.all))  <br>Idents(sce.all)=sce.all$celltype<br>table(Idents(sce.all)) <br><br><span>#做COSG分析</span><br><span>#COSG</span><br>pro = <span>'cosg_celltype_'</span><br><span>library</span>(COSG)<br>marker_cosg &lt;- cosg(<br>  sce.all,<br>  groups=<span>'all'</span>,<br>  assay=<span>'RNA'</span>,<br>  slot=<span>'data'</span>,<br>  mu=<span>1</span>,<br>  n_genes_user=<span>100</span>)<br><br>save(marker_cosg,file = paste0(pro,<span>'_marker_cosg.Rdata'</span>))<br><br>sce = sce.all<br>table(sce$celltype)<br><br><span>library</span>(dplyr)  <br><br><span>## Top3 genes</span><br>top_3 &lt;- unique(as.character(apply(marker_cosg$names,<span>2</span>,head,<span>3</span>)))<br><span>#为了防止数据量太大不好出图，这里在每个亚群提取出来100个</span><br><span>#DoHeatmap可视化,如果觉得默认输出的颜色太丑了可以换颜色。</span><br>DoHeatmap(subset(sce,downsample=<span>100</span>),top_3,size=<span>3</span>)<span>#+</span><br> <span># scale_fill_gradientn(colors = c("white","grey","firebrick3"))</span><br>ggsave(filename=paste0(pro,<span>'DoHeatmap_check_top3_markers_by_clusters.pdf'</span>) ,<br>       width=<span>10</span>,height=<span>8</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7776606954689147" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8JFRtU51HX7BhuKgjOlBJfb56lXAsTNfRpCubhfrSQIynTokHpVOal3t5rHldthONaef1EHt9Bzw/640?wx_fmt=png" data-type="png" data-w="949" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8JFRtU51HX7BhuKgjOlBJfb56lXAsTNfRpCubhfrSQIynTokHpVOal3t5rHldthONaef1EHt9Bzw/640?wx_fmt=png"><figcaption>图1</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>DoHeatmap(subset(sce,downsample=<span>100</span>),top_3,size=<span>3</span>)+<br>scale_fill_gradientn(colors = c(<span>"#4DBBD5"</span>,<span>"white"</span>,<span>"#E64B35"</span>))<br>ggsave(filename=paste0(pro,<span>'DoHeatmap_check_top3_markers_by_clusters-2.pdf'</span>) ,<br>       width=<span>10</span>,height=<span>8</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7739221871713985" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8JFRtU51HX7BhuKgjOlBJfoWN8gCjICjNmFnic8Q6gSVU4FvHNa84oLVyRh7jQbrc4Rc3JGrDUTWQ/640?wx_fmt=png" data-type="png" data-w="951" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8JFRtU51HX7BhuKgjOlBJfoWN8gCjICjNmFnic8Q6gSVU4FvHNa84oLVyRh7jQbrc4Rc3JGrDUTWQ/640?wx_fmt=png"><figcaption>图2</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>Complexheatmap 美化<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#从单细胞矩阵中提取数据</span><br>sce.sub&lt;-subset(sce,downsample=<span>100</span>)<br><br>data &lt;- GetAssayData(sce.sub, slot = <span>"counts"</span>)<br>data &lt;- log2(data + <span>1</span>)<br><br>celltype_info &lt;- sort(sce.sub$celltype)<br>table(celltype_info)<br><br>celltype_info&lt;-factor(celltype_info,levels = c(<span>"T/NK"</span>,<span>"myeloid"</span>,<span>"Endo"</span>,<br>                                               <span>"Fibo"</span>,<span>"cycling"</span>,<span>"B cells"</span>,<span>"Hepatocyte"</span>,<span>"tumor"</span>))<br><br>mat &lt;- as.matrix(data[top_3, names(celltype_info)])<br><span>library</span>(circlize)<br><span>#可视化</span><br>Heatmap(mat,col = colorRamp2(c(<span>0</span>,<span>2</span>,<span>4</span>), c(<span>"#6395C7"</span>, <span>"white"</span>, <span>"#E06EAD"</span>)),<br>        name = <span>"Expression"</span>,<br>        column_split = celltype_info,<br>        cluster_rows = <span>FALSE</span>,<br>        cluster_columns = <span>FALSE</span>,<br>        show_column_names = <span>FALSE</span>,<br>        show_row_names = <span>TRUE</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6222005842259006" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8JFRtU51HX7BhuKgjOlBJfdXFhZRiaCIEFyMQDibLMUUn6jL9cyhLYaqXVu5AMFZGQqPKKIxxbhT2A/640?wx_fmt=png" data-type="png" data-w="1027" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8JFRtU51HX7BhuKgjOlBJfdXFhZRiaCIEFyMQDibLMUUn6jL9cyhLYaqXVu5AMFZGQqPKKIxxbhT2A/640?wx_fmt=png"><figcaption>图3</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>col &lt;- c(<span>"#D9AB42"</span>,<span>"#A35E47"</span>,<span>"#0F4C3A"</span>,<span>"#563F2E"</span>,<span>"#78C2C4"</span>,<span>"#C73E3A"</span>,<span>"#B47157"</span>,<span>"#2B5F75"</span>)<br>names(col) &lt;- levels(celltype_info)<br><br>top_anno &lt;- HeatmapAnnotation(<br>  cluster = anno_block(gp = gpar(fill = col), <span># 设置填充色</span><br>                       labels = levels(celltype_info),<br>                       labels_gp = gpar(cex = <span>0.5</span>, col = <span>"white"</span>))) <span># 设置字体</span><br><br><br>pdf(<span>'heatmap.pdf'</span>,width = <span>7</span>,height = <span>5</span>)<br>Heatmap(mat,name = <span>"Expression"</span>,<br>        row_order = <span>1</span>:nrow(mat),<br>        col = colorRamp2(c(<span>0</span>,<span>2</span>,<span>4</span>), c(<span>"#6395C7"</span>, <span>"white"</span>, <span>"#E06EAD"</span>)),<br>        cluster_rows = <span>FALSE</span>,<br>        cluster_columns = <span>FALSE</span>,<br>        show_column_names = <span>F</span>,<br>        <span>#show_row_names = FALSE,</span><br>        border = <span>T</span>,<br>        <span>#row_names_gp = gpar(fontface = 'italic',fontsize = 10),</span><br>        column_split = celltype_info,<br>        top_annotation = top_anno, <span># 在热图上边增加注释</span><br>        column_title = <span>NULL</span> <span># 不需要列标题</span><br>        ) <br>dev.off()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7129629629629629" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8JFRtU51HX7BhuKgjOlBJfEvn3mTxopRf0yfvUh2tBicjIQn3f1hCCgN6uNyA4glHq8cJuDD5nS3A/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8JFRtU51HX7BhuKgjOlBJfEvn3mTxopRf0yfvUh2tBicjIQn3f1hCCgN6uNyA4glHq8cJuDD5nS3A/640?wx_fmt=png"><figcaption>图4</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span>微信交流群</span><span></span></h3><p data-tool="mdnice编辑器">如果你也想参与到群里的讨论中，给我提出一些推文更新建议的话欢迎入群。同时你也可以得到我前期更新的所有数据及代码，在群里我会把代码分享给大家，而且大家可以在群里「提出自己感兴趣的单细胞文献」<strong>「我们尽可能优先选择大家的数据集去复现和实战，也欢迎大家在群里分享更多其它资料，咱们一起进步，」</strong>「比较高级的单细胞分析」**我们也会一起尝试， 相信你肯定是会不虚此行哈。</p><p data-tool="mdnice编辑器">附上之前推文的链接 <a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512238&amp;idx=1&amp;sn=e0c6dc2ea0e089aabb78133e50fb5d7f&amp;scene=21#wechat_redirect" data-linktype="2">为爱发电不可取（单细胞周更需要你的支持）</a></p><p data-tool="mdnice编辑器">我们这个群是真正的付费交流群，不仅提供数据，代码，学习资料，而且也会跟大家互动交流，还会坚持进行创作至少一年。</p><p data-tool="mdnice编辑器"><strong>「「目前群里已经有200多人，所以你想要进群的话就需要添加我的微信，私聊给我发99元的红包，我把你拉进群里。」」</strong></p><p data-tool="mdnice编辑器">是真正的付费交流群，因为提供数据，代码，学习资料，并且跟大家互动交流，而且会坚持进行创作至少一年。所以，如果介意99元的门槛且不认可我们知识分享的理念，<strong>「请不要加我好友」</strong>。。。</p><figure data-tool="mdnice编辑器"><img data-ratio="1.0161943319838056" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8JFRtU51HX7BhuKgjOlBJfgYc287nfWBs5FxCjvEbmmGbTV65kqs8P0KNFGc0rO45J0lqLjJRjMA/640?wx_fmt=png" data-type="png" data-w="247" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8JFRtU51HX7BhuKgjOlBJfgYc287nfWBs5FxCjvEbmmGbTV65kqs8P0KNFGc0rO45J0lqLjJRjMA/640?wx_fmt=png"><figcaption><br></figcaption></figure></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ct6hVAipoKhBOcbbme_CwA",target="_blank" rel="noopener noreferrer">原文链接</a>
