---
title: "一文搞定基本cellranger定量"
date: 2023-07-20T23:50:09Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
一文搞定基本cellranger定量 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span></span>引言</h1><p data-tool="mdnice编辑器">在上次推文中，我们正式开启了“初学者暑期搞定单细胞”这个专辑，并学习了如何下载单细胞测序上游fastq文件，这其中我们着重强调了scRNAseq测序原理的重要性，这会导致我们输入输出文件的不同，影响接下来的分析，这次我们就来系统地学习scRNAseq测序以及10X技术配套软件cellranger的使用。</p><blockquote data-tool="mdnice编辑器"><p>参考原推文：</p><ul><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484179&amp;idx=1&amp;sn=fe84f5243a6021fe6afea128e3ac273a&amp;chksm=ea1f0591dd688c8780d4e68a1d5838a5fca79b19f13587751112c57eae8d605d79680a787c00&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(二) cell ranger使用前注意事项</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484206&amp;idx=1&amp;sn=edeebbdd092f79361aee87e9ce086d80&amp;chksm=ea1f05acdd688cba4bb00b65e362db843f9867e40421bb334fc13be996c24afb2211a23adbb5&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(三) Cell Ranger使用初探</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484355&amp;idx=1&amp;sn=7860fe0c46073a55d2d3700822c3103b&amp;chksm=ea1f0541dd688c57245c175fb1869158993f83fcdd9693c5d6c98de890ff5c1969c355f5c330&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(四) Cell Ranger流程概览</a></section></li></ul></blockquote><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>scRNAseq测序技术基础知识：</h1><p data-tool="mdnice编辑器">测序流程：现在主流的主要<strong>10X Genomics Chromium</strong>（较多细胞），SAMRT-seq2（较多基因）和Fluidigm C1等。当然还有其他的如：CELL-seq、Drop-seq、mas-seq和Wafergen ICELL8等。</p><p data-tool="mdnice编辑器">最上游的实验阶段，我们简单地理解成两部分：单细胞分离和单细胞定量</p><ul data-tool="mdnice编辑器"><li><section><strong>单细胞分离</strong> （Isolation of Single Cells）</section></li></ul><p data-tool="mdnice编辑器">单细胞分离方法：包括有限稀释法（Limiting dilution technique）显微操作法（micromanipulation）、流式细胞分选(FACS)、激光捕获显微分离(LCM)、微孔（microwell）、微流控（microfluidics）和微滴（droplet）。</p><p data-tool="mdnice编辑器"><strong>微滴技术</strong> 是将<strong>单个细胞包裹在µl级别的液滴中，液滴被搭载到建库所用的酶上，每个微滴包含一个独特的条码(barcode)<strong>，</strong>由那个被包装好的细胞产生的所有reads都被贴上了该条码，也是为了之后对于不同细胞reads的分辨</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="0.5425925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKzM58t212NAwiaaUrWMDB4qqnlPUyicmEcbO5zHFmgiaF1zlBVKyvwlbHg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKzM58t212NAwiaaUrWMDB4qqnlPUyicmEcbO5zHFmgiaF1zlBVKyvwlbHg/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section><strong>单细胞定量</strong></section></li></ul><p data-tool="mdnice编辑器">包括两种类型：全长以及基于标签(tag)。前者对每个转录本都试图获得一致的read覆盖度，后者只捕获5‘或者3’端的RNA。定量方法的选择也影响了后续分析的方法选择。</p><p data-tool="mdnice编辑器">理论上，全长的方法应该得到转录本的平均覆盖度，但是实际上，覆盖度经常是有偏差的。<strong>基于标签的方法能够利用特异性分子标记(Unique Molecular Identifiers, UMIs)提高定量准确度</strong>，但是呢，这种限制了转录组一端的方法有降低了转录本的可拼接性，让以后的isoform识别变得困难。</p><hr data-tool="mdnice编辑器"><blockquote data-tool="mdnice编辑器"><p>单细胞转录组数据和普通的bulk转录组还是不太一样，bulk结果一般就是R1、R2，很容易区分；10X单细胞数据比较特殊，它的测序文库中包括index、barcode、UMI和测序reads。</p></blockquote><p data-tool="mdnice编辑器">详细看看10X技术：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.44907407407407407" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKAygXJwiaaaZGx1plYWyUzpPOlRpRTVCRBXJ9yLpw0NbS6Wx7iclxdbEw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKAygXJwiaaaZGx1plYWyUzpPOlRpRTVCRBXJ9yLpw0NbS6Wx7iclxdbEw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">可以发现和bulk测序中illumina双端很像，其实本质上是一样的，只不过其中一端（R1）变成了barcode+UMI</p><p data-tool="mdnice编辑器">我们获取scRNAseq的fastq文件至少是两个，除了barcode+UMI和reads外，有的还有index</p><blockquote data-tool="mdnice编辑器"><p>index和barcode有什么区别，为什么用两个fq文件进行区分？</p><p><strong>i7 sample index</strong>是加到Illumina测序接头上的，<strong>保证多个测序文库可以在同一个flow-cell上或者同一个lane上进行混合测序(multiplexed)。</strong>当然可以自己指定index，但更多情况下会使用10X公司提供的index序列(bundled index sets)，针对不同项目使用的index也是不同的。不过共性就是：96孔板的每个孔中都加入了4种不同的index oligos混合(详见：https://kb.10xgenomics.com/hc/en-us/articles/218168503-What-oligos-are-in-my-sample-index-)。</p><p>它的作用就是在CellRanger的 <code>mkfastq</code> 功能中体现出来的，它自动识别样本index名称（例如：SA-GA-A1），<strong>将具有相同4种oligo的fq文件组合在一起，表示同一个样本</strong></p></blockquote><p data-tool="mdnice编辑器">我们使用barcode来鉴别细胞，UMI来控制<strong>PCR偏差</strong>和鉴别基因（转录本）</p><p data-tool="mdnice编辑器">我根据我个人的理解，绘制了一个草图帮助理解”UMI来控制<strong>PCR偏差“</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="0.75" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPK94ibicFtdxJCgb1UHhJ5eGiax5SYxULQGUbq4F8FXx38BApcQK4sgodiaw/640?wx_fmt=jpeg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPK94ibicFtdxJCgb1UHhJ5eGiax5SYxULQGUbq4F8FXx38BApcQK4sgodiaw/640?wx_fmt=jpeg"></figure><p data-tool="mdnice编辑器">每个UMI对应一个mRNA，mRNA可以是不同\相同基因的、不同\相同转录本的，但都对应不同UMI（一个barcode上每种UMI都是唯一的）</p><h1 data-tool="mdnice编辑器"><span></span>cellranger基本流程：</h1><h4 data-tool="mdnice编辑器"><span></span>修改文件名称<span></span></h4><p data-tool="mdnice编辑器">在上一期 <a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247514120&amp;idx=1&amp;sn=c8892e9fcb5b3b07807a34ce9a69140a&amp;scene=21#wechat_redirect" data-linktype="2">今年暑假一起学单细胞吧（附上游数据下载tips）</a> 我们获得了sra通过--split-files得到的3个fq文件，其实这后面还需要修改一下名字</p><figure data-tool="mdnice编辑器"><img data-ratio="0.8556910569105691" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKHgoz6sRc6OPu4G2Lcn72OacQ1icwuNd0LgicJIYYgotlASkjFW2lJ2hw/640?wx_fmt=png" data-type="png" data-w="984" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKHgoz6sRc6OPu4G2Lcn72OacQ1icwuNd0LgicJIYYgotlASkjFW2lJ2hw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">R1就是barcode+UMI序列</p><figure data-tool="mdnice编辑器"><img data-ratio="1.4159592529711376" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKHASvOobD8Zpic2TIxLZhvX4iaiap3DaVsuJ28icccD96UGzTTFjBokzNNg/640?wx_fmt=png" data-type="png" data-w="589" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKHASvOobD8Zpic2TIxLZhvX4iaiap3DaVsuJ28icccD96UGzTTFjBokzNNg/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h4 data-tool="mdnice编辑器"><span></span>质控<span></span></h4><p data-tool="mdnice编辑器">使用原推文代码  <a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484206&amp;idx=1&amp;sn=edeebbdd092f79361aee87e9ce086d80&amp;chksm=ea1f05acdd688cba4bb00b65e362db843f9867e40421bb334fc13be996c24afb2211a23adbb5&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(三) Cell Ranger使用初探</a></p><pre data-tool="mdnice编辑器"><span></span><code><span># 以P2586-4为例</span><br>mkdir -p <span>$wkd</span>/qc<br><span>cd</span> <span>$wkd</span>/qc<br>find <span>$wkd</span>/raw/P2586-4 -name <span>'*R1*.gz'</span>&gt;P2586-4-id-1.txt<br>find <span>$wkd</span>/raw/P2586-4 -name <span>'*R2*.gz'</span>&gt;P2586-4-id-2.txt<br>cat P2586-4-id-1.txt P2586-4-id-2.txt &gt;P2586-4-id-all.txt<br><br>cat P2586-4-id-all.txt| xargs fastqc -t 20 -o ./<br></code></pre><p data-tool="mdnice编辑器">根据自己当前工作目录进行修改</p><p data-tool="mdnice编辑器">fastqc质控结果解读：</p><p data-tool="mdnice编辑器">https://www.bioinformatics.babraham.ac.uk/projects/fastqc/Help/3%20Analysis%20Modules/</p><h4 data-tool="mdnice编辑器"><span></span>背景补充<span></span></h4><p data-tool="mdnice编辑器">原推文<a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484206&amp;idx=1&amp;sn=edeebbdd092f79361aee87e9ce086d80&amp;chksm=ea1f05acdd688cba4bb00b65e362db843f9867e40421bb334fc13be996c24afb2211a23adbb5&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(三) Cell Ranger使用初探</a> 介绍了许多10X多种不同的测序情况，并且介绍了如何用cellranger来处理这些不同的情况</p><blockquote data-tool="mdnice编辑器"><p>主要根据sample、library、flowcell的数量来定义分析的复杂程度(由浅入深)</p></blockquote><p data-tool="mdnice编辑器">先学最简单的，一个sample 一个library 一个flowcell</p><figure data-tool="mdnice编辑器"><img data-ratio="0.4861111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKfJKaibZfCn86oo4iaz17UwKlIv9xItVsy4RXpts8IlHZibFuZZ2OKOjhA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKfJKaibZfCn86oo4iaz17UwKlIv9xItVsy4RXpts8IlHZibFuZZ2OKOjhA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">目前应该是最简单的，因为我看sample和lane都是唯一的，S1_L001</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6694444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKMiclZzJANAQ7mGibzfibuibS40EgurYVJhsFHvqH2WkqCGB4pcCY1IZZXw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKMiclZzJANAQ7mGibzfibuibS40EgurYVJhsFHvqH2WkqCGB4pcCY1IZZXw/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h4 data-tool="mdnice编辑器"><span></span>Cell Ranger的安装与配置<span></span></h4><p data-tool="mdnice编辑器"><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484206&amp;idx=1&amp;sn=edeebbdd092f79361aee87e9ce086d80&amp;chksm=ea1f05acdd688cba4bb00b65e362db843f9867e40421bb334fc13be996c24afb2211a23adbb5&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(三) Cell Ranger使用初探</a></p><p data-tool="mdnice编辑器">原推文的cellranger版本已经较老了，这里我去官网下载的最新版：</p><p data-tool="mdnice编辑器">https://support.10xgenomics.com/single-cell-gene-expression/software/downloads/latest?</p><figure data-tool="mdnice编辑器"><img data-ratio="0.4648148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKc16Tb2a3k8KCQ7xVHy42WPYRqZ0XicetgSBKYvosM4IBFAJxQjkFMicg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKc16Tb2a3k8KCQ7xVHy42WPYRqZ0XicetgSBKYvosM4IBFAJxQjkFMicg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">参考基因组：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.8628428927680798" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKhps6l8ade3NdrREGKVLxyibc5XTMg5VDzia9HDHmVpic9IsIVicYoqrXJw/640?wx_fmt=png" data-type="png" data-w="802" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKhps6l8ade3NdrREGKVLxyibc5XTMg5VDzia9HDHmVpic9IsIVicYoqrXJw/640?wx_fmt=png"></figure><h4 data-tool="mdnice编辑器"><span></span>cellranger定量<span></span></h4><p data-tool="mdnice编辑器"><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247484355&amp;idx=1&amp;sn=7860fe0c46073a55d2d3700822c3103b&amp;chksm=ea1f0541dd688c57245c175fb1869158993f83fcdd9693c5d6c98de890ff5c1969c355f5c330&amp;scene=21#wechat_redirect" data-linktype="2">单细胞实战(四) Cell Ranger流程概览</a></p><p data-tool="mdnice编辑器">在原推文中，介绍了一种cellranger <code>mkfastq</code>拆分BCLs（每个flowcell 的Illumina sequencer's base call files）数据得到fastq文件的方法</p><p data-tool="mdnice编辑器">我们这里直接使用前面sra拆分得到的fastq文件</p><p data-tool="mdnice编辑器">联系前面提到</p><blockquote data-tool="mdnice编辑器"><p>许多10X多种不同的测序情况，并且介绍了如何用cellranger来处理这些不同的情况</p><p>主要根据sample、library、flowcell的数量来定义分析的复杂程度(由浅入深)</p></blockquote><p data-tool="mdnice编辑器">原推文提到，这些不同情况也有不同的fq文件位置需要注意，这里我们就不深入探究了</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">我们这里主要使用最新版cellranger7.1.0软件对fq文件进行定量，同时与作者当时使用的v2版本输出文件结果进行比较</p><p data-tool="mdnice编辑器">原推文v2版本代码：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6388888888888888" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKsIT2Hg7lADV5PBKZuDRrGnZRRqCpr1MpCGtFHicK5YopbotObZianDrw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKsIT2Hg7lADV5PBKZuDRrGnZRRqCpr1MpCGtFHicK5YopbotObZianDrw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">我使用最新版定量代码：</p><pre data-tool="mdnice编辑器"><span></span><code>ref=../soft/refdata-gex-mm10-2020-A/<br>cellranger=../soft/cellranger-7.1.0/cellranger<br>ls ../raw/*gz|cut -d<span>"_"</span> -f 1 |sort -u|cut -d<span>"/"</span> -f 3 | cut -d <span>"_"</span> -f 1 | uniq | <span>while</span> <span>read</span> id;<span>do</span><br>nohup <span>$cellranger</span> count --id=<span>$id</span> \<br>--transcriptome=<span>$ref</span> \<br>--fastqs=../raw \<br>--sample=<span>$id</span> \<br>--nosecondary \<br>--localcores=4 \<br>--localmem=30 &amp;<br><span>done</span><br></code></pre><blockquote data-tool="mdnice编辑器"><p>使用资源限制：Cell Ranger默认在本地运行(或者使用 <code>--jobmode=local</code>指定)，它会占用90%的空余内存以及所有空余的CPU。如果要进行资源限制，可以使用 <code>—localmem</code>或者 <code>--localcores</code></p><p>如果使用的是共享服务器就需要注意这个问题</p></blockquote><p data-tool="mdnice编辑器">输出文件比较：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.7697495183044316" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKPvZNZjLjA0LCN3gEIZ9S6PaJthCJwoM4A3xYtskq3PcSahSWxCfUKQ/640?wx_fmt=png" data-type="png" data-w="1038" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKPvZNZjLjA0LCN3gEIZ9S6PaJthCJwoM4A3xYtskq3PcSahSWxCfUKQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">cellranger7.1.0输出文件目录：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6706989247311828" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKNtIwaPlzhd8KMg9vVCRqdFcZbqN6IiaQqI4OjrfrC2ic3L0ZVZjKVsXA/640?wx_fmt=png" data-type="png" data-w="744" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSAAZ2z5XIWNGxFHaFswMPKNtIwaPlzhd8KMg9vVCRqdFcZbqN6IiaQqI4OjrfrC2ic3L0ZVZjKVsXA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">可以发现默认输出文件格式基本一致</p><blockquote data-tool="mdnice编辑器"><p>从上到下依次来看：</p><ul><li><section>web_summary.html：官方说明 summary HTML file</section></li><li><section>metrics_summary.csv：CSV格式数据摘要</section></li><li><section>possorted_genome_bam.bam：比对文件</section></li><li><section>possorted_genome_bam.bam.bai：索引文件</section></li><li><section>filtered_gene_bc_matrices：<strong>是重要的一个目录</strong> ，下面又包含了 barcodes.tsv.gz、features.tsv.gz、matrix.mtx.gz，是<strong>下游Seurat、Scater、Monocle等分析的输入文件</strong></section></li><li><section>filtered_feature_bc_matrix.h5：过滤掉的barcode信息HDF5 format</section></li><li><section>raw_feature_bc_matrix：原始barcode信息</section></li><li><section>raw_feature_bc_matrix.h5：原始barcode信息HDF5 format</section></li><li><section>analysis：数据分析目录，下面又包含聚类clustering（有graph-based &amp; k-means）、差异分析diffexp、主成分线性降维分析pca、非线性降维tsne</section></li><li><section>molecule_info.h5：下面进行<strong>aggregate使用的文件</strong></section></li><li><section>cloupe.cloupe：官方可视化工具Loupe Cell Browser 输入文件</section></li></ul></blockquote><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">此外，原推文还提到了一些内置软件和算法、如何自主构建参考信息以及多个文库的整合 aggr</p><blockquote data-tool="mdnice编辑器"><p>很多时候，我们需要根据自己的需要，自定义一套参考信息</p></blockquote><blockquote data-tool="mdnice编辑器"><p>当处理多个生物学样本或者一个样本存在多个重复/文库时，最好的操作就是先分别对每个文库进行单独的count定量，然后将定量结果利用 <code>aggr</code>组合起来</p></blockquote></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/waGX23SEI08SIJuPSr1Cnw",target="_blank" rel="noopener noreferrer">原文链接</a>
