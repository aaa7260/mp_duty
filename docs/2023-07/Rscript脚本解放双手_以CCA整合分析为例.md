---
title: "Rscript脚本解放双手：以CCA整合分析为例"
date: 2023-07-07T08:53:06Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
Rscript脚本解放双手：以CCA整合分析为例 by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">随着我深入学习生信分析，我发现生信真的是学无止境：从R语言编程的学习，到常规统计和画图、芯片数据，NGS多组学上下游包括转录组、基因组、表观遗传和蛋白组学等，再到单细胞多组学和空间转录组，还有我从未涉猎的宏基因组和影像组学等等。</p><ul data-tool="mdnice编辑器"><li><section>从编程学习的角度来说，除了需要熟练掌握R语言以外，我发现还需要学习Linux操作和shell命令，如果需要分析单细胞/空转大数据的话，还需要学习Python。</section></li><li><section>从单细胞多组学和空转学习的角度来说，除了常规的标准分析性，我们还需要学习各种个性化分析（本质上是学习各种R包和Python包，包括拟时序、转录因子分析和inferCNV等等），这些分析的难易基本取决于前期R语言、Linux和Python的掌握情况，编程能力越强，这些个性化分析代码层面的理解越容易。特别是空转的学习，运行资源消耗大，需要掌握的Python包特别多。</section></li><li><section>从知识架构习的角度来说，除了上述代码编程层面的知识体系建立，还需要建立生物信息学领域的常规知识体系，例如测序，多组学，Bulk和单细胞测序等这些基本概念是什么及其原理。<strong>最重要的是第三层次的知识体系的学习，围绕本领域的背景知识和本领域关注的生物学问题。</strong>我深有体会的是，如果只掌握了前述2个层次的知识体系的话，对于我们做科学研究，仍然是不够的，可以说没有第三层次的内核作为支撑，大概率会被吐槽为“程序员”。此外，如果是从事干湿结合的话，有必要了解和学习各种湿实验及其大致原理和用途（可以回答哪些层面的科学问题？）。</section></li></ul><p data-tool="mdnice编辑器">坦率的说，我从2020年8月到现在2023年8月学习了3年的生信分析，我感觉我才刚刚入门生信这个领域。。。越学越发现自己的渺小。但是我也鼓励自己，同时我也想鼓励各位：生信的学习本身是一个学习曲线比较陡的学科，基础入门难，但是咬咬牙坚持下去，后续的问题基本都是举一反三的。就比如我现在在学习Python单细胞分析，R语言单细胞分析其实是我的一个舒适区，我是极不想去学习Python的单细胞分析体系，但我又深知Python的实用性和价值。所以这一年多，我几次学习Python，几次悻悻而归。最近因为分析需要，咬一咬牙坚持，突然发现Python也没有像20年那会学习R语言、生信和Linux的难（从0学起的难度，现在回想起来还是很痛苦）。总体来说，因为有前期的生信基础，Python的学习曲线的陡坡会比想象中的低很多。</p><p data-tool="mdnice编辑器">最后，我再分享最近的一个感悟（鸡汤）：生物信息学的学习是永无止境的，对于未来从事生信这行也包括从事湿实验这行的人来说（现在的湿实验基本离不开干实验分析），很可能是一辈子的学习，所以不要觉得目前自己能作出点啥东西就觉得满足了；同时，面对自己的无知，也不要恐慌和自责，毕竟闻道有先后，术业有专攻，哪里不会从哪里学起，一定要相信自己的学习能力。</p><p data-tool="mdnice编辑器">言归正传，以下是正文。</p><p data-tool="mdnice编辑器">本期帖子分享一个Linux服务器下Rscript传参脚本，用于单细胞批次的整合分析。其实熟悉我的朋友都知道，关于Linux服务器下的脚本，我已做了多次的分享，例如：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483696&amp;idx=1&amp;sn=521df829a697d50477e7b4ac840a8129&amp;scene=21#wechat_redirect" data-linktype="2">Linux随笔（一）入门篇</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483723&amp;idx=1&amp;sn=4716bcef0d1ebc0c6b7f1eb289b4754d&amp;scene=21#wechat_redirect" data-linktype="2">Linux随笔（二）“软件管家“ conda</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247486524&amp;idx=1&amp;sn=108e915d1f29afa746244307fcfe40a1&amp;scene=21#wechat_redirect" data-linktype="2">跟着Cell子刊学Shell脚本</a></section></li></ul><p data-tool="mdnice编辑器">举一反三，Shell脚本可以挂后台运行，R语言和Python的当然也是可以：</p><ul data-tool="mdnice编辑器"><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484778&amp;idx=1&amp;sn=45f99192489b835d895bd2bd4d93e774&amp;scene=21#wechat_redirect" data-linktype="2">巧用Python加速单细胞分析</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247485381&amp;idx=1&amp;sn=45b38e52652cf8d14afa87380bb762e3&amp;scene=21#wechat_redirect" data-linktype="2">批量使用基于Python的Scrublet工具去除双细胞（二）</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247485433&amp;idx=1&amp;sn=8414f226f68ad15f6e9e63f0420ff2e0&amp;scene=21#wechat_redirect" data-linktype="2">加速：Linux环境下基于Shell批量运行R语言脚本</a></p></section></li></ul><p data-tool="mdnice编辑器">在熟练掌握这些批处理脚本之后，有一个疑问随之而来：如何像Linux下运行那些软件一样，进行参数的传递？这里我以单细胞整合分析的CCA为例写了一个传参R语言脚本：</p><pre data-tool="mdnice编辑器"><span></span><code>cat &gt;Rscript_seurat_CCA.R<br></code></pre><p data-tool="mdnice编辑器">首先在Linux命令行下运行上述代码，即创建一个<strong>空白</strong>的<code>Rscript_seurat_CCA.R</code>脚本，然后复制粘贴下述代码：</p><pre data-tool="mdnice编辑器"><span></span><code><span>##### 参数接收</span><br><span>library</span>(argparse)<br>parser = ArgumentParser()<br>parser$add_argument(<span>"--seurat_dir"</span>, help=<span>"The Dir for input seurat file."</span>,required =<span>T</span>)<br>parser$add_argument(<span>"--sc_format"</span>, help=<span>"The format of input file"</span>,required =<span>T</span>,<br>                    choices = c(<span>'rds'</span>,<span>'qs'</span>,<span>"RDS"</span>),default = <span>"rds"</span>)<br>parser$add_argument(<span>"--normalize_method"</span>, <br>                    help=<span>"Using normalizeData by default. SCT is optional"</span>, <br>                    choices = c(<span>'SCT'</span>,<span>'Standard'</span>),default = <span>"Standard"</span>)<br>parser$add_argument(<span>"--cluster"</span>, choices = c(<span>"T"</span>,<span>"F"</span>),default = <span>"F"</span>,<br>                    help=<span>"Whether clustering needs to be performed? TRUE or FALSE"</span>)<br>parser$add_argument(<span>"--save_anchors"</span>, choices = c(<span>"T"</span>,<span>"F"</span>), default = <span>"F"</span>,<br>                    help=<span>"Whether save anchors? If save please provide path."</span>)<br>parser$add_argument(<span>"--outdir"</span>, help=<span>"Outdir"</span>,required =<span>T</span>)<br>parser$add_argument(<span>"--batchID"</span>, help=<span>"Batch ID"</span>,required =<span>T</span>)<br><br>args &lt;- parser$parse_args()<br>input.data = args$seurat_dir<br>sc_format = args$sc_format<br>save_anchors = args$save_anchors<br>cluster_perform = args$cluster<br>outdir = args$outdir<br>batchID = args$batchID<br>normalize_method = args$normalize_method <br><br><span>##### 默认参数的一些判断</span><br><span>if</span>(cluster_perform==<span>'F'</span>){<br>  cluster_perform = <span>FALSE</span><br>}<span>else</span> <span>if</span>(save_anchors==<span>'T'</span>){<br>  cluster_perform = <span>TRUE</span><br>}<br><br><span>if</span>(normalize_method==<span>'Standard'</span>){<br>  normalize_method = <span>"Standard"</span><br>  <span>warning</span>(<span>"Normalize method: Standard analysis by NormalizeData"</span>)<br>}<span>else</span> <span>if</span>(save_anchors==<span>'SCT'</span>){<br>  normalize_method = <span>"SCT"</span><br>  <span>warning</span>(<span>"Normalize method: SCT"</span>)<br>}<br><br><span>if</span>(save_anchors==<span>'F'</span>){<br>  save_anchors = <span>FALSE</span><br>}<span>else</span> <span>if</span>(save_anchors==<span>'T'</span>){<br>  save_anchors = <span>TRUE</span><br>}<br><br><span>if</span> (!dir.exists(outdir)) {<br>  dir.create(outdir, recursive = <span>TRUE</span>)<br>  print(paste(<span>"Folder"</span>, outdir, <span>"created."</span>))<br>}<br><br><span>######## Run CCA整合去批次</span><br><span>library</span>(Seurat)<br><span>library</span>(dplyr)<br><span>library</span>(patchwork)<br><span>library</span>(readr)<br><span>library</span>(ggplot2)<br><span>library</span>(RColorBrewer)<br><span>library</span>(future)<br><span>library</span>(cowplot)<br><span>library</span>(stringr)<br><span>library</span>(qs)<br><span># change the current plan to access parallelization</span><br>plan(<span>"multisession"</span>, workers = <span>2</span>)<br>plan()<br><span>#设置可用的内存</span><br>options(future.globals.maxSize = <span>10</span> * <span>1024</span>^<span>3</span>)<br><br><span>#### Step0. 加载数据集</span><br><span>if</span>(sc_format==<span>"rds"</span>|sc_format==<span>"RDS"</span>){<br>  seurat.data = read_rds(file = input.data)<br>}<span>else</span> <span>if</span> (sc_format==<span>"qs"</span>){<br>  seurat.data = qread(file = input.data)<br>} <span>else</span> {<br>  <span>stop</span>(<span>"For now, input data only support seurat object for RDS or qs files!"</span>)<br>}<br><br><span>if</span>(unique(table(seurat.data@meta.data[,batchID])&lt;<span>200</span>)[<span>1</span>]){<br>  <span>stop</span>(<span>"CCA requires a minimum of 200 cells in each batch for integration!"</span>)<br>}<br><br><span>#### Step1. split, anchors and Integrate</span><br>seurat_list &lt;- SplitObject(seurat.data, split.by = batchID)<br><br><span>if</span>(normalize_method==<span>"SCT"</span>){<br>  <span>##SCT</span><br>  seurat_list &lt;- lapply(X = seurat_list, FUN = SCTransform, method = <span>"glmGamPoi"</span>)<br>  <span># select features that are repeatedly variable across datasets for integration</span><br>  features &lt;- SelectIntegrationFeatures(object.list = seurat_list, nfeatures = <span>3000</span>)<br>  seurat_list &lt;- PrepSCTIntegration(object.list = seurat_list, anchor.features = features)<br>  <br>  seurat_anchors &lt;- FindIntegrationAnchors(object.list = seurat_list, normalization.method = <span>"SCT"</span>,<br>                                           anchor.features = features)<br>  <span>if</span>(save_anchors){<br>    saveRDS(seurat_anchors,file = paste0(outdir,<span>"/Step1.Seurat_anchors_CCA_SCT.rds"</span>))<br>  }<br>  <br>  <span># 利用anchors进行整合</span><br>  seurat_int &lt;- IntegrateData(anchorset = seurat_anchors, normalization.method = <span>"SCT"</span>)<br>  <br>}<span>else</span> <span>if</span>(normalize_method==<span>"Standard"</span>)<br>{<br>  <span># normalize and identify variable features for each dataset independently</span><br>  seurat_list &lt;- lapply(X = seurat_list, FUN = <span>function</span>(x) {<br>    x &lt;- NormalizeData(x)<br>    x &lt;- FindVariableFeatures(x, selection.method = <span>"vst"</span>, nfeatures = <span>2000</span>)<br>    <span>return</span>(x)<br>  })<br>  <span># select features that are repeatedly variable across datasets for integration</span><br>  features &lt;- SelectIntegrationFeatures(object.list = seurat_list)<br>  <br>  <span>#找到整合的锚点anchors</span><br>  seurat_anchors &lt;- FindIntegrationAnchors(object.list = seurat_list, <br>                                           anchor.features = features, dims = <span>1</span>:<span>30</span>)<br>  <br>  <span>if</span>(save_anchors){<br>    saveRDS(seurat_anchors,file = paste0(outdir,<span>"/Step1.Seurat_anchors_CCA_Standard.rds"</span>))<br>  }<br>  <br>  <span># 利用anchors进行整合</span><br>  seurat_int &lt;- IntegrateData(anchorset = seurat_anchors, dims = <span>1</span>:<span>30</span>)<br>  names(seurat_int@assays)<br>  seurat_int@active.assay<br>}<br><br><span>#### Step2. 是否选择继续降维聚类？</span><br><span>if</span>(cluster_perform){<br>  <span>#移除不用的对象</span><br>  rm(seurat_list)<br>  rm(seurat_anchors)<br>  <br>  <span>### 2.1. 降维聚类</span><br>  n.pcs = <span>30</span><br>  <br>  <span>if</span>(normalize_method==<span>"Standard"</span>){<br>    seurat_int &lt;- ScaleData(seurat_int, verbose = <span>FALSE</span>)<br>  }<br>  <br>  seurat_int &lt;- seurat_int %&gt;%<br>    RunPCA(npcs = n.pcs, verbose = <span>FALSE</span>) %&gt;% <br>    FindNeighbors(dims = <span>1</span>:n.pcs) %&gt;% <br>    RunUMAP(dims = <span>1</span>:n.pcs)<br>  <br>  <span>for</span> (res <span>in</span> c(<span>0.05</span>,<span>0.1</span>,<span>0.3</span>,<span>0.5</span>,<span>0.8</span>,<span>1</span>,<span>1.2</span>,<span>1.4</span>)){<br>    print(paste0(<span>"FindClusters resolution: "</span>,res))<br>    seurat_int &lt;- FindClusters(seurat_int,resolution = res, algorithm = <span>1</span>)<br>  }<br>  <br>  <span>#umap可视化</span><br>  cluster_umap &lt;- wrap_plots(ncol = <span>4</span>,<br>                             DimPlot(seurat_int, reduction = <span>"umap"</span>, group.by = <span>"integrated_snn_res.0.05"</span>, label = <span>T</span>) &amp; NoAxes(),  <br>                             DimPlot(seurat_int, reduction = <span>"umap"</span>, group.by = <span>"integrated_snn_res.0.1"</span>, label = <span>T</span>) &amp; NoAxes(),<br>                             DimPlot(seurat_int, reduction = <span>"umap"</span>, group.by = <span>"integrated_snn_res.0.3"</span>, label = <span>T</span>)&amp; NoAxes(),<br>                             DimPlot(seurat_int, reduction = <span>"umap"</span>, group.by = <span>"integrated_snn_res.0.5"</span>, label = <span>T</span>) &amp; NoAxes(),<br>                             DimPlot(seurat_int, reduction = <span>"umap"</span>, group.by = <span>"integrated_snn_res.0.8"</span>, label = <span>T</span>) &amp; NoAxes(), <br>                             DimPlot(seurat_int, reduction = <span>"umap"</span>, group.by = <span>"integrated_snn_res.1"</span>, label = <span>T</span>) &amp; NoAxes(),<br>                             DimPlot(seurat_int, reduction = <span>"umap"</span>, group.by = <span>"integrated_snn_res.1.2"</span>, label = <span>T</span>) &amp; NoAxes(),<br>                             DimPlot(seurat_int, reduction = <span>"umap"</span>, group.by = <span>"integrated_snn_res.1.4"</span>, label = <span>T</span>)&amp; NoAxes()<br>  )<br>  cluster_umap<br>  ggsave(cluster_umap,filename = paste0(outdir,<span>"/Step2.After_inter.cluster_UMAP_CCA.pdf"</span>),<br>         width = <span>20</span>, height = <span>14</span>)<br>}<br><br><span>#### Step3. save IntegrateData</span><br><span>if</span>(normalize_method==<span>"SCT"</span>){<br>  saveRDS(seurat_int,file = paste0(outdir,<span>"/Seurat_IntegrateData_SCT_Standard.rds"</span>))<br>}<span>else</span> <span>if</span>(normalize_method==<span>"Standard"</span>){<br>  saveRDS(seurat_int,file = paste0(outdir,<span>"/Seurat_IntegrateData_CCA_Standard.rds"</span>))<br>}<br></code></pre><p data-tool="mdnice编辑器">基于写好的<code>Rscript_seurat_CCA.R</code>脚本，然后写一个<code>Run_CCA.sh</code>脚本，批量运行：</p><p data-tool="mdnice编辑器">测试数据在：https://pan.baidu.com/s/1IPZ3G8Jle_UpV3S6ZRkS3Q?pwd=1234 提取码：1234</p><p data-tool="mdnice编辑器">参数的话，看看上面的help内容，我都标注了：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.45657894736842103" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqViaSNY6Mmvab4h7GicUqKgMezP2tvudIGHMsG643sRZ1Uks4SIX5Q10w7ZrN0leD8EqrTm93ErLSBg/640?wx_fmt=other" data-type="other" data-w="760" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqViaSNY6Mmvab4h7GicUqKgMezP2tvudIGHMsG643sRZ1Uks4SIX5Q10w7ZrN0leD8EqrTm93ErLSBg/640?wx_fmt=other"><figcaption>image-20230707160219201</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>cat &gt;Run_CCA.sh<br>Rscript Rscript_seurat_CCA.R --seurat_dir ./CCA_test.rds --sc_format RDS --normalize_method Standard --cluster T --save_anchors T --outdir ./  --batchID stim <br><br><span>## Run</span><br>nohup bash Run_CCA.sh 1&gt;Run_seurat.CCA.log 2&gt;&amp;1 &amp;<br></code></pre><p data-tool="mdnice编辑器">运行完毕之后，目标目录下会输出结果，可以用于后续的继续分析：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.2883817427385892" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqViaSNY6Mmvab4h7GicUqKgMe5icrHVYz0ic8aJxMLDMYZBIshZuRdMsnGvmeyibVe5yOz30vmXjSA0Iiaw/640?wx_fmt=other" data-type="other" data-w="482" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqViaSNY6Mmvab4h7GicUqKgMe5icrHVYz0ic8aJxMLDMYZBIshZuRdMsnGvmeyibVe5yOz30vmXjSA0Iiaw/640?wx_fmt=other"><figcaption>image-20230707152418218</figcaption></figure><p data-tool="mdnice编辑器"><strong>上述脚本旨在一个抛砖引玉的作用，具体一些细节用户可以自行修改。另外如果有发现任何错误，欢迎大家后台留言进行批评指正。</strong></p><p data-tool="mdnice编辑器">传参脚本基本上是一劳永逸的，对于运行大样本的单细胞数据分析大有裨益。其实举一反三，CCA的脚本可以这样写，RPCA、Harmony和其他整合方法都可以写成一个传参R脚本，包括：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484318&amp;idx=1&amp;sn=daf04a599413de0514afda07928eecb9&amp;scene=21#wechat_redirect" data-linktype="2">CCA单细胞多样本整合和插槽选择（一）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484384&amp;idx=1&amp;sn=e114a00e1594e8996bed895df64303a2&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之RPCA</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484506&amp;idx=1&amp;sn=98d7fe9265243c073a1444030fcd4a30&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之Harmony，LIGER和LISI</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247485666&amp;idx=1&amp;sn=ae0da39f47190da11c0d379c2b5bbefb&amp;scene=21#wechat_redirect" data-linktype="2">R版BBKNN整合去批次</a></section></li></ul><p data-tool="mdnice编辑器">也有用python做过BBKNN和harmony：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484778&amp;idx=1&amp;sn=45f99192489b835d895bd2bd4d93e774&amp;scene=21#wechat_redirect" data-linktype="2">巧用Python加速单细胞分析</a></section></li></ul><p data-tool="mdnice编辑器"><strong>另外注意，脚本的形式比较适合Linux服务器下运行。如果你所在的课题组没有服务器的话，我比较推荐两家租赁的云服务器：</strong></p><ul data-tool="mdnice编辑器"><li><section>生信技能树多人共享没有root权限，但是价格便宜：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247522831&amp;idx=2&amp;sn=1744efdf428465425a145ff3a982198b&amp;scene=21#wechat_redirect" data-linktype="2">144线程640Gb内存服务器共享一年仍然是仅需800</a></section></li><li><section>西柚云服务器支持独享，有root权限可以做很多不一样的探索：<a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247487192&amp;idx=1&amp;sn=256cbe466eadeee70301eb588b71aaa4&amp;chksm=c03890a9f74f19bfe60b828d7072fcd545a28896d910223d20adc09f32ad0b4f16d2620a90c6&amp;scene=21#wechat_redirect" data-linktype="2">独享服务器，满足你对生信分析的所有幻想</a></section></li><li><section><strong>我向西柚云拿到了200的无门槛现金优惠，新用户注册即可获取，注册链接：</strong>https://www.xiyoucloud.net/aff/GKRYOBCA</section></li></ul><p data-tool="mdnice编辑器"><strong>最后，由衷希望大家都能找到属于自己的前进方向！</strong></p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/l9mwAQB_4lDvMhdTlBodTQ",target="_blank" rel="noopener noreferrer">原文链接</a>
