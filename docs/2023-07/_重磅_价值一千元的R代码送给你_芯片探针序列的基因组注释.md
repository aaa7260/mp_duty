---
title: "（重磅！价值一千元的R代码送给你）芯片探针序列的基因组注释"
date: 2023-07-14T09:32:35Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
（重磅！价值一千元的R代码送给你）芯片探针序列的基因组注释 by 生信技能树
------
<div><section data-tools="新媒体管家" data-label="powered by xmt.cn"></section><blockquote><p>这是我第二次在标题上写重磅！价值一千元的代码，虽然下面的技能或者说代码对我来说是非常简单啦，但是在有需求的粉丝看来真正的价值不可估量。</p></blockquote><p>第一次是：<a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247487152&amp;idx=1&amp;sn=244a799c035fd081e01964f4c2d39bed&amp;chksm=9b484e0bac3fc71de3de79b4863ad5a118a1f735deac86e1b6b39627387016ccd2a6b07eef7e&amp;scene=21#wechat_redirect" target="_blank">TCGA的28篇教程-风险因子关联图-一个价值1000但是迟到的答案</a></p><p>纯粹的R代码技巧，怕粉丝看不懂，我已经花了一个星期做铺垫：</p><ul><li><p><span>1 <a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247488330&amp;idx=1&amp;sn=3443a44bfe3e3c2e5105221286f56886&amp;chksm=9b4853f1ac3fdae78ad68754558d08f943a5105822b6583a64df7972581fcec9b0b9faa4e4bc&amp;scene=21#wechat_redirect" target="_blank">把fasta序列读入到R里面去</a></span></p></li><li><p><span>2 <a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247488339&amp;idx=2&amp;sn=f02c9b9a0c5f995cbb8c2c09cdbbb4a6&amp;chksm=9b4853e8ac3fdafefbd3ead1411ba94bb0a96d91e828623cf1d40ff04baea0a9381a734f15ac&amp;scene=21#wechat_redirect" target="_blank">使用refGenome加上dplyr玩转gtf文件</a></span></p></li><li><p><span>3 <a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247488339&amp;idx=1&amp;sn=025a42c2ddfb9051022dc900e84fced4&amp;chksm=9b4853e8ac3fdafe5dd06c724e864096dc83ada8ef758dfae97191d71c5b7380071a726367db&amp;scene=21#wechat_redirect" target="_blank">把bam文件读入R，并且转为grange对象</a></span></p></li><li><p><span>4 <a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247488360&amp;idx=1&amp;sn=eb2a41d0470c6fa6c2b0d0d75d60b267&amp;chksm=9b4853d3ac3fdac58782330951e4e62fb11ff87d6b91e036a194ccdf1ed22bfcf889aac8f350&amp;scene=21#wechat_redirect" target="_blank">在R里面使用Rsubread完成组学分析全套流程</a></span></p></li><li><p><span>5 <a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247488366&amp;idx=2&amp;sn=9e8f7587421bc2e038a9078f0dd8a09c&amp;chksm=9b4853d5ac3fdac3c5f84596a79e8a0993fbd05b70f2575df39674c714ff8967e9dc51aa68c1&amp;scene=21#wechat_redirect" target="_blank">在R里面对坐标进行映射</a></span></p></li><li><p><span>6 <a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247488366&amp;idx=1&amp;sn=dd31ca199d9fe16c9d0c826ba5acf2aa&amp;chksm=9b4853d5ac3fdac364616659a1eb9b4912530356e46bf5ad177a818b6e8b11d6aac262750330&amp;scene=21#wechat_redirect" target="_blank">下载所有芯片探针序列并且写成fasta文件</a></span></p></li></ul><p>前面我提到过有些芯片，各种地方都是找不到其设计的探针对应的基因的，但是探针序列一般会给出，比如：</p><pre><code>Human LncRNA Expression <span>Array</span> V4<span>.0</span> <span>AS</span>-LNC-H-V4<span>.0</span> <span>20</span>,<span>730</span> mRNAs <span>and</span> <span>40</span>,<span>173</span> LncRNAs <span>8</span>*<span>60</span>K<br></code></pre><p>以前我会简单的回答，其实就是芯片探针的重新注释，重点是</p><ul><li><p><span>probe sequences 探针序列下载</span></p></li><li><p><span>uniquely mapped to the human genome (hg19) by Bowtie without mismatch. 参考基因组下载及比对</span></p></li><li><p><span>chromosomal position of lncRNA genes based on annotations from GENCODE (Release 23)坐标提取，最后使用bedtools进行坐标映射</span></p></li></ul><p>三部曲罢了，不过感觉会linux的朋友不多，我还是用R来一波这个操作。</p><h3><span>首先下载序列</span></h3><p>这里我选择在GEO官网的GPL平台下载 : https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GPL21827</p><pre><code>rm(list = ls())  <span>## 魔幻操作，一键清空~</span><br>options(stringsAsFactors = <span>F</span>)<br><span># 注意查看下载文件的大小，检查数据 </span><br>f=<span>'GPL21827_eSet.Rdata'</span><br><br><span>library</span>(GEOquery)<br><span># 这个包需要注意两个配置，一般来说自动化的配置是足够的。</span><br><span>#Setting options('download.file.method.GEOquery'='auto')</span><br><span>#Setting options('GEOquery.inmemory.gpl'=FALSE)</span><br><span>if</span>(!file.exists(f)){<br>  gset &lt;- getGEO(<span>'GPL21827'</span>, destdir=<span>"."</span> )       <span>## 平台文件</span><br>  save(gset,file=f)   <span>## 保存到本地</span><br>}<br>load(<span>'GPL21827_eSet.Rdata'</span>)  <span>## 载入数据</span><br>class(gset)<br>length(gset)<br>gset <br>colnames(Table(gset))<br>probe2symbol=Table(gset)[,c(<span>1</span>,<span>4</span>)]<br>all_recs=paste(apply(probe2symbol,<span>1</span>,<span>function</span>(x) paste0(<span>'&gt;'</span>,x[<span>1</span>],<span>'\n'</span>,x[<span>2</span>])),collapse = <span>'\n'</span>)<br>temp &lt;- tempfile()  <span>## 编程技巧，把变量写入临时文件~</span><br>write(all_recs, temp)<br></code></pre><p>这个技巧我在生信菜鸟团博客发布过：http://www.bio-info-trainee.com/3732.html 芯片概况如下：</p><figure><img data-ratio="0.6908045977011494" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wx9RI2ExBHeY8MLqyexrpZVdic1EfAd7VmyEhCv50L5NJOgSwCMpJICcCc2CZGYkICUQclrpe24pGg/640?wx_fmt=png" data-type="png" data-w="1740" title="" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wx9RI2ExBHeY8MLqyexrpZVdic1EfAd7VmyEhCv50L5NJOgSwCMpJICcCc2CZGYkICUQclrpe24pGg/640?wx_fmt=png"></figure><h3><span>然后对人类的参考基因组构建索引并且比对</span></h3><p>主要是参考基因组下载会耗费时间，还有构建索引耗时也很可观！</p><pre><code><span>library</span>(Rsubread)<br><span># 推荐从ENSEMBL上面下载成套的参考基因组fa及基因注释GTF文件</span><br>dir=<span>'~/data/project/qiang/release1/Genomes/'</span><br>ref &lt;- file.path(dir,<span>'Homo_sapiens.GRCh38.dna.toplevel.fa'</span>)<br>buildindex(basename=<span>"reference_index"</span>,reference=ref)<br><span>## 是单端数据，fa序列来源于上一个步骤输出的gpl的探针</span><br>reads &lt;- temp<br>align(index=<span>"reference_index"</span>,readfile1=reads,<br>      output_file=<span>"alignResults.BAM"</span>,phredOffset=<span>64</span>) <br>propmapped(<span>"alignResults.BAM"</span>)<br></code></pre><p>构建大约耗时一个小时，具体如下：</p><figure><img data-ratio="0.5080275229357798" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wx9RI2ExBHeY8MLqyexrpZV2dia1BtZtf3sicpiaBiaYtj46odQr5mpkxc9kUYWMcQ4CtXZUwpPm60iaeg/640?wx_fmt=png" data-type="png" data-w="1744" title="" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wx9RI2ExBHeY8MLqyexrpZV2dia1BtZtf3sicpiaBiaYtj46odQr5mpkxc9kUYWMcQ4CtXZUwpPm60iaeg/640?wx_fmt=png"></figure><p>比对速度很快，因为探针序列只有6万多，如下：</p><figure><img data-ratio="0.6828442437923251" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wx9RI2ExBHeY8MLqyexrpZV0FG8jcjXNmicD5kv3iao1xliaYtHIrHiaLA8DIQnAGnDrmo281NArmdKJw/640?wx_fmt=png" data-type="png" data-w="1772" title="" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wx9RI2ExBHeY8MLqyexrpZV0FG8jcjXNmicD5kv3iao1xliaYtHIrHiaLA8DIQnAGnDrmo281NArmdKJw/640?wx_fmt=png"></figure><p>在linux下得到比对后的bam文件也很简单的。</p><h3><span>读入人类基因组注释文件</span></h3><p>也是需要一点点R技巧，可以参考我在生信菜鸟团的博客：http://www.bio-info-trainee.com/3742.html 使用refGenome加上dplyr玩转gtf文件</p><pre><code><span>library</span>(Rsubread)<br><span># 推荐从ENSEMBL上面下载成套的参考基因组fa及基因注释GTF文件</span><br>dir=<span>'~/data/project/release1/Genomes/'</span><br>gtf &lt;- file.path(dir,<span>'Homo_sapiens.GRCh38.82.gtf'</span>)<br><span>if</span>(!<span>require</span>(refGenome)) install.packages(<span>"refGenome"</span>)<br><span># create ensemblGenome object for storing Ensembl genomic annotation data</span><br>ens &lt;- ensemblGenome()<br><span># read GTF file into ensemblGenome object</span><br>read.gtf(ens,useBasedir = <span>F</span>,gtf)<br><br>class(ens)  <br><span># counts all annotations on each seqname</span><br>tableSeqids(ens) <br><span># returns all annotations on mitochondria</span><br>extractSeqids(ens, <span>'MT'</span>)<br><span># summarise features in GTF file</span><br>tableFeatures(ens)<br><span># create table of genes</span><br>my_gene &lt;- getGenePositions(ens)<br>dim(my_gene)<br><br><span># length of genes</span><br>gt=my_gene<br>my_gene_length &lt;- gt$end - gt$start<br>my_density &lt;- density(my_gene_length)<br>plot(my_density, main = <span>'Distribution of gene lengths'</span>)<br><span>## 重点是要成为对象</span><br><span>library</span>(GenomicRanges)<br>my_gr &lt;- with(my_gene, GRanges(seqid, IRanges(start, end), <br>                               strand, id = gene_id))<br></code></pre><p>如果是linux的shell脚本，一句话就可以搞定其实。</p><h3><span>坐标映射</span></h3><p>把自己制作好的bam文件的坐标，跟提取自gtf文件的坐标信息对应起来，使用<code>GenomicRanges</code>包自带的函数即可。</p><p>值得注意的是把bam文件读入R，并且转为grange对象需要一点点技巧，我在生信菜鸟团博客写过：http://www.bio-info-trainee.com/3740.html</p><pre><code><span>library</span>(Rsamtools)<br>bamFile=<span>"alignResults.BAM"</span><br>quickBamFlagSummary(bamFile)<br><span># https://kasperdanielhansen.github.io/genbioconductor/html/Rsamtools.html</span><br>bam &lt;- scanBam(bamFile)<br>bam<br>names(bam[[<span>1</span>]])<br>tmp=as.data.frame(do.call(cbind,lapply(bam[[<span>1</span>]], as.character)))<br>tmp=tmp[tmp$flag!=<span>4</span>,] <span># 60885 probes</span><br><span>#  intersect() on two GRanges objects.</span><br><span>library</span>(GenomicRanges)<br>my_seq &lt;- with(tmp, GRanges(as.character(rname), <br>                                 IRanges(as.numeric(pos)-<span>60</span>, as.numeric(pos)+<span>60</span>), <br>                                 as.character(strand), <br>                                 id = as.character(qname)))<br>gr3 = intersect(my_seq,my_gr)<br>gr3<br>o = findOverlaps(my_seq,my_gr)<br>o<br>lo=cbind(as.data.frame(my_seq[queryHits(o)]),<br>         as.data.frame(my_gr[subjectHits(o)]))<br>head(lo)<br>write.table(lo,file = <span>'GPL21827_probe2ensemb.csv'</span>,row.names = <span>F</span>,sep = <span>','</span>)<br></code></pre><p>当然，坐标映射本身也是满满的R技巧啦。</p><section data-style-type="5" data-tools="新媒体排版" data-id="1376000"><section powered-by="xiumi.us"><section><section><section data-style-type="5" data-tools="新媒体排版" data-id="1408312"><p><strong><span><strong><span><span>■</span><span>   <span>■</span>   ■</span></span></strong></span></strong></p></section></section></section></section></section><section data-style-type="5" data-tools="新媒体排版" data-id="1376000"><section powered-by="xiumi.us"><section><section><section powered-by="xiumi.us"><section><section><p><span>生信基础知识大全系列：</span><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247485662&amp;idx=1&amp;sn=e1b55e5bea539daed3e003b4f0d7e971&amp;scene=21#wechat_redirect" target="_blank"><span>生信基础知识100讲</span></a><span>   </span></p><p><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486815&amp;idx=1&amp;sn=a71663abc269df5da16256c9469b3d44&amp;chksm=9b484de4ac3fc4f2d69f82c85457895fe72ebb01e4b1c6bca2075d4504ebd2ef6bd9442de3f3&amp;scene=21#wechat_redirect" target="_blank"><span>史上最强的生信自学环境准备课来啦！！</span></a><span><span> 7次改版，11节课程，14K的讲稿，30个夜晚打磨，100页PPT的课程。</span><span>   </span></span></p><p><span>如果需要组装自己的服务器；</span><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247487052&amp;idx=1&amp;sn=9b577069df20032d9cd1d8665c1efcfd&amp;chksm=9b484ef7ac3fc7e1468b54905098a7d7fec17184599663c7090cfe57f94a35cc9dd417cba1a3&amp;scene=21#wechat_redirect" target="_blank"><span>代办生物信息学服务器</span></a></p><p><span>如果需要帮忙下载海外数据(GEO/TCGA/GTEx等等)，</span><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247487025&amp;idx=1&amp;sn=18fdfdaddfa9226f0b6107986cec9043&amp;chksm=9b484e8aac3fc79cf1616837a4f5a91efb16559434a3c93fabdecb59da53a97e4a1ab9c6e778&amp;scene=21#wechat_redirect" target="_blank"><span>点我？</span></a></p><p><strong><span>如果需要线下辅导及培训，看</span></strong><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247487460&amp;idx=1&amp;sn=33cf308c824d369d4c111a96ab9fafb8&amp;chksm=9b484f5fac3fc649dc9e01399cc105fdab3f208dd088d5dce02c757ad4257e05b4217bf17b1c&amp;scene=21#wechat_redirect" target="_blank"><strong>招学徒</strong></a><strong><span> </span></strong></p><p><span>如果需要个人电脑：</span><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247487098&amp;idx=1&amp;sn=0e28a20911f5a76446bb0363c9bc9d84&amp;chksm=9b484ec1ac3fc7d70ff3e6e0a2589b29e7aa766e0fc0fd9ef106af7ae821e9ca288d316cdd23&amp;scene=21#wechat_redirect" target="_blank"><span>个人计算机推荐</span></a></p><p><span>如果需要置办生物信息学书籍，看：</span><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247487434&amp;idx=1&amp;sn=ce51f8950ca3f463138419c0cba06abe&amp;chksm=9b484f71ac3fc66772def7f28603b5edfb1f379254099d5cc9c91b113f272d140daf8d85c42b&amp;scene=21#wechat_redirect" target="_blank"><span>生信人必备书单</span></a></p><p><span>如果需要实习岗位：</span><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247487646&amp;idx=1&amp;sn=5b2af700abdad7d702f1f33c6023ed45&amp;chksm=9b485025ac3fd933b43a9a7aaf05d71ae926dce4a8dda22c22c93dd4211344cbceca23d09bee&amp;scene=21#wechat_redirect" target="_blank"><span>实习职位发布</span></a></p><p><span>如果需要售后：</span><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247487213&amp;idx=1&amp;sn=8154b0dddba81c493a649e21a9744fd0&amp;chksm=9b484e56ac3fc740bfe3b5aef3177fa11e312bd1b12624c3970c6d6a78252afff0b1f9d2bc87&amp;scene=21#wechat_redirect" target="_blank"><span>点我</span></a></p><p><span>如果需要入门资料大全：</span><span><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247487685&amp;idx=1&amp;sn=f357d26efdc9b394dc6c449272d5a50f&amp;chksm=9b48507eac3fd968bfacd5f27527687eb23158d9f2ba65744ea3cfe87bc7f3504edf6edc2198&amp;scene=21#wechat_redirect" target="_blank">点我</a></span></p></section></section></section></section></section></section></section><p><span>点击下面的阅读原文直达</span></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/mrtjpN8yDKUdCSvSUuUwcA",target="_blank" rel="noopener noreferrer">原文链接</a>
