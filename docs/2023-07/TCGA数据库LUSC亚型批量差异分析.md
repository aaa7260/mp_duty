---
title: "TCGA数据库LUSC亚型批量差异分析"
date: 2023-07-13T09:39:18Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
TCGA数据库LUSC亚型批量差异分析 by 生信技能树
------
<div><section data-tools="新媒体管家" data-label="powered by xmt.cn"><br></section><section data-role="outer" label="Powered by 135editor.com"><section><section data-tools="135编辑器" data-id="95222"><section><section><section><br></section><section><br></section></section><section><p><span>前些天我布置了一个学徒作业：</span><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492967&amp;idx=2&amp;sn=eaa3bfa73f6c5899f062eb9e97532893&amp;scene=21#wechat_redirect" data-linktype="2">这一个图背后是12个差异分析的综合</a></p><p><span>作业参考的文献：Integrated analysis reveals five potential ceRNA biomarkers in human </span><span><strong>lung adenocarcinoma</strong></span></p><p><span>所以我设置的学徒作业是：下载TCGA数据库中LUSC的转录组信号值矩阵，LUSC病人分成了4类T1-4亚型分别与Normal组做差异分析，就是3*4=12个表达矩阵，12次差异分析，画PCA图，热图，火山图，以及用于差异分析结果比较的Venn图。</span></p><p><span>下面让我们一起看看一个优秀学徒的表演，该学徒很久以前在我们这里分享过他跨专业进入生信学习圈子的感悟：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492850&amp;idx=1&amp;sn=8326ade733fa4140a676edacb8bb35a0&amp;chksm=9b4ba449ac3c2d5f04ca990ca19d31b53b9327e673eb7e706cded6cf932c5abe56b092daf5c1&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2">在华大工作五年还不如生信技能树3天？</a></span></p></section><section><section><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/7QRTvkK2qC60S9ic5EibVVeaAh4u6qKcUgLHfWxKpweayAic8F5ibSk0LgKeibicMG3BznVzYfILEIA1H8DEE9iawibjibA/640?wx_fmt=gif" data-type="gif" data-w="30" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/7QRTvkK2qC60S9ic5EibVVeaAh4u6qKcUgLHfWxKpweayAic8F5ibSk0LgKeibicMG3BznVzYfILEIA1H8DEE9iawibjibA/640?wx_fmt=gif"></section><section><br></section></section></section></section><section data-tools="135编辑器" data-id="96383"><section data-width="100%"><section><img data-ratio="0.8333333333333334" data-src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W1z3HOrQNibrLTDwsZM7jZb2PHLibkYyCqepB8wd3JuRhbKHSLnVzOUZw/640?wx_fmt=png" data-type="png" data-w="48" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W1z3HOrQNibrLTDwsZM7jZb2PHLibkYyCqepB8wd3JuRhbKHSLnVzOUZw/640?wx_fmt=png"></section><section data-brushtype="text"><strong><span>下载数据</span></strong></section><section><img data-ratio="0.17796610169491525" data-src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0WerzjGbWVEKcHEQeHjIWxYib9DCZXd9dYaaY3ibaaSsHv1HAicBUKoYbwg/640?wx_fmt=png" data-type="png" data-w="118" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0WerzjGbWVEKcHEQeHjIWxYib9DCZXd9dYaaY3ibaaSsHv1HAicBUKoYbwg/640?wx_fmt=png"></section><section><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W7aKX5XdKVAkBfgIQ0bDq5ZuEJGQMLLiaBKDULFmYicy6r48czIWb1OwA/640?wx_fmt=png" data-type="png" data-w="21" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W7aKX5XdKVAkBfgIQ0bDq5ZuEJGQMLLiaBKDULFmYicy6r48czIWb1OwA/640?wx_fmt=png"></section></section></section><p><br></p><p><span>紧跟群主的TCGA视频课程，从UCSC的XENA下载LUSC表达矩阵，临床信息，探针注释GMT文件！</span></p><p><span>视频课程见：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492960&amp;idx=1&amp;sn=cc82b6d235511e04ca2a7d64bd708c94&amp;chksm=9b4ba5dbac3c2ccdee8d80918456c798f3726ed14e9c99b33044f5a5b9f583585a8434382e2d&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">4个小时TCGA肿瘤数据库知识图谱视频教程又有学习笔记啦</a></span></p><p><br></p><pre><code>rm(list = ls())<br>pd=read.table("TCGA-LUSC.GDC_phenotype.tsv.gz",header=T,sep = "\t", quote = "\"",dec = ".", fill = TRUE, comment.char = <span>""</span>,row.names = <span>1</span>)<br>gset_mRNA=read.table(<span>"TCGA-LUSC.htseq_counts.tsv.gz"</span>,header=T,sep = <span>"\t"</span>, quote = <span>"\""</span>,<span>dec</span> = <span>"."</span>, fill = <span>TRUE</span>, comment.char = <span>""</span>,row.names = <span>1</span>)<br>gset_miRNA=read.table(<span>"TCGA-LUSC.mirna.tsv.gz"</span>,header=T,sep = <span>"\t"</span>,row.names = <span>1</span>)<br><br><span>#由于导入数据列名自动把“-”变为了“.”,可用gsub替换回来。</span><br><br>colnames(gset_miRNA)=gsub(<span>"\\."</span>,<span>"-"</span>, colnames(gset_miRNA))<br>colnames(gset_mRNA)=gsub(<span>"\\."</span>,<span>"-"</span>, colnames(gset_mRNA))<br><br><span># 去掉mRNA和miRNA表达矩阵不一致的样本</span><br><br><span>table</span>(colnames(gset_mRNA) %<span>in</span>% colnames(gset_miRNA))<br>gset_mRNA=gset_mRNA[,colnames(gset_mRNA) %<span>in</span>% colnames(gset_miRNA)]<br>gset_miRNA=gset_miRNA[,colnames(gset_miRNA) %<span>in</span>% colnames(gset_mRNA)]<br><br><span>table</span>(<span>substring</span>(colnames(gset_mRNA),<span>14</span>,<span>16</span>))<br><span>table</span>(pd$pathologic_T)  <br><br><span># TCGA数据库的样本分组规律（感谢Jimmy大神提供）：Tumor types range from 01 - 09, normal types from 10 - 19 and control samples from 20 - 29.</span><br><br><span># 分期里T1分为了T1a,T1b,T1;T2分为了T2a,T2b,T2;这里就不细分了，分别合在一起组成T1和T2期亚群</span><br><br>group_list_mRNA=ifelse(<span>substring</span>(colnames(gset_mRNA),<span>14</span>,<span>15</span>) == <span>"11"</span>,<span>"Normal"</span>,ifelse(colnames(gset_mRNA) %<span>in</span>% rownames(pd[<span>substring</span>(pd[,<span>"pathologic_T"</span>],<span>1</span>,<span>2</span>) == <span>"T1"</span>,]),<span>"T1"</span>,ifelse(colnames(gset_mRNA) %<span>in</span>% rownames(pd[<span>substring</span>(pd[,<span>"pathologic_T"</span>],<span>1</span>,<span>2</span>) == <span>"T1"</span>,]),<span>"T1"</span>,ifelse(colnames(gset_mRNA) %<span>in</span>% rownames(pd[<span>substring</span>(pd[,<span>"pathologic_T"</span>],<span>1</span>,<span>2</span>) == <span>"T2"</span>,]),<span>"T2"</span>,ifelse(colnames(gset_mRNA) %<span>in</span>% rownames(pd[<span>substring</span>(pd[,<span>"pathologic_T"</span>],<span>1</span>,<span>2</span>) == <span>"T3"</span>,]),<span>"T3"</span>,ifelse(colnames(gset_mRNA) %<span>in</span>% rownames(pd[<span>substring</span>(pd[,<span>"pathologic_T"</span>],<span>1</span>,<span>2</span>) == <span>"T4"</span>,]),<span>"T4"</span>,<span>"q"</span>))))))<br>group_list_miRNA=ifelse(<span>substring</span>(colnames(gset_miRNA),<span>14</span>,<span>15</span>) == <span>"11"</span>,<span>"Normal"</span>,ifelse(colnames(gset_miRNA) %<span>in</span>% rownames(pd[<span>substring</span>(pd[,<span>"pathologic_T"</span>],<span>1</span>,<span>2</span>) == <span>"T1"</span>,]),<span>"T1"</span>,ifelse(colnames(gset_miRNA) %<span>in</span>% rownames(pd[<span>substring</span>(pd[,<span>"pathologic_T"</span>],<span>1</span>,<span>2</span>) == <span>"T1"</span>,]),<span>"T1"</span>,ifelse(colnames(gset_miRNA) %<span>in</span>% rownames(pd[<span>substring</span>(pd[,<span>"pathologic_T"</span>],<span>1</span>,<span>2</span>) == <span>"T2"</span>,]),<span>"T2"</span>,ifelse(colnames(gset_miRNA) %<span>in</span>% rownames(pd[<span>substring</span>(pd[,<span>"pathologic_T"</span>],<span>1</span>,<span>2</span>) == <span>"T3"</span>,]),<span>"T3"</span>,ifelse(colnames(gset_miRNA) %<span>in</span>% rownames(pd[<span>substring</span>(pd[,<span>"pathologic_T"</span>],<span>1</span>,<span>2</span>) == <span>"T4"</span>,]),<span>"T4"</span>,<span>"q"</span>))))))<br><br><br><span>table</span>(group_list_mRNA)                                 <br><span>table</span>(group_list_miRNA) <br><br><span># 查下TCGA官网数据的说明，mRNA表达矩阵取了log2(fpkm+1)，miRNA表达矩阵取了log2(RPM+1),所以这里要还原回去</span><br><br><span>head</span>(gset_miRNA)<br><span>head</span>(gset_mRNA)<br>gset_miRNA=(<span>2</span>^gset_miRNA <span>-1</span>)*<span>1000</span>  <span>#差异分析用的RPKM，所以要乘以1000</span><br>gset_mRNA=<span>2</span>^gset_mRNA <span>-1</span><br><br><span># mRNA表达矩阵包括codingRNA和lncRNA,需要拆分下</span><br><br><span>library</span>(rtracklayer)<br><span>library</span>(SummarizedExperiment)<br>gtf1 &lt;- rtracklayer::<span>import</span>(<span>'gencode.v22.annotation.gtf/gencode.v22.annotation.gtf'</span>)<br>gtf_df &lt;- as.data.frame(gtf1)<br><span>head</span>(gtf_df)<br>ensem2symbol &lt;- gtf_df[gtf_df$<span>type</span> == <span>'gene'</span>,c(<span>'gene_id'</span>, <span>'gene_type'</span>, <span>'gene_name'</span>, <span>'source'</span>)]<br>rownames(ensem2symbol) &lt;- ensem2symbol$gene_id<br><span>head</span>(<span>sort</span>(<span>table</span>(ensem2symbol$gene_type),decreasing = T))<br><br>gset_cdRNA=gset_mRNA[rownames(gset_mRNA) %<span>in</span>% rownames(ensem2symbol[ensem2symbol$gene_type == <span>"protein_coding"</span>,]),]<br>gset_lncRNA=gset_mRNA[rownames(gset_mRNA) %<span>in</span>% rownames(ensem2symbol[ensem2symbol$gene_type == <span>"lincRNA"</span>,]),]<br><br><br><span>#保存表达矩阵和分组信息</span><br><span>save</span>(pd,ensem2symbol,gset_miRNA,gset_cdRNA,gset_lncRNA,group_list_mRNA,group_list_miRNA,<span>file</span> = <span>"step1_output.Rdata"</span>)<br></code></pre><ul><li><p><span>gsub批量整体替换字符很方便</span></p></li><li><p><span>ifelse函数筛选T1-T4的样本ID，得到表达矩阵及分组信息</span></p></li><li><p><span>用基因探针GMT文件注释拆分mRNA表达矩阵成cdRNA(编码蛋白的基因)和lncRNA表达矩阵</span></p></li><li><p><span>注意TCGA上对表达矩阵的格式说明，DESeq2差异分析是对count值表达矩阵，必要需要还原！</span></p></li></ul><section data-tools="135编辑器" data-id="96383"><section data-width="100%"><section><img data-ratio="0.8333333333333334" data-src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W1z3HOrQNibrLTDwsZM7jZb2PHLibkYyCqepB8wd3JuRhbKHSLnVzOUZw/640?wx_fmt=png" data-type="png" data-w="48" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W1z3HOrQNibrLTDwsZM7jZb2PHLibkYyCqepB8wd3JuRhbKHSLnVzOUZw/640?wx_fmt=png"></section><section data-brushtype="text"><span><strong><span>DESeq2差异分析</span></strong></span></section><section><img data-ratio="0.17796610169491525" data-src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0WerzjGbWVEKcHEQeHjIWxYib9DCZXd9dYaaY3ibaaSsHv1HAicBUKoYbwg/640?wx_fmt=png" data-type="png" data-w="118" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0WerzjGbWVEKcHEQeHjIWxYib9DCZXd9dYaaY3ibaaSsHv1HAicBUKoYbwg/640?wx_fmt=png"></section><section><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W7aKX5XdKVAkBfgIQ0bDq5ZuEJGQMLLiaBKDULFmYicy6r48czIWb1OwA/640?wx_fmt=png" data-type="png" data-w="21" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W7aKX5XdKVAkBfgIQ0bDq5ZuEJGQMLLiaBKDULFmYicy6r48czIWb1OwA/640?wx_fmt=png"></section></section></section><h3><span><span>1.比较LUSC患者T1-4分型与正常样本的差异基因或miRNA </span>RNA表达矩阵</span></h3><h5><span>1.1 检查数据</span></h5><pre><code><span>## 全部肿瘤样本及正常样本表达矩阵的PCA图，热图</span><br><br>rm(list = ls())<br>load(file = <span>"step1_output.Rdata"</span>)<br>dat=gset_cdRNA<br>group_list=ifelse(substring(colnames(gset_cdRNA),14,15) == <span>"11"</span>,<span>"Normal"</span>,<span>"Tumor"</span>)<br><br><span>### 去掉低质量的探针行</span><br>dat=dat[apply(dat,1, function(x) sum(x&gt;1) &gt; 50),]<br><br><span>### 检查数据</span><br>table(group_list)<br>source(<span>"run_check_h_pca.R"</span>)<br>pro = <span>"cdRNA_Tumor_vs_Normal"</span><br>run_check_h_pca(pro)<br></code></pre><figure><p><img data-ratio="0.5188933873144399" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz83ib7d5RdzOWLSaicPkz0275Tho8VasckSspgrAZcOYib71bS2iaCPFITJUsksUdqFJnM1xMVQAJKfw/640?wx_fmt=png" data-type="png" data-w="1482" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz83ib7d5RdzOWLSaicPkz0275Tho8VasckSspgrAZcOYib71bS2iaCPFITJUsksUdqFJnM1xMVQAJKfw/640?wx_fmt=png"></p><figcaption><br></figcaption></figure><ul><li><p>样本分组</p><table width="100%"><thead><tr><th>Group</th><th>Normal</th><th>T1</th><th>T2</th><th>T3</th><th>T4</th></tr></thead><tbody><tr><td>样本个数</td><td>38</td><td>106</td><td>279</td><td>69</td><td>21</td></tr></tbody></table></li><li><p>全部Tumor样本和Normal组的热图和PCA图可以看出，Tumor组样本大都与Normal组有显著差异，从而可进行下一步差异分析。</p></li></ul><h5><span>1.2 差异分析</span></h5><pre><code><span>## T1-T4亚型组与正常组表达矩阵分别差异分析</span><br><br><span>### 去掉低质量的探针行</span><br>gset=gset_cdRNA<br>gset=gset[apply(gset,<span>1</span>, <span><span>function</span><span>(x)</span> <span>sum</span><span>(x&gt;<span>1</span>)</span> &gt; 50),]<br><br>### <span>for</span>循环批量差异分析<br><span>source</span><span>(<span>"function.R"</span>)</span><br><span>for</span> <span>(Typel in c<span>(<span>"T1"</span>,<span>"T2"</span>,<span>"T3"</span>,<span>"T4"</span>)</span>)</span> </span>{<br>  pro=paste0(<span>"cdRNA_"</span>,Typel,<span>"_vs_Normal_2"</span>)<br>  run_filter_check_DESeq2(Typel,pro)<br>}<br></code></pre><h5><span>1.3 比较差异分析结果</span></h5><pre><code><span>## 比较T1-4分别与正常样本差异基因情况</span><br>rm(list=ls())<br>load(<span>"cdRNA_T1_vs_Normal_deseq2_DEG.Rdata"</span>)<br>p0=p1 <span># 一个赋值小错误，由于包装函数里是p1，所以导致赋值时p1和p4一样，所以暂且改成p0赋值了</span><br>DEG_T1=DEG<br>load(<span>"cdRNA_T2_vs_Normal_deseq2_DEG.Rdata"</span>)<br>p2=p1<br>DEG_T2=DEG<br>load(<span>"cdRNA_T3_vs_Normal_deseq2_DEG.Rdata"</span>)<br>p3=p1<br>DEG_T3=DEG<br>load(<span>"cdRNA_T4_vs_Normal_deseq2_DEG.Rdata"</span>)<br>p4=p1<br>DEG_T4=DEG<br><br><span>library</span>(ggplot2)<br><span>library</span>(gridExtra)<br>plots &lt;- list(p0,p2,p3,p4)<br>p= grid.arrange(grobs = plots, ncol = <span>2</span>,<br>                top = <span>"compare"</span>)<br>ggsave(p,filename = <span>"cdRNA_compare_volcano.png"</span>,width = <span>20</span>,height = <span>15</span>)<br><br><br>venn &lt;- <span>function</span>(x,y,z,a,name){<br>  <span>if</span>(!<span>require</span>(VennDiagram))install.packages(<span>'VennDiagram'</span>)<br>  <span>library</span> (VennDiagram)<br>  venn.diagram(x= list(T1_vs_Normal = x,T2_vs_Normal = y,T3_vs_Normal = z,T4_vs_Normal = a),filename = <span>"cdRNA_DEGgene.png"</span>, <br>               height = <span>1000</span>, width = <span>1000</span>,resolution =<span>300</span>, imagetype=<span>"tiff"</span>, col=<span>"transparent"</span>,fill=c(<span>"cornflowerblue"</span>,<span>"green"</span>,<span>"yellow"</span>,<span>"darkorchid1"</span>),alpha = <span>0.5</span>, cex=<span>0.45</span>, cat.cex=<span>0.45</span>)<br>}<br><br>DEG_T1$change!=<span>"NOT"</span><br><br>DEGs=<span>function</span>(df){<br>  rownames(df)[df$change!=<span>"NOT"</span>]<br>}<br><br><span>library</span>(VennDiagram)<br>venn(DEGs(DEG_T1),DEGs(DEG_T2),DEGs(DEG_T3),DEGs(DEG_T4),<br>     <span>"DEGgene"</span><br>)<br><br>DEGsl = intersect(intersect(intersect(DEGs(DEG_T1),DEGs(DEG_T2)),DEGs(DEG_T3)),DEGs(DEG_T4))<br><br>length(DEGsl)<br></code></pre><p><img data-ratio="0.75" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz83ib7d5RdzOWLSaicPkz027Mbdial4U9eAeTkR52uJj9OicNY5h3J2rCOicWmnjibL0ILua2GgvwlxN1Q/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz83ib7d5RdzOWLSaicPkz027Mbdial4U9eAeTkR52uJj9OicNY5h3J2rCOicWmnjibL0ILua2GgvwlxN1Q/640?wx_fmt=png"></p><h4><span>2. lncRNA和miRNA表达矩阵一样批量分析</span><br></h4><ul><li><p><span>这里就直接上文献中类似的venn图结果</span></p></li></ul><p><br></p><p><img data-ratio="0.2737580993520518" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz83ib7d5RdzOWLSaicPkz027S3hLLGriamia3C6WFpmhQzuRf5WRI4WZQndVf15IhXUZpD4vzCXqyDqA/640?wx_fmt=png" data-type="png" data-w="1852" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz83ib7d5RdzOWLSaicPkz027S3hLLGriamia3C6WFpmhQzuRf5WRI4WZQndVf15IhXUZpD4vzCXqyDqA/640?wx_fmt=png"></p><ul><li><p>T1-4期患者样本分别与正常样本差异分析的阈值：<strong>log2FC=1,FDR=0.01</strong></p></li><li><p>T1-4期患者样本分别与正常样本差异分析结果</p></li><li><p>cdRNA:19814个基因里有5573个共同差异基因</p></li><li><p>lncRNA:7656个基因里有1571个共同的差异lncRNA基因</p></li><li><p>miRNA:1881个miRNA里有164个共同的差异miRNA</p></li></ul><section data-tools="135编辑器" data-id="96383"><section data-width="100%"><section><img data-ratio="0.8333333333333334" data-src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W1z3HOrQNibrLTDwsZM7jZb2PHLibkYyCqepB8wd3JuRhbKHSLnVzOUZw/640?wx_fmt=png" data-type="png" data-w="48" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W1z3HOrQNibrLTDwsZM7jZb2PHLibkYyCqepB8wd3JuRhbKHSLnVzOUZw/640?wx_fmt=png"></section><section data-brushtype="text"><span><strong><span>总结</span></strong></span></section><section><img data-ratio="0.17796610169491525" data-src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0WerzjGbWVEKcHEQeHjIWxYib9DCZXd9dYaaY3ibaaSsHv1HAicBUKoYbwg/640?wx_fmt=png" data-type="png" data-w="118" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0WerzjGbWVEKcHEQeHjIWxYib9DCZXd9dYaaY3ibaaSsHv1HAicBUKoYbwg/640?wx_fmt=png"></section><section><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W7aKX5XdKVAkBfgIQ0bDq5ZuEJGQMLLiaBKDULFmYicy6r48czIWb1OwA/640?wx_fmt=png" data-type="png" data-w="21" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W7aKX5XdKVAkBfgIQ0bDq5ZuEJGQMLLiaBKDULFmYicy6r48czIWb1OwA/640?wx_fmt=png"></section></section></section><ul><li><p>首先特别感谢Jimmy 大神，以上函数代码均引自<strong>Jimmy大神及生信技能树</strong>。</p></li><li><p><span>TCGA数据库的样本编码规律：Tumor types range from 01 - 09, normal types from 10 - 19 and control samples from 20 - 29，方法对样本进行分组。</span></p></li><li><p><span>基因注释GMT文件把mRNA矩阵注释拆分成了coding RNA和lncRNA表达矩阵。</span></p></li><li><p><span>DESeq2包分析的表达矩阵必须是count矩阵，TCGA等数据库下载的表达矩阵需查看格式说明，如是否取log,如有需要转换回来。</span></p></li><li><p><span>包装函数for循环方便根据临床表型信息批量筛选表达矩阵，绘制热图、PCA图、差异分析并得到火山图、venn图。</span></p></li><li><p><span>模仿文献分析方法挖掘数据需要仔细阅读文献，查看表达矩阵的过滤条件和差异分析阈值（FC和log2FC有区别）。</span></p></li></ul><section data-tools="135编辑器" data-id="96383"><section data-width="100%"><section><img data-ratio="0.8333333333333334" data-src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W1z3HOrQNibrLTDwsZM7jZb2PHLibkYyCqepB8wd3JuRhbKHSLnVzOUZw/640?wx_fmt=png" data-type="png" data-w="48" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W1z3HOrQNibrLTDwsZM7jZb2PHLibkYyCqepB8wd3JuRhbKHSLnVzOUZw/640?wx_fmt=png"></section><section data-brushtype="text"><span><strong><span>函数代码</span></strong></span></section><section><img data-ratio="0.17796610169491525" data-src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0WerzjGbWVEKcHEQeHjIWxYib9DCZXd9dYaaY3ibaaSsHv1HAicBUKoYbwg/640?wx_fmt=png" data-type="png" data-w="118" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0WerzjGbWVEKcHEQeHjIWxYib9DCZXd9dYaaY3ibaaSsHv1HAicBUKoYbwg/640?wx_fmt=png"></section><section><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W7aKX5XdKVAkBfgIQ0bDq5ZuEJGQMLLiaBKDULFmYicy6r48czIWb1OwA/640?wx_fmt=png" data-type="png" data-w="21" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_png/7QRTvkK2qC73khicTK3Up4USibtAA70I0W7aKX5XdKVAkBfgIQ0bDq5ZuEJGQMLLiaBKDULFmYicy6r48czIWb1OwA/640?wx_fmt=png"></section></section></section><h5><span>检查数据函数</span></h5><pre><code>run_check_h_pca &lt;- <span>function</span>(pro = <span>"T1_vs_Normal"</span>){<br>  rm(list = ls())  <span>## 魔幻操作，一键清空~</span><br>  options(stringsAsFactors = <span>F</span>)<br>  table(group_list)<br>  <span># 每次都要检测数据</span><br>  dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br>  <span>## 下面是画PCA的必须操作，需要看说明书。</span><br>  dat=t(dat)<span>#画PCA图时要求是行名时样本名，列名时探针名，因此此时需要转换</span><br>  dat=as.data.frame(dat)<span>#将matrix转换为data.frame</span><br>  dat=cbind(dat,group_list) <span>#cbind横向追加，即将分组信息追加到最后一列</span><br>  <span>library</span>(<span>"FactoMineR"</span>)<span>#画主成分分析图需要加载这两个包</span><br>  <span>library</span>(<span>"factoextra"</span>) <br>  <span># The variable group_list (index = 54676) is removed</span><br>  <span># before PCA analysis</span><br>  dat.pca &lt;- PCA(dat[,-ncol(dat)], graph = <span>FALSE</span>)<span>#现在dat最后一列是group_list，需要重新赋值给一个dat.pca,这个矩阵是不含有分组信息的</span><br>  fviz_pca_ind(dat.pca,<br>               geom.ind = <span>"point"</span>, <span># show points only (nbut not "text")</span><br>               col.ind = dat$group_list, <span># color by groups</span><br>               <span># palette = c("#00AFBB", "#E7B800"),</span><br>               addEllipses = <span>TRUE</span>, <span># Concentration ellipses</span><br>               legend.title = <span>"Groups"</span><br>  )<br>  ggsave(filename = paste0(pro,<span>'_all_samples_PCA.png'</span>))<br><br>  rm(list = ls())  <span>## 魔幻操作，一键清空~</span><br>  load(file = <span>'step1_output.Rdata'</span>) <br>  dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>] <br><br>  cg=names(tail(sort(apply(dat,<span>1</span>,sd)),<span>1000</span>))<span>#apply按行（'1'是按行取，'2'是按列取）取每一行的方差，从小到大排序，取最大的1000个</span><br>  <span>library</span>(pheatmap)<br>  <span>#pheatmap(dat[cg,],show_colnames =F,show_rownames = F) #对那些提取出来的1000个基因所在的每一行取出，组合起来为一个新的表达矩阵</span><br>  n=t(scale(t(dat[cg,]))) <span># 'scale'可以对log-ratio数值进行归一化</span><br>  n[n&gt;<span>2</span>]=<span>2</span> <br>  n[n&lt; -<span>2</span>]= -<span>2</span><br>  n[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  pheatmap(n,show_colnames =<span>F</span>,show_rownames = <span>F</span>)<br>  ac=data.frame(g=group_list)<br>  rownames(ac)=colnames(n) <span>#把ac的行名给到n的列名，即对每一个探针标记上分组信息（是'noTNBC'还是'TNBC'）</span><br>  <span>## 可以看到TNBC具有一定的异质性，拿它来区分乳腺癌亚型指导临床治疗还是略显粗糙。</span><br>  pheatmap(n,show_colnames =<span>F</span>,show_rownames = <span>F</span>,<br>           annotation_col=ac,filename = paste0(pro,<span>"_heatmap_top1000_sd.png"</span>))<br><br><br>  rm(list = ls()) <br>  load(file = <span>'step1_output.Rdata'</span>) <br>  dat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>] <br>  exprSet=dat<br>  pheatmap::pheatmap(cor(exprSet)) <br>  <span># 组内的样本的相似性应该是要高于组间的！</span><br>  colD=data.frame(group_list=group_list)<br>  rownames(colD)=colnames(exprSet)<br>  pheatmap::pheatmap(cor(exprSet),<br>                     annotation_col = colD,<br>                     show_rownames = <span>F</span>,<br>                     filename = paste0(pro,<span>"_cor_all.png"</span>))<br>  dim(exprSet)<br>  exprSet=exprSet[apply(exprSet,<span>1</span>, <span>function</span>(x) sum(x&gt;<span>1</span>) &gt; <span>5</span>),]<br>  dim(exprSet)<br><br>  exprSet=log(edgeR::cpm(exprSet)+<span>1</span>)<br>  dim(exprSet)<br>  exprSet=exprSet[names(sort(apply(exprSet, <span>1</span>,mad),decreasing = <span>T</span>)[<span>1</span>:<span>500</span>]),]<br>  dim(exprSet)<br>  M=cor(log2(exprSet+<span>1</span>)) <br>  pheatmap::pheatmap(M,<br>                     show_rownames = <span>F</span>,<br>                     annotation_col = colD,<br>                     filename = paste0(pro,<span>"_cor_top500.png"</span>))<br>}<br></code></pre><h5><span>DESeq2差异分析函数</span></h5><pre><code>run_filter_check_DESeq2 &lt;- <span><span>function</span><span>(Typel,pro)</span></span>{<br>  <span>#按照T1-T4分类肺癌组织样本的得到四个表达矩阵</span><br>  RNA_Normal=gset[,substring(colnames(gset),<span>14</span>,<span>15</span>) == <span>"11"</span>]<br>  RNA_LUSC=gset[,substring(colnames(gset),<span>14</span>,<span>15</span>) == <span>"01"</span>]<br><br>  colnames(RNA_Normal)<br>  colnames(RNA_LUSC)<br><br>  <span># T1-4期亚型的表达矩阵</span><br>  RNA_T=RNA_LUSC[,colnames(RNA_LUSC) %in% rownames(pd[substring(pd[,<span>"pathologic_T"</span>],<span>1</span>,<span>2</span>) == Typel,])]<br>  dat=cbind(RNA_Normal,RNA_T)<br>  colnames(dat)<br>  group_list=c(rep(<span>"Normal"</span>,<span>38</span>),rep(Typel,ncol(RNA_T)))<br>  table(group_list)<br><br>  <span>## 差异分析 DESeq2</span><br><br>  <span>if</span>(!<span>require</span>(DESeq2))BiocManager::install(<span>"DESeq2"</span>)<br>  library(DESeq2)<br>  <span>#需修改results()的contrast参数</span><br>  <span>#输入：表达矩阵和分组信息</span><br>  <span>#输出：差异分析结果、火山图</span><br>  <span>#构建colData (condition存在于colData中，是表示分组的因子型变量)</span><br>  countData &lt;- floor(dat)<br>  colData &lt;- data.frame(row.names =colnames(countData), <br>                        condition=group_list)<br>  dds &lt;- DESeqDataSetFromMatrix(<br>    countData = countData,<br>    colData = colData,<br>    design = ~ condition)<br><br>  dds &lt;- DESeq(dds)<br>  <span># 两两比较</span><br>  res &lt;- results(dds, contrast = c(<span>"condition"</span>,Typel,<span>"Normal"</span>))<br>  resOrdered &lt;- res[order(res$padj),] <span># 按照P值排序</span><br>  DEG &lt;- <span>as</span>.data.frame(resOrdered)<br>  DEG &lt;- na.omit(DEG)<br><br>  <span>#添加change列标记基因上调下调,在DESeq里FDR就是pdaj，所以要把pvalue改成pdaj</span><br>  <span>#logFC_cutoff &lt;- with(DEG,mean(abs(log2FoldChange)) + 2*sd(abs(log2FoldChange)) )</span><br>  logFC_cutoff &lt;- <span>1</span><br>  DEG$change = <span>as</span>.factor(<br>    ifelse(DEG$padj &lt; <span>0.01</span> &amp; abs(DEG$log2FoldChange) &gt; logFC_cutoff,<br>           ifelse(DEG$log2FoldChange &gt;= logFC_cutoff ,<span>'UP'</span>,<span>'DOWN'</span>),<span>'NOT'</span>)<br>  )<br>  head(DEG)<br>  boxplot(<span>as</span>.numeric(countData[rownames(DEG)[<span>1</span>],])~group_list)<br>  <span># Heatmap热图</span><br>  choose_gene=head(rownames(DEG),<span>100</span>) <span>## 选定部分差异基因</span><br>  choose_matrix=countData[choose_gene,]<br>  pheatmap::pheatmap(choose_matrix) <br><br>  annotation_col = data.frame(<br>    group = factor(group_list))<br>  rownames(annotation_col) = colnames(countData)<br><br>  pheatmap::pheatmap(choose_matrix,<br>                     scale = <span>"row"</span>,<br>                     annotation_col = annotation_col)<br><br>  <span># 火山图</span><br>  library(ggplot2)<br><br>  this_tile &lt;- paste0(<span>'Cutoff for log2FoldChange is '</span>,round(logFC_cutoff,<span>3</span>),<br>                      <span>'\nThe number of up gene is '</span>,nrow(DEG[DEG$change ==<span>'UP'</span>,]) ,<br>                      <span>'\nThe number of down gene is '</span>,nrow(DEG[DEG$change ==<span>'DOWN'</span>,])<br>  )<br>  p1 = ggplot(data=DEG, <br>              aes(x=log2FoldChange, y=-log10(padj),color=change)) +<br>    geom_point(alpha=<span>0.4</span>, size=<span>3.5</span>) +<br>    theme_set(theme_set(theme_bw(base_size=<span>20</span>)))+<br>    xlab(<span>"log2 fold change"</span>) + ylab(<span>"-log10 padj"</span>) +<br>    geom_vline(xintercept=c(-logFC_cutoff,logFC_cutoff),lty=<span>4</span>,col=<span>"black"</span>,lwd=<span>0.8</span>) +<br>    geom_hline(yintercept = -log10(<span>0.05</span>),lty=<span>4</span>,col=<span>"black"</span>,lwd=<span>0.8</span>) +<br>    ggtitle( this_tile ) + theme(plot.title = element_text(size=<span>15</span>,hjust = <span>0.5</span>))+<br>    scale_colour_manual(values = c(<span>'blue'</span>,<span>'grey'</span>,<span>'red'</span>)) <span>## corresponding to the levels(res$change)</span><br>  p1<br>  ggsave(p1, filename = paste0(pro,<span>"deseq2_vocalno.png"</span>), width = <span>10</span>, height = <span>7</span> )<br>  save(DEG,p1,file = paste0(pro,<span>"_deseq2_DEG.Rdata"</span>))<br><br>}</code><h4><span>文末友情宣传</span><span></span></h4><section>强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</section></pre><ul><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492877&amp;idx=1&amp;sn=3c757918f99f11fea8048f7c43067de9&amp;scene=21#wechat_redirect" data-linktype="2">全国巡讲全球听（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492711&amp;idx=1&amp;sn=5b629127522cd19fb3210e80f3841bc1&amp;scene=21#wechat_redirect" data-linktype="2">生信技能树的2019年终总结</a>  ，你的生物信息学成长宝藏</section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492732&amp;idx=1&amp;sn=26ce7dfb8bcfd9fe18fcabfb83de101b&amp;scene=21#wechat_redirect" data-linktype="2">2020学习主旋律，B站74小时免费教学视频为你领路</a></section></li></ul></section></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ufCqtsorJQdqcPNFdK4t1g",target="_blank" rel="noopener noreferrer">原文链接</a>
