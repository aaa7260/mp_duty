---
title: "单细胞数据处理的基因名字转换"
date: 2023-07-28T15:13:12Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
单细胞数据处理的基因名字转换 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span>❝</span><p>本周推文本来是计划把一篇文献中的NMF部分复现一下，然后在处理数据的时候发现在读入数据以后，基因名字显示的并不是symbol而是ensemble ID, 想着要不就从这个小小的问题入手写个笔记~</p><span>❞</span></blockquote><p data-tool="mdnice编辑器">搜索推文发现曾老师之前写过一篇，不过他这篇是在后面作图的时候发现画图报错后才转换ID，这种就会比较麻烦，所以我这里就正好在构建surat对象之初把基因名字转换好。</p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247502953&amp;idx=1&amp;sn=322d6dd9226059534b6f008966b49230&amp;scene=21#wechat_redirect" data-linktype="2">构建seurat对象之初就应该是把基因名字转换好</a></p><figure data-tool="mdnice编辑器"><img data-ratio="0.2750352609308886" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicO9j6BRQAulCBibSJp1FIB5GcaqIdPfM3Om52BNYoCLE4IlbM7ibofhtuYiapNLjGPhnlund3QhYrDg/640?wx_fmt=png" data-type="png" data-w="709" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicO9j6BRQAulCBibSJp1FIB5GcaqIdPfM3Om52BNYoCLE4IlbM7ibofhtuYiapNLjGPhnlund3QhYrDg/640?wx_fmt=png"></figure><h4 data-tool="mdnice编辑器"><span></span>所用文献及数据<span></span></h4><blockquote data-tool="mdnice编辑器"><span>❝</span><p>文献：Single-cell RNA sequencing identifies a paracrine interaction that may drive oncogenic notch signaling in human adenoid cystic carcinoma.</p><p>2022 Nov 29;41(9):111743. doi: 10.1016/j.celrep.2022.111743.</p><p>数据集：GSE210171<img data-ratio="0.08072487644151564" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicO9j6BRQAulCBibSJp1FIB5UJPrCjvKIKHp2pKeiaGenUoHXm8LpYugUzLSHErSZibZseMPEEKAaIAQ/640?wx_fmt=png" data-type="png" data-w="607" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicO9j6BRQAulCBibSJp1FIB5UJPrCjvKIKHp2pKeiaGenUoHXm8LpYugUzLSHErSZibZseMPEEKAaIAQ/640?wx_fmt=png"></p><span>❞</span></blockquote><h4 data-tool="mdnice编辑器"><span></span>step1:导入数据 ——构建seurat对象之初需要把基因名字转换好<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>) <br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><br><span>###### step1:导入数据 ######  </span><br><span>library</span>(data.table)<br>getwd()<br>setwd(<span>"../"</span>)<br>dir=<span>'raw/'</span> <br>samples=list.files( dir )<br>samples  <br><br>  <span>library</span>(data.table)<br>  a=fread(<span>'./raw/GSE210171_acc_scrnaseq_counts.txt.gz'</span>,data.table = <span>F</span>)<br>  a[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  class(a)<br>  a&lt;-as.data.frame(a)<br><span>#取ensemble ID的前15位</span><br>  a[,<span>1</span>]&lt;-substr(a[,<span>1</span>], <span>1</span>,<span>15</span>)<br>  a[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  a &lt;- a[!duplicated(a[,<span>1</span>]),]<br>  a[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  <br>  ct=a<br>  rownames(ct)=a[,<span>1</span>]<br>  head(rownames(ct))<br>  class(ct)<br>  <span>library</span>(stringr)<br>  <span>library</span>(org.Hs.eg.db)<br>  ids=select(org.Hs.eg.db,keys = rownames(ct),<br>             columns = c(<span>'ENSEMBL'</span>,<span>'SYMBOL'</span>),<br>             keytype = <span>'ENSEMBL'</span>)<br>  <br>  colnames(ids)&lt;-c(<span>"Geneid"</span>,<span>"SYMBOL"</span>)<br>  ct2&lt;-merge(ct,ids,by=<span>"Geneid"</span>)<br>  <br> <span># ct3 &lt;- ct2[!duplicated(ct2[,1]),]</span><br>  <span>#rownames(ct3)&lt;-ct3[,1]</span><br>  <br>  ct3 &lt;- ct2[!duplicated(ct2[,<span>2406</span>]),]<br>   rownames(ct3)&lt;-ct3[,<span>2406</span>]<br>   ct3&lt;-ct3[,-<span>2406</span>]<br>   ct3&lt;-ct3[,-(<span>1</span>:<span>6</span>)]<br>  sce=CreateSeuratObject( ct3 )<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>查看数据<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code> sce.all=sce<br>sce.all@assays$RNA@counts[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>dim(sce.all)<br>as.data.frame(sce.all@assays$RNA@counts[<span>1</span>:<span>10</span>, <span>1</span>:<span>2</span>])<br>head(sce.all@meta.data, <span>10</span>)<br>table(sce.all$orig.ident)<br>table(rownames(sce.all@meta.data))<br><br>sce.all$sample&lt;-ifelse(grepl(<span>"ACC2"</span>,rownames(sce.all@meta.data)),<span>"ACC2"</span>,<br>                   ifelse(grepl(<span>"ACC5"</span>,rownames(sce.all@meta.data)),<span>"ACC5"</span>,<br> ifelse(grepl(<span>"ACC7"</span>,rownames(sce.all@meta.data)),<span>"ACC7"</span>,<br>  ifelse(grepl(<span>"ACC15"</span>,rownames(sce.all@meta.data)),<span>"ACC15"</span>,<br>     ifelse(grepl(<span>"ACC19"</span>,rownames(sce.all@meta.data)),<span>"ACC19"</span>,                      ifelse(grepl(<span>"ACC21"</span>,rownames(sce.all@meta.data)),<span>"ACC21"</span>,<span>"ACC22"</span>))))))<br><br>table(sce.all$sample)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>之后就是常规的QC<span></span></h4><h4 data-tool="mdnice编辑器"><span></span>step2: harmony<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>dir.create(<span>"2-harmony"</span>)<br>getwd()<br>setwd(<span>"2-harmony"</span>)<br><br>sce=sce.all <br>sce<br>sce &lt;- NormalizeData(sce, <br>                         normalization.method = <span>"LogNormalize"</span>,<br>                         scale.factor = <span>1e4</span>) <br>sce &lt;- FindVariableFeatures(sce)<br>sce &lt;- ScaleData(sce)<br>sce &lt;- RunPCA(sce, features = VariableFeatures(object = sce))<br><br><span>library</span>(harmony)<br>seuratObj &lt;- RunHarmony(sce, <span>"orig.ident"</span>)<br>names(seuratObj@reductions)<br>seuratObj &lt;- RunUMAP(seuratObj,  dims = <span>1</span>:<span>15</span>, <br>                     reduction = <span>"harmony"</span>)<br>DimPlot(seuratObj,reduction = <span>"umap"</span>,label=<span>T</span> ) <br><br>sce=seuratObj<br>sce &lt;- FindNeighbors(sce, reduction = <span>"harmony"</span>,<br>                     dims = <span>1</span>:<span>15</span>) <br>sce.all=sce<br><span>#设置不同的分辨率，观察分群效果</span><br><span>for</span> (res <span>in</span> c(<span>0.01</span>, <span>0.05</span>, <span>0.1</span>, <span>0.2</span>, <span>0.3</span>, <span>0.5</span>,<span>0.8</span>,<span>1</span>)) {<br>  sce.all=FindClusters(sce.all, <span>#graph.name = "CCA_snn",</span><br>                       resolution = res, algorithm = <span>1</span>)<br>}<br>colnames(sce.all@meta.data)<br><br><span>#接下来分析，按照分辨率为0.05进行 </span><br>sel.clust = <span>"RNA_snn_res.0.05"</span><br>sce.all &lt;- SetIdent(sce.all, value = sel.clust)<br>table(sce.all@active.ident) <br>saveRDS(sce.all, <span>"sce.all_int.rds"</span>)<br><br>getwd()<br>setwd(<span>'../'</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>step3: 检查常见分群情况<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>###### step3:检查常见分群情况  ######</span><br>dir.create(<span>"3-cell"</span>)<br>setwd(<span>"3-cell"</span>)  <br>getwd()<br><span>#sce.all=readRDS("./2-harmony/sce.all_int.rds")</span><br><br>DimPlot(sce.all, reduction = <span>"umap"</span>, group.by = <span>"seurat_clusters"</span>,label = <span>T</span>) <br>DimPlot(sce.all, reduction = <span>"umap"</span>, group.by = <span>"RNA_snn_res.0.05"</span>,label = <span>T</span>) <br>ggsave(<span>'umap_by_RNA_snn_res.0.05.pdf'</span>)<br><br><span>library</span>(ggplot2) <br>genes_to_check = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <span>'CD4'</span>,<span>'CD8A'</span>,<span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span> ,<br>                   <span>'IGHG1'</span>, <span>'MZB1'</span>, <span>'SDC1'</span>,<br>                   <span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>, <br>                   <span>'TPSAB1'</span> , <span>'TPSB2'</span>,  <span># mast cells,</span><br>                   <span>'MKI67'</span>,<span>'TOP2A'</span>,<span>'KLRC1'</span>,<br>                   <span>'RCVRN'</span>,<span>'FPR1'</span> , <span>'ITGAM'</span> ,<br>                   <span>'FGF7'</span>,<span>'MME'</span>, <span>'ACTA2'</span>,<br>                   <span>'PECAM1'</span>, <span>'VWF'</span>,    <br>                   <span>'KLRB1'</span>,<span>'NCR1'</span>, <span># NK </span><br>                   <span>'EPCAM'</span> , <span>'KRT19'</span>, <span>'PROM1'</span>, <span>'ALDH1A1'</span>,<br>                   <span>'MKI67'</span> ,<span>'TOP2A'</span> )<br><span>library</span>(stringr)  <br>genes_to_check=str_to_upper(unique(genes_to_check))<br>genes_to_check<br>p_all_markers &lt;- DotPlot(sce.all, features = genes_to_check,<br>                         assay=<span>'RNA'</span>  )  + coord_flip()<br><br>p_all_markers<br>ggsave(plot=p_all_markers, filename=<span>"check_all_marker_by_seurat_cluster.pdf"</span>)<br><br></code></pre><h4 data-tool="mdnice编辑器"><span></span>step4: 细胞分群<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#umap图细胞生物学命名marker</span><br>genes_to_check = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <span>'CD4'</span>,<span>'CD8A'</span>,<br>                   <span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span> ,<br>                   <span>'IGHG1'</span>, <span>'MZB1'</span>, <span>'SDC1'</span>,<br>                   <span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>, <br>                   <span>'TPSAB1'</span> , <span>'TPSB2'</span>,  <span># mast cells,</span><br>                   <span>'RCVRN'</span>,<span>'FPR1'</span> , <span>'ITGAM'</span> ,<br>                   <span>'C1QA'</span>,  <span>'C1QB'</span>,  <span># mac</span><br>                   <span>'S100A9'</span>, <span>'S100A8'</span>, <span>'MMP19'</span>,<span># monocyte</span><br>                   <span>'FCGR3A'</span>,<br>                   <span>'LAMP3'</span>, <span>'IDO1'</span>,<span>'IDO2'</span>,<span>## DC3 </span><br>                   <span>'CD1E'</span>,<span>'CD1C'</span>, <span># DC2</span><br>                   <span>'KLRB1'</span>,<span>'NCR1'</span>, <span># NK </span><br>                   <span>'FGF7'</span>,<span>'MME'</span>, <span>'ACTA2'</span>, <span>## human  fibo </span><br>                   <span>'DCN'</span>, <span>'LUM'</span>,  <span>'GSN'</span> , <span>## mouse PDAC fibo </span><br>                   <span>'MKI67'</span> , <span>'TOP2A'</span>, <br>                   <span>'PECAM1'</span>, <span>'VWF'</span>,  <span>## endo </span><br>                   <span>'EPCAM'</span> , <span>'KRT19'</span>,<span>'KRT7'</span>, <span># epi </span><br>                   <span>'FYXD2'</span>, <span>'TM4SF4'</span>, <span>'ANXA4'</span>,<span># cholangiocytes</span><br>                   <span>'APOC3'</span>, <span>'FABP1'</span>,  <span>'APOA1'</span>,  <span># hepatocytes</span><br>                   <span>'Serpina1c'</span>,<span>'PROM1'</span>, <span>'ALDH1A1'</span>,<br>                   <span>"NKG7"</span><span>#NKT</span><br>                   )<br><br><span>library</span>(stringr)  <br>genes_to_check=str_to_upper(genes_to_check)<br>genes_to_check<br>p &lt;- DotPlot(sce.all, features = unique(genes_to_check),<br>             assay=<span>'RNA'</span>  )  + coord_flip()<br><br>p <br>ggsave(<span>'check_last_markers.pdf'</span>,height = <span>11</span>,width = <span>11</span>)<br><br><span># 需要自行看图,定细胞亚群：</span><br><span># 文章里面的 ：  </span><br><br>celltype=data.frame(ClusterID=<span>0</span>:<span>4</span>,<br>                    celltype= <span>0</span>:<span>4</span>) <br><br><span>#定义细胞亚群 </span><br>celltype[celltype$ClusterID %<span>in</span>% c( <span>4</span> ),<span>2</span>]=<span>'B'</span>  <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>,<span>2</span>),<span>2</span>]=<span>'epi'</span>   <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>1</span>),<span>2</span>]=<span>'fibo'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c(<span>3</span>),<span>2</span>]=<span>'Endo'</span>  <br><br><br>head(celltype)<br>celltype<br>table(celltype$celltype)<br><br>sce.all@meta.data$celltype = <span>"NA"</span><br><span>for</span>(i <span>in</span> <span>1</span>:nrow(celltype)){<br>  sce.all@meta.data[which(sce.all@meta.data$RNA_snn_res.0.05 == celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]}<br>table(sce.all@meta.data$celltype)<br><br><br>th=theme(axis.text.x = element_text(angle = <span>45</span>, <br>                                    vjust = <span>0.5</span>, hjust=<span>0.5</span>)) <br><span>library</span>(patchwork)<br>p_all_markers=DotPlot(sce.all, features = genes_to_check,<br>                      assay=<span>'RNA'</span> ,group.by = <span>'celltype'</span> )  + coord_flip()+th<br>p_umap=DimPlot(sce.all, reduction = <span>"umap"</span>, group.by = <span>"celltype"</span>,label = <span>T</span>,label.box = <span>T</span>)<br>p_all_markers+p_umap<br>ggsave(<span>'markers_umap_by_celltype_2.pdf'</span>,width = <span>13</span>,height = <span>8</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6162551440329218" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicO9j6BRQAulCBibSJp1FIB5Nww9YHsVJLw1cej5ps7VQBiagzILmCAQpTzbDdHFdzN3qAhVyibwc0MQ/640?wx_fmt=png" data-type="png" data-w="972" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicO9j6BRQAulCBibSJp1FIB5Nww9YHsVJLw1cej5ps7VQBiagzILmCAQpTzbDdHFdzN3qAhVyibwc0MQ/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><span>❝</span><p>该篇文献中也有关于NMF运用到单细胞数据的相关分析，下周尝试复现一下，看看效果如何。</p><span>❞</span></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="0.8475991649269311" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicO9j6BRQAulCBibSJp1FIB5duDEqwTtokxdPpdtE3S16qiangIrEeDYK3ePN5Hzib1E43QZQMro1N5A/640?wx_fmt=png" data-type="png" data-w="479" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicO9j6BRQAulCBibSJp1FIB5duDEqwTtokxdPpdtE3S16qiangIrEeDYK3ePN5Hzib1E43QZQMro1N5A/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span><span>微信交流群</span><span></span></h3><p data-tool="mdnice编辑器">如果你也想参与到群里的讨论中，给我提出一些推文更新建议的话欢迎入群。同时你也可以得到我前期更新的所有数据及代码，在群里我会把代码分享给大家，而且大家可以在群里「提出自己感兴趣的单细胞文献」<strong>「我们尽可能优先选择大家的数据集去复现和实战，也欢迎大家在群里分享更多其它资料，咱们一起进步，」</strong>「比较高级的单细胞分析」**我们也会一起尝试， 相信你肯定是会不虚此行哈。</p><p data-tool="mdnice编辑器">附上之前推文的链接 <a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512238&amp;idx=1&amp;sn=e0c6dc2ea0e089aabb78133e50fb5d7f&amp;scene=21#wechat_redirect" data-linktype="2">为爱发电不可取（单细胞周更需要你的支持）</a></p><p data-tool="mdnice编辑器"><strong>「「目前群里已经有300多人，所以你想要进群的话就需要添加我的微信，私聊给我发99元的红包，我把你拉进群里。」」</strong></p><p data-tool="mdnice编辑器">我们这个群是真正的付费交流群，不仅提供数据，代码，学习资料，而且也会跟大家互动交流，还会坚持进行创作至少一年。所以，如果介意99元的门槛且不认可我们知识分享的理念，<strong>「请不要加我好友」</strong>。。</p><figure data-tool="mdnice编辑器"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicO9j6BRQAulCBibSJp1FIB5ZnN43pbkV5GXDebmJOdnI7OoTicAjEAEeQjUv0ehWSmxJQEflQTJv4Q/640?wx_fmt=png" data-type="png" data-w="172" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicO9j6BRQAulCBibSJp1FIB5ZnN43pbkV5GXDebmJOdnI7OoTicAjEAEeQjUv0ehWSmxJQEflQTJv4Q/640?wx_fmt=png"></figure></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/IKTi7Nb76IU6nE6e-pwbiw",target="_blank" rel="noopener noreferrer">原文链接</a>
