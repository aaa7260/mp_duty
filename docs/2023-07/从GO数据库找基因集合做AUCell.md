---
title: "从GO数据库找基因集合做AUCell"
date: 2023-07-05T14:00:53Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
从GO数据库找基因集合做AUCell by 生信星球
------
<div><p data-mpa-powered-by="yiban.io"><span>‍</span><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第916天</strong></span></span><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></p><hr><section><span><span>   </span><span>大神一句话，菜鸟跑半年。我不是大神，但我可以缩短你走弯路的半年~</span></span></section><section><span>   就像歌儿唱的那样，如果你不知道该往哪儿走，就留在这学点生信好不好~</span></section><section><span>   这里有豆豆和花花的学习历程，从新手到进阶，生信路上有你有我！</span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>1.提取指定GOterm的基因</span><span><span> </span></span></h4><blockquote data-tool="mdnice编辑器"><p>https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7606976/</p></blockquote><p data-tool="mdnice编辑器">在这篇文章里提到，Reactive oxygen species (ROS) 活性氧相关的17个GO条目,可以把这些基因提取出来。使用msigdbr包搞定。Data_Sheet_2.XLSX是文章的附件</p><blockquote data-tool="mdnice编辑器"><p>https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7606976/bin/Data_Sheet_2.XLSX</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>library(tidyverse)<br>dat = rio::import(<span>"Data_Sheet_2.XLSX"</span>)<br>g = dat[-1,1]<br>g<br><br><span>##  [1] "GO_REACTIVE_OXYGEN_SPECIES_BIOSYNTHETIC_PROCESS"                       </span><br><span>##  [2] "GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS"                          </span><br><span>##  [3] "GO_POSITIVE_REGULATION_OF_REACTIVE_OXYGEN_SPECIES_BIOSYNTHETIC_PROCESS"</span><br><span>##  [4] "GO_NEGATIVE_REGULATION_OF_REACTIVE_OXYGEN_SPECIES_BIOSYNTHETIC_PROCESS"</span><br><span>##  [5] "GO_NEGATIVE_REGULATION_OF_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS"   </span><br><span>##  [6] "GO_POSITIVE_REGULATION_OF_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS"   </span><br><span>##  [7] "GO_MITOCHONDRIAL_ELECTRON_TRANSPORT_CYTOCHROME_C_TO_OXYGEN"            </span><br><span>##  [8] "GO_SUPEROXIDE_GENERATING_NADPH_OXIDASE_ACTIVITY"                       </span><br><span>##  [9] "GO_HYDROGEN_PEROXIDE_METABOLIC_PROCESS"                                </span><br><span>## [10] "GO_HYDROGEN_PEROXIDE_CATABOLIC_PROCESS"                                </span><br><span>## [11] "GO_PENTOSE_METABOLIC_PROCESS"                                          </span><br><span>## [12] "GO_RESPONSE_TO_REACTIVE_OXYGEN_SPECIES"                                </span><br><span>## [13] "GO_REGULATION_OF_RESPONSE_TO_REACTIVE_OXYGEN_SPECIES"                  </span><br><span>## [14] "GO_CELLULAR_RESPONSE_TO_REACTIVE_OXYGEN_SPECIES"                       </span><br><span>## [15] "GO_REGULATION_OF_REACTIVE_OXYGEN_SPECIES_BIOSYNTHETIC_PROCESS"         </span><br><span>## [16] "GO_REGULATION_OF_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS"            </span><br><span>## [17] "GO_NEGATIVE_REGULATION_OF_RESPONSE_TO_REACTIVE_OXYGEN_SPECIES"</span><br></code></pre><p data-tool="mdnice编辑器">17条term👆</p><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>2.从msigdbr查找这些term</span><span><span> </span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>library(msigdbr)<br>GO_df = msigdbr(species = <span>"Homo sapiens"</span>,category = <span>"C5"</span>) %&gt;% <br>  dplyr::select(gene_symbol,gs_name,gs_subcat)<br><br>dim(GO_df)<br><br><span>## [1] 1424471       3</span><br><br>table(GO_df<span>$gs_subcat</span>)<br><br><span>## </span><br><span>##  GO:BP  GO:CC  GO:MF    HPO </span><br><span>## 721379 115769 122674 464649</span><br><br>GO_df = GO_df[GO_df<span>$gs_subcat</span>!=<span>"HPO"</span>,]<br><br>table(g %<span>in</span>% GO_df<span>$gs_name</span>)<br><br><span>## </span><br><span>## FALSE </span><br><span>##    17</span><br></code></pre><p data-tool="mdnice编辑器">全部匹配失败啦？</p><p data-tool="mdnice编辑器">其实是因为前缀不同</p><pre data-tool="mdnice编辑器"><span></span><code>head(GO_df<span>$gs_name</span>,3)<br><br><span>## [1] "GOBP_10_FORMYLTETRAHYDROFOLATE_METABOLIC_PROCESS"</span><br><span>## [2] "GOBP_10_FORMYLTETRAHYDROFOLATE_METABOLIC_PROCESS"</span><br><span>## [3] "GOBP_10_FORMYLTETRAHYDROFOLATE_METABOLIC_PROCESS"</span><br><br>head(g,3)<br><br><span>## [1] "GO_REACTIVE_OXYGEN_SPECIES_BIOSYNTHETIC_PROCESS"                       </span><br><span>## [2] "GO_REACTIVE_OXYGEN_SPECIES_METABOLIC_PROCESS"                          </span><br><span>## [3] "GO_POSITIVE_REGULATION_OF_REACTIVE_OXYGEN_SPECIES_BIOSYNTHETIC_PROCESS"</span><br></code></pre><p data-tool="mdnice编辑器">把前缀去掉来匹配，顺便把大写变成小写，变得易读一点。</p><pre data-tool="mdnice编辑器"><span></span><code>sn = GO_df<span>$gs_name</span> %&gt;%<br>  str_to_lower()%&gt;%<br>  str_replace(<span>"_"</span>,<span>"///"</span>) %&gt;%<br>  str_split(<span>"///"</span>,simplify = T)%&gt;%<br>  .[,2] %&gt;%<br>  str_replace_all(<span>"_"</span>,<span>" "</span>)<br>head(sn)<br><br><span>## [1] "10 formyltetrahydrofolate metabolic process"</span><br><span>## [2] "10 formyltetrahydrofolate metabolic process"</span><br><span>## [3] "10 formyltetrahydrofolate metabolic process"</span><br><span>## [4] "10 formyltetrahydrofolate metabolic process"</span><br><span>## [5] "10 formyltetrahydrofolate metabolic process"</span><br><span>## [6] "10 formyltetrahydrofolate metabolic process"</span><br><br>GO_df = mutate(GO_df,short_name = sn)<br><br>g = str_to_lower(g)%&gt;%<br>  str_replace(<span>"_"</span>,<span>"///"</span>) %&gt;%<br>  str_split(<span>"///"</span>,simplify = T)%&gt;%<br>  .[,2] %&gt;%<br>  str_replace_all(<span>"_"</span>,<span>" "</span>)<br>head(g)<br><br><span>## [1] "reactive oxygen species biosynthetic process"                       </span><br><span>## [2] "reactive oxygen species metabolic process"                          </span><br><span>## [3] "positive regulation of reactive oxygen species biosynthetic process"</span><br><span>## [4] "negative regulation of reactive oxygen species biosynthetic process"</span><br><span>## [5] "negative regulation of reactive oxygen species metabolic process"   </span><br><span>## [6] "positive regulation of reactive oxygen species metabolic process"</span><br><br>table(g %<span>in</span>% GO_df<span>$short_name</span>)<br><br><span>## </span><br><span>## FALSE  TRUE </span><br><span>##     1    16</span><br></code></pre><p data-tool="mdnice编辑器">经过数据框搜索，发现匹配不上的那个其实是因为少了俩空格。。。</p><p data-tool="mdnice编辑器">所以直接改一下就好。</p><p data-tool="mdnice编辑器">“superoxide generating nadph oxidase activity”</p><p data-tool="mdnice编辑器">“superoxide generating nad p h oxidase activity”</p><pre data-tool="mdnice编辑器"><span></span><code>g[!(g %<span>in</span>% GO_df<span>$short_name</span>)] = <span>"superoxide generating nad p h oxidase activity"</span><br>table(g %<span>in</span>% GO_df<span>$short_name</span>)<br><br><span>## </span><br><span>## TRUE </span><br><span>##   17</span><br><br>rosgene = GO_df %&gt;%<br>  filter(short_name %<span>in</span>% g) %&gt;%<br>  pull(gene_symbol) %&gt;%<br>  unique()<br>length(rosgene)<br><br><span>## [1] 402</span><br></code></pre><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>2.AUCell</span><span><span> </span></span></h4><p data-tool="mdnice编辑器">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9897923/用这个文章里的方法，将单细胞亚群的marker基因与ros相关基因取交集，用作AUCell的基因集</p><blockquote data-tool="mdnice编辑器"><p>The intersection of marker genes was selected based on strong population specificity (adj_p &lt; 0.05 &amp; |avg_log2FoldChange| &gt; 1.5 &amp; pct.1 &gt; 0.5 &amp; pct.2 &lt; 0.5) from each cell subgroup and factors related to OS responses.</p></blockquote><p data-tool="mdnice编辑器">sce.all是seurat+singleR得出的对象，markers是findallmarkers得到的数据框。</p><pre data-tool="mdnice编辑器"><span></span><code>load(<span>"sce.all.Rdata"</span>)<br>load(<span>"makers.Rdata"</span>)<br>k = markers<span>$p_val_adj</span> &lt; 0.05 &amp; <br>  abs(markers<span>$avg_log2FC</span>) &gt; 1.5 &amp; <br>  markers<span>$pct</span>.1 &gt; 0.5 &amp; <br>  markers<span>$pct</span>.2 &lt; 0.5<br>table(k)<br><br><span>## k</span><br><span>## FALSE  TRUE </span><br><span>## 13100  1483</span><br><br>gi = intersect(markers[k,<span>"gene"</span>],rosgene) <br>gi = factor(gi,levels = gi)<br>library(Seurat)<br>DotPlot(sce.all,features = gi,cols = <span>"RdYlBu"</span>,<br>        group.by = <span>"RNA_snn_res.0.5"</span>)+RotatedAxis()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHomrTsZSemUEfJ373JnKJVobYtBfaghPQjZ8QDZGpIQs0ae4LJuq2Kp6Ljr6GN283qwM74ibL7cwiaA/640?wx_fmt=jpeg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHomrTsZSemUEfJ373JnKJVobYtBfaghPQjZ8QDZGpIQs0ae4LJuq2Kp6Ljr6GN283qwM74ibL7cwiaA/640?wx_fmt=jpeg"></figure><p data-tool="mdnice编辑器">AUCell用于计算每个细胞中特定基因集的活性程度。用上面的gi作为基因集来计算。</p><p data-tool="mdnice编辑器">AUCell的三个步骤:</p><p data-tool="mdnice编辑器">Build the rankings：矩阵中的每个细胞里，给基因进行排序</p><p data-tool="mdnice编辑器">Calculate the Area Under the Curve (AUC)：计算每个细胞的AUC值</p><p data-tool="mdnice编辑器">Set the assignment thresholds：计算活性区分的阈值</p><pre data-tool="mdnice编辑器"><span></span><code>library(GSEABase)<br>geneSets &lt;- GeneSet(as.character(gi), setName=<span>"ROS"</span>)<br>geneSets<br><br><span>## setName: ROS </span><br><span>## geneIds: ACP5, SOD3, ..., PMAIP1 (total: 32)</span><br><span>## geneIdType: Null</span><br><span>## collectionType: Null </span><br><span>## details: use 'details(object)'</span><br><br>library(AUCell)<br>exprMatrix = sce.all@assays<span>$RNA</span>@data<br>cells_rankings &lt;- AUCell_buildRankings(exprMatrix)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHomrTsZSemUEfJ373JnKJVoCSc9mlcEsvAiaSkPAFRdsNVPGffVuRZsqs6PqOeA2kaH14ohyppTL2w/640?wx_fmt=jpeg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHomrTsZSemUEfJ373JnKJVoCSc9mlcEsvAiaSkPAFRdsNVPGffVuRZsqs6PqOeA2kaH14ohyppTL2w/640?wx_fmt=jpeg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>##  min   1%   5%  10%  50% 100% </span><br><span>##  474  716  794  859 1409 5996</span><br><br>cells_AUC &lt;- AUCell_calcAUC(geneSets, cells_rankings)<br>set.seed(333)<br>cells_assignment &lt;- AUCell_exploreThresholds(cells_AUC, plotHist=TRUE, assign=TRUE) <br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHomrTsZSemUEfJ373JnKJVohOTQPZicAqNyCkYEGENH884D82Sp8bUia9ndyS2uYEcCiaiaafAuZPMBWg/640?wx_fmt=jpeg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHomrTsZSemUEfJ373JnKJVohOTQPZicAqNyCkYEGENH884D82Sp8bUia9ndyS2uYEcCiaiaafAuZPMBWg/640?wx_fmt=jpeg"></figure><pre data-tool="mdnice编辑器"><span></span><code>auc_thr = cells_assignment<span>$ROS</span><span>$aucThr</span><span>$selected</span><br>auc_thr<br><br><span>##       L_k2 </span><br><span>## 0.07917315</span><br></code></pre><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>3.FeaturePlot可视化</span><span><span> </span></span></h4><p data-tool="mdnice编辑器">标准版：</p><pre data-tool="mdnice编辑器"><span></span><code>library(Seurat)<br>a = as.numeric(getAUC(cells_AUC))<br>sce.all<span>$auc_score</span> = a<br>FeaturePlot(sce.all,features = <span>"auc_score"</span>) <br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHomrTsZSemUEfJ373JnKJVoxibqCZY3EHgFULl7lpCv2HKx6ZDDfxxN8ic1I3SqeftJuYk75GQh4K1A/640?wx_fmt=jpeg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHomrTsZSemUEfJ373JnKJVoxibqCZY3EHgFULl7lpCv2HKx6ZDDfxxN8ic1I3SqeftJuYk75GQh4K1A/640?wx_fmt=jpeg"></figure><p data-tool="mdnice编辑器">定制版：</p><pre data-tool="mdnice编辑器"><span></span><code>dat&lt;- data.frame(sce.all@meta.data, <br>                sce.all@reductions<span>$umap</span>@cell.embeddings,<br>                sce.all@active.ident)<br>colnames(dat)[ncol(dat)] = <span>"seurat_annotation"</span><br>class_avg &lt;- dat %&gt;%<br>  group_by(seurat_annotation) %&gt;%<br>  summarise(<br>    UMAP_1 = median(UMAP_1),<br>    UMAP_2 = median(UMAP_2)<br>  )<br><br>library(ggpubr)<br>ggplot(dat, aes(UMAP_1, UMAP_2))  +<br>  geom_point(aes(colour  = auc_score)) + viridis::scale_color_viridis(option=<span>"A"</span>) +<br>  ggrepel::geom_label_repel(aes(label = seurat_annotation),<br>                            data = class_avg,<br>                            label.size = 0,<br>                            segment.color = NA)+<br>  theme(legend.position = <span>"none"</span>) + theme_bw()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHomrTsZSemUEfJ373JnKJVo31FkpyFFs308j2YcgiaAoALeiaoAVUrG77wIthnrLda4pqgC8ZPsYyRg/640?wx_fmt=jpeg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHomrTsZSemUEfJ373JnKJVo31FkpyFFs308j2YcgiaAoALeiaoAVUrG77wIthnrLda4pqgC8ZPsYyRg/640?wx_fmt=jpeg"></figure><p>https://www.jianshu.com/p/2fb20f44da67</p><pre data-tool="mdnice编辑器"><span></span><code>dat<span>$auc_group</span> = ifelse(dat<span>$auc_score</span>&gt;auc_thr,<span>"active"</span>,<span>"non_active"</span>)</code></pre><hr><h4 data-tool="mdnice编辑器"><span>4.活跃和不活跃组的细胞比例条形图</span><span><span> </span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>ggplot(dat,aes(auc_group,fill = seurat_annotation))+<br>  geom_bar(position = <span>"fill"</span>, alpha = 0.9)+<br>  scale_fill_brewer(palette = <span>"Set1"</span>)+<br>  theme_classic()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHomrTsZSemUEfJ373JnKJVoVanmcEowzycc7nFJ2TGibsPeDx20Xp07sCibr95045jx6RMjomol8nYg/640?wx_fmt=jpeg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHomrTsZSemUEfJ373JnKJVoVanmcEowzycc7nFJ2TGibsPeDx20Xp07sCibr95045jx6RMjomol8nYg/640?wx_fmt=jpeg"><span></span></figure></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><figure data-tool="mdnice编辑器"></figure></section><section><blockquote><section><span>如果因为代码看不懂，而跟不上正文的节奏，可以来找我，系统学习。我的</span><span>课程都是循环开课。</span><span>下一期的时间，点进去咨询微信咯</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247493194&amp;idx=1&amp;sn=5ddfe9dc5c0096c64364fbcd824fa4e6&amp;chksm=fdfbae08ca8c271eb1808717502255c15754e35832f04d374cf7e6bd25783407fa1f80a35fc1&amp;scene=21#wechat_redirect" textvalue="新的一年，你要不要来找我们学习‍生信" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">新的一年，你要不要来找我<span>‍</span>们学习生信</a><br></section></blockquote></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/s2hDgR3X78OWqAnsfy6kDQ",target="_blank" rel="noopener noreferrer">原文链接</a>
