---
title: "SoupX——去除RNA污染"
date: 2023-07-09T15:10:27Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
SoupX——去除RNA污染 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span>❝</span><p>在处理一组单细胞转录组测序数据的过程中，发现数据可能有环境污染，然后曾老师就建议我使用SoupX这个包来去除环境污染。为什么要处理环境污染呢？</p><p>由于在处理细胞样品的时候需要用到机械解离或者酶解的步骤，所以免不了会造成细胞的破裂同时产生环境污染。</p><span>❞</span></blockquote><p data-tool="mdnice编辑器">下面我将会从两方面来解析一下。</p><h4 data-tool="mdnice编辑器"><span></span>文献角度：<span></span></h4><figure data-tool="mdnice编辑器"><img data-ratio="0.5705794947994056" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibEgDHfnwwYGbjDsWPeIz8bTKPrKic9F4fkMJ2OsSNaF0INLDvoxPTq8S9K2xU0GFVBgf45lgA7llg/640?wx_fmt=png" data-type="png" data-w="673" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibEgDHfnwwYGbjDsWPeIz8bTKPrKic9F4fkMJ2OsSNaF0INLDvoxPTq8S9K2xU0GFVBgf45lgA7llg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">其实对于这篇文献经过查找资料发现在B站上已经有up主详细讲解了一下这篇文献。即下面这个链接出自 <strong>「Closer_初心依旧」</strong></p><p data-tool="mdnice编辑器">https://www.bilibili.com/video/BV1Zs4y1J7dZ/?spm_id_from=333.337.search-card.all.click</p><p data-tool="mdnice编辑器"><strong>「因此我在这里就简要的介绍一下文献的摘要和用到的算法。」</strong></p><p data-tool="mdnice编辑器"><strong>「摘要：」</strong></p><p data-tool="mdnice编辑器">背景：基于液滴的单细胞RNA序列分析假定所有获得的RNA都是细胞内源性的。然而，输入溶液中包含的任何无细胞的RNA也被这些测定所捕获。这种无细胞RNA的测序构成了一种背景污染，混淆了单细胞转录组数据的生物学解释。</p><p data-tool="mdnice编辑器">结果：文章中证明，来自这种无细胞RNA的 "soup "的污染是无处不在的，其组成和程度有实验上的特定变化。所以提出了一种方法，<strong>「SoupX」</strong>，用于量化污染的程度和估计 "背景校正 "的细胞表达谱，与现有的下游分析工具无缝整合。将这种方法应用于使用多种液滴测序技术的几个数据集，我们证明它的应用改善了对其他误导性数据的生物学解释，同时也改善了质量控制指标。</p><p data-tool="mdnice编辑器">结论：因此文章中提出了SoupX，一种用于从基于液滴的单细胞RNA测序实验中去除环境RNA污染的工具。</p><p data-tool="mdnice编辑器"><strong>「算法原理：」</strong><img data-ratio="0.37906647807637905" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibEgDHfnwwYGbjDsWPeIz8b36FialJVRVVYeuSqWEMOXgRR2AaZic5jgRm93Q6BCAuE864e9UcE2hHA/640?wx_fmt=png" data-type="png" data-w="707" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibEgDHfnwwYGbjDsWPeIz8b36FialJVRVVYeuSqWEMOXgRR2AaZic5jgRm93Q6BCAuE864e9UcE2hHA/640?wx_fmt=png">计算估计空液滴中RNA表达量；计算污染比例（即每个细胞受到污染的比例有多少）；之后对返回的数据做一个矫正，这里注意返回的矩阵中数据并不是整数，但是作者并不推荐对数据取整。</p><h4 data-tool="mdnice编辑器"><span></span>下面让我参考官方文档来对我的数据进行去除污染<span></span></h4><p data-tool="mdnice编辑器">https://rawcdn.githack.com/constantAmateur/SoupX/204b602418df12e9fdb4b68775a8b486c6504fe4/inst/doc/pbmcTutorial.html</p><p data-tool="mdnice编辑器">官方文档中使用的是 PBMC dataset 的数据，这里我用自己的数据试一下。</p><h4 data-tool="mdnice编辑器"><span></span>代码角度：<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br><span>#devtools::instsc_github("constantAmateur/SoupX",ref='devel')</span><br><span>library</span>(SoupX)<br><span>library</span>(Seurat)<br><span>library</span>(DropletUtils)<br><br>getwd()<br><span>#使用之前保存的数据</span><br> <span>#全矩阵，未经过QC的数据</span><br>load(<span>"./sce.all_counts.Rdata"</span>)<br><span>#经过QC过的数据</span><br>sce.all_filter&lt;-readRDS(<span>"./2-harmony/sce.all_int.rds"</span>)<br><span># table(sce.all$orig.ident)</span><br><span># table(sce.all_filter$orig.ident)</span><br><br>tod&lt;-sce.all@assays$RNA@counts  <span>#全矩阵</span><br>toc&lt;-sce.all_filter@assays$RNA@counts <span>#经过QC过的矩阵</span><br><br><span>#保证基因名一致</span><br>tod &lt;- tod[rownames(toc),]<br><br><span>##SoupX帮助文档建议提供分析矩阵的聚类亚群分组，因此这里利用分析矩阵做一个简单聚类</span><br>all &lt;- toc<br>all &lt;- CreateSeuratObject(all)<br>all &lt;- NormalizeData(all, normalization.method = <span>"LogNormalize"</span>, scale.factor = <span>10000</span>)<br>all &lt;- FindVariableFeatures(all, selection.method = <span>"vst"</span>, nfeatures = <span>3000</span>)<br>all.genes &lt;- rownames(all)<br>all &lt;- ScaleData(all, features = all.genes)<br>all &lt;- RunPCA(all, features = VariableFeatures(all), npcs = <span>40</span>, verbose = <span>F</span>)<br>all &lt;- FindNeighbors(all, dims = <span>1</span>:<span>20</span>)<br>all &lt;- FindClusters(all, resolution = <span>0.5</span>)<br>all &lt;- RunUMAP(all, dims = <span>1</span>:<span>20</span>)<br><span>#提取聚类后的meta.data信息</span><br>matx &lt;- all@meta.data<br><br><span>#这里可以参考官方文档的步骤</span><br><span>#第一种方法计算</span><br><span>#sc = SoupChannel(tod, toc, calcSoupProfile = FALSE)</span><br><span>#sc = estimateSoup(sc)</span><br><br><span>#通常情况下，不自动运行 estimateSoup 的唯一原因是你想改变默认参数或者用其他方式来计算"soup"的轮廓。</span><br><span>#有一种情况下，你可能想做后者，那就是你只有计数表，而没有空液滴。在这种情况下，可运行下面的代码。</span><br><br><span>#第二种方法计算</span><br><span>library</span>(Matrix)<br>toc = sc$toc<br>scNoDrops = SoupChannel(tod, toc, calcSoupProfile = <span>FALSE</span>)<br><span># Calculate soup profile</span><br>soupProf = data.frame(row.names = rownames(toc), est = rowSums(toc)/sum(toc), counts = rowSums(toc))<br>scNoDrops = setSoupProfile(scNoDrops, soupProf)<br><br>sc&lt;-scNoDrops<br>sc = setClusters(sc, setNames(matx$seurat_clusters, rownames(matx)))<br>sc = setContaminationFraction(sc, <span>0.2</span>)<br>sc = autoEstCont(sc)<br><br><span>#校正矩阵</span><br>out = adjustCounts(sc)<br><span>#保存两个矩阵文件</span><br>saveRDS(sc,<span>"sc.rds"</span>)<br><br><span>#保存校正后的矩阵，输出为10X格式</span><br>DropletUtils:::write10xCounts(<span>"./"</span>,out,version=<span>"3"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5285714285714286" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibEgDHfnwwYGbjDsWPeIz8bMQSPEglsjbpqvYRY4xfSVbB0HeguKecL0QTaPrRb8UH0OTCMNTTXhg/640?wx_fmt=png" data-type="png" data-w="700" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibEgDHfnwwYGbjDsWPeIz8bMQSPEglsjbpqvYRY4xfSVbB0HeguKecL0QTaPrRb8UH0OTCMNTTXhg/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(SoupX)<br>sc=readRDS(<span>"./sc.rds"</span>)<br><span>#校正矩阵</span><br>out = adjustCounts(sc)<br><span>#加载R包</span><br><span>library</span>(Seurat)<br><span>library</span>(harmony)<br><span>library</span>(ggsci)<br><span>library</span>(dplyr) <br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(data.table)<br><span>library</span>(dplyr)<br><span>library</span>(ggplot2)<br><span>library</span>(patchwork)<br><span>library</span>(stringr)<br><span>#重新读取数据，再降维分群看看数据有什么区别~</span><br>srat = CreateSeuratObject(out)<br><br>table(srat$orig.ident)<br><span>library</span>(harmony)<br>sp=<span>'human'</span><br>getwd()<br><span>###### step3: harmony整合多个单细胞样品 ######</span><br>dir.create(<span>"2-harmony-2"</span>)<br>getwd()<br>setwd(<span>"2-harmony-2"</span>)<br><span>#重新降维分群</span><br><span>source</span>(<span>'../scRNA_scripts/harmony.R'</span>)<br>sce.all.int = run_harmony(srat)<br>setwd(<span>'../'</span>)<br><br><span>#用FeaturePlot去看一下SoupX去除前后的效果</span><br>FeaturePlot(sce.all.int,features = <span>"S100A9"</span>)<br>FeaturePlot(sce.all_filter,features = <span>"S100A9"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.1938202247191012" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibEgDHfnwwYGbjDsWPeIz8buTfCU8cnibQkj0SnlSwA1UQk3TjL34r3xX2o99CfIj8PibCfP3ibJcApQ/640?wx_fmt=png" data-type="png" data-w="356" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibEgDHfnwwYGbjDsWPeIz8buTfCU8cnibQkj0SnlSwA1UQk3TjL34r3xX2o99CfIj8PibCfP3ibJcApQ/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><span>❝</span><p>由于单细胞转录组测序数据有很多的技术差异，即使在完成去除污染的步骤后，可能也不会对数据有什么影响。如果你的数据在处理样品上机的时候细胞碎片过多，也可以试试用这个R包<strong>「SoupX」</strong>去除污染。</p><span>❞</span></blockquote><h4 data-tool="mdnice编辑器"><span></span>harmony.R代码<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>run_harmony &lt;- <span>function</span>(input_sce){<br>  input_sce&lt;-srat<br>  <span>#print(dim(input_sce))</span><br>  input_sce &lt;- NormalizeData(input_sce, <br>                             normalization.method = <span>"LogNormalize"</span>,<br>                             scale.factor = <span>1e4</span>) <br>  input_sce &lt;- FindVariableFeatures(input_sce)<br>  input_sce &lt;- ScaleData(input_sce)<br>  input_sce &lt;- RunPCA(input_sce, features = VariableFeatures(object = input_sce))<br>  seuratObj &lt;- RunHarmony(input_sce, <span>"orig.ident"</span>)<br>  names(seuratObj@reductions)<br>  seuratObj &lt;- RunUMAP(seuratObj,  dims = <span>1</span>:<span>15</span>, <br>                       reduction = <span>"harmony"</span>)<br>  <br>  <span># p = DimPlot(seuratObj,reduction = "umap",label=T ) </span><br>  <span># ggsave(filename='umap-by-orig.ident-after-harmony',plot = p)</span><br>  <br>  input_sce=seuratObj<br>  input_sce &lt;- FindNeighbors(input_sce, reduction = <span>"harmony"</span>,<br>                             dims = <span>1</span>:<span>15</span>) <br>  input_sce.all=input_sce<br>  <br>  <span>#设置不同的分辨率，观察分群效果(选择哪一个？)</span><br>  <span>for</span> (res <span>in</span> c(<span>0.01</span>, <span>0.05</span>, <span>0.1</span>, <span>0.2</span>, <span>0.3</span>, <span>0.5</span>,<span>0.8</span>,<span>1</span>)) {<br>    input_sce.all=FindClusters(input_sce.all, <span>#graph.name = "CCA_snn", </span><br>                               resolution = res, algorithm = <span>1</span>)<br>  }<br>  colnames(input_sce.all@meta.data)<br>  apply(input_sce.all@meta.data[,grep(<span>"RNA_snn"</span>,colnames(input_sce.all@meta.data))],<span>2</span>,table)<br>    <br>  table(input_sce.all@active.ident) <br>  saveRDS(input_sce.all, <span>"sce.all_int.rds"</span>)<br>  <span>return</span>(input_sce.all)<br>  <br>}<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>微信交流群</span><span></span></h3><p data-tool="mdnice编辑器">如果你也想参与到群里的讨论中，给我提出一些推文更新建议的话欢迎入群。同时你也可以得到我前期更新的所有数据及代码，在群里我会把代码分享给大家，而且大家可以在群里<strong>「「提出自己感兴趣的单细胞文献」」</strong>我们尽可能优先选择大家的数据集去复现和实战，也欢迎大家在群里分享更多其它资料，咱们一起进步，<strong>「「比较高级的单细胞分析」」</strong>我们也会一起尝试， 相信你肯定是会不虚此行哈。</p><p data-tool="mdnice编辑器">附上之前推文的链接 <a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512238&amp;idx=1&amp;sn=e0c6dc2ea0e089aabb78133e50fb5d7f&amp;scene=21#wechat_redirect" data-linktype="2">为爱发电不可取（单细胞周更需要你的支持）</a></p><p data-tool="mdnice编辑器">我们这个群是真正的付费交流群，不仅提供数据，代码，学习资料，而且也会跟大家互动交流，还会坚持进行创作至少一年。</p><p data-tool="mdnice编辑器"><strong>「「目前群里已经有200多人，所以你想要进群的话就需要添加我的微信，私聊给我发99元的红包，我把你拉进群里。」」</strong></p><p data-tool="mdnice编辑器">是真正的付费交流群，因为提供数据，代码，学习资料，并且跟大家互动交流，而且会坚持进行创作至少一年。所以，如果介意99元的门槛且不认可我们知识分享的理念，<strong>「请不要加我好友」</strong>。</p><figure data-tool="mdnice编辑器"><img data-ratio="1.0161943319838056" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibEgDHfnwwYGbjDsWPeIz8bWSPJc8ju3GI4kVfnhNt5r0HuG6iaO7md2AU5yj4Vm0nXL521pepLdIA/640?wx_fmt=png" data-type="png" data-w="247" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibEgDHfnwwYGbjDsWPeIz8bWSPJc8ju3GI4kVfnhNt5r0HuG6iaO7md2AU5yj4Vm0nXL521pepLdIA/640?wx_fmt=png"></figure></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/WkQybMNNM0ziM7HcWNR_tg",target="_blank" rel="noopener noreferrer">原文链接</a>
