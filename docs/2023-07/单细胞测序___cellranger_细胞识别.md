---
title: "单细胞测序 | cellranger 细胞识别"
date: 2023-07-17T13:48:29Z
draft: ["false"]
tags: [
  "fetched",
  "生信控"
]
categories: ["Acdemic"]
---
单细胞测序 | cellranger 细胞识别 by 生信控
------
<div><p><img data-ratio="0.15625" data-src="https://mmbiz.qpic.cn/mmbiz_gif/GXnBwOcM857kicu3mN7sf73m53xRalJjvkd6jjlWBRqHTic97up9smWS7lZjB6py0O5l0hus3g6lyiaCBdc6fCkcQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-w="640" src="https://mmbiz.qpic.cn/mmbiz_gif/GXnBwOcM857kicu3mN7sf73m53xRalJjvkd6jjlWBRqHTic97up9smWS7lZjB6py0O5l0hus3g6lyiaCBdc6fCkcQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></p><p><span>对于细胞识别，cellranger v3.0 及以上版本使用 </span><span>EmptyDrops</span><span> 算法 (Lun et al., 2019)，在保留高RNA含量细胞的同时，能更好地将低RNA含量的细胞与空细胞(/GEMs)区分开来并保留。在经过算法过滤后，即得到 filtered_feature_bc_matrix 。</span><br></p><p>虽然算法有升级，但对于特定情况，如中性粒细胞，由于其RNA表达偏低，算法仍没办法将其与背景有效区分，导致中性粒细胞检出偏少，或进一步导致总细胞数少于预期：</p><blockquote><p>This is because the RNA profile of neutrophils is more similar to the background (low UMI, low gene count) and the cell calling algorithm cannot readily distinguish between the neutrophils and background.</p></blockquote><p>详见：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNzk1NjUxOA==&amp;mid=2247485534&amp;idx=1&amp;sn=efb394aebe82b57bc619b4997c8dfba5&amp;chksm=e8580a17df2f8301d1c6d96ab547f08c476aeb6593e6c0bd8340dba14bc5a093d5fd8f9e7eec&amp;scene=21#wechat_redirect" textvalue="单细胞测序 | 中性粒细胞检不出怎么办？" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞测序 | 中性粒细胞检不出怎么办？</a></p><p>所以，当 cellranger 分析出的细胞数与预期不一致（也可通过 web 文件中的 Barcode Rank Plot 查看）时：</p><blockquote><p>In some cases <strong>the set of barcodes called as cells may not match the desired set of barcodes based on visual inspection</strong>[☞ barcode rank plot]. This can be remedied by either re-running count or reanalyze with the <strong><span>--force-cells</span></strong> option, or by <strong>selecting the desired barcodes from the raw feature-barcode matrix</strong> in downstream analysis.</p></blockquote><p>提供2种解决思路：</p><p><strong>方法1、设置 <code>--force-cells</code> 参数</strong></p><blockquote><p><code>--force-cells</code> <span>Optional.</span> Force pipeline to use this number of cells, <strong>bypassing the cell detection algorithm</strong>.</p></blockquote><p>可以通过 <code>cellranger count</code>，由于是从 FASTQs 重跑，故相当耗时，也可以通过 <code>cellranger reanalyze</code>，由于是直接从表达矩阵开始，故执行快速（几分钟即可完成），但是生成的 web_summary.html 信息相比 <code>cellranger count</code> 缺失较多，如下：</p><figure><img data-ratio="0.45507246376811594" data-src="https://mmbiz.qpic.cn/mmbiz_png/GXnBwOcM854u1LnM8ic4Uwgz3G3faaWNsz8ZxZme3Pibibo1KxV3YvkkMoOQpDtQHWwYBCPXtVMPn4ziaGiawOjCDpQ/640?wx_fmt=png" data-type="png" data-w="1035" title="null" src="https://mmbiz.qpic.cn/mmbiz_png/GXnBwOcM854u1LnM8ic4Uwgz3G3faaWNsz8ZxZme3Pibibo1KxV3YvkkMoOQpDtQHWwYBCPXtVMPn4ziaGiawOjCDpQ/640?wx_fmt=png"></figure><p>但核心内容，force 后的 filtered_feature_bc_matrix 表达矩阵是一致的：</p><pre><code>library(Seurat)<br><br><span>## 比较 count 和 reanalyze 的结果</span><br>data_count_force = Read10X(<span>"/path/to/count_force/outs/filtered_feature_bc_matrix"</span>)<br><span>dim</span>(data_count_force)<br>data_reanalyze_force = Read10X(<span>"/path/to/reanalyze_force/outs/filtered_feature_bc_matrix"</span>)<br><span>dim</span>(data_reanalyze_force)<br><br><span># identical 判断2个对象是否一样</span><br>identical(data_reanalyze, data_force)  <span># [1] TRUE</span></code></pre><p><strong><span>方法2、直接对原始表达矩阵（raw feature-barcode matrix）进行处理</span></strong><span></span><br></p><p>force 本质上是对原始表达矩阵的过滤，即在最终表达矩阵中保留N个（ <code>--force-cells=N</code> ）细胞，选择保留N个细胞，最简单的方法或许就是按检测到的UMI表达量从高到低，将细胞排序，并取TopN，如下：</p><pre><code>library(Seurat)<br><br><span>## 从 raw 进行 force</span><br>data_raw = Read10X(<span>"/path/to/outs/raw_feature_bc_matrix"</span>)<br><span>dim</span>(data_raw)<br><span># 每个细胞中检测到的 UMI counts</span><br>ExpPerCell = colSums(data_raw)<br><span># N设置为要force的细胞数</span><br>force_cells = <span>names</span>(tail(sort(ExpPerCell), N))  <span># 排序，取TopN</span><br>setdiff(colnames(data_force), force_cells)  <span># 与 cellranger force 后的细胞一致</span></code></pre><p>经过上示测试，细胞选择<span>的</span>方法确实如我们猜测...，也找到了官方证明：</p><blockquote><p>When samples contain <strong>a high dynamic range of RNA content</strong>, 10X Genomics suggests to use the <code>--force-cells</code>. Essentially this method <strong>orders cells according to total UMI</strong> content and then keeps <strong>the highest <code>N</code> cells</strong>.</p></blockquote><blockquote><p>Add <code>--force-cells</code> option to <code>count</code> and <code>reanalyze</code> to explicitly set the cell count. If specified, Cell Ranger will take the top N barcodes (by UMI count) as cells <strong>instead of doing dynamic cell count estimation</strong>.</p></blockquote><p><span>https://support.10xgenomics.com/single-cell-gene-expression/software/release-notes/2-0</span></p><p>可见，如果设置了 <code>--force-cells</code> 参数就意味着放弃了默认使用的 EmptyDrops 算法，转而直接取TopN表达的细胞。</p><p>这里需要注意，由于可能存在多个具有相同UMI值的细胞，故N选择哪个，取决于排序结果。</p><p>方法2的优势在于，在R中的实现更加灵活，便于衔接后续分析，无需再调用cellranger，也不会产生一堆可能不需要的文件，接seurat标准分析前，先取子集：</p><pre><code>data = CreateSeuratObject(counts = data_raw)<br>data = subset(data, cells = force_cells) <span># force后的细胞</span><br><span>dim</span>(data)</code></pre><section data-darkmode-bgcolor="rgb(36, 36, 36)"><section data-darkmode-bgcolor="rgb(36, 36, 36)"><img data-ratio="0.3208955223880597" data-type="gif" data-w="134" width="4em" data-src="https://mmbiz.qpic.cn/mmbiz_gif/GXnBwOcM854H437mZXWZCJTqTQZhyDcYEQ1bk43JRXIlfjwwevW2rqZ8vibL9sSVlToSrLNtSjpJqxkHic4E8UAg/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" src="https://mmbiz.qpic.cn/mmbiz_gif/GXnBwOcM854H437mZXWZCJTqTQZhyDcYEQ1bk43JRXIlfjwwevW2rqZ8vibL9sSVlToSrLNtSjpJqxkHic4E8UAg/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section><section data-darkmode-bgcolor="rgb(36, 36, 36)"><br data-darkmode-bgcolor="rgb(36, 36, 36)"></section></section><section data-darkmode-bgcolor="rgb(36, 36, 36)"><br></section><section data-tools="135编辑器" data-id="93199" data-darkmode-bgcolor="rgb(36, 36, 36)" data-style='white-space: normal; max-width: 100%; box-sizing: border-box; background-color: rgb(255, 255, 255); color: rgba(255, 255, 255, 0.8); font-family: -apple-system-font, system-ui, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif; letter-spacing: 0.544px; border-width: 0px; border-style: none; border-color: initial; overflow-wrap: break-word !important;'><section><section data-darkmode-bgcolor="rgb(36, 36, 36)"><section data-darkmode-bgcolor="rgb(36, 36, 36)"><section data-darkmode-bgcolor="rgb(36, 36, 36)" data-style="margin-left: 5px; padding-right: 15px; padding-left: 15px; max-width: 100%; box-sizing: border-box; border-color: rgb(0, 0, 0); border-width: 1px; border-style: solid; background: rgb(255, 181, 2); display: inline-block; font-size: 12px; overflow-wrap: break-word !important;"><p data-darkmode-bgcolor="rgb(36, 36, 36)"><span data-darkmode-bgcolor="rgb(36, 36, 36)">绘图系列·往期精彩</span></p></section></section></section></section><section data-darkmode-bgcolor="rgb(36, 36, 36)" data-darkmode-color="rgb(167, 167, 167)" data-style="margin-top: -5.5px; padding: 1em 0.8em; max-width: 100%; box-sizing: border-box; border-color: rgb(0, 0, 0); font-size: 14px; letter-spacing: 1.5px; line-height: 1.75em; border-width: 1px; border-style: solid; overflow-wrap: break-word !important;"><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNzk1NjUxOA==&amp;mid=2247485476&amp;idx=1&amp;sn=19338ab7883f1369fc60f7b99b2b7d04&amp;chksm=e8580a6ddf2f837bad80bdcabb4de23f4b4552ab78b3652492099dc3188806f831633c10fb67&amp;scene=21#wechat_redirect" textvalue="单细胞测序 | RNA速率分析(scVelo)是个老大难" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">单细胞测序 | RNA速率分析(scVelo)是个老大难</a><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNzk1NjUxOA==&amp;mid=2247485430&amp;idx=1&amp;sn=e72993461ae8a9c7321e843fc1a68303&amp;chksm=e85805bfdf2f8ca9a2b445e7177c4634b6730e9f627755c1a9eeebab65bc883da98937976923&amp;scene=21#wechat_redirect" textvalue="单细胞测序 | marker基因列表怎么找？" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">单细胞测序 | marker基因列表怎么找？</a><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNzk1NjUxOA==&amp;mid=2247485489&amp;idx=1&amp;sn=0eb427bc184e513f04bb3d1328d01847&amp;chksm=e8580a78df2f836e70365148daae4d0fb2796ad4334d9b34d68dd2daffaefb31f9f6d8dab1ad&amp;scene=21#wechat_redirect" textvalue="单细胞测序 | 10X单细胞PBMC数据哪里找？" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">单细胞测序 | 10X单细胞PBMC数据哪里找？</a><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNzk1NjUxOA==&amp;mid=2247485577&amp;idx=1&amp;sn=fd06cc38190d9cc4624d42504c841575&amp;chksm=e8580ac0df2f83d65dbc2bba62d7aa476ad450afcbd46258702ffc356edf99af5271ef426110&amp;scene=21#wechat_redirect" textvalue="单细胞测序 | cellranger 确实慢..." linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞测序 | cellranger 确实慢...</a><br></section></section></section><section><br></section><section><img data-ratio="0.593939393939394" data-src="https://mmbiz.qpic.cn/mmbiz_png/GXnBwOcM854H437mZXWZCJTqTQZhyDcYqmIeAAMEcFe5NZQ9YmGwbRQibdWzd6P26ibllZtaVzicc5IzBj9ibW2xqA/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="jpeg" data-w="825" src="https://mmbiz.qpic.cn/mmbiz_png/GXnBwOcM854H437mZXWZCJTqTQZhyDcYqmIeAAMEcFe5NZQ9YmGwbRQibdWzd6P26ibllZtaVzicc5IzBj9ibW2xqA/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/-kmB050MJdazzIU-ueadsw",target="_blank" rel="noopener noreferrer">原文链接</a>
