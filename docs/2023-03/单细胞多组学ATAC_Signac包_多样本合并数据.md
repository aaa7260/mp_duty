---
title: "单细胞多组学ATAC-Signac包-多样本合并数据"
date: 2023-03-24T08:24:20Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
单细胞多组学ATAC-Signac包-多样本合并数据 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span>写在前面</span><span></span><span> </span></h2><section>哦，上次写这块好像还是一年前，囧！好吧，忙里抽空，这个系列近期更新了，后面随缘再更新Signac包处理scATAC数据和scATAC+scRNA数据的一些事情吧。</section><h2 data-tool="mdnice编辑器"><span> </span><span>多样本合并处理的特殊性</span><span></span><span> </span></h2><section>今天接着之前<span>【</span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MzE4NDg5NQ==&amp;mid=2247484594&amp;idx=1&amp;sn=c3c8934481a13fa63a0d43ba57a174bc&amp;chksm=ce7d3622f90abf34d24b04bf113383ab18eab5ced9e0330e68bdf2dc1b602eaede98efbfa159&amp;scene=21#wechat_redirect" textvalue="单细胞多组学ATAC-Signac包-单样本10×单细胞数据质控" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞多组学ATAC-Signac包-单样本10×单细胞数据质控</span></a><span>】</span>往后继续说，单样本质控只是单个样本进行质控检测，让大家熟悉scATAC质控相关的函数和流程，真实情况下，一般都是多个样本的数据合并进行处理，因此在每个样本逐一质控检查前，一般需要将多个样本scATAC数据合并在一起，这个和Seurat处理scRNA数据有一点点不太一样的地方。 </section><section>不一样的原因：主要还是因为原先我们在进行peak calling 时候是cellranger ATAC软件 每个样本逐一进行的，意味着每个样本的peaks位置可能不是完全对齐（如下图）。</section><section>因此我们在合并多样本的peaks矩阵时候需要对peaks进行校准处理，由于peaks名称是按染色体+起始位置+终止位置命名的，若没有对齐，合并矩阵可能会存在很多异常问题。Signac包推荐使用 GenomicRanges包的方法，对不同样本peaks进行校准量化。这里有两种策略：<code>reduce</code>函数可以将所有相交的peaks进行合并<code>disjoin</code>函数则将创建不同的不重叠的peaks集。</section><figure data-tool="mdnice编辑器"><img data-ratio="0.4726443768996961" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLuFiawxJBxmzGvhiceicNB8VoicSjTLMcw1D8rMICWwNXB1cUoNnYbM2tFCJiaE3DLiafCE1tov9FNhGiapg/640?wx_fmt=png" data-type="png" data-w="658" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLuFiawxJBxmzGvhiceicNB8VoicSjTLMcw1D8rMICWwNXB1cUoNnYbM2tFCJiaE3DLiafCE1tov9FNhGiapg/640?wx_fmt=png"><figcaption><br></figcaption></figure><h2 data-tool="mdnice编辑器"><span> </span><span></span><span>数据准备</span><span></span><span> </span></h2><pre data-tool="mdnice编辑器"><span></span><code><span># 500 cell</span><br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_500_nextgem/atac_pbmc_500_nextgem_fragments.tsv.gz<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_500_nextgem/atac_pbmc_500_nextgem_fragments.tsv.gz.tbi<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_500_nextgem/atac_pbmc_500_nextgem_peaks.bed<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_500_nextgem/atac_pbmc_500_nextgem_singlecell.csv<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_500_nextgem/atac_pbmc_500_nextgem_filtered_peak_bc_matrix.h5<br><br><span># 1k cell</span><br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_1k_nextgem/atac_pbmc_1k_nextgem_fragments.tsv.gz<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_1k_nextgem/atac_pbmc_1k_nextgem_fragments.tsv.gz.tbi<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_1k_nextgem/atac_pbmc_1k_nextgem_peaks.bed<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_1k_nextgem/atac_pbmc_1k_nextgem_singlecell.csv<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_1k_nextgem/atac_pbmc_1k_nextgem_filtered_peak_bc_matrix.h5<br><br><span># 5k cell</span><br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_5k_nextgem/atac_pbmc_5k_nextgem_fragments.tsv.gz<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_5k_nextgem/atac_pbmc_5k_nextgem_fragments.tsv.gz.tbi<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_5k_nextgem/atac_pbmc_5k_nextgem_peaks.bed<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_5k_nextgem/atac_pbmc_5k_nextgem_singlecell.csv<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_5k_nextgem/atac_pbmc_5k_nextgem_filtered_peak_bc_matrix.h5<br><br><span># 10k cell</span><br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_10k_nextgem/atac_pbmc_10k_nextgem_fragments.tsv.gz<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_10k_nextgem/atac_pbmc_10k_nextgem_fragments.tsv.gz.tbi<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_10k_nextgem/atac_pbmc_10k_nextgem_peaks.bed<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_10k_nextgem/atac_pbmc_10k_nextgem_singlecell.csv<br>wget https://cf.10xgenomics.com/samples/cell-atac/1.1.0/atac_pbmc_10k_nextgem/atac_pbmc_10k_nextgem_filtered_peak_bc_matrix.h5<br></code></pre><p data-tool="mdnice编辑器"><br></p><p data-tool="mdnice编辑器">这里说下：一般signac需要10×cellranger ATAC分析后的文件主要是：</p><ul><li><p data-tool="mdnice编辑器">fragments.tsv.gz </p></li><li><p data-tool="mdnice编辑器">fragments.tsv.gz.tbl </p></li><li><p data-tool="mdnice编辑器">peaks.bedsinglecell.csv </p></li><li><p data-tool="mdnice编辑器">filtered_peak_bc_matrix.h5 </p></li></ul><section>关于这些文件介绍在之前<span> 【</span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MzE4NDg5NQ==&amp;mid=2247484667&amp;idx=1&amp;sn=92ebee99040b3b846478ecd80a185288&amp;chksm=ce7d366bf90abf7dbe4aa4be6501f9aa2644792129df2235e537fd66e3d158c74fab701cc4e1&amp;scene=21#wechat_redirect" textvalue="单细胞多组学ATAC-Cellranger ARC-结果解读之概述" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞多组学ATAC-Cellranger ARC-结果解读之概述</span></a><span>】</span>文章中有介绍。</section><h2 data-tool="mdnice编辑器"><span> </span><span>最佳实践</span><span></span><span> </span></h2><h3 data-tool="mdnice编辑器"><span></span>创建一个共有的peak set<span></span></h3><section>首先计算一个common peak set，这里写了一个简单的函数去处理bed文件：</section><section>处理的方法就是上面使用的<span>GenomicRanges包中的方法，纳入所有样本的bed文件进行校准overlap后，后面结合signac自身的<span>FeatureMatrix函数对每个样本的数据进行校准，这样merge合并后，数据相对准确些。</span></span></section><pre data-tool="mdnice编辑器"><span></span><code>library(Signac)<br>library(Seurat)<br>library(GenomicRanges)<br>library(future)<br><br>plan(<span>"multiprocess"</span>, workers = 4)<br>options(future.globals.maxSize = 50000 * 1024^2) <span># for 50 Gb RAM</span><br><br><br><span># 准备好各个样本的数据的路径文件夹</span><br>data &lt;- c(<span>""</span>,<span>""</span>,<span>""</span>,<span>""</span>)<br><span># 与data一一对应把每个样本名称准备下</span><br>sample &lt;- c(<span>"pbmc500"</span>,<span>"pbmc1k"</span>,<span>"pbmc5k"</span>,<span>"pbmc10k"</span>)<br><br>common_peak_set &lt;-  <span>function</span>(data,peakwidths.max=10000,peakwidths.min=20,mode=<span>"reduce"</span>){<br>    grlist &lt;- list()<br>    <span>for</span> (i <span>in</span> data){<br>        bed.file &lt;- list.files(path = i, pattern = <span>"*peaks.bed$"</span>, full.names = TRUE)<br>        beddata &lt;- read.table(<br>            file = bed.file,<br>            col.names = c(<span>"chr"</span>, <span>"start"</span>, <span>"end"</span>)<br>        )<br>        <span># convert to genomic ranges</span><br>        grlist[[i]] &lt;- makeGRangesFromDataFrame(beddata)<br>    }<br>    <span># Create a unified set of peaks to quantify in each dataset</span><br>    peak.ranges &lt;- Reduce(f = c, x = grlist)<br>    <span>if</span> (mode == <span>"reduce"</span>) {<br>        combined.peaks &lt;- GenomicRanges::reduce(x =peak.ranges)<br>    } <span>else</span> <span>if</span> (mode == <span>"disjoin"</span>) {<br>       combined.peaks &lt;- GenomicRanges::disjoin(x =peak.ranges)<br>    } <span>else</span> {<br>        stop(<span>"Unknown mode requested"</span>)<br>    }<br>    <br>    <span># Filter out bad peaks based on length</span><br>    peakwidths &lt;- width(combined.peaks)<br>    combined.peaks &lt;- combined.peaks[peakwidths  &lt; peakwidths.max &amp; peakwidths &gt; peakwidths.min] <br>    <span>return</span>(combined.peaks)<br>}<br><br>combined.peaks &lt;- common_peak_set(data)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.4942857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLuFiawxJBxmzGvhiceicNB8VoicNEmfccicuNzq7vNG3PVkD4DoVc4q3bdhzPd4wvicpXWHu0WDEzsxg0pA/640?wx_fmt=png" data-type="png" data-w="700" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLuFiawxJBxmzGvhiceicNB8VoicNEmfccicuNzq7vNG3PVkD4DoVc4q3bdhzPd4wvicpXWHu0WDEzsxg0pA/640?wx_fmt=png"><figcaption><br></figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>创建Seurat对象并多样本合并<span></span></h3><section>这里我自定义一个函数，帮助批量处理读取和创建Seurat对象，<span>其中参数：</span><span> </span></section><ul><li><section>data.dir 文件夹路径 </section></li><li><section>project 推荐使用样本命名 </section></li><li><section>combined.peaks 就是上面计算的common peak setpassed_filters 是一个参数，对于一些低质量细胞进行过滤，这里默认是500。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span># define a convenient function to load all the data and create a Seurat object</span><br>create_seurat_single &lt;- <span>function</span>(data.dir,project,combined.peaks,passed_filters=500) {<br>    fragment.file &lt;- list.files(path = data.dir, pattern = <span>"*fragments.tsv.gz$"</span>, full.names = TRUE)<br>    <span># load meatdata</span><br>    meta.file &lt;- list.files(path = data.dir, pattern = <span>"*singlecell.csv$"</span>, full.names = TRUE)<br>    metadata &lt;- read.table(<br>    file = meta.file,<br>    stringsAsFactors = FALSE,<br>    sep = <span>","</span>,<br>    header = TRUE,<br>    row.names = 1<br>    )[-1, ]<br><br>    <span># perform an initial filtering of low count cells</span><br>    metadata &lt;- metadata[metadata<span>$passed_filters</span> &gt; passed_filters, ] <br><br>    <span># create fragment objects</span><br>    fragmentdata &lt;- CreateFragmentObject(<br>    path = fragment.file,<br>    cells = rownames(metadata)<br>    )<br><br>    <span># Quantify peaks in each dataset</span><br>    counts &lt;- FeatureMatrix(<br>    fragments = fragmentdata,<br>    features = combined.peaks,<br>    cells = rownames(metadata)<br>    )<br><br>    <span># Create the objects</span><br>    assay &lt;- CreateChromatinAssay(counts, fragments = fragmentdata)<br>    rds &lt;- CreateSeuratObject(counts=assay, project =project,assay = <span>"ATAC"</span>, meta.data = metadata)<br>    <span># adding a cell ID to make sure cell names are unique</span><br>    rds &lt;- RenameCells(rds,add.cell.id = project)<br>    <span>return</span>(rds)<br>}<br><br>rdslist &lt;- list()<br><span>for</span> (i <span>in</span> 1:length(data)){<br> <span>print</span>(sample[i])<br>    rdslist[[i]] &lt;- create_seurat_single(data.dir=data[i],project=sample[i],combined.peaks,passed_filters=500)<br>}<br><br><span># merge all datasets</span><br>rds &lt;- rdslist[[1]]<br><span>for</span> (i <span>in</span> 2:length(rdslist)){<br>    rds &lt;- merge(rds,rdslist[[i]])<br>}<br></code></pre><p data-tool="mdnice编辑器"><br></p><p data-tool="mdnice编辑器">对这个函数每一步所用到的函数进行一定的介绍： </p><p data-tool="mdnice编辑器">第一个是读取metadata ，这是直接使用的 10X cellranger ATAC数据结果中的singlecell.csv文件，里面存储了每个细胞的一些数据指标信息。</p><p data-tool="mdnice编辑器">第二个是创建fragment objects这里使用的是CreateFragmentObject函数进行 </p><p data-tool="mdnice编辑器">这个对象以32-bit MD5 hash格式方法存储了fragment文件常用参数: <span></span></p><ul><li><p data-tool="mdnice编辑器">path  fragment文件路径 </p></li><li><p data-tool="mdnice编辑器">cells  你要提取的对应所需的cell barcode</p><p data-tool="mdnice编辑器"><span></span></p></li></ul><p data-tool="mdnice编辑器">第三个是对每个数据进行校准这里使用的是FeatureMatrix函数进行这个函数处理可能会比较慢，可以用future包设置多线程计算方法来压缩计算时间这个函数主要是根据提供的bed文件来创建feature矩阵。常用参数: <span></span></p><ul><li><p data-tool="mdnice编辑器">fragments 上面CreateFragmentObject函数返回的对象 </p></li><li><p data-tool="mdnice编辑器">features 我们之前common peak set 规整过的peaks setcells 是我们最终需要纳入分析的那些细胞的cell barcodes </p></li><li><p data-tool="mdnice编辑器">process_n 每个线程一次要加载到内存中的区域数。一次处理更多区域可能会更快，但会占用更多内存，默认是2000</p><p data-tool="mdnice编辑器"><br></p></li></ul><p data-tool="mdnice编辑器">第四个是创建ChromatinAssay对象这里使用的是CreateChromatinAssay函数进行常用参数: <span></span></p><ul><li><p data-tool="mdnice编辑器">counts  FeatureMatrix函数处理后的返回值 </p></li><li><p data-tool="mdnice编辑器">min.cells  最少要满足min.cells的features </p></li><li><p data-tool="mdnice编辑器">min.features  最少要满足min.features的cells </p></li><li><p data-tool="mdnice编辑器">fragments   CreateFragmentObject函数处理后的返回值</p><p data-tool="mdnice编辑器"><br></p></li></ul><p data-tool="mdnice编辑器">第五个是创建Seurat对象这个大家都比较常见的，就是CreateSeuratObject常用参数：<span></span></p><ul><li><p data-tool="mdnice编辑器">counts 这里使用ChromatinAssay返回值 </p></li><li><p data-tool="mdnice编辑器">project 推荐设置成这个样本的名称 </p></li><li><p data-tool="mdnice编辑器">assay 就是seurat对象assay名称命名，这里由于是scATAC数据，一般我们命名为ATAC，区别于RNA数据 </p></li><li><p data-tool="mdnice编辑器">meta.data 可以额外将10X的每个细胞计算的一些指标信息添加到meta.data表中</p><p data-tool="mdnice编辑器"><br></p></li></ul><p data-tool="mdnice编辑器">这里还运用到一个RenameCells来修改cell barcodesRenameCells 函数中add.cell.id 参数 将样本信息 添加到barcodes上这是为了防止多个样本合并时候造成 有些样本的barcodes重复</p><p data-tool="mdnice编辑器">最后使用merge函数将每个样本的Seurat对象合并在一起</p><h3 data-tool="mdnice编辑器"><span></span>降维展示<span></span></h3><section>其实之后是可以接入一个类似单样本质控的环节 ，根据一些ATAC数据指标进行一定的过滤，保留高质量细胞，还有包括peaks的一些注释情况（Annotation步骤），这里就不作介绍的，具体质控可以参考<span>【</span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MzE4NDg5NQ==&amp;mid=2247484594&amp;idx=1&amp;sn=c3c8934481a13fa63a0d43ba57a174bc&amp;chksm=ce7d3622f90abf34d24b04bf113383ab18eab5ced9e0330e68bdf2dc1b602eaede98efbfa159&amp;scene=21#wechat_redirect" textvalue="单细胞多组学ATAC-Signac包-单样本10×单细胞数据质控" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞多组学ATAC-Signac包-单样本10×单细胞数据质控</span></a><span>】</span>，这里就不做介绍了。</section><section>这样多样本合并数据整合到一个Seurat对象就告一段落了。</section><section>剩下其实就是数据的降维，这块先给大家列出来，运行一下看结果，具体的降维将在下一期详细给大家介绍。</section><pre data-tool="mdnice编辑器"><span></span><code>library(EnsDb.Hsapiens.v75)<br>library(GenomeInfoDb)<br><span># extract gene annotations from EnsDb</span><br>annotations &lt;- GetGRangesFromEnsDb(ensdb = EnsDb.Hsapiens.v75)<br><br><span># change to UCSC style since the data was mapped to hg19</span><br>seqlevelsStyle(annotations) &lt;- <span>'UCSC'</span><br><br><span># add the gene information to the object</span><br>Annotation(rds) &lt;- annotations<br><br>rds &lt;- RunTFIDF(rds)<br>rds &lt;- FindTopFeatures(rds, min.cutoff = 20)<br>rds &lt;- RunSVD(rds)<br>rds &lt;- RunUMAP(rds, dims = 2:50, reduction = <span>'lsi'</span>)<br><br>p &lt;- DimPlot(rds, group.by = <span>'sample'</span>, pt.size = 0.1)<br></code></pre><figure data-tool="mdnice编辑器"><img data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLuFiawxJBxmzGvhiceicNB8VoicLdP9byVnicnKpiaVy6AcncF9jicyQPYb7fKD85aK1XYY5mS63rxqbnFAg/640?wx_fmt=png" data-type="png" data-ratio="1.0048309178743962" data-w="828" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLuFiawxJBxmzGvhiceicNB8VoicLdP9byVnicnKpiaVy6AcncF9jicyQPYb7fKD85aK1XYY5mS63rxqbnFAg/640?wx_fmt=png"><figcaption><br></figcaption></figure><h2 data-tool="mdnice编辑器"><span> </span><span></span><span>非共有peak set的矩阵合并对比</span><span></span><span> </span></h2><section>有时候，可能会没有bed文件，那么就无法使用最佳实践的方法，但是如果我们有bam文件也是可以使用sinto工具生成的bed文件的。这里我们对比一下如果不使用共有peak set 会发生什么情况呢？</section><section>真的，不太推荐下面的方式。Signac包 对peaks的定义中ChromatinAssay对象中存储的 overlapping peaks是等效的，并会调整峰所跨越的基因组范围，以便合并的每个对象中的features变得等效，这样的情况，原本每个样本features没有进行校准，这样可能会导致一些peaks的范围区域经过merge调整后浮动，扩展到并没有实际计算到的区域。因此，尽量使用共有peak set 校准的方法实践，下面的方法是一种实在没有办法的方法才运行的。</section><pre data-tool="mdnice编辑器"><span></span><code>library(Signac)<br>library(Seurat)<br>library(GenomicRanges)<br>library(future)<br><span># load the count matrix for each object that was generated by cellranger</span><br>counts.500 &lt;- Read10X_h5(<span>"../vignette_data/pbmc500/atac_pbmc_500_nextgem_filtered_peak_bc_matrix.h5"</span>)<br>counts.1k &lt;- Read10X_h5(<span>"../vignette_data/pbmc1k/atac_pbmc_1k_nextgem_filtered_peak_bc_matrix.h5"</span>)<br>counts.5k &lt;- Read10X_h5(<span>"../vignette_data/pbmc5k/atac_pbmc_5k_nextgem_filtered_peak_bc_matrix.h5"</span>)<br>counts.10k &lt;- Read10X_h5(<span>"../vignette_data/pbmc10k/atac_pbmc_10k_nextgem_filtered_peak_bc_matrix.h5"</span>)<br><br><span># create objects</span><br>pbmc500_assay &lt;- CreateChromatinAssay(counts = counts.500, sep = c(<span>":"</span>, <span>"-"</span>), min.features = 500)<br>pbmc500 &lt;- CreateSeuratObject(pbmc500_assay, assay = <span>"peaks"</span>)<br>pbmc1k_assay &lt;- CreateChromatinAssay(counts = counts.1k, sep = c(<span>":"</span>, <span>"-"</span>), min.features = 500)<br>pbmc1k &lt;- CreateSeuratObject(pbmc1k_assay, assay = <span>"peaks"</span>)<br>pbmc5k_assay &lt;- CreateChromatinAssay(counts = counts.5k, sep = c(<span>":"</span>, <span>"-"</span>), min.features = 500)<br>pbmc5k &lt;- CreateSeuratObject(pbmc5k_assay, assay = <span>"peaks"</span>)<br>pbmc10k_assay &lt;- CreateChromatinAssay(counts = counts.10k, sep = c(<span>":"</span>, <span>"-"</span>), min.features = 1000)<br>pbmc10k &lt;- CreateSeuratObject(pbmc10k_assay, assay = <span>"peaks"</span>)<br><br><span># add information to identify dataset of origin</span><br>pbmc500<span>$sample</span> &lt;- <span>'pbmc500'</span><br>pbmc1k<span>$sample</span> &lt;- <span>'pbmc1k'</span><br>pbmc5k<span>$sample</span> &lt;- <span>'pbmc5k'</span><br>pbmc10k<span>$sample</span> &lt;- <span>'pbmc10k'</span><br><br><span># merge</span><br>combined &lt;- merge(<br>  x = pbmc500,<br>  y = list(pbmc1k, pbmc5k, pbmc10k),<br>  add.cell.ids = c(<span>"500"</span>, <span>"1k"</span>, <span>"5k"</span>, <span>"10k"</span>)<br>)<br><br>library(EnsDb.Hsapiens.v75)<br>library(GenomeInfoDb)<br><span># extract gene annotations from EnsDb</span><br>annotations &lt;- GetGRangesFromEnsDb(ensdb = EnsDb.Hsapiens.v75)<br><br><span># change to UCSC style since the data was mapped to hg19</span><br>seqlevelsStyle(annotations) &lt;- <span>'UCSC'</span><br><br><span># add the gene information to the object</span><br>Annotation(combined) &lt;- annotations<br><br><span># process </span><br>combined &lt;- RunTFIDF(combined)<br>combined &lt;- FindTopFeatures(combined, min.cutoff = 20)<br>combined &lt;- RunSVD(combined)<br>combined &lt;- RunUMAP(combined, dims = 2:50, reduction = <span>'lsi'</span>)<br><br>p &lt;- DimPlot(combined, group.by = <span>'sample'</span>, pt.size = 0.1)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.9913686806411838" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLuFiawxJBxmzGvhiceicNB8Voichfy9l8xLeMqPwPzgklXAVBQMNxmF6Td5bPmKLmCbV1icu6zdfnp5SNQ/640?wx_fmt=png" data-type="png" data-w="811" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLuFiawxJBxmzGvhiceicNB8Voichfy9l8xLeMqPwPzgklXAVBQMNxmF6Td5bPmKLmCbV1icu6zdfnp5SNQ/640?wx_fmt=png"><figcaption><br></figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>对比<span></span></h3><section>两种策略对比后，可以发现一个非常明显的事情，感觉第二个方法样本间的异质性就突出了，可能会存在“批次效应“。这是由于没有校准共有的peak set导致的结局，单纯依赖merge去overlapping peaks去做，不准。</section><figure data-tool="mdnice编辑器"><img data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLuFiawxJBxmzGvhiceicNB8VoicOia7sYSyeLxgQqoVfxsoyZMHVzEaMhy4S9IB57maChEFaHdCiaYsHLMA/640?wx_fmt=png" data-type="png" data-ratio="0.5689828801611279" data-w="993" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLuFiawxJBxmzGvhiceicNB8VoicOia7sYSyeLxgQqoVfxsoyZMHVzEaMhy4S9IB57maChEFaHdCiaYsHLMA/640?wx_fmt=png"><figcaption><br></figcaption></figure><section>除此之外，在测试的时候，由于merge这步 没有使用共有的peak set矩阵，导致merge需要推算overlapping peaks，这步计算非常慢，非常慢！！！</section><section><span><strong>总结：最佳实践的运行时间快，数据最终处理后降维数据融合情况也相对比较好。因此 还是推荐最佳实践的共有peak set校准的策略进行！！！！！</strong></span></section><h2 data-tool="mdnice编辑器"><span> </span><span></span><span>参考</span><span></span><span> </span></h2><p data-tool="mdnice编辑器">Signac merge object：https://stuartlab.org/signac/articles/merging.html</p><p><br></p><section><p><br></p><section data-style-type="5" data-tools="新媒体排版" data-id="2440476"><section><section><section><section><img data-ratio="0.9495798319327731" data-src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif" data-type="gif" data-w="119" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif"></section><section data-brushtype="text">往期回顾</section><section><br></section></section></section></section><section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247510077&amp;idx=1&amp;sn=96fd3e828b409d6d5b8de302031acad5&amp;chksm=ea1caebfdd6b27a96a57293dcc17d3d666700ae7f92b04216c1050c8583bcd85a56f73efa9bf&amp;scene=21#wechat_redirect" textvalue="单细胞多组学ATAC-Signac包-概述" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>单细胞多组学ATAC-Signac包-概述</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247510236&amp;idx=2&amp;sn=dcf3e49cc485cb2b1d1bcf377f9fd382&amp;chksm=ea1cae5edd6b274862b2b9d477107914c568f8faa4a484a27cf1cde9a582f5f29e71c83ac5b4&amp;scene=21#wechat_redirect" textvalue="单细胞多组学ATAC-Signac包-单样本10×单细胞ATAC数据读取" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>单细胞多组学ATAC-Signac包-单样本10×单细胞ATAC数据读取</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247510406&amp;idx=1&amp;sn=d10108138c74388fdd600d7aa569b9ae&amp;chksm=ea1caf04dd6b26120f8a709aebe3df4a532a706a5db42edfece29d9102a37ceee122aed8739f&amp;scene=21#wechat_redirect" textvalue="单细胞多组学ATAC-Signac包-单样本10×单细胞数据质控" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>单细胞多组学ATAC-Signac包-单样本10×单细胞数据质控</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247511245&amp;idx=1&amp;sn=7ad9b315ce24ca081e69cb2e280794bc&amp;chksm=ea1caa4fdd6b2359e84f82b00cd93628bd152b982f5c5c38d65bfc275a17433cac6c5db078fc&amp;scene=21#wechat_redirect" textvalue="单细胞图谱细化结直肠癌的分类" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞图谱细化结直肠癌的分类</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247511215&amp;idx=1&amp;sn=9de684587b1609661e4e53189c7b5f42&amp;chksm=ea1caa2ddd6b233b41874cea9cf9719c59fefefd080713b7f9c31a36d82b5bca0c61bd0655c6&amp;scene=21#wechat_redirect" textvalue="标准的单细胞降维聚类分群和命名" linktype="text" imgurl="" imgdata="null" data-itemshowtype="8" tab="innerlink" data-linktype="2"><span>标准的单细胞降维聚类分群和命名</span></a><br></p></section></section><hr><p><br></p></section><section data-style-type="5" data-tools="新媒体排版" data-id="2440475"><hr><p><br></p><hr><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247520628&amp;idx=1&amp;sn=8904b3e4baed6d02397b4f6beb089085&amp;chksm=9b4bd1cfac3c58d9ee006daf365931bdfab8d5152ffb5090a2c6227d631e93c52f6656c39cd6&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课4月班" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信入门&amp;数据挖掘线上直播课4月班</a><br></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=2&amp;sn=6cb33654c7751f4c3df0f84743f77aaf&amp;chksm=9b4bceaeac3c47b8899afc00077b96357b87a4ed6b75e7c434ba14071fd6c8448e4c218de5e0&amp;scene=21#wechat_redirect" textvalue="144线程640Gb内存服务器共享一年仍然是仅需800" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">144线程640Gb内存服务器共享一年仍然是仅需800</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">千呼万唤始出来的独享生物信息学云服务器</a></p></li></ul><p><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-id="93668"><section><section data-width="95%"><section><section><section data-width="38%"><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg" data-type="other" data-w="258" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ffg-HFMX9GEU7xHI7dQ9SQ",target="_blank" rel="noopener noreferrer">原文链接</a>
