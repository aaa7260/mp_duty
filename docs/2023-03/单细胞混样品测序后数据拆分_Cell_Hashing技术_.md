---
title: "单细胞混样品测序后数据拆分（Cell Hashing技术）"
date: 2023-03-22T08:06:36Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
单细胞混样品测序后数据拆分（Cell Hashing技术） by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>最近有学徒提到她在复现文献：《utative regulators for the continuum of erythroid differentiation revealed by single-cell transcriptome of human BM and UCB cells.》的单细胞数据分析的时候.</p></blockquote><p data-tool="mdnice编辑器">她发现作者明明是提到了6个样品，但是其数据集是：https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE150774,可以看到是5个数据 ：</p><pre data-tool="mdnice编辑器"><span></span><code>GSM4558614 CD235a+ cells - umbilical cord blood 2 and umbilical cord blood 3,UCB3<br>GSM4558615 CD235a+ cells - umbilical cord blood 1<br>GSM4558616 CD235a+ cells - Bone Marrow 2<br>GSM4558617 CD235a+ cells - Bone Marrow 3<br>GSM4558618 CD235a+ cells - Bone Marrow 4<br></code></pre><p data-tool="mdnice编辑器">仔细看了看文章里面的描述，确实是 10x Genomics platform  这个技术，是 3 adult bone marrow and 3 umbilical cord blood samples ，合起来是6个样品，而且提前做了细胞分选，仅仅是关注 CD235a+ cells</p><p data-tool="mdnice编辑器">学徒以为是作者数据整理上传失败，其实是cell hashing技术，大家可以先去了解 CITE-seq技术 ，它可以同时拿到普通基因的表达量矩阵，以及几十个蛋白质（通过antibody-derived tags (ADT)）的表达量矩阵，该技术的全称为cellular indexing of transcriptomes and epitopes by sequencing。而Cell Hashing是在CITE-seq的基础上改进，是给需要混合的样品提前加上HTO (A distinct Hashtag oligonucleotide) 标签，这样即使混合后也可以提供不同的HTO标签进行区分。</p><p data-tool="mdnice编辑器">可以看到文件UCB2UCB3确实是混合在同一个单细胞样品里面了 ：</p><pre data-tool="mdnice编辑器"><span></span><code>GSM4558614_UCB2UCB3_filtered_gene_bc_matrices.tar.gz 95.9 Mb<br>GSM4558615_UCB1_filtered_gene_bc_matrices.tar.gz 4.4 Mb<br>GSM4558616_BM2_filtered_gene_bc_matrices.tar.gz 7.4 Mb<br>GSM4558617_BM3_filtered_gene_bc_matrices.tar.gz 6.3 Mb<br>GSM4558618_BM4_filtered_gene_bc_matrices.tar.gz 8.3 Mb<br></code></pre><p data-tool="mdnice编辑器">下面就让我们来看看如何把这个95.9 Mb的矩阵拆分成为两个样品</p><h2 data-tool="mdnice编辑器"><span></span>首先导入数据并查看数据分布</h2><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>) <br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span># 需要自己去 GSE150774 数据集主页下载 GSE150774_RAW 哦 </span><br><span># 把这个 GSM4558614_UCB2UCB3_filtered_gene_bc_matrices.tar.gz 95.9 Mb 解压即可：</span><br>HP &lt;- Read10X(<span>"GSE150774_RAW/HP0_filtered_gene_bc_matrices/"</span>)<br>HP[[<span>1</span>]] <span># RNA：Gene Expression</span><br>HP[[<span>2</span>]] <span># HTO：Antibody Capture</span><br></code></pre><p data-tool="mdnice编辑器">它这个文件夹里面，有 表达量矩阵，也有 HTO (A distinct Hashtag oligonucleotide) 标签，这样即使混合后也可以提供不同的HTO标签进行区分。</p><h2 data-tool="mdnice编辑器"><span></span>表达量矩阵和HTO标签需要取交集</h2><pre data-tool="mdnice编辑器"><span></span><code><span>#先读hto数据 </span><br>yhto &lt;- as.data.frame(HP$`Antibody Capture`)<br>rownames(yhto)<br><span># 可以看到是两个样品</span><br>table(colSums(yhto)== <span>0</span>)<br>pbmc.htos &lt;- yhto[colSums(yhto)&gt;<span>0</span>]<br>dim(pbmc.htos)<br><br><span># 然后看表达量矩阵 </span><br>pbmc.umis &lt;- HP$`Gene Expression`<br><br><span>#  取交集</span><br>joint.bcs &lt;- intersect(colnames(pbmc.umis), colnames(pbmc.htos))<br>length(joint.bcs)<br><br><span># 前面的抗体信息和表达量信息，都需要过滤</span><br><span># Subset RNA and HTO counts by joint cell barcodes</span><br>pbmc.umis &lt;- pbmc.umis[, joint.bcs]<br>pbmc.htos &lt;- as.matrix(pbmc.htos[, joint.bcs])<br></code></pre><p data-tool="mdnice编辑器">如果你的表达量矩阵跟HTO标签矩阵确实是同一个实验产出的，两者交集应该是非常好。</p><h2 data-tool="mdnice编辑器"><span></span>创建Seurat并将HTO置入对象中</h2><p data-tool="mdnice编辑器">取交集后，就可以进行seurat标准流程啦</p><pre data-tool="mdnice编辑器"><span></span><code><span># Setup Seurat object</span><br>pbmc.hashtag &lt;- CreateSeuratObject(counts = pbmc.umis)<br><br><span># Normalize RNA data with log normalization</span><br>pbmc.hashtag &lt;- NormalizeData(pbmc.hashtag)<br><span># Find and scale variable features</span><br>pbmc.hashtag &lt;- FindVariableFeatures(pbmc.hashtag, selection.method = <span>"mean.var.plot"</span>)<br>pbmc.hashtag &lt;- ScaleData(pbmc.hashtag, features = VariableFeatures(pbmc.hashtag))<br>pbmc.hashtag<br><br><span># Add HTO data as a new assay independent from RNA</span><br>pbmc.hashtag[[<span>"HTO"</span>]] &lt;- CreateAssayObject(counts = pbmc.htos)<br>names(pbmc.hashtag)<br><span># Normalize HTO data, here we use centered log-ratio (CLR) transformation</span><br>pbmc.hashtag &lt;- NormalizeData(pbmc.hashtag, <br>                              assay = <span>"HTO"</span>, <br>                              normalization.method = <span>"CLR"</span>)<br><br><br>head(pbmc.hashtag@meta.data)<br><br>VlnPlot(pbmc.hashtag, features = c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>,<br>                                   <span>"nCount_HTO"</span>,<span>"nFeature_HTO"</span>), <br>        ncol = <span>2</span>,pt.size = <span>0</span>)<br></code></pre><p data-tool="mdnice编辑器">可以看到，这个时候其实是两个矩阵都进入了seurat对象里面哦，</p><h2 data-tool="mdnice编辑器"><span></span>利用<code>HTODemux函数</code>拆分数据</h2><p data-tool="mdnice编辑器">前面的seurat对象比较特殊，它有两个assay，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; pbmc.hashtag<br>An object of class Seurat <br>32740 features across 18777 samples within 2 assays <br>Active assay: RNA (32738 features, 1749 variable features)<br> 1 other assay present: HTO<br></code></pre><p data-tool="mdnice编辑器">这样的，有两个 assay的 seurat对象，就可以被<code>HTODemux函数</code>拆分数据，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>pbmc.hashtag &lt;- HTODemux(pbmc.hashtag,<br>                         assay = <span>"HTO"</span>, <br>                         positive.quantile = <span>0.99</span>)<br>pbmc.hashtag<br>table(pbmc.hashtag$HTO_classification.global)<br>pbmc.hashtag@assays<br>table(pbmc.hashtag$hash.ID)<br><br><span># ## Doublet Negative  Singlet </span><br><span>#     152    14650     3975 </span><br><br><span># 可视化</span><br>Idents(pbmc.hashtag) &lt;- <span>"hash.ID"</span><br>VlnPlot(pbmc.hashtag, features = <span>"nCount_RNA"</span>, pt.size = <span>0</span>, log = <span>TRUE</span>)<br>FeatureScatter(pbmc.hashtag, feature1 = <span>"rna_HBE1"</span>, feature2 = <span>"rna_S100A9"</span>)<br></code></pre><p data-tool="mdnice编辑器">可以看到， 这个数据集质量有点问题，绝大部分的细胞都是阴性，有点意思。</p><h2 data-tool="mdnice编辑器"><span></span>数据提取</h2><p data-tool="mdnice编辑器">混合样品，拆开成为不同的seurat对象：</p><pre data-tool="mdnice编辑器"><span></span><code><br><span># First, we will remove negative cells from the object</span><br>table(Idents(pbmc.hashtag))<br>pbmc.hashtag.subset &lt;- subset(pbmc.hashtag, <br>                              idents = c(<span>"Negative"</span>,<span>"Doublet"</span>), <br>                              invert = <span>TRUE</span>)<br>table(Idents(pbmc.hashtag.subset)) <br>pbmc.hashtag.subset &lt;- RunPCA(pbmc.hashtag.subset)<br>pbmc.hashtag.subset &lt;- RunUMAP(pbmc.hashtag.subset,dims=<span>1</span>:<span>10</span>)<br>DimPlot(pbmc.hashtag.subset) <br><br><span>#提取B0251：</span><br>B0251 &lt;- subset(pbmc.hashtag, <br>                idents = c(<span>"B0251 anti-human Hashtag1"</span>))<br><span>#提取B0252：</span><br>B0252 &lt;- subset(pbmc.hashtag, <br>                idents = c(<span>"B0252 anti-human Hashtag2"</span>))<br> <br></code></pre><h3 data-tool="mdnice编辑器"><span></span>多个单细胞对象需要合并后走harmony流程<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><br>sce.all &lt;- merge( B0251, y=  B0252 ,add.cell.ids = c(<span>'B0251'</span>,<span>'B0252'</span>)) <br> <br>as.data.frame(sce.all@assays$RNA@counts[<span>1</span>:<span>10</span>, <span>1</span>:<span>2</span>])<br>head(sce.all@meta.data, <span>10</span>)<br>table(sce.all@meta.data$orig.ident) <br><span>library</span>(stringr)<br>phe=as.data.frame(str_split(colnames(sce.all),<span>'_'</span>,simplify = <span>T</span>))<br>head(phe)<br>sce.all@meta.data$orig.ident = phe$V1<br>table(sce.all@meta.data$orig.ident )<br>head(sce.all@meta.data)<br><span># 下面是标准流程</span><br>sce=sce.all<br>sce &lt;- NormalizeData(sce, <br>                         normalization.method = <span>"LogNormalize"</span>,<br>                         scale.factor = <span>1e4</span>) <br>sce &lt;- FindVariableFeatures(sce)<br>sce &lt;- ScaleData(sce)<br>sce &lt;- RunPCA(sce, features = VariableFeatures(object = sce))<br><br><span>library</span>(harmony)<br>seuratObj &lt;- RunHarmony(sce, <span>"orig.ident"</span>)<br>names(seuratObj@reductions)<br>seuratObj &lt;- RunUMAP(seuratObj,  dims = <span>1</span>:<span>15</span>, <br>                     reduction = <span>"harmony"</span>)<br>DimPlot(seuratObj,reduction = <span>"umap"</span>,label=<span>T</span> ) <br><br>sce=seuratObj<br>sce &lt;- FindNeighbors(sce, reduction = <span>"harmony"</span>,<br>                     dims = <span>1</span>:<span>15</span>) <br>sce.all=sce <br></code></pre><p data-tool="mdnice编辑器">后面的结果就顺理成章了，分群注释，如下所示的结果：</p><p><img data-ratio="0.359375" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyLhRBNM1bZZaiaXwvLDLN5mHQ3vrgVqa8yaAADuL7wvLicmPuc6juLiaxNHkhX1VzBJaRT6jg2MI8oQ/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyLhRBNM1bZZaiaXwvLDLN5mHQ3vrgVqa8yaAADuL7wvLicmPuc6juLiaxNHkhX1VzBJaRT6jg2MI8oQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">唯一美中不足的就是最开始的两万多个细胞，居然过滤后仅仅是剩下三千左右细胞数量了。</p><p data-tool="mdnice编辑器">降维聚类分群，参考前面的例子：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497956&amp;idx=1&amp;sn=5d4deb7cf7b7848b3e2273cbd663bb6a&amp;scene=21#wechat_redirect" data-linktype="2">人人都能学会的单细胞聚类分群注释</a></p><h3 data-tool="mdnice编辑器"><span></span>写在文末<span></span></h3><p data-tool="mdnice编辑器">我在《生信技能树》，《生信菜鸟团》，《单细胞天地》的大量推文教程里面共享的代码都是复制粘贴即可使用的， 有任何疑问欢迎留言讨论，也可以发邮件给我，详细描述你遇到的困难的前因后果给我，我的邮箱地址是 jmzeng1314@163.com</p><p data-tool="mdnice编辑器">如果你确实觉得我的教程对你的科研课题有帮助，让你茅塞顿开，或者说你的课题大量使用我的技能，烦请日后在发表自己的成果的时候，加上一个简短的致谢，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>We thank Dr.Jianming Zeng(University of Macau), and all the members of his bioinformatics team, biotrainee, <span>for</span> generously sharing their experience and codes.<br></code></pre><p data-tool="mdnice编辑器">十年后我环游世界各地的高校以及科研院所（当然包括中国大陆）的时候，如果有这样的情谊，我会优先见你。</p></section><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/pVuOurFeQXldce4Ys89Ifg",target="_blank" rel="noopener noreferrer">原文链接</a>
