---
title: "复现1---火山图的另一种画法"
date: 2023-03-01T09:29:58Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
复现1---火山图的另一种画法 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span><span>缘起</span><span></span></h2><p data-tool="mdnice编辑器">上周推文，我们谈到要开启可变剪切的学习。那学习啥呢，老师说，我可以先依次复现一下上周推文推荐的文章中与可变剪切相关的几幅小图。这周的话，我们主要先复现第一副密度散点图。<span>一看如下示例的密度散点图的横坐标、纵坐标与形状，其实大家都能看出来它就是差异分析后以logFC与padj绘制的火山图，只不过此处颜色映射的是密度，不是我们常规映射的上调、下调与不变的基因。此外，此处绘制的每个点代表的是每个基因对映的外显子，不是我们转录组常规差异分析后的基因</span>。在此图的复现过程中，需要<strong><span>特别强调两个点</span></strong><span>，1.是将图例设置为右上角 2.是通过trans="log"这个参数，将图例的颜色比例尺指定为1、16、256、4096与65536这五个均分部分，而不是按照数值均分的映射。</span>为什么复现的时候，需要特别强调这两点呢，推文中我们将进行详细描述。</p><p data-tool="mdnice编辑器">今天，我们要复现的图就是如下得这幅图哈，图中两条辅助线对应的logFC分别为-2与2。<img data-ratio="0.6440677966101694" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9VnLHnuuflJXXicicicicicvzgnWITzJEjib3nwrkWpGOLN0CicAzCbppahibL6DPaEdh3f9MDWxAc7sPxKg/640?wx_fmt=png" data-type="png" data-w="354" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9VnLHnuuflJXXicicicicicvzgnWITzJEjib3nwrkWpGOLN0CicAzCbppahibL6DPaEdh3f9MDWxAc7sPxKg/640?wx_fmt=png"></p><h2 data-tool="mdnice编辑器"><span></span><span>探索</span><span></span></h2><p data-tool="mdnice编辑器">今天，我们使用上周推文介绍过的文章，标题为 <strong>「剪切因子SF3B1通过调节KSR2 RNA成熟促进子宫内膜癌进展」</strong> 的附件表3进行探究。为什么使用附表3的数据呢？正文中提到，为了深入了解可变剪切的基因谱，作者使用DEXSeq对RNA-seq数据进行差异外显子使用分析。DEXseq分析了6,40,456个外显子的差异使用情况。完整的DEXseq原始计数、标准化计数和每个外显子的统计数据作为补充提供在附表3。附表3的下载链接如下：<span>https://www.nature.com/articles/s41419-020-03055-y#Sec18 </span> 。关于这篇经典文章的介绍，感兴趣的小伙伴可以阅读上周的推文<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247510762&amp;idx=1&amp;sn=fa70866e6f9c6602319f24e3a444020e&amp;chksm=fa456fd7cd32e6c18440c508e237f1d89a1ac40eb55325b8e96ce018fe88cde3b783c2789a00&amp;cur_album_id=2545418429466607617&amp;scene=21&amp;key=a1e4a6001c8061185cd5b40aac56082940b2ea5a4a182fecd7c0374da472e152023d0c46aa3309e5fa34b556f2370ba5c54b291a8bec0651f4094e4e6f29100cdecf9dc15dc58f0d233579e0ca88d3c3c6eb8771ed7bdd134dea9ed04a12d15e35a151d13c762cc345fbbb83a63129fd984bd66bf2a630a88b7089ae1d03fc01&amp;ascene=0&amp;uin=MjI3OTYzNDcwNg==&amp;devicetype=Windows%2011%20x64&amp;version=6309001c&amp;lang=zh_CN&amp;countrycode=CN&amp;exportkey=n_ChQIAhIQENkvIGDm9RWNIfkurONGSRLgAQIE97dBBAEAAAAAAGtMNjFxFtsAAAAOpnltbLcz9gKNyK89dVj035igPCVgjLtvn5meYnsFZoI/xeN/8S3YJD61%20p0Cpc6NjPL0JTqqr2LL2Cy46zH%20tmT4QyA3qW1IWj/tscsZJPCQc3lLwO9%20oQbgWRtsU9sPg%20rPGOJ2rHG0K/0Y5nv7cBfuQN/twge3IrM/dO8c0oL/S6ualDp/%20xl8GnqslRFN7bnedRQm5y3luybAxpwalSfVe1zkSnK3TI9qY0ycLij6cHKrCVmMiaMEgy9w%20a%2077Fv9Kwd8HxBU&amp;acctmode=0&amp;pass_ticket=NcMYodOx2lsBPabCW7nWYkR5uFB/wlUp3uDDuLIx5mZSVeL3NszbYsgZXPMl/eJdn617qmtBme6uC1IIAHCsaw==&amp;wx_header=1&amp;fontgear=2#wechat_redirect" data-linktype="2">转录组----新的转折</a>。</p><h2 data-tool="mdnice编辑器"><span></span><span>转录组数据介绍</span><span></span></h2><p data-tool="mdnice编辑器">通过附表3的下载链接地址，我们能够下载到DEXseq分析的外显子使用情况的表格。从表格的counts计数中，我们可以看到该数据组别分为control与sf3b1两组，每组具有3个重复样本。<img data-ratio="0.30781893004115224" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9VnLHnuuflJXXicicicicicvzgngo1pxXzkYQ3mGMzOVFibssCPTe4Qj3IqhN0HY8Kuiae9LxByKrIep5wA/640?wx_fmt=png" data-type="png" data-w="1215" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9VnLHnuuflJXXicicicicicvzgngo1pxXzkYQ3mGMzOVFibssCPTe4Qj3IqhN0HY8Kuiae9LxByKrIep5wA/640?wx_fmt=png">除了counts结果，文中还具备差异分析之后得到的padj与logFC值。对于我们今天绘制的密度散点图，提取logFC与padj两列，将基因ID的外显子作为行名即可。接下来，咱们就正式开始分析吧。<img data-ratio="0.4760892667375133" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9VnLHnuuflJXXicicicicicvzgncic6ibGoMwzbFrt7nfiaj7JAeQwk5wXfcwM2mTQPhibXibvKsR9DSiaViakicg/640?wx_fmt=png" data-type="png" data-w="941" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9VnLHnuuflJXXicicicicicvzgncic6ibGoMwzbFrt7nfiaj7JAeQwk5wXfcwM2mTQPhibXibvKsR9DSiaViakicg/640?wx_fmt=png"></p><h2 data-tool="mdnice编辑器"><span></span><span>正式分析</span><span></span></h2><h3 data-tool="mdnice编辑器"><span></span><span><span></span>1.清空环境，加载R包</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br><span>library</span>(data.table)<br><span>library</span>(openxlsx)<br><span>library</span>(ggplot2)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span></span>2.读取数据，获得绘制火山图需要的logFC与padj两列</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>df=read.xlsx(<span>"41419_2020_3055_MOESM8_ESM.xlsx"</span>)<br>df[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span>##           groupID featureID exonBaseMean  dispersion</span><br><span>## 1 ENSG00000000003      E001    0.9483831 0.050371938</span><br><span>## 2 ENSG00000000003      E002  547.5304102 0.001285623</span><br><span>## 3 ENSG00000000003      E003  184.3717721 0.001420820</span><br><span>## 4 ENSG00000000003      E004    1.0278659 0.052101035</span><br>colnames(df)<br><span>##  [1] "groupID"                "featureID"              "exonBaseMean"          </span><br><span>##  [4] "dispersion"             "stat"                   "pvalue"                </span><br><span>##  [7] "padj"                   "control"                "sf3b1"                 </span><br><span>## [10] "log2fold_sf3b1_control" "genomicData.seqnames"   "genomicData.start"     </span><br><span>## [13] "genomicData.end"        "genomicData.width"      "genomicData.strand"    </span><br><span>## [16] "countData.control_rep1" "countData.control_rep2" "countData.control_rep3"</span><br><span>## [19] "countData.sf3b1_rep1"   "countData.sf3b1_rep2"   "countData.sf3b1_rep3"  </span><br><span>## [22] "transcripts"</span><br>dat=df[,c(<span>"groupID"</span>,<span>"featureID"</span>,<span>"padj"</span>,<span>"log2fold_sf3b1_control"</span>)]<br>dat$ENS_exon=paste0(dat$groupID,<span>"_"</span>,dat$featureID)<br><span># class(dat)</span><br><span># dat=dat[!duplicated(dat$ENS_exon),]</span><br><span># class(dat)</span><br>rownames(dat)=dat$ENS_exon<br>dat=dat[,c(<span>"padj"</span>,<span>"log2fold_sf3b1_control"</span>)]<br>dat=na.omit(dat)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span></span>3.绘制常规火山图</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 设置p_value和logFC的阈值</span><br>cut_off_pvalue = <span>0.01</span>  <span>#统计显著性</span><br>cut_off_logFC = <span>2</span>           <span>#差异倍数值</span><br><br>class(dat$padj)<br><span>## [1] "character"</span><br>dat$padj=as.numeric(dat$padj)  <span>##注意，一定要是数值型</span><br>class(dat$padj)<br><span>## [1] "numeric"</span><br><br>dat$change=ifelse(dat$padj&lt;<span>0.01</span>,ifelse(dat$log2fold_sf3b1_control&gt; <span>1</span> ,<span>"up"</span>,ifelse(dat$log2fold_sf3b1_control&lt; -<span>1</span> ,<span>"down"</span>,<span>"not"</span>)),<span>"not"</span>)<br>table(dat$change)<br><span>## </span><br><span>##   down    not     up </span><br><span>##   3618 364053  13383</span><br><br>p &lt;- ggplot(<br>  <span># 数据、映射、颜色</span><br>  dat, aes(x = log2fold_sf3b1_control, y = -log10(padj), colour=change)) +<br>  geom_point(alpha=<span>0.4</span>, size=<span>3.5</span>) +<br>  scale_color_manual(values=c(<span>"#546de5"</span>, <span>"#d2dae2"</span>,<span>"#ff4757"</span>))+<br>  <span># 辅助线</span><br>  geom_vline(xintercept=c(-<span>1</span>,<span>1</span>),lty=<span>4</span>,col=<span>"black"</span>,lwd=<span>0.8</span>) +<br>  geom_hline(yintercept = -log10(cut_off_pvalue),lty=<span>4</span>,col=<span>"black"</span>,lwd=<span>0.8</span>) +<br>  <span># 坐标轴</span><br>  labs(x=<span>"log2(fold- change)"</span>,<br>       y=<span>"-log10(padj)"</span>)+<br>  theme_bw()+<br>  <span># 图例</span><br>  theme(plot.title = element_text(hjust = <span>0.5</span>), <br>        legend.position=<span>"right"</span>, <br>        legend.title = element_blank())<br>p<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9VnLHnuuflJXXicicicicicvzgnBSVibYREQdWO8jibgmdCHq0r5WLictoTToGJDKZVibV9oHFxZrtrudsPmQ/640?wx_fmt=png" data-type="png" data-w="672" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9VnLHnuuflJXXicicicicicvzgnBSVibYREQdWO8jibgmdCHq0r5WLictoTToGJDKZVibV9oHFxZrtrudsPmQ/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span><span><span></span>4.绘制密度散点图(不加trans=“log”版)</span><span></span></h3><p data-tool="mdnice编辑器">前面，我们提到过<strong>「2点较为重要」</strong>。<strong>1.图例位置右上</strong>，为什么图例位置为右上比较重要呢，因为ggplot2中指定图例位置一般有坐标法（坐标法无法将图例与图分开）与指定位置法（上、下、左与右四个位置）两种。从这两种中我们能够看见，都没有直接与右上相关的。在位置指定上，除了仅仅指定方向的右，我们还需要使用到另一个位置参数theme(legend.justification=“top”)。<span>关于第二点，我们将通过绘图的方式展示</span><strong><span>：影响自定义图例颜色比例尺trans=“log”这个参数的重要性</span></strong>。</p><pre data-tool="mdnice编辑器"><span></span><code><span>## 不加trans="log"</span><br>p1=ggplot(dat, aes(x = log2fold_sf3b1_control, y = -log10(padj)) ) +<br>  geom_hex(bins = c(<span>100</span>)) +<br>  scale_fill_continuous(limits = c(<span>1</span>,<span>65536</span>), breaks = c(<span>1</span>, <span>16</span>, <span>256</span>, <span>4096</span>, <span>65536</span>),type = <span>"viridis"</span>) +<br>  guides(fill=guide_colorbar(title = <span>"Density bin count"</span>))+<br>  theme_bw()+theme(legend.justification = <span>"top"</span>)+<br>  <span># 坐标轴</span><br>  labs(x=<span>"log2(fold- change)"</span>,<br>       y=<span>"-log10(padj)"</span>)+ geom_vline(aes(xintercept = -<span>2</span>),linetype = <span>"dashed"</span>)+geom_vline(aes(xintercept = <span>2</span>),linetype = <span>"dashed"</span>)<br>p1<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9VnLHnuuflJXXicicicicicvzgnSvhP0E8h4EpcsibkTRCVRGgcJicaVfU1AZvneCJHcqdZJ1TQF9KWj3icQ/640?wx_fmt=png" data-type="png" data-w="672" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9VnLHnuuflJXXicicicicicvzgnSvhP0E8h4EpcsibkTRCVRGgcJicaVfU1AZvneCJHcqdZJ1TQF9KWj3icQ/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span><span><span></span>5.绘制密度散点图(加trans=“log”版)</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>## 加trans="log"</span><br>p2=ggplot(dat, aes(x = log2fold_sf3b1_control, y = -log10(padj)) ) +<br>  geom_hex(bins = c(<span>100</span>)) +<br>  scale_fill_continuous(trans=<span>"log"</span>,limits = c(<span>1</span>,<span>65536</span>), breaks = c(<span>1</span>, <span>16</span>, <span>256</span>, <span>4096</span>, <span>65536</span>),type = <span>"viridis"</span>) +<br>  guides(fill=guide_colorbar(title = <span>"Density bin count"</span>))+<br>  theme_bw()+theme(legend.justification = <span>"top"</span>)+<br>  <span># 坐标轴</span><br>  labs(x=<span>"log2(fold- change)"</span>,<br>       y=<span>"-log10(padj)"</span>)+ geom_vline(aes(xintercept = -<span>2</span>),linetype = <span>"dashed"</span>)+geom_vline(aes(xintercept = <span>2</span>),linetype = <span>"dashed"</span>)<br>p2<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9VnLHnuuflJXXicicicicicvzgnMMOYm2zeicvicOCAAjiatLPxJ08CkicKtsZaYck8Hq2LC38iasicvYr25Izw/640?wx_fmt=png" data-type="png" data-w="672" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9VnLHnuuflJXXicicicicicvzgnMMOYm2zeicvicOCAAjiatLPxJ08CkicKtsZaYck8Hq2LC38iasicvYr25Izw/640?wx_fmt=png"><span></span></figure><p data-tool="mdnice编辑器">通过以上代码，我们复现了文中的图，我们可以看出加了trans=“log”对于这个图例颜色比例尺的影响。<span>小编需要给大家强调的是，trans=“log”这个参数在很多颜色映射的图中不常用，但它对于基于图的个性化展示非常重要，否则很大可能绘制出来的图就和第一幅不加trans=“log”的图一样丑。</span>不了解这个参数的话，真是一个bug卡半天的感觉，这还得感谢小伙伴的帮助，感兴趣的小伙伴快来试试吧。</p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/njE36VHX70xW9cIhugeT4w",target="_blank" rel="noopener noreferrer">原文链接</a>
