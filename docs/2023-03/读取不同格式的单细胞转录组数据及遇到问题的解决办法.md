---
title: "读取不同格式的单细胞转录组数据及遇到问题的解决办法"
date: 2023-03-23T05:31:14Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
读取不同格式的单细胞转录组数据及遇到问题的解决办法 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>几种不同格式单细胞转录组数据的读取方式，以及最近在读取单细胞转录组数据的时候遇到的问题。</p></blockquote><h3 data-tool="mdnice编辑器"><span></span>读取h5格式的单细胞文件<span></span></h3><p data-tool="mdnice编辑器">以下面这个数据集为例，h5格式的单细胞文件 GSE175687</p><p data-tool="mdnice编辑器">GEO Accession viewer (nih.gov)</p><p data-tool="mdnice编辑器"><img data-ratio="0.1981981981981982" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWM2ibia6Z93SHjxWKkgamlwibCDBhzEr8Z9EYibmR5pibLrxyqsqu8uxcbqDg/640?wx_fmt=png" data-type="png" data-w="999" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWM2ibia6Z93SHjxWKkgamlwibCDBhzEr8Z9EYibmR5pibLrxyqsqu8uxcbqDg/640?wx_fmt=png">批量导入数据：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>) <br><span>library</span>(Seurat)<br><span>library</span>(dplyr)<br><span>library</span>(hdf5r)<br><br><span>library</span>(data.table)<br>dir=<span>'GSE175687_raw/'</span> <br>samples=list.files( dir )<br>samples<br><br>sceList = lapply(samples,<span>function</span>(pro){ <br>  print(pro) <br>  sce =CreateSeuratObject(counts =  Read10X_h5( file.path(dir,pro)) ,<br>                          project =   gsub(<span>'_filtered_feature_bc_matrix.h5'</span>,<span>''</span>,gsub(<span>'^GSM[0-9]*_'</span>,<span>''</span>,pro) ) ,<br>                          min.cells = <span>5</span>,<br>                          min.features = <span>300</span> )<br>  <span>return</span>(sce)<br>})<br>sceList<br>samples<br></code></pre><p data-tool="mdnice编辑器">整合数据</p><pre data-tool="mdnice编辑器"><span></span><code>sce.all=merge(x=sceList[[<span>1</span>]],<br>              y=sceList[ -<span>1</span> ],<br>              add.cell.ids =   gsub(<span>'_filtered_feature_bc_matrix.h5'</span>,<span>''</span>,gsub(<span>'^GSM[0-9]*_'</span>,<span>''</span>,samples)))<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>读取10X格式的单细胞文件<span></span></h3><p data-tool="mdnice编辑器">文件输入格式</p><p data-tool="mdnice编辑器">10X格式文件结构：</p><pre data-tool="mdnice编辑器"><span></span><code>├── [ <span>160</span>]  Sample1<br>│   ├── [<span>2.</span>2M]  barcodes.tsv.gz<br>│   ├── [221K]  features.tsv.gz<br>│   └── [<span>4.</span>5M]  matrix.mtx.gz<br>├── [ <span>160</span>]  Sample2<br>│   ├── [<span>2.</span>2M]  barcodes.tsv.gz<br>│   ├── [221K]  features.tsv.gz<br>│   └── [<span>4.</span>0M]  matrix.mtx.gz<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.2603550295857988" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMh4LaDjbRQ12fI31DqNQS5xKsoRYs9VVZWRWQUFqVWpLtJsLPnqLrLw/640?wx_fmt=png" data-type="png" data-w="1014" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMh4LaDjbRQ12fI31DqNQS5xKsoRYs9VVZWRWQUFqVWpLtJsLPnqLrLw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">可以看到，每个10X的样品都是一个独立的文件夹，每个文件夹里面都是 matrix.mtx, genes.tsv (or features.tsv), and barcodes.tsv  这样的3个文件，非常有规律。</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(data.table)<br>sce =CreateSeuratObject(counts =  Read10X(<span>"./GSE135710_raw/"</span>) ,<br>                          <span>#project = gsub('.gz','',gsub('^GSM[0-9]*_','') ) ,</span><br>                          min.cells = <span>5</span>,<br>                          min.features = <span>300</span> )<br><br><span>library</span>(stringr)<br>head(rownames(sce@meta.data))<br>phe=str_split(rownames(sce@meta.data),<span>'-'</span>,simplify = <span>T</span>)<br>head(phe)<br>tail(phe)<br>table(phe[,<span>2</span>])<br>sce@meta.data$orig.ident=paste0(<span>'p'</span>,phe[,<span>2</span>])<br>table(sce@meta.data$orig.ident)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>fread 读取txt.gz格式文件<span></span></h3><p data-tool="mdnice编辑器">数据集：GSE183625</p><p data-tool="mdnice编辑器">GEO Accession viewer (nih.gov)</p><p data-tool="mdnice编辑器"><img data-ratio="0.11976047904191617" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMH57HHIBGUdicbXUkjLdDSV7HQYsUcUKJCZO8jEYg1462RPiadEErtllA/640?wx_fmt=png" data-type="png" data-w="1002" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMH57HHIBGUdicbXUkjLdDSV7HQYsUcUKJCZO8jEYg1462RPiadEErtllA/640?wx_fmt=png">导入数据</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>) <br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><br>getwd()   <br><span>library</span>(data.table)<br>dir=<span>'GSE183625_RAW/'</span> <br>samples=list.files( dir )<br>samples<br><br><span>library</span>(data.table)<br>sceList = lapply(samples,<span>function</span>(pro){ <br>  print(pro)<br>  ct=fread(file.path( dir ,pro),data.table = <span>F</span>)<br>  ct[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  rownames(ct)=ct[,<span>1</span>]<br>  ct=ct[,-<span>1</span>]<br>  sce=CreateSeuratObject(counts =  ct ,<br>                         project = gsub(<span>'.expression_matrix.txt.gz'</span>,<span>''</span>,gsub(<span>'^GSM[0-9]*_'</span>,<span>''</span>,pro) ) ,<br>                         min.cells = <span>5</span>,<br>                         min.features = <span>300</span>)<br>  <br>  <span>return</span>(sce)<br>})<br>sceList<br>samples<br></code></pre><p data-tool="mdnice编辑器">整合数据</p><pre data-tool="mdnice编辑器"><span></span><code>sce.all=merge(x=sceList[[<span>1</span>]],<br>              y=sceList[ -<span>1</span> ],<br>              add.cell.ids =   gsub(<span>'.expression_matrix.txt.gz'</span>,<span>''</span>,gsub(<span>'^GSM[0-9]*_'</span>,<span>''</span>,samples) )  )<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>fread读取单细胞测序数据csv格式<span></span></h3><p data-tool="mdnice编辑器">数据集：GSE129516</p><p data-tool="mdnice编辑器">GEO Accession viewer (nih.gov)</p><p data-tool="mdnice编辑器"><img data-ratio="0.2672672672672673" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMGWGk0NEKl7Iwhxxmuw8kiavQTTML009RIjic4YfMnV3oXtyUA1jwZs5A/640?wx_fmt=png" data-type="png" data-w="999" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMGWGk0NEKl7Iwhxxmuw8kiavQTTML009RIjic4YfMnV3oXtyUA1jwZs5A/640?wx_fmt=png">导入数据：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>) <br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br> <br><span>library</span>(data.table)<br>dir=<span>'GSE129516_RAW/'</span> <br>samples=list.files( dir )<br>samples<br><br>sceList = lapply(samples,<span>function</span>(pro){ <br>  print(pro) <br>  ct=fread(file.path( dir ,pro),data.table = <span>F</span>)<br>  ct[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  rownames(ct)=ct[,<span>1</span>]<br>  ct=ct[,-<span>1</span>]<br>  sce =CreateSeuratObject(counts =  ct ,<br>                          project =   gsub(<span>'_filtered_gene_bc_matrices.csv.gz'</span>,<span>''</span>,gsub(<span>'^GSM[0-9]*_'</span>,<span>''</span>,pro) ) ,<br>                          min.cells = <span>5</span>,<br>                          min.features = <span>300</span> )<br>  <span>return</span>(sce)<br>})<br>sceList <br>samples<br></code></pre><p data-tool="mdnice编辑器">整合数据：</p><pre data-tool="mdnice编辑器"><span></span><code>sce.all=merge(x=sceList[[<span>1</span>]],<br>              y=sceList[ -<span>1</span> ],<br>              add.cell.ids =   gsub(<span>'_filtered_gene_bc_matrices.csv.gz'</span>,<span>''</span>,gsub(<span>'^GSM[0-9]*_'</span>,<span>''</span>,samples) )  )<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>最近在读取单细胞转录组数据的时候遇到的问题<span></span></h4><p data-tool="mdnice编辑器">同样都是10X数据，在文件读取的时候也是会出现问题的，有的GEO上传上去的数据并不标准，标准的文件如下。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.2601851851851852" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMtzauz7mGm5YMxgZrzNSOoJia47pB7ViaoSJzico02ZcymWiachHYaYticnQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMtzauz7mGm5YMxgZrzNSOoJia47pB7ViaoSJzico02ZcymWiachHYaYticnQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">最近遇到的数据集是这样的，需要把第一列和第一行都切割掉。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6103896103896104" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMZeoyvlF18H6xjWt5eMGY7z47fBQAm1mxicrn5wnibTvT1hOTKRxxe5Cg/640?wx_fmt=png" data-type="png" data-w="539" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMZeoyvlF18H6xjWt5eMGY7z47fBQAm1mxicrn5wnibTvT1hOTKRxxe5Cg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">第一行不切割的话，会在读取的时候报错，文件读不进去。而且由于feature是一列的，所以需要加个参数gene.colum=1。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.10559006211180125" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMNcck2bQrIvYRML93v0kERGgj4cFNtuJ621ThzUia2MkhlZMIASicbRuA/640?wx_fmt=png" data-type="png" data-w="483" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMNcck2bQrIvYRML93v0kERGgj4cFNtuJ621ThzUia2MkhlZMIASicbRuA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">第一列不切割的话，会在使用marker gene做dotplot的时候报错，因为匹配不到细胞和基因。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.48004314994606256" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMwzmKbEWiamVbSLdO87DhnFfjaKiaPsddA2V1XWicmqsJ3BpE5Qvf45ngg/640?wx_fmt=png" data-type="png" data-w="927" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMwzmKbEWiamVbSLdO87DhnFfjaKiaPsddA2V1XWicmqsJ3BpE5Qvf45ngg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">去head一下数据的话，发现的确是这样。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5305067218200621" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMliavZtoJG1uCQwicfuppC86djdc0OvDFykYBaNWLcelvy9CZd6LNXZrQ/640?wx_fmt=png" data-type="png" data-w="967" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMliavZtoJG1uCQwicfuppC86djdc0OvDFykYBaNWLcelvy9CZd6LNXZrQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">把第一列切割后就没问题了。</p><p data-tool="mdnice编辑器">或者有条件的话可以自己跑一下上游定量流程，得到定量的数据。</p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/M15kWdH8eDONfakNhY-enA",target="_blank" rel="noopener noreferrer">原文链接</a>
