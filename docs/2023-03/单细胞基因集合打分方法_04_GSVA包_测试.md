---
title: "单细胞基因集合打分方法-04-GSVA包-测试"
date: 2023-03-11T04:19:29Z
draft: ["false"]
tags: [
  "fetched",
  "止水的小分享"
]
categories: ["Acdemic"]
---
单细胞基因集合打分方法-04-GSVA包-测试 by 止水的小分享
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span><span>写在前面</span><span> </span></h2><section>书接上回【<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzE4NDg5NQ==&amp;mid=2247484978&amp;idx=1&amp;sn=75a8e8bcfe73968efececde2fbf44991&amp;chksm=ce7d34a2f90abdb43ff8b6063255ef894022b7276babf234b73f6bb5fbdd968a46351438d4a1&amp;scene=21#wechat_redirect" target="_blank" localeditorid="90t4l1jggvg00000000">单细胞基因集合打分方法-04-GSVA包-示例</a>】，我们继续测试GSVA4种方法的鲁棒性问题，测试方面和之前测试AUCell和AddModulescore一样，从seed测试和细胞数目影响进行测试。</section><h2 data-tool="mdnice编辑器"><span></span><span>测试代码示例</span><span> </span></h2><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(GSVA)<br><span>library</span>(Seurat)<br><span>library</span>(GSEABase)<br><span>library</span>(ggplot2)<br><span>library</span>(dplyr)<br><span>library</span>(tidyr)<br>rds &lt;- readRDS(<span>"pbmc3k.final.rds"</span>)<br>signatures &lt;- <span>"gene.gmt"</span><br>geneSets &lt;- getGmt(signatures)<br><br>cb200 &lt;- sample(colnames(rds),<span>200</span>)<br>rds200 &lt;- rds[,cb200]<br><br>run_gsva &lt;- <span>function</span>(rds,slot=<span>"counts"</span>,geneSets,assay=<span>"RNA"</span>,method,seed=<span>1</span>,kcdf=<span>"Poisson"</span>,ncore=<span>1</span>){<br>set.seed(seed)<br><br>geneset  &lt;- geneIds(geneSets)<br><span>if</span>(! purrr::is_list(geneset)){<span>stop</span>(<span>"Custom geneset should be a list."</span>)}<br>    <span>if</span>(purrr::is_null(names(geneset))){names(geneset) &lt;- paste0(<span>"geneset"</span>,seq_along(geneset))}<br><br>    <span># filiter the gene sets based on rds</span><br>    <span>for</span>(i <span>in</span> seq_along(geneset)){<br>      <span>if</span>(all(stringr::str_detect(geneset[[i]], pattern = <span>"\\+$|-$"</span>)==<span>T</span>)){<br>        geneset[[i]] &lt;- geneset[[i]][stringr::str_remove(geneset[[i]],pattern = <span>"\\+$|-$"</span>) %<span>in</span>% rownames(rds)]<br>        <span>if</span>(length(geneset[[i]])==<span>0</span>){<br>          message(paste0(<span>"No genes remaining in following genesets: "</span>,names(geneset[i])))}<br>        <span>if</span>(all(stringr::str_detect(geneset[[i]], pattern = <span>"\\+$"</span>)==<span>F</span>)){<br>          message(paste0(<span>"No positive genes remaining in following genesets: "</span>,names(geneset[i])))}<br>        <span>if</span>(all(stringr::str_detect(geneset[[i]], pattern = <span>"-$"</span>)==<span>F</span>)){<br>          message(paste0(<span>"No negative genes remaining in following genesets: "</span>,names(geneset[i])))}<br>      }<span>else</span>{<br>        <span>if</span>(any(stringr::str_detect(geneset[[i]], pattern = <span>"\\+$|-$"</span>))){<br>          message(paste0(<span>"All genes need direction in following genesets: "</span>,names(geneset[i])))}<br>        geneset[[i]] &lt;- geneset[[i]][geneset[[i]] %<span>in</span>% rownames(rds)]<br>        <span>if</span>(length(geneset[[i]])==<span>0</span>){<br>          message(paste0(<span>"No genes remaining in following genesets: "</span>,names(geneset[i])))}<br>      }<br>    }<br><br>h.gsets.list &lt;- geneset %&gt;% purrr::compact()<br><br><br>matrix &lt;- Seurat::GetAssayData(object=rds, slot=slot, assay=assay)<br><br>h.gsets.list1 &lt;- h.gsets.list %&gt;% purrr::discard(.p = <span>function</span>(x){all(stringr::str_detect(x, pattern = <span>"\\+$|-$"</span>))})<br>gsva_es &lt;- gsva(as.matrix(matrix), gset.idx.list=h.gsets.list1, method=c(method), tau=<span>switch</span>(method, gsva=<span>1</span>, ssgsea=<span>0.25</span>, <span>NA</span>),kcdf=kcdf, parallel.sz=ncore) <span>#</span><br>signature_exp&lt;-data.frame(t(gsva_es))<br>rds1 &lt;- Seurat::AddMetaData(rds, as.data.frame(signature_exp))<br><span>return</span>(rds1)<br>}<br><br><span>#方法选择</span><br>method &lt;- <span>"gsva"</span><br><br><span>if</span>(method %<span>in</span>% c(<span>"gsva"</span>,<span>"ssgsea"</span>)){<br>    kcdf &lt;- <span>"Poisson"</span><br>    slot &lt;- <span>"counts"</span> <br>} <span>else</span>{<br>    kcdf &lt;- <span>"Gaussian"</span><br>    slot &lt;- <span>"data"</span><br>}<br><br><span>#测试seed</span><br><br>rds1 &lt;- run_gsva(rds=rds,slot=slot,kcdf=kcdf,geneSets=geneSets,method=method,seed=<span>1</span>)<br>metadata1 &lt;- rds1@meta.data<br>colnames(metadata1) &lt;- paste0(colnames(metadata1),<span>"_seed1"</span>)<br>rds2 &lt;- run_gsva(rds=rds,slot=slot,kcdf=kcdf,geneSets=geneSets,method=method,seed=<span>2</span>)<br>metadata2 &lt;- rds2@meta.data<br>colnames(metadata2) &lt;- paste0(colnames(metadata2),<span>"_seed2"</span>)<br>data &lt;- cbind(metadata1,metadata2)<br>p1 &lt;- ggplot(dat,aes(x=Pro_inflammatory_seed1,y=Pro_inflammatory_seed2)) + geom_point() + geom_abline(intercept=<span>0</span>,slope=<span>1</span> ,color=<span>"red"</span>)<br>print(p1)<br><br>rds1 &lt;- run_gsva(rds=rds,slot=slot,kcdf=kcdf,geneSets=geneSets,method=method,seed=<span>1</span>)<br>metadata1 &lt;- rds1@meta.data<br>colnames(metadata1) &lt;- paste0(colnames(metadata1),<span>"_seed1_1"</span>)<br>rds2 &lt;- run_gsva(rds=rds,slot=slot,kcdf=kcdf,geneSets=geneSets,method=method,seed=<span>1</span>)<br>metadata2 &lt;- rds2@meta.data<br>colnames(metadata2) &lt;- paste0(colnames(metadata2),<span>"_seed1_2"</span>)<br>data &lt;- cbind(metadata1,metadata2)<br>dat &lt;- data[,c(<span>"Pro_inflammatory_seed1_1"</span>,<span>"Pro_inflammatory_seed1_2"</span>)]<br>p2 &lt;- ggplot(dat,aes(x=Pro_inflammatory_seed1_1,y=Pro_inflammatory_seed1_2)) + geom_point() + geom_abline(intercept=<span>0</span>,slope=<span>1</span> ,color=<span>"red"</span>)<br>print(p2)<br><br><br><span>##测试纳入分析细胞数影响</span><br>rds1 &lt;- run_gsva(rds=rds200,slot=slot,kcdf=kcdf,geneSets=geneSets,method=method,seed=<span>1</span>)<br>metadata200 &lt;- rds1@meta.data<br>colnames(metadata200) &lt;- paste0(colnames(metadata200),<span>"_200"</span>)<br><br>cb100 &lt;- sample(colnames(rds200),<span>100</span>)<br>rds100 &lt;- rds[,cb100]<br>rds100_1 &lt;- run_gsva(rds=rds100,slot=slot,kcdf=kcdf,geneSets=geneSets,method=method,seed=<span>1</span>)<br>metadata100 &lt;- rds100_1@meta.data<br>colnames(metadata100) &lt;- paste0(colnames(metadata100),<span>"_100"</span>)<br><br><span>#200个细胞里面取出相同的100个细胞</span><br>metadata200 &lt;- metadata200[rownames(metadata100),]<br>data &lt;- cbind(metadata100,metadata200)<br>dat &lt;- data[,c(<span>"Pro_inflammatory_100"</span>,<span>"Pro_inflammatory_200"</span>)]<br>p3 &lt;- ggplot(dat,aes(x=Pro_inflammatory_100,y=Pro_inflammatory_200)) + geom_point() + geom_abline(intercept=<span>0</span>,slope=<span>1</span> ,color=<span>"red"</span>)<br>print(p3)<br><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>ssgsea的鲁棒性</span><span> </span></h2><h3 data-tool="mdnice编辑器"><span></span>seed影响<span></span></h3><figure data-tool="mdnice编辑器"><img data-type="png" data-ratio="0.5210727969348659" data-w="1044" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhOBkjaO2Co882sncOIsU5bo6AmMxsWvw3oCWgMvB7cD5bBZzaTDSLnOA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhOBkjaO2Co882sncOIsU5bo6AmMxsWvw3oCWgMvB7cD5bBZzaTDSLnOA/640?wx_fmt=png"><figcaption>image-20230309141034952</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>纳入的细胞数<span></span></h3><figure data-tool="mdnice编辑器"><img data-type="png" data-ratio="0.9955290611028316" data-w="671" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhOtOibNvVn5OzXhQTxmh4jSmDoQ9rGcIFjxbgpia39iccMWgQyjuiahGWW1g/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhOtOibNvVn5OzXhQTxmh4jSmDoQ9rGcIFjxbgpia39iccMWgQyjuiahGWW1g/640?wx_fmt=png"><figcaption><br></figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>GSVA的鲁棒性</span><span> </span></h2><h3 data-tool="mdnice编辑器"><span></span>seed影响<span></span></h3><figure data-tool="mdnice编辑器"><img data-type="png" data-ratio="0.5489583333333333" data-w="960" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhOEkaKhYSEibib1ias31ZyOKhgR5ptlNmorlSNRqFkjjUbQFS88cCfOdUmA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhOEkaKhYSEibib1ias31ZyOKhgR5ptlNmorlSNRqFkjjUbQFS88cCfOdUmA/640?wx_fmt=png"><figcaption><br></figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>纳入的细胞数<span></span></h3><figure data-tool="mdnice编辑器"><img data-type="png" data-ratio="0.9970104633781763" data-w="669" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhOr2qbDtQydnM7EBwb5kLlejj4QNuoqkTWMJhyUtxZibsFuT5icB6hcp3w/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhOr2qbDtQydnM7EBwb5kLlejj4QNuoqkTWMJhyUtxZibsFuT5icB6hcp3w/640?wx_fmt=png"><figcaption><br></figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>zscore的鲁棒性</span><span> </span></h2><h3 data-tool="mdnice编辑器"><span></span>seed影响<span></span></h3><figure data-tool="mdnice编辑器"><img data-type="png" data-ratio="0.49676724137931033" data-w="928" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhO6BzJADwTkNAG0XJb58pbgXEWR3yibdPalKQK8O7yv12Eg9WVanePvOw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhO6BzJADwTkNAG0XJb58pbgXEWR3yibdPalKQK8O7yv12Eg9WVanePvOw/640?wx_fmt=png"><figcaption><br></figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>纳入的细胞数<span></span></h3><figure data-tool="mdnice编辑器"><img data-type="png" data-ratio="0.9955022488755623" data-w="667" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhO5UVDbFY4AKJXywOdyIzGLibQa6TDSesHThjrZD4QMCIfNZl6aHFtRHg/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhO5UVDbFY4AKJXywOdyIzGLibQa6TDSesHThjrZD4QMCIfNZl6aHFtRHg/640?wx_fmt=png"><figcaption><br></figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>plage的鲁棒性</span><span> </span></h2><h3 data-tool="mdnice编辑器"><span></span>seed影响<span></span></h3><figure data-tool="mdnice编辑器"><img data-type="png" data-ratio="0.5265188042430087" data-w="1037" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhOv72VreXichhocjpkibjv8uYLpfxhvEtticnKMTltx7npUjhGQ7kRj9DCw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhOv72VreXichhocjpkibjv8uYLpfxhvEtticnKMTltx7npUjhGQ7kRj9DCw/640?wx_fmt=png"><figcaption><br></figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>纳入的细胞数<span></span></h3><figure data-tool="mdnice编辑器"><img data-type="png" data-ratio="0.9940029985007496" data-w="667" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhOlKrjefYrLjlOtKEfvcR4wDdUgUExdVMl4XoFbwJDxxlwfibbGgUfcJw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLu1Ho9CIWAiaUV9ficUNzXEhOlKrjefYrLjlOtKEfvcR4wDdUgUExdVMl4XoFbwJDxxlwfibbGgUfcJw/640?wx_fmt=png"><figcaption><br></figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>总结</span><span> </span></h2><section>第一，运行时间上，gsva这个方法是非常慢非常慢非常慢，重要的事情说了三遍！可见其计算速度之慢！测试我为啥用200个细胞、100个细胞就是实在太慢了！相比之下ssgsea是比较快的；</section><section>第二，GSVA包这4个方法有个共性特点，就是不收seed的影响，这是因为他们是考虑全部的基因的情况，没有随机取背景基因的事情发生；</section><section>第三，可以看到除了ssgsea以外，其他三个方法都会受到纳入细胞的影响，这是因为细胞纳入后，决定了基因的排序次序问题，不同的细胞矩阵基因排序次序不一样。ssgsea为啥不会受到纳入细胞的影响是因为他的基因排序是一个一个单独细胞进行的不考虑其他细胞的事情。</section><section>总之，如果想用GSVA包的方法在单细胞基因集合打分上对每个单独细胞进行打分，无论是计算时间和鲁棒性上，ssgsea是比较合适的方法，其余三个方法不太推荐。</section></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/TPyL3jNML2f9Vs6WHnqBOA",target="_blank" rel="noopener noreferrer">原文链接</a>
