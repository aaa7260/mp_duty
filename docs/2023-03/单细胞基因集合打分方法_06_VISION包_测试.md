---
title: "单细胞基因集合打分方法-06-VISION包-测试"
date: 2023-03-15T00:16:50Z
draft: ["false"]
tags: [
  "fetched",
  "止水的小分享"
]
categories: ["Acdemic"]
---
单细胞基因集合打分方法-06-VISION包-测试 by 止水的小分享
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span><span>写在前面</span><span> </span></h2><section>接上一期【<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MzE4NDg5NQ==&amp;mid=2247485055&amp;idx=1&amp;sn=a4b5530d82038dd751af9ab4b4971773&amp;chksm=ce7d34eff90abdf9e1d5f57de731954b8130015df4aa87c01e2a17e67d752502c62b52e409f1&amp;scene=21#wechat_redirect" target="_blank" localeditorid="8s7ehcj5b9w00000000">单细胞基因集合打分方法-06-VISION包-算法</a>】，还是老规矩实操和鲁棒性测试。</section><h2 data-tool="mdnice编辑器"><span></span><span>包的安装</span><span> </span></h2><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(devtools)<br>install_github(<span>"YosefLab/VISION"</span>)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>代码实操</span><span> </span></h2><section>为了后续方便，我封装了VISION流程中函数众多，为了方便测试，封装了函数进行。</section><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(VISION)<br><span>library</span>(GSEABase)<br><span>library</span>(tidyr)<br><br>rds &lt;- readRDS(<span>"pbmc3k.final.rds"</span>)<br>signatures &lt;- <span>"gene.gmt"</span><br><br>run_VISION &lt;- <span>function</span>(rds,signatures,assay=<span>NULL</span>,slot=<span>"counts"</span>,seed=<span>1</span>,ncores=<span>1</span>){<br>    set.seed(seed)<br>    <span>if</span> (is.null(assay)) {<br>            assay &lt;- Seurat::DefaultAssay(rds)<br>        }<br><br>    matrix &lt;- Seurat::GetAssayData(object=rds, slot=slot, assay=assay)<br>    x &lt;- as.matrix(matrix)<br>    n.umi &lt;- colSums(x)<br>    center.umi &lt;- median(n.umi)<br>    scaled_counts &lt;- t(t(x) / n.umi) * center.umi<br><br>    vis &lt;- Vision(scaled_counts, signatures = signatures,min_signature_genes = <span>1</span>)<br>    options(mc.cores = ncores)<br>    vis &lt;- analyze(vis)<br>    signature_exp &lt;- data.frame(vis@SigScores)<br>    rds &lt;- Seurat::AddMetaData(rds, signature_exp)<br>    <span>return</span>(rds)<br>}<br><br>rds1 &lt;-  run_VISION(rds = rds,signatures = signatures,seed=<span>1</span>,assay=<span>"RNA"</span>,slot=<span>"counts"</span>)<br>metadata &lt;- rds1@meta.data<br>head(metadata)<br>FeaturePlot(rds1,features=<span>"Pro_inflammatory"</span>)<br>VlnPlot(rds1,features=<span>"Pro_inflammatory"</span>)<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-type="png" data-ratio="0.5574650912996778" data-w="931" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLs489GNnvdXd8BZeeFmib7vP2nzeHesWG32oDfutzN2U92QhGKw7TYOibERdlVNAkC3CchLRbCQunvA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLs489GNnvdXd8BZeeFmib7vP2nzeHesWG32oDfutzN2U92QhGKw7TYOibERdlVNAkC3CchLRbCQunvA/640?wx_fmt=png"><figcaption>image-20230314192542187</figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>鲁棒性</span><span> </span></h2><section>还是和之前测试一样，看下随机seed和纳入细胞数的影响。</section><h3 data-tool="mdnice编辑器"><span></span>seed影响<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>rds1 &lt;-  run_VISION(rds = rds,signatures = signatures,seed=<span>1</span>,assay=<span>"RNA"</span>,slot=<span>"counts"</span>)<br>metadata1 &lt;- rds1@meta.data<br>colnames(metadata1) &lt;- paste0(colnames(metadata1),<span>"_seed1"</span>)<br>rds2 &lt;-  run_VISION(rds = rds,signatures = signatures,seed=<span>2</span>,assay=<span>"RNA"</span>,slot=<span>"counts"</span>)<br>metadata2 &lt;- rds2@meta.data<br>colnames(metadata2) &lt;- paste0(colnames(metadata2),<span>"_seed2"</span>)<br>data &lt;- cbind(metadata1,metadata2)<br>dat &lt;- data[,c(<span>"Pro_inflammatory_seed1"</span>,<span>"Pro_inflammatory_seed2"</span>)]<br>p1 &lt;- ggplot(dat,aes(x=Pro_inflammatory_seed1,y=Pro_inflammatory_seed2)) + geom_point() + geom_abline(intercept=<span>0</span>,slope=<span>1</span> ,color=<span>"red"</span>)<br>print(p1)<br><br><br>rds1 &lt;-  run_VISION(rds = rds,signatures = signatures,seed=<span>1</span>,assay=<span>"RNA"</span>,slot=<span>"counts"</span>)<br>metadata1 &lt;- rds1@meta.data<br>colnames(metadata1) &lt;- paste0(colnames(metadata1),<span>"_seed1_1"</span>)<br>rds2 &lt;-  run_VISION(rds = rds,signatures = signatures,seed=<span>1</span>,assay=<span>"RNA"</span>,slot=<span>"counts"</span>)<br>metadata2 &lt;- rds2@meta.data<br>colnames(metadata2) &lt;- paste0(colnames(metadata2),<span>"_seed1_2"</span>)<br>data &lt;- cbind(metadata1,metadata2)<br>dat &lt;- data[,c(<span>"Pro_inflammatory_seed1_1"</span>,<span>"Pro_inflammatory_seed1_2"</span>)]<br>p2 &lt;- ggplot(dat,aes(x=Pro_inflammatory_seed1_1,y=Pro_inflammatory_seed1_2)) + geom_point() + geom_abline(intercept=<span>0</span>,slope=<span>1</span> ,color=<span>"red"</span>)<br>print(p2)<br></code></pre><figure data-tool="mdnice编辑器"><img data-type="png" data-ratio="0.495618305744888" data-w="1027" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLs489GNnvdXd8BZeeFmib7vPFyb61rpia4ib2pZjy8Gp2ZicpiayP6OhfE7eTOGeXiaYfia0g1t3RUZJrMwQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLs489GNnvdXd8BZeeFmib7vPFyb61rpia4ib2pZjy8Gp2ZicpiayP6OhfE7eTOGeXiaYfia0g1t3RUZJrMwQ/640?wx_fmt=png"><figcaption>image-20230314192531999</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>纳入细胞数影响<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>cb2000 &lt;- sample(colnames(rds),<span>2000</span>)<br>rds2000 &lt;- rds[,cb2000]<br>rds2000_1 &lt;-  run_VISION(rds = rds2000,signatures = signatures,seed=<span>1</span>,assay=<span>"RNA"</span>,slot=<span>"counts"</span>)<br>metadata2000 &lt;- rds2000_1@meta.data<br>colnames(metadata2000) &lt;- paste0(colnames(metadata2000),<span>"_2000"</span>)<br><br>cb1000 &lt;- sample(colnames(rds2000),<span>1000</span>)<br>rds1000 &lt;- rds[,cb1000]<br>rds1000_1 &lt;-  run_VISION(rds = rds1000,signatures = signatures,seed=<span>1</span>,assay=<span>"RNA"</span>,slot=<span>"counts"</span>)<br>metadata1000 &lt;- rds1000_1@meta.data<br>colnames(metadata1000) &lt;- paste0(colnames(metadata1000),<span>"_1000"</span>)<br><br><span>#2000个细胞里面取出相同的1000个细胞</span><br>metadata2000 &lt;- metadata2000[rownames(metadata1000),]<br>data &lt;- cbind(metadata1000,metadata2000)<br>dat &lt;- data[,c(<span>"Pro_inflammatory_1000"</span>,<span>"Pro_inflammatory_2000"</span>)]<br><br>p3 &lt;- ggplot(dat,aes(x=Pro_inflammatory_1000,y=Pro_inflammatory_2000)) + geom_point() + geom_abline(intercept=<span>0</span>,slope=<span>1</span> ,color=<span>"red"</span>)<br>print(p3)<br></code></pre><figure data-tool="mdnice编辑器"><img data-type="png" data-ratio="0.9925149700598802" data-w="668" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLs489GNnvdXd8BZeeFmib7vPMTic2AsCDlLulcBhG7iaJc2VcBSfC1jbUicibFwfp2SpKMtHNDwlyiahYdg/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLs489GNnvdXd8BZeeFmib7vPMTic2AsCDlLulcBhG7iaJc2VcBSfC1jbUicibFwfp2SpKMtHNDwlyiahYdg/640?wx_fmt=png"><figcaption>image-20230314192612211</figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>总结</span><span> </span></h2><section>第一，VISION是一款单细胞出发设计的打分软件；</section><section>第二，VISION打分的数据分布可以看出来还是相对连续的，不受随机性seed的影响；</section><section>第三，VISION打分头疼的就是它会受到纳入细胞数的影响，这是因为它本身算法就会导致存在这个特性，因为他需要将纳入的细胞群进行PCA和Neighbors的查询，本身这个就会受到纳入细胞数的影响，因此每个细胞打分会受其他细胞的影响；</section><section>第四，这个VISION包开发了一个web app的输出结果，如下图，此外，它还嵌入了hotspot的分析功能。感兴趣的可以在参考内的链接详细了解，这里不进行介绍了，之后会随缘对这块进行打个补丁，写个番外。</section><figure data-tool="mdnice编辑器"><img data-ratio="0.6458333333333334" data-type="png" data-w="624" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLs489GNnvdXd8BZeeFmib7vPexpxmWMOvWAxeSKlNCicVxpgsDcgXwGZU48cIgiaQSE7CxTZ1uIuncWw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLs489GNnvdXd8BZeeFmib7vPexpxmWMOvWAxeSKlNCicVxpgsDcgXwGZU48cIgiaQSE7CxTZ1uIuncWw/640?wx_fmt=png"><figcaption>image-20230313222841283</figcaption></figure><section>总之，这个方法，虽然是单细胞出发，但是令人失望的是它会受到纳入细胞的影响，这个本身就不太合理，理论上来说，每个细胞的打分都应该是独立的才是符合实际情况的，不可能受到其他细胞的影响。这些情况会在具体各个算法的测评中会总结介绍。</section><section>ps：带我爸去北京看升国旗啦！昨天一整天整理资料，搞了些存稿，囧！</section><h2 data-tool="mdnice编辑器"><span></span><span>参考</span><span> </span></h2><p data-tool="mdnice编辑器">https://yoseflab.github.io/VISION/articles/VISION-vignette.html#customizing-the-latent-space</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/F39s9WNuJPSFiV2hI8Go0w",target="_blank" rel="noopener noreferrer">原文链接</a>
