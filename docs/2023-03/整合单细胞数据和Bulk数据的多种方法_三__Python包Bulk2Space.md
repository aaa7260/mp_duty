---
title: "整合单细胞数据和Bulk数据的多种方法（三）：Python包Bulk2Space"
date: 2023-03-27T15:08:22Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
整合单细胞数据和Bulk数据的多种方法（三）：Python包Bulk2Space by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">接着前两个帖子：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247510115&amp;idx=1&amp;sn=5549cab7c977410047d846df56196607&amp;scene=21#wechat_redirect" data-linktype="2">整合单细胞数据和Bulk数据的多种方法（一）：R包scAB</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247510810&amp;idx=1&amp;sn=ba0b9e20497a2847d5d141399d9cd127&amp;scene=21#wechat_redirect" data-linktype="2">整合单细胞数据和Bulk数据的多种方法（二）：R包Scissor</a></section></li></ul><p data-tool="mdnice编辑器">除了scAB和Scissor这两个工具以外，衔接单细胞数据和Bulk测序数据的方法还有scPrognosis 和DEGAS 等工具。scPrognosis是2020年发表在PLoS Comput Biol上的一个R包，专门针对乳腺癌的bulk和单细胞数据，目前引用了11次。<strong>然而作者的github（https://github.com/XiaomeiLi1/scPrognosis）并没有给出一个示例文档</strong>，我也没有那么多精力去研究里面的源代码，所以我只能放弃这个R包。。。此外，DEGAS算法是在2022年发表于Genome Med上的一个python工具，基于深度学习算法，依赖GPU。然而，我在安装这个算法的python依赖包functools时，一直报错，尽管严格按照教程的软件版本，我换了三台服务器依然是报错，所以我也放弃了这个算法。。。本以为本系列推文到此就结束了，我突然想到前段时间发表在NC上的一个工具Bulk2Space，大致目的是把bulk数据反卷积映射到空间转录组数据上。</p><p data-tool="mdnice编辑器">Bulk2Space发表在2022年10月份的Nature communications 上，题为《De novo analysis of bulk RNA-seq data at spatially resolved single-cell resolution》。Bulk2Space ( https://github.com/ZJUFanLab/bulk2space)是一种基于深度学习框架的空间反卷积算法（python环境），可以使用现有的单细胞和空间转录组学参考同时揭示Bulk RNA-seq 数据的空间和细胞异质性。</p><blockquote data-tool="mdnice编辑器"><p>不得不吐槽一句，这个算法需要基于Bulk数据+单细胞数据+空转数据，然后去推算Bulk数据的单细胞矩阵和空间位置信息，从这篇文章出来之初，我就在想这个算法有啥用。。。到今天重新读了这篇文章及其代码，我还是没搞明白这套组合拳能够去探讨一个怎么样的生物学问题？</p><p>也可能是我的认识有限，因此非常欢迎有想法的朋友在文末进行留言讨论！</p></blockquote><h3 data-tool="mdnice编辑器">一. Bulk2Space算法的工作流程</h3><figure data-tool="mdnice编辑器"><img data-ratio="0.559375" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMqLWecPtMnB500f8GZJoFvkfdNRbYGTd4KBaqWKavbw8BlOQO1pJiaBg/640?wx_fmt=other" data-type="other" data-w="640" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMqLWecPtMnB500f8GZJoFvkfdNRbYGTd4KBaqWKavbw8BlOQO1pJiaBg/640?wx_fmt=other"><figcaption>overview</figcaption></figure><p data-tool="mdnice编辑器">简言之，Bulk2Space算法需要输入Bulk数据+单细胞数据（表达矩阵+细胞类型信息）+空转数据（表达矩阵+细胞空间位置分布信息），具体格式和内容见下文实战部分。<strong>而且，从示例数据看来，每次只能针对一个样本/患者的Bulk数据进行推断，推断逻辑具体是：</strong></p><ul data-tool="mdnice编辑器"><li><section>第一步反卷积（Deconvolution）：利用单细胞参考数据对Bulk数据进行反卷积从而构建一个模拟的单细胞矩阵。注意这里的反卷积不同于CIBERSORTx、MuSiC 和贝叶斯棱镜算法（BayesPrism），这些算法结合bulk数据和单细胞数据，然后直接给我们bulk数据里的细胞类型的比例情况。<strong>而Bulk2Space是直接输出一个基于Bulk数据推断的“单细胞表达矩阵”</strong>。</section></li><li><section>第二步空间映射（Spatial mapping）：在假定的“单细胞表达矩”的基础上，将每个细胞映射到空间位置上。本质上，这和传统的单细胞数据映射到空转数据是一个逻辑。</section></li><li><section>具体的算法逻辑见b,c和d。</section></li></ul><h3 data-tool="mdnice编辑器">二. Bulk2Space的代码实现</h3><p data-tool="mdnice编辑器">本文使用PDAC示例数据集进行展示，示例数据在谷歌云盘https://drive.google.com/file/d/1xB-Gk_KLxQA320-tycJp4CFHA66zF3LE/view。考虑到很多人无法使用谷歌，我也把示例数据上传到了百度云盘：https://pan.baidu.com/s/1Z2FoobwGmKgdk6Ijky0n9Q?pwd=1234 提取码：1234</p><h4 data-tool="mdnice编辑器">Step0. 环境部署</h4><p data-tool="mdnice编辑器">Bulk2Space算法依赖python环境，需要在Linux和python IDE下进行分析：</p><pre data-tool="mdnice编辑器"><span></span><code>conda create -n bulk2space python=3.8<br>conda activate bulk2space<br><br>pip install torch --extra-index-url https://download.pytorch.org/whl/cu116<br></code></pre><p data-tool="mdnice编辑器">github上的R包下载至服务器，然后：</p><pre data-tool="mdnice编辑器"><span></span><code><span>cd</span> bulk2space-main<br>pip install -r requirements.txt<br><br>python setup.py build<br>python setup.py install<br></code></pre><h4 data-tool="mdnice编辑器">快速启动</h4><p data-tool="mdnice编辑器">要使用Bulk2Space，我们需要5个格式化的“.csv”文件作为输入(即由pandas读取)。示例数据在tutorial/data/example_data文件夹中（https://github.com/ZJUFanLab/bulk2space/blob/main/tutorial/data/example_data）。</p><p data-tool="mdnice编辑器">如果您选择基于spot的数据(如10x Genomics、ST或Slide-seq等)作为空间参考数据集，可以查阅教程:</p><ul data-tool="mdnice编辑器"><li><section>Demonstration of Bulk2Space on demo1 dataset</section></li></ul><p data-tool="mdnice编辑器">如果您选择基于图像的数据(如MERFISH、SeqFISH或STARmap等)作为空间参考，请参考:</p><ul data-tool="mdnice编辑器"><li><section>Demonstration of Bulk2Space on demo2 dataset</section></li></ul><p data-tool="mdnice编辑器">gitHub上给出了两个示例教程：</p><ul data-tool="mdnice编辑器"><li><section>Integrating spatial gene expression and histomorphology in pancreatic ductal adenocarcinoma (PDAC)</section></li><li><section>Spatially resolved analysis of mouse hypothalamus by Bulk2Space</section></li></ul><h4 data-tool="mdnice编辑器">Step1. 加载依赖包</h4><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> scanpy<br><span>import</span> pandas <span>as</span> pd<br><span>import</span> numpy <span>as</span> np<br><span>import</span> matplotlib.colors <span>as</span> clr<br><span>import</span> matplotlib.pyplot <span>as</span> plt<br><span>from</span> scipy.stats <span>import</span> pearsonr<br><br><span>import</span> bulk2space<br><span>from</span> bulk2space <span>import</span> Bulk2Space<br>model = Bulk2Space()<br></code></pre><p data-tool="mdnice编辑器">这里我们检查一下示例数据的构成。示例数据包括Bulk数据+单细胞数据（表达矩阵+细胞类型信息）+空转数据（表达矩阵+细胞空间位置分布信息），共5个csv文件，具体如下：</p><ul data-tool="mdnice编辑器"><li><section>pdac_bulk.csv bulk数据，单样本的一个表达矩阵</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>pdac_bulk = pd.read_csv(<span>'tutorial/data/pdac/pdac_bulk.csv'</span>)<br>print(pdac_bulk)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6219281663516069" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMyyzgBGZuBibe3MFicLfMicqegXUMH3LaGce5KMZMjPyCfPTh2VhtBqKww/640?wx_fmt=other" data-type="other" data-w="529" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMyyzgBGZuBibe3MFicLfMicqegXUMH3LaGce5KMZMjPyCfPTh2VhtBqKww/640?wx_fmt=other"><figcaption>image-20230323172422109</figcaption></figure><ul data-tool="mdnice编辑器"><li><section>sc_data.csv 单细胞表达矩阵，单样本的一个表达矩阵，示例数据包含了1927个单细胞</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>sc_data = pd.read_csv(<span>'tutorial/data/pdac/sc_data.csv'</span>)<br>print(sc_data)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.089430894308943" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMVDVgLXib9lKgbtLBGCI4cywKEpalaNBL3ZXCzLMhKqPYqhgbkxv2CPw/640?wx_fmt=other" data-type="other" data-w="615" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMVDVgLXib9lKgbtLBGCI4cywKEpalaNBL3ZXCzLMhKqPYqhgbkxv2CPw/640?wx_fmt=other"><figcaption>image-20230323172604646</figcaption></figure><ul data-tool="mdnice编辑器"><li><section>sc_meta.csv 单细胞表型数据，包含单细胞的细胞类型</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>sc_meta = pd.read_csv(<span>'tutorial/data/pdac/sc_meta.csv'</span>)<br>print(sc_meta)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6104417670682731" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWM3E0856hou18r1nhsproU076xxuDM2l17Eaib4ra8rzJALpoXiaXTr78w/640?wx_fmt=other" data-type="other" data-w="498" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWM3E0856hou18r1nhsproU076xxuDM2l17Eaib4ra8rzJALpoXiaXTr78w/640?wx_fmt=other"><figcaption>image-20230323172725678</figcaption></figure><ul data-tool="mdnice编辑器"><li><section>st_data.csv 空转表达矩阵，示例数据包含429个spot。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>st_data = pd.read_csv(<span>'tutorial/data/pdac/st_data.csv'</span>)<br>print(st_data)<br></code></pre><ul data-tool="mdnice编辑器"><li><section>st_data.csv 空转表型数据，包含spot的空间位置坐标。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>st_meta = pd.read_csv(<span>'tutorial/data/pdac/st_meta.csv'</span>)<br>print(st_meta)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6772009029345373" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMMO1lJ2eTTpbGuu4fSk3fDjtRJuu7vd8uHT0pkXtlT9MeiaeFs5iaDdpg/640?wx_fmt=other" data-type="other" data-w="443" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMMO1lJ2eTTpbGuu4fSk3fDjtRJuu7vd8uHT0pkXtlT9MeiaeFs5iaDdpg/640?wx_fmt=other"><figcaption>image-20230323172929958</figcaption></figure><h4 data-tool="mdnice编辑器">Step2. 将bulk-seq数据分解为scRNA-seq数据</h4><pre data-tool="mdnice编辑器"><span></span><code>generate_sc_meta, generate_sc_data = model.train_vae_and_generate(<br>    input_bulk_path=<span>'tutorial/data/pdac/pdac_bulk.csv'</span>,<br>    input_sc_data_path=<span>'tutorial/data/pdac/sc_data.csv'</span>,<br>    input_sc_meta_path=<span>'tutorial/data/pdac/sc_meta.csv'</span>,<br>    input_st_data_path=<span>'tutorial/data/pdac/st_data.csv'</span>,<br>    input_st_meta_path=<span>'tutorial/data/pdac/st_meta.csv'</span>,<br>    ratio_num=<span>1</span>,<br>    top_marker_num=<span>200</span>,<br>    gpu=<span>0</span>,<br>    batch_size=<span>512</span>,<br>    learning_rate=<span>1e-4</span>,<br>    hidden_size=<span>256</span>,<br>    epoch_num=<span>3500</span>,<br>    vae_save_dir=<span>'tutorial/data/pdac/predata/save_model'</span>,<br>    vae_save_name=<span>'pdac_vae'</span>,<br>    generate_save_dir=<span>'tutorial/data/pdac/predata/output'</span>,<br>    generate_save_name=<span>'pdac'</span>)<br></code></pre><p data-tool="mdnice编辑器">其实这个示例数据单细胞和空转数据并不大，但是我在运行的时候，这个步骤花了好久。。。</p><h5 data-tool="mdnice编辑器">2.1 绘制生成的scRNA-seq数据的细胞类型比例</h5><p data-tool="mdnice编辑器">运行成功之后，生成的generate_sc_meta和generate_sc_data分别代表从bulk数据中反卷积获得的假定的单细胞表型数据（即细胞类型）和表达矩阵，可以可视化一下生成的细胞类型数量：</p><pre data-tool="mdnice编辑器"><span></span><code><span># The number of cells per cell type in deconvoluted bulk-seq data</span><br>ct_stat = pd.DataFrame(generate_sc_meta[<span>'Cell_type'</span>].value_counts())<br>ct_name = list(ct_stat.index)<br>ct_num = list(ct_stat[<span>'Cell_type'</span>])<br>color = [<span>"#14B8A6"</span>, <span>"#EF4444"</span>, <span>'#F97316'</span>, <span>"#7C3AED"</span>, <span>'#64748B'</span>, <span>'#3B82F6'</span>, <span>"#0EA5E9"</span>, <br>         <span>'#F59E0B'</span>, <span>'#10B981'</span>, <span>'#EC4899'</span>, <span>"#7DD3FC"</span>, <span>"#F472B6"</span>, <span>"#D946EF"</span>]<br>plt.bar(ct_name, ct_num, color=color)<br>plt.xticks(ct_name, ct_name, rotation=<span>90</span>)<br>plt.title(<span>"The number of cells per cell type in bulk-seq data"</span>)<br>plt.xlabel(<span>"Cell type"</span>)<br>plt.ylabel(<span>"Cell number"</span>)<br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.9388111888111889" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMOq7jlPTDOpk6iccCcgA9bHlcAibh87ibkVaXKEqnaunTS0JJ0P8Wicl0kQ/640?wx_fmt=other" data-type="other" data-w="572" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMOq7jlPTDOpk6iccCcgA9bHlcAibh87ibkVaXKEqnaunTS0JJ0P8Wicl0kQ/640?wx_fmt=other"><figcaption>image-20230323173152334</figcaption></figure><h5 data-tool="mdnice编辑器">2.2 计算scRNA-seq参考数据和生成的scRNA-seq数据之间的标记基因表达相关性</h5><p data-tool="mdnice编辑器">此外，我们也可以比较真实的单细胞数据的细胞类型marker和bulk反卷积得到的单细胞细胞类型的marker的相似度：</p><pre data-tool="mdnice编辑器"><span></span><code><span># load input sc data</span><br>input_data = bulk2space.utils.load_data(<br>    input_bulk_path=<span>'tutorial/data/pdac/pdac_bulk.csv'</span>,<br>    input_sc_data_path=<span>'tutorial/data/pdac/sc_data.csv'</span>,<br>    input_sc_meta_path=<span>'tutorial/data/pdac/sc_meta.csv'</span>,<br>    input_st_data_path=<span>'tutorial/data/pdac/st_data.csv'</span>,<br>    input_st_meta_path=<span>'tutorial/data/pdac/st_meta.csv'</span><br>)<br><br><span># Calculate 200 marker genes of each cell type</span><br>sc = scanpy.AnnData(input_data[<span>'input_sc_data'</span>].T)<br>sc.obs = input_data[<span>'input_sc_meta'</span>][[<span>'Cell_type'</span>]]<br>scanpy.tl.rank_genes_groups(sc, <span>'Cell_type'</span>, method=<span>'wilcoxon'</span>)<br>marker_df = pd.DataFrame(sc.uns[<span>'rank_genes_groups'</span>][<span>'names'</span>]).head(<span>200</span>)<br>marker = list(np.unique(np.ravel(np.array(marker_df))))<br><br><span># the mean expression of 200 marker genes of input sc data</span><br>sc_marker = input_data[<span>'input_sc_data'</span>].loc[marker, :].T<br>sc_marker[<span>'Cell_type'</span>] = input_data[<span>'input_sc_meta'</span>][<span>'Cell_type'</span>]<br>sc_marker_mean = sc_marker.groupby(<span>'Cell_type'</span>)[marker].mean()<br><br><span># the mean expression of 200 marker genes of deconvoluted bulk-seq data</span><br>generate_sc_meta.index = list(generate_sc_meta[<span>'Cell'</span>])<br>generate_sc_data_new = generate_sc_data.T<br>generate_sc_data_new[<span>'Cell_type'</span>] = generate_sc_meta[<span>'Cell_type'</span>]<br>generate_sc_marker_mean = generate_sc_data_new.groupby(<span>'Cell_type'</span>)[marker].mean()<br><br>intersect_cell = list(set(sc_marker_mean.index).intersection(set(generate_sc_marker_mean.index)))<br>generate_sc_marker_mean= generate_sc_marker_mean.loc[intersect_cell]<br>sc_marker_mean= sc_marker_mean.loc[intersect_cell]<br><br><span># calculate correlation</span><br>sc_marker_mean = sc_marker_mean.T<br>generate_sc_marker_mean = generate_sc_marker_mean.T<br><br>coeffmat = np.zeros((sc_marker_mean.shape[<span>1</span>], generate_sc_marker_mean.shape[<span>1</span>]))<br><span>for</span> i <span>in</span> range(sc_marker_mean.shape[<span>1</span>]):    <br>    <span>for</span> j <span>in</span> range(generate_sc_marker_mean.shape[<span>1</span>]):        <br>        corrtest = pearsonr(sc_marker_mean[sc_marker_mean.columns[i]], <br>                            generate_sc_marker_mean[generate_sc_marker_mean.columns[j]])  <br>        coeffmat[i,j] = corrtest[<span>0</span>]<br>        <br>rf_ct = list(sc_marker_mean.columns)<br>generate_ct = list(generate_sc_marker_mean.columns)<br><br><span># plot</span><br>fig, ax = plt.subplots()<br>im = ax.imshow(coeffmat, cmap=<span>'RdBu_r'</span>)<br>ax.set_xticks(np.arange(len(rf_ct)))<br>ax.set_xticklabels(rf_ct)<br>ax.set_yticks(np.arange(len(generate_ct)))<br>ax.set_yticklabels(generate_ct)<br>plt.xlabel(<span>"scRNA-seq reference"</span>)<br>plt.ylabel(<span>"deconvoluted bulk-seq"</span>)<br>plt.setp(ax.get_xticklabels(), rotation=<span>90</span>, ha=<span>"right"</span>, rotation_mode=<span>"anchor"</span>)<br>plt.colorbar(im)<br>ax.set_title(<span>"Expression correlation"</span>)<br>fig.tight_layout()<br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.9328358208955224" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMnTZnr8Fodujd2OxbL0raKHgBLmKWCp67nzicU9WW51CQYgxUwlic2rlw/640?wx_fmt=other" data-type="other" data-w="536" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMnTZnr8Fodujd2OxbL0raKHgBLmKWCp67nzicU9WW51CQYgxUwlic2rlw/640?wx_fmt=other"><figcaption>image-20230323173432299</figcaption></figure><h4 data-tool="mdnice编辑器">Step3. 将ST数据分解为空间分辨的单细胞转录组数据</h4><pre data-tool="mdnice编辑器"><span></span><code>df_meta, df_data = model.train_df_and_spatial_deconvolution(<br>    generate_sc_meta,<br>    generate_sc_data,<br>    input_st_data_path=<span>'tutorial/data/pdac/st_data.csv'</span>,<br>    input_st_meta_path=<span>'tutorial/data/pdac/st_meta.csv'</span>,<br>    spot_num=<span>500</span>,<br>    cell_num=<span>10</span>,<br>    df_save_dir=<span>'tutorial/data/pdac/predata/save_model/'</span>,<br>    df_save_name=<span>'pdac_df'</span>,<br>    map_save_dir=<span>'tutorial/data/pdac/result'</span>, <br>    map_save_name=<span>'pdac'</span>,<br>    top_marker_num=<span>200</span>,<br>    marker_used=<span>True</span>,<br>    k=<span>10</span>)<br></code></pre><p data-tool="mdnice编辑器">利用深度学习模型，将空转数据分解。</p><h4 data-tool="mdnice编辑器">Step4. 用单细胞分辨率绘制空间反褶积结果</h4><p data-tool="mdnice编辑器">我们首先研究了单细胞分辨率的空间反褶积结果。结果表明腺泡细胞、癌细胞和导管细胞具有明显的空间分布规律，与组织形态一致。</p><pre data-tool="mdnice编辑器"><span></span><code><span># Spatial mapping with single cell resolution</span><br>ct_type = list(df_meta[<span>'Cell_type'</span>].unique())<br>color = [<span>"#EF4444"</span>, <span>"#10B981"</span>, <span>'#14B8A6'</span>, <span>"#7C3AED"</span>, <span>'#3B82F6'</span>, <span>'#64748B'</span>, <span>"#D946EF"</span>, <br>         <span>'#F59E0B'</span>, <span>'#F97316'</span>, <span>'#7DD3FC'</span>, <span>"#F472B6"</span>, <span>"#EC4899"</span>]<br><br>fig, ax = plt.subplots(figsize=(<span>8</span>,<span>8</span>))<br><span>for</span> i <span>in</span> range(len(ct_type)):<br>    ax.scatter(df_meta.loc[df_meta.Cell_type == ct_type[i], <span>'Cell_xcoord'</span>],<br>               df_meta.loc[df_meta.Cell_type == ct_type[i], <span>'Cell_ycoord'</span>],<br>               color = color[i], label = ct_type[i], s = <span>15</span>)<br><br><br>plt.title(<span>"Spatial mapping with single cell resolution"</span>)<br>plt.xlabel(<span>"Cell_xcoord"</span>)<br>plt.ylabel(<span>"Cell_ycoord"</span>)<br>plt.legend(bbox_to_anchor=(<span>1</span>, <span>0.2</span>), loc=<span>3</span>, borderaxespad=<span>0</span>, frameon=<span>False</span>, fontsize=<span>15</span>)<br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.753125" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMHxMQMpKb1ZToY3RljDhHicCBwkfOSm8ic6pbjhA5aRqSe8ogRUnXCgWg/640?wx_fmt=other" data-type="other" data-w="640" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMHxMQMpKb1ZToY3RljDhHicCBwkfOSm8ic6pbjhA5aRqSe8ogRUnXCgWg/640?wx_fmt=other"><figcaption>image-20230323173635343</figcaption></figure><h4 data-tool="mdnice编辑器">Step5. 用单细胞分辨率绘制标记基因的空间表达谱</h4><p data-tool="mdnice编辑器">标记基因的空间表达模式也与细胞类型的空间分布一致。</p><pre data-tool="mdnice编辑器"><span></span><code><span># gene expression</span><br>plot = df_meta<br>plot.index = list(plot[<span>'Cell'</span>])<br><span># 'REG1A': Acinar cells; 'CLDN1': Cancer clone A; 'KRT16': Cancer clone B; 'MUC5B': Ductal</span><br>gene = [<span>'REG1A'</span>, <span>'CLDN1'</span>, <span>'KRT16'</span>, <span>'MUC5B'</span>]<br>plot[gene] = df_data.T[gene]<br>xcoord = np.array(plot[<span>'Cell_xcoord'</span>])<br>ycoord = np.array(plot[<span>'Cell_ycoord'</span>])<br>gene1 = np.array(plot[<span>'REG1A'</span>])<br>gene2 = np.array(plot[<span>'CLDN1'</span>])<br>gene3 = np.array(plot[<span>'KRT16'</span>])<br>gene4 = np.array(plot[<span>'MUC5B'</span>])<br><br>fig, axs = plt.subplots(<span>1</span>, <span>4</span>, figsize=(<span>12</span>, <span>3</span>))<br><br>a = axs[<span>0</span>].scatter(xcoord, ycoord, s=<span>2.5</span>, cmap=<span>'viridis'</span>, c=gene1)<br>fig.colorbar(a, ax=axs[<span>0</span>])<br>axs[<span>0</span>].set_title(<span>'REG1A'</span>)<br><br>b = axs[<span>1</span>].scatter(xcoord, ycoord, s=<span>2.5</span>, cmap=<span>'viridis'</span>, c=gene2)<br>fig.colorbar(b, ax=axs[<span>1</span>])<br>axs[<span>1</span>].set_title(<span>'CLDN1'</span>)<br><br>c = axs[<span>2</span>].scatter(xcoord, ycoord, s=<span>2.5</span>, cmap=<span>'viridis'</span>, c=gene3)<br>fig.colorbar(c, ax=axs[<span>2</span>])<br>axs[<span>2</span>].set_title(<span>'KRT16'</span>)<br><br>d = axs[<span>3</span>].scatter(xcoord, ycoord, s=<span>2.5</span>, cmap=<span>'viridis'</span>, c=gene4)<br>fig.colorbar(d, ax=axs[<span>3</span>])<br>axs[<span>3</span>].set_title(<span>'MUC5B'</span>)<br><br>plt.tight_layout()<br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.2453125" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMJfaXKrUib7ZSdyiaWcJxPSj5BuTpzmcvlI3ZXpsyEggXpVZ9HF31Rjhg/640?wx_fmt=other" data-type="other" data-w="640" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMJfaXKrUib7ZSdyiaWcJxPSj5BuTpzmcvlI3ZXpsyEggXpVZ9HF31Rjhg/640?wx_fmt=other"><figcaption>image-20230323173834492</figcaption></figure><h4 data-tool="mdnice编辑器">Step6. 在spot分辨率下探讨反卷积结果</h4><pre data-tool="mdnice编辑器"><span></span><code><span># spot-level</span><br><span># calculate cell type proportion per spot</span><br>prop = df_meta[[<span>'Cell'</span>, <span>'Cell_type'</span>, <span>'Spot'</span>]].pivot_table(index=[<span>'Spot'</span>], columns=[<span>'Cell_type'</span>], aggfunc=<span>'count'</span>,values = <span>'Cell'</span>, fill_value=<span>0</span>)<br>prop = prop.div(prop.sum(axis=<span>1</span>), axis=<span>0</span>)<br>prop.columns = pd.Index(list(prop.columns))<br>prop[<span>'Spot_xcoord'</span>] = np.array(df_meta.pivot_table(index=[<span>'Spot'</span>])[<span>'Spot_xcoord'</span>])<br>prop[<span>'Spot_ycoord'</span>] = np.array(df_meta.pivot_table(index=[<span>'Spot'</span>])[<span>'Spot_ycoord'</span>])<br><br><span># aggregate gene expression per spot</span><br>pred_spot_new = df_data.T<br>genes = pred_spot_new.columns<br>pred_spot_new[<span>'Spot'</span>] = df_meta[<span>'Spot'</span>]<br>pred_spot_mean = pred_spot_new.groupby(<span>'Spot'</span>)[genes].mean()<br></code></pre><h5 data-tool="mdnice编辑器">6.1 绘制每个点的单元格类型比例</h5><pre data-tool="mdnice编辑器"><span></span><code><span># plot cell type proportion</span><br><span># Acinar cells; Cancer clone A; Cancer clone B; Ductal</span><br>spot_x = np.array(prop[<span>'Spot_xcoord'</span>])<br>spot_y = np.array(prop[<span>'Spot_ycoord'</span>])<br>cell1 = np.array(prop[<span>'Acinar cells'</span>])<br>cell2 = np.array(prop[<span>'Cancer clone A'</span>])<br>cell3 = np.array(prop[<span>'Cancer clone B'</span>])<br>cell4 = np.array(prop[<span>'Ductal'</span>])<br><br>fig, axs = plt.subplots(<span>1</span>, <span>4</span>, figsize=(<span>12</span>, <span>3</span>))<br><br>a = axs[<span>0</span>].scatter(spot_x, spot_y, s=<span>10</span>, cmap=<span>'viridis'</span>, c=cell1)<br>fig.colorbar(a, ax=axs[<span>0</span>])<br>axs[<span>0</span>].set_title(<span>'Acinar cells'</span>)<br><br>b=axs[<span>1</span>].scatter(spot_x, spot_y, s=<span>10</span>, cmap=<span>'viridis'</span>, c=cell2)<br>fig.colorbar(b, ax=axs[<span>1</span>])<br>axs[<span>1</span>].set_title(<span>'Cancer clone A'</span>)<br><br>c=axs[<span>2</span>].scatter(spot_x, spot_y, s=<span>10</span>, cmap=<span>'viridis'</span>, c=cell3)<br>fig.colorbar(c, ax=axs[<span>2</span>])<br>axs[<span>2</span>].set_title(<span>'Cancer clone B'</span>)<br><br>d=axs[<span>3</span>].scatter(spot_x, spot_y, s=<span>10</span>, cmap=<span>'viridis'</span>, c=cell4)<br>fig.colorbar(d, ax=axs[<span>3</span>])<br>axs[<span>3</span>].set_title(<span>'Ductal'</span>)<br><br>plt.tight_layout()<br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.2375" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMBibRibX50fT0nJL1I362WjrQ7r0pw5UlxguaEUKGog4w87lLlApIIKjg/640?wx_fmt=other" data-type="other" data-w="640" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWMBibRibX50fT0nJL1I362WjrQ7r0pw5UlxguaEUKGog4w87lLlApIIKjg/640?wx_fmt=other"><figcaption>image-20230323174004342</figcaption></figure><h5 data-tool="mdnice编辑器">6.2 绘制每个spot的基因表达量</h5><pre data-tool="mdnice编辑器"><span></span><code><span># plot gene expression proportion</span><br><span># 'REG1A': Acinar cells; 'CLDN1': Cancer clone A; 'KRT16': Cancer clone B; 'MUC5B': Ductal</span><br>spot_x = np.array(prop[<span>'Spot_xcoord'</span>])<br>spot_y = np.array(prop[<span>'Spot_ycoord'</span>])<br>g1 = np.array(pred_spot_mean[<span>'REG1A'</span>])<br>g2 = np.array(pred_spot_mean[<span>'CLDN1'</span>])<br>g3 = np.array(pred_spot_mean[<span>'KRT16'</span>])<br>g4 = np.array(pred_spot_mean[<span>'MUC5B'</span>])<br><br>fig, axs = plt.subplots(<span>1</span>, <span>4</span>, figsize=(<span>12</span>, <span>3</span>))<br><br>a = axs[<span>0</span>].scatter(spot_x, spot_y, s=<span>10</span>, cmap=<span>'viridis'</span>, c=g1)<br>fig.colorbar(a, ax=axs[<span>0</span>])<br>axs[<span>0</span>].set_title(<span>'REG1A'</span>)<br><br>b=axs[<span>1</span>].scatter(spot_x, spot_y, s=<span>10</span>, cmap=<span>'viridis'</span>, c=g2)<br>fig.colorbar(b, ax=axs[<span>1</span>])<br>axs[<span>1</span>].set_title(<span>'CLDN1'</span>)<br><br>c=axs[<span>2</span>].scatter(spot_x, spot_y, s=<span>10</span>, cmap=<span>'viridis'</span>, c=g3)<br>fig.colorbar(c, ax=axs[<span>2</span>])<br>axs[<span>2</span>].set_title(<span>'KRT16'</span>)<br><br>d=axs[<span>3</span>].scatter(spot_x, spot_y, s=<span>10</span>, cmap=<span>'viridis'</span>, c=g4)<br>fig.colorbar(d, ax=axs[<span>3</span>])<br>axs[<span>3</span>].set_title(<span>'MUC5B'</span>)<br><br>plt.tight_layout()<br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.2390625" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWM6I4ZdrBiaJBFYSvMCKnk7EsC6Yu8auB52d8hIWtxN8Hc7hsWA1CJctA/640?wx_fmt=other" data-type="other" data-w="640" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosicMdhpu44CPDjUpibiaicTdyWM6I4ZdrBiaJBFYSvMCKnk7EsC6Yu8auB52d8hIWtxN8Hc7hsWA1CJctA/640?wx_fmt=other"><figcaption>image-20230323174048962</figcaption></figure><h3 data-tool="mdnice编辑器">三. 写在最后</h3><p data-tool="mdnice编辑器">关于Bulk2Space算法的实际用途，我唯一想到的是，针对稀有样本如果只有Bulk数据，同时存在单细胞分辨率下的数据，且存在空转级别的数据，然后利用这个算法去推断bulk数据，扩大单细胞/空转的样本量。此外，还可以用这个算法，基于bulk数据，来验证单细胞和空转的结果（有一点鸡生蛋，蛋生鸡的悖论感。。。）。除此之外，大家觉得这个算法还能讲一些什么故事呢？欢迎在文末进行留言。</p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/GZAoS1ACW6IsN8kuAVZzew",target="_blank" rel="noopener noreferrer">原文链接</a>
