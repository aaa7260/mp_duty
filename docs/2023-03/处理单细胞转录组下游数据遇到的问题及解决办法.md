---
title: "处理单细胞转录组下游数据遇到的问题及解决办法"
date: 2023-03-30T05:07:34Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
处理单细胞转录组下游数据遇到的问题及解决办法 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h4 data-tool="mdnice编辑器"><span></span>Question 1<span></span></h4><blockquote data-tool="mdnice编辑器"><p>最近在做一个单细胞转录组测序的数据集的时候。在降维分群后，画dotplot的时候cluster不按照正常的数字排序显示，使用factor对cluster设置levels。</p><p>first_sce.Rdata为做过QC，降维分群和harmony后的数据。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><br>dir.create(<span>"./2-markers"</span>)<br>setwd(<span>"./2-markers/"</span>)<br>getwd()<br>load(file = <span>'../1-QC/first_sce.Rdata'</span>) <br><br>sce &lt;- FindClusters(sce, resolution = <span>0.8</span>)<br>DimPlot(sce,reduction = <span>"umap"</span>,label=<span>T</span> )<br><br><span>library</span>(ggplot2) <br>genes_to_check = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <br>                   <span>'CD4'</span>,<span>'CD8A'</span>,<span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span>,<br>                   <span>'IGHG1'</span>, <span>'MZB1'</span>, <span>'SDC1'</span>,<br>                   <span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>, <br>                   <span>'TPSAB1'</span> , <span>'TPSB2'</span>,  <span># mast cells,</span><br>                   <span>'RCVRN'</span>,<span>'FPR1'</span> , <span>'ITGAM'</span> ,<br>                   <span>'C1QA'</span>,  <span>'C1QB'</span>,  <span># mac</span><br>                   <span>'S100A9'</span>, <span>'S100A8'</span>, <span>'MMP19'</span>,<span># monocyte</span><br>                   <span>'LAMP3'</span>, <span>'IDO1'</span>,<span>'IDO2'</span>,<span>## DC3 </span><br>                   <span>'CD1E'</span>,<span>'CD1C'</span>, <span># DC2</span><br>                   <span>'KLRB1'</span>,<span>'NCR1'</span>, <span># NK </span><br>                   <span>'FGF7'</span>,<span>'MME'</span>, <span>'ACTA2'</span>,<br>                   <span>'PECAM1'</span>, <span>'VWF'</span>, <br>                   <span>'DCN'</span>, <span>'LUM'</span>,  <span>'GSN'</span> , <span>## mouse PDAC fibo </span><br>                   <span>'MKI67'</span>,<span>'TOP2A'</span>,<br>                   <span>'EPCAM'</span> , <span>'KRT19'</span>, <span>'PROM1'</span>, <span>'ALDH1A1'</span> )<br><span>library</span>(stringr)  <br><span># str_to_title</span><br><span># str_to_upper()</span><br>genes_to_check=str_to_upper(genes_to_check)<br>genes_to_check<br>p1 &lt;- DotPlot(sce, features = unique(genes_to_check),<br>             assay=<span>'RNA'</span> ,scale = <span>T</span>,<br>             group.by = <span>"RNA_snn_res.0.8"</span> )  + coord_flip()<br><br>p1  <br>ggsave(p1,file=<span>'check_out_cluster_RNA_snn_res.0.8.pdf'</span>,width = <span>14</span>,height = <span>10</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7139938712972421" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9EE2wVrtpfwSEbH3bKwPHJxo1KD1Q0Dqkqo3vyaR6icr1hJGh2Q0bFDhoocdGBFN9kf6utf6RyJeg/640?wx_fmt=png" data-type="png" data-w="979" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9EE2wVrtpfwSEbH3bKwPHJxo1KD1Q0Dqkqo3vyaR6icr1hJGh2Q0bFDhoocdGBFN9kf6utf6RyJeg/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>My_levels&lt;-c(<span>"0"</span>,<span>"1"</span>,<span>"2"</span>,<span>"3"</span>,<span>"4"</span>,<span>"5"</span>,<span>"6"</span>,<span>"7"</span>,<span>"8"</span>,<span>"9"</span>,<span>"10"</span>,<span>"11"</span>,<span>"12"</span>,<span>"13"</span>,<span>"14"</span>,<span>"15"</span>,<span>"16"</span>,<span>"17"</span>,<span>"18"</span>,<span>"19"</span>,<span>"20"</span>,<span>"21"</span>,<span>"22"</span>,<span>"23"</span>,<span>"24"</span>,<span>"25"</span>,<span>"26"</span>,<span>"27"</span>,<span>"28"</span>,<span>"29"</span>,<span>"30"</span>,<span>"31"</span>)<br>sce$RNA_snn_res.0.8<br>sce$RNA_snn_res.0.8&lt;-factor(sce$RNA_snn_res.0.8,levels= My_levels)<br>sce$RNA_snn_res.0.8<br><br>genes_to_check<br>p1 &lt;- DotPlot(sce, features = unique(genes_to_check),<br>             assay=<span>'RNA'</span> ,scale = <span>T</span>,<br>             group.by = <span>"RNA_snn_res.0.8"</span> )  + coord_flip()<br><br>p1  <br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.9386422976501305" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9EE2wVrtpfwSEbH3bKwPHJKwtUPWYAyWvBSoK2SNh9I96xY7gUnO928kzDGlbBdC5pEFWicB8okGw/640?wx_fmt=png" data-type="png" data-w="766" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9EE2wVrtpfwSEbH3bKwPHJKwtUPWYAyWvBSoK2SNh9I96xY7gUnO928kzDGlbBdC5pEFWicB8okGw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">这么看level就正常了。</p><h4 data-tool="mdnice编辑器"><span></span>Question 2<span></span></h4><blockquote data-tool="mdnice编辑器"><p>在跑曾老师scissor算法的代码的时候，遇到了一个报错。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br><br><span>#devtools::install_github('sunduanchen/Scissor')</span><br><span>library</span>(Seurat)<br><span>library</span>(Scissor)<br>load(<span>'input/scRNA-seq.RData'</span>)<br>load(<span>'input/TCGA_LUAD_exp1.RData'</span>)<br>load(<span>'input/TCGA_LUAD_survival.RData'</span>)<br><br>dim(sc_dataset)<br>sc_dataset &lt;- Seurat_preprocessing(sc_dataset, <br>                                   min.cells = <span>3</span>,<br>                                   min.features = <span>400</span> ,<br>                                   verbose = <span>T</span>)<br>DimPlot(sc_dataset, reduction = <span>'umap'</span>, label = <span>T</span>, label.size = <span>10</span>)<br>sc_dataset<br><br>dim(bulk_dataset)<br>head(bulk_survival)<br>table(colnames(bulk_dataset) == bulk_survival$TCGA_patient_barcode) <span>#确认生存数据的样本顺序是和表达矩阵一致的</span><br>phenotype &lt;- bulk_survival[,<span>2</span>:<span>3</span>]<br>colnames(phenotype) &lt;- c(<span>"time"</span>, <span>"status"</span>)<br>head(phenotype)<span>#</span><br>identical(colnames(bulk_dataset) ,row.names(phenotype))<br>row.names(phenotype) = colnames(bulk_dataset)<br><br><span># 数据有56716个基因， 471个样本。</span><br><span># 执行Scissor算法，对细胞进行分类</span><br>infos1 &lt;- Scissor(bulk_dataset, sc_dataset, phenotype, alpha = <span>0.05</span>, <br>                  family = <span>"cox"</span>, Save_file = <span>'Scissor_LUAD_survival.RData'</span>)<br><br><span>#Error in normalize.quantiles(dataset0) : ERROR; return code from pthread_create() is 22</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.1907051282051282" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9EE2wVrtpfwSEbH3bKwPHJzLP3kB7sMVy5JiaVicDyJltPObkKB9tgANdEc6jzxJUygS7MrkOmeLWw/640?wx_fmt=png" data-type="png" data-w="624" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9EE2wVrtpfwSEbH3bKwPHJzLP3kB7sMVy5JiaVicDyJltPObkKB9tgANdEc6jzxJUygS7MrkOmeLWw/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p>在小郭老师和永杰的帮助下了解到这个报错是由于一个R包的问题，才造成scissor分析计算的时候报错。</p></blockquote><p data-tool="mdnice编辑器">解决方法：</p><p data-tool="mdnice编辑器">https://github.com/sunduanchen/Scissor/issues/15</p><pre data-tool="mdnice编辑器"><span></span><code><span>#使用这个代码，重新安装 preprocessCore </span><br>BiocManager::install(<span>"preprocessCore"</span>, configure.args=<span>"--disable-threading"</span>, force = <span>TRUE</span>)<br><span>#重启Rstudio 或者退出</span><br><span>#重新加载R包运行</span><br></code></pre><p data-tool="mdnice编辑器">这样就成功解决了问题，后续代码可以运行了~</p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/OmZ7jpuRJiW8Vp4zWqNWRQ",target="_blank" rel="noopener noreferrer">原文链接</a>
