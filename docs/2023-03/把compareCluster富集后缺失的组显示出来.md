---
title: "把compareCluster富集后缺失的组显示出来"
date: 2023-03-28T07:32:31Z
draft: ["false"]
tags: [
  "fetched",
  "果子学生信"
]
categories: ["Acdemic"]
---
把compareCluster富集后缺失的组显示出来 by 果子学生信
------
<div><section data-mpa-powered-by="yiban.io"><p>你有没有想过差异基因做富集分析的时候，究竟该输入什么基因？<br>全体？上调？下调？<br>如果搞不清的时候就都做一下，看看有什么差别，然后就知道以后该怎么做了。<br>正好Y叔的<code>compareCluster</code> 函数就可以做这个，简直是神器。</p><h4><span>准备测试数据(差异分析结果)</span></h4><pre><code>rm(list = ls())<br><span>library</span>(clusterProfiler)<br><span>library</span>(dplyr)<br><span>library</span>(tibble)<br>load(file = <span>"output/DEseq2_ESR1_Diff.Rdata"</span>)<br></code></pre><p>数据的名称是res，数据的内容就是Deseq2差异分析的结果，也可以是limma芯片的结果</p><figure><img data-ratio="0.5578231292517006" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfedgC1h19via0atq9wCO4lrsZmgTwWGhKe6e4S10OuwqzE7V5BOcQwCA/640?wx_fmt=png" data-type="png" data-w="1323" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfedgC1h19via0atq9wCO4lrsZmgTwWGhKe6e4S10OuwqzE7V5BOcQwCA/640?wx_fmt=png"></figure><p>只要有基因和排序的标准就行，这里我们筛选p值小于0.05的，基因变化倍数不做要求，只用它来排序</p><pre><code>diffgene &lt;- res %&gt;% <br>  <span>filter</span>(gene !=<span>""</span>) %&gt;% <br>  <span>filter</span>(adj.P.Val &lt; <span>0.05</span>) %&gt;% <br>  arrange(desc(logFC))<br></code></pre><p>现在留下的都是p值小于0.05，按照logFC从高到低排序的表格了<br></p><figure><img data-ratio="0.5043069694596711" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwf6z51SJmr7jPTrcP7iba45YiaTQhIT5celEk2RoDedCPibIJ4qwJ064saQ/640?wx_fmt=png" data-type="png" data-w="1277" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwf6z51SJmr7jPTrcP7iba45YiaTQhIT5celEk2RoDedCPibIJ4qwJ064saQ/640?wx_fmt=png"></figure><p>分别提取升高的基因和降低的基因</p><pre><code><span>upgeneall</span> &lt;- diffgene<span>$gene</span>[diffgene<span>$logFC</span>&gt;<span>0</span>]<br>dngeneall &lt;- diffgene<span>$gene</span>[diffgene<span>$logFC</span>&lt;<span>0</span>]<br></code></pre><p>因为这些基因被排过序，升高的就是按照从高到底排序<br>降低的基因，logfc是负的，他的绝对值logFC是越来越大的</p><h4><span>compareCluster 的输入和执行</span></h4><p>分别选取，需要输入的差异基因</p><pre><code><span>## 选取一定数目上调基因</span><br><span>upgene</span> = head(upgeneall,<span>3000</span>)<br><span>## 选取一定数目下调基因</span><br><span>dngene</span> = tail(dngeneall,<span>3000</span>)<br></code></pre><p>compareCluster 的输入文件可以是个list，里面放上不同组的基因<br>我们这里就输入上调，下调，以及全部基因</p><pre><code>gcSample = list(up = upgene,<br>                down = dngene,<br>                all = c(upgene,dngene))<br></code></pre><p>加载基因集,这里用hallmarks作为测试，可以在board下载得到</p><pre><code><span>h_df</span> &lt;- read.gmt(<span>"resource/h.all.v2022.1.Hs.symbols.gmt"</span>)<br></code></pre><p>正式运行,</p><pre><code>dd &lt;- compareCluster(gcSample, <span><span>fun</span>="enricher",TERM2GENE = h_df)</span><br></code></pre><p>此处就是三个参数，<br>第一，gcSample就是我们给的多组数据，也可以是单细胞每个亚群的marker基因<br>第二，富集分析函数<code>enriche</code>,Y 叔的神奇之处在于，他创造了这个通用的富集分数<br>你不用再究竟KEGG分析，GO分析，只要是个基因集，他都能做，真正的解放思想。<br>第三，是<code>enriche</code>函数的第二个参数（可以逗号隔开更多的参数哦），就是这里的基因集。<br>以上的代码，可以实现任意基因集的ORA分析，可谓是真正的万能代码。</p><p>接下来就可以用极其简单熟悉的代码来实现作图啦</p><pre><code>dotplot(dd,label_format = 60)<br></code></pre><figure><img data-ratio="0.7598705501618123" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwflWsJ0kMA63nYqbUuYcobic3sO619UhFYEOh9f5eN5JBp1HuSiaGemO4g/640?wx_fmt=png" data-type="png" data-w="1545" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwflWsJ0kMA63nYqbUuYcobic3sO619UhFYEOh9f5eN5JBp1HuSiaGemO4g/640?wx_fmt=png"></figure><p>这是一个ESR1敲减的数据，所以在这个图上我们能看到两个雌激素相关的通路被富集了。<br>而且，是在下调的基因中富集到的，他十分符合生物学背景。<br>如果我们只用上调的基因是得到不到结果的，用全部的基因，可以富集但是不知道是激活和抑制。<br>因此，我觉得以后，这串代码应该成为差异基因富集分析的标配。</p><h4><span>特殊情况处理</span></h4><p>如果我们换一个数据集，比如KEGG的，结果就会有点不一样，</p><pre><code>h_df &lt;- read.gmt(<span>"resource/c2.cp.kegg.v2022.1.Hs.symbols.gmt"</span>)<br>dd &lt;- compareCluster(gcSample, <span><span>fun</span>="enricher",TERM2GENE = h_df)</span><br>dotplot(dd,label_format = <span>60</span>)<br></code></pre><p>图出来了，但是我们发现少了下调的富集结果<br></p><figure><img data-ratio="0.7475474166121648" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwf4oabf2kibicYdxKRNaDic8xSwZlFUWNC71XrFMp5ic8DWf2Ik7JwwceDDA/640?wx_fmt=png" data-type="png" data-w="1529" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwf4oabf2kibicYdxKRNaDic8xSwZlFUWNC71XrFMp5ic8DWf2Ik7JwwceDDA/640?wx_fmt=png"></figure><p>这个结果本身没有问题，但是你放在文章中，需要额外解释，</p><blockquote><p>我们也是做了下调基因的富集分析的，就是没有富集到。</p></blockquote><p>这个还能理解，如果6个大群的单细胞数据进行这样的分群富集分析，缺少2-3个后，解释起来就不直观。<br>那么，现在的需求是，能不能把缺失的组给我显示出来，即使没有富集到任何结果？<br>答案是肯定的啊。</p><h4><span>ggplot2显示缺失的组</span></h4><p>我们创建一个数据，把其中一个分组信息的因子水平改成3个</p><pre><code>df &lt;- data.frame(<span>type</span>=c(<span>"A"</span>, <span>"A"</span>, <span>"A"</span>, <span>"B"</span>, <span>"B"</span>), group=<span>rep</span>(<span>"group1"</span>, <span>5</span>))<br>df$<span>type</span> &lt;- factor(df$<span>type</span>, levels=c(<span>"A"</span>,<span>"B"</span>, <span>"C"</span>))<br></code></pre><p>就是这样的数据，type总共就呈现两类数据，因子的水平是三个，ABC<br></p><figure><img data-ratio="1.1358885017421603" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfBadkIdyJib10a2O163QC2MNbBZToVMVoicdg2Kqu2d05dlP8dFkic4jibQ/640?wx_fmt=png" data-type="png" data-w="287" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfBadkIdyJib10a2O163QC2MNbBZToVMVoicdg2Kqu2d05dlP8dFkic4jibQ/640?wx_fmt=png"></figure><p>直接画图</p><pre><code><span>library</span>(ggplot2)<br>ggplot(df, aes(x=<span>type</span>)) + geom_bar()<br></code></pre><p>他只会显示两组<br></p><figure><img data-ratio="0.7514563106796116" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfJxCGhgFU6CNdpSuXkd9VxU6Oy93MZuEDtiaSlE2gkYYGicPSib3Pt2niag/640?wx_fmt=png" data-type="png" data-w="1545" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfJxCGhgFU6CNdpSuXkd9VxU6Oy93MZuEDtiaSlE2gkYYGicPSib3Pt2niag/640?wx_fmt=png"></figure><p>重点来了，X轴的分类，是由因子的水平决定的，只是在画图过程中，缺少内容的因子水平被去掉了<br>我们可以通过这句代码，把他保留下来。</p><pre><code>scale_x_discrete(<span>drop</span>=<span>FALSE</span>)<br></code></pre><p>重新画图看看</p><pre><code>ggplot(df, aes(x=type)) + geom_bar() + scale_x_discrete(<span>drop</span>=<span>FALSE</span>)<br></code></pre><p>看看C组，虽然没有东西，但是组别还是显示出来了，这就是我们想要的效果<br></p><figure><img data-ratio="0.7503225806451613" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwf4UzRd9bt3HYIs08wsibDVyO70DIRqbSnMBzgOxf1aqjiaLsJEyu3IOYQ/640?wx_fmt=png" data-type="png" data-w="1550" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwf4UzRd9bt3HYIs08wsibDVyO70DIRqbSnMBzgOxf1aqjiaLsJEyu3IOYQ/640?wx_fmt=png"></figure><p>知道了实现方法，接下来就是需要改造<code>compareCluster</code>的富集结果</p><h4><span>修改内部数据，欺骗作图函数</span></h4><p>图就是数据画出来的，所以我们要看看数据在哪里<br>Y叔这一系列的富集数据，都可以通过<code>as.data.frame</code>来获取</p><pre><code>h_df &lt;- read.gmt(<span>"resource/c2.cp.kegg.v2022.1.Hs.symbols.gmt"</span>)<br>dd &lt;- compareCluster(gcSample, <span><span>fun</span>="enricher",TERM2GENE = h_df)</span><br><span>data</span> &lt;- <span>as</span>.<span>data</span>.frame(dd)<br></code></pre><p>我们在数据中看到了X轴的数据，就是Cluster这一类，确实只有up和all这两类<br></p><figure><img data-ratio="0.5822873082287309" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfWvJicKN6XI0XFpibRJcTSB6icRODNJc4LuI3U3ITLZZfTRDQlRue6CymQ/640?wx_fmt=png" data-type="png" data-w="1434" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfWvJicKN6XI0XFpibRJcTSB6icRODNJc4LuI3U3ITLZZfTRDQlRue6CymQ/640?wx_fmt=png"></figure><p>那么我们只要改一下这一列的因子水平就可以了。<br>但是实际上最终不能实现，因为这还不是最终的画图数据。<br>因为Y叔在画图前，用了<code>fortify</code>这个函数对数据进行了预先处理，添加了额外的信息。<br>比如在这里，cluster实际上并不单纯是up和all<br></p><figure><img data-ratio="0.7373935821872953" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfibbjA6qcMGDaicuQTOgFLMiaFNndcn3C5hib85miaf1gFCLWMzWUTGTLQaw/640?wx_fmt=png" data-type="png" data-w="1527" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfibbjA6qcMGDaicuQTOgFLMiaFNndcn3C5hib85miaf1gFCLWMzWUTGTLQaw/640?wx_fmt=png"></figure><p>他还添加了有效输入基因数目(782和1429)，提供了更加丰富的信息。</p><p>所以现在不应该修改这个数据，而是最终画图的数据。<br>我曾经说过，Y叔对我最大的影响就是下面这句话</p><blockquote><p>图就是数据，数据就是图。</p></blockquote><p>因此我们现在图画出来，再把它变成数据，就可以啦</p><pre><code>p <span>&lt;<span>-</span> <span>dotplot</span>(<span>dd</span>,<span>label_format</span> = <span>60)</span><br></span></code></pre><p>此时p是一个数据，是个拥有10个元素的list<br>而画图数据data就藏在里面<br></p><figure><img data-ratio="0.2812215132178669" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwficBibRDI5p5tpPvia36dqGW6VqEFiaAlAh4El0c6icOsybMLLAFeib0voEkA/640?wx_fmt=png" data-type="png" data-w="2194" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwficBibRDI5p5tpPvia36dqGW6VqEFiaAlAh4El0c6icOsybMLLAFeib0voEkA/640?wx_fmt=png"></figure><p>这个cluster列才是我们真正需要的<br></p><figure><img data-ratio="0.4757213230119634" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfYtOybIoOO7k1UeAOzofPWzib4sBJ8ScgZibJgG0Jtcv8LDibTbGN4YiaAw/640?wx_fmt=png" data-type="png" data-w="1421" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfYtOybIoOO7k1UeAOzofPWzib4sBJ8ScgZibJgG0Jtcv8LDibTbGN4YiaAw/640?wx_fmt=png"></figure><p>提取这个数据，发现他是一个factor，因子水平只有2个<br></p><figure><img data-ratio="0.19492219492219492" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfebPdQeAicyaokr3F2XEveRUhKXO9QGEMFQg8Wxo9EgKvyribFn5iaElWA/640?wx_fmt=png" data-type="png" data-w="1221" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfebPdQeAicyaokr3F2XEveRUhKXO9QGEMFQg8Wxo9EgKvyribFn5iaElWA/640?wx_fmt=png"></figure><p>这就好办了，我们给他添加进去就行啦。</p><pre><code>p<span>$data</span><span>$Cluster</span> &lt;- factor(p<span>$data</span><span>$Cluster</span>,levels =c(<span>"up\n(782)"</span>,<span>"down\n(0)"</span>,<span>"all\n(1429)"</span>) )<br></code></pre><p>此刻再来作图</p><pre><code>p + scale_x_discrete(<span>drop</span>=<span>FALSE</span>)<br></code></pre><p>完美呈现，我们可以感受到富集出来的通路都是上调基因的结果，可以认为是激活的，下调的基因当前没有贡献。<br>这个如果展示的是单细胞群marker的富集结果，可以表现出通路的特异性。<br></p><figure><img data-ratio="0.7516297262059974" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwflVmRVRJ3JgjxKVsTibmvxEhMTmHjIqSKCkvEibODzX1173nIOJYiaDXMw/640?wx_fmt=png" data-type="png" data-w="1534" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwflVmRVRJ3JgjxKVsTibmvxEhMTmHjIqSKCkvEibODzX1173nIOJYiaDXMw/640?wx_fmt=png"></figure><p>但是这个图是由瑕疵的，因为我在down那里给的数值是0，不应该是0，而应该是合法的输入基因数目。</p><h4><span>知道需求后，进一步修改</span></h4><p>这些数据，在Y叔的结果中都是提供的。</p><p>我们只需要让他不过滤，我们自己能看一眼就行啦</p><pre><code>dd1 &lt;- compareCluster(gcSample, <span><span>fun</span>="enricher",TERM2GENE = h_df,pvalueCutoff = 1,qvalueCutoff = 1)</span><br>data1 &lt;- <span>as</span>.<span>data</span>.frame(dd1)<br></code></pre><p>通过结果我们可以看到，上调的是782，下调的是647<br></p><figure><img data-ratio="0.4419713831478537" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfJHvkLATdCVnDYibz1jxdgRBqSkjn5TF1BxM8FFGqMGEiaYqnPLjlSfCw/640?wx_fmt=png" data-type="png" data-w="1887" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfJHvkLATdCVnDYibz1jxdgRBqSkjn5TF1BxM8FFGqMGEiaYqnPLjlSfCw/640?wx_fmt=png"></figure><p>此外，上调加上下调应该等于总体。所以，即使不做这个操作<br>我们做个减法也能得到结果</p><pre><code><span>1429-782</span>=<span>647</span><br></code></pre><p>此刻我们重新修改一下图片</p><pre><code><span>p</span> &lt;- dotplot(dd)<br>p<span>$data</span><span>$Cluster</span> &lt;- factor(p<span>$data</span><span>$Cluster</span>,levels =c(<span>"up\n(782)"</span>,<span>"down\n(647)"</span>,<span>"all\n(1429)"</span>) )<br>p + scale_x_discrete(drop=FALSE)<br></code></pre><figure><img data-ratio="0.8318965517241379" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfF81WKlibQibcMibwWexd3CHsolBZjcg8NibzUiavicUSHmGialZkxkNmSVBVA/640?wx_fmt=png" data-type="png" data-w="1392" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfF81WKlibQibcMibwWexd3CHsolBZjcg8NibzUiavicUSHmGialZkxkNmSVBVA/640?wx_fmt=png"></figure><br>但是多组的情况下，你还得过来看，这里贡献一串代码，自动提多个组别数据</section><section><pre><code>dd1 &lt;- compareCluster(gcSample, <span><span>fun</span>="enricher",TERM2GENE = h_df,pvalueCutoff = 1,qvalueCutoff = 1)</span><br>data1 &lt;- <span>as</span>.<span>data</span>.frame(dd1)<br>data1 &lt;- data1 %&gt;% <br>  select(Cluster,GeneRatio) %&gt;% <br>  mutate(GeneRatio = gsub(<span>"\\d+/"</span>,<span>""</span>,GeneRatio)) %&gt;% <br>  distinct(Cluster,.keep_all = T)<br></code></pre><p>看看这个结果，再多的组都不怕了<br></p><figure><img data-ratio="0.637883008356546" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfojTn78QLX3fC8jEoicT989HXnVHFic26Aict41h9lYJczIVsIRCkfFoIA/640?wx_fmt=png" data-type="png" data-w="359" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX22MnAHChDhDE5ia6HT3nGwfojTn78QLX3fC8jEoicT989HXnVHFic26Aict41h9lYJczIVsIRCkfFoIA/640?wx_fmt=png"></figure><p>如果你还不满意，不想在自定义因子水平的时候手工写，我还可以把代码再调整一下</p><pre><code>dd1 &lt;- compareCluster(gcSample, <span><span>fun</span>="enricher",TERM2GENE = h_df,pvalueCutoff = 1,qvalueCutoff = 1)</span><br>data1 &lt;- <span>as</span>.<span>data</span>.frame(dd1)<br>data2 &lt;- data1 %&gt;% <br>  select(Cluster,GeneRatio) %&gt;% <br>  mutate(GeneRatio = gsub(<span>"\\d+/"</span>,<span>""</span>,GeneRatio)) %&gt;% <br>  distinct(Cluster,.keep_all = T) %&gt;% <br>  mutate(level = paste0(Cluster,<span>"\n"</span>,<span>"("</span>,GeneRatio,<span>")"</span>))<br>dput(data2$level)<br></code></pre><p>他会自动生成这样的字符串,堪称懒癌福利</p><pre><code><span>c</span>(<span>"up\n(782)"</span>, <span>"down\n(647)"</span>, <span>"all\n(1429)"</span>)<br></code></pre><p>我写这么多，实际上只要Y叔愿意，他可以轻松的加上一些代码，在神不知鬼不觉的情况下完成这些操作，<br>但是，当你看到这里的时候，你难道不觉得，自己能写代码，能自由探索更有趣么。<br>而这才是我真正的目的啊，激发你的兴趣，让你觉得，我也可以。</p><h4><span>关于富集分析最后的思考</span></h4><p>在这个例子中，我们的ESR1敲减数据。<br>使用hallmarks 基因集能够富集过雌激素通路，而且我们看到是抑制的。<br>但是使用广为人知的KEGG却没有能够得到有效信息，你认为是什么原因呢？<br>是不是应该不要把分析局限在特定的基因集，而是应该跳出去接受更多的信息呢。</p><p>而这个就是<code>enricher</code>这个函数的使命啊，他跟<code>GSEA</code>的用法几乎一致。<br>富集分析背后的支撑就是基因集，<br>而基因集是前人经验的积累和总结，<br>我们在探索数据时，应该光谱的把能做的基因集都尝试来一遍，然后再尝试整合这些前人的知识。<br>做到在没有开展实验前，胸有成竹。<br>而这个整合能力，又是功夫在诗外了啊。</p><p>下一次，我再来展示一下<code>compareCluster</code> 函数更加神奇的使用。</p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/dHQtS18FsyRT-0XSieCXWQ",target="_blank" rel="noopener noreferrer">原文链接</a>
