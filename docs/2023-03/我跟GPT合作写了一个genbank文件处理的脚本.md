---
title: "我跟GPT合作写了一个genbank文件处理的脚本"
date: 2023-03-28T15:13:10Z
draft: ["false"]
tags: [
  "fetched",
  "洲更的第二大脑"
]
categories: ["Acdemic"]
---
我跟GPT合作写了一个genbank文件处理的脚本 by 洲更的第二大脑
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">事情起因是这样子，我有个genbank文件，里面记录的是线粒体的注释的坐标信息。由于这个注释是来源同源注释，可能存在错误，因此还需要后续的手动修改。我没去找到专门的工具，只是根据分析结果，手动改了里面一些基因的坐标，就导致里面的translation这一栏跟坐标对不上，需要更新一下。虽然我有能力写这个代码去更新结果，但是我希望给GPT(模型turbo 3.5)一个机会，让他处理下。</p><p data-tool="mdnice编辑器">首先，我问了它关于genbank的格式定义，确保它后续能够进行处理。他的回答非常正确，符合我的认知（下面是对话截图）</p><figure data-tool="mdnice编辑器"><img data-ratio="0.7944444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/hiaSZLAw0jibSoN6EZC7XxfZhYgYbM7TmwYjQIicic8GIshDB6cYVY3tyAF3eG6PgOibkytC9PqjunMW8ljNmq232aw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/hiaSZLAw0jibSoN6EZC7XxfZhYgYbM7TmwYjQIicic8GIshDB6cYVY3tyAF3eG6PgOibkytC9PqjunMW8ljNmq232aw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">接下来我就开始问问题了，我让他编写脚本，让我调整坐标，它写了一段python 的代码，通过调用BioPython模块来实现我刚才说的功能。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5444444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/hiaSZLAw0jibSoN6EZC7XxfZhYgYbM7TmwhDxO1DFKkz7eDQqaibRgjF3iauC1En0aYxbCddOBqeKuy4ibyZsyzAzUA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/hiaSZLAw0jibSoN6EZC7XxfZhYgYbM7TmwhDxO1DFKkz7eDQqaibRgjF3iauC1En0aYxbCddOBqeKuy4ibyZsyzAzUA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">但是这代码有问题，因为通用性比较差，所以我让他改写代码，有一个遍历过程，先得到新的CDS，然后和原来的translation进行比较，如果存在不同则替换</p><p data-tool="mdnice编辑器">它的工作非常棒，下面是它给的结果。</p><pre data-tool="mdnice编辑器"><span></span><code><span>from</span> Bio <span>import</span> SeqIO<br><br><span># 读取GenBank文件</span><br>record = SeqIO.read(<span>"your_genbank_file.gb"</span>, <span>"genbank"</span>)<br><br><span># 遍历所有CDS区域</span><br><span>for</span> feature <span>in</span> record.features:<br>    <span>if</span> feature.type == <span>"CDS"</span>:<br>        <span># 获取原始位置信息</span><br>        old_start = feature.location.start<br>        old_end = feature.location.end<br>        <br>        <span># 修改位置信息为新的位置</span><br>        new_start = <span>100</span>  <span># 新的起始位置</span><br>        new_end = <span>500</span>  <span># 新的终止位置</span><br>        feature.location = feature.location._shifted(new_start - old_start)<br>        feature.location = feature.location._shifted(new_end - old_end)<br>        <br>        <span># 更新翻译信息</span><br>        old_translation = feature.qualifiers.get(<span>"translation"</span>, [<span>""</span>])[<span>0</span>]<br>        new_sequence = feature.extract(record.seq)  <span># 提取新序列</span><br>        new_translation = new_sequence.translate(to_stop=<span>True</span>)  <span># 计算新的翻译信息</span><br>        new_translation_str = str(new_translation)<br>        <span>if</span> new_translation_str != old_translation:<br>            feature.qualifiers[<span>"translation"</span>] = [new_translation_str]<br><br><span># 写回GenBank文件</span><br><span>with</span> open(<span>"modified_genbank_file.gb"</span>, <span>"w"</span>) <span>as</span> output_handle:<br>    SeqIO.write(record, output_handle, <span>"genbank"</span>)<br><br></code></pre><p data-tool="mdnice编辑器">不过它总是念念不忘他的new_start 和 new_ned，这显然不是我需要的，所以，我让他把这部分去掉。下面截图是我的提问和它的回答。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.48333333333333334" data-src="https://mmbiz.qpic.cn/mmbiz_png/hiaSZLAw0jibSoN6EZC7XxfZhYgYbM7Tmw3Gy0WAQGbFHt1pPkIzf9z3yE3icNxpafaU2GzlzUwP9JNgbcukIGhyw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/hiaSZLAw0jibSoN6EZC7XxfZhYgYbM7Tmw3Gy0WAQGbFHt1pPkIzf9z3yE3icNxpafaU2GzlzUwP9JNgbcukIGhyw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">这次代码简洁多了。不过他还不是一个合格的代码，因为调用只能是固定的文件名，我希望它能进一步提高通用性，所以我的提问是“好的，进一步提供他的通用性，使得我们可以在命令行通过 python remake.py input.gb output.gb来实现文件的重新生成”</p><p data-tool="mdnice编辑器">这次他的回答更加的棒，它用了argparse模块，并将原来的代码函数化，下面是他的回答。</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> argparse<br><span>from</span> Bio <span>import</span> SeqIO<br><br><br><span><span>def</span> <span>update_cds_translation</span><span>(record, new_positions)</span>:</span><br>    <span>"""<br>    更新GenBank记录中所有CDS区域的翻译信息并返回修改后的记录。<br>    :param record: GenBank记录对象<br>    :param new_positions: 包含每个CDS区域新起始和终止位置的dict对象<br>    :return: 修改后的GenBank记录对象<br>    """</span><br>    <span>for</span> feature <span>in</span> record.features:<br>        <span>if</span> feature.type == <span>"CDS"</span>:<br>            <span># 获取CDS区域原始序列和翻译信息</span><br>            old_sequence = feature.extract(record.seq)<br>            old_translation = feature.qualifiers.get(<span>"translation"</span>, [<span>""</span>])[<span>0</span>]<br><br>            <span># 获取CDS区域新位置</span><br>            start, end = new_positions.get(feature.qualifiers[<span>'gene'</span>][<span>0</span>], (feature.location.start, feature.location.end))<br><br>            <span># 调整CDS区域位置并计算新翻译信息</span><br>            feature.location = feature.location._shifted(start - feature.location.start)<br>            feature.location = feature.location._shifted(end - feature.location.end)<br>            new_sequence = feature.extract(record.seq)<br>            new_translation = new_sequence.translate(to_stop=<span>True</span>)<br>            new_translation_str = str(new_translation)<br><br>            <span># 如果翻译信息不同，则更新qualifiers字段</span><br>            <span>if</span> new_translation_str != old_translation:<br>                feature.qualifiers[<span>"translation"</span>] = [new_translation_str]<br><br>    <span>return</span> record<br><br><br><span>if</span> __name__ == <span>'__main__'</span>:<br>    <span># 解析命令行参数</span><br>    parser = argparse.ArgumentParser(description=<span>"Update CDS translations in a GenBank file."</span>)<br>    parser.add_argument(<span>"input"</span>, help=<span>"Input GenBank file name"</span>)<br>    parser.add_argument(<span>"output"</span>, help=<span>"Output GenBank file name"</span>)<br>    parser.add_argument(<span>"-p"</span>, <span>"--positions"</span>, help=<span>"New start and end positions for each gene, e.g. 'gene1:100-500 gene2:200-600'"</span>, default=<span>""</span>)<br>    args = parser.parse_args()<br><br>    <span># 读取GenBank文件和新位置信息</span><br>    record = SeqIO.read(args.input, <span>"genbank"</span>)<br>    new_positions = {gene_pos.split(<span>":"</span>)[<span>0</span>]: tuple(map(int, gene_pos.split(<span>":"</span>)[<span>1</span>].split(<span>"-"</span>))) <span>for</span> gene_pos <span>in</span> args.positions.strip().split()}<br><br>    <span># 更新CDS翻译信息并写回GenBank文件</span><br>    updated_record = update_cds_translation(record, new_positions)<br>    <span>with</span> open(args.output, <span>"w"</span>) <span>as</span> output_handle:<br>        SeqIO.write(updated_record, output_handle, <span>"genbank"</span>)<br><br></code></pre><p data-tool="mdnice编辑器">更惊喜的是，在它的解释中，它还扩展了功能，它说道</p><blockquote data-tool="mdnice编辑器"><span>❝</span><p>此代码使用argparse模块解析命令行参数，并根据提供的输入文件名和输出文件名读取和写入GenBank记录。它还允许通过命令行参数-p/--positions指定每个基因的新起始和终止位置，方式为'gene1:100-500 gene2:200-600'。如果不提供此参数，则使用每个CDS区域的原始位置。最后，它调用update_cds_translation函数来更新所有CDS区域的翻译信息，然后将修改后的GenBank记录写回到输出文件中。</p><span>❞</span></blockquote><p data-tool="mdnice编辑器">我觉得差不多了，并复制了代码，开始运行，然后我报错了。错误信息如下</p><pre data-tool="mdnice编辑器"><span></span><code>我运行了代码，出现了如下报错，我应该如何处理<br>Traceback (most recent call last):<br>  File "/Users/xuzhougeng/Downloads/remake.py", line 48, in &lt;module&gt;<br>    updated_record = update_cds_translation(record, new_positions)<br>  File "/Users/xuzhougeng/Downloads/remake.py", line 22, in update_cds_translation<br>    feature.location = feature.location._shifted(start - feature.location.start)<br>AttributeError: 'FeatureLocation' object has no attribute '_shifted'<br></code></pre><p data-tool="mdnice编辑器">我直接复制了这段代码，问gpt怎么办，它推断是biopython的版本问题，还给我写了一个更加通用的代码，新的代码如下</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> argparse<br><span>from</span> Bio <span>import</span> SeqIO, SeqFeature<br><br><br><span><span>def</span> <span>update_cds_translation</span><span>(record, new_positions)</span>:</span><br>    <span>"""<br>    更新GenBank记录中所有CDS区域的翻译信息并返回修改后的记录。<br>    :param record: GenBank记录对象<br>    :param new_positions: 包含每个CDS区域新起始和终止位置的dict对象<br>    :return: 修改后的GenBank记录对象<br>    """</span><br>    <span>for</span> feature <span>in</span> record.features:<br>        <span>if</span> feature.type == <span>"CDS"</span>:<br>            <span># 获取CDS区域原始序列和翻译信息</span><br>            old_sequence = feature.extract(record.seq)<br>            old_translation = feature.qualifiers.get(<span>"translation"</span>, [<span>""</span>])[<span>0</span>]<br><br>            <span># 获取CDS区域新位置</span><br>            start, end = new_positions.get(feature.qualifiers[<span>'gene'</span>][<span>0</span>], (feature.location.start, feature.location.end))<br><br>            <span># 调整CDS区域位置并计算新翻译信息</span><br>            offset_start = start - feature.location.start<br>            offset_end = end - feature.location.end<br>            new_location = SeqFeature.FeatureLocation(<br>                feature.location.start + offset_start,<br>                feature.location.end + offset_end,<br>                feature.location.strand<br>            )<br>            new_sequence = feature.extract(record.seq)<br>            new_translation = new_sequence.translate(to_stop=<span>True</span>)<br>            new_translation_str = str(new_translation)<br><br>            <span># 如果翻译信息不同，则更新qualifiers字段</span><br>            <span>if</span> new_translation_str != old_translation:<br>                feature.qualifiers[<span>"translation"</span>] = [new_translation_str]<br><br>            <span># 更新位置信息</span><br>            feature.location = new_location<br><br>    <span>return</span> record<br><br><br><span>if</span> __name__ == <span>'__main__'</span>:<br>    <span># 解析命令行参数</span><br>    parser = argparse.ArgumentParser(description=<span>"Update CDS translations in a GenBank file."</span>)<br>    parser.add_argument(<span>"input"</span>, help=<span>"Input GenBank file name"</span>)<br>    parser.add_argument(<span>"output"</span>, help=<span>"Output GenBank file name"</span>)<br>    parser.add_argument(<span>"-p"</span>, <span>"--positions"</span>, help=<span>"New start and end positions for each gene, e.g. 'gene1:100-500 gene2:200-600'"</span>, default=<span>""</span>)<br>    args = parser.parse_args()<br><br>    <span># 读取GenBank文件和新位置信息</span><br>    record = SeqIO.read(args.input, <span>"genbank"</span>)<br>    new_positions = {gene_pos.split(<span>":"</span>)[<span>0</span>]: tuple(map(int, gene_pos.split(<span>":"</span>)[<span>1</span>].split(<span>"-"</span>))) <span>for</span> gene_pos <span>in</span> args.positions.strip().split()}<br><br>    <span># 更新CDS翻译信息并写回GenBank文件</span><br>    updated_record = update_cds_translation(record, new_positions)<br>    <span>with</span> open(args.output, <span>"w"</span>) <span>as</span> output_handle:<br>        SeqIO.write(updated_record, output_handle, <span>"genbank"</span>)<br><br></code></pre><p data-tool="mdnice编辑器">这个代码对不对呢？至少我跑完是没有报错的，我进一步的检查了它的分析结果。发现很多CDS的长度明显短了，我觉得这可能是我没有说清楚，我给的是线粒体基因组。我讲这个结果反馈给了gpt，它认可了我的推测，下面是他的回答。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.2601851851851852" data-src="https://mmbiz.qpic.cn/mmbiz_png/hiaSZLAw0jibSoN6EZC7XxfZhYgYbM7TmwUm5Okjia0W3uC4Pc08t89Eib9EriblTfyRlFgXk4tsiaWVWM2SxeTmD9wQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/hiaSZLAw0jibSoN6EZC7XxfZhYgYbM7TmwUm5Okjia0W3uC4Pc08t89Eib9EriblTfyRlFgXk4tsiaWVWM2SxeTmD9wQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">后来我们又反反复复商量了好几轮，对代码反复打磨，通常都是它给出了建议，我询问他是不是有另一种解决思路，比如说有些genbank文件里的cds长度有问题，不一定是3的倍数，他建议我对处理来的文件，我觉得可以考虑捕获报错，他也执行的特别好。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6222222222222222" data-src="https://mmbiz.qpic.cn/mmbiz_png/hiaSZLAw0jibSoN6EZC7XxfZhYgYbM7TmwUXAQ5xAt1wn79XiaUqy0yicNrWvWoY7ricUnXyX2iaLIAb3DFRBFicianOww/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/hiaSZLAw0jibSoN6EZC7XxfZhYgYbM7TmwUXAQ5xAt1wn79XiaUqy0yicNrWvWoY7ricUnXyX2iaLIAb3DFRBFicianOww/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">下面的代码目前我最为满意的版本了</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> argparse<br><span>from</span> Bio <span>import</span> SeqIO, Data<br><br><br><span><span>def</span> <span>update_cds_translation</span><span>(record, new_positions)</span>:</span><br>    <span>"""<br>    更新GenBank记录中所有CDS区域的翻译信息并返回修改后的记录。<br>    :param record: GenBank记录对象<br>    :param new_positions: 包含每个CDS区域新起始和终止位置的dict对象<br>    :return: 修改后的GenBank记录对象<br>    """</span><br>    <span># 遍历每个特征</span><br>    <span>for</span> feature <span>in</span> record.features:<br>        <span># 如果是CDS区域</span><br>        <span>if</span> feature.type == <span>'CDS'</span>:<br>            <span># 获取特征的名称</span><br>            gene = feature.qualifiers.get(<span>'gene'</span>, [<span>''</span>])[<span>0</span>]<br>            <span># 获取CDS区域的起始和终止位置</span><br>            start, end = feature.location.start, feature.location.end<br>            <span># 如果有新位置信息，则使用新位置信息</span><br>            <span>if</span> gene <span>in</span> new_positions:<br>                start, end = new_positions[gene]<br>            <span># 获取CDS区域的序列</span><br>            cds_seq = record.seq[start:end]<br>            <span># 判断序列的方向</span><br>            <span>if</span> feature.strand == <span>-1</span>:<br>                cds_seq = cds_seq.reverse_complement()<br><br>            <span># 获取codon_start和transl_table信息</span><br>            codon_start = int(feature.qualifiers.get(<span>'codon_start'</span>, [<span>1</span>])[<span>0</span>])<br>            transl_table = int(feature.qualifiers.get(<span>'transl_table'</span>, [<span>1</span>])[<span>0</span>])<br>            <span># 翻译CDS区域</span><br>            table = Data.CodonTable.unambiguous_dna_by_id[transl_table]<br>            <span>try</span>:<br>                cds_protein = cds_seq[codon_start - <span>1</span>:].translate(table=table, cds=<span>True</span>)<br>            <span>except</span> Data.CodonTable.TranslationError:<br>                cds_protein = <span>''</span><br>                print(<span>f"Warning: Unable to translate CDS region <span>{gene}</span> in record <span>{record.id}</span>"</span>)<br>            <span># 更新CDS区域的翻译信息</span><br>            feature.qualifiers[<span>'translation'</span>] = [str(cds_protein)]<br>    <span>return</span> record<br><br><br><span>if</span> __name__ == <span>'__main__'</span>:<br>    <span># 解析命令行参数</span><br>    parser = argparse.ArgumentParser(description=<span>"Update CDS translations in a GenBank file."</span>)<br>    parser.add_argument(<span>"input"</span>, help=<span>"Input GenBank file name"</span>, type=argparse.FileType(<span>'r'</span>))<br>    parser.add_argument(<span>"output"</span>, help=<span>"Output GenBank file name"</span>, type=argparse.FileType(<span>'w'</span>))<br>    parser.add_argument(<span>"-p"</span>, <span>"--positions"</span>, help=<span>"New start and end positions for each gene, e.g. 'gene1:100-500 gene2:200-600'"</span>, default=<span>""</span>)<br>    args = parser.parse_args()<br><br>    <span># 读取GenBank文件和新位置信息</span><br>    records = (record <span>for</span> record <span>in</span> SeqIO.parse(args.input, <span>"genbank"</span>))<br>    new_positions = {gene: tuple(map(int, pos.split(<span>'-'</span>))) <span>for</span> gene, _, pos <span>in</span> map(str.partition, args.positions.split())}<br>    <br>    <span># 更新CDS翻译信息并写回GenBank文件</span><br>    untranslated_cds_count = <span>0</span><br>    <span>for</span> record <span>in</span> records:<br>        record = update_cds_translation(record, new_positions)<br>        <span># 统计无法翻译的CDS区域个数</span><br>        <span>for</span> feature <span>in</span> record.features:<br>            <span>if</span> feature.type == <span>'CDS'</span> <span>and</span> <span>not</span> feature.qualifiers.get(<span>'translation'</span>, [<span>''</span>])[<span>0</span>]:<br>                untranslated_cds_count += <span>1</span><br>        SeqIO.write(record, args.output, <span>"genbank"</span>)<br>    <br>    <span># 提示用户有多少个CDS区域无法翻译为蛋白质序列</span><br>    <span>if</span> untranslated_cds_count &gt; <span>0</span>:<br>        print(<span>f"Warning: Failed to translate <span>{untranslated_cds_count}</span> CDS regions."</span>)<br></code></pre><p data-tool="mdnice编辑器">我运行了这个代码，发现结果非常好。</p><pre data-tool="mdnice编辑器"><span></span><code>$ python remake.py mitoscaf.fa.gbf new.gff<br>Warning: Unable to translate CDS region COX2 <span>in</span> record XZG<br>Warning: Failed to translate 1 CDS regions.<br></code></pre><p data-tool="mdnice编辑器">其实早在几年前，openAI推出GPT3的时候，我就知道了，我也提交了申请，但是一直没被通过，也就被我忘了。后来chatGPT横空出世，我开始也聊了几句，后面也就放在一边了。直到最近，它又火了，并且还出现了一个非常优秀的github项目，chatgpt-web，使得我能搭建了一个自己的专属GPT，之后我还搞定了付费API。</p><p data-tool="mdnice编辑器">虽然他也会出错（未来的4.0 API或许会好很多），但这样子说的仿佛人不出错一样。我现在就把它当做一个合作搭档，我有一个想法，让我帮我快速实现一下，然后我根据结果进行修改，并反馈给他，他也能迅速的给我一个反馈，这不挺好吗？</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/RBaZu33RKEKQB2xn4RTcgg",target="_blank" rel="noopener noreferrer">原文链接</a>
