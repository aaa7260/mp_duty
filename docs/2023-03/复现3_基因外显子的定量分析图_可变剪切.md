---
title: "复现3-基因外显子的定量分析图—可变剪切"
date: 2023-03-29T04:42:34Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
复现3-基因外显子的定量分析图—可变剪切 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span><span>缘起</span><span></span></h2><p data-tool="mdnice编辑器">上周，我们尝试了第二幅图-热图复现，强调了取色与热图不展示聚类树进行聚类的小技巧。今天，我们来尝试复现一下第三幅图：基因外显子的定量分析图。这副图的绘制流程还是挺复杂的，但最关键之处在于要构造一个DEXSeqDataSet对象，然后进行差异分析，接着进行整体展示或者指定基因可视化，绘制DXESeq的基因外显子的差异分析图。构造DEXSeqDataSet对象主要需要三类输入文件：1.每个样本的count矩阵 2.gtf格式的基因组注释文件 3.实验设计表格。此处需要注意的是基因组注释文件需要用通过 dexseq_prepare_annotation.py 流程将注释基因组gff文件为DEXSeq.chr.gff文件，庆幸的是作者提供了这个gff文件，那我们直接分析即可。具体流程参考曾老师多年前的博客用DEXSeq分析可变剪切与官方教程。</p><p data-tool="mdnice编辑器">今天，我们要复现的指定基因的外显子<span>定量</span>分析图由两部分组成，一副子图展示的是Exon Usage的外显子<span>定量</span>分析图，一副子图展示的是Normalized conuts的外显子<span>定量</span>分析图。具体如下：</p><figure data-tool="mdnice编辑器"><img data-ratio="1.1969407265774379" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8j5Zfem7zOe7WX4VbZbno1srWpQYwFgG3zU9SJXYqyQC4jdxvSRQYXdOuNckKPQDc3Id1XvYwsfA/640?wx_fmt=png" data-type="png" data-w="523" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8j5Zfem7zOe7WX4VbZbno1srWpQYwFgG3zU9SJXYqyQC4jdxvSRQYXdOuNckKPQDc3Id1XvYwsfA/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span><span>探索</span><span></span></h2><p data-tool="mdnice编辑器">今天，我们使用的仍旧是上周推文介绍过的文章，标题为 <strong>「「剪切因子SF3B1通过调节KSR2 RNA成熟促进子宫内膜癌进展」」</strong> 的附件表3进行探究。为什么使用附表3的数据呢？正文中提到，为了深入了解可变剪切的基因谱，作者使用DEXSeq对RNA-seq数据进行差异外显子使用分析。DEXseq分析了6,40,456个外显子的差异使用情况。完整的DEXseq原始计数、标准化计数和每个外显子的统计数据作为补充提供在附件表3，此次我们要使用的是其将所有样本的count矩阵拆分为每个样本的count矩阵，再利用注释基因组的gff文件与实验表格进行DXEseq的差异分析。附表3的下载链接如下：https://www.nature.com/articles/s41419-020-03055-y#Sec18  。关于这篇经典文章的介绍，感兴趣的小伙伴可以阅读上周的推文<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247510762&amp;idx=1&amp;sn=fa70866e6f9c6602319f24e3a444020e&amp;chksm=fa456fd7cd32e6c18440c508e237f1d89a1ac40eb55325b8e96ce018fe88cde3b783c2789a00&amp;cur_album_id=2545418429466607617&amp;scene=21&amp;key=a1e4a6001c8061185cd5b40aac56082940b2ea5a4a182fecd7c0374da472e152023d0c46aa3309e5fa34b556f2370ba5c54b291a8bec0651f4094e4e6f29100cdecf9dc15dc58f0d233579e0ca88d3c3c6eb8771ed7bdd134dea9ed04a12d15e35a151d13c762cc345fbbb83a63129fd984bd66bf2a630a88b7089ae1d03fc01&amp;ascene=0&amp;uin=MjI3OTYzNDcwNg==&amp;devicetype=Windows%2011%20x64&amp;version=6309001c&amp;lang=zh_CN&amp;countrycode=CN&amp;exportkey=n_ChQIAhIQENkvIGDm9RWNIfkurONGSRLgAQIE97dBBAEAAAAAAGtMNjFxFtsAAAAOpnltbLcz9gKNyK89dVj035igPCVgjLtvn5meYnsFZoI/xeN/8S3YJD61+p0Cpc6NjPL0JTqqr2LL2Cy46zH+tmT4QyA3qW1IWj/tscsZJPCQc3lLwO9+oQbgWRtsU9sPg+rPGOJ2rHG0K/0Y5nv7cBfuQN/twge3IrM/dO8c0oL/S6ualDp/+xl8GnqslRFN7bnedRQm5y3luybAxpwalSfVe1zkSnK3TI9qY0ycLij6cHKrCVmMiaMEgy9w+a+77Fv9Kwd8HxBU&amp;acctmode=0&amp;pass_ticket=NcMYodOx2lsBPabCW7nWYkR5uFB/wlUp3uDDuLIx5mZSVeL3NszbYsgZXPMl/eJdn617qmtBme6uC1IIAHCsaw==&amp;wx_header=1&amp;fontgear=2#wechat_redirect" data-linktype="2">转录组----新的转折</a>。</p><h2 data-tool="mdnice编辑器"><span></span><span>转录组数据介绍</span><span></span></h2><p data-tool="mdnice编辑器">通过附表3的下载链接地址，我们能够下载到DEXseq分析的外显子使用情况的表格。从表格的counts计数中，我们可以看到该数据组别分为control与sf3b1两组，每组具有3个样本。<img data-ratio="0.30781893004115224" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8j5Zfem7zOe7WX4VbZbno1qvEzOibjp8JXomfm4jMfuvKNe7TTalwfwa2MXDXwIcfXwkcPLwjfk0A/640?wx_fmt=png" data-type="png" data-w="1215" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8j5Zfem7zOe7WX4VbZbno1qvEzOibjp8JXomfm4jMfuvKNe7TTalwfwa2MXDXwIcfXwkcPLwjfk0A/640?wx_fmt=png">今天，我们要使用的输入文件之一的就是利用这个所有样本的counts数据转换成每个样本counts的txt文件与作者提供的gff文件。<img data-ratio="0.2668478260869565" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8j5Zfem7zOe7WX4VbZbno13Iv0BZRm9L6aEGPd1k5Xo0uAUsWpdEbHO07vlCk5DnyicicqiaT7VkiapQ/640?wx_fmt=png" data-type="png" data-w="1840" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8j5Zfem7zOe7WX4VbZbno13Iv0BZRm9L6aEGPd1k5Xo0uAUsWpdEbHO07vlCk5DnyicicqiaT7VkiapQ/640?wx_fmt=png">接下来咱们就来正式分析吧。</p><h3 data-tool="mdnice编辑器"><span></span><span><span></span>1.清空环境，加载R包</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>## 使用DXESeq进行差异分析，此处最关键是构建DXEseq的DEXSeqDataSet对象、</span><br><span>## 构建这个文件最关键的就是需要准备3个文件</span><br>rm(list=ls())<br><span>library</span>(DEXSeq)<br><span>library</span>(pasilla)<br><span>library</span>(data.table)<br><span>library</span>(openxlsx)<br><span>library</span>(ggplot2)<br><span>library</span>(pheatmap)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span></span>2.准备构造DEXSeqDataSet对象的三个输入文件</span><span></span></h3><p data-tool="mdnice编辑器">此处需要值得注意的是，很奇怪，作者提供的gff文件中并没有ENSG00000281398，所以没法绘制SNGH4。此处重在展示，示例ENSG00000073711代替ENSG00000281398，绘制SNGH4的基因外显子差异分析图。</p><pre data-tool="mdnice编辑器"><span></span><code>df=read.xlsx(<span>"41419_2020_3055_MOESM8_ESM.xlsx"</span>)<br>df[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span>##           groupID featureID exonBaseMean  dispersion</span><br><span>## 1 ENSG00000000003      E001    0.9483831 0.050371938</span><br><span>## 2 ENSG00000000003      E002  547.5304102 0.001285623</span><br><span>## 3 ENSG00000000003      E003  184.3717721 0.001420820</span><br><span>## 4 ENSG00000000003      E004    1.0278659 0.052101035</span><br>colnames(df)<br><span>##  [1] "groupID"                "featureID"              "exonBaseMean"          </span><br><span>##  [4] "dispersion"             "stat"                   "pvalue"                </span><br><span>##  [7] "padj"                   "control"                "sf3b1"                 </span><br><span>## [10] "log2fold_sf3b1_control" "genomicData.seqnames"   "genomicData.start"     </span><br><span>## [13] "genomicData.end"        "genomicData.width"      "genomicData.strand"    </span><br><span>## [16] "countData.control_rep1" "countData.control_rep2" "countData.control_rep3"</span><br><span>## [19] "countData.sf3b1_rep1"   "countData.sf3b1_rep2"   "countData.sf3b1_rep3"  </span><br><span>## [22] "transcripts"</span><br>df1=df[,<span>16</span>:<span>21</span>]<br>df1$V1=paste0(df$groupID,<span>":"</span>,df$featureID)<br><span>## 注意：一定要将外显子的E去除---制成一模一样即可</span><br>nchar(df1$V1[<span>1</span>])<br><span>## [1] 20</span><br>substr(df1$V1[<span>1</span>],<span>1</span>,<span>16</span>)<br><span>## [1] "ENSG00000000003:"</span><br>substr(df1$V1[<span>1</span>],<span>18</span>,<span>20</span>) <span>##截取两段拼起来即可</span><br><span>## [1] "001"</span><br>paste0(substr(df1$V1[<span>1</span>],<span>1</span>,<span>16</span>),substr(df1$V1[<span>1</span>],<span>18</span>,<span>20</span>))<br><span>## [1] "ENSG00000000003:001"</span><br><span>##去除E，换成对应的名字就好</span><br>df1$V1=paste0(substr(df1$V1,<span>1</span>,<span>16</span>),substr(df1$V1,<span>18</span>,<span>20</span>))<br>colnames(df1)[<span>1</span>:<span>6</span>]=gsub(<span>"countData."</span>,<span>""</span>,colnames(df1)[<span>1</span>:<span>6</span>])<br><span>### 第一个输入文件准备 (countFiles)</span><br><span># 批量生成6个样本对映的外显子count表格</span><br>lapply(colnames(df1)[<span>1</span>:<span>6</span>],<span>function</span>(i){<br>  <span># i= "control_rep1"</span><br>  a=df1[grepl(<span>"ENSG00000073711"</span>,df1$V1),c(<span>"V1"</span>,i)] <span>#取17列看看</span><br>  a$V1=gsub(<span>"ENSG00000073711"</span>,<span>"SNGH4"</span>,a$V1)<br>  colnames(a)=c(<span>"V1"</span>,<span>"V2"</span>)<br>  write.table(a,file = paste0(i,<span>".txt"</span>),sep = <span>"\t"</span>,quote = <span>F</span>,row.names = <span>F</span>,col.names = <span>F</span>)<br>})<br><span>## [[1]]</span><br><span>## NULL</span><br><span>## </span><br><span>## [[2]]</span><br><span>## NULL</span><br><span>## </span><br><span>## [[3]]</span><br><span>## NULL</span><br><span>## </span><br><span>## [[4]]</span><br><span>## NULL</span><br><span>## </span><br><span>## [[5]]</span><br><span>## NULL</span><br><span>## </span><br><span>## [[6]]</span><br><span>## NULL</span><br>countFiles=list.files(<span>"./"</span>,pattern=<span>"txt"</span>)<br>countFiles<br><span>## [1] "control_rep1.txt" "control_rep2.txt" "control_rep3.txt" "sf3b1_rep1.txt"  </span><br><span>## [5] "sf3b1_rep2.txt"   "sf3b1_rep3.txt"</span><br>head(read.table(countFiles[<span>1</span>]))<br><span>##          V1  V2</span><br><span>## 1 SNGH4:001  11</span><br><span>## 2 SNGH4:002  29</span><br><span>## 3 SNGH4:003 171</span><br><span>## 4 SNGH4:004   2</span><br><span>## 5 SNGH4:005  25</span><br><span>## 6 SNGH4:006  34</span><br>dim(read.table(countFiles[<span>1</span>]))<br><span>## [1] 23  2</span><br><span>## 第二个文件（gff）</span><br>gffFile &lt;- list.files(<span>"./"</span>, pattern=<span>"name.gff$"</span>, full.names=<span>TRUE</span>) <br><span>#注意count文件需要与gff文件匹配，name.gff文件需要1.提取出count对应的geneid如上述ENSG00000073711相应行 2.将相应geneid改为要展示的基因名如SNGH4</span><br>gffFile<br><span>## [1] "./rename.gff"</span><br><span>## 第三个文件：实验设计</span><br>sampleTable &lt;- data.frame(row.names=c(paste(<span>"control_rep"</span>, <span>1</span>:<span>3</span>, sep=<span>""</span>), paste(<span>"sf3b1_rep"</span>, <span>1</span>:<span>3</span>, sep=<span>""</span>)),<br>                          condition=rep(c(<span>"Control"</span>, <span>"SF3B1"</span>), c(<span>3</span>, <span>3</span>)))<br>sampleTable<br><span>##              condition</span><br><span>## control_rep1   Control</span><br><span>## control_rep2   Control</span><br><span>## control_rep3   Control</span><br><span>## sf3b1_rep1       SF3B1</span><br><span>## sf3b1_rep2       SF3B1</span><br><span>## sf3b1_rep3       SF3B1</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span></span>3.构造DEXSeqDataSet对象</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>#就是利用上面准备好的3类文件即可</span><br>dxd &lt;- DEXSeqDataSetFromHTSeq(<br>  countFiles,<br>  sampleData=sampleTable,<br>  design= ~sample + exon + condition:exon,<br>  flattenedfile=gffFile<br>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span></span>4.差异分析，展示指定基因SNGH4的可视化</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>dxr &lt;- DEXSeq(dxd)<br>class(dxd)<br><span>## [1] "DEXSeqDataSet"</span><br><span>## attr(,"package")</span><br><span>## [1] "DEXSeq"</span><br><span>## 所有基因都绘制的话，很慢。</span><br>dxr; class(dxr)<br>plotDEXSeq( dxr, <span>"SNGH4"</span>, expression=<span>FALSE</span>, norCounts=<span>TRUE</span>,<br>            legend=<span>TRUE</span>, cex.axis=<span>1.2</span>, cex=<span>1.3</span>, lwd=<span>2</span> )<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8j5Zfem7zOe7WX4VbZbno1Wb74Bic983Oun7bUewUwx2jNibR8Gw31NWGtD9rq7s1NmluIVmkgLr4g/640?wx_fmt=png" data-type="png" data-w="672" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8j5Zfem7zOe7WX4VbZbno1Wb74Bic983Oun7bUewUwx2jNibR8Gw31NWGtD9rq7s1NmluIVmkgLr4g/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>plotDEXSeq( dxr, "SNGH4", expression=FALSE, norCounts=TRUE,<br>            legend=FALSE, cex.axis=1.2, cex=1.3, lwd=2 ,names=F)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8j5Zfem7zOe7WX4VbZbno1y1tVF7yfc4PE5AFxNfibSxqVvicmwttIAKvfzYfeiaujGmXiah4Xm1q0IQ/640?wx_fmt=png" data-type="png" data-w="672" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8j5Zfem7zOe7WX4VbZbno1y1tVF7yfc4PE5AFxNfibSxqVvicmwttIAKvfzYfeiaujGmXiah4Xm1q0IQ/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>## 合并</span><br>plotDEXSeq( dxr, <span>"SNGH4"</span>, displayTranscripts=<span>TRUE</span>, expression=<span>FALSE</span>, norCounts=<span>TRUE</span>, splicing=<span>TRUE</span>,<br>            legend=<span>TRUE</span>, cex.axis=<span>1.2</span>, cex=<span>1.3</span>, lwd=<span>2</span> )<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8j5Zfem7zOe7WX4VbZbno1v38APsh6kCyZ6JlibsP9Iibqb73Q8F8qXGuGEbiajgPN9CGw18h4ye4GQ/640?wx_fmt=png" data-type="png" data-w="672" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8j5Zfem7zOe7WX4VbZbno1v38APsh6kCyZ6JlibsP9Iibqb73Q8F8qXGuGEbiajgPN9CGw18h4ye4GQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">通过以上代码，我们可以绘制指定基因对应的基因外显子的<span>定量</span>分析图。但是，很奇怪的是，小编在作者提供的gff文件中，并没有看见ENSG00000281398，所以不清楚作者如何绘制的SNGH4。此处重在展示，示例用ENSG00000073711代替ENSG00000281398，绘制名为SNGH4的基因外显子<span>定量</span>分析图，注意count的行数与基因名要与gff的行数与基因名对应哈,否则DEXSeqDataSet构造过程会报错。感兴趣的小伙伴们可以来尝试一下。</p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/0WNYlVQhbfTQhic25PdWUg",target="_blank" rel="noopener noreferrer">原文链接</a>
