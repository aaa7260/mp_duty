---
title: "单细胞空间域分析详细教程"
date: 2023-05-13T01:17:46Z
draft: ["false"]
tags: [
  "fetched",
  "生信编程自修室"
]
categories: ["Acdemic"]
---
单细胞空间域分析详细教程 by 生信编程自修室
------
<div><p>这期推送是华大空间转录组数据分析教程第六期，往期推送如下：</p><p data-tool="markdown.com.cn编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MTY3ODA2Mw==&amp;mid=2247484963&amp;idx=1&amp;sn=cade210927a38bc1fe9b71311a041ee5&amp;chksm=fcddca23cbaa4335d6698bcd3455cd0bcf272c072d577fc9ea5cddfcb0e58b2f80f67386108f&amp;scene=21#wechat_redirect" textvalue="Stereopy 分析华大空间转录组数据-整体流程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">Stereopy 分析华大空间转录组数据-整体流程</a><br></p><p data-tool="markdown.com.cn编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MTY3ODA2Mw==&amp;mid=2247484977&amp;idx=1&amp;sn=1027bb40b5bf23da2edd095868d50e64&amp;chksm=fcddca31cbaa4327a8782cae95434c340b049d9ac656372b33f6f4f1aa99a115143d0d2ff128&amp;scene=21#wechat_redirect" textvalue="Stereopy 分析华大空间转录组数据-整体流程-2" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">Stereopy 分析华大空间转录组数据-整体流程-2</a><br></p><p data-tool="markdown.com.cn编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MTY3ODA2Mw==&amp;mid=2247485036&amp;idx=1&amp;sn=6ad51f56bc198b3a1049ea21f7413fdd&amp;chksm=fcddca6ccbaa437ac8afb4305f2e4574f00febd53041ff937d5d5d19422ca85c7424be31ceb5&amp;scene=21#wechat_redirect" textvalue="华大空转Stereo-seq | 细胞分割" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">华大空转Stereo-seq | 细胞分割</a></p><p data-tool="markdown.com.cn编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MTY3ODA2Mw==&amp;mid=2247485097&amp;idx=1&amp;sn=3ab393b5219d437eb3d92a4d0ba9c52e&amp;chksm=fcddcaa9cbaa43bfc36f4bb00603c217d9eba0a2beb5b023f65005bb7e6af1a0037af34496c5&amp;scene=21#wechat_redirect" textvalue="华大空转Stereo-seq | RNA分割" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">华大空转Stereo-seq | RNA分割</a></p><p data-tool="markdown.com.cn编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MTY3ODA2Mw==&amp;mid=2247485119&amp;idx=1&amp;sn=ccc1a01ef49a0980f2efb6ab3af89eaa&amp;chksm=fcddcabfcbaa43a9b8231fbd2324e5734e246046560e35b796b2e2311d52e77d3c272c8b453d&amp;scene=21#wechat_redirect" textvalue="Stereo-seq | 空间约束聚类 SCC" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">Stereo-seq | 空间约束聚类 SCC</a><br></p><blockquote><p>spateo数据获取，请在公众号后台回复：spateo（该资源永久且持续保持更新）</p></blockquote><p>接着上一期，利用作者使用 SCC 算法注释的结果，我们进一步进行空间域识别；并使用单细胞和空间域组合可视化，实现炫酷的展示方式。</p><h3>数据加载</h3><p>这里我们加载作者已经注释好的 bin60 以及单细胞分辨率的华大空转数据，另外我们还加载了一个 bin30 的数据</p><p>这样对同一个数据，我们就形成了不同分辨率的数据，从而来进行一些精细的空间域分析</p><section><ul><li><li></ul><pre data-lang="python"><code><span>import spateo as st</span></code><code><span>st.config.n_threads = 1</span></code></pre></section><pre><code>2023-04-27 09:26:32.184791: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Could not find TensorRT<br><br>|-----&gt; setting visualization default mode in dynamo. Your customized matplotlib settings might be overritten.<br></code></pre><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span># Load annotated binning data</span></code><code><span>fname_bin60 = "mousebrain_bin60_clustered.h5ad"</span></code><code><span>adata_bin60 = st.sample_data.mousebrain(fname_bin60, backup=True)</span></code><code><span><br></span></code><code><span># Load annotated cellbin data</span></code><code><span>fname_cellbin = "mousebrain_cellbin_clustered.h5ad"</span></code><code><span>adata_cellbin = st.sample_data.mousebrain(fname_cellbin, backup=True)</span></code><code><span><br></span></code><code><span># Load higher resolution binning data</span></code><code><span>fname_bin30 = "mousebrain_bin30.h5ad"</span></code><code><span>adata_bin30 = st.sample_data.mousebrain(fname_bin30)</span></code><code><span><br></span></code><code><span>adata_bin60, adata_bin30, adata_cellbin</span></code></pre></section><pre><code>|-----&gt; Downloading data to ./data/mousebrain_bin60_clustered.h5ad<br>|-----&gt; Downloading data to ./data/mousebrain_cellbin_clustered.h5ad<br>|-----&gt; Downloading data to ./data/mousebrain_bin30.h5ad<br><br><br>(AnnData object with n_obs × n_vars = 7765 × 21667<br>     obs: 'area', 'n_counts', 'Size_Factor', 'initial_cell_size', 'louvain', 'scc', 'scc_anno'<br>     var: 'pass_basic_filter'<br>     uns: '__type', 'louvain', 'louvain_colors', 'neighbors', 'pp', 'scc', 'scc_anno_colors', 'scc_colors', 'spatial', 'spatial_neighbors'<br>     obsm: 'X_pca', 'X_spatial', 'bbox', 'contour', 'spatial'<br>     layers: 'count', 'spliced', 'unspliced'<br>     obsp: 'connectivities', 'distances', 'spatial_connectivities', 'spatial_distances',<br> AnnData object with n_obs × n_vars = 31040 × 25691<br>     obs: 'area'<br>     uns: '__type', 'pp', 'spatial'<br>     obsm: 'X_spatial', 'bbox', 'contour', 'spatial'<br>     layers: 'count', 'spliced', 'unspliced',<br> AnnData object with n_obs × n_vars = 11854 × 14645<br>     obs: 'area', 'pass_basic_filter', 'n_counts', 'louvain', 'Celltype'<br>     var: 'mt', 'pass_basic_filter'<br>     uns: 'Celltype_colors', '__type', 'louvain', 'neighbors', 'spatial'<br>     obsm: 'X_pca', 'X_spatial', 'bbox', 'contour', 'spatial'<br>     layers: 'count', 'spliced', 'unspliced'<br>     obsp: 'connectivities', 'distances')<br></code></pre><h2>空间域识别</h2><p><span></span></p><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span># SCC annotation</span></code><code><span>st.pl.space(</span></code><code><span>    adata_bin60,</span></code><code><span>    color=['scc_anno'],</span></code><code><span>    show_legend="upper left",</span></code><code><span>    figsize=(4, 3),</span></code><code><span>    color_key_cmap="tab20"</span></code><code><span>)</span></code></pre></section><p><img data-galleryid="" data-ratio="0.7699115044247787" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBHPyxOrmYfa8FwkspmALRlLSF0jda3JAMy14fyIMCibnHkksE6ajfXMg/640?wx_fmt=png" data-type="png" data-w="791" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBHPyxOrmYfa8FwkspmALRlLSF0jda3JAMy14fyIMCibnHkksE6ajfXMg/640?wx_fmt=png"></p><p>这是本期推送的核心！</p><p>使用低分辨率的数据对象进行轮廓识别，再使用高分辨率的数据进行空间域分配；</p><p>这里边的算法也比较有趣:</p><ul><li><section>首先根据低分辨率数据产生一张 cluster label 图；</section></li><li><section>根据 cluster label 图进行轮廓识别；</section></li><li><section>根据轮廓识别结果，判断高分辨率数据中的数据点在哪个轮廓中，从而识别空间域</section></li></ul><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>st.dd.set_domains(</span></code><code><span>    adata_high_res=adata_bin30,  # 这里当然也可以直接用用单细胞数据</span></code><code><span>    adata_low_res=adata_bin60,  # 当使用更低分辨的数据时，通常可以使用 `scc` 方法产生更好的空间域聚类结果，从而进行域/域轮廓识别；</span></code><code><span>    bin_size_high=30,</span></code><code><span>    bin_size_low=60,</span></code><code><span>    cluster_key="scc_anno",</span></code><code><span>    k_size=1.8,</span></code><code><span>    min_area=16</span></code><code><span>)</span></code></pre></section><pre><code>|-----&gt; Generate the cluster label image with `gen_cluster_image`.<br>|-----&gt; Set up the color for the clusters with the tab20 colormap.<br>|-----&gt; Saving integer labels for clusters into adata.obs['cluster_img_label'].<br>|-----&gt; Prepare a mask image and assign each pixel to the corresponding cluster id.<br>|-----&gt; Iterate through each cluster and identify contours with `extract_cluster_contours`.<br></code></pre><section><ul><li></ul><pre data-lang="python"><code><span>adata_bin30</span></code></pre></section><pre><code>AnnData object with n_obs × n_vars = 31040 × 25691<br>    obs: 'area', 'domain_scc_anno'<br>    uns: '__type', 'pp', 'spatial'<br>    obsm: 'X_spatial', 'bbox', 'contour', 'spatial'<br>    layers: 'count', 'spliced', 'unspliced'<br></code></pre><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span># 可视化空间域</span></code><code><span>st.pl.space(</span></code><code><span>    adata_bin30,</span></code><code><span>    color=['domain_scc_anno'],</span></code><code><span>    show_legend="upper left",</span></code><code><span>    figsize=(4, 3),</span></code><code><span>    color_key_cmap="tab20",</span></code><code><span>    pointsize=.1</span></code><code><span>)</span></code></pre></section><p><img data-galleryid="" data-ratio="0.8078381795195955" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBzB24RdhH8KPzsVZ7IZg3aDIxJMZWicaiczOWlcgYFCbRWPhGgKdos7mQ/640?wx_fmt=png" data-type="png" data-w="791" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBzB24RdhH8KPzsVZ7IZg3aDIxJMZWicaiczOWlcgYFCbRWPhGgKdos7mQ/640?wx_fmt=png"></p><p>这里根据上面的每一个分区依次进行轮廓检测，相互叠加之后即可得到分区轮廓图。这样后续就可以使用这个图辅助可视化</p><section><ul><li><li><li></ul><pre data-lang="python"><code><span><br></span></code><code><span>save_img_path = "spatial_domains.png"</span></code><code><span>st.pl.spatial_domains(adata_bin30, bin_size=30, label_key="domain_scc_anno", save_img=save_img_path)</span></code></pre></section><p><img data-galleryid="" data-ratio="1.1247401247401247" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCB5duVPbouGQFun2ymbbwZiaxD89SYg1aibZia2IWIKVjcpgca0BHpNibI8Q/640?wx_fmt=png" data-type="png" data-w="481" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCB5duVPbouGQFun2ymbbwZiaxD89SYg1aibZia2IWIKVjcpgca0BHpNibI8Q/640?wx_fmt=png"></p><h3>单细胞可视化</h3><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>st.pl.space(</span></code><code><span>    adata_cellbin,</span></code><code><span>    color=['Celltype'],</span></code><code><span>    pointsize=0.1,</span></code><code><span>    show_legend="upper left",</span></code><code><span>    figsize=(4, 3),</span></code><code><span>    color_key_cmap = "tab20",</span></code><code><span>)</span></code></pre></section><p><img data-galleryid="" data-ratio="0.532258064516129" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBia0AT4PZAf6QJjav6O6gn07GEAs2ibqiaNKob0Xts8Jwtb9capIz5Bg3A/640?wx_fmt=png" data-type="png" data-w="992" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBia0AT4PZAf6QJjav6O6gn07GEAs2ibqiaNKob0Xts8Jwtb9capIz5Bg3A/640?wx_fmt=png"></p><p>Spateo 实现了单细胞的几何绘图。每个细胞被绘制为一个多边形，该多边形是细胞内所有点的凸包。</p><section><ul><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>st.pl.geo(</span></code><code><span>    adata_cellbin,</span></code><code><span>    color=['Celltype'],</span></code><code><span>    boundary_width=0.1,</span></code><code><span>    show_legend="upper left",</span></code><code><span>    figsize=(4, 3),</span></code><code><span>    color_key_cmap = "tab20",</span></code><code><span>    pointsize=5</span></code><code><span><br></span></code><code><span>)</span></code></pre></section><p><img data-galleryid="" data-ratio="0.5171370967741935" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBlShh67Hdp2ZC58dTddvCjqJe2LZNAESbH2HLapRxnU179wzts58rxw/640?wx_fmt=png" data-type="png" data-w="992" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBlShh67Hdp2ZC58dTddvCjqJe2LZNAESbH2HLapRxnU179wzts58rxw/640?wx_fmt=png"></p><section><ul><li></ul><pre data-lang="python"><code><span>adata_cellbin.obs['contour'][0]</span></code></pre></section><p><img data-galleryid="" data-ratio="0.8737864077669902" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCB7XfICWRfNyABzTDsdpOrdhW92OCNatYKcLDcTGHoqWqtqKcYRwQycg/640?wx_fmt=png" data-type="png" data-w="206" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCB7XfICWRfNyABzTDsdpOrdhW92OCNatYKcLDcTGHoqWqtqKcYRwQycg/640?wx_fmt=png"></p><h3>结合空间域进行单细胞可视化</h3><p>通过重新缩放单细胞的空间坐标 使之与空间域对齐。这样我们可以与上面预先生成的空间域图像联合可视化</p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>adata_cellbin.obsm['spatial_bin30'] = adata_cellbin.obsm['spatial']//30  # 坐标缩放倍数和bin一致</span></code><code><span><br></span></code><code><span># Load spatial domain image as background</span></code><code><span>adata_cellbin = st.io.read_image(</span></code><code><span>    adata_cellbin,</span></code><code><span>    filename=save_img_path,</span></code><code><span>    img_layer="layer1",</span></code><code><span>    slice="slice1",</span></code><code><span>    scale_factor=1,</span></code><code><span>)</span></code><code><span><br></span></code><code><span># adata_cellbin.write("mousebrain_cellbin_domain.h5ad", compression="gzip")</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span># View cells with domains as background</span></code><code><span>st.pl.space(</span></code><code><span>    adata_cellbin,</span></code><code><span>    space="spatial_bin30",</span></code><code><span>    color=['Celltype'],</span></code><code><span>    alpha=0.95,</span></code><code><span>    figsize=(4, 3),</span></code><code><span>    show_legend="upper left",</span></code><code><span>    img_layers = "layer1",</span></code><code><span>    slices="slice1",</span></code><code><span>)</span></code></pre></section><p><img data-galleryid="" data-ratio="0.5120967741935484" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBjY2ORAk0bZTs5qEz9qFyXDnT8TMzdemjP6AVae2Ue3mjib2DfiatTGBA/640?wx_fmt=png" data-type="png" data-w="992" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBjY2ORAk0bZTs5qEz9qFyXDnT8TMzdemjP6AVae2Ue3mjib2DfiatTGBA/640?wx_fmt=png"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>### 突出重点细胞类型</span></code><code><span>st.pl.space(</span></code><code><span>    adata_cellbin[adata_cellbin.obs['Celltype'].isin(["OLIG", "OPC"]), :],</span></code><code><span>    space="spatial_bin30",</span></code><code><span>    color=['Celltype'],</span></code><code><span>    alpha=0.95,</span></code><code><span>    pointsize=0.05,</span></code><code><span>    figsize=(4, 3),</span></code><code><span>    show_legend="upper left",</span></code><code><span>    img_layers = "layer1",</span></code><code><span>    slices="slice1",</span></code><code><span>)</span></code></pre></section><p><img data-galleryid="" data-ratio="0.737300435413643" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBk9IuGXkGuEYTUkyjicvnQHFo3Jb0zIbMqvH4EcLJ37fLWlRj4dfRmdQ/640?wx_fmt=png" data-type="png" data-w="689" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBk9IuGXkGuEYTUkyjicvnQHFo3Jb0zIbMqvH4EcLJ37fLWlRj4dfRmdQ/640?wx_fmt=png"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>import numpy as np</span></code><code><span>color_palette = np.repeat(["#EEEEEEFF"],23).tolist() + ["#8eb3fbff","#4166afff"] + np.repeat(["#EEEEEEFF"],1).tolist()</span></code><code><span><br></span></code><code><span>st.pl.space(</span></code><code><span>    adata_cellbin,</span></code><code><span>    space="spatial_bin30",</span></code><code><span>    color=['Celltype'],</span></code><code><span>    color_key=color_palette,</span></code><code><span>    alpha=0.95,</span></code><code><span>    pointsize=0.05,</span></code><code><span>    figsize=(4, 3),</span></code><code><span>    show_legend="upper left",</span></code><code><span>    img_layers = "layer1",</span></code><code><span>    slices="slice1",</span></code><code><span>)</span></code></pre></section><p><img data-galleryid="" data-ratio="0.5120967741935484" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBth0u56cj9nITWekF5gbEb2icQiclD5BiaQNwUMbFqFjibOXuwrj0gllKQQ/640?wx_fmt=png" data-type="png" data-w="992" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBth0u56cj9nITWekF5gbEb2icQiclD5BiaQNwUMbFqFjibOXuwrj0gllKQQ/640?wx_fmt=png"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>### 突出重点细胞类型</span></code><code><span>st.pl.space(</span></code><code><span>    adata_cellbin[adata_cellbin.obs['Celltype'].isin(["OLIG", "OPC"]), :],</span></code><code><span>    space="spatial_bin30",</span></code><code><span>    color=['Celltype'],</span></code><code><span>    alpha=0.95,</span></code><code><span>    pointsize=0.05,</span></code><code><span>    figsize=(4, 3),</span></code><code><span>    show_legend="upper left",</span></code><code><span>    img_layers = "layer1",</span></code><code><span>    slices="slice1",</span></code><code><span>)</span></code></pre></section><p><img data-galleryid="" data-ratio="0.737300435413643" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBk9IuGXkGuEYTUkyjicvnQHFo3Jb0zIbMqvH4EcLJ37fLWlRj4dfRmdQ/640?wx_fmt=png" data-type="png" data-w="689" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbTtgkNicwq0Jg9W2hpUfZSCBk9IuGXkGuEYTUkyjicvnQHFo3Jb0zIbMqvH4EcLJ37fLWlRj4dfRmdQ/640?wx_fmt=png"></p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/sRoBPVB-2-JRTtEqgZsIow",target="_blank" rel="noopener noreferrer">原文链接</a>
