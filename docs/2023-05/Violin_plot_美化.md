---
title: "Violin plot 美化"
date: 2023-05-15T03:40:21Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
Violin plot 美化 by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span>❝</span><p>本周推文继续来美化figure，小提琴图也经常用于单细胞转录组测序的相关文章中，如下图这种形式。</p><span>❞</span></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="0.6434285714285715" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjiasVFGxIQUiaTFPGkOqCC7BAgnncL1wUnibTPBH9HiaMMEn2QKRSkjhWvxQ/640?wx_fmt=png" data-type="png" data-w="875" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjiasVFGxIQUiaTFPGkOqCC7BAgnncL1wUnibTPBH9HiaMMEn2QKRSkjhWvxQ/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br><span># devtools::install_github("sajuukLyu/ggunchull", type = "source")</span><br><span># install.packages("tidydr")</span><br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(dplyr)<br><span>library</span>(tidydr)<br><span>library</span>(ggsci)<br><span>library</span>(paletteer)<br><br>getwd()<br>dir.create(<span>"./figure"</span>)<br>setwd(<span>"./figure"</span>)  <br><br>sce.all=readRDS(<span>"../3-cell/sce.all_int_0.8.rds"</span>)<br>load(<span>"../3-cell/sce.markers.Rdata"</span>)<br>sce.all$celltype=factor(sce.all$celltype,levels = sort(unique(sce.all$celltype)))<br>Idents(sce.all)=<span>"celltype"</span><br><br><br><span>#最常规的小提琴图</span><br>VlnPlot(sce.all, features = <span>"CD3E"</span>,group.by=<span>"celltype"</span>)+NoLegend()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.821917808219178" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjiacgGTac4ia2pPVmGV3eWgs5TUlpm9EKsbamY5psZeSxeruz2qr62DjBA/640?wx_fmt=png" data-type="png" data-w="511" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjiacgGTac4ia2pPVmGV3eWgs5TUlpm9EKsbamY5psZeSxeruz2qr62DjBA/640?wx_fmt=png"><figcaption>图1</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>Seurat内置的VlnPlot函数<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#颜色</span><br>color &lt;- c(paletteer_d(<span>"awtools::bpalette"</span>),<br>           paletteer_d(<span>"awtools::a_palette"</span>),<br>           paletteer_d(<span>"awtools::mpalette"</span>))<br><br>genes_to_check = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <span>'CD4'</span>,<span>'CD8A'</span>,<span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span> ,<br>                   <span>'IGHG1'</span>, <span>'MZB1'</span>, <span>'SDC1'</span>,<br>                   <span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>, <br>                   <span>'TPSAB1'</span> , <span>'TPSB2'</span>,  <span># mast cells,</span><br>                   <span>'MKI67'</span>,<span>'TOP2A'</span>,<span>'KLRC1'</span>,<br>                   <span>'RCVRN'</span>,<span>'FPR1'</span> , <span>'ITGAM'</span> ,<br>                   <span>'FGF7'</span>,<span>'MME'</span>, <span>'ACTA2'</span>,<br>                   <span>'PECAM1'</span>, <span>'VWF'</span>,    <br>                   <span>'KLRB1'</span>,<span>'NCR1'</span>, <span># NK </span><br>                   <span>'EPCAM'</span> , <span>'KRT19'</span>, <span>'PROM1'</span>, <span>'ALDH1A1'</span>,<br>                   <span>'MKI67'</span> ,<span>'TOP2A'</span> )<br>genes_to_check2&lt;-as.data.frame(genes_to_check)<br><br><span>#genes_to_check2&lt;-t(genes_to_check2)</span><br><br>p1 &lt;- VlnPlot(sce.all,features =  genes_to_check,<br>              group.by  = <span>"celltype"</span>,<br>              flip = <span>T</span>,stack = <span>T</span>,cols = color<br>              )<br>p2&lt;-p1 + NoLegend()<br><br>ggsave(p2,file=<span>"vlnplot1.pdf"</span>,height = <span>8</span>,width=<span>6</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.3340292275574113" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjiaXypZAlvEsStvnxIiatjZFOzwfjCMTE0k27zDRQpYmmz7wkLwyicch98g/640?wx_fmt=png" data-type="png" data-w="479" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjiaXypZAlvEsStvnxIiatjZFOzwfjCMTE0k27zDRQpYmmz7wkLwyicch98g/640?wx_fmt=png"><figcaption>图2</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>Seurat内置的VlnPlot函数也可以用来画分半小提琴图<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#分组</span><br>table(sce.all$group)<br><br><span>#分组分半小提琴图</span><br>p&lt;-VlnPlot(sce.all, features = genes_to_check,stack=<span>T</span>,pt.size=<span>0</span>,flip = <span>T</span>,add.noise = <span>T</span>,split.by = <span>'group'</span>,<br>        group.by = <span>"celltype"</span>,<br>       cols = c(<span>"#78C2C4"</span>,<span>"#C73E3A"</span>),<br>        split.plot = <span>T</span>)+<br>  theme(axis.text.y = element_blank(),<br>        axis.ticks.y = element_blank(),<br>        axis.title = element_blank(),<br>        axis.text.x = element_text(colour = <span>'black'</span>,size = <span>10</span>,angle = <span>90</span>),<br>        legend.position = <span>'none'</span>)<br><br>ggsave(p,file=<span>"vlnplot2.pdf"</span>,height = <span>8</span>,width=<span>6</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.3492063492063493" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjiau3NF0TOMhVOtonhg10Cjvej1Gz3pxaWMxDEV4M9uDuB0JiawqfOTANQ/640?wx_fmt=png" data-type="png" data-w="504" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjiau3NF0TOMhVOtonhg10Cjvej1Gz3pxaWMxDEV4M9uDuB0JiawqfOTANQ/640?wx_fmt=png"><figcaption>图3</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code><span>#stack = TRUE 参数，分组旋转小提琴图</span><br>p1 &lt;- VlnPlot(sce.all, genes_to_check, stack = <span>TRUE</span>,split.by = <span>'group'</span>,<br>              sort = <span>TRUE</span>, cols = c(<span>"#78C2C4"</span>,<span>"#C73E3A"</span>),) +<br>  theme(legend.position = <span>"none"</span>);p1<br>ggsave(p1,file=<span>"vlnplot3.pdf"</span>,height = <span>6</span>,width=<span>8</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7412935323383084" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjiahKxtLalO7LxxiayFJqyNW4AQp8dhUtOyOXRq8lp1DMoFQshdYCquzyg/640?wx_fmt=png" data-type="png" data-w="804" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjiahKxtLalO7LxxiayFJqyNW4AQp8dhUtOyOXRq8lp1DMoFQshdYCquzyg/640?wx_fmt=png"><figcaption>图4</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code><span>#也可以提取使用findallmarker计算出来的sce.markers,通过限制条件筛选的gene去画小提琴图</span><br><span># marker_gene &lt;- sce.markers  %&gt;% </span><br><span>#        filter(p_val_adj &lt; 0.05) %&gt;% </span><br><span>#        filter(pct.1 &gt;= 0.5 &amp; pct.2 &lt;= 0.5) %&gt;% </span><br><span>#        group_by(cluster) %&gt;% </span><br><span>#        slice_max(order_by = avg_log2FC, n = 2)</span><br><br><span>#marker_gene比较多，这里不展示了。</span><br></code></pre><h4 data-tool="mdnice编辑器"><span></span>提取数据<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#使用ggplot画小提琴图</span><br><span>#可以用任意gene来画小提琴图</span><br>genes_to_check = c(<span>'PTPRC'</span>, <br>                   <span>'MUC2'</span> , <span>'ITLN1'</span>,<br>                   <span>'FABP1'</span> , <span>'APOA1'</span>,<br>                   <span>'CEACAM5'</span> , <span>'CEACAM6'</span>,<br>                   <span>'EPCAM'</span>, <span>'KRT18'</span>, <span>'MUC1'</span>,<br>                   <span>'MUC6'</span> , <span>'TFF2'</span>,<br>                   <span>'PGA4'</span> , <span>'PGA3'</span>,<br>                   <span>'MUC5AC'</span> , <span>'TFF1'</span>,<span>'CHGA'</span> , <span>'CHGB'</span>)<br><br>genes_to_check2&lt;-as.data.frame(genes_to_check)<br>marker_gene&lt;-genes_to_check2<br><br><span>library</span>(reshape2)<br>head(sce.all@assays$RNA@data)[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>vln.data=as.data.frame(sce.all@assays$RNA@data)[marker_gene$genes_to_check,]<br>vln.data&lt;-na.omit(vln.data)<br><br>vln.data$gene=rownames(vln.data)<br>vln.data=melt(vln.data,id=<span>"gene"</span>)<br>colnames(vln.data)[c(<span>2</span>,<span>3</span>)]=c(<span>"cell"</span>,<span>"exp"</span>)<br><br>sce.all@meta.data$cell&lt;-rownames(sce.all@meta.data)<br>head(sce.all@meta.data, <span>10</span>)<br><br>data=sce.all@meta.data[,c(<span>"cell"</span>,<span>"celltype"</span>)]<br>vln.data=merge(vln.data,data,by=<span>"cell"</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>可视化<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span># 颜色色条：palette("Set3")</span><br>color&lt;-c(<span>"#8DD3C7"</span>,<span>"#FFFFB3"</span>,<span>"#BEBADA"</span>,<span>"#FB8072"</span>,<span>"#80B1D3"</span>,<span>"#FDB462"</span>,<span>"#B3DE69"</span>,<span>"#FCCDE5"</span>,<span>"#BC80BD"</span>,<span>"gray85"</span>)<br><br>p&lt;-ggplot(vln.data,aes(celltype,exp))+geom_violin(aes(fill=gene),scale = <span>"width"</span>)+<br>  facet_grid(vln.data$gene~.,scales = <span>"free_y"</span>)+<br>  scale_fill_manual(values = color)+<br>  scale_x_discrete(<span>""</span>)+scale_y_continuous(<span>""</span>)+<br>  theme_bw()+<br>  theme(<br>    axis.text.x.bottom = element_text(angle = <span>45</span>,hjust = <span>1</span>,vjust = <span>1</span>),<br>    panel.grid.major = element_blank(),<br>    panel.grid.minor = element_blank(),<br>    legend.position = <span>"none"</span>,<br>    axis.text.x = element_text(color = <span>'black'</span>,size = <span>11</span>),<br>    axis.text.y = element_blank(),<br>    axis.title.x = element_text(color = <span>'black'</span>, size = <span>15</span>),<br>    axis.ticks.x = element_line(color = <span>'black'</span>),<br>    axis.ticks.y = element_blank(),<br>  )<br>p<br>ggsave(<span>"vlnplot.pdf"</span>,width = <span>9</span>,height = <span>10</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.1062874251497006" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjiaYdOaG09jxQ12wfIibUCtwxsibbJlY58ETHNLibErF8Fm3nM9vToKQgtZw/640?wx_fmt=png" data-type="png" data-w="668" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjiaYdOaG09jxQ12wfIibUCtwxsibbJlY58ETHNLibErF8Fm3nM9vToKQgtZw/640?wx_fmt=png"><figcaption>图5</figcaption></figure><blockquote data-tool="mdnice编辑器"><span>❝</span><p>上周推文下有小伙伴有提到python画出来的dotplot比较好看，的确是python画出来的比较精致。</p><p>小编也想去学学python画图，先留个坑，不知道什么时候有时间能补上~</p><p>学无止境，的确是时间有限。</p><span>❞</span></blockquote><h3 data-tool="mdnice编辑器"><span></span><span>微信交流群</span><span></span></h3><p data-tool="mdnice编辑器">如果你也想参与到群里的讨论中，给我提出一些推文更新建议的话欢迎入群。同时你也可以得到我前期更新的所有数据及代码，在群里我会把代码分享给大家，而且大家可以在群里<strong>「「提出自己感兴趣的单细胞文献」」</strong>我们尽可能优先选择大家的数据集去复现和实战，也欢迎大家在群里分享更多其它资料，咱们一起进步，<strong>「「比较高级的单细胞分析」」</strong>我们也会一起尝试， 相信你肯定是会不虚此行哈。</p><p data-tool="mdnice编辑器">附上之前推文的链接 <a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512238&amp;idx=1&amp;sn=e0c6dc2ea0e089aabb78133e50fb5d7f&amp;scene=21#wechat_redirect" data-linktype="2">为爱发电不可取（单细胞周更需要你的支持）</a></p><p data-tool="mdnice编辑器">我们这个群是真正的付费交流群，不仅提供数据，代码，学习资料，而且也会跟大家互动交流，还会坚持进行创作至少一年。</p><p data-tool="mdnice编辑器"><strong>「「目前群里已经有200多人，所以你想要进群的话就需要添加我的微信，私聊给我发99元的红包，我把你拉进群里。」」</strong></p><p data-tool="mdnice编辑器">是真正的付费交流群，因为提供数据，代码，学习资料，并且跟大家互动交流，而且会坚持进行创作至少一年。所以，如果介意99元的门槛且不认可我们知识分享的理念，<strong>「请不要加我好友」</strong>。。。</p><figure data-tool="mdnice编辑器"><img data-ratio="1.0068181818181818" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjial9LL3OkmnEicLehthia7jrof0UlHruQElMmtf8Ez6y2tZZHibCGrrhMxA/640?wx_fmt=png" data-type="png" data-w="440" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCZoUSBXMlSOiaOgNfGBnjial9LL3OkmnEicLehthia7jrof0UlHruQElMmtf8Ez6y2tZZHibCGrrhMxA/640?wx_fmt=png"></figure></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/u5ZhGqIfWD8EoaG0gTIbLQ",target="_blank" rel="noopener noreferrer">原文链接</a>
