---
title: "TCGA数据库8个应用领域之3——UCSCXenaTools探索各类型肿瘤的TN差异分析"
date: 2023-05-31T22:54:49Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
TCGA数据库8个应用领域之3——UCSCXenaTools探索各类型肿瘤的TN差异分析 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">这次我们来探索各类肿瘤与对照的全局（如mRNA，lncRNA，miRNA，甲基化，蛋白）水平的差异情况（差异分析流程），也就是各类型肿瘤的turmorl和normal的差异分析，用的包是UCSCXenaTools，UCSCXenaTools包以往的介绍见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247512250&amp;idx=2&amp;sn=36b21e3ff1d2e96a377e4ed5aeaf550f&amp;scene=21#wechat_redirect" data-linktype="2">通过R包UCSCXenaTools链接UCSC的XENA浏览器来探索TCGA等公共数据</a>、<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247491657&amp;idx=1&amp;sn=d715222e9aecc823625f9bc4739e8f31&amp;scene=21#wechat_redirect" data-linktype="2">UCSCXenaTools介绍</a>。</p><h4 data-tool="mdnice编辑器"><span></span>设置<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(data.table)<br><span>library</span>(dplyr)<br><span>library</span>(stringi)<br><br><span>#install.packages("UCSCXenaTools")</span><br><span>library</span>(UCSCXenaTools)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>通过标准分析流程五步走<span></span></h4><p data-tool="mdnice编辑器">生成 <code>XenaHub</code> 对象</p><pre data-tool="mdnice编辑器"><span></span><code><span>#UCSCXenaTools 使用包内置数据集 XenaData 辅助生成 XenaHub 对象，这个数据集记录了当前所有数据集的信息。</span><br>data(XenaData) <br>head(XenaData)<br><span>#&gt; # A tibble: 6 x 17</span><br><span>#&gt;   XenaHosts XenaHostNames XenaCohorts XenaDatasets SampleCount DataSubtype</span><br><span>#&gt;   &lt;chr&gt;     &lt;chr&gt;         &lt;chr&gt;       &lt;chr&gt;              &lt;int&gt; &lt;chr&gt;      </span><br><span>#&gt; 1 https://… publicHub     Breast Can… ucsfNeve_pu…          51 gene expre…</span><br><span>#&gt; 2 https://… publicHub     Breast Can… ucsfNeve_pu…          57 phenotype  </span><br><span>#&gt; 3 https://… publicHub     Glioma (Ko… kotliarov20…         194 copy number</span><br><span>#&gt; 4 https://… publicHub     Glioma (Ko… kotliarov20…         194 phenotype  </span><br><span>#&gt; 5 https://… publicHub     Lung Cance… weir2007_pu…         383 copy number</span><br><span>#&gt; 6 https://… publicHub     Lung Cance… weir2007_pu…         383 phenotype  </span><br><span>#&gt; # … with 11 more variables: Label &lt;chr&gt;, Type &lt;chr&gt;,</span><br><span>#&gt; #   AnatomicalOrigin &lt;chr&gt;, SampleType &lt;chr&gt;, Tags &lt;chr&gt;, ProbeMap &lt;chr&gt;,</span><br><span>#&gt; #   LongTitle &lt;chr&gt;, Citation &lt;chr&gt;, Version &lt;chr&gt;, Unit &lt;chr&gt;,</span><br><span>#&gt; #   Platform &lt;chr&gt;</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>#从'XenaData'生成XenaHub对象，取子集</span><br>xe = XenaGenerate(subset = XenaHostNames == <span>"gdcHub"</span>)<br></code></pre><p data-tool="mdnice编辑器">过滤数据</p><pre data-tool="mdnice编辑器"><span></span><code>xe2 = XenaFilter(xe, filterDatasets = <span>"htseq_counts"</span>) <br>xe2@datasets<br><span># [1] "TCGA-BLCA.htseq_counts.tsv"     "TCGA-LUSC.htseq_counts.tsv"    </span><br><span># [3] "TCGA-ESCA.htseq_counts.tsv"     "TARGET-RT.htseq_counts.tsv"    </span><br><span># [5] "MMRF-COMMPASS.htseq_counts.tsv" "TCGA-MESO.htseq_counts.tsv"    </span><br><span># [7] "TCGA-LUAD.htseq_counts.tsv"     "TCGA-STAD.htseq_counts.tsv"    </span><br><span># [9] "TCGA-TGCT.htseq_counts.tsv"     "TCGA-UVM.htseq_counts.tsv"     </span><br><span># [11] "TCGA-PAAD.htseq_counts.tsv"     "TCGA-GBM.htseq_counts.tsv"     </span><br><span># [13] "TCGA-COAD.htseq_counts.tsv"     "TARGET-NBL.htseq_counts.tsv"   </span><br><span># [15] "TCGA-OV.htseq_counts.tsv"       "TCGA-THYM.htseq_counts.tsv"    </span><br><span># [17] "TCGA-BRCA.htseq_counts.tsv"     "TCGA-UCEC.htseq_counts.tsv"    </span><br><span># [19] "TCGA-UCS.htseq_counts.tsv"      "TARGET-WT.htseq_counts.tsv"    </span><br><span># [21] "TARGET-AML.htseq_counts.tsv"    "TCGA-CHOL.htseq_counts.tsv"    </span><br><span># [23] "TARGET-OS.htseq_counts.tsv"     "TCGA-KIRC.htseq_counts.tsv"    </span><br><span># [25] "TCGA-ACC.htseq_counts.tsv"      "TCGA-LGG.htseq_counts.tsv"     </span><br><span># [27] "TCGA-KIRP.htseq_counts.tsv"     "TCGA-KICH.htseq_counts.tsv"    </span><br><span># [29] "TCGA-THCA.htseq_counts.tsv"     "TARGET-ALL-P3.htseq_counts.tsv"</span><br><span># [31] "TCGA-LIHC.htseq_counts.tsv"     "TCGA-HNSC.htseq_counts.tsv"    </span><br><span># [33] "TCGA-CESC.htseq_counts.tsv"     "TCGA-READ.htseq_counts.tsv"    </span><br><span># [35] "TCGA-PCPG.htseq_counts.tsv"     "TARGET-CCSK.htseq_counts.tsv"  </span><br><span># [37] "TCGA-SARC.htseq_counts.tsv"     "TCGA-DLBC.htseq_counts.tsv"    </span><br><span># [39] "TCGA-PRAD.htseq_counts.tsv"     "TCGA-LAML.htseq_counts.tsv"    </span><br><span># [41] "TCGA-SKCM.htseq_counts.tsv"</span><br></code></pre><p data-tool="mdnice编辑器">检索数据</p><pre data-tool="mdnice编辑器"><span></span><code>xe2_query = XenaQuery(xe2)<br>head(xe2_query)<br><span>#                      hosts                   datasets</span><br><span># 1 https://gdc.xenahubs.net TCGA-BLCA.htseq_counts.tsv</span><br><span># 2 https://gdc.xenahubs.net TCGA-LUSC.htseq_counts.tsv</span><br><span># 3 https://gdc.xenahubs.net TCGA-ESCA.htseq_counts.tsv</span><br><span># 6 https://gdc.xenahubs.net TCGA-MESO.htseq_counts.tsv</span><br><span># 7 https://gdc.xenahubs.net TCGA-LUAD.htseq_counts.tsv</span><br><span># 8 https://gdc.xenahubs.net TCGA-STAD.htseq_counts.tsv</span><br><span># url</span><br><span># 1 https://gdc.xenahubs.net/download/TCGA-BLCA.htseq_counts.tsv.gz</span><br><span># 2 https://gdc.xenahubs.net/download/TCGA-LUSC.htseq_counts.tsv.gz</span><br><span># 3 https://gdc.xenahubs.net/download/TCGA-ESCA.htseq_counts.tsv.gz</span><br><span># 6 https://gdc.xenahubs.net/download/TCGA-MESO.htseq_counts.tsv.gz</span><br><span># 7 https://gdc.xenahubs.net/download/TCGA-LUAD.htseq_counts.tsv.gz</span><br><span># 8 https://gdc.xenahubs.net/download/TCGA-STAD.htseq_counts.tsv.gz</span><br><br>save(xe2_query, file = <span>"03-DEG/xe2_query.RData"</span>)<br></code></pre><p data-tool="mdnice编辑器">下载和导入数据放在画图的循环里。</p><h4 data-tool="mdnice编辑器"><span></span>循环画图<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>load(<span>"03-DEG/xe2_query.RData"</span>)<br>xe2_query = xe2_query[substr(xe2_query$datasets,<span>1</span>,<span>4</span>)== <span>'TCGA'</span>,]   <span>#去掉其它数据库来源的数据，因为分组规则不一样（不一定按01-11分组），后续画图会出错</span><br><br>destdir = <span>"03-DEG/xena_TCGA_data"</span> <span>#下载数据存入的文件夹</span><br><span>library</span>(limma)<br><br><span>for</span> (i <span>in</span> <span>1</span>:length(xe2_query$datasets) ) {<br>  <span>#i = 14</span><br>  xe2_query2 = xe2_query[i,]<br>    <br><span>#下载数据，已经下载了会读入</span><br>  xe2_download = XenaDownload(xe2_query2, destdir = destdir,  <br>                             trans_slash = <span>TRUE</span>)<br><span>#导入数据 </span><br>  expr = XenaPrepare(xe2_download) <br>  expr$Ensembl_ID=stri_sub(expr$Ensembl_ID,<span>1</span>,<span>15</span>)<span>##保留前15位，去掉小数点</span><br>  row.names(expr)=expr$Ensembl_ID<br>  expr2 =expr[,-<span>1</span>]<br>  row.names(expr2)=expr$Ensembl_ID<br>  expr2=normalizeBetweenArrays(expr2)<br>  <br><span>#转换一下 id</span><br>  <span>library</span>(tinyarray)<br>  expr2 = trans_exp(expr2)<br>  <br><span>#tumor和normal分组信息</span><br>  group = ifelse(as.numeric(substr(colnames(expr2),<span>14</span>,<span>15</span>)) &lt; <span>10</span>,<span>'tumor'</span>,<span>'normal'</span>)<br>  <span>#group = ifelse(as.numeric(substr(colnames(expr2),nchar(colnames(expr2))-2,nchar(colnames(expr2))-1)) &lt; 10,'tumor','normal')</span><br>  <br>  group &lt;- factor(group, levels = c(<span>'normal'</span>,<span>'tumor'</span>))<br> <br><span>#因为有一些癌症数据集是没有normal样本的，所以要做一个判断，且使用normal样本大于15的数据</span><br> <span>if</span> (sum(group==<span>"normal"</span>)&gt;<span>15</span>) {     <span>#if ("normal" %in% group) {</span><br>     <br><span>#转录组数据用limma做差异分析</span><br>    <span>library</span>(limma)<br>    dge &lt;- edgeR::DGEList(counts=expr2)<br>    dge &lt;- edgeR::calcNormFactors(dge)<br>    design=model.matrix(~factor( group ))<br>    fit = voom(dge,design, normalize=<span>"quantile"</span>)<br>    fit=lmFit(expr2,design)<br>    fit=eBayes(fit)<br>   <br>    options(digits = <span>4</span>) <span>#设置全局的数字有效位数为4</span><br>    deg = topTable(fit,coef=<span>2</span>,adjust=<span>'BH'</span>, n=<span>Inf</span>)  <br>     <br><span>#获取具体的癌症名字</span><br>    cancer = xe2_query2$datasets<br>    cancer = gsub(<span>"TCGA-"</span>,<span>""</span>,cancer)<br>    cancer = gsub(<span>".htseq_counts.tsv"</span>,<span>""</span>,cancer)<br>    cancer<br>    save(deg, file=paste0(<span>"03-DEG/"</span>,cancer,<span>"_limma_deg.Rdata"</span>)) <br>    <br><span>#取上下调显著的前10个基因画图</span><br>    logFC_t=<span>1</span><br>    P.Value_t = <span>0.05</span><br>    <br>    k1 = (deg$P.Value &lt; P.Value_t)&amp;(deg$logFC &lt; -logFC_t)<br>    k2 = (deg$P.Value &lt; P.Value_t)&amp;(deg$logFC &gt; logFC_t)<br>    deg &lt;- mutate(deg,change = ifelse(k1,<span>"down"</span>,ifelse(k2,<span>"up"</span>,<span>"stable"</span>)))<br><br>    <span>library</span>(dplyr)<br>    dat2 = deg %&gt;%<br>      filter(change!=<span>"stable"</span>) %&gt;%<br>      arrange(logFC)  <span>#把上下调基因按logFC排序</span><br> <br>    cg = c(head(rownames(dat2),<span>5</span>),<br>           tail(rownames(dat2),<span>5</span>))<br>    <br><span>#火山图</span><br>    <span>library</span>(EnhancedVolcano)<br>    EnhancedVolcano(deg,<br>                        lab =  rownames(deg),<br>                        x = <span>'logFC'</span>,<br>                        y = <span>'P.Value'</span>,<br>                        pCutoff = <span>0.05</span>,<br>                        FCcutoff = <span>1</span>,<br>                        labSize = <span>5</span>,<br>                        selectLab = cg,<br>                        drawConnectors = <span>TRUE</span> <span>#EnhancedVolcano显示基因名会默认重叠就不显示，加上这个参数才会错开显示</span><br>    )<br>    ggsave(width = <span>10</span>, height = <span>8</span>, filename = paste0(<span>"03-DEG/"</span>,cancer,<span>"_limma_deg.png"</span>))    <br> }<br>}<br></code></pre><p data-tool="mdnice编辑器">有14个癌症的normal数据大于15个画出了图，放三个看看：</p><p data-tool="mdnice编辑器">COAD<img data-ratio="0.8" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicicNibwlPY2kUfQmfu0qa1pwVFs6LaO4Eg43vEJHkiblENDgKxzKMoPgPzqZ4VVCI57jqHXAgtwAavQ/640?wx_fmt=png" data-type="png" data-w="3000" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicicNibwlPY2kUfQmfu0qa1pwVFs6LaO4Eg43vEJHkiblENDgKxzKMoPgPzqZ4VVCI57jqHXAgtwAavQ/640?wx_fmt=png">STAD<img data-ratio="0.8" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicicNibwlPY2kUfQmfu0qa1pwctf2Psg5xF5dBdfiaVv8bZEr3IRNBNteAic0BeAaaXMojmTAiaLLfSEcQ/640?wx_fmt=png" data-type="png" data-w="3000" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicicNibwlPY2kUfQmfu0qa1pwctf2Psg5xF5dBdfiaVv8bZEr3IRNBNteAic0BeAaaXMojmTAiaLLfSEcQ/640?wx_fmt=png">THCA<img data-ratio="0.8" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicicNibwlPY2kUfQmfu0qa1pw03o6UrrDBKtnDNDbucTBsv9ss8k5dJCXpqqMH1abSHcicWhdpDM5j7w/640?wx_fmt=png" data-type="png" data-w="3000" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicicNibwlPY2kUfQmfu0qa1pw03o6UrrDBKtnDNDbucTBsv9ss8k5dJCXpqqMH1abSHcicWhdpDM5j7w/640?wx_fmt=png"></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/l4wRWr0RSQ4jgrDXuKAWWA",target="_blank" rel="noopener noreferrer">原文链接</a>
