---
title: "Seurat空间转录组分析（一）数据读入"
date: 2023-05-18T01:41:44Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
Seurat空间转录组分析（一）数据读入 by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">目前的单细胞转录组学从样本量、分析方法和湿实验等方面都已经卷到了一定程度，另一个趋势则是引入单细胞多组学（如scATAC-seq等）以及空间维度，包括空间转录组、空间代谢组、空间蛋白组、空间ATAC等等。</p><p data-tool="mdnice编辑器">关于空间转录组分析的学习，我推荐先学习单细胞转录组分析，熟练掌握单细胞的数据读入，常规分析，整合去批次，以及部分高级分析（例如拟时序、转录因子和细胞通讯分析），在这个基础上，理解和学习单细胞空间转录组就非常快了，Seurat官方文档（https://satijalab.org/seurat/articles/spatial_vignette.html）就是一个很好的入门教程。</p><p data-tool="mdnice编辑器"><strong>在学习此空转教程之前，我先介绍一下空转数据如何读入R语言，然后构建成Seurat对象。</strong></p><h3 data-tool="mdnice编辑器">一. 导读</h3><p data-tool="mdnice编辑器"><strong>空间数据如何储存在<code>Seurat</code>中？</strong></p><p data-tool="mdnice编辑器">来自10x的visium数据包括以下数据类型:</p><ul data-tool="mdnice编辑器"><li><section>通过基因表达矩阵得到一个点(spot )</section></li><li><section>组织切片图像(采集数据时H&amp;E染色)</section></li><li><section>用于显示的原始高分辨率图像与低分辨率图像之间的比例因子。</section></li></ul><p data-tool="mdnice编辑器">在Seurat对象中，Spot by基因表达矩阵与典型的“RNA”分析类似，但包含spot水平，而不是单细胞水平的数据。图像本身存储在Seurat对象中的一个images 槽（slot）中。图像槽还存储必要的信息，以将斑点与其在组织图像上的物理位置相关联。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.562200956937799" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqWicABLHNgNhlp0hNcSyCPcZeXE7FicVwUweGnc1dbia158qgFbjIf0m69acu0qWtbZLUDxib6GDja4bg/640?wx_fmt=other" data-type="other" data-w="418" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqWicABLHNgNhlp0hNcSyCPcZeXE7FicVwUweGnc1dbia158qgFbjIf0m69acu0qWtbZLUDxib6GDja4bg/640?wx_fmt=other"><figcaption>image-20230312105819088</figcaption></figure><p data-tool="mdnice编辑器">空转下游和单细胞类似的处理，主要包括：</p><ul data-tool="mdnice编辑器"><li><section>Cellrange下机，读入R为Seurat对象；</section></li><li><section>双细胞预测（可选）；</section></li><li><section>低质量的细胞过滤（可选）；</section></li><li><section>标准化特征选择和归一化；</section></li><li><section>降维聚类；</section></li><li><section>分群注释；</section></li><li><section>差异表达分析得到特征markers。</section></li></ul><p data-tool="mdnice编辑器">从注释完的数据其，其后的分析一般可以归为个性化分析，和单细胞分析一样，主要有：</p><ul data-tool="mdnice编辑器"><li><section>富集分析：如GO、KEGG和GSEA富集分析；</section></li><li><section>转录因子分析；</section></li><li><section>空转拟时序分析；</section></li><li><section>空转细胞通讯分析；</section></li><li><section>......</section></li></ul><h3 data-tool="mdnice编辑器">二. 空转数据如何读入R语言</h3><h4 data-tool="mdnice编辑器">Step1. R包加载及安装</h4><pre data-tool="mdnice编辑器"><span></span><code>library(Seurat)<br>library(SeuratData)<br>library(ggplot2)<br>library(patchwork)<br>library(dplyr)<br></code></pre><h4 data-tool="mdnice编辑器">Step2. 加载数据</h4><p data-tool="mdnice编辑器">针对不同的数据类型有不同的加载策略：</p><h5 data-tool="mdnice编辑器">（1）加载Seurat官网的示例数据</h5><p data-tool="mdnice编辑器">示例数据在https://support.10xgenomics.com/spatial-gene-expression/datasets获得，并使用<code>Load10X_Spatial()</code>函数将其加载到<code>Seurat</code>。这将读取<code>spaceranger</code>管道的输出，并返回<code>Seurat</code>对象，该对象包含spot级别的表达数据以及相关的组织切片图像。</p><p data-tool="mdnice编辑器">本文的示例数据是10X平台的，内置于<code>SeuratData</code>R包，加载方式如下：</p><pre data-tool="mdnice编辑器"><span></span><code>InstallData("stxBrain")<br>brain &lt;- LoadData("stxBrain", type = "anterior1")<br>brain<br># An object of class Seurat <br># 31053 features across 2696 samples within 1 assay <br># Active assay: Spatial (31053 features, 0 variable features)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>## 检查示例数据</span><br>head(brain@meta.data)<br><span>#                   orig.ident nCount_Spatial nFeature_Spatial slice   region</span><br><span># AAACAAGTATCTCCCA-1  anterior1          13069             4242     1 anterior</span><br><span># AAACACCAATAACTGC-1  anterior1          37448             7860     1 anterior</span><br><span># AAACAGAGCGACTCCT-1  anterior1          28475             6332     1 anterior</span><br><span># AAACAGCTTTCAGAAG-1  anterior1          39718             7957     1 anterior</span><br><span># AAACAGGGTCTATATT-1  anterior1          33392             7791     1 anterior</span><br><span># AAACATGGTGAGAGGA-1  anterior1          20955             6291     1 anterior</span><br>SpatialDimPlot(brain,alpha = <span>0</span>)<br><br><span>#更多参数参考</span><br>?SpatialDimPlot()<br></code></pre><img data-ratio="0.785958904109589" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqWicABLHNgNhlp0hNcSyCPcZ0aPO7hB4s8owarfn69Q302pu0u3gaocO0cM2RCvqrSD6GdtibhqhSfA/640?wx_fmt=other" data-type="other" data-w="584" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqWicABLHNgNhlp0hNcSyCPcZ0aPO7hB4s8owarfn69Q302pu0u3gaocO0cM2RCvqrSD6GdtibhqhSfA/640?wx_fmt=other"><h5 data-tool="mdnice编辑器">（2）加载10X Cellrange上游输出的数据</h5><p data-tool="mdnice编辑器">常规流程是不会使用<code>LoadData</code>函数进行读取数据，因为正常情况下我们拿到的是10 X <code>Space Ranger</code>的输出结果：</p><p data-tool="mdnice编辑器">以下是下载自10X官方网站的数据：</p><p data-tool="mdnice编辑器">https://www.10xgenomics.com/resources/datasets?query=&amp;page=1&amp;configure%5Bfacets%5D%5B0%5D=chemistryVersionAndThroughput&amp;configure%5Bfacets%5D%5B1%5D=pipeline.version&amp;configure%5BhitsPerPage%5D=500&amp;configure%5BmaxValuesPerFacet%5D=1000&amp;menu%5Bproducts.name%5D=Spatial%20Gene%20Expression</p><pre data-tool="mdnice编辑器"><span></span><code>test_data = Load10X_Spatial(data.dir = <span>"./input/"</span>,<br>                           filename = <span>"Visium_FFPE_Human_Normal_Prostate_filtered_feature_bc_matrix.h5"</span>,<br>                           assay = <span>"Spatial"</span>, <br>                           slice = <span>"test"</span>)<br>head(test_data@meta.data)<br>SpatialDimPlot(test_data,alpha = <span>0</span>)<br><br><span>#和单细胞数据一样，可以人为更改这些命名</span><br>test_data@project.name &lt;- <span>"test"</span><br>Idents(test_data) &lt;- <span>"test"</span><br>test_data$orig.ident &lt;- <span>"test"</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6543624161073825" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqWicABLHNgNhlp0hNcSyCPcZvnOZDLedjNTpxPk5TsicE3DXOu1juz8Uz0uCEA3zTJhFaBOoVWQ7GRA/640?wx_fmt=other" data-type="other" data-w="596" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqWicABLHNgNhlp0hNcSyCPcZvnOZDLedjNTpxPk5TsicE3DXOu1juz8Uz0uCEA3zTJhFaBOoVWQ7GRA/640?wx_fmt=other"><figcaption>image-20230224173610241</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code><span>## 获取切片图像坐标：</span><br>img&lt;- GetTissueCoordinates(test_data)<br>img$imagerow = <span>540</span>-img$imagerow<br>write.csv(img,file = <span>"./No_IHC/position_information.csv"</span>)<br>head(img)<br><span>#                     imagerow imagecol</span><br><span># AAACAAGTATCTCCCA-1 183.3725 434.0820</span><br><span># AAACAATCTACTAGCA-1 442.7995 247.5663</span><br><span># AAACAGAGCGACTCCT-1 381.8799 409.0720</span><br><span># AAACAGCTTTCAGAAG-1 222.4493 139.4663</span><br><span># AAACCCGAACGAAATC-1 210.8508 475.3213</span><br><span># AAACCGGAAATGTTAA-1 161.2021 503.7606</span><br></code></pre><h5 data-tool="mdnice编辑器">（3）非常规数据的读入</h5><h5 data-tool="mdnice编辑器">3.1 缺少IHC图像</h5><p data-tool="mdnice编辑器">有些时候从数据库中下载得到的数据，由于缺少IHC图像，可以利用以下方式进行读取：</p><pre data-tool="mdnice编辑器"><span></span><code># 把空间数据当成单细胞数据读入<br>test_data2 = Read10X("./input/filtered_feature_bc_matrix/")<br>test_data2 &lt;- CreateSeuratObject(counts = test_data2, <br>                                min.features = 0, <br>                                project = "test")<br>test_data2<br># An object of class Seurat <br># 17943 features across 2543 samples within 1 assay<br></code></pre><p data-tool="mdnice编辑器">没有IHC的空转数据，作者一般会提供一个position information：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 读入单细胞的位置信息</span><br>position = read.csv(<span>"./No_IHC/position_information.csv"</span>,header = <span>T</span>,row.names = <span>1</span>)<br>head(position)<br>position = select(position,imagecol,imagerow)<br><br><span>#将位置信息合并入单细胞seurat对象</span><br>colnames(position) = paste0(<span>"Spatial_"</span>,<span>1</span>:ncol(position))<br>test_data2[[<span>"spatial"</span>]] &lt;- CreateDimReducObject(embeddings = as.matrix(position), <br>                                                    key = <span>"Spatial"</span>,assay = <span>"RNA"</span>)<br>DimPlot(test_data2,reduction = <span>"spatial"</span>,pt.size = <span>1</span>)<br></code></pre><img data-ratio="0.8006644518272426" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqWicABLHNgNhlp0hNcSyCPcZalP0Bz3olnJACFMQCsPIzfacrKkAdakN6ichI8Ag5GaRBf81Eic7OUPg/640?wx_fmt=other" data-type="other" data-w="602" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqWicABLHNgNhlp0hNcSyCPcZalP0Bz3olnJACFMQCsPIzfacrKkAdakN6ichI8Ag5GaRBf81Eic7OUPg/640?wx_fmt=other"><h5 data-tool="mdnice编辑器">3.2 缺少IHC图像也可采用Slide-seq的方法</h5><pre data-tool="mdnice编辑器"><span></span><code>test_data2 = Read10X(<span>"./input/filtered_feature_bc_matrix/"</span>)<br>test_data2 &lt;- CreateSeuratObject(counts = test_data2,<br>                                min.features = <span>0</span>,<br>                                project = <span>"test"</span>, <br>                                assay=<span>"Spatial"</span>)<br>test_data2<br><span># An object of class Seurat </span><br><span># 17943 features across 2543 samples within 1 assay </span><br><span># Active assay: RNA (17943 features, 0 variable features)</span><br><br>coord.df = read.csv(<span>"./position_information.csv"</span>,header = <span>T</span>,row.names = <span>1</span>)<br>test_data2@images$image =  new(<br>  Class = <span>'SlideSeq'</span>,<br>  assay = <span>"Spatial"</span>,<br>  key = <span>"image_"</span>,<br>  coordinates = coord.df<br>)<br><br>test_data2<br>SpatialDimPlot(test_data2)<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.8020304568527918" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqWicABLHNgNhlp0hNcSyCPcZVzw1icjMwldNEVD76ibnHibnGS19VgKHpwHVzftvQ9oO8vUzgVboGzKfw/640?wx_fmt=other" data-type="other" data-w="591" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqWicABLHNgNhlp0hNcSyCPcZVzw1icjMwldNEVD76ibnHibnGS19VgKHpwHVzftvQ9oO8vUzgVboGzKfw/640?wx_fmt=other"></p><p data-tool="mdnice编辑器">以上就是空转数据读入R语言的常见的几种方法。</p><span>- END -</span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/U9GwW9TPQ9sSUpsdZtmouQ",target="_blank" rel="noopener noreferrer">原文链接</a>
