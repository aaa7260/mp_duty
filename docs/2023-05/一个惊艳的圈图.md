---
title: "一个惊艳的圈图"
date: 2023-05-17T04:11:31Z
draft: ["false"]
tags: [
  "fetched",
  "爱德华的百宝箱"
]
categories: ["Acdemic"]
---
一个惊艳的圈图 by 爱德华的百宝箱
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section><mpprofile data-pluginname="mpprofile" data-id="MzA5NzI2MDQ2Mg==" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFndHKZh0GCo7h1JP9PPOE1QWHmQmia3Wo1F5hU6icomXctTxv54uU3zBXuekcyajzicAUDhQ7SIKCQziaQ/0?wx_fmt=png" data-nickname="爱德华的百宝箱" data-alias="ShareMyTreasureChest" data-signature="主要分享一些学习笔记，以生物信息相关知识为主吧。不定期、不确定会写其他内容，活到老，学到老！" data-from="0"></mpprofile></section><h2 data-tool="mdnice编辑器"><span>目录</span></h2><ul><li><p>1   代码注释</p></li><ul><li><p>1.1  数据简介</p></li><li><p>1.2  数据处理</p></li><li><p>1.3  可视化</p></li></ul><li><p>2   知识点</p></li><ul><li><p>2.1  坐标系相互转化</p></li><li><p>2.2  row_number()函数</p></li><li><p>2.3  括号的另一种用法</p></li></ul><li><p>3   参考链接</p></li></ul><h2 data-tool="mdnice编辑器"><span>1.</span><span></span><span>代码注释</span><span></span></h2><h3 data-tool="mdnice编辑器"><span><span>1.1 </span>数据简介</span></h3><p data-tool="mdnice编辑器">第 46 周（即 2019-11-12）的数据来自 Phillip Massicotte，他分析了 CRAN 上所有 R 包的代码行数和使用的编程语言。</p><p data-tool="mdnice编辑器">大神的代码放在了他的 blog 主页上，链接是：https://www.pmassicotte.com/post/analyzing-the-programming-languages-used-in-r-packages/，其中写道：</p><blockquote data-tool="mdnice编辑器"><p>在这篇文章中，我正在分析 CRAN 上发布的 R 包中使用的编程语言。我已经下载了所有已发布的包，并使用 CLOC（v1.82）来计算每个包中的代码行数。注意：cloc 不仅计算编程语言的代码行数，它还计算标记语言（例如 markdown）的行数。</p><p>在撰写本文时，大约分析了 14,700 个包。</p></blockquote><p data-tool="mdnice编辑器">本周的活动数据可以通过下面的代码获取：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 方法1</span><br>cran_code &lt;- readr::read_csv(<span>"https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-11-12/loc_cran_packages.csv"</span>)<br><br><span># 方法二</span><br><span># Or read in with tidytuesdayR package (https://github.com/thebioengineer/tidytuesdayR)</span><br><span># Either ISO-8601 date or year/week works!</span><br><span># Install via devtools::install_github("thebioengineer/tidytuesdayR")</span><br>tuesdata &lt;- tidytuesdayR::tt_load(<span>"2019-11-12"</span>)<br>tuesdata &lt;- tidytuesdayR::tt_load(<span>2019</span>, week = <span>46</span>)<br>cran_code &lt;- tuesdata$loc_cran_packages<br></code></pre><p data-tool="mdnice编辑器">查看数据：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.21307506053268765" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMG7y5hlVdlvrumxc4WFI5ibUs4zia6ibrzY3KXHp9ChYR5gDwNX6v9IHJwQ/640?wx_fmt=png" data-type="png" data-w="826" src="https://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMG7y5hlVdlvrumxc4WFI5ibUs4zia6ibrzY3KXHp9ChYR5gDwNX6v9IHJwQ/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.3826771653543307" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMGdMibpP46Krw2IbyHDDwyGAtbpaplC9a8IZC6ZH2gDGqblaL19eAw6pg/640?wx_fmt=png" data-type="png" data-w="635" src="https://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMGdMibpP46Krw2IbyHDDwyGAtbpaplC9a8IZC6ZH2gDGqblaL19eAw6pg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">各个列数据的意义：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.3830275229357798" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMG5oqQL0CVcpdjCzWICn9OoDvb7aMgsSFj7JIJFvOQSTFZkdjNpMkmvw/640?wx_fmt=png" data-type="png" data-w="872" src="https://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMG5oqQL0CVcpdjCzWICn9OoDvb7aMgsSFj7JIJFvOQSTFZkdjNpMkmvw/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span><span>1.2 </span>数据处理</span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(tidyverse)<br><span>library</span>(igraph)<br><span>library</span>(ggraph)<br>rm(list = ls())<br><br>path &lt;- <span>"https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-11-12/"</span><br>data &lt;- read_csv(file = paste0(path, <span>"loc_cran_packages.csv"</span>))<br><br><span># 可以看出，数据集包含108种编程语言</span><br>length(unique(data$language))<br><br><span>################ 补充数据</span><br><span># 从TIOBE Index(2019年11月)的数据中发现了最流行的编程语言（13种）</span><br>popular_languages &lt;- c(<br>  <span>"Java"</span>, <span>"C"</span>, <span>"Python"</span>, <span>"C++"</span>, <span>"C#"</span>,<br>  <span>"Visual Basic"</span>, <span>"JavaScript"</span>, <span>"PHP"</span>, <span>"SQL"</span>, <span>"Ruby"</span>,<br>  <span>"Objective C++"</span>, <span>"Assembly"</span>, <span>"R"</span><br>)<br><br><br><span>################ 数据处理</span><br><span># 要显示的软件包数</span><br>number_of_pkgs &lt;- <span>300</span><br><br><span># 提取用流行语言编写的代码总行数前300名的R包</span><br>top_packages &lt;- data %&gt;%<br>  filter(language %<span>in</span>% popular_languages) %&gt;% <span># 选择流行语言</span><br>  group_by(pkg_name) %&gt;% <span># 按pkg_name进行分组</span><br>  summarize(total_code = sum(code)) %&gt;% <span># 获得该R包的代码总行数</span><br>  arrange(desc(total_code)) %&gt;% <span># 按总行数降序排列</span><br>  head(number_of_pkgs) %&gt;% <span># 选择前300名R包</span><br>  select(pkg_name, total_code)<br><br><span># 提取用流行语言编写的前300名R包中使用的编程语言</span><br>top_languages_per_pkg &lt;- data %&gt;%<br>  filter(<br>    pkg_name %<span>in</span>% top_packages$pkg_name,<br>    language %<span>in</span>% popular_languages<br>  ) %&gt;%<br>  arrange(pkg_name, desc(code)) %&gt;% <span># 先按pkg_name升序排列，再按code降序排列</span><br>  group_by(pkg_name) %&gt;% <span># 按pkg_name进行分组</span><br>  mutate(<br>    main = row_number() == <span>1</span>, <span># 将排序后同一R包的第1位赋值为TRUE，其余为FALSE，后续将以此设置不透明度</span><br>    total_code = sum(code)<br>  ) %&gt;% <span># 新建2列</span><br>  ungroup() %&gt;% <span># 解除分组</span><br>  select(language, pkg_name, code, total_code, main)<br><br><span>################ 点</span><br><span># 查看前300名R包所用到的编程语言</span><br><span># 可以看到只有9种编程语言了</span><br>(top_languages &lt;- top_languages_per_pkg %&gt;%<br>  pull(language) %&gt;% <span># pull()提取列，这里指提取language列</span><br>  unique() %&gt;% <span># 删除重复</span><br>  sort()) <span># 排序</span><br><br><span># 不同的编程语言用不同的颜色表示</span><br>top_language_colors &lt;- c(<br>  <span>"#efb306"</span>, <span>"#eb990c"</span>, <span>"#e8351e"</span>, <span>"#cd023d"</span>, <span>"#852f88"</span>,<br>  <span>"#4e54ac"</span>, <span>"#0f8096"</span>, <span>"#7db954"</span>, <span>"#17a769"</span>,<br>  <span>"#000000"</span><br>)<br><br>names(top_language_colors) &lt;- c(top_languages, <span>"All"</span>)<br><br><span>################ 边</span><br><span># transmute()添加新变量，并删除现有变量，这里将language列赋值给from新列</span><br>edges1 &lt;- top_languages_per_pkg %&gt;%<br>  transmute(from = language, to = pkg_name, total_code = total_code, main = main)<br><br><span># count()中wt选项，指的是Frequency weights，可以为NULL或者变量名</span><br><span># 如果为NULL(默认值)，则计算每个组中的行数。</span><br><span># 如果是变量，计算每组的sum(wt)。</span><br>edges2 &lt;- top_languages_per_pkg %&gt;%<br>  count(x = ., language, wt = code, name = <span>"total_code"</span>) %&gt;% <span># 按language进行分组，计算组内code的总和，命名为total_code</span><br>  transmute(from = <span>""</span>, to = language, total_code, main = <span>TRUE</span>)<br><br><span># 按相同列进行合并，增加行数</span><br>edges &lt;- bind_rows(edges1, edges2)<br><br><span>################ 顶点</span><br>vertices1 &lt;- top_languages_per_pkg %&gt;%<br>  filter(main) %&gt;% <span># 提取main列为TRUE的行</span><br>  transmute(node = pkg_name, language, total_code, level = <span>1</span>)<br><br>vertices2 &lt;- edges2 %&gt;%<br>  transmute(node = to, language = to, total_code, level = <span>2</span>)<br><br>vertices3 &lt;- tibble(node = <span>""</span>, language = <span>NA</span>, total_code = <span>0</span>, level = <span>3</span>)<br><br>vertices &lt;- bind_rows(vertices1, vertices2, vertices3) %&gt;%<br>  mutate(<br>    radius = total_code**(<span>1.8</span>), <span># 缩放圆的半径</span><br>    language = factor(language, names(top_language_colors))<br>  ) %&gt;%<br>  arrange(level, language, node)<br></code></pre><h3 data-tool="mdnice编辑器"><span><span>1.3 </span>可视化</span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>################ 作图</span><br><span># 从dataframes创建igraph图数据</span><br>my_graph &lt;- graph_from_data_frame(edges, vertices = vertices)<br><br><span># create_layout()创建ggraph图，相当于ggplot2::ggplot()，将结果保存为layout，</span><br><span># 通过更新现有的圆形布局layout，创建自定义布局</span><br>layout &lt;- create_layout(graph = my_graph, layout = <span>"circle"</span>)<br><br><span># 外圈</span><br>outer_circle &lt;- layout %&gt;%<br>  filter(level == <span>1</span>) %&gt;%<br>  mutate(language = factor(language, names(top_language_colors))) %&gt;%<br>  arrange(language, desc(name)) %&gt;%<br>  mutate(<br>    x = cos((row_number() - <span>1</span>) / number_of_pkgs * <span>2</span> * pi), <span># 重新生成各个点的坐标</span><br>    y = sin((row_number() - <span>1</span>) / number_of_pkgs * <span>2</span> * pi)<br>  )<br><br><span># 内圈</span><br><span># 通过指定极坐标手动定位圆中心</span><br>angles &lt;- c(<span>3</span>, <span>43</span>, <span>119</span>, <span>160</span>, <span>178</span>, <span>255</span>, <span>350</span>, <span>190</span>, <span>340</span>, <span>0</span>)<br>radii &lt;- c(<span>0.8</span>, <span>0.5</span>, <span>0.6</span>, <span>0.4</span>, <span>0.65</span>, <span>0.45</span>, <span>0.6</span>, <span>0.7</span>, <span>0.38</span>, <span>0</span>)<br>centers &lt;- tibble(<br>  x = radii * cos(angles / <span>180</span> * pi),<br>  y = radii * sin(angles / <span>180</span> * pi)<br>)<br><span># 选取level2和level3行，删除x和y列，再合并上面计算出来的新x和y列</span><br>inner_circle &lt;- bind_cols(centers, select(filter(layout, level != <span>1</span>), -x, -y))<br><br><span># 将layout的数据全部更新（即layout[]，也可以写成layout）</span><br>layout[] &lt;- bind_rows(outer_circle, inner_circle) %&gt;%<br>  arrange(.ggraph.index)<br><br><br><span># ggraph()，创建ggraph图</span><br>ggraph(layout) +<br><br>  <span># geom_edge_diagonal()，画边</span><br>  geom_edge_diagonal(<br>    aes(<br>      edge_color = node1.language,<br>      edge_alpha = as.factor(main)<br>    ),<br>    edge_width = <span>0.3</span>,<br>    show.legend = <span>FALSE</span><br>  ) +<br><br>  <span># geom_node_point()，画点</span><br>  geom_node_point(<br>    aes(<br>      size = radius,<br>      color = language<br>    ),<br>    alpha = <span>0.6</span>,<br>    show.legend = <span>FALSE</span><br>  ) +<br><br>  <span># geom_node_text()，点注释</span><br>  geom_node_text(<br>    aes(<br>      x = <span>1.0175</span> * x, <span># 这里将外圈放大</span><br>      y = <span>1.0175</span> * y,<br>      label = name,<br>      angle = -((-node_angle(x, y) + <span>90</span>) %% <span>180</span>) + <span>90</span>,<br>      filter = !(name %<span>in</span>% top_languages) <span># 因为将内外圈的数据放在一个dataframe中，这里只提取外圈的数据</span><br>    ),<br>    size = <span>2</span>,<br>    <span># family = 'Oswald',</span><br>    hjust = <span>"outward"</span><br>  ) +<br>  geom_node_text(<br>    aes(<br>      x = x,<br>      y = y,<br>      label = name,<br>      filter = name %<span>in</span>% top_languages <span># 这里只提取内圈的数据</span><br>    ),<br>    size = <span>6</span>,<br>    <span># family = 'Oswald',</span><br>    hjust = <span>0.5</span><br>  ) +<br>  geom_node_text(<br>    aes(<br>      x = x,<br>      y = y - <span>0.045</span>,<br>      label = ifelse(total_code &gt; <span>1000</span>, format(total_code, big.mark = <span>","</span>), total_code), <span># 判断语句</span><br>      filter = name %<span>in</span>% top_languages<br>    ),<br>    size = <span>3</span>,<br>    <span># family = 'Oswald',</span><br>    hjust = <span>0.5</span><br>  ) +<br><br>  <span># 其他</span><br>  scale_edge_color_manual(values = top_language_colors) + <span># 重新定义边的颜色</span><br>  scale_edge_alpha_manual(values = c(<span>0.15</span>, <span>1</span>)) + <span># 边的透明度</span><br>  scale_color_manual(values = top_language_colors) + <span># 重新定义点的颜色</span><br>  scale_size_area(max_size = <span>150</span>) + <span># 按什么缩放点的大小，指定最大面积为150，最小面积默认从0开始</span><br>  coord_fixed() + <span># 坐标系伸缩变换，只影响图形展示，不影响内部数据的值。</span><br>  labs(<br>    title = <span>"CLOC of Popular Programming Languages in 300 CRAN Packages"</span>,<br>    subtitle = <span>"considered are largest CRAN packages written in one (or more) of top 16 programming languages from TIOBE Index (Nov. 2019)"</span>,<br>    caption = <span>"#tidytuesday 46|2019 spren9er"</span><br>  ) +<br>  theme_void() +<br>  theme(<br>    <span># text = element_text(family = 'Oswald'),</span><br>    legend.position = c(<span>0.645</span>, <span>0.51</span>),<br>    plot.title = element_text(face = <span>"bold"</span>, hjust = <span>0.5</span>, size = <span>20</span>, margin = margin(t = <span>45</span>, b = <span>3</span>)),<br>    plot.subtitle = element_text(face = <span>"plain"</span>, hjust = <span>0.5</span>, size = <span>13</span>, margin = margin(t = <span>5</span>, b = <span>3</span>)),<br>    plot.caption = element_text(face = <span>"plain"</span>, color = <span>"#dedede"</span>, size = <span>8</span>, hjust = <span>1</span>, margin = margin(b = <span>20</span>))<br>  )<br><br>ggsave(<span>"cran_packages.png"</span>, width = <span>12</span>, height = <span>12.5</span>, dpi = <span>300</span>)<br></code></pre><p data-tool="mdnice编辑器">最后的图片内容如下：</p><p><img data-galleryid="" data-ratio="1.04140625" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMGMtyX2hbDm4b6yyz0161yXlHwCqp4sGMHiah0Htdv53QCayGllI6ibEHA/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMGMtyX2hbDm4b6yyz0161yXlHwCqp4sGMHiah0Htdv53QCayGllI6ibEHA/640?wx_fmt=png"></p><p data-tool="mdnice编辑器"><span>这个图是真的漂亮！</span></p><p data-tool="mdnice编辑器">感觉可以改改，来展示 GO 和 KEGG 的富集结果，后面找时间研究下。</p><h2 data-tool="mdnice编辑器"><span>2.</span><span></span><span>知识点</span><span></span></h2><h3 data-tool="mdnice编辑器"><span><span>2.1 </span>坐标系相互转化</span></h3><p data-tool="mdnice编辑器">代码中有一些坐标系的转化，因此这里找了些资料。</p><p data-tool="mdnice编辑器">当我们在平面上同时使用极坐标和直角坐标时，我们令它们的原点重合，取极坐标的初始射线为正 X 轴，射线 <span><span role="presentation" data-formula="\theta = \frac{\pi}{2} , r&gt;0" data-formula-type="inline-equation"><svg xmlns="http://www.w3.org/2000/svg" role="img" focusable="false" viewbox="0 -705 5374.8 1050" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="3B8" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"></path></g><g data-mml-node="mo" transform="translate(746.8, 0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mfrac" transform="translate(1802.6, 0)"><g data-mml-node="mi" transform="translate(220, 394) scale(0.707)"><path data-c="3C0" d="M132 -11Q98 -11 98 22V33L111 61Q186 219 220 334L228 358H196Q158 358 142 355T103 336Q92 329 81 318T62 297T53 285Q51 284 38 284Q19 284 19 294Q19 300 38 329T93 391T164 429Q171 431 389 431Q549 431 553 430Q573 423 573 402Q573 371 541 360Q535 358 472 358H408L405 341Q393 269 393 222Q393 170 402 129T421 65T431 37Q431 20 417 5T381 -10Q370 -10 363 -7T347 17T331 77Q330 86 330 121Q330 170 339 226T357 318T367 358H269L268 354Q268 351 249 275T206 114T175 17Q164 -11 132 -11Z"></path></g><g data-mml-node="mn" transform="translate(244.7, -345) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><rect width="603.1" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(2645.6, 0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(3090.3, 0)"><path data-c="72" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(3819.1, 0)"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path></g><g data-mml-node="mn" transform="translate(4874.8, 0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g></g></g></svg></span></span>，如下图所示：</p><figure data-tool="mdnice编辑器"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMGmUkWf8zOfDEm6eI80ppKia4HgoNS6Sia5DnO2rTVMrjWhc6XrGfgcQ4A/640?wx_fmt=jpeg" data-type="jpeg" data-w="500" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMGmUkWf8zOfDEm6eI80ppKia4HgoNS6Sia5DnO2rTVMrjWhc6XrGfgcQ4A/640?wx_fmt=jpeg"></figure><p data-tool="mdnice编辑器">（1）“极坐标”变成“直角坐标”：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.3582089552238806" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMGsEpiaHIe0moyjibuDyiamGhAfaWnQs9EbESxEIJ4LckHGgyd1rUdA4cAA/640?wx_fmt=png" data-type="png" data-w="737" src="https://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMGsEpiaHIe0moyjibuDyiamGhAfaWnQs9EbESxEIJ4LckHGgyd1rUdA4cAA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">（2）“直角坐标”变成“极坐标”：</p><p data-tool="mdnice编辑器">主要是要考虑点所在的象限，比如上图中的情况：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.30286493860845837" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMGxRaaIZvRVJ8HsrHlO3CUoJ7vXIBtoqzrEQQeEsfLIFQPeA50P0UkCQ/640?wx_fmt=png" data-type="png" data-w="733" src="https://mmbiz.qpic.cn/sz_mmbiz_png/XjV6XiaVYFnd9iaXzWBPGgtvlJXbyT0wMGxRaaIZvRVJ8HsrHlO3CUoJ7vXIBtoqzrEQQeEsfLIFQPeA50P0UkCQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">但如果不在第一象限，就要用诱导公式把角处理一下。</p><h3 data-tool="mdnice编辑器"><span><span>2.2 </span>row_number()函数</span></h3><p data-tool="mdnice编辑器">row_number() 函数用于创建标识号（即一个 ID 变量），可以用分组变量标记每个观察结果。</p><ul data-tool="mdnice编辑器"><li><section>row_number() 函数目前是使用内建的 rank 函数实现的，row_number() 等价于 rank(ties.method = "first")；</section></li><li><section>主要是目前是使用内建的 rank 函数实现的，主要是在 R 和 SQL 之间转换时提供方便。</section></li><li><section>所有排序函数都将最小的输入映射到最小的输出。</section></li><li><section>使用 desc() 来反转方向。</section></li></ul><p data-tool="mdnice编辑器">用代码来解释下：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; x &lt;- c(<span>5</span>, <span>1</span>, <span>3</span>, <span>2</span>, <span>2</span>, <span>NA</span>)<br>&gt; <br>&gt; <span># 计算出x中元素的秩，NA不参与计算</span><br>&gt; row_number(x)<br>[<span>1</span>]  <span>5</span>  <span>1</span>  <span>4</span>  <span>2</span>  <span>3</span> <span>NA</span><br>&gt; <br>&gt; row_number(desc(x))<br>[<span>1</span>]  <span>1</span>  <span>5</span>  <span>2</span>  <span>3</span>  <span>4</span> <span>NA</span><br></code></pre><blockquote data-tool="mdnice编辑器"><p>row_number() 可以不指定参数。</p><p>row_number can be used with single table verbs without specifying x (for data frames and databases that support windowing)</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span># 基础数据</span><br>tmp &lt;- data.frame(<br>  ID = c(<span>101</span>, <span>103</span>, <span>104</span>, <span>105</span>, <span>102</span>, <span>100</span>, <span>106</span>, <span>107</span>, <span>108</span>, <span>109</span>),<br>  NAME = c(<span>"John"</span>, <span>"Jony"</span>, <span>"Sheldon"</span>, <span>"Max"</span>, <span>"Tom"</span>, <span>"Jemma"</span>, <span>"Haward"</span>, <span>"Peter"</span>, <span>"Jerry"</span>, <span>"Molly"</span>),<br>  PASSWORd = c(<span>"extends"</span>, <span>"Avengers"</span>, <span>"bigBang"</span>, <span>"Brokenirls"</span>, <span>"cat"</span>, <span>"shiled"</span>, <span>"bigBang"</span>, <span>"Brokengirls"</span>, <span>"mouse"</span>, <span>"extends"</span>),<br>  DEPARTMENT = c(<span>30</span>, <span>40</span>, <span>50</span>, <span>60</span>, <span>70</span>, <span>20</span>, <span>50</span>, <span>60</span>, <span>70</span>, <span>30</span>)<br>)<br><br><span># 计算每行的秩</span><br>mutate(tmp, rank = row_number())<br><br><span># 将第一行标为TRUE，其余行标为FALSE</span><br>mutate(tmp, row_number() == <span>1L</span>)<br><br><span># 计算每行的秩，再提取出秩在[1，5]的行</span><br>tmp %&gt;% filter(between(row_number(), lower = <span>1</span>, upper = <span>5</span>))<br></code></pre><p data-tool="mdnice编辑器">结果如下：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; tmp<br>    ID    NAME    PASSWORd DEPARTMENT<br><span>1</span>  <span>101</span>    John     extends         <span>30</span><br><span>2</span>  <span>103</span>    Jony    Avengers         <span>40</span><br><span>3</span>  <span>104</span> Sheldon     bigBang         <span>50</span><br><span>4</span>  <span>105</span>     Max  Brokenirls         <span>60</span><br><span>5</span>  <span>102</span>     Tom         cat         <span>70</span><br><span>6</span>  <span>100</span>   Jemma      shiled         <span>20</span><br><span>7</span>  <span>106</span>  Haward     bigBang         <span>50</span><br><span>8</span>  <span>107</span>   Peter Brokengirls         <span>60</span><br><span>9</span>  <span>108</span>   Jerry       mouse         <span>70</span><br><span>10</span> <span>109</span>   Molly     extends         <span>30</span><br>&gt; <span># 计算每行的秩</span><br>&gt; mutate(tmp, rank = row_number())<br>    ID    NAME    PASSWORd DEPARTMENT rank<br><span>1</span>  <span>101</span>    John     extends         <span>30</span>    <span>1</span><br><span>2</span>  <span>103</span>    Jony    Avengers         <span>40</span>    <span>2</span><br><span>3</span>  <span>104</span> Sheldon     bigBang         <span>50</span>    <span>3</span><br><span>4</span>  <span>105</span>     Max  Brokenirls         <span>60</span>    <span>4</span><br><span>5</span>  <span>102</span>     Tom         cat         <span>70</span>    <span>5</span><br><span>6</span>  <span>100</span>   Jemma      shiled         <span>20</span>    <span>6</span><br><span>7</span>  <span>106</span>  Haward     bigBang         <span>50</span>    <span>7</span><br><span>8</span>  <span>107</span>   Peter Brokengirls         <span>60</span>    <span>8</span><br><span>9</span>  <span>108</span>   Jerry       mouse         <span>70</span>    <span>9</span><br><span>10</span> <span>109</span>   Molly     extends         <span>30</span>   <span>10</span><br>&gt; <span># 将第一行标为TRUE，其余行标为FALSE</span><br>&gt; mutate(tmp, row_number() == <span>1L</span>)<br>    ID    NAME    PASSWORd DEPARTMENT row_number() == <span>1L</span><br><span>1</span>  <span>101</span>    John     extends         <span>30</span>               <span>TRUE</span><br><span>2</span>  <span>103</span>    Jony    Avengers         <span>40</span>              <span>FALSE</span><br><span>3</span>  <span>104</span> Sheldon     bigBang         <span>50</span>              <span>FALSE</span><br><span>4</span>  <span>105</span>     Max  Brokenirls         <span>60</span>              <span>FALSE</span><br><span>5</span>  <span>102</span>     Tom         cat         <span>70</span>              <span>FALSE</span><br><span>6</span>  <span>100</span>   Jemma      shiled         <span>20</span>              <span>FALSE</span><br><span>7</span>  <span>106</span>  Haward     bigBang         <span>50</span>              <span>FALSE</span><br><span>8</span>  <span>107</span>   Peter Brokengirls         <span>60</span>              <span>FALSE</span><br><span>9</span>  <span>108</span>   Jerry       mouse         <span>70</span>              <span>FALSE</span><br><span>10</span> <span>109</span>   Molly     extends         <span>30</span>              <span>FALSE</span><br>&gt; <span># 计算每行的秩，再提取出秩在[1，5]的行</span><br>&gt; tmp %&gt;% filter(between(row_number(), lower = <span>1</span>, upper = <span>5</span>))<br>   ID    NAME   PASSWORd DEPARTMENT<br><span>1</span> <span>101</span>    John    extends         <span>30</span><br><span>2</span> <span>103</span>    Jony   Avengers         <span>40</span><br><span>3</span> <span>104</span> Sheldon    bigBang         <span>50</span><br><span>4</span> <span>105</span>     Max Brokenirls         <span>60</span><br><span>5</span> <span>102</span>     Tom        cat         <span>70</span><br></code></pre><p data-tool="mdnice编辑器">自己该如何实现这个函数呢？</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(data.table)<br><br><span># 将上面的数据框转成data.table格式</span><br>tmp &lt;- as.data.table(tmp)<br><br><span># 新增一列rn， 按照ID排序，并按照DEPARTMENT分组，即实现分区的功能</span><br>tmp[, rn := rank(-ID), by = <span>"DEPARTMENT"</span>]<br>tmp[order(DEPARTMENT, rn)]<br>tmp[rn == <span>1</span>][order(DEPARTMENT)]<br><br>tmp %&gt;%<br>  group_by(DEPARTMENT) %&gt;%<br>  arrange(DEPARTMENT, desc(ID)) %&gt;%<br>  mutate(rn = rank(desc(ID), ties.method = <span>"first"</span>)) %&gt;%<br>  filter(rn == <span>1</span>)<br><br><span># 等价于</span><br>tmp %&gt;%<br>  group_by(DEPARTMENT) %&gt;%<br>  mutate(rank = row_number(desc(ID))) %&gt;%<br>  filter(rank == <span>1</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span><span>2.3 </span>括号的另一种用法</span></h3><p data-tool="mdnice编辑器">括号<code>()</code>除了用来表示优先级和用在函数名后定义参数外，还有一个用法。</p><p data-tool="mdnice编辑器">那就是直接显示变量值，不用再调用函数名。</p><p data-tool="mdnice编辑器">举例如下：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; a &lt;- c(<span>1</span>:<span>5</span>)<br>&gt; a<br>[<span>1</span>] <span>1</span> <span>2</span> <span>3</span> <span>4</span> <span>5</span><br>&gt; (a &lt;- c(<span>1</span>:<span>5</span>))<br>[<span>1</span>] <span>1</span> <span>2</span> <span>3</span> <span>4</span> <span>5</span><br></code></pre><p data-tool="mdnice编辑器">又学到了一个能卖弄的小技巧，奈斯！</p><h2 data-tool="mdnice编辑器"><span>3.</span><span></span><span>参考链接</span><span></span></h2><ul data-tool="mdnice编辑器"><li><section>spren9er：https://github.com/spren9er/tidytuesday/blob/6622103171e62e2864a7f8d149966800bd99ba02/tidytuesday_201946_cran_packages.r</section></li><li><section>数据：https://github.com/rfordatascience/tidytuesday/tree/master/data/2019/2019-11-12/</section></li><li><section>极坐标怎么与直角坐标系相互转化？：https://www.zhihu.com/question/324685172</section></li><li><section>R中实现好用的row_number()函数：https://zhuanlan.zhihu.com/p/41132586</section></li></ul></section><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/FUcTF6UFCMpp4GmwvcwWcQ",target="_blank" rel="noopener noreferrer">原文链接</a>
