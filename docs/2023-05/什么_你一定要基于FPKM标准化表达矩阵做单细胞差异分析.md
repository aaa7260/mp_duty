---
title: "什么，你一定要基于FPKM标准化表达矩阵做单细胞差异分析"
date: 2023-05-03T00:44:30Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
什么，你一定要基于FPKM标准化表达矩阵做单细胞差异分析 by 生信技能树
------
<div><section data-tools="新媒体管家" data-label="powered by xmt.cn"><br></section><p><br></p><section powered-by="xiumi.us"><section><section><section><img data-ratio="0.91875" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wztsZWIld4dbSAHficyAXWgkicrhjjacU8Ey0UKM56qbSnedHStMqWUfTPQxbqxNTVZy1g59nNW3BSg/640?wx_fmt=jpeg" data-type="jpeg" data-w="640" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wztsZWIld4dbSAHficyAXWgkicrhjjacU8Ey0UKM56qbSnedHStMqWUfTPQxbqxNTVZy1g59nNW3BSg/640?wx_fmt=jpeg"></section></section><span title="" opera-tn-ra-cell="_$.pages:0.layers:0.comps:0.title1"><p><br></p></span></section><section><section powered-by="xiumi.us"><p>学徒和学员已经陆续出师，是时候把生信技能树的舞台交给后辈了！</p></section></section></section><section powered-by="xiumi.us"><section data-tools="新媒体排版" data-id="763890" data-style-type="undefined"><section placeholder="请输入标题">下面是《生信入门第7期》学员的分享</section></section></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>最近看到有一个简单的数据挖掘文章，就做了一个单细胞表达矩阵的差异分析，然后强行解释一波。而且使用的是基于FPKM标准化表达矩阵载入seurat包进行分析，就随便使用我们学习班获得的技能复现一下，分享给广大读者。</p></blockquote></section><ul><li><p>1、概述</p></li><ul><li><p>计算基因长度</p></li><li><p>1.1 单细胞差异分析pipeline</p></li><li><p>1.2 count标准化</p></li></ul><li><p>2、官方fpkm数据差异分析</p></li><ul><li><p>2.1 表达矩阵与分组信息</p></li><li><p>2.2 ID转换</p></li><li><p>2.3 创建seurat，质控，差异分析一键操作</p></li><li><p>2.4 差异结果可视化</p></li></ul><li><p>3、根据count矩阵转换fpkm并完成差异分析</p></li><ul><li><p>3.1 导入count矩阵</p></li><li><p>3.2 计算fpkm矩阵</p></li><li><p>3.3 差异分析</p></li><li><p>3.4 可视化</p></li></ul></ul><p>前言：使用GSE81861提供的数据，比较CRC肿瘤上皮细胞与正常上皮细胞的差异。</p><p>GEO提供了count与fpkm两种数据。笔记内容先用官方的fpkm数据做差异分析，再利用counts数据手动计算fpkm矩阵，完成差异分析。最后比较两种方法的结果是否存在差异。</p><p>https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE81861</p><p>注：因为有不少重复的步骤，故设置较多的函数。</p><h1>1、概述</h1><h2>1.1 单细胞差异分析pipeline</h2><p>简单来说分为三步：首先导入、制备规范的表达矩阵以及分组信息；然后利用Seurat包构建seurat对象，归一化；最后进行差异分析，以及结果的可视化。</p><h2>1.2 count标准化</h2><p>主要受测序文库(样本总read数)与基因长度的影响，测序的counts数据不能直接进行差异分析，需要进行标准化处理。常见的几种标准化方法简单介绍如下–</p><ul><li><p>rpkm：counts先对测序文库标准化，再对基因长度标准化；</p></li><li><p>fpkm：FPKM同RPKM是一样的，只是RPKM用于单末端测序，而FPKM用于双末端测序；</p></li><li><p>tpm：counts先对基因长度标准化，再对测序文库标准化；</p></li><li><p>cpm：counts只对测序文库标准化。</p></li></ul><p>测序文库相对容易计算，直接使用<code>colSums()</code>函数即可；而基因长度则比较难求，首先要了解基因长度有不同的定义标准，其次要知道哪些R包提供相关生物数据。我目前了解到了以下三种方法，以及根据与官方fpkm验证，最终选择第三种方法用于后续的分析。</p><h3>计算基因长度</h3><h4>(1)TxDb.Hsapiens.UCSC.hg19.knownGene包</h4><pre><code><span>if</span> (!<span>require</span>(<span>"TxDb.Hsapiens.UCSC.hg19.knownGene"</span>, quietly = <span>TRUE</span>))<br>  BiocManager::install(<span>"TxDb.Hsapiens.UCSC.hg19.knownGene"</span>)<br>txdb &lt;- TxDb.Hsapiens.UCSC.hg19.knownGene<br>exon_txdb=exons(txdb)<br>genes_txdb=genes(txdb)</code></pre><h5>g_l.1–根据非冗余外显子之和定义</h5><pre><code>g_l_1 &lt;- <span>function</span>(){<br>  o &lt;- findOverlaps(exon_txdb,genes_txdb)<br>  t1=exon_txdb[queryHits(o)]<br>  t2=genes_txdb[subjectHits(o)]<br>  t1=as.data.frame(t1)<br>  t1$geneid=mcols(t2)[,<span>1</span>]<br>  <span># 得到exon_id与geneid的对应关系</span><br>  g_l.1 &lt;- lapply(split(t1,t1$geneid),<span>function</span>(x){<br>    <span>#按gene id拆分表格</span><br>    head(x)<br>    tmp=apply(x,<span>1</span>,<span>function</span>(y){<br>      y[<span>2</span>]:y[<span>3</span>]<br>    }) <span>#根据每一个gene所有exon的区间，生成区间内的整数，返回的为list。</span><br>    length(unique(unlist(tmp)))<br>    <span>#计算共有多少种整数，即为最终的非冗余exon长度之和</span><br>  })<br>  head(g_l.1) <span>#为一个list</span><br>  g_l.1=data.frame(gene_id=names(g_l.1),length=as.numeric(g_l.1))<br>  dim(g_l.1)<br>  head(g_l.1)<br>  <span>#为基因ID增添ENSEMBLE ID</span><br>  <span>library</span>(org.Hs.eg.db)<br>  s2g=toTable(org.Hs.egENSEMBL)<br>  head(s2g)<br>  g_l.1=merge(g_l.1,s2g,by=<span>'gene_id'</span>)<br>  <span>#把g_l,s2g两个数据框以'gene_id'为连接进行拼接</span><br>  head(g_l.1)<br>  <span>return</span>(g_l.1)<br>}<br><br><br><br>g_l.1 &lt;- g_l_1()<br>head(g_l.1)</code></pre><pre><code>##   gene_id length      ensembl_id<br>## 1       1   7255 ENSG00000121410<br>## 2      10   1317 ENSG00000156006<br>## 3     100   1532 ENSG00000196839<br>## 4    1000   4570 ENSG00000170558<br>## 5   10000   7458 ENSG00000117020<br>## 6   10000   7458 ENSG00000275199</code></pre><h5>g_l.2—-根据最长转录本定义</h5><pre><code>g_l_2 &lt;- <span>function</span>(){<br>  t_l=transcriptLengths(txdb)<br>  head(t_l)<br>  t_l=na.omit(t_l)<br>  <span>#先按基因ID，再按转录本长度从大到小排序</span><br>  t_l=t_l[order(t_l$gene_id,t_l$tx_len,decreasing = <span>T</span>),]<br>  head(t_l);dim(t_l)<br>  <span>#根据gene_id去重，选择第一个，也就是最长的那个</span><br>  t_l=t_l[!duplicated(t_l$gene_id),]<br>  head(t_l);dim(t_l)<br>  g_l.2=t_l[,c(<span>3</span>,<span>5</span>)]<br>  <span>library</span>(org.Hs.eg.db)<br>  s2g=toTable(org.Hs.egENSEMBL)<br>  g_l.2=merge(g_l.2,s2g,by=<span>'gene_id'</span>)<br>  head(g_l.2)<br>  <span>return</span>(g_l.2)<br>}<br>g_l.2 &lt;- g_l_2()<br>head(g_l.2)</code></pre><pre><code>##   gene_id tx_len      ensembl_id<br>## 1       1   3419 ENSG00000121410<br>## 2      10   1317 ENSG00000156006<br>## 3     100   1532 ENSG00000196839<br>## 4    1000   4367 ENSG00000170558<br>## 5   10000   7082 ENSG00000275199<br>## 6   10000   7082 ENSG00000117020</code></pre><h4>(2)biomaRt包</h4><h5>g_l.3–根据最长转录本定义</h5><pre><code>g_l_3 &lt;- <span>function</span>(){<br>  <span>if</span> (!<span>require</span>(<span>"biomaRt"</span>, quietly = <span>TRUE</span>))<br>    BiocManager::install(<span>"biomaRt"</span>)<br>  ensembl &lt;- useMart(<span>"ensembl"</span>) <span>#connect to a specified BioMart database</span><br>  ensembl = useDataset(<span>"hsapiens_gene_ensembl"</span>,mart=ensembl)<br>  <span>#use the hsapiens(人类) dataset.或者直接如下设置</span><br>  <span>#ensembl = useMart("ensembl",dataset="hsapiens_gene_ensembl")</span><br>  test &lt;- getBM(attributes=c(<span>'ensembl_gene_id'</span>, <span>'start_position'</span>,<br>                             <span>'end_position'</span>,<span>'ensembl_transcript_id'</span>,<br>                             <span>'transcript_length'</span>),<br>                mart = ensembl)<br>  test &lt;- test[order(test$ensembl_gene_id,test$transcript_length,<br>                     decreasing = <span>T</span>),]<br>  g_l.3 &lt;- test[!duplicated(test$ensembl_gene_id),]<br>  g_l.3 &lt;- g_l.3[,c(<span>1</span>,<span>5</span>)]<br>  head(g_l.3)<br>  <span>return</span>(g_l.3)<br>}<br>g_l.3 &lt;- g_l_3()</code></pre><h4>比较三种结果的差异</h4><pre><code>dim(g_l.1);dim(g_l.2);dim(g_l.3)</code></pre><pre><code>## [1] 23729     3</code></pre><pre><code>## [1] 25159     3</code></pre><pre><code>## [1] 67130     2</code></pre><pre><code>g_l.1 &lt;- g_l.1[,-<span>1</span>]<br>colnames(g_l.1) &lt;- c(<span>"g_l.1"</span>,<span>"ensembl_id"</span>)<br>g_l.2 &lt;- g_l.2[,-<span>1</span>]<br>colnames(g_l.2) &lt;- c(<span>"g_l.2"</span>,<span>"ensembl_id"</span>)<br>colnames(g_l.3) &lt;- c(<span>"ensembl_id"</span>,<span>"g_l.3"</span>)<br>g_l_all &lt;- merge(g_l.1, g_l.2, by=<span>"ensembl_id"</span>)<br>g_l_all &lt;- merge(g_l_all, g_l.3, by=<span>"ensembl_id"</span>)<br>head(g_l_all,<span>10</span>)</code></pre><pre><code>##         ensembl_id g_l.1 g_l.2 g_l.3<br>## 1  ENSG00000000003  2486  2069  3796<br>## 2  ENSG00000000005  3031  3031  1205<br>## 3  ENSG00000000419  1069  1069  1161<br>## 4  ENSG00000000457  3426  3090  6308<br>## 5  ENSG00000000460  5654  3852  4355<br>## 6  ENSG00000000938  3470  2485  2637<br>## 7  ENSG00000000971  4386  4127  6985<br>## 8  ENSG00000001036  4415  2749  2385<br>## 9  ENSG00000001084  6221  3812  3785<br>## 10 ENSG00000001167  6589  6385  3811</code></pre><pre><code>summary(g_l_all)</code></pre><pre><code>##   ensembl_id            g_l.1            g_l.2            g_l.3<br>##  Length:23906       Min.   :    20   Min.   :    20   Min.   :    27<br>##  Class :character   1st Qu.:  1636   1st Qu.:  1472   1st Qu.:  1660<br>##  Mode  :character   Median :  2964   Median :  2515   Median :  2902<br>##                     Mean   :  3760   Mean   :  3083   Mean   :  3564<br>##                     3rd Qu.:  4934   3rd Qu.:  4104   3rd Qu.:  4743<br>##                     Max.   :117846   Max.   :109223   Max.   :109224</code></pre><pre><code><span>#最终选择第三种结果</span><br>g_l &lt;- g_l.3</code></pre><h1>2、官方fpkm数据差异分析</h1><h3>2.1 表达矩阵与分组信息</h3><pre><code><span>#表达矩阵</span><br>nm_FPKM &lt;- read.csv(<span>"GSE81861_CRC_NM_epithelial_cells_FPKM.csv/GSE81861_CRC_NM_epithelial_cells_FPKM.csv"</span>)<br>data_input &lt;- <span>function</span>(data){<br>  <span>#data &lt;- nm_FPKM</span><br>  row.names(data) &lt;- data[,<span>1</span>]<br>  data &lt;- data[,-<span>1</span>]<br>  data &lt;- as.matrix(data)<br>  rownames(data) &lt;- sapply(strsplit(rownames(data),<span>"_"</span>),<span>"["</span>,<span>3</span>)<br>  rownames(data) &lt;- sapply(strsplit(rownames(data),<span>"[.]"</span>),<span>"["</span>,<span>1</span>)<br>  colnames(data) &lt;- sapply(strsplit(colnames(data),<span>"_"</span>),<span>"["</span>,<span>1</span>)<br>  data &lt;- data[grep(<span>"ENSG"</span>,rownames(data)),]<br>  <span>return</span>(data)<br>}<br><br>nm_FPKM &lt;- data_input(nm_FPKM)<br>dim(nm_FPKM)  <span>#56380个基因 #160个样本</span></code></pre><pre><code>## [1] 56380   160</code></pre><pre><code>nm_FPKM[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]</code></pre><pre><code>##                 RHC4104 RHC6087 RHL2880   RHC5949<br>## ENSG00000000003   0.000 185.315 323.203 22.311700<br>## ENSG00000000005   0.000   0.000   0.000  0.000000<br>## ENSG00000000419   0.000 231.756   0.000  0.851514<br>## ENSG00000000457 100.135   0.000   0.000  0.000000</code></pre><pre><code>tumor_FPKM &lt;- read.csv(<span>"GSE81861_CRC_tumor_epithelial_cells_FPKM.csv/GSE81861_CRC_tumor_epithelial_cells_FPKM.csv"</span>)<br>tumor_FPKM &lt;- data_input(tumor_FPKM)<br>tumor_FPKM[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]</code></pre><pre><code>##                 RHC4075 RHC5563 RHC5552 RHC4874<br>## ENSG00000000003       0   0.000       0       0<br>## ENSG00000000005       0   0.000       0       0<br>## ENSG00000000419       0   0.000       0       0<br>## ENSG00000000457       0 193.167       0       0</code></pre><pre><code>dim(tumor_FPKM)<span>#56380个基因 #272个样本</span></code></pre><pre><code>## [1] 56380   272</code></pre><pre><code>exp_FPKM &lt;- cbind(nm_FPKM,tumor_FPKM)<br>dim(exp_FPKM) <span># 56380个基因   432个样本</span></code></pre><pre><code>## [1] 56380   432</code></pre><pre><code><span>#分组信息</span><br>group_dat &lt;- data.frame(group=c(rep(<span>'normal'</span>,<span>160</span>),<br>                                rep(<span>'tumor'</span>,<span>272</span>)),<br>                        row.names = colnames(exp_FPKM))</code></pre><h3>2.2 ID转换</h3><p>因为seurat质控需要过滤线粒体基因，所以需要把ensembl ID转换为 symbol ID</p><pre><code>exp_FPKM[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]</code></pre><pre><code>##                 RHC4104 RHC6087 RHL2880   RHC5949<br>## ENSG00000000003   0.000 185.315 323.203 22.311700<br>## ENSG00000000005   0.000   0.000   0.000  0.000000<br>## ENSG00000000419   0.000 231.756   0.000  0.851514<br>## ENSG00000000457 100.135   0.000   0.000  0.000000</code></pre><pre><code>id_change &lt;- <span>function</span>(data){<br>  print(dim(data))<br>  <span>library</span>(org.Hs.eg.db)<br>  ids1 &lt;- data.frame(ID=c(<span>1</span>:nrow(data)),<br>                     ensembl_id=rownames(data))<br>  ids2 &lt;- merge(toTable(org.Hs.egENSEMBL),<br>                toTable(org.Hs.egSYMBOL),by=<span>"gene_id"</span>)<br>  ids &lt;- merge(ids1, ids2, by=<span>"ensembl_id"</span>)<br>  data &lt;- data[ids$ID,]<br>  rownames(data) &lt;- ids$symbol<br>  print(dim(data))<br>  <span>return</span>(data)<br>}<br>exp_FPKM &lt;- id_change(exp_FPKM) <span>#有2w+个ensembl ID没配对到 symbol</span></code></pre><pre><code>## [1] 56380   432<br>## [1] 24941   432</code></pre><pre><code>exp_FPKM[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]</code></pre><pre><code>##        RHC4104 RHC6087 RHL2880   RHC5949<br>## TSPAN6   0.000 185.315 323.203 22.311700<br>## TNMD     0.000   0.000   0.000  0.000000<br>## DPM1     0.000 231.756   0.000  0.851514<br>## SCYL3  100.135   0.000   0.000  0.000000</code></pre><h3>2.3 创建seurat，质控，差异分析一键操作</h3><pre><code>scRNA_deg &lt;- <span>function</span>(exp,group){<br>  <span>library</span>(Seurat)<br>  print(<span>"创建seurat对象..."</span>)<br>  scRNA &lt;- CreateSeuratObject(counts=exp,<br>                              meta.data=group)<br>  print(<span>"质控..."</span>)<br>  scRNA[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(scRNA, pattern = <span>"^MT-"</span>)<br>  minGene=<span>500</span>;maxGene=<span>4000</span>;pctMT=<span>15</span><br>  scRNA &lt;- subset(scRNA, subset = nFeature_RNA &gt; minGene &amp; nFeature_RNA &lt; maxGene &amp; percent.mt &lt; pctMT)<br>  print(<span>"归一化..."</span>)<br>  scRNA &lt;- NormalizeData(scRNA, normalization.method = <span>"LogNormalize"</span>, scale.factor = <span>10000</span>)<br>  print(<span>"差异分析..."</span>)<br>  diff_dat &lt;- FindMarkers(scRNA,ident.1=<span>"normal"</span>,ident.2=<span>"tumor"</span>,<br>                          group.by=<span>'group'</span>)<br>  <br>}<br>FPKM_diff &lt;- scRNA_deg(exp=exp_FPKM, group=group_dat)</code></pre><pre><code>## [1] "创建seurat对象..."<br>## [1] "质控..."<br>## [1] "归一化..."<br>## [1] "差异分析..."</code></pre><pre><code>head(FPKM_diff)</code></pre><pre><code>##               p_val avg_logFC pct.1 pct.2    p_val_adj<br>## GUCA2A 1.353485e-30  2.576937 0.742 0.101 3.375728e-26<br>## CLCA4  3.106166e-30  1.112995 0.688 0.067 7.747089e-26<br>## MT1E   7.460402e-28  1.733571 0.789 0.162 1.860699e-23<br>## CKB    1.723524e-27  2.241367 0.883 0.285 4.298641e-23<br>## ZG16   1.936670e-27  2.753875 0.664 0.073 4.830248e-23<br>## PHGR1  5.482718e-27  1.882931 0.938 0.531 1.367445e-22</code></pre><pre><code>dim(FPKM_diff)</code></pre><pre><code>## [1] 1421    5</code></pre><pre><code>FPKM_diff &lt;- FPKM_diff[FPKM_diff$p_val&lt;<span>0.01</span> &amp; abs(FPKM_diff$avg_logFC)&gt;<span>0.8</span>,]<br>dim(FPKM_diff)</code></pre><pre><code>## [1] 122   5</code></pre><pre><code>exp_FPKM_diff &lt;- exp_FPKM[match(rownames(FPKM_diff),rownames(exp_FPKM)),]</code></pre><h3>2.4 差异结果可视化</h3><h5>热图</h5><pre><code>my_heatmap &lt;- <span>function</span>(exp_dat){<br>  n &lt;- t(scale(t(exp_dat)))<br>  n[n&gt;<span>2</span>]=<span>2</span>;n[n&lt; -<span>2</span>]= -<span>2</span><br>  <span>library</span>(pheatmap)<br>  pheatmap(n, show_rownames = <span>F</span>,<br>           show_colnames = <span>F</span>,<br>           annotation_col = group_dat)<br>}<br>p.exp_FPKM_diff &lt;- my_heatmap(exp_FPKM_diff)<br>p.exp_FPKM_diff</code></pre><p><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz0zqpJ6SXOFEh66KERJPUHk98pDNwyCJdhIiaxpNk3IugiaaQXruvp1K5HQ3GjvN0YiaBibCC5ysqAIQ/640?wx_fmt=png" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz0zqpJ6SXOFEh66KERJPUHk98pDNwyCJdhIiaxpNk3IugiaaQXruvp1K5HQ3GjvN0YiaBibCC5ysqAIQ/640?wx_fmt=png"></p><h5>箱图</h5><pre><code>my_boxplot &lt;- <span>function</span>(data,i){<br>  <span>library</span>(ggpubr)<br>  <span>if</span>(!is.numeric(i)){<br>    i=match(i,rownames(data))<br>  }<br>  df &lt;- data.frame(gene=data[i,], group=group_dat$group)<br>  ggboxplot(df,x=<span>"group"</span>,y=<span>"gene"</span>,<br>            color = <span>"group"</span>,add = <span>"jitter"</span>,<br>            ylab = rownames(data)[i]) +<br>    theme_bw()<br>}<br>my_boxplot(exp_FPKM_diff, <span>2</span>)</code></pre><p><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz0zqpJ6SXOFEh66KERJPUHqI1iaw4VJnZia7Fv5tZGnEunXGibCrqh8QZwZKFLTPjHkfDh6JrpvXiaBw/640?wx_fmt=png" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz0zqpJ6SXOFEh66KERJPUHqI1iaw4VJnZia7Fv5tZGnEunXGibCrqh8QZwZKFLTPjHkfDh6JrpvXiaBw/640?wx_fmt=png"></p><pre><code>my_boxplot(exp_FPKM_diff, <span>"PGK1"</span>)</code></pre><p><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz0zqpJ6SXOFEh66KERJPUHR49ZtUL3Tl2UkTRpQHR9Tr0GzPneLoc9icrLSJPNwo5mMvtB455OsNw/640?wx_fmt=png" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz0zqpJ6SXOFEh66KERJPUHR49ZtUL3Tl2UkTRpQHR9Tr0GzPneLoc9icrLSJPNwo5mMvtB455OsNw/640?wx_fmt=png"></p><h1>3、根据count矩阵转换fpkm并完成差异分析</h1><h3>3.1 导入count矩阵</h3><pre><code>nm_COUNT &lt;- read.csv(<span>"GSE81861_CRC_NM_epithelial_cells_COUNT.csv/GSE81861_CRC_NM_epithelial_cells_COUNT.csv"</span>)<br>nm_COUNT &lt;- data_input(nm_COUNT)<br>nm_COUNT[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]</code></pre><pre><code>##                 RHC4104 RHC6087 RHL2880 RHC5949<br>## ENSG00000000003       0     428      66     141<br>## ENSG00000000005       0       0       0       0<br>## ENSG00000000419       0     179       0       1<br>## ENSG00000000457     465       0       0       0</code></pre><pre><code>dim(nm_COUNT)</code></pre><pre><code>## [1] 56380   160</code></pre><pre><code>tumor_COUNT &lt;- read.csv(<span>"GSE81861_CRC_tumor_epithelial_cells_COUNT.csv/GSE81861_CRC_tumor_epithelial_cells_COUNT.csv"</span>)<br>tumor_COUNT &lt;- data_input(tumor_COUNT)<br>tumor_COUNT[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]</code></pre><pre><code>##                 RHC4075 RHC5563 RHC5552 RHC4874<br>## ENSG00000000003       0       0       0       0<br>## ENSG00000000005       0       0       0       0<br>## ENSG00000000419       0       0       0       0<br>## ENSG00000000457       0     133       0       0</code></pre><pre><code>dim(tumor_COUNT)</code></pre><pre><code>## [1] 56380   272</code></pre><h3>3.2 计算fpkm矩阵</h3><pre><code>my_FPKM &lt;- <span>function</span>(counts,g_l){<br>  <span>####根据有基因长度的基因，筛选矩阵子集</span><br>  <span>#counts=nm_COUNT</span><br>  ng=intersect(rownames(counts),g_l$ensembl_id)<br>  length(ng)<br>  lengths=g_l[match(ng,g_l$ensembl_id),<span>2</span>]<br>  names(lengths) &lt;- g_l[match(ng,g_l$ensembl_id),<span>1</span>]<br>  head(lengths)<br>  <span>#### 计算样本文库大小，以及最后的fpkm计算</span><br>  counts &lt;- counts[names(lengths),]<br>  counts[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  total_count &lt;- colSums(counts)<br>  head(total_count)<br>  <span>#根据counts、length、total_count计算fpkm</span><br>  FPKM &lt;- t(do.call( rbind,<br>                     lapply(<span>1</span>:length(total_count),<br>                            <span>function</span>(i){<br>                              <span>10</span>^<span>9</span>*counts[,i]/lengths/total_count[i]<br>                              <span>#lengths向量自动遍历</span><br>                            }) ))<br>  FPKM[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  <span>return</span>(FPKM)<br>}<br><br>nm_my_FPKM &lt;- my_FPKM(counts = nm_COUNT,<br>                      g_l = g_l)<br>colnames(nm_my_FPKM) &lt;- colnames(nm_COUNT)<br>nm_my_FPKM[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]</code></pre><pre><code>##                  RHC4104  RHC6087  RHL2880    RHC5949<br>## ENSG00000000003   0.0000 160.5715 168.6839 22.7021034<br>## ENSG00000000005   0.0000   0.0000   0.0000  0.0000000<br>## ENSG00000000419   0.0000 219.5694   0.0000  0.5264304<br>## ENSG00000000457 124.2016   0.0000   0.0000  0.0000000</code></pre><pre><code>dim(nm_my_FPKM)</code></pre><pre><code>## [1] 50813   160</code></pre><pre><code>tumor_my_FPKM &lt;- my_FPKM(counts = tumor_COUNT,<br>                      g_l = g_l)<br>dim(tumor_FPKM)</code></pre><pre><code>## [1] 56380   272</code></pre><pre><code>colnames(tumor_my_FPKM) &lt;- colnames(tumor_COUNT)<br>nm_my_FPKM[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]</code></pre><pre><code>##                  RHC4104  RHC6087  RHL2880    RHC5949<br>## ENSG00000000003   0.0000 160.5715 168.6839 22.7021034<br>## ENSG00000000005   0.0000   0.0000   0.0000  0.0000000<br>## ENSG00000000419   0.0000 219.5694   0.0000  0.5264304<br>## ENSG00000000457 124.2016   0.0000   0.0000  0.0000000</code></pre><h3>3.3 差异分析</h3><pre><code>exp_my_FPKM &lt;- cbind(nm_my_FPKM,tumor_my_FPKM)<br>dim(exp_my_FPKM) <span>#转换id前</span></code></pre><pre><code>## [1] 50813   432</code></pre><pre><code>exp_my_FPKM[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>] <span>#转换id前</span></code></pre><pre><code>##                  RHC4104  RHC6087  RHL2880    RHC5949<br>## ENSG00000000003   0.0000 160.5715 168.6839 22.7021034<br>## ENSG00000000005   0.0000   0.0000   0.0000  0.0000000<br>## ENSG00000000419   0.0000 219.5694   0.0000  0.5264304<br>## ENSG00000000457 124.2016   0.0000   0.0000  0.0000000</code></pre><pre><code>exp_my_FPKM &lt;- id_change(exp_my_FPKM)</code></pre><pre><code>## [1] 50813   432<br>## [1] 24931   432</code></pre><pre><code>dim(exp_my_FPKM) <span>#转换id后</span></code></pre><pre><code>## [1] 24931   432</code></pre><pre><code>exp_my_FPKM[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>] <span>#转换id后</span></code></pre><pre><code>##         RHC4104  RHC6087  RHL2880    RHC5949<br>## TSPAN6   0.0000 160.5715 168.6839 22.7021034<br>## TNMD     0.0000   0.0000   0.0000  0.0000000<br>## DPM1     0.0000 219.5694   0.0000  0.5264304<br>## SCYL3  124.2016   0.0000   0.0000  0.0000000</code></pre><pre><code>my_FPKM_diff &lt;- scRNA_deg(exp=exp_my_FPKM, group=group_dat)</code></pre><pre><code>## [1] "创建seurat对象..."<br>## [1] "质控..."<br>## [1] "归一化..."<br>## [1] "差异分析..."</code></pre><pre><code>head(my_FPKM_diff)</code></pre><pre><code>##               p_val avg_logFC pct.1 pct.2    p_val_adj<br>## CLCA4  2.640706e-30 1.6080767 0.688 0.067 6.583544e-26<br>## GUCA2A 3.289287e-30 2.4478445 0.742 0.101 8.200520e-26<br>## ZG16   1.629645e-27 2.9466466 0.664 0.073 4.062867e-23<br>## MT1E   2.707239e-27 1.4704522 0.789 0.162 6.749417e-23<br>## CKB    5.633316e-27 1.9409546 0.883 0.285 1.404442e-22<br>## PADI2  2.153941e-26 0.5522112 0.734 0.128 5.369989e-22</code></pre><pre><code>dim(my_FPKM_diff)</code></pre><pre><code>## [1] 1231    5</code></pre><pre><code>my_FPKM_diff &lt;- my_FPKM_diff[my_FPKM_diff$p_val&lt;<span>0.01</span> &amp; abs(my_FPKM_diff$avg_logFC)&gt;<span>0.8</span>,]<br>dim(my_FPKM_diff)</code></pre><pre><code>## [1] 112   5</code></pre><pre><code>exp_my_FPKM_diff &lt;- exp_my_FPKM[match(rownames(my_FPKM_diff),rownames(exp_my_FPKM)),]</code></pre><h3>3.4 可视化</h3><h5>热图</h5><pre><code>my_heatmap(exp_my_FPKM_diff)</code></pre><p><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz0zqpJ6SXOFEh66KERJPUHEPJibMLSAic0Rw4oenNPZJwfPaBtVNLVCCJnLOnsbibc0IxyzYp2Oqrtg/640?wx_fmt=png" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz0zqpJ6SXOFEh66KERJPUHEPJibMLSAic0Rw4oenNPZJwfPaBtVNLVCCJnLOnsbibc0IxyzYp2Oqrtg/640?wx_fmt=png"> ##### 箱图</p><pre><code>my_boxplot(exp_my_FPKM_diff, <span>2</span>)</code></pre><p><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz0zqpJ6SXOFEh66KERJPUH4j1Us6YuBemV5cMu1Nxl5cM4C6ibBlLgIvcTFibCBPYhap9sziboZyoRw/640?wx_fmt=png" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz0zqpJ6SXOFEh66KERJPUH4j1Us6YuBemV5cMu1Nxl5cM4C6ibBlLgIvcTFibCBPYhap9sziboZyoRw/640?wx_fmt=png"></p><pre><code>my_boxplot(exp_my_FPKM_diff, <span>"PGK1"</span>)</code></pre><p><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz0zqpJ6SXOFEh66KERJPUHL4W3Wz6owWicZrialQXvpzv6hia6R2dfAqVd5A7PKQJyg7RhG3libdXxfg/640?wx_fmt=png" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz0zqpJ6SXOFEh66KERJPUHL4W3Wz6owWicZrialQXvpzv6hia6R2dfAqVd5A7PKQJyg7RhG3libdXxfg/640?wx_fmt=png"></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">上个月我们组建了：《单细胞CNS图表复现交流群》，见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247495627&amp;idx=1&amp;sn=6cd6982928b04405fe0caac121c8d4d4&amp;scene=21#wechat_redirect" data-linktype="2">你要的rmarkdown文献图表复现全套代码来了（单细胞）</a>，也分享了单细胞转录组数据分析的流程：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247495635&amp;idx=1&amp;sn=b80a060573dfc266fe9d4c7773c88c7f&amp;scene=21#wechat_redirect" data-linktype="2">祖传的单个10x样本的seurat标准代码</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247495646&amp;idx=1&amp;sn=b24b77c21e99f11793ae8166be9ad02f&amp;scene=21#wechat_redirect" data-linktype="2">祖传的单个10x样本的seurat标准代码（人和鼠需要区别对待）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247495874&amp;idx=1&amp;sn=1189c08b96ce1ea2c70964db93f480d6&amp;scene=21#wechat_redirect" data-linktype="2">seurat标准流程实例之2个10x样本的项目（GSE135927数据集）</a></section></li></ul><p data-tool="mdnice编辑器">交流群里大家讨论的热火朝天，而且也都开始了图表复现之旅，如果你也想加入交流群，自己去：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247495627&amp;idx=1&amp;sn=6cd6982928b04405fe0caac121c8d4d4&amp;scene=21#wechat_redirect" data-linktype="2">你要的rmarkdown文献图表复现全套代码来了（单细胞）</a>找到我们的拉群小助手哈。</p></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/iYuXXPMEsBJwoE3qpAVShg",target="_blank" rel="noopener noreferrer">原文链接</a>
