---
title: "z-score的标准化究竟怎么弄？"
date: 2023-05-05T09:54:32Z
draft: ["false"]
tags: [
  "fetched",
  "果子学生信"
]
categories: ["Acdemic"]
---
z-score的标准化究竟怎么弄？ by 果子学生信
------
<div><section><p>在学习「数据挖掘导论」的<strong>数据预处理</strong>时，里面谈到了变量变换，我联想到了在基因表达量分析时的常见操作，例如FPKM，TPM，CPM，log对数变换。比如说在文章里面会见到如下的描述</p><blockquote><p>The size factor of each cell was computed using a pooling strategy implemented in the R function <code>computeSumFactors</code>. Normalized counts were then computed by dividing the counts for each cell by the size factor for that cell. A log2 transformation was applied to normalized counts.</p></blockquote><p>变量转换有什么好处，需要注意些什么呢？「数据挖掘导论」讨论了两种重要的变量变换类型: 简单函数变换和规范化。</p><p><strong>简单变换</strong>是使用一个简单数学函数分别作用于每一个值，例如log转换，求绝对值，求倒数等。统计学中，变量变换（例如log转换）常用于将不具有高斯（正态）分布的数据变换成具有高斯（正态）分布的数据。在数据挖掘领域可以用来进行数据压缩。这类变换需要我们了解数据在变化前后的后果，例如负数取倒数之后的大小关系会发生倒转。</p><p><strong>标准化(standardization)或规范化(normalization)</strong>的<strong>目标</strong>是使整个值的集合具有<strong>特定的属性</strong>。使用这两个术语需要特别注意使用这两个词的上下文。书中提到"在数据挖掘界，这两个术语常常可互换，然而，在统计学中，术语规范化可能与使得变量<strong>正态</strong>化相混淆"。虽然从中文的角度来看，规范化和正态化明显不一样，但是从英文的角度看，正态分布翻译自normal distribution, 很容易从normal联想到normalization。当然也有将normalization翻译成归一化，即将原来数据值通过<span><img data-ratio="0.13771186440677965" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1yDWQl9zrEiaMcianFISRpG1EwcReoBUq64LYj73FzictMpr9Zqfdfr0NcjetibJjIxF20aqibI1Bf4ag/640?wx_fmt=png" data-type="png" data-w="472" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1yDWQl9zrEiaMcianFISRpG1EwcReoBUq64LYj73FzictMpr9Zqfdfr0NcjetibJjIxF20aqibI1Bf4ag/640?wx_fmt=png"></span>转换到0,1之间。统计学的变量标准化指的就是对原来的数据基于均值和标准差计算z-score(公式如下), 不过考虑到均值和标准差受到离群点波动很大，可以用中位数替代均值，用绝对标准差替代标准差。<br><span><span><img data-ratio="0.4385026737967914" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1yDWQl9zrEiaMcianFISRpG1SUpPteSHMficvZRITBeKQfcNicKJcsicARRJNiaYjFEF4qyop8h5rEhadQ/640?wx_fmt=png" data-type="png" data-w="187" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1yDWQl9zrEiaMcianFISRpG1SUpPteSHMficvZRITBeKQfcNicKJcsicARRJNiaYjFEF4qyop8h5rEhadQ/640?wx_fmt=png"></span></span></p><p>R语言中做标准化常用到一个函数<code>scale</code>，它的功能是对矩阵的列进行中心化和(或)缩放</p><pre><code>scale(x, center = TRUE, scale = TRUE)<br></code></pre><p>参数就3个，基本上我用的时候就提供第一个输入，举个例子</p><pre><code>&gt; x &lt;- c(<span>1</span>,<span>2</span>,<span>3</span>,<span>4</span>,<span>5</span>)<br>&gt; y &lt;- scale(x)<br>&gt; y<br>           [,<span>1</span>]<br>[<span>1</span>,] -<span>1.2649111</span><br>[<span>2</span>,] -<span>0.6324555</span><br>[<span>3</span>,]  <span>0.0000000</span><br>[<span>4</span>,]  <span>0.6324555</span><br>[<span>5</span>,]  <span>1.2649111</span><br>attr(,<span>"scaled:center"</span>)<br>[<span>1</span>] <span>3</span><br>attr(,<span>"scaled:scale"</span>)<br>[<span>1</span>] <span>1.581139</span><br></code></pre><p>之前我都是这样子用的，也没有思考过这到底它到底做了些什么。最近为了彻底搞懂它的两个参数，我翻了它的源代码。</p><p>代码总共38行，第一部分是关于<code>center</code>参数，也就是中心化。它先判断<code>center</code>是否是逻辑值还是数值向量。如果是逻辑值，则当<code>center=TRUE</code>时它会计算每一列的均值，然后调用<code>sweep</code>按列分别减去均值。如果判定<code>center</code>是一个数值向量时，就是为<code>sweep</code>手动指定每一列的中心值。</p><pre><code><span>if</span> (is.logical(center)) {<br>  <span>if</span> (center) {<br>    center &lt;- colMeans(x, na.rm=<span>TRUE</span>)<br>    x &lt;- sweep(x, <span>2L</span>, center, check.margin=<span>FALSE</span>)<br>  }<br>}<br><span>else</span> {<br>  <span>if</span>(!is.numeric(center)) center &lt;- as.numeric(center)<br>  <span>if</span> (length(center) == nc)<br>    x &lt;- sweep(x, <span>2L</span>, center, check.margin=<span>FALSE</span>)<br>  <span>else</span><br>    <span>stop</span>(<span>"length of 'center' must equal the number of columns of 'x'"</span>)<br>}<br></code></pre><p>第二部分是关于<code>scale</code>,决定数据如何缩放。如果是逻辑值且为真时，默认用下面的函数计算每一列的缩放系数，然后用<code>sweep</code>按列除以每列系数<br><span><span><img data-ratio="0.6373056994818653" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1yDWQl9zrEiaMcianFISRpG1HSNzslrvic4jgic0cvBqutnDSyvJaEtvAC8eobFua7ibIHKQvN9R0j1XQ/640?wx_fmt=png" data-type="png" data-w="193" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1yDWQl9zrEiaMcianFISRpG1HSNzslrvic4jgic0cvBqutnDSyvJaEtvAC8eobFua7ibIHKQvN9R0j1XQ/640?wx_fmt=png"></span></span></p><blockquote><p>这个计算的结果就是样本标准差，因为<span><img data-ratio="0.4236111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1yDWQl9zrEiaMcianFISRpG1hsJPQA2ZicN5ibsxRiakkmz2BZIvkK7jNLCAPG9uGxGEpDkCuxDN9eQbA/640?wx_fmt=png" data-type="png" data-w="144" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1yDWQl9zrEiaMcianFISRpG1hsJPQA2ZicN5ibsxRiakkmz2BZIvkK7jNLCAPG9uGxGEpDkCuxDN9eQbA/640?wx_fmt=png"></span></p></blockquote><p>如果是数值向量，则用<code>sweep</code>以给定数值按列相除。</p><pre><code><span>if</span> (is.logical(scale)) {<br>  <span>if</span> (scale) {<br>    f &lt;- <span>function</span>(v) {<br>      v &lt;- v[!is.na(v)]<br>      sqrt(sum(v^<span>2</span>) / max(<span>1</span>, length(v) - <span>1L</span>))<br>    }<br>    scale &lt;- apply(x, <span>2L</span>, f)<br>    x &lt;- sweep(x, <span>2L</span>, scale, <span>"/"</span>, check.margin=<span>FALSE</span>)<br>  }<br>}<br><span>else</span> {<br>  <span>if</span>(!is.numeric(scale)) scale &lt;- as.numeric(scale)<br>  <span>if</span> (length(scale) == nc)<br>    x &lt;- sweep(x, <span>2L</span>, scale, <span>"/"</span>, check.margin=<span>FALSE</span>)<br>  <span>else</span><br>    <span>stop</span>(<span>"length of 'scale' must equal the number of columns of 'x'"</span>)<br>}<br></code></pre><p>最后一部分是设置输出结果的属性。</p><pre><code><span>if</span>(is.numeric(center)) attr(x, <span>"scaled:center"</span>) &lt;- center<br><span>if</span>(is.numeric(scale )) attr(x, <span>"scaled:scale"</span> ) &lt;- scale<br></code></pre><p>那么默认参数下，我们就是对矩阵按列进行z-score的标准化。检验标准很简单，计算标准化的数据的均值和标准差，z-score的结果就是让数据均值为0，标准差为1，不改变分布。</p><pre><code>&gt; mean(y)<br><span>0</span><br>&gt; sd(y)<br><span>1</span><br></code></pre><p>这解决了我多年的疑惑，为啥我在R语言中就是找不到<code>zscore</code>这个函数，因为<code>scale</code>默认情况下就是实现<code>z-score</code>的变换。当然R语言取名<code>scale</code>也是有它的道理，比方说数据中存在离群值，我们应该选择不容易受离群值影响的中位数替代均值，选择绝对平均偏差, 中位数绝对偏差或四分位数极差来替换方差。</p><pre><code><span># 默认参数</span><br>&gt; x &lt;- matrix(c(<span>1</span>,<span>2</span>,<span>3</span>,<span>4</span>,<span>5</span>,<span>1</span>,<span>2</span>,<span>3</span>,<span>4</span>,<span>1000</span>), ncol=<span>2</span>)<br>&gt; scale(x)<br><br>           [,<span>1</span>]       [,<span>2</span>]<br>[<span>1</span>,] -<span>1.2649111</span> -<span>0.4505747</span><br>[<span>2</span>,] -<span>0.6324555</span> -<span>0.4483330</span><br>[<span>3</span>,]  <span>0.0000000</span> -<span>0.4460914</span><br>[<span>4</span>,]  <span>0.6324555</span> -<span>0.4438497</span><br>[<span>5</span>,]  <span>1.2649111</span>  <span>1.7888488</span><br><span>...</span><br><span># 替换后</span><br>&gt; x &lt;- matrix(c(<span>1</span>,<span>2</span>,<span>3</span>,<span>4</span>,<span>5</span>,<span>1</span>,<span>2</span>,<span>3</span>,<span>4</span>,<span>1000</span>), ncol=<span>2</span>)<br>&gt; scale(x, <br>      center = apply(x, <span>2</span>, median),<br>      scale = apply(x, <span>2</span>, <span>function</span>(x){<br>        sum(abs(x - mean(x))) / (length(x)-<span>1</span>)<br>      })<br>      )<br><br>           [,<span>1</span>]         [,<span>2</span>]<br>[<span>1</span>,] -<span>1.3333333</span> -<span>0.005012531</span><br>[<span>2</span>,] -<span>0.6666667</span> -<span>0.002506266</span><br>[<span>3</span>,]  <span>0.0000000</span>  <span>0.000000000</span><br>[<span>4</span>,]  <span>0.6666667</span>  <span>0.002506266</span><br>[<span>5</span>,]  <span>1.3333333</span>  <span>2.498746867</span><br><span>...</span><br></code></pre><p>此外，它还能实现其他形式的数据转换，例如归一化，即将数据的范围缩放到0到1之间</p><pre><code>x &lt;- matrix(c(<span>1</span>,<span>2</span>,<span>3</span>,<span>4</span>,<span>5</span>,<span>6</span>), ncol=<span>2</span>)<br>y &lt;- scale(x, center = apply(x, <span>2</span>, min), <br>           scale = apply(x,<span>2</span>,<span>function</span>(x) {max(x)-min(x)})<br>           )<br></code></pre><p>最后总结一下:</p><ul><li><p><span>数据的变量转换有两类，简单变换和标准化/规范化，无论是何种变换都要看它的具体公式</span></p></li><li><p>R语言的<code>scale</code>默认就是计算原始数据的z-score, 通过调整<code>center</code>和<code>scale</code>可以实现多种形式的数据转换。</p></li></ul></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/TsZR4f-1U8ZpIBhcFtV6tg",target="_blank" rel="noopener noreferrer">原文链接</a>
