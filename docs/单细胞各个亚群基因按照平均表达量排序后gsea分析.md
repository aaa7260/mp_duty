---
title: "单细胞各个亚群基因按照平均表达量排序后gsea分析"
date: 2022-12-25T09:19:28Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
单细胞各个亚群基因按照平均表达量排序后gsea分析 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>理论上gsea或者gsva这样的给基因集合打分的算法需要的仅仅是全部的基因的排序，这个排序指标可以是差异分析后的变化倍数，也可以仅仅是每个样品的全部基因的表达量排序。但是在单细胞表达量矩阵里面有一个问题，就是每个细胞里面的全部基因90%都是0，所以它排序就很麻烦，表达量都是0的那些基因理论上是同一个顺序是并列的倒数第一名。所以，我们不是很建议在单细胞表达量矩阵的层面做gsea或者gsva这样的给基因集合打分，有其它更好的算法推荐，比如  addmodulescore，ucell，aucell等等。</p></blockquote><p data-tool="mdnice编辑器">如果一定要做gsea或者gsva这样的给基因集合打分，也有几个补救措施，比如把单细胞表达量矩阵进行缺失值插补，或者把单细胞表达量矩阵构建成为metacell矩阵。不过，最简单的方法是把单细胞表达量矩阵按照各个亚群来进行表达量平均，我们以大家熟知的pbmc3k数据集为例，大家先安装这个数据集对应的包 <code>SeuratData</code>，并且对它进行降维聚类分群，参考前面的例子：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497956&amp;idx=1&amp;sn=5d4deb7cf7b7848b3e2273cbd663bb6a&amp;scene=21#wechat_redirect" data-linktype="2">人人都能学会的单细胞聚类分群注释</a> ，而且每个亚群找高表达量基因，都存储为Rdata文件。标准代码是：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(SeuratData) <span>#加载seurat数据集  </span><br>getOption(<span>'timeout'</span>)<br>options(timeout=<span>10000</span>)<br><span>#InstallData("pbmc3k")  </span><br>data(<span>"pbmc3k"</span>)  <br>sce &lt;- pbmc3k.final  <br><span>library</span>(Seurat)<br>table(Idents(sce))<br>DimPlot(sce,label = <span>T</span>)<br>av &lt;-AverageExpression(sce , <br>                       assays = <span>"RNA"</span>)<br>av=av[[<span>1</span>]] <br>cg=names(tail(sort(apply(av, <span>1</span>, sd)),<span>1000</span>)) <br>pheatmap::pheatmap(cor(av[cg,])) <br></code></pre><p data-tool="mdnice编辑器">可以得到如下所示的各个单细胞亚群的表达量相关性：</p><p><img data-galleryid="" data-ratio="0.8106060606060606" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzGdibL5RewYBADhia1gaAdvxbo4IQgLmBesh4OojNgn5BU1u3iaLFA2a8zIMZceial2h5ibcXD4DA5f1A/640?wx_fmt=png" data-type="png" data-w="1320" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzGdibL5RewYBADhia1gaAdvxbo4IQgLmBesh4OojNgn5BU1u3iaLFA2a8zIMZceial2h5ibcXD4DA5f1A/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>各个单细胞亚群的表达量相关性</figcaption></figure><p data-tool="mdnice编辑器">可以很清晰看到血小板和淋巴系免疫细胞，髓系免疫细胞的区分是非常明显的。</p><p data-tool="mdnice编辑器">我们拿到了全部的基因在全部的单细胞亚群的表达量矩阵后，就可以在每个细胞亚群内部进行基因排序后的gsea分析啦。</p><p><img data-galleryid="" data-ratio="0.48990435706695007" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzGdibL5RewYBADhia1gaAdvxdmBWf7ic1vibH5HrjwV6ia4JPhlPWxKniaPyMfMWRicqEmaBgMicdHLxHKEA/640?wx_fmt=png" data-type="png" data-w="1882" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzGdibL5RewYBADhia1gaAdvxdmBWf7ic1vibH5HrjwV6ia4JPhlPWxKniaPyMfMWRicqEmaBgMicdHLxHKEA/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>全部的基因在全部的单细胞亚群的表达量矩阵</figcaption></figure><p data-tool="mdnice编辑器">全部的基因在全部的单细胞亚群的表达量矩阵，如下所示，可以类比成bulk表达量矩阵， 一般来说做的是ssGSEA分析，我们同样的使用<code>msigdbr</code> 包里面的基因列表吧。然后做GSEA分析我使用了<code>clusterProfiler</code>包的GSEA函数，全部的代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(GSVA) <br><span>library</span>(GSEABase)<br><span>library</span>(msigdbr)<br><span>library</span>(clusterProfiler)<br><br>all_gene_sets = msigdbr(species = <span>"Homo sapiens"</span>,<br>                        category=<span>'H'</span>) <br>msigdbr_collections()<br>all_gene_sets = msigdbr(species = <span>"Homo sapiens"</span>,<br>                        category = <span>"C2"</span>, subcategory =   <span>"CP:REACTOME"</span>  ) <br><span># geneList = av[,1] </span><br>gl = apply(av, <span>2</span>, <span>function</span>(geneList){<br>  geneList=sort(geneList,decreasing = <span>T</span>)<br>   print(head(geneList))<br>  print(tail(geneList))<br>  geneList=geneList[geneList&gt;<span>0.1</span>]<br>  egmt &lt;- GSEA(geneList, TERM2GENE= all_gene_sets[,c(<span>'gs_name'</span>,<span>'gene_symbol'</span>)] , <br>               minGSSize = <span>20</span>, <br>               pvalueCutoff = <span>1</span>,<br>               verbose=<span>FALSE</span>)<br>  head(egmt)<br>  egmt@result <br>  gsea_results_df &lt;- egmt@result <br>  <span>return</span>(gsea_results_df) <br>  <br>})<br>path = unique(all_gene_sets$gs_name)<br>es.max &lt;- do.call(cbind,<br>        lapply(gl, <span>function</span>(x){<br>          x[path,<span>'enrichmentScore'</span>]<br>        }))<br>rownames(es.max) = path<br>head(es.max)  <br>es.max=na.omit(es.max)<br>pheatmap::pheatmap(es.max,show_colnames =<span>T</span>,show_rownames = <span>F</span>) <br></code></pre><p data-tool="mdnice编辑器">但是结果有点诡异，首先就是全部的gsea结果都是正值，没有负值，其次就是除了血小板其它单细胞亚群过于类似，如下所示：</p><p><img data-galleryid="" data-ratio="1.0534188034188035" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzGdibL5RewYBADhia1gaAdvxpwQeLjARB9RSicBv90netoYzqFrCD9eH0W8tziba3OQqypcexabX7drg/640?wx_fmt=png" data-type="png" data-w="936" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzGdibL5RewYBADhia1gaAdvxpwQeLjARB9RSicBv90netoYzqFrCD9eH0W8tziba3OQqypcexabX7drg/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>其它单细胞亚群过于类似</figcaption></figure><p data-tool="mdnice编辑器">我简单挑选了一下各个单细胞亚群特异性的结果，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><br><span>#每个单细胞亚群的特异性top5基因集的 富集分析结果</span><br><span>library</span>(dplyr)<br>df = do.call(rbind,<br>             lapply(<span>1</span>:ncol(es.max), <span>function</span>(i){<br>               dat= data.frame(<br>                 path  = rownames(es.max),<br>                 cluster =   colnames(es.max)[i],<br>                 sd.1 = es.max[,i], <span>#每一列原值</span><br>                 sd.2 = apply(es.max[,-i], <span>1</span>, median)  <span>#除当列以外每行的中位值</span><br>               )<br>             })) <br>df$fc = df$sd.1 - df$sd.2<span>#两值相减，变化越大说明越有意义（从中挑出top5）</span><br>top5 &lt;- df %&gt;% group_by(cluster) %&gt;% top_n(<span>5</span>, fc)<span>#找出每个细胞类型的前五个通路</span><br>n=es.max[unique(top5$path),]<br>rownames(n)<br>rownames(n)[grepl(<span>'FGFR'</span>,rownames(n))]<br>rownames(n)=gsub(<span>'REACTOME_'</span>,<span>''</span>,rownames(n))<br>rownames(n)=substring(rownames(n),<span>1</span>,<span>30</span>)<br>pheatmap::pheatmap(n,show_rownames = <span>T</span>) <br></code></pre><p data-tool="mdnice编辑器">也是很诡异，如下所示：</p><p><img data-galleryid="" data-ratio="0.7570564516129032" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzGdibL5RewYBADhia1gaAdvxstJTcAAxnUOiabwp3MODxtVbb5uc1RGqVfW4HKHQQlsnaFwibCiaV33sA/640?wx_fmt=png" data-type="png" data-w="1984" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzGdibL5RewYBADhia1gaAdvxstJTcAAxnUOiabwp3MODxtVbb5uc1RGqVfW4HKHQQlsnaFwibCiaV33sA/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>B细胞和DC都富集到了抗原提呈通路</figcaption></figure><p data-tool="mdnice编辑器">可以看到，B细胞和DC都富集到了抗原提呈通路，符合。然后<strong>两个单核细胞不知道为什么富集到了高尔基体，可能是我生物学不达标无法理解。总体来说，就是很难理解为什么这个GSEA分析结果都是正值，没有负值。</strong></p><p data-tool="mdnice编辑器">实际上我给大家写的GEO数据库挖掘的标准代码教程里面是有根据MSIGDB数据库的gmt文件来做 GSEA分析的，那个结果就每次都是比较合情理 ：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(ggplot2)<br><span>library</span>(clusterProfiler)<br><span>library</span>(org.Hs.eg.db)<br><br><span>### 对 MigDB中的全部基因集 做GSEA分析。</span><br><span># http://www.bio-info-trainee.com/2105.html</span><br><span># http://www.bio-info-trainee.com/2102.html </span><br>{<br>  load(file = <span>'anno_DEG.Rdata'</span>)<br>  geneList=DEG$logFC<br>  names(geneList)=DEG$symbol<br>  geneList=sort(geneList,decreasing = <span>T</span>)<br>  <span># 选择gmt文件（MigDB中的全部基因集）</span><br>  d=<span>'../MsigDB/symbols'</span><br>  <span># 需要自己下载 gmt文件 哦 </span><br>  gmts &lt;- list.files(d,pattern = <span>'all'</span>)<br>  gmts<br>  <span>#GSEA分析</span><br>  <span>library</span>(GSEABase) <span># BiocManager::install('GSEABase')</span><br>  <span>## 下面使用lapply循环读取每个gmt文件，并且进行GSEA分析</span><br>  <span>## 如果存在之前分析后保存的结果文件，就不需要重复进行GSEA分析。</span><br>  f=<span>'gsea_results.Rdata'</span><br>  <span>if</span>(!file.exists(f)){<br>    gsea_results &lt;- lapply(gmts, <span>function</span>(gmtfile){<br>      <span># gmtfile=gmts[2]</span><br>      geneset &lt;- read.gmt(file.path(d,gmtfile)) <br>      print(paste0(<span>'Now process the '</span>,gmtfile))<br>      egmt &lt;- GSEA(geneList, TERM2GENE=geneset, verbose=<span>FALSE</span>)<br>      head(egmt)<br>      <span># gseaplot(egmt, geneSetID = rownames(egmt[1,]))</span><br><br>      <span>return</span>(egmt)<br>    })<br>    <span># 上面的代码耗时，所以保存结果到本地文件</span><br>    save(gsea_results,file = f)<br>  }<br>  load(file = f)<br>  <span>#提取gsea结果，熟悉这个对象</span><br>  gsea_results_list&lt;- lapply(gsea_results, <span>function</span>(x){<br>    cat(paste(dim(x@result)),<span>'\n'</span>)<br>    x@result<br>  })<br>  gsea_results_df &lt;- do.call(rbind, gsea_results_list)<br>  gseaplot(gsea_results[[<span>2</span>]],<span>'KEGG_CELL_CYCLE'</span>) <br>  gseaplot(gsea_results[[<span>2</span>]],<span>'FARMER_BREAST_CANCER_CLUSTER_6'</span>) <br>  gseaplot(gsea_results[[<span>5</span>]],<span>'GO_CONDENSED_CHROMOSOME_OUTER_KINETOCHORE'</span>) <br><br>}<br></code></pre></section><h4 data-tool="mdnice编辑器"><span>文末友情宣传</span></h4><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519083&amp;idx=1&amp;sn=61f07b390469617ca2e9924f5b3929ab&amp;scene=21#wechat_redirect" data-linktype="2">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li></ul><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/JgIY0ja13fW10ROlA-efug",target="_blank" rel="noopener noreferrer">原文链接</a>
