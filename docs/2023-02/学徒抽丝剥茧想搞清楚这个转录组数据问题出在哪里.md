---
title: "学徒抽丝剥茧想搞清楚这个转录组数据问题出在哪里"
date: 2023-02-23T12:18:22Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
学徒抽丝剥茧想搞清楚这个转录组数据问题出在哪里 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section powered-by="xiumi.us"><section><section><section><img data-ratio="0.91875" data-type="jpeg" data-w="640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wztsZWIld4dbSAHficyAXWgkicrhjjacU8Ey0UKM56qbSnedHStMqWUfTPQxbqxNTVZy1g59nNW3BSg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wztsZWIld4dbSAHficyAXWgkicrhjjacU8Ey0UKM56qbSnedHStMqWUfTPQxbqxNTVZy1g59nNW3BSg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></section></section><span title="" opera-tn-ra-cell="_$.pages:0.layers:0.comps:0.title1"><p><br></p></span></section><section><section powered-by="xiumi.us"><p>前些天布置了<span>学徒作业-  CNP0002454的分析，详见：</span></p><p data-tool="mdnice编辑器"><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519893&amp;idx=1&amp;sn=5bdc95aaebd59061244ce1e7548382d1&amp;scene=21#wechat_redirect" textvalue="华大基因单细胞团队的这个差异分析后的热图真奇怪" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2"><strong>华大基因单细胞团队的这个差异分析后的热图真奇怪</strong></a></p></section></section></section><section powered-by="xiumi.us"><section data-tools="新媒体排版" data-id="763890" data-style-type="undefined"><section placeholder="请输入标题"><span>下面是今年优秀实习生的分享</span></section></section></section><p data-tool="mdnice编辑器">这个<span>CNP0002454数据集来源的</span>文章：Identification of a 3-Gene Model as Prognostic Biomarker in Patients With Gastric Cancer ，大家可以自行阅读</p><p data-tool="mdnice编辑器">DOI：https://doi.org/10.3389/fonc.2022.930586</p><h1 data-tool="mdnice编辑器"><span></span>0.下载数据</h1><p data-tool="mdnice编辑器">数据在CNGBdb，https://db.cngb.org/search/project/CNP0002454/</p><p data-tool="mdnice编辑器">查了一下批量下载的教程，发现一般是用Aspera下载</p><p data-tool="mdnice编辑器">Aspera批量下载：http://www.bio-info-trainee.com/8587.html</p><p data-tool="mdnice编辑器">但是需要自己手动制作new_fq.txt文件，也就是把下载链接一条条复制粘贴进去。</p><p data-tool="mdnice编辑器"><strong>看了一下本文的样本有34个，每个样本双端测序，也就是要复制粘贴68次，还是有点繁琐了。</strong></p><p data-tool="mdnice编辑器">本来尝试了另一种傻瓜式的下载方法：</p><ul data-tool="mdnice编辑器"><li><section>下载Xftp或FileZilla</section></li><li><section>进入ftp://ftp.cngb.org，匿名登录</section></li><li><section>通过文件夹路径找到项目文件夹：/pub/CNSA/data4/CNP0002454</section></li><li><section>把整个CNP0002454文件夹拖进服务器目标路径即可</section></li></ul><p data-tool="mdnice编辑器"><strong>下载到一半连接断开了……</strong></p><p data-tool="mdnice编辑器"><strong>缺点：下载速度大概3M/s，有点慢，网容易断。</strong></p><p data-tool="mdnice编辑器">最后，我是用以下方法下载的：</p><p data-tool="mdnice编辑器">只需要知道项目编号，找到ftp路径：ftp://ftp.cngb.org/pub/CNSA/data4/CNP0002454</p><p data-tool="mdnice编辑器">然后通过wget命令递归下载，速度20M/s，很快：</p><pre data-tool="mdnice编辑器"><span></span><code>wget -r -nH -nd -P ./ ftp://ftp.cngb.org/pub/CNSA/data4/CNP0002454 --ftp-user=anonymous --ftp-password=anonymous@example.com<br><span>#</span><span> -r :递归下载</span><br><span>#</span><span> -nH：不创建主机目录</span><br><span>#</span><span> -nd：不创建目录</span><br><span>#</span><span> -P：将文件保存到目录</span><br></code></pre><p data-tool="mdnice编辑器">这样可以把所有文件都下载在一个文件夹里。</p><p data-tool="mdnice编辑器"><strong>注意：一定要加-nd参数！否则会得到一个超级无敌长的文件夹套娃！</strong></p><h1 data-tool="mdnice编辑器"><span></span>1.质控过滤</h1><p data-tool="mdnice编辑器">FastQC质控，Trim_galore过滤。</p><p data-tool="mdnice编辑器">首先用FastQC检测原始数据质量：</p><pre data-tool="mdnice编辑器"><span></span><code>fastqc -t 12 -o ./ *.gz<br><span>#</span><span> -t：线程数</span><br>multiqc ./ -n "All_Raw_fq"<br></code></pre><p data-tool="mdnice编辑器">再对原始数据进行过滤及质量再检测。</p><p data-tool="mdnice编辑器">改了一下代码，在曾老师代码的基础上增加了脚本的泛用性：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#</span><span> Trim_FastQC.sh</span><br><span>#</span><span>!/bin/bash</span><br><span>#</span><span><span>#####################</span></span><br><span>#</span><span> usage: bash Trim_FastQC.sh &lt;QCconfig&gt; &lt;Output_dir&gt; &lt;Raw_file_dir&gt;</span><br><span>#</span><span> QCconfig：遍历列表</span><br><span>#</span><span> Output_dir：输出文件路径</span><br><span>#</span><span> Raw_file_dir：原始数据文件路径</span><br><span>#</span><span><span>#####################</span></span><br>echo =================== QC Start ===================<br>echo QC method: Trim Galore + FastQC<br><span>#</span><span> 创建&lt;Output_dir&gt;输出文件夹</span><br>if [ -d "$2" ] ; then<br>    echo $2 have been existed.<br>else<br>    mkdir $2<br>    echo Make $2<br>fi<br><br>cd $2<br>source /home/miniconda3/bin/activate YAP-ChIP<br><span>#</span><span> 根据QCconfig遍历</span><br>cat $1 | while read id;<br>do<br>    arr=($id)<br>    path1=${arr[0]}<br>    path2=${arr[1]}<br>    fq1=$(basename $path1)<br>    fq2=$(basename $path2)<br>    echo ------------------ ${fq1%%.*} ------------------<br>    echo fq1: $fq1<br>    echo fq2: $fq2<br>    trim_galore --fastqc --gzip --basename ${fq1%%.*}  -O $2 --paired $3/$path1 $3/$path2<br>    # 根据文件名可以修改--basename参数<br>    if [ $? -ne 0 ] ; then <br>        echo ------------------ Failed ------------------<br>    else<br>        echo ------------------ Success ------------------<br>    fi<br>done<br><span>#</span><span> multiqc 查看多样本QC结果</span><br>multiqc ./ -n "All_clean_fq"<br>if [ $? -ne 0 ] ; then<br>    echo ----- MultiQC Failed -----<br>else<br>    echo ----- MultiQC Success -----<br>echo ==================== QC End ====================<br></code></pre><p data-tool="mdnice编辑器">使用脚本前需要做一个QCconfig文件：</p><pre data-tool="mdnice编辑器"><span></span><code>ls *.gz | grep _1.fq.gz &gt; ../fq1<br>ls *.gz | grep _2.fq.gz &gt; ../fq2<br>paste fq1 fq2 &gt; QCconfig<br><span>#</span><span> QCconfig</span><br>DP8400018285BL_L01_100_1.fq.gz DP8400018285BL_L01_100_2.fq.gz<br>DP8400018285BL_L01_101_1.fq.gz DP8400018285BL_L01_101_2.fq.gz<br>DP8400018285BL_L01_102_1.fq.gz DP8400018285BL_L01_102_2.fq.gz<br>DP8400018285BL_L01_103_1.fq.gz DP8400018285BL_L01_103_2.fq.gz<br>...<br></code></pre><p data-tool="mdnice编辑器">然后运行：</p><pre data-tool="mdnice编辑器"><span></span><code>nohup bash Trim_FastQC.sh /data2/RNA/QCconfig /data2/RNA/1.Trim+QC /data2/RNA/RawData &amp;<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>QC结果</h2><p data-tool="mdnice编辑器">原始数据：</p><p><img data-ratio="0.528125" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoBXT9qre3Eiao0d2iaJHm6J6oKSPsXAbOia5JCgP4925t89oGWvluibxcKA/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoBXT9qre3Eiao0d2iaJHm6J6oKSPsXAbOia5JCgP4925t89oGWvluibxcKA/640?wx_fmt=png"></p><p><img data-ratio="0.15780998389694043" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoD8icn80lxR85Dvic6B2iaLfibvZ3AJsvFYPmXE6ahf0SDzEPQ092cZruSA/640?wx_fmt=png" data-type="png" data-w="1242" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoD8icn80lxR85Dvic6B2iaLfibvZ3AJsvFYPmXE6ahf0SDzEPQ092cZruSA/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">原始数据质量就已经合格了，而且也没有检测到接头污染。</p><p data-tool="mdnice编辑器">过滤数据： </p><p><img data-ratio="0.53046875" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoMbRGBxRQQUdLTkDm3c0m3qKB1V55ic17upuuar8xjd0BRVqyBtJAdFw/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoMbRGBxRQQUdLTkDm3c0m3qKB1V55ic17upuuar8xjd0BRVqyBtJAdFw/640?wx_fmt=png"></p><p><img data-ratio="0.16058394160583941" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoJUqGVzYUgwztZTVNQIbJMM9dxQhQ5WiaEbPpA3K9ZmVIUwkeE85wBVw/640?wx_fmt=png" data-type="png" data-w="1233" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoJUqGVzYUgwztZTVNQIbJMM9dxQhQ5WiaEbPpA3K9ZmVIUwkeE85wBVw/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">但是发现GC含量和重复序列水平不太正常。 </p><p data-tool="mdnice编辑器">原始数据：</p><p><img data-ratio="0.52734375" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWojQn0NznEG0dBjb2ydZPMOIX6Sicfr2WdZOK6eLY6jo1oRhvfeRhHSuA/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWojQn0NznEG0dBjb2ydZPMOIX6Sicfr2WdZOK6eLY6jo1oRhvfeRhHSuA/640?wx_fmt=png"></p><p><img data-ratio="0.53359375" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoJlibxicRia9qsYRsZ3RJGkEl6MoJZ9b8enziaYEXtwiciaCTXnvlFUFA3tgw/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoJlibxicRia9qsYRsZ3RJGkEl6MoJZ9b8enziaYEXtwiciaCTXnvlFUFA3tgw/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">过滤数据：</p><p><img data-ratio="0.53125" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoLF97ctYC2tYoicWn4KzQgRQNDaMrQmnYeuauChAGJ81ADxSiaFAow4YA/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoLF97ctYC2tYoicWn4KzQgRQNDaMrQmnYeuauChAGJ81ADxSiaFAow4YA/640?wx_fmt=png"></p><p><img data-ratio="0.53828125" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWouxvG3TenAusWc6hmI9K0b47XjLSMwic8JQ4Wib82hsBic7AHicLJWlKLYw/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWouxvG3TenAusWc6hmI9K0b47XjLSMwic8JQ4Wib82hsBic7AHicLJWlKLYw/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">只有DP8400018285BL_L01_128勉强通过GC含量和重复序列水平检测。<strong>考虑到样品是胃组织，可能存在细菌污染情况。</strong></p><h1 data-tool="mdnice编辑器"><span></span>2.Hisat2比对</h1><p data-tool="mdnice编辑器">比对使用脚本：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#</span><span> hisat2.sh</span><br><span>#</span><span>!/bin/bash</span><br><span>#</span><span> usage: hisat2.sh &lt;Alignconfig&gt; &lt;Rawdata_dirpath&gt; &lt;output_dirpath&gt;</span><br><span>#</span><span> mm10=/data2/Ref/hisat2_index/mm10/grcm38.p6/GRCm38.p6.genome</span><br>hg19=/data2/Ref/hisat2_index/hg19/hg19/genome<br><br>echo ========== RNA-seq Alignment ==========<br>echo Method:Hisat2<br>if [ -d "$3" ];<br>then<br>    echo $3 have been existed.<br>else<br>    mkdir $3<br>    echo Make $3.<br>fi<br><br>cd $3<br>source /home/miniconda3/bin/activate RNA-seq<br><br>cat $1 | while read id;<br>do<br>arr=($id)<br>fq1=${arr[0]}<br>fq2=${arr[1]}<br>out=${fq1%%_1_val*}<br>echo fq1:$fq1<br>echo fq2:$fq2<br>hisat2 -x $hg19 -p 20 -1 $2/$fq1 -2 $2/$fq2 | samtools view -Sbh - &gt;  $3/${out}.bam<br>if [ $? -ne 0 ]; <br>then <br>echo ------------------ Failed ------------------<br>else<br>echo ------------------ Success ------------------<br>fi<br>done<br><br>echo ========== RNA-seq Alignment End ==========<br></code></pre><p data-tool="mdnice编辑器">运行之前先制作Alignconfig：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#</span><span> 在Trim之后的文件夹中</span><br>ls *.gz | grep _1.fq.gz &gt; ../fq1<br>ls *.gz | grep _2.fq.gz &gt; ../fq2<br>paste fq1 fq2 &gt; Alignconfig<br><span>#</span><span> Alignconfig</span><br>DP8400018285BL_L01_100_1_val_1.fq.gz DP8400018285BL_L01_100_1_val_2.fq.gz<br>DP8400018285BL_L01_101_1_val_1.fq.gz DP8400018285BL_L01_101_1_val_2.fq.gz<br>DP8400018285BL_L01_102_1_val_1.fq.gz DP8400018285BL_L01_102_1_val_2.fq.gz<br>DP8400018285BL_L01_103_1_val_1.fq.gz DP8400018285BL_L01_103_1_val_2.fq.gz<br>...<br></code></pre><p data-tool="mdnice编辑器">然后运行hisat2.sh：</p><pre data-tool="mdnice编辑器"><span></span><code>nohup bash hisat2.sh /data2/Alignconfig /data2/raw /data2/2.Hisat2 &amp; 1&gt;hisat2.log<br></code></pre><p data-tool="mdnice编辑器">检查比对率：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#</span><span> 图省事可以一行命令</span><br>cat hisat2.log | grep 'fq1\|overall alignment rate' | sed 's/fq1:\|_1_.*\|over.*//g' &gt; AlignRate.txt<br><span>#</span><span> 分两步方便查看</span><br>cat hisat2.log | grep fq1 | sed 's/fq1:\|_1_.*//g' &gt; ID<br>cat hisat2.log | grep overall| sed 's/over.*//g' &gt; Alignrate<br>paste ID Alignrate &gt; AlignRate.txt<br><span>#</span><span> 按比对率大小排序</span><br>sort -n -k 2 -r AlignRate.txt<br></code></pre><p data-tool="mdnice编辑器"><strong>可以发现大多数样本的比对率在70-80%，个别低至46%，因为前面QC看到了大量非人类物种的序列干扰，所以我们使用人类参考基因组比对那些reads肯定是会失败。（正常情况下我们的转录组数据人或者小鼠比对都是99%以上）</strong></p><p data-tool="mdnice编辑器">而GC含量勉强合格的DP8400018285BL_L01_128比对率86.42%是最高的。</p><pre data-tool="mdnice编辑器"><span></span><code><span>#</span><span> AlignRate.txt</span><br>DP8400018285BL_L01_128  86.42%<br>DP8400018285BL_L01_125  84.55%<br>DP8400018285BL_L01_117  83.53%<br>DP8400018285BL_L01_98   82.01%<br>DP8400018285BL_L01_127  81.99%<br>DP8400018285BL_L01_26   81.75%<br>DP8400018285BL_L01_91   81.29%<br>DP8400018285BL_L01_100  81.15%<br>DP8400018285BL_L01_103  80.87%<br>DP8400018285BL_L01_104  80.79%<br>DP8400018285BL_L01_99   80.77%<br>DP8400018285BL_L01_123  80.76%<br>DP8400018285BL_L01_102  80.36%<br>DP8400018285BL_L01_85   80.03%<br>DP8400018285BL_L01_25   79.94%<br>DP8400018285BL_L01_101  79.91%<br>DP8400018285BL_L01_30   79.74%<br>DP8400018285BL_L01_29   79.17%<br>DP8400018285BL_L01_96   79.06%<br>DP8400018285BL_L01_124  78.86%<br>DP8400018285BL_L01_92   78.16%<br>DP8400018285BL_L01_97   75.84%<br>DP8400018285BL_L01_94   75.72%<br>DP8400018285BL_L01_86   75.68%<br>DP8400018285BL_L01_126  75.08%<br>DP8400018285BL_L01_28   75.01%<br>DP8400018285BL_L01_87   73.48%<br>DP8400018285BL_L01_122  73.13%<br>DP8400018285BL_L01_121  72.98%<br>DP8400018285BL_L01_88   72.05%<br>DP8400018285BL_L01_93   68.29%<br>DP8400018285BL_L01_90   63.78%<br>DP8400018285BL_L01_89   57.57%<br>DP8400018285BL_L01_95   46.37%<br></code></pre><p data-tool="mdnice编辑器">要进行污染检测可以使用Blast或者FastQ Screen。</p><p data-tool="mdnice编辑器"><strong>Blast需要下载庞大的数据库文件，FastQ Screen需要下载bowtie、bowtie2或者bwa的物种索引文件。</strong></p><p data-tool="mdnice编辑器">需要的数据库文件太大了这里就不做了，放一些攻略：</p><p data-tool="mdnice编辑器">Blast:</p><ul data-tool="mdnice编辑器"><li><section>https://www.jianshu.com/p/2487cfe27e0c</section></li><li><section>https://blog.csdn.net/qq_42962326/article/details/105081327</section></li></ul><p data-tool="mdnice编辑器">FastQ Screen:</p><ul data-tool="mdnice编辑器"><li><section>https://www.jianshu.com/p/0990f478ef63</section></li></ul><h1 data-tool="mdnice编辑器"><span></span>3.featureCounts定量</h1><p data-tool="mdnice编辑器">计算比对过的文件中位于exon部分的reads数。这个部分应该可以过滤掉大部分污染，只计算能够映射到转录本的reads。</p><pre data-tool="mdnice编辑器"><span></span><code>featureCounts -T 12 -p -t exon -g gene_id \<br>        -a ../Annotation/GRCh37.p13/gencode.v19.annotation.gtf \<br>        --extraAttributes gene_name -o RNA.txt \<br>        *.bam \<br>        2&gt;featureCounts.log<br></code></pre><p data-tool="mdnice编辑器">Tip：加--extraAttributes参数把gene_name(也就是Symbol)一起输出，在后面在R中就不用转换了。（其实 -g 参数也可以指定 使用<span>gene_name(也就是Symbol) </span> ）</p><p data-tool="mdnice编辑器">运行结束后对映射结果进行质控：</p><pre data-tool="mdnice编辑器"><span></span><code>multiqc ./ -n "hisat2QC"<br></code></pre><p data-tool="mdnice编辑器">得到映射率：</p><pre data-tool="mdnice编辑器"><span></span><code>DP8400018285BL_L01_100 40.0%<br>DP8400018285BL_L01_101 34.7%<br>DP8400018285BL_L01_102 34.1%<br>DP8400018285BL_L01_103 37.3%<br>DP8400018285BL_L01_104 36.6%<br>DP8400018285BL_L01_117 39.3%<br>DP8400018285BL_L01_121 32.9%<br>DP8400018285BL_L01_122 34.2%<br>DP8400018285BL_L01_123 39.1%<br>DP8400018285BL_L01_124 35.3%<br>DP8400018285BL_L01_125 26.0%<br>DP8400018285BL_L01_126 35.1%<br>DP8400018285BL_L01_127 40.9%<br>DP8400018285BL_L01_128 36.8%<br>DP8400018285BL_L01_25  43.4%<br>DP8400018285BL_L01_26  39.0%<br>DP8400018285BL_L01_28  42.2%<br>DP8400018285BL_L01_29  44.3%<br>DP8400018285BL_L01_30  37.6%<br>DP8400018285BL_L01_85  20.7%<br>DP8400018285BL_L01_86  20.8%<br>DP8400018285BL_L01_87  23.2%<br>DP8400018285BL_L01_88  19.0%<br>DP8400018285BL_L01_89  13.1%<br>DP8400018285BL_L01_90  14.9%<br>DP8400018285BL_L01_91  37.3%<br>DP8400018285BL_L01_92  27.8%<br>DP8400018285BL_L01_93  24.1%<br>DP8400018285BL_L01_94  26.2%<br>DP8400018285BL_L01_95  18.7%<br>DP8400018285BL_L01_96  19.4%<br>DP8400018285BL_L01_97  22.4%<br>DP8400018285BL_L01_98  26.2%<br>DP8400018285BL_L01_99  41.0%<br></code></pre><p data-tool="mdnice编辑器">可以看到这个数据集不仅仅是前面的参考基因组比对率非常低，而且呢，它映射到参考基因组的基因注释区域比例也很多，正常情况下我们的转录组可以达到60%~80%的映射率。</p><p data-tool="mdnice编辑器">另外，由于做差异分析之前要生成一个group_list标记样本的处理对照组关系，在featureCounts运行结束之后把样本id改成样本类型。</p><p data-tool="mdnice编辑器">先做一个id_sample.txt对应表：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#</span><span> id_sample.txt</span><br>DP8400018285BL_L01_100.bam case1<br>DP8400018285BL_L01_101.bam control1<br>DP8400018285BL_L01_102.bam case2<br>DP8400018285BL_L01_103.bam control2<br>DP8400018285BL_L01_104.bam case3<br>DP8400018285BL_L01_117.bam control3<br>DP8400018285BL_L01_121.bam control4<br>DP8400018285BL_L01_122.bam case4<br>DP8400018285BL_L01_123.bam control5<br>DP8400018285BL_L01_124.bam case5<br>DP8400018285BL_L01_125.bam control6<br>DP8400018285BL_L01_126.bam case6<br>...<br></code></pre><p data-tool="mdnice编辑器">再写一个循环即可：</p><pre data-tool="mdnice编辑器"><span></span><code>cat id_sample.txt | while read id;<br>do <br> arr=($id)<br> id=${arr[0]}<br> sample=${arr[1]}<br><span> #</span><span> -i表示改动原文件，加后缀表示修改原文件的同时生成一个拥有该后缀的备份</span><br> sed "s/$id/$sample/g" RNA.txt -i.bak<br>done <br></code></pre><h1 data-tool="mdnice编辑器"><span></span>4.DESeq2差异分析</h1><p data-tool="mdnice编辑器">以下代码都在R中跑。 </p><p data-tool="mdnice编辑器">首先走DESeq2差异分析流程，得到差异分析结果和DESeq2的标准化表达矩阵：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(openxlsx)<br><span>library</span>(patchwork)<br><span>library</span>(stringr)<br><br><span># 去掉ensembl_id中.及之后的字符</span><br>a=read.table(<span>"../RNA.txt"</span>, header = <span>T</span>)<br>a$Geneid &lt;- str_split(a$Geneid,<span>'\\.'</span>,simplify = <span>T</span>)[,<span>1</span>]<br>exprSetB &lt;- a[,-c(<span>2</span>:<span>6</span>)]<br><br><span>if</span>(<span>F</span>){<br>  <span>library</span>(org.Hs.eg.db)<br>  colnames(exprSetB)[<span>1</span>] &lt;- <span>"ensembl_id"</span><br>  table(table(exprSetB$ensembl_id)&gt;<span>1</span>)<br>  table(exprSetB$ensembl_id)[table(exprSetB$ensembl_id)&gt;<span>1</span>] <span>#查找重复出现的基因名</span><br>  exprSetB=exprSetB[order(exprSetB$ensembl_id),] <span>#按ensemblID重新排序</span><br>  exprSetB=exprSetB[!duplicated(exprSetB$ensembl_id),] <span>#ensembl_id去重</span><br>  rownames(exprSetB) &lt;- exprSetB$ensembl_id<br>}<br><br>exprSet &lt;- exprSetB<br>rownames(exprSet) &lt;- exprSetB$ensembl_id<br>exprSet &lt;- exprSet[,-c(<span>1</span>,<span>2</span>)]<br>exprSet &lt;- exprSet[,order(colnames(exprSet))] <span># 列排序</span><br><br><span># 差异分析</span><br>suppressMessages(<span>library</span>(DESeq2)) <br>group_list &lt;- factor(c(<br>  rep(<span>'Case'</span>,<span>17</span>),<br>  rep(<span>'Control'</span>,<span>17</span>)<br>  ))<br>colData &lt;- data.frame(row.names=colnames(exprSet), <br>                       group_list=group_list<br>                       )<br>colData$group_list &lt;- relevel(colData$group_list, ref = <span>"Control"</span>)<br>dds &lt;- DESeqDataSetFromMatrix(countData = exprSet, <br>                              colData = colData,<br>                              design = ~ group_list)<br><br>                <br>dds &lt;- DESeq(dds)<br>normalized_counts&lt;-counts(dds,normalized=<span>TRUE</span>) <span>#返回标准化的值</span><br>normalized_counts &lt;- as.data.frame(normalized_counts)<br>write.xlsx(normalized_counts, file = <span>'../normalized_counts.xlsx'</span>, rowNames = <span>TRUE</span>)<br><br><span># 返回差异分析结果</span><br>res &lt;- results(dds)<br>resOrdered &lt;- res[order(res$padj),]<br>resOrdered &lt;- na.omit(as.data.frame(resOrdered))<br>write.xlsx(resOrdered,<span>"../DEG_result.xlsx"</span>, rowNames = <span>TRUE</span>)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>可视化部分</h2><h3 data-tool="mdnice编辑器"><span></span>1.PCA图<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(ggplot2)<br><span>library</span>(factoextra)<br><br><span># 准备exprSet表达矩阵</span><br>exprSet1 &lt;- t(normalized_counts)<br>exprSet1 &lt;- exprSet1[,colSums(exprSet1)!=<span>0</span>]<br><br>expr_pca &lt;- prcomp(exprSet1, center = <span>T</span>, scale. = <span>T</span>)<br>expr_pcasum &lt;- summary(expr_pca)<br><br>pic_expr_pca &lt;- fviz_pca_ind(expr_pca,<br>                             col.ind=group_list,<br>                             repel = <span>TRUE</span>, <span># 避免标签重叠</span><br>                             addEllipses = <span>T</span>, <br>                             legend.title=<span>"Groups"</span>,<br>                             ellipse.type=<span>"confidence"</span>,<br>                             <span>#ellipse.level=0.9,</span><br>                             palette = c(<span>"#8665C8"</span>, <span>"#FF8635"</span>),<br>                             title = <span>'PCA for case&amp;Control'</span><br>                             )+ <br>  theme(panel.border = element_rect(fill=<span>NA</span>,color=<span>"black"</span>, size=<span>1</span>, linetype=<span>"solid"</span>))<span>#加个边框</span><br>ggsave(pic_expr_pca,filename = <span>"../PCA.pdf"</span>,width = <span>6</span>,height = <span>4</span>)<br></code></pre><p><img data-ratio="0.6609375" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWogOyicn7dOFAvU3pwytZqWNuMicCCUoBbEcc6k4kWwNT4CFKwaXBMVW3Q/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWogOyicn7dOFAvU3pwytZqWNuMicCCUoBbEcc6k4kWwNT4CFKwaXBMVW3Q/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">看PCA的结果感觉差异不是很明显……</p><p data-tool="mdnice编辑器">PS：其实这个时候，我们应该是做三张图~</p><blockquote data-tool="mdnice编辑器"><p>我在生信技能树的教程：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247491228&amp;idx=1&amp;sn=34fed09dec0f8c27bd408ba8476d9133&amp;scene=21#wechat_redirect" data-linktype="2">《你确定你的差异基因找对了吗？》</a>提到过，必须要对你的<strong>转录水平的全局表达矩阵</strong>做好质量控制，最好是看到<strong>标准3张图</strong>：</p></blockquote><ul data-tool="mdnice编辑器"><li><section>左边的热图，说明我们实验的两个分组，normal和npc的很多基因表达量是有明显差异的</section></li><li><section>中间的PCA图，说明我们的normal和npc两个分组非常明显的差异</section></li><li><section>右边的层次聚类也是如此，说明我们的normal和npc两个分组非常明显的差异</section></li></ul><p data-tool="mdnice编辑器">如果分组在3张图里面体现不出来，<strong>实际上后续差异分析是有风险的</strong>。这个时候需要根据你自己不合格的3张图，仔细探索哪些样本是离群点，自行查询中间过程可能的问题所在，或者检查是否有其它混杂因素，都是会影响我们的差异分析结果的生物学解释。</p><p data-tool="mdnice编辑器">而这个<span>CNP0002454数据集很明显如果是使用case和control这样的分组，三张图是失败的，<strong>其实这个时候可以加入我们前面的比对率和映射率，就可以探索为什么会失败。</strong></span></p><h3 data-tool="mdnice编辑器"><span></span>2.火山图<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># plot</span><br>nrDEG=resOrdered<br>logFC_cutoff=<span>1</span><br><br>nrDEG$change = as.factor(ifelse(nrDEG$padj &lt; <span>0.05</span> &amp; abs(nrDEG$log2FoldChange) &gt; logFC_cutoff,<br>                                  ifelse(nrDEG$log2FoldChange &gt; logFC_cutoff ,<span>'UP'</span>,<span>'DOWN'</span>),<span>'NOT'</span>))<br>title_vol &lt;- paste0(<span>'\nCutoff for log2FC is '</span>,logFC_cutoff,<br>                    <span>'\nThe number of up gene is '</span>,nrow(nrDEG[nrDEG$change ==<span>'UP'</span>,]) ,<br>                    <span>'\nThe number of down gene is '</span>,nrow(nrDEG[nrDEG$change ==<span>'DOWN'</span>,]))<br><br><span># enhancedvolcano作图</span><br><span>library</span>(EnhancedVolcano)<br><span># 设置作图参数</span><br>keyvals = list()<br>keycol &lt;- <span>function</span>(x){<br>  ifelse(x !=<span>'NOT'</span>, ifelse(x ==<span>'UP'</span>, <span>'red2'</span>, <span>'royalblue'</span>),<span>'grey'</span>)<br>}<br>keyvals &lt;- lapply(nrDEG$change, keycol)<br>names(keyvals)[keyvals == <span>'red2'</span>] &lt;- <span>'UP'</span><br>names(keyvals)[keyvals ==<span>'grey'</span> ] &lt;- <span>'NOT'</span><br>names(keyvals)[keyvals == <span>'royalblue'</span>] &lt;- <span>'DOWN'</span><br><span># 火山图</span><br>volc_plot &lt;- EnhancedVolcano(nrDEG, <br>                             max.overlaps = <span>10</span>,<br>                             lab = rownames(nrDEG), <br>                             x = <span>'log2FoldChange'</span>, <br>                             y = <span>'padj'</span>, <br>                             selectLab = <span>''</span>, <span># 标记基因</span><br>                             <span>##设置题目 </span><br>                             title = <span>"Volcano"</span>,<br>                             titleLabSize = <span>20</span>,<br>                             subtitle = title_vol,<br>                             subtitleLabSize = <span>16</span>,<br>                             legendPosition = <span>'right'</span>,<br>                             caption = <span>''</span>,<br>                             <span>#captionLabSize = 14,</span><br>                             <span>##设置p值cutoff和foldchange的cutoff </span><br>                             pCutoff = <span>0.05</span>, FCcutoff = logFC_cutoff, <br>                             <span>##设置点和标签的大小 </span><br>                             pointSize = <span>2.0</span>, labSize = <span>6.0</span>,<br>                             <span>#添加Connectors </span><br>                             <span># drawConnectors = TRUE, widthConnectors = 0.5,</span><br>                             <span># 四象限颜色</span><br>                             <span># col = c('grey', 'grey', 'grey', 'red2'),</span><br>                             <span># 自定义颜色</span><br>                             colCustom = keyvals)<br>ggsave(volc_plot,filename = <span>"../volcano.pdf"</span>,width = <span>8</span>,height = <span>6</span>)<br></code></pre><p><img data-ratio="0.7093124456048738" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWofdOIBVeBLA4GRXdPaibJ4CCicLjBU03nngTx5KEyhWRaX9ibcDc0CTDPQ/640?wx_fmt=png" data-type="png" data-w="1149" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWofdOIBVeBLA4GRXdPaibJ4CCicLjBU03nngTx5KEyhWRaX9ibcDc0CTDPQ/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">分析得到差异基因共557个，其中，上调193个，下调364个。</p><h3 data-tool="mdnice编辑器"><span></span>3.表达量热图<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>## heatmap</span><br><span>library</span>(pheatmap)<br><span>#选择上下调基因</span><br>choose_gene &lt;- subset(nrDEG,nrDEG$change != <span>'NOT'</span>)<br>choose_matrix=normalized_counts[rownames(choose_gene)[order(choose_gene$change, decreasing = <span>TRUE</span>)],]<br><span># 添加注释条</span><br>Group &lt;- data.frame(Group=group_list, row.names = colnames(normalized_counts))<br>Up_Down &lt;- data.frame(Up_Down = choose_gene$change, row.names = rownames(choose_gene))<br>heat_plot &lt;- pheatmap(choose_matrix,<br>                      scale = <span>"row"</span>,<br>                      cluster_rows = <span>F</span>,<br>                      cluster_cols = <span>F</span>,<br>                      show_colnames =<span>F</span>,<br>                      show_rownames = <span>F</span>,<br>                      annotation_names_row = <span>F</span>,<br>                      annotation_names_col = <span>F</span>,<br>                      annotation_col=Group,<br>                      annotation_colors = list(Group = c(Control = <span>"#FFBE7A"</span>, Case = <span>"#BEB8DC"</span>),<br>                                               Up_Down = c(UP = <span>"#F84B0C"</span>, DOWN = <span>"#0C79B8"</span>)),<br>                      annotation_row = Up_Down,<br>                      border_color = <span>NULL</span>,<br>                      main = <span>'Pheatmap 557 DEGs'</span>,<br>                      <span>#angle_col = 315,</span><br>                      color = colorRampPalette(c(<span>"#0C79B8"</span>, <span>"#FFFCCE"</span>, <span>"#F84B0C"</span>))(<span>100</span>))<br>ggsave(filename = <span>"../heatmap.pdf"</span>, plot = heat_plot, width = <span>5</span>, height = <span>5</span>)<br></code></pre><p><img data-ratio="1.0301624129930393" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWo2tniaXhwqZnmHblLAAs9v5wItlwNrNorMicnEPRNtHqAyy4Nia65XBZfQ/640?wx_fmt=png" data-type="png" data-w="862" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWo2tniaXhwqZnmHblLAAs9v5wItlwNrNorMicnEPRNtHqAyy4Nia65XBZfQ/640?wx_fmt=png"><img data-ratio="0.9677790563866513" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWouoeNISS3nmarZTXZDmxde7SPTyZGWGB4tl7SLwdUFwZElAXSSAsTqw/640?wx_fmt=png" data-type="png" data-w="869" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWouoeNISS3nmarZTXZDmxde7SPTyZGWGB4tl7SLwdUFwZElAXSSAsTqw/640?wx_fmt=png"></p><p><span><strong>复现图（上）及原图（下）</strong></span></p><p data-tool="mdnice编辑器">虽然差异基因个数有差别，但表达量趋势是相似的。其实这个时候基本上可以判断出来 <a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519893&amp;idx=1&amp;sn=5bdc95aaebd59061244ce1e7548382d1&amp;scene=21#wechat_redirect" textvalue="华大基因单细胞团队的这个差异分析后的热图真奇怪" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2"><strong>华大基因单细胞团队的这个差异分析后的热图真奇怪</strong></a>，是因为这个转录组测序数据质量差的问题，比对率和映射率都不好，所以表达量矩阵就有问题，那么后续强行找差异后的可视化也是不对劲。</p><h3 data-tool="mdnice编辑器"><span></span>4.韦恩图<span></span></h3><p data-tool="mdnice编辑器">文章分析得到321个差异基因，可以在补充表3中获得所有差异基因列表，基于此可以作韦恩图看两个差异基因集的关系：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(openxlsx)<br><span>library</span>(ggplot2)<br><span>library</span>(ggvenn)<br><br><span># 导入DEGs表</span><br>a0 &lt;- read.xlsx(xlsxFile = <span>'../Data Sheet 2.xlsx'</span>, sheet = <span>4</span>, <br>                colNames = <span>TRUE</span>, rowNames = <span>TRUE</span>)<br>colnames(a0) &lt;- a0[<span>1</span>,]<br>a0 &lt;- a0[-<span>1</span>,]<br><br><span># 提取DEGs</span><br>a0_DEGs &lt;- rownames(a0)<br>a_DEGs &lt;- exprSetB[rownames(choose_gene),<span>"gene_name"</span>]<br><br><span># 作Venn图</span><br>Venn &lt;- ggvenn(list(DEGs_321 = a0_DEGs, DEGs_557 = a_DEGs),<br>               fill_color = c(<span>"#957BCA"</span>, <span>"#FA5D45"</span>), fill_alpha = <span>0.7</span>,<br>               stroke_color = <span>'black'</span>)<br>ggsave(<span>'../Venn.pdf'</span>, plot = Venn, width = <span>5</span>, height = <span>5</span>)<br></code></pre><p><img data-ratio="0.7723378212974297" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoVe9ESMicA410BBSNjkuLbYNibAumiafyQibOOaqCNVuAQYjwZKibyUMlxhw/640?wx_fmt=png" data-type="png" data-w="817" src="https://mmbiz.qpic.cn/mmbiz_png/nS9duFOxcfPlEwrLe0wibEBm1rcBhdaWoVe9ESMicA410BBSNjkuLbYNibAumiafyQibOOaqCNVuAQYjwZKibyUMlxhw/640?wx_fmt=png"></p><p><span><strong>原文（左，321个）及复现（右，557个）</strong></span></p><p data-tool="mdnice编辑器"><strong>交集部分相对于文章找到的差异基因集来说还是很大的。当然了，两次差异分析（我们的复现和文章自己的差异）的对比其实不仅仅是这样的韦恩图看交集。</strong></p><blockquote data-tool="mdnice编辑器"><p>初学者最喜欢怀疑自己的分析是否正确，比如差异分析的时候就容易陷入上下调基因数量的对比问题，文章可能是上下调一千附近，但是学员自己复现的时候就数量对不上。</p></blockquote><p data-tool="mdnice编辑器">其实这个问题并不在于上下调基因数量，应该是看质量，这样的对比才有意义。详见：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247518872&amp;idx=1&amp;sn=d1f9485b7af9289822e8b6613d6908d0&amp;chksm=9b4bca23ac3c4335fbb9671c98eec90add27f509e399b2e749c9c700123417cf7a9c7807ef7f&amp;scene=21#wechat_redirect" textvalue="两次差异分析结果的比较不要局限于韦恩图" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">两次差异分析结果的比较不要局限于韦恩图</a></p><h1 data-tool="mdnice编辑器"><span></span>思考</h1><ul data-tool="mdnice编辑器"><li><section>不知道污染对后续的分析有没有影响（虽然在featureCounts的时候只计算映射到exon部分的reads），可以污染检测之后用FastQ Screen或者其他软件把污染物种reads删除，再走一次转录组流程对比结果；</section></li><li><section>比文章得到的DEGs多两百多个，可以继续做GO和GSEA-KEGG分析，与文章结果对比。</section></li></ul></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ly2p0gS2wvU7V8s0zeSMHA",target="_blank" rel="noopener noreferrer">原文链接</a>
