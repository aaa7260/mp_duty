---
title: "R语言学习：purrr包map函数理解和应用"
date: 2023-01-02T08:30:51Z
draft: ["false"]
tags: [
  "fetched",
  "R语言"
]
categories: ["Acdemic"]
---
R语言学习：purrr包map函数理解和应用 by R语言
------
<div><section><mp-common-profile data-pluginname="mpprofile" data-id="MzA4NDgyMzkyMA==" data-headimg="http://mmbiz.qpic.cn/mmbiz/pMPbyicMFiacvUQqibc9APO9dT4alyEec7BfVSysNQWKR2j7XatqgsLmXqR6Jl0jCVIHVb1UvV1yCfXSs26EvAo4g/0" data-nickname="R语言" data-alias="Ryuyan360" data-signature="R语言学习与实践" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><p>我们模拟6个学生10次考试成绩。<br></p><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="properties"><code><span>scores &lt;- list(</span></code><code><span>  s1 = round(runif(10, 50, 100)),</span></code><code><span>  s2 = round(runif(10, 50, 100)),</span></code><code><span>  s3 = round(runif(10, 50, 100)),</span></code><code><span>  s4 = round(runif(10, 50, 100)),</span></code><code><span>  s5 = round(runif(10, 50, 100)),</span></code><code><span>  s6 = round(runif(10, 50, 100))</span></code><code><span>)</span></code><code><span>scores</span></code></pre></section><p>我们用列表记录这些学生的成绩。</p><p><img data-galleryid="" data-ratio="0.7896551724137931" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6MIic3aju2S0g72EbG2jsYjDM5t5AiczEwJIauuck9MIJm8FDwLuXg42A/640?wx_fmt=png" data-type="png" data-w="580" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6MIic3aju2S0g72EbG2jsYjDM5t5AiczEwJIauuck9MIJm8FDwLuXg42A/640?wx_fmt=png"></p><p><br></p><p>请问：<span>如何计算每个学生的平均分数？</span><br></p><p>方案一：base-R的写法<br></p><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>list(</span></code><code><span>  s1 = mean(scores$s1),</span></code><code><span>  s2 = mean(scores$s2),</span></code><code><span>  s3 = mean(scores$s3),</span></code><code><span>  s4 = mean(scores$s4),</span></code><code><span>  s5 = mean(scores$s5),</span></code><code><span>  s6 = mean(scores$s6)</span></code><code><span>)</span></code></pre></section><p>输出结果<br></p><p><img data-galleryid="" data-ratio="0.9393939393939394" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk670fW001hDm6iaibBaQBgI0KmqLuGuQfc7qYAXf7Z77LicWPLBE1dvluqg/640?wx_fmt=png" data-type="png" data-w="462" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk670fW001hDm6iaibBaQBgI0KmqLuGuQfc7qYAXf7Z77LicWPLBE1dvluqg/640?wx_fmt=png"></p><p>方案一，不足之处，对scores列表的每个元素重写了mean函数，若是有更多的学生计算平均分数，这种方法费时费力，不精简，还容易出错。</p><p><span>方案二：使用apply的家族函数 lapply函数</span><br></p><section><ul><li></ul><pre><code><span>lapply(scores, mean)</span></code></pre></section><p>输出结果同上。<br></p><p>这个写法很简洁，也适合列表含有多个元素的场景</p><p><span>方案三：使用函数式编程</span>，也就是把一个函数作用于列表的每个元素，成功处理完后，重组为一个新的列表。这个逻辑，我们可以使用<span>purrr包的map函数族。可以理解为它们是base-R的apply函数族的升级版本</span></p><section><ul><li><li><li><li><li><li></ul><pre data-lang="perl"><code><span>library(magrittr)</span></code><code><span>library(purrr)</span></code><code><span>map(scores, mean)</span></code><code><span># 或者</span></code><code><span># 管道操作和表示</span></code><code><span>scores %&gt;% map(mean)</span></code></pre></section><p>输出结果同上<br></p><p>为了准确地使用purrr包map函数做函数式编程和应用，我们先深入了解下这个函数的用法。<br></p><p>学习任何函数，三步曲。</p><p><span>第一步：函数输入</span></p><p><span>第二步：函数体做什么事情</span></p><p><span>第三步：函数输出</span></p><p>map函数，也不例外<br></p><p>map函数的理解，如下图所示：<br></p><p><img data-galleryid="" data-ratio="0.5756097560975609" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6MaDXZdc4cTplhavqCHY4eGWef0QrqO2oUyJEtPoOpnicVW9C3bkCBVQ/640?wx_fmt=png" data-type="png" data-w="615" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6MaDXZdc4cTplhavqCHY4eGWef0QrqO2oUyJEtPoOpnicVW9C3bkCBVQ/640?wx_fmt=png"></p><p>map函数解读<br></p><p>1）输入部分，第一个参数是列表或者向量，第二个参数是函数（R自带或者自定义的）<br></p><p>2）函数体部分，函数会作用于列表或者向量中的每个元素，进行对应的函数处理<br></p><p>3）输出部分，函数作用于每个元素都会有个输出，所有输出组合成一个新的list。</p><p><span>map函数家族</span><br></p><p>map函数家族，可以让map返回我们需要的数据格式。如下图所示：<br></p><p><img data-galleryid="" data-ratio="0.5194244604316547" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6WYZS26JB4gAzByEPbR2hjCWQYIrEnNiaNbsO232ERcSEgfrpeD0ickdQ/640?wx_fmt=png" data-type="png" data-w="695" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6WYZS26JB4gAzByEPbR2hjCWQYIrEnNiaNbsO232ERcSEgfrpeD0ickdQ/640?wx_fmt=png"></p><p>例如：<br></p><p>1）6个学生的平均分记为一个向量<br></p><section><ul><li></ul><pre data-lang="nginx"><code><span>scores %&gt;% map_dbl(mean)</span></code></pre></section><p>输出结果<br></p><p><img data-galleryid="" data-ratio="0.12585034013605442" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6ERGjYjeD5ABJTAVepsFibLHNBNIibguztX5oxRia2Yn2nAmbGZIfMOGKA/640?wx_fmt=png" data-type="png" data-w="588" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6ERGjYjeD5ABJTAVepsFibLHNBNIibguztX5oxRia2Yn2nAmbGZIfMOGKA/640?wx_fmt=png"></p><p><br></p><p>2）6个学生的平均分保存在数据框里</p><section><ul><li></ul><pre data-lang="nginx"><code><span>scores %&gt;% map_df(mean)</span></code></pre></section><p>输出结果<br></p><p><img data-galleryid="" data-ratio="0.23782771535580524" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6JyUJUruiajbIAJd6HX1mMqhlMiafBSVhlauj0TBLw1csPHibnyxgUiau7w/640?wx_fmt=png" data-type="png" data-w="534" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6JyUJUruiajbIAJd6HX1mMqhlMiafBSVhlauj0TBLw1csPHibnyxgUiau7w/640?wx_fmt=png"></p><p><br></p><p><span>map函数的使用拓展</span><br></p><p><strong>1 支持添加额外参数</strong><br></p><p>说明，这个额外参数，来自于map函数的第二个参数—函数f的参数。</p><p>例如：我们需要对6个学生的分数做降序排列</p><section><ul><li></ul><pre data-lang="perl"><code><span>scores %&gt;% map(sort, decreasing = FALSE)</span></code></pre></section><p>输出结果<br></p><p><img data-galleryid="" data-ratio="0.7504078303425775" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6MpcxZXEGLbibscceFydhPypErpfffU4AgkY4s1DUBXxmuyQIs20ib89Q/640?wx_fmt=png" data-type="png" data-w="613" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6MpcxZXEGLbibscceFydhPypErpfffU4AgkY4s1DUBXxmuyQIs20ib89Q/640?wx_fmt=png"></p><p><br></p><p><strong>2 支持自定义函数</strong></p><p>有时候，根据需求，我们需要自定义函数来对列表的每个元素做处理。<br></p><p>例如：对每个学生的成绩做标准化处理</p><section><ul><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span><span># 第一步：自定义函数</span></span></code><code><span>my_fun &lt;- <span><span>function</span><span>(x)</span></span>{</span></code><code><span>  (x - mean(x))/sd(x)</span></code><code><span>}</span></code><code><span><span># 第二步：自定义函数作用于列表的每个元素</span></span></code><code><span>std_scores &lt;- scores %&gt;% map(my_fun)</span></code><code><span>std_scores</span></code><code><span><span># 第三步：检验是否标准化成功</span></span></code><code><span>std_scores %&gt;% map(mean)</span></code><code><span>std_scores %&gt;% map(<span>var</span>)</span></code></pre></section><p><strong>3 支持匿名函数</strong></p><p>匿名函数就是没有函数名的函数<br></p><p>第一种写法<br></p><section><ul><li></ul><pre data-lang="javascript"><code><span>scores %&gt;% map(function(x) {(x-mean(x))/sd(x)})</span></code></pre></section><p>第二种写法<br></p><section><ul><li></ul><pre data-lang="cpp"><code><span>scores %&gt;% map(~ {(.x-mean(.x))/sd(.x)})</span></code></pre></section><p>第三种写法</p><section><ul><li></ul><pre data-lang="cpp"><code><span>scores %&gt;% <span>map</span>(~ {(.-mean(.))/sd(.)})</span></code></pre></section><p>三种写法，输出结果都一样，你可以根据自己的喜好选择一种写法，同时，知道其它写法效果等同就好了。<br></p><p><strong>4 与dplyr包结合使用</strong><br></p><p>dplyr包方便数据处理，purrr包的map函数家族方便做函数式编程，两者结合，可以做更多有趣的事情。<br></p><p>例如，我们想知道列表中每个元素的长度<br></p><section><ul><li><li><li><li><li><li></ul><pre data-lang="xml"><code><span>library(tidyverse)</span></code><code><span>df <span>&lt;<span>-</span> <span>tibble</span>(</span></span></code><code><span>  <span>x</span> = <span>list(1,</span> <span>2:3</span>, <span>4:6</span>)</span></code><code><span><span>) %&gt;</span>% </span></code><code><span>  mutate(l = purrr::map_int(x, length))</span></code><code><span>df</span></code></pre></section><p>输出结果<br></p><p><img data-galleryid="" data-ratio="0.30866425992779783" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6zjTuQ4QgtOgnHFibFXrBcVniac6KH3TyUAC8kEBmiaFtCMt5W1jP7YNSA/640?wx_fmt=png" data-type="png" data-w="554" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6zjTuQ4QgtOgnHFibFXrBcVniac6KH3TyUAC8kEBmiaFtCMt5W1jP7YNSA/640?wx_fmt=png"></p><p><br></p><p>例如，用于建模操作</p><section><ul><li><li><li><li><li><li></ul><pre data-lang="nginx"><code><span><span>mtcars</span> %&gt;%</span></code><code><span>  group_by(cyl) %&gt;%</span></code><code><span>  nest() %&gt;%</span></code><code><span>  mutate(model = purrr::map(data, <span>~ lm(mpg</span> <span>~ wt,</span> data = .))) %&gt;%</span></code><code><span>  mutate(result = purrr::map(model, <span>~ broom::tidy(.)))</span> %&gt;%</span></code><code><span>  unnest(result)</span></code></pre></section><p>输出结果<br></p><p><img data-galleryid="" data-ratio="0.1766256590509666" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6RypbRZq5nj9R9PmSqOiabs9QN85MnCLvGX4CyAFEicVYIVDicicAAicK2JQ/640?wx_fmt=png" data-type="png" data-w="1138" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacursAia2iahicXTRphCK6gYjk6RypbRZq5nj9R9PmSqOiabs9QN85MnCLvGX4CyAFEicVYIVDicicAAicK2JQ/640?wx_fmt=png"></p><p><br></p><p><span>总结</span><br></p><p>purrr包map函数家族，可以实现函数式编程，apply函数家族的升级版本，通过简介代码，实现迭代操作，提升工作效率。<br></p><p><strong>进一步阅读</strong><br></p><p>可以阅读《R数据科学》书籍的第三部分：编程<br></p><p><span>需要R数据科学书籍</span>的朋友，可以加我微信，备注：<span>R数据科学书籍</span><br></p><p>需要<span>加入R语言群</span>的朋友，可以加我微信，备注：<span>R群</span><br></p><p>我的微信<strong>luqin360</strong>。</p><p><img data-galleryid="" data-ratio="1.0117096018735363" data-s="300,640" data-type="png" data-w="427" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacvbB8IDOtGuRAWrlvv7O30vwqDtkQD7lSvqPWbVYXzobmd0G0EqO8v3LfP5YSwsB3AvaAtSLZsVvw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacvbB8IDOtGuRAWrlvv7O30vwqDtkQD7lSvqPWbVYXzobmd0G0EqO8v3LfP5YSwsB3AvaAtSLZsVvw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p><span>公众号：R语言</span></p><p><span>作者：王路情<br></span></p><p><br></p><p><span><strong>R语言学习者。</strong></span></p><p><span><strong>R语言深度使用者。</strong></span></p><p><span><strong>我用R语言做数据科学和医学科研。</strong></span></p><p><span><strong>我提供R语言付费服务。</strong></span></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/lU17XzlakQSRl5fpoeJRyg",target="_blank" rel="noopener noreferrer">原文链接</a>
