---
title: "ggplot2的热图玩法"
date: 2023-01-06T03:23:58Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
ggplot2的热图玩法 by 生信星球
------
<div><p><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第858天</strong></span></span><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></p><hr><p><span><span>   </span><span>大神一句话，菜鸟跑半年。我不是大神，但我可以缩短你走弯路的半年~</span></span></p><p><span>   就像歌儿唱的那样，如果你不知道该往哪儿走，就留在这学点生信好不好~</span></p><p><span>   这里有豆豆和花花的学习历程，从新手到进阶，生信路上有你有我!</span><span></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h4 data-tool="mdnice编辑器"><span>背景</span></h4><p data-tool="mdnice编辑器">画热图的体系用的比较多的是pheatmap和ComplexHeatmap这两个包，前者胜在代码简单，功能强大，而后者胜在细节无穷无尽，只有你想不到，没有它做不到。ggplot2在画热图这件事上，是存在感不太强的。但有时候还必须得用它来画，以期和其他ggplot2的图严丝合缝的拼在一起。</p><p data-tool="mdnice编辑器">因此我收集了一下ggplot2的成果，发现又解锁了y叔的一个新包aplot，以及前段时间刚出的ggheatmap（居然是大三的学生写的，后生可畏）。我写了三种方法，ggheatmap最为简单，可以直接去看方法3。</p><h4 data-tool="mdnice编辑器"><span>画图数据</span></h4><p data-tool="mdnice编辑器">热图的输入数据嘛，是一个数值型矩阵：</p><pre data-tool="mdnice编辑器"><span></span><code><span>test</span> = matrix(rnorm(200), 20, 10)<br><span>test</span>[1:10, seq(1, 10, 2)] = <span>test</span>[1:10, seq(1, 10, 2)] + 3<br><span>test</span>[11:20, seq(2, 10, 2)] = <span>test</span>[11:20, seq(2, 10, 2)] + 2<br><span>test</span>[15:20, seq(2, 10, 2)] = <span>test</span>[15:20, seq(2, 10, 2)] + 4<br>colnames(<span>test</span>) = paste(<span>"Test"</span>, 1:10, sep = <span>""</span>)<br>rownames(<span>test</span>) = paste(<span>"Gene"</span>, 1:20, sep = <span>""</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span>方法1 ggh4x</span></h4><p data-tool="mdnice编辑器">给ggplot2加聚类树的R包ggh4x，里面的scale_y_dendrogram函数。</p><pre data-tool="mdnice编辑器"><span></span><code>library(ggh4x)<br>library(ggplot2)<br>library(tidyverse)<br><br>yclust &lt;- hclust(dist(<span>test</span>))<br>xclust &lt;- hclust(dist(t(<span>test</span>)))<br>p = <span>test</span> %&gt;% <br>  as.data.frame() %&gt;% <br>  rownames_to_column() %&gt;% <br>  pivot_longer(cols = 2:ncol(.),<br>               names_to = <span>"sample"</span>,<br>               values_to = <span>"exp"</span>) %&gt;% <br>  ggplot(aes(x = sample,y = rowname))+<br>  geom_tile(aes(fill = exp))+<br>  scale_fill_gradient2(midpoint = 2.5,  <br>                       low = <span>'#2fa1dd'</span>,<br>                       mid=<span>"white"</span>,<br>                       high = <span>'#f87669'</span>) +<br>  scale_y_dendrogram(hclust = yclust) +<br>  scale_x_dendrogram(hclust = xclust,position = <span>'top'</span>) +<br>  theme(panel.grid = element_blank(), panel.background = element_rect(fill = NA), <br>            legend.background = element_rect(fill = NA), plot.background = element_rect(fill = NA), <br>            axis.line = element_blank(), axis.ticks = element_blank(), <br>            axis.title = element_blank()) <br><br>p<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrVdFOlsGTeRsE6lvyh2SUXxxW9HhN4WtBc9VlNXpia6SiaSHBRtJCzmIia2eghTHFibkAsT6uJsdWqjQ/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrVdFOlsGTeRsE6lvyh2SUXxxW9HhN4WtBc9VlNXpia6SiaSHBRtJCzmIia2eghTHFibkAsT6uJsdWqjQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">图还是有模有样的，只是行名列名贴着聚类树，不如pheatmap画的好看。所以我尝试了一下把基因名放到右边，失败辽。但是又找到了另外一个做法：</p><h4 data-tool="mdnice编辑器"><span>方法2 ggtree</span></h4><p data-tool="mdnice编辑器">还是神奇Y叔的包，树状图可视化用的ggtree，配合拼图用的aplot，简直不要太方便。</p><pre data-tool="mdnice编辑器"><span></span><code>p1 = <span>test</span> %&gt;% <br>  as.data.frame() %&gt;% <br>  rownames_to_column() %&gt;% <br>  pivot_longer(cols = 2:ncol(.),<br>               names_to = <span>"sample"</span>,<br>               values_to = <span>"exp"</span>) %&gt;% <br>  ggplot(aes(x = sample,y = rowname))+<br>  geom_tile(aes(fill = exp))+<br>  scale_fill_gradient2(midpoint = 2.5,  <br>                       low = <span>'#2fa1dd'</span>,<br>                       mid=<span>"white"</span>,<br>                       high = <span>'#f87669'</span>) +<br>  scale_y_discrete(position = <span>"right"</span>)+<br>  theme(panel.grid = element_blank(), panel.background = element_rect(fill = NA), <br>            legend.background = element_rect(fill = NA), plot.background = element_rect(fill = NA), <br>            axis.line = element_blank(), axis.ticks = element_blank(), <br>            axis.title = element_blank()) <br><br>library(ggtree)<br>p2&lt;-ggtree(yclust)<br>p2+<br>  geom_tiplab()+<br>  xlim(NA,10)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrVdFOlsGTeRsE6lvyh2SUXuoicKkS3P4bUO6bnfKd1hyn8ckurTficlxaAGRzhRCAlDmrLMtuwLEqQ/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrVdFOlsGTeRsE6lvyh2SUXuoicKkS3P4bUO6bnfKd1hyn8ckurTficlxaAGRzhRCAlDmrLMtuwLEqQ/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>p3&lt;-ggtree(xclust)+layout_dendrogram()<br>p3+<br>  geom_tiplab()+<br>  xlim(NA,12)<br><br>library(aplot)<br>p1%&gt;%<br>  insert_left(p2,width = 0.2) %&gt;% <br>  insert_top(p3,height = 0.2)<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrVdFOlsGTeRsE6lvyh2SUX69WZ9StIiaIiaR7d1WzeRfVo3nwEO3B8AsZfXo1pWcme7sw2OVJRPtRQ/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrVdFOlsGTeRsE6lvyh2SUX69WZ9StIiaIiaR7d1WzeRfVo3nwEO3B8AsZfXo1pWcme7sw2OVJRPtRQ/640?wx_fmt=png">本来以为拼图需要把主体热图的行列顺序调整一下才能拼，结果神奇的aplot能实现无缝连接，顺序调整犹如merge函数一样，自动搞定了嘿~ </p><p data-tool="mdnice编辑器">看到ggheatmap也用到了aplot包，应该是同一种方法咯。写成新的函数无比方便</p><h4 data-tool="mdnice编辑器"><span>方法3 ggheatmap</span></h4><p data-tool="mdnice编辑器">试了一下行列聚类和加注释条的操作，还是很丝滑的。只是annotation_color没有默认颜色，我jio的作者可以在下一版里设置上默认值。</p><pre data-tool="mdnice编辑器"><span></span><code>library(<span>"ggheatmap"</span>)<br>ggheatmap(<span>test</span>,cluster_rows = T,cluster_cols = T,<br>          color = colorRampPalette(c(<span>"#2fa1dd"</span>, <span>"white"</span>, <span>"#f87669"</span>))(100))<br><br>annotation_col = data.frame(<br>  CellType = factor(rep(c(<span>"CT1"</span>, <span>"CT2"</span>), 5))<br>)<br>rownames(annotation_col) = paste(<span>"Test"</span>, 1:10, sep = <span>""</span>)<br><br>col &lt;- list(CellType=c(CT1 = <span>"#2fa1dd"</span>,CT2 = <span>"#f87669"</span>))<br><br>ggheatmap(<span>test</span>,cluster_rows = T,cluster_cols = T,<br>          color = colorRampPalette(c(<span>"#2fa1dd"</span>, <span>"white"</span>, <span>"#f87669"</span>))(100),<br>          annotation_cols = annotation_col,<br>          annotation_color = col,<br>          scale = <span>"row"</span>)<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrVdFOlsGTeRsE6lvyh2SUX8SAHahfv8Ak7icwTjaQdAfw8Gyw6HSwffzNLT1Vg5wC66NoUuyoicRLA/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrVdFOlsGTeRsE6lvyh2SUX8SAHahfv8Ak7icwTjaQdAfw8Gyw6HSwffzNLT1Vg5wC66NoUuyoicRLA/640?wx_fmt=png">这个配色我太喜欢了，恨不得走到哪都带着。</p></section><section><blockquote><section><span>如果因为代码看不懂，而跟不上正文的节奏，可以来找我，系统学习。</span><span>以下课程都是循环开课。</span><span>下一期的时间，点进去咨询微信咯</span><br></section><section><span></span></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247490554&amp;idx=2&amp;sn=12c1ad970911a283f71f559268282ff1&amp;chksm=fdf853b8ca8fdaae8b5432c82655492c882267f9a9c2bab2022eb2ed1d3d976c8eaa9fa93110&amp;scene=21#wechat_redirect" textvalue="生信零基础入门学习小组" data-itemshowtype="0" tab="innerlink" data-linktype="2"><strong>生信零基础入门学习小组</strong></a></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247491247&amp;idx=2&amp;sn=b91fd720b3bf58c767dbc18dc7704819&amp;chksm=fdf856edca8fdffb8c69d323e63800dbdabbebf16485f3dd7fe28f88d71a527f8e1002532023&amp;scene=21#wechat_redirect" textvalue="生信入门班（四周线上直播课）" data-itemshowtype="11" tab="innerlink" data-linktype="2"><strong>生信入门班（四周线上直播课）</strong></a></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247491247&amp;idx=1&amp;sn=c68c17adda0090809945b931d532d7f4&amp;chksm=fdf856edca8fdffb14a4bbaba9e1b874df8b997e87f2bc6356b02829a4e5febc9ae9d0c24a59&amp;scene=21#wechat_redirect" textvalue="数据挖掘班（医生/医学生首选）" data-itemshowtype="11" tab="innerlink" data-linktype="2"><strong>数据挖掘班（医生/医学生首选）</strong></a></section></blockquote></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ihdDP689Y1_5FeT5-Buxpw",target="_blank" rel="noopener noreferrer">原文链接</a>
