---
title: "本实验室运行SCENIC分析的代码"
date: 2023-01-30T03:21:00Z
draft: ["false"]
tags: [
  "fetched",
  "东林的扯淡小屋"
]
categories: ["Acdemic"]
---
本实验室运行SCENIC分析的代码 by 东林的扯淡小屋
------
<div><p>安装软件：<br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span><span>if</span> (!requireNamespace(<span>"BiocManager"</span>, quietly = <span>TRUE</span>))</span></code><code><span>  install.packages(<span>"BiocManager"</span>)</span></code><code><span>BiocManager::install(<span>"clusterProfiler"</span>)</span></code><code><span>BiocManager::install(c(<span>"GenomicFeatures"</span>, <span>"AnnotationDbi"</span>))</span></code><code><span>BiocManager::install(<span>"enrichplot"</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>if</span> (!requireNamespace(<span>"BiocManager"</span>, quietly = <span>TRUE</span>)) install.packages(<span>"BiocManager"</span>)</span></code><code><span>BiocManager::version()</span></code><code><span><span># If your bioconductor version is previous to 3.9, see the section bellow</span></span></code><code><span><br></span></code><code><span><span>## Required</span></span></code><code><span>BiocManager::install(c(<span>"AUCell"</span>, <span>"RcisTarget"</span>))</span></code><code><span>BiocManager::install(c(<span>"RcisTarget"</span>)) <span># Optional. Can be replaced by GRNBoost</span></span></code><code><span>BiocManager::install(c(<span>"GENIE3"</span>)) <span># Optional. Can be replaced by GRNBoost</span></span></code><code><span><br></span></code><code><span><span>## Optional (but highly recommended):</span></span></code><code><span><span># To score the network on cells (i.e. run AUCell):</span></span></code><code><span>BiocManager::install(c(<span>"zoo"</span>, <span>"mixtools"</span>, <span>"rbokeh"</span>))</span></code><code><span><span># For various visualizations and perform t-SNEs:</span></span></code><code><span>BiocManager::install(c(<span>"DT"</span>, <span>"NMF"</span>, <span>"pheatmap"</span>, <span>"R2HTML"</span>, <span>"Rtsne"</span>))</span></code><code><span><span># To support paralell execution (not available in Windows):</span></span></code><code><span>BiocManager::install(c(<span>"doMC"</span>, <span>"doRNG"</span>))</span></code><code><span><span># To export/visualize in http://scope.aertslab.org</span></span></code><code><span><span>if</span> (!requireNamespace(<span>"devtools"</span>, quietly = <span>TRUE</span>)) install.packages(<span>"devtools"</span>)</span></code><code><span>devtools::install_github(<span>"aertslab/SCopeLoomR"</span>, build_vignettes = <span>TRUE</span>)</span></code><code><span><br></span></code><code><span>packageVersion(<span>"AUCell"</span>)</span></code><code><span>packageVersion(<span>"RcisTarget"</span>)</span></code><code><span>packageVersion(<span>"GENIE3"</span>)</span></code><code><span><br></span></code><code><span><span>if</span> (!requireNamespace(<span>"devtools"</span>, quietly = <span>TRUE</span>)) install.packages(<span>"devtools"</span>)</span></code><code><span>devtools::install_github(<span>"aertslab/SCENIC"</span>) </span></code><code><span>packageVersion(<span>"SCENIC"</span>)</span></code><code><span><br></span></code><code><span><span>#其他下载方法</span></span></code><code><span>install.packages(<span>"usethis"</span>)</span></code><code><span>install.packages(<span>"curl"</span>)</span></code><code><span>install.packages(<span>"credentials"</span>)</span></code><code><span>install.packages(<span>"httr"</span>)</span></code><code><span>install.packages(<span>"gert"</span>)</span></code><code><span>install.packages(<span>"gh"</span>)</span></code><code><span><br></span></code><code><span><span>#其他下载方法</span></span></code><code><span><span>require</span>(remotes)</span></code><code><span>install_version(<span>"rbokeh"</span>, version = <span>"0.5.1"</span>, repos = <span>"http://cran.us.r-project.org"</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span>install.packages(<span>'devtools'</span>)</span></code><code><span>library(<span>'devtools'</span>)</span></code><code><span><span># Enter commands in R (or R studio, if installed)</span></span></code><code><span><span>#install.packages('Seurat')</span></span></code><code><span>library(Seurat)</span></code></pre></section><p>具体scenic代码：<br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="ruby"><code><span><span>#人类</span></span></code><code><span><span>#load in the motifannotation this will load it into your environment but as the name in which is given to the list argument</span></span></code><code><span>data(list=<span>"motifAnnotations_hgnc_v9"</span>, package=<span>"RcisTarget"</span>)</span></code><code><span><br></span></code><code><span><span>#rename the motif annnotion by attributing it to the variable that is in the error</span></span></code><code><span>motifAnnotations_hgnc &lt;- motifAnnotations_hgnc_v9</span></code><code><span><br></span></code><code><span>set.seed(<span>123</span>)</span></code><code><span>library(Seurat)</span></code><code><span>library(tidyverse)</span></code><code><span>library(patchwork)</span></code><code><span>library(SCENIC)</span></code><code><span><span>##==分析准备==##</span></span></code><code><span>dir.create(<span>"SCENIC"</span>)</span></code><code><span>dir.create(<span>"SCENIC/int"</span>)</span></code><code><span><span>#scRNA &lt;-sce.all</span></span></code><code><span>scRNA &lt;-readRDS(<span>"allsample_processed.rds"</span>)</span></code><code><span><span>#rm(YDL)</span></span></code><code><span>setwd(<span>"./SCENIC"</span>) </span></code><code><span><span>##准备细胞meta信息</span></span></code><code><span>cellInfo &lt;- data.frame(scRNA@meta.data)</span></code><code><span>colnames(cellInfo)[which(colnames(cellInfo)==<span>"orig.ident"</span>)] &lt;- <span>"sample"</span></span></code><code><span>colnames(cellInfo)[which(colnames(cellInfo)==<span>"seurat_clusters"</span>)] &lt;- <span>"cluster"</span></span></code><code><span><span>#colnames(cellInfo)[which(colnames(cellInfo)=="celltype_Monaco")] &lt;- "celltype"</span></span></code><code><span>cellInfo &lt;- cellInfo[,c(<span>"sample"</span>,<span>"cluster"</span>)]</span></code><code><span>saveRDS(cellInfo, file=<span>"int/cellInfo.Rds"</span>)</span></code><code><span><span>#为了节省计算资源，随机抽取1000个细胞的数据子集</span></span></code><code><span>subcell &lt;- sample(colnames(scRNA),<span>1000</span>)</span></code><code><span>scRNAsub &lt;- scRNA[,subcell]</span></code><code><span>saveRDS(scRNAsub, <span>"scRNAsub.rds"</span>)</span></code><code><span>exprMat &lt;- as.matrix(scRNAsub@assays$RNA@counts)</span></code><code><span><span># dim(exprMat)</span></span></code><code><span><span># [1] 32285  1000</span></span></code><code><span><span>#head(cellInfo)</span></span></code><code><span><span>##设置分析环境</span></span></code><code><span>mydbDIR &lt;- <span>"/data/yudonglin/reference/scenic/"</span></span></code><code><span>mydbs &lt;- c(<span>"hg19-500bp-upstream-7species.mc9nr.feather"</span>,</span></code><code><span>           <span>"hg19-tss-centered-10kb-7species.mc9nr.feather"</span>)</span></code><code><span>names(mydbs) &lt;- c(<span>"500bp"</span>, <span>"10kb"</span>)</span></code><code><span>scenicOptions &lt;- initializeScenic(org=<span>"hgnc"</span>, </span></code><code><span>                                  nCores=<span>60</span>,</span></code><code><span>                                  dbDir=mydbDIR, </span></code><code><span>                                  dbs = mydbs,</span></code><code><span>                                  datasetTitle = <span>"SCENIC"</span>)</span></code><code><span>saveRDS(scenicOptions, <span>"int/scenicOptions.rds"</span>)</span></code><code><span>genesKept &lt;- geneFiltering(exprMat, scenicOptions, </span></code><code><span>                           minCountsPerGene = <span>3</span> * <span>0</span>.<span>01</span> * ncol(exprMat), </span></code><code><span>                           minSamples = ncol(exprMat) * <span>0</span>.<span>01</span>)</span></code><code><span>exprMat_filtered &lt;- exprMat[genesKept, ]</span></code><code><span><span>##计算相关性矩阵</span></span></code><code><span>runCorrelation(exprMat_filtered, scenicOptions)</span></code><code><span><span>##TF-Targets相关性回归分析</span></span></code><code><span>exprMat_filtered_log &lt;- log2(exprMat_filtered+<span>1</span>)</span></code><code><span>runGenie3(exprMat_filtered_log, scenicOptions, nParts = <span>20</span>)</span></code><code><span><span>#这一步消耗的计算资源非常大，个人电脑需要几个小时的运行时间</span></span></code><code><span><span>##推断共表达模块</span></span></code><code><span>runSCENIC_1_coexNetwork2modules(scenicOptions)</span></code><code><span><span># scenicOptions &lt;- initializeScenic(org="hgnc", </span></span></code><code><span><span>#                                   nCores=9,</span></span></code><code><span><span>#                                   dbDir=mydbDIR, </span></span></code><code><span><span>#                                   dbs = mydbs,</span></span></code><code><span><span>#                                   datasetTitle = "erythrogenesis")</span></span></code><code><span><span>##推断转录调控网络（regulon）</span></span></code><code><span>runSCENIC_2_createRegulons(scenicOptions)</span></code><code><span><span>#以上代码可增加参数coexMethod=c("w001", "w005", "top50", "top5perTarget", "top10perTarget", "top50perTarget"))</span></span></code><code><span><span>#默认6种方法的共表达网络都计算，可以少选几种方法以减少计算量</span></span></code><code><span>scenicOptions &lt;- initializeScenic(org=<span>"hgnc"</span>, </span></code><code><span>                                  nCores=<span>1</span>,</span></code><code><span>                                  dbDir=mydbDIR, </span></code><code><span>                                  dbs = mydbs,</span></code><code><span>                                  datasetTitle = <span>"erythrogenesis"</span>)</span></code><code><span><span>##==regulon活性评分与可视化==##</span></span></code><code><span><span>##regulons计算AUC值并进行下游分析</span></span></code><code><span>exprMat_all &lt;- as.matrix(scRNA@assays$RNA@counts)</span></code><code><span>exprMat_all &lt;- log2(exprMat_all+<span>1</span>)</span></code><code><span>saveRDS(exprMat_all,<span>"exprMat_all.rds"</span>)</span></code><code><span><span># rm(list=ls())</span></span></code><code><span><span># scenicOptions&lt;-readRDS("scenicOptions.rds")</span></span></code><code><span><span># exprMat_all&lt;-readRDS("exprMat_all.rds")</span></span></code><code><span>runSCENIC_3_scoreCells(scenicOptions, exprMat=exprMat_all)</span></code><code><span><br></span></code><code><span><span>#runSCENIC_3_scoreCells(scenicOptions, exprMat=log2(as.matrix(scRNA<span>@assays</span>$RNA<span>@counts</span>)+1))</span></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><span># #使用shiny互动调整阈值</span></span></code><code><span><span># aucellApp &lt;- plotTsne_AUCellApp(scenicOptions, exprMat_all)</span></span></code><code><span><span># savedSelections &lt;- shiny::runApp(aucellApp)</span></span></code><code><span><span># #保存调整后的阈值</span></span></code><code><span><span># newThresholds &lt;- savedSelections$thresholds</span></span></code><code><span><span># scenicOptions<span>@fileNames</span>$int["aucell_thresholds",1] &lt;- "int/newThresholds.Rds"</span></span></code><code><span><span># saveRDS(newThresholds, file=getIntName(scenicOptions, "aucell_thresholds"))</span></span></code><code><span><span># saveRDS(scenicOptions, file="int/scenicOptions.Rds")</span></span></code><code><span>runSCENIC_4_aucell_binarize(scenicOptions, exprMat=exprMat_all)</span></code><code><span>savehistory(<span>"scenic_code.txt"</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#小鼠</span></span></code><code><span><br></span></code><code><span>set.seed(<span>123</span>)</span></code><code><span>library(Seurat)</span></code><code><span>library(tidyverse)</span></code><code><span>library(patchwork)</span></code><code><span>library(SCENIC)</span></code><code><span><span>##==分析准备==##</span></span></code><code><span>dir.create(<span>"SCENIC"</span>)</span></code><code><span>dir.create(<span>"SCENIC/int"</span>)</span></code><code><span><span>#scRNA &lt;-sce.all</span></span></code><code><span>scRNA &lt;-readRDS(<span>"allsample_processed.rds"</span>)</span></code><code><span><span>#rm(YDL)</span></span></code><code><span>setwd(<span>"./SCENIC"</span>) </span></code><code><span><span>##准备细胞meta信息</span></span></code><code><span>cellInfo &lt;- data.frame(scRNA@meta.data)</span></code><code><span>colnames(cellInfo)[which(colnames(cellInfo)==<span>"orig.ident"</span>)] &lt;- <span>"sample"</span></span></code><code><span>colnames(cellInfo)[which(colnames(cellInfo)==<span>"seurat_clusters"</span>)] &lt;- <span>"cluster"</span></span></code><code><span><span>#colnames(cellInfo)[which(colnames(cellInfo)=="celltype_Monaco")] &lt;- "celltype"</span></span></code><code><span>cellInfo &lt;- cellInfo[,c(<span>"sample"</span>,<span>"cluster"</span>)]</span></code><code><span>saveRDS(cellInfo, file=<span>"int/cellInfo.Rds"</span>)</span></code><code><span><span>#为了节省计算资源，随机抽取1000个细胞的数据子集</span></span></code><code><span>subcell &lt;- sample(colnames(scRNA),<span>1000</span>)</span></code><code><span>scRNAsub &lt;- scRNA[,subcell]</span></code><code><span>saveRDS(scRNAsub, <span>"scRNAsub.rds"</span>)</span></code><code><span>exprMat &lt;- as.matrix(scRNAsub@assays$RNA@counts)</span></code><code><span><span># dim(exprMat)</span></span></code><code><span><span># [1] 32285  1000</span></span></code><code><span><span>#head(cellInfo)</span></span></code><code><span><span>##设置分析环境</span></span></code><code><span><br></span></code><code><span><span>#load in the motifannotation this will load it into your environment but as the name in which is given to the list argument</span></span></code><code><span>data(list=<span>"motifAnnotations_mgi_v9"</span>, package=<span>"RcisTarget"</span>)</span></code><code><span><br></span></code><code><span><span>#rename the motif annnotion by attributing it to the variable that is in the error</span></span></code><code><span>motifAnnotations_mgi &lt;- motifAnnotations_mgi_v9</span></code><code><span><br></span></code><code><span>mydbDIR &lt;- <span>"/data/yudonglin/reference/scenic/"</span></span></code><code><span>mydbs &lt;- c(<span>"mm9-500bp-upstream-7species.mc9nr.feather"</span>,</span></code><code><span>           <span>"mm9-tss-centered-10kb-7species.mc9nr.feather"</span>)</span></code><code><span>names(mydbs) &lt;- c(<span>"500bp"</span>, <span>"10kb"</span>)</span></code><code><span>scenicOptions &lt;- initializeScenic(org=<span>"mgi"</span>, </span></code><code><span>                                  nCores=<span>60</span>,</span></code><code><span>                                  dbDir=mydbDIR, </span></code><code><span>                                  dbs = mydbs,</span></code><code><span>                                  datasetTitle = <span>"SCENIC"</span>)</span></code><code><span>saveRDS(scenicOptions, <span>"int/scenicOptions.rds"</span>)</span></code><code><span>genesKept &lt;- geneFiltering(exprMat, scenicOptions, </span></code><code><span>                           minCountsPerGene = <span>3</span> * <span>0</span>.<span>01</span> * ncol(exprMat), </span></code><code><span>                           minSamples = ncol(exprMat) * <span>0</span>.<span>01</span>)</span></code><code><span>exprMat_filtered &lt;- exprMat[genesKept, ]</span></code><code><span><span>##计算相关性矩阵</span></span></code><code><span>runCorrelation(exprMat_filtered, scenicOptions)</span></code><code><span><span>##TF-Targets相关性回归分析</span></span></code><code><span>exprMat_filtered_log &lt;- log2(exprMat_filtered+<span>1</span>)</span></code><code><span>runGenie3(exprMat_filtered_log, scenicOptions, nParts = <span>20</span>)</span></code><code><span><span>#这一步消耗的计算资源非常大，个人电脑需要几个小时的运行时间</span></span></code><code><span><span>##推断共表达模块</span></span></code><code><span>runSCENIC_1_coexNetwork2modules(scenicOptions)</span></code><code><span><span>#推断转录调控网络（regulon）</span></span></code><code><span>runSCENIC_2_createRegulons(scenicOptions)</span></code><code><span><span>#以上代码可增加参数coexMethod=c("w001", "w005", "top50", "top5perTarget", "top10perTarget", "top50perTarget"))</span></span></code><code><span><span>#默认6种方法的共表达网络都计算，可以少选几种方法以减少计算量</span></span></code><code><span>scenicOptions &lt;- initializeScenic(org=<span>"mgi"</span>, </span></code><code><span>                                  nCores=<span>1</span>,</span></code><code><span>                                  dbDir=mydbDIR, </span></code><code><span>                                  dbs = mydbs,</span></code><code><span>                                  datasetTitle = <span>"SCENIC"</span>)</span></code><code><span><span>##==regulon活性评分与可视化==##</span></span></code><code><span><span>##regulons计算AUC值并进行下游分析</span></span></code><code><span>exprMat_all &lt;- as.matrix(scRNA@assays$RNA@counts)</span></code><code><span>exprMat_all &lt;- log2(exprMat_all+<span>1</span>)</span></code><code><span>saveRDS(exprMat_all,<span>"exprMat_all.rds"</span>)</span></code><code><span><span># rm(list=ls())</span></span></code><code><span><span># scenicOptions&lt;-readRDS("scenicOptions.rds")</span></span></code><code><span><span># exprMat_all&lt;-readRDS("exprMat_all.rds")</span></span></code><code><span>runSCENIC_3_scoreCells(scenicOptions, exprMat=exprMat_all)</span></code><code><span><br></span></code><code><span><span>#runSCENIC_3_scoreCells(scenicOptions, exprMat=log2(as.matrix(scRNA<span>@assays</span>$RNA<span>@counts</span>)+1))</span></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><span># #使用shiny互动调整阈值</span></span></code><code><span><span># aucellApp &lt;- plotTsne_AUCellApp(scenicOptions, exprMat_all)</span></span></code><code><span><span># savedSelections &lt;- shiny::runApp(aucellApp)</span></span></code><code><span><span># #保存调整后的阈值</span></span></code><code><span><span># newThresholds &lt;- savedSelections$thresholds</span></span></code><code><span><span># scenicOptions<span>@fileNames</span>$int["aucell_thresholds",1] &lt;- "int/newThresholds.Rds"</span></span></code><code><span><span># saveRDS(newThresholds, file=getIntName(scenicOptions, "aucell_thresholds"))</span></span></code><code><span><span># saveRDS(scenicOptions, file="int/scenicOptions.Rds")</span></span></code><code><span>runSCENIC_4_aucell_binarize(scenicOptions, exprMat=exprMat_all)</span></code><code><span>savehistory(<span>"scenic_code.txt"</span>)</span></code><code><span><br></span></code></pre></section><p><img data-galleryid="" data-ratio="0.7854113655640373" data-s="300,640" data-type="png" data-w="1179" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBrlGfn0c5XVUOE1ce5eaiaiaSQB9K8aNK2seDnBibTQ2iaCrMCAA317ibMVjhyovrV8fLc2Vf1XWURYZ7g/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBrlGfn0c5XVUOE1ce5eaiaiaSQB9K8aNK2seDnBibTQ2iaCrMCAA317ibMVjhyovrV8fLc2Vf1XWURYZ7g/640?wx_fmt=png"></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/rwFUTdZaGlwDycXjDhDwhA",target="_blank" rel="noopener noreferrer">原文链接</a>
