---
title: "跟着Nature Communications学数据分析：R语言做随机森林模型并对变量重要性排序"
date: 2022-12-23T09:31:47Z
draft: ["false"]
tags: [
  "fetched",
  "小明的数据分析笔记本"
]
categories: ["Acdemic"]
---
跟着Nature Communications学数据分析：R语言做随机森林模型并对变量重要性排序 by 小明的数据分析笔记本
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-mpa-powered-by="yiban.io"><h2 data-tool="mdnice编辑器"><span></span><span>论文</span><span> </span></h2><blockquote data-tool="mdnice编辑器"><p>Drivers and trends of global soil microbial carbon over two decades</p></blockquote><p data-tool="mdnice编辑器">https://www.nature.com/articles/s41467-022-31833-z#data-availability</p><p data-tool="mdnice编辑器">这个里面有很多地图的图</p><p data-tool="mdnice编辑器">数据和代码</p><p data-tool="mdnice编辑器">https://github.com/gpatoine/drivers_trends_microbial_carbon</p><p data-tool="mdnice编辑器">这里有随机森林模型 然后对变量重要性进行排序的代码，今天的推文我们重复一下论文中的这部分内容，目前能够利用代码和数据运行得到结果，但是还不明白原理和代码中参数的具体作用。今天的内容只是对运行过程的记录。</p><h2 data-tool="mdnice编辑器"><span></span><span>部分示例数据集截图</span><span> </span></h2><figure data-tool="mdnice编辑器"><img data-ratio="0.4782258064516129" data-src="https://mmbiz.qpic.cn/mmbiz_png/t1wZDoUyFk5ic5K17GOqQPFhGufUbmPdFuFWKa5eu5YGhz7g5RhTHJVGCTf6loyUOM7q0mvpicWs4R4R4dQpzM4Q/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/t1wZDoUyFk5ic5K17GOqQPFhGufUbmPdFuFWKa5eu5YGhz7g5RhTHJVGCTf6loyUOM7q0mvpicWs4R4R4dQpzM4Q/640?wx_fmt=png"><figcaption>image.png</figcaption></figure><p data-tool="mdnice编辑器">前10个变量是用来构建模型的变量，其中有一个是分类变量，其他都是数值型数据，最后一列Cmic是因变量</p><h2 data-tool="mdnice编辑器"><span></span><span>读取数据</span><span> </span></h2><pre data-tool="mdnice编辑器"><span></span><code>library(readr)<br>library(tidyverse)<br>dat&lt;-read_csv(<span>"data/20221215/drivers_trends_microbial_carbon-main/rf_example.csv"</span>)<br>dat %&gt;% head()<br>dat %&gt;% colnames()<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>构建随机森林模型</span><span> </span></h2><pre data-tool="mdnice编辑器"><span></span><code>library(caret)<br>set.seed(202)<br>predictors&lt;-colnames(dat)[1:10]<br>model &lt;- train(x = dat[,predictors], <br>               y = dat<span>$Cmic</span>,<br>               method = <span>"rf"</span>,<br>               importance = TRUE,<br>               tuneGrid = expand.grid(mtry = c(2:4)), <span># length(predictors) or 2:6</span><br>               trControl = trainControl(method = <span>"cv"</span>, <br>                                        number = 20,<br>                                        p = 0.75,<br>                                        savePredictions = TRUE))<br></code></pre><p data-tool="mdnice编辑器">这一步需要的时间还是相对比较长的</p><p data-tool="mdnice编辑器">代码中各个参数都是什么意思还需要仔细看看</p><h2 data-tool="mdnice编辑器"><span></span><span>输出模型的RSEM和R方</span><span> </span></h2><pre data-tool="mdnice编辑器"><span></span><code>model<span>$results</span> %&gt;% as_tibble %&gt;% filter(mtry == model<span>$bestTune</span> %&gt;% unlist) %&gt;% select(RMSE, Rsquared)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>棒棒糖图展示模型重要性</span><span> </span></h2><pre data-tool="mdnice编辑器"><span></span><code>varImp(model)<br><br>varImp(model) %&gt;% plot<br>varImp(model, scale = FALSE) %&gt;% plot<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.732912723449001" data-src="https://mmbiz.qpic.cn/mmbiz_png/t1wZDoUyFk5ic5K17GOqQPFhGufUbmPdFh2Ddz3iarnBLlYBU5tb3jfBl58XYoTUYDRkIxscV3z683PnvAe0tNxg/640?wx_fmt=png" data-type="png" data-w="951" src="https://mmbiz.qpic.cn/mmbiz_png/t1wZDoUyFk5ic5K17GOqQPFhGufUbmPdFh2Ddz3iarnBLlYBU5tb3jfBl58XYoTUYDRkIxscV3z683PnvAe0tNxg/640?wx_fmt=png"><figcaption>image.png</figcaption></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.7429171038824763" data-src="https://mmbiz.qpic.cn/mmbiz_png/t1wZDoUyFk5ic5K17GOqQPFhGufUbmPdFxH8p6Oia6PPJbTpMVibibEME1dPHxM7l2AWFcogLfr8EYOcOzKhjWl4nA/640?wx_fmt=png" data-type="png" data-w="953" src="https://mmbiz.qpic.cn/mmbiz_png/t1wZDoUyFk5ic5K17GOqQPFhGufUbmPdFxH8p6Oia6PPJbTpMVibibEME1dPHxM7l2AWFcogLfr8EYOcOzKhjWl4nA/640?wx_fmt=png"><figcaption>image.png</figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>还可以用ggplot2画两个柱形图来展示</span><span> </span></h2><pre data-tool="mdnice编辑器"><span></span><code>varImp(model)<span>$importance</span> %&gt;% <br>  as.data.frame() %&gt;% <br>  rownames_to_column(<span>"var"</span>) %&gt;% <br>  arrange(Overall) %&gt;% <br>  mutate(var=factor(var,levels = rev(var))) %&gt;% <br>  ggplot(aes(x=var,y=Overall))+<br>  geom_col(aes(fill=var),show.legend = FALSE)+<br>  theme_bw()+<br>  labs(x=NULL) -&gt; p1<br><br>varImp(model,scale = FALSE)<span>$importance</span> %&gt;% <br>  as.data.frame() %&gt;% <br>  rownames_to_column(<span>"var"</span>) %&gt;% <br>  arrange(Overall) %&gt;% <br>  mutate(var=factor(var,levels = rev(var))) %&gt;% <br>  ggplot(aes(x=var,y=Overall))+<br>  geom_col(aes(fill=var),show.legend = FALSE)+<br>  theme_bw()+<br>  labs(x=NULL) -&gt; p2<br><br>library(patchwork)<br>p1+<br>  theme(axis.text.x = element_text(angle=60,vjust=1,hjust=1))+<br>  p2+<br>  theme(axis.text.x = element_text(angle=60,vjust=1,hjust=1))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.4258064516129032" data-src="https://mmbiz.qpic.cn/mmbiz_png/t1wZDoUyFk5ic5K17GOqQPFhGufUbmPdFPSAosgqBNoO2rib7xZiaWxtMWA80HJ1PtO09kOL5R4M7MMicNpCv7Edfw/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/t1wZDoUyFk5ic5K17GOqQPFhGufUbmPdFPSAosgqBNoO2rib7xZiaWxtMWA80HJ1PtO09kOL5R4M7MMicNpCv7Edfw/640?wx_fmt=png"><figcaption>image.png</figcaption></figure><p data-tool="mdnice编辑器">后面还有代码是将这个随机森林模型重复运行100次，使用到了map()和map_dfr()函数，这两个函数还得仔细学习一下用法</p><p data-tool="mdnice编辑器">关于这个代码感兴趣的可以去看看原文提供的代码</p><blockquote data-tool="mdnice编辑器"><p>示例数据和代码可以给公众号推文点赞，点击在看，最后留言获取</p></blockquote><p data-tool="mdnice编辑器">欢迎大家关注我的公众号</p><p data-tool="mdnice编辑器"><strong>小明的数据分析笔记本</strong></p><section><mp-common-profile data-pluginname="mpprofile" data-weui-theme="light" data-id="MzI3NzQ3MTcxMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/t1wZDoUyFk5t1sOnM0iabvBhnfIj5YpyqrMib0E1MGCd9ibcYxaOPZd0GWhQBDvK2BPEwsicQxd6y5MHLfphnwHnow/0?wx_fmt=png" data-nickname="小明的数据分析笔记本" data-alias="" data-signature="数据分析和数据可视化有意思的简单小例子~石榴研究生的笔记本" data-from="0" data-is_biz_ban="0"></mp-common-profile><br></section><blockquote data-tool="mdnice编辑器"><p>小明的数据分析笔记本 公众号 主要分享：1、R语言和python做数据分析和数据可视化的简单小例子；2、园艺植物相关转录组学、基因组学、群体遗传学文献阅读笔记；3、生物信息学入门学习资料及自己的学习笔记！</p></blockquote></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/q99tWH_MOWpVrMkcFfnU0g",target="_blank" rel="noopener noreferrer">原文链接</a>
