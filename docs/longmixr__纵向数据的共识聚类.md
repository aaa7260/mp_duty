---
title: "longmixr——纵向数据的共识聚类"
date: 2022-09-12T14:08:29Z
draft: ["false"]
tags: [
  "fetched",
  "医学僧的科研日记"
]
categories: ["Acdemic"]
---
longmixr——纵向数据的共识聚类 by 医学僧的科研日记
------
<div><p>ConsensusClusterPlus包各位都比较熟悉了，这是最简单的包之一，同名函数只需要一步就可以对矩阵进行聚类，参数易调，使用方便。但是它却对纵向数据无能为力，这时候longmixr就站了出来，longmixr与其功能类同，但是它可适用于纵向数据和混合数据，并且函数用法、参数及确定最佳聚类数k方法相似，何不打包一块学走？（纵向数据：一千个基因的表达矩阵是瞬时的，如果每个基因测4次，矩阵就有四千行，就变成了纵向数据）</p><section><iframe data-vidtype="2" data-mpvid="wxv_2573213668297981954" data-cover="http%3A%2F%2Fmmbiz.qpic.cn%2Fmmbiz_jpg%2FeBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbODaZ5k3Z81w49j4mBbw4OL7kzdbcibnPNicf3fYxfDKU5chY4PkBrJDg%2F0%3Fwx_fmt%3Djpeg" allowfullscreen="" frameborder="0" data-ratio="1.7777777777777777" data-w="1920" data-src="https://mp.weixin.qq.com/mp/readtemplate?t=pages/video_player_tmpl&amp;action=mpvideo&amp;auto=0&amp;vid=wxv_2573213668297981954"></iframe></section><p><img data-ratio="0.7453608247422681" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbic4FVSNibziafv74LG7A9Zsibfib7KBib80I9OXjl1jC7aK9ABDRao2MiamMA/640?wx_fmt=png" data-type="png" data-w="970" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbic4FVSNibziafv74LG7A9Zsibfib7KBib80I9OXjl1jC7aK9ABDRao2MiamMA/640?wx_fmt=png"></p><section><ul><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span>#加载包</span></span></code><code><span><span>library</span>(longmixr)</span></code><code><span><span>library</span>(dplyr)</span></code><code><span><span>library</span>(tidyr)</span></code><code><span><span>library</span>(ggplot2)</span></code><code><span><span>library</span>(ggalluvial)</span></code><code><span><span>library</span>(FactoMineR)</span></code><code><span><span>library</span>(factoextra)</span></code><code><span><span>library</span>(lme4)</span></code><code><span><span>library</span>(purrr)</span></code></pre></section><section><ul><li><li></ul><pre data-lang="apache"><code><span><span>#加载内嵌示例数据</span></span></code><code><span><span>data</span>(<span>"fake_questionnaire_data"</span>)</span></code></pre></section><p><br></p><p>该数据集包含100 名受试者在四个不同时间点的观察结果，数据分为两组。对于每个人，信息包括：</p><p>第一个时间点的年龄</p><p>问卷A 包含五个项目（或换言之变量），分类级别为1 - 5</p><p>问卷B 包含五个项目（或换言之变量），分类级别为1 - 5</p><p>问卷C 包含五个连续变量</p><p>还有一个额外的连续变量</p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span>#降维，特别是如果有很多变量，则降低分析的维数可能很有意义</span></span></code><code><span><span>#使用FactoMineR包中的函数FAMD，它与PCA类似。为了更好的可解释性，对每个问卷进行降维</span></span></code><code><span><span>quest_A_dim</span> &lt;- fake_questionnaire_data %&gt;% </span></code><code><span>  <span>select</span>(starts_with(<span>"questionnaire_A"</span>)) %&gt;% </span></code><code><span>  <span>FAMD</span>(ncp = 5, graph = FALSE)</span></code><code><span><br></span></code><code><span><span>quest_B_dim</span> &lt;- fake_questionnaire_data %&gt;% </span></code><code><span>  <span>select</span>(starts_with(<span>"questionnaire_B"</span>)) %&gt;% </span></code><code><span>  <span>FAMD</span>(ncp = 5, graph = FALSE)</span></code><code><span><br></span></code><code><span><span>quest_C_dim</span> &lt;- fake_questionnaire_data %&gt;% </span></code><code><span>  <span>select</span>(starts_with(<span>"questionnaire_C"</span>)) %&gt;% </span></code><code><span>  <span>prcomp</span>(scale = TRUE)</span></code></pre></section><section><ul><li><li></ul><pre data-lang="apache"><code><span><span>#可以使用手肘图直观地确定要包含在分析中的组件数量</span></span></code><code><span><span>fviz_screeplot</span>(quest_A_dim, main = <span>"Questionnaire A"</span>)</span></code></pre></section><p><img data-ratio="0.7209677419354839" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVb9S2wI3X8E8IFibkkib7kSx1Lb6Pj4AhlztP5cv2v7JI1wicaCrXSiaP5gw/640?wx_fmt=png" data-type="png" data-w="620" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVb9S2wI3X8E8IFibkkib7kSx1Lb6Pj4AhlztP5cv2v7JI1wicaCrXSiaP5gw/640?wx_fmt=png"></p><p><span>对于问卷A，只选择前三个组分，因为其他组分只解释了少量的方差。</span></p><section><ul><li></ul><pre data-lang="javascript"><code><span>fviz_screeplot(quest_B_dim, main = <span>"Questionnaire B"</span>)</span></code></pre></section><p><img data-ratio="0.7115072933549432" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbiapXEP8tTwiblgwnibzXTfESDXQC1VnhBFfE3kDpqvzVOmnbZOUtnwPBw/640?wx_fmt=png" data-type="png" data-w="617" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbiapXEP8tTwiblgwnibzXTfESDXQC1VnhBFfE3kDpqvzVOmnbZOUtnwPBw/640?wx_fmt=png"></p><p>对于问卷B，只包含第一个组分。</p><section><ul><li></ul><pre data-lang="javascript"><code><span>fviz_screeplot(quest_C_dim, main = <span>"Questionnaire C"</span>)</span></code></pre></section><p><img data-ratio="0.7188552188552189" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbJn08ou7UxPdl48ZhlGq7FOCAsbj2Q5l3LIuZLUf2LulSzp8ibaruhqw/640?wx_fmt=png" data-type="png" data-w="594" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbJn08ou7UxPdl48ZhlGq7FOCAsbj2Q5l3LIuZLUf2LulSzp8ibaruhqw/640?wx_fmt=png"></p><p><span>对于</span><span>问卷</span><span>C，只包</span><span>含第一个组分。</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span>#将被选择的组分汇总</span></span></code><code><span><span>quest_A_comp</span> &lt;- as.data.frame(quest_A_dim$ind$coord[, 1:3])</span></code><code><span><span>colnames</span>(quest_A_comp) &lt;- paste0(<span>"quest_A_"</span>, 1:3)</span></code><code><span><span>quest_B_comp</span> &lt;- as.data.frame(quest_B_dim$ind$coord[, 1])</span></code><code><span><span>colnames</span>(quest_B_comp) &lt;- paste0(<span>"quest_B_"</span>, 1)</span></code><code><span><span>quest_C_comp</span> &lt;- as.data.frame(quest_C_dim$x[, 1])</span></code><code><span><span>colnames</span>(quest_C_comp) &lt;- paste0(<span>"quest_C_"</span>, 1)</span></code><code><span><br></span></code><code><span><span>cluster_data</span> &lt;- bind_cols(</span></code><code><span>  <span>data</span>.frame(</span></code><code><span>    <span>ID</span> = fake_questionnaire_data$ID,</span></code><code><span>    <span>visit</span> = fake_questionnaire_data$visit,</span></code><code><span>    <span>age</span> = fake_questionnaire_data$age_visit_1</span></code><code><span>  ),</span></code><code><span>  <span>quest_A_comp</span>,</span></code><code><span>  <span>quest_B_comp</span>,</span></code><code><span>  <span>quest_C_comp</span></span></code><code><span>)</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span><span>#混杂因素：可能存在对不想分析的结果有已知影响的混杂因素。</span></span></code><code><span><span>#一种解决方案是首先在线性模型中“将它们回归”，并且只使用生成的残差。</span></span></code><code><span><span>#比如问卷A</span></span></code><code><span>ggplot(cluster_data, aes(x = age, y = quest_A_1)) +</span></code><code><span>  geom_point() +</span></code><code><span>  geom_smooth(method = <span>"lm"</span>) +</span></code><code><span>  ylab(<span>"Questionnaire A dimension 1"</span>) +</span></code><code><span>  theme_bw()</span></code></pre></section><p><img data-ratio="0.71900826446281" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbXIIjNq0P2sXqKRGbibC0ibqNGUHW0sic5MxWexvFpic63VBOpnz4BIun2g/640?wx_fmt=png" data-type="png" data-w="605" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbXIIjNq0P2sXqKRGbibC0ibqNGUHW0sic5MxWexvFpic63VBOpnz4BIun2g/640?wx_fmt=png"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span>#使用线性混合模型来回归用于聚类的所有组分中的年龄效应：</span></span></code><code><span><span>generate_residuals</span> &lt;- function(x, age, ID) {</span></code><code><span>  <span>data</span> &lt;- data.frame(</span></code><code><span>    <span>x</span> = x,</span></code><code><span>    <span>age</span> = age,</span></code><code><span>    <span>ID</span> = ID)</span></code><code><span>  <span>model</span> &lt;- lmer(x ~ age + (1 | ID), data = data)</span></code><code><span>  <span>resid</span> &lt;- residuals(model, type = <span>"response"</span>)</span></code><code><span>  <span>names</span>(resid) &lt;- NULL</span></code><code><span>  <span>resid</span></span></code><code><span>}</span></code><code><span><br></span></code><code><span><span>cluster_data_resid</span> &lt;- cluster_data %&gt;% </span></code><code><span>  <span>mutate</span>(across(matches(<span>"[1-9]$"</span>),</span></code><code><span>                ~<span>generate_residuals</span>(x = .x, age = age, ID = ID),</span></code><code><span>                .<span>names</span> = <span>"{.col}_resid"</span>)) %&gt;% </span></code><code><span>  <span>select</span>(ID, visit, ends_with(<span>"resid"</span>), age)</span></code></pre></section><section><ul><li><li><li><li><li><li></ul><pre data-lang="javascript"><code><span>#回归后，残差中不再包含年龄的线性效应。</span></code><code><span>ggplot(cluster_data_resid, aes(x = age, y = quest_A_1_resid)) +</span></code><code><span>  geom_point() +</span></code><code><span>  geom_smooth(method = <span>"lm"</span>) +</span></code><code><span>  ylab(<span>"Residuals of questionnaire A dimension 1"</span>) +</span></code><code><span>  theme_bw()</span></code></pre></section><p><img data-ratio="0.7200674536256324" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVb7s7bEeSDq3ibFIbcrYt90owkS4ULKV1dlToYupcTiazuOffX4wpwmMTQ/640?wx_fmt=png" data-type="png" data-w="593" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVb7s7bEeSDq3ibFIbcrYt90owkS4ULKV1dlToYupcTiazuOffX4wpwmMTQ/640?wx_fmt=png"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span>#聚类，对于每个变量，需要构建一个模型（与共识聚类的最大不同之处）</span></span></code><code><span><span>response_names</span> &lt;- c(paste0(<span>"quest_A_"</span>, 1:3, <span>"_resid"</span>),</span></code><code><span>                    <span>paste0</span>(<span>"quest_B_"</span>, 1, <span>"_resid"</span>),</span></code><code><span>                    <span>paste0</span>(<span>"quest_C_"</span>, 1, <span>"_resid"</span>))</span></code><code><span><span>list_models</span> &lt;- lapply(response_names, function(x) {</span></code><code><span>  <span>flexmix</span>::FLXMRmgcv(as.formula(paste0(x, <span>" ~ ."</span>)))</span></code><code><span>})</span></code><code><span><span>set</span>.seed(2378)</span></code><code><span><span>cluster_model</span> &lt;- longitudinal_consensus_cluster(data = cluster_data_resid,</span></code><code><span>                                                <span>id_column</span> = <span>"ID"</span>,</span></code><code><span>                                                <span>max_k</span> = 3,</span></code><code><span>                                                <span>reps</span> = 5,</span></code><code><span>                                                <span>p_item</span> = 0.8,</span></code><code><span>                                                <span>model_list</span> = list_models,</span></code><code><span>                                                <span>flexmix_formula</span> = as.formula(<span>"~s(visit, k = 4) | ID"</span>),</span></code><code><span>                                                <span>final_linkage</span> = <span>"ward.D2"</span>)</span></code></pre></section><section><ul><li><li></ul><pre data-lang="apache"><code><span><span>#分析聚类，确定最佳聚类数</span></span></code><code><span><span>plot</span>(cluster_model)</span></code></pre></section><p><img data-ratio="0.8940886699507389" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbjH2psGn2UQyZP2ib8LdaricKa7MHGicFl3blLnM2chUbXTGHF5ncqdIew/640?wx_fmt=png" data-type="png" data-w="406" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbjH2psGn2UQyZP2ib8LdaricKa7MHGicFl3blLnM2chUbXTGHF5ncqdIew/640?wx_fmt=png"></p><p><img data-ratio="0.6934931506849316" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbb3GQib22xWxxYEDtQOP8cXbKU54MaW0csVJ0hBYje9BCvINqSUYZXtg/640?wx_fmt=png" data-type="png" data-w="584" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbb3GQib22xWxxYEDtQOP8cXbKU54MaW0csVJ0hBYje9BCvINqSUYZXtg/640?wx_fmt=png"></p><p><img data-ratio="0.6650717703349283" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVb03rmdymISMO2DsddvcJ9iaRQEQy4Khdjykiag6hqtB7wYjapb6YavM1A/640?wx_fmt=png" data-type="png" data-w="627" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVb03rmdymISMO2DsddvcJ9iaRQEQy4Khdjykiag6hqtB7wYjapb6YavM1A/640?wx_fmt=png"></p><p><img data-ratio="0.6716171617161716" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbchUbOHfgmxkpHiaZ6MD6kU8AY8LHtmChq2ibzM7MyHNMltj8yaicM9BiaQ/640?wx_fmt=png" data-type="png" data-w="606" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbchUbOHfgmxkpHiaZ6MD6kU8AY8LHtmChq2ibzM7MyHNMltj8yaicM9BiaQ/640?wx_fmt=png"></p><p><img data-ratio="0.6672212978369384" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbmn9wQhr8DCl2Q1MRgLKUj8xibmicYIvSTpch35Ajv8DJJalibDeibVsYVg/640?wx_fmt=png" data-type="png" data-w="601" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbmn9wQhr8DCl2Q1MRgLKUj8xibmicYIvSTpch35Ajv8DJJalibDeibVsYVg/640?wx_fmt=png"></p><section><ul><li></ul><pre data-lang="apache"><code><span><span>#可视化</span></span></code></pre></section><section><ul><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span>#选择k=2作为最佳聚类数，提取聚类信息</span></span></code><code><span><span>cluster_assignments</span> &lt;- get_clusters(cluster_model, number_clusters = 2)</span></code><code><span><span>original_data</span> &lt;- fake_questionnaire_data %&gt;% </span></code><code><span>  <span>left_join</span>(cluster_assignments, by = <span>"ID"</span>)</span></code><code><span><span>cluster_data_resid</span> &lt;- cluster_data_resid %&gt;% </span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span>#定义绘图函数（意大利面图）</span></span></code><code><span><span>plot_spaghetti</span> &lt;- function(data = cluster_data_resid,</span></code><code><span>                           <span>num_clus</span> = 2,</span></code><code><span>                           <span>var_type</span> = c(<span>"quest_A"</span>, <span>"quest_B"</span>, <span>"quest_C"</span>),</span></code><code><span>                           <span>var_nums</span> = 1:3,</span></code><code><span>                           <span>scale_arg</span> = <span>"fixed"</span>) {</span></code><code><span>  <span>var_type</span> &lt;- match.arg(var_type)</span></code><code><span>  <span>clus_assign</span> &lt;- paste0(<span>"assignment_num_clus_"</span>, num_clus)</span></code><code><span>  </span></code><code><span>  <span>plot_data</span> &lt;- data %&gt;% </span></code><code><span>    <span>pivot_longer</span>(</span></code><code><span>      <span>cols</span> = paste0(var_type, <span>"_"</span>, var_nums, <span>"_resid"</span>),</span></code><code><span>      <span>names_to</span> = <span>"variable"</span></span></code><code><span>    ) %&gt;% </span></code><code><span>    <span># this step to create a patient_idID per variable is needed, otherwise</span></span></code><code><span>    <span># ggplot can't differentiate between the different variables</span></span></code><code><span>    <span>mutate</span>(ID = paste0(ID, <span>"_"</span>, variable),</span></code><code><span>           <span>across</span>(c(visit, variable, ID), as.factor))</span></code><code><span>  </span></code><code><span>  <span>additional_data</span> &lt;- plot_data %&gt;% </span></code><code><span>    <span>select</span>(visit, value, variable, .data[[clus_assign]]) %&gt;% </span></code><code><span>    <span>group_by</span>(visit, variable, .data[[clus_assign]]) %&gt;% </span></code><code><span>    <span>summarise</span>(mean = mean(value),</span></code><code><span>              <span>sd</span> = sd(value)) %&gt;% </span></code><code><span>    <span>mutate</span>(ID = 1)</span></code><code><span>  </span></code><code><span>  <span>ggplot</span>(data = plot_data) +</span></code><code><span>    <span>geom_line</span>(mapping = aes(x = visit, y = value, col = variable, group = ID),</span></code><code><span>              <span>alpha</span> = 0.4) +</span></code><code><span>    <span>geom_ribbon</span>(data = additional_data,</span></code><code><span>                <span>mapping</span> = aes(x = visit, y = mean, ymin = mean - sd, ymax = mean + sd,</span></code><code><span>                              <span>fill</span> = variable, group = variable), alpha = 0.3) +</span></code><code><span>    <span>geom_line</span>(data = additional_data,</span></code><code><span>              <span>mapping</span> = aes(x = visit, y = mean, col = variable, group = variable),</span></code><code><span>              <span>size</span> = 2) +</span></code><code><span>    <span>facet_wrap</span>(~as.factor(.data[[clus_assign]]), scales = scale_arg) +</span></code><code><span>    <span>theme_bw</span>()</span></code><code><span>}</span></code></pre></section><section><ul><li><li></ul><pre data-lang="apache"><code><span><span>#问卷A</span></span></code><code><span><span>plot_spaghetti</span>(num_clus = 2, var_type = <span>"quest_A"</span>, var_nums = 1:3)</span></code></pre></section><p><img data-ratio="0.7559322033898305" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbXV7A4I70kZDHUFpcaXcG8a5tXWR1QYicWG0W3OhkmImQicpBE2Yj7keg/640?wx_fmt=png" data-type="png" data-w="590" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbXV7A4I70kZDHUFpcaXcG8a5tXWR1QYicWG0W3OhkmImQicpBE2Yj7keg/640?wx_fmt=png"></p><section><ul><li><li></ul><pre data-lang="apache"><code><span><span>#问卷B</span></span></code><code><span><span>plot_spaghetti</span>(num_clus = 2, var_type = <span>"quest_B"</span>, var_nums = 1)</span></code></pre></section><p><img data-ratio="0.7478849407783418" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVb218YucvnUghQySYRj9qI2XEGJa6dXfSiaiagGZMqLibsZPBaoUw1jjA1A/640?wx_fmt=png" data-type="png" data-w="591" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVb218YucvnUghQySYRj9qI2XEGJa6dXfSiaiagGZMqLibsZPBaoUw1jjA1A/640?wx_fmt=png"></p><section><ul><li><li></ul><pre data-lang="apache"><code><span><span>#问卷C</span></span></code><code><span><span>plot_spaghetti</span>(num_clus = 2, var_type = <span>"quest_C"</span>, var_nums = 1)</span></code></pre></section><p><img data-ratio="0.7491408934707904" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbMJ9437frp2PoyJ7V9OPjhUkYswHCFSzGe16HQic9HbWA4D8301TiaUxA/640?wx_fmt=png" data-type="png" data-w="582" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbMJ9437frp2PoyJ7V9OPjhUkYswHCFSzGe16HQic9HbWA4D8301TiaUxA/640?wx_fmt=png"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span>#使用桑基图来可视化每组每个变量随时间变化的趋势</span></span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#定义绘图函数</span></span></code><code><span><span>plot_alluvial</span> &lt;- function(data = original_data,</span></code><code><span>                          <span>num_clus</span> = 2,</span></code><code><span>                          <span>var_name</span>) {</span></code><code><span>  <span>clus_assign</span> &lt;- paste0(<span>"assignment_num_clus_"</span>, num_clus)</span></code><code><span>  </span></code><code><span>  <span>p</span> &lt;- data %&gt;% </span></code><code><span>    <span>ggplot</span>(aes(x = visit,</span></code><code><span>               <span>stratum</span> = .data[[var_name]],</span></code><code><span>               <span>alluvium</span> = ID,</span></code><code><span>               <span>fill</span> = .data[[var_name]],</span></code><code><span>               <span>label</span> = .data[[var_name]])) +</span></code><code><span>    <span>scale_fill_brewer</span>(type = <span>"qual"</span>, palette = <span>"Set2"</span>) +</span></code><code><span>    <span>geom_flow</span>(stat = <span>"alluvium"</span>, lode.guidance = <span>"frontback"</span>,</span></code><code><span>              <span>color</span> = <span>"darkgray"</span>) +geom_stratum() +</span></code><code><span>    <span>facet_wrap</span>(~as.factor(.data[[clus_assign]])) +</span></code><code><span>    <span>theme_bw</span>() +</span></code><code><span>    <span>theme</span>(legend.position = <span>"bottom"</span>) +</span></code><code><span>    <span>ylab</span>(<span>"number of subjects"</span>) +</span></code><code><span>    <span>ggtitle</span>(paste0(<span>"Distribution of "</span>, var_name, <span>" across clusters"</span>))</span></code><code><span>  </span></code><code><span>  <span>print</span>(p)</span></code><code><span>}</span></code></pre></section><section><ul><li><li><li></ul><pre data-lang="apache"><code><span><span>#以问卷A为例</span></span></code><code><span><span>colnames</span>(original_data)[grepl(<span>"^questionnaire_A"</span>, colnames(original_data))] %&gt;% </span></code><code><span>  <span>walk</span>(~plot_alluvial(num_clus = 2, var_name = .x))</span></code></pre></section><p><img data-ratio="0.7306967984934086" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbfXjI1JZQLv4hgJSVicQgjScGJ5anZUMobdaEgrxGCtKmMIyErzx25WQ/640?wx_fmt=png" data-type="png" data-w="531" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbfXjI1JZQLv4hgJSVicQgjScGJ5anZUMobdaEgrxGCtKmMIyErzx25WQ/640?wx_fmt=png"></p><p><img data-ratio="0.7078853046594982" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVb1wibt2MCt6ncWF4HicU5z8yib2Y9ia7uESuW9jKFYMMOzZriaq8P3ic86JbA/640?wx_fmt=png" data-type="png" data-w="558" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVb1wibt2MCt6ncWF4HicU5z8yib2Y9ia7uESuW9jKFYMMOzZriaq8P3ic86JbA/640?wx_fmt=png"></p><p><img data-ratio="0.7343453510436433" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbEwJlqIc1LIdQOOFu0Ih1FcR4TCSeqFmFElvrD3ibEvwrQZzUyjh3gzA/640?wx_fmt=png" data-type="png" data-w="527" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbEwJlqIc1LIdQOOFu0Ih1FcR4TCSeqFmFElvrD3ibEvwrQZzUyjh3gzA/640?wx_fmt=png"></p><p><img data-ratio="0.7332089552238806" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbWIdQtqc9K0pKoCic2Ft8amSkLkstdbxIqCeFicqLBkYrEmcuA0c5Czicw/640?wx_fmt=png" data-type="png" data-w="536" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbWIdQtqc9K0pKoCic2Ft8amSkLkstdbxIqCeFicqLBkYrEmcuA0c5Czicw/640?wx_fmt=png"></p><p><img data-ratio="0.7419962335216572" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVboPTxsuSHL0z5iaK2NQn6oibsMaSnDa856FR9QDCvibFepNh7BiaRhicWdhg/640?wx_fmt=png" data-type="png" data-w="531" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVboPTxsuSHL0z5iaK2NQn6oibsMaSnDa856FR9QDCvibFepNh7BiaRhicWdhg/640?wx_fmt=png"></p><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span>#组间比较</span></span></code><code><span><span>#还记得没使用过的单个连续变量吗？</span></span></code><code><span><span>original_data</span> %&gt;% </span></code><code><span>  <span>filter</span>(visit == 1) %&gt;% </span></code><code><span>  <span>mutate</span>(cluster = as.factor(assignment_num_clus_2)) %&gt;% </span></code><code><span>  <span>ggplot</span>(aes(x = cluster, y = single_continuous_variable,</span></code><code><span>             <span>fill</span> = cluster)) +</span></code><code><span>  <span>geom_boxplot</span>() +</span></code><code><span>  <span>theme_bw</span>()</span></code></pre></section><p><img data-ratio="0.7412199630314233" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbXeTPNa7ytJT24W0nJZenEBRPqQvugtFV35XiaiaQYOLsK4rHnIcKYXHA/640?wx_fmt=png" data-type="png" data-w="541" src="https://mmbiz.qpic.cn/mmbiz_png/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbXeTPNa7ytJT24W0nJZenEBRPqQvugtFV35XiaiaQYOLsK4rHnIcKYXHA/640?wx_fmt=png"></p><p>怎么样，这么实用的包和函数还不赶快学起来~</p><p><img data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbyXLjrV4X8qCDU47s5RVyqjjHk2n9GzRyiaBXQ7XpmP6SpIQFibicEcgTg/640?wx_fmt=jpeg" data-type="jpeg" data-w="960" src="https://mmbiz.qpic.cn/mmbiz_jpg/eBfvI7Ryx8dfg21QWSuibJV7mP0QfRPVbyXLjrV4X8qCDU47s5RVyqjjHk2n9GzRyiaBXQ7XpmP6SpIQFibicEcgTg/640?wx_fmt=jpeg"></p><section>写在后面<br></section><section>医学僧的心愿是为医学僧的支持者和科研爱好者营造一个勤学好问、互帮互助、共同进步的优良环境。但是人多了难免鱼龙混杂，良莠不齐，群里不乏有真心实意、脚踏实地的科研人，我们很尊重并欢迎他们，因此不希望被少数来发广告的、划水的、看热闹的、占个坑的所打扰，最终我们的心意付之东流，大家的热情消磨殆尽。为了解决这个问题，我们决定提高入群的门槛——收费进群，这样，愿意进群的同志相信也是个圈内活跃用户，圈内人相互交流，岂不快哉！</section><section><span>因</span><span>此</span><span>，为了提升大家的效率，调动大家的积极性，吸收真正的科研爱好者，形成一个良好的学习交流氛围，我们决定增加群的数量，并细化群的功能，暂时增加以下几个主题群：</span></section><ul><li><p>文献下载-医学僧</p></li><li><p>机器学习（分类）-医学僧</p></li><li><p>ggplot可视化-医学僧</p></li><li><p>热图可视化-医学僧</p></li><li><p>TCGA挖掘-医学僧</p></li><li><p>GEO挖掘-医学僧</p></li><li><p>肿瘤预后模型-医学僧</p></li><li><p>肿瘤分子亚型-医学僧</p></li></ul><p>欢迎小伙伴们进群👏👏👏，每个群收费15元。请联系小编微信yixuesengkyrj或扫描下面二维码：</p><p><img data-ratio="0.8407407407407408" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/eBfvI7Ryx8enibib3UJd6iaLibROb1ibWJtZn0fyA9Bu9szdIkibpzWVzjw0LIVrQKeHfPS7h1gI8bicaaYlcOnMIyQAQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/eBfvI7Ryx8enibib3UJd6iaLibROb1ibWJtZn0fyA9Bu9szdIkibpzWVzjw0LIVrQKeHfPS7h1gI8bicaaYlcOnMIyQAQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/8SJ07zPmpF0XoUX_7q6VlQ",target="_blank" rel="noopener noreferrer">原文链接</a>
