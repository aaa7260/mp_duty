---
title: "单细胞免疫组库分析之scRepertoire"
date: 2022-12-09T08:35:37Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
单细胞免疫组库分析之scRepertoire by 生信菜鸟团
------
<div><h2><span>scRepertoire安装</span><span></span></h2><p>使用gitHub安装scRepertoire包，加载完后，就可以愉快的开始分析了。</p><pre><code>devtools::install_github(<span>"ncborcherding/scRepertoire"</span>)<br></code></pre><h2><span>示例教程运行</span><span></span></h2><h3><span>1、统计个样本中唯一克隆类型的总数或相对数量</span></h3><pre><code>&gt; <span>library</span>(scRepertoire)<br>&gt; <span>library</span>(Seurat)<br>&gt; <span>library</span>(ggsci)<br><br>&gt; data(<span>"contig_list"</span>) <br>&gt; combined &lt;- combineTCR(contig_list, samples = c(<span>"PY"</span>, <span>"PY"</span>, <span>"PX"</span>, <span>"PX"</span>, <span>"PZ"</span>,<span>"PZ"</span>), ID = c(<span>"P"</span>, <span>"T"</span>, <span>"P"</span>, <span>"T"</span>, <span>"P"</span>, <span>"T"</span>), cells =<span>"T-AB"</span>)<br>&gt; quantContig(combined, cloneCall=<span>"gene+nt"</span>, scale = <span>T</span>) +   scale_fill_npg()<br>&gt; quantContig_output &lt;- quantContig(combined, cloneCall=<span>"gene+nt"</span>, scale = <span>T</span>, exportTable = <span>T</span>) <span>#可视化数据对象</span><br>&gt; quantContig_output<br>  contigs values total   scaled<br><span>1</span>    <span>2692</span>   PY_P  <span>3208</span> <span>83.91521</span><br><span>2</span>    <span>1513</span>   PY_T  <span>3119</span> <span>48.50914</span><br><span>3</span>     <span>823</span>   PX_P  <span>1068</span> <span>77.05993</span><br><span>4</span>     <span>928</span>   PX_T  <span>1678</span> <span>55.30393</span><br><span>5</span>    <span>1147</span>   PZ_P  <span>1434</span> <span>79.98605</span><br><span>6</span>     <span>764</span>   PZ_T  <span>2768</span> <span>27.60116</span><br></code></pre><figure><img data-ratio="0.7161803713527851" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhgn0eEF8ibXvmPbpDwDo3QFCFv0G4ASf5aTXhibbc6For9GDwc9UWPlJA/640?wx_fmt=png" data-type="png" data-w="1131" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhgn0eEF8ibXvmPbpDwDo3QFCFv0G4ASf5aTXhibbc6For9GDwc9UWPlJA/640?wx_fmt=png"><figcaption>img</figcaption></figure><h3><span>2、克隆型丰度统计</span></h3><pre><code>&gt; abundanceContig(combined, cloneCall = <span>"gene"</span>, scale = <span>F</span>)<br></code></pre><figure><img data-ratio="0.6886383347788378" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhRjndNcic5LohKCzmfVnE5BCpRy8SibfAXapeR21ZRq7KV0OE3tq6l5tg/640?wx_fmt=png" data-type="png" data-w="1153" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhRjndNcic5LohKCzmfVnE5BCpRy8SibfAXapeR21ZRq7KV0OE3tq6l5tg/640?wx_fmt=png"><figcaption>img</figcaption></figure><h3><span>3、CDR3序列的长度分布</span></h3><p>克隆符号只能是“nt”或“aa”</p><pre><code>&gt; lengthContig(combined, cloneCall=<span>"aa"</span>, chains = <span>"combined"</span>)  +  scale_fill_npg()<br>scale.<br>&gt; lengthContig(combined, cloneCall=<span>"nt"</span>, chains = <span>"combined"</span>)  +  scale_fill_npg()<br>&gt; lengthContig(combined, cloneCall=<span>"nt"</span>, chains = <span>"single"</span>) +  scale_fill_npg()<br></code></pre><figure><img data-ratio="0.6803493449781659" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAh38GBx6EDTCw4W460UiaFzwgsCgYwS8cZu5yuxCPTfw4BXfxDeNgKqtA/640?wx_fmt=png" data-type="png" data-w="1145" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAh38GBx6EDTCw4W460UiaFzwgsCgYwS8cZu5yuxCPTfw4BXfxDeNgKqtA/640?wx_fmt=png"><figcaption>img</figcaption></figure><figure><img data-ratio="0.7022026431718061" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhJYEm3DZIAKHfCdPvBkxybMxMV5ZvB0DkxJiaySS7vx07qdGviagKdsfw/640?wx_fmt=png" data-type="png" data-w="1135" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhJYEm3DZIAKHfCdPvBkxybMxMV5ZvB0DkxJiaySS7vx07qdGviagKdsfw/640?wx_fmt=png"><figcaption>img</figcaption></figure><h3><span>4、样本间克隆类型的动态变化</span></h3><pre><code>&gt; compareClonotypes(combined, numbers = <span>10</span>, samples = c(<span>"PY_P"</span>, <span>"PY_T"</span>), cloneCall=<span>"aa"</span>, graph = <span>"alluvial"</span>)<br></code></pre><figure><img data-ratio="0.726063829787234" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhILdwldSf3VRynWCY3unfw9TwjjAWlcsu6JibUppvrzicM3VYrBuTeq0Q/640?wx_fmt=png" data-type="png" data-w="1128" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhILdwldSf3VRynWCY3unfw9TwjjAWlcsu6JibUppvrzicM3VYrBuTeq0Q/640?wx_fmt=png"><figcaption>img</figcaption></figure><h3><span>5 、克隆空间内稳态</span></h3><pre><code>&gt; clonalHomeostasis(combined, cloneCall = <span>"gene"</span>)<br></code></pre><figure><img data-ratio="0.7145359019264448" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhIicEsibWPwRDNEiaHYT2ZO8GLqkibX6DVDdaTHtelbUWcE5g9QDDURqTibw/640?wx_fmt=png" data-type="png" data-w="1142" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhIicEsibWPwRDNEiaHYT2ZO8GLqkibX6DVDdaTHtelbUWcE5g9QDDURqTibw/640?wx_fmt=png"><figcaption>img</figcaption></figure><h3><span>6、克隆比例</span></h3><p>split表示克隆型按拷贝数或出现频率的排序，即1:10为每个样本中前10个克隆型。默认的bin位于函数中的split变量之下，可以进行调整，但在基线上它们如下所示</p><pre><code>&gt; clonalProportion(combined, cloneCall = <span>"gene"</span>)   +  scale_fill_npg()<br></code></pre><figure><img data-ratio="0.7202486678507993" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhSF5nibDFhIXYhth2XKSYOad79IGLrQSL7F54aAeic0247doiaOGUC8sFw/640?wx_fmt=png" data-type="png" data-w="1126" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhSF5nibDFhIXYhth2XKSYOad79IGLrQSL7F54aAeic0247doiaOGUC8sFw/640?wx_fmt=png"><figcaption>img</figcaption></figure><h3><span>7、样本间相似性度量</span></h3><pre><code>&gt; clonalOverlap(combined, cloneCall = <span>"gene+nt"</span>, method = <span>"morisita"</span>)<br></code></pre><figure><img data-ratio="0.7139084507042254" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAh77iaHp31eI30hgFgEG6axIUqQUjv1Cy2txs3NqXoZyBOpbDoKpiamTbQ/640?wx_fmt=png" data-type="png" data-w="1136" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAh77iaHp31eI30hgFgEG6axIUqQUjv1Cy2txs3NqXoZyBOpbDoKpiamTbQ/640?wx_fmt=png"><figcaption>img</figcaption></figure><h3><span>8、多样性分析</span></h3><p>多样性也可以通过样本或其他变量来衡量。多样性的四种度量方法：1) Shannon, 2) inverse Simpson, 3) Chao1, and 4) Abundance-based Coverage Estimator (ACE)</p><pre><code>&gt;  clonalDiversity(combined, cloneCall = <span>"gene"</span>, group = <span>"samples"</span>)+  scale_fill_npg()<br></code></pre><figure><img data-ratio="0.6976336546888694" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhcIYakn4VbRD5Mg9KoX5hpdJtTc1RZ5rUmdWaPILuySGiapgxXYFfFpQ/640?wx_fmt=png" data-type="png" data-w="1141" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhcIYakn4VbRD5Mg9KoX5hpdJtTc1RZ5rUmdWaPILuySGiapgxXYFfFpQ/640?wx_fmt=png"><figcaption>img</figcaption></figure><h3><span>9、整合seurat数据</span></h3><p>示例教程中的数据没找到，下面以10X官提供的10k PBMC数据为例（单个样本数据）。首先读入BCR数据，使用combinedBCR函数将读入的数据BCR数据进行整合。</p><pre><code><span># read bcr/tcr</span><br>bcr &lt;- read.csv(<span>"b_filtered_contig_annotations.csv"</span>)<br>bcr &lt;- bcr[!duplicated(bcr$barcode),]<br>names(bcr)[names(bcr) == <span>"raw_clonotype_id"</span>] &lt;- <span>"clonotype_id"</span><br><br>mycsv1 = list(ex=bcr)<br>combined &lt;- combineBCR(mycsv1, samples = c(<span>"PY"</span>), ID = c(<span>"P"</span>))<br>combined$PY_P &lt;- stripBarcode(combined$PY_P , column = <span>1</span>, connector = <span>"_"</span>, num_connects = <span>3</span>)<br></code></pre><p>接着读入10X的RNA表达谱数据，并走seurat官方流程。</p><pre><code>data.matrix &lt;- Read10X(<span>"filtered_feature_bc_matrix/"</span>)<br>seurat.object &lt;- CreateSeuratObject(counts = data.matrix$`Gene Expression`)<br><br>clono.seurat &lt;- seurat.object<br>clono.seurat &lt;- FindVariableFeatures(clono.seurat, selection.method = <span>"vst"</span>, nfeatures = <span>2000</span>)<br>clono.seurat &lt;- SCTransform(object = clono.seurat, verbose = <span>FALSE</span>, do.scale = <span>TRUE</span>)<br>clono.seurat &lt;- RunPCA(clono.seurat, features = VariableFeatures(clono.seurat))<br>clono.seurat &lt;- RunUMAP(clono.seurat, dims = <span>1</span>:<span>15</span>)<br>clono.seurat &lt;- RunTSNE(clono.seurat, dims = <span>1</span>:<span>15</span>)<br>clono.seurat &lt;- FindNeighbors(clono.seurat, dims = <span>1</span>:<span>15</span>)<br>clono.seurat &lt;- FindClusters(clono.seurat, resolution = <span>0.1</span>)<br>DimPlot(clono.seurat, label = <span>T</span>) + NoLegend() + scale_fill_npg()<br></code></pre><figure><img data-ratio="0.7144144144144144" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhdaO7Y6jF5rPIvZ3yiajeA86rYSAWCwUWjSlY5NOrDz8xZPUNNiad4PHg/640?wx_fmt=png" data-type="png" data-w="1110" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAhdaO7Y6jF5rPIvZ3yiajeA86rYSAWCwUWjSlY5NOrDz8xZPUNNiad4PHg/640?wx_fmt=png"><figcaption>img</figcaption></figure><p>使用combineExpression()数据整合表达谱数据以及clonotype数据。因为大部分细胞都不是B细胞，因此存在很多NA。</p><pre><code>&gt; seurat1 &lt;- combineExpression(combined, clono.seurat, cloneCall=<span>"gene"</span>)<br>&gt; head(seurat1@meta.data)<br>                      orig.ident nCount_RNA nFeature_RNA nCount_protein nFeature_protein nCount_SCT nFeature_SCT SCT_snn_res.0.8<br>AAACCTGAGACAGACC-<span>1</span> SeuratProject       <span>4751</span>         <span>1982</span>           <span>1704</span>               <span>19</span>       <span>5119</span>         <span>1981</span>               <span>1</span><br>AAACCTGAGCGATAGC-<span>1</span> SeuratProject       <span>5767</span>         <span>1761</span>           <span>2571</span>               <span>19</span>       <span>5631</span>         <span>1761</span>               <span>0</span><br>AAACCTGAGCGGCTTC-<span>1</span> SeuratProject       <span>4991</span>         <span>1957</span>           <span>2914</span>               <span>19</span>       <span>5236</span>         <span>1954</span>               <span>3</span><br>AAACCTGAGGATCGCA-<span>1</span> SeuratProject       <span>6012</span>         <span>2310</span>           <span>2388</span>               <span>19</span>       <span>5773</span>         <span>2307</span>               <span>3</span><br>AAACCTGAGTCACGCC-<span>1</span> SeuratProject       <span>7267</span>         <span>2315</span>           <span>1772</span>               <span>19</span>       <span>6072</span>         <span>2312</span>               <span>2</span><br>AAACCTGAGTTCGCAT-<span>1</span> SeuratProject       <span>2543</span>         <span>1116</span>           <span>2124</span>               <span>19</span>       <span>5017</span>         <span>1164</span>               <span>2</span><br>                   seurat_clusters SCT_snn_res.0.1 barcode CTgene CTnt CTaa CTstrict Frequency cloneType highlight<br>AAACCTGAGACAGACC-<span>1</span>               <span>1</span>               <span>1</span>    &lt;<span>NA</span>&gt;   &lt;<span>NA</span>&gt; &lt;<span>NA</span>&gt; &lt;<span>NA</span>&gt;     &lt;<span>NA</span>&gt;        <span>NA</span>      &lt;<span>NA</span>&gt;      &lt;<span>NA</span>&gt;<br>AAACCTGAGCGATAGC-<span>1</span>               <span>0</span>               <span>0</span>    &lt;<span>NA</span>&gt;   &lt;<span>NA</span>&gt; &lt;<span>NA</span>&gt; &lt;<span>NA</span>&gt;     &lt;<span>NA</span>&gt;        <span>NA</span>      &lt;<span>NA</span>&gt;      &lt;<span>NA</span>&gt;<br>AAACCTGAGCGGCTTC-<span>1</span>               <span>1</span>               <span>1</span>    &lt;<span>NA</span>&gt;   &lt;<span>NA</span>&gt; &lt;<span>NA</span>&gt; &lt;<span>NA</span>&gt;     &lt;<span>NA</span>&gt;        <span>NA</span>      &lt;<span>NA</span>&gt;      &lt;<span>NA</span>&gt;<br>AAACCTGAGGATCGCA-<span>1</span>               <span>1</span>               <span>1</span>    &lt;<span>NA</span>&gt;   &lt;<span>NA</span>&gt; &lt;<span>NA</span>&gt; &lt;<span>NA</span>&gt;     &lt;<span>NA</span>&gt;        <span>NA</span>      &lt;<span>NA</span>&gt;      &lt;<span>NA</span>&gt;<br>AAACCTGAGTCACGCC-<span>1</span>               <span>0</span>               <span>0</span>    &lt;<span>NA</span>&gt;   &lt;<span>NA</span>&gt; &lt;<span>NA</span>&gt; &lt;<span>NA</span>&gt;     &lt;<span>NA</span>&gt;        <span>NA</span>      &lt;<span>NA</span>&gt;      &lt;<span>NA</span>&gt;<br>AAACCTGAGTTCGCAT-<span>1</span>               <span>0</span>               <span>0</span>    &lt;<span>NA</span>&gt;   &lt;<span>NA</span>&gt; &lt;<span>NA</span>&gt; &lt;<span>NA</span>&gt;     &lt;<span>NA</span>&gt;        <span>NA</span>      &lt;<span>NA</span>&gt;      &lt;<span>NA</span>&gt;<br>&gt; colorblind_vector &lt;- colorRampPalette(c(<span>"#FF4B20"</span>, <span>"#FFB433"</span>, <span>"#C6FDEC"</span>, <span>"#7AC5FF"</span>, <span>"#0348A6"</span>))<br>&gt; DimPlot(seurat1, group.by = <span>"cloneType"</span>) + scale_color_manual(values = colorblind_vector(<span>5</span>), na.value=<span>"grey"</span>)<br></code></pre><figure><img data-ratio="0.7116200169635284" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAh9mtRgo9WxIQH05icpfQExs4avAmIULicP7RkNwibTJDqDjguVrxCTBrwA/640?wx_fmt=png" data-type="png" data-w="1179" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicmWR8I27KMmQCVMJC9bicAh9mtRgo9WxIQH05icpfQExs4avAmIULicP7RkNwibTJDqDjguVrxCTBrwA/640?wx_fmt=png"><figcaption>img</figcaption></figure><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/E8K16len8Hh6FcIA2NQ6OQ",target="_blank" rel="noopener noreferrer">原文链接</a>
