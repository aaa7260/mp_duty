---
title: "CIBERSORT 免疫浸润"
date: 2023-01-02T12:55:46Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
CIBERSORT 免疫浸润 by 生信星球
------
<div><section data-mpa-powered-by="yiban.io"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第888天</strong></span></span><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="20" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><p><span><span>   </span><span>大神一句话，菜鸟跑半年。我不是大神，但我可以缩短你走弯路的半年~</span></span></p><p><span>   就像歌儿唱的那样，如果你不知道该往哪儿走，就留在这学点生信好不好~</span></p><p><span>   这里有豆豆和花花的学习历程，从新手到进阶，生信路上有你有我!</span><span></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">目前主流的免疫浸润计算方法是CIBERSORT和ssgsea，今天介绍CIBERSORT。</p><h3 data-tool="mdnice编辑器"><span></span><span>1.输入数据要什么</span><span></span></h3><p data-tool="mdnice编辑器">下面这段话摘自CIBERSORT的介绍</p><blockquote data-tool="mdnice编辑器"><p>Importantly, all expression data should be non-negative, devoid of missing values, and represented in non-log linear space.</p><p>For Affymetrix microarrays, a custom chip definition file (CDF) is recommended (see Subheading 3.2.2) and should be normalized with MAS5 or RMA.</p><p>Illumina Beadchip and single color Agilent arrays should be processed as described in the limma package.</p><p>Standard RNA-Seq expression quantification metrics, such as frag- ments per kilobase per million (FPKM) and transcripts per kilobase million (TPM), are suitable for use with CIBERSORT. –《Profiling Tumor Infiltrating Immune Cells with CIBERSORT》</p></blockquote><p data-tool="mdnice编辑器">非常清楚的写出了输入数据的要求：1.不可以有负值和缺失值</p><p data-tool="mdnice编辑器">2.不要取log</p><p data-tool="mdnice编辑器">3.如果是芯片数据，昂飞芯片使用RMA标准化，Illumina 的Beadchip 和Agilent的单色芯片，用limma处理。</p><p data-tool="mdnice编辑器">4.如果是RNA-Seq表达量，使用FPKM和TPM都很合适。</p><p data-tool="mdnice编辑器">芯片的要求可能把你唬住了，GEO常规的表达矩阵都是这样得到的，直接下载使用即可。注意有的表达矩阵下载下来就已经取过log，需要逆转回去。有的经过了标准化或者有负值，需要处理原始数据，前面写过介绍文了。</p><h3 data-tool="mdnice编辑器"><span></span><span>3.来一个示例</span><span></span></h3><p data-tool="mdnice编辑器">找了一个转录组fpkm数据。</p><pre data-tool="mdnice编辑器"><span></span><code>a = read.delim(<span>"GSE201050_4_genes_fpkm_expression.txt.gz"</span>,check.names = F)<br>library(stringr)<br>exp = a[,str_starts(colnames(a),<span>"FPKM"</span>)]<br>k = !duplicated(a<span>$gene_name</span>);table(k)<br><span>## k</span><br><span>## FALSE  TRUE </span><br><span>##  7089 43030</span><br><br>exp = exp[k,]<br>rownames(exp) = unique(a<span>$gene_name</span>)<br>colnames(exp) = str_remove(colnames(exp),<span>"FPKM."</span>)<br>exp[1:4,1:4]<br><span>##             CK_1        CK_2       CK_3      D_2_1</span><br><span>## TSPAN6  1.931311  2.10492200  2.6443970  3.6337456</span><br><span>## TNMD    0.000000  0.03177236  0.0000000  0.0000000</span><br><span>## DPM1   61.199326 60.15538342 63.9972350 67.9992979</span><br><span>## SCYL3   1.218088  1.09913176  0.8558017  0.9523167</span><br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>3.3 做成cibersort要求的输入文件</span><span></span></h4><p data-tool="mdnice编辑器">需要两个输入文件:</p><p data-tool="mdnice编辑器">一个是表达矩阵文件</p><p data-tool="mdnice编辑器">一个是R包里的内置数据LM22.txt，记录了22种免疫细胞的基因表达特征数据。</p><p data-tool="mdnice编辑器">由于读取文件的代码比较粗暴，为了适应它，导出文件之前需要把行名变成一列。不然后面就会有报错。</p><pre data-tool="mdnice编辑器"><span></span><code>library(tidyverse)<br>exp2 = as.data.frame(exp)<br>exp2 = rownames_to_column(exp2)<br>write.table(exp2,file = <span>"exp.txt"</span>,row.names = F,quote = F,sep = <span>"\t"</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>3.4. 运行CIBERSORT</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>f = <span>"ciber_GSE201050.Rdata"</span><br><span>if</span>(!file.exists(f)){<br>  <span>#devtools:: install_github ("Moonerss/CIBERSORT")</span><br>  library(CIBERSORT)<br>  lm22f = system.file(<span>"extdata"</span>, <span>"LM22.txt"</span>, package = <span>"CIBERSORT"</span>)<br>  TME.results = cibersort(lm22f, <br>                        <span>"exp.txt"</span> , <br>                        perm = 1000, <br>                        QN = T)<br>  save(TME.results,file = f)<br>}<br>load(f)<br>TME.results[1:4,1:4]<br><br><span>##       B cells naive B cells memory Plasma cells T cells CD8</span><br><span>## CK_1    0.047478089    0.000000000  0.013099049 0.035400078</span><br><span>## CK_2    0.004488084    0.000000000  0.004812423 0.025224919</span><br><span>## CK_3    0.000000000    0.003064788  0.001037858 0.013915937</span><br><span>## D_2_1   0.003727559    0.000000000  0.000000000 0.001672263</span><br><br>re &lt;- TME.results[,-(23:25)]<br></code></pre><p data-tool="mdnice编辑器">运行有些慢。计算出来的结果包含了22种免疫细胞的丰度，还有三列其他统计量，不管它们。</p><h4 data-tool="mdnice编辑器"><span></span><span>3.5. 经典的免疫细胞丰度热图</span><span></span></h4><p data-tool="mdnice编辑器">那些在一半以上样本里丰度为0的免疫细胞，就不展示在热图里了。我看了一下这个热图，从聚类的情况来看，不同分组之间没有很好的分开。</p><pre data-tool="mdnice编辑器"><span></span><code>library(pheatmap)<br>k &lt;- apply(re,2,<span>function</span>(x) {sum(x == 0) &lt; nrow(TME.results)/2})<br>table(k)<br><br><span>## k</span><br><span>## FALSE  TRUE </span><br><span>##    14     8</span><br><br>re2 &lt;- as.data.frame(t(re[,k]))<br>Group = str_sub(colnames(exp),1,str_length(colnames(exp))-2)<br>table(Group)<br><br><span>## Group</span><br><span>##     CK    D_2    D_3   DP_3 DP_3_1     YS </span><br><span>##      3      3      3      3      3      3</span><br><br>an = data.frame(group = Group,<br>                row.names = colnames(exp))<br>pheatmap(re2,scale = <span>"row"</span>,<br>         show_colnames = F,<br>         cluster_cols = F,<br>         annotation_col = an,<br>         color = colorRampPalette(c(<span>"navy"</span>, <span>"white"</span>, <span>"firebrick3"</span>))(50))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHovEhBPzjSiaNuYnRlVajd9MG8SUibeY1XRMTRDxDgLKsMfQAYcE6qVa0TEECThexq3b0icqE6C7DfbQ/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHovEhBPzjSiaNuYnRlVajd9MG8SUibeY1XRMTRDxDgLKsMfQAYcE6qVa0TEECThexq3b0icqE6C7DfbQ/640?wx_fmt=png"></figure><h4 data-tool="mdnice编辑器"><span></span><span>3.6. 直方图</span><span></span></h4><p data-tool="mdnice编辑器">可以展示出每个样本的免疫细胞比例</p><pre data-tool="mdnice编辑器"><span></span><code>library(RColorBrewer)<br>mypalette &lt;- colorRampPalette(brewer.pal(8,<span>"Set1"</span>))<br><br>dat &lt;- re %&gt;% <br>  as.data.frame() %&gt;%<br>  rownames_to_column(<span>"Sample"</span>) %&gt;% <br>  gather(key = Cell_type,value = Proportion,-Sample) %&gt;% <br>  mutate(group = str_sub(Sample,1,str_length(Sample)-2)) %&gt;% <br>  arrange(group)<br><br>dat<span>$Sample</span> = factor(dat<span>$Sample</span>,ordered = T,levels = unique(dat<span>$Sample</span>)) <span>#定横坐标顺序</span><br><span># 先把group排序，然后将sample设为了因子，确定排序后的顺序为水平，所以两图的顺序是对应的。</span><br><br>dat2 = data.frame(a = 1:ncol(exp),<br>                  b = 1,<br>                  group = Group) <br><br>p1 = ggplot(dat2,aes(x = a, y = b)) + <br>      geom_tile(aes(fill = Group)) + <br>      scale_fill_manual(values = mypalette(22)[1:length(unique(Group))]) +<br>      theme(panel.grid = element_blank(), <br>            panel.background = element_blank(), <br>            axis.line = element_blank(), <br>            axis.ticks = element_blank(), <br>            axis.text = element_blank(), <br>            axis.title = element_blank()) + <br>      scale_x_continuous(expand = c(0, 0)) +<br>      labs(fill = <span>"Group"</span>)<br><br>p2 = ggplot(dat,aes(Sample, Proportion,fill = Cell_type)) + <br>  geom_bar(<span>stat</span> = <span>"identity"</span>) +<br>  labs(fill = <span>"Cell Type"</span>,x = <span>""</span>,y = <span>"Estiamted Proportion"</span>) + <br>  theme_bw() +<br>  theme(<span>#axis.text.x = element_blank(),</span><br>        axis.ticks.x = element_blank()<br>        ) + <br>  scale_y_continuous(expand = c(0.01,0)) +<br>  scale_fill_manual(values = mypalette(22))<br><br>library(patchwork)<br>p1 / p2 + plot_layout(heights = c(1,10),guides = <span>"collect"</span> ) &amp;<br>  theme(legend.position = <span>"bottom"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHovEhBPzjSiaNuYnRlVajd9MicFibIRiavU4mwGIx8LDvpyIhw1bN0c6JFo6DqyvoOykas4MnGRQsZcibw/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHovEhBPzjSiaNuYnRlVajd9MicFibIRiavU4mwGIx8LDvpyIhw1bN0c6JFo6DqyvoOykas4MnGRQsZcibw/640?wx_fmt=png"></figure><h4 data-tool="mdnice编辑器"><span></span><span>3.7 箱线图</span><span></span></h4><p data-tool="mdnice编辑器">展示免疫细胞之间的比较。</p><pre data-tool="mdnice编辑器"><span></span><code>ggplot(dat,aes(Cell_type,Proportion,fill = Cell_type)) + <br>  geom_boxplot() + <br>  theme_bw() + <br>  labs(x = <span>"Cell Type"</span>, y = <span>"Estimated Proportion"</span>) +<br>    theme(axis.text.x = element_blank(),<br>        axis.ticks.x = element_blank(),<br>        legend.position = <span>"bottom"</span>) + <br>  scale_fill_manual(values = mypalette(22))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHovEhBPzjSiaNuYnRlVajd9MCCxJkVwl979OgBfdXM3JZSwpb5iaD1MP0Mnec6knXaJlmplv05xeLsw/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHovEhBPzjSiaNuYnRlVajd9MCCxJkVwl979OgBfdXM3JZSwpb5iaD1MP0Mnec6knXaJlmplv05xeLsw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">每种免疫细胞不同分组的结果做个比较：</p><p data-tool="mdnice编辑器">画出全部在组间差异显著的细胞</p><pre data-tool="mdnice编辑器"><span></span><code><span># 全是0的行去掉</span><br>k = colSums(re)&gt;0;table(k)<br><br><span>## k</span><br><span>## FALSE  TRUE </span><br><span>##     2    20</span><br><br>re = re[,k]<br>library(tinyarray)<br>draw_boxplot(t(re),factor(Group),<br>             drop = T,<br>             color = mypalette(length(unique(Group))))+<br>  labs(x = <span>"Cell Type"</span>, y = <span>"Estimated Proportion"</span>) <br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHovEhBPzjSiaNuYnRlVajd9MO78NBX5j40t5zsfwpiaG4MZgWj7CqibnOINP8kAicmGPicPpoicibW53rCibw/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHovEhBPzjSiaNuYnRlVajd9MO78NBX5j40t5zsfwpiaG4MZgWj7CqibnOINP8kAicmGPicPpoicibW53rCibw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">单画某一个感兴趣的免疫细胞</p><pre data-tool="mdnice编辑器"><span></span><code>dat2 = dat[dat<span>$Cell_type</span>==<span>"Eosinophils"</span>,]<br>library(ggpubr)<br>ggplot(dat2,aes(Group,Proportion,fill = Group)) + <br>  geom_boxplot() + <br>  theme_bw() + <br>  labs(x = <span>"Group"</span>, y = <span>"Estimated Proportion"</span>) +<br>  theme(legend.position = <span>"top"</span>) + <br>  scale_fill_manual(values = mypalette(length(unique(Group))))+ stat_compare_means(aes(group = Group,label = ..p.signif..),method = <span>"kruskal.test"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.714516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHovEhBPzjSiaNuYnRlVajd9MvkYbatvibcSde19lQw9NeZpkLKJPPD5iajVBYJ58iaqiaLM0kqYbF2mLJw/640?wx_fmt=png" data-type="png" data-w="1240" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHovEhBPzjSiaNuYnRlVajd9MvkYbatvibcSde19lQw9NeZpkLKJPPD5iajVBYJ58iaqiaLM0kqYbF2mLJw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">搞掂~</p></section><p><span><br></span></p><section><blockquote><section><span>如果因为代码看不懂，而跟不上正文的节奏，可以来找我，系统学习。我的</span><span>课程都是循环开课。</span><span>下一期的时间，点进去咨询微信咯</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247492627&amp;idx=1&amp;sn=614671537676eece45244aa1cbe94b15&amp;chksm=fdfbac51ca8c25475c71ed3b7b3506391a8d08149acfd62d0666193e382b33634382bef4f80d&amp;scene=21#wechat_redirect" textvalue="产假结束，核酸尚阴，期待遇见2023年的你" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">产假结束，核酸尚阴，期待遇见2023年的你</a><br></section></blockquote></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/p9lHCcW_lOhWG6izLP7WxA",target="_blank" rel="noopener noreferrer">原文链接</a>
