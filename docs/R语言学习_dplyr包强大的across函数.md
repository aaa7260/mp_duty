---
title: "R语言学习：dplyr包强大的across函数"
date: 2023-01-02T08:26:36Z
draft: ["false"]
tags: [
  "fetched",
  "R语言"
]
categories: ["Acdemic"]
---
R语言学习：dplyr包强大的across函数 by R语言
------
<div><p><strong>2023年第1篇文章。</strong><br></p><p>这篇文章分享和总结dplyr包强大的across函数的功能，通过此文，你可以获得<br></p><p>1）across函数知识</p><p>2）across函数应用</p><p><strong>1 across函数</strong><br></p><p>对所选择的列应用函数操作，函数可以是0个、1个或者多个。<br></p><p>across函数的定义和参数说明。<br></p><p><img data-galleryid="" data-ratio="0.4744661095636026" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacs8Kgicn7A1zzNrQMmw8RkMJKQyDeABhGrsFkc4qOzrSRvMAZhkxcQdAZYBGnicWnDYSxR9t3tlRhdw/640?wx_fmt=png" data-type="png" data-w="1077" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacs8Kgicn7A1zzNrQMmw8RkMJKQyDeABhGrsFkc4qOzrSRvMAZhkxcQdAZYBGnicWnDYSxR9t3tlRhdw/640?wx_fmt=png"></p><p><strong>2 across函数应用</strong><br></p><p>通过R语言代码，来说明如何应用across函数。<br></p><p>第一步：加载R包</p><section><ul><li><li><li><li><li></ul><pre data-lang="bash"><code><span>library(pacman)</span></code><code><span>p_load(</span></code><code><span>  dplyr,   <span># 数据管理包</span></span></code><code><span>  readr    <span># 数据读写包</span></span></code><code><span>)</span></code></pre></section><p>第二步：导入数据集</p><section><ul><li><li><li><li></ul><pre data-lang="nginx"><code><span><span>ac_items</span> &lt;- read_csv(<span>"./raw_data/items.csv"</span>)</span></code><code><span>dim(ac_items)</span></code><code><span>names(ac_items)</span></code><code><span>ac_items</span></code></pre></section><p>第三步：across函数应用<br></p><p><strong>应用1</strong><br></p><p>1）想了解不同类型下列sell_value和buy_value的均值<br></p><p>以往解决方案</p><section><ul><li><li><li><li><li><li></ul><pre data-lang="properties"><code><span><span>ac_items</span> <span>%&gt;%</span></span></code><code><span>  <span>group_by(category)</span> <span>%&gt;%</span></span></code><code><span>  <span>summarise(</span></span></code><code><span>    <span>sell_value</span> = <span>mean(sell_value, na.rm=TRUE),</span></span></code><code><span>    <span>buy_value</span> = <span>mean(buy_value, na.rm=TRUE)</span></span></code><code><span>  <span>)</span></span></code></pre></section><p>现在解决方案（使用across函数）</p><section><ul><li><li><li><li><li></ul><pre data-lang="nginx"><code><span><span>ac_items</span> %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  summarise(</span></code><code><span>    across(c(sell_value, buy_value), mean, na.rm=TRUE)</span></code><code><span>  )</span></code></pre></section><p><img data-galleryid="" data-ratio="0.630057803468208" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacs8Kgicn7A1zzNrQMmw8RkMJdol8KWNMegjWSjpt34RSudOju52AdI7nibwbsqHjpVD6G98OcRqCUZQ/640?wx_fmt=png" data-type="png" data-w="519" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacs8Kgicn7A1zzNrQMmw8RkMJdol8KWNMegjWSjpt34RSudOju52AdI7nibwbsqHjpVD6G98OcRqCUZQ/640?wx_fmt=png"></p><p>函数操作这块，可以使用我们熟悉的常用函数，也可以使用purrr包的函数式编程风格，即 ~和.x设计和构建函数。<br></p><section><ul><li><li><li><li><li></ul><pre data-lang="nginx"><code><span><span>ac_items</span> %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  mutate(across(c(sell_value, buy_value), <span>~ .x</span> / max(.x, na.rm = TRUE),</span></code><code><span>                .names = <span>"{col}_prop"</span>)) %&gt;%</span></code><code><span>  <span>select</span>(category, ends_with(<span>"prop"</span>))</span></code></pre></section><p><strong>应用2</strong><br></p><p>修改列名，通过across函数的参数.names配置，基于glue的语法方式<br></p><section><ul><li><li><li></ul><pre data-lang="nginx"><code><span><span>ac_items</span> %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  summarise(across(c(sell_value, buy_value), mean, na.rm = TRUE, .names = <span>"{col}_mean"</span>))</span></code></pre></section><p><strong>应用3</strong></p><p>多函数操作，对所选择列，采用多个函数进行处理。<br></p><section><ul><li><li><li><li></ul><pre data-lang="php"><code><span>tems %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  summarise(across(c(sell_value, buy_value),</span></code><code><span>                   <span>list</span>(mean = mean, sd = sd), na.rm = <span>TRUE</span>, .names = <span>"{col}_{fn}"</span>))</span></code></pre></section><p><strong>应用4</strong><br></p><p>所需列的选择，可以采用dplyr包关于列选择的知识。</p><p>例如：</p><p>1）contains函数选择列</p><section><ul><li><li><li><li></ul><pre data-lang="nginx"><code><span><span>ac_items</span> %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  summarise(across(contains(<span>"value"</span>), mean, na.rm = TRUE, .names = <span>"{col}_"</span>))</span></code><code><span><br></span></code></pre></section><p>2）where函数和is_系列函数组合选择列</p><section><ul><li><li><li></ul><pre data-lang="cs"><code><span>ac_items %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  summarise(across(<span>where</span>(<span>is</span>.numeric), mean, na.rm = TRUE, .names = <span>"{col}_"</span>))</span></code></pre></section><p><strong>应用5</strong><br></p><p>across函数综合应用，构建自定义函数<br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>summarizer &lt;- <span><span>function</span><span>(data, numeric_cols = NULL, ...)</span> </span>{</span></code><code><span>  data %&gt;%</span></code><code><span>    group_by(...) %&gt;%</span></code><code><span>    summarise(across({{numeric_cols}}, <span>list</span>(</span></code><code><span>      mean = ~mean(.x, na.rm = <span>TRUE</span>),</span></code><code><span>      sd = ~sd(.x, na.rm = <span>TRUE</span>),</span></code><code><span>      q05 = ~quantile(.x, <span>0.05</span>, na.rm = <span>TRUE</span>),</span></code><code><span>      q95 = ~quantile(.x, <span>0.95</span>, na.rm = <span>TRUE</span>)</span></code><code><span>    ), .names = <span>"{col}_{fn}"</span>))</span></code><code><span>}</span></code><code><span><br></span></code><code><span>summarizer(ac_items, numeric_cols = c(sell_value, buy_value),</span></code><code><span>           category)</span></code></pre></section><p><img data-galleryid="" data-ratio="0.5700737618545838" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacs8Kgicn7A1zzNrQMmw8RkMJViaW93YG59JZMbTm0wT6ibPia0KlKzPtKvSjuEF1ZPXp5C5EzbxJHGUWw/640?wx_fmt=png" data-type="png" data-w="949" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacs8Kgicn7A1zzNrQMmw8RkMJViaW93YG59JZMbTm0wT6ibPia0KlKzPtKvSjuEF1ZPXp5C5EzbxJHGUWw/640?wx_fmt=png"></p><p>dplyr包across函数功能强大，掌握它，可以提升数据加工和管理的效率。</p><p>此文，完整代码</p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span><span># 加载R包 ----</span></span></code><code><span>library(pacman)</span></code><code><span>p_load(</span></code><code><span>  dplyr,   <span># 数据管理包</span></span></code><code><span>  readr    <span># 数据读写包</span></span></code><code><span>)</span></code><code><span><br></span></code><code><span><span># 导入数据集 ----</span></span></code><code><span>ac_items &lt;- read_csv(<span>"./raw_data/items.csv"</span>)</span></code><code><span>dim(ac_items)</span></code><code><span>names(ac_items)</span></code><code><span>ac_items</span></code><code><span><br></span></code><code><span><span># 统计分析 ----</span></span></code><code><span><span>## 1）均值分析 ----</span></span></code><code><span>ac_items %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  summarise(</span></code><code><span>    sell_value = mean(sell_value, na.rm=<span>TRUE</span>),</span></code><code><span>    buy_value = mean(buy_value, na.rm=<span>TRUE</span>)</span></code><code><span>  )</span></code><code><span><br></span></code><code><span>ac_items %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  summarise(</span></code><code><span>    across(c(sell_value, buy_value), mean, na.rm=<span>TRUE</span>)</span></code><code><span>  )</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>## 2) 使用lambda函数 ----</span></span></code><code><span><span># purrr 函数式编程</span></span></code><code><span><br></span></code><code><span>ac_items %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  mutate(across(c(sell_value, buy_value), ~ .x / max(.x, na.rm = <span>TRUE</span>),</span></code><code><span>                .names = <span>"{col}_prop"</span>)) %&gt;%</span></code><code><span>  select(category, ends_with(<span>"prop"</span>)) </span></code><code><span><br></span></code><code><span><span># 修改列名 ----</span></span></code><code><span>ac_items %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  summarise(across(c(sell_value, buy_value), mean, na.rm = <span>TRUE</span>, .names = <span>"{col}_mean"</span>))</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span># 多函数操作 ----</span></span></code><code><span>ac_items %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  summarise(across(c(sell_value, buy_value),</span></code><code><span>                   <span>list</span>(mean = mean, sd = sd), na.rm = <span>TRUE</span>, .names = <span>"{col}_{fn}"</span>))</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span># 列名匹配方法 ----</span></span></code><code><span><span># 使用tidyselect</span></span></code><code><span><br></span></code><code><span>ac_items %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  summarise(across(contains(<span>"value"</span>), mean, na.rm = <span>TRUE</span>, .names = <span>"{col}_"</span>))</span></code><code><span><br></span></code><code><span>ac_items %&gt;%</span></code><code><span>  group_by(category) %&gt;%</span></code><code><span>  summarise(across(where(is.numeric), mean, na.rm = <span>TRUE</span>, .names = <span>"{col}_"</span>))</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span># across函数与自定义函数融合 ----</span></span></code><code><span><span># 实现更强大功能</span></span></code><code><span>summarizer &lt;- <span><span>function</span><span>(data, numeric_cols = NULL, ...)</span> </span>{</span></code><code><span>  data %&gt;%</span></code><code><span>    group_by(...) %&gt;%</span></code><code><span>    summarise(across({{numeric_cols}}, <span>list</span>(</span></code><code><span>      mean = ~mean(.x, na.rm = <span>TRUE</span>),</span></code><code><span>      sd = ~sd(.x, na.rm = <span>TRUE</span>),</span></code><code><span>      q05 = ~quantile(.x, <span>0.05</span>, na.rm = <span>TRUE</span>),</span></code><code><span>      q95 = ~quantile(.x, <span>0.95</span>, na.rm = <span>TRUE</span>)</span></code><code><span>    ), .names = <span>"{col}_{fn}"</span>))</span></code><code><span>}</span></code><code><span><br></span></code><code><span>summarizer(ac_items, numeric_cols = c(sell_value, buy_value),</span></code><code><span>           category) %&gt;% View</span></code></pre></section><hr><p><strong>我是谁？</strong></p><p>我叫王路情，是一名数据科学家，同时，也是一名讲师。<br></p><p>我通过公众号、知乎等网络媒体，向大众传播和分享<strong>R语言和数据科学</strong>的知识。到目前为止，受众已经超过5万人。<br></p><p><span>虽说数据科学家的主要工作帮助客户利用好数据，但我不太喜欢墨守成规。</span></p><p><span><span>我认为“数据创造价值”应该是数据科学家的首要任务。我通过各种途径向世人传播数据科学知识，就是希望帮助更多客户用好数据。</span></span></p><p><span><span>请多多关照。</span></span></p><hr><p><span><span></span></span></p><p><strong><span><span>我的R语言社群？</span></span></strong><span><span></span></span></p><p><span><span>我创建了多个R语言社群，聚焦于R语言和数据科学的讨论、交流和分享。<br></span></span></p><p><span><span>这些R语言社群受众2500+人，来自各行各业，大家都在使用R语言解决问题。</span></span></p><p><span><span>欢迎大家加入我的R语言社群，我的微信</span></span><strong>luqin360，</strong>加我时，请备注：<strong>姓名-入群</strong><span>。</span></p><p><img data-galleryid="" data-ratio="1.0117096018735363" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacvbB8IDOtGuRAWrlvv7O30vwqDtkQD7lSvqPWbVYXzobmd0G0EqO8v3LfP5YSwsB3AvaAtSLZsVvw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="427" src="https://mmbiz.qpic.cn/mmbiz_png/pMPbyicMFiacvbB8IDOtGuRAWrlvv7O30vwqDtkQD7lSvqPWbVYXzobmd0G0EqO8v3LfP5YSwsB3AvaAtSLZsVvw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/F7vYh6uarqAQj-E9aFlAOg",target="_blank" rel="noopener noreferrer">原文链接</a>
