---
title: "单细胞注释复写（二）: human colorectal"
date: 2022-08-30T04:57:03Z
draft: ["false"]
tags: [
  "fetched",
  "Biomamba 生信基地"
]
categories: ["Acdemic"]
---
单细胞注释复写（二）: human colorectal by Biomamba 生信基地
------
<div><section data-support="96编辑器" data-style-id="35163"><section><h1><span><strong>写在前面：</strong></span></h1><section><img data-ratio="0.6349206349206349" data-src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgEPt6jo0gEwibQzFX4zmOqqiaM9bZyTy3bIjLJcicVlkUFwFvyicJx8wR2ZslWiaBicM4nw9AtyQ7k7ugA/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-type="gif" data-w="63" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgEPt6jo0gEwibQzFX4zmOqqiaM9bZyTy3bIjLJcicVlkUFwFvyicJx8wR2ZslWiaBicM4nw9AtyQ7k7ugA/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section><section><section><section><mp-common-profile data-index="0" data-id="MzAwMzIzOTk5OQ==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpzyQpcoEQKDb6ic0Dia8dFR0tfmNm2u0eJfmhJzN3Jjh0jmmTycIeJdu7XMxu6Fvz8jicsKmH2S4MvOQ/0?wx_fmt=png&amp;wx_head=1" data-nickname="Biomamba 生信基地" data-alias="" data-signature="本人为在读博士研究生，此公众号旨在分享生信知识及科研经验与体会，欢迎各位同学、老师与专家的批评指正，也欢迎各界人士的合作与交流。" data-origin_num="177" data-is_biz_ban="0" data-isban="0" data-from="2"></mp-common-profile></section><section><span>我反复的谈过，</span><span>细胞类型注释</span><span>才是单细胞测序中</span><span>最难</span><span>的环节，这主要是不同单细胞测序项目中的<strong>取样形式</strong>、<strong>建库方法</strong>、<strong>测序平台</strong>、<strong>分析工具</strong>、<strong>函数参数</strong>等多方面因素造成的。拿笔者的第一个单细胞数据集来说，光是调整过滤参数、分辨率、寻找marker加以注释就花了</span><span>一个月</span><span>的时间，属实是既枯燥又乏味，为了给大家提供方便，以后会</span><span>不定期</span><span>带领大家复现一些已发表数据集中的细胞类型注释过程，有需要的同学可以持续关注，若有</span><span>感兴趣的物种、组织器官</span><span>也可以在文末客服处登记；当然，如果您有好的注释结果，也欢迎以<strong>Rmarkdown</strong>与工程文件Rdata的形式来稿，可以为大家提供</span><span>稿费</span><span>。</span></section><section><span>注释后的数据：</span><br></section><p><span>https://pan.baidu.com/s/1yZjOF_CVQKG8mXP00N2LTQ?pwd=4eer </span></p><p><img data-galleryid="" data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ImlBFVOwwpzwbrtZTjHQun2lmQ0zyEDhyLaIhqYhDic5B25GgibsEF7LREvYx4lA8duSicPmic4dnpSLVgiazqQVKmg/640?wx_fmt=jpeg" data-type="png" data-w="280" src="https://mmbiz.qpic.cn/mmbiz_jpg/ImlBFVOwwpzwbrtZTjHQun2lmQ0zyEDhyLaIhqYhDic5B25GgibsEF7LREvYx4lA8duSicPmic4dnpSLVgiazqQVKmg/640?wx_fmt=jpeg"></p><p><br></p><section><br></section><section><span>大家拿到这个数据后，可以load()上图中的rdata文件后参考这个教程(文中的</span><span>方法三</span><span>与</span><span>方法四</span><span>)对自己手中</span><span>合适的</span><span>数据加以注释：</span></section><section><span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247488597&amp;idx=1&amp;sn=6123d348db245774d4a0db4134a839d4&amp;chksm=9b3f6d05ac48e4132f92ca6c32dab29d2a4e1eb00d1db3b6e10eba7ffc7154e8554a70938583&amp;scene=21#wechat_redirect" textvalue="手把手教你做单细胞测序数据分析（五）——细胞类型注释" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">手把手教你做单细胞测序数据分析（五）——细胞类型注释</a></span></section></section></section></section></section><section><section><section><br></section></section><h1><span><strong>往期回归：</strong></span></h1><section data-support="96编辑器" data-style-id="35163"><section><section><img data-ratio="0.6349206349206349" data-src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgEPt6jo0gEwibQzFX4zmOqqiaM9bZyTy3bIjLJcicVlkUFwFvyicJx8wR2ZslWiaBicM4nw9AtyQ7k7ugA/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-type="gif" data-w="63" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgEPt6jo0gEwibQzFX4zmOqqiaM9bZyTy3bIjLJcicVlkUFwFvyicJx8wR2ZslWiaBicM4nw9AtyQ7k7ugA/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section><section><section><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247490504&amp;idx=1&amp;sn=0066b2b33067cedb9d1c28689a53faab&amp;chksm=9b3f6298ac48eb8e12cdc7bdd6263e5feb9039f549f7b9dbf4e258854ee61476d09f702f1447&amp;scene=21#wechat_redirect" textvalue="单细胞注释复写(一):Human Fetal Kidney" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞注释复写(一):Human Fetal Kidney</a><span></span></p></section></section></section></section><section data-width="100%"><br></section></section><section><h1><span><strong>本期复现过程：</strong></span></h1></section><section data-support="96编辑器" data-style-id="35163"><section><section><img data-ratio="0.6349206349206349" data-src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgEPt6jo0gEwibQzFX4zmOqqiaM9bZyTy3bIjLJcicVlkUFwFvyicJx8wR2ZslWiaBicM4nw9AtyQ7k7ugA/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-type="gif" data-w="63" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgEPt6jo0gEwibQzFX4zmOqqiaM9bZyTy3bIjLJcicVlkUFwFvyicJx8wR2ZslWiaBicM4nw9AtyQ7k7ugA/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section><section><section><p><br></p><p><span><strong><span>一、基本信息</span></strong></span><span></span></p><p><br></p><p><strong><span>1. 原文标题</span></strong></p><p><span>Lineage-dependent gene expression programs influence the immune landscape of colorectal cancer.</span></p><p><strong><span>2. </span></strong><strong><span>文章链接</span></strong></p><p><span>https://pubmed.ncbi.nlm.nih.gov/32451460/</span></p><p><strong><span>3. 物</span></strong><strong><span>种</span></strong></p><p>human colorectal</p><p><strong><span>4.</span></strong> <strong><span>GSE编号链接</span></strong></p><p><span>https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE132465</span></p><p><strong><span>5. 细胞类型</span></strong></p><p><span><span>来自23个直肠癌患者和10个对照的粘膜组织</span></span></p><p><span><strong>6. metadata</strong></span></p><p><span>细胞类型注释信息由文章作者提供</span></p><p><br></p></section></section></section></section><section><p><br></p><p><br></p><section><section data-support="96编辑器" data-style-id="35163"><section><section><img data-ratio="0.6349206349206349" data-src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgEPt6jo0gEwibQzFX4zmOqqiaM9bZyTy3bIjLJcicVlkUFwFvyicJx8wR2ZslWiaBicM4nw9AtyQ7k7ugA/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-type="gif" data-w="63" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgEPt6jo0gEwibQzFX4zmOqqiaM9bZyTy3bIjLJcicVlkUFwFvyicJx8wR2ZslWiaBicM4nw9AtyQ7k7ugA/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section><section><section><section><br></section><p><span><strong><span>二、数据处</span></strong></span><span><strong><span>理</span></strong></span></p><p><br></p><p><span></span><strong><span>s</span></strong><strong><span>tep0：加载R包</span></strong></p><section><ul><li></ul><pre data-lang=""><code><span>library(Seurat)</span></code></pre></section><section><ul><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># Attaching SeuratObject</span></span></code><code><span><span>#</span><span># Attaching sp</span></span></code></pre></section><section><ul><li></ul><pre><code><span>library(dplyr)</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># </span></span></code><code><span><span>#</span><span># Attaching package: 'dplyr'</span></span></code><code><span><span>#</span><span># The following objects are masked from 'package:stats':</span></span></code><code><span><span>#</span><span># </span></span></code><code><span><span>#</span><span>#     filter, lag</span></span></code><code><span><span>#</span><span># The following objects are masked from 'package:base':</span></span></code><code><span><span>#</span><span># </span></span></code><code><span><span>#</span><span>#     intersect, setdiff, setequal, union</span></span></code></pre></section><section><ul><li><li></ul><pre><code><span>library(ggplot2)</span></code><code><span>library(harmony)</span></code></pre></section><section><ul><li></ul><pre data-lang="shell"><code><span><span>#</span><span># Loading required package: Rcpp</span></span></code></pre></section><section><ul><li></ul><pre><code><span>library(monocle)<strong><span></span></strong></span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># Loading required package: Matrix</span></span></code><code><span><span>#</span><span># Loading required package: Biobase</span></span></code><code><span><span>#</span><span># Loading required package: BiocGenerics</span></span></code><code><span><span>#</span><span># </span></span></code><code><span><span>#</span><span># Attaching package: 'BiocGenerics'</span></span></code><code><span><span>#</span><span># The following objects are masked from 'package:dplyr':</span></span></code><code><span><span>#</span><span># </span></span></code><code><span><span>#</span><span>#     combine, intersect, setdiff, union</span></span></code><code><span><span>#</span><span># The following objects are masked from 'package:stats':</span></span></code><code><span><span>#</span><span># </span></span></code><code><span><span>#</span><span>#     IQR, mad, sd, var, xtabs</span></span></code><code><span><span>#</span><span># The following objects are masked from 'package:base':</span></span></code><code><span><span>#</span><span># </span></span></code><code><span><span>#</span><span>#     anyDuplicated, append, as.data.frame, basename, cbind, colnames,</span></span></code><code><span><span>#</span><span>#     dirname, do.call, duplicated, eval, evalq, Filter, Find, get, grep,</span></span></code><code><span><span>#</span><span>#     grepl, intersect, is.unsorted, lapply, Map, mapply, match, mget,</span></span></code><code><span><span>#</span><span>#     order, paste, pmax, pmax.int, pmin, pmin.int, Position, rank,</span></span></code><code><span><span>#</span><span>#     rbind, Reduce, rownames, sapply, setdiff, sort, table, tapply,</span></span></code><code><span><span>#</span><span>#     union, unique, unsplit, which.max, which.min</span></span></code><code><span><span>#</span><span># Welcome to Bioconductor</span></span></code><code><span><span>#</span><span># </span></span></code><code><span><span>#</span><span>#     Vignettes contain introductory material; view with</span></span></code><code><span><span>#</span><span>#     'browseVignettes()'. To cite Bioconductor, see</span></span></code><code><span><span>#</span><span>#     'citation("Biobase")', and for packages 'citation("pkgname")'.</span></span></code><code><span><span>#</span><span># Loading required package: VGAM</span></span></code><code><span><span>#</span><span># Loading required package: stats4</span></span></code><code><span><span>#</span><span># Loading required package: splines</span></span></code><code><span><span>#</span><span># Loading required package: DDRTree</span></span></code><code><span><span>#</span><span># Loading required package: irlba</span></span></code></pre></section><section><ul><li><li></ul><pre data-lang="css"><code><span><span>library</span>(<span>readxl</span>)</span></code><code><span><span>library</span>(<span>data</span><span>.table</span>)</span></code></pre></section><section><ul><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># </span></span></code><code><span><span>#</span><span># Attaching package: 'data.table'</span></span></code><code><span><span>#</span><span># The following objects are masked from 'package:dplyr':</span></span></code><code><span><span>#</span><span># </span></span></code><code><span><span>#</span><span>#     between, first, last</span></span></code></pre></section><section><ul><li><li><li></ul><pre data-lang="cs"><code><span>library(readxl)</span></code><code><span><br></span></code><code><span><span>set</span>.seed(<span>20222202</span>)</span></code></pre></section><p><strong><span></span></strong></p><p><strong><span><br></span></strong></p><p><strong><span>step1：数</span></strong><strong><span>据读入</span></strong></p><section><ul><li><li><li><li><li></ul><pre data-lang="nginx"><code><span><span># 上述GEO链接下载counts数据及注释文件: 解压</span></span></code><code><span><br></span></code><code><span><span># 读取注释文件（复制粘贴到名为cell_anno的表格中）</span></span></code><code><span><span>cell_anno</span> &lt;- read_excel(<span>"cell_anno.xlsx"</span>)</span></code><code><span>head(cell_anno)</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># # A tibble: 6 × 6</span></span></code><code><span><span>#</span><span>#   Index                    Patient Class Sample  Cell_type        Cell_subtype</span></span></code><code><span><span>#</span><span>#   &lt;chr&gt;                    &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;            &lt;chr&gt;       </span></span></code><code><span><span>#</span><span># 1 SMC01-T_AAACCTGCATACGCCG SMC01   Tumor SMC01-T Epithelial cells CMS2        </span></span></code><code><span><span>#</span><span># 2 SMC01-T_AAACCTGGTCGCATAT SMC01   Tumor SMC01-T Epithelial cells CMS2        </span></span></code><code><span><span>#</span><span># 3 SMC01-T_AAACCTGTCCCTTGCA SMC01   Tumor SMC01-T Epithelial cells CMS2        </span></span></code><code><span><span>#</span><span># 4 SMC01-T_AAACGGGAGGGAAACA SMC01   Tumor SMC01-T Epithelial cells CMS2        </span></span></code><code><span><span>#</span><span># 5 SMC01-T_AAACGGGGTATAGGTA SMC01   Tumor SMC01-T Epithelial cells CMS2        </span></span></code><code><span><span>#</span><span># 6 SMC01-T_AAAGATGAGGCCGAAT SMC01   Tumor SMC01-T Epithelial cells CMS2</span></span></code></pre></section><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>cell_anno &lt;- <span>as</span>.data.frame(cell_anno)</span></code><code><span>rownames(cell_anno) &lt;- cell_anno$Index</span></code><code><span>cell_anno$Index &lt;- <span>NULL</span></span></code><code><span><br></span></code><code><span><span># 读取counts文件</span></span></code><code><span>counts &lt;- fread(<span>"./GSE132465_GEO_processed_CRC_10X_raw_UMI_count_matrix.txt.gz"</span>)</span></code><code><span>head(counts[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>])</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span>#       Index SMC01-T_AAACCTGCATACGCCG SMC01-T_AAACCTGGTCGCATAT</span></span></code><code><span><span>#</span><span># 1:     A1BG                        0                        0</span></span></code><code><span><span>#</span><span># 2: A1BG-AS1                        0                        0</span></span></code><code><span><span>#</span><span># 3:     A1CF                        0                        2</span></span></code><code><span><span>#</span><span># 4:      A2M                        0                        0</span></span></code><code><span><span>#</span><span>#    SMC01-T_AAACCTGTCCCTTGCA</span></span></code><code><span><span>#</span><span># 1:                        0</span></span></code><code><span><span>#</span><span># 2:                        0</span></span></code><code><span><span>#</span><span># 3:                        0</span></span></code><code><span><span>#</span><span># 4:                        0</span></span></code></pre></section><section><ul><li><li><li><li></ul><pre data-lang="php"><code><span>counts &lt;- <span>as</span>.data.frame(counts)</span></code><code><span>rownames(counts) &lt;- counts$Index</span></code><code><span>counts$Index &lt;- <span>NULL</span></span></code><code><span>head(counts[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>])</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span>#          SMC01-T_AAACCTGCATACGCCG SMC01-T_AAACCTGGTCGCATAT</span></span></code><code><span><span>#</span><span># A1BG                            0                        0</span></span></code><code><span><span>#</span><span># A1BG-AS1                        0                        0</span></span></code><code><span><span>#</span><span># A1CF                            0                        2</span></span></code><code><span><span>#</span><span># A2M                             0                        0</span></span></code><code><span><span>#</span><span>#          SMC01-T_AAACCTGTCCCTTGCA SMC01-T_AAACGGGAGGGAAACA</span></span></code><code><span><span>#</span><span># A1BG                            0                        0</span></span></code><code><span><span>#</span><span># A1BG-AS1                        0                        0</span></span></code><code><span><span>#</span><span># A1CF                            0                        0</span></span></code><code><span><span>#</span><span># A2M                             0                        0</span></span></code></pre></section><p><br></p><p><strong><span>step2：创建seurat对象</span></strong></p><section><ul><li></ul><pre data-lang="xml"><code><span>sce <span>&lt;<span>-</span> <span>CreateSeuratObject</span>(<span>counts</span> = <span>counts)</span></span></span></code></pre></section><section><ul><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># Warning: Feature names cannot have underscores ('_'), replacing with dashes</span></span></code><code><span><span>#</span><span># ('-')</span></span></code></pre></section><section><ul><li><li><li><li></ul><pre data-lang="nginx"><code><span><span>## 添加细胞注释文件</span></span></code><code><span><span>sce</span> &lt;- AddMetaData(sce,metadata = cell_anno)</span></code><code><span><br></span></code><code><span>head(sce@meta.data)</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span>#                          orig.ident nCount_RNA nFeature_RNA Patient Class</span></span></code><code><span><span>#</span><span># SMC01-T_AAACCTGCATACGCCG    SMC01-T      38052         4866   SMC01 Tumor</span></span></code><code><span><span>#</span><span># SMC01-T_AAACCTGGTCGCATAT    SMC01-T      33750         5268   SMC01 Tumor</span></span></code><code><span><span>#</span><span># SMC01-T_AAACCTGTCCCTTGCA    SMC01-T       7356         1714   SMC01 Tumor</span></span></code><code><span><span>#</span><span># SMC01-T_AAACGGGAGGGAAACA    SMC01-T       3752         1229   SMC01 Tumor</span></span></code><code><span><span>#</span><span># SMC01-T_AAACGGGGTATAGGTA    SMC01-T      23991         3914   SMC01 Tumor</span></span></code><code><span><span>#</span><span># SMC01-T_AAAGATGAGGCCGAAT    SMC01-T      15662         3319   SMC01 Tumor</span></span></code><code><span><span>#</span><span>#                           Sample        Cell_type Cell_subtype</span></span></code><code><span><span>#</span><span># SMC01-T_AAACCTGCATACGCCG SMC01-T Epithelial cells         CMS2</span></span></code><code><span><span>#</span><span># SMC01-T_AAACCTGGTCGCATAT SMC01-T Epithelial cells         CMS2</span></span></code><code><span><span>#</span><span># SMC01-T_AAACCTGTCCCTTGCA SMC01-T Epithelial cells         CMS2</span></span></code><code><span><span>#</span><span># SMC01-T_AAACGGGAGGGAAACA SMC01-T Epithelial cells         CMS2</span></span></code><code><span><span>#</span><span># SMC01-T_AAACGGGGTATAGGTA SMC01-T Epithelial cells         CMS2</span></span></code><code><span><span>#</span><span># SMC01-T_AAAGATGAGGCCGAAT SMC01-T Epithelial cells         CMS2</span></span></code></pre></section><section><ul><li><li><li></ul><pre data-lang="nginx"><code><span><span>#--------------------------------- 5. 看看数据质量 -----------------------------</span></span></code><code><span><span>sce</span> &lt;- PercentageFeatureSet(sce,pattern = <span>'^MT-'</span>,col.name = <span>'percent.mt'</span>)</span></code><code><span>fivenum(sce@meta.data$percent.mt)</span></code></pre></section><section><ul><li></ul><pre data-lang="css"><code><span>## <span>[1]</span>  0<span>.000000</span>  2<span>.894388</span>  4<span>.518072</span>  7<span>.434139</span> 19<span>.995095</span></span></code></pre></section><section><ul><li></ul><pre data-lang="css"><code><span><span>head</span>(<span>sce</span>@<span>meta</span>.<span>data</span>)</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span>#                          orig.ident nCount_RNA nFeature_RNA Patient Class</span></span></code><code><span><span>#</span><span># SMC01-T_AAACCTGCATACGCCG    SMC01-T      38052         4866   SMC01 Tumor</span></span></code><code><span><span>#</span><span># SMC01-T_AAACCTGGTCGCATAT    SMC01-T      33750         5268   SMC01 Tumor</span></span></code><code><span><span>#</span><span># SMC01-T_AAACCTGTCCCTTGCA    SMC01-T       7356         1714   SMC01 Tumor</span></span></code><code><span><span>#</span><span># SMC01-T_AAACGGGAGGGAAACA    SMC01-T       3752         1229   SMC01 Tumor</span></span></code><code><span><span>#</span><span># SMC01-T_AAACGGGGTATAGGTA    SMC01-T      23991         3914   SMC01 Tumor</span></span></code><code><span><span>#</span><span># SMC01-T_AAAGATGAGGCCGAAT    SMC01-T      15662         3319   SMC01 Tumor</span></span></code><code><span><span>#</span><span>#                           Sample        Cell_type Cell_subtype percent.mt</span></span></code><code><span><span>#</span><span># SMC01-T_AAACCTGCATACGCCG SMC01-T Epithelial cells         CMS2  12.921791</span></span></code><code><span><span>#</span><span># SMC01-T_AAACCTGGTCGCATAT SMC01-T Epithelial cells         CMS2   8.761481</span></span></code><code><span><span>#</span><span># SMC01-T_AAACCTGTCCCTTGCA SMC01-T Epithelial cells         CMS2  19.711800</span></span></code><code><span><span>#</span><span># SMC01-T_AAACGGGAGGGAAACA SMC01-T Epithelial cells         CMS2   9.541578</span></span></code><code><span><span>#</span><span># SMC01-T_AAACGGGGTATAGGTA SMC01-T Epithelial cells         CMS2  17.314826</span></span></code><code><span><span>#</span><span># SMC01-T_AAAGATGAGGCCGAAT SMC01-T Epithelial cells         CMS2   7.278764</span></span></code></pre></section><section><ul><li><li><li></ul><pre data-lang="cs"><code><span><span># 可视化基因和UMI(可以看到作者已经对基因进行了过滤: &lt; 6000)</span></span></code><code><span>features &lt;- c(<span>'nCount_RNA'</span>,<span>'nFeature_RNA'</span>)</span></code><code><span>VlnPlot(sce,features = features,pt.size = <span>0</span>,<span>group</span>.<span>by</span> = <span>'orig.ident'</span>)&amp;NoLegend()&amp;labs(x = <span>''</span>)&amp;theme(axis.text.x = element_text(angle = <span>90</span>,hjust = <span>1</span>,vjust = <span>0.5</span>))</span></code></pre></section><p><br></p><p><br></p><p><img data-ratio="0.375" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCE23cib1hMJm5iby1WhwjMwutf1WDD4WJNn3YuibtqjHPjZT9lZmSkiaAIw/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCE23cib1hMJm5iby1WhwjMwutf1WDD4WJNn3YuibtqjHPjZT9lZmSkiaAIw/640?wx_fmt=png"></p><span></span><p><br></p><section><ul><li><li><li></ul><pre data-lang="cs"><code><span><span># 可视化线粒体基因(可以看到作者已经对线粒体基因进行了过滤: &lt; 20%)</span></span></code><code><span>features &lt;- c(<span>'percent.mt'</span>)</span></code><code><span>VlnPlot(sce,features = features,pt.size = <span>0</span>,<span>group</span>.<span>by</span> = <span>'orig.ident'</span>)&amp;NoLegend()&amp;labs(x = <span>''</span>)&amp;theme(axis.text.x = element_text(angle = <span>90</span>,hjust = <span>1</span>,vjust = <span>0.5</span>))</span></code></pre></section><p><br></p><p><img data-ratio="0.375" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCIylPYoibm0hiaNrMSao07JDM4D4hmhwwGRv16tbFIArgLDiar643UYtQQ/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCIylPYoibm0hiaNrMSao07JDM4D4hmhwwGRv16tbFIArgLDiar643UYtQQ/640?wx_fmt=png"></p><section><ul><li></ul><pre data-lang="shell"><code><span><span>#</span> save(sce,file = <span>'sce.RData'</span>)</span></code></pre></section><p><br></p><p><strong><span>step3：降维聚类</span></strong></p><section><ul><li><li><li><li><li></ul><pre data-lang="objectivec"><code><span><span># 因为作者已经进行了质控，所以接下来我们直接进行降维聚类</span></span></code><code><span>sce &lt;- NormalizeData(sce) %&gt;% </span></code><code><span>  FindVariableFeatures() %&gt;% </span></code><code><span>  ScaleData() %&gt;%</span></code><code><span>  RunPCA(npcs = <span>50</span>)</span></code></pre></section><span>‍</span><section><ul><li></ul><pre data-lang="shell"><code><span><span>#</span><span># Centering and scaling data matrix</span></span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># PC_ 1 </span></span></code><code><span><span>#</span><span># Positive:  CALD1, COL6A2, IGFBP7, COL1A2, SPARC, C1R, C1S, COL3A1, COL6A1, COL1A1 </span></span></code><code><span><span>#</span><span>#     LUM, NNMT, DCN, FSTL1, THY1, MMP2, RARRES2, PCOLCE, FBLN1, SERPING1 </span></span></code><code><span><span>#</span><span>#     EFEMP2, PRKCDBP, SERPINF1, AEBP1, MYL9, MEG3, COL6A3, IGFBP4, CTSK, BGN </span></span></code><code><span><span>#</span><span># Negative:  CD69, LTB, CCL5, TRBC1, AREG, KLRB1, GZMA, EPCAM, TSPAN8, NKG7 </span></span></code><code><span><span>#</span><span>#     ALOX5AP, CLDN3, CD24, CD27, GPX2, CEACAM5, CLDN4, LGALS4, GZMB, KRT18 </span></span></code><code><span><span>#</span><span>#     GPR183, SFN, KRT19, KRT8, MISP, CD79A, TNFRSF18, FERMT1, PERP, CD8A </span></span></code><code><span><span>#</span><span># PC_ 2 </span></span></code><code><span><span>#</span><span># Positive:  EPCAM, KRT18, KRT8, CEACAM5, CLDN3, KRT19, TSPAN8, LGALS4, CLDN4, CD24 </span></span></code><code><span><span>#</span><span>#     FXYD3, SFN, AGR2, S100A14, GPRC5A, S100P, PRSS3, TFF3, S100A16, CEACAM6 </span></span></code><code><span><span>#</span><span>#     MAL2, PERP, GPX2, PHLDA2, FHL2, MUC13, MISP, GDF15, MGST1, ATP1B1 </span></span></code><code><span><span>#</span><span># Negative:  VIM, CD74, HLA-DPB1, GPR183, HLA-DPA1, S100A4, CD69, RGS2, ALOX5AP, ITGB2 </span></span></code><code><span><span>#</span><span>#     HLA-DQA1, IGKC, TYROBP, HLA-DRA, HLA-DRB1, FCER1G, CCL5, HLA-DQB1, CCL4, LGALS1 </span></span></code><code><span><span>#</span><span>#     HLA-DRB5, CD83, BCL2A1, AIF1, LST1, CCL3, LTB, IGHA1, TRBC1, CCL4L2 </span></span></code><code><span><span>#</span><span># PC_ 3 </span></span></code><code><span><span>#</span><span># Positive:  FCER1G, TYROBP, AIF1, CXCL8, IL1B, LYZ, CD68, CTSB, PLAUR, CD14 </span></span></code><code><span><span>#</span><span>#     FCGR2A, S100A9, MS4A7, SOD2, G0S2, MS4A6A, CCL3, CXCL2, C1QA, CCL3L3 </span></span></code><code><span><span>#</span><span>#     C1QB, LST1, C1QC, C15orf48, SPI1, BCL2A1, CTSL, C5AR1, IL1RN, PLEK </span></span></code><code><span><span>#</span><span># Negative:  IGHA1, JCHAIN, CD69, TRBC1, KLRB1, IGHA2, FKBP11, CD27, LTB, GZMA </span></span></code><code><span><span>#</span><span>#     MZB1, IGKC, CCL5, IGLC2, DERL3, CD79A, IGLC3, AL928768.3, CD8A, HOPX </span></span></code><code><span><span>#</span><span>#     CTSW, TNFRSF18, NKG7, TNFRSF17, GZMB, PRF1, PIM2, GZMK, SPINK2, KLRD1 </span></span></code><code><span><span>#</span><span># PC_ 4 </span></span></code><code><span><span>#</span><span># Positive:  LUM, DCN, FBLN1, CTSK, SERPINF1, C1S, COL1A2, PCOLCE, MFAP4, RARRES2 </span></span></code><code><span><span>#</span><span>#     MEG3, COL6A3, COL1A1, SFRP2, OLFML3, COL3A1, C1R, CCDC80, ISLR, C3 </span></span></code><code><span><span>#</span><span>#     THBS2, VCAN, EMILIN1, AEBP1, MXRA8, SPON2, LOXL1, CFD, EFEMP1, MRC2 </span></span></code><code><span><span>#</span><span># Negative:  PLVAP, RAMP2, ECSCR.1, ADGRL4, CLEC14A, RAMP3, VWF, ESAM, CLDN5, PCAT19 </span></span></code><code><span><span>#</span><span>#     CDH5, CYYR1, MMRN2, PECAM1, EMCN, ADGRF5, TM4SF18, FAM167B, FLT1, EGFL7 </span></span></code><code><span><span>#</span><span>#     CD34, BCAM, KDR, PODXL, JAM2, MYCT1, ROBO4, PTPRB, APLNR, CXorf36 </span></span></code><code><span><span>#</span><span># PC_ 5 </span></span></code><code><span><span>#</span><span># Positive:  CTHRC1, BGN, TAGLN, SULF1, COL11A1, POSTN, LOXL2, COL5A2, COL12A1, THBS2 </span></span></code><code><span><span>#</span><span>#     FAP, COL10A1, GJB2, ADAMTS12, PODNL1, PRRX1, PLPP4, MFAP2, COL5A1, MMP11 </span></span></code><code><span><span>#</span><span>#     CDH11, NOTCH3, TNC, TPM2, ACTA2, WNT2, BMP1, INHBA, PALLD, ANTXR1 </span></span></code><code><span><span>#</span><span># Negative:  ADH1B, CFD, SFRP1, SCARA5, ABCA8, TNXB, PLAC9, GPX3, OGN, CXCL12 </span></span></code><code><span><span>#</span><span>#     LINC01082, EFEMP1, TCF21, PTN, MFAP4, PLPP3, CADM3, SEPP1, C16orf89, ADAMDEC1 </span></span></code><code><span><span>#</span><span>#     MATN2, GSN, DPT, LTBP4, PCOLCE2, ABI3BP, COL14A1, CP, HAPLN1, PI16</span></span></code></pre></section><section><ul><li></ul><pre><code><span>ElbowPlot(sce,ndims = 50)</span></code></pre></section><p><strong></strong></p><p><strong></strong></p><p><strong><img data-galleryid="" data-ratio="0.7138888888888889" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCtJibnkNb88Q3n5cd4Q26oC5IT27knPRVKjkIiabCDBKkxsXticgxvTN3Q/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCtJibnkNb88Q3n5cd4Q26oC5IT27knPRVKjkIiabCDBKkxsXticgxvTN3Q/640?wx_fmt=png"></strong></p><section><ul><li><li><li><li></ul><pre data-lang="properties"><code><span><span>sce_ha</span> <span>&lt;- sce</span></span></code><code><span><br></span></code><code><span><span># 不整合看效果</span></span></code><code><span><span>sce</span> <span>&lt;- RunUMAP(sce,dims = 1:30)</span></span></code></pre></section></section><section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># Warning: The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric</span></span></code><code><span><span>#</span><span># To use Python UMAP via reticulate, set umap.method to 'umap-learn' and metric to 'correlation'</span></span></code><code><span><span>#</span><span># This message will be shown once per session</span></span></code><code><span><span>#</span><span># 19:22:04 UMAP embedding parameters a = 0.9922 b = 1.112</span></span></code><code><span><span>#</span><span># 19:22:04 Read 63689 rows and found 30 numeric columns</span></span></code><code><span><span>#</span><span># 19:22:04 Using Annoy for neighbor search, n_neighbors = 30</span></span></code><code><span><span>#</span><span># 19:22:04 Building Annoy index with metric = cosine, n_trees = 50</span></span></code><code><span><span>#</span><span># 0%   10   20   30   40   50   60   70   80   90   100%</span></span></code><code><span><span>#</span><span># [----|----|----|----|----|----|----|----|----|----|</span></span></code><code><span><span>#</span><span># **************************************************|</span></span></code><code><span><span>#</span><span># 19:22:23 Writing NN index file to temp file /tmp/RtmpP1MXxN/file836ad2566262b</span></span></code><code><span><span>#</span><span># 19:22:23 Searching Annoy index using 1 thread, search_k = 3000</span></span></code><code><span><span>#</span><span># 19:23:04 Annoy recall = 100%</span></span></code><code><span><span>#</span><span># 19:23:06 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30</span></span></code><code><span><span>#</span><span># 19:23:16 Initializing from normalized Laplacian + noise (using irlba)</span></span></code><code><span><span>#</span><span># 19:23:53 Commencing optimization for 200 epochs, with 2907208 positive edges</span></span></code><code><span><span>#</span><span># 19:25:00 Optimization finished</span></span></code></pre></section><p><strong></strong></p><section><ul><li><li><li><li></ul><pre data-lang="cs"><code><span><span># save(sce,file = 'sce_no_har.Rdata')</span></span></code><code><span><br></span></code><code><span>DimPlot(sce,<span>group</span>.<span>by</span> = <span>'orig.ident'</span>,split.<span>by</span> = <span>'orig.ident'</span>,ncol = <span>5</span>) + NoLegend() + NoAxes()</span></code><code><span><br></span></code></pre></section><p><br></p><p><img data-galleryid="" data-ratio="0.7138888888888889" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCHYAQm0pZGv6JlEmkhwPX7XNfbFfiat3BXuvE993J0YgWNcF9JearGuQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCHYAQm0pZGv6JlEmkhwPX7XNfbFfiat3BXuvE993J0YgWNcF9JearGuQ/640?wx_fmt=png"></p><br><p><br></p><section><ul><li></ul><pre data-lang="cs"><code><span>DimPlot(sce,<span>group</span>.<span>by</span> = <span>'Cell_type'</span>,split.<span>by</span> = <span>'Class'</span>) + NoAxes()</span></code></pre></section><p><strong></strong></p><p><strong><br></strong></p><p><strong></strong></p><p><strong><img data-galleryid="" data-ratio="0.7138888888888889" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCDQNVOqIJS85v5wib3SmccgtXZZia8zsct5etsD25ic4AIRfS5cqKtfS1A/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCDQNVOqIJS85v5wib3SmccgtXZZia8zsct5etsD25ic4AIRfS5cqKtfS1A/640?wx_fmt=png"></strong></p><strong><br></strong><p><br></p><section><ul><li><li></ul><pre data-lang="cs"><code><span><span># harmony整合</span></span></code><code><span>sce &lt;- RunHarmony(sce_ha,<span>group</span>.<span>by</span>.vars = <span>'orig.ident'</span>,plot_convergence = T,project.dim = F)</span></code></pre></section><p><strong></strong></p><section><ul><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># Harmony 1/10</span></span></code><code><span><span>#</span><span># Harmony 2/10</span></span></code><code><span><span>#</span><span># Harmony 3/10</span></span></code><code><span><span>#</span><span># Harmony 4/10</span></span></code><code><span><span>#</span><span># Harmony 5/10</span></span></code><code><span><span>#</span><span># Harmony converged after 5 iterations</span></span></code></pre></section><p><strong></strong></p><p><strong></strong></p><p><strong><img data-galleryid="" data-ratio="0.7138888888888889" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPC8NhJuQX1VZfMyUqMpiaPpLbOvzibLZ2oqzI6C3NsFKibqooCcbFrSvoibw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPC8NhJuQX1VZfMyUqMpiaPpLbOvzibLZ2oqzI6C3NsFKibqooCcbFrSvoibw/640?wx_fmt=png"></strong></p><p><br></p><section><ul><li><li></ul><pre data-lang="nginx"><code><span><span># 降维聚类</span></span></code><code><span><span>sce</span> &lt;- RunUMAP(sce,dims = <span>1</span>:<span>30</span>,reduction = <span>'harmony'</span>)</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># 19:39:30 UMAP embedding parameters a = 0.9922 b = 1.112</span></span></code><code><span><span>#</span><span># 19:39:30 Read 63689 rows and found 30 numeric columns</span></span></code><code><span><span>#</span><span># 19:39:30 Using Annoy for neighbor search, n_neighbors = 30</span></span></code><code><span><span>#</span><span># 19:39:30 Building Annoy index with metric = cosine, n_trees = 50</span></span></code><code><span><span>#</span><span># 0%   10   20   30   40   50   60   70   80   90   100%</span></span></code><code><span><span>#</span><span># [----|----|----|----|----|----|----|----|----|----|</span></span></code><code><span><span>#</span><span># **************************************************|</span></span></code><code><span><span>#</span><span># 19:39:52 Writing NN index file to temp file /tmp/RtmpP1MXxN/file836ad408b4f2a</span></span></code><code><span><span>#</span><span># 19:39:52 Searching Annoy index using 1 thread, search_k = 3000</span></span></code><code><span><span>#</span><span># 19:40:37 Annoy recall = 100%</span></span></code><code><span><span>#</span><span># 19:40:39 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30</span></span></code><code><span><span>#</span><span># 19:40:50 Initializing from normalized Laplacian + noise (using irlba)</span></span></code><code><span><span>#</span><span># 19:41:38 Commencing optimization for 200 epochs, with 2998222 positive edges</span></span></code><code><span><span>#</span><span># 19:43:05 Optimization finished</span></span></code></pre></section><section><ul><li><li><li><li><li><li></ul><pre data-lang="cs"><code><span><span># save(sce,file = 'sce_har.Rdata')</span></span></code><code><span><br></span></code><code><span>my9color &lt;- c(<span>'#5470c6'</span>,<span>'#91cc75'</span>,<span>'#fac858'</span>,<span>'#ee6666'</span>,<span>'#73c0de'</span>,<span>'#3ba272'</span>,<span>'#fc8452'</span>,<span>'#9a60b4'</span>,<span>'#ea7ccc'</span>)</span></code><code><span><br></span></code><code><span><span># total umap</span></span></code><code><span>DimPlot(sce,<span>group</span>.<span>by</span> = <span>'Cell_type'</span>,cols = my9color)  + NoAxes() + theme(plot.title = element_blank())</span></code></pre></section><p><strong></strong></p><p><br></p><p><strong></strong></p><p><strong><img data-galleryid="" data-ratio="0.7138888888888889" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCQXZDboZTe1M78qgiaZ7KdmhS244VBGib85hBAhgGtcKAjRp5kpqv7f2w/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCQXZDboZTe1M78qgiaZ7KdmhS244VBGib85hBAhgGtcKAjRp5kpqv7f2w/640?wx_fmt=png"></strong></p><p><br></p><section><ul><li><li></ul><pre data-lang="cs"><code><span><span># indi</span></span></code><code><span>DimPlot(sce,<span>group</span>.<span>by</span> = <span>'orig.ident'</span>)  + NoAxes() + theme(plot.title = element_blank())</span></code></pre></section><p><strong></strong></p><p><strong></strong></p><p><strong><img data-galleryid="" data-ratio="0.7138888888888889" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCniamibWhFHYLswibFStKst7vbEgxOm6HfjiaovvBMka2OrcsoHNgsoUO3Q/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCniamibWhFHYLswibFStKst7vbEgxOm6HfjiaovvBMka2OrcsoHNgsoUO3Q/640?wx_fmt=png"></strong></p><strong><br></strong><p><br></p><section><ul><li><li></ul><pre data-lang="cs"><code><span><span># Class</span></span></code><code><span>DimPlot(sce,<span>group</span>.<span>by</span> = <span>'Class'</span>,cols = c(<span>'#80b9df'</span>,<span>'#fe8180'</span>))  + NoAxes() + theme(plot.title = element_blank())</span></code></pre></section><p><strong></strong></p><p><strong></strong></p><p><strong><img data-galleryid="" data-ratio="0.7138888888888889" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCsZViadfApumtogo9ql5wCyYS89ibNGop8FficQN7nxyQpNvgK7f96w7ng/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCsZViadfApumtogo9ql5wCyYS89ibNGop8FficQN7nxyQpNvgK7f96w7ng/640?wx_fmt=png"></strong></p><strong><br></strong><p><br></p><section><ul><li></ul><pre data-lang="cs"><code><span>DimPlot(sce,<span>group</span>.<span>by</span> = <span>'Class'</span>,split.<span>by</span> = <span>'Class'</span>,cols = c(<span>'#80b9df'</span>,<span>'#fe8180'</span>))  + NoAxes() + theme(plot.title = element_blank())</span></code></pre></section><p><strong></strong></p><p><strong><br></strong></p><p><strong></strong></p><p><strong><img data-galleryid="" data-ratio="0.7138888888888889" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCEFLbLOtTDEGJicG2NHjsryvWfPE4pQicRAqXYriaX8kJFYSLicL7zRbwfA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCEFLbLOtTDEGJicG2NHjsryvWfPE4pQicRAqXYriaX8kJFYSLicL7zRbwfA/640?wx_fmt=png"></strong></p><strong><br></strong><p><br></p><section><ul><li><li></ul><pre data-lang="cs"><code><span><span># Class_celltype</span></span></code><code><span>DimPlot(sce,<span>group</span>.<span>by</span> = <span>'Cell_type'</span>,split.<span>by</span> = <span>'Class'</span>,cols = my9color)  + NoAxes() + theme(plot.title = element_blank())</span></code></pre></section><p><strong></strong></p><p><strong></strong></p><p><strong><img data-galleryid="" data-ratio="0.7138888888888889" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCaOb6TTpXyl1cjHDibXbX1OFJwlib97vS4cJBWeqyPQ8eEXgDKO92kvaQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCaOb6TTpXyl1cjHDibXbX1OFJwlib97vS4cJBWeqyPQ8eEXgDKO92kvaQ/640?wx_fmt=png"></strong></p><p><br></p><p><br></p><p><strong><span></span></strong></p><p><strong><span>step4：</span></strong><strong><span>计算并可视化各个cluster的top基</span></strong><strong><span>因</span></strong></p><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># 大类</span></span></code><code><span><br></span></code><code><span>library(readr)</span></code><code><span>big_top10 &lt;- read.csv('./big_top10.csv')</span></code><code><span><span>#</span> Idents(sce) &lt;- sce<span>$Cell_type</span></span></code><code><span><span>#</span> marker_big &lt;- FindAllMarkers(sce,logfc.threshold = 0.5,only.pos = T)</span></code><code><span><span>#</span> write.csv(marker_big,<span>'marker_big.csv'</span>)</span></code><code><span><span>#</span> big_top10 &lt;- marker_big %&gt;% group_by(cluster) %&gt;% top_n(10,avg_log2FC)</span></code><code><span><span>#</span> write.csv(big_top10,<span>'big_top10.csv'</span>)</span></code></pre></section><section><ul><li><li><li></ul><pre data-lang="nginx"><code><span><span>## 大类top10可视化</span></span></code><code><span><br></span></code><code><span><span>sce_big</span> &lt;- ScaleData(sce,features = big_top10<span>$gene</span>)</span></code></pre></section><section><ul><li></ul><pre data-lang="shell"><code><span><span>#</span><span># Centering and scaling data matrix</span></span></code></pre></section><section><ul><li></ul><pre data-lang="cs"><code><span>p &lt;- DoHeatmap(subset(sce_big,downsample = <span>100</span>),features = <span>as</span>.character(unique(big_top10$gene)), <span>group</span>.<span>by</span> = <span>"Cell_type"</span>, assay = <span>"RNA"</span>,<span>group</span>.colors = c(<span>"#C77CFF"</span>,<span>"#7CAE00"</span>,<span>"#00BFC4"</span>,<span>"#F8766D"</span>,<span>"#AB82FF"</span>,<span>"#90EE90"</span>)) +  scale_fill_gradientn(colors = c(<span>"navy"</span>,<span>"white"</span>,<span>"firebrick3"</span>))</span></code></pre></section><section><ul><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># Scale for 'fill' is already present. Adding another scale for 'fill', which</span></span></code><code><span><span>#</span><span># will replace the existing scale.</span></span></code></pre></section><section><ul><li></ul><pre><code><span>p</span></code></pre></section><p><br></p><p><img data-galleryid="" data-ratio="1.3333333333333333" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCibDH9ALyibQ494wgEe8SxicLLhPev1lUF0wibOlia3XEdeT4omT7icWbTu0g/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCibDH9ALyibQ494wgEe8SxicLLhPev1lUF0wibOlia3XEdeT4omT7icWbTu0g/640?wx_fmt=png"></p><p><br></p><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># 小类</span></span></code><code><span>library(readr)</span></code><code><span>small_top10 &lt;- read.csv('./small_big_top10.csv')</span></code><code><span><span>#</span> Idents(sce) &lt;- sce<span>$Cell_subtype</span></span></code><code><span><span>#</span> marker_small &lt;- FindAllMarkers(sce,logfc.threshold = 0.5,only.pos = T)</span></code><code><span><span>#</span> write.csv(marker_small,<span>'marker_small.csv'</span>)</span></code><code><span><span>#</span> small_top10 &lt;- marker_small %&gt;% group_by(cluster) %&gt;% top_n(10,avg_log2FC)</span></code><code><span><span>#</span> write.csv(small_top10,<span>'small_big_top10.csv'</span>)</span></code></pre></section><section><ul><li><li></ul><pre data-lang="nginx"><code><span><span>## 小类top10可视化</span></span></code><code><span><span>sce_small</span> &lt;- ScaleData(sce,features = small_top10<span>$gene</span>)</span></code></pre></section><section><ul><li></ul><pre data-lang="shell"><code><span><span>#</span><span># Centering and scaling data matrix</span></span></code></pre></section><section><ul><li></ul><pre data-lang="cs"><code><span>p &lt;- DoHeatmap(subset(sce_small,downsample = <span>100</span>),features = <span>as</span>.character(unique(small_top10$gene)), <span>group</span>.<span>by</span> = <span>"Cell_subtype"</span>, assay = <span>"RNA"</span>) + scale_fill_gradientn(colors = c(<span>"navy"</span>,<span>"white"</span>,<span>"firebrick3"</span>))  + NoLegend()</span></code></pre></section><section><ul><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span># Scale for 'fill' is already present. Adding another scale for 'fill', which</span></span></code><code><span><span>#</span><span># will replace the existing scale.</span></span></code></pre></section><section><ul><li></ul><pre data-lang="javascript"><code><span>ggsave(<span>'heatmap_small.pdf'</span>,width = <span>49</span>,height = <span>49</span>,dpi = <span>500</span>)</span></code></pre></section><p><img data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCmQOwFMov5fWRdqA1EZpq9lyMN9f7iaRWCS3GHzGFJgFn5VuLjJvY3rw/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpyicsCUOjIUZRGFgYrTT0EPCmQOwFMov5fWRdqA1EZpq9lyMN9f7iaRWCS3GHzGFJgFn5VuLjJvY3rw/640?wx_fmt=png"></p><p><br></p></section></section></section></section></section><p><br></p><section><br></section><p><br></p><section><section><section data-support="96编辑器" data-style-id="27326"><section><section><section><section><section><p><br></p><section><section data-support="96编辑器" data-style-id="34887"><section><section><section><img data-ratio="0.8372093023255814" data-type="png" data-w="86" data-width="100%" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWjsU2VMXgI8TRjfwVeo0Aj4EiaLjQXteia730VKnC0j8Tkgu6hkTs7ZO0JRFyw8riaczdNlQQKsOnfIQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWjsU2VMXgI8TRjfwVeo0Aj4EiaLjQXteia730VKnC0j8Tkgu6hkTs7ZO0JRFyw8riaczdNlQQKsOnfIQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></section><section><section><section><p>如何联系我们</p></section></section></section></section></section></section><p><br></p></section><section data-support="96编辑器" data-style-id="34892"><section><section><section><section><img data-ratio="1.1627906976744187" data-type="gif" data-w="43" data-src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWjsU2VMXgI8TRjfwVeo0Aj4z284kwxMryKUBLBbNicjxYMDvWxmosNGHmIW66jtmJuia0pe51q8hFzQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWjsU2VMXgI8TRjfwVeo0Aj4z284kwxMryKUBLBbNicjxYMDvWxmosNGHmIW66jtmJuia0pe51q8hFzQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section></section></section><section><section><section><section>公众号后台中消息更新不及时，超过48h后便不允许回复读者消息，这里给大家留一下领取资料、免费服务器的<span><strong>微信号</strong></span>，方便大家随时交流、提建议（由助理接待）。此外呼声一直很高的<span>交流群</span>也建好了，欢迎大家入群讨论：</section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247490936&amp;idx=1&amp;sn=850dfc45b10a6bd538c81cfbf1d7af37&amp;chksm=9b3f6428ac48ed3e4199dbfdec2fce4324d3226af19e335b8e5c0143cf8f0881667e36074d83&amp;scene=21#wechat_redirect" textvalue="永久免费的千人生信、科研交流群" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">永久免费的千人生信、科研交流群</a><br></section><section><br></section><section><span>大家可以阅读完这几篇之后添加</span></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247484685&amp;idx=1&amp;sn=3b47c0bcad97a265650b5f34c00a6a3c&amp;chksm=9b3f7c5dac48f54be9cde50ab7a1147c55a36b980ffa0e721c02c05cbb88fef41a8fbc13d599&amp;scene=21#wechat_redirect" textvalue="笑一笑也就算了" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">笑一笑也就算了</a></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247488966&amp;idx=1&amp;sn=9e9e7659b4cf00ac3173d21e88e1602b&amp;chksm=9b3f6c96ac48e580efe53f966430f6598785e5c5c6bcc20f5eef019e723e49baaaea6d73fb7b&amp;scene=21#wechat_redirect" textvalue="如何搜索公众号过往发布内容" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">如何搜索公众号过往发布内容</a><br></section><p><img data-galleryid="" data-ratio="1.2464962901896126" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ImlBFVOwwpyUNnHOn8es4zIE8EU8PJ0wRtpDqO03bR2TecVjskmGmoY0DVzyDjOycE4xHrfx7dw4HFSO7JhEgQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="jpeg" data-w="1213" src="https://mmbiz.qpic.cn/mmbiz_jpg/ImlBFVOwwpyUNnHOn8es4zIE8EU8PJ0wRtpDqO03bR2TecVjskmGmoY0DVzyDjOycE4xHrfx7dw4HFSO7JhEgQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p></section></section></section></section></section></section></section></section></section></section></section></section></section><section><br></section></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/lHG1F5Pmkixfkxi80M8D2w",target="_blank" rel="noopener noreferrer">原文链接</a>
