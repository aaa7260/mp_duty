---
title: "将CNV数据处理成TCGA的格式"
date: 2024-01-25T09:52:38Z
draft: ["false"]
tags: [
  "fetched",
  "生信那些事"
]
categories: ["Acdemic"]
---
将CNV数据处理成TCGA的格式 by 生信那些事
------
<div><p>最近自己处理了一下CNV的数据，想要记录一下。</p><p>Somatic CNV 分析工具目前已经有多种了。目前常见有 GATK4 CNV、FACETS、Sequenza，ASCAT等。使用GISTIC工具可以寻找多个样品中，发生CNV的Fragments。</p><p>GISTIC默认输出<span>all_lesions.conf_*.txt、amp_genes.conf_*.txt和del_genes.conf_*.txt</span>等文件。这些文件可以被maftools读取并进行后续分析。然而，无数人被误导，以为导入这批数据后，得到的基因既是CNV基因。我自己在分析一批突变数据后，跟cBioportal上TCGA结果进行比较，最终发现先前对GISTIC输出的结果理解有误，并找到了GISTIC CNV基因汇总结果的正确打开方式。</p><h1>cBioportal是这样展示CNA基因的</h1><p><img data-galleryid="" data-ratio="0.8636363636363636" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVowicOq23rAOwJsxpUPK8LwZqnEIRbJgAibsyJOZTMEcDDPuUFSzqrJYQ/640?wx_fmt=png" data-type="png" data-w="528" src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVowicOq23rAOwJsxpUPK8LwZqnEIRbJgAibsyJOZTMEcDDPuUFSzqrJYQ/640?wx_fmt=png"></p><p>注意基因右侧加圈的G，这些基因就说GISTIC的到的拷贝数变异显著区间内的基因。然而，若用这些区间内的基因并不能直接视为CNV变化的全部基因。例如，在该数据集中，肺鳞癌常见的PIK3CA扩增，就没有在CNV Peak中，但PIK3CA扩增在该组数据集中出现频率颇高。</p><p>cBioportal处理TCGA数据时，是这样判定CNV结果的：</p><p>For TCGA studies, the table in allthresholded.bygenes.txt (which is the part of the GISTIC output that is used to determine the copy-number status of each gene in each sample in cBioPortal) is obtained by applying both low- and high-level thresholds to to the gene copy levels of all the samples.</p><p>所以就开始在服务器上面安装GISTIC软件<br></p><section><ul><li><li><li></ul><pre data-lang="ruby"><code><span>mkdir GISTIC</span></code><code><span>wget -c <span>ftp:</span>/<span>/ftp.broadinstitute.org/pub</span><span>/GISTIC2.0/</span>GISTIC_2_0_23.tar.gz</span></code><code><span>tar zxvf GISTIC_2_0_23.tar.gz</span></code></pre></section><p>然后就能得到这样的目录<br></p><p><img data-galleryid="" data-ratio="0.30849478390462" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJV0yAgne9pRFf1aA7FibBLsVicsibpqcb3PAJMLvrI0SMzntt9vVTbGYV2Q/640?wx_fmt=png" data-type="png" data-w="671" src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJV0yAgne9pRFf1aA7FibBLsVicsibpqcb3PAJMLvrI0SMzntt9vVTbGYV2Q/640?wx_fmt=png"></p><h3>安装MCR_Installer</h3><p><strong>因为GISTIC软件是一个MATLAB程序</strong>，在Linux环境下运行需要MCR_Installer。matlab毕竟是收费软件，而且是有界面的。虽然搞生物信息的都用R和linux替代了MATLAB，但是很多高大上的单位，比如大名鼎鼎的broadinstitute，仍然是用matlab的，所以他们开发的程序也会以matlab代码的形式发布。但是考虑到大多研究者用不起matlab，或者不会用，所以就用linux系统里面安装matlab运行环境来解决这个问题，我们仍然可以把人家写的matlab程序，在linux命令行下面，当做一个脚本来运行！</p><p>我们前面下载的GISTIC软件离线包里面是有一个  MCR_Installer 文件夹，里面就有 MCR_Installer压缩包可以解压然后安装。</p><section><ul><li><li><li><li><li></ul><pre data-lang="properties"><code><span><span>cd</span> <span>MCR_Installer</span></span></code><code><span><span>unzip</span> <span>MCRInstaller.zip </span></span></code><code><span><span>chmod</span> <span>744 installer_input.txt</span></span></code><code><span><span>./install</span> <span>-mode silent -agreeToLicense yes -destinationFolder /home/imp/GISTIC/MATLAB_Compiler_Runtime/</span></span></code><code><span><span># 注意，最后选项填入的路径需要是绝对路径</span></span></code></pre></section><p><span>安装过程会有一个</span><strong>简单的log日志</strong><span>，需要留意一下，最后出现下面的话语代表成功安装：</span></p><p><img data-galleryid="" data-ratio="0.15522388059701492" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVOknibHO6O2PVzjicSk6VyBWvTtcqpmWibGfYGoKYiaxUxLuak14LB7xEaQ/640?wx_fmt=png" data-type="png" data-w="670" src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVOknibHO6O2PVzjicSk6VyBWvTtcqpmWibGfYGoKYiaxUxLuak14LB7xEaQ/640?wx_fmt=png"></p><p><span>我自己安装好以后没有及时做下自己跑出来的结果记录，用了一个别人的，但是几乎是一致的，只是时间不一样。</span><br></p><p><span><br></span></p><p><strong><span>接下来我们按照要求设置这些变量</span></strong></p><section><ul><li><li></ul><pre data-lang="bash"><code><span><span>echo</span> <span>"export XAPPLRESDIR=/home/imp/GISTIC/MATLAB_Compiler_Runtime/v83/X11/app-defaults:\$XAPPLRESDIR"</span> &gt;&gt; ~/.bashrc</span></code><code><span><span>source</span> ~/.bashrc</span></code></pre></section><p><strong></strong><span>LD_LIBRARY_PATH</span><span> 按照相应的格式设定即可。</span></p><h3>运行GISTIC示例文件：</h3><section><ul><li><li></ul><pre data-lang="bash"><code><span><span>cd</span> ../</span></code><code><span>./run_gistic_example</span></code></pre></section><p><span></span><strong><span>run_gistic_example的代码为：</span></strong></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span><span>#!/bin/sh</span></span></code><code><span><span>## run example GISTIC analysis</span></span></code><code><span><br></span></code><code><span><span>## output directory</span></span></code><code><span><span>echo</span> --- creating output directory ---</span></code><code><span>basedir=`<span>pwd</span>`/CNV_FACETS</span></code><code><span>mkdir -p <span>$basedir</span> </span></code><code><span><br></span></code><code><span><span>echo</span> --- running GISTIC ---</span></code><code><span><span>## input file definitions</span></span></code><code><span>segfile=`<span>pwd</span>`/examplefiles/segmentationfile.txt</span></code><code><span>markersfile=`<span>pwd</span>`/examplefiles/markersfile.txt</span></code><code><span>refgenefile=`<span>pwd</span>`/refgenefiles/hg16.mat</span></code><code><span>alf=`<span>pwd</span>`/examplefiles/arraylistfile.txt</span></code><code><span>cnvfile=`<span>pwd</span>`/examplefiles/cnvfile.txt</span></code><code><span><span>## call script that sets MCR environment and calls GISTIC executable </span></span></code><code><span>./gistic2 -b <span>$basedir</span> -seg <span>$segfile</span> -mk <span>$markersfile</span> -refgene <span>$refgenefile</span> -alf <span>$alf</span> -cnv <span>$cnvfile</span> -genegistic 1 -smallmem 1 -broad 1 -brlen 0.5 -conf 0.90 -armpeel 1 -savegene 1 -gcm extreme</span></code></pre></section><p><span></span><span>在上面的这一串代码中我们主要准备好：basedir，文件输出的地方，segfile输入的文件，refgenefile参考基因组。</span></p><p><strong><span>参考基因，在GISTIC文件夹里面有</span></strong><br></p><p><img data-galleryid="" data-ratio="0.4105263157894737" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVicVf9I8CNF3icRzndPxlLKoLsjOzw1hKWicVmqJkzFWtAxAQjEnTL5npw/640?wx_fmt=png" data-type="png" data-w="380" src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVicVf9I8CNF3icRzndPxlLKoLsjOzw1hKWicVmqJkzFWtAxAQjEnTL5npw/640?wx_fmt=png"></p><p><span>选择适合自己的就好<br></span></p><p><span>然后输出文件夹自己设置放置的地方<br></span></p><p><span>最关键的就是这个输入文件，输入文件我们可以直接参考GISTIC文件夹里面的GISTICDocumentation_standalone.htm这个网页上的内容，相应的网址我放在下面</span></p><section><ul><li></ul><pre data-lang="ruby"><code><span><span>ftp:</span>/<span>/ftp.broadinstitute.org/pub</span><span>/GISTIC2.0/</span>GISTICDocumentation_standalone.htm</span></code></pre></section><p><span></span><strong><span>最最关键的是</span></strong></p><p><img data-galleryid="" data-ratio="0.30134932533733133" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVk7ibxLpDqvNkrVAiaSRmpxkUdI50vicbHTQYuhkxXxlUtLicU8K99zhOOw/640?wx_fmt=png" data-type="png" data-w="667" src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVk7ibxLpDqvNkrVAiaSRmpxkUdI50vicbHTQYuhkxXxlUtLicU8K99zhOOw/640?wx_fmt=png"></p><p><strong><span>关键是这个第六列的值需要怎么弄<br></span></strong></p><p><strong><span>参考的是：</span></strong><span><br></span></p><section><ul><li></ul><pre data-lang="ruby"><code><span><span>https:</span>/<span>/github.com/mskcc</span><span>/facets/issues</span><span>/84</span></span></code></pre></section><p><span></span><strong><span>log2(median(TCN))-1<br></span></strong></p><p><strong><span>在GISTIC文章中也有说到这边的值应该用总的拷贝数变异的中位数进行计算</span></strong><br></p><p><img data-galleryid="" data-ratio="0.4669902912621359" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVGAzmUTfTch2lD8sIQ59UIJ5lhGNaDQziaCVicaicNQxdtFmUiaDKIQBicHw/640?wx_fmt=png" data-type="png" data-w="1030" src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVGAzmUTfTch2lD8sIQ59UIJ5lhGNaDQziaCVicaicNQxdtFmUiaDKIQBicHw/640?wx_fmt=png"></p><p><br></p><p><strong><span>整理完的数据是这样的：</span></strong><br></p><p><img data-galleryid="" data-ratio="0.6631016042780749" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVzzicl5KwiaAa3aSrFciaN46mfPRJP7A16JhQYJ7x5mTTaicHqSUmfFcHSg/640?wx_fmt=png" data-type="png" data-w="561" src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVzzicl5KwiaAa3aSrFciaN46mfPRJP7A16JhQYJ7x5mTTaicHqSUmfFcHSg/640?wx_fmt=png"></p><p><span>接着运行了：</span><br></p><section><ul><li></ul><pre data-lang="bash"><code><span>./gistic2 -b <span>$basedir</span> -seg <span>$segfile</span> -refgene <span>$refgenefile</span> -genegistic 1 -smallmem 1 -broad 1 -brlen 0.5 -conf 0.90 -armpeel 1 -savegene 1 -gcm extreme</span></code></pre></section><p><span>得到了</span><br></p><p><img data-galleryid="" data-ratio="1.4285714285714286" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVceoy6kkQ8krrglpPSWuqWxf85w3rYU7KsSyHsY1Y79Smic60AT454HQ/640?wx_fmt=png" data-type="png" data-w="350" src="https://mmbiz.qpic.cn/mmbiz_png/S6vVCE1h1jmHPy4cV2artorRrXiabZXJVceoy6kkQ8krrglpPSWuqWxf85w3rYU7KsSyHsY1Y79Smic60AT454HQ/640?wx_fmt=png"></p><p><span>上述命令运行完，在输出文件夹OutDir中，相对默认参数，会多出4个_data_by_genes.txt的文本。其中all_thresholded.by_genes.txt就是我们需要的结果。而cBioportal的说明也讲的很明确：</span></p><section><ul><li><li><li><li><li></ul><pre data-lang="php"><code><span><span>-2</span> <span>or</span> Deep Deletion indicates a deep loss, possibly a homozygous deletion</span></code><code><span><span>-1</span> <span>or</span> Shallow Deletion indicates a shallow loss, possibley a heterozygous deletion</span></code><code><span><span>0</span> is diploid</span></code><code><span><span>1</span> <span>or</span> Gain indicates a low-level gain (a few additional copies, often broad)</span></code><code><span><span>2</span> <span>or</span> Amplification indicate a high-level amplification (more copies, often focal)</span></code></pre></section><h1>将CNA基因汇总结果导入maftools</h1><p><span>拿到GISTIC的拷贝数变异的数据后，使用下面的示例代码，将拷贝数汇总结果导入maftools：</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="makefile"><span>library(m</span>aftools)<code><span><br></span></code><code><span>CNA = readr::read_delim(<span>"OutDir/all_thresholded.by_genes.txt"</span>,<span>"\t"</span>)</span></code><code><span>Genes = CNA$`Gene Symbol`</span></code><code><span>CNA = CNA[,-2];CNA = CNA[,-2] <span># GISTIC输出的CNV表中会包含GI号和基因所在的cytoband，这两列不需要</span></span></code><code><span>CNA = reshape2::melt(CNA,id=c('Gene Symbol'),value.name = 'CN')</span></code><code><span>colnames(CNA) = c('Gene','Sample_name','CN')</span></code><code><span>CNA = CNA[CNA$CN != 0,] </span></code><code><span>CNA = CNA[CNA$CN != 1,] <span>#  low-level gain 和 shallow loss的情况，酌情考虑</span></span></code><code><span>CNA = CNA[CNA$CN != -1,] <span># 我们的例子中仅考虑2与-2的情况</span></span></code><code><span>CN = rep('Amp',nrow(CNA))</span></code><code><span>CN[CNA$CN&lt;0]='Del'</span></code><code><span>CNA$CN = CN</span></code><code><span><br></span></code><code><span>laml = read.maf(maf = <span>"Input.maf"</span>,</span></code><code><span>                clinicalData = <span>"Input.clinic.txt"</span>,</span></code><code><span>                cnTable = CNA)</span></code><code><span><br></span></code><code><span>oncoplot(maf = laml)</span></code></pre></section><p><span>对于拷贝数变异过小的基因我们不进行考虑，这样就能得到自己想要的每个样本中扩增和删失的基因</span></p><p><br></p><p><span><span>参考：</span></span></p><p><span><span>1. https://www.jianshu.com/p/ae71c1c97f1b?utm_campaign=haruki&amp;utm_content=note&amp;utm_medium=reader_share&amp;utm_source=weixin</span></span><br></p><p><span><span>2. https://www.jianshu.com/p/5822759a67e2?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=seo_notes&amp;utm_source=recommendation</span></span></p><p><span><span>3. http://www.360doc.com/content/21/1209/17/70118598_1007866674.shtml</span></span></p><p><span><span>4. https://github.com/mskcc/facets/issues/84</span></span></p><p><span><span>5. file:///C:/Users/XIEJIA~1/AppData/Local/Temp/scp26137/home/imp/GISTIC/GISTICDocumentation_standalone.htm</span></span></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/gR2qviDSrtCo65TFiF4ECg",target="_blank" rel="noopener noreferrer">原文链接</a>
