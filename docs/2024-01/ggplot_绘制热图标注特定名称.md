---
title: "ggplot 绘制热图标注特定名称"
date: 2024-01-03T15:53:29Z
draft: ["false"]
tags: [
  "fetched",
  "老俊俊的生信笔记"
]
categories: ["Acdemic"]
---
ggplot 绘制热图标注特定名称 by 老俊俊的生信笔记
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-mpa-powered-by="yiban.io"><h4 data-tool="mdnice编辑器"><span></span></h4><section><mp-common-profile data-pluginname="mpprofile" data-id="MzkyMTI1MTYxNA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/G5jjcE4usey42oX5qyLTVibLRO9dz8ic5G4TpEHQc9rICYlpS4MHg6Et8cgXrQDqibvibXombicTro8t9cekJRlDBcw/0?wx_fmt=png" data-nickname="老俊俊的生信笔记" data-alias="JunJunLab" data-signature="老俊俊的生信技能和知识分享,我不是巨人,但你可以站在我的肩膀上更进一步!" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><h4 data-tool="mdnice编辑器"><span></span></h4><h2 data-tool="mdnice编辑器"><span><span>1</span></span><span>引言</span><span></span></h2><blockquote data-tool="mdnice编辑器"><p>简单的把 <strong>smartLabelAlignGrob</strong> 封装为 <strong>geom</strong> 图层 <strong>geom_marklabel</strong>,这样用 ggplot 绘制热图添加部分特定标签方便些。下面画单细胞热图来举例。</p></blockquote><h2 data-tool="mdnice编辑器"><span><span>2</span></span><span>安装</span><span></span></h2><pre data-tool="mdnice编辑器"><span></span><code><span># install.packages("devtools")</span><br>devtools::install_github(<span>"junjunlab/ggSCvis"</span>)<br><br><span># or</span><br>remotes::install_github(<span>"junjunlab/ggSCvis"</span>)<br></code></pre><h2 data-tool="mdnice编辑器"><span><span>3</span></span><span>示例</span><span></span></h2><p data-tool="mdnice编辑器">加载包和准备数据:</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(ggSCvis)<br><span>library</span>(ggplot2)<br><span>library</span>(SeuratData)<br><span>library</span>(Seurat)<br><span>library</span>(tidyverse)<br><br><br>data(<span>"pbmc3k"</span>)<br>pbmc &lt;- pbmc3k.final<br>pbmc &lt;- UpdateSeuratObject(object = pbmc)<br><br>pbmc.markers &lt;- FindAllMarkers(pbmc, only.pos = <span>TRUE</span>)<br>mk &lt;- pbmc.markers %&gt;%<br>  dplyr::group_by(cluster) %&gt;%<br>  dplyr::filter(avg_log2FC &gt; <span>1</span>) %&gt;%<br>  dplyr::group_by(cluster) %&gt;%<br>  dplyr::arrange(p_val_adj ,avg_log2FC) %&gt;%<br>  dplyr::slice_head(n = <span>10</span>)<br><br>mark_gene &lt;- sample(mk$gene,<span>20</span>,replace = <span>F</span>)<br></code></pre><p data-tool="mdnice编辑器">按亚群分面:</p><pre data-tool="mdnice编辑器"><span></span><code>ggscplot(object = pbmc,<br>         features = mk$gene,<br>         mapping = aes(x = cell,y = gene_name)) +<br>  geom_tile(aes(fill = value)) +<br>  scale_fill_gradient(low = <span>"grey90"</span>,high = <span>"red"</span>) +<br>  facet_wrap(~seurat_clusters,nrow = <span>1</span>,scales = <span>"free_x"</span>) +<br>  <span># mark for last panel</span><br>  geom_marklabel(data = . %&gt;% dplyr::filter(seurat_clusters == <span>"8"</span>),<br>                 mark.label = mark_gene) +<br>  theme(axis.text.x = element_blank(),<br>        axis.ticks.x = element_blank(),<br>        legend.position = <span>"left"</span>,<br>        plot.margin = margin(r = <span>0.15</span>,unit = <span>"npc"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029051" data-ratio="0.5891402714932127" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbkqoHBEs5sL9Q3ibicgNZibRpvyAT1yGHQtcASLicQr9acdYzriaM9lODelw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1105" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbkqoHBEs5sL9Q3ibicgNZibRpvyAT1yGHQtcASLicQr9acdYzriaM9lODelw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>use.smartAlign2 = T</strong>:</p><pre data-tool="mdnice编辑器"><span></span><code>ggscplot(object = pbmc,<br>         features = mk$gene,<br>         mapping = aes(x = cell,y = gene_name)) +<br>  geom_tile(aes(fill = value)) +<br>  scale_fill_gradient(low = <span>"grey90"</span>,high = <span>"red"</span>) +<br>  facet_wrap(~seurat_clusters,nrow = <span>1</span>,scales = <span>"free_x"</span>) +<br>  theme(axis.text.x = element_blank(),<br>        axis.ticks.x = element_blank(),<br>        legend.position = <span>"left"</span>,<br>        plot.margin = margin(r = <span>0.1</span>,unit = <span>"npc"</span>)) +<br>  geom_marklabel(data = . %&gt;% filter(seurat_clusters == <span>"8"</span>),<br>                 mark.label = mark_gene,<br>                 use.smartAlign2 = <span>T</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029050" data-ratio="0.6998191681735986" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbV95pCWZICkxW4lpVbOaiaLAcZEHfcFcROvLibDPDPdenmGV1rt7Dk8RA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1106" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbV95pCWZICkxW4lpVbOaiaLAcZEHfcFcROvLibDPDPdenmGV1rt7Dk8RA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">调整位置:</p><pre data-tool="mdnice编辑器"><span></span><code>ggscplot(object = pbmc,<br>         features = mk$gene,<br>         mapping = aes(x = cell,y = gene_name)) +<br>  geom_tile(aes(fill = value)) +<br>  scale_fill_gradient(low = <span>"grey90"</span>,high = <span>"red"</span>) +<br>  facet_wrap(~seurat_clusters,nrow = <span>1</span>,scales = <span>"free_x"</span>) +<br>  scale_y_discrete(position = <span>"right"</span>) +<br>  geom_marklabel(data = . %&gt;% filter(seurat_clusters == <span>"0"</span>),<br>                 mark.label = mark_gene,<br>                 pos = <span>"left"</span>) +<br>  theme(axis.text.x = element_blank(),<br>        axis.ticks.x = element_blank(),<br>        legend.position = <span>"right"</span>,<br>        plot.margin = margin(l = <span>0.15</span>,unit = <span>"npc"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029048" data-ratio="0.6986425339366515" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbngSlhAv230zwqlDEAFvpkiceCv4nAhbibjNf15WIHicBQ8vVx4JUKQaog/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1105" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbngSlhAv230zwqlDEAFvpkiceCv4nAhbibjNf15WIHicBQ8vVx4JUKQaog/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">横过来标注:</p><pre data-tool="mdnice编辑器"><span></span><code>ggscplot(object = pbmc,<br>         features = mk$gene,<br>         mapping = aes(y = cell,x = gene_name)) +<br>  geom_tile(aes(fill = value)) +<br>  scale_fill_gradient(low = <span>"grey90"</span>,high = <span>"red"</span>) +<br>  scale_x_discrete(position = <span>"top"</span>) +<br>  facet_wrap(~seurat_clusters,ncol = <span>1</span>,scales = <span>"free_y"</span>,<span>switch</span> = <span>"y"</span>) +<br>  geom_marklabel(data = . %&gt;% filter(seurat_clusters == <span>"8"</span>),<br>                 mark.label = mark_gene,<br>                 link.line.length = <span>0.1</span>,<br>                 pos = <span>"bottom"</span>) +<br>  theme(axis.text.y = element_blank(),<br>        axis.ticks.y = element_blank(),<br>        axis.text.x = element_text(angle = <span>90</span>,hjust = <span>0</span>),<br>        plot.margin = margin(b = <span>0.2</span>,unit = <span>"npc"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029049" data-ratio="0.6582959641255606" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0Ebf4xtic77dH7yRF7m1rmAVcCPLKDW7hShNH434icuhjQ3c1dw8EARELvg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1115" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0Ebf4xtic77dH7yRF7m1rmAVcCPLKDW7hShNH434icuhjQ3c1dw8EARELvg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">你也可以画取均值的热图:</p><pre data-tool="mdnice编辑器"><span></span><code>ggscplot(object = pbmc,features = mk$gene,<br>         mapping = aes(y = gene_name,x = seurat_clusters,<br>                       fill = mean_exp,exp = mean_exp)) +<br>  geom_scTile() +<br>  scale_fill_gradient(low = <span>"grey90"</span>,high = <span>"red"</span>) +<br>  geom_marklabel(mark.label = mark_gene,<br>                 link.line.length = <span>0.01</span>,<br>                 use.smartAlign2 = <span>F</span>) +<br>  theme_bw() +<br>  theme(plot.margin = margin(t = <span>0.05</span>,r = <span>0.18</span>,unit = <span>"npc"</span>),<br>        legend.position = <span>"left"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029047" data-ratio="1.1275964391691395" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0Eb3YNVOmvwEhEZxLuXpLAUsOyOzojZx1oIM6OyGbjVV9KdTPn9cWElsw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="674" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0Eb3YNVOmvwEhEZxLuXpLAUsOyOzojZx1oIM6OyGbjVV9KdTPn9cWElsw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">没问题你就可以把原来的基因去掉了:</p><pre data-tool="mdnice编辑器"><span></span><code>mk &lt;- pbmc.markers %&gt;%<br>  dplyr::group_by(cluster) %&gt;%<br>  dplyr::filter(avg_log2FC &gt; <span>1</span>) %&gt;%<br>  dplyr::group_by(cluster) %&gt;%<br>  dplyr::arrange(p_val_adj ,avg_log2FC) %&gt;%<br>  dplyr::slice_head(n = <span>50</span>)<br><br>mark_gene &lt;- sample(mk$gene,<span>100</span>,replace = <span>F</span>)<br><br>ggscplot(object = pbmc,features = mk$gene,<br>         featuresAnno = mk$cluster,<br>         mapping = aes(y = gene_name,x = seurat_clusters,<br>                       fill = mean_exp,exp = mean_exp)) +<br>  geom_scTile() +<br>  scale_fill_gradient(low = <span>"grey90"</span>,high = <span>"red"</span>) +<br>  facet_wrap(~featureAnno,scales = <span>"free"</span>,nrow = <span>2</span>) +<br>  geom_marklabel(mark.label = mark_gene,<br>                 link.line.length = <span>0.075</span>,<br>                 use.smartAlign2 = <span>F</span>) +<br>  theme_bw() +<br>  theme(plot.margin = margin(t = <span>0.1</span>,r = <span>0.15</span>,unit = <span>"npc"</span>),<br>        panel.spacing.x = unit(<span>0.06</span>,<span>"npc"</span>),<br>        axis.text.y = element_blank(),<br>        axis.ticks.y = element_blank(),<br>        legend.position = <span>"left"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029057" data-ratio="0.3697478991596639" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbazClQFqSNfjLwx9ZG6zmfJWHcqS2a14FKpDjicKhv1gPtpvDyib9icVJg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1785" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbazClQFqSNfjLwx9ZG6zmfJWHcqS2a14FKpDjicKhv1gPtpvDyib9icVJg/640?wx_fmt=png&amp;from=appmsg"></figure><blockquote data-tool="mdnice编辑器"><p><strong>还有一些其它设置颜色,形状等的参数你可以自己看文档进行调整。</strong></p></blockquote><h2 data-tool="mdnice编辑器"><span><span>4</span></span><span>结尾</span><span></span></h2><blockquote data-tool="mdnice编辑器"><p><strong>路漫漫其修远兮,吾将上下而求索。</strong></p></blockquote><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">欢迎加入生信交流群。加我微信我也拉你进 <strong>微信群聊</strong> <strong>老俊俊生信交流群</strong> <strong>(微信交流群需收取 20 元入群费用,一旦交费,拒不退还!(防止骗子和便于管理))</strong> 。QQ 群可免费加入, 记得进群按格式修改备注哦。</p><section data-tool="mdnice编辑器"><section><p><strong>老俊俊微信：</strong></p><figure><img data-imgfileid="100029055" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbeJ9XNQUl6RXuS7fwQ7icABx94OFiaibbicia7Gwa1joSJSoLD9f3urFiboWA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="430" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbeJ9XNQUl6RXuS7fwQ7icABx94OFiaibbicia7Gwa1joSJSoLD9f3urFiboWA/640?wx_fmt=png&amp;from=appmsg"></figure><figure><img data-imgfileid="100029056" data-ratio="1.3668430335097002" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbW63dyeDxb1hQzPv8jLNDCYhQSicJA4HMXcJq1YmODLSiaIicS0G2QrjJg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="567" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbW63dyeDxb1hQzPv8jLNDCYhQSicJA4HMXcJq1YmODLSiaIicS0G2QrjJg/640?wx_fmt=png&amp;from=appmsg"></figure></section><section><p><strong>知识星球：</strong></p><figure><img data-imgfileid="100029053" data-ratio="1.5896226415094339" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbomtwxvveGpMiaXs5Ew8n4dwyiadzic0oSdDPnyAicDMrjcmHicRBXr33UFg/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1060" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/G5jjcE4usewFlMoHYqlImHibcAoNJm0EbomtwxvveGpMiaXs5Ew8n4dwyiadzic0oSdDPnyAicDMrjcmHicRBXr33UFg/640?wx_fmt=jpeg&amp;from=appmsg"></figure></section></section><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器"><br></p><center data-tool="mdnice编辑器"><strong> 往期回顾目录</strong></center><blockquote data-tool="mdnice编辑器"><p><br></p><center><strong><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247512646&amp;idx=1&amp;sn=d9241b243771dcb355c74fd1a7f9431c&amp;chksm=c1848837f6f301216f9d4c06659f01814b54994b552b5f15d9df9c5b227f417288a7cd4061e6&amp;token=2102927728&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">听说你只有富集表格还想画 GSEA 图?</a></strong></center><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247512269&amp;idx=1&amp;sn=0208555abacffaed2e8a8437c8b43214&amp;chksm=c1848abcf6f303aa83091c6c517b054ba4f7da2edc8de0fb86a2878064a91375a67cee89fd3b&amp;token=864433526&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">ggSCvis 可视化 dot/heatmap/violin plot 示例</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247512189&amp;idx=1&amp;sn=1cc5cb6167f9d3960922dd691aa376db&amp;chksm=c1848a0cf6f3031a4b9b1ab4195d525269703553f84ef29ea312878c60accfec07ca3a3102d6&amp;token=864433526&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">给你的亚群添加编号</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247512093&amp;idx=1&amp;sn=b44680cfccfa7c0bb0a59eef29b944fc&amp;chksm=c1848a6cf6f3037ad9e74e898575125b0cbd0d372c25805315559e5e41c9168c6e8612418896&amp;token=1185565850&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">ggSCvis 让你的单细胞可视化 gg 起来</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247511755&amp;idx=1&amp;sn=b5758249eef3fdf4946aae0f4e7ef592&amp;chksm=c18494baf6f31dacdbf6e4a1ba0a05817b087a9bc1ad2a6b8b79959903ce5b96156e4e1a2faf&amp;token=1185565850&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">easylift 基因组坐标轻松转换</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247511683&amp;idx=1&amp;sn=289992da1c3a551a4e5b8236fe830e94&amp;chksm=c18494f2f6f31de444ff98d314f7bfea97ade3573babe625200dd89b1cf86ccb47f287548e61&amp;token=1910483679&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">CCPlotR: 细胞通讯可视化包</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247511206&amp;idx=1&amp;sn=30806bab4936d81aa5b626b3d69d828d&amp;chksm=c18496d7f6f31fc1b8993ebf3b36a9d8a1a5db32181a0cb85297c48016f5debcfb296cf58aa3&amp;token=1910483679&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">geom_genomicNestedZoom 放大视图</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247511175&amp;idx=1&amp;sn=d88e495e3ecb62a29931bab3cb51d804&amp;chksm=c18496f6f6f31fe0b5d599fb2a8e0c6f001feb8d93ea214ce2ae1a5ea9bf59845739af520c04&amp;token=1304327956&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">听说你想给 pheatmap 添加感兴趣基因?</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247510846&amp;idx=1&amp;sn=9483f23b436903fd4d74034a64e99e79&amp;chksm=c184914ff6f31859d557c2665f1e09b088ef716c5037f3030f7a12d9cbcd144aa9dd257f08d2&amp;token=843968300&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">给 heatmap 添加显著性标记</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247510758&amp;idx=1&amp;sn=6a1d78131792e297d7be33aceb4711ba&amp;chksm=c1849097f6f3198159bbb4d66d4d1424d11da9ea07e896128573ebc63860aa2985e31ea5331d&amp;token=843968300&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">没有文档的 R 包不算好包</a></center></strong></blockquote></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/WUx1Rr69VbOHZz3zPJQw7A",target="_blank" rel="noopener noreferrer">原文链接</a>
