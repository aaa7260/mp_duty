---
title: "单细胞测序最好的教程（十二）：你真的做对了细胞比例分析吗？"
date: 2024-01-08T23:39:56Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
单细胞测序最好的教程（十二）：你真的做对了细胞比例分析吗？ by 单细胞天地
------
<div><section data-style-type="5" data-tools="新媒体排版" data-id="2430070"><section data-style-type="5" data-tools="新媒体排版" data-id="2390348"><section><section powered-by="xiumi.us"><section><section><section powered-by="xiumi.us"><section><section><br></section><section><section><section powered-by="xiumi.us"><section><section><p>分享是一种态度</p></section></section></section></section></section></section></section></section><section><section powered-by="xiumi.us"><section><section><img data-ratio="0.8738095238095238" data-src="https://mmbiz.qpic.cn/mmbiz_gif/siaia0BDGJdjSnnb9ibXpFagGPWQ0JjSSTNVBZthROEhicfINuLcxX2Ro3Zb600LJhrzeYIb120tLjSVXEtLn14DwA/640?wx_fmt=gif" data-type="gif" data-w="420" width="100%" data-imgfileid="100035271" src="https://mmbiz.qpic.cn/mmbiz_gif/siaia0BDGJdjSnnb9ibXpFagGPWQ0JjSSTNVBZthROEhicfINuLcxX2Ro3Zb600LJhrzeYIb120tLjSVXEtLn14DwA/640?wx_fmt=gif"></section></section></section></section></section></section></section></section></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>作者按</p><p>本章节主要讲解了单细胞数据的细胞组成（比例）的分析方法，讲解了为什么直接分析比例不行的原因与例子，并介绍了“有标签”，“有标签有层次”，“无标签”三个维度的细胞组成分析方法。本教程首发于单细胞最好的中文教程，未经授权许可，禁止转载。</p><p><span>全文字数|预计阅读时间</span>: 5000|10min</p><p>——Starlitnightly（星夜）</p></blockquote><h2 data-tool="mdnice编辑器"><span></span><span>1. 背景</span></h2><p data-tool="mdnice编辑器">在单细胞分析中，我们除了关注基因表达模式受不同条件所影响导致的改变，我们还会关注细胞组成（例如细胞类型的比例）也会在不同条件下发生变化。例如药物处理，外源感染，细胞癌变等，这些刺激因素将会导致细胞类型的变化。由于细胞组成是一种整体性的变化，因此我们需要大量的细胞以及样本数量，才能证实组成的变化发生。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100035326" data-ratio="0.4212962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdkMpXeGCoP30B28kdFzCnDo23IV65kicHlpIL0tRWYIIECicF1bXTBYlg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdkMpXeGCoP30B28kdFzCnDo23IV65kicHlpIL0tRWYIIECicF1bXTBYlg/640?wx_fmt=png&amp;from=appmsg"><figcaption>细胞组成变化</figcaption></figure><p data-tool="mdnice编辑器">在本章中，我们将详细探讨细胞组成的变化的分析手段，并阐明清楚为什么不能直接对细胞比例进行分析？分析细胞比例的局限性在哪？这会是很有意思的一章教程。</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> omicverse <span>as</span> ov<br><span>import</span> scanpy <span>as</span> sc<br><span>import</span> scvelo <span>as</span> scv<br><span>import</span> pertpy <span>as</span> pt<br><br>ov.utils.ov_plot_set()<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>       ____            _     _    __                  <br>      / __ \____ ___  (_)___| |  / /__  _____________ <br>     / / / / __ `__ \/ / ___/ | / / _ \/ ___/ ___/ _ \ <br>    / /_/ / / / / / / / /__ | |/ /  __/ /  (__  )  __/ <br>    \____/_/ /_/ /_/_/\___/ |___/\___/_/  /____/\___/                                              <br>    <br>    Version: 1.5.6, Tutorials: https://omicverse.readthedocs.io/<br><br><br>    Global seed <span>set</span> to 0<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>2.加载数据</span></h2><p data-tool="mdnice编辑器">本章将介绍这两种方法并将其应用于 Haber 数据集[ Haber等人。，2017 ]。该数据集包含来自小鼠小肠和类器官的 53,193 个单个上皮细胞。一些细胞还受到细菌或寄生线虫感染，例如分别通过沙门氏菌和Heligmosomoides polygyrus感染。在本教程中，我们使用完整 Haber 数据集的子集，其中仅包括专门为此目的收集的对照细胞和受感染细胞。值得注意的是，我们排除了仅收集大单元格的附加数据集，以加快计算速度并降低复杂性。</p><p data-tool="mdnice编辑器">数据下载地址：</p><ul data-tool="mdnice编辑器"><li><section>https://figshare.com/ndownloader/files/38169900</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>adata=ov.read(<span>'data/haber_count.h5ad'</span>)<br>adata<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># AnnData object with n_obs × n_vars = 9842 × 15215</span><br>    <span>#     obs: 'batch', 'barcode', 'condition', 'cell_label'</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>adata.obs[<span>'condition'</span>].cat.categories<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># Index(['Control', 'Hpoly.Day3', 'Hpoly.Day10', 'Salmonella'], dtype='object')</span><br></code></pre><p data-tool="mdnice编辑器">数据分 10 个批次进行收集。条件变量是对照组（Control）、沙门氏菌（Salmonella）、肠道寄生线虫感染3天（Hpoly.Day3）和肠道寄生线虫感染10天（Hpoly.Day10）。cell_label存放了细胞类型。</p><h2 data-tool="mdnice编辑器"><span></span><span>3. 组成差异</span></h2><p data-tool="mdnice编辑器">我们在分析单细胞数据中的细胞比例的时候，通常是描述细胞在不同分组中的占比来进行叙述的，在一般的分析教程中，例如药物治疗后，某类T细胞的比例上升。但是，这类T细胞真的上升了吗？这是一个值得去思考的问题。我们来看下面这个例子：</p><p data-tool="mdnice编辑器">在一项癌症研究中，我们想要比较健康器官与患病器官的细胞类型组成。我们假设在这种器官中存在三类细胞，分别是A，B，C，其中：</p><ul data-tool="mdnice编辑器"><li><section>健康器官中，三类细胞的细胞数量相同，都是2000个</section></li><li><section>患病器官中，A类细胞变成了4000个，但是B类和C类细胞仍是2000个细胞</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> pandas <span>as</span> pd<br><span>import</span> numpy <span>as</span> np<br>healthy_tissue = [<span>2000</span>, <span>2000</span>, <span>2000</span>]<br>diseased_tissue = [<span>4000</span>, <span>2000</span>, <span>2000</span>]<br>example_data_global = pd.DataFrame(<br>    data=np.array([healthy_tissue, diseased_tissue]),<br>    index=[<span>1</span>, <span>2</span>],<br>    columns=[<span>"A"</span>, <span>"B"</span>, <span>"C"</span>],<br>)<br>example_data_global[<span>"Disease status"</span>] = [<span>"Healthy"</span>, <span>"Diseased"</span>]<br>example_data_global<br></code></pre><section data-tool="mdnice编辑器"><table><thead><tr><th>A</th><th>B</th><th>C</th><th>Disease status</th></tr></thead><tbody><tr><td>1</td><td>2000</td><td>2000</td><td>2000</td></tr><tr><td>2</td><td>4000</td><td>2000</td><td>2000</td></tr></tbody></table></section><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> seaborn <span>as</span> sns<br><span>import</span> matplotlib.pyplot <span>as</span> plt<br>plot_data_global = example_data_global.melt(<br>    <span>"Disease status"</span>, [<span>"A"</span>, <span>"B"</span>, <span>"C"</span>], <span>"Cell type"</span>, <span>"count"</span><br>)<br><br>fig, ax = plt.subplots(<span>1</span>, <span>2</span>, figsize=(<span>12</span>, <span>6</span>))<br>sns.barplot(<br>    data=plot_data_global, x=<span>"Disease status"</span>, y=<span>"count"</span>, hue=<span>"Cell type"</span>, ax=ax[<span>0</span>]<br>)<br>ax[<span>0</span>].set_title(<span>"Global abundances, by status"</span>)<br><br>sns.barplot(<br>    data=plot_data_global, x=<span>"Cell type"</span>, y=<span>"count"</span>, hue=<span>"Disease status"</span>, ax=ax[<span>1</span>]<br>)<br>ax[<span>1</span>].set_title(<span>"Global abundances, by cell type"</span>)<br><br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035325" data-ratio="0.5324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdicoC94ib8oycE55K6436kgOrNiapdG0PjeVyEkfxJIRmvx3MsNbH3LjZw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdicoC94ib8oycE55K6436kgOrNiapdG0PjeVyEkfxJIRmvx3MsNbH3LjZw/640?wx_fmt=png&amp;from=appmsg"><figcaption>模拟真实数据</figcaption></figure><p data-tool="mdnice编辑器">对于分析的目的而言，我们在获得健康器官和患病器官后，想探究清楚，患病后哪一类细胞的比例会变化。很显而易见，A类细胞翻倍变化了。但是我们在分析的时候，真的如我们理想情况一般吗？</p><p data-tool="mdnice编辑器">答案是否定的，我们都知道，单细胞测序技术有着通量限制，即使是技术迭代发展，测序仪单次所能通过的细胞也在5000-6000之间。这意味着，我们每个病人器官所获的的细胞总数是有限的。我们无法获得器官内的所有细胞，这个时候。我们会用所测序的细胞来作为这个“病人器官”的代表。一个新的问题也随之出现，我们所获的的细胞类型计数只是一种比例，其总和为1。在统计学上，我们把这种数据称之为“成分数据”，特征是一个样本中的所有特征（细胞类型）的相对丰度总和为1.</p><p data-tool="mdnice编辑器">因此，我们前面的A、B、C三类细胞，我们并不能获得6000和8000个细胞，我们假设测序仪的限制为600，因此我们只能从中随机获得600个细胞。我们采用随机抽样模拟这一过程。</p><pre data-tool="mdnice编辑器"><span></span><code>np.random.seed(<span>112</span>)<br>healthy_sample = np.random.multinomial(<br>    pvals=healthy_tissue / np.sum(healthy_tissue), n=<span>600</span><br>)<br>diseased_sample = np.random.multinomial(<br>    pvals=diseased_tissue / np.sum(diseased_tissue), n=<span>600</span><br>)<br>example_data_sample = pd.DataFrame(<br>    data=np.array([healthy_sample, diseased_sample]),<br>    index=[<span>1</span>, <span>2</span>],<br>    columns=[<span>"A"</span>, <span>"B"</span>, <span>"C"</span>],<br>)<br>example_data_sample[<span>"Disease status"</span>] = [<span>"Healthy"</span>, <span>"Diseased"</span>]<br>example_data_sample<br></code></pre><section data-tool="mdnice编辑器"><table><thead><tr><th>A</th><th>B</th><th>C</th><th>Disease status</th></tr></thead><tbody><tr><td>1</td><td>193</td><td>201</td><td>206</td></tr><tr><td>2</td><td>296</td><td>146</td><td>158</td></tr></tbody></table></section><pre data-tool="mdnice编辑器"><span></span><code>plot_data_sample = example_data_sample.melt(<br>    <span>"Disease status"</span>, [<span>"A"</span>, <span>"B"</span>, <span>"C"</span>], <span>"Cell type"</span>, <span>"count"</span><br>)<br><br>fig, ax = plt.subplots(<span>1</span>, <span>2</span>, figsize=(<span>12</span>, <span>6</span>))<br>sns.barplot(<br>    data=plot_data_sample, x=<span>"Disease status"</span>, y=<span>"count"</span>, hue=<span>"Cell type"</span>, ax=ax[<span>0</span>]<br>)<br>ax[<span>0</span>].set_title(<span>"Sampled abundances, by status"</span>)<br><br>sns.barplot(<br>    data=plot_data_sample, x=<span>"Cell type"</span>, y=<span>"count"</span>, hue=<span>"Disease status"</span>, ax=ax[<span>1</span>]<br>)<br>ax[<span>1</span>].set_title(<span>"Sampled abundances, by cell type"</span>)<br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035327" data-ratio="0.5388888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7Mdc8lAFpDbZTPOhduOkfNj3TVaEuia0qVkwPQsuAuia6ahoGFTgwHziawAg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7Mdc8lAFpDbZTPOhduOkfNj3TVaEuia0qVkwPQsuAuia6ahoGFTgwHziawAg/640?wx_fmt=png&amp;from=appmsg"><figcaption>模拟真实数据采样</figcaption></figure><p data-tool="mdnice编辑器">我们可以很直观地感受到，虽然A类细胞的比例依然是最大的，但是B、C两类细胞似乎在病人器官中出现了下降的情况，但对应我们的真实情况而言，B、C两类细胞在病人与健康人中的比例应该是不变的。</p><p data-tool="mdnice编辑器">读到这里，你可能会去思考，如何才能将B、C两类细胞的误差进行消除，使得我们分析能得到一个合理的结果。</p><p data-tool="mdnice编辑器">可能你注意到，例如我们同时对B、C两类细胞在病人中的样本减少1000个细胞，A类细胞保持2000个那么我们在采样600个细胞的时候，所获得的测序结果与A类细胞变为4000个是一致的。因此，我们可以考虑固定数据的参考点，我们假设该参考点在所有样本中保持不变。例如我们保持B、C细胞不变，那么A类细胞的分析结果将与真实情况一致。参考点的选取可以是单一细胞类型、多种细胞类型的聚合（例如几何平均值）或一组正交基。</p><h2 data-tool="mdnice编辑器"><span></span><span>4. 基于已有的标记</span></h2><p data-tool="mdnice编辑器">scCODA属于一种通过预定义类（例如细胞类型）来统计得出细胞的成分变化。该算法受微生物组数据分析的启发。scCODA 提出了一种贝叶斯方法来解决单细胞分析中常见的低重复问题。它使用分层狄利克雷多项式模型对细胞类型计数进行建模，该模型通过对所有测量的细胞类型比例进行联合建模来解释细胞类型比例的不确定性和负相关偏差。为了确保唯一可识别的解决方案和易于解释，scCODA 中的参考被选择为特定的细胞类型。因此，scCODA 检测到的任何成分变化始终必须相对于所选参考进行查看。</p><p data-tool="mdnice编辑器">但需要注意的是，scCODA 假设协变量和细胞丰度之间存在对数线性关系，这在使用连续协变量时可能并不总是反映潜在的生物过程。scCODA 的另一个限制是无法推断除成分效应之外的细胞成分之间的相关结构。此外，scCODA 仅模拟平均丰度的变化，但不检测响应变异性的变化</p><h3 data-tool="mdnice编辑器"><span></span><span>4.1 初始化scCODA模型。</span><span></span></h3><p data-tool="mdnice编辑器">我们使用 load 函数准备 MuData 对象以供后续处理，并根据输入数据创建成分分析数据集。我们将 cell_type_identifier 指定为cell_label，sample_identifier 指定为batch，covariate_obs 与condition我们的例子一样。</p><pre data-tool="mdnice编辑器"><span></span><code>sccoda_model = pt.tl.Sccoda()<br>sccoda_data = sccoda_model.load(<br>    adata,<br>    type=<span>"cell_level"</span>,<br>    generate_sample_level=<span>True</span>,<br>    cell_type_identifier=<span>"cell_label"</span>,<br>    sample_identifier=<span>"batch"</span>,<br>    covariate_obs=[<span>"condition"</span>],<br>)<br>sccoda_data<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><br><span># &lt;pre&gt;MuData object with n_obs × n_vars = 9852 × 15223</span><br><span>#   2 modalities</span><br><span>#     rna:    9842 x 15215</span><br><span>#       obs:  &amp;#x27;batch&amp;#x27;, &amp;#x27;barcode&amp;#x27;, &amp;#x27;condition&amp;#x27;, &amp;#x27;cell_label&amp;#x27;</span><br><span>#     coda:   10 x 8</span><br><span>#       obs:  &amp;#x27;condition&amp;#x27;</span><br><span>#       var:  &amp;#x27;n_cells&amp;#x27;&lt;/pre&gt;</span><br></code></pre><p data-tool="mdnice编辑器">为了概述不同条件下的细胞类型分布，我们可以使用 scCODA 的boxplots. 为了更好地了解数据的分布方式，红点显示实际的数据点。</p><pre data-tool="mdnice编辑器"><span></span><code>pt.pl.coda.boxplots(<br>    sccoda_data,<br>    modality_key=<span>"coda"</span>,<br>    feature_name=<span>"condition"</span>,<br>    figsize=(<span>12</span>, <span>5</span>),<br>    add_dots=<span>True</span>,<br>    args_swarmplot={<span>"palette"</span>: [<span>"red"</span>]},<br>)<br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035328" data-ratio="0.4083333333333333" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdNfAjQOj1NX7ibROqLSDtibRdAHB4JVNFdvuwIUfUnl9ria9T5r3oD24Lg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdNfAjQOj1NX7ibROqLSDtibRdAHB4JVNFdvuwIUfUnl9ria9T5r3oD24Lg/640?wx_fmt=png&amp;from=appmsg"><figcaption>细胞比例箱线图</figcaption></figure><p data-tool="mdnice编辑器">箱线图突出显示了细胞类型分布的一些差异。明显值得注意的是沙门氏菌病症的肠上皮细胞（Enterocyte）比例很高。但其他细胞类型，例如转运扩增（TA）细胞，与对照组相比，沙门氏菌条件下的丰度也表现出明显差异，我们必须正确评估这些差异是否具有统计显着性。</p><p data-tool="mdnice编辑器">当然，你除了通过箱线图，你也可以通过堆叠柱状图来可视化细胞类型的比例变化。</p><pre data-tool="mdnice编辑器"><span></span><code>pt.pl.coda.stacked_barplot(<br>    sccoda_data, modality_key=<span>"coda"</span>, feature_name=<span>"condition"</span>, figsize=(<span>2</span>, <span>2</span>)<br>)<br>plt.xticks(fontsize=<span>10</span>)<br>plt.yticks(fontsize=<span>10</span>)<br>plt.ylabel(<span>'Prop'</span>,fontsize=<span>11</span>)<br>plt.legend(bbox_to_anchor=(<span>1.05</span>,<span>1</span>),fontsize=<span>10</span>)<br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035324" data-ratio="0.669576059850374" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdFqtLibAVjTarrvYHyzCYdgZ00YPRsAGPMV5j2bib3m1hQD1QeibOmkGhg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="802" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdFqtLibAVjTarrvYHyzCYdgZ00YPRsAGPMV5j2bib3m1hQD1QeibOmkGhg/640?wx_fmt=png&amp;from=appmsg"><figcaption>细胞比例堆叠柱状图</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span>4.2 scCODA模型训练</span><span></span></h3><p data-tool="mdnice编辑器">我们在初始化scCODA模型后，还需要指定两个主要参数：</p><ul data-tool="mdnice编辑器"><li><section>公式（formula）：斜变量（格式为R语言的样式）</section></li><li><section>参考细胞类型（reference_cell_type）：用作参考的细胞类型</section></li></ul><p data-tool="mdnice编辑器">在上述例子中，我们将条件（condition）指定为唯一的斜变量，该变量包括来4种类型，scCODA将会对这四种类型进行分别建模。此外，我们发现内分泌细胞（Endocrine）在4种类型中的变化很小，即在所有样品中具有几乎恒定的相对丰度。如果参考细胞类型不清楚，我们可以令scCODA自身去计算合适的参考细胞类型，这时候，公式变量的输入如下</p><p data-tool="mdnice编辑器"><code>formula = "covariate_1 + covariate_2"reference_cell_type"automatic"</code></p><pre data-tool="mdnice编辑器"><span></span><code>sccoda_data = sccoda_model.prepare(<br>    sccoda_data,<br>    modality_key=<span>"coda"</span>,<br>    formula=<span>"condition"</span>,<br>    reference_cell_type=<span>"Endocrine"</span>,<br>)<br>sccoda_model.run_nuts(sccoda_data, modality_key=<span>"coda"</span>, rng_key=<span>112</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># sample: 100%|██████████| 11000/11000 [00:53&lt;00:00, 207.54it/s, 127 steps of size 2.16e-02. acc. prob=0.76]</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>sccoda_data[<span>"coda"</span>].varm<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># AxisArrays with keys: intercept_df, effect_df_condition[T.Hpoly.Day3], effect_df_condition[T.Hpoly.Day10], effect_df_condition[T.Salmonella]</span><br></code></pre><p data-tool="mdnice编辑器">计算结果如下表所示，我们选择<code>effect_df_condition[T.Salmonella]</code>进行解释，这代表了在沙门氏菌的组别的细胞比例变化情况，其中各参数的意义如下：</p><ul data-tool="mdnice编辑器"><li><section>Final Parameter: 统计学模型上的参数，类似y=kx+b中的k</section></li><li><section>预期样本（Expected Sample）与对数变化（log2-fold change）：我们首先假设当前协变量（T.Salmonella）的值为1，其他协变量的值为0，然后计算该预期样本与截距部分中没有活动协变量的预期样本之间的对数倍数变化。由于我们的数据是成分数据，如果我们的协变量的效应为0，那么预期样本与截距样本相同，那么log2的倍数变化也为0</section></li></ul><p data-tool="mdnice编辑器">在沙门氏菌病例中，我们仅看到肠上皮细胞的可信增加，而所有其他细胞类型均未受到该疾病的影响。具有相同总细胞计数的对照样品和感染样品之间肠细胞的对数倍数变化约为 1.54。</p><pre data-tool="mdnice编辑器"><span></span><code>sccoda_data[<span>"coda"</span>].varm[<span>"effect_df_condition[T.Salmonella]"</span>]<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035331" data-ratio="0.3808864265927978" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdDEf9YJGvG7tJYaIV0NlkaVkT8lmcUUicWENDk0mah0E1ZOKvBUA5icXQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="722" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdDEf9YJGvG7tJYaIV0NlkaVkT8lmcUUicWENDk0mah0E1ZOKvBUA5icXQ/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span>4.3 调整错误发现率</span><span></span></h3><p data-tool="mdnice编辑器">scCODA 根据包含概率选择可信效应。可信效应和不可信效应之间的界限取决于所需的错误发现率 (FDR)。较小的 FDR 值会产生更保守的结果，但可能会遗漏一些效应，而较大的 FDR 值会选择更多的效应，但会产生更多的错误发现。</p><p data-tool="mdnice编辑器">默认情况下，该值为 0.05。由于根据数据集的不同，FDR 可能会对结果产生重大影响，因此我们建议尝试高达 0.2 的不同 FDR，以获得最显着的效果。</p><pre data-tool="mdnice编辑器"><span></span><code>sccoda_model.set_fdr(sccoda_data, <span>0.4</span>)<br></code></pre><p data-tool="mdnice编辑器">为了获得每种细胞类型的成分变化的二元分类，我们credible_effects在结果对象上使用 scCODA 函数。标记为“True”的每种细胞类型或多或少都存在。倍数变化描述了细胞类型是否更多或更少存在。因此，我们将把它们与下面的二元分类一起绘制。</p><pre data-tool="mdnice编辑器"><span></span><code>sccoda_model.credible_effects(sccoda_data, modality_key=<span>"coda"</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># Covariate                 Cell Type            </span><br>    <span># condition[T.Hpoly.Day3]   Endocrine                False</span><br>    <span>#                           Enterocyte                True</span><br>    <span>#                           Enterocyte.Progenitor    False</span><br>    <span>#                           Goblet                    True</span><br>    <span>#                           Stem                      True</span><br>    <span>#                           TA                        True</span><br>    <span>#                           TA.Early                 False</span><br>    <span>#                           Tuft                      True</span><br>    <span># condition[T.Hpoly.Day10]  Endocrine                False</span><br>    <span>#                           Enterocyte                True</span><br>    <span>#                           Enterocyte.Progenitor    False</span><br>    <span>#                           Goblet                    True</span><br>    <span>#                           Stem                     False</span><br>    <span>#                           TA                       False</span><br>    <span>#                           TA.Early                  True</span><br>    <span>#                           Tuft                      True</span><br>    <span># condition[T.Salmonella]   Endocrine                False</span><br>    <span>#                           Enterocyte                True</span><br>    <span>#                           Enterocyte.Progenitor    False</span><br>    <span>#                           Goblet                   False</span><br>    <span>#                           Stem                     False</span><br>    <span>#                           TA                       False</span><br>    <span>#                           TA.Early                 False</span><br>    <span>#                           Tuft                     False</span><br>    <span># Name: Final Parameter, dtype: bool</span><br><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>pt.pl.coda.effects_barplot(sccoda_data, modality_key=<span>"coda"</span>, <br>                           covariates=<span>"condition"</span>)<br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035333" data-ratio="0.25092592592592594" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdR2UgJrxLNbBUK8TUkeQ9uJlh7q8heeKPutL7AMNJPaeKMxpgPaickBw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdR2UgJrxLNbBUK8TUkeQ9uJlh7q8heeKPutL7AMNJPaeKMxpgPaickBw/640?wx_fmt=png&amp;from=appmsg"><figcaption>细胞组成分析图</figcaption></figure><p data-tool="mdnice编辑器">这些图很好地显示了条件对细胞类型的显着且可信的影响。这些效应在很大程度上与 Haber 论文中的发现一致，该论文使用<code>非组合泊松回归模型</code>得出了他们的发现：</p><ul data-tool="mdnice编辑器"><li><section>1.“感染沙门氏菌后，成熟肠上皮细胞（Entercyte）的频率大幅增加。” [哈伯等人。，2017年]</section></li><li><section>2.“寄生线虫感染后将导致杯状细胞（Goblet）和簇状细胞（Tuft）丰度增加。” [哈伯等人。，2017年]</section></li></ul><p data-tool="mdnice编辑器">熟悉原始出版物的读者可能想知道为什么 Haber 等人使用的模型。发现比 scCODA 更显着的效果，例如沙门氏菌感染时干细胞和转运扩增细胞的减少。这与scCODA的结果不完全一致，这是由于细胞比例数据是成分数据，一种细胞类型的相对丰度的增加，将导致其他细胞类型的相对丰度减少。所以如果只使用<code>非组合泊松回归模型</code>便会出现这种问题。</p><h2 data-tool="mdnice编辑器"><span></span><span>5. 基于已有的标记以及层次结构</span></h2><p data-tool="mdnice编辑器">除了每种细胞类型的丰度之外，典型的单细胞数据集还以基于树的分层排序的形式包含有关不同细胞相似性的信息。这些层次结构可以通过基因表达的聚类（通常用于发现属于同一细胞类型的细胞簇）自动确定，也可以通过生物信息层次结构（如细胞谱系）自动确定。 tascCODA是 scCODA 的扩展，它将分层信息和实验协变量数据集成到成分计数数据的生成模型中[ Ostner et al. ，2021 ]。这对于高分辨率的细胞图谱工作特别有益。</p><h3 data-tool="mdnice编辑器"><span></span><span>5.1 层次结构聚类</span><span></span></h3><p data-tool="mdnice编辑器">要使用 tascCODA，我们首先必须定义细胞类型的分层排序。一种可能的层次聚类使用八种细胞类型，并根据它们在 PCA 表示中的相似性（皮尔逊相关性）对它们进行排序sc.tl.dendrogram。由于这种结构在我们的数据中非常简单，因此不会给我们带来很多新的见解，因此我们希望有一个更复杂的聚类。最近获得此类簇的一种方法是schist包[ Morelli等人。，2021 ]，它使用嵌套随机块模型，以不同的分辨率级别对细胞群进行聚类。使用标准设置运行该方法需要一些时间（在我们的数据上约为 15 分钟），并为我们提供了将每个单元格分配给adata.obs. 首先，我们需要通过 PCA 嵌入定义单元格之间的距离度量</p><pre data-tool="mdnice编辑器"><span></span><code>ov.pp.preprocess(adata,mode=<span>'shiftlog|pearson'</span>,n_HVGs=<span>2000</span>,)<br>ov.pp.scale(adata)<br>ov.pp.pca(adata,layer=<span>'scaled'</span>,n_pcs=<span>50</span>)<br>sc.pp.neighbors(adata, n_neighbors=<span>10</span>, n_pcs=<span>30</span>,<br>               use_rep=<span>'scaled|original|X_pca'</span>, random_state=<span>112</span>)<br><span># Calculate UMAP for visualization purposes</span><br><span>#sc.tl.umap(adata)</span><br>adata.obsm[<span>"X_mde"</span>] = ov.utils.mde(adata.obsm[<span>"scaled|original|X_pca"</span>])<br>adata<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># Begin robust gene identification</span><br>    <span># After filtration, 15215/15215 genes are kept. Among 15215 genes, 15215 genes are robust.</span><br>    <span># End of robust gene identification.</span><br>    <span># Begin size normalization: shiftlog and HVGs selection pearson</span><br>    <span># normalizing counts per cell The following highly-expressed genes are not considered during normalization factor computation:</span><br>    <span># ['Cck', 'Defa24', 'Fabp6', 'Gcg', 'Ghrl', 'Gip', 'Nts', 'Reg3b', 'Reg3g', 'Reg4', 'Sct', 'Spink4', 'Sst', 'Tff3', 'Zg16']</span><br>    <span>#     finished (0:00:00)</span><br>    <span># extracting highly variable genes</span><br>    <span># --&gt; added</span><br>    <span>#     'highly_variable', boolean vector (adata.var)</span><br>    <span>#     'highly_variable_rank', float vector (adata.var)</span><br>    <span>#     'highly_variable_nbatches', int vector (adata.var)</span><br>    <span>#     'highly_variable_intersection', boolean vector (adata.var)</span><br>    <span>#     'means', float vector (adata.var)</span><br>    <span>#     'variances', float vector (adata.var)</span><br>    <span>#     'residual_variances', float vector (adata.var)</span><br>    <span># End of size normalization: shiftlog and HVGs selection pearson</span><br>    <span># computing neighbors</span><br>    <span>#     finished: added to `.uns['neighbors']`</span><br>    <span>#     `.obsp['distances']`, distances for each pair of neighbors</span><br>    <span>#     `.obsp['connectivities']`, weighted adjacency matrix (0:00:16)</span><br><br><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>ov.utils.cluster(adata,method=<span>'schist'</span>, random_seed=<span>112</span>)<br>adata<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># WARNING: Threading backend does not work with this version of graph-tool</span><br>    <span># Switching to loky backend</span><br>    <span># minimizing the nested Stochastic Block Model</span><br>    <span>#         minimization step done (0:09:20)</span><br>    <span>#         consensus step done (0:12:35)</span><br>    <span>#     done (0:12:35)</span><br>    <span>#     finished: and added</span><br>    <span>#     'nsbm', the cluster labels (adata.obs, categorical) (0:12:35)</span><br><br><br><br><br><br>    <span># AnnData object with n_obs × n_vars = 9842 × 15215</span><br>    <span>#     obs: 'batch', 'barcode', 'condition', 'cell_label', 'nsbm_level_0', 'nsbm_level_1', 'nsbm_level_2', 'nsbm_level_3', 'nsbm_level_4', 'nsbm_level_5', 'nsbm_level_6'</span><br>    <span>#     var: 'robust', 'highly_variable_features'</span><br>    <span>#     uns: 'scaled|original|pca_var_ratios', 'scaled|original|cum_sum_eigenvalues', 'neighbors', 'schist'</span><br>    <span>#     obsm: 'scaled|original|X_pca', 'X_mde', 'CM_nsbm_level_0', 'CM_nsbm_level_1', 'CM_nsbm_level_2', 'CM_nsbm_level_3', 'CM_nsbm_level_4', 'CM_nsbm_level_5', 'CM_nsbm_level_6'</span><br>    <span>#     varm: 'scaled|original|pca_loadings'</span><br>    <span>#     layers: 'counts', 'scaled', 'lognorm'</span><br>    <span>#     obsp: 'distances', 'connectivities'</span><br><br><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>ov.utils.embedding(adata,<br>                   basis=<span>'X_mde'</span>,<br>                    frameon=<span>'small'</span>,<br>                   color=[<span>"nsbm_level_1"</span>, <span>"nsbm_level_2"</span>,<br>                           <span>"nsbm_level_3"</span>,<span>"cell_label"</span>],<br>                   ncols=<span>2</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035332" data-ratio="0.7453703703703703" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdVYyDngXBDoqNFIqRBRiaQUnejxmjatAUXJaUaSaEehgnXBXUWWmD7WA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdVYyDngXBDoqNFIqRBRiaQUnejxmjatAUXJaUaSaEehgnXBXUWWmD7WA/640?wx_fmt=png&amp;from=appmsg"><figcaption>细胞层次簇</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>adata.write_h5ad(<span>'tmp/tasccoda_schist.h5ad'</span>,compression=<span>'gzip'</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>5.2 初始化TAsccoda模型</span><span></span></h3><p data-tool="mdnice编辑器">对于TAsccoda模型而言，我们需要在树的层面上作为样本的输入，即从<code>cell_level</code>变成<code>cluster_level</code>，我们希望簇的规模能尽可能大一些，而不是过小，所以我们从<code>nsbm_level_1</code>开始。</p><pre data-tool="mdnice编辑器"><span></span><code>tasccoda_model = pt.tl.Tasccoda()<br>tasccoda_data = tasccoda_model.load(<br>    adata,<br>    type=<span>"cell_level"</span>,<br>    cell_type_identifier=<span>"nsbm_level_1"</span>,<br>    sample_identifier=<span>"batch"</span>,<br>    covariate_obs=[<span>"condition"</span>],<br>    levels_orig=[<span>"nsbm_level_4"</span>, <span>"nsbm_level_3"</span>, <span>"nsbm_level_2"</span>, <span>"nsbm_level_1"</span>],<br>    add_level_name=<span>True</span>,<br>)<br>tasccoda_data<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span># MuData object with n_obs × n_vars = 9852 × 15257</span><br><span>#   2 modalities</span><br><span>#     rna:    9842 x 15215</span><br><span>#       obs:  &amp;#x27;batch&amp;#x27;, &amp;#x27;barcode&amp;#x27;, &amp;#x27;condition&amp;#x27;, &amp;#x27;cell_label&amp;#x27;, &amp;#x27;nsbm_level_0&amp;#x27;, &amp;#x27;nsbm_level_1&amp;#x27;, &amp;#x27;nsbm_level_2&amp;#x27;, &amp;#x27;nsbm_level_3&amp;#x27;, &amp;#x27;nsbm_level_4&amp;#x27;, &amp;#x27;nsbm_level_5&amp;#x27;, &amp;#x27;nsbm_level_6&amp;#x27;</span><br><span>#       var:  &amp;#x27;robust&amp;#x27;, &amp;#x27;highly_variable_features&amp;#x27;</span><br><span>#       uns:  &amp;#x27;scaled|original|pca_var_ratios&amp;#x27;, &amp;#x27;scaled|original|cum_sum_eigenvalues&amp;#x27;, &amp;#x27;neighbors&amp;#x27;, &amp;#x27;schist&amp;#x27;, &amp;#x27;nsbm_level_1_colors&amp;#x27;, &amp;#x27;nsbm_level_2_colors&amp;#x27;, &amp;#x27;nsbm_level_3_colors&amp;#x27;, &amp;#x27;cell_label_colors&amp;#x27;</span><br><span>#       obsm: &amp;#x27;scaled|original|X_pca&amp;#x27;, &amp;#x27;X_mde&amp;#x27;, &amp;#x27;CM_nsbm_level_0&amp;#x27;, &amp;#x27;CM_nsbm_level_1&amp;#x27;, &amp;#x27;CM_nsbm_level_2&amp;#x27;, &amp;#x27;CM_nsbm_level_3&amp;#x27;, &amp;#x27;CM_nsbm_level_4&amp;#x27;, &amp;#x27;CM_nsbm_level_5&amp;#x27;, &amp;#x27;CM_nsbm_level_6&amp;#x27;</span><br><span>#       varm: &amp;#x27;scaled|original|pca_loadings&amp;#x27;</span><br><span>#       layers:   &amp;#x27;counts&amp;#x27;, &amp;#x27;scaled&amp;#x27;, &amp;#x27;lognorm&amp;#x27;</span><br><span>#       obsp: &amp;#x27;distances&amp;#x27;, &amp;#x27;connectivities&amp;#x27;</span><br><span>#     coda:   10 x 42</span><br><span>#       obs:  &amp;#x27;condition&amp;#x27;, &amp;#x27;nsbm_level_5&amp;#x27;, &amp;#x27;nsbm_level_6&amp;#x27;</span><br><span>#       var:  &amp;#x27;n_cells&amp;#x27;</span><br><span>#       uns:  &amp;#x27;tree&amp;#x27;</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>5.3 TAsccoda模型训练</span><span></span></h3><p data-tool="mdnice编辑器">tascCODA 中的模型设置和执行与 scCODA 类似，参考的自由参数和公式也相同。此外，我们可以通过参数phi和lambda_1参数来调整树聚合和模型选择pen_args（有关更多信息，请参阅[ Ostner et al. , 2021 ] ）。在这里，我们使用无偏设置phi=0和模型选择，该模型选择比默认的(<code>lambda_1=1.7</code>)稍微宽松一些。</p><p data-tool="mdnice编辑器">值得注意的是，我们发现内分泌细胞组主要是簇18，那么我们可以用簇18来做<code>reference_cell_type</code></p><pre data-tool="mdnice编辑器"><span></span><code>tasccoda_model.prepare(<br>    tasccoda_data,<br>    modality_key=<span>"coda"</span>,<br>    reference_cell_type=<span>"18"</span>,<br>    formula=<span>"condition"</span>,<br>    pen_args={<span>"phi"</span>: <span>0</span>, <span>"lambda_1"</span>: <span>3.5</span>},<br>    tree_key=<span>"tree"</span>,<br>)<br>tasccoda_model.run_nuts(<br>    tasccoda_data, modality_key=<span>"coda"</span>, rng_key=<span>112</span>, <br>    num_samples=<span>10000</span>, num_warmup=<span>1000</span><br>)<br></code></pre><pre data-tool="mdnice编辑器">Zero counts encountered in data! Added a pseudocount of <span>0.5</span>.<br></pre><pre data-tool="mdnice编辑器"><span></span><code><span>#    sample: 100%|██████████| 11000/11000 [04:52&lt;00:00, 37.61it/s, 63 steps of size 8.74e-02. acc. prob=0.91]</span><br></code></pre><p data-tool="mdnice编辑器">我们发现，TAscCODA的acc达到了0.91，远高于scCODA的0.76，这表明TAscCODA有着更好的准确性与可解释性。</p><h3 data-tool="mdnice编辑器"><span></span><span>5.4 TAsccoda模型的解释性</span><span></span></h3><p data-tool="mdnice编辑器">tascCODA 的结果首先应该被解释为对树节点的影响。节点上的非零参数意味着该节点下所有细胞类型的聚合计数显着变化。我们可以轻松地将这三种疾病状态的树状图可视化。蓝色圆圈表示增加，红色圆圈表示减少</p><pre data-tool="mdnice编辑器"><span></span><code>pt.pl.coda.draw_effects(<br>    tasccoda_data,<br>    modality_key=<span>"coda"</span>,<br>    tree=<span>"tree"</span>,<br>    covariate=<span>"condition[T.Salmonella]"</span>,<br>    show_leaf_effects=<span>False</span>,<br>    show_legend=<span>False</span>,<br>)<br></code></pre><p data-tool="mdnice编辑器">或者，对内部节点的影响也可以通过树转换到细胞类型级别，从而允许像 scCODA 一样计算对数倍数变化。为了可视化细胞类型的对数倍数变化，我们绘制了与 scCODA 相同的图。</p><pre data-tool="mdnice编辑器"><span></span><code>pt.pl.coda.effects_barplot(tasccoda_data, modality_key=<span>"coda"</span>, <br>                           covariates=<span>"condition"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035329" data-ratio="0.15833333333333333" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdCEJJHU8jzFhkN2FuYzdQmWR3ovwP8RShI9F177jIOnZZC1Da8BsicRg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdCEJJHU8jzFhkN2FuYzdQmWR3ovwP8RShI9F177jIOnZZC1Da8BsicRg/640?wx_fmt=png&amp;from=appmsg"><figcaption>细胞组成分析2</figcaption></figure><p data-tool="mdnice编辑器">通过绘制 UMAP 嵌入上每个条件的效应大小，并将其与细胞类型分配进行比较，可以获得另一种富有洞察力的表示</p><pre data-tool="mdnice编辑器"><span></span><code>kwargs = {<span>"ncols"</span>: <span>3</span>, <span>"wspace"</span>: <span>0.25</span>, <span>"vcenter"</span>: <span>0</span>, <span>"vmax"</span>: <span>1.5</span>, <span>"vmin"</span>: <span>-1.5</span>}<br>tasccoda_data[<span>"rna"</span>].obsm[<span>'X_umap'</span>]=tasccoda_data[<span>"rna"</span>].obsm[<span>'X_mde'</span>]<br>pt.pl.coda.effects_umap(<br>    tasccoda_data,<br>    effect_name=[<br>        <span>"effect_df_condition[T.Salmonella]"</span>,<br>        <span>"effect_df_condition[T.Hpoly.Day3]"</span>,<br>        <span>"effect_df_condition[T.Hpoly.Day10]"</span>,<br>    ],<br>    cluster_key=<span>"nsbm_level_1"</span>,<br>    **kwargs<br>)<br>ov.utils.embedding(<br>    tasccoda_data[<span>"rna"</span>], <br>    basis=<span>'X_mde'</span>,<br>    color=[<span>"cell_label"</span>, <span>"nsbm_level_1"</span>], <br>    ncols=<span>2</span>, wspace=<span>0.5</span>,<br>    frameon=<span>'small'</span><br>)<br></code></pre><p data-tool="mdnice编辑器"><img data-imgfileid="100035330" data-ratio="0.2972222222222222" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7Mdia4Gthrmxfz5Q8x4iczFn0icRciaAkgY7u98MvHbicSka1tPha5txBBQEhg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7Mdia4Gthrmxfz5Q8x4iczFn0icRciaAkgY7u98MvHbicSka1tPha5txBBQEhg/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100035338" data-ratio="0.3416666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdBIMG7xWMkr0bial9F7beYYUV5h014zEa5z2ZJ6Q26l2c1XO4w9YkOFQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7MdBIMG7xWMkr0bial9F7beYYUV5h014zEa5z2ZJ6Q26l2c1XO4w9YkOFQ/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">结果与 scCODA 的发现非常相似：</p><ul data-tool="mdnice编辑器"><li><section>对于沙门氏菌感染，我们得到簇的聚集增加，大约代表细胞类型簇中的肠细胞。对于簇 12,18,7,9，这种增加甚至更强，如对叶水平的额外积极影响所示</section></li><li><section>对于寄生线虫感染，3 天后我们没有得到可信的变化。10 天后，我们发现包含干细胞（Stem）和转运扩增细胞（TA）的细胞簇减少，肠上皮细胞（Enterocytes）和肠上皮细胞祖细胞（Enterocyte progenitors）的减少也不太明显，scCODA 也发现了这一点。</section></li></ul><p data-tool="mdnice编辑器">此时的发现与原始论文则较为一致。</p><h2 data-tool="mdnice编辑器"><span></span><span>6. 无明确的细胞类型标记（发育）</span></h2><p data-tool="mdnice编辑器">还有一种有意思的情况是发育过程中，细胞的状态演变及比例变化。此时细胞位于过渡态居多，如果我们继续使用scCODA或者是TAscCODA，我们根据明确的细胞注释作为参考是不太恰当的。在这里有一些根据KNN邻域图的方法，或许会对发育过程中细胞谱系的变化，有一定帮助。注意，探究发育过程中的细胞比例变化的意义是不大的。这是因为多种细胞会有共享状态。此时，我们会考虑，不同的药物处理组，是否会带来不同的发育轨迹，而不是细胞比例的相关分析。</p><ul data-tool="mdnice编辑器"><li><section>DA-seq 使用一系列 k 值，根据细胞邻域中两种生物状态的细胞的相对流行率，为每个细胞计算一个分数[ Zhao et al. ，2021 ]。这些分数用作逻辑分类器的输入，以预测每个细胞的生物状况。</section></li><li><section>Milo 将细胞分配到 KNN 图上部分重叠的邻域，然后使用广义线性模型 (GLM) 对细胞计数进行差异丰度 (DA) 测试[ Dann等人，2017]。，2022 ]。</section></li><li><section>MELD 使用基于图形的密度估计来计算在每种条件下观察每个细胞的相对似然估计[ Burkhardt等人。，2021 ]。</section></li></ul><p data-tool="mdnice编辑器">受限于章节内容长度，本小节内容不做详细展开，感兴趣的可以自行去使用Milo进行分析，教程地址：https://www.sc-best-practices.org/conditions/compositional.html</p><h2 data-tool="mdnice编辑器"><span></span><span>7. 总结</span></h2><ul data-tool="mdnice编辑器"><li><section>如果主要兴趣在于已知细胞类型或状态之间的组成变化，请使用 scCODA 或 tascCODA 来统计评估丰度变化。</section></li><li><section>如果数据没有明显聚类（例如在发育过程中），如果我们对可能出现在细胞类型之间的过渡状态或特定子集中的细胞丰度差异感兴趣，则应使用基于 KNN 的方法，例如 DA-Seq 或 MILO给定细胞类型的细胞。</section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span>8. 思考</span></h2><ul data-tool="mdnice编辑器"><li><section>从视觉上直观推断细胞比例变化是很困难的。为什么？</section></li><li><section>为什么需要将细胞类型丰度解释为比例而不是绝对计数？不这样做会有什么问题？</section></li><li><section>在什么情况下应该使用使用簇信息（例如细胞类型）的工具，在什么情况下应该使用不使用簇信息的工具？</section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span>写在文末</span></h2><p data-tool="mdnice编辑器">如果你对omicverse的使用有什么疑问，或者也想加入一起开发擅长，想在生物信息学工具开发路上找到同道中人，那么这个Python的转录组学分析框架与生态交流群请不要错过。</p><p data-tool="mdnice编辑器">如果群满了也可以关注我们的github仓库获取最新消息：https://github.com/Starlitnightly/omicverse</p><figure data-tool="mdnice编辑器"><img data-cropselx1="0" data-cropselx2="474" data-cropsely1="0" data-cropsely2="249" data-imgfileid="100035337" data-ratio="1.1902439024390243" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7Mdm1RI1Mtm8VvtaRLGeOXgKRxzaibAmnLqOKK7PjeZekJ6jFk6eawhROA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="820" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSaGKjyKTBmBxeg4AyXl7Mdm1RI1Mtm8VvtaRLGeOXgKRxzaibAmnLqOKK7PjeZekJ6jFk6eawhROA/640?wx_fmt=png&amp;from=appmsg"></figure></section><section><p><br></p><p><br></p><section data-style-type="5" data-tools="新媒体排版" data-id="2440476"><section><section><section><section><img data-imgfileid="100035273" data-ratio="0.9495798319327731" data-src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif" data-type="gif" data-w="119" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif"></section><section data-brushtype="text">往期回顾</section><section><br></section></section></section></section><section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518840&amp;idx=1&amp;sn=51edf03832661ee6ecd49f583e7f4fca&amp;chksm=ea1c8cfadd6b05ec6913045b86a3e8f693c2c3fba9437bfc5e38b43cb05c64db8ab45587e48f&amp;scene=21#wechat_redirect" textvalue="单细胞分析支持人类前列腺癌研究中腺泡-神经内分泌的转分化的观点" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞分析支持人类前列腺癌研究中腺泡-神经内分泌的转分化的观点</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518857&amp;idx=1&amp;sn=cd3a18c74db1f51d96caefc79db172d4&amp;chksm=ea1c8c0bdd6b051d8fb92b2daf58187c1a17cf5e43261fc95a107608be3b01772a8d55514563&amp;scene=21#wechat_redirect" textvalue="一起学之单细胞高级分析SCENIC-R语言版" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>一起学之单细胞高级分析SCENIC-R语言版</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518832&amp;idx=1&amp;sn=292407e85bc2b169861bcd1d82aaae39&amp;chksm=ea1c8cf2dd6b05e477962ad1737ae6b7d12f3833359cb39645b83dea1d92e532e596fb4cf875&amp;scene=21#wechat_redirect" textvalue="单细胞测序最好的教程（十一）：差异表达基因分析｜或许比pseudobulk更优" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞测序最好的教程（十一）：差异表达基因分析｜或许比pseudobulk更优</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515825&amp;idx=2&amp;sn=5122e66e005b04194ee21569d8c8245f&amp;chksm=ea1cb833dd6b312560d4da99a3ed73c7110d5ce84ae71bb8f9d3ab565de3f077521f0ff04ad0&amp;scene=21#wechat_redirect" textvalue="单细胞测序最好的教程（十）：万能的Transformer与细胞注释" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞测序最好的教程（十）：万能的Transformer与细胞注释</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515808&amp;idx=1&amp;sn=271304f9dbf9a7e504f5e7644c207046&amp;chksm=ea1cb822dd6b313430cc7a76a713b603552598db95ec32fb66dfc1adbfd8d4ed622b44002a51&amp;scene=21#wechat_redirect" textvalue="单细胞测序最好的教程（九）: 发表在Science的细胞注释算法" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞测序最好的教程（九）: 发表在Science的细胞注释算法</span></a></p></section></section><hr><p><br></p></section><section data-style-type="5" data-tools="新媒体排版" data-id="2440475"><hr><p><br></p><hr><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527207&amp;idx=1&amp;sn=fb9ca814003fc24e9ec8b1bcecbd1d56&amp;chksm=9b4b2b9cac3ca28afc5b68047e5f0587b6636d52879051decd573009e38313c5f7d6b0d1927d&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课2024年1月班" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信入门&amp;数据挖掘线上直播课2024年1月班</a><br></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">时隔5年，我们的生信技能树VIP学徒继续招生啦</a><br></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526168&amp;idx=1&amp;sn=ebc4a9d53d675e3f7d20b1e2f97901b8&amp;chksm=9b4b27a3ac3caeb5ee0828c38f816c229067d1946be224bcaf4bac0dbdfc9eff863c621097e2&amp;scene=21#wechat_redirect" textvalue="生物信息学江湖的开创性产品-共享服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学江湖的开创性产品-共享服务器</a></p></li></ul><p><img data-imgfileid="100035269" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg" data-type="other" data-w="341" data-imgfileid="100035270" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-id="93668"><section><section data-width="95%"><section><section><section data-width="38%"><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-imgfileid="100035272" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg" data-type="other" data-w="258" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/yYTxb_kOjeRSkzzuUoI4mA",target="_blank" rel="noopener noreferrer">原文链接</a>
