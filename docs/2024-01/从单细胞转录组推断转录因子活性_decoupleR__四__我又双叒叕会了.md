---
title: "从单细胞转录组推断转录因子活性？decoupleR (四)：我又双叒叕会了"
date: 2024-01-23T01:08:45Z
draft: ["false"]
tags: [
  "fetched",
  "生信益站"
]
categories: ["Acdemic"]
---
从单细胞转录组推断转录因子活性？decoupleR (四)：我又双叒叕会了 by 生信益站
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><figure data-tool="mdnice编辑器"></figure></section></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><figure data-tool="mdnice编辑器"><img data-imgfileid="100022204" data-ratio="0.278125" data-src="https://mmbiz.qpic.cn/sz_mmbiz_gif/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgV9CA29Dlf9avbibl8NMLPRTk0gqabiaHSZ3cFwDlpsp83n6JUib2zcgPjw/640?wx_fmt=gif&amp;from=appmsg" data-type="gif" data-w="640" src="https://mmbiz.qpic.cn/sz_mmbiz_gif/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgV9CA29Dlf9avbibl8NMLPRTk0gqabiaHSZ3cFwDlpsp83n6JUib2zcgPjw/640?wx_fmt=gif&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><code>生信益站，一点就有益</code>！<strong>「祝友友们天天开心，月月发 CNS~」</strong></p><section><mp-common-profile data-pluginname="mpprofile" data-id="MzU1NTk0MTUxMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/mhoJzVKWSibicV5ezibIjic3zhPgzQcTD8N0hm3q2fO2QgBoVFIuRWy6BKffGjfXOzI7foLDlyrHWfRUMkicOCSKq4g/0?wx_fmt=png" data-nickname="生信益站" data-alias="" data-signature="生物信息或基因测序数据分析、软件算法、科研绘图、Python/Perl/R代码分享。" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><h1 data-tool="mdnice编辑器"><span>各位友友记得将<code>益站</code>设为</span><span><code>星标</code></span><span>哈</span></h1><h1 data-tool="mdnice编辑器"><span></span><span>这样才能<code>更容易</code>在每天<code>早上八点</code>收到我们的<code>推送</code>哈~</span><span></span></h1><figure data-tool="mdnice编辑器"><img data-imgfileid="100022200" data-ratio="0.4090909090909091" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVhBHxMHO22EUlyVwITLvxnBia8pmzXibwZSWxbNiavfA5VcyvawdskIdKQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="440" src="https://mmbiz.qpic.cn/sz_mmbiz_png/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVhBHxMHO22EUlyVwITLvxnBia8pmzXibwZSWxbNiavfA5VcyvawdskIdKQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">关于 <code>decoupleR</code>，站长已经写了 <code>3</code> 篇推文了：</p><ol data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU1NTk0MTUxMg==&amp;mid=2247505149&amp;idx=1&amp;sn=0f0cc15b78ad53b739c1cb48271f9801&amp;chksm=fbce3f1accb9b60c9c14aeb95c45ce6d3e59cedd237daf46bc0f951b12d0649c3b0a2b2f9378&amp;scene=21#wechat_redirect" textvalue="哪些基因激活/抑制了你的通路？decoupleR (一)：这个我会" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">哪些基因激活/抑制了你的<code>通路</code>？decoupleR (一)：这个我会</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU1NTk0MTUxMg==&amp;mid=2247505188&amp;idx=1&amp;sn=a5d4693d256c72ebeedbf7ce9c99d578&amp;chksm=fbce3ec3ccb9b7d57491ab2e00d1717a59fbfb0b261b820c1c77dd5881a4bf1f95f1f74ff34a&amp;scene=21#wechat_redirect" textvalue="如何用转录组推断转录因子活性？decoupleR (二)：这个我也会！" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">如何用<code>转录组</code>推断<code>转录因子</code>活性？decoupleR (二)：这个我也会！</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU1NTk0MTUxMg==&amp;mid=2247505494&amp;idx=1&amp;sn=fb418ef9bbc483a93a83510ecd9529ff&amp;chksm=fbce3db1ccb9b4a7744d0980ac309f61b91f45c75a8cee8b61a68f97e8c8a8748ef20f200053&amp;scene=21#wechat_redirect" textvalue="从单细胞转录组推断通路活性？decoupleR（三）：这个我还会" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">从<code>单细胞</code>转录组推断<code>通路</code>活性？decoupleR（三）：这个我还会</a></section></li></ol><p data-tool="mdnice编辑器">今天给大家带来 <code>decoupleR</code> 第 <code>4</code> 篇——从 <code>scRNA-seq</code> 推断<code>转录因子活性</code>。</p><h2 data-tool="mdnice编辑器"><span></span><span>加载包</span><span></span></h2><p data-tool="mdnice编辑器">首先，我们需要加载相关包，Seurat 处理 scRNA-seq 数据，decoupleR 使用统计方法。</p><pre data-tool="mdnice编辑器"><span></span><code><span>## We load the required packages</span><br><span>library</span>(Seurat)<br><span>library</span>(decoupleR)<br><br><span># Only needed for data handling and plotting</span><br><span>library</span>(dplyr)<br><span>library</span>(tibble)<br><span>library</span>(tidyr)<br><span>library</span>(patchwork)<br><span>library</span>(ggplot2)<br><span>library</span>(pheatmap)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>加载数据集</span><span></span></h2><p data-tool="mdnice编辑器">Seurat 在这里，我们使用了小插图中使用的数据的下采样版本 。我们可以这样打开数据：</p><pre data-tool="mdnice编辑器"><span></span><code>inputs_dir &lt;- system.file(<span>"extdata"</span>, package = <span>"decoupleR"</span>)<br>data &lt;- readRDS(file.path(inputs_dir, <span>"sc_data.rds"</span>))<br></code></pre><p data-tool="mdnice编辑器">此时，可以观察到不同的细胞类型：</p><pre data-tool="mdnice编辑器"><span></span><code>DimPlot(data, reduction = <span>"umap"</span>, label = <span>TRUE</span>, pt.size = <span>0.5</span>) + NoLegend()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100022201" data-ratio="0.6175925925925926" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVKjTqTvCqYt2YibfOH15xWhbnqGiamO8EJicibC1UemuBmUx9icKWmEvcTSw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVKjTqTvCqYt2YibfOH15xWhbnqGiamO8EJicibC1UemuBmUx9icKWmEvcTSw/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>CollecTRI 网络</span><span></span></h2><p data-tool="mdnice编辑器"><code>CollecTRI</code> 是一个综合资源，包含由 12 个不同资源编译而成的 TF 及其转录目标的精选集合。与我们之前的 DoRothEA 网络和其他基于文献的 GRN 相比，该集合提供了更多的转录因子覆盖范围，并且在识别受干扰的 TF 方面具有卓越的性能。与 DoRothEA 类似，相互作用按其调节模式（激活或抑制）进行加权。</p><p data-tool="mdnice编辑器">在本例中，我们将使用人类版本（也可以使用小鼠和大鼠）。我们可以使用 decoupleR 从 OmniPath 检索它。该参数 <code>split_complexes</code> 保留复合体或将它们分成子单元，默认情况下我们建议将复合体保持在一起。</p><pre data-tool="mdnice编辑器"><span></span><code>net &lt;- get_collectri(organism=<span>'human'</span>, split_complexes=<span>FALSE</span>)<br>net<br><span>#&gt; # A tibble: 43,178 × 3</span><br><span>#&gt;    source target   mor</span><br><span>#&gt;    &lt;chr&gt;  &lt;chr&gt;  &lt;dbl&gt;</span><br><span>#&gt;  1 MYC    TERT       1</span><br><span>#&gt;  2 SPI1   BGLAP      1</span><br><span>#&gt;  3 SMAD3  JUN        1</span><br><span>#&gt;  4 SMAD4  JUN        1</span><br><span>#&gt;  5 STAT5A IL2        1</span><br><span>#&gt;  6 STAT5B IL2        1</span><br><span>#&gt;  7 RELA   FAS        1</span><br><span>#&gt;  8 WT1    NR0B1      1</span><br><span>#&gt;  9 NR0B2  CASP1      1</span><br><span>#&gt; 10 SP1    ALDOA      1</span><br><span>#&gt; # ℹ 43,168 more rows</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>使用单变量线性模型 (ULM) 进行活性推断</span><span></span></h2><p data-tool="mdnice编辑器">为了推断 TF 富集分数，我们将运行单变量线性模型 ( ulm) 方法。对于数据集中的每个样本 ( mat) 和网络中的每个 TF net，它都拟合一个线性模型，该模型仅根据 TF 的 TF-Gene 相互作用权重来预测观察到的基因表达。拟合后，获得的斜率 t 值就是分数。如果为正，我们认为 TF 处于活跃状态；如果为负，我们认为 TF 处于非活跃状态。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100022203" data-ratio="0.6638888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVdIJiafYcp0icSj1ZMLaKytAzbuibIZcMO6YQg9HvgpDoD94IwSKS5RicTQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVdIJiafYcp0icSj1ZMLaKytAzbuibIZcMO6YQg9HvgpDoD94IwSKS5RicTQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">要运行 decoupleR 方法，我们需要一个输入矩阵 ( mat)、一个输入先验知识网络/资源 ( 上一步得到的 net) 以及我们要使用的网络列名。</p><pre data-tool="mdnice编辑器"><span></span><code><span># Extract the normalized log-transformed counts</span><br>mat &lt;- as.matrix(data@assays$RNA@data)<br><br><span># Run ulm</span><br>acts &lt;- run_ulm(mat=mat, net=net, .source=<span>'source'</span>, .target=<span>'target'</span>,<br>                .mor=<span>'mor'</span>, minsize = <span>5</span>)<br>acts<br><span>#&gt; # A tibble: 80,640 × 5</span><br><span>#&gt;    statistic source condition        score  p_value</span><br><span>#&gt;    &lt;chr&gt;     &lt;chr&gt;  &lt;chr&gt;            &lt;dbl&gt;    &lt;dbl&gt;</span><br><span>#&gt;  1 ulm       MYC    AAACATACAACCAC-1 13.5  3.54e-41</span><br><span>#&gt;  2 ulm       MYC    AAACGCTGTTTCTG-1  8.09 6.78e-16</span><br><span>#&gt;  3 ulm       MYC    AACCTTTGGACGGA-1 12.0  1.04e-32</span><br><span>#&gt;  4 ulm       MYC    AACGCCCTCGTACA-1 10.4  3.11e-25</span><br><span>#&gt;  5 ulm       MYC    AACGTCGAGTATCG-1 10.8  4.20e-27</span><br><span>#&gt;  6 ulm       MYC    AACTCACTCAAGCT-1 10.1  5.15e-24</span><br><span>#&gt;  7 ulm       MYC    AAGATGGAAAACAG-1 11.4  5.79e-30</span><br><span>#&gt;  8 ulm       MYC    AAGATTACCGCCTT-1 13.4  1.64e-40</span><br><span>#&gt;  9 ulm       MYC    AAGCCATGAACTGC-1 11.8  5.50e-32</span><br><span>#&gt; 10 ulm       MYC    AAGGTCTGCAGATC-1 12.3  1.56e-34</span><br><span>#&gt; # ℹ 80,630 more rows</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>可视化</span><span></span></h2><p data-tool="mdnice编辑器">根据获得的结果，我们将它们存储在我们的对象中作为一个新的 <code>assay</code>，称为 <code>tfsulm</code>：</p><pre data-tool="mdnice编辑器"><span></span><code><span># Extract ulm and store it in tfsulm in pbmc</span><br>data[[<span>'tfsulm'</span>]] &lt;- acts %&gt;%<br>  pivot_wider(id_cols = <span>'source'</span>, names_from = <span>'condition'</span>,<br>              values_from = <span>'score'</span>) %&gt;%<br>  column_to_rownames(<span>'source'</span>) %&gt;%<br>  Seurat::CreateAssayObject(.)<br><br><span># Change assay</span><br>DefaultAssay(object = data) &lt;- <span>"tfsulm"</span><br><br><span># Scale the data</span><br>data &lt;- ScaleData(data)<br>data@assays$tfsulm@data &lt;- data@assays$tfsulm@scale.data<br></code></pre><p data-tool="mdnice编辑器">这种新的 <code>assay</code> 可用于绘制活性图。在这里，我们观察了推断的 PAX5 跨细胞活性，它在 B 细胞中特别活跃。<span><strong>有趣的是，PAX5 是一种已知的对 B 细胞身份和功能至关重要的 TF。从目标基因的“足迹”推断活性比仅仅查看给定 TF 的分子读数更能提供信息，</strong></span>这里的一个例子是 PAX5 的基因表达，其本身的信息量并不大：</p><pre data-tool="mdnice编辑器"><span></span><code>p1 &lt;- DimPlot(data, reduction = <span>"umap"</span>, label = <span>TRUE</span>, pt.size = <span>0.5</span>) +<br>  NoLegend() + ggtitle(<span>'Cell types'</span>)<br>p2 &lt;- (FeaturePlot(data, features = c(<span>"PAX5"</span>)) &amp;<br>  scale_colour_gradient2(low = <span>'blue'</span>, mid = <span>'white'</span>, high = <span>'red'</span>)) +<br>  ggtitle(<span>'PAX5 activity'</span>)<br>DefaultAssay(object = data) &lt;- <span>"RNA"</span><br>p3 &lt;- FeaturePlot(data, features = c(<span>"PAX5"</span>)) + ggtitle(<span>'PAX5 expression'</span>)<br>DefaultAssay(object = data) &lt;- <span>"tfsulm"</span><br>p1 | p2 | p3<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100022202" data-ratio="0.3333333333333333" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVE4v6OT33jZ218tW9KCNkDOZKqPd5TzPv0JUeFpk0KZiaeBiaj53bQm6g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVE4v6OT33jZ218tW9KCNkDOZKqPd5TzPv0JUeFpk0KZiaeBiaj53bQm6g/640?wx_fmt=png&amp;from=appmsg"><figcaption><span></span>左中右以此为Umap图、PAX5活性图、PAX5表达图</figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>探索</span><span></span></h2><p data-tool="mdnice编辑器">我们还可以查看 <code>top 25</code> 个较大变异的 TF 每组的平均活性是多少：</p><pre data-tool="mdnice编辑器"><span></span><code>n_tfs &lt;- <span>25</span><br><span># Extract activities from object as a long dataframe</span><br>df &lt;- t(as.matrix(data@assays$tfsulm@data)) %&gt;%<br>  as.data.frame() %&gt;%<br>  mutate(cluster = Idents(data)) %&gt;%<br>  pivot_longer(cols = -cluster, names_to = <span>"source"</span>, values_to = <span>"score"</span>) %&gt;%<br>  group_by(cluster, <span>source</span>) %&gt;%<br>  summarise(mean = mean(score))<br><br><span># Get top tfs with more variable means across clusters</span><br>tfs &lt;- df %&gt;%<br>  group_by(<span>source</span>) %&gt;%<br>  summarise(std = sd(mean)) %&gt;%<br>  arrange(-abs(std)) %&gt;%<br>  head(n_tfs) %&gt;%<br>  pull(<span>source</span>)<br><br><span># Subset long data frame to top tfs and transform to wide matrix</span><br>top_acts_mat &lt;- df %&gt;%<br>  filter(<span>source</span> %<span>in</span>% tfs) %&gt;%<br>  pivot_wider(id_cols = <span>'cluster'</span>, names_from = <span>'source'</span>,<br>              values_from = <span>'mean'</span>) %&gt;%<br>  column_to_rownames(<span>'cluster'</span>) %&gt;%<br>  as.matrix()<br><br><span># Choose color palette</span><br>palette_length = <span>100</span><br>my_color = colorRampPalette(c(<span>"Darkblue"</span>, <span>"white"</span>,<span>"red"</span>))(palette_length)<br><br>my_breaks &lt;- c(seq(-<span>3</span>, <span>0</span>, length.out=ceiling(palette_length/<span>2</span>) + <span>1</span>),<br>               seq(<span>0.05</span>, <span>3</span>, length.out=floor(palette_length/<span>2</span>)))<br><br><span># Plot</span><br>pheatmap(top_acts_mat, border_color = <span>NA</span>, color=my_color, breaks = my_breaks)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100022206" data-ratio="0.6175925925925926" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVZHYSEZXwbW3d7mBjURribJ4coYwkj223JDwgEKesAXVnIuXfS2IicNkg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVZHYSEZXwbW3d7mBjURribJ4coYwkj223JDwgEKesAXVnIuXfS2IicNkg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">在这里，我们可以观察到其他已知标记 TF 的出现，EBF1 代表 B 细胞，RFX5 代表骨髓谱系，EOMES 代表淋巴系。</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">OK，今天的分享到此为止。咱们明天见~</p><h2 data-tool="mdnice编辑器"><span></span><span>联系站长</span><span></span></h2><blockquote data-tool="mdnice编辑器"><span>❝</span><p>对<code>本篇文章有疑问</code>，或者有<code>科研服务需求</code>的友友可以在益站<code>发消息留言</code>，也欢迎各位童鞋<code>扫下面的二维码</code>加入我们的 <code>QQ</code> 交流群。</p><span>❞</span></blockquote><figure data-tool="mdnice编辑器"><img data-imgfileid="100022209" data-ratio="0.7277777777777777" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVc6JL2ibJ1fykiatEMl9ibEFU1vxxUTXGCm2ute3X4bvLf3ibbL8xa5l1rg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVc6JL2ibJ1fykiatEMl9ibEFU1vxxUTXGCm2ute3X4bvLf3ibbL8xa5l1rg/640?wx_fmt=png&amp;from=appmsg"><figcaption><span></span>科研服务</figcaption></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100022207" data-ratio="1.5" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVnXtVpnyEI6yWXZGGpjMoqmJZnVKeeWiaQ5EMSb4twicXvz3YGx0ukFPA/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="512" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVnXtVpnyEI6yWXZGGpjMoqmJZnVKeeWiaQ5EMSb4twicXvz3YGx0ukFPA/640?wx_fmt=jpeg&amp;from=appmsg"><figcaption><span></span>最新QQ群</figcaption></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100022208" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_gif/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVauEOIbPvQUHVpmiaM9UelPOHjD0QDUKibQricJZ9RjuWlC1ibPDbicEu6aA/640?wx_fmt=gif&amp;from=appmsg" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/sz_mmbiz_gif/mhoJzVKWSibibYf6D1DNtXEjuqfFkvHxgVauEOIbPvQUHVpmiaM9UelPOHjD0QDUKibQricJZ9RjuWlC1ibPDbicEu6aA/640?wx_fmt=gif&amp;from=appmsg"><figcaption><span></span>您的<code>关注、点赞、在看、转发</code>是对益站最大的<code>鼓励和支持</code>哈</figcaption></figure></section><figure data-tool="mdnice编辑器"><section><mp-common-profile data-pluginname="mpprofile" data-id="MzU1NTk0MTUxMg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/mhoJzVKWSibicV5ezibIjic3zhPgzQcTD8N0hm3q2fO2QgBoVFIuRWy6BKffGjfXOzI7foLDlyrHWfRUMkicOCSKq4g/0?wx_fmt=png" data-nickname="生信益站" data-alias="" data-signature="生物信息或基因测序数据分析、软件算法、科研绘图、Python/Perl/R代码分享。" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><figcaption><br></figcaption></figure></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/oM1-3SZXgPufZXmC5Z8B2A",target="_blank" rel="noopener noreferrer">原文链接</a>
