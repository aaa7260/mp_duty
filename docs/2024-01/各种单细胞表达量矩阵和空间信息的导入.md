---
title: "各种单细胞表达量矩阵和空间信息的导入"
date: 2024-01-15T16:09:54Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
各种单细胞表达量矩阵和空间信息的导入 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>前面我们演示了R语言里面的最流行的Seurat的单细胞流程是如何导入标准10x技术空间单细胞文件， 虽然说也有其它空间单细胞技术可以产出各式各样的数据。详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527318&amp;idx=1&amp;sn=31b9b7edfc17ce302eb5f77b3e345e7c&amp;scene=21#wechat_redirect" data-linktype="2">10x的空间单细胞文件格式详解</a>，但是我们粗浅的可以认为空间单细胞约等于10x技术。不过Seurat官网确实是给出来了两个分类：</p></blockquote><ul data-tool="mdnice编辑器"><li><section>Analysis of spatial datasets (Sequencing-based)，比如：10x Visium and Slide-seq v2.</section></li><li><section>Analysis of spatial datasets (Imaging-based)，比如：MERSCOPE, Xenium, CosMx SMI, and CODEX.</section></li></ul><h3 data-tool="mdnice编辑器"><span></span>为什么现在才强推空间单细胞转录组呢<span></span></h3><p data-tool="mdnice编辑器">老实说，过去的三年虽然说我一直在朋友圈刷到有空间单细胞的cns文章，但我实际上是瞧不起这个技术的。首先它仅仅是给大红大紫的单细胞转录组续命而已，其次它根本就不是真正的单细胞水平，所以绝大部分数据分析哦度非常粗糙，仅仅是蹭热点。。。。</p><p data-tool="mdnice编辑器">详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526055&amp;idx=2&amp;sn=e7d0b5fb7fae55d2ab0daec7464e13fd&amp;scene=21#wechat_redirect" data-linktype="2">单细胞空间转录组就只能说做这么一点分析吗</a></p><p data-tool="mdnice编辑器">但是，从今天开始，一切变天了。因为真正的空间单细胞确实是来了，起码朋友圈可以看到各种动态了，我也非常期待！</p><p><img data-galleryid="" data-imgfileid="100044135" data-ratio="0.6064814814814815" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wx8aV1HpGYyicaRSvUXiboRDfOWsYA0Yb6Vugv8YXRjreRutNGicbwicSqwuokALq3gn9yqUZOu1ZTjEw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wx8aV1HpGYyicaRSvUXiboRDfOWsYA0Yb6Vugv8YXRjreRutNGicbwicSqwuokALq3gn9yqUZOu1ZTjEw/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>真正的空间单细胞</figcaption></figure><p data-tool="mdnice编辑器">而且这个变革对数据分析人员来说其实是非常友好，因为公司还是10x，所以绝大部分大家耳熟能详的数据格式，分析流程都是原模原样的，而且因为是真正的空间单细胞所以没必要在各种去卷积工具层面浪费时间精力啦。大家看到的各种各样的教程：CARD, RCTD, cell2location, DestVI,SpatialDWLS, SPOTlight, STRIDE, CellDART, Celloscope, DSTG和Stereoscope</p><p data-tool="mdnice编辑器">都可以直接丢弃了 ， 太开心了。就好像是大家做单细胞转录组的降维聚类分群，其实没有人去关心pca怎么弄，tsne和umap如何弄，因为一个Seurat全部打通，而且都是默认参数默认结果，大家需要做的是数据分析结果图表的解读，赋予生物学意义，这才是真正的技术应该发挥的作用！</p><h3 data-tool="mdnice编辑器"><span></span>权威资料：Seurat官网<span></span></h3><p data-tool="mdnice编辑器">而且Seurat官网居然有对这些全部的数据的示范的读取案例，非常棒！所以单细胞数据分析教程优先应该是看Seurat官网以及10x公司的官网。</p><p data-tool="mdnice编辑器">但是技术太多就会导致数据处理环节的教程很难写，所以我们仍然是专注于10x的空间哦，而且呢实际情况下绝大部分10x的空间单细胞文件都不标准，因为大家并不是从fq文件开始走Space Ranger。这个就是初学者的拦路虎，值得我们重点讲解。另外就是我们接下来（2023年12月30日之后）的教程都是基于Seurat的V5版本哦：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518295&amp;idx=1&amp;sn=f97bd58d2c21122ba5c7d250f7fa709e&amp;scene=21#wechat_redirect" data-linktype="2">初试Seurat的V5版本</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518314&amp;idx=1&amp;sn=b53feba8104cfb9a377518852e871c66&amp;scene=21#wechat_redirect" data-linktype="2">使用Seurat的v5来读取多个10x的单细胞转录组矩阵</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527174&amp;idx=1&amp;sn=a062d9fc438756b4953fb0d71bfaee51&amp;scene=21#wechat_redirect" data-linktype="2">使用Seurat的v5来读取多个不是10x标准文件的单细胞项目</a></section></li></ul><p data-tool="mdnice编辑器">需要理解Seurat包的一些跟10x技术空间单细胞文件的导入相关的函数，比如：</p><pre data-tool="mdnice编辑器"><span></span><code>Read10X Load <span>in</span> data from 10X<br>Read10X_h5 Read 10X hdf5 file<br>Read10X_Image Load a 10X Genomics Visium Image <br>Load10X_Spatial Load a 10x Genomics Visium Spatial Experiment into a <span>'Seurat'</span> object <br></code></pre><p data-tool="mdnice编辑器">如果你走Space Ranger拿到了全部的文件，那么 Load10X_Spatial 函数就最方便了，它会一起读取h5格式的表达量矩阵以及spatial文件夹里面的图片文件哦 。这些细节都可以在：https://rdrr.io/github/satijalab/seurat/src/R/preprocessing.R 里面找到：</p><h3 data-tool="mdnice编辑器"><span></span>首先是导入表达量矩阵（等同于常规单细胞转录组数据）<span></span></h3><p data-tool="mdnice编辑器">表达量矩阵可以是csv或者txt这样的文本文件，也可以是前面提到的Market Exchange Format (MEX) 和 Hierarchical Data Format (HDF5) 这两个来源于 spaceranger count 定量流程的 格式。</p><p data-tool="mdnice编辑器">如果是Market Exchange Format (MEX)  表达量矩阵形式，那么使用Read10X函数读取对应的文件夹即可，每个文件夹里面的3个文件名字是固定的哦。如果是Hierarchical Data Format (HDF5) 格式，那么当然是Read10X_h5啦，如果是其它格式，比如csv或者txt这样的文本文件，取决于制作这样的文件的人是如何安排里面的行列信息的，每个人都不一样哦。参考前面的单细胞转录组表达量矩阵文件读取教程即可：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518295&amp;idx=1&amp;sn=f97bd58d2c21122ba5c7d250f7fa709e&amp;scene=21#wechat_redirect" data-linktype="2">初试Seurat的V5版本</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247518314&amp;idx=1&amp;sn=b53feba8104cfb9a377518852e871c66&amp;scene=21#wechat_redirect" data-linktype="2">使用Seurat的v5来读取多个10x的单细胞转录组矩阵</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527174&amp;idx=1&amp;sn=a062d9fc438756b4953fb0d71bfaee51&amp;scene=21#wechat_redirect" data-linktype="2">使用Seurat的v5来读取多个不是10x标准文件的单细胞项目</a></section></li></ul><p data-tool="mdnice编辑器">这个时候其实并不需要理会单细胞空间转录组技术，因为还没有涉及到空间相关信息。而且这个时候<strong>没有空间信息的矩阵其实可以完完全全参考我们前面的单细胞转录组数据分析代码</strong>哦，没有如何特殊的地方。</p><h3 data-tool="mdnice编辑器"><span></span>其次是导入空间信息<span></span></h3><p data-tool="mdnice编辑器">空间信息最方便的当然是图片文件啦，其中<code>tissue_hires_image.png</code> and <code>tissue_lowres_image.png</code>，都可以读取。需要使用的就是Read10X_Image函数啦，它有两种方式，如果你的spatial文件夹是标准的，或者说里面的图片文件是齐全的， 如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>ls -lh GSE158328_RAW/A1/spatial/ |cut -d<span>" "</span> -f 7-<br><br>  1.6M Feb 20  2020 aligned_fiducials.jpg<br>  1.8M Feb 20  2020 detected_tissue_image.jpg<br>  163B Feb 20  2020 scalefactors_json.json<br>  4.6M Feb 20  2020 tissue_hires_image.png<br>  496K Feb 20  2020 tissue_lowres_image.png<br>  180K Feb 20  2020 tissue_positions_list.csv<br></code></pre><p data-tool="mdnice编辑器">那么最简单的函数就是：</p><pre data-tool="mdnice编辑器"><span></span><code>img &lt;- Read10X_Image(image.dir = file.path(<span>"./GSE158328_RAW/A1/"</span>, <br>                                              <span>"spatial"</span>), filter.matrix = <span>TRUE</span>)<br>img<br></code></pre><p data-tool="mdnice编辑器">这个函数会去这个  GSE158328_RAW/A1/spatial/  文件夹里面找自己需要的图片文件进行读取，如果你想自己指定图片文件，也是可以的；</p><pre data-tool="mdnice编辑器"><span></span><code>  d=<span>"./GSE158328_RAW/A1/spatial/"</span><br>  list.files(d)<br>  image2 = Read10X_Image(d,<span>"tissue_hires_image.png"</span>)<br></code></pre><p data-tool="mdnice编辑器">如果作者什么都不给，比如：《Spatially Resolved Multi-Omics Single-Cell Analyses Inform Mechanisms of Immune Dysfunction in Pancreatic Cancer. <em>Gastroenterology</em> 2023 Oct;165(4):891-908.e14. PMID: 37263303》文章里面的数据集是GSE205354，它就仅仅是提供了表达量矩阵没有然后空间信息，那就不可能把它当做是空间单细胞转录组数据处理了，只能说是走普通单细胞转录组的降维聚类分群流程。</p><h3 data-tool="mdnice编辑器"><span></span>接着是整合单细胞表达量矩阵和空间信息<span></span></h3><p data-tool="mdnice编辑器">上面我们读取了表达量矩阵命名为ct这个变量，它是一个稀疏矩阵，然后读取了图片文件命名为img变量，接下来就可以把这两个变量整合成为Seurat的空间单细胞对象，全部的代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span># https://rdrr.io/github/satijalab/seurat/src/R/preprocessing.R</span><br>sceP &lt;- CreateSeuratObject(counts = ct, assay = <span>"Spatial"</span>)<br>img &lt;- img[Cells(x = sceP)]<br>DefaultAssay(sceP = img) &lt;- <span>"Spatial"</span><br>sceP[[<span>'slice1'</span>]] &lt;- img <br></code></pre><p data-tool="mdnice编辑器">读取好的对象就可以走后面的降维聚类分群流程啦，前提是认真了解这个Seurat的空间单细胞对象，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527345&amp;idx=2&amp;sn=bc7118ee10c2b5c19b3d9b0dc545add8&amp;scene=21#wechat_redirect" data-linktype="2">认识Seurat的空间单细胞对象结构</a>  ：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; sceP<br>An object of class Seurat <br>33538 features across 4992 samples within 1 assay <br>Active assay: Spatial (33538 features, 0 variable features)<br> 1 layer present: counts<br> 1 image present: slice1<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>读取坐标文件作为空间信息<span></span></h3><p data-tool="mdnice编辑器">但是也有些时候作者并不公开图片文件，也可以是  <code>tissue_positions.csv</code>  这样的文本文件里面记录了空间单细胞的每个spot的坐标信息。这个时候这个坐标文件很容易读取，因为就是普通的文本文件，然后就有两个方法把坐标文件作为的空间信息整合到前面的表达量矩阵后成为Seurat的空间单细胞对象，也是需要认真了解这个Seurat的空间单细胞对象，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527345&amp;idx=2&amp;sn=bc7118ee10c2b5c19b3d9b0dc545add8&amp;scene=21#wechat_redirect" data-linktype="2">认识Seurat的空间单细胞对象结构</a>  ，就是需要修改对象里面的空间信息（images元素）。这个我们后面再分享</p><h3 data-tool="mdnice编辑器"><span></span>最后是走空间单细胞基本流程<span></span></h3><p data-tool="mdnice编辑器">就是降维聚类分群啦，参考：https://satijalab.org/seurat/articles/spatial_vignette.html</p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span>学徒作业<span></span></h3><p data-tool="mdnice编辑器">使用上面的代码，完成前面的推文《<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527318&amp;idx=1&amp;sn=31b9b7edfc17ce302eb5f77b3e345e7c&amp;scene=21#wechat_redirect" data-linktype="2">10x的空间单细胞文件格式详解</a>》里面的示例数据集的读取和后续标准分析。</p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/RIgnagb9dxhGmmpK4G10Sw",target="_blank" rel="noopener noreferrer">原文链接</a>
