---
title: "cellhint：单细胞整合分析天花板"
date: 2024-01-19T16:35:41Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
cellhint：单细胞整合分析天花板 by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">关于cellhint这个整合算法，我最早在预印本看到过https://www.biorxiv.org/content/10.1101/2023.05.01.538994v2。通讯作者是Sarah A. Teichmann大佬，关于她，不认识的小伙伴可以参考<a href="https://mp.weixin.qq.com/s?__biz=MzU1MjE5MTQwMA==&amp;mid=2247487780&amp;idx=1&amp;sn=fc5a44329377bb09cec0eaa8d252a8b2&amp;scene=21#wechat_redirect" data-linktype="2">【生信进阶之路】盘点生物信息大牛课题组 EP16：Sarah A. Teichmann</a>。</p><p data-tool="mdnice编辑器">Teichmann团队的代表作/合作算法有BBKNN算法，celltypist算法，cellphoneDB等：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247485666&amp;idx=1&amp;sn=ae0da39f47190da11c0d379c2b5bbefb&amp;scene=21#wechat_redirect" data-linktype="2">R版BBKNN整合去批次</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484838&amp;idx=1&amp;sn=d02d0ee3daaa0ea69cfbfd11b9fde844&amp;scene=21#wechat_redirect" data-linktype="2">Celltypist：超越singleR的单细胞注释工具</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247508318&amp;idx=1&amp;sn=17c096db0c85ee056f738912d5816cc0&amp;scene=21#wechat_redirect" data-linktype="2">细胞通讯分析之CellphoneDB初探（一）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247509506&amp;idx=1&amp;sn=27bd32f9b1919d4ba59ba60e40418b2e&amp;scene=21#wechat_redirect" data-linktype="2">细胞通讯分析之CellphoneDB（二）可视化篇</a></section></li></ul><p data-tool="mdnice编辑器"><strong>作为人类细胞图谱（the Human Cell Atlas，HCA）国际联盟的联合创始人和主要负责人，</strong>Teichmann团队的重心并不是开发算法，而是绘制人类单细胞组织图谱，包括：</p><ul data-tool="mdnice编辑器"><li><section>心脏【Cells of the adult human heart】：DOI: 10.1038/s41586-020-2797-4</section></li><li><section>心脏【Spatially resolved multiomics of human cardiac niches】：DOI: 10.1038/s41586-023-06311-1</section></li><li><section>肺【A cellular census of human lungs identifies novel cell states in health and in asthma】：DOI: 10.1038/s41591-019-0468-5</section></li><li><section>肺【A spatially resolved atlas of the human lung characterizes a gland-associated immune niche】：DOI: 10.1038/s41588-022-01243-4</section></li><li><section>全身【Cross-tissue immune cell analysis reveals tissue-specific features in humans】：DOI: 10.1126/science.abl5197</section></li><li><section>全身【Automatic cell-type harmonization and integration across Human Cell Atlas datasets】：DOI: https://doi.org/10.1016/j.cell.2023.11.026</section></li></ul><p data-tool="mdnice编辑器">基本都是CNS或者是大子刊，更多内容可以参考她的谷歌学术档案：https://scholar.google.co.uk/citations?user=ZMEr7wIAAAAJ&amp;hl=en</p><p data-tool="mdnice编辑器">而cellhint这个整合算法流程，最近竟然发在了Cell上（有点震惊），我认为cellhint应该是整合算法的天花板了：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004187" data-ratio="0.3139240506329114" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaxW4fPmr3WrOJicrUZ0DgwoHtHn4RiaibWS4Eic5aicWLlTmn4jw0pogBwpw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="790" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaxW4fPmr3WrOJicrUZ0DgwoHtHn4RiaibWS4Eic5aicWLlTmn4jw0pogBwpw/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222163004359</figcaption></figure><p data-tool="mdnice编辑器">关于单细胞整合算法，我写过一个系列，包括：</p><ul data-tool="mdnice编辑器"><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484318&amp;idx=1&amp;sn=daf04a599413de0514afda07928eecb9&amp;scene=21#wechat_redirect" data-linktype="2">CCA单细胞多样本整合和插槽选择（一）</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484384&amp;idx=1&amp;sn=e114a00e1594e8996bed895df64303a2&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之RPCA</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484506&amp;idx=1&amp;sn=98d7fe9265243c073a1444030fcd4a30&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之Harmony，LIGER和LISI</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247485666&amp;idx=1&amp;sn=ae0da39f47190da11c0d379c2b5bbefb&amp;scene=21#wechat_redirect" data-linktype="2">R版BBKNN整合去批次</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247515099&amp;idx=1&amp;sn=02d4a6448e3fec0ed76e2f8c85494320&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之R语言版scVI</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484778&amp;idx=1&amp;sn=45f99192489b835d895bd2bd4d93e774&amp;scene=21#wechat_redirect" data-linktype="2">巧用Python加速单细胞分析</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247487358&amp;idx=1&amp;sn=a9dff19083623ef3063df6ccce9ee411&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之scVI和scANVI</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247487688&amp;idx=1&amp;sn=03fa47e197220c523cf40c884bb3ce9b&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之Scanorama</a></p></section></li></ul><p data-tool="mdnice编辑器">接下来，我们用实战代码介绍一下这个算法流程。</p><h3 data-tool="mdnice编辑器">一. 环境部署</h3><p data-tool="mdnice编辑器"><strong>cellhint是一个python包，环境部署非常简单：</strong></p><pre data-tool="mdnice编辑器"><span></span><code>conda create -n cellhint<br>conda activate cellhint<br>pip install cellhint<br>pip install celltypist <span>#额外安装一下celltypist</span><br></code></pre><p data-tool="mdnice编辑器">如果需要衔接jupyter使用的话，安装一下相应的包：</p><pre data-tool="mdnice编辑器"><span></span><code>conda install -y nb_conda_kernels ipykernel<br>python -m ipykernel install --user --name cellhint --display-name cellhint<br></code></pre><h3 data-tool="mdnice编辑器">二. 运行示例数据</h3><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> scanpy <span>as</span> sc<br><span>import</span> cellhint<br></code></pre><p data-tool="mdnice编辑器">示例数据是一个脾脏组织的20W+单细胞，来自4个不同的数据集：</p><pre data-tool="mdnice编辑器"><span></span><code>adata = sc.read(<span>'cellhint_demo_folder/Spleen.h5ad'</span>, backup_url = <span>'https://celltypist.cog.sanger.ac.uk/Resources/Organ_atlas/Spleen/Spleen.h5ad'</span>)<br>adata<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span> AnnData object with n_obs × n_vars = 200664 × 74369</span><br><span>    obs: 'Dataset', 'donor_id', 'development_stage', 'sex', 'suspension_type', 'assay', 'Original_annotation', 'CellHint_harmonised_group', 'cell_type', 'Curated_annotation', 'organism', 'disease', 'tissue'</span><br><span>    var: 'exist_in_Madissoon2020', 'exist_in_Tabula2022', 'exist_in_DominguezConde2022', 'exist_in_He2020'</span><br><span>    uns: 'schema_version', 'title'</span><br><span>    obsm: 'X_umap'</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>adata.obs.Dataset.value_counts()<br><span>#Madissoon et al. 2020          92049</span><br><span>#Dominguez Conde et al. 2022    70099</span><br><span>#Tabula Sapiens 2022            34004</span><br><span>#He et al. 2020                  4512</span><br><span>#Name: Dataset, dtype: int64</span><br></code></pre><p data-tool="mdnice编辑器">对数正态化基因表达（标准化至每个细胞的10,000计数）存储在 .X 中，而原始Count数据存储在 .raw 中。CellHint不依赖于后者，但为了确保单细胞分析的完整性，我们仍然从原始Count数据开始进行操作：</p><pre data-tool="mdnice编辑器"><span></span><code>adata = adata.raw.to_adata()<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>del</span> adata.var<br><span>del</span> adata.uns<br><span>del</span> adata.obsm<br>adata<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span> AnnData object with n_obs × n_vars = 200664 × 74369</span><br><span>    obs: 'Dataset', 'donor_id', 'development_stage', 'sex', 'suspension_type', 'assay', 'Original_annotation', 'CellHint_harmonised_group', 'cell_type', 'Curated_annotation', 'organism', 'disease', 'tissue'</span><br></code></pre><p data-tool="mdnice编辑器">这个adata就是一般我们输入到python的最原始的scanpy对象了，然后对adata执行标准分析流程：</p><pre data-tool="mdnice编辑器"><span></span><code>sc.pp.normalize_total(adata, target_sum = <span>1e4</span>)<br>sc.pp.log1p(adata)<br>adata.raw = adata<br>sc.pp.highly_variable_genes(adata, batch_key = <span>'Dataset'</span>, subset = <span>True</span>)<br>sc.pp.scale(adata, max_value = <span>10</span>)<br>sc.tl.pca(adata)<br>sc.pp.neighbors(adata)<br>sc.tl.umap(adata)<br></code></pre><p data-tool="mdnice编辑器">根据数据集或者患者ID进行分组可视化umap结果：</p><pre data-tool="mdnice编辑器"><span></span><code>sc.pl.umap(adata, color = [<span>'Dataset'</span>, <span>'donor_id'</span>], wspace = <span>0.5</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004183" data-ratio="0.24620060790273557" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaGxkrw0TWI9se2Dgk2QOZDGUica2N622oW2XiaUcbIkG6GM10mcDl3VlQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="987" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaGxkrw0TWI9se2Dgk2QOZDGUica2N622oW2XiaUcbIkG6GM10mcDl3VlQ/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222165312318</figcaption></figure><p data-tool="mdnice编辑器">这个数据集还有预注释的结果：</p><pre data-tool="mdnice编辑器"><span></span><code>sc.pl.umap(adata, color = [<span>'Curated_annotation'</span>], wspace = <span>0.5</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004185" data-ratio="0.3221202854230377" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iay3C7Yf3h4hRiaeXcFcw4PwOPl8MIsGXBP4UxFhU7Ltx4W28QXxoheMw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="981" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iay3C7Yf3h4hRiaeXcFcw4PwOPl8MIsGXBP4UxFhU7Ltx4W28QXxoheMw/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222165341410</figcaption></figure><p data-tool="mdnice编辑器">整体上看，批次还是比较严重的。然后我们进行cellhint整合去批次：</p><pre data-tool="mdnice编辑器"><span></span><code><span># Integrate cells with `cellhint.integrate`.</span><br>cellhint.integrate(adata, <span>'Dataset'</span>, <span>'Curated_annotation'</span>)<br></code></pre><p data-tool="mdnice编辑器"><strong>一句函数就能完成整合了，这个流程非常快，只需要1分钟不到的时间。</strong></p><p data-tool="mdnice编辑器">需要注意的是，cellhint需要指定批次，这里用的是'Dataset'；还需要指定预注释的信息，这里是'Curated_annotation'。除了使用'Dataset'这个作为批次的话，我们还可以使用患者/样本为批次，'donor_id'，例如：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#cellhint.integrate(adata, 'donor_id', 'Curated_annotation')</span><br></code></pre><p data-tool="mdnice编辑器">整合完之后，重新跑一下umap：</p><pre data-tool="mdnice编辑器"><span></span><code>sc.tl.umap(adata)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>sc.pl.umap(adata, color = [<span>'Dataset'</span>, <span>'donor_id'</span>], wspace = <span>0.5</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004186" data-ratio="0.21944444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaHaPwJtrhJ7h1UkXbFevicCiciciabE6flNp7whQt2lfoiaqWuyQL6xekgVA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaHaPwJtrhJ7h1UkXbFevicCiciciabE6flNp7whQt2lfoiaqWuyQL6xekgVA/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222170024107</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>sc.pl.umap(adata, color = <span>'Curated_annotation'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004184" data-ratio="0.31932773109243695" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iadibehRtj5ZT55KCK0DJ2og5kiaiaxh3SaeeyN9ctd0HXN6DdV3Vb95Ccw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1071" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iadibehRtj5ZT55KCK0DJ2og5kiaiaxh3SaeeyN9ctd0HXN6DdV3Vb95Ccw/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222170100185</figcaption></figure><p data-tool="mdnice编辑器">可以看到，按照细胞类型进行聚类了。</p><h3 data-tool="mdnice编辑器">三. 使用CellTypist自动注释</h3><p data-tool="mdnice编辑器">前面也提到了，CellTypist这个算法也是Teichmann团队提出的，关于CellTypist我之前也做过介绍，这个自动注释算法真的挺准确的：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484838&amp;idx=1&amp;sn=d02d0ee3daaa0ea69cfbfd11b9fde844&amp;scene=21#wechat_redirect" data-linktype="2">Celltypist：超越singleR的单细胞注释工具</a></section></li></ul><p data-tool="mdnice编辑器">因此，cellhint流程也把CellTypist算法纳入了，对于首次使用celltypist的用户来说，需要下载一下官方的model（https://www.celltypist.org/models）：</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> celltypist<br><span>from</span> celltypist <span>import</span> models<br>models.download_models(force_update = <span>True</span>)<br>models.models_path <span># 模型会下载到家目录'~/.celltypist/data/models'</span><br>models.models_description() <span># model description</span><br></code></pre><p data-tool="mdnice编辑器">如果已经部署过celltypist的model的用户来说，跳过下载步骤，直接运行：</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> celltypist<br>adata = celltypist.annotate(adata, model = <span>'Immune_All_Low.pkl'</span>, majority_voting = <span>True</span>).to_adata()<br></code></pre><p data-tool="mdnice编辑器">20w+单细胞注释，大概需要5-10分钟，结果储存在<code>adata.obs</code>：</p><pre data-tool="mdnice编辑器"><span></span><code>adata.obs[[<span>'predicted_labels'</span>, <span>'majority_voting'</span>, <span>'conf_score'</span>]]<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004188" data-ratio="0.5338865836791148" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iau58JITo7LMn4MSq6mqQibkpWsKlTIJ1ZeI3oggk9YCic3yXXcgCCt0ibQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="723" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iau58JITo7LMn4MSq6mqQibkpWsKlTIJ1ZeI3oggk9YCic3yXXcgCCt0ibQ/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222171618493</figcaption></figure><p data-tool="mdnice编辑器">如果用户的单细胞数据是没有预注释信息的，完全可以使用celltypist进行预注释，然后进行cellhint整合，整合效果非常好：</p><pre data-tool="mdnice编辑器"><span></span><code><span># You can also set 'predicted_labels' here in addition to 'majority_voting'.</span><br>cellhint.integrate(adata, <span>'donor_id'</span>, <span>'majority_voting'</span>)<br>sc.tl.umap(adata)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>sc.pl.umap(adata, color = [<span>'Dataset'</span>, <span>'donor_id'</span>], wspace = <span>0.5</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004192" data-ratio="0.23354958294717332" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaEp7dh5W7jticgP13nEonW2UdCQlS25GOPicLFnibdbJKrXcmcMBY4vGiag/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1079" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaEp7dh5W7jticgP13nEonW2UdCQlS25GOPicLFnibdbJKrXcmcMBY4vGiag/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222171828088</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>sc.pl.umap(adata, color = <span>'majority_voting'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004190" data-ratio="0.2637571157495256" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaqiaAjEUyKiaQemTg2aXWuJeLiaZnOvkGCLXymiaOHBIeF9y2Tby4kZ7BjQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1054" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaqiaAjEUyKiaQemTg2aXWuJeLiaZnOvkGCLXymiaOHBIeF9y2Tby4kZ7BjQ/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222171851213</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>sc.pl.umap(adata, color = <span>'Curated_annotation'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004189" data-ratio="0.2743362831858407" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaOQTGlblCX9PLToFM3H8xlEdPwvKjeMichw4tCl7S2XfbXugRIYtb5Sg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1017" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaOQTGlblCX9PLToFM3H8xlEdPwvKjeMichw4tCl7S2XfbXugRIYtb5Sg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222171912061</figcaption></figure><h3 data-tool="mdnice编辑器">四. 使用CellHint harmonisation指导整合分析</h3><p data-tool="mdnice编辑器">除了使用上述预注释的结果进行整合，或者是celltypist的预测结果进行整合，CellHint 还可以使用<code>harmonisation</code>模式指导整合分析，运行速度也是非常快：</p><pre data-tool="mdnice编辑器"><span></span><code>alignment = cellhint.harmonize(adata, <span>'Dataset'</span>, <span>'Original_annotation'</span>)<br></code></pre><p data-tool="mdnice编辑器">可视化<code>harmonisation</code>的结果：</p><pre data-tool="mdnice编辑器"><span></span><code>cellhint.treeplot(alignment)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004191" data-ratio="1.083815028901734" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6ia0wNvPub9VOeEa8HxRL21uUKwYPIPRsXBFhR1BlTfafZnjteoSYFtWg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="692" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6ia0wNvPub9VOeEa8HxRL21uUKwYPIPRsXBFhR1BlTfafZnjteoSYFtWg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222172243317</figcaption></figure><p data-tool="mdnice编辑器">这个图表表明在数据整合过程中可以视为对应的细胞类型。</p><p data-tool="mdnice编辑器">重要的是，细胞重新注释的信息存储在alignment.reannotation中:</p><pre data-tool="mdnice编辑器"><span></span><code>alignment.reannotation<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004195" data-ratio="0.4590325765054294" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6ianaQgAymEXQzX8AKFJsmzibzbicWxEQicWCcJJ08r1iarha0aS3rJRrolJw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1013" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6ianaQgAymEXQzX8AKFJsmzibzbicWxEQicWCcJJ08r1iarha0aS3rJRrolJw/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222172354898</figcaption></figure><p data-tool="mdnice编辑器">我们可以把上述结果中的<code>reannotation</code>和<code>group</code>添加到adata单细胞对象里：</p><pre data-tool="mdnice编辑器"><span></span><code>adata.obs[[<span>'reannotation'</span>, <span>'group'</span>]] = alignment.reannotation[[<span>'reannotation'</span>, <span>'group'</span>]].loc[adata.obs_names]<br></code></pre><p data-tool="mdnice编辑器">查看一下：</p><pre data-tool="mdnice编辑器"><span></span><code>adata.obs.iloc[:, <span>-2</span>:]<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004196" data-ratio="0.5307017543859649" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iawibw8wTxyOXdj5CWuS6Gy6Sicds4WCY87rYjCYwlWHEibb5yyewyeX9Dg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="684" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iawibw8wTxyOXdj5CWuS6Gy6Sicds4WCY87rYjCYwlWHEibb5yyewyeX9Dg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222172523087</figcaption></figure><p data-tool="mdnice编辑器">最后，我们基于<code>harmonisation</code>的结果进行整合：</p><pre data-tool="mdnice编辑器"><span></span><code>cellhint.integrate(adata, <span>'donor_id'</span>, <span>'reannotation'</span>)<br>sc.tl.umap(adata)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>sc.pl.umap(adata, color = [<span>'Dataset'</span>, <span>'donor_id'</span>], wspace = <span>0.5</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004193" data-ratio="0.2184959349593496" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaD5JTm6mCeoZOS0g2DrVl1aUITFxc622zuGFFFMg4Oib7bt1faN7ibY2Q/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="984" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaD5JTm6mCeoZOS0g2DrVl1aUITFxc622zuGFFFMg4Oib7bt1faN7ibY2Q/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222172618078</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>sc.pl.umap(adata, color = <span>'Curated_annotation'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004194" data-ratio="0.27116827438370844" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iakVeMWAvjSXLABFlNfGY2kXbK0QO6EzzG12wSCiaZJD5gzR5z2lQRW8w/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="933" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iakVeMWAvjSXLABFlNfGY2kXbK0QO6EzzG12wSCiaZJD5gzR5z2lQRW8w/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222172637004</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>sc.pl.umap(adata, color = <span>'group'</span>, legend_loc = <span>'on data'</span>)<br>sc.pl.umap(adata, color = <span>'reannotation'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004197" data-ratio="0.3962962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6ia0NXa29lm3qsL5vhTvmNwvzgxGXkJUE2UJcGZCV4yZKvALWibIxRD2yA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6ia0NXa29lm3qsL5vhTvmNwvzgxGXkJUE2UJcGZCV4yZKvALWibIxRD2yA/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222172709916</figcaption></figure><h3 data-tool="mdnice编辑器">五. 总结</h3><p data-tool="mdnice编辑器">还记得我之前评价过依赖GPU的明星整合算法scVI和scANVI，没有GPU运行真的太慢了：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247487358&amp;idx=1&amp;sn=a9dff19083623ef3063df6ccce9ee411&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之scVI和scANVI</a></section></li></ul><p data-tool="mdnice编辑器">而cellhint的逻辑理念和运行速度让我大为震撼，在Cell原文中，作者还与其他整合算法做了横向比较：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004200" data-ratio="0.5639614855570839" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iakThs5icvuDvhypZMBXHQPlSt6AMicAkK8xLp45AhKiaWm4A5jncz67x6Q/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="727" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iakThs5icvuDvhypZMBXHQPlSt6AMicAkK8xLp45AhKiaWm4A5jncz67x6Q/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222173311583</figcaption></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100004199" data-ratio="0.4180478821362799" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaESs5dtOGSl7NqvebqzLoSO5z4LGTtDrBEINMibkZ4TiazJbCNfxbXPFg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="543" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqW7b63ibGfA0UOZ3HCI52Q6iaESs5dtOGSl7NqvebqzLoSO5z4LGTtDrBEINMibkZ4TiazJbCNfxbXPFg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231222173316623</figcaption></figure><p data-tool="mdnice编辑器"><strong>cellhint算法绝对可以说是整合算法中的天花板了。cellhint本身的运行非常简单，加上联合celltypist这个自动注释天花板，这里我大胆预言一波，cellhint整合算法绝对要火~</strong></p><p data-tool="mdnice编辑器"><strong>另外cellhint的理念也让我有一点启发：Teichmann团队试图用多种算法来统一单细胞命名和整合不规范的问题，在这个基础上，把单细胞单一组织来源的整合，拓展到全身组织的整合，构建真正意义上的”人类细胞图谱“。</strong></p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/eaKuwJ3I92tY5qkF3b-WCA",target="_blank" rel="noopener noreferrer">原文链接</a>
