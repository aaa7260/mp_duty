---
title: "一起学之---空间转录组结合单细胞转录组联合分析 SPOTlight"
date: 2024-01-17T22:54:35Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
一起学之---空间转录组结合单细胞转录组联合分析 SPOTlight by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">SPOTlight是基于非负矩阵因子分解回归（NMF）将单细胞转录组数据整合到空间转录组数据中，展示每个spot细胞类型的比例，本质上也是一种去卷积的方法，这里我们学习如何进行单细胞和空间转录组分析。</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">官网地址：GitHub - MarcElosua/SPOTlight: Spatial Transcriptomics Capture Location Deconvolution</p><p data-tool="mdnice编辑器">首选我们需要准备2个数据集，1个单细胞转录组数据<strong>brain_sc</strong>，另一个是单细胞空转数据<strong>cortex</strong>。然后加载必要的包：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(Seurat)<br><span>library</span>(SPOTlight)<br>brain_sc &lt;- readRDS(<span>"./ST_SC_integerate/brain_sc.rds"</span>)<br>cortex &lt;- readRDS(<span>"./ST_SC_integerate/cortex.rds"</span>)<br></code></pre><p data-tool="mdnice编辑器">SPOTlight的核心步骤中需要单细胞的高可变基因，以及不同分群的差异基因，因此运行：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#获取单细胞高可变基因</span><br>brain_sc &lt;- FindVariableFeatures(brain_sc,nfeatures=<span>3000</span>)<br>features &lt;- VariableFeatures(brain_sc)<br><br><span>#计算单细胞细胞类型marker基因</span><br>DefaultAssay(brain_sc) &lt;- <span>'RNA'</span><br>Idents(brain_sc) &lt;- <span>"cell_type"</span><br>ALL_markers &lt;- FindAllMarkers(brain_sc, logfc.threshold = <span>0.25</span>, only.pos =<span>TRUE</span>)<br></code></pre><p data-tool="mdnice编辑器">另外我们并不需要所有的细胞去运行SPOTlight，而是每个分群取样100个细胞即可。</p><pre data-tool="mdnice编辑器"><span></span><code>down &lt;- SplitObject(brain_sc,split.by=<span>"cell_type"</span>)<br>cell_keep &lt;- c()<br><span>for</span>(i <span>in</span> <span>1</span>:length(down)){<br> print(names(down)[[i]])<br> n &lt;- ncol(down[[i]])<br> <span>if</span>(n &lt; <span>100</span>){<br>  n_cells = n<br> }<span>else</span>{n=<span>100</span>}<br> cell_keep &lt;- c(cell_keep,sample(colnames(down[[i]]),n))<br>}<br><br>brain_sc_down &lt;- subset(brain_sc, cells=cell_keep)<br></code></pre><p data-tool="mdnice编辑器">接下来是核心步骤：</p><pre data-tool="mdnice编辑器"><span></span><code>res &lt;- SPOTlight(x=brain_sc_down,<br>     y=cortex,<br>     groups=as.character(brain_sc_down$cell_type),<br>     mgs=ALL_markers,<br>     hvg=features,<br>     weight_id=<span>"p_val"</span>,<br>     group_id=<span>"cluster"</span>,<br>     gene_id=<span>"gene"</span>,<br>     assay_sc=<span>"RNA"</span>,<br>     slot_sc=<span>"counts"</span>)<br></code></pre><p data-tool="mdnice编辑器">需要注意的是几个参数，我们输入的矩阵是RNA中的counts数据，而不是标准化的data数据，其他的几个id名字基本不需要改，都是<strong>FindAllMarkers</strong>函数之后自动生成的。</p><p data-tool="mdnice编辑器">最终生成了res结果即是我们需要的最终结果。接下来我们简单看一下res的结构：</p><p><img data-galleryid="" data-imgfileid="100000502" data-ratio="0.11238095238095239" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKJiaZvPL35V5YusMFnyykgJoSTFiaNqDdQSP21kLPUR91AC1epkLLKDabia4PdnaiauUPeicFtSjicKia0A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1050" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKJiaZvPL35V5YusMFnyykgJoSTFiaNqDdQSP21kLPUR91AC1epkLLKDabia4PdnaiauUPeicFtSjicKia0A/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">主要有2个内容，mat和NMF。</p><p><img data-galleryid="" data-imgfileid="100000504" data-ratio="0.42735042735042733" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKJiaZvPL35V5YusMFnyykgJ64Vq3ds7I18ia0XRLicvMZVvqCAA87p86bZ5EF6mDIY1fHMP7xrlcxJw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="819" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKJiaZvPL35V5YusMFnyykgJ64Vq3ds7I18ia0XRLicvMZVvqCAA87p86bZ5EF6mDIY1fHMP7xrlcxJw/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-galleryid="" data-imgfileid="100000503" data-ratio="0.38264738598442716" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKJiaZvPL35V5YusMFnyykgJU621vQPLibLiacTicbbMta5GNSg6W1z7bvIWAkW19fC3vdWqDiaFgWkbpA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="899" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKJiaZvPL35V5YusMFnyykgJU621vQPLibLiacTicbbMta5GNSg6W1z7bvIWAkW19fC3vdWqDiaFgWkbpA/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">如上图，mat是一个行为spot，列为细胞注释信息的矩阵，其中的值是细胞比例。NMF是SPOTlight使用NMF算法的中间结果。</p><pre data-tool="mdnice编辑器"><span></span><code><span>#提取结果</span><br>matrix &lt;- res$mat<br>mod &lt;- res$NMF<br><br>plotTopicProfiles(x = mod,y = brain_sc_down$cell_type,facet = <span>FALSE</span>,min_prop = <span>0.01</span>,ncol = <span>1</span>)<br>plotTopicProfiles(x = mod,y = brain_sc_down$cell_type,facet = <span>TRUE</span>,min_prop = <span>0.01</span>,ncol = <span>7</span>)<br>plotCorrelationMatrix(matrix)<br>plotInteractions(matrix, which = <span>"heatmap"</span>, metric = <span>"prop"</span>)<br>plotInteractions(matrix, which = <span>"network"</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(dplyr)<br><br>metadata &lt;- cortex@meta.data<br>metadata$ID &lt;- rownames(metadata)<br><br>matrix &lt;- as.data.frame(matrix)<br>matrix$ID &lt;- rownames(matrix)<br><br>metadata &lt;- left_join(metadata,matrix,by=<span>"ID"</span>)<br>rownames(metadata) &lt;- metadata$ID<br><br>cortex@meta.data &lt;- metadata<br><br>SpatialFeaturePlot(cortex,<span>"L4"</span>)<br><br><br>ct &lt;- colnames(matrix)<br>matrix[matrix &lt; <span>0.1</span>] &lt;- <span>0</span><br><br>pal &lt;- c(<span>"#E41A1C"</span>,<span>"#377EB8"</span>,<span>"#4DAF4A"</span>,<span>"#984EA3"</span>,<span>"#FF7F00"</span>,<span>"#A65628"</span>,<span>"#F781BF"</span>,<span>"#999999"</span>,<span>"#66C2A5"</span>,<span>"#FC8D62"</span>,<span>"#8DA0CB"</span>,<span>"#E78AC3"</span>,<span>"#A6D854"</span>)<br>names(pal) &lt;- ct[<span>1</span>:<span>13</span>]<br><br><br><span>#合并作图数据与位置数据</span><br>POS &lt;- cortex@images$anterior1@coordinates<br>View(POS)<br>POS$ID &lt;- rownames(POS)<br>matrix &lt;- left_join(matrix, POS, by=<span>"ID"</span>)<br>matrix$radius &lt;- rep(<span>65</span>, nrow(matrix))<br>View(matrix)<br><br><br><span>#作图</span><br><span>library</span>(scatterpie)<br>ggplot(matrix) + geom_scatterpie(aes(x=imagecol,y=imagerow,r=radius), data = matrix, cols = colnames(matrix)[<span>1</span>:<span>13</span>], color=<span>NA</span>)+<br> scale_y_reverse()+<br> theme_void() + <br> coord_equal() + <br> scale_fill_manual(values = pal)<br></code></pre><p><img data-galleryid="" data-imgfileid="100000505" data-ratio="0.725" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKJiaZvPL35V5YusMFnyykgJFIFGgVRKLrz7NVTpSy6QXWhZMBJjP9jiaPRgrDR96lPulBAKowmb8Fg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/y6jd6X97IxKJiaZvPL35V5YusMFnyykgJFIFGgVRKLrz7NVTpSy6QXWhZMBJjP9jiaPRgrDR96lPulBAKowmb8Fg/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">这张图就是我们需要的最终图片，从上图中我们能够看出较为明显的层状结构Astro主要分布在外层。这也能再次印证我们的单细胞注释结果，以便接下来的功能分析。</p></section><section><section data-style-type="5" data-tools="新媒体排版" data-id="2440476"><section><section><section><section><img data-ratio="0.9495798319327731" data-src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif" data-type="gif" data-w="119" data-width="100%" data-imgfileid="100035609" src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif"></section><section data-brushtype="text">往期回顾</section><section><br></section></section></section></section><section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247519254&amp;idx=1&amp;sn=e728006c625602bd37425bd6b5b9563f&amp;chksm=ea1c8a94dd6b0382688d4747218758d4eeaa986a16baf1dabbf616bf2dcd35f816c088eea1af&amp;scene=21#wechat_redirect" textvalue="转录调控研究遇瓶颈？解读lncRNA信息开辟新思路" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>转录调控研究遇瓶颈？解读lncRNA信息开辟新思路</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247519253&amp;idx=1&amp;sn=70121081c5858d971f4ee77f73dd6388&amp;chksm=ea1c8a97dd6b038105b0303e9417650f79ca0a3ee5220cddb11663436ba7288df6a8b7b8f924&amp;scene=21#wechat_redirect" textvalue="各种单细胞表达量矩阵和空间信息的导入" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>各种单细胞表达量矩阵和空间信息的导入</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247519170&amp;idx=2&amp;sn=73f6e5a487a49c2b542313ce38ef63be&amp;chksm=ea1c8d40dd6b045639cf13ac07af05fa0faf671728c15aba77d2685fb4f56d7c72a06fa5e08a&amp;scene=21#wechat_redirect" textvalue="10x的空间单细胞文件格式详解" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>10x的空间单细胞文件格式详解</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247519142&amp;idx=1&amp;sn=b5618a2cb778f0d82408c3536b673f2f&amp;chksm=ea1c8d24dd6b04329e7bd096cc64571a893de1f8a6168f5a0e384ca443c8f0cd5f51992d88f1&amp;scene=21#wechat_redirect" textvalue="单细胞测序最好的教程（十三）：你真的做对过干预后细胞分析吗？" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞测序最好的教程（十三）：你真的做对过干预后细胞分析吗？</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247519133&amp;idx=1&amp;sn=42293cd8456a5b4d00a64bfe5a7a47ca&amp;chksm=ea1c8d1fdd6b0409d658d83639f6d12cdb9e4825096d3751add69c762c0cbbb87f13b930d6a8&amp;scene=21#wechat_redirect" textvalue="单细胞测序最好的教程（十二）：你真的做对了细胞比例分析吗？" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞测序最好的教程（十二）：你真的做对了细胞比例分析吗？</span></a><br></p></section></section><hr><p><br></p></section><section data-style-type="5" data-tools="新媒体排版" data-id="2440475"><hr><p><br></p><hr><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527207&amp;idx=1&amp;sn=fb9ca814003fc24e9ec8b1bcecbd1d56&amp;chksm=9b4b2b9cac3ca28afc5b68047e5f0587b6636d52879051decd573009e38313c5f7d6b0d1927d&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课2024年1月班" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信入门&amp;数据挖掘线上直播课2024年1月班</a><br></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">时隔5年，我们的生信技能树VIP学徒继续招生啦</a><br></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247526168&amp;idx=1&amp;sn=ebc4a9d53d675e3f7d20b1e2f97901b8&amp;chksm=9b4b27a3ac3caeb5ee0828c38f816c229067d1946be224bcaf4bac0dbdfc9eff863c621097e2&amp;scene=21#wechat_redirect" textvalue="生物信息学江湖的开创性产品-共享服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学江湖的开创性产品-共享服务器</a></p></li></ul><p><img data-imgfileid="100035608" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-imgfileid="100035607" data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-id="93668"><section><section data-width="95%"><section><section><section data-width="38%"><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg" data-type="other" data-w="258" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" data-imgfileid="100035611" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><p><br></p></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/7iQhRifSejHOV3DzOfKYqA",target="_blank" rel="noopener noreferrer">原文链接</a>
