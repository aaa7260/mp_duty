---
title: "网络爬虫实例：爬取CRAN上的R语言工具包及其相关信息"
date: 2024-01-15T00:32:43Z
draft: ["false"]
tags: [
  "fetched",
  "R语言学堂"
]
categories: ["Acdemic"]
---
网络爬虫实例：爬取CRAN上的R语言工具包及其相关信息 by R语言学堂
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器"><strong><span>专注</span></strong><span><strong><span>系列化</span></strong></span><strong><span>、</span></strong><span><strong><span>高质量</span></strong></span><strong><span>的R语言教程</span></strong></p><p data-tool="mdnice编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247504509&amp;idx=1&amp;sn=6fd600fe0fdfbe5f0a5a174b2f9a3427&amp;chksm=ce048a57f973034178679b70da3110e49829627007bb84fade1b319b7abbec37172cb88f2633&amp;scene=21#wechat_redirect" textvalue="推文索‍引" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>推文索引</span></a><span> | <a target="_blank" href="https://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247490868&amp;idx=1&amp;sn=181032ee65a5ce5c9595530cceabcb8c&amp;chksm=ce07451ef970cc08dc75ed55c295e2f6ecd6c327199fe99fc3a041a597b8dece8b3a9860fc92&amp;scene=21#wechat_redirect" textvalue="联系小编" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2">联系小编</a> | <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247503266&amp;idx=1&amp;sn=e43cfe33776bfc956d6f822aba8b95b0&amp;chksm=ce049588f9731c9e7a8489c13d5484fa81a60923e240e98a759d0388ad4b140607948d25b409&amp;scene=21#wechat_redirect" textvalue="咨询服务" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">咨询服务</a></span></p><hr data-tool="mdnice编辑器"></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">学堂君先前写过一篇推文“<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247484187&amp;idx=1&amp;sn=6bf94ab75ef71945935fc2dc1ac96c51&amp;scene=21#wechat_redirect" data-linktype="2">网络爬虫初步——使用CSS选择器</a>”。这篇推文介绍了使用<code>rvest</code>工具包爬取网站上数据的方法。</p><p data-tool="mdnice编辑器">本篇推文使用的方法和这篇推文类似，但是需要爬取两层网站数据：第一层是CRAN网站上的R工具包列表，第二层是每个工具包链接内的信息。</p><p data-tool="mdnice编辑器">本篇目录如下：</p><ul><li><p>1 爬取工具包列表</p></li><li><p>2 爬取工具包信息</p></li><ul><li><p>2.1 个例爬取</p></li><li><p>2.2 编写函数</p></li><li><p>2.3 批量爬取</p></li></ul><li><p>3 完整代码</p></li></ul><p data-tool="mdnice编辑器"><br></p><h2 data-tool="mdnice编辑器"><span></span><span>1 爬取工具包列表</span></h2><p data-tool="mdnice编辑器">CRAN的网站链接为：https://cloud.r-project.org/web/packages/available_packages_by_name.html。</p><p data-tool="mdnice编辑器">在该页面，我们需要爬取三列信息：工具包名称、工具包描述、工具包链接；其中工具包链接没有直接展示在网页上。</p><p data-tool="mdnice编辑器">具体方法在“<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247484187&amp;idx=1&amp;sn=6bf94ab75ef71945935fc2dc1ac96c51&amp;scene=21#wechat_redirect" data-linktype="2">网络爬虫初步——使用CSS选择器</a>”已经介绍了，这里直接展示代码并加以说明。</p><p data-tool="mdnice编辑器">爬取工具包名称和描述：</p><pre data-tool="mdnice编辑器"><code><span>library</span>(rvest)<br><span>library</span>(tidyverse)<br><br>html &lt;- read_html(<span>"https://cloud.r-project.org/web/packages/available_packages_by_name.html"</span>)<br><br><span>## 工具包名称和描述</span><br>Package = html %&gt;%<br>  html_elements(css = <span>"div.container table"</span>) %&gt;%<br>  html_table() %&gt;%<br>  `[[`(<span>1</span>) %&gt;%<br>  `[`(-<span>1</span>,) %&gt;%<br>  setNames(c(<span>"name"</span>, <span>"decription"</span>))<br></code></pre><blockquote data-tool="mdnice编辑器"><span></span><ul><li><section>新版本的<code>rvest</code>工具包将<code>html_nodes()</code>函数改为了<code>html_elements()</code>函数，但前者目前仍然可用；</section></li><li><section>在网站页面，右键“检查”进入源代码，可以看到工具包列表位于<code>table</code>标签内，这是设置<code>html_elements()</code>函数<code>css</code>参数的依据，见下图；</section></li><li><section><code>html_table()</code>函数用于爬取<code>table</code>标签内的表格；</section></li><li><section><code>html_table()</code>爬取结果是list，使用<code>[[1]]</code>提取其元素结果为数据框，再用<code>[-1]</code>删去其第一行的无效值。</section></li></ul><span></span></blockquote><figure data-tool="mdnice编辑器"><img data-imgfileid="100021358" data-ratio="0.5046296296296297" data-src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLicWiaYFH2SrIxTlpDBibwauicqrPmiaZhkHdT2ta1xW7bm9kHWelYloLLPjxc5xt1dnuACTOZ0IEog6Ug/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLicWiaYFH2SrIxTlpDBibwauicqrPmiaZhkHdT2ta1xW7bm9kHWelYloLLPjxc5xt1dnuACTOZ0IEog6Ug/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">爬取工具包链接：</p><pre data-tool="mdnice编辑器"><code><span>## 工具包链接</span><br>link = html %&gt;%<br>  html_elements(css = <span>"div.container table tr td a"</span>) %&gt;%<br>  html_attr(<span>"href"</span>) %&gt;%<br>  sub(<span>"../../"</span>, <span>"https://cloud.r-project.org/"</span>, .)<br></code></pre><blockquote data-tool="mdnice编辑器"><span></span><ul><li><section>爬取的链接开头是<code>../../</code>，使用<code>sub()</code>函数将其替换为<code>https://cloud.r-project.org/</code>。</section></li></ul><span></span></blockquote><p data-tool="mdnice编辑器">爬取结果显示，<code>Package</code>有20268行，<code>link</code>只有<code>20243</code>行。经检查，<code>Package</code>有一些为<code>NA</code>的无效行，删除后其与<code>link</code>的行数相同。</p><p data-tool="mdnice编辑器">将<code>link</code>合并到<code>Package</code>：</p><pre data-tool="mdnice编辑器"><code>Package = Package %&gt;%<br>  filter(!is.na(decription)) %&gt;%<br>  mutate(link = link) %&gt;%<br>  rowwise() %&gt;%<br>  mutate(id = grepl(name, link)) %&gt;%<br>  ungroup()<br></code></pre><blockquote data-tool="mdnice编辑器"><span></span><ul><li><section>为了保证合并正确，生成一个标识变量<code>id</code>，用来记录工具包名称<code>name</code>是否出现在对应的链接<code>link</code>里（工具包链接里会包含工具包名称）。</section></li></ul><span></span></blockquote><p data-tool="mdnice编辑器"><code>id</code>只有<code>TRUE</code>一个值，因此所有行的<code>name</code>变量都包含在<code>link</code>变量里：</p><pre data-tool="mdnice编辑器"><code>unique(Package$id)<br><span>## [1] TRUE</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>2 爬取工具包信息</span></h2><h3 data-tool="mdnice编辑器"><span></span><span></span><span>2.1 个例爬取</span><span></span></h3><p data-tool="mdnice编辑器">先以第一个工具包为例，爬取它的相关信息：</p><pre data-tool="mdnice编辑器"><code>link0 = Package$link[<span>1</span>]<br><br>read_html(link0) %&gt;%<br>  html_elements(css = <span>"div.container table:nth-child(3)"</span>) %&gt;%<br>  html_table() %&gt;%<br>  `[[`(<span>1</span>) %&gt;%<br>  mutate(X1 = sub(<span>":"</span>, <span>""</span>, X1))<br><br><span>## # A tibble: 11 × 2</span><br><span>##    X1               X2                                           </span><br><span>##    &lt;chr&gt;            &lt;chr&gt;                                        </span><br><span>##  1 Version          1.0.0                                        </span><br><span>##  2 Depends          R (≥ 2.15.0), xtable, pbapply                </span><br><span>##  3 Suggests         randomForest, e1071                          </span><br><span>##  4 Published        2015-08-16                                   </span><br><span>##  5 Author           Scott Fortmann-Roe                           </span><br><span>##  6 Maintainer       Scott Fortmann-Roe  &lt;scottfr at berkeley.edu&gt;</span><br><span>##  7 License          GPL-2 | GPL-3 [expanded from: GPL (≥ 2)]     </span><br><span>##  8 NeedsCompilation no                                           </span><br><span>##  9 Citation         A3 citation info                             </span><br><span>## 10 Materials        NEWS                                         </span><br><span>## 11 CRAN checks      A3 results</span><br></code></pre><blockquote data-tool="mdnice编辑器"><span></span><ul><li><section>网站源代码里不止一个<code>table</code>标签，而需要爬取的<code>table</code>标签是<code>div.container</code>的第3个子标签，所以使用<code>div.container table:nth-child(3)</code>定位。</section></li></ul><span></span></blockquote><p data-tool="mdnice编辑器">爬取的表格不是规范的数据框，需要转置一下，然后将原先的第一列作为转置后的数据框的列标题：</p><pre data-tool="mdnice编辑器"><code>read_html(link0) %&gt;%<br>  html_elements(css = <span>"div.container table:nth-child(3)"</span>) %&gt;%<br>  html_table() %&gt;%<br>  `[[`(<span>1</span>) %&gt;%<br>  mutate(X1 = sub(<span>":"</span>, <span>""</span>, X1)) %&gt;%<br>  t() %&gt;%<br>  as.data.frame() %&gt;%<br>  setNames(.[<span>1</span>,]) %&gt;%<br>  `[`(-<span>1</span>,)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>2.2 编写函数</span><span></span></h3><p data-tool="mdnice编辑器">将2.1的代码封装成函数<code>f()</code>：</p><pre data-tool="mdnice编辑器"><code>f = <span>function</span>(link0) {<br>  <br>  print(link0)<br>  <br>  <span>try</span>({<br>    read_html(link0) %&gt;%<br>      html_elements(css = <span>"div.container table:nth-child(3)"</span>) %&gt;%<br>      html_table() %&gt;%<br>      `[[`(<span>1</span>) %&gt;%<br>      mutate(X1 = sub(<span>":"</span>, <span>""</span>, X1)) %&gt;%<br>      t() %&gt;%<br>      as.data.frame() %&gt;%<br>      setNames(.[<span>1</span>,]) %&gt;%<br>      `[`(-<span>1</span>,)<br>  })<br>}<br></code></pre><blockquote data-tool="mdnice编辑器"><span></span><ul><li><section><code>print(link0)</code>：在爬取前先输出链接，用来提示用户进程；</section></li><li><section>为了防止程序意外中断，使用<code>try()</code>函数抑制报错信息。</section></li></ul><span></span></blockquote><h3 data-tool="mdnice编辑器"><span></span><span></span><span>2.3 批量爬取</span><span></span></h3><p><mp-pay-preview-filter data-offset="43"></mp-pay-preview-filter></p></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/lkosAw--t8hEw0rlnTQiIg",target="_blank" rel="noopener noreferrer">原文链接</a>
