---
title: "把火山图做成烟花图"
date: 2024-01-25T10:30:35Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
把火山图做成烟花图 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>差异分析，大家都喜欢两个分组的比较，但实际科研项目，往往是比这复杂，多达十几个甚至几十个分组也不稀奇。之前的教程：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247504676&amp;idx=1&amp;sn=6707c9b993ab4c84f893b0285df3e448&amp;scene=21#wechat_redirect" data-linktype="2">多分组的差异分析只需要合理设置design矩阵即可</a>，我们展示了无论多少个分组，都可以很方便的进行差异分析。</p></blockquote><p data-tool="mdnice编辑器">对两个分组的差异分析，我们会首选火山图进行展示，但是有一个学员反馈了他画出来的一个超级诡异的火山图，我把它命名为烟花图！</p><p><img data-galleryid="" data-ratio="1.034375" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wwpLaduZl9jwQD5pLIb47OTIZd9Ox89Z5IQlw4ZwI9EY5DVFbibnumDebNhNj00Qu1KALrGQFuYCdQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wwpLaduZl9jwQD5pLIb47OTIZd9Ox89Z5IQlw4ZwI9EY5DVFbibnumDebNhNj00Qu1KALrGQFuYCdQ/640?wx_fmt=jpeg"></p><figure data-tool="mdnice编辑器"><figcaption>超级诡异的火山图</figcaption></figure><p data-tool="mdnice编辑器">下面我们就以  airway 这个R包来演示这个过程，如果你没有这个包，就自己使用代码 ：BiocManager::install('airway') 进行安装哦！</p><h3 data-tool="mdnice编辑器"><span></span>整理数据<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><br><span># 1.构建表达矩阵 ----------------------------------------------------------------</span><br>dir.create(<span>"./data"</span>)<br><br><span># 魔幻操作，一键清空</span><br>rm(list = ls()) <br>options(stringsAsFactors = <span>F</span>)<br><span># BiocManager::install('airway')</span><br><span># 加载airway数据集并转换为表达矩阵</span><br><span>library</span>(airway,quietly = <span>T</span>)<br>data(airway)<br>class(airway)<br><br>rawcount &lt;- assay(airway)<br>colnames(rawcount)<br><br><span># 查看表达谱</span><br>rawcount[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br><span># 去除前的基因表达矩阵情况</span><br>dim(rawcount)<br><br><span># 获取分组信息</span><br>group_list &lt;- colData(airway)$dex<br>group_list<br><br><span># 过滤在至少在75%的样本中都有表达的基因</span><br>keep &lt;- rowSums(rawcount&gt;<span>0</span>) &gt;= floor(<span>0.75</span>*ncol(rawcount))<br>table(keep)<br><br>filter_count &lt;- rawcount[keep,]<br>filter_count[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>dim(filter_count)<br><br><span># 加载edgeR包计算counts per millio(cpm) 表达矩阵,并对结果取log2值</span><br><span>library</span>(edgeR)<br>express_cpm &lt;- log2(cpm(filter_count)+<span>1</span>)<br>express_cpm[<span>1</span>:<span>6</span>,<span>1</span>:<span>6</span>]<br><br><span># 保存表达矩阵和分组结果</span><br>save(filter_count,<br>     express_cpm,<br>     group_list,<br>     file = <span>"./data/Step01-airwayData.Rdata"</span>)<br><br></code></pre><p data-tool="mdnice编辑器">代码块里面的内容有点多， 实际上仅仅是一个熟悉airway这个表达量矩阵的过程：</p><h3 data-tool="mdnice编辑器"><span></span>正常差异分析<span></span></h3><p data-tool="mdnice编辑器">我们这里首先选取最出名的包，DESeq2来进行差异分析：</p><pre data-tool="mdnice编辑器"><span></span><code><br><span>#2.进行差异分析 ------------------------------------------------------------------</span><br>rm(list = ls())<br>options(stringsAsFactors = <span>F</span>)<br><br><span># 读取基因表达矩阵信息</span><br>lname &lt;- load(file = <span>"./data/Step01-airwayData.Rdata"</span>)<br>lname <br><br><span># 查看分组信息和表达矩阵数据</span><br>exprSet &lt;- filter_count<br>dim(exprSet)<br>exprSet[<span>1</span>:<span>6</span>,<span>1</span>:<span>6</span>]<br>table(group_list)<br><br><span># 加载包</span><br><span>library</span>(DESeq2)<br><br><span># 第一步，构建DESeq2的DESeq对象</span><br>colData &lt;- data.frame(row.names=colnames(exprSet),group_list=group_list)<br>dds &lt;- DESeqDataSetFromMatrix(countData = exprSet,colData = colData,design = ~ group_list)<br><br><span># 第二步，进行差异表达分析</span><br>dds2 &lt;- DESeq(dds)<br><br><span># 提取差异分析结果，trt组对untrt组的差异分析结果</span><br>tmp &lt;- results(dds2,contrast=c(<span>"group_list"</span>,<span>"trt"</span>,<span>"untrt"</span>))<br>DEG_DESeq2 &lt;- as.data.frame(tmp[order(tmp$padj),])<br>head(DEG_DESeq2)<br><br><span># 去除差异分析结果中包含NA值的行</span><br>DEG_DESeq2 = na.omit(DEG_DESeq2)<br><br><span># 筛选上下调，设定阈值</span><br>fc_cutoff &lt;- <span>1</span><br>fdr &lt;- <span>0.05</span><br><br>DEG_DESeq2$regulated &lt;- <span>"normal"</span><br><br>loc_up &lt;- intersect(which(DEG_DESeq2$log2FoldChange&gt;log2(fc_cutoff)),<br>                    which(DEG_DESeq2$padj&lt;fdr))<br>loc_down &lt;- intersect(which(DEG_DESeq2$log2FoldChange&lt; (-log2(fc_cutoff))),<br>                      which(DEG_DESeq2$padj&lt;fdr))<br><br>DEG_DESeq2$regulated[loc_up] &lt;- <span>"up"</span><br>DEG_DESeq2$regulated[loc_down] &lt;- <span>"down"</span><br><br>table(DEG_DESeq2$regulated)<br><br>head(DEG_DESeq2)<br><span>library</span>(AnnoProbe)<br>ag=annoGene(rownames(DEG_DESeq2),<br>         ID_type = <span>'ENSEMBL'</span>,species = <span>'human'</span><br>            )<br>head(ag)<br>DEG_DESeq2$ENSEMBL=rownames(DEG_DESeq2)<br> <br>deg_anno=merge(ag,DEG_DESeq2,by=<span>'ENSEMBL'</span>)<br>head(deg_anno)<br><span># 保存</span><br>write.table(deg_anno,<span>"./data/DEG_DESeq2_all.xls"</span>,<br>            row.names = <span>F</span>,sep=<span>"\t"</span>,quote = <span>F</span>) <br>save(deg_anno, file = <span>"./data/Step03-DESeq2_nrDEG.Rdata"</span>)<br></code></pre><p data-tool="mdnice编辑器">得到了上下调基因，有了差异分析结果表格，每个表格都可以去判断统计学显著的上下调基因，去富集分析，去做火山图，热图。这样的分析看我六年前的<strong>表达芯片的公共数据库挖掘系</strong>列推文即可哈 ：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486063&amp;idx=1&amp;sn=156bee5397e979722b36b78284188538&amp;scene=21#wechat_redirect" data-linktype="2">解读GEO数据存放规律及下载，一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486054&amp;idx=1&amp;sn=209975adee162228cfe6e6c5065c5c8c&amp;scene=21#wechat_redirect" data-linktype="2">解读SRA数据库规律一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486087&amp;idx=1&amp;sn=1e775a1c3e215384e381953a9fa74ec3&amp;scene=21#wechat_redirect" data-linktype="2">从GEO数据库下载得到表达矩阵 一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486090&amp;idx=1&amp;sn=62374fbdd4f20c3185beb6568bbeb3e9&amp;scene=21#wechat_redirect" data-linktype="2">GSEA分析一文就够（单机版+R语言版）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486112&amp;idx=1&amp;sn=67a2104c62222bcb139623699f874a6c&amp;scene=21#wechat_redirect" data-linktype="2">根据分组信息做差异分析- 这个一文不够的</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486120&amp;idx=1&amp;sn=14d7892c1beec2fb9cdfc0ec0aba3e4e&amp;scene=21#wechat_redirect" data-linktype="2">差异分析得到的结果注释一文就够</a></section></li></ul><p data-tool="mdnice编辑器">不过我们这里仅仅是展现火山图即可：</p><h3 data-tool="mdnice编辑器"><span></span>绘制火山图<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><br><span>## 首先检查是否上下调设置错了</span><br><span># 挑选一个差异表达基因</span><br><br>load(file = <span>"./data/Step03-DESeq2_nrDEG.Rdata"</span>)<br>load(file = <span>"./data/Step01-airwayData.Rdata"</span>)<br>head(deg_anno)<br><span># 在差异基因列表里面，随意挑选一个上下调基因</span><br><span># 这里上调基因举例说明 </span><br>cg=<span>"ENSG00000152583"</span><br>deg_anno[match(cg, deg_anno$ENSEMBL),]<br>exp &lt;- c(t(express_cpm[match(cg,rownames(express_cpm)),]))<br>test &lt;- data.frame(value=exp,group=group_list)<br><span>library</span>(ggplot2) <br><span>library</span>(ggpubr) <br>df &lt;- data.frame(value=exp,group=group_list)<br>head(df)<br>p &lt;- ggboxplot(df, x = <span>"group"</span>, y = <span>"value"</span>,<br>               color = <span>"group"</span>, palette = <span>"jco"</span>,<br>               add = <span>"jitter"</span>)<br>p<br><span>#  Add p-value</span><br>p + stat_compare_means()<br><br><span>library</span>(EnhancedVolcano)<br>colnames(deg_anno)<br>EnhancedVolcano(deg_anno,<br>                lab = deg_anno$SYMBOL,<br>                x = <span>'log2FoldChange'</span>,<br>                y = <span>'padj'</span>)<br>ggsave(filename = <span>'EnhancedVolcano_for_DEG_DEseq2.pdf'</span>)<br><br></code></pre><p data-tool="mdnice编辑器">如下所示：</p><p><img data-galleryid="" data-ratio="0.5421863536316948" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwpLaduZl9jwQD5pLIb47OTAn2xnslDvVKjU7bvqFvyBWZasKoUYw7oiaJuZicp3X8icBrHoObV0ib22g/640?wx_fmt=png" data-type="png" data-w="2726" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwpLaduZl9jwQD5pLIb47OTAn2xnslDvVKjU7bvqFvyBWZasKoUYw7oiaJuZicp3X8icBrHoObV0ib22g/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>一个很标准的火山图</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>创作烟花图所需要的数据<span></span></h3><p data-tool="mdnice编辑器">火山图是基于正常的表达量矩阵进行正常的差异分析得到的：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; exprSet[1:4,1:4]<br>                SRR1039508 SRR1039509 SRR1039512 SRR1039513<br>ENSG00000000003        679        448        873        408<br>ENSG00000000419        467        515        621        365<br>ENSG00000000457        260        211        263        164<br>ENSG00000000460         60         55         40         35<br>&gt; group_list<br>[1] untrt trt   untrt trt   untrt trt   untrt trt  <br>Levels: trt untrt<br>&gt; table(group_list)<br>group_list<br>  trt untrt <br>    4     4 <br></code></pre><p data-tool="mdnice编辑器">但是对于烟花图，我们需要把前面的两个分组的两个样品进行重复四次，假装是每个分组有4个重复值，实际上每个分组里面的重复都是人造的。</p><p data-tool="mdnice编辑器">代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>options(stringsAsFactors = <span>F</span>)<br><br><span># 读取基因表达矩阵信息</span><br>lname &lt;- load(file = <span>"./data/Step01-airwayData.Rdata"</span>)<br>lname <br><br><span># 查看分组信息和表达矩阵数据</span><br>exprSet &lt;- filter_count<br>dim(exprSet)<br>exprSet[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>group_list<br>table(group_list)<br><span># 加载包</span><br><span>library</span>(DESeq2)<br>exprSet=cbind(<br>  exprSet[,<span>1</span>:<span>2</span>],<br>  exprSet[,<span>1</span>:<span>2</span>],<br>  exprSet[,<span>1</span>:<span>2</span>],<br>  exprSet[,<span>1</span>:<span>2</span>]<br>) <br>colnames(exprSet)=<span>1</span>:<span>8</span> <br><span># DESeq2包不受欺骗，不支持我们的这样的假冒伪劣矩阵哦</span><br><span>if</span>(<span>F</span>){<br>  <span># 加载包</span><br>  <span>library</span>(DESeq2)<br>  <span># 第一步，构建DESeq2的DESeq对象</span><br>  colData &lt;- data.frame(row.names=colnames(exprSet),group_list=group_list)<br>  dds &lt;- DESeqDataSetFromMatrix(countData = exprSet,colData = colData,design = ~ group_list)<br>  <span># 第二步，进行差异表达分析</span><br>  dds2 &lt;- DESeq(dds)<br>  <br>  <span># 提取差异分析结果，trt组对untrt组的差异分析结果</span><br>  tmp &lt;- results(dds2,contrast=c(<span>"group_list"</span>,<span>"trt"</span>,<span>"untrt"</span>))<br>  DEG_DESeq2 &lt;- as.data.frame(tmp[order(tmp$padj),])<br>  head(DEG_DESeq2)<br>}<br><br><br><br><span># 加载包</span><br><span>library</span>(limma)<br><span>library</span>(edgeR) <br><span>#创建设计矩阵和对比：假设数据符合分布，构建线性模型</span><br>design &lt;- model.matrix(~<span>0</span>+factor(group_list))<br>colnames(design) &lt;- levels(factor(group_list))<br>rownames(design) &lt;- colnames(exprSet)<br>design<br><br><span>#设置需要进行对比的分组</span><br>comp &lt;- <span>'trt-untrt'</span><br>cont.matrix &lt;- makeContrasts(contrasts=c(comp),levels = design)<br><span>#进行差异表达分析</span><br>dge &lt;- DGEList(counts=exprSet)<br>v &lt;- voom(dge,design,plot=<span>TRUE</span>, normalize=<span>"quantile"</span>) <br>fit &lt;- lmFit(v, design)<br>fit2 &lt;- contrasts.fit(fit,cont.matrix)<br>fit2 &lt;- eBayes(fit2)<br>tmp &lt;- topTable(fit2, coef=comp, n=<span>Inf</span>,adjust.method=<span>"BH"</span>)<br>DEG_limma_voom &lt;- na.omit(tmp)<br><br>head(DEG_limma_voom)<br><span>library</span>(AnnoProbe)<br>ag=annoGene(rownames(DEG_limma_voom),<br>            ID_type = <span>'ENSEMBL'</span>,species = <span>'human'</span><br>)<br>head(ag)<br>DEG_limma_voom$ENSEMBL=rownames(DEG_limma_voom)<br><br>deg_anno=merge(ag,DEG_limma_voom,by=<span>'ENSEMBL'</span>)<br>head(deg_anno)<br><span>library</span>(EnhancedVolcano)<br>colnames(deg_anno)<br>EnhancedVolcano(deg_anno,<br>                lab =deg_anno$SYMBOL,<br>                x = <span>'logFC'</span>,<br>                y = <span>'adj.P.Val'</span>)<br><br><br><br><br></code></pre><p data-tool="mdnice编辑器">如下所示：</p><p><img data-galleryid="" data-ratio="0.628421052631579" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwpLaduZl9jwQD5pLIb47OTiavS0cuSPuf0vBzEwWzlJLnx90sQQNCpPsuBJUp9aFDY0dPkTXVljrA/640?wx_fmt=png" data-type="png" data-w="1900" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwpLaduZl9jwQD5pLIb47OTiavS0cuSPuf0vBzEwWzlJLnx90sQQNCpPsuBJUp9aFDY0dPkTXVljrA/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>一个烟花图</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>学徒作业：<span></span></h3><p data-tool="mdnice编辑器">运行我这个教程里面的代码，得到两次差异分析结果后，进行比较，绘制各自上下调基因的韦恩图看看！</p><h3 data-tool="mdnice编辑器"><span></span>思考题<span></span></h3><p data-tool="mdnice编辑器">既然我们前面把每个分组里面的单个样品简单粗暴的复制粘贴3次充当生物学重复，会导致计算得到的p值如此的诡异。</p><p data-tool="mdnice编辑器">那么， 假如你的两个分组真的就是都有且仅有一个样品，你该如何进行差异分析呢？</p></section><h3 data-tool="mdnice编辑器">文末友情推荐</h3><p data-tool="mdnice编辑器">与十万人一起学生信，你值得拥有下面的学习班：</p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508762&amp;idx=1&amp;sn=c411bc6007b02e1828235317465fa458&amp;chksm=9b4be3a1ac3c6ab7e649381f828aace86ac811e3edcd152a0a981118d39af4cd87260933b2dc&amp;scene=21#wechat_redirect" textvalue="数据挖掘（GEO,TCGA,单细‍胞）2021第9期" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">数据挖掘（GEO,TCGA,单细胞）2021第10期</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508762&amp;idx=2&amp;sn=d1eb0963f32da5ca35a6d873658d0179&amp;chksm=9b4be3a1ac3c6ab78521bec4b27b380f6f560cf8feaabdb744e545e8c7aa2bcfa007fc27dd0d&amp;scene=21#wechat_redirect" textvalue="生信爆款入门-2021第‍9期" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">生信爆款入门-2021第9期</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508448&amp;idx=1&amp;sn=3283fafda88479411c6fab4e54166fa0&amp;chksm=9b4be15bac3c684d6e9b5c245ce759491c54ab97f39517b266f4d9e9a68f65f2dba56b910a5b&amp;scene=21#wechat_redirect" textvalue="（千呼万唤始出来）生信技能树知识整理实习生在哪里" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">（千呼万唤始出来）生信技能树知识整理实习生在哪里</a></section></li></ul><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/QskjnJBwtQhA9DRa82qY9Q",target="_blank" rel="noopener noreferrer">原文链接</a>
