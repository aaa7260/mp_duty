---
title: "基于mlr3工具包的机器学习（4）：重采样、基准测试"
date: 2024-01-20T01:27:18Z
draft: ["false"]
tags: [
  "fetched",
  "R语言学堂"
]
categories: ["Acdemic"]
---
基于mlr3工具包的机器学习（4）：重采样、基准测试 by R语言学堂
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器"><strong><span>专注</span></strong><span><strong><span>系列化</span></strong></span><strong><span>、</span></strong><span><strong><span>高质量</span></strong></span><strong><span>的R语言教程</span></strong></p><p data-tool="mdnice编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247504509&amp;idx=1&amp;sn=6fd600fe0fdfbe5f0a5a174b2f9a3427&amp;chksm=ce048a57f973034178679b70da3110e49829627007bb84fade1b319b7abbec37172cb88f2633&amp;scene=21#wechat_redirect" textvalue="推文索‍引" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>推文索引</span></a><span> | <a target="_blank" href="https://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247490868&amp;idx=1&amp;sn=181032ee65a5ce5c9595530cceabcb8c&amp;chksm=ce07451ef970cc08dc75ed55c295e2f6ecd6c327199fe99fc3a041a597b8dece8b3a9860fc92&amp;scene=21#wechat_redirect" textvalue="联系小编" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2">联系小编</a> | <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247503266&amp;idx=1&amp;sn=e43cfe33776bfc956d6f822aba8b95b0&amp;chksm=ce049588f9731c9e7a8489c13d5484fa81a60923e240e98a759d0388ad4b140607948d25b409&amp;scene=21#wechat_redirect" textvalue="咨询服务" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">咨询服务</a></span></p><hr data-tool="mdnice编辑器"></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">本系列已发推文：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247500304&amp;idx=1&amp;sn=95c0e09a705ccafce25b626b672d06a5&amp;scene=21#wechat_redirect" data-linktype="2">基于mlr3工具包的机器学习（1）——数据、模型、训练、预测</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247505054&amp;idx=1&amp;sn=dcde6904436523e4698ccd8e332c8019&amp;scene=21#wechat_redirect" data-linktype="2">基于mlr3工具包的机器学习（2）——回归学习器及模型评估</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247505078&amp;idx=1&amp;sn=0e6cfaa014218fb06973b34d1cf0664a&amp;scene=21#wechat_redirect" data-linktype="2">基于mlr3工具包的机器学习（3）——分类学习器及模型评估</a></section></li></ul><p data-tool="mdnice编辑器">本篇参考资料：</p><ul data-tool="mdnice编辑器"><li><section>https://mlr3book.mlr-org.com/chapters/chapter3/evaluation_and_benchmarking.html</section></li></ul><p data-tool="mdnice编辑器">本篇目录如下：</p><ul><li><p>1 重采样</p></li><ul><li><p>1.1 重采样方法</p></li><li><p>1.2 执行重采样</p></li><li><p>1.3 预测结果</p></li><li><p>1.4 模型评估</p></li><li><p>1.5 分组和分层</p></li></ul><li><p>2 基准测试</p></li></ul><p data-tool="mdnice编辑器"><br></p><h2 data-tool="mdnice编辑器"><span></span><span>1 重采样</span></h2><p data-tool="mdnice编辑器">在前两篇推文里，我们都将原始数据随机划分为训练集和测试集，其中训练集用于模型训练，测试集用于模型评估。划分训练集和测试集的操作叫<strong>重采样</strong>（resampling）。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>1.1 重采样方法</span><span></span></h3><p data-tool="mdnice编辑器">重采样有许多方法，如留出法（holdout）、k折交叉验证（k-fold cross-validation）、子采样法（subsampling）、自举法（bootstrap）等。已经介绍的<code>partition()</code>函数使用的就是留出法。</p><p data-tool="mdnice编辑器"><code>mlr3</code>内置的重采样方法可在<code>mlr_resamplings</code>中查看：</p><pre data-tool="mdnice编辑器"><code><span>library</span>(mlr3)<br><br>mlr_resamplings<br><span>## &lt;DictionaryResampling&gt; with 9 stored values</span><br><span>## Keys: bootstrap, custom, custom_cv, cv, holdout, insample, loo,</span><br><span>##   repeated_cv, subsampling</span><br></code></pre><p data-tool="mdnice编辑器">将其转换成表格可查看重采样方法的参数：</p><pre data-tool="mdnice编辑器"><code>as.data.table(mlr_resamplings)<br><span>##            key                         label        params iters</span><br><span>## 1:   bootstrap                     Bootstrap ratio,repeats    30</span><br><span>## 2:      custom                 Custom Splits                  NA</span><br><span>## 3:   custom_cv Custom Split Cross-Validation                  NA</span><br><span>## 4:          cv              Cross-Validation         folds    10</span><br><span>## 5:     holdout                       Holdout         ratio     1</span><br><span>## 6:    insample           Insample Resampling                   1</span><br><span>## 7:         loo                 Leave-One-Out                  NA</span><br><span>## 8: repeated_cv     Repeated Cross-Validation folds,repeats   100</span><br><span>## 9: subsampling                   Subsampling ratio,repeats    30</span><br></code></pre><p data-tool="mdnice编辑器">下面简述几种重采样方法及其差异：</p><ul data-tool="mdnice编辑器"><li><section><p><strong>留出法</strong>是将样本按一定比例随机分为测试集和训练集（默认2:1）；</p></section></li><li><section><p><strong>k折交叉验证</strong>是将样本等分为<span><span role="presentation" data-formula="k" data-formula-type="inline-equation"><svg xmlns="http://www.w3.org/2000/svg" role="img" focusable="false" viewbox="0 -694 521 705" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g></g></g></svg></span></span>份（默认10份），每次使用<span><span role="presentation" data-formula="k-1" data-formula-type="inline-equation"><svg xmlns="http://www.w3.org/2000/svg" role="img" focusable="false" viewbox="0 -694 2243.4 776" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mo" transform="translate(743.2, 0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(1743.4, 0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></svg></span></span>份作为测试集，剩余1份作为训练集，因此会训练出<span><span role="presentation" data-formula="k" data-formula-type="inline-equation"><svg xmlns="http://www.w3.org/2000/svg" role="img" focusable="false" viewbox="0 -694 521 705" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g></g></g></svg></span></span>个中间模型；</p></section></li><li><section><p><strong>留一法交叉验证</strong>是交叉验证的特例，它的<span><span role="presentation" data-formula="k" data-formula-type="inline-equation"><svg xmlns="http://www.w3.org/2000/svg" role="img" focusable="false" viewbox="0 -694 521 705" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g></g></g></svg></span></span>等于样本量<span><span role="presentation" data-formula="n" data-formula-type="inline-equation"><svg xmlns="http://www.w3.org/2000/svg" role="img" focusable="false" viewbox="0 -442 600 453" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></span></span>，因此每次测试集只有1个样本；</p></section></li><li><section><p><strong>子采样法</strong>相当于将留出法重复多次（默认30次），因此也会训练出多个中间模型；它与k折交叉验证的区别是，不同测试集会有重叠；</p></section></li><li><section><p><strong>自举法</strong>与子采样法的区别是，在抽取训练集样本时使用的是有放回抽样，因此一个样本可能会在训练集中多次出现；自举法的抽样也可以重复多次（默认30次），因此也会训练出多个中间模型。</p></section></li></ul><p data-tool="mdnice编辑器">每种重采样方法的<strong>官方帮助文档</strong>都可在<code>mlr</code>包的<code>mlr_resamplings_*</code>条目查看，其中<code>*</code>为重采样方法的名称，如<code>mlr_resamplings_holdout</code>。</p><p data-tool="mdnice编辑器">关于交叉验证方法还可参考如下推文：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247490100&amp;idx=1&amp;sn=a1e13187b9190f6cdbad5d60f3898047&amp;scene=21#wechat_redirect" data-linktype="2">交叉验证</a></section></li></ul><h3 data-tool="mdnice编辑器"><span></span><span></span><span>1.2 执行重采样</span><span></span></h3><p data-tool="mdnice编辑器">对学习任务执行重采样分为两个步骤，涉及两个函数。第一步是构建重采样方法，使用<code>rsmp()</code>函数；第二步是将重采样方法应用于学习任务，使用<code>resample()</code>函数。</p><p data-tool="mdnice编辑器">构建一些重采样方法：</p><pre data-tool="mdnice编辑器"><code>set.seed(<span>0117</span>)<br><br><span>## 留出法</span><br>holdout = rsmp(<span>"holdout"</span>, ratio = <span>0.8</span>)<br><br><span>## 交叉验证</span><br>cv = rsmp(<span>"cv"</span>, folds = <span>5</span>)<br><br><span>## 子采样法</span><br>subsmp = rsmp(<span>"subsampling"</span>, ratio = <span>0.8</span>, repeats = <span>5</span>)<br><br><span>## 自举法</span><br>bootstrap = rsmp(<span>"bootstrap"</span>, ratio = <span>0.8</span>, repeats = <span>5</span>)<br></code></pre><blockquote data-tool="mdnice编辑器"><span></span><ul><li><section>每种重采样方法的设置参数见<code>as.data.table(mlr_resamplings)</code>输出结果的<code>params</code>列。</section></li></ul><span></span></blockquote><p data-tool="mdnice编辑器">将重采样方法应用于学习任务：</p><pre data-tool="mdnice编辑器"><code>data(<span>"mtcars"</span>)<br><span>## 任务和学习器</span><br>task = as_task_classif(mtcars, target = <span>"vs"</span>, <br>                       positive = <span>"1"</span>)<br>learn = lrn(<span>"classif.rpart"</span>, predict_type = <span>"prob"</span>)<br><br><span>## 将重采样方法应用于学习任务</span><br>r1 = resample(task, learn, resampling = holdout)<br><span>## INFO  [19:20:20.870] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 1/1)</span><br><br>r2 = resample(task, learn, resampling = cv)<br><span>## INFO  [19:20:20.960] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 1/5)</span><br><span>## INFO  [19:20:21.028] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 2/5)</span><br><span>## INFO  [19:20:21.044] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 3/5)</span><br><span>## INFO  [19:20:21.062] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 4/5)</span><br><span>## INFO  [19:20:21.081] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 5/5)</span><br><br>r3 = resample(task, learn, resampling = subsmp)<br><span>## INFO  [19:20:21.124] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 1/5)</span><br><span>## INFO  [19:20:21.142] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 2/5)</span><br><span>## INFO  [19:20:21.160] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 3/5)</span><br><span>## INFO  [19:20:21.179] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 4/5)</span><br><span>## INFO  [19:20:21.194] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 5/5)</span><br><br>r4 = resample(task, learn, resampling = bootstrap)<br><span>## INFO  [21:38:28.642] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 1/5)</span><br><span>## INFO  [21:38:28.663] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 2/5)</span><br><span>## INFO  [21:38:28.682] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 3/5)</span><br><span>## INFO  [21:38:28.701] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 4/5)</span><br><span>## INFO  [21:38:28.721] [mlr3] Applying learner 'classif.rpart' on task 'mtcars' (iter 5/5)</span><br></code></pre><blockquote data-tool="mdnice编辑器"><span></span><ul><li><section>除留出法外，其他方法都有5个迭代结果。</section></li></ul></blockquote><p data-tool="mdnice编辑器"><mpcpc js_editor_cpcad="" src="/cgi-bin/readtemplate?t=tmpl/cpc_tmpl#1705650389393" data-category_id_list="1|16|17|24|28|29|31|35|36|37|39|41|42|43|46|47|48|5|50|51|55|6|7|8" data-id="1705650389393"></mpcpc></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>1.3 预测结果</span><span></span></h3><p data-tool="mdnice编辑器">在重采样过程中，<code>resample()</code>函数会一次性完成模型训练和模型预测，而不是像上篇推文那样先使用<code>train()</code>方法训练，再使用<code>predict()</code>方法预测。</p><p data-tool="mdnice编辑器">在重采样中，使用训练集训练出的模型称为“中间模型”，<code>resample()</code>还会使用全部数据训练一个“最终模型”。在得到重采样结果后，使用<code>predictions()</code>方法可查看各个中间模型在对应测试集上的预测结果：</p><pre data-tool="mdnice编辑器"><code>r3$predictions()<br><span>## [[1]]</span><br><span>## &lt;PredictionClassif&gt; for 6 observations:</span><br><span>##  row_ids truth response     prob.1    prob.0</span><br><span>##        1     0        0 0.06666667 0.9333333</span><br><span>##        8     1        1 1.00000000 0.0000000</span><br><span>##       10     1        1 1.00000000 0.0000000</span><br><span>##       17     0        0 0.06666667 0.9333333</span><br><span>##       29     0        0 0.06666667 0.9333333</span><br><span>##       30     0        0 0.06666667 0.9333333</span><br><span>## </span><br><span>## [[2]]</span><br><span>## &lt;PredictionClassif&gt; for 6 observations:</span><br><span>##  row_ids truth response prob.1 prob.0</span><br><span>##        1     0        1      1      0</span><br><span>##        2     0        1      1      0</span><br><span>##       16     0        0      0      1</span><br><span>##       23     0        0      0      1</span><br><span>##       27     0        1      1      0</span><br><span>##       28     1        1      1      0</span><br><span>## </span><br><span>## ....</span><br></code></pre><blockquote data-tool="mdnice编辑器"><span></span><ul><li><section>共5个预测结果，这里只展示前两个。</section></li></ul><span></span></blockquote><p data-tool="mdnice编辑器">使用<code>prediction()</code>方法可查看所有迭代结果的“组合预测”：</p><pre data-tool="mdnice编辑器"><code>r3$prediction()<br><span>## &lt;PredictionClassif&gt; for 30 observations:</span><br><span>##     row_ids truth response     prob.1    prob.0</span><br><span>##           1     0        0 0.06666667 0.9333333</span><br><span>##           8     1        1 1.00000000 0.0000000</span><br><span>##          10     1        1 1.00000000 0.0000000</span><br><span>## ---                                            </span><br><span>##          23     0        0 0.06250000 0.9375000</span><br><span>##          27     0        0 0.06250000 0.9375000</span><br><span>##          31     0        0 0.06250000 0.9375000</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>1.4 模型评估</span><span></span></h3><p data-tool="mdnice编辑器">使用指标评估重采样结果会展示所有中间模型的评估分数：</p><pre data-tool="mdnice编辑器"><code>r1$score(msr(<span>"classif.ce"</span>))<br><span>##    task_id    learner_id resampling_id iteration classif.ce</span><br><span>## 1:  mtcars classif.rpart       holdout         1  0.3333333</span><br><span>## Hidden columns: task, learner, resampling, prediction</span><br><br>r2$score(msr(<span>"classif.ce"</span>))<br><span>##    task_id    learner_id resampling_id iteration classif.ce</span><br><span>## 1:  mtcars classif.rpart            cv         1  0.0000000</span><br><span>## 2:  mtcars classif.rpart            cv         2  0.0000000</span><br><span>## 3:  mtcars classif.rpart            cv         3  0.0000000</span><br><span>## 4:  mtcars classif.rpart            cv         4  0.0000000</span><br><span>## 5:  mtcars classif.rpart            cv         5  0.1666667</span><br><span>## Hidden columns: task, learner, resampling, prediction</span><br><br>r3$score(msr(<span>"classif.ce"</span>))<br><span>##    task_id    learner_id resampling_id iteration classif.ce</span><br><span>## 1:  mtcars classif.rpart   subsampling         1        0.0</span><br><span>## 2:  mtcars classif.rpart   subsampling         2        0.5</span><br><span>## 3:  mtcars classif.rpart   subsampling         3        0.0</span><br><span>## 4:  mtcars classif.rpart   subsampling         4        0.0</span><br><span>## 5:  mtcars classif.rpart   subsampling         5        0.0</span><br><span>## Hidden columns: task, learner, resampling, prediction</span><br><br>r4$score(msr(<span>"classif.ce"</span>))<br><span>##    task_id    learner_id resampling_id iteration classif.ce</span><br><span>## 1:  mtcars classif.rpart     bootstrap         1 0.13333333</span><br><span>## 2:  mtcars classif.rpart     bootstrap         2 0.16666667</span><br><span>## 3:  mtcars classif.rpart     bootstrap         3 0.00000000</span><br><span>## 4:  mtcars classif.rpart     bootstrap         4 0.06666667</span><br><span>## 5:  mtcars classif.rpart     bootstrap         5 0.25000000</span><br><span>## Hidden columns: task, learner, resampling, prediction</span><br></code></pre><p data-tool="mdnice编辑器">使用<code>aggregate()</code>字段可计算评估指标的平均值，默认为“宏平均”，即所有中间模型评估分数的平均值：</p><pre data-tool="mdnice编辑器"><code>r2$aggregate(msr(<span>"classif.ce"</span>))<br><span>## classif.ce </span><br><span>## 0.03333333</span><br></code></pre><p data-tool="mdnice编辑器">“微平均”是按测试集的样本数给中间模型评估分数加权后得到的平均值。因为训练集和测试集有时不能恰好满足指定比例，所以不同之间模型的测试集样本数可能不同，从而导致宏平均与微平均有略微差异：</p><pre data-tool="mdnice编辑器"><code>r2$aggregate(msr(<span>"classif.ce"</span>, average = <span>"micro"</span>))<br><span>## classif.ce </span><br><span>##    0.03125</span></code></pre><p data-tool="mdnice编辑器"><mpcpc js_editor_cpcad="" src="/cgi-bin/readtemplate?t=tmpl/cpc_tmpl#1705650402074" data-category_id_list="1|16|17|24|28|29|31|35|36|37|39|41|42|43|46|47|48|5|50|51|55|6|7|8" data-id="1705650402074"></mpcpc></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>1.5 分组和分层</span><span></span></h3><p data-tool="mdnice编辑器">在重采样过程中，有时还要考虑样本的<strong>分组</strong>（grouping）或<strong>分层</strong>（stratification）。</p><p data-tool="mdnice编辑器">分组重采样是指，拥有某一共同特征的样本必须同时被划分到训练集或测试集里去。分组方法是将某特征变量设置为分组角色：</p><pre data-tool="mdnice编辑器"><code><span>## 备份任务</span><br>task2 = task$clone()<br><br><span>## 指定分组角色</span><br>task2$set_col_roles(cols = <span>"cyl"</span>, roles = <span>"group"</span>)<br><br>r21 = resample(task2, learn, resampling = holdout)<br><br><span>## 测试集</span><br>testid = as.data.table(r21$prediction())$row_ids<br>mtcars[testid, <span>"cyl"</span>]<br><span>##  [1] 8 8 8 8 8 8 8 8 8 8 8 8 8 8</span><br></code></pre><blockquote data-tool="mdnice编辑器"><span></span><ul><li><section>反复运行上面的代码，可以发现测试集的<code>cyl</code>列始终相同。</section></li></ul><span></span></blockquote><p data-tool="mdnice编辑器">分层重抽样是指，拥有某一共同特征的样本必须以同比例分布在训练集和测试集中。分层重抽样尤其针对目标变量。分层方法是将变量设置为分层角色：</p><pre data-tool="mdnice编辑器"><code><span>## 备份任务</span><br>task3 = task$clone()<br><br><span>## 指定分组角色</span><br>task3$set_col_roles(cols = <span>"vs"</span>, roles = c(<span>"stratum"</span>, <span>"target"</span>))<br>task3$col_roles<br><span>## $feature</span><br><span>##  [1] "am"   "carb" "cyl"  "disp" "drat" "gear" "hp"   "mpg"  "qsec" "wt"  </span><br><span>## </span><br><span>## $target</span><br><span>## [1] "vs"</span><br><span>## </span><br><span>## $name</span><br><span>## character(0)</span><br><span>## </span><br><span>## $order</span><br><span>## character(0)</span><br><span>## </span><br><span>## $stratum</span><br><span>## [1] "vs"</span><br><span>## </span><br><span>## $group</span><br><span>## character(0)</span><br><span>## </span><br><span>## $weight</span><br><span>## character(0)</span><br></code></pre><blockquote data-tool="mdnice编辑器"><span></span><ul><li><section><code>vs</code>变量既是目标变量，也是分层变量。</section></li></ul><span></span></blockquote><h2 data-tool="mdnice编辑器"><span></span><span>2 基准测试</span></h2><p data-tool="mdnice编辑器">基准测试（benchmark）就是将不同学习器应用于同一个或几个任务，并使用同一个或几个重采样方法，然后使用同一个或几个评估指标来比较学习效果的过程。</p><p data-tool="mdnice编辑器">使用<code>benchmark_grid()</code>函数设计基准测试：</p><pre data-tool="mdnice编辑器"><code><span>library</span>(mlr3learners)<br>task = as_task_classif(mtcars, target = <span>"vs"</span>, <br>                       positive = <span>"1"</span>)<br>learns = lrns(c(<span>"classif.rpart"</span>, <span>"classif.ranger"</span>, <span>"classif.kknn"</span>), <br>              predict_type = <span>"prob"</span>)<br><br>cv = rsmp(<span>"cv"</span>, folds = <span>5</span>)<br><br>design = benchmark_grid(tasks = task,<br>                        learners = learns,<br>                        resamplings = cv)<br></code></pre><p data-tool="mdnice编辑器">使用<code>benchmark()</code>函数执行基准测试：</p><pre data-tool="mdnice编辑器"><code>bmr = benchmark(design)<br></code></pre><p data-tool="mdnice编辑器">计算评估分数：</p><pre data-tool="mdnice编辑器"><code>bmr$score(msr(<span>"classif.ce"</span>))<br><span>##     nr task_id     learner_id resampling_id iteration classif.ce</span><br><span>##  1:  1  mtcars  classif.rpart            cv         1  0.1428571</span><br><span>##  2:  1  mtcars  classif.rpart            cv         2  0.0000000</span><br><span>##  3:  1  mtcars  classif.rpart            cv         3  0.0000000</span><br><span>##  4:  1  mtcars  classif.rpart            cv         4  0.0000000</span><br><span>##  5:  1  mtcars  classif.rpart            cv         5  0.0000000</span><br><span>##  6:  2  mtcars classif.ranger            cv         1  0.1428571</span><br><span>##  7:  2  mtcars classif.ranger            cv         2  0.0000000</span><br><span>##  8:  2  mtcars classif.ranger            cv         3  0.0000000</span><br><span>##  9:  2  mtcars classif.ranger            cv         4  0.1666667</span><br><span>## 10:  2  mtcars classif.ranger            cv         5  0.1666667</span><br><span>## 11:  3  mtcars   classif.kknn            cv         1  0.0000000</span><br><span>## 12:  3  mtcars   classif.kknn            cv         2  0.0000000</span><br><span>## 13:  3  mtcars   classif.kknn            cv         3  0.0000000</span><br><span>## 14:  3  mtcars   classif.kknn            cv         4  0.3333333</span><br><span>## 15:  3  mtcars   classif.kknn            cv         5  0.0000000</span><br><span>## Hidden columns: uhash, task, learner, resampling, prediction</span><br><br>bmr$aggregate(msr(<span>"classif.ce"</span>))<br><span>##    nr task_id     learner_id resampling_id iters classif.ce</span><br><span>## 1:  1  mtcars  classif.rpart            cv     5 0.02857143</span><br><span>## 2:  2  mtcars classif.ranger            cv     5 0.09523810</span><br><span>## 3:  3  mtcars   classif.kknn            cv     5 0.06666667</span><br><span>## Hidden columns: resample_result</span><br></code></pre><p data-tool="mdnice编辑器">通过基准测试，我们可以一次性运行多个学习模型并进行比较。</p></section><section><mp-common-profile data-pluginname="mpprofile" data-id="Mzg2MjU1NjQ4NQ==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KL9a707y9iaaiaev0bAHCCHpKV6tpmhVIFmhtf98s0eb6otVJwVwPQNShzaGLp9kUSib1KeW8yIlO8nOA/0?wx_fmt=png" data-nickname="R语言学堂" data-alias="rstudier" data-signature="数据处理、可视化、数学模型、GIS、科研技能。" data-from="0" data-is_biz_ban="0" data-weui-theme="light"></mp-common-profile></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/RRtQXiUq6ACUXxBQzwEUIw",target="_blank" rel="noopener noreferrer">原文链接</a>
