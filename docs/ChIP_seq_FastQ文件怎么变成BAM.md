---
title: "ChIP-seq FastQ文件怎么变成BAM"
date: 2022-09-09T05:37:48Z
draft: ["false"]
tags: [
  "fetched",
  "果子学生信"
]
categories: ["Acdemic"]
---
ChIP-seq FastQ文件怎么变成BAM by 果子学生信
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">这一篇，我们来讲讲，怎么将二代测序回帖到基因组上，将FastQ文件处理成BAM文件，主要分成两步</p><ul data-tool="mdnice编辑器"><li><section>建立基因组索引</section></li><li><section>比对到基因组</section></li></ul><p data-tool="mdnice编辑器">本篇教程主要涉及到两个软件bowtie2和samtools，可以使用bioconda安装</p><pre data-tool="mdnice编辑器"><span></span><code>conda install -c bioconda -c conda-forge bowtie2 samtools<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>参考基因组及bowtie2索引准备</span><span></span></h2><p data-tool="mdnice编辑器">根据文章，参考基因组使用的是hg19（GRCh37），因此我们直接到ensemble网站上找到下载链接，使用<code>wget</code>命令：</p><blockquote data-tool="mdnice编辑器"><span>❝</span><p>选择hg19 还是选择hg38，主要是和你已有的数据有关，如果之前分析的数据都是用的hg19 或者其他分析的网页工具要求的也是hg19, 那么你就得用hg19。</p><span>❞</span></blockquote><pre data-tool="mdnice编辑器"><span></span><code>wget http://ftp.ensembl.org/pub/grch37/current/fasta/homo_sapiens/dna/Homo_sapiens.GRCh37.dna.primary_assembly.fa.gz<br><span>#解压</span><br>gunzip Homo_sapiens.GRCh37.dna.primary_assembly.fa.gz <br><span># 为了方便写代码，我把名字改成hg19</span><br>mkdir ref<br>mv Homo_sapiens.GRCh37.dna.primary_assembly.fa ref/hg19.fa<br></code></pre><p data-tool="mdnice编辑器">bowtie2索引的构建则使用<code>bowtie2-bulid</code>完成：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 使用方法可查看网址http://bowtie-bio.sourceforge.net/bowtie2/manual.shtml#the-bowtie2-build-indexer</span><br>bowtie2-build [options]* &lt;reference_in&gt; &lt;bt2_base&gt;<br><span>#[options] 可自由添加参数，我们在下方使用--threads规定了使用的线程数</span><br><span># &lt;reference_in&gt; 为参考基因组</span><br><span># bt2_base 就是生成的index </span><br><br><span># 这里是相对路径，hg19.fa 在ref目录下</span><br>mkdir -p ref/GRCh37.p13<br>bowtie2-build --threads 20 ref/hg19.fa ref/GRCh37.p13/bowtie2   <br><br></code></pre><p data-tool="mdnice编辑器">索引如下：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.2292134831460674" data-type="jpeg" data-w="890" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/NDy5aEnReX3M5maqsOkT9YlfawNAiavLl5QVWiavqSENIm3qibD1SM1DSgbkYTC0ksutAPleen5pjPVQXFvIE4VpA/640?wx_fmt=jpeg" src="https://mmbiz.qpic.cn/mmbiz_jpg/NDy5aEnReX3M5maqsOkT9YlfawNAiavLl5QVWiavqSENIm3qibD1SM1DSgbkYTC0ksutAPleen5pjPVQXFvIE4VpA/640?wx_fmt=jpeg"></figure><p data-tool="mdnice编辑器">这一步花的时间跟基因组大小和用的线程有关。通常而言，基因组越大，时间越久，线程越多，速度越快。</p><h2 data-tool="mdnice编辑器"><span></span><span>基因组比对，并将SAM文件转至BAM</span><span></span></h2><p data-tool="mdnice编辑器">我们将reads比对到参考基因组之后，会生成一个序列比对图（<strong>「Sequence Alignment Map，SAM」</strong>）的文本文件。SAM文件的具体格式和文件信息，可以去找Heng Li老师2009年在<strong>「Bioinformatics」</strong>发表的文章：<em>The Sequence Alignment/Map format and SAMtools</em>。相信已经更有无数人告诉你，SAM文件虽适合人类阅读，但机器读起来却费劲，因此为了提升后续分析的速度，大家选择把SAM文件转为二进制的<strong>「BAM」</strong>（Binary Alignment Map）文件。</p><p data-tool="mdnice编辑器">由此可知，bowtie2比对产生的是SAM文件，而BAM我们选择使用李恒老师的SAMtools。</p><p data-tool="mdnice编辑器">和上面的软件一样，都是先学习使用说明，而后修改代码</p><pre data-tool="mdnice编辑器"><span></span><code><span># bowtie2 usage</span><br>bowtie2 [options]* -x &lt;bt2-idx&gt; {-1 &lt;m1&gt; -2 &lt;m2&gt; | -U &lt;r&gt; | --interleaved &lt;i&gt;} [-S &lt;sam&gt;]<br><br></code></pre><p data-tool="mdnice编辑器">bowtie2要求提供参考基因组索引的前缀地址，还有fastq文件，如果是双端测序数据，要用-1和-2，如果是单端测序数据，就是-U。</p><p>我们来写一个脚本， align.sh，放在跟之前01-raw-data, 02-clean-data, ref 的同一级目录下，脚本内容如下</p><pre><code><span>#!/bin/bash</span><br><span>set</span> -e<br><span>set</span> -u<br><span>set</span> -o pipefail<br><span># set the directory of input and output</span><br>INDIR=02-clean-data<br>OUTDIR=03-read-align<br>REF=ref/GRCh37.p13/bowtie2</code><code>mkdir -p $OUTDIR<br><br><span># ESCs</span><br><span>#1</span><br>bowtie2 -p 6 -3 5 --<span>local</span> -x <span>$REF</span> -U <span>$INDIR</span>/SRR13918096_GSM5149478_WT_ESC_input_rep_1_Homo_sapiens_ChIP-Seq.fastq.gz \<br> | samtools sort -O bam -o <span>$OUTDIR</span>/ESC_input_1.bam<br><span>#2</span><br>bowtie2 -p 6 -3 5 --<span>local</span> -x <span>$REF</span> -U <span>$INDIR</span>/SRR13918097_GSM5149479_WT_ESC_input_rep_2_Homo_sapiens_ChIP-Seq.fastq.gz \<br> | /samtools sort -O bam -o <span>$OUTDIR</span>/ESC_input_2.bam<br><br><span>## 以此类推，直到完成8个样本。</span><br><span>## 相信这部分是可以写循环的，但是循环的撰写也是需要时间的，懒鬼还是暂时不学了</span><br><br></code></pre><p>如果想要脚本在任何地方都能运行，就需要修改上面INDIR, OUTDIR, REF的相对路径为绝对路径。</p><p data-tool="mdnice编辑器">然后运行脚本</p><pre data-tool="mdnice编辑器"><span></span><code>bash ./align.sh<br><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>比对结果质量控制</span><span></span></h2><p data-tool="mdnice编辑器">比对结束之后，我们有一个非常关心的问题，就是到底有多少数据能够比对到基因组上。比对率（mapping ratio)太低肯定不是好事, 比如说5%都不到，可能是文库污染了，或者公司拆分样本出错了，把别人小鼠的数据给了你。</p><p data-tool="mdnice编辑器">一般来说，Illumina HiSeq System测序的样品（如Hiseq2500）的比例应该超过80%。不过也有例外，像IgG这样的非dna结合蛋白的标记率通常较低(约60%)。当然，这些数字也不是绝对的，不是说80%可以。79%就不成。甚至有些时候，20%都可以接受，我们得根据实验设计来做具体判断。不过，有一点是可以确定的，就是0%绝对不行。</p><p data-tool="mdnice编辑器">我们使用 samtools flagstat 统计比对情况，以其中一个样本为例</p><pre data-tool="mdnice编辑器"><span></span><code>samtools flagstat ESC_TP53_1.bam <span># 可直接查看某个bam文件的比对信息</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.32228218966846567" data-type="jpeg" data-w="1297" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/NDy5aEnReX3M5maqsOkT9YlfawNAiavLlwuczssErg1xMGGwXRGZVtIFZqQxggk3Egp0B8KKVORDv82zFLqoNMw/640?wx_fmt=jpeg" src="https://mmbiz.qpic.cn/mmbiz_jpg/NDy5aEnReX3M5maqsOkT9YlfawNAiavLlwuczssErg1xMGGwXRGZVtIFZqQxggk3Egp0B8KKVORDv82zFLqoNMw/640?wx_fmt=jpeg"></figure><p data-tool="mdnice编辑器">这里的ESC_TP53有80.44%的数据比对到了基因组上，说明是至少样本没有出问题。至于数据能不能用，还得看peak calling步骤的结果，或者可以用IGV大致看看有没有信号。</p><h2 data-tool="mdnice编辑器"><span></span><span>比对结果可视化：IGV</span><span></span></h2><p data-tool="mdnice编辑器">比对结果可视化需要Integrative Genomics Viewer（IGV）软件、BAM文件以及BAM的索引文件BAI。所以我们在已有IGV软件的情况下，好需要创建BAI文件，我们还是使用<strong>「SAMtools」</strong>。先看一下使用方法：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.16838166510757718" data-type="jpeg" data-w="1069" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/NDy5aEnReX3M5maqsOkT9YlfawNAiavLl1fpW3Qy7jMCKPIicNuJp1E2icK94PEBZTia6aopqibS09B1OlSicshNkT5Q/640?wx_fmt=jpeg" src="https://mmbiz.qpic.cn/mmbiz_jpg/NDy5aEnReX3M5maqsOkT9YlfawNAiavLl1fpW3Qy7jMCKPIicNuJp1E2icK94PEBZTia6aopqibS09B1OlSicshNkT5Q/640?wx_fmt=jpeg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 根据说明，我们的代码超简单的，跑起来也超快的</span><br>samtools index ESC_input_1.bam ESC_input_1.bam.bai<br></code></pre><p data-tool="mdnice编辑器">IGV查看示例，我们已知TP53的经典下游基因包括CDKN1A（P21）等，于是挑出来简单看看，结果如下：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6027397260273972" data-type="jpeg" data-w="1022" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/NDy5aEnReX3M5maqsOkT9YlfawNAiavLl1hxIbbQXNjib3icbzZZfk9CiblerKrUYh3mCyHWKXLlHPChsS7a8XNQ8w/640?wx_fmt=jpeg" src="https://mmbiz.qpic.cn/mmbiz_jpg/NDy5aEnReX3M5maqsOkT9YlfawNAiavLl1hxIbbQXNjib3icbzZZfk9CiblerKrUYh3mCyHWKXLlHPChsS7a8XNQ8w/640?wx_fmt=jpeg"></figure><p data-tool="mdnice编辑器">问题不大，我们下一篇就开始Peak Calling了</p></section><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/jzcdTK1y_kDDy7drHGGL2w",target="_blank" rel="noopener noreferrer">原文链接</a>
