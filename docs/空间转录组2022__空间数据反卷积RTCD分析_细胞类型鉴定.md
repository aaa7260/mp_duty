---
title: "空间转录组2022||空间数据反卷积RTCD分析：细胞类型鉴定"
date: 2022-11-17T02:44:21Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
空间转录组2022||空间数据反卷积RTCD分析：细胞类型鉴定 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">参考教程链接：</p><ul data-tool="mdnice编辑器"><li><section>https://github.com/dmcable/spacexr</section></li><li><section>官方教程：https://github.com/dmcable/spacexr/tree/master/vignettes</section></li><li><section>文献解读：10X单细胞空间联合分析之十（RCTD） https://www.jianshu.com/p/92a6df0dcb1b</section></li></ul><p data-tool="mdnice编辑器">RCTD可以将单细胞类型或细胞类型混合分配到空间转录组spots上。RCTD 有三种模式：</p><ul data-tool="mdnice编辑器"><li><section><strong>doublet mode</strong>：它为每个Spot分配1-2种细胞类型，推荐用于高空间分辨率的技术，如Slide-seq和MERFISH</section></li><li><section><strong>full mode</strong>：它为每个Spot分配任意数量的细胞类型，推荐用于空间分辨率较低的技术，如100微米分辨率的Visium</section></li><li><section><strong>multi mode</strong>：doublet mode的扩展，可以在每个点上发现两种以上的细胞类型，作为full mode的替代选项</section></li></ul><p data-tool="mdnice编辑器">每种模态都有一个对应的教程</p><p data-tool="mdnice编辑器">今天先来学习Doublet mode: spatial transcriptomics vignette. Also, most other vignettes use doublet mode.</p><p data-tool="mdnice编辑器">包安装</p><pre data-tool="mdnice编辑器"><code><span># install.packages("devtools")</span><br>devtools::install_github(<span>"dmcable/spacexr"</span>, build_vignettes = <span>FALSE</span>)<br><span>library</span>(spacexr)<br><span>library</span>(Matrix)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>Introduction</span><span> </span></h2><p data-tool="mdnice编辑器">稳健细胞类型分解(Robust Cell Type Decomposition，简称RCTD)是一种从空间转录组数据中学习细胞类型的统计方法。</p><p data-tool="mdnice编辑器">在本次示例中，我们将为小脑Slide-seq数据集反卷积注释细胞类型。教程使用带注释的snRNA-seq小脑数据集定义细胞类型。</p><p data-tool="mdnice编辑器">Note：参考也可以是单细胞数据集或细胞类型特定的bulkRNA-seq数据集。</p><h2 data-tool="mdnice编辑器"><span></span><span>数据预处理</span><span> </span></h2><p data-tool="mdnice编辑器">RCTD需要两个数据：带有注释的单细胞转录组参考数据，需要反卷积注释的空间转录组数据。</p><h3 data-tool="mdnice编辑器"><span></span>reference数据<span></span></h3><p data-tool="mdnice编辑器">首先是单细胞参考数据集。reference使用RCTD包中Reference函数，这个函数需要三个参数：</p><ul data-tool="mdnice编辑器"><li><section><strong>counts</strong>：为矩阵或dgCmatrix对象。行名是基因，列名代表barcode/细胞名。counts应该是<strong>未转换</strong>的原始counts数据</section></li><li><section><strong>cell_types</strong>：为带有细胞命名的(通过细胞barcode)细胞类型因子。因子的“水平”是可能的细胞类型标识。</section></li><li><section><strong>nUMI</strong>：可选，具有barcode的每个像素中总counts or UMI列表。如果没有提供，nUMI将被假定为出现在每个像素上的总数。</section></li></ul><p data-tool="mdnice编辑器">reference可能来自各种数据类型，但需要将其加载到R环境中。</p><p data-tool="mdnice编辑器">在本教程中，我们的reference作为两个csv文件存储在' reference /Vignette '文件夹中:</p><ul data-tool="mdnice编辑器"><li><section><strong>meta_data.csv</strong>：CSV文件(有3列，标题为“barcode”、“cluster”和“nUMI”)，包含每个细胞的nUMI和单元格类型分配。</section></li><li><section><strong>dge.csv</strong>：标准10x格式的基因表达CSV文件。</section></li></ul><pre data-tool="mdnice编辑器"><code><span>### Load in/preprocess your data, this might vary based on your file type</span><br><span># directory for the reference</span><br>refdir &lt;- system.file(<span>"extdata"</span>,<span>'Reference/Vignette'</span>,package = <span>'spacexr'</span>) <br><span># load in counts matrix</span><br>counts &lt;- read.csv(file.path(refdir,<span>"dge.csv"</span>)) <br><span># Move first column to rownames</span><br>rownames(counts) &lt;- counts[,<span>1</span>]<br>counts[,<span>1</span>] &lt;- <span>NULL</span><br>counts[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br><br><span># load in meta_data (barcodes, clusters, and nUMI)</span><br>meta_data &lt;- read.csv(file.path(refdir,<span>"meta_data.csv"</span>)) <br>head(meta_data)<br><br><span># create cell_types named list</span><br>cell_types &lt;- meta_data$cluster<br>names(cell_types) &lt;- meta_data$barcode <br><span># convert to factor data type</span><br>cell_types &lt;- as.factor(cell_types) <br>head(cell_types)<br><br><span># create nUMI named list</span><br>nUMI &lt;- meta_data$nUMI<br>names(nUMI) &lt;- meta_data$barcode <br>head(nUMI)<br><br><span>### Create the Reference object</span><br>reference &lt;- Reference(counts, cell_types, nUMI)<br>str(reference)<br><br><span>## Examine reference object (optional)</span><br><span>#observe Digital Gene Expression matrix</span><br>print(dim(reference@counts)) <br><span>#&gt; [1] 384 475</span><br><br><span>#number of occurences for each cell type</span><br>table(reference@cell_types) <br><br><span>## Save RDS object (optional)</span><br>saveRDS(reference, file.path(refdir,<span>'SCRef.rds'</span>))<br></code></pre><p data-tool="mdnice编辑器">至此，reference已经构建好。</p><h3 data-tool="mdnice编辑器"><span></span>空间转录组数据<span></span></h3><p data-tool="mdnice编辑器">接下来，加载空间数据为SpatialRNA对象。SpatialRNA函数需要三个参数：</p><ul data-tool="mdnice编辑器"><li><section><strong>coords</strong>：数据框或者矩阵对象，为空间像素坐标，行名为每个像素的barcode，列为x和y</section></li><li><section><strong>counts</strong>：矩阵或者dgCmatrix对象，行名是基因，列名是每个像素的barcode，counts值没有进行转换。</section></li><li><section><strong>nUMI</strong>：可选</section></li></ul><p data-tool="mdnice编辑器">构建SpatialRNA有不同的方法，本教程为两个文件：</p><ul data-tool="mdnice编辑器"><li><section><strong>BeadLocationsForR.csv</strong>：CSV文件，三列，列名为"barcodes”, “xcoord”, and “ycoord”，包含每个像素的空间坐标；</section></li><li><section><strong>MappedDGEForR.csv</strong>：每个像素的表达矩阵文件</section></li></ul><pre data-tool="mdnice编辑器"><code><span>##=============================== 读取空间数据</span><br><span># directory for sample Slide-seq dataset</span><br>datadir &lt;- system.file(<span>"extdata"</span>,<span>'SpatialRNA/Vignette'</span>,package = <span>'spacexr'</span>) <br>counts &lt;- read.csv(file.path(datadir,<span>"MappedDGEForR.csv"</span>))<br>rownames(counts) &lt;- counts[,<span>1</span>]; counts[,<span>1</span>] &lt;- <span>NULL</span><br>counts[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br>coords &lt;- read.csv(file.path(datadir,<span>"BeadLocationsForR.csv"</span>))<br>rownames(coords) &lt;- coords$barcodes<br>coords$barcodes &lt;- <span>NULL</span><br>head(coords)<br><br><span># In this case, total counts per pixel is nUMI</span><br>nUMI &lt;- colSums(counts) <br>head(nUMI)<br><br><span>### Create SpatialRNA object</span><br>puck &lt;- SpatialRNA(coords, counts, nUMI)<br>str(puck)<br><br><br><span>### Create SpatialRNA object</span><br>puck &lt;- SpatialRNA(coords, counts, nUMI)<br>str(puck)<br><br><span>## Examine SpatialRNA object (optional)</span><br>print(dim(puck@counts))<br><br><span># histogram of log_2 nUMI</span><br>hist(log(puck@nUMI,<span>2</span>))<br></code></pre><p data-tool="mdnice编辑器">结果图：可以看到空间数据的每个像素中UMI的数值分布。</p><p><img data-ratio="0.7494172494172494" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujKmrMXZs5xjsTuBX9XLxsn7qUkHAkvdYzCS44IE9ibCsTS4zriaG6okZA/640?wx_fmt=png" data-type="png" data-w="858" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujKmrMXZs5xjsTuBX9XLxsn7qUkHAkvdYzCS44IE9ibCsTS4zriaG6okZA/640?wx_fmt=png"></p><p data-tool="mdnice编辑器"><br></p><pre data-tool="mdnice编辑器"><code>print(head(puck@coords)) <span># start of coordinate data.frame</span><br>barcodes &lt;- colnames(puck@counts) <span># pixels to be used (a list of barcode names). </span><br><br><span># This list can be restricted if you want to crop the puck e.g. </span><br><span># puck &lt;- restrict_puck(puck, barcodes) provides a basic plot of the nUMI of each pixel</span><br><span># on the plot:</span><br>p &lt;- plot_puck_continuous(puck, barcodes, puck@nUMI, ylimit = c(<span>0</span>,round(quantile(puck@nUMI,<span>0.9</span>))), title =<span>'plot of nUMI'</span>) <br></code></pre><p data-tool="mdnice编辑器">结果图：使用x，y坐标展示每个像素中的UMI分布</p><figure data-tool="mdnice编辑器"><img data-ratio="0.797752808988764" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujWiaAfF9UDcygds3iafmlIxcKk84JSD87iawQI84vDa9rYC0E04nWPXh4Q/640?wx_fmt=png" data-type="png" data-w="801" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujWiaAfF9UDcygds3iafmlIxcKk84JSD87iawQI84vDa9rYC0E04nWPXh4Q/640?wx_fmt=png"><figcaption>image-20221111222947585</figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>创建RCTD对象</span><span> </span></h2><p data-tool="mdnice编辑器">使用create.RCTD函数创建。以下为几个有用的参数：</p><ul data-tool="mdnice编辑器"><li><section><strong>max_cores</strong>：对于并行处理，使用的线程数</section></li><li><section><strong>gene_cutoff, fc_cutoff, gene_cutoff_reg, fc_cutoff_reg</strong>：差异表达基因筛选阈值</section></li><li><section><strong>UMI_min, UMI_max</strong>：每个像素点的阈值筛选</section></li></ul><h3 data-tool="mdnice编辑器"><span></span>运行RCTD<span></span></h3><p data-tool="mdnice编辑器">可以使用run.RCTD函数，这个函数等价于：fitBulk<code>, </code>choose_sigma_c<code>, and </code>fitPixels这三个函数。doublet_mode可以选择上面提到的三种反卷积模式。</p><pre data-tool="mdnice编辑器"><code>myRCTD &lt;- create.RCTD(puck, reference, max_cores = <span>10</span>)<br>myRCTD &lt;- run.RCTD(myRCTD, doublet_mode = <span>'doublet'</span>)<br>str(myRCTD)<br></code></pre><p data-tool="mdnice编辑器">myRCTD结构：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.2708113804004215" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujVGFicFIlv1V4no4Cgmfb6ibCGfPAOrAKMtI1OwJJGibiaibVqfcCpVUiblEQ/640?wx_fmt=png" data-type="png" data-w="949" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujVGFicFIlv1V4no4Cgmfb6ibCGfPAOrAKMtI1OwJJGibiaibVqfcCpVUiblEQ/640?wx_fmt=png"><figcaption>image-20221112182253019</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>RCTD结果<span></span></h3><p data-tool="mdnice编辑器">RCTD结果保存在myRCTD对象中的@results中</p><ul data-tool="mdnice编辑器"><li><section>@results$weights：是一个数据框，为full mode模式下每一个spots（即像素）中细胞类型的权重</section></li><li><section>@results$results_df：doublet_mode的结果</section></li><ul><li><section>spot_class：因子类型，RCTD的分类，singlet表示每个spot有一种细胞类型，doublet_certain表示每个spot有两种细胞类型，doublet_uncertain表示spot上有2种细胞类型，但只确定有1种，reject表示没有预测到结果。</section></li><li><section>first_type：因子类型，预测到的第一种细胞类型</section></li><li><section>second_type：因子类型，预测到的第一种细胞类型</section></li></ul><li><section>@results$weights_doublet：doublet_mode下每种细胞类型的权重</section></li></ul><pre data-tool="mdnice编辑器"><code>results &lt;- myRCTD@results<br><br><span># normalize the cell type proportions to sum to 1.</span><br>norm_weights = normalize_weights(results$weights) <br><br><span>#list of cell type names</span><br>cell_type_names &lt;- myRCTD@cell_type_info$info[[<span>2</span>]] <br>spatialRNA &lt;- myRCTD@spatialRNA<br><br><span>## you may change this to a more accessible directory on your computer.</span><br>resultsdir &lt;- <span>'RCTD_Plots'</span> <br>dir.create(resultsdir)<br></code></pre><p data-tool="mdnice编辑器">results$results_df结果示例如下：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.40358744394618834" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujwYP7GPFK8Gz7RSaiamGdcQD8hm4Ig12d2bed8bpyxaCXc222OtesKbg/640?wx_fmt=png" data-type="png" data-w="892" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujwYP7GPFK8Gz7RSaiamGdcQD8hm4Ig12d2bed8bpyxaCXc222OtesKbg/640?wx_fmt=png"><figcaption>image-20221112184204705</figcaption></figure><p data-tool="mdnice编辑器">接下来对结果可视化绘图：</p><pre data-tool="mdnice编辑器"><code><span># make the plots </span><br><span># 绘制full_mode模式下每种细胞类型的可信权重 (saved as </span><br><span># 'results/cell_type_weights_unthreshold.pdf')</span><br>plot_weights(cell_type_names, spatialRNA, resultsdir, norm_weights) <br><br><span># 绘制full_mode模式下每种细胞类型的权重</span><br><span># 这里每种细胞类型一幅图，点表示空间上的一个像素或者spot，颜色为权重 (saved as</span><br><span># 'results/cell_type_weights.pdf')</span><br>plot_weights_unthreshold(cell_type_names, spatialRNA, resultsdir, norm_weights) <br><br><span># 绘制full_mode模式下每种细胞类型预测到的spots数 (saved as </span><br><span># 'results/cell_type_occur.pdf')</span><br>plot_cond_occur(cell_type_names, resultsdir, norm_weights, spatialRNA)<br><br><span># 绘制doublet_mode模式下每种细胞类型的权重 (saved as </span><br><span># 'results/cell_type_weights_doublets.pdf')</span><br>plot_weights_doublet(cell_type_names, spatialRNA, resultsdir, results$weights_doublet, results$results_df) <br></code></pre><p data-tool="mdnice编辑器">其中，绘制full_mode模式下每种细胞类型预测到的spots数结果图如下：</p><p data-tool="mdnice编辑器">从这里可以看得出，空间数据预测出来的主要为细胞类型10，其次是18。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.8383961117861483" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNuj1w7F3E2XJcmd8nnk7foYhNnVx1h2pmHv7YFwo4k9R3uzuxwM2wSJjw/640?wx_fmt=png" data-type="png" data-w="823" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNuj1w7F3E2XJcmd8nnk7foYhNnVx1h2pmHv7YFwo4k9R3uzuxwM2wSJjw/640?wx_fmt=png"><figcaption>image-20221112192742832</figcaption></figure><pre data-tool="mdnice编辑器"><code><span># 所有细胞类型的map结果 (saved as </span><br><span># 'results/all_cell_types.pdf')</span><br>plot_all_cell_types(results$results_df, spatialRNA@coords, cell_type_names, resultsdir) <br></code></pre><p data-tool="mdnice编辑器">所有细胞类型的map结果图：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.991991991991992" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNuj4iboFWUILlK1K7DIrhV5icibjpr8iahzatknXVyNcqhKX56ib3veAlSre8g/640?wx_fmt=png" data-type="png" data-w="999" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNuj4iboFWUILlK1K7DIrhV5icibjpr8iahzatknXVyNcqhKX56ib3veAlSre8g/640?wx_fmt=png"><figcaption>image-20221112194400757</figcaption></figure><p data-tool="mdnice编辑器">绘制doublets：</p><pre data-tool="mdnice编辑器"><code><span># doublets</span><br><span># obtain a dataframe of only doublets</span><br>doublets &lt;- results$results_df[results$results_df$spot_class == <span>"doublet_certain"</span>,] <br><br><span># 绘制所有的doublets (saved as </span><br><span># 'results/all_doublets.pdf')</span><br>plot_doublets(spatialRNA, doublets, resultsdir, cell_type_names) <br><br><span># 对每种细胞类型绘制doublets (saved as </span><br><span># 'results/all_doublets_type.pdf')</span><br>plot_doublets_type(spatialRNA, doublets, resultsdir, cell_type_names) <br><br><span># a table of frequency of doublet pairs </span><br>doub_occur &lt;- table(doublets$second_type, doublets$first_type) <br><br><span># 绘制doublet出现的堆积柱状图 (saved as  </span><br><span># 'results/doublet_stacked_bar.pdf')</span><br>plot_doub_occur_stack(doub_occur, resultsdir, cell_type_names) <br></code></pre><p data-tool="mdnice编辑器">doublet_stacked_bar结果图：</p><figure data-tool="mdnice编辑器"><img data-ratio="1.0121457489878543" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujnftojzYwzLAMWEJodsa51Gu16ma4S4mJQbIZMfVX16oGQPbnxS0jSQ/640?wx_fmt=png" data-type="png" data-w="988" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujnftojzYwzLAMWEJodsa51Gu16ma4S4mJQbIZMfVX16oGQPbnxS0jSQ/640?wx_fmt=png"><figcaption>image-20221112194946431</figcaption></figure><p data-tool="mdnice编辑器">感觉这个软件的结果图不是很好看，可调整度也不高，我觉得跟教程的数据有关系，后面重新找个数据看看。</p><p data-tool="mdnice编辑器">教程的空间数据是slide-seq的数据：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.625314333612741" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujcmx0PDvpR53LuJy0v5rCRZ8RibI9xPVIuMnfibrrTEYicmpuuVTu7ibW4g/640?wx_fmt=png" data-type="png" data-w="1193" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujcmx0PDvpR53LuJy0v5rCRZ8RibI9xPVIuMnfibrrTEYicmpuuVTu7ibW4g/640?wx_fmt=png"><figcaption>img</figcaption></figure><p data-tool="mdnice编辑器">找了个10x Visium的文献来看看：</p><p data-tool="mdnice编辑器">ref1：Cell2location maps fine-grained cell types in spatial transcriptomics ( https://doi.org/10.1038/s41587-021-01139-4 )</p><figure data-tool="mdnice编辑器"><img data-ratio="0.32934131736526945" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujDpu4Htw1dEEdPkxicxVgter13gjLibUmw5ygXUFfqvQTKMydq8zfZh6A/640?wx_fmt=png" data-type="png" data-w="1336" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrKbHC880K54J67kIbJNujDpu4Htw1dEEdPkxicxVgter13gjLibUmw5ygXUFfqvQTKMydq8zfZh6A/640?wx_fmt=png"><figcaption>image-20221112222920831</figcaption></figure></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/r78K4tm44VqV2FsIoS71Cg",target="_blank" rel="noopener noreferrer">原文链接</a>
