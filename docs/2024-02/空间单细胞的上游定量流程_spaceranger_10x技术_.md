---
title: "空间单细胞的上游定量流程（spaceranger，10x技术）"
date: 2024-02-15T01:23:41Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
空间单细胞的上游定量流程（spaceranger，10x技术） by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>前面的教程里面 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527907&amp;idx=1&amp;sn=5e2b4fa9b8f28f2169de87e057dde983&amp;scene=21#wechat_redirect" data-linktype="2">能从源头解决数据分析的瑕疵吗</a> ，我们重现了<strong>普通单细胞转录组</strong>数据分析的从fastq文件开始的走cellranger的定量流程。使用的是kingfisher进行了一行代码下载数据，但是针对同一个文章的<strong>空间单细胞转录组数据</strong>就总是失败，既然没办法直接下载fastq文件，就只能说是曲线救国啦，先现在ncbi数据库里面的sra文件然后转为fastq文件即可。</p></blockquote><h3 data-tool="mdnice编辑器"><span></span><span>下载sra文件</span><span></span></h3><p data-tool="mdnice编辑器">首先呢，需要熟读文献，在推文：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527859&amp;idx=1&amp;sn=f4dd19d99f1110c5552b8d978a7b82b3&amp;scene=21#wechat_redirect" data-linktype="2">数据分析有错误并不可怕，造假才不可饶恕</a> 提到了这个新鲜出炉（ 2023年12月5日）的cell期刊的文章。根据文献里面的空间单细胞转录组样品情况，制作一个文本文件；srr_list.txt ，内容就是下面的3个id即可：</p><pre data-tool="mdnice编辑器"><span></span><code>SRR19996402<br>SRR19996403<br>SRR19996404 <br></code></pre><p data-tool="mdnice编辑器">然后使用ncbi提供的SRA Toolkit 工具集里面的命令<code>prefetch</code> 根据上面的3个id去下载，如下所示的很简单的一句话代码即可 ：<code>nohup prefetch -O ./ --option-file srr_list.txt --max-size u 1&gt;down.log 2&gt;&amp;1 &amp;</code></p><p data-tool="mdnice编辑器">其中<code>prefetch</code> 是 NCBI（National Center for Biotechnology Information）提供的一个命令行工具（ SRA Toolkit 工具集），用于下载和缓存 NCBI 数据库中的生物信息学数据。它是 SRA Toolkit 工具集的一部分，专门用于处理 NCBI Sequence Read Archive（SRA）中的高通量测序数据。</p><p data-tool="mdnice编辑器">上面的Linux命令是使用<code>nohup</code>命令在后台运行<code>prefetch</code>程序，并将输出记录到名为<code>down.log</code>的文件中。以下是每个部分的详细解释：</p><ul data-tool="mdnice编辑器"><li><section><code>nohup</code>: 该命令用于在后台运行其他命令，同时忽略SIGHUP（hangup）信号，这样即使用户退出终端，命令仍会继续执行。</section></li><li><section><code>prefetch</code>: 这是 NCBI SRA Toolkit 提供的命令行工具，用于从 NCBI Sequence Read Archive（SRA）下载测序数据。它需要一个或多个参数，这里可能是通过 <code>--option-file srr_list.txt</code> 指定一个包含SRR号的文本文件，表示要下载的数据。</section></li><li><section><code>-O ./</code>: 指定数据下载的输出目录为当前目录下（<code>./</code>）。</section></li><li><section><code>--max-size u</code>: 这个选项可能是指定下载的数据的大小上限为 unlimited（不受限制）。这意味着，无论数据有多大，都会被下载。</section></li><li><section><code>1&gt;down.log</code>: 将标准输出重定向到名为 <code>down.log</code> 的文件中。这意味着<code>prefetch</code>程序的输出将保存在 <code>down.log</code> 文件中。</section></li><li><section><code>2&gt;&amp;1</code>: 将标准错误（stderr）重定向到与标准输出相同的位置，即 <code>down.log</code> 文件。</section></li><li><section><code>&amp;</code>: 在命令末尾使用 <code>&amp;</code> 符号表示在后台运行该命令。</section></li></ul><p data-tool="mdnice编辑器">当然了，如果下载和安装NCBI（National Center for Biotechnology Information）提供的一个命令行工具（ SRA Toolkit 工具集），就是很简单的conda啦，在前面的教程里面 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527907&amp;idx=1&amp;sn=5e2b4fa9b8f28f2169de87e057dde983&amp;scene=21#wechat_redirect" data-linktype="2">能从源头解决数据分析的瑕疵吗</a> ，给出来了代码，这里就不再赘述。</p><p data-tool="mdnice编辑器">命令<code>prefetch</code> 根据上面的3个id去下载，得到如下所示的文件：</p><pre data-tool="mdnice编辑器"><span></span><code>ls -lh */*sra|cut -d<span>" "</span> -f 5-<br>36G 1月  15 05:14 SRR19996402/SRR19996402.sra<br>54G 1月  15 06:36 SRR19996403/SRR19996403.sra<br>32G 1月  15 11:04 SRR19996404/SRR19996404.sra<br></code></pre><p data-tool="mdnice编辑器">需要把这样的sra文件转为fastq格式的测序数据文件才可以跑流程：</p><pre data-tool="mdnice编辑器"><span></span><code>ls SRR*/*sra |<span>while</span> <span>read</span> id;<span>do</span> (fasterq-dump -O ./ --split-files -e 8 --include-technical <span>${id}</span> );<span>done</span> <br></code></pre><p data-tool="mdnice编辑器">会得到如下所示的文件哦：</p><pre data-tool="mdnice编辑器"><span></span><code>ls -lh SRR1999640*gz|cut -d<span>" "</span> -f 5-<br> 15G 1月  12 18:20 SRR19996402_1.fastq.gz<br> 17G 1月  12 18:31 SRR19996402_2.fastq.gz<br> 21G 1月  14 12:36 SRR19996403_1.fastq.gz<br> 26G 1月  14 12:54 SRR19996403_2.fastq.gz<br> 14G 1月  14 18:23 SRR19996404_1.fastq.gz<br> 15G 1月  14 18:32 SRR19996404_2.fastq.gz<br></code></pre><p data-tool="mdnice编辑器">可以看到，每个样品最开始是单个sra的文件，转了之后是两个fastq.gz文件，理论上是足够走spaceranger定量流程啦。前面我们介绍的单细胞转录组的cellranger的定量流程可以作为参考，代码我已经是多次分享了。参考：</p><ul data-tool="mdnice编辑器"><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247512340&amp;idx=3&amp;sn=1b9609a8870a0209dd27ffdcbc3cac87&amp;chksm=9b4bf1afac3c78b90674678fcec66365b9faaa275ff4b0a2255e0a05fa8b905e15222a643bea&amp;scene=21#wechat_redirect" data-linktype="2">10X单细胞转录组原始测序数据的Cell Ranger流程（仅需800元）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247496813&amp;idx=1&amp;sn=4151bf2265618eff4e0123722c50e569&amp;scene=21#wechat_redirect" data-linktype="2">10X的单细胞转录组原始数据也可以在EBI下载</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247510920&amp;idx=1&amp;sn=c4561d34e984406693c014cdfe236c0f&amp;chksm=9b4beb33ac3c622542d894344c323ff7cca52f69119d02fc7aa4636af0cbe7df4b6c63dd5ba9&amp;scene=21#wechat_redirect" data-linktype="2">一个10x单细胞转录组项目从fastq到细胞亚群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513565&amp;idx=1&amp;sn=092e637017d176c43f00a295d3210592&amp;scene=21#wechat_redirect" data-linktype="2">一文打通单细胞上游：从软件部署到上游分析</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513605&amp;idx=1&amp;sn=e86a329c887745c6d00d3ededa39dcda&amp;chksm=9b4bf6beac3c7fa8523cef4e7189fb20b914460ddb61e6cd1dd520b5928e1b59a8b7827ce783&amp;scene=21#wechat_redirect" data-linktype="2">PRJNA713302这个10x单细胞fastq实战</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513968&amp;idx=1&amp;sn=f5a44a7bea0bdacd8af1a20c177763e5&amp;scene=21#wechat_redirect" data-linktype="2">一次曲折且昂贵的单细胞公共数据获取与上游处理</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514146&amp;idx=1&amp;sn=b9721433d49a2d963eeaab1ad47fc91b&amp;scene=21#wechat_redirect" data-linktype="2">只能下载bam文件的10x单细胞转录组项目数据处理</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511452&amp;idx=2&amp;sn=83ec97cbc3334a6095e6d63e05e9fd6e&amp;scene=21#wechat_redirect" data-linktype="2">不知道10x单细胞转录组样品和fastq文件的对应关系</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508521&amp;idx=2&amp;sn=2cf3158e74d37b3a741908d8bfc8f02f&amp;scene=21#wechat_redirect" data-linktype="2">10X单细胞转录组测序数据的 SRA转fastq踩坑那些事</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514395&amp;idx=2&amp;sn=96c505b76ae87dd0efa737c4c44e2270&amp;scene=21#wechat_redirect" data-linktype="2">10x的单细胞转录组fastq文件的R1和R2不能弄混哦</a></section></li></ul><p data-tool="mdnice编辑器">因为这次是空间单细胞转录组，所以换一个软件，不再是cellranger的定量流程，应该是spaceranger，大同小异哈！</p><h3 data-tool="mdnice编辑器"><span></span><span>spaceranger的准备工作</span></h3><p><img data-galleryid="" data-imgfileid="100036313" data-ratio="0.6287037037037037" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSIY97AgmQnWushuU4myIWniaDBSbSGtCqgCmHUvr5iaeNibibkUjmV4jw7jziaWk9hbJLLrRO7xZdeskw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSIY97AgmQnWushuU4myIWniaDBSbSGtCqgCmHUvr5iaeNibibkUjmV4jw7jziaWk9hbJLLrRO7xZdeskw/640?wx_fmt=png&amp;from=appmsg"></p><span></span><p data-tool="mdnice编辑器">主要是需要下载软件以及配套的数据库文件即可，都是需要去10x的官网下载即可，都是解压即可使用！</p><ul data-tool="mdnice编辑器"><li><section>https://support.10xgenomics.com/spatial-gene-expression/software/downloads/latest</section></li></ul><p data-tool="mdnice编辑器">虽然说Space Ranger跟cellranger软件名字不一样，但是使用方法是很类似的，感兴趣的可以试试看10x官网提供的空间单细胞转录组案例数据：</p><ul data-tool="mdnice编辑器"><li><section>wget https://cf.10xgenomics.com/samples/spatial-exp/1.3.0/Visium_FFPE_Human_Breast_Cancer/Visium_FFPE_Human_Breast_Cancer_fastqs.tar</section></li></ul><p data-tool="mdnice编辑器">基本上也是常规的fq文件命名格式即可，因为不同文件命名有不同含义，所以一定是不能弄混哦 ：</p><ul data-tool="mdnice编辑器"><li><section>28bp read 1 (16bp Visium spatial barcode, 12bp UMI),</section></li><li><section>50bp read2 (transcript)</section></li><li><section>10bp i7 sample barcode</section></li><li><section>10bp i5 sample barcode.</section></li></ul><p data-tool="mdnice编辑器">我们这里演示的是上面的sra文件变成的fq文件，所以是需要合理的改名的，如下所示：：</p><pre data-tool="mdnice编辑器"><span></span><code>ls -lh GSM*ST*gz|cut -d<span>" "</span> -f 5-<br>22 1月  13 23:41 GSM6294362_ST1_S1_L001_R1_001.fastq.gz -&gt; SRR19996404_1.fastq.gz<br>22 1月  13 23:41 GSM6294362_ST1_S1_L001_R2_001.fastq.gz -&gt; SRR19996404_2.fastq.gz<br>22 1月  13 23:41 GSM6294363_ST2_S1_L001_R1_001.fastq.gz -&gt; SRR19996403_1.fastq.gz<br>22 1月  13 23:41 GSM6294363_ST2_S1_L001_R2_001.fastq.gz -&gt; SRR19996403_2.fastq.gz<br>22 1月  13 23:41 GSM6294364_ST3_S1_L001_R1_001.fastq.gz -&gt; SRR19996402_1.fastq.gz<br>22 1月  13 23:41 GSM6294364_ST3_S1_L001_R2_001.fastq.gz -&gt; SRR19996402_2.fastq.gz<br></code></pre><p data-tool="mdnice编辑器">可以看到，其实每个样品只需要是有r1和r2即可，并不一定要四个文件或者三个文件哈。但是文件名字一定要符合规则哦！我上面演示了通过软连接的方式合理的给空间单细胞转录组测序数据文件修改名字哦！</p><h3 data-tool="mdnice编辑器"><span></span><span>运行spaceranger进行空间单细胞的上游定量</span><span></span></h3><p data-tool="mdnice编辑器">写一个脚本文本文件（ run_sapceranger.sh ），如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#! /bin/bash -xe</span><br><span>##</span><br>bin=/home/jmzeng/x10/pipeline/spaceranger-<span>2.1</span><span>.1</span>/spaceranger<br>db=/home/jmzeng/x10/pipeline/refdata-gex-mm10-<span>2020</span>-A<br><br>fq_dir=${<span>2</span>}<br><br>/usr/bin/time -v $bin count --id=${<span>1</span>} \<br>--transcriptome=$db \<br>--fastqs=$fq_dir \<br>--sample=${<span>1</span>} \<br>--image=${<span>3</span>} \<br>--unknown-slide visium-<span>1</span> \<br>--localcores=<span>2</span> \<br>--localmem=<span>80</span><br></code></pre><p data-tool="mdnice编辑器">上面的脚本文本文件（ run_sapceranger.sh ），可以接受3个参数，包括样品的fastq格式的测序数据文件前缀，样品的fastq格式的测序数据文件所在的文件夹路径，以及样品的图片。也就是说，是需要每个样品有fastq格式的测序数据文件的同时还需要有图片。。。。前提是作者确实是提供了，幸好我们在文章对应的geo数据库里面看到了压缩包里面是有图片的  ：</p><pre data-tool="mdnice编辑器"><span></span><code>ls -lh GSE207546_RAW/ |cut -d<span>" "</span> -f 5-<br><br> 13M 1月  18 18:37 GSM6294362_ST_treatment1_spatial.tar.gz<br> 12M 1月  18 18:37 GSM6294363_ST_treatment2_spatial.tar.gz<br> 13M 1月  18 18:37 GSM6294364_ST_treatment3_spatial.tar.gz<br></code></pre><p data-tool="mdnice编辑器">我们拿其中一个样品举例，解压后可以看到 GSE207546_RAW/ST_treatment3/aligned_fiducials.jpg 就可以后面的走流程啦！所以，单个样品跑上面的脚本文本文件（ run_sapceranger.sh ）的代码就蛮复杂啦；</p><pre data-tool="mdnice编辑器"><span></span><code>nohup bash run_sapceranger.sh  GSM6294364_ST3  \<br>./rawdata    \<br>./GSE207546_RAW/ST_treatment3/aligned_fiducials.jpg \ <br>1&gt;log_GSM6294364_ST3.txt 2&gt;&amp;1 &amp;<br></code></pre><p data-tool="mdnice编辑器">值得注意是上面的Linux命令非常依赖于文件夹路径的准确性，文件的存在与否。也就是说要准备好3个参数，包括样品的fastq格式的测序数据文件前缀，样品的fastq格式的测序数据文件所在的文件夹路径，以及样品的图片。</p><p data-tool="mdnice编辑器">让我们伤心的是很多空间单细胞转录组文献他们公开了样品的测序数据，但是缺乏对应的 图片文件，所以很难走这个定量流程。</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/oMSij89hYATPrbdnjRqxSw",target="_blank" rel="noopener noreferrer">原文链接</a>
