---
title: "各个单细胞亚群特异性的转录因子热图"
date: 2024-02-29T09:29:34Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
各个单细胞亚群特异性的转录因子热图 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span></span>各个单细胞亚群特异性的转录因子热图</h1><p data-tool="mdnice编辑器">虽然转录因子分析作为单细胞转录组数据分析的3大高级分析之一名满天下，但是因为它太耗费计算资源导致绝大部分人敬而远之，我们其实也多次分享过细节教程：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497441&amp;idx=1&amp;sn=7a53e6aa00c84b57104a61787f2beb03&amp;scene=21#wechat_redirect" data-linktype="2">张泽民团队的单细胞研究把T细胞分的如此清楚</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497617&amp;idx=2&amp;sn=fe47078075a3b9994079761f96870aa3&amp;scene=21#wechat_redirect" data-linktype="2">细胞通讯分析的背景知识</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497617&amp;idx=1&amp;sn=0e63223347afbb0795aa94d339d72214&amp;scene=21#wechat_redirect" data-linktype="2">构建单细胞亚群网络（类似于细胞通讯分析）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497653&amp;idx=2&amp;sn=320d26cad3d8141bb081d6ff798ae778&amp;scene=21#wechat_redirect" data-linktype="2">细胞通讯分析结果的解读</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497665&amp;idx=1&amp;sn=74ac0e87b9689d5df7c0208e1c1dc0ac&amp;scene=21#wechat_redirect" data-linktype="2">SCENIC转录因子分析结果的解读</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497956&amp;idx=1&amp;sn=5d4deb7cf7b7848b3e2273cbd663bb6a&amp;scene=21#wechat_redirect" data-linktype="2">人人都能学会的单细胞聚类分群注释</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247498040&amp;idx=1&amp;sn=3a39699ab10fb71b966adb5e7e640270&amp;scene=21#wechat_redirect" data-linktype="2">对单细胞表达矩阵做gsea分析</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247498091&amp;idx=1&amp;sn=5c157da6e889f2134ef9342cee560197&amp;scene=21#wechat_redirect" data-linktype="2">单细胞转录因子分析之SCENIC流程</a></section></li></ul><p data-tool="mdnice编辑器">如果你没有足够的计算资源，我们其实也推荐过一个简单版本的转录因子分析，就是 dorothea 这个R包，本质上是计算  Viper 得分，代码如下所示:</p><pre data-tool="mdnice编辑器"><span></span><code><span>## We compute Viper Scores </span><br> <br><span># 0.安装R包 ----</span><br><span># devtools::install_github('caleblareau/BuenColors')</span><br><span># utils::install.packages(pkgs = "ggstatsplot")</span><br><span># InstallData("pbmc3k") </span><br><br><span># 1.加载R包和测试数据 ----</span><br>rm(list = ls())<br><span>library</span>(SeuratData) <span>#加载seurat数据集  </span><br>getOption(<span>'timeout'</span>)<br>options(timeout = <span>10000</span>)<br>data(<span>"pbmc3k"</span>)  <br>sce &lt;- pbmc3k.final  <br><span>library</span>(Seurat)<br><span># 一个seurat对象</span><br><span>library</span>(Seurat)<br><span>library</span>(dorothea)<br><span>library</span>(tidyverse)<br><br><span># 获取包自带数据库</span><br><span>## We read Dorothea Regulons for Human:</span><br>dorothea_regulon_human &lt;- get(data(<span>"dorothea_hs"</span>, package = <span>"dorothea"</span>))<br><br><span>## We obtain the regulons based on interactions with confidence level A, B and C</span><br>regulon &lt;- dorothea_regulon_human %&gt;%<br>    dplyr::filter(confidence %<span>in</span>% c(<span>"A"</span>,<span>"B"</span>,<span>"C"</span>))<br><br>sce &lt;- run_viper(sce, regulon,<br>                  options = list(method = <span>"scale"</span>, minsize = <span>4</span>, <br>                                 eset.filter = <span>FALSE</span>, cores = <span>1</span>,  <br>                                 verbose = <span>FALSE</span>))<br></code></pre><p data-tool="mdnice编辑器">关于这个R包，DoRothEA  on http://bioconductor.org/  and https://github.com/saezlab/dorothea. 有详细的文档介绍如何选择TF activity per cell population，根据 previously computed <strong>VIPER</strong> scores on <strong>DoRothEA’s</strong> regulons.</p><p data-tool="mdnice编辑器">这个函数   run_viper 其实修改了我们的seurat对象，使它增加了一个 assay属性。查看如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; Assays(sce)<br>[1] <span>"RNA"</span>      <span>"dorothea"</span><br>&gt; sce@assays<span>$dorothea</span>@data[1:4,1:4]<br>       AAACATACAACCAC AAACATTGAGCTAC AAACATTGATCAGC AAACCGTGCTTCCG<br>AHR         0.7001660      -1.439884      0.7897333       0.919263<br>AR         -2.0755431      -2.865013     -1.5363144      -1.177092<br>ARID2      -3.4504242      -4.014060     -3.2745958      -3.097172<br>ARID3A     -0.7943249      -3.643424     -1.4438534      -3.931423<br>&gt; dim(sce@assays<span>$dorothea</span>@data)<br>[1]  266 2638<br></code></pre><p data-tool="mdnice编辑器">可以看到，这个pbmc3k数据集里面的约 三千个细胞都有自己的266个转录因子的活性得分。</p><h3 data-tool="mdnice编辑器"><span></span>试试看FindAllMarkers函数获取各个单细胞亚群特异性的转录因子<span></span></h3><p data-tool="mdnice编辑器">代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><br>DefaultAssay(object = sce) &lt;- <span>"dorothea"</span><br>table(Idents(sce))<br><br><span>library</span>(future)<br><span># check the current active plan</span><br>plan()<br>plan(<span>"multiprocess"</span>, workers = <span>4</span>)<br>plan()<br><br>sce.markers &lt;- FindAllMarkers(object = sce, <br>                              only.pos = <span>TRUE</span>, <br>                              min.pct = <span>0.25</span>, <br>                              thresh.use = <span>0.25</span>)<br>DT::datatable(sce.markers)<br>pro=<span>'dorothea-markers-for-pbmc3k'</span><br>write.csv(sce.markers,file=paste0(pro,<span>'_sce.markers.csv'</span>))<br>save(sce.markers,file = paste0(pro, <span>'_sce.markers.Rdata'</span>))<br></code></pre><p data-tool="mdnice编辑器">虽然这个pbmc3k数据集里面只有约 三千个细胞，我们为了加快速度，还是使用了4个线程，大概40秒就可以出结果，</p><p data-tool="mdnice编辑器">然后尝试热图可视化：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(dplyr) <br>sce.markers$fc = sce.markers$pct.1 - sce.markers$pct.2<br>top10 &lt;- sce.markers %&gt;% group_by(cluster) %&gt;% top_n(<span>10</span>, fc)<br>sce@assays$dorothea@data[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>top10 =top10[top10$fc &gt; <span>0.5</span>,] <br>sce &lt;- ScaleData(sce )<br><br>sce@assays$dorothea@scale.data[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>DoHeatmap(sce,top10$gene,size=<span>3</span>,slot = <span>'scale.data'</span>)<br></code></pre><p data-tool="mdnice编辑器">看起来还不错，确实绝大部分的转录因子都是在不同单细胞亚群里面的特异性比较好：</p><p><img data-galleryid="" data-ratio="0.5441547518923465" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxE1PJoVVLrcuUvuibU1SXpatuibh9fr5bD8sZWQdWCV00Mdv7iccibCOcj23lzSGannYHibghWUypcyIQ/640?wx_fmt=png" data-type="png" data-w="2378" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxE1PJoVVLrcuUvuibU1SXpatuibh9fr5bD8sZWQdWCV00Mdv7iccibCOcj23lzSGannYHibghWUypcyIQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>特异性比较好</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>然后看看包官方教程<span></span></h3><p data-tool="mdnice编辑器">这个R包，DoRothEA  on http://bioconductor.org/  and https://github.com/saezlab/dorothea. 有详细的文档介绍如何选择TF activity per cell population，根据 previously computed <strong>VIPER</strong> scores on <strong>DoRothEA’s</strong> regulons.</p><p data-tool="mdnice编辑器">首先也是获取Viper得分矩阵 ，根据不同细胞亚群进行归纳汇总 ：</p><pre data-tool="mdnice编辑器"><span></span><code><span>## We transform Viper scores, scaled by seurat, into a data frame to better </span><br><span>## handling the results</span><br>viper_scores_df &lt;- GetAssayData(sce, slot = <span>"scale.data"</span>, <br>                                assay = <span>"dorothea"</span>) %&gt;%<br>  data.frame(check.names = <span>F</span>) %&gt;%<br>  t()<br>viper_scores_df[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br><br><span>## We create a data frame containing the cells and their clusters</span><br>CellsClusters &lt;- data.frame(cell = names(Idents(sce)), <br>                            cell_type = as.character(Idents(sce)),<br>                            check.names = <span>F</span>)<br>head(CellsClusters)<br><br><span>## We create a data frame with the Viper score per cell and its clusters</span><br>viper_scores_clusters &lt;- viper_scores_df  %&gt;%<br>  data.frame() %&gt;% <br>  rownames_to_column(<span>"cell"</span>) %&gt;%<br>  gather(tf, activity, -cell) %&gt;%<br>  inner_join(CellsClusters)<br><br><span>## We summarize the Viper scores by cellpopulation</span><br>summarized_viper_scores &lt;- viper_scores_clusters %&gt;% <br>  group_by(tf, cell_type) %&gt;%<br>  summarise(avg = mean(activity),<br>            std = sd(activity))<br><span># For visualization purposes, we select the 20 most variable TFs across clusters according to our scores.</span><br>head(summarized_viper_scores)<br><br><span>## We select the 20 most variable TFs. (20*9 populations = 180)</span><br>highly_variable_tfs &lt;- summarized_viper_scores %&gt;%<br>  group_by(tf) %&gt;%<br>  mutate(var = var(avg))  %&gt;%<br>  ungroup() %&gt;%<br>  top_n(<span>180</span>, var) %&gt;%<br>  distinct(tf)<br>highly_variable_tfs<br><br><span>## We prepare the data for the plot</span><br>summarized_viper_scores_df &lt;- summarized_viper_scores %&gt;%<br>  semi_join(highly_variable_tfs, by = <span>"tf"</span>) %&gt;%<br>  dplyr::select(-std) %&gt;%   <br>  spread(tf, avg) %&gt;%<br>  data.frame(row.names = <span>1</span>, check.names = <span>FALSE</span>) <br>palette_length = <span>100</span><br>my_color = colorRampPalette(c(<span>"Darkblue"</span>, <span>"white"</span>,<span>"red"</span>))(palette_length)<br>colnames(summarized_viper_scores_df)<br><br></code></pre><p data-tool="mdnice编辑器">整理好的数据如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; summarized_viper_scores_df[1:4,1:4]<br>                 EPAS1       FOSL1      FOSL2       GATA1<br>B           0.08468826 -0.08464098 -0.1715292 -0.06634766<br>CD14+ Mono  0.15636053  0.65938400  0.7189514  0.43845099<br>CD8 T       0.12689359 -0.19252488 -0.2669776 -0.20250346<br>DC         -0.44678908 -0.12504099 -0.2844289 -0.18479202<br></code></pre><p data-tool="mdnice编辑器">是精心挑选了20个转录因子，它们在9个不同的单细胞亚群里面的变化最大，这样就可以挑选得到各个单细胞亚群特异性的转录因子并且进行后续可视化。</p><p data-tool="mdnice编辑器">有了数据，就很容易可视化：</p><pre data-tool="mdnice编辑器"><span></span><code><br>my_breaks &lt;- c(seq(min(summarized_viper_scores_df), <span>0</span>, <br>                   length.out=ceiling(palette_length/<span>2</span>) + <span>1</span>),<br>               seq(max(summarized_viper_scores_df)/palette_length, <br>                   max(summarized_viper_scores_df), <br>                   length.out=floor(palette_length/<span>2</span>)))<br><span>library</span>(pheatmap)<br>viper_hmap &lt;- pheatmap(t(summarized_viper_scores_df),fontsize=<span>14</span>, <br>                       fontsize_row = <span>10</span>, <br>                       color=my_color, breaks = my_breaks, <br>                       main = <span>"DoRothEA (ABC)"</span>, angle_col = <span>45</span>,<br>                       treeheight_col = <span>0</span>,  border_color = <span>NA</span>) <br></code></pre><p data-tool="mdnice编辑器">可以看到， 官方文档就是选择了最朴实无华的 pheatmap ，效果如下所示：</p><p><img data-galleryid="" data-ratio="0.5047619047619047" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxE1PJoVVLrcuUvuibU1SXpakv2unElmJsFpTvDd1FlibJBK4n9DbuGGwVkMrich2D48uuYr4YuCN3ibA/640?wx_fmt=png" data-type="png" data-w="1680" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxE1PJoVVLrcuUvuibU1SXpakv2unElmJsFpTvDd1FlibJBK4n9DbuGGwVkMrich2D48uuYr4YuCN3ibA/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>各个单细胞亚群特异性的转录因子热图</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>写在文末<span></span></h3><p data-tool="mdnice编辑器">我在《生信技能树》，《生信菜鸟团》，《单细胞天地》的大量推文教程里面共享的代码都是复制粘贴即可使用的， 有任何疑问欢迎留言讨论，也可以发邮件给我，详细描述你遇到的困难的前因后果给我，我的邮箱地址是 jmzeng1314@163.com</p><p data-tool="mdnice编辑器">如果你确实觉得我的教程对你的科研课题有帮助，让你茅塞顿开，或者说你的课题大量使用我的技能，烦请日后在发表自己的成果的时候，加上一个简短的致谢，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>We thank Dr.Jianming Zeng(University of Macau), and all the members of his bioinformatics team, biotrainee, <span>for</span> generously sharing their experience and codes.<br></code></pre><p data-tool="mdnice编辑器">十年后我环游世界各地的高校以及科研院所（当然包括中国大陆）的时候，如果有这样的情谊，我会优先见你。</p></section><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/w0lUALxJMEoHwSximV4e0g",target="_blank" rel="noopener noreferrer">原文链接</a>
