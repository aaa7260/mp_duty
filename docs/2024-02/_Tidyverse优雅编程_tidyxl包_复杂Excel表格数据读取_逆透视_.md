---
title: "【Tidyverse优雅编程】tidyxl包：复杂Excel表格数据读取（逆透视）"
date: 2024-02-17T10:32:38Z
draft: ["false"]
tags: [
  "fetched",
  "R语言与数学建模"
]
categories: ["Acdemic"]
---
【Tidyverse优雅编程】tidyxl包：复杂Excel表格数据读取（逆透视） by R语言与数学建模
------
<div><p data-first-child="" data-pid="Rrt1Q0EN"><span>问题来自：</span>https://zhuanlan.zhihu.com/p/682395897</p><p data-pid="o7236lue">如何将左侧的表格整理为右侧的表？</p><figure data-size="normal"><img data-imgfileid="100002328" data-ratio="0.6046296296296296" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVkCam8DHhMicCEJN6PS36IIicwGcfQI8R8HN7RUvYwkiccs662YkvhR9Yw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" height="653" width="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVkCam8DHhMicCEJN6PS36IIicwGcfQI8R8HN7RUvYwkiccs662YkvhR9Yw/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="mjz2DHTW">这是复杂 <code>Excel</code> 表格（透视表）读取问题，读取简单表格的<code>readxl</code> 包就无能为力了。好在 <code>R</code> 还有 <code>tidyxl</code> 包，专为读取复杂 <code>Excel</code> 表格而生的！这个包有专门一本书在讲（可以浏览一下最后一章的 7 个真实案例，<span>绝对大开眼界</span>）：</p><p>https://nacnudus.github.io/spreadsheet-munging-strategies/index.html</p><p data-pid="4QHLZs4t">对于本问题，只能算牛刀小试！</p><p data-pid="c4cQwyOH">该透视表只读取，并不是右表的样子，那还需要一步分组汇总。下面逐步来解决。</p><hr><p data-pid="2S_tTvGc"><code>tidyxl</code> 包比较难学，它解决复杂 Excel 表格读取的基本逻辑是：</p><ul><li><p>将复杂 Excel 表格彻底打碎了读取进来：无论是表头、值、格式、公式所有信息统统都包括，并记录好行列位置；</p></li><li><p>确定哪些单元格是表头哪些是数据，充分利用各种信息：<span>筛选+剥出/嵌入标题行+变形</span>，得到想要的结果。</p></li></ul><p data-pid="uGh8OtJ7">先加载包：</p><pre><code>library(tidyverse)<br>library(readxl)<br>library(tidyxl)<br>library(unpivotr)<br>library(smungs)  <span>#</span> 只能从github安装: https:<span>//</span>github.com<span>/</span>nacnudus<span>/</span>smungs</code></pre><p data-pid="09Y-2R5y">本数据存放在<code>借贷数据.xlsx</code> 的<code>Sheet1</code>。</p><h2 data-into-catalog-status="">1 读取复杂 Excel 表格</h2><h3 data-into-catalog-status="">1.1 全信息表</h3><p data-pid="p2kwKjck">用 <code>xlsx_cells()</code> 将 Excel 表的全部单元格内容都读入到 R：</p><pre><code>cells <span>=</span> xlsx_cells(<span>"借贷数据.xlsx"</span>, sheets <span>=</span> <span>"Sheet1"</span>)<br>glimpse(cells)</code></pre><figure data-size="normal"><img data-imgfileid="100002329" data-ratio="0.5527777777777778" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVS0g30LQoYCM8fGTfyZmibWr8cg3Aia1e1VZBMQkh6uOibyLZH5ofpeTDw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" height="744" width="1345" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVS0g30LQoYCM8fGTfyZmibWr8cg3Aia1e1VZBMQkh6uOibyLZH5ofpeTDw/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="8jQWr19G">本来是一个<span> 29 行 × 4 列 </span>的小数据表（<span>形式上是宽表</span>），读取进来变成了一个 <span>116 行 × 24 列 </span>的大数据框（<span>形式上是长表</span>）！你想要的所有信息都在里面，其中</p><p data-pid="scII-DMo">原表的数据：日期值、数值、字符值，分别在 <code>date, numeric, character</code> 列。</p><p data-pid="EKvc_9bI">若要查看适合人类阅读的表格样式：</p><pre><code>rectify(cells)</code></pre><figure data-size="normal"><img data-imgfileid="100002326" data-ratio="0.64" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVeoJ2bAXL5T10kY1ichKjnALGFO86CZsLy6zdRH3072oGPkS6C9TKIOw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="675" height="432" width="675" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVeoJ2bAXL5T10kY1ichKjnALGFO86CZsLy6zdRH3072oGPkS6C9TKIOw/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="VPlbSeIt">观察对应的原数据表：</p><figure data-size="normal"><img data-imgfileid="100002327" data-ratio="1.8318385650224216" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVSX4S8eHJ8hBwZH68XNGru21attqrNwRoaH0phvByOa7fj5WCP0l0Nw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="446" height="817" width="446" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVSX4S8eHJ8hBwZH68XNGru21attqrNwRoaH0phvByOa7fj5WCP0l0Nw/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="I6-N3709">解决问题的大体逻辑是：</p><p data-pid="yqgbtHZz">(1) 特殊行客户A-G：需要根据格式特点（灰色填充）单独提取出来，再嵌入回主体表；</p><p data-pid="VfSv7eur">(2) 主体表：标题行 + 数据，需要提取出来，有专门的标题行处理，再类似长变宽还原到原表。</p><h3 data-into-catalog-status="">1.2 处理特殊行</h3><p data-pid="vVrNKRiX">涉及格式（灰色填充），获取并提取格式：</p><pre><code>formats <span>=</span> xlsx_formats(<span>"借贷数据.xlsx"</span>)<br>formats<span>$</span>local<span>$</span>fill<span>$</span>patternFill<span>$</span>fgColor<span>$</span>rgb       <span>#</span> 查看背景填充色</code></pre><figure data-size="normal"><img data-imgfileid="100002325" data-ratio="0.024074074074074074" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVBPIEF023fpAq3Z6kMBKnwyWiaHAFJNKFSRuQ59Y6PzIk1yOhSC8NibYQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" height="32" width="1323" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVBPIEF023fpAq3Z6kMBKnwyWiaHAFJNKFSRuQ59Y6PzIk1yOhSC8NibYQ/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="NfAUwR4t">从全信息表根据背景填充信息筛选出想要的数据：</p><pre><code>customer <span>=</span> cells <span>%</span><span>&gt;</span><span>%</span><br>  filter(row <span>&gt;=</span> <span>2</span>, col <span>==</span> <span>1</span>, <span>!</span>is_blank,<br>         <span>!</span><span>is</span>.na(formats<span>$</span>local<span>$</span>fill<span>$</span>patternFill<span>$</span>fgColor<span>$</span>rgb<span>[</span>local_format_id<span>]</span>)) <span>%</span><span>&gt;</span><span>%</span><br>  <span>select</span>(row, col, 客户 <span>=</span> <span>character</span>)<br>customer</code></pre><figure data-size="normal"><img data-imgfileid="100002330" data-ratio="0.9145907473309609" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsViafN3S8LghWib8nY2fDfcBic0kcdPiapCDNHib7ic8LPLeoDleHNjoQTwj8g/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="281" height="257" width="281" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsViafN3S8LghWib8nY2fDfcBic0kcdPiapCDNHib7ic8LPLeoDleHNjoQTwj8g/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="i2bhYgWc">因为要嵌入回主体表，表示原始位置的 <code>row</code> 和 <code>col</code> 信息是需要的。</p><h3 data-into-catalog-status="">1.3 处理主体表</h3><p data-pid="8rQMZaSg">复杂 Excel 表格往往<span>上方</span>和<span>左侧</span>都是标题行，甚至不止一行（列），所以，<code>tidyxl</code> 是将左、上当标题行处理的，也就是本例数据：<span>列名是上标题行，日期列是左标题列，主体数据是其余中间部分</span>。</p><p data-pid="Gh1GoX7g">处理主体表的基本逻辑是：</p><ul><li><p>从全信息表筛选出包含标题行、标题列、主体数据的内容；</p></li><li><p>用 <code>behead()</code><span>往上</span>、<span>往左</span>（复杂表还可能<span>往左上</span>等）生成标题行、标题列。</p></li></ul><p data-pid="-5wne7Ok">本例数据，只有一个上标题行，一个左标题列，所以：</p><pre><code>Table <span>=</span> cells <span>%</span><span>&gt;</span><span>%</span><br>  filter(<span>!</span>is_blank) <span>%</span><span>&gt;</span><span>%</span><br>  behead(<span>"up"</span>, <span>"header"</span>) <span>%</span><span>&gt;</span><span>%</span>     <span>#</span> 往<span>"上"</span>推进一层<br>  behead(<span>"left"</span>, <span>"日期"</span>)         <span>#</span> 往<span>"左"</span>推进一层</code></pre><p data-pid="k2O1w6bT">此时的 <code>Table</code> 是全信息表的样式，没有可读性，如果想看一看适合人类阅读的表格样式：</p><pre><code>rectify(Table)</code></pre><figure data-size="normal"><img data-imgfileid="100002332" data-ratio="0.7123966942148761" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVmhQsgbAPuQohOjNOVCxdcZ5bwMTJPxppAK16u8eqquYkqetuqQqRPw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="605" height="431" width="605" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVmhQsgbAPuQohOjNOVCxdcZ5bwMTJPxppAK16u8eqquYkqetuqQqRPw/640?wx_fmt=other&amp;from=appmsg"></figure><h3 data-into-catalog-status="">1.4 嵌入特殊行</h3><p data-pid="BNUmna2J">用 <code>enhead()</code> 将前面处理好的 <code>customer</code> （是原表的<span>左上标题行</span>）嵌入回主体表：</p><pre><code>Table <span>=</span> Table <span>%</span><span>&gt;</span><span>%</span><br>  enhead(customer, <span>"up-left"</span>)</code></pre><h3 data-into-catalog-status="">1.5 变形到结果表</h3><p data-pid="lfzGvSP8">选择相关的列：前面创建的列、数据列<code>numeric, character</code>，以及变形需要的<code>row, data_type</code> 。</p><p data-pid="ZNH8diO4"><code>spatter()</code>的效果类似 <code>pivot_wider()</code>，做一种更智能的长变宽：</p><pre><code>Table <span>=</span> Table <span>%</span><span>&gt;</span><span>%</span><br>  <span>select</span>(row, data_type, 客户, 日期, header, numeric, <span>character</span>) <span>%</span><span>&gt;</span><span>%</span><br>  spatter(header) <span>%</span><span>&gt;</span><span>%</span><br>  <span>select</span>(<span>-</span>row)<br>Table</code></pre><figure data-size="normal"><img data-imgfileid="100002331" data-ratio="0.7195325542570952" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVfFbquQWrOhajlkKJ3ARCBtAXfvAeaZMicLDoM7k9KEApVkZ3YOhwkrQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="599" height="431" width="599" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVfFbquQWrOhajlkKJ3ARCBtAXfvAeaZMicLDoM7k9KEApVkZ3YOhwkrQ/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="1YzNaH_v">至此，原数据表已成功读取到 <code>R</code> 中，很容易看出其与原表的正确对应关系。</p><p data-pid="EV5r_h5K">忽略中间过程，借助管道完整代码如下：</p><pre><code>library(tidyverse)<br>library(readxl)<br>library(tidyxl)<br>library(unpivotr)<br>library(smungs)      <span>#</span> 只能从github安装: https:<span>//</span>github.com<span>/</span>nacnudus<span>/</span>smungs<br>cells <span>=</span> xlsx_cells(<span>"exercise/借贷数据.xlsx"</span>, sheets <span>=</span> <span>"Sheet1"</span>)<br>formats <span>=</span> xlsx_formats(<span>"exercise/借贷数据.xlsx"</span>)<br>customer <span>=</span> cells <span>%</span><span>&gt;</span><span>%</span><br>  filter(row <span>&gt;=</span> <span>2</span>, col <span>==</span> <span>1</span>, <span>!</span>is_blank,<br>         <span>!</span><span>is</span>.na(formats<span>$</span>local<span>$</span>fill<span>$</span>patternFill<span>$</span>fgColor<span>$</span>rgb<span>[</span>local_format_id<span>]</span>)) <span>%</span><span>&gt;</span><span>%</span><br>  <span>select</span>(row, col, 客户 <span>=</span> <span>character</span>)<br>Table <span>=</span> cells <span>%</span><span>&gt;</span><span>%</span><br>  filter(<span>!</span>is_blank) <span>%</span><span>&gt;</span><span>%</span><br>  behead(<span>"up"</span>, <span>"header"</span>) <span>%</span><span>&gt;</span><span>%</span><br>  behead(<span>"left"</span>, <span>"日期"</span>) <span>%</span><span>&gt;</span><span>%</span><br>  enhead(customer, <span>"up-left"</span>) <span>%</span><span>&gt;</span><span>%</span><br>  <span>select</span>(row, data_type, 客户, 日期, header, numeric, <span>character</span>) <span>%</span><span>&gt;</span><span>%</span><br>  spatter(header) <span>%</span><span>&gt;</span><span>%</span><br>  <span>select</span>(<span>-</span>row)</code></pre><p data-pid="kYBGPQhU"><span>注：</span>看起来稍显麻烦，但是越复杂的表格，该解决思路的优势越明显。</p><h2 data-into-catalog-status="">2 数据进一步汇总（压缩行）</h2><p data-pid="-6xa_M_h">观察上述结果表，同一条记录，因为借方、贷方交错，分成了两行，完全可以压缩成一行。</p><p data-pid="Qk0Xavx0">从数据思维的角度来看，这是一个分组汇总（忽略<code>NA</code>），但是如果直接用 <code>na.omit()</code> ，像客户 B 那一行数据会被压缩没了，所以，封装一个小函数：</p><pre><code><span>#</span> 若全是NA, 让结果保留一个NA<br>bindNA <span>=</span> <span>function</span>(<span>x</span>) ifelse(<span>all</span>(<span>is</span>.na(x)), NA, na.omit(x))</code></pre><p data-pid="CPfEXlA_">分组汇总：</p><pre><code>Table <span>%</span><span>&gt;</span><span>%</span><br>  group_by(客户, 日期, 凭证字号) <span>%</span><span>&gt;</span><span>%</span><br>  reframe(across(c(贷方, 借方), bindNA))</code></pre><figure data-size="normal"><img data-imgfileid="100002333" data-ratio="0.7337883959044369" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVBYgrz9JrBZbZkbkicbrNr98pzf2KkgME7qB22M15lUWEWW0QN28SDBQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="586" height="430" width="586" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWBBMfnDEOyuklCKjQcmvPsVBYgrz9JrBZbZkbkicbrNr98pzf2KkgME7qB22M15lUWEWW0QN28SDBQ/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="YDs2VJdj">至此，彻底大功告成！</p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/sWVH6DdmlEz_8Ct3Q7Np-g",target="_blank" rel="noopener noreferrer">原文链接</a>
