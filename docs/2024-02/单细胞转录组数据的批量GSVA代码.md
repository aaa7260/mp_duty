---
title: "单细胞转录组数据的批量GSVA代码"
date: 2024-02-29T09:32:45Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
单细胞转录组数据的批量GSVA代码 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>我在：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247498130&amp;idx=1&amp;sn=3a42c01a8eb62a5a9f2a1a08f6896fb2&amp;scene=21#wechat_redirect" data-linktype="2">借鉴escape包的一些可视化GSVA或者ssGSEA结果矩阵的方法</a> 这个教程里面剧透过， <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247498040&amp;idx=1&amp;sn=3a39699ab10fb71b966adb5e7e640270&amp;scene=21#wechat_redirect" data-linktype="2">对单细胞表达矩阵做gsea分析</a>的代码实现环节大同小异。最重要的反而是如何筛选特定的通路去进行展示，有点类似于做完了转录因子分析后的：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247510987&amp;idx=1&amp;sn=3c5268c42e4dafd4cd1fb4ae31158925&amp;scene=21#wechat_redirect" data-linktype="2">各个单细胞亚群特异性的转录因子热图</a>，同样的道理我们对单细胞转录组数据的批量GSVA分析很容易，但是对它们进行各个单细胞亚群特异性的富集通路的热图展现才是考验功底。</p></blockquote><p data-tool="mdnice编辑器">而且，单细胞转录组数据的批量GSVA分析并且进行各个单细胞亚群特异性的富集通路的热图展现，以及是各个单细胞亚群的标准3大分析了，跟转录因子分析，拟时序分析并列。</p><h3 data-tool="mdnice编辑器"><span></span>仍然是以大家熟知的pbmc3k数据集为例<span></span></h3><p data-tool="mdnice编辑器">大家先安装这个数据集对应的包，并且对它进行降维聚类分群，参考前面的例子：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497956&amp;idx=1&amp;sn=5d4deb7cf7b7848b3e2273cbd663bb6a&amp;scene=21#wechat_redirect" data-linktype="2">人人都能学会的单细胞聚类分群注释</a>  ，而且每个亚群找高表达量基因，都存储为Rdata文件。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 0.安装R包 ----</span><br><span># devtools::install_github('caleblareau/BuenColors')</span><br><span># utils::install.packages(pkgs = "ggstatsplot")</span><br><span># InstallData("pbmc3k") </span><br><br><span>library</span>(SeuratData) <span>#加载seurat数据集  </span><br>getOption(<span>'timeout'</span>)<br>options(timeout=<span>10000</span>)<br><span>#InstallData("pbmc3k")  </span><br>data(<span>"pbmc3k"</span>)  <br>sce &lt;- pbmc3k.final   <br><span>library</span>(Seurat)<br>table(Idents(sce))<br>p1=DimPlot(sce,label = <span>T</span>)<br><br></code></pre><p data-tool="mdnice编辑器">因为这个数据集已经进行了不同单细胞亚群的标记，我们接下来可以简单的对各个单细胞亚群取表达量矩阵。借助于seurat的AverageExpression函数，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>sce<span>$celltype</span> = Idents(sce)<br>av &lt;-AverageExpression(sce ,<br>                       group.by = <span>"celltype"</span>,<br>                       assays = <span>"RNA"</span>) <br>av=av[[1]]<br>head(av)<br>write.csv(av,file = <span>'AverageExpression-0.8.csv'</span>)<br>cg=names(tail(sort(apply(av, 1, sd)),1000))<br>pheatmap::pheatmap(cor(av[cg,]))<br>pheatmap::pheatmap(cor(av[cg,]),<br>                   file = <span>'AverageExpression-0.8.pdf'</span>)<br>dev.off()<br><br></code></pre><p data-tool="mdnice编辑器">可以看到不同单细胞亚群的全局表达量相关性是符合我们的生物学常识的：</p><p><img data-galleryid="" data-ratio="0.548440065681445" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkAC1Wk8pnAZ8jtRKpgPjWf6orH3rdv6NbNvGfPPYXu7oKavfsWS1JicPIWj40KYwlUwwVdicmSCRg/640?wx_fmt=png" data-type="png" data-w="1218" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkAC1Wk8pnAZ8jtRKpgPjWf6orH3rdv6NbNvGfPPYXu7oKavfsWS1JicPIWj40KYwlUwwVdicmSCRg/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>单细胞亚群的全局表达量相关性</figcaption></figure><p data-tool="mdnice编辑器">就是不知道为什么这个B单细胞混在了各种T细胞里面，可能是因为它们都是淋巴细胞吧。</p><h3 data-tool="mdnice编辑器"><span></span>接下来进行gsva分析<span></span></h3><p data-tool="mdnice编辑器">因为去broad官网下载msigdb数据库文件很麻烦，MSigDB（Molecular Signatures Database）数据库中定义了已知的基因集合：http://software.broadinstitute.org/gsea/msigdb  需要注册才能下载。但是 msigdbr 包，它内置了MSigDB（Molecular Signatures Database）数据库的全部基因集合。安装方法非常简单：</p><pre data-tool="mdnice编辑器"><span></span><code>install.packages(<span>"msigdbr"</span>)<br></code></pre><p data-tool="mdnice编辑器">包括H和C1-C7八个系列（Collection），每个系列分别是：</p><ul data-tool="mdnice编辑器"><li><section>H: hallmark gene sets （癌症）特征基因集合，共50组，最常用；</section></li><li><section>C1: positional gene sets 位置基因集合，根据染色体位置，共326个，用的很少；</section></li><li><section>C2: curated gene sets：（专家）校验基因集合，基于通路、文献等：</section></li><li><section>C3: motif gene sets：模式基因集合，主要包括microRNA和转录因子靶基因两部分</section></li><li><section>C4: computational gene sets：计算基因集合，通过挖掘癌症相关芯片数据定义的基因集合；</section></li><li><section>C5: GO gene sets：Gene Ontology 基因本体论，包括BP（生物学过程biological process，细胞原件cellular component和分子功能molecular function三部分）</section></li><li><section>C6: oncogenic signatures：癌症特征基因集合，大部分来源于NCBI GEO  发表芯片数据</section></li><li><section>C7: immunologic signatures: 免疫相关基因集合。</section></li></ul><p data-tool="mdnice编辑器">因为我们这里针对的是大家熟知的pbmc3k数据集，所以这里选择C7: immunologic signatures: 免疫相关基因集合。如果你是肿瘤相关数据，建议选择H: hallmark gene sets （癌症）特征基因集合，共50组，最常用。</p><p data-tool="mdnice编辑器">代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(msigdbr)<br>all_gene_sets = msigdbr(species = <span>"Homo sapiens"</span>,<br>                        category=<span>'C7'</span>)<br>length(unique(table(all_gene_sets$gs_name)))<br>tail(table(all_gene_sets$gs_name))<br><br></code></pre><p data-tool="mdnice编辑器">可以看到总共是300个基因集：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; tail(sort(table(all_gene_sets<span>$gs_name</span>)))<br><br>                                    ZAK_PBMC_MRKAD5_HIV_1_GAG_POL_NEF_AGE_20_50YO_1DY_UP <br>                                                                                    1280 <br>                           NAKAYA_PLASMACYTOID_DENDRITIC_CELL_FLUMIST_AGE_18_50YO_7DY_UP <br>                                                                                    1332 <br>HARALAMBIEVA_PBMC_FLUARIX_AGE_50_74YO_CORR_WITH_28D_MEM_B_CELL_RESPONSE_AT_28DY_POSITIVE <br>                                                                                    1389 <br>                                                  NAKAYA_PBMC_FLUMIST_AGE_18_50YO_7DY_UP <br>                                                                                    1705 <br>                            OSMAN_BLOOD_CHAD63_KH_AGE_18_50YO_HIGH_DOSE_SUBJECTS_24HR_DN <br>                                                                                    2040 <br>                            OSMAN_BLOOD_CHAD63_KH_AGE_18_50YO_HIGH_DOSE_SUBJECTS_24HR_UP <br>                                                                                    2354 <br></code></pre><p data-tool="mdnice编辑器">而且这些基因集合的名字都好长啊！！！</p><p data-tool="mdnice编辑器">使用这个基因集对前面的矩阵进行gsva，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><br><span>library</span>(gplots)<br><span>library</span>(ggplot2) <br><span>library</span>(clusterProfiler)<br><span>library</span>(org.Hs.eg.db)<br><span>library</span>(GSVA) <span># BiocManager::install('GSVA')</span><br><span>library</span>(GSEABase)<br>gs=split(all_gene_sets$gene_symbol,all_gene_sets$gs_name)<br>gs = lapply(gs, unique)<br>gsc &lt;- GeneSetCollection(mapply(<span>function</span>(geneIds, keggId) {<br>  GeneSet(geneIds, geneIdType=EntrezIdentifier(),<br>          collectionType=KEGGCollection(keggId),<br>          setName=keggId)<br>}, gs, names(gs)))<br>gsc<br>geneset &lt;- gsc<br>X= av <br>es.max &lt;- gsva(X, geneset, <br>               mx.diff=<span>FALSE</span>, verbose=<span>FALSE</span>, <br>               parallel.sz=<span>8</span>)<br><span>library</span>(pheatmap)<br>pheatmap(es.max)<br><br></code></pre><p data-tool="mdnice编辑器">可以看到， 这300个通路，在9种不同的单细胞亚群的富集情况是有差异的，如下所示：</p><p><img data-galleryid="" data-ratio="1.1658291457286432" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkAC1Wk8pnAZ8jtRKpgPjWQo2g2l20SWRIKlPaNboz03ThroYFaz22c7wYlJhMPiaJp4GegFYiahsA/640?wx_fmt=png" data-type="png" data-w="796" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkAC1Wk8pnAZ8jtRKpgPjWQo2g2l20SWRIKlPaNboz03ThroYFaz22c7wYlJhMPiaJp4GegFYiahsA/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>9种不同的单细胞亚群的富集情况是有差异的</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>接下来需要挑选单细胞亚群特异性富集的通路<span></span></h4><p data-tool="mdnice编辑器">有很多方法，比如借鉴做完了转录因子分析后的：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247510987&amp;idx=1&amp;sn=3c5268c42e4dafd4cd1fb4ae31158925&amp;scene=21#wechat_redirect" data-linktype="2">各个单细胞亚群特异性的转录因子热图</a>。</p><p data-tool="mdnice编辑器">我首先进行了 普通的sd筛选，发现并不是各个单细胞亚群特异性，而是淋巴细胞和髓系的大类特异性，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>load(<span>'es.max.Rdata'</span>)<br>cg = names(tail(sort(apply(es.max, <span>1</span>, sd) ),<span>10</span>))<br>pheatmap(es.max[cg,])<br>pheatmap(es.max[cg,],show_rownames = <span>F</span>)<br><br></code></pre><p><img data-galleryid="" data-ratio="1.1725888324873097" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkAC1Wk8pnAZ8jtRKpgPjWy4THibU4g2RDNHHchbFAp50kYtmoooJicbSv0hdjWlOcDTE10Jry297g/640?wx_fmt=png" data-type="png" data-w="788" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkAC1Wk8pnAZ8jtRKpgPjWy4THibU4g2RDNHHchbFAp50kYtmoooJicbSv0hdjWlOcDTE10Jry297g/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>淋巴细胞和髓系的大类特异性</figcaption></figure><p data-tool="mdnice编辑器">然后，我做了一个巧妙的计算，挑选了每个单细胞亚群特异性的top 5 的基因集，效果如下所示：</p><p><img data-galleryid="" data-ratio="1.3980099502487562" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkAC1Wk8pnAZ8jtRKpgPjW098Z0K0zPtzfNfZQIc5xo5PcvoIs35R82UoRBLDFQL6FNkz0KSg2Tg/640?wx_fmt=png" data-type="png" data-w="804" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzkAC1Wk8pnAZ8jtRKpgPjW098Z0K0zPtzfNfZQIc5xo5PcvoIs35R82UoRBLDFQL6FNkz0KSg2Tg/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">可以看到，基本上每个单细胞亚群，都或多或少有一些特异性的免疫通路激活哦。如果你感兴趣我的巧妙变换，欢迎付费一块钱获取我的代码。</p><p data-tool="mdnice编辑器">代码如下所示：</p><p><mp-pay-preview-filter></mp-pay-preview-filter></p></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/AQ8Aq_EmKLqX9dlTFsbJrg",target="_blank" rel="noopener noreferrer">原文链接</a>
