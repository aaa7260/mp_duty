---
title: "R语言画图 | ggplot2绘制热图及个性化修饰"
date: 2024-02-01T09:37:47Z
draft: ["false"]
tags: [
  "fetched",
  "被炸熟的虾"
]
categories: ["Acdemic"]
---
R语言画图 | ggplot2绘制热图及个性化修饰 by 被炸熟的虾
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p><span>R语言中，</span><code><span>pheatmap</span></code><span>是最常用的绘制热图R包，但是拓展性不强，</span><code><span>ComplexHeatmap</span></code><span>又过于复杂。考虑到兼容问题与拼图，很多时候</span><code><span>ggplot2</span></code><span>也是一个很不错的选择。</span></p><h2 data-tool="mdnice编辑器"><span></span><span>1、数据准备</span><span></span><span> </span></h2><section><span>生成随机数据并转换成</span><code><span>ggplot2</span></code><span>需要的长格式：</span></section><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls()) <br>set.seed(<span>12345</span>)<br>Data &lt;- data.frame(matrix(rnorm(<span>200</span>), <span>20</span>, <span>10</span>))<br><span>##为了美观，这里修改了极值</span><br>Data[Data &gt; <span>2</span>] &lt;- <span>2</span><br>Data[Data &lt; -<span>2</span>] &lt;- -<span>2</span><br>colnames(Data) = paste(<span>"Data"</span>, <span>1</span>:<span>10</span>, sep = <span>""</span>)<br>Data$Gene &lt;- paste(<span>"Gene"</span>, <span>1</span>:<span>20</span>, sep = <span>""</span>)<br><br><span>library</span>(tidyverse)<br>dft &lt;- Data %&gt;% pivot_longer(-Gene)<br>dft$name &lt;- factor(dft$name,levels = paste(<span>"Data"</span>, <span>1</span>:<span>10</span>, sep = <span>""</span>))<br>head(dft)<br><span># A tibble: 6 x 3</span><br><span>#  Gene  name  value</span><br><span>#  &lt;chr&gt; &lt;fct&gt; &lt;dbl&gt;</span><br><span>#1 Gene1 Data1 0.586</span><br><span>#2 Gene1 Data2 0.780</span><br><span>#3 Gene1 Data3 1.13 </span><br><span>#4 Gene1 Data4 0.150</span><br><span>#5 Gene1 Data5 0.645</span><br><span>#6 Gene1 Data6 0.224</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>2. 基本绘图</span><span></span><span> </span></h2><p data-tool="mdnice编辑器"><span>这里使用</span><code><span>geom_tile()</span></code><span>绘制矩形色块</span></p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(ggplot2)<br>p &lt;- ggplot(data = dft,aes(x = name,y = Gene)) +<br>     geom_tile(aes(fill = value),color = <span>"grey"</span>) +<br>     theme_minimal() <br></code></pre><p><img data-galleryid="" data-imgfileid="100002453" data-ratio="0.9687875150060024" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JsSmHJFOfEPqykrAOvjh4ias3ERNHIF0oicbGhiamvcYDSWMibmWsT1Aib09pAY82acJcyAodJ6axXmQw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="833" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JsSmHJFOfEPqykrAOvjh4ias3ERNHIF0oicbGhiamvcYDSWMibmWsT1Aib09pAY82acJcyAodJ6axXmQw/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器"><span>修改</span><code><span>theme</span></code><span>参数，调整颜色</span></p><pre data-tool="mdnice编辑器"><span></span><code>mytheme &lt;- theme(panel.grid = element_blank(),<br>                 legend.position = <span>"right"</span>,<br>                 legend.text = element_text(size = <span>18</span>),<br>                 legend.title = element_text(size = <span>18</span>),<br>                 axis.ticks.y = element_blank(),<br>                 axis.title = element_blank(),<br>                 axis.text.x = element_text(angle = <span>45</span>,hjust = <span>1</span>,size = <span>18</span>),<br>                 axis.text.y = element_text(colour = <span>'black'</span>, size = <span>18</span>))<br><span>library</span>(paletteer)<br>p2 &lt;- p + scale_fill_paletteer_c(<span>"ggthemes::Classic Red-Blue"</span>,<br>                                 direction = -<span>1</span>,<br>                                 name = <span>"Expression level\n(Z-score)"</span>,<br>                                 limits = c(-<span>2</span>,<span>2</span>)) + <br>      mytheme<br><span>####拉长图例</span><br>p2 &lt;- p2 + guides(fill = guide_colorbar(title.position = <span>"top"</span>,title.hjust = <span>0.5</span>,<br>                                        barwidth = <span>1.5</span>,barheight = <span>15</span>,ticks = <span>FALSE</span>))       <br></code></pre><p><img data-galleryid="" data-imgfileid="100002452" data-ratio="0.8265895953757225" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JsSmHJFOfEPqykrAOvjh4iamVMVjj2iaFaibaV7iaicb7xGz8rHPJNuYulnyfoyOJpY8Hs6AyC6mqwTTQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1038" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JsSmHJFOfEPqykrAOvjh4iamVMVjj2iaFaibaV7iaicb7xGz8rHPJNuYulnyfoyOJpY8Hs6AyC6mqwTTQ/640?wx_fmt=png&amp;from=appmsg"></p><h2 data-tool="mdnice编辑器"><span></span><span>3、绘制聚类树</span><span></span><span> </span></h2><pre data-tool="mdnice编辑器"><span></span><code>rownames(Data) &lt;- Data$Gene<br>df &lt;- as.data.frame(t(Data[,-ncol(Data)]))<br>Colors &lt;- c(<span>"grey70"</span>,<span>"#709AE1FF"</span>)  <br>Colors &lt;- Colors[as.numeric(factor(rep(c(<span>"Group1"</span>, <span>"Group2"</span>), each = <span>5</span>)))]<br>Shapes &lt;- c(<span>16</span>,<span>17</span>)[as.numeric(factor(rep(c(<span>"Group1"</span>, <span>"Group2"</span>), each = <span>5</span>)))]<br><br><span>#BiocManager::install("ggtree",force = TRUE)</span><br><span>library</span>(ggtree)<br><span>##行聚类</span><br>phr &lt;- hclust(dist(t(df))) %&gt;% <br>       ggtree(layout = <span>"rectangular"</span>,branch.length = <span>"none"</span>)<br><span>##列聚类 不同组别样本赋予不同颜色、图形</span><br>phc &lt;- hclust(dist(df)) %&gt;% ggtree() + layout_dendrogram()+<br>       geom_tippoint(color = Colors,shape = Shapes, alpha = <span>0.5</span>, size = <span>4</span>)+<br>       theme(legend.title = element_blank(),<br>          legend.key = element_blank(),<br>             legend.text = element_text(size = <span>18</span>))<br></code></pre><p data-tool="mdnice编辑器"><span>使用</span><code><span>aplot</span></code><span>包拼图：聚类树+热图</span></p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(aplot)<br>p_tree &lt;- p2 %&gt;% insert_left(phr, width = <span>0.2</span>) %&gt;% insert_top(phc, height = <span>0.08</span>)  <br></code></pre><p data-tool="mdnice编辑器"><br><span></span></p><p><img data-galleryid="" data-imgfileid="100002427" data-ratio="0.35185185185185186" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JsSmHJFOfEPqykrAOvjh4iafqdRr6PZKEALE0Wib5uRw3n5UnFyOuXNokIFuia3RfyJw0jY9lSibVUug/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JsSmHJFOfEPqykrAOvjh4iafqdRr6PZKEALE0Wib5uRw3n5UnFyOuXNokIFuia3RfyJw0jY9lSibVUug/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器"><span></span></p><h2 data-tool="mdnice编辑器"><span>4、添加分组色块</span><span></span><span> </span></h2><p data-tool="mdnice编辑器"><span>显示分组的条带也是一个小热图，画法一致：</span></p><pre data-tool="mdnice编辑器"><span></span><code><span>##生成随机分组</span><br>Group &lt;- rep(c(<span>"Group1"</span>, <span>"Group2"</span>), each = <span>5</span>)<br>Class &lt;- rep(c(<span>"Class1"</span>, <span>"Class2"</span>), <span>5</span>)<br>Group &lt;- data.frame(Sample_id = colnames(Data)[<span>1</span>:<span>10</span>],<br>                    Yaxis = <span>"Annotation"</span>,<br>                    Group, Class)<br><span>##添加新theme，去除标签</span><br>mytheme2 &lt;- theme(panel.grid = element_blank(),<br>                 legend.position = <span>"right"</span>,<br>                 legend.text = element_text(size = <span>18</span>),<br>                 legend.title = element_text(size = <span>18</span>),<br>                 axis.ticks.y = element_blank(),<br>                 axis.title = element_blank(),<br>                 axis.text.x =  element_blank(),<br>                 axis.text.y =  element_blank())<br>Block1 &lt;- ggplot(data = Group,aes(Sample_id,Yaxis,fill = Group))+<br>          geom_tile()+<br>          scale_fill_manual(values = c(<span>"#3B9AB2"</span>, <span>"#78B7C5"</span>))+<br>          theme_void() + mytheme2<br>Block2 &lt;- ggplot(data = Group,aes(Sample_id,Yaxis,fill = Class))+<br>          geom_tile()+<br>          scale_fill_manual(values = c(<span>"#006699"</span>, <span>"#993333"</span>)) + <br>          theme_void() + mytheme2<br></code></pre><p data-tool="mdnice编辑器"><span>仍然使用</span><code><span>aplot</span></code><span>包拼图：</span></p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(aplot)<br>p_block &lt;- p2 %&gt;% insert_top(Block1,height = <span>0.04</span>)  %&gt;% insert_top(Block2,height = <span>0.04</span>)   <br></code></pre><p data-tool="mdnice编辑器"><span>也可以使用</span><code><span>patchwork</span></code><span>拼图，添加空白填补缝隙（不具有普适性）：</span></p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(patchwork) <br>p_block2 &lt;- (Block1 + plot_spacer() + Block2 + plot_spacer() + p2) + <br>             plot_layout(heights = c(<span>0.04</span>,-<span>0.035</span>,<span>0.04</span>,-<span>0.05</span>,<span>1</span>),ncol = <span>1</span>,guides=<span>'collect'</span>)<br></code></pre><p><img data-galleryid="" data-imgfileid="100002430" data-ratio="1.0425790754257906" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JsSmHJFOfEPqykrAOvjh4iaahVFSKEBpymS45rib46miaNyibnWPtVl7mttGKUQiaOW1cfQeKsNJIicfIw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="822" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JsSmHJFOfEPqykrAOvjh4iaahVFSKEBpymS45rib46miaNyibnWPtVl7mttGKUQiaOW1cfQeKsNJIicfIw/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器"><span>同样的我们也可以在侧面添加分组，此时我们需要将纵坐标标签移动到右侧</span></p><pre data-tool="mdnice编辑器"><span></span><code>p3 &lt;- p2 + scale_y_discrete(position=<span>"right"</span>) <br></code></pre><p data-tool="mdnice编辑器"><span>其他步骤类似：</span></p><pre data-tool="mdnice编辑器"><span></span><code>Genelist &lt;- rep(c(<span>"Group1"</span>, <span>"Group2"</span>), each = <span>10</span>)<br>Group &lt;- data.frame(Gene_id = rownames(Data),<br>                    Xaxis = <span>"Annotation"</span>,<br>                    Genelist)<br>Block3 &lt;- ggplot(data = Group,aes(Xaxis,Gene_id,fill = Genelist))+<br>          geom_tile()+<br>          scale_fill_manual(values = c(<span>"#88c4e8"</span>,<span>"#db6968"</span>))+<br>          theme_void() + mytheme2<br>p_block &lt;- p3 %&gt;% insert_top(Block1,height = <span>0.04</span>) %&gt;% insert_top(Block2,height = <span>0.04</span>) %&gt;% <br>           insert_left(Block3,width = <span>0.04</span>) <br></code></pre><p data-tool="mdnice编辑器"><span>把之前获得聚类树也加上：</span></p><pre data-tool="mdnice编辑器"><span></span><code>p3 %&gt;% insert_top(Block1,height = <span>0.04</span>) %&gt;% <br>       insert_top(Block2,height = <span>0.04</span>) %&gt;% <br>       insert_left(Block3,width = <span>0.04</span>) %&gt;%<br>       insert_left(phr, width = <span>0.2</span>) %&gt;% <br>       insert_top(phc, height = <span>0.08</span>)    <br></code></pre></section><p><img data-galleryid="" data-imgfileid="100002431" data-ratio="0.9438832772166106" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JsSmHJFOfEPqykrAOvjh4ia4P7XiaicpXOA1FSJmOFYZXsYxwOusnfX8u6o0iapOxDKypAA1iaL8lS9Rg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="891" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3JsSmHJFOfEPqykrAOvjh4ia4P7XiaicpXOA1FSJmOFYZXsYxwOusnfX8u6o0iapOxDKypAA1iaL8lS9Rg/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-ratio="0.05278592375366569" data-type="png" data-w="341" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/1LTeQhNfr8sUH75oYsoDaqjPCTiaukEmS8tWricW7LnLKKfIE9jKBexibqamsrlibaaXmuc2nicaYibfDFBNCmqX5mBw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-imgfileid="100002454" src="https://mmbiz.qpic.cn/sz_mmbiz_png/1LTeQhNfr8sUH75oYsoDaqjPCTiaukEmS8tWricW7LnLKKfIE9jKBexibqamsrlibaaXmuc2nicaYibfDFBNCmqX5mBw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p><br></p><section data-tools="135编辑器" data-id="116886" draggable="true"><section><section><section><section><strong data-brushtype="text">被炸熟的虾</strong></section></section></section><section><section><section data-width="35%"><section><img data-cropselx1="0" data-cropselx2="115" data-cropsely1="0" data-cropsely2="115" data-imgfileid="100002456" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/dRYYdqiaan3JjDfj2H8p6gg3CB25AGthbwzrotao4ev5tIe0utthbZRK8yOoDOuTzOSoTSnPWn61IdDCnXsnaiag/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="jpeg" data-w="258" data-width="100%" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/dRYYdqiaan3JjDfj2H8p6gg3CB25AGthbwzrotao4ev5tIe0utthbZRK8yOoDOuTzOSoTSnPWn61IdDCnXsnaiag/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></section></section><section data-width="63%"><section><section><strong>自己的摸索，发现问题麻烦告诉作者，光速回来改正</strong><strong><img data-imgfileid="100002455" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3KLQGNxibvI4SdtUfxjINkz2DO8cGEPTgbcMJ357RvXJ7IvWU2p7anljpePpakI9oKu3icJxobBDp5w/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="64" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3KLQGNxibvI4SdtUfxjINkz2DO8cGEPTgbcMJ357RvXJ7IvWU2p7anljpePpakI9oKu3icJxobBDp5w/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></strong></section></section></section></section></section></section></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/bwOIZ_n31axAkUtJMrzoAw",target="_blank" rel="noopener noreferrer">原文链接</a>
