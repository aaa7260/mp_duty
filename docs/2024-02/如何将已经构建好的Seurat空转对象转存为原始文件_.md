---
title: "如何将已经构建好的Seurat空转对象转存为原始文件？"
date: 2024-02-21T02:23:45Z
draft: ["false"]
tags: [
  "fetched",
  "Biomamba 生信基地"
]
categories: ["Acdemic"]
---
如何将已经构建好的Seurat空转对象转存为原始文件？ by Biomamba 生信基地
------
<div><p>空转的分析生态还没有单细胞那么成熟，经常需要跨软件、跨平台完成数据分析，这里我们以10X Visium为例演示演示如何将R语言中的Seurat空转对象转变为本地输出，并用Python中Scanpy进行读取检查。当然，Scanpy可以直接以sc.read_visium的形式读入数据，这里我们假设了一种只能拿到rds文件的情况。</p><p>本教程测试文件：<span>https://pan.baidu.com/s/1uFSVCH86JZ8RAHR7kb30ig?pwd=j9nv</span></p><p>提取码：j9nv</p><p><br></p><section>更多空转教程可见：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247505088&amp;idx=1&amp;sn=9f60dca1b21f5ba8c32d09595a512134&amp;chksm=9b3cad90ac4b2486820dd335d997d2a96b77beb6ad463b1df6a2f307e47ebe8d7de3304ebf7c&amp;scene=21#wechat_redirect" textvalue="空间转录组学习手册合辑" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>空间转录组学习手册合辑</span></a></section><section>一、Seurat中读取并转存10X Visium数据(在R中完成)</section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="ruby"><code><span><span>### 读取数据 ###</span></span></code><code><span><span># 加载R包</span></span></code><code><span>library(DropletUtils)</span></code><code><span>library(tibble)</span></code><code><span>library(Seurat)</span></code><code><span>library(jsonlite)</span></code><code><span>library(stringr)</span></code><code><span><br></span></code><code><span><span># 读入10X Visium数据</span></span></code><code><span>data &lt;- Load10X_Spatial(<span>'~/data/test/10X_data'</span>)</span></code><code><span><br></span></code><code><span><span># 保存为RDS</span></span></code><code><span>saveRDS(data,file = <span>'~/data/test/RDS/data.rds'</span>)</span></code></pre></section><p><br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="ruby"><code><span><span>### 保存为scanpy可以读取的格式 ###</span></span></code><code><span><br></span></code><code><span><span># 从 data 对象中提取空间图像的缩放因子。Visium 数据通常包括高分辨率（hires）和低分辨率（lowres）的图像数据。这里，low_factor 和 hi_factor 分别存储了低分辨率和高分辨率图像的缩放因子。这些因子在分析空间转录组数据时非常重要，因为它们帮助调整图像大小以匹配转录组数据。</span></span></code><code><span>low_factor &lt;- data@images$slice1@scale.factors$lowres</span></code><code><span>hi_factor &lt;- data@images$slice1@scale.factors$hires</span></code><code><span><br></span></code><code><span>dir.create(<span>'~/data/test/Export_data/spatial'</span>)</span></code><code><span><br></span></code><code><span><span># 获取并保存图像</span></span></code><code><span>images &lt;- GetImage(data, mode = <span>"raw"</span>)</span></code><code><span>images &lt;- magick::image_read(images) </span></code><code><span>image_height &lt;- magick::image_info(images)$height</span></code><code><span>EBImage::writeImage(magick::as_EBImage(images), file = <span>'~/data/test/Export_data/spatial/tissue_lowres_image.png'</span>)</span></code><code><span>images &lt;- images %&gt;% magick::image_resize(paste<span>0</span>(<span>'x'</span>,round(image_height/low_factor*hi_factor)))</span></code><code><span>EBImage::writeImage(magick::as_EBImage(images), file = <span>'~/data/test/Export_data/spatial/tissue_hires_image.png'</span>)</span></code><code><span><br></span></code><code><span><span># 获取并保存坐标信息</span></span></code><code><span>coordinates &lt;- data@images$slice1@coordinates</span></code><code><span>coordinates &lt;- rownames_to_column(coordinates)</span></code><code><span><span># coordinates[,1] &lt;- str_split(coordinates[,1],'_',simplify = TRUE)[,2] #可以用这行修改barcodes前缀</span></span></code><code><span>write.table(coordinates,file = <span>'~/data/test/Export_data/spatial/tissue_positions_list.csv'</span>,quote = F,row.names = F,col.names = F,sep=<span>','</span>)</span></code><code><span><br></span></code><code><span><span># 整理并保存缩放因子</span></span></code><code><span>scale_factors &lt;- data.frame(spot_diameter_fullres=data@images$slice1@scale.factors$spot,</span></code><code><span>                            tissue_hires_scalef=data@images$slice1@scale.factors$hires,</span></code><code><span>                            fiducial_diameter_fullres=data@images$slice1@scale.factors$fiducial,</span></code><code><span>                            tissue_lowres_scalef=data@images$slice1@scale.factors$lowres)</span></code><code><span><br></span></code><code><span>jsondata &lt;- toJSON(scale_factors)</span></code><code><span>cat(str_remove_all(jsondata, <span>'[\\[\\]]'</span>), file = <span>'~/data/test/Export_data/spatial/scalefactors_json.json'</span>, fill = FALSE, labels = NULL, append = FALSE)</span></code><code><span><br></span></code><code><span><span># 保存矩阵</span></span></code><code><span>write10xCounts(x = data@assays$Spatial$counts,</span></code><code><span>               <span>#barcodes = str_split(colnames(P2_noninf<span>@assays</span>$Spatial$counts),'_',simplify = TRUE)[,2] , </span></span></code><code><span>               <span># 如果barcodes已经被修改过带有前缀了，如果不想要前缀可以用上一行去掉，不过记得改coordinates里面的barcodes</span></span></code><code><span>               gene.id = rownames(data@assays$Spatial$counts),</span></code><code><span>               gene.symbol = rownames(data@assays$Spatial$counts),</span></code><code><span>               gene.type = <span>"Gene Expression"</span>,</span></code><code><span>               overwrite = FALSE,</span></code><code><span>               type = <span>'HDF5'</span>,</span></code><code><span>               genome = <span>"CRCh38"</span>,</span></code><code><span>               version = <span>"3"</span>,</span></code><code><span>               chemistry = <span>"Single Cell 3' v1"</span>,</span></code><code><span>               library.ids = <span>"slice1"</span>,</span></code><code><span>               path = <span>'~/data/test/Export_data/filtered_feature_bc_matrix.h5'</span>)</span></code><code><span><br></span></code></pre></section><p><br></p><p>二、在Scanpy中查看是否能够读入(在<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247499921&amp;idx=1&amp;sn=dcd6f95596e3de9bf378d850c217fe78&amp;chksm=9b3cb9c1ac4b30d7bbd44057b181f87541f5904d24f903494ae557e768ae00c208c1b68b45c7&amp;scene=21#wechat_redirect" textvalue="Python" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>Python</span></a>中完成)<br></p><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="javascript"><code><span>### 导入数据 ###</span></code><code><span><span>import</span> scanpy <span>as</span> sc</span></code><code><span><span>import</span> pandas <span>as</span> pd</span></code><code><span><span>import</span> matplotlib.pyplot <span>as</span> plt</span></code><code><span><span>import</span> seaborn <span>as</span> sns</span></code><code><span>data_export = sc.read_visium(<span>'/home/zbt/data/test/Export_data'</span>,library_id=<span>'slice1'</span>)</span></code><code><span>data_10x = sc.read_visium(<span>'/home/zbt/data/test/10X_data'</span>)</span></code></pre></section><p>两个数据均可正常导入:<br></p><p><img data-galleryid="" data-imgfileid="100022865" data-ratio="0.3796423658872077" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpxwtL210ID1Q7S1RsnC1B9djzOJvYIs4zh1IGogGyfSuqpbbiaglliayGWS6fG5ud63SNgFBqjUBmSg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="727" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpxwtL210ID1Q7S1RsnC1B9djzOJvYIs4zh1IGogGyfSuqpbbiaglliayGWS6fG5ud63SNgFBqjUBmSg/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span><span>### 做点预处理看看是否能够正常分析 ###</span></span></code><code><span>data_export.var_names_make_unique()</span></code><code><span>data_export.<span>var</span>[<span>"mt"</span>] = data_export.var_names.str.startswith(<span>"MT-"</span>)</span></code><code><span>sc.pp.calculate_qc_metrics(data_export, qc_vars=[<span>"mt"</span>], inplace=<span>True</span>)</span></code><code><span><br></span></code><code><span>data_10x.var_names_make_unique()</span></code><code><span>data_10x.<span>var</span>[<span>"mt"</span>] = data_10x.var_names.str.startswith(<span>"MT-"</span>)</span></code><code><span>sc.pp.calculate_qc_metrics(data_10x, qc_vars=[<span>"mt"</span>], inplace=<span>True</span>)</span></code><code><span><br></span></code><code><span>plt.rcParams[<span>"figure.figsize"</span>] = (<span>8</span>, <span>8</span>)</span></code><code><span>sc.pl.spatial(data_export, img_key=<span>"hires"</span>, color=[<span>"total_counts"</span>, <span>"n_genes_by_counts"</span>])</span></code><code><span><br></span></code><code><span>plt.rcParams[<span>"figure.figsize"</span>] = (<span>8</span>, <span>8</span>)</span></code><code><span>sc.pl.spatial(data_10x, img_key=<span>"hires"</span>, color=[<span>"total_counts"</span>, <span>"n_genes_by_counts"</span>])</span></code></pre></section><p><br></p><p>可以看出与原始数据相比几乎无差异：</p><p><img data-imgfileid="100022866" data-ratio="0.48055555555555557" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpxwtL210ID1Q7S1RsnC1B9daIdH1TiaPG1xenh4v2neib9yB8mW2d7pf53fshibjQzMB57ibjhZbNxmXg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpxwtL210ID1Q7S1RsnC1B9daIdH1TiaPG1xenh4v2neib9yB8mW2d7pf53fshibjQzMB57ibjhZbNxmXg/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-imgfileid="100022867" data-ratio="0.48055555555555557" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpxwtL210ID1Q7S1RsnC1B9dfqmusD0NB434AzictticzjOLxUlEYtibTSP401l6wwavTJK8zhsRpT96g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpxwtL210ID1Q7S1RsnC1B9dfqmusD0NB434AzictticzjOLxUlEYtibTSP401l6wwavTJK8zhsRpT96g/640?wx_fmt=png&amp;from=appmsg"></p><section>此方法唯一的缺陷是是Seurat对象中仅存储lowres图像，所以只能利用rds文件图像强制拉伸到hires分辨率。hires图像会略微模糊。<span>如</span><span>果原文提供了hires图像则可以直接替换进spa</span><span>tial文件夹。</span></section><p><span>更多空转教程可参考：</span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247505088&amp;idx=1&amp;sn=9f60dca1b21f5ba8c32d09595a512134&amp;chksm=9b3cad90ac4b2486820dd335d997d2a96b77beb6ad463b1df6a2f307e47ebe8d7de3304ebf7c&amp;scene=21#wechat_redirect" textvalue="空间转录组学习手册合辑" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>空间转录组学习手册合辑</span><span></span></a></p><section><section><section data-support="96编辑器" data-style-id="27326"><section><section><section><section><section><section><section data-support="96编辑器" data-style-id="34887"><section><section><section data-support="96编辑器" data-style-id="36531"><section data-align="title"><section><section><br></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><section><section><section data-support="96编辑器" data-style-id="27326"><section><section><section><section><section><section><section data-support="96编辑器" data-style-id="34887"><section><section><section data-support="96编辑器" data-style-id="36531"><section data-align="title"><section><section><img data-imgfileid="100024480" data-ratio="0.5106382978723404" data-w="47" data-width="100%" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWiaFyWDMZJ2713X3DwiaQicG5O8mjlC4kPOluxibs4oDot7AXe0RgoXgMeiaB3KYViadIQqXRoRicyian7KUg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWiaFyWDMZJ2713X3DwiaQicG5O8mjlC4kPOluxibs4oDot7AXe0RgoXgMeiaB3KYViadIQqXRoRicyian7KUg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></section><section><section><section><p><strong>如何联系我们</strong><br></p></section></section><section><img data-imgfileid="100024479" data-ratio="1.163265306122449" data-w="49" data-width="100%" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWiaFyWDMZJ2713X3DwiaQicG5OSxqKNRib39TuLic5NT2iaJaI0mIicuvjMZlRPvlqPfgjzg001qlRJTBDRA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWiaFyWDMZJ2713X3DwiaQicG5OSxqKNRib39TuLic5NT2iaJaI0mIicuvjMZlRPvlqPfgjzg001qlRJTBDRA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></section></section></section></section></section><section data-support="96编辑器" data-style-id="34624"><section><section><section><img data-imgfileid="100024481" data-ratio="0.2463768115942029" data-w="138" data-src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWiaC0oer2QpXIolHVU3Xibtm9BNWiav660mHaB5qEd1dibMibUicNYmAzBBiadQP2s7HArdUxoWL5cDkTEbQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWiaC0oer2QpXIolHVU3Xibtm9BNWiav660mHaB5qEd1dibMibUicNYmAzBBiadQP2s7HArdUxoWL5cDkTEbQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section><section><section>公众号后台消息回复不便，这里给大家留一下领取资料及免费服务器(<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247507693&amp;idx=1&amp;sn=d9517a0803ad75cb7be430806834e7b8&amp;chksm=9b3ca7bdac4b2eaba1ad01ed04ab1fbcbafcf4f6ddfe9e4f76ed9229707f545fe7d9c9ffd6ae&amp;scene=21#wechat_redirect" textvalue="足够支持你完成硕博生涯的生信环境" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"><span>足够支持你完成硕博生涯的生信环境</span></a>)的<span><strong>微信号</strong></span>，方便各位随时交流、提建议（科研任务繁重，回复不及时请见谅）。此外呼声一直很高的<strong><span>交流群</span></strong>也建好了，欢迎大家入群讨论：</section><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247505868&amp;idx=2&amp;sn=20c81313eaef9a7031a84ef3a691d1b5&amp;chksm=9b3cae9cac4b278a42c8de97e864c7664a37e9a4adb5973625fe3f8dd1093e55aeda88d443aa&amp;scene=21#wechat_redirect" textvalue="永久免费的生信、科研交流群" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"><span>永久免费的生信、科研交流群</span></a><br></p><section><span>大家可以阅读完这几篇之后添加</span></section><section><span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247493329&amp;idx=1&amp;sn=597870b7f7ce10346da3561e7c281627&amp;chksm=9b3c9f81ac4b169794088ce9abbcacb5f18e9fd174fc0d7e28da62d78facadf3100ef38aaf22&amp;scene=21#wechat_redirect" textvalue="给生信入门初学者的小贴士" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">给生信入门初学者的小贴士</a><br></span></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247506266&amp;idx=2&amp;sn=22b1164bc9602c25620d058847785422&amp;chksm=9b3ca00aac4b291c16d738271746ffb90149282a728f484e8a1952463c46a8e7dc4f883ab928&amp;scene=21#wechat_redirect" textvalue="如何搜索公众号过往发布内容(内含集锦)" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"><span>如何搜索公众号过往发布内容</span></a><br></section><p><img data-galleryid="" data-imgfileid="100024483" data-ratio="0.4357976653696498" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpx6Htt0YEibg4Pn7N7fFUdclZQH9RX6YAUqQG98l3jcz9XjCiatucDpyE0o10sotnD7jiaEIFDOmv8Yw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1028" src="https://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpx6Htt0YEibg4Pn7N7fFUdclZQH9RX6YAUqQG98l3jcz9XjCiatucDpyE0o10sotnD7jiaEIFDOmv8Yw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><section><section><section><img data-imgfileid="100024484" data-ratio="0.7619047619047619" data-w="84" data-width="80%" data-src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWhFTIP7DCMLPwWh8Yhjs079f1vMqlYdExqbWaZVJyiawKkr21EDSNW740b4yMzkeHxFJULTpZGzYwQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" src="https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWhFTIP7DCMLPwWh8Yhjs079f1vMqlYdExqbWaZVJyiawKkr21EDSNW740b4yMzkeHxFJULTpZGzYwQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section><section><span>您点的每个赞和在看，我都认真当成了喜欢</span></section></section></section><section><br></section><p><br></p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/iso9kDB88Alk1cI6CZ-7hA",target="_blank" rel="noopener noreferrer">原文链接</a>
