---
title: "DotPlot-分步看"
date: 2024-02-08T03:32:25Z
draft: ["false"]
tags: [
  "fetched",
  "SofarSoso"
]
categories: ["Acdemic"]
---
DotPlot-分步看 by SofarSoso
------
<div><h4>1.首先加载要用到的所有包</h4><p><span><span>•</span>SeuratData里存储了大量的Seurat可用数据集，可以作测试使用</span></p><section><ul><li><li><li></ul><pre data-lang="R"><code><span><span>library</span><span>(</span><span>SeuratData</span><span>)</span></span></code><code><span><span>library</span><span>(</span><span>Seurat</span><span>)</span></span></code><code><span><span>library</span><span>(</span><span>cowplot</span><span>)</span></span></code></pre></section><h4>2.调用SeuratData</h4><p><span><span>•</span>这里用了pbmc3k.final的数据集</span></p><section><ul><li><li></ul><pre data-lang=""><code><span><span>AvailableData</span><span>()#查看目前有哪些数据集可用，</span><span>TRUE </span><span>表明该数据集可用，</span><span>FALSE </span><span>表明不可用，需要安装</span></span></code><code><span><span>InstallData</span><span>(</span><span>'pbmc3k'</span><span>)#我这边网速不好，实际是</span><span>InstallData</span><span>跳出的网址，自己网上下载后再</span><span>install</span><span>.</span><span>packages</span><span>安装的</span></span></code></pre></section><h4>3.简单的Seurat的DotPlot</h4><section><ul><li><li><li><li></ul><pre data-lang="R"><code><span><span>data</span><span>(</span><span>"pbmc3k.final"</span><span>)</span></span></code><code><span><span>pbmc</span><span>&lt;-</span><span> pbmc3k</span><span>.</span><span>final</span></span></code><code><span><span>features </span><span>=</span><span> c</span><span>(</span><span>'CD68'</span><span>,</span><span>'CD70'</span><span>,</span><span>'CD33'</span><span>,</span><span>'CD37'</span><span>,</span><span>'CD226'</span><span>)</span></span></code><code><span><span>DotPlot</span><span>(</span><span>pbmc</span><span>,</span><span>features </span><span>=</span><span> c</span><span>(</span><span>'CD68'</span><span>,</span><span>'CD70'</span><span>,</span><span>'CD33'</span><span>,</span><span>'CD37'</span><span>,</span><span>'CD226'</span><span>),</span><span>scale </span><span>=</span><span> T</span><span>)</span></span></code></pre></section><figure><p><img data-galleryid="" data-ratio="0.5140295053514609" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/y7JAiaUuGxMwqqJ7CWGXOSvSVGcGibeyGoPxKMGu7jzkHsBvRMGo85RqZicJmOl2ckJJzyvbP8VpHZb9iaTuaQib88Q/640?wx_fmt=png" data-type="png" data-w="3457" src="https://mmbiz.qpic.cn/mmbiz_png/y7JAiaUuGxMwqqJ7CWGXOSvSVGcGibeyGoPxKMGu7jzkHsBvRMGo85RqZicJmOl2ckJJzyvbP8VpHZb9iaTuaQib88Q/640?wx_fmt=png"></p><figcaption><br></figcaption></figure><h4>4.借用以下几行DotPlot的默认参数</h4><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="R"><code><span><span>scale</span><span>.</span><span>by</span><span> </span><span>=</span><span> </span><span>"radius"</span><span>;</span><span>cols </span><span>=</span><span> c</span><span>(</span><span>"lightgrey"</span><span>,</span><span>"blue"</span><span>);</span></span></code><code><span><span>col</span><span>.</span><span>min </span><span>=</span><span> </span><span>-</span><span>2.5</span><span>;</span><span>col</span><span>.</span><span>max </span><span>=</span><span> </span><span>2.5</span><span>;</span></span></code><code><span><span>dot</span><span>.</span><span>min </span><span>=</span><span> </span><span>0</span><span>;</span><span>color</span><span>.</span><span>by</span><span>=</span><span>'id'</span><span>;</span></span></code><code><span><span>scale</span><span>.</span><span>min </span><span>=</span><span> NA</span><span>;</span><span>scale</span><span>.</span><span>max </span><span>=</span><span> NA</span><span>;</span></span></code><code><span><span>dot</span><span>.</span><span>scale </span><span>=</span><span> </span><span>6</span><span>;</span><span>split</span><span>.</span><span>by</span><span>=</span><span>NULL</span><span>;</span></span></code><code><span><span>color</span><span>.</span><span>by</span><span>=</span><span>NULL</span></span></code><code><span><span>split</span><span>.</span><span>colors </span><span>&lt;-</span><span> </span><span>!</span><span>is</span><span>.</span><span>null</span><span>(</span><span>x </span><span>=</span><span> split</span><span>.</span><span>by</span><span>)</span><span> </span><span>&amp;&amp;</span><span> </span><span>!</span><span>any</span><span>(</span><span>cols </span><span>%</span><span>in</span><span>%</span><span> rownames</span><span>(</span><span>x </span><span>=</span><span> brewer</span><span>.</span><span>pal</span><span>.</span><span>info</span><span>))</span></span></code></pre></section><h4>5.DotPlot-数据索引</h4><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="R"><code><span><span>#在Seurat中用FetchData这个函数</span></span></code><code><span><span>data_choose </span><span>&lt;-</span><span> </span><span>FetchData</span><span>(</span><span>pbmc</span><span>,</span><span>vars </span><span>=</span><span> features</span><span>)</span></span></code><code><span><span>#其实Seurat也可以这样来进行“矩阵”索引，像数据框一样，这里的行是基因，列是样本（即细胞）</span></span></code><code><span><span>data_choose </span><span>&lt;-</span><span> pbmc</span><span>[</span><span>features</span><span>,]</span></span></code><code><span><span>data_matrix </span><span>&lt;-</span><span> </span><span>as</span><span>.</span><span>data</span><span>.</span><span>frame</span><span>(</span><span>t</span><span>(</span><span>as</span><span>.</span><span>matrix</span><span>(</span><span>data_choose@assays$RNA@data</span><span>)))</span></span></code><code><span><span>##当然，关于细胞的一系列信息还是存储再meta.data中</span></span></code><code><span><span>data_pheo </span><span>&lt;-</span><span> data_choose@meta</span><span>.</span><span>data</span></span></code><code><span><span>data_matrix$id </span><span>&lt;-</span><span> data_pheo$seurat_annotations</span></span></code></pre></section><h4>6.DotPlot-数据处理-ident水平的平均值计算</h4><p><span><span>•</span>对每个ident的数据，作以下处理：每个值作exp(x)-1处理，按列求平均</span><span><span>•</span>对每个ident的数据，按列，求每列 &gt;0 的数值的比例</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="R"><code><span><span>data</span><span>.</span><span>plot</span><span>&lt;-</span><span> lapply</span><span>(</span><span>unique</span><span>(</span><span>data_matrix$id</span><span>),</span><span>function</span><span>(</span><span>ident</span><span>){</span></span></code><code><span><span>  data</span><span>.</span><span>use</span><span> </span><span>&lt;-</span><span> data_matrix</span><span>[</span><span>data_matrix$id </span><span>==</span><span> ident</span><span>,</span></span></code><code><span><span>                          </span><span>1</span><span>:(</span><span>ncol</span><span>(</span><span>x </span><span>=</span><span> data_matrix</span><span>)</span><span> </span><span>-</span><span> </span><span>1</span><span>),</span><span> drop </span><span>=</span><span> FALSE</span><span>]</span></span></code><code><span><span>  avg</span><span>.</span><span>exp </span><span>&lt;-</span><span> apply</span><span>(</span><span>X </span><span>=</span><span> data</span><span>.</span><span>use</span><span>,</span><span> MARGIN </span><span>=</span><span> </span><span>2</span><span>,</span><span> FUN </span><span>=</span><span> </span><span>function</span><span>(</span><span>x</span><span>)</span><span> </span><span>{</span></span></code><code><span><span>    </span><span>return</span><span>(</span><span>mean</span><span>(</span><span>x </span><span>=</span><span> expm1</span><span>(</span><span>x </span><span>=</span><span> x</span><span>)))</span></span></code><code><span><span>  </span><span>})</span></span></code><code><span><span>  pct</span><span>.</span><span>exp </span><span>&lt;-</span><span> apply</span><span>(</span><span>X </span><span>=</span><span> data</span><span>.</span><span>use</span><span>,</span><span> MARGIN </span><span>=</span><span> </span><span>2</span><span>,</span><span> FUN </span><span>=</span><span> </span><span>PercentAbove</span><span>,</span></span></code><code><span><span>                   threshold </span><span>=</span><span> </span><span>0</span><span>)</span></span></code><code><span><span>  features</span><span>.</span><span>plot </span><span>&lt;-</span><span> colnames</span><span>(</span><span>x </span><span>=</span><span> data</span><span>.</span><span>use</span><span>)</span><span>  </span></span></code><code><span><span>  data </span><span>&lt;-</span><span> data</span><span>.</span><span>frame</span><span>(</span><span>avg</span><span>.</span><span>exp </span><span>=</span><span>avg</span><span>.</span><span>exp</span><span>,</span><span>pct</span><span>.</span><span>exp </span><span>=</span><span> pct</span><span>.</span><span>exp</span><span>,</span><span>features</span><span>.</span><span>plot</span><span>=</span><span>features</span><span>.</span><span>plot</span><span>)</span></span></code><code><span><span>  data$id </span><span>&lt;-</span><span> ident</span></span></code><code><span><span>  </span><span>return</span><span>(</span><span>data</span><span>)</span></span></code><code><span><span>})</span></span></code></pre></section><h4>7.DotPlot - 基因水平的scale</h4><p><span><span>•</span>上述我们得到的数据是n(ident) x n(gene) ，需在基因水平进行scale，以使各cluster间的表达对比更加明显；</span><span><span>•</span>MinMax设置极值范围也是这个目的，使颜色对比更加鲜明；</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="R"><code><span><span>color</span><span>.</span><span>by</span><span> </span><span>&lt;-</span><span> ifelse</span><span>(</span><span>test </span><span>=</span><span> split</span><span>.</span><span>colors</span><span>,</span><span> yes </span><span>=</span><span> </span><span>"colors"</span><span>,</span><span> </span><span>no</span><span> </span><span>=</span><span> </span><span>"avg.exp.scaled"</span><span>)</span></span></code><code><span><span>avg</span><span>.</span><span>exp</span><span>.</span><span>scaled </span><span>&lt;-</span><span> sapply</span><span>(</span><span>X </span><span>=</span><span> unique</span><span>(</span><span>x </span><span>=</span><span> data</span><span>.</span><span>plot$features</span><span>.</span><span>plot</span><span>),</span></span></code><code><span><span>                         FUN </span><span>=</span><span> </span><span>function</span><span>(</span><span>x</span><span>)</span><span> </span><span>{</span></span></code><code><span><span>                           data</span><span>.</span><span>use</span><span> </span><span>&lt;-</span><span> data</span><span>.</span><span>plot</span><span>[</span><span>data</span><span>.</span><span>plot$features</span><span>.</span><span>plot </span><span>==</span></span></code><code><span><span>                                                   x</span><span>,</span><span> </span><span>"avg.exp"</span><span>]</span></span></code><code><span><span>                           data</span><span>.</span><span>use</span><span> </span><span>&lt;-</span><span> scale</span><span>(</span><span>x </span><span>=</span><span> data</span><span>.</span><span>use</span><span>)</span></span></code><code><span><span>                           data</span><span>.</span><span>use</span><span> </span><span>&lt;-</span><span> </span><span>MinMax</span><span>(</span><span>data </span><span>=</span><span> data</span><span>.</span><span>use</span><span>,</span><span> min </span><span>=</span><span> col</span><span>.</span><span>min</span><span>,</span></span></code><code><span><span>                                              max </span><span>=</span><span> col</span><span>.</span><span>max</span><span>)</span><span>                          </span></span></code><code><span><span>                           </span><span>return</span><span>(</span><span>data</span><span>.</span><span>use</span><span>)</span></span></code><code><span><span>                         </span><span>})</span></span></code><code><span><span>avg</span><span>.</span><span>exp</span><span>.</span><span>scaled </span><span>&lt;-</span><span> </span><span>as</span><span>.</span><span>vector</span><span>(</span><span>x </span><span>=</span><span> t</span><span>(</span><span>x </span><span>=</span><span> avg</span><span>.</span><span>exp</span><span>.</span><span>scaled</span><span>))</span></span></code><code><span><span>data</span><span>.</span><span>plot$avg</span><span>.</span><span>exp</span><span>.</span><span>scaled </span><span>&lt;-</span><span> avg</span><span>.</span><span>exp</span><span>.</span><span>scaled</span></span></code><code><span><span>data</span><span>.</span><span>plot$features</span><span>.</span><span>plot </span><span>&lt;-</span><span> factor</span><span>(</span><span>x </span><span>=</span><span> data</span><span>.</span><span>plot$features</span><span>.</span><span>plot</span><span>,</span><span>levels </span><span>=</span><span> features</span><span>)</span></span></code><code><span><span>data</span><span>.</span><span>plot$pct</span><span>.</span><span>exp</span><span>[</span><span>data</span><span>.</span><span>plot$pct</span><span>.</span><span>exp </span><span>&lt;</span><span> dot</span><span>.</span><span>min</span><span>]</span><span> </span><span>&lt;-</span><span> NA</span></span></code><code><span><span>data</span><span>.</span><span>plot$pct</span><span>.</span><span>exp </span><span>&lt;-</span><span> data</span><span>.</span><span>plot$pct</span><span>.</span><span>exp </span><span>*</span><span> </span><span>100</span></span></code></pre></section><h4>8.DotPlot - ggplot2绘图</h4><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="R"><code><span><span>plot </span><span>&lt;-</span><span> ggplot</span><span>(</span><span>data </span><span>=</span><span> data</span><span>.</span><span>plot</span><span>,</span><span> mapping </span><span>=</span><span> aes_string</span><span>(</span><span>x </span><span>=</span><span> </span><span>"features.plot"</span><span>,</span><span>y </span><span>=</span><span> </span><span>"id"</span><span>))</span><span> </span><span>+</span><span> </span></span></code><code><span><span>  geom_point</span><span>(</span><span>mapping </span><span>=</span><span> aes_string</span><span>(</span><span>size </span><span>=</span><span> </span><span>"pct.exp"</span><span>,</span><span>color </span><span>=</span><span> color</span><span>.</span><span>by</span><span>))</span><span> </span><span>+</span><span> </span></span></code><code><span><span>  scale</span><span>.</span><span>func</span><span>(</span><span>range </span><span>=</span><span> c</span><span>(</span><span>0</span><span>,</span><span> dot</span><span>.</span><span>scale</span><span>),</span><span>limits </span><span>=</span><span> c</span><span>(</span><span>scale</span><span>.</span><span>min</span><span>,</span><span> scale</span><span>.</span><span>max</span><span>))</span><span> </span><span>+</span></span></code><code><span><span>  theme</span><span>(</span><span>axis</span><span>.</span><span>title</span><span>.</span><span>x </span><span>=</span><span> element_blank</span><span>(),</span><span>axis</span><span>.</span><span>title</span><span>.</span><span>y </span><span>=</span><span> element_blank</span><span>())</span><span> </span><span>+</span></span></code><code><span><span>  guides</span><span>(</span><span>size </span><span>=</span><span> guide_legend</span><span>(</span><span>title </span><span>=</span><span> </span><span>"Percent Expressed"</span><span>))</span><span> </span><span>+</span></span></code><code><span><span>  labs</span><span>(</span><span>x </span><span>=</span><span> </span><span>"Features"</span><span>,</span><span> y </span><span>=</span><span> ifelse</span><span>(</span><span>test </span><span>=</span><span> </span><span>is</span><span>.</span><span>null</span><span>(</span><span>x </span><span>=</span><span> split</span><span>.</span><span>by</span><span>),</span><span>yes </span><span>=</span><span> </span><span>"Identity"</span><span>,</span><span> </span><span>no</span><span> </span><span>=</span><span> </span><span>"Split Identity"</span><span>))+</span></span></code><code><span><span>  theme_cowplot</span><span>()+</span></span></code><code><span><span>  scale_color_gradient</span><span>(</span><span>low </span><span>=</span><span> cols</span><span>[</span><span>1</span><span>],</span><span> high </span><span>=</span><span> cols</span><span>[</span><span>2</span><span>])</span></span></code><code><span><br></span></code></pre></section><p><img data-galleryid="" data-ratio="0.5222929936305732" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/y7JAiaUuGxMwqqJ7CWGXOSvSVGcGibeyGoFaoJPA4RVBibWmq9ubDbcfMTGo8x5ABCfBKF39UTV31dMsNIsX7Zelw/640?wx_fmt=png" data-type="png" data-w="3454" src="https://mmbiz.qpic.cn/mmbiz_png/y7JAiaUuGxMwqqJ7CWGXOSvSVGcGibeyGoFaoJPA4RVBibWmq9ubDbcfMTGo8x5ABCfBKF39UTV31dMsNIsX7Zelw/640?wx_fmt=png"></p><figure><figcaption></figcaption></figure></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/mx17BwlNLVlQ1yB01_yygQ",target="_blank" rel="noopener noreferrer">原文链接</a>
