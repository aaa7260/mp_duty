---
title: "天哪！GSEA运行可以这么快！"
date: 2024-02-29T11:06:49Z
draft: ["false"]
tags: [
  "fetched",
  "果子学生信"
]
categories: ["Acdemic"]
---
天哪！GSEA运行可以这么快！ by 果子学生信
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">GSEA在我脑中一直是一个比较耗时，而且也消耗内存的工作。很多年之前果子老师，让我帮他写并行代码，进行GSEA分析，然后我发现当时的128G内存不够，溢出了。</p><p data-tool="mdnice编辑器">最近我突然想到，能不能再python中做GSEA分析呢？于是我搜了下，发现还真有！名字叫GSEApy, 对应文章是”Zhuoqing Fang, Xinyuan Liu, Gary Peltz, GSEApy: a comprehensive package for performing gene set enrichment analysis in Python,Bioinformatics, 2022;, btac757, https://doi.org/10.1093/bioinformatics/btac757“，也是刚发表不到1年。</p><blockquote data-tool="mdnice编辑器"><p>GSEA是描述基因表达变化的常用算法。然而，目前用于执行 GSEA 的工具分析大型数据集的能力有限，这在分析单细胞数据时尤其成问题。为了克服这一局限，我们用 Python 开发了一个 GSEA 软件包（GSEApy），它可以高效地分析大型单细胞数据集。GSEA。GSEApy 使用 Rust 实现，能够计算与 GSEA 相同的路径集合富集统计量。GSEApy 的 Rust 实现比 GSEApy 的 Numpy 版本（v0.10.8）快 3 倍，内存使用量少 4 倍以上</p></blockquote><p data-tool="mdnice编辑器">更为惊喜的是，我发现这个GSEApy的底层实现居然还是Rust，一门高性能的编程语言，那么到底速度如何呢？我用的果子老师的数据，做了测试。</p><p data-tool="mdnice编辑器">如下是R版本的代码</p><pre data-tool="mdnice编辑器"><span></span><code><span>### GSEA 分析</span><br>load(file = <span>"./DEseq2_ESR1_Diff.Rdata"</span>)<br><span>library</span>(dplyr)<br>gene_df &lt;- res %&gt;% <br>  dplyr::select(gene_id,logFC,gene) %&gt;% <br>  <span>## 去掉NA</span><br>  filter(gene!=<span>""</span>) %&gt;% <br>  <span>## 去掉重复</span><br>  distinct(gene,.keep_all = <span>T</span>)<br><br><span>### 1.获取基因logFC</span><br>geneList &lt;- gene_df$logFC<br><span>### 2.命名</span><br>names(geneList) = gene_df$gene<br><span>## 3.排序很重要</span><br>geneList = sort(geneList, decreasing = <span>TRUE</span>)<br><br>head(geneList)<br><span>library</span>(clusterProfiler)<br><br><span>### GSEA 分析</span><br><br>start_time &lt;- Sys.time()<br>hallmarks &lt;- read.gmt(<span>"./h.all.v7.1.symbols.gmt"</span>)<br>gseahallmarks &lt;- GSEA(geneList,TERM2GENE =hallmarks)<br><span># 获取程序结束时间</span><br>end_time &lt;- Sys.time()<br><br><span># 计算程序执行时间</span><br>execution_time &lt;- end_time - start_time<br><br><span># 输出程序执行时间</span><br>print(execution_time)<br><span># Time difference of 24.17011 secs</span><br></code></pre><p data-tool="mdnice编辑器">接着，我们试试python版本的GSEA，首先要安装GSEA</p><pre data-tool="mdnice编辑器"><span></span><code>pip install gseapy<br></code></pre><p data-tool="mdnice编辑器">代码如下，其中geneList是让GPT模仿R版本的预处理代码编写，gp.prerank是我修改自官方教程</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> pandas <span>as</span> pd<br><br><span># Assuming you have a DataFrame called 'res' in Python</span><br><span># that corresponds to your 'gene_df' in R</span><br>res = pd.read_csv(<span>"E:/gsea_analysis/DEseq2_ESR1_Diff.csv"</span>)<br><span># Select the columns 'gene_id', 'logFC', and 'gene'</span><br>gene_df = res[[<span>'gene_id'</span>, <span>'logFC'</span>, <span>'gene'</span>]]<br><br><span># Filter out rows where 'gene' is not empty,NaN </span><br>gene_df = gene_df[gene_df[<span>'gene'</span>].isnull() == <span>False</span>]<br><br><span># Remove duplicates based on the 'gene' column</span><br>gene_df = gene_df.drop_duplicates(subset=[<span>'gene'</span>], keep=<span>'first'</span>)<br><br><span># 1. Get the 'logFC' values into a list</span><br>geneList = gene_df[<span>'logFC'</span>]<br>geneList.index = gene_df[<span>'gene'</span>]<br>geneList = geneList.sort_values(ascending=<span>False</span>)<br><br><br>start_time = time.time()<br>pre_res = gp.prerank(rnk= geneList , <span># or rnk = rnk,</span><br>                     gene_sets= <span>"E:/gsea_analysis/h.all.v7.1.symbols.gmt"</span>,<br>                     threads=<span>1</span>,<br>                     min_size=<span>5</span>,<br>                     max_size=<span>1000</span>,<br>                     permutation_num=<span>1000</span>, <span># reduce number to speed up testing</span><br>                     outdir=<span>None</span>, <span># don't write to disk</span><br>                     seed=<span>6</span>,<br>                     verbose=<span>True</span>, <span># see what's going on behind the scenes</span><br>                    )<br><span># Record the end time</span><br>end_time = time.time()<br><br><span># Calculate and print the execution time</span><br>execution_time = end_time - start_time<br>print(<span>"Execution Time: {:.2f} seconds"</span>.format(execution_time))<br><br><span># Execution Time: 2.13 seconds</span><br></code></pre><p data-tool="mdnice编辑器">从速度来说，R版本用了24秒，而gseapy只用了2秒多一点，几乎快了10倍多！那么结果一样吗？</p><p data-tool="mdnice编辑器">我分析了下，稍微还是有一些区别，但是不大。在gseapy的输出结果中，NOM p-val&lt;0.05的结果有22条，R版本的GSEA结果是20条，当然gseapy的22条都在GSEA中出现，但几乎可以忽略不计了！</p><p data-tool="mdnice编辑器">gseapy提供了一些画图函数，可以用来展示结果，比如说，我们需要绘制最常见的GSEA的结果图。</p><pre data-tool="mdnice编辑器"><span></span><code>term = <span>"HALLMARK_ESTROGEN_RESPONSE_LATE"</span><br>axs = pre_res.plot(terms= term, show_ranking=<span>True</span>) <span># v1.0.5</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.9831824062095731" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/NDy5aEnReX2pVkxEviabjZqFXibr1PM9gQ9hqyQAUCj1LjcbDCW5dJia9Wmg4uicjUv6zpJiakSGHmxaJfWosCGRKjQ/640?wx_fmt=png" data-type="png" data-w="773" src="https://mmbiz.qpic.cn/sz_mmbiz_png/NDy5aEnReX2pVkxEviabjZqFXibr1PM9gQ9hqyQAUCj1LjcbDCW5dJia9Wmg4uicjUv6zpJiakSGHmxaJfWosCGRKjQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">亦或者想看点图结果</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> matplotlib.pyplot <span>as</span> plt<br><span>from</span> gseapy <span>import</span> dotplot<br><span># to save your figure, make sure that ``ofname`` is not None</span><br>ax = dotplot(pre_res.res2d,<br>             column=<span>"FDR q-val"</span>,<br>             title=<span>'KEGG_2016'</span>,<br>             cmap=plt.cm.viridis,<br>             size=<span>6</span>, <span># adjust dot size</span><br>             figsize=(<span>4</span>,<span>5</span>), cutoff=<span>0.25</span>, show_ring=<span>False</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5814814814814815" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/NDy5aEnReX2pVkxEviabjZqFXibr1PM9gQIEScXIAvXksScJMJ35YzjuZmkNMarEHVAW9YVf0TvsTvDvYRMib27Ng/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/NDy5aEnReX2pVkxEviabjZqFXibr1PM9gQIEScXIAvXksScJMJ35YzjuZmkNMarEHVAW9YVf0TvsTvDvYRMib27Ng/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">亦或者是网络图</p><pre data-tool="mdnice编辑器"><span></span><code><span>from</span> gseapy <span>import</span> enrichment_map<br><span>import</span> networkx <span>as</span> nx<br><br>nodes, edges = enrichment_map(pre_res.res2d)<br>G = nx.from_pandas_edgelist(edges,<br>                            source=<span>'src_idx'</span>,<br>                            target=<span>'targ_idx'</span>,<br>                            edge_attr=[<span>'jaccard_coef'</span>, <span>'overlap_coef'</span>, <span>'overlap_genes'</span>])<br><br>fig, ax = plt.subplots(figsize=(<span>16</span>, <span>10</span>))<br><br><span># init node cooridnates</span><br>pos=nx.layout.spiral_layout(G)<br><span>#node_size = nx.get_node_attributes()</span><br><span># draw node</span><br>nx.draw_networkx_nodes(G,<br>                       pos=pos,<br>                       cmap=plt.cm.RdYlBu,<br>                       node_color=list(nodes.NES),<br>                       node_size=list(nodes.Hits_ratio *<span>1000</span>))<br><span># draw node label</span><br>nx.draw_networkx_labels(G,<br>                        pos=pos,<br>                        labels=nodes.Term.to_dict())<br><span># draw edge</span><br>edge_weight = nx.get_edge_attributes(G, <span>'jaccard_coef'</span>).values()<br>nx.draw_networkx_edges(G,<br>                       pos=pos,<br>                       width=list(map(<span>lambda</span> x: x*<span>10</span>, edge_weight)),<br>                       edge_color=<span>'#CDDBD4'</span>)<br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6203703703703703" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/NDy5aEnReX2pVkxEviabjZqFXibr1PM9gQDowwRTvo8G8nH8xvvv4dqhib7xI3hTCFCe2QU5gGxMqNWibkbldk1dUA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/NDy5aEnReX2pVkxEviabjZqFXibr1PM9gQDowwRTvo8G8nH8xvvv4dqhib7xI3hTCFCe2QU5gGxMqNWibkbldk1dUA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">但是，假设，你更偏好于用R进行可视化，比如说用Y叔开发的 enrichplot 画图，所以我写了一小段代码，输出结果，用于cluterProfiler画图。</p><p data-tool="mdnice编辑器">首先，将GSEApy的结果保存成csv, 一个排序信息，一个是GSEA运行结果</p><pre data-tool="mdnice编辑器"><span></span><code>pre_res.ranking.to_csv(<span>"./geneList.csv"</span>)<br>pre_res.res2d.to_csv(<span>"./gseapy.csv"</span>, index=<span>False</span>)<br></code></pre><p data-tool="mdnice编辑器">然后在R语言中，我们读取保存的文件，然后自己用<code>new</code>创建一个gseaResult，只不过数据来自于GSEApy</p><pre data-tool="mdnice编辑器"><span></span><code>df &lt;- read.csv(<span>"./gseapy.csv"</span>)<br><br><span># 读取gene排序</span><br>geneList_df &lt;- read.csv(<span>"./geneList.csv"</span>)<br>geneList &lt;- geneList_df$prerank<br>names(geneList) &lt;- geneList_df$gene_name  <br><br><span># hallmarks ，也就似乎基因集信息</span><br>hallmarks &lt;- read.gmt(<span>"./h.all.v7.1.symbols.gmt"</span>)<br>gene_sets &lt;- split(hallmarks$gene, hallmarks$term)<br><br><br><span># 输出结果的result</span><br>result &lt;- data.frame(<br>  <span>"ID"</span> = df$Term ,<br>  <span>"Description"</span>= df$Term ,<br>  <span>"setSize"</span>= sapply(strsplit(df$Tag.., <span>"/"</span>), <span>function</span>(x) as.numeric(x[<span>2</span>])),<br>  <span>"enrichmentScore"</span>=df$ES,<br>  <span>"NES"</span>= df$NES,<br>  <span>"pvalue"</span>= df$NOM.p.val, <br>  <span>"p.adjust"</span>=df$FDR.q.val,<br>  <span>"qvalue"</span>=df$FWER.p.val,<br>  <span>"rank"</span>= <span>1</span>,<br>  <span>"leading_edge"</span>= <span>""</span>,<br>  <span>"core_enrichment"</span> = gsub(<span>";"</span>,<span>"/"</span>,df$Lead_genes)<br>)<br><br>rownames(result) &lt;- result$ID<br><span># 需要注意的是params，我设置了pvalueCutoff=1, 因为没有限制。</span><br>my_result &lt;- new(<span>"gseaResult"</span>, result = result,<br>                 geneSets=gene_sets,<br>                 geneList=geneList,<br>                 params = list(pvalueCutoff = <span>1</span>,  exponent = <span>1</span>, minGSSize=<span>10</span>, maxGSSize=<span>500</span>)<br>                 )<br></code></pre><p data-tool="mdnice编辑器">于是乎，神奇的事情就发生了，我们可以用 enrichplot 包的函数画图了！</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(enrichplot)<br><br>pathway.id = <span>"HALLMARK_ESTROGEN_RESPONSE_LATE"</span><br>p1 &lt;- gseaplot2(my_result, <br>          color = <span>"red"</span>,<br>          geneSetID = pathway.id,<br>          pvalue_table = <span>T</span>)<br><br>p2 &lt;- gseaplot2(gseahallmarks, <br>          color = <span>"blue"</span>,<br>          geneSetID = pathway.id,<br>          pvalue_table = <span>T</span>)<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.325" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/NDy5aEnReX2pVkxEviabjZqFXibr1PM9gQYq52pT2BJ5KXcCIPdOJ5VY2K4vQdUGQdD5ib4afp3HC173icFicuLSvicw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/NDy5aEnReX2pVkxEviabjZqFXibr1PM9gQYq52pT2BJ5KXcCIPdOJ5VY2K4vQdUGQdD5ib4afp3HC173icFicuLSvicw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">自此，鱼与熊掌兼得</p></section><p><br></p><p>PS：这部分神奇的操作已经被果子老师加入到他的单细胞课程中了。</p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyMzA2MTcwMg==&amp;mid=2650736848&amp;idx=1&amp;sn=80ef64299af6e080332b1a5a45ef1dea&amp;chksm=f0285b79c75fd26f94baf66e5b857d7549ad9f1fc807b06a32535708fd3f84017ec65ebc1c45&amp;scene=21#wechat_redirect" textvalue="果子单细胞课程招生，新世界的奇幻之旅！" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">果子单细胞课程招生，新世界的奇幻之旅！</a><br><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/nxkTXyKiK1h7ujTDipTLsQ",target="_blank" rel="noopener noreferrer">原文链接</a>
