---
title: "R语言SHAP模型解释"
date: 2024-02-28T04:00:48Z
draft: ["false"]
tags: [
  "fetched",
  "医学和生信笔记"
]
categories: ["Acdemic"]
---
R语言SHAP模型解释 by 医学和生信笔记
------
<div><section><span>关注公众号，发送</span><strong>R语言</strong><span>或</span><strong>python</strong><span>，可获取资料</span><span></span></section><section><mp-common-profile data-pluginname="mpprofile" data-id="MzUzOTQzNzU0NA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R9YDc8IDhqWAHTrZsMuhDpFlw4scqOl1ZVWpeY77cdibaSzPeGALfkEhdVpwHzVibHCRSYZg4csB43g/0?wx_fmt=png" data-nickname="医学和生信笔记" data-alias="yxhsxbj" data-signature="外科医生👨‍⚕️的R语言和生信学习🔖" data-from="2" data-weuitheme="light"></mp-common-profile></section><section data-role="outer" label="edit by 135editor"><section data-role="paragraph"><section data-role="outer" label="edit by 135editor"><section data-role="paragraph"><section data-role="outer" label="edit by 135editor"><section data-role="paragraph"><section data-role="outer"><section data-role="outer" label="edit by 135editor"><section data-tools="135编辑器" data-id="28"><p data-brushtype="text" hm_fix="440:185"><span>💡专注R语言在🩺生物医学中的使用</span></p></section></section></section></section></section><hr><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><span><span>设为“</span><strong><span>星标</span></strong><span>”，精彩不错过</span></span><br></p><hr><p data-tool="mdnice编辑器"><span><strong></strong></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">分解解释高度依赖于预测变量的顺序，解决方法有两个，一个是通过把最重要的变量放在最前面，另一种就是识别变量间的交互作用并使用专门的方法。</p><p data-tool="mdnice编辑器">但是以上两种方法都不是很好。所以出现了<strong>SHAP</strong>(SHapley AdditiveexPlanations)，中文称为<strong>Shaply加性解释</strong>。SHapley加性解释（SHAP）基于Shapley（人名）在博弈论中提出的“Shapley值（Shaply-values）”。SHAP是专为预测模型设计的方法的首字母缩写词。</p><p data-tool="mdnice编辑器">简单来说，Shaply加性解释就是<strong>计算变量间的所有可能的排列</strong>，然后计算每个变量的平均贡献（或者叫平均归因）。这种方法叫做重排（permutation）SHAP或者置换SHAP。</p><p data-tool="mdnice编辑器">作为一种与模型无关（model-agnostic）的解释，这种方法是适用于任何模型的，本文是以随机森林模型为例进行演示的。</p><p data-tool="mdnice编辑器">如果已经了解了分解解释的原理，那么这里的重排SHAP就非常好理解了。它的详细公式计算过程这里就不展示了，感兴趣的可以自己了解。</p><p data-tool="mdnice编辑器">今天先介绍下R中的instance-level的SHAP，依然是使用<code>DALEX</code>，3行代码解决！关于SHAP的内容其实还有非常多哈，以后再慢慢介绍。</p><p data-tool="mdnice编辑器">公众号后台回复<strong>shap</strong>即可获取SHAP解释合集。</p><pre data-tool="mdnice编辑器"><code><span>library</span>(DALEX)<br>data(<span>"titanic_imputed"</span>)<br><br><span># 结果变量变成因子型</span><br>titanic_imputed$survived &lt;- factor(titanic_imputed$survived)<br><br>dim(titanic_imputed)<br></code></pre><pre data-tool="mdnice编辑器"><code>[1] 2207    8<br></code></pre><pre data-tool="mdnice编辑器"><code>str(titanic_imputed)<br></code></pre><pre data-tool="mdnice编辑器"><code>'data.frame':   2207 obs. of  8 variables:<br> $ gender  : Factor w/ 2 levels "female","male": 2 2 2 1 1 2 2 1 2 2 ...<br> $ age     : num  42 13 16 39 16 25 30 28 27 20 ...<br> $ class   : Factor w/ 7 levels "1st","2nd","3rd",..: 3 3 3 3 3 3 2 2 3 3 ...<br> $ embarked: Factor w/ 4 levels "Belfast","Cherbourg",..: 4 4 4 4 4 4 2 2 2 4 ...<br> $ fare    : num  7.11 20.05 20.05 20.05 7.13 ...<br> $ sibsp   : num  0 0 1 1 0 0 1 1 0 0 ...<br> $ parch   : num  0 2 1 1 0 0 0 0 0 0 ...<br> $ survived: Factor w/ 2 levels "0","1": 1 1 1 2 2 2 1 2 2 2 ...<br></code></pre><p data-tool="mdnice编辑器">建立一个随机森林模型：</p><pre data-tool="mdnice编辑器"><code><span>library</span>(randomForest)<br><br>set.seed(<span>123</span>)<br>titanic_rf &lt;- randomForest(survived ~ ., data = titanic_imputed)<br></code></pre><p data-tool="mdnice编辑器">建立解释器：</p><pre data-tool="mdnice编辑器"><code>explain_rf &lt;- DALEX::explain(model = titanic_rf,<br>                             data = titanic_imputed[,-<span>8</span>],<br>                             y = titanic_imputed$survived == <span>1</span>,<br>                             label = <span>"randomforest"</span><br>                             )<br></code></pre><pre data-tool="mdnice编辑器"><code>Preparation of a new explainer is initiated<br>  -&gt; model label       :  randomforest <br>  -&gt; data              :  2207  rows  7  cols <br>  -&gt; target variable   :  2207  values <br>  -&gt; predict function  :  yhat.randomForest  will be used (  default  )<br>  -&gt; predicted values  :  No value for predict function target column. (  default  )<br>  -&gt; model_info        :  package randomForest , ver. 4.7.1.1 , task classification (  default  ) <br>  -&gt; model_info        :  Model info detected classification task but 'y' is a logical . Converted to numeric.  (  NOTE  )<br>  -&gt; predicted values  :  numerical, min =  0 , mean =  0.2350131 , max =  1  <br>  -&gt; residual function :  difference between y and yhat (  default  )<br>  -&gt; residuals         :  numerical, min =  -0.886 , mean =  0.08714363 , max =  1  <br>  A new explainer has been created!<br></code></pre><p data-tool="mdnice编辑器">使用<code>predict_parts</code>解释，方法选择SHAP：</p><pre data-tool="mdnice编辑器"><code>shap_rf &lt;- predict_parts(explainer = explain_rf,<br>                         new_observation = titanic_imputed[<span>15</span>,-<span>8</span>],<br>                         type = <span>"shap"</span>,<br>                         B = <span>25</span> <span># 选择多少个排列组合</span><br>                         )<br><br>shap_rf<br></code></pre><pre data-tool="mdnice编辑器"><code>                                              min           q1      median<br>randomforest: age = 18               -0.010423199  0.006507476  0.02422882<br>randomforest: class = 3rd            -0.201079293 -0.126367830 -0.06920344<br>randomforest: embarked = Southampton -0.022489352 -0.010681242 -0.01012868<br>randomforest: fare = 9.07            -0.154593566 -0.058991844 -0.02455460<br>randomforest: gender = female         0.293671047  0.384545537  0.43246217<br>randomforest: parch = 1              -0.031936565  0.080251817  0.10775804<br>randomforest: sibsp = 0               0.008140462  0.014347757  0.02413484<br>                                             mean            q3         max<br>randomforest: age = 18                0.067138668  0.1240188038  0.19714907<br>randomforest: class = 3rd            -0.090971092 -0.0672904395 -0.01977254<br>randomforest: embarked = Southampton -0.006165292 -0.0006504304  0.01238423<br>randomforest: fare = 9.07            -0.037531346 -0.0193303126  0.04265791<br>randomforest: gender = female         0.436079928  0.4822868147  0.54142003<br>randomforest: parch = 1               0.092327612  0.1308228364  0.17770367<br>randomforest: sibsp = 0               0.028108382  0.0478994110  0.05099230<br></code></pre><p data-tool="mdnice编辑器">画图：</p><pre data-tool="mdnice编辑器"><code>plot(shap_rf)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100017301" data-ratio="0.7142857142857143" data-type="png" data-w="672" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8WE3ibcwhXvgygSU49iapg7ASceOia9QGFUPTXicM4LludNw5NpDMlrEYyd8gKjgOcO3KribIAxlOqPmw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8WE3ibcwhXvgygSU49iapg7ASceOia9QGFUPTXicM4LludNw5NpDMlrEYyd8gKjgOcO3KribIAxlOqPmw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">这个图中的箱线图表示预测变量在所有排列的分布情况，条形图表示平均值，也就是shaply值。</p><p data-tool="mdnice编辑器">还可以不展示箱线图：</p><pre data-tool="mdnice编辑器"><code>plot(shap_rf, show_boxplots = <span>F</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100017302" data-ratio="0.7142857142857143" data-type="png" data-w="672" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8WE3ibcwhXvgygSU49iapg7AycobWs2KicVg1fYRO5O8GC5cggQ8pHj4rEOrwkHfCgQJlbsx4MhEFwg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8WE3ibcwhXvgygSU49iapg7AycobWs2KicVg1fYRO5O8GC5cggQ8pHj4rEOrwkHfCgQJlbsx4MhEFwg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><code>DALEX</code>中的<code>plot</code>函数对<code>ggplot2</code>的包装，是可以直接连接<code>ggplot2</code>语法的。</p><p data-tool="mdnice编辑器">除此之外，我们也可以提取数据自己画图。</p><pre data-tool="mdnice编辑器"><code><span>library</span>(tidyverse)<br><span>library</span>(ggsci)<br><br>shap_rf %&gt;% <br>  as.data.frame() %&gt;% <br>  mutate(mean_con = mean(contribution), .by = variable) %&gt;% <br>  mutate(variable = fct_reorder(variable, abs(mean_con))) %&gt;% <br>  ggplot() +<br>  geom_bar(data = \(x) distinct(x,variable,mean_con),<br>           aes(mean_con, variable,fill= mean_con &gt; <span>0</span>), alpha = <span>0.5</span>,<br>           stat = <span>"identity"</span>)+<br>  geom_boxplot(aes(contribution,variable,fill= mean_con &gt; <span>0</span>), width = <span>0.4</span>)+<br>  scale_fill_lancet()+<br>  labs(y = <span>NULL</span>)+<br>  theme(legend.position = <span>"none"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100017303" data-ratio="0.7142857142857143" data-type="png" data-w="672" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8WE3ibcwhXvgygSU49iapg7AichpZxuJhNrYHF6EZ6tDLRSd7BicSd48dviajYhFvZTwBbNUlGH0icJ1lA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8WE3ibcwhXvgygSU49iapg7AichpZxuJhNrYHF6EZ6tDLRSd7BicSd48dviajYhFvZTwBbNUlGH0icJ1lA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">OVER！</p><p data-tool="mdnice编辑器">SHAP的使用率非常高，在R语言中也有非常多实现SHAP的包，我会写多篇推文，把常用的全都介绍一遍。</p></section><hr><blockquote><p><span><strong>联系我们，关注我们</strong></span></p><ol><li><section>免费QQ交流群1：613637742</section></li><li><section>免费QQ交流群2：608720452</section></li><li><section>公众号消息界面关于作者获取联系方式</section></li><li><section>知乎、CSDN、简书同名账号</section></li><li><section>哔哩哔哩：阿越就是我</section></li></ol></blockquote></section></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/vibNxgcs3MyduoNacuW7Bw",target="_blank" rel="noopener noreferrer">原文链接</a>
