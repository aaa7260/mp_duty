---
title: "先差异后GSEA呢还是先ssGSEA后差异呢"
date: 2024-02-03T05:01:20Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
先差异后GSEA呢还是先ssGSEA后差异呢 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>转录组等表达量数据处理大家都是蛮熟悉的了，无论是传统的芯片还是转录组测序，最后都是得到一些样品在几万个基因的表达量矩阵。一般来说，样品需要有分组，这样才有差异分析的可能，最简单的就是处理和对照的二分组。</p></blockquote><p data-tool="mdnice编辑器">如果我们想搞清楚处理前后到底两个分组有什么差异，其实可选的数据分析路线还蛮多的：</p><ul data-tool="mdnice编辑器"><li><section>方案1：分组做一个差异分析，根据阈值确定统计学显著的几百个上下调基因，然后分别注释其功能</section></li><li><section>方案2：分组做一个差异分析，根据变化情况把几万个基因排序后，进行gsea分析来确定上下调通路功能</section></li><li><section>方案3：针对每个样品的基因表达量排序进行ssGSEA分析，然后对ssGSEA打分矩阵根据分组进行差异分析</section></li></ul><p data-tool="mdnice编辑器">我们一直以来都是给大家前面的两个方案，就是一定要先根据表达量矩阵做不同分组的差异，而且两者的结果一致性都还不错。但是前面的两个方案都会手动一个批次效应的影响，如果大家没有把握好其中的批次效应的去除，很容易在差异分析阶段就不小心引入了错误。</p><p data-tool="mdnice编辑器">实际上，最后的方案，就是针对每个样品的基因表达量排序进行ssGSEA分析，然后对ssGSEA打分矩阵根据分组进行差异分析理论上可以跨越批次效应的，而且如果它的结果跟前面的两个方案差异也不大，我们后续遇到了无法去除的批次效应情况就可以走它了。</p><h3 data-tool="mdnice编辑器"><span></span>这里仍然是以airway数据集为例子<span></span></h3><p data-tool="mdnice编辑器">airway数据集可以说是最出名的转录组测序数据了，因为各大教程和授课资料都是以它为案例来讲解转录组差异分析，它就在 airway的包里面，如下所示的代码：</p><pre data-tool="mdnice编辑器"><span></span><code><br><span># 1.构建表达矩阵 ----------------------------------------------------------------</span><br>dir.create(<span>"./data"</span>)<br><br><span># 魔幻操作，一键清空</span><br>rm(list = ls()) <br>options(stringsAsFactors = <span>F</span>)<br><span># BiocManager::install('airway')</span><br><span># 加载airway数据集并转换为表达矩阵</span><br><span>library</span>(airway,quietly = <span>T</span>)<br>data(airway)<br>class(airway)<br><br>rawcount &lt;- assay(airway)<br>colnames(rawcount)<br><br><span># 查看表达谱</span><br>rawcount[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br><span># 去除前的基因表达矩阵情况</span><br>dim(rawcount)<br><br><span># 获取分组信息</span><br>group_list &lt;- colData(airway)$dex<br>group_list<br><br><span># 过滤在至少在75%的样本中都有表达的基因</span><br>keep &lt;- rowSums(rawcount&gt;<span>0</span>) &gt;= floor(<span>0.75</span>*ncol(rawcount))<br>table(keep)<br><br>filter_count &lt;- rawcount[keep,]<br>filter_count[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>dim(filter_count)<br><br><span># 加载edgeR包计算counts per millio(cpm) 表达矩阵,并对结果取log2值</span><br><span>library</span>(edgeR)<br>express_cpm &lt;- log2(cpm(filter_count)+<span>1</span>)<br>express_cpm[<span>1</span>:<span>6</span>,<span>1</span>:<span>6</span>]<br><br><span># 保存表达矩阵和分组结果</span><br>save(filter_count,<br>     express_cpm,<br>     group_list,<br>     file = <span>"./data/Step01-airwayData.Rdata"</span>) <br></code></pre><p data-tool="mdnice编辑器">大家可以先自行理解这个airway数据集，它的转录组测序数据也是公开可以获取的， 可以看我们的数据分析实战系列教程，目录如下所示：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514751&amp;idx=2&amp;sn=6e08d54d1a8e8ab8bc8a8fa595746ce2&amp;scene=21#wechat_redirect" data-linktype="2">（零）：RNA-seq流程前的准备——Linux与R的环境创建</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514751&amp;idx=3&amp;sn=3444c04722abc568992e6d0f5c65ce2c&amp;scene=21#wechat_redirect" data-linktype="2">（一）：上游数据下载、格式转化和质控清洗</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514824&amp;idx=1&amp;sn=e5648a7cf9f1215a1abdf098de8f375a&amp;scene=21#wechat_redirect" data-linktype="2">（二）：上游数据的比对计数——Hisat2+ featureCounts 与 Salmon</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514824&amp;idx=2&amp;sn=916bbd9e5fe778a0ad51ec8a64fbfadd&amp;scene=21#wechat_redirect" data-linktype="2">（三）：在R里面整理表达量counts矩阵</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514857&amp;idx=4&amp;sn=dcd9ea3efe72502e8ee885088993d854&amp;scene=21#wechat_redirect" data-linktype="2">（四）：差异分析前的准备——数据检查</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514857&amp;idx=5&amp;sn=6c9caffc411fbe459a30ca38140a1166&amp;scene=21#wechat_redirect" data-linktype="2">（五）：差异分析——DESeq2 edgeR limma的使用与比较</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514903&amp;idx=2&amp;sn=ce5a89b0d69bccc2f852946ff1a80a6e&amp;scene=21#wechat_redirect" data-linktype="2">（六）：GO、KEGG富集分析与enrichplot超全可视化攻略</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514903&amp;idx=3&amp;sn=f284597b9b7d152152a40fc8f75902ee&amp;scene=21#wechat_redirect" data-linktype="2">（七）：GSEA——基因集富集分析</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514959&amp;idx=2&amp;sn=76ba7b67967b20fe186afa28fa5992eb&amp;scene=21#wechat_redirect" data-linktype="2">（八）：GSVA——基因集变异分析</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514959&amp;idx=3&amp;sn=d7f0594f07e3051e30f779a08f4ce042&amp;scene=21#wechat_redirect" data-linktype="2">（九）：PPI蛋白互作网络构建（上）——STRING数据库的使用</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514989&amp;idx=3&amp;sn=4a36a1c60cc50dd41499d8a6b04a73e5&amp;scene=21#wechat_redirect" data-linktype="2">（十）：PPI蛋白互作网络构建（下）——Cytoscape软件的使用</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514989&amp;idx=4&amp;sn=6bba059b0de9280da520e2f3862b653e&amp;scene=21#wechat_redirect" data-linktype="2">（十一）：WGCNA加权基因共表达网络分析——关联基因模块与表型</a></section></li></ul><p data-tool="mdnice编辑器">前面我们提到了可选的数据分析路线有3个：</p><ul data-tool="mdnice编辑器"><li><section>方案1：分组做一个差异分析，根据阈值确定统计学显著的几百个上下调基因，然后分别注释其功能</section></li><li><section>方案2：分组做一个差异分析，根据表达量变化情况把几万个基因排序后，进行gsea分析来确定上下调通路功能</section></li><li><section>方案3：针对每个样品的基因表达量排序进行ssGSEA分析，然后对ssGSEA打分矩阵根据分组进行差异分析</section></li></ul><p data-tool="mdnice编辑器">前面的两个方案都需要做差异分析，接下来我们就走转录组差异分析</p><h3 data-tool="mdnice编辑器"><span></span>先差异后GSEA<span></span></h3><p data-tool="mdnice编辑器">转录组差异分析，我们针对测序的counts矩阵，走DESeq2这个r包的方法：</p><pre data-tool="mdnice编辑器"><span></span><code> <br>exprSet &lt;- filter_count<br>dim(exprSet)<br>exprSet[<span>1</span>:<span>6</span>,<span>1</span>:<span>6</span>]<br>table(group_list)<br><br><span># 加载包</span><br><span>library</span>(DESeq2)<br><br><span># 第一步，构建DESeq2的DESeq对象</span><br>colData &lt;- data.frame(row.names=colnames(exprSet),group_list=group_list)<br>dds &lt;- DESeqDataSetFromMatrix(countData = exprSet,colData = colData,design = ~ group_list)<br><br><span># 第二步，进行差异表达分析</span><br>dds2 &lt;- DESeq(dds)<br><br><span># 提取差异分析结果，trt组对untrt组的差异分析结果</span><br>tmp &lt;- results(dds2,contrast=c(<span>"group_list"</span>,<span>"trt"</span>,<span>"untrt"</span>))<br>DEG_DESeq2 &lt;- as.data.frame(tmp[order(tmp$padj),])<br>head(DEG_DESeq2)<br><br><span># 去除差异分析结果中包含NA值的行</span><br>DEG_DESeq2 = na.omit(DEG_DESeq2) <br>head(DEG_DESeq2)<br><span>library</span>(AnnoProbe)<br>ag=annoGene(rownames(DEG_DESeq2),<br>         ID_type = <span>'ENSEMBL'</span>,species = <span>'human'</span><br>            )<br>head(ag)<br>DEG_DESeq2$ENSEMBL=rownames(DEG_DESeq2)<br> <br>deg_anno=merge(ag,DEG_DESeq2,by=<span>'ENSEMBL'</span>)<br>head(deg_anno)<br><span># 保存 </span><br>save(deg_anno, file = <span>"./data/Step03-DESeq2_nrDEG.Rdata"</span>)<br><br></code></pre><p data-tool="mdnice编辑器">有了差异分析结果，我们先走方案2：分组做一个差异分析，根据变化情况把几万个基因排序后，进行gsea分析来确定上下调通路功能：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>options(stringsAsFactors = <span>F</span>)<br>load(file = <span>"./data/Step03-DESeq2_nrDEG.Rdata"</span>) <br><br><span>library</span>(clusterProfiler)<br><span>library</span>(org.Hs.eg.db)<br><span># 转成ENTREZID</span><br>df &lt;- bitr(unique(deg_anno$SYMBOL), fromType = <span>"SYMBOL"</span>,<br>           toType = c( <span>"ENTREZID"</span>),<br>           OrgDb = org.Hs.eg.db) <br>DEG=merge(deg_anno,df,by=<span>'SYMBOL'</span>)<br>colnames(DEG)<br>data_all_sort &lt;- DEG %&gt;%  <span>#排序</span><br>  arrange(desc(log2FoldChange))<br>geneList = data_all_sort$log2FoldChange <span>#把foldchange按照从大到小提取出来</span><br>names(geneList) &lt;- data_all_sort$ENTREZID <span>#给上面提取的foldchange加上对应上ENTREZID</span><br>head(geneList) <span>#排序好的基因序列，而且是entrezeID的形式</span><br><br>R.utils::setOption( <span>"clusterProfiler.download.method"</span>,<span>'auto'</span> )<br>kkgsea &lt;- gseKEGG(geneList     = geneList,<br>               organism     = <span>'hsa'</span>, <br>               minGSSize    = <span>3</span>,<br>               maxGSSize    = <span>5000</span>,<br>               pvalueCutoff = <span>1</span>,<br>               pAdjustMethod = <span>"none"</span> ) <span>#进行gseKEGG富集分析 </span><br>tmp = kkgsea@result<br>save(kkgsea,file = <span>'gsea_kk.Rdata'</span>) <br></code></pre><p data-tool="mdnice编辑器">一般来说，这个 clusterProfiler 包里面的gseKEGG会在线获取kegg数据库的三百多通路，并且全部进行fix。</p><h3 data-tool="mdnice编辑器"><span></span>先ssGSEA后差异<span></span></h3><p data-tool="mdnice编辑器">这里我们针对测序的counts矩阵，走GSVA包的ssGSEA分析，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>options(stringsAsFactors = <span>F</span>) <br>load(file = <span>"./data/Step01-airwayData.Rdata"</span>)<br>express_cpm[<span>1</span>:<span>6</span>,<span>1</span>:<span>6</span>]<br>table(group_list)<br><br><span>library</span>(msigdbr)  <span>#install.packages("msigdbr")</span><br><span>library</span>(GSVA) <br><span>library</span>(GSEABase)<br><span>library</span>(pheatmap)<br><span>library</span>(limma) <br><br><span>## msigdbr包提取下载  KEGG数据集</span><br>KEGG_df_all &lt;-  msigdbr(species = <span>"Homo sapiens"</span>, <span># Homo sapiens or Mus musculus</span><br>                        category = <span>"C2"</span>,<br>                        subcategory = <span>"CP:KEGG"</span>) <br>colnames(KEGG_df_all)<br>KEGG_df &lt;- dplyr::select(KEGG_df_all,gs_exact_source,gs_exact_source,ensembl_gene)  <br>kegg_list &lt;- split(KEGG_df$ensembl_gene, KEGG_df$gs_exact_source)  <br>kegg_list<br> <br>names(kegg_list)<br>ssgsea_mat &lt;- gsva(expr=express_cpm, <br>                 method=<span>'ssgsea'</span>,<br>                 gset.idx.list=kegg_list,  <br>                 verbose=<span>T</span>, <br>                 parallel.sz = <span>4</span> )<span>#调用所有核，行名变成通路名</span><br>ssgsea_mat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span>library</span>(limma)<br>g=factor( group_list ,levels = c(<span>'untrt'</span>,<span>'trt'</span>))<br>design=model.matrix(~g)<br>fit=lmFit(ssgsea_mat,design)<br>fit=eBayes(fit)<br><span>## 上面是limma包用法的一种方式 </span><br>options(digits = <span>4</span>) <span>#设置全局的数字有效位数为4</span><br><span>#topTable(fit,coef=2,adjust='BH') </span><br>ssgsea_deg = topTable(fit,coef=<span>2</span>,adjust=<span>'BH'</span>, n=<span>Inf</span>) <br>save(ssgsea_deg,file = <span>'ssgsea_deg.Rdata'</span>) <br></code></pre><p data-tool="mdnice编辑器">因为是msigdbr包提取下载KEGG数据集，所以通路就不到两百个哦。</p><h3 data-tool="mdnice编辑器"><span></span>对比一下<span></span></h3><p data-tool="mdnice编辑器">因为两次分析选取的kegg数据源头不一样，所以需要根据ID进行简单的交集：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>options(stringsAsFactors = <span>F</span>) <br>load(file = <span>'ssgsea_deg.Rdata'</span>)<br>load(file = <span>'gsea_kk.Rdata'</span>)<br><br>deg_gsea = kkgsea@result<br>gsea_deg = ssgsea_deg<br><br>ids = intersect(rownames(deg_gsea),<br>                rownames(ssgsea_deg)) <span>#186条中有184条，换了个富集源，从40显著增加</span><br><br><span># 02构建可视化所需的矩阵（相关性就两行值）</span><br>df=data.frame(<br>  ssgsea_deg=ssgsea_deg[ ids,<span>"logFC"</span>],<br>  deg_gsea=deg_gsea[ ids,<span>"enrichmentScore"</span>] <span>#就是两列logFC的值（散点图）</span><br>)<br>deg_gsea=deg_gsea[ ids,]<br>df$Description=deg_gsea$Description  <span>#加名字了的，可视化了的</span><br><br><span>library</span>(ggstatsplot)<br><span>#BiocManager::install("ggpmisc")</span><br><span>library</span>(ggpmisc)<br>p &lt;- ggplot(df, aes(x=ssgsea_deg,<br>                    deg_gsea)) +    <br>  geom_point() +<br>  labs(x = <span>"ssgsea_deg"</span>,<br>       y = <span>"deg_gsea"</span>)+<br>  scale_color_manual(values=c(<span>"blue"</span>, <span>"grey"</span>,<span>"red"</span>))+<br>  <span>#geom_vline(xintercept = c( -1.5,0,1.5),lty=4,col="#ec183b",lwd=0.8) +</span><br>  <span># geom_hline(yintercept =  c( -1.5,0,1.5),lty=4,col="#18a5ec",lwd=0.8) +</span><br>  <span>#xlim(-5,5)+</span><br>  ylim(-<span>1</span>,<span>1</span>)+<br>  theme_ggstatsplot()+<br>  theme(panel.grid.minor = element_blank(),<br>        panel.grid.major = element_blank())<br>p<br>p+stat_poly_eq(aes(label=paste(..eq.label..,..adj.rr.label..,..p.value.label..,sep = <span>"~~~~"</span>)),formula = y~x,parse=<span>T</span>,size=<span>3.0</span>)<br><br></code></pre><p data-tool="mdnice编辑器">可以看到， 两个策略得到的结果其实是大同小异：</p><p><img data-galleryid="" data-ratio="0.7205056179775281" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxg8OXicSPF52293k78Lia1qwF9VNUVRMEcHYmRVr4qTPpOkz4hgHTGGMqEFLQusk4mGCFm1omAicGPw/640?wx_fmt=png" data-type="png" data-w="1424" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxg8OXicSPF52293k78Lia1qwF9VNUVRMEcHYmRVr4qTPpOkz4hgHTGGMqEFLQusk4mGCFm1omAicGPw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>两个策略得到的结果其实是大同小异</figcaption></figure><p data-tool="mdnice编辑器">同理，大家也可以测试一下方案1和2的一致性，差异分析后的统计学显著的上下调基因分别独立去做GO或者KEGG数据库的超几何分布检验结果，跟上面提到的先差异后GSEA结果是否有很大区别。</p><p data-tool="mdnice编辑器">再次强调一下可选的数据分析路线有3个：</p><ul data-tool="mdnice编辑器"><li><section>方案1：分组做一个差异分析，根据阈值确定统计学显著的几百个上下调基因，然后分别注释其功能</section></li><li><section>方案2：分组做一个差异分析，根据表达量变化情况把几万个基因排序后，进行gsea分析来确定上下调通路功能</section></li><li><section>方案3：针对每个样品的基因表达量排序进行ssGSEA分析，然后对ssGSEA打分矩阵根据分组进行差异分析</section></li></ul><p data-tool="mdnice编辑器">你喜欢哪一个呢？</p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><span>文末友情宣传</span><br></p></section></section><p><br></p><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section> <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247515323&amp;idx=1&amp;sn=3f848867b3daffbca99050bf5287ea3a&amp;chksm=9b4bfc00ac3c7516e2de3045e229a538dd62847e40ee516afed73e966fef6e56feef329d1ee0&amp;scene=21#wechat_redirect" textvalue="数据挖掘（GEO,TCGA,单细胞）2022年暑期班（收官之作）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">数据挖掘（GEO,TCGA,单细胞）2022年暑期班（收官之作）</a>，快速了解一些生物信息学应用图表</section></li><li><section> <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247515331&amp;idx=1&amp;sn=e3d38ffe89d81e82d65e3669314c9ee4&amp;chksm=9b4bfc78ac3c756e78dce53a9c95c67b9a90c2a08df8c2052eea95022bfd105b6e5b0a1bec3c&amp;scene=21#wechat_redirect" textvalue="生信入门课-2022年暑期班（收官之作）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">生信入门课-2022年暑期班（收官之作）</a>，你的生物信息学第一课</section></li></ul><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/1tSSiHJWWj0Wc0zbBmgxdQ",target="_blank" rel="noopener noreferrer">原文链接</a>
