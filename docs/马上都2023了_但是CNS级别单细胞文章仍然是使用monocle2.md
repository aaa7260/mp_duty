---
title: "马上都2023了，但是CNS级别单细胞文章仍然是使用monocle2"
date: 2022-12-02T03:03:50Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
马上都2023了，但是CNS级别单细胞文章仍然是使用monocle2 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>很多人在交流群问到：自己的单细胞数据分析里面的拟时序环节使用了monocle2，会不会投稿时候被审稿人disss，毕竟monocle2的作者都在强力推荐monocle3这样的更新版本了。</p></blockquote><p data-tool="mdnice编辑器">其实大家简单的搜索就能发现 trapnell 实验室虽然出了 monocle3 ，而且写的很清楚：Monocle 2 and Monocle 3 alpha are deprecated，  Please use our new package, Monocle 3 ，如下所示的链接 ：</p><ul data-tool="mdnice编辑器"><li><section>http://cole-trapnell-lab.github.io/monocle-release/docs/#installing-monocle</section></li><li><section>https://cole-trapnell-lab.github.io/monocle3/docs/installation/</section></li></ul><p data-tool="mdnice编辑器">但是 monocle3 目前仍然是在 github上面，并不是在cran或者Bioconductor，它的安装方式是：</p><pre data-tool="mdnice编辑器"><span></span><code><span># install monocle3 through the cole-trapnell-lab GitHub, execute:</span><br>install.packages(<span>"devtools"</span>)<br>devtools::install_github(<span>'cole-trapnell-lab/monocle3'</span>)<br><br><span># If you wish to install the develop branch of monocle3, execute:</span><br>devtools::install_github(<span>'cole-trapnell-lab/monocle3'</span>, ref=<span>"develop"</span>)<br></code></pre><p data-tool="mdnice编辑器">对中国大陆地区的小伙伴来说，并不是很友好。而且它 依赖于一个过期的包，https://cran.r-project.org/src/contrib/Archive/Matrix.utils/ ，这样的话很多人（代码能力不够）压根就安装不上啊。</p><p data-tool="mdnice编辑器">反倒是 Monocle2就很友好啦，安装超级简单， 在bioconductor就有啊 ：https://bioconductor.org/packages/release/bioc/html/monocle.html</p><pre data-tool="mdnice编辑器"><span></span><code><span>if</span> (!require(<span>"BiocManager"</span>, quietly = TRUE))<br>    install.packages(<span>"BiocManager"</span>)<br><br>BiocManager::install(<span>"monocle"</span>)<br></code></pre><p data-tool="mdnice编辑器">目前我看到的这个monocle是  2.26.0 版本 ，如果大家的R版本跟这个冲突，似乎也是让初学者头疼的事情。</p><p data-tool="mdnice编辑器">不过，使用起来也是标准代码即可，而且结果的解读都是我们反复分享过的。这个拟时序分析流程，我们早就在前面的教程：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247509858&amp;idx=2&amp;sn=476461cd7b7b77febf32b14884bb7b6d&amp;scene=21#wechat_redirect" data-linktype="2">拟时序分析就是差异分析的细节剖析</a>，我们展现了一个表达量矩阵如何去走<strong>Monocle2分析</strong>，通常我们的表达量矩阵在seurat对象里面， 首先导出，然后构建Monocle2对象，过滤细胞，选择基因，然后降维的时候选择默认DDRTree算法即可。</p><h3 data-tool="mdnice编辑器"><span></span>而且有大量CNS文章给你背书<span></span></h3><p data-tool="mdnice编辑器">完全不惧往往是门外汉的审稿人啊，比如张泽民的最新nature单细胞文章：《<strong>Liver tumour immune microenvironment subtypes and neutrophil heterogeneity</strong>》，就是3个算法一起使用：</p><p><img data-galleryid="" data-ratio="0.6709677419354839" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwR5OHF86mVuDsZMbd409KMaQF5AqiceqTOH1nQk57icg5ViaICraNdicQkbDCWrLSRDeBJJQy4AyaQNA/640?wx_fmt=png" data-type="png" data-w="930" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwR5OHF86mVuDsZMbd409KMaQF5AqiceqTOH1nQk57icg5ViaICraNdicQkbDCWrLSRDeBJJQy4AyaQNA/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>3个算法一起使用</figcaption></figure><p data-tool="mdnice编辑器">最后的结果如下所示：</p><p data-tool="mdnice编辑器"><strong>e</strong>, Monocle trajectories of neutrophils coloured by tissues (left), cluster identities (middle) and CytoTRACE scores (right).</p><p><img data-galleryid="" data-ratio="0.47553516819571867" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwR5OHF86mVuDsZMbd409KMI57ickk6TicuMicf5mbpNJWDNxERUBPibqUicficciaGPGAnkOhHSYwrAGQLw/640?wx_fmt=png" data-type="png" data-w="1308" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwR5OHF86mVuDsZMbd409KMI57ickk6TicuMicf5mbpNJWDNxERUBPibqUicficciaGPGAnkOhHSYwrAGQLw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>可视化</figcaption></figure><p data-tool="mdnice编辑器">Each dot represents a single cell. Cell orders are inferred based on the expression of the most variable genes across neutrophil clusters.</p><h3 data-tool="mdnice编辑器"><span></span>很简单的seurat对象直接走monocle2流程<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 一般来说，我们不会对seurat对象里面的全部的单细胞亚群进行拟时序</span><br><span># </span><br><span># seurat=subset(seurat,idents = c(1,3))</span><br>DimPlot(seurat)<br><br><span>#选择需要构建细胞分化轨迹的细胞类型（subset提取感兴趣的名字，上面已经准备好名字了）</span><br>expr_matrix=seurat@assays$RNA@counts<span>#使用counts表达值</span><br>sample_sheet&lt;-seurat@meta.data<span>#将实验信息赋值新变量</span><br>gene_annotation=data.frame(gene_short_name=rownames(seurat))<span>#构建一个含有基因名字的数据框</span><br>rownames(gene_annotation)=rownames(seurat)<span>#将上述数据框的行名赋值基因名字</span><br><br>pd &lt;- new(<span>"AnnotatedDataFrame"</span>, data = sample_sheet)<span>#将实验信息变量转化为monocel可以接收的对象</span><br>fd &lt;- new(<span>"AnnotatedDataFrame"</span>, data = gene_annotation)<span>#将基因注释变量转化为monocle可以接收的对象</span><br>cds &lt;- newCellDataSet(expr_matrix, phenoData = pd, featureData = fd,<br>                      expressionFamily=negbinomial.size())<span>#创建一个monocle的对象</span><br> <br>cds &lt;- estimateSizeFactors(cds)<br>cds &lt;- estimateDispersions(cds) <br><br><span># 并不是所有的基因都有作用，所以先进行挑选，合适的基因用来进行聚类。</span><br>disp_table &lt;- dispersionTable(cds)<br>unsup_clustering_genes &lt;- subset(disp_table, mean_expression &gt;= <span>0.1</span>)<br>cds &lt;- setOrderingFilter(cds, unsup_clustering_genes$gene_id)<br>plot_ordering_genes(cds) <br>plot_pc_variance_explained(cds, return_all = <span>F</span>) <span># norm_method='log'</span><br><span># 其中 num_dim 参数选择基于上面的PCA图</span><br>cds &lt;- reduceDimension(cds, max_components = <span>2</span>, num_dim = <span>6</span>,<br>                       reduction_method = <span>'tSNE'</span>, verbose = <span>T</span>)<br>cds &lt;- clusterCells(cds, num_clusters = <span>6</span>) <br>plot_cell_clusters(cds, <span>1</span>, <span>2</span> )<br>table(pData(cds)$Cluster) <br>colnames(pData(cds)) <br><span># seurat$RNA_snn_res.0.2</span><br>table(pData(cds)$Cluster,pData(cds)$RNA_snn_res.0.2)<br>plot_cell_clusters(cds, <span>1</span>, <span>2</span> )<br><br>save(cds,file = <span>'input_cds.Rdata'</span>)<br><br><span># 接下来很重要，到底是看哪个性状的轨迹</span><br>colnames(pData(cds))<br>table(pData(cds)$Cluster)<br>table(pData(cds)$Cluster,pData(cds)$RNA_snn_res.0.2)<br>plot_cell_clusters(cds, <span>1</span>, <span>2</span> )<br><br>pData(cds)$Cluster = pData(cds)$RNA_snn_res.0.2<br>Sys.time()<br>diff_test_res &lt;- differentialGeneTest(cds,<br>                                      fullModelFormulaStr = <span>"~Cluster"</span>)<br>Sys.time()<br><br><span># Select genes that are significant at an FDR &lt; 10%</span><br>sig_genes &lt;- subset(diff_test_res, qval &lt; <span>0.1</span>)<br>sig_genes=sig_genes[order(sig_genes$pval),]<br>head(sig_genes[,c(<span>"gene_short_name"</span>, <span>"pval"</span>, <span>"qval"</span>)] ) <br>cg=as.character(head(sig_genes$gene_short_name))  <br><br><span># 前面是找差异基因，后面是做拟时序分析</span><br><br><span># 第一步: 挑选合适的基因. 有多个方法，例如提供已知的基因集，这里选取统计学显著的差异基因列表</span><br>ordering_genes &lt;- row.names (subset(diff_test_res, qval &lt; <span>0.01</span>))<br>ordering_genes<br>cds &lt;- setOrderingFilter(cds, ordering_genes)<br>plot_ordering_genes(cds)<br>cds &lt;- reduceDimension(cds, max_components = <span>2</span>,<br>                       method = <span>'DDRTree'</span>)<br><br><span># 第二步: 降维。降维的目的是为了更好的展示数据。函数里提供了很多种方法,</span><br><span># 不同方法的最后展示的图都不太一样, 其中“DDRTree”是Monocle2使用的默认方法</span><br>cds &lt;- reduceDimension(cds, max_components = <span>2</span>,<br>                       method = <span>'DDRTree'</span>)<br><span># 第三步: 对细胞进行排序</span><br>cds &lt;- orderCells(cds)<br><span># 最后两个可视化函数，对结果进行可视化</span><br>plot_cell_trajectory(cds, color_by = <span>"Cluster"</span>)  <br>ggsave(<span>'monocle_cell_trajectory_for_Cluster.pdf'</span>)<br><br>length(cg)<br>plot_genes_in_pseudotime(cds[cg,],<br>                         color_by = <span>"Cluster"</span>) <br>ggsave(<span>'monocle_plot_genes_in_pseudotime_for_Cluster.pdf'</span>)<br><br><span># https://davetang.org/muse/2017/10/01/getting-started-monocle/</span><br><br>my_cds_subset=cds<br><span># pseudotime is now a column in the phenotypic data as well as the cell state</span><br>head(pData(my_cds_subset))<br><span># 这个differentialGeneTest会比较耗费时间</span><br>my_pseudotime_de &lt;- differentialGeneTest(my_cds_subset,<br>                                         fullModelFormulaStr = <span>"~sm.ns(Pseudotime)"</span>,<br>                                         cores = <span>1</span>)<br><span># 不知道为什么无法开启并行计算了</span><br>head(my_pseudotime_de)<br>save( my_cds_subset,my_pseudotime_de,file = <span>'output_of_monocle.Rdata'</span>)<br> <br></code></pre></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ZthqULYx1zg2eB46y9rFuQ",target="_blank" rel="noopener noreferrer">原文链接</a>
