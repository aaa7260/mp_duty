---
title: "单细胞测序 | RNA速率分析(scVelo)是个老大难"
date: 2023-04-19T12:22:52Z
draft: ["false"]
tags: [
  "fetched",
  "生信控"
]
categories: ["Acdemic"]
---
单细胞测序 | RNA速率分析(scVelo)是个老大难 by 生信控
------
<div><p><img data-ratio="0.15625" data-src="https://mmbiz.qpic.cn/mmbiz_gif/GXnBwOcM857kicu3mN7sf73m53xRalJjvkd6jjlWBRqHTic97up9smWS7lZjB6py0O5l0hus3g6lyiaCBdc6fCkcQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-w="640" src="https://mmbiz.qpic.cn/mmbiz_gif/GXnBwOcM857kicu3mN7sf73m53xRalJjvkd6jjlWBRqHTic97up9smWS7lZjB6py0O5l0hus3g6lyiaCBdc6fCkcQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></p><p><span>网上关于<strong>RNA速率分析</strong>的教程其实不少，要么没有测试数据，要么长篇大论不明所以，看来看去只觉得头冷(一头雾水)。但其实对于该分析，一张图就能解释的清：</span><br></p><figure><img data-ratio="0.39444444444444443" data-src="https://mmbiz.qpic.cn/mmbiz_png/GXnBwOcM855XgLnWz9PPAU1kdp9FvxDelPiaxAGEfJIdVenuCTPq8DK9qsPgT2H0jF3xutVZX6SKcrd724ficDWA/640?wx_fmt=png" data-type="png" data-w="1080" title="null" src="https://mmbiz.qpic.cn/mmbiz_png/GXnBwOcM855XgLnWz9PPAU1kdp9FvxDelPiaxAGEfJIdVenuCTPq8DK9qsPgT2H0jF3xutVZX6SKcrd724ficDWA/640?wx_fmt=png"><span>即，基于原始Fq数据，使用 </span><code>cellranger count</code><span> 生成表达矩阵和比对bam文件。</span><span>基于此 </span><code>velocyto run</code><span> </span><span>可生成loom文件，其中</span><span>包含 spliced/unspliced 转录本表达</span><span>矩阵及行、列的属性信息。</span><span>seVelo基于loom文件分</span><span>析RNA速率，并将其可视化到UMAP图上，UMAP可以来自Loupe、Seurat等工具。</span></figure><figure><span></span></figure><p>其中， <code>cellranger count</code> 和 <code>velocyto run</code> 会消耗大量的计算资源和时间（推荐使用服务器），所以一般教程是从表达矩阵和 loom 文件开始。</p><p>1、测试数据（4个文件，可直接下载，放在 input-files 目录下）</p><pre><span></span><code>wget -c https://cf.10xgenomics.com/supp/cell-exp/neutrophils/filtered_feature_bc_matrix.tar.gz<br>tar -zxvf filtered_feature_bc_matrix.tar.gz<br>wget -c https://cf.10xgenomics.com/supp/cell-exp/neutrophils/WB_Lysis_3p_Introns_8kCells.loom<br>wget -c https://cf.10xgenomics.com/supp/cell-exp/neutrophils/3p-Neutrophils-clusters.csv<br>wget -c https://cf.10xgenomics.com/supp/cell-exp/neutrophils/3p-Neutrophils-UMAP-Projection.csv</code></pre><p>2、执行环境配置（scVelo，其他python包同理安装）</p><pre><span></span><code><span>###### 安装scVelo</span><br>pip install scvelo</code></pre><p>3、RNA速率分析（是个python脚本）</p><pre><span></span><code><span>import</span> pandas <span>as</span> pd<br><span>import</span> scvelo <span>as</span> scv<br><span>import</span> scanpy <span>as</span> sc<br><br><span>#===== 读取表达矩阵（cellranger count输出）</span><br>Neutro3p = sc.read_10x_mtx(<span>"./input-files/filtered_feature_bc_matrix/"</span>, var_names=<span>'gene_symbols'</span>, cache=<span>True</span>)<br><br><span>#===== 读取Loupe分析结果（***同理，所需文件从Seurat也可得***）</span><br><span># 聚类结果(两列：Barcode,Cluster) # 本例中只包含中性粒细胞(neutrophil)的数据，实际分析中也应选择某种特定的细胞类型进行RNA速率分析</span><br>Clusters_Loupe = pd.read_csv(<span>"./input-files/3p-Neutrophils-clusters.csv"</span>, delimiter=<span>','</span>,index_col=<span>0</span>)<br>Neutrophils_BCs=Clusters_Loupe.index<br><span># UMAP坐标(三列：Barcode,UMAP图中细胞的X轴定位,UMAP图中细胞的Y轴定位)</span><br>UMAP_Loupe = pd.read_csv(<span>"./input-files/3p-Neutrophils-UMAP-Projection.csv"</span>, delimiter=<span>','</span>,index_col=<span>0</span>)<br>UMAP_Loupe = UMAP_Loupe.loc[Neutrophils_BCs,]<br><span># 数据整理</span><br>UMAP_Loupe = UMAP_Loupe.to_numpy()<br>Neutro3p = Neutro3p[Neutrophils_BCs] <span># 目标细胞</span><br>Neutro3p.obs[<span>'Loupe'</span>] = Clusters_Loupe <span># 添加聚类信息</span><br>Neutro3p.obsm[<span>"X_umap"</span>] = UMAP_Loupe  <span># 添加UMAP坐标信息</span><br>Neutro3p<br><span># AnnData object with n_obs × n_vars = 3343 × 36601</span><br><span>#     obs: 'Loupe'</span><br><span>#     var: 'gene_ids', 'feature_types'</span><br><span>#     obsm: 'X_umap'</span><br><br><span>#===== 读取loom文件（velocyto 输出）</span><br>VelNeutro3p = scv.read(<span>'./input-files/WB_Lysis_3p_Introns_8kCells.loom'</span>, cache=<span>True</span>)<br><span># 修改细胞名(barcodes)，与 Neutro3p.obs.index 中的保持一致!否则无法合并!!</span><br>barcodes = [bc.split(<span>':'</span>)[<span>1</span>] <span>for</span> bc <span>in</span> VelNeutro3p.obs.index.tolist()]<br>barcodes = [bc[<span>0</span>:<span>len</span>(bc)-<span>1</span>] + <span>'-1'</span> <span>for</span> bc <span>in</span> barcodes]<br>VelNeutro3p.obs.index = barcodes<br><br><span>#===== 合并分析</span><br>Neutro3p = scv.utils.merge(Neutro3p, VelNeutro3p)<br>scv.utils.show_proportions(Neutro3p) <span># 'unspliced', 'spliced', 'ambiguous' 占比</span><br>scv.pl.proportions(Neutro3p) <span># 占比可视化</span><br><span># 预处理</span><br>scv.pp.filter_and_normalize(Neutro3p, min_shared_counts=<span>30</span>, n_top_genes=<span>2000</span>)<br>scv.pp.moments(Neutro3p, n_pcs=<span>30</span>, n_neighbors=<span>30</span>)<br><span># 计算RNA速率</span><br>scv.tl.recover_dynamics(Neutro3p)<br>scv.tl.velocity(Neutro3p, mode=<span>'dynamical'</span>) <span># mode='dynamics'为动态模型(官方推荐使用)</span><br>scv.tl.velocity_graph(Neutro3p)<br>scv.tl.recover_latent_time(Neutro3p)<br><span># 可视化</span><br><span>scv</span><span>.</span><span>pl</span><span>.</span><span>velocity_embedding_grid</span><span>(</span><span>Neutro3p</span><span>,</span><span>basis</span><span>=</span><span>"umap"</span><span>,</span><span>color</span><span>=</span><span>"Loupe"</span><span>,</span><span>title</span><span>=</span><span>'Neutrophils'</span><span>,</span><span>fontsize</span><span>=</span><span>20</span><span>,</span><span>legend_fontsize</span><span>=</span><span>20</span><span>,</span><span>min_mass</span><span>=</span><span>2</span><span>,</span><span>color_map</span><span>=</span><span>"plasma"</span><span>,</span><span>save</span><span>=</span><span>'scVelo-umap-grid.pdf'</span><span>)</span><br><span>scv</span><span>.</span><span>pl</span><span>.</span><span>velocity_embedding_stream</span><span>(</span><span>Neutro3p</span><span>,</span><span>basis</span><span>=</span><span>"umap"</span><span>,</span><span>color</span><span>=</span><span>"Loupe"</span><span>,</span><span>title</span><span>=</span><span>'Neutrophils'</span><span>,</span><span>fontsize</span><span>=</span><span>12</span><span>,</span><span>legend_fontsize</span><span>=</span><span>12</span><span>,</span><span>min_mass</span><span>=</span><span>2</span><span>,</span><span>color_map</span><span>=</span><span>"plasma"</span><span>,</span><span>save</span><span>=</span><span>'scVelo-umap-stream.png'</span><span>)</span></code></pre><p><img data-galleryid="" data-ratio="0.7980582524271844" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/GXnBwOcM855XgLnWz9PPAU1kdp9FvxDeTZp9ayfQzYHNn6H5czicnDlzZk8AYKU5Xv07Fut5oQtC3CUvcvPEPGQ/640?wx_fmt=png" data-type="png" data-w="515" src="https://mmbiz.qpic.cn/mmbiz_png/GXnBwOcM855XgLnWz9PPAU1kdp9FvxDeTZp9ayfQzYHNn6H5czicnDlzZk8AYKU5Xv07Fut5oQtC3CUvcvPEPGQ/640?wx_fmt=png"></p><p><img data-galleryid="" data-ratio="0.7469512195121951" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/GXnBwOcM855XgLnWz9PPAU1kdp9FvxDeicZc9DAqAib0jrlQ6x7FnwHCc7jQQSeaxw9W46oYuibPKIWH4455mA99Q/640?wx_fmt=png" data-type="png" data-w="656" src="https://mmbiz.qpic.cn/mmbiz_png/GXnBwOcM855XgLnWz9PPAU1kdp9FvxDeicZc9DAqAib0jrlQ6x7FnwHCc7jQQSeaxw9W46oYuibPKIWH4455mA99Q/640?wx_fmt=png"></p><p>还有其他不明白的就参考这个，也是本文的主要参考，绝美！</p><p><span>https://statbiomed.github.io/SingleCell-Workshop-2021/preprocess.html#preprocessing-for-rna-velocity</span></p><p>整合Seurat的结果以及其他分析内容可参考这个：<br></p><p><span>https://smorabit.github.io/tutorials/8_velocyto/</span></p><section data-darkmode-bgcolor="rgb(36, 36, 36)"><section data-darkmode-bgcolor="rgb(36, 36, 36)"><img data-ratio="0.3208955223880597" data-src="https://mmbiz.qpic.cn/mmbiz_gif/GXnBwOcM854H437mZXWZCJTqTQZhyDcYEQ1bk43JRXIlfjwwevW2rqZ8vibL9sSVlToSrLNtSjpJqxkHic4E8UAg/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-type="gif" data-w="134" width="4em" src="https://mmbiz.qpic.cn/mmbiz_gif/GXnBwOcM854H437mZXWZCJTqTQZhyDcYEQ1bk43JRXIlfjwwevW2rqZ8vibL9sSVlToSrLNtSjpJqxkHic4E8UAg/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section><section data-darkmode-bgcolor="rgb(36, 36, 36)"><br data-darkmode-bgcolor="rgb(36, 36, 36)"></section></section><section data-darkmode-bgcolor="rgb(36, 36, 36)"><br></section><section data-tools="135编辑器" data-id="93199" data-darkmode-bgcolor="rgb(36, 36, 36)" data-style='white-space: normal; max-width: 100%; box-sizing: border-box; background-color: rgb(255, 255, 255); color: rgba(255, 255, 255, 0.8); font-family: -apple-system-font, system-ui, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif; letter-spacing: 0.544px; border-width: 0px; border-style: none; border-color: initial; overflow-wrap: break-word !important;'><section><section data-darkmode-bgcolor="rgb(36, 36, 36)"><section data-darkmode-bgcolor="rgb(36, 36, 36)"><section data-darkmode-bgcolor="rgb(36, 36, 36)" data-style="margin-left: 5px; padding-right: 15px; padding-left: 15px; max-width: 100%; box-sizing: border-box; border-color: rgb(0, 0, 0); border-width: 1px; border-style: solid; background: rgb(255, 181, 2); display: inline-block; font-size: 12px; overflow-wrap: break-word !important;"><p data-darkmode-bgcolor="rgb(36, 36, 36)"><span data-darkmode-bgcolor="rgb(36, 36, 36)">绘图系列·往期精彩</span></p></section></section></section></section><section data-darkmode-bgcolor="rgb(36, 36, 36)" data-darkmode-color="rgb(167, 167, 167)" data-style="margin-top: -5.5px; padding: 1em 0.8em; max-width: 100%; box-sizing: border-box; border-color: rgb(0, 0, 0); font-size: 14px; letter-spacing: 1.5px; line-height: 1.75em; border-width: 1px; border-style: solid; overflow-wrap: break-word !important;"><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNzk1NjUxOA==&amp;mid=2247484478&amp;idx=1&amp;sn=507fd0012b14b79543827d9e7a7140ac&amp;chksm=e8580677df2f8f61b66ec6c4ad28d3e50126b150f488c0d921d21f69939a440bb55cd645cc96&amp;scene=21#wechat_redirect" textvalue="R语言 | 多重假设检验校正" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">R语言 | 多重假设检验校正</a><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNzk1NjUxOA==&amp;mid=2247485430&amp;idx=1&amp;sn=e72993461ae8a9c7321e843fc1a68303&amp;chksm=e85805bfdf2f8ca9a2b445e7177c4634b6730e9f627755c1a9eeebab65bc883da98937976923&amp;scene=21#wechat_redirect" textvalue="单细胞测序 | marker基因列表怎么找？" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞测序 | marker基因列表怎么找？</a><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNzk1NjUxOA==&amp;mid=2247485463&amp;idx=1&amp;sn=bbf6b130da028e2f5a5fa691a62e25da&amp;chksm=e8580a5edf2f8348c31a00ef8d1758226b3447a7790b841a80418f6be008707f535f5a9949d8&amp;scene=21#wechat_redirect" textvalue="单细胞测序 | 数据下载，速度就是生命！(GEO)" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞测序 | 数据下载，速度就是生命！(GEO)</a></section></section></section><section><br></section><section><img data-ratio="0.593939393939394" data-src="https://mmbiz.qpic.cn/mmbiz_png/GXnBwOcM854H437mZXWZCJTqTQZhyDcYqmIeAAMEcFe5NZQ9YmGwbRQibdWzd6P26ibllZtaVzicc5IzBj9ibW2xqA/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="jpeg" data-w="825" src="https://mmbiz.qpic.cn/mmbiz_png/GXnBwOcM854H437mZXWZCJTqTQZhyDcYqmIeAAMEcFe5NZQ9YmGwbRQibdWzd6P26ibllZtaVzicc5IzBj9ibW2xqA/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/DmY3hJFdHKqLv72_Q0HBJw",target="_blank" rel="noopener noreferrer">原文链接</a>
