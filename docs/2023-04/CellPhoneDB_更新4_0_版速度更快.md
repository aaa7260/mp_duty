---
title: "CellPhoneDB 更新4.0 版速度更快"
date: 2023-04-14T02:17:45Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
CellPhoneDB 更新4.0 版速度更快 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">之前版本的CellPhoneDB依赖的anndata不兼容导致使用h5ad的文件作为count matrix输入报错，没想到CellPhoneDB更新到了4.0解决了这个问题，而且运行速度超级快十几分钟就跑完了10几万细胞的主要流程</p><pre data-tool="mdnice编辑器"><span></span><code>cd ~<br>mamba create -n cpdb python=<span>3.8</span><br>mamba activate cpdb<br>mamba install -y ipykernel numpy pandas scikit-learn<br>pip install cellphonedb gseapy -i https://pypi.tuna.tsinghua.edu.cn/simple<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>下载数据库文件</h2><p data-tool="mdnice编辑器">https://www.cellphonedb.org</p><figure data-tool="mdnice编辑器"><img data-ratio="0.4398148148148148" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/OmJXhnRxzIreISEkicfbf63RWMfmZZibX11DQtjNpibiagC8BHiaHW4eXdJLswDVfvPkhca8NibZRI8Lc1pglK9wmdYw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/OmJXhnRxzIreISEkicfbf63RWMfmZZibX11DQtjNpibiagC8BHiaHW4eXdJLswDVfvPkhca8NibZRI8Lc1pglK9wmdYw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>Count data</h2><ol data-tool="mdnice编辑器"><li><section>如果是人的基因就直接使用<code>adata_noramlised_annotated.h5ad</code>文件就可以不需要下边的步骤</section></li><li><section>如果是小鼠基因，则需要把基因名转换为人的基因名</section></li><li><section>输入的count文件也可以是文本文件，但是h5ad文件速度更快</section></li></ol><pre data-tool="mdnice编辑器"><span></span><code><span>from</span> gseapy <span>import</span> Biomart<br><span>import</span> pandas <span>as</span> pd<br><br>bm = Biomart()<br>m2h_df = bm.query(dataset=<span>'mmusculus_gene_ensembl'</span>,<br>               attributes=[<span>'ensembl_gene_id'</span>,<span>'external_gene_name'</span>,<br>                           <span>'hsapiens_homolog_ensembl_gene'</span>,<br>                           <span>'hsapiens_homolog_associated_gene_name'</span>])<br>m2h=m2h_df.dropna(subset=[<span>'hsapiens_homolog_associated_gene_name'</span>])<br>m2h=m2h.loc[:,[<span>'external_gene_name'</span>,<span>'hsapiens_homolog_associated_gene_name'</span>]]<br><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> anndata<br><br>adata = anndata.read_h5ad(<span>'adata_noramlised_annotated.h5ad'</span>)<br>adata_raw=adata.raw.to_adata()<br>bdata=anndata.AnnData(X=adata_raw.X,<br>    obs=pd.DataFrame({<span>'cell_type'</span>:adata_raw.obs.CellType2},index=adata_raw.obs_names),<br>    var=pd.DataFrame(index=adata_raw.var_names)<br>    )<br>merged =pd.merge(bdata.var,m2h,left_index=<span>True</span>,right_on=<span>'external_gene_name'</span>)<br>bdata=bdata[:,merged.external_gene_name]<br>bdata.var_names=merged.hsapiens_homolog_associated_gene_name.values<br>bdata.write_h5ad(<span>'adata_for_cellphonedb.h5ad'</span>,compression=<span>'lzf'</span>)<br><br></code></pre><h2 data-tool="mdnice编辑器"><span></span>Meta data</h2><pre data-tool="mdnice编辑器"><span></span><code>meta_file = pd.DataFrame({<span>'Cell'</span>:bdata.obs.index,<span>'cell_type'</span>:bdata.obs.cell_type})<br>meta_file.to_csv(<span>"meta_file.csv"</span>,index=<span>False</span>)<br><br></code></pre><ul data-tool="mdnice编辑器"><li><section>删除不需要的变量</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span>del</span> adata,meta_file,bdata,merged,m2h<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>cpdb_statistical_analysis_method</h2><pre data-tool="mdnice编辑器"><span></span><code><span>from</span> cellphonedb.src.core.methods <span>import</span> cpdb_statistical_analysis_method<br><br>deconvoluted, means, pvalues, significant_means = cpdb_statistical_analysis_method.call(<br>    cpdb_file_path = <span>'./cellphonedb.zip'</span>,            <span># mandatory: CellPhoneDB database zip file.</span><br>    meta_file_path = <span>"./meta_file.csv"</span>,              <span># mandatory: tsv file defining barcodes to cell label.</span><br>    counts_file_path = <span>'./adata_for_cellphonedb.h5ad'</span>,<span># mandatory: normalized count matrix.</span><br>    counts_data = <span>'hgnc_symbol'</span>,                     <span># defines the gene annotation in counts matrix.</span><br>    microenvs_file_path = <span>None</span>,                      <span># optional (default: None): defines cells per microenvironment.</span><br>    iterations = <span>1000</span>,                               <span># denotes the number of shufflings performed in the analysis.</span><br>    threshold = <span>0.1</span>,                                 <span># defines the min % of cells expressing a gene for this to be employed in the analysis.</span><br>    threads = <span>8</span>,                                     <span># number of threads to use in the analysis.</span><br>    debug_seed = <span>42</span>,                                 <span># debug randome seed. To disable &gt;=0.</span><br>    result_precision = <span>3</span>,                            <span># Sets the rounding for the mean values in significan_means.</span><br>    pvalue = <span>0.05</span>,                                   <span># P-value threshold to employ for significance.</span><br>    subsampling = <span>False</span>,                             <span># To enable subsampling the data (geometri sketching).</span><br>    subsampling_log = <span>False</span>,                         <span># (mandatory) enable subsampling log1p for non log-transformed data inputs.</span><br>    subsampling_num_pc = <span>100</span>,                        <span># Number of componets to subsample via geometric skectching (dafault: 100).</span><br>    subsampling_num_cells = <span>1000</span>,                    <span># Number of cells to subsample (integer) (default: 1/3 of the dataset).</span><br>    separator = <span>'|'</span>,                                 <span># Sets the string to employ to separate cells in the results dataframes "cellA|CellB".</span><br>    debug = <span>False</span>,                                   <span># Saves all intermediate tables employed during the analysis in pkl format.</span><br>    output_path = <span>'./'</span>,                              <span># Path to save results.</span><br>    output_suffix = <span>None</span>                             <span># Replaces the timestamp in the output files by a user defined string in the  (default: None).</span><br>    )<br></code></pre><p data-tool="mdnice编辑器">文件目录</p><pre data-tool="mdnice编辑器"><span></span><code>├── adata_for_cellphonedb.h5ad<br>├── meta_file.cs<br>├── statistical_analysis_deconvoluted_03_30_2023_11:<span>11</span>:<span>04.</span>txt<br>├── statistical_analysis_means_03_30_2023_11:<span>11</span>:<span>04.</span>txt<br>├── statistical_analysis_pvalues_03_30_2023_11:<span>11</span>:<span>04.</span>txt<br>└── statistical_analysis_significant_means_03_30_2023_11:<span>11</span>:<span>04.</span>txt<br></code></pre><p data-tool="mdnice编辑器">输出文件和可视化可以参考</p><p data-tool="mdnice编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg5MDg4MDU4MQ==&amp;mid=2247484038&amp;idx=1&amp;sn=cc20f4b9a7fd745bd0dc201da494f650&amp;chksm=cfd495acf8a31cba30351accfd24a37b6cf614228c37a80ea985b3f35dbdecdfd8ca6165d943&amp;scene=21#wechat_redirect" textvalue="单细胞转录组实战05: CellphoneDB细胞通讯及可视化" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞转录组实战05: CellphoneDB细胞通讯及可视化</a><br></p><h2 data-tool="mdnice编辑器"><span></span>Reference</h2><pre data-tool="mdnice编辑器"><span></span><code>https://cellphonedb.readthedocs.io/en/latest/RESULTS-DOCUMENTATION.html</code></pre></section><section><p><br></p><p><br></p><section data-style-type="5" data-tools="新媒体排版" data-id="2440476"><section><section><section><section><img data-ratio="0.9495798319327731" data-src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif" data-type="gif" data-w="119" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif"></section><section data-brushtype="text">往期回顾</section><section><br></section></section></section></section><section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247511865&amp;idx=1&amp;sn=38223ccb690ab953c50cf4bb099fbaa5&amp;chksm=ea1ca9bbdd6b20ad4a45c4dd5678027c114dc3913a2e2767334b2007ea1658df5e456db9f69e&amp;scene=21#wechat_redirect" textvalue="单细胞工具MARVEL—单细胞可变剪切分析(二)" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞工具MARVEL—单细胞可变剪切分析(二)</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247511864&amp;idx=1&amp;sn=e94d6f5a8cf8a8ea1cb427047838e97a&amp;chksm=ea1ca9badd6b20ac3aaa9e6824eea093560690abd08f3587fbc071c4c1522655682c2b41202d&amp;scene=21#wechat_redirect" textvalue="单细胞工具MARVEL—单细胞可变剪切分析(一)" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞工具MARVEL—单细胞可变剪切分析(一)</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247511619&amp;idx=1&amp;sn=0e463b0fd0fb80faa64bbd27865da83d&amp;chksm=ea1ca8c1dd6b21d71ff129fb1d8f0f5ab329c814bb38fc1d3da56f73bc2706709bb522767884&amp;scene=21#wechat_redirect" textvalue="常规转录组与单细胞转录组的整合分析揭示了肝癌的细胞异质性与免疫浸润" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>常规转录组与单细胞转录组的整合分析揭示了肝癌的细胞异质性与免疫浸润</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247511581&amp;idx=1&amp;sn=5b134c22c926289a936ed38df23726e0&amp;chksm=ea1ca89fdd6b2189aa1b8580858bfce67b2328f5280b38e342562d726a4331d45e480d452064&amp;scene=21#wechat_redirect" textvalue="ImmCluster—用于正常和癌变组织中免疫细胞类型聚类和注释的集成资源" linktype="text" imgurl="" imgdata="null" data-itemshowtype="8" tab="innerlink" data-linktype="2"><span>ImmCluster—用于正常和癌变组织中免疫细胞类型聚类和注释的集成资源</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247511549&amp;idx=1&amp;sn=dbf8386bdb233a22edbfa98d4c6b2ae6&amp;chksm=ea1cab7fdd6b2269b028bf8cb499d690036b027f237f888facbd1ba481aaba5dec5bf1b3a003&amp;scene=21#wechat_redirect" textvalue="单细胞多组学数据分析最佳实践(2023典藏版)" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞多组学数据分析最佳实践(2023典藏版)</span></a><br></p></section></section><hr><p><br></p></section><section data-style-type="5" data-tools="新媒体排版" data-id="2440475"><hr><p><br></p><hr><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247520628&amp;idx=1&amp;sn=8904b3e4baed6d02397b4f6beb089085&amp;chksm=9b4bd1cfac3c58d9ee006daf365931bdfab8d5152ffb5090a2c6227d631e93c52f6656c39cd6&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课4月班" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信入门&amp;数据挖掘线上直播课4月班</a><br></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=2&amp;sn=6cb33654c7751f4c3df0f84743f77aaf&amp;chksm=9b4bceaeac3c47b8899afc00077b96357b87a4ed6b75e7c434ba14071fd6c8448e4c218de5e0&amp;scene=21#wechat_redirect" textvalue="144线程640Gb内存服务器共享一年仍然是仅需800" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">144线程640Gb内存服务器共享一年仍然是仅需800</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">千呼万唤始出来的独享生物信息学云服务器</a></p></li></ul><p><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-id="93668"><section><section data-width="95%"><section><section><section data-width="38%"><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg" data-type="other" data-w="258" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><p><br></p></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/TtBMVpfV2J-IxfO7VSIrdg",target="_blank" rel="noopener noreferrer">原文链接</a>
