---
title: "跟着Cell子刊学Shell脚本"
date: 2023-04-22T08:00:31Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
跟着Cell子刊学Shell脚本 by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">关于R语言的学习，我是从2020年9月份开始学习的，先是从R语言基础学起，然后又学习了芯片和RNA-seq数据分析。由于没有人带，没有办法系统的学习生信基础，因此所有知识点都是一点一点自学的，例如最最基本的芯片数据和RNA-seq数据的区别，基本分析流程？什么是count、FPKM、TPM？什么是富集分析？诸如此类，<strong>那会最难的其实不是学习这些东西，而是压根就不知道也没有渠道去系统了解到这些概念</strong>。而现在<strong>得益于各种生信自媒体们的涌现，这些过去学的很艰难的知识点，现在基本上一搜就有答案了。</strong>此外，对于准备或者刚刚<span>入门</span>生信的朋友，生信技能树也有各类系统课程帮助大家系统的学习，少走很多弯路，例如：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247520714&amp;idx=2&amp;sn=c214a3c188583257b055e91d2968b3a7&amp;scene=21#wechat_redirect" data-linktype="2">R语言编程7天授课（2023）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247520963&amp;idx=2&amp;sn=24b6c980fa5a5077c9541a1d297f7b08&amp;scene=21#wechat_redirect" data-linktype="2">马拉松授课的GEO数据挖掘单元</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247520984&amp;idx=3&amp;sn=45432210c92362bb5d5a32014127d877&amp;scene=21#wechat_redirect" data-linktype="2">转录组单元（含单细胞）5天授课时间线</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247520984&amp;idx=2&amp;sn=52a7fd252f10c12bf6b1e91262086021&amp;scene=21#wechat_redirect" data-linktype="2">Linux单元5天授课时间线</a></section></li><li><section>（参阅 <a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxMDkxODM1Ng==&amp;action=getalbum&amp;album_id=2201138830328528899&amp;scene=173&amp;from_msgid=2247520984&amp;from_itemidx=2&amp;count=3&amp;nolastread=1#wechat_redirect" data-linktype="2">时间线</a>）...</section></li></ul><p data-tool="mdnice编辑器">如果像我一样，生活比较困难的，没办法额外花很多钱学习生信的，其实生信技能树、生信菜鸟团和单细胞天地等公众号除了有大量的免费推文以外，技能树在B站也有海量免费的学习资源（https://space.bilibili.com/338686099），我当年就是白嫖B站健明老师的视频课程，学习了一整套的NGS多组学分析流程。另外，国外例如哈佛剑桥也有很多免费的公开课程，例如：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483735&amp;idx=1&amp;sn=87d13347524ab7d264bb6c9b7c233af9&amp;scene=21#wechat_redirect" data-linktype="2">单细胞入门第一讲：公开课及数据库资源</a></section></li></ul><blockquote data-tool="mdnice编辑器"><p>题外话，有很多人问我生信学习到底要不要报班，借此机会我也好好聊一聊这个问题。其实是否自学<span>还是</span><span>跟班学习生信</span>，本质上有点像考研自学还是跟班学习。这东西的选择取决于很多因素，例如：</p><ul><li><section>个人/课题组条件（钱）好不好？不差钱的，跟班学习当然会少走很多弯路，虽然也和个人学习能力有关，但是跟班学习一般能缩短一半以上的学习成本（我个人的经验）；</section></li><li><section>学习动机和心态。一定别忘了，跟班学习不一定能百分百“考上研”，如果自己不努力的话，仅把希望全部寄托于“辅导班”，这肯定是不行的。生信学习更不像考研那样，考过了就可以丢掉书本，生信学习应该是“无止境的学习“的过程。现在技术/知识更新的太快啦！</section></li><li><section>另外，跟班与否也和自己的学习习惯有关。例如像我这样的，不是很喜欢上课式的被动教育，我更倾向根据自己的兴趣去探索和学习。</section></li></ul></blockquote><p data-tool="mdnice编辑器">言归正传，我在学习了大半年的基础知识之后，一直跟着健明老师的课程，多次听到他提起“服务器”、“上游”和“Linux Shell脚本”之类的名词，于是经过检索之后才明白，由于NGS测序产生的fastq数据极为庞大，一般的笔记本和台式电脑是没有办法处理这么大型的数据的，因此需要借助配置更好的高性能计算机，也就是<strong>服务器集群</strong>，来处理这些数据。而 Linux 是除了Windows和IOS系统以外最常用的服务器操作系统，且服务器可以扩展硬盘内存条和CPU。比如想分析大规模的单细胞和空间转录组数据，无论是上游还是下游， Windows 很难达到要求（Mac太贵了，且拓展性不好）。其次，grep、sed、awk及shell脚本的批处理等使数据处理<strong>非常高效率</strong>。另外服务器运维方面的需求。同一台服务器可以同时共享给多人使用，解决成本。但Linux 对于生信来说，运维不是刚需，而使用是刚需。所以服务器运维对于生信学习来说并不是优先级。</p><p data-tool="mdnice编辑器"><span>21年末的时候写了一些帖子介绍Linux入门学习，例如：</span></p><section><br></section><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483696&amp;idx=1&amp;sn=521df829a697d50477e7b4ac840a8129&amp;scene=21#wechat_redirect" data-linktype="2">Linux随笔（一）入门篇</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483723&amp;idx=1&amp;sn=4716bcef0d1ebc0c6b7f1eb289b4754d&amp;scene=21#wechat_redirect" data-linktype="2">Linux随笔（二）“软件管家“ conda</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247485433&amp;idx=1&amp;sn=8414f226f68ad15f6e9e63f0420ff2e0&amp;scene=21#wechat_redirect" data-linktype="2">加速：Linux环境下基于Shell批量运行R语言脚本</a></section></li></ul><p data-tool="mdnice编辑器">在掌握了这些基本知识之后，就可以尝试进行NGS多组学的上游分析了，例如：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483979&amp;idx=1&amp;sn=25e1b0d54df0cf33dd2c353eb98f2697&amp;scene=21#wechat_redirect" data-linktype="2">91例免疫治疗队列（含生存）转录组上游分析实战</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247509727&amp;idx=1&amp;sn=a6a9730a240de716c1b47c66513b116e&amp;scene=21#wechat_redirect" data-linktype="2">CircRNA-seq上游分析工具测评：CIRIquant VS. CIRCexplorer3</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484227&amp;idx=1&amp;sn=ff4fe0eb2bab1d5f64711297427e6bf7&amp;scene=21#wechat_redirect" data-linktype="2">ChIPseq实战分析(一)：从fastq到bed</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483752&amp;idx=1&amp;sn=5d7bb3369c68f5170995861962a6cbd3&amp;scene=21#wechat_redirect" data-linktype="2">一文打通单细胞上游：从软件部署到上游分析</a></section></li><li><section>单细胞的一些高级分析诸如速率分析、cellphoneDB等也需要用到Linux命令行：<a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247485750&amp;idx=2&amp;sn=4b37f73c4af9856c1a160238c81a2659&amp;scene=21#wechat_redirect" data-linktype="2">细胞通讯分析之CellphoneDB初探（一）</a></section></li></ul><p data-tool="mdnice编辑器">最近我看到Cell子刊STAR Protocols上的一篇论文《Protocol for unbiased, consolidated variant calling from whole exome sequencing data》（doi: 10.1016/j.xpro.2022.101418），文章中非常清晰的描述了如何进行全外显子数据的分析流程。作者的Shell脚本书写的非常规范化，非常值得学习！</p><p data-tool="mdnice编辑器"><strong>下图是全外显子数据的分析流程：</strong></p><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los8cGTbhy1St3abTiaU4RWica1B30VqCSuDyOATxVBgL5zCLG6Sg4D2wmrNSqWFPfXAic3iby7Gwic997Pw/640?wx_fmt=other" data-type="other" data-w="996" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los8cGTbhy1St3abTiaU4RWica1B30VqCSuDyOATxVBgL5zCLG6Sg4D2wmrNSqWFPfXAic3iby7Gwic997Pw/640?wx_fmt=other"><p data-tool="mdnice编辑器">Step1是数据准备和软件部署，Step2是fastq数据的质控、过滤和比对过程，这两个步骤基本是所有NGS组学上游的必备步骤，让我们来学习一下作者的Shell脚本代码吧！</p><h3 data-tool="mdnice编辑器">01. fastq数据下载和环境部署</h3><p data-tool="mdnice编辑器">这里没啥说的，环境部署用conda就行，和下帖一样：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483979&amp;idx=1&amp;sn=25e1b0d54df0cf33dd2c353eb98f2697&amp;scene=21#wechat_redirect" data-linktype="2">91例免疫治疗队列（含生存）转录组上游分析实战</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247509727&amp;idx=1&amp;sn=a6a9730a240de716c1b47c66513b116e&amp;scene=21#wechat_redirect" data-linktype="2">CircRNA-seq上游分析工具测评：CIRIquant VS. CIRCexplorer3</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484227&amp;idx=1&amp;sn=ff4fe0eb2bab1d5f64711297427e6bf7&amp;scene=21#wechat_redirect" data-linktype="2">ChIPseq实战分析(一)：从fastq到bed</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483752&amp;idx=1&amp;sn=5d7bb3369c68f5170995861962a6cbd3&amp;scene=21#wechat_redirect" data-linktype="2">一文打通单细胞上游：从软件部署到上游分析</a></section></li></ul><h3 data-tool="mdnice编辑器">02. 质量控制及过滤</h3><p data-tool="mdnice编辑器"><strong>基于作者的Shell脚本，我做了部分修改以适用于我的服务器：</strong></p><pre data-tool="mdnice编辑器"><span></span><code>conda activate rnaseq<br><br>cat &gt;QC.sh<br><span>#!/bin/bash</span><br>HOME_PATH=/home/data/fuli09/ngs_data/1.Bulk_RNAseq/1.test.data/<br>FASTQ_PATH=<span>$HOME_PATH</span>/1.rawdata<br>FASTQ_PATTERN=∗.fastq.gz<br>FASTQC_COMMAND=fastqc<br>MULTIQC_COMMAND=multiqc<br>FASTQC_OUTPUT=<span>$HOME_PATH</span>/2.fastqc<br>CORES=4<br><br><span>if</span> [ ! -d <span>$FASTQC_OUTPUT</span> ]<br><span>then</span><br> mkdir -p <span>$FASTQC_OUTPUT</span><br><span>fi</span><br><br><span>$FASTQC_COMMAND</span> --outdir <span>$FASTQC_OUTPUT</span> --threads <span>$CORES</span><br><span>$FASTQ_PATH</span>/<span>$FASTQ_PATTERN</span><br><span>$MULTIQC_COMMAND</span> <span>$FASTQC_OUTPUT</span> -o <span>$FASTQC_OUTPUT</span><br><br><span>##run</span><br>nohup bash QC.sh &amp;<br></code></pre><p data-tool="mdnice编辑器">看不懂的话，可以丢进ChatGPT帮助理解：</p><blockquote data-tool="mdnice编辑器"><p>这个脚本似乎是用于NGS测序数据的质量控制流程。以下是它的具体操作：</p><ol><li><section>设置了所需的路径和变量。</section></li><li><section>检查fastqc分析输出目录是否存在，如果不存在则创建。</section></li><li><section>在指定目录中对所有fastq文件运行fastqc命令，使用指定的核心数。</section></li><li><section>对fastqc的输出运行multiqc命令，将输出放在与fastqc输出相同的目录中。</section></li><li><section>使用nohup在后台运行脚本，即使用户注销也可以继续运行。</section></li></ol><p>总体来说，这个脚本应该可以为指定目录中的所有fastq文件生成fastqc和multiqc报告。</p></blockquote><p data-tool="mdnice编辑器">简单来说，从<code>HOME_PATH</code>到<code>CORES</code>部分，作者是在设置所需的路径和变量，例如<code>FASTQ_PATH</code>是目标fastq文件存放的路径，<code>CORES</code>是使用的核心数。</p><p data-tool="mdnice编辑器"><strong>以下是我用的旧的Shell脚本：</strong></p><pre data-tool="mdnice编辑器"><span></span><code>conda activate rnaseq<br><span>cd</span> /home/data/fuli09/ngs_data/1.Bulk_RNAseq/1.test.data/1.test.data/<br><br><span>###生成的fastqc放到~/sra/3.fastq_qc/中,-t指定线程数。</span><br>nohup fastqc -t 4 -o ./ ./*.fastq.gz 1&gt;fastqc.log 2&gt;&amp;1 &amp;<br><br>cat nohup.out | grep Failed<br><br><span>###使用MutliQC整合FastQC结果，将后缀为.html的文件进行multiqc处理</span><br>multiqc ./  -o QC_Raw<br></code></pre><p data-tool="mdnice编辑器">虽然写的更加简单，但是缺少规范化。</p><p data-tool="mdnice编辑器"><strong>接下来选做<code>Trimgalore</code>过滤接头，作者的脚本具体如下（双端数据）：</strong></p><pre data-tool="mdnice编辑器"><span></span><code>cat &gt;Trimgalore.sh<br><span>#!/bin/bash</span><br>HOME_PATH=/home/data/fuli09/ngs_data/1.Bulk_RNAseq/1.test.data/<br>FASTQ_PATH=<span>$HOME_PATH</span>/1.rawdata<br>TRIMGALORE_COMMAND=trim_galore<br>CUTADAPT_COMMAND=<span>$CUTADAPT_PATH</span>/cutadapt<br>TRIMGALORE_OUTPUT=<span>$HOME_PATH</span>/3.fastq_qual<br>CORES=4<br><br><span>if</span> [ ! -d <span>$TRIMGALORE_OUTPUT</span> ]<br><span>then</span><br> mkdir -p <span>$TRIMGALORE_OUTPUT</span><br><span>fi</span><br><br><span>for</span> FILE <span>in</span> <span>$FASTQ_PATH</span>/∗_1.fastq.gz<br><span>do</span><br>BASE=`basename <span>$FILE</span> | sed s/_1\.fastq\.gz//`<br><span>echo</span> <span>"Processing <span>$BASE</span>"</span><br>mkdir -p <span>$TRIMGALORE_OUTPUT</span><br>F1=<span>$FASTQ_PATH</span>/<span>$BASE</span><span>"_1.fastq.gz"</span><br>F2=<span>$FASTQ_PATH</span>/<span>$BASE</span><span>"_2.fastq.gz"</span><br><span>$TRIMGALORE_COMMAND</span> \<br>--quality 30 \<br>--length 50 \<br>--output_dir <span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span> \<br>--path_to_cutadapt <span>$CUTADAPT_COMMAND</span> \<br>--cores <span>$CORES</span> \<br>--paired \<br>--fastqc \<br>--trim-n <span>$F1</span> <span>$F2</span><br>mv <span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span><span>"_1_val_1.fq.gz"</span> \<br><span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span><span>"_1.fastq.gz"</span><br><br>mv <span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span><span>"_2_val_2.fq.gz"</span> \<br><span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span><span>"_2.fastq.gz"</span><br><br>mv <span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span><span>"_1_val_1_fastqc.html"</span> \<br><span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span><span>"_1_fastqc.html"</span><br><br>mv <span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span><span>"_1_val_1_fastqc.zip"</span> \<br><span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span><span>"_1_fastqc.zip"</span><br><br>mv <span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span><span>"_2_val_2_fastqc.html"</span> \<br><span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span><span>"_2_fastqc.html"</span><br><br>mv <span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span><span>"_2_val_2_fastqc.zip"</span> \<br><span>$TRIMGALORE_OUTPUT</span>/<span>$BASE</span><span>"_2_fastqc.zip"</span><br><br><span>done</span><br><br><span>##run</span><br>nohup bash Trimgalore.sh &amp;<br></code></pre><h3 data-tool="mdnice编辑器">03. 与参考基因组的比对和统计</h3><p data-tool="mdnice编辑器"><strong>举一反三，在学习了上述作者的两个Shell脚本之后，我开始按照他这个模板写自己的Shell脚本。</strong></p><p data-tool="mdnice编辑器">例如ATAC-seq数据的bam比对：</p><pre data-tool="mdnice编辑器"><span></span><code><span>##人的用h38</span><br>cat &gt;bowtie2_paried.sh<br>HOME_PATH=/home/data/fuli09/ngs_data/1.Bulk_RNAseq/1.test.data/<br><span># Change the path below with the quality-controlled data directory</span><br><span># if trimming performed (see commented line below)</span><br>FASTQ_PATH=<span>$HOME_PATH</span>/1.rawdata<br><span>#FASTQ_PATH=$HOME_PATH/3.fastq_qual</span><br>BAM_PATH=<span>$HOME_PATH</span>/4.bam<br>BAM_LAST=<span>$HOME_PATH</span>/5.bam_last<br>THREADS=4<br>BOWTIE_INDEX=/home/data/refdir/server/reference/index/bowtie/hg38<br><br><span>for</span> id <span>in</span> `ls <span>$FASTQ_PATH</span>/*_1.fastq.gz`<br><span>do</span><br>FILE=$(basename <span>$id</span>)<br>SAMPLE=<span>${FILE%%_1.fastq.gz*}</span><br>bowtie2 -p <span>$THREADS</span> -x <span>$BOWTIE_INDEX</span> -1 <span>$FASTQ_PATH</span>/<span>${SAMPLE}</span>_1.fastq.gz -2 <span>$FASTQ_PATH</span>/<span>${SAMPLE}</span>_2.fastq.gz| samtools sort -O bam -@ <span>$THREADS</span> -o - &gt;<span>$BAM_PATH</span>/<span>${SAMPLE}</span>.bam<br>samtools index <span>$BAM_PATH</span>/<span>${SAMPLE}</span>.bam -@ <span>$THREADS</span><br>samtools flagstat -@ <span>$THREADS</span> <span>$BAM_PATH</span>/<span>${SAMPLE}</span>.bam &gt;<span>$BAM_PATH</span>/<span>${SAMPLE}</span>.flagstat<br><br><span>#去重复</span><br>sambamba markdup -r -t <span>$THREADS</span> <span>$BAM_PATH</span>/<span>${SAMPLE}</span>.bam <span>$BAM_PATH</span>/<span>${SAMPLE}</span>.markdup.bam &gt;<span>$BAM_PATH</span>/<span>${SAMPLE}</span>.<span>log</span><br>samtools index <span>$BAM_PATH</span>/<span>${SAMPLE}</span>.bam -@ <span>$THREADS</span><br>samtools flagstat -@ <span>$THREADS</span> <span>$BAM_PATH</span>/<span>${SAMPLE}</span>.markdup.bam &gt;<span>$BAM_PATH</span>/<span>${SAMPLE}</span>.markdup.flagstat<br><br><span>#去除低质量序列和线粒体reads</span><br>samtools view -h -f 2 -q 30 <span>$BAM_PATH</span>/<span>${SAMPLE}</span>.markdup.bam| grep -v samtools | grep -v chrM | samtools sort -O bam -@ 1 -o - &gt;<span>$BAM_LAST</span>/<span>${SAMPLE}</span>.last.bam<br>samtools index <span>$BAM_LAST</span>/<span>${SAMPLE}</span>.last.bam -@ <span>$THREADS</span><br>samtools flagstat -@ <span>$THREADS</span> <span>$BAM_LAST</span>/<span>${SAMPLE}</span>.last.bam &gt;<span>$BAM_LAST</span>/<span>${SAMPLE}</span>.last.flagstat<br><br><span>#bam转bed</span><br>bedtools bamtobed -i <span>$BAM_LAST</span>/<span>${SAMPLE}</span>.last.bam &gt;<span>$BAM_LAST</span>/<span>${SAMPLE}</span>.bed<br><span>done</span> <br><br><span>###运行脚本</span><br>nohup bash bowtie2_paried.sh &amp;<br></code></pre><p data-tool="mdnice编辑器">总结来说，把文件的路径和变量放在开头，方便阅读，以及方便下次的使用和修改。</p><p data-tool="mdnice编辑器">然后基于对比后生成的Bam文件，如果是RNA-seq一般做featureCounts定量计数，如果是ChIP-seq和ATAC-seq一般是转为bw文件可视化以及peaks calling，如果是全外显子/全基因组测序的话，走GATK流程或者DeepVariant流程。</p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/POvP8nP7gYRzGhhZG88iHg",target="_blank" rel="noopener noreferrer">原文链接</a>
