---
title: "Seuratv5之崎岖测试之路"
date: 2023-04-04T14:13:50Z
draft: ["false"]
tags: [
  "fetched",
  "止水的小分享"
]
categories: ["Acdemic"]
---
Seuratv5之崎岖测试之路 by 止水的小分享
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span>写在前面</h2><p data-tool="mdnice编辑器">啊~囧，就拿Integrative analysis来进行测试展示吧！</p><h2 data-tool="mdnice编辑器"><span></span>Integrative analysis</h2><p data-tool="mdnice编辑器"><strong>去批次的方法Seuratv5包含了以下几个方法：</strong></p><section>· CCA方法整合</section><section>· RPCA方法整合</section><section>· Harmony方法整合</section><section>· FastMNN方法整合</section><section>· scVI方法整合</section><p data-tool="mdnice编辑器">在Seuratv5中实现上述方法的函数为IntegrateLayers这个函数。</p><p data-tool="mdnice编辑器"><strong>准备工作：</strong></p><section>需要装harmony、batchelor等R包</section><section>需要装Seurat扩展包SeuratWrappers。</section><section>需要准备python的scvi-tools（安装文档：https://docs.scvi-tools.org/en/stable/installation.html）</section><section>需要装一个R能运行python命令的R包：reticulate。</section><h2 data-tool="mdnice编辑器"><span></span>测试</h2><section>一般，根据经验，一个新的工具进行测试，往往从工具的官网给的手册的示例进行，从官网给的demo数据进行测试。</section><p data-tool="mdnice编辑器"><strong>1.数据集的获取</strong></p><section>从SeuratData这个数据集R包中获取pbmcsca这个数据集进行，并使用一个参考集进行自动化注释（Azimuth包的方法）</section><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(Seurat)<br><span>library</span>(SeuratData)<br><span>library</span>(SeuratWrappers)<br><span>library</span>(Azimuth)<br><span>library</span>(ggplot2)<br><span>library</span>(patchwork)<br>options(future.globals.maxSize = <span>1e9</span>)<br>options(Seurat.object.assay.version = <span>"v5"</span>)<br><span># 下载测试数据集</span><br>InstallData(<span>"pbmcsca"</span>)<br><br><span># 加载测试数据集</span><br>pbmcsca &lt;- LoadData(<span>"pbmcsca"</span>)<br><br><span># 保存测试数据集以备下次直接使用</span><br>saveRDS(pbmcsca,<span>"/seurat/v5/test/test1/pbmcsca.rds"</span>)<br><br><span># load in the pbmc systematic comparative analysis dataset</span><br>obj &lt;- LoadData(<span>"pbmcsca"</span>)<br>obj &lt;- subset(obj, nFeature_RNA &gt; <span>1000</span>)<br>obj &lt;- RunAzimuth(obj, reference = <span>"pbmcref"</span>)<br>obj<br></code></pre><p data-tool="mdnice编辑器"><strong>2.Layers分割</strong></p><section>Seuratv5引入了一个数据结构叫layers，用来在同一个Seurat对象中，按你需要分割的想法将表达矩阵分割成若干的子集。</section><section>无论跑不去批次和去批次的流程，都需要对数据进行标准化、高变基因、归一化、PCA线性降维。</section><pre data-tool="mdnice编辑器"><span></span><code><span># split method to layers</span><br>obj[[<span>"RNA"</span>]] &lt;- split(obj[[<span>"RNA"</span>]], f = obj$Method)<br>obj<br><br><span>## 数据标准化、高变基因、归一化、PCA线性降维</span><br>obj &lt;- NormalizeData(obj)<br>obj &lt;- FindVariableFeatures(obj)<br>obj &lt;- ScaleData(obj)<br>obj &lt;- RunPCA(obj)<br></code></pre><section>切割后的结果如下，一般是assays下的layers分割，可以看到counts和data都被分割了。</section><figure data-tool="mdnice编辑器"><img data-ratio="0.26296296296296295" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsricfibFZF5eW4zDYtLZWN1Yibx3IE6f8fSSTFjBq5YRbd9cA9kwkMcIYg/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsricfibFZF5eW4zDYtLZWN1Yibx3IE6f8fSSTFjBq5YRbd9cA9kwkMcIYg/640?wx_fmt=png"><figcaption><br></figcaption></figure><p data-tool="mdnice编辑器"><strong>3.不去批次降维聚类</strong></p><section>不去批次的降维聚类是和以前的Seruat的流程一样的。</section><pre data-tool="mdnice编辑器"><span></span><code><span># unintegrated</span><br>obj &lt;- FindNeighbors(obj, dims = <span>1</span>:<span>30</span>, reduction = <span>"pca"</span>)<br>obj &lt;- FindClusters(obj, resolution = <span>2</span>, cluster.name = <span>"unintegrated_clusters"</span>)<br><br>obj &lt;- RunUMAP(obj, dims = <span>1</span>:<span>30</span>, reduction = <span>"pca"</span>, reduction.name = <span>"umap.unintegrated"</span>)<br><span># visualize by batch and cell type annotation</span><br><span># cell type annotations were previously added by Azimuth</span><br>pdf(<span>"/seurat/v5/test/test1/label_unintegrated.pdf"</span>,width=<span>15</span>,height=<span>7</span>)<br>DimPlot(obj, reduction = <span>"umap.unintegrated"</span>, group.by = c(<span>"Method"</span>, <span>"predicted.celltype.l2"</span>))<br>dev.off()<br></code></pre><p data-tool="mdnice编辑器">结果:</p><figure data-tool="mdnice编辑器"><img data-ratio="0.46111111111111114" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsz38j2JibYicow1gcl6h1zUSXKSxhIhvWy1icjXBqbict2IJ3Vh7icWbRciaA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsz38j2JibYicow1gcl6h1zUSXKSxhIhvWy1icjXBqbict2IJ3Vh7icWbRciaA/640?wx_fmt=png"><figcaption><br></figcaption></figure><p data-tool="mdnice编辑器"><strong>4.CCA整合</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># cca</span><br>obj &lt;- IntegrateLayers(<br>  object = obj, method = CCAIntegration,<br>  orig.reduction = <span>"pca"</span>, new.reduction = <span>"integrated.cca"</span>,<br>  verbose = <span>FALSE</span><br>)<br><br>obj &lt;- FindNeighbors(obj, reduction = <span>"integrated.cca"</span>, dims = <span>1</span>:<span>30</span>)<br>obj &lt;- FindClusters(obj, resolution = <span>2</span>, cluster.name = <span>"cca_clusters"</span>)<br><br>obj &lt;- RunUMAP(obj, reduction = <span>"integrated.cca"</span>, dims = <span>1</span>:<span>30</span>, reduction.name = <span>"umap.cca"</span>)<br>p1 &lt;- DimPlot(<br>  obj,<br>  reduction = <span>"umap.cca"</span>,<br>  group.by = c(<span>"Method"</span>, <span>"predicted.celltype.l2"</span>, <span>"cca_clusters"</span>),<br>  combine = <span>FALSE</span><br>)<br><br>pdf(<span>"//seurat/v5/test/test1/label_cca.pdf"</span>,width=<span>10</span>,height=<span>21</span>)<br>wrap_plots(p1, ncol = <span>1</span>)<br>dev.off()<br></code></pre><p data-tool="mdnice编辑器">结果：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.2935185185185185" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsUDtqfoYicdiaMPI4iaTWqCF7mowcqDDibNC1NAmtUdL9kMYCFCyPxvMrXw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsUDtqfoYicdiaMPI4iaTWqCF7mowcqDDibNC1NAmtUdL9kMYCFCyPxvMrXw/640?wx_fmt=png"><figcaption><br></figcaption></figure><p data-tool="mdnice编辑器"><strong>5.Harmony整合</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># harmony</span><br>obj &lt;- IntegrateLayers(<br>  object = obj, method = HarmonyIntegration,<br>  orig.reduction = <span>"pca"</span>, new.reduction = <span>"harmony"</span>,<br>  verbose = FALSE<br>)<br><br>obj &lt;- FindNeighbors(obj, reduction = <span>"harmony"</span>, dims = 1:30)<br>obj &lt;- FindClusters(obj, resolution = 2, cluster.name = <span>"harmony_clusters"</span>)<br><br>obj &lt;- RunUMAP(obj, reduction = <span>"harmony"</span>, dims = 1:30, reduction.name = <span>"umap.harmony"</span>)<br>p2 &lt;- DimPlot(<br>  obj,<br>  reduction = <span>"umap.harmony"</span>,<br>  group.by = c(<span>"Method"</span>, <span>"predicted.celltype.l2"</span>, <span>"harmony_clusters"</span>),<br>  combine = FALSE<br>)<br><br>pdf(<span>"/seurat/v5/test/test1/label_harmony.pdf"</span>,width=10,height=21)<br>wrap_plots(p2, ncol = 1)<br>dev.off()<br></code></pre><p data-tool="mdnice编辑器">结果：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.27685185185185185" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsXujhk2OibwaVyVQKGMCVFqPhg9hqXtswNz5feRjDmicCo1icWexF7sNgw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsXujhk2OibwaVyVQKGMCVFqPhg9hqXtswNz5feRjDmicCo1icWexF7sNgw/640?wx_fmt=png"><figcaption><br></figcaption></figure><p data-tool="mdnice编辑器"><strong>6.RPCA整合</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># RPCA</span><br>obj &lt;- IntegrateLayers(<br>  object = obj, method = RPCAIntegration,<br>  orig.reduction = <span>"pca"</span>, new.reduction = <span>"integrated.rpca"</span>,<br>  verbose = <span>FALSE</span><br>)<br><br>obj &lt;- FindNeighbors(obj, reduction = <span>"integrated.rpca"</span>, dims = <span>1</span>:<span>30</span>)<br>obj &lt;- FindClusters(obj, resolution = <span>2</span>, cluster.name = <span>"rpca_clusters"</span>)<br><br>obj &lt;- RunUMAP(obj, reduction = <span>"integrated.rpca"</span>, dims = <span>1</span>:<span>30</span>, reduction.name = <span>"umap.rpca"</span>)<br>p3 &lt;- DimPlot(<br>  obj,<br>  reduction = <span>"umap.rpca"</span>,<br>  group.by = c(<span>"Method"</span>, <span>"predicted.celltype.l2"</span>, <span>"rpca_clusters"</span>),<br>  combine = <span>FALSE</span><br>)<br><br>pdf(<span>"/seurat/v5/test/test1/label_rpca.pdf"</span>,width=<span>10</span>,height=<span>21</span>)<br>wrap_plots(p3, ncol = <span>1</span>)<br>dev.off()<br></code></pre><p data-tool="mdnice编辑器">结果：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.28703703703703703" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsHrbJQfQxX3CYZVHlmx2BBrESfT5pjTJD3S5vRvotxeVmEkPskhJysQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsHrbJQfQxX3CYZVHlmx2BBrESfT5pjTJD3S5vRvotxeVmEkPskhJysQ/640?wx_fmt=png"><figcaption><br></figcaption></figure><p data-tool="mdnice编辑器"><strong>7.合并layers结果</strong></p><section>合并layers主要是为了适配后续的一些分析结果流程，将layers子集恢复成一个data和counts，使用的函数是JoinLayers函数进行。</section><pre data-tool="mdnice编辑器"><span></span><code><span># merge layers</span><br>obj &lt;- JoinLayers(obj)<br>obj<br></code></pre><p data-tool="mdnice编辑器"><strong>8.额外说明</strong></p><section><strong>8.1FastMNN的方法：</strong></section><pre data-tool="mdnice编辑器"><span></span><code>obj &lt;- IntegrateLayers(<br>  object = obj, method = FastMNNIntegration,<br>  new.reduction = <span>"integrated.mnn"</span>,<br>  verbose = <span>FALSE</span><br>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.14646464646464646" data-type="png" data-w="594" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwyts5MkzGYtZ2M8ysoAYsdeAYe1PTMzv6PJHKOA4EtQILBTgibvhD0XDjKw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwyts5MkzGYtZ2M8ysoAYsdeAYe1PTMzv6PJHKOA4EtQILBTgibvhD0XDjKw/640?wx_fmt=png"><figcaption><br></figcaption></figure><section>运行后，直接报错，报错为FastMNNIntegration这个函数没有找到！</section><section>然后我在Seurat和SeuratWrappers等R包的Namespace的export里面，找了半天都没有找到这个函数外放出来，已经反馈给Seurat作者提交bug了。</section><p><strong>8.2scVI的方法：</strong></p><pre data-tool="mdnice编辑器"><span></span><code>obj &lt;- IntegrateLayers(<br>  object = obj, method = scVIIntegration,<br>  new.reduction = <span>"integrated.scvi"</span>,<br>  conda_env = <span>"/miniconda3/envs/scvitools"</span>, verbose = <span>FALSE</span><br>)<br></code></pre><section>报错了！！！</section><figure data-tool="mdnice编辑器"><img data-ratio="0.04259259259259259" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsfbs12wsIv6WybFmNNzDAFGZIcDOXMmJnezibpC4gtyYyxNqBS9WbFTw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsfbs12wsIv6WybFmNNzDAFGZIcDOXMmJnezibpC4gtyYyxNqBS9WbFTw/640?wx_fmt=png"><figcaption><br></figcaption></figure><section>至今这个报错还没解决，也提交给作者了。这几天被这两个折磨的，看了他很多源码，有些写法确实有些启示！但是这些报错还是需要解决的。</section><h2 data-tool="mdnice编辑器"><span></span>写在后面</h2><section>seuratv5的版本，目前我安装的版本是4.9.9.9040。</section><section>然后它最近又双叒更新了：</section><figure data-tool="mdnice编辑器"><img data-ratio="0.29375" data-type="png" data-w="320" data-src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsgWzOf1KAV9ibeJOy6x28jEQTXSXiaLY6uR1k2lG3pricMNXrWVQMicxScw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/NZV5ovF8kLt52NgNHATQSHnnibyNgwytsgWzOf1KAV9ibeJOy6x28jEQTXSXiaLY6uR1k2lG3pricMNXrWVQMicxScw/640?wx_fmt=png"><figcaption><br></figcaption></figure><section>可惜还不是正式的seuratv5版本，目前根据目前测试的情况，已经不打算继续测试了，等正式的5.0.0版本出来再进行测试了，抢先版目前存在很多问题，包括前面提到的依赖包的安装问题和这次测试出现的一些问题。</section><section>不过就目前我测试的整合批次方法的集成这块，感觉集成的方法，更加方便大家对不同去批次方法在seurat中的实现，只要一个函数，确实省去了很多麻烦的步骤。</section><section>期待正式的5.0.0版本的出台，让我们在v5时代相遇！</section><h2 data-tool="mdnice编辑器"><span></span>参考</h2><p data-tool="mdnice编辑器">https://satijalab.org/seurat/articles/seurat5_integration.html</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/AjvB6D3WSW1qhArlVEiehw",target="_blank" rel="noopener noreferrer">原文链接</a>
