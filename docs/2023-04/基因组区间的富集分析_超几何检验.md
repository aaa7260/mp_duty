---
title: "基因组区间的富集分析：超几何检验"
date: 2023-04-04T14:14:29Z
draft: ["false"]
tags: [
  "fetched",
  "生信小知识"
]
categories: ["Acdemic"]
---
基因组区间的富集分析：超几何检验 by 生信小知识
------
<div><section><span></span><h2><span>基因组区间的富集分析：超几何检验</span></h2><blockquote><p>微信公众号：<strong>生信小知识</strong><br>关注可了解更多的生物信息学教程及知识。问题或建议，请公众号留言;</p></blockquote><h3><span>目录</span></h3><p><span><span>前言</span></span><span><span>1. 预处理</span></span><span><span><span>1.1 基因组切分</span></span></span><span><span><span>1.2 目的区域切分</span></span></span><span><span>2. 超几何检验策略</span></span><span><span><span>2.1 自定义函数</span></span></span><span><span><span>2.2 输入数据格式</span></span></span><span><span><span>2.3 输出数据解读</span></span></span><span><span>后记</span></span></p><h3><span>前言</span></h3><p>今天简单记录下对于基因组上某个区间进行富集分析的方法。</p><p>关于富集分析的统计学方法其实有2种，这两种我在过去都有详细介绍过：</p><ul><li><p><span>超几何检验</span></p></li><li><p><span>GSEA富集分析（PMID: 16199517<span es-id-type="PMID" es-id="16199517" es-collect-button-id="0"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 1000 1000" enable-background="new 0 0 1000 1000" height="1em"><g><path d="M852.3,135.6l-47.7,48.3c157.6,178.7,157.4,451,0.1,631l48.8,49.5C1035.9,672.1,1035.5,327.2,852.3,135.6z M740.9,248.6l-49.3,49.9c96.1,115.5,96.1,285.8,0.5,402.1l48.8,49.6C863.4,606.1,863.6,391.5,740.9,248.6z M195.4,183.9l-47.7-48.3c-183.2,191.6-183.6,536.5-1.2,728.8l48.8-49.5C37.9,635,37.8,362.6,195.4,183.9z M259.1,248.6C136.4,391.5,136.6,606.1,259,750.3l48.8-49.6c-95.6-116.4-95.6-286.6,0.4-402.1L259.1,248.6z M499.8,340.4c-87.3,0-158.1,71.8-158.1,160.4c0,88.5,70.8,160.4,158.1,160.4c87.3,0,158.1-71.8,158.1-160.4C657.8,412.2,587,340.4,499.8,340.4z"></path></g></svg></span>）</span></p></li></ul><p>所以今天关于原理部分，不在我的笔记范围之中。今天只是<strong>单纯从代码的角度</strong>记录如何实现这一目的。</p><p>在我所需要的分析，是将基因组进行分割成为一个个的bin后进行统计，因此我的检验也是<strong>以bin为单位</strong>进行的。如果你们的目的和我的不一致，可以参考，但是不要直接套用。</p><section><mp-common-profile data-pluginname="mpprofile" data-weui-theme="light" data-id="MjM5NTk0Mzg2Nw==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJo1mibx7zpDpGwiaZDqzB9Z9RLOTh583lDKece7X3iczxtY5qS4neHe0GNGDvicK3aQPTWxiaBTuPtfJKg/0?wx_fmt=png" data-nickname="生信小知识" data-alias="" data-signature="记录自学生信的技术之路，将积累的经验为有相同需求的小白们铺平道路，避免误入我走过的弯路～" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><h3><span>1. 预处理</span></h3><h4><span>1.1 基因组切分</span></h4><p>我们需要先拿到基因组切割成bin后的坐标。</p><blockquote><p>因为不同物种不同基因组版本的坐标不同，因此大家自己选择合适的坐标进行处理。我的分析是针对<strong>人hg38</strong>的坐标进行。</p></blockquote><p>具体而言，我们需要拿到以下几个文件：</p><ol><li><p><span>基因组长度统计文件</span></p></li></ol><pre><code>wget https://hgdownload-test.gi.ucsc.edu/goldenPath/mm9/bigZips/mm10.chrom.sizes<br>wget https://hgdownload-test.gi.ucsc.edu/goldenPath/hg38/bigZips/hg38.chrom.sizes<br>wget https://hgdownload-test.gi.ucsc.edu/goldenPath/hg19/bigZips/hg19.chrom.sizes<br></code></pre><ol start="2"><li><p><span>基因组blacklist文件</span></p></li></ol><pre><code>wget https://github.com/Boyle-Lab/Blacklist/raw/master/lists/mm10-blacklist.v2.bed.gz<br>wget https://github.com/Boyle-Lab/Blacklist/raw/master/lists/hg19-blacklist.v2.bed.gz<br>wget https://github.com/Boyle-Lab/Blacklist/raw/master/lists/hg38-blacklist.v2.bed.gz<br></code></pre><p>然后我们就可以进行处理了。</p><blockquote><p>对于人hg38的染色体，我只关心chr.1_22XY，因此我手动去除了其他的染色体。大家自己根据自己的兴趣进行处理。</p></blockquote><p>首先根据基因组长度文件，将基因组分割成为200bp大小的bin：</p><pre><code>$ bedtools makewindows -g hg38.chrom.1_22XY.sizes -w 200 &gt; windows.bed<br>$ head windows.bed<br>chr1    0       200<br>chr1    200     400<br>chr1    400     600<br>chr1    600     800<br>chr1    800     1000<br>chr1    1000    1200<br>chr1    1200    1400<br>chr1    1400    1600<br>chr1    1600    1800<br>chr1    1800    2000<br></code></pre><p>然后去除blacklist区域：</p><pre><code>$ bedtools subtract -a windows.bed -b hg38-blacklist.v2.bed -A &gt; windowsNoBlack.bed (windowsNoBlack.noid.bed)<br>$ head windowsNoBlack.bed<br>chr1    792600  792800<br>chr1    792800  793000<br>chr1    793000  793200<br>chr1    793200  793400<br>chr1    793400  793600<br>chr1    793600  793800<br>chr1    793800  794000<br>chr1    794000  794200<br>chr1    794200  794400<br>chr1    794400  794600<br></code></pre><p>这样我们就有了具体bin坐标了，后面为了方便进行统计检验在R中进行分析，我们还需要将其转变为GRanges对象（R中进行）：</p><pre><code>rm(list = ls())<br>options(stringAsFactors = <span>F</span>)<br><span>library</span>(GenomicFeatures)<br><br>dat &lt;- data.table::fread(file = <span>"data/raw_data/windowsNoBlack.bed"</span>, header = <span>F</span>, sep = <span>"\t"</span>, fill = <span>T</span>, skip = <span>""</span>, data.table=<span>F</span>)<br>dat[<span>1</span>:<span>4</span>, ]<br><span>##     V1     V2     V3</span><br><span>## 1 chr1 792600 792800</span><br><span>## 2 chr1 792800 793000</span><br><span>## 3 chr1 793000 793200</span><br><span>## 4 chr1 793200 793400</span><br><br>bin &lt;- GRanges(seqnames = dat[,<span>1</span>],<br>               ranges = IRanges(start = dat[,<span>2</span>]+<span>1</span>,<br>                                end = dat[,<span>3</span>]))<br>bin<br><span>## GRanges object with 14305237 ranges and 0 metadata columns:</span><br><span>##              seqnames            ranges strand</span><br><span>##                 &lt;Rle&gt;         &lt;IRanges&gt;  &lt;Rle&gt;</span><br><span>##          [1]     chr1     792601-792800      *</span><br><span>##          [2]     chr1     792801-793000      *</span><br><span>##          [3]     chr1     793001-793200      *</span><br><span>##          [4]     chr1     793201-793400      *</span><br><span>##          [5]     chr1     793401-793600      *</span><br><span>##          ...      ...               ...    ...</span><br><span>##   [14305233]    chr21 46681601-46681800      *</span><br><span>##   [14305234]    chr21 46681801-46682000      *</span><br><span>##   [14305235]    chr21 46682001-46682200      *</span><br><span>##   [14305236]    chr21 46682201-46682400      *</span><br><span>##   [14305237]    chr21 46682401-46682600      *</span><br><span>##   -------</span><br><span>##   seqinfo: 24 sequences from an unspecified genome; no seqlengths</span><br><br>saveRDS(bin,file = <span>"windowsNoBlack.rds"</span>)<br></code></pre><blockquote><p>关于<a href="https://mp.weixin.qq.com/s?__biz=MjM5NTk0Mzg2Nw==&amp;mid=2247487716&amp;idx=1&amp;sn=7729fe5dcd7c97ea2bc7f47bd897f482&amp;scene=21#wechat_redirect" data-linktype="2">不同文件格式的坐标系统</a>，所以我们知道这个文件的坐标系统是0-based，而在GRanges对象中，一般都是1-based的坐标系统，所以在坐标上，我们对所有的<strong>start坐标+1</strong>。</p></blockquote><h4><span>1.2 目的区域切分</span></h4><p>这里其实类似于富集分析中感兴趣的基因集（参考转录组分析的概念）</p><p>为了让分析更加普适，这里我同样将感兴趣的基因组坐标转变为以bin为单位的GRanges对象。</p><p>为了方便演示，这里我对gtf文件中的一些特征进行处理，收集在gtf文件中，所有TSS和TES的坐标，将其转变为以bin为单位的GRanges对象。</p><p>这里我使用的是人hg38的注释文件：<code>gencode.v40.annotation.gtf.gz</code></p><p>下面则直接在R中进行操作：</p><pre><code>rm(list = ls())<br>options(stringAsFactors = <span>F</span>)<br><span>library</span>(GenomicFeatures)<br><br>txdb &lt;- makeTxDbFromGFF(<span>"gencode.v40.annotation.gtf.gz"</span>)<br>saveDb(txdb, file=file)<br></code></pre><p>收集所有 <code>TSS±200bp</code> 的bin：</p><pre><code>tss &lt;- promoters(txdb, upstream=<span>200</span>, downstream=<span>200</span>, columns=c(<span>"TXNAME"</span>, <span>"GENEID"</span>))<br>tss<br>bin_tss &lt;- bin[bin %over% tss]<br><br>saveRDS(bin_tss, file = “tss_bin.rds)<br></code></pre><p>更多的就不做举例了。我们就用这些进行简单演示。</p><h3><span>2. 超几何检验策略</span></h3><p>详细原理参考之前推文：</p><ul><li><p><a href="https://mp.weixin.qq.com/s?__biz=MjM5NTk0Mzg2Nw==&amp;mid=2247488231&amp;idx=1&amp;sn=ea373cfc0ab9514feaf146218e5f490f&amp;scene=21#wechat_redirect" data-linktype="2">超几何检验再详解</a></p></li></ul><h4><span>2.1 自定义函数</span></h4><p>为了方便使用，我直接写了一个函数，利用这个函数，我们就可以直接进行检验了：</p><pre><code>enrichment &lt;- <span><span>function</span><span>(interest_regions,<br>                       Total_number,<br>                       interest_Terms,<br>                       anno_interest_Terms,<br>                       filter = F, <br>                       log2fc = <span>2</span>, <br>                       fdr = <span>1e-3</span>)</span> </span>{<br>  <span># All DEGs</span><br>  n &lt;- length(interest_regions)<br><br>  <span># All genes</span><br>  N &lt;- Total_number<br><br>  <span># k and M</span><br>  res_l &lt;- sapply(interest_Terms, <span><span>function</span><span>(x)</span></span>{<br>    <span># M: All genes in TermA</span><br>    M &lt;- length(x)<br>    <span># k: DEGs in TermA</span><br>    k &lt;- sum(interest_regions %over% x)<br><br>    <span># enrichment P: phyper(k-1,M,N-M,n,lower.tail = F)</span><br>    p &lt;- phyper(k<span>-1</span>,M,N-M,n,lower.tail = F)<br><br>    <span>return</span>(c(p,N,M,n,k))<br>  })<br><br>  res_l &lt;- <span>as</span>.data.frame(t(res_l))<br>  colnames(res_l) &lt;- c(<span>"P_hyper"</span>,<span>"All_genes_N"</span>,<span>"All_genes_in_term_M"</span>,<span>"All_DEGs_n"</span>,<span>"DEGs_in_Term_k"</span>)<br><br>  <span># P adjust</span><br>  FDR = p.adjust(res_l$P,method = <span>"bonferroni"</span>)<br><br>  <span># enrichment fold change: (k/n)/(N/M)=kN/nM</span><br>  term_in_DEG &lt;- res_l$DEGs_in_Term_k / res_l$All_DEGs_n<br>  term_in_BG &lt;- res_l$All_genes_in_term_M / res_l$All_genes_N<br><br>  fc &lt;- term_in_DEG / term_in_BG<br>  fc_res &lt;- data.frame(Log2FC = log2(fc),<br>                       term_in_DEG = term_in_DEG,<br>                       term_in_BG = term_in_BG)<br><br>  <span># annotation</span><br>  anno &lt;- cbind(fc_res,FDR,res_l,anno_interest_Terms)<br><br>  <span>if</span> (filter) {<br>    anno &lt;- anno[anno$Log2FC&gt;=log2fc &amp; anno$FDR&lt;fdr,]<br>  }<br><br>  <span>return</span>(anno)<br>}<br></code></pre><h4><span>2.2 输入数据格式</span></h4><p>关于这个函数的input解释：</p><ul><li><p><code>interest_regions</code>：我们想要测试的区域，以 bin 为单位。格式参考上文 <strong>1.2 部分的 `bin`</strong> 结果。</p></li><li><p><code>Total_number</code>：整个基因组上有多少个 bin。该值在选择上需要根据 <code>interest_regions</code> 进行决定。</p></li><li><p><code>interest_Terms</code>：我们感兴趣区域列表，例如上文演示找到的所有TSS区域的bin。注意：该变量是一个<strong>列表</strong>，如果你只有一个感兴趣的区域，也需要将该区域变量转为列表进行分析。这里可以理解为GO富集分析中不同的term通路。</p></li><li><p><code>anno_interest_Terms</code>：对于 <code>interest_Terms</code> 的一个注释文件，格式为<strong>数据框</strong>。</p></li><li><p><code>filter</code>：是否对富集分析的结果进行过滤，默认不过滤。</p></li><li><p><code>log2fc</code>：如果对结果进行过滤时，log2(富集程度) 的阈值。默认为2，即富集程度超过4倍。</p></li><li><p><code>fdr</code>：如果对结果进行过滤时，统计检验FDR的阈值。默认为1e-3。</p></li></ul><p>下面简单展示下input变量的格式：</p><pre><code>&gt; interest_regions<br><span>## GRanges object with 11430160 ranges and 1 metadata column:</span><br><span>##              seqnames            ranges strand |       state</span><br><span>##                 &lt;Rle&gt;         &lt;IRanges&gt;  &lt;Rle&gt; | &lt;character&gt;</span><br><span>##          [1]     chr1     792601-792800      * |        no_0</span><br><span>##          [2]     chr1     792801-793000      * |        no_0</span><br><span>##          [3]     chr1     793001-793200      * |        no_0</span><br><span>##          [4]     chr1     793201-793400      * |        no_0</span><br><span>##          [5]     chr1     793401-793600      * |        no_0</span><br><span>##          ...      ...               ...    ... .         ...</span><br><span>##   [11430156]    chr21 46681601-46681800      * |        no_0</span><br><span>##   [11430157]    chr21 46681801-46682000      * |        no_0</span><br><span>##   [11430158]    chr21 46682001-46682200      * |        no_0</span><br><span>##   [11430159]    chr21 46682201-46682400      * |        no_0</span><br><span>##   [11430160]    chr21 46682401-46682600      * |        no_0</span><br><span>##   -------</span><br><span>##   seqinfo: 24 sequences from an unspecified genome; no seqlengths</span><br><br>&gt; Total_number<br><span>## [1] 14305237</span><br><br>&gt; interest_Terms<br><span>## GRangesList object of length 1:</span><br><span>## $tss</span><br><span>## GRanges object with 364023 ranges and 0 metadata columns:</span><br><span>##            seqnames            ranges strand</span><br><span>##               &lt;Rle&gt;         &lt;IRanges&gt;  &lt;Rle&gt;</span><br><span>##        [1]     chr1     803601-803800      *</span><br><span>##        [2]     chr1     803801-804000      *</span><br><span>##        [3]     chr1     804001-804200      *</span><br><span>##        [4]     chr1     809801-810000      *</span><br><span>##        [5]     chr1     810001-810200      *</span><br><span>##        ...      ...               ...    ...</span><br><span>##   [364019]    chr21 46656801-46657000      *</span><br><span>##   [364020]    chr21 46657001-46657200      *</span><br><span>##   [364021]    chr21 46667001-46667200      *</span><br><span>##   [364022]    chr21 46667201-46667400      *</span><br><span>##   [364023]    chr21 46667401-46667600      *</span><br><span>##   -------</span><br><span>##   seqinfo: 24 sequences from an unspecified genome; no seqlengths</span><br><br>&gt; anno_interest_Terms<br><span>##   type</span><br><span>## 1  tss</span><br>&gt; class(regionAnno)<br><span>## [1] "data.frame"</span><br></code></pre><h4><span>2.3 输出数据解读</span></h4><p>我们用上述数据做一个分析，对结果进行解读：</p><pre><code>&gt; anno &lt;- enrichment(interest_regions, Total_number, interest_Terms, anno_interest_Terms, filter=<span>F</span>)<br>&gt; anno<br><span>##          Log2FC term_in_DEG  term_in_BG FDR P_hyper All_genes_N All_genes_in_term_M All_DEGs_n DEGs_in_Term_k type</span><br><span>## tss  -0.7788763 0.014830938 0.025446835   1       1    14305237              364023   11430160         169520  tss</span><br></code></pre><p>关于结果的解读：</p><ul><li><p><code>Log2FC</code>：log2(富集程度) ，该值 = <code>log2(term_in_DEG/term_in_BG)</code></p></li><li><p><code>term_in_DEG</code>：interest_regions 与 interest_Terms 存在有overlap的bin数据占interest_regions的百分比，该值 = <code>log2(DEGs_in_Term_k/All_DEGs_n)</code></p></li><li><p><code>term_in_BG</code>：interest_regions 与 interest_Terms 存在有overlap的bin数据占整个基因组的百分比，该值 = <code>log2(All_genes_in_term_M/All_genes_N)</code></p></li><li><p><code>FDR</code>：FDR统计值</p></li><li><p><code>P_hyper</code>：未矫正的P值</p></li><li><p><code>All_genes_N</code>：基因组一共有多少bin</p></li><li><p><code>All_genes_in_term_M</code>：我们感兴趣的interest_Terms中一共有多少bin</p></li><li><p><code>All_DEGs_n</code>：interest_regions中一共有多少bin</p></li><li><p><code>DEGs_in_Term_k</code>：interest_regions 与 interest_Terms 存在有overlap的bin数</p></li><li><p><code>type</code>：interest_Terms的注释信息，来自我们input时提供的 <code>regionAnno</code></p></li></ul><h3><span>后记</span></h3><p>后面再分享关于GSEA的算法代码吧~<span></span></p><span></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/80TR3pWHHXsfhZDZuYOMIw",target="_blank" rel="noopener noreferrer">原文链接</a>
