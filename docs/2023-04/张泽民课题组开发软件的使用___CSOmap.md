---
title: "张泽民课题组开发软件的使用---CSOmap"
date: 2023-04-28T17:03:28Z
draft: ["false"]
tags: [
  "fetched",
  "东林的扯淡小屋"
]
categories: ["Acdemic"]
---
张泽民课题组开发软件的使用---CSOmap by 东林的扯淡小屋
------
<div><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="http"><code><span># <span>install.packages("devtools")</span></span></code><code><span>#devtools::install_github("lijxug/CSOmapR")</span></code><code><span><br></span></code><code><span># install CSOmapR.demo package for easy-loading demo data</span></code><code><span># devtools::install_github("lijxug/CSOmapR.demo")</span></code><code><span><br></span></code><code><span>#Load demo dataset</span></code><code><span>library(CSOmapR)</span></code><code><span>library(CSOmapR.demo)</span></code><code><span>invisible(TPM)</span></code><code><span>invisible(LR)</span></code><code><span>invisible(labelData)</span></code><code><span><br></span></code><code><span><br></span></code><code><span>head(TPM[1:4,1:4])</span></code><code><span>head(LR)</span></code><code><span>head(labelData)</span></code><code><span>macrophage&lt;-readRDS("macrophage.rds")</span></code><code><span>TPM=as.data.frame(macrophage[["RNA"]]@counts) %&gt;% apply(2,function(x){x/sum(x) * 10000})</span></code><code><span>#https://blog.csdn.net/m0_58549466/article/details/125730805</span></code><code><span><br></span></code><code><span><br></span></code><code><span>macrophage[["celltype"]]&lt;-Idents(macrophage)</span></code><code><span>head(macrophage@meta.data)</span></code><code><span>x = Idents(object = macrophage)</span></code><code><span>head(x)</span></code><code><span>write.csv(x,"labelData.csv")</span></code><code><span>labelData&lt;-read.csv("labelData.csv")</span></code><code><span>colnames(labelData)&lt;-c("cells","labels")</span></code><code><span># y&lt;-macrophage@meta.data$seurat_clusters</span></code><code><span># head(y)</span></code><code><span># x&lt;-as.data.frame(x)</span></code><code><span># head(x)</span></code><code><span># y&lt;-as.data.frame(y)</span></code><code><span># head(y)</span></code><code><span># new&lt;-cbind(x,y)</span></code><code><span># head(new)</span></code><code><span># colnames(new)&lt;-c("cells","labels")</span></code><code><span># head(new)</span></code><code><span><br></span></code><code><span>#Calculate optimized 3D coordinates</span></code><code><span>affinityMat = getAffinityMat(TPM, LR, verbose = T)</span></code><code><span><br></span></code><code><span>coords_res = runExactTSNE_R(</span></code><code><span>  X = affinityMat,</span></code><code><span>  no_dims = 3,</span></code><code><span>  max_iter = 1000,</span></code><code><span>  verbose = T</span></code><code><span>)</span></code><code><span>coords = coords_res$Y</span></code><code><span>rownames(coords) &lt;- colnames(TPM)</span></code><code><span>colnames(coords) &lt;- c('x', 'y', 'z')</span></code><code><span>#Visualization(by 3D density)</span></code><code><span>require(dplyr)</span></code><code><span># arrange data</span></code><code><span>coords_tbl = bind_cols(cellName = rownames(coords), as.data.frame(coords))</span></code><code><span><br></span></code><code><span>join_vec = setNames(colnames(labelData)[1], nm = colnames(coords_tbl)[1])</span></code><code><span>cellinfo_tbl = left_join(coords_tbl, labelData, by = join_vec)</span></code><code><span><br></span></code><code><span>density_obj = getDensity3D(cellinfo_tbl$x, cellinfo_tbl$y, cellinfo_tbl$z)</span></code><code><span><br></span></code><code><span>head(density_obj)</span></code><code><span><br></span></code><code><span>p_3Ddensity = plot3D(cellinfo_tbl, color_by = "density", title = "3D density")</span></code><code><span>p_3Ddensity = plot3D(cellinfo_tbl, color_by = "labels", title = "3D density")</span></code><code><span>head(cellinfo_tbl$labels)</span></code><code><span>head(p_3Ddensity)</span></code><code><span>#Get significance</span></code><code><span>signif_results = getSignificance(coords, labels = cellinfo_tbl$labels, verbose = T)</span></code><code><span>contribution_list = getContribution(TPM, LR, signif_results$detailed_connections)</span></code><code><span>head(signif_results$qvalue)</span></code><code><span>head(contribution_list)</span></code><code><span><br></span></code><code><span><br></span></code><code><span>#第一行是对cellinfo_tbl中的数据进行筛选，只留 |z|&lt;0.2的细胞，0.2可以自己调整。因为很难有细胞的z坐标正好等于0</span></code><code><span>cellinfo_tbl = cellinfo_tbl %&gt;% mutate(density = density_obj)</span></code><code><span>section_z0 = cellinfo_tbl[which(cellinfo_tbl$z &lt; 0.2 &amp; cellinfo_tbl$z &gt; -0.2),]</span></code><code><span>library(ggplot2)</span></code><code><span>ggplot(data = section_z0, aes(x = x, y = y, color = labels)) +</span></code><code><span>  geom_point()+theme_bw()</span></code><code><span><br></span></code><code><span>section_z0 = cellinfo_tbl[which(cellinfo_tbl$z &lt; 2 &amp; cellinfo_tbl$z &gt; -2),]</span></code><code><span>library(ggplot2)</span></code><code><span>ggplot(data = section_z0, aes(x = x, y = y, color = labels)) +</span></code><code><span>  geom_point()+theme_bw()</span></code><code><span>  </span></code><code><span>#When dealing with large dataset</span></code><code><span><span>#We provide two options</span>: optimize coordinates through tSNE(BH algorithm), or downsample the original huge dataset first.</span></code><code><span><br></span></code><code><span><span># under development</span></span></code><code><span><span># Citation</span></span></code><code><span><span># Ren, X., Zhong, G., Zhang, Q., Zhang, L., Sun, Y., and Zhang, Z. (2020). Reconstruction of cell spatial organization from single-cell RNA sequencing data based on ligand-receptor mediated self-assembly. Cell Res.</span></span></code><code><span><span>#https://github.com/lijxug/CSOmapR</span></span></code><code><span><br></span></code></pre></section><p><img data-galleryid="" data-ratio="0.3962962962962963" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBp3ob0tzg08zbVjUNVCzKOialseVGvgkIo21HXYIUoZmhIDJlkHCMWgSialeR8rickrxeicGEoS3RhZsA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBp3ob0tzg08zbVjUNVCzKOialseVGvgkIo21HXYIUoZmhIDJlkHCMWgSialeR8rickrxeicGEoS3RhZsA/640?wx_fmt=png"></p><p>结果是一个球：<br></p><p><img data-galleryid="" data-ratio="1.0236518448438978" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBp3ob0tzg08zbVjUNVCzKOia3NyELMJZ5U1ickgIcPtRG0TA8YFrEhFJow7RtWzrR01uzjicMTfBy3cA/640?wx_fmt=png" data-type="png" data-w="1057" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBp3ob0tzg08zbVjUNVCzKOia3NyELMJZ5U1ickgIcPtRG0TA8YFrEhFJow7RtWzrR01uzjicMTfBy3cA/640?wx_fmt=png"></p><p>取了一个截面：<br></p><p><img data-galleryid="" data-ratio="0.9481481481481482" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBp3ob0tzg08zbVjUNVCzKOiawIHEJEBeFiaVbcW58cWUnz5eBvsp4XRUGwicZt1Ph2nuuBWbIQ9EE1iaA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBp3ob0tzg08zbVjUNVCzKOiawIHEJEBeFiaVbcW58cWUnz5eBvsp4XRUGwicZt1Ph2nuuBWbIQ9EE1iaA/640?wx_fmt=png"></p><p>修改了一下只留 |z|&lt;2的细胞，模式感觉更好了一点</p><p><img data-galleryid="" data-ratio="0.9527777777777777" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBp3ob0tzg08zbVjUNVCzKOiaFLrCibEofX0mb0frBJQosJya7GV6zlWvMlck8zXJoplNZicBTMWXRNSA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBp3ob0tzg08zbVjUNVCzKOiaFLrCibEofX0mb0frBJQosJya7GV6zlWvMlck8zXJoplNZicBTMWXRNSA/640?wx_fmt=png">可能是因为我这全是巨噬细胞的原因，比较纯，没有办法推断空间关系。</p><p><img data-galleryid="" data-ratio="0.3574074074074074" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBp3ob0tzg08zbVjUNVCzKOiaLERc04pfYHrq8qbJyOYwP4YrKHEpTjG9xViaysTliczXqJI5RBiccpHXg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBp3ob0tzg08zbVjUNVCzKOiaLERc04pfYHrq8qbJyOYwP4YrKHEpTjG9xViaysTliczXqJI5RBiccpHXg/640?wx_fmt=png"></p><p>按照老师的说法，其实就是看这个qvalue，低于0.05的就认为是有可能有空间的接触。</p><p><br></p><p>参考资料：<br></p><p>https://www.nature.com/articles/s41422-020-0353-2</p><p>https://github.com/lijxug/CSOmapR</p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/_S5rUxE9deCgikmFG5YMhw",target="_blank" rel="noopener noreferrer">原文链接</a>
