---
title: "单细胞热图我要整整齐齐"
date: 2023-04-10T01:18:41Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
单细胞热图我要整整齐齐 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>最近学徒在分享单细胞数据集实战的时候，发现一个简单的各个单细胞亚群特异性标记基因热图都绘制的很奇怪，感觉大家仅仅是跑标准代码，而不能花时间去研发和提高，做出有自己特色的分析。比如热图首先基因不能显示出顺序的区块效果，其次也不设置一下自己的喜欢的配色。</p></blockquote><p data-tool="mdnice编辑器">我们以大家熟知的pbmc3k数据集为例。大家先安装这个数据集对应的包，并且对它进行降维聚类分群，参考前面的例子：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497956&amp;idx=1&amp;sn=5d4deb7cf7b7848b3e2273cbd663bb6a&amp;scene=21#wechat_redirect" data-linktype="2">人人都能学会的单细胞聚类分群注释</a>  ，而且每个亚群找高表达量基因，都存储为Rdata文件。标准代码是：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(SeuratData) <span>#加载seurat数据集  </span><br>getOption(<span>'timeout'</span>)<br>options(timeout=<span>10000</span>)<br><span>#InstallData("pbmc3k")  </span><br>data(<span>"pbmc3k"</span>)  <br>sce &lt;- pbmc3k.final  <br><span>library</span>(Seurat)<br>table(Idents(sce))<br>DimPlot(sce,label = <span>T</span>)<br>sce.markers &lt;- FindAllMarkers(object = sce, only.pos = <span>TRUE</span>, <br>                              min.pct = <span>0.25</span>, <br>                              thresh.use = <span>0.25</span>)<br><span>library</span>(dplyr) <br>top3 &lt;- sce.markers %&gt;% group_by(cluster) %&gt;% top_n(<span>3</span>, avg_log2FC)<br>DoHeatmap(sce ,top3$gene,size=<span>3</span>)<br></code></pre><p data-tool="mdnice编辑器">会得到如下所示的热图：</p><p><img data-galleryid="" data-ratio="0.7184065934065934" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wx5H5Rsyeu0MEBwH2VPqSQvtjFVm7uDOor3iambHu2VVy09kaDXt706icFfkaIx0QkxK2fy6iacpvxkA/640?wx_fmt=png" data-type="png" data-w="1456" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wx5H5Rsyeu0MEBwH2VPqSQvtjFVm7uDOor3iambHu2VVy09kaDXt706icFfkaIx0QkxK2fy6iacpvxkA/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>默认热图</figcaption></figure><p data-tool="mdnice编辑器">如果是针对上面的FindAllMarkers定位到的各个单细胞亚群各自特异性基因，</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(dplyr) <br>top3 &lt;- sce.markers %&gt;% group_by(cluster) %&gt;% top_n(<span>3</span>, avg_log2FC)<br>sce.all &lt;- ScaleData(sce,features =  top3$gene)  <br><span>library</span>(paletteer) <br>color &lt;- c(paletteer_d(<span>"awtools::bpalette"</span>),<br>           paletteer_d(<span>"awtools::a_palette"</span>),<br>           paletteer_d(<span>"awtools::mpalette"</span>))<br>unique(sce.all$celltype)<br>ord = c(<span>'Naive CD4 T'</span> ,<span>'Memory CD4 T'</span>, <span>'CD8 T'</span>, <span>'NK'</span>, <br>        <span>'CD14+ Mono'</span>, <span>'FCGR3A+ Mono'</span> ,<span>'DC'</span>,  <span>'B'</span>,<span>'Platelet'</span>)<br>sce.all$celltype = factor(sce.all$celltype ,levels = ord)<br>ll = split(top10$gene,top10$cluster)<br>ll = ll[ord]<br>rmg=names(table(unlist(ll))[table(unlist(ll))&gt;<span>1</span>])<br>ll = lapply(ll, <span>function</span>(x) x[!x %<span>in</span>% rmg])<br><span>library</span>(ggplot2)<br>DoHeatmap(sce.all,<br>          features = unlist(ll),<br>          group.by = <span>"celltype"</span>,<br>          assay = <span>'RNA'</span>,<br>          group.colors = color,label = <span>F</span>)+<br>   scale_fill_gradientn(colors = c(<span>"white"</span>,<span>"grey"</span>,<span>"firebrick3"</span>))<br><br>ggsave(filename = <span>"marker_pheatmap.pdf"</span>,units = <span>"cm"</span>,width = <span>36</span>,height = <span>42</span>)<br></code></pre><p data-tool="mdnice编辑器">效果如下所示：</p><p><img data-galleryid="" data-ratio="0.7126917712691772" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wx5H5Rsyeu0MEBwH2VPqSQvSFam1l14KTTzy0RrskZZdVCNjQrVR9EH7JPpJeDz5zbsgAiczz0JdYg/640?wx_fmt=png" data-type="png" data-w="1434" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wx5H5Rsyeu0MEBwH2VPqSQvSFam1l14KTTzy0RrskZZdVCNjQrVR9EH7JPpJeDz5zbsgAiczz0JdYg/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>改进的热图</figcaption></figure><p data-tool="mdnice编辑器">如果没有使用FindAllMarkers函数，而是 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513489&amp;idx=1&amp;sn=fffb8aac0b6d6b984fb4f0966b09074f&amp;scene=21#wechat_redirect" data-linktype="2">速度上吊打FindAllMarkers的单细胞亚群特异性高表达基因查询算法</a> ：</p><pre data-tool="mdnice编辑器"><span></span><code><br><span>library</span>(dplyr)  <br>top_10 &lt;- unique(as.character(apply(marker_cosg$names,<span>2</span>,head,<span>10</span>))) <br>sce.all &lt;- ScaleData(sce,features =  top_10  )  <br>table(sce.all$celltype)<br><span>library</span>(paletteer) <br>color &lt;- c(paletteer_d(<span>"awtools::bpalette"</span>),<br>           paletteer_d(<span>"awtools::a_palette"</span>),<br>           paletteer_d(<span>"awtools::mpalette"</span>))<br><br>ord = names(marker_cosg$names)<br>sce.all$celltype = factor(sce.all$celltype ,levels = ord)<br>table(sce.all$celltype)<br><br>ll =  as.list(marker_cosg$names)<br>ll = ll[ord]<br>rmg=names(table(unlist(ll))[table(unlist(ll))&gt;<span>1</span>])<br>ll = lapply(ll, <span>function</span>(x) x[!x %<span>in</span>% rmg])<br><br>DoHeatmap(sce.all,<br>          features = unlist(ll),<br>          group.by = <span>"celltype"</span>,<br>          assay = <span>'RNA'</span>,<br>          group.colors = color,label = <span>T</span>)+<br>  scale_fill_gradientn(colors = c(<span>"white"</span>,<span>"grey"</span>,<span>"firebrick3"</span>))<br><br>ggsave(filename = <span>"marker_pheatmap_by_celltype.pdf"</span>,units = <span>"cm"</span>,width = <span>36</span>,height = <span>42</span>)<br></code></pre><p data-tool="mdnice编辑器">其实原理很简单，就是针对单细胞亚群进行排序，而且必须要跟各个亚群特异性的高表达基因的顺序对应哦。</p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><span>文末友情宣传</span><br></p></section></section><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section> <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247515323&amp;idx=1&amp;sn=3f848867b3daffbca99050bf5287ea3a&amp;chksm=9b4bfc00ac3c7516e2de3045e229a538dd62847e40ee516afed73e966fef6e56feef329d1ee0&amp;scene=21#wechat_redirect" textvalue="数据挖掘（GEO,TCGA,单细胞）2022年暑期班（收官之作）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click">数据挖掘（GEO,TCGA,单细胞）2022年暑期班（收官之作）</a>，快速了解一些生物信息学应用图表</section></li><li><section> <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247515331&amp;idx=1&amp;sn=e3d38ffe89d81e82d65e3669314c9ee4&amp;chksm=9b4bfc78ac3c756e78dce53a9c95c67b9a90c2a08df8c2052eea95022bfd105b6e5b0a1bec3c&amp;scene=21#wechat_redirect" textvalue="生信入门课-2022年暑期班（收官之作）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click">生信入门课-2022年暑期班（收官之作）</a>，你的生物信息学第一课</section></li></ul><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/5gEsVDJYgQfHXzwM7lF3Pw",target="_blank" rel="noopener noreferrer">原文链接</a>
