---
title: "基因组区间的富集分析：GSEA分析"
date: 2023-04-08T08:55:51Z
draft: ["false"]
tags: [
  "fetched",
  "生信小知识"
]
categories: ["Acdemic"]
---
基因组区间的富集分析：GSEA分析 by 生信小知识
------
<div><section><span></span><h2><span>基因组区间的富集分析：GSEA分析</span></h2><blockquote><p>微信公众号：<strong>生信小知识</strong><br>关注可了解更多的生物信息学教程及知识。问题或建议，请公众号留言;</p></blockquote><h3><span>目录</span></h3><p><span><span>前言</span></span><span><span>1. 测试数据</span></span><span><span>2. GSEA检验</span></span><span><span>3. 结果可视化简单展示</span></span><span><span>后记</span></span></p><h3><span>前言</span></h3><p>今天简单记录下对于基因组上某个区间进行富集分析的方法。</p><p>关于富集分析的统计学方法其实有2种，这两种我在过去都有详细介绍过：</p><ul><li><p>超几何检验：<a href="https://mp.weixin.qq.com/s?__biz=MjM5NTk0Mzg2Nw==&amp;mid=2247488865&amp;idx=1&amp;sn=6cb2e04be79254d2a511c23b51da8983&amp;scene=21#wechat_redirect" data-linktype="2">这个前两天已经分享过</a></p></li><li><p><span>GSEA富集分析（PMID: 16199517<span es-id-type="PMID" es-id="16199517" es-collect-button-id="0"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 1000 1000" enable-background="new 0 0 1000 1000" height="1em"><g><path d="M852.3,135.6l-47.7,48.3c157.6,178.7,157.4,451,0.1,631l48.8,49.5C1035.9,672.1,1035.5,327.2,852.3,135.6z M740.9,248.6l-49.3,49.9c96.1,115.5,96.1,285.8,0.5,402.1l48.8,49.6C863.4,606.1,863.6,391.5,740.9,248.6z M195.4,183.9l-47.7-48.3c-183.2,191.6-183.6,536.5-1.2,728.8l48.8-49.5C37.9,635,37.8,362.6,195.4,183.9z M259.1,248.6C136.4,391.5,136.6,606.1,259,750.3l48.8-49.6c-95.6-116.4-95.6-286.6,0.4-402.1L259.1,248.6z M499.8,340.4c-87.3,0-158.1,71.8-158.1,160.4c0,88.5,70.8,160.4,158.1,160.4c87.3,0,158.1-71.8,158.1-160.4C657.8,412.2,587,340.4,499.8,340.4z"></path></g></svg></span>）</span></p></li></ul><p>所以今天关于原理部分，不在我的笔记范围之中。今天只是<strong>单纯从代码的角度</strong>记录如何实现这一目的。</p><p>在我所需要的分析，是将基因组进行分割成为一个个的bin后进行统计，因此我的检验也是<strong>以bin为单位</strong>进行的。如果你们的目的和我的不一致，可以参考，但是不要直接套用。</p><h3><span>1. 测试数据</span></h3><p>我们知道，GSEA分析的核心就是看基因集是否富集在排序后的某一端而已，非常的简单。</p><p>我们直接用实际数据进行演示好了。如果你想拿到我所使用的测试数据，请在公众号后台回复 "<strong>基因组GSEA</strong>" 即可。</p><p>简单展示下所使用到的数据：</p><pre><code>head(geneList)<br><span>## b11367489 b11367490 b11367491 b11367492 b11367493 b11367494</span><br><span>##  16.60265  16.60265  16.60265  16.60265  16.60265  16.60265</span><br>class(geneList)<br><span>## [1] "numeric"</span><br><br>head(target_gene_set)<br><span>##   gs_name ensembl_gene</span><br><span>## 1      s0           b1</span><br><span>## 2      s0           b2</span><br><span>## 3      s0           b3</span><br><span>## 4      s0           b4</span><br><span>## 5      s0           b5</span><br><span>## 6      s0           b6</span><br>class(target_gene_set)<br><span>## [1] "data.frame"</span><br></code></pre><p>做GSEA分析时，所需要的数据其实很简单，只需要2个数据即可：</p><ul><li><p><code>geneList</code>：经过降序（由大到小）排序后的<strong>数字向量</strong>，每个数字有自己的name属性，并且这个name要和 <code>target_gene_set</code> 数据框中的 <code>ensembl_gene</code> 列相一致。</p></li><li><p><code>target_gene_set</code>：一个<strong>数据框</strong>，一共有2列，第1列是我们感兴趣基因集的名字，例如干细胞干性、T细胞活化等等term的名字。第2列则是第1列term条目中所包含的基因名字。</p></li></ul><p>在这里因为基因组已经变成了bin，而我们是针对感兴趣基因组上的区域，所以对应过来：</p><ul><li><p><code>geneList</code>：经过降序（由大到小）排序后的<strong>数字向量</strong>，每个数字的name属性是具体 <strong>bin 的ID</strong>。</p></li><li><p><code>target_gene_set</code>：一个<strong>数据框</strong>，一共有2列，第1列是我们<strong>感兴趣基因组上区域的名字</strong>。第2列则是<strong>这些区域所包含的bin ID</strong>。</p></li></ul><h3><span>2. GSEA检验</span></h3><p>真正的检验其实很简单，只有一个函数就可以搞定：</p><pre><code>result_dat &lt;- clusterProfiler::GSEA(geneList,<br>                                    TERM2GENE = target_gene_set, <br>                                    minGSSize = <span>500</span>,<br>                                    maxGSSize = <span>10000000</span>,<br>                                    pvalueCutoff = <span>1</span>,<br>                                    eps = <span>1e-20</span>,<br>                                    scoreType = <span>"pos"</span>,<br>                                    nPermSimple = <span>100</span>)<br></code></pre><p>不过，这里的参数设置上要小心：</p><ul><li><p><code>minGSSize</code> 和 <code>maxGSSize</code>：因为基因组上来看，bin的数目是非常庞大的，所以我们要小心设置这两个参数。这两个参数的含义是：我们感兴趣区域所包含的bin数目最大和最小值。超过这两个值的区域会被自动排除在外，不做检验。</p></li><li><p><code>eps</code>：因为基因组上bin数目很多，也会导致P值很容易出现很多0。这个参数可以让我们设置当P小于多少时则直接返回检验结果为0</p></li><li><p><code>scoreType</code>：这个主要需要根据每个人数据分布情况来决定，当我们<strong>感兴趣区域的bin数量很多</strong>，导致在 <code>geneList</code> 上很多hit，这会导致 GSEA 分析时，所有的统计值都&gt;0，在这种情况下，默认的 <code>std</code> 分数类型无法计算标准差并生成负值。因此，建议切换到使用 <code>pos</code> 分数类型。</p></li><li><p><code>nPermSimple</code>：这个是用来重复抽样计算以计算P值的次数。次值不宜设置过大，以免消耗时间太长。</p></li></ul><h3><span>3. 结果可视化简单展示</span></h3><p>这里不做过多举例，因为针对基因组的富集分析，我们可能需要根据自己的目的进行可视化展示。</p><p>这里只展示了感兴趣区域中，<code>qvalue&lt;1e-5</code> 的区域结果：</p><pre><code>enrichplot::gseaplot2(result_dat, result_dat@result$ID[result_dat@result$qvalue&lt;<span>1e-5</span>])<br></code></pre><figure><p><img data-galleryid="" data-ratio="0.7906558849955077" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJrz8gSTJCUlxPL5A49iabl05icMDtwvm6JIM5wb8MeBgFhIkxxUEEhreCWGSzqslNmuGMqHzEczCia0Q/640?wx_fmt=png" data-type="png" data-w="1113" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJrz8gSTJCUlxPL5A49iabl05icMDtwvm6JIM5wb8MeBgFhIkxxUEEhreCWGSzqslNmuGMqHzEczCia0Q/640?wx_fmt=png"></p></figure><h3><span>后记</span></h3><p>此次分享只有核心代码，不甚详细，如果有问题，可以考虑公众号后台回复。有价值的问题我会回复。<span></span></p><span></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/awlIhTLKu4YpW0L2DWb9kA",target="_blank" rel="noopener noreferrer">原文链接</a>
