---
title: "CytoTRACE推测细胞分化状态"
date: 2023-04-20T15:11:35Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
CytoTRACE推测细胞分化状态 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p><br></p><section><qqmusic musicid="349568878" mid="002RNhfK3JsMOL" albumurl="http://y.gtimg.cn/music/photo_new/T001R120x120M0000036ERbx4IUm9V_2.jpg" audiourl="http://isure6.stream.qqmusic.qq.com/C200002RNhfK3JsMOL.m4a?guid=2000000052&amp;vkey=14F8276AE29EC00DCFA2F3A6CB1A82E7903CFD493BBCD036929396D740800D4FE430A9D7AD4F3FCFC6389C8349A093EF42CCEEB3D77E1272&amp;uin=0&amp;fromtag=20052" music_name="被动" singer="伍佰" play_length="59" src="/mp/readtemplate?t=app_editor/music&amp;singer=%E4%BC%8D%E4%BD%B0&amp;music_name=%E8%A2%AB%E5%8A%A8&amp;albumurl=http%3A%2F%2Fy.gtimg.cn%2Fmusic%2Fphoto_new%2FT001R120x120M0000036ERbx4IUm9V_2.jpg&amp;musictype=1" musictype="1" otherid="002RNhfK3JsMOL" albumid="" jumpurlkey="" data-pluginname="insertaudio"></qqmusic><span></span></section><h2 data-tool="mdnice编辑器"> python环境</h2><p data-tool="mdnice编辑器">CytoTRACE的iCytoTRACE函数需要调用python去除批次效应，因此需要先设置好python环境</p><pre data-tool="mdnice编辑器"><span></span><code>mamba create -n SC &amp;&amp; mamba activate SC<br><br>mamba install -y -c conda-forge python=3.10 notebook ipywidgets pandas numpy seaborn matplotlib ipykernel openpyxl pyarrow scanpy python-igraph leidenalg pytables jaxlib leidenalg<br>pip install scanoramaCT -i https://pypi.tuna.tsinghua.edu.cn/simple<br><span>which</span> python<br><span># /opt/homebrew/Caskroom/mambaforge/base/envs/SC/bin/python</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span>修改bug</h2><p data-tool="mdnice编辑器">找到intervaltree/intervaltree.py这个脚本修改bug</p><pre data-tool="mdnice编辑器"><span></span><code><span>#25行的</span><br>import collections<br><span>#替换为</span><br>import collections.abc as collections<br><span>#我的intervaltree/intervaltree.py文件路径在</span><br>/opt/homebrew/Caskroom/mambaforge/base/envs/SC/lib/python3.10/site-packages/intervaltree/intervaltree.py<br><br></code></pre><p data-tool="mdnice编辑器">如果你不知道去哪里找intervaltree/intervaltree.py文件可以在terminal中，导入python库，报错的时候有文件路径，如果没报错就不需要修改了。</p><pre data-tool="mdnice编辑器"><span></span><code>mamba activate SC<br>ipython<br>import scanoramaCT<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>安装CytoTRACE</h2><p data-tool="mdnice编辑器">using函数是我写在<code>$HOME/.Rprofile</code>中的函数，因此每次打开R就能使用。</p><p data-tool="mdnice编辑器"><code>using</code><span>的功能是一次加载多个包，并且使用了</span><code>suppressPackageStartupMessages</code><span>函数，因此不会显示加载包过程中的信息。</span></p><pre data-tool="mdnice编辑器"><span></span><code>wget https://cytotrace.stanford.edu/CytoTRACE_0.3.3.tar.gz<br>using(remotes)<br>remotes::install_local(<span>"CytoTRACE_0.3.3.tar.gz"</span>)<br><br></code></pre><h2 data-tool="mdnice编辑器"><span></span>从anndata导出数据</h2><p data-tool="mdnice编辑器">adata是注释好细胞类型的数据，CellType是细胞类型，library_id是不同样本编号代表批次效应。</p><p data-tool="mdnice编辑器">这里使用了Arrow格式作为R和Python的中间数据，可以参考<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg5MDg4MDU4MQ==&amp;mid=2247484848&amp;idx=1&amp;sn=697605f97b65c6ff8ba9d0507cffe4a1&amp;chksm=cfd4929af8a31b8c43bc496ca0c85bf89f4c2f8b895dd2eeb4cae492b44627980fc81b3aa349&amp;scene=21#wechat_redirect" textvalue="使用Arrow管理数据" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">使用Arrow管理数据</a>。</p><pre data-tool="mdnice编辑器"><span></span><code>adata=sc.read(<span>"adata.h5ad"</span>).raw.to_adata()<br><span># AnnData object with n_obs × n_vars = 14268 × 32285</span><br><span>#     obs: 'CellType', 'library_id', 'n_genes', 'doublet_score', 'predicted_doublet', 'Cluster'</span><br><span>#     uns: 'Cluster_colors', 'CellType_colors', 'hvg', 'leiden', 'library_id_colors', 'log1p', 'neighbors', 'pca', 'scrublet', 'umap'</span><br><span>#     obsm: 'X_harmony', 'X_pca', 'X_umap'</span><br><span>#     obsp: 'connectivities', 'distances'</span><br>adata.to_df().reset_index().to_feather(<span>"matrix.arrow"</span>,compression=<span>'zstd'</span>, compression_level=1)<br><span># Phenotype tables, NO headers</span><br>adata.obs.to_csv(<span>"pd.csv"</span>,index=True,header=False)<br><span># batch info</span><br>adata.obs.loc[:,[<span>'library_id'</span>]].to_csv(<span>"batch.csv"</span>,index=False,header=True)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>R中设置python路径</h2><pre data-tool="mdnice编辑器"><span></span><code>using(reticulate)<br>reticulate::use_python(<span>"/opt/homebrew/Caskroom/mambaforge/base/envs/SC/bin/python"</span>)<br>reticulate::py_exe()<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>整理input</h2><ul data-tool="mdnice编辑器"><li><section>读入</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>using(data.table, arrow, CytoTRACE, dplyr, tidyr, purrr)<br>df &lt;- arrow::read_ipc_file(<span>"matrix.arrow"</span>)<br>batch &lt;- data.table::fread(<span>"batch.csv"</span>)<br>pd &lt;- data.table::fread(<span>"pd.csv"</span>)<br><br></code></pre><ul data-tool="mdnice编辑器"><li><section>整理</section></li></ul><p data-tool="mdnice编辑器">datasets是没有名字的列表，里边是表达矩阵Matrix类型，phe是有名字的向量，名字是细胞barcode，值是细胞类型</p><pre data-tool="mdnice编辑器"><span></span><code>a &lt;- split(df, batch$library_id)<br>datasets &lt;- purrr::map(a, ~ column_to_rownames(.x, <span>"index"</span>) %&gt;% t())<br>names(datasets) &lt;- <span>NULL</span><br>phe &lt;- pd$V2<br>names(phe) &lt;- pd$V1<br>rm(df, batch, pd) <span># 删除不需要的变量</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span>iCytoTRACE</h2><pre data-tool="mdnice编辑器"><span></span><code>results &lt;- CytoTRACE::iCytoTRACE(datasets, enableFast = <span>TRUE</span>, ncores = <span>8</span>, subsamplesize = <span>1000</span>)<br>CytoTRACE::plotCytoTRACE(results, phenotype = phe, gene = <span>"Top2a"</span>, outputDir = <span>'./'</span>)<br>CytoTRACE::plotCytoGenes(results, numOfGenes = <span>10</span>, outputDir = <span>'./'</span>)<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.23425925925925925" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/OmJXhnRxzIqJ9UXy4kLO8GYewh0dE7jhENbLxWoWjOdjicDTLdXCb1wcdD8Z7xmvfsA2YHrpJxajd9FyAVp4foQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/OmJXhnRxzIqJ9UXy4kLO8GYewh0dE7jhENbLxWoWjOdjicDTLdXCb1wcdD8Z7xmvfsA2YHrpJxajd9FyAVp4foQ/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.7550813008130082" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/OmJXhnRxzIqJ9UXy4kLO8GYewh0dE7jhF4iadRmS1odBlLgcmiaicsKDw80YeSUoc67zPvzjpYWn1icbwxIDk4mVLA/640?wx_fmt=png" data-type="png" data-w="984" src="https://mmbiz.qpic.cn/sz_mmbiz_png/OmJXhnRxzIqJ9UXy4kLO8GYewh0dE7jhF4iadRmS1odBlLgcmiaicsKDw80YeSUoc67zPvzjpYWn1icbwxIDk4mVLA/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.81648675171737" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/OmJXhnRxzIqJ9UXy4kLO8GYewh0dE7jhlwKPQ4rrKT64eJLcB7GNRfDaKTx3Ds16rrT6Rzeyq5NAfJAR62huEA/640?wx_fmt=png" data-type="png" data-w="1019" src="https://mmbiz.qpic.cn/sz_mmbiz_png/OmJXhnRxzIqJ9UXy4kLO8GYewh0dE7jhlwKPQ4rrKT64eJLcB7GNRfDaKTx3Ds16rrT6Rzeyq5NAfJAR62huEA/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>Reference</h2><pre data-tool="mdnice编辑器"><span></span><code>https://mp.weixin.qq.com/s/S1-ClJEtR0ro0sYnIF6iaw<br>https://mp.weixin.qq.com/s/Al-FqOLMPBlrrT-JNchVhw<br>https://mp.weixin.qq.com/s/WiqU3nUFUysXf1M519l_Dg<br><span></span><br></code></pre></section><section><p><br></p><section data-style-type="5" data-tools="新媒体排版" data-id="2440476"><section><section><section><section><img data-ratio="0.9495798319327731" data-src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif" data-type="gif" data-w="119" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif"></section><section data-brushtype="text">往期回顾</section><section><br></section></section></section></section><section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247512024&amp;idx=1&amp;sn=eef4b01b3249dda4ea72aedc5952115d&amp;chksm=ea1ca95add6b204c67575031b9c6175646805185dcde1243d094ef38cc13b3adffde6c22a68d&amp;scene=21#wechat_redirect" textvalue="癌症的单细胞表观遗传学" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">癌症的单细胞表观遗传学</a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247512005&amp;idx=1&amp;sn=5fb76b52aaff42ae312ec9c2f443c52c&amp;chksm=ea1ca947dd6b2051b18fd1cf3fe64ee273f080d031d6a7527983f616fabb3aa9e798b4071c76&amp;scene=21#wechat_redirect" textvalue="单细胞转录组经典聚类算法：Louvain与Leiden" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">单细胞转录组经典聚类算法：Louvain与Leiden</a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247511996&amp;idx=1&amp;sn=9ca054317c13104a8535d70be6959fcd&amp;chksm=ea1ca93edd6b202833228fc5e5b41ce93150807b0fb6cc53cfd77a61fb552b77a75262ecca95&amp;scene=21#wechat_redirect" textvalue="单细胞多组学揭示肾透明细胞癌中的关键调控机制" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞多组学揭示肾透明细胞癌中的关键调控机制</a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247511977&amp;idx=1&amp;sn=60ef57e21cf038caa0ec9c93b8d21f2b&amp;chksm=ea1ca92bdd6b203db9f59ebdbc55ed1b08eb259dc45f2bfbf8c9ba30727614e734337e8a4c7d&amp;scene=21#wechat_redirect" textvalue="cellDancer预测RNA Velocity和单细胞水平的RNA动力学速率" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">cellDancer预测RNA Velocity和单细胞水平的RNA动力学速率</a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247511549&amp;idx=1&amp;sn=dbf8386bdb233a22edbfa98d4c6b2ae6&amp;chksm=ea1cab7fdd6b2269b028bf8cb499d690036b027f237f888facbd1ba481aaba5dec5bf1b3a003&amp;scene=21#wechat_redirect" textvalue="单细胞多组学数据分析最佳实践(2023典藏版)" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞多组学数据分析最佳实践(2023典藏版)</a><br></p></section></section><hr><p><br></p></section><section data-style-type="5" data-tools="新媒体排版" data-id="2440475"><hr><p><br></p><hr><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247520628&amp;idx=1&amp;sn=8904b3e4baed6d02397b4f6beb089085&amp;chksm=9b4bd1cfac3c58d9ee006daf365931bdfab8d5152ffb5090a2c6227d631e93c52f6656c39cd6&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课4月班" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信入门&amp;数据挖掘线上直播课4月班</a><br></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=2&amp;sn=6cb33654c7751f4c3df0f84743f77aaf&amp;chksm=9b4bceaeac3c47b8899afc00077b96357b87a4ed6b75e7c434ba14071fd6c8448e4c218de5e0&amp;scene=21#wechat_redirect" textvalue="144线程640Gb内存服务器共享一年仍然是仅需800" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">144线程640Gb内存服务器共享一年仍然是仅需800</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">千呼万唤始出来的独享生物信息学云服务器</a></p></li></ul><p><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-id="93668"><section><section data-width="95%"><section><section><section data-width="38%"><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg" data-type="other" data-w="258" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/sZGUemjuS8-pTZcdFuPfUQ",target="_blank" rel="noopener noreferrer">原文链接</a>
