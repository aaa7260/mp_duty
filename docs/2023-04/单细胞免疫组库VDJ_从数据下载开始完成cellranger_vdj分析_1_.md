---
title: "单细胞免疫组库VDJ|从数据下载开始完成cellranger vdj分析（1）"
date: 2023-04-25T01:36:29Z
draft: ["false"]
tags: [
  "fetched",
  "生信补给站"
]
categories: ["Acdemic"]
---
单细胞免疫组库VDJ|从数据下载开始完成cellranger vdj分析（1） by 生信补给站
------
<div><p><span>单细胞免疫组库可以额外做啥？<br></span></p><p><span>scTCR可以更细致的获取肿瘤免疫微环境的变化，比如单细胞转录组可以获取不同样本，不同分组（癌和癌旁，是否治疗，是否响应）的celltype组成，可以知道哪些celltype发生变化。</span></p><p><span>而TCR可以进一步的得知发生变化的celltype中clone扩展情况如何，治疗响应组中clone是变多了还是变少了？不同celltype之间是否共享一些clone？是否出现了noval的clone？clone最多的TCR序列是哪些？这些序列和哪些peptide结合最强？是否可以用于CAR-T或者TAR-T治疗等等。</span></p><p><span>本系列会使用2021年Cancer Cell文章“<span>Single-cell sequencing links multiregional immune landscapes and tissue-resident T cells in ccRCC to tumor topology and therapy efficacy</span>”中的部分样本作为示例展示TCR的常见应用场景以及可视化。</span></p><p><span><span>该数据集的<span><strong>多个</strong></span></span><strong><span>样本都有多处采样位置，多数样本同时含有RNA和TCR数据，且含有治疗前后的数据，ICB响应与否的数据</span></strong><span>，非常适合免疫组库系列分析的练习。</span></span><span></span></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><p><span>一 数据集下载 </span></p></section></section></section></section></section><p><br></p><p><span><span>Pubmed中找到该文章，然后在</span><span>Data Availability Statement </span><span>中发现文章的原始数据在</span><span>PRJNA705464，下载原始的sra文件来开启 “<strong><span>从0开始scVDJ</span></strong>”的系列分析。</span></span></p><h2><strong><span>1，数据集下载</span></strong><span></span></h2><p><span>在浏览器输入https://www.ncbi.nlm.nih.gov/Traces/study/，在Accession 中输入BioProject的ID号（PRJNA705464）， 下拉找到以下信息，就可以开始下载了，介绍以下两种下载方式</span></p><p><img data-ratio="0.3675925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBick5SYfAlEbjiaiaPdpFddnhlpoib2QmwNC7wZf0cCAC1c9s2QGKzOiafH4cLfKPTvmkA2v0aURo3Sjw/640?wx_fmt=png" data-type="png" data-w="1080" width="1307.2" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjBick5SYfAlEbjiaiaPdpFddnhlpoib2QmwNC7wZf0cCAC1c9s2QGKzOiafH4cLfKPTvmkA2v0aURo3Sjw/640?wx_fmt=png"></p><p><span>（1）可以点击具体的Run，然后找到Data Access ，获取下载链接后进行下载。</span></p><p><span>（2）也可以获取第一列的SRR信息，使用SRAToolkit的prefetch进行批量下载</span></p><h3><span>1.1 安装SRAToolkit</span></h3><p><span>可以在https://github.com/ncbi/sra-tools/wiki/01.-Downloading-SRA-Toolkit的链接中选择合适的</span><span>SRAToolkit</span><span>下载 或者通过</span><strong><span>wget方式</span></strong><span>获取</span></p><section><ul><li><li></ul><pre data-lang="properties"><code><span><span>wget</span> <span>https://ftp-trace.ncbi.nlm.nih.gov/sra/sdk/3.0.2/sratoolkit.3.0.2-centos_linux64.tar.gz</span></span></code><code><span><span>tar zxvf sratoolkit.3.0.2-centos_linux64.tar.gz</span></span></code></pre></section><p><span>1.</span><span>2 prefetch下载数据</span><br></p><h4><span>（1）单个Run下载</span></h4><p><span>prefetch 后面添加上SRR的ID号即可 ，prefetch建议使用绝对路径 , 可以添加--max-size 100G 参数。</span></p><section><ul><li></ul><pre data-lang="nginx"><code><span>/path/<span>prefetch</span> SRR13806045  --max-size <span>100G</span></span></code></pre></section><h4><span>（2）SRR_ACC_List 批量下载（一列SRR编号的文件）</span></h4><section><ul><li></ul><pre data-lang="css"><code><span>/<span>path</span>/<span>prefetch</span> <span>--option-file</span> <span>SRR_ACC_List</span><span>.txt</span></span></code></pre></section><h4><span>（3）shell循环下载</span></h4><section><ul><li><li><li></ul><pre data-lang="bash"><code><span>cat SRR_ACC_List.txt |<span>while</span> <span>read</span> i; <span>do</span></span></code><code><span>/path/prefetch <span>$i</span>  </span></code><code><span><span>done</span></span></code></pre></section><h2><strong><span>软件建议使用绝对路径。</span></strong></h2><h2><strong><span>2 sra文件转为fastq</span></strong><span></span></h2><p><span>使用sratoolkit中的<span><strong>fastq-dump</strong></span>命令将 sra 转化为 fastq 文件。<br></span></p><p><span>进入到sra数据的存储文件夹中，可以用下述代码进行批量的格式转化：</span></p><section><ul><li><li><li></ul><pre data-lang="bash"><code><span>cat SRR_ACC_List.txt |<span>while</span> <span>read</span> i; <span>do</span></span></code><code><span>/path/.../fastq-dump --split-3 <span>$i</span> </span></code><code><span><span>done</span></span></code></pre></section><p><span><span>注：--sp</span><span>lit-3 filename其中--split-3参数代表着如果是单端测序就生成一个 </span><em>.fastq文件，如果是双端测序就生成</em><span>_1.fastq 和*_2.fastq 文件。</span></span></p><h2><span><strong>3 修改cellranger 输入格式</strong></span></h2><p><span>得到fastq文件后，还需要转为cellrange 分析需要的格式（</span><span>比如，将得到的SRR_1.fastq.gz改为SRR<strong><span>_S1_L001_I1_001</span></strong>.fastq.gz</span><span>）</span><span>。</span></p><p><span></span><span>可以使用上述方式进行批量修改，但是要注意生成文件的个数，如果像本示例中产生的是R1和R2文件，那就<span>将原来_1的改成R1，将_2改成R2</span>。</span></p><section><ul><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span><br></span></code><code><span><span>#创建SRR_ACC_List.txt ，内容为SRR号</span></span></code><code><span>cat SRR_ACC_List.txt| <span>while</span> <span>read</span> i ;<span>do</span> </span></code><code><span>mv <span>${i}</span>_1*.fastq.gz <span>${i}</span>_S1_L001_R1_001.fastq.gz;</span></code><code><span>mv <span>${i}</span>_2*.fastq.gz <span>${i}</span>_S1_L001_R2_001.fastq.gz);</span></code><code><span><span>done</span></span></code></pre></section><p><strong><span>注：样本名称不要有下划线"_"，可以是短线"-"。</span></strong><span></span></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><p><span>二 cellranger分析 </span></p></section></section></section></section></section><p><br></p><p><span>首先进行cellranger的下载和安装，参照10X官网https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/using/tutorial_in 或者 <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650398490&amp;idx=1&amp;sn=855d3427379efd263637efc53e36e682&amp;chksm=f01cbdfac76b34ec963a1b5c0d4a2db3361057464cc80eff30ef294acaa1c9e909180392897d&amp;scene=21#wechat_redirect" textvalue="单细胞工具箱|Cell Ranger-V6.0 开启单细胞之旅（上）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞工具箱|Cell Ranger-V6.0 开启单细胞之旅（上）</a></span><br></p><h2><strong><span>1 scRNA分析</span></strong><span></span></h2><p><span>首先下载refdata文件，然后解压</span></p><section><ul><li><li></ul><pre data-lang="nginx"><code><span><span>wget</span> https://cf.10xgenomics.com/supp/cell-exp/refdata-gex-GRCh38-2020-A.tar.gz </span></code><code><span>tar -zxvf refdata-gex-GRCh38-<span>2020</span>-A.tar.gz</span></code></pre></section><p><span>进行cellranger <strong><span>count</span></strong>分析</span></p><section><ul><li><li><li><li><li></ul><pre data-lang="sql"><code><span>/path/cellranger count <span>--id=sample1 \</span></span></code><code><span>                   <span>--transcriptome=/path/.../refdata-gex-GRCh38-2020-A \</span></span></code><code><span>                   <span>--fastqs=/path/.../fastq_path \</span></span></code><code><span>                   <span>--sample=sample1 \</span></span></code><code><span>                   <span>--expect-cells=1000 \</span></span></code></pre></section><p><img data-galleryid="" data-ratio="0.6348448687350835" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjA9nVXCl83y48jcsxib0icHH3JXv3Ce4qDA1zmMIF6aia7iax5fxjJuibxL7O5k7y0yfMjsTL1gwUmI62g/640?wx_fmt=png" data-type="png" data-w="419" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjA9nVXCl83y48jcsxib0icHH3JXv3Ce4qDA1zmMIF6aia7iax5fxjJuibxL7O5k7y0yfMjsTL1gwUmI62g/640?wx_fmt=png"></p><p><span>运行结果在outs文件夹，建议每个文件都在<strong><span>官网</span></strong>中查一下大概的含义，这里重点关注outs/</span><span><strong><span>filtered_feature_bc_matrix文件夹</span></strong></span><span>， <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650398490&amp;idx=1&amp;sn=855d3427379efd263637efc53e36e682&amp;chksm=f01cbdfac76b34ec963a1b5c0d4a2db3361057464cc80eff30ef294acaa1c9e909180392897d&amp;scene=21#wechat_redirect" textvalue="单细胞工具箱|Cell Ranger-V6.0 开启单细胞之旅（上）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞工具箱|Cell Ranger-V6.0 开启单细胞之旅（上）</a></span></p><h2><strong><span>2 scVDJ分析</span></strong><span></span></h2><p><span>首先下载<span>V(D)J reference</span>文件，然后解压</span></p><section><ul><li><li></ul><pre data-lang="nginx"><code><span><span>curl</span> -O https://cf.10xgenomics.com/supp/cell-vdj/refdata-cellranger-vdj-GRCh38-alts-ensembl-5.0.0.tar.gz </span></code><code><span>tar -xf refdata-cellranger-vdj-GRCh38-alts-ensembl-<span>5</span>.<span>0</span>.<span>0</span>.tar.gz</span></code></pre></section><p><span>进行cellranger<span><strong> vdj</strong></span>分析</span></p><section><ul><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span>/path/cellranger vdj <span>--id=sample1 \</span></span></code><code><span>      <span>--reference=/path/.../refdata-cellranger-vdj-GRCh38-alts-ensembl-5.0.0 \</span></span></code><code><span>      <span>--fastqs=/path/.../data \ #fastq文件所在路径</span></span></code><code><span>      <span>--sample=sample1 \ #第一个下划线之前的样本信息</span></span></code><code><span>      <span>--localcores=8 \</span></span></code><code><span>      <span>--localmem=64 \</span></span></code></pre></section><p><img data-galleryid="" data-ratio="1.6163069544364508" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjA9nVXCl83y48jcsxib0icHH3Z5Zp1uHwUKxcSLCEp4DFdtEE67Lcjb7QRlUsdibxryxBhWjazhDw2tg/640?wx_fmt=png" data-type="png" data-w="417" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjA9nVXCl83y48jcsxib0icHH3Z5Zp1uHwUKxcSLCEp4DFdtEE67Lcjb7QRlUsdibxryxBhWjazhDw2tg/640?wx_fmt=png"></p><p>运行结果在outs文件夹，文件很多，建议根据<span>https://support.10xgenomics.com/single-cell-vdj/software/pipelines/latest/output/overview了解以下每个文件的意义。</span><span>outs/<strong><span>filtered_contig_annotations.csv文件</span></strong>，更需要重点了解每一列的意义。</span></p><p><span>以上，得到每个样本的单细胞RNA和TCR的结果后就可以使用</span><strong><span>scRepertoire 或者STARTRAC</span></strong><span> 进行免疫组库以及T细胞动态等分析了。</span><br></p><p><span>这些分析后续会进行系统的介绍。</span><span></span></p><p><span>参考资料：Single Cell Immune Profiling - Official 10x Genomics Support</span><span></span></p><section data-style-type="7" data-tools="新媒体排版" data-id="9190"><p><span><span data-txtless="spin" data-txtlessp="120">◆ </span><span>◆ </span><span data-txtless="spin" data-txtlessp="-120">◆  <span data-txtless="spin" data-txtlessp="120">◆ </span><span>◆</span></span></span></p></section><p cid="n94" mdtype="paragraph"><span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650398215&amp;idx=1&amp;sn=730225fb5ba3a51ceb8df0a531632515&amp;chksm=f01cbce7c76b35f1bebbf327d78a51d859770a46ae1329d362e3b705c4f8765ee2dc461d24dc&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">精心整理（含图PLUS版）|R语言生信分析，可视化</a>（R统计，ggplot2绘图，生信图形可视化汇总）</span></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/JKsph6l_9OzdqA_BAE7qWg",target="_blank" rel="noopener noreferrer">原文链接</a>
