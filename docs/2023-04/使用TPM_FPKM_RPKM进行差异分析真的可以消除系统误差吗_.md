---
title: "使用TPM/FPKM/RPKM进行差异分析真的可以消除系统误差吗？"
date: 2023-04-26T08:13:06Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
使用TPM/FPKM/RPKM进行差异分析真的可以消除系统误差吗？ by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>这周曾老师给我分享了一篇文章，题为《Don’t trust TPM/FPKM/RPKM too much. They don’t promise to cancel the systematic error of RNA-Seq data》，文章主要讨论了RNA-Seq数据中的系统误差不能被TPM/FPKM/RPKM消除的问题。TPM/FPKM/RPKM是一种“全局归一化”，在<strong>理论上可以消除线性系统误差</strong>。但是，作者认为这种假设对组学数据分析来说太天真了，并且强调组学数据的非线性系统误差没有生物信息学方法可以消除，并以GSE159751为例进行了相关分析。</p></blockquote><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span>背景知识</h2><p data-tool="mdnice编辑器">首先我们来谈谈什么是线性和非线性系统误差？为什么TPM/FPKM/RPKM在理论上可以消除线性系统误差？</p><h2 data-tool="mdnice编辑器"><span></span>线性误差</h2><p data-tool="mdnice编辑器">组学数据中的线性系统误差指的是由于技术或实验条件的限制，导致测量值与真实值之间存在一定的偏差，这种偏差在数学上可以用线性模型来表示。具体而言，对于一组测量数据 y，它们与真实值 x 的关系可以用以下的线性模型表示：y = Ax + b + e</p><p data-tool="mdnice编辑器">其中，A 是系数矩阵，b 是偏置向量，e 是误差向量。在这个模型中，A 和 b 是已知的常数，而 e 表示测量误差，也就是线性系统误差。</p><p data-tool="mdnice编辑器">消除线性系统误差的方法主要有两种：校准和标准化。</p><p data-tool="mdnice编辑器">校准的基本思路是通过添加一些已知的标准样品，建立标准曲线，然后利用标准曲线对未知样品的测量结果进行修正。具体而言，我们可以将标准样品的真实值和测量值用线性回归模型拟合，得到一个系数和截距，然后利用这个系数和截距对未知样品的测量值进行校准。</p><p data-tool="mdnice编辑器">标准化的基本思路是将测量数据进行线性变换，使得它们的均值为零，方差为一。这个过程通常称为Z-score标准化：</p><p data-tool="mdnice编辑器">Z = (x - μ) / σ</p><p data-tool="mdnice编辑器">其中，x 是原始测量数据，μ 是所有样品的均值，σ 是所有样品的标准差。将这个标准化的结果作为最终的测量结果，可以有效消除线性系统误差e。</p><p data-tool="mdnice编辑器">下面是一些在转录组数据分析中可能遇到的线性误差的例子：</p><ol data-tool="mdnice编辑器"><li><section><strong>序列长度</strong>：不同长度的转录本会影响到测序数据的比对和计数。这个误差可以通过对测序数据进行长度标准化来消除。</section></li><li><section><strong>测序深度</strong>：测序深度的不同会影响到表达量的计算。</section></li></ol><p data-tool="mdnice编辑器">这些误差可以通过对表达量进行归一化处理来消除，例如，<strong>TPM、FPKM、RPKM等方法</strong>。</p><p data-tool="mdnice编辑器">关于这些方法我们此前也有介绍：</p><ul data-tool="mdnice编辑器"><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247490699&amp;idx=2&amp;sn=6d7e0d96779d4885f3c36089cdd31516&amp;scene=21#wechat_redirect" data-linktype="2">RNA-seq的counts值，RPM, RPKM, FPKM, TPM 的异同</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513933&amp;idx=2&amp;sn=874301305219e93c26d173560a31b076&amp;scene=21#wechat_redirect" data-linktype="2">Counts FPKM RPKM TPM CPM 的转化</a></p></section></li></ul><p data-tool="mdnice编辑器">也欢迎大家关注我们语雀平台团队整理的“生物统计从理论到实践”，里面涉及到许多生物信息的统计学知识讲解</p><p data-tool="mdnice编辑器">RPKM FPKM 和 TPM：https://www.yuque.com/biotrainee/biostat/chapter3-4</p><blockquote data-tool="mdnice编辑器"><p>RPKM FPKM 和 TPM主要目的是去除测序数据的技术偏差：测序深度和基因长度</p></blockquote><ol start="3" data-tool="mdnice编辑器"><li><section>不完全的RNA提取：对于不完全的RNA提取，可能会影响到所测定的RNA的数量，从而影响到表达量的计算。这个误差可以通过对样品进行RNA质量控制、RNA浓度检测、DNase I处理等步骤来消除。</section></li><li><section>PCR扩增引入的偏差：PCR扩增过程中，不同的转录本可能会被扩增的效率不同，从而引入偏差。这个误差可以通过进行PCR扩增的优化来消除。</section></li><li><section>RNA降解：RNA的降解会导致RNA浓度的下降和RNA质量的降低，从而影响到表达量的计算。这个误差可以通过对样品进行RNA质量控制和标准化处理来消除。</section></li></ol><p data-tool="mdnice编辑器">这些误差通常会引起表达量测量的偏差，但是这些误差通常是线性的，因此可以采用不同的标准化方法和归一化方法来消除或减小这些误差，从而提高数据处理的准确性和可靠性。</p><h2 data-tool="mdnice编辑器"><span></span>非线性误差</h2><p data-tool="mdnice编辑器">组学数据中的非线性系统误差指的是由于技术或实验条件的限制，导致测量值与真实值之间存在一定的偏差，而<strong>这种偏差无法用线性模型来完全描述。</strong></p><p data-tool="mdnice编辑器">与线性系统误差不同，<strong>非线性系统误差不仅仅是误差向量 e 的线性组合，而可能涉及到多个变量之间的复杂关系，如幂律、指数函数、对数函数等。</strong></p><p data-tool="mdnice编辑器">因此，对于组学数据中的非线性系统误差，我们需要采用更加复杂的模型来描述和修正。常见的方法包括使用高阶多项式、神经网络等非线性模型来对数据进行拟合和校正。</p><p data-tool="mdnice编辑器">非线性系统误差是指在组学数据分析中可能存在的不符合线性模型的偏差。这种偏差可能由于实验设计、样本处理、RNA测量、数据分析等各个方面的因素引起，因此可能影响分析的准确性和可靠性。<strong>非线性系统误差不能通过简单的计算和全局归一化等基本方法来消除</strong>，需要更为复杂和有效的技术来处理。在组学数据分析之前，必须对可能出现的非线性系统误差有所了解并对其进行评估，以保证数据的质量和准确性。</p><p data-tool="mdnice编辑器">下面是一些在转录组数据分析中可能遇到的非线性误差的例子：</p><ol data-tool="mdnice编辑器"><li><section>批次效应：如果实验中存在多个批次，可能会导致不同批次之间的表达量存在显著差异，这是因为批次效应会影响RNA提取、样品制备和测序等步骤，从而影响表达量测量的准确性。</section></li><li><section>技术因素：转录组测序技术中存在多个步骤，如RNA提取、RNA库制备和测序等，每个步骤都可能会引入一些非线性误差，例如，PCR扩增过程中可能会引入偏差等。</section></li><li><section>剪接变异：基因的剪接变异会导致不同转录本长度的不同，因此在标准化方法中只考虑基因长度而不考虑剪接变异可能会引入非线性误差。</section></li><li><section>RNA质量：RNA质量是影响表达量测量的重要因素，如果RNA质量不好，则会导致表达量测量偏低或偏高，从而引入非线性误差。</section></li></ol><p data-tool="mdnice编辑器">所以作者认为组学数据的非线性系统误差没有生物信息学方法可以消除，在此基础上，任何不同来源的数据集的合并都是不可接受的。</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">小编有话说：</p><p data-tool="mdnice编辑器">此外，根据全篇文章的解读以及小编后续复现的分析也可发现，作者的文章暗含了支持使用raw counts进行差异分析的立场，认为为了理论上消除系统误差而使用TPM/FPKM/RPKM是不可取的。所以稍微总结一下作者的两个立场，以便读者带着问题阅读：</p><ul data-tool="mdnice编辑器"><li><section>TPM/FPKM/RPKM并虽然理论上可以消除线性系统误差，但对差异分析而言结果却不如raw counts不理想，这在一定程度反映了这些均一化方法的局限性和处理带来的潜在偏差</section></li><li><section>在实验设计和操作环节需要尤其注意非线性误差的潜在影响，因为没有生物信息学方法可以处理非线性误差，任何不同来源的数据集的合并都是不可接受的</section></li></ul><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">以下引用均为文章作者所述翻译内容</p><h2 data-tool="mdnice编辑器"><span></span>histogram</h2><blockquote data-tool="mdnice编辑器"><p>您可能认为必须使用TPM/FPKM/RPKM，而不是raw counts，以避免样本之间的系统性误差。但每百万reads的标准化是一种“全局标准化”，理论上只能抵消线性系统误差。然而，对于组学数据分析来说，这样的假设太天真了。让我们看一个示例，GSE159751，它由两组26个样本组成。根据GSM记录，GSE159751_RAW.tar提供的矩阵的为FPKM值。请注意，以直方图表示的FPKM的分布模式各不相同。<strong>似乎有两种类型的形状：单峰型和双峰型，与疾病状态无关。这有力地表明存在系统性错误。</strong>（Figure 1）<img data-ratio="0.7842592592592592" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou99Pzgd83PPobxlX7o6hgWoSL4rmIegLn0Hd1NQOibabiadfKhGnB4oicg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou99Pzgd83PPobxlX7o6hgWoSL4rmIegLn0Hd1NQOibabiadfKhGnB4oicg/640?wx_fmt=png"></p></blockquote><p data-tool="mdnice编辑器">首先来到GEO看看这个数据集https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE159751<img data-ratio="0.3509259259259259" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouTukMKt7OZwsHARNANRlm2TecMxOdsPILHkv9ZXn1XKoOwbPesgVWng/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouTukMKt7OZwsHARNANRlm2TecMxOdsPILHkv9ZXn1XKoOwbPesgVWng/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">FPKM (Fragments Per Kilobase of transcript per Million mapped reads) 是一种常用的转录组表达量的标准化方法。FPKM处理的转录组数据的分布直方图通常呈现出类似于正态分布的形式，这是由于转录本的表达量在大多数生物学实验中都是连续变量，同时在样本中存在许多不同的转录本。</p><p data-tool="mdnice编辑器">虽然FPKM转录组数据的分布可以近似为正态分布，但是具体的形态和趋势仍然取决于具体的实验设计和生物体。<strong>在一些情况下，转录本表达量可能呈现出双峰分布或者其他类型的非正态分布（这里FPKM的分布模式有两种形状：单峰和双峰状，无论疾病状态如何）</strong>。</p><p data-tool="mdnice编辑器">我们先尝试使用GEOquery包在线获取：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(GEOquery) <br><span>library</span>(AnnoProbe)<br><br>eset &lt;- getGEO(<span>"GSE159751"</span>, destdir=<span>"."</span>, AnnotGPL = <span>F</span>, getGPL = <span>F</span>)<br>class(eset)<br>view(eset)<br><br>exp &lt;- exprs(eset[[<span>1</span>]])  <span># 空值</span><br></code></pre><p data-tool="mdnice编辑器">发现为空后转为手动下载GSE159751_RAW文件，并对各个样本GSM进行合并获得FPKM的表达矩阵merge_GSM_file.txt</p><pre data-tool="mdnice编辑器"><span></span><code><span>##### 多样本直方图-------------</span><br>mydata &lt;- read.table(<span>"merge_GSM_file.txt"</span>, header=<span>TRUE</span>, sep=<span>" "</span>)<br>d &lt;- read.table(<span>"GSE159751_RAW/GSM4838989_N1.txt"</span>,header = <span>T</span>,sep = <span>'\t'</span>)<br>coln &lt;- d[,<span>1</span>]  <span># gene列</span><br>mydata$gene &lt;- coln<br>mydata$X &lt;- <span>NULL</span><br><span># reshape2::merlt把长数据转换为宽数据</span><br><span>library</span>(reshape2)<br><span>library</span>(tidyverse)  <span># 数据分析和可视化的大型library集合，包含有dplyr、ggplot2等常用库</span><br><span>library</span>(hrbrthemes)  <span># 提供了多个精美的主题，可以美化图表</span><br><span>library</span>(viridis)  <span># 提供了多个平滑的配色方案，可以用来设置颜色</span><br><span>library</span>(forcats)  <span># 针对离散变量(factors)的再次封装，提供了更多的独特编号和排序功能</span><br>long_data &lt;- mydata %&gt;%<br>  melt(id.vars = c(<span>"gene"</span>),  <span># 指定保留的列</span><br>       variable.name = <span>"sample"</span>,  <span># 通过多列列名新生成列的名称</span><br>       value.name = <span>"FPKM"</span>)  <span># 通过多列值生成新列的名称</span><br><span># gene列这里没啥用，丢了算了</span><br>long_data$gene &lt;- <span>NULL</span><br><span># 根据sample分组信息 plot</span><br>myplot &lt;- long_data %&gt;%<br>  <span># 使用fct_reorder()函数调整sample的顺序</span><br>  <span># mutate(sample = fct_reorder(sample, FPKM)) %&gt;%</span><br>  ggplot( aes(x=FPKM, color=sample, fill=sample)) +<br>  geom_histogram(alpha=<span>0.6</span>) +<br>  <span># 使用“scale_fill_viridis”和“scale_color_viridis”函数添加填充和颜色，以使每个文本标签具有不同的颜色</span><br>  scale_x_continuous(trans = <span>"log10"</span>,  <span># log10 区域narrow down</span><br>                     labels = scales::label_number(accuracy = <span>1</span>)) +  <span># 标签不使用科学计数法</span><br>  scale_fill_viridis(discrete=<span>TRUE</span>) +<br>  scale_color_viridis(discrete=<span>TRUE</span>) +<br>  <span># 使用“theme_ipsum”函数将主题设置为“ipsum”主题，这是一种较新的主题，可使图形看起来更美观</span><br>  theme_ipsum() +<br>  <span># 使用“theme”函数对其他主题元素进行微调，如删除图例，调整面板间距等</span><br>  theme(<br>    legend.position=<span>"none"</span>,<br>    panel.spacing = unit(<span>0.1</span>, <span>"lines"</span>),<br>    strip.text.x = element_text(size = <span>8</span>)<br>  ) +<br>  <span># 使用“xlab”和“ylab”函数分别添加x轴和y轴标签</span><br>  xlab(<span>"the histograms of the distribution of FPKM of each sample."</span>) +<br>  ylab(<span>"counts"</span>) +<br>  <span># facet_wrap()是ggplot2包中的一个函数，它用于将数据集中的不同组分别绘制在不同的小图中，以避免在同一轴上绘制过多分组而造成图像混乱的问题。这个函数可以根据数据集中的一个或多个变量，生成多个小图。每个小图都可以使用相同的绘图参数。通过facet_wrap()函数生成的多个小图组成了一张大图，方便对数据进行比较和分析</span><br>  facet_wrap(~sample)<br>myplot<br><span># N8.1列其实为C8 下载的数据集错把C8写成了N8</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou5IecdSJRWZbq1dwibpTPgE5e7hHpYkLn9d1uSAlV3s37PUYHh13APrQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou5IecdSJRWZbq1dwibpTPgE5e7hHpYkLn9d1uSAlV3s37PUYHh13APrQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">可以发现，各样本FPKM值的分布确实如作者所说“FPKM的分布模式有两种形状：单峰和双峰状，无论疾病状态如何”</p><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span>PCA</h2><blockquote data-tool="mdnice编辑器"><p>随后<strong>PCA结果表明，样本表达谱很可能是由于非线性偏差而聚集在一起的，而不是由于生物学背景。</strong>请看主成分分析的结果，疾病状态（蓝色和黄色）与PC1（横轴）无关（图2，上图）。所以我将样本标记为PC1得分高和低（粉色和绿色）（图2，下部）。So I marked samples as PC1 score high and low (pink and green).<img data-ratio="1.0431432973805854" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouJQ3ejRtTGOhdz32p0UyR3DnwBcPHJFvUfwdmyFNBY7pKX95KO3s26Q/640?wx_fmt=png" data-type="png" data-w="649" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouJQ3ejRtTGOhdz32p0UyR3DnwBcPHJFvUfwdmyFNBY7pKX95KO3s26Q/640?wx_fmt=png"></p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>data &lt;- read.table(<span>"merge_GSM_file.txt"</span>,header = <span>T</span>,sep = <span>' '</span>)<br>genecol &lt;- read.table(<span>"GSE159751_RAW/GSM4838989_N1.txt"</span>,header = <span>T</span>,sep = <span>'\t'</span>)<br>genecol &lt;- genecol[,<span>1</span>]<br>data$X &lt;- <span>NULL</span><br>data$gene &lt;- genecol<br>save(data,file = <span>"merge_GSMdata_withGene.RData"</span>)<br><br>rm(list = ls())<br>load(<span>"1.merge_GSMdata_withGene.RData"</span>)  <span># data 表达矩阵</span><br><br>options(stringsAsFactors = <span>F</span>) <br>getOption(<span>'timeout'</span>)  <span># 60</span><br>options(timeout=<span>10000</span>)<br><span>library</span>(FactoMineR)<br><span>library</span>(factoextra)<br><br>group=rep(c(<span>"Non-IBD"</span>,<span>"CD"</span>),each=<span>13</span>)<br>group_list=factor(group,levels = c(<span>"Non-IBD"</span>,<span>"CD"</span>))<br>table(group_list)<span>#检查一下组别数量</span><br><span># Non-IBD      CD </span><br><span># 13      13</span><br><br><span># PCA</span><br>data[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span># N1       N2          N3          N4</span><br><span># 1 4.936070  4.70440  6.96842018  7.35134879</span><br><span># 2 0.285694  0.00000  0.06803618  0.03205427</span><br><span># 3 9.950503 12.70891 20.55543822 17.82955841</span><br><span># 4 1.425634  1.57114  1.24927397  1.94193101</span><br><span># gene列转换为行名</span><br>rownames(data) &lt;- data$gene<br>data$gene &lt;- <span>NULL</span><br><span># 添加group列</span><br>data &lt;- as.data.frame(t(data))<br>data$group &lt;- group_list<br>data[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span># ENSG00000000003 ENSG00000000005 ENSG00000000419 ENSG00000000457</span><br><span># N1        4.936070      0.28569398        9.950503        1.425634</span><br><span># N2        4.704400      0.00000000       12.708906        1.571140</span><br><span># N3        6.968420      0.06803618       20.555438        1.249274</span><br><span># N4        7.351349      0.03205427       17.829558        1.941931</span><br>table(data$group)<br><span># Non-IBD      CD </span><br><span># 13      13 </span><br><span># 绘图</span><br>dat_pca &lt;- PCA(data[,-ncol(data)], graph = <span>FALSE</span>)  <span># 去除非数值列 pca结果</span><br>PCAplot&lt;- fviz_pca_ind(dat_pca,<br>                     geom.ind = <span>"point"</span>, <span># 只显示点，不显示文字</span><br>                     col.ind = data$group, <span># 用不同颜色表示分组</span><br>                     palette = c(<span>"#00AFBB"</span>, <span>"#E7B800"</span>),<br>                     addEllipses = <span>T</span>, <span># 是否圈起来，少于4个样圈不起来</span><br>                     legend.title = <span>"disease state groups"</span>) + theme_bw()<br>PCAplot<br><br><span># So I marked samples as PC1 score high and low (pink and green).</span><br>pca_group &lt;- rep(<span>"PC1 high socres"</span>,<span>26</span>)<br>pca_group[which(dat_pca$ind$coord[,<span>1</span>]&lt;<span>0</span>)] &lt;- <span>"PC1 low scores"</span><br>table(pca_group)<br><span># PC1 high socres  PC1 low scores </span><br><span># 13              13 </span><br>PCAplot_byPCA1&lt;- fviz_pca_ind(dat_pca,<br>                       geom.ind = <span>"point"</span>, <span># 只显示点，不显示文字</span><br>                       col.ind = pca_group, <span># 用不同颜色表示分组</span><br>                       palette = c(<span>"#00AFBB"</span>, <span>"#E7B800"</span>),<br>                       addEllipses = <span>T</span>, <span># 是否圈起来，少于4个样圈不起来</span><br>                       legend.title = <span>"PC1 scores groups"</span>) + theme_bw()<br>PCAplot_byPCA1<br><br>save(pca_group, group_list,file = <span>"2.PCA.RData"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouM8A8YRxts8YnFk2XKCCdOIELY96toz9tJsnjB9yZeOjEmLE8mNYkkQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouM8A8YRxts8YnFk2XKCCdOIELY96toz9tJsnjB9yZeOjEmLE8mNYkkQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">可以发现样本确实没有按照“disease state”分组聚集</p><figure data-tool="mdnice编辑器"><img data-ratio="0.7324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouv21VUdwZbGS4X9hU7icfeeurkgWRklyKc1q73gkWX5HfPSnzw60javA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouv21VUdwZbGS4X9hU7icfeeurkgWRklyKc1q73gkWX5HfPSnzw60javA/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span>hierarchical clustering</h2><blockquote data-tool="mdnice编辑器"><p>然后我对数据执行了分层聚类。当然，样本不是按疾病状态进行聚类，而是按预期的PC1评分类别进行聚类。更有趣的是，PC1分数分类与直方图的形状有关。（图3）<img data-ratio="0.6796296296296296" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouX3x5GFgHibicwJiburfnBG2YSicnvt7P7TEjJoNopoRnQiaXFBcG0XBdAeQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouX3x5GFgHibicwJiburfnBG2YSicnvt7P7TEjJoNopoRnQiaXFBcG0XBdAeQ/640?wx_fmt=png"></p></blockquote><p data-tool="mdnice编辑器">从这里开始，我们的结果开始和作者出现差别，看着作者的图3，私以为，虽然样本不是按疾病状态进行聚类，但也不能完全说按预期的PC1评分类别进行聚类吧，聚类结果也不是很完美</p><p data-tool="mdnice编辑器">一开始我犯懒打算用SD标准差取差异基因简单看看聚类，但根据PC1的聚类结果都没作者那样好，这里还是贴出来，后面我还是做了一遍差异分析用差异基因热图聚类（虽然根据PC1得分分组的聚类结果还是没作者那样好）</p><pre data-tool="mdnice编辑器"><span></span><code><span># the R Graph Gallery：</span><br><span># The heatmap() function is natively provided in R. It produces high quality matrix and offers statistical tools to normalize input data, run clustering algorithm and visualize the result with dendrograms. It is one of the very rare case where I prefer base R to ggplot2.</span><br><span># ggplot2 also allows to build heatmaps thanks to geom_tile(). However, I personally prefer the heatmap() function above since only it offers option for normalization, clustering and Dendrogram.</span><br><span># 所以这里我们不用ggplot2使用base</span><br>rm(list=ls())<br>load(<span>"1.merge_GSMdata_withGene.RData"</span>)<br>load(<span>"2.PCA.RData"</span>)<br><br>head(data)<br>rownames(data) &lt;- data$gene<br>data$gene &lt;- <span>NULL</span><br><br><span># &gt; dim(data_mat)</span><br><span># [1] 42072    26</span><br><br>data$sd &lt;-  apply(data,<span>1</span>,sd)<br>chosen_data &lt;- data[data$sd&gt;<span>2</span>, ]  <span># 选择sd标准差大于2的</span><br>dim(chosen_data)<br><span># [1] 7134   27</span><br>chosen_data$sd &lt;- <span>NULL</span><br><br><span>############### plot sd&gt;2-------------------------</span><br>data_mat &lt;- as.matrix(chosen_data)<br><span># col_DiseaseState &lt;- RColorBrewer::brewer.pal(2, "Set1")[group_list]</span><br>col_PC1 &lt;- RColorBrewer::brewer.pal(<span>2</span>,<span>"Set2"</span>)[factor(pca_group)]<br><span># colSide &lt;- c(col_DiseaseState,col_PC1)</span><br><span># heatmap(data_mat,ColSideColors = col_DiseaseState)</span><br><span># 太大了显示不出来</span><br>heatmap(data_mat,<br>        ColSideColors = col_PC1,<br>        xlab = <span>"Disease State Groups"</span>,labRow = <span>""</span>,  <span># 去除横坐标</span><br>        hclustfun = hclust,  <span># default</span><br>        margins = c(<span>5</span>,<span>8</span>))  <span># 避免和后面添加的legend重叠  numeric vector of length 2 containing the margins (see par(mar = *)) for column and row names, respectively.</span><br><br><span># Create a vector of colors and their corresponding labels</span><br>PC1_labels &lt;- c(<span>"low"</span>,<span>"high"</span>)<br>PC1_color &lt;- c(<span>"#FC8D62"</span>, <span>"#66C2A5"</span>)  <span># 根据col_PC1</span><br><span># Create a legend for the color vector</span><br>legend(<span>"topright"</span>, legend = PC1_labels, fill = PC1_color, <br>       bty = <span>"n"</span>, cex = <span>0.5</span>, title = <span>"PC1 groups"</span>)<br><br><span>###### 选择sd标准差大于50的-------------------</span><br>chosen_data1 &lt;- data[data$sd&gt;<span>50</span>, ]  <span># 411</span><br>chosen_data1$sd &lt;- <span>NULL</span><br>data_mat1 &lt;- as.matrix(chosen_data1)<br><span># col_DiseaseState &lt;- RColorBrewer::brewer.pal(2, "Set1")[group_list]</span><br>col_PC1 &lt;- RColorBrewer::brewer.pal(<span>2</span>,<span>"Set2"</span>)[factor(pca_group)]<br><span># colSide &lt;- c(col_DiseaseState,col_PC1)</span><br><span># heatmap(data_mat1,ColSideColors = col_DiseaseState,</span><br><span>#         hclustfun = hclust)  # 默认</span><br>heatmap(data_mat1,<br>        ColSideColors = col_PC1,<br>        xlab = <span>"Disease State Groups"</span>,labRow = <span>""</span>,  <span># 去除横坐标</span><br>        hclustfun = hclust,  <span># default</span><br>        margins = c(<span>5</span>,<span>8</span>))  <span># 避免和后面添加的legend重叠  numeric vector of length 2 containing the margins (see par(mar = *)) for column and row names, respectively.</span><br><br><span># Create a legend for the color vector</span><br>legend(<span>"topright"</span>, legend = PC1_labels, fill = PC1_color, <br>       bty = <span>"n"</span>, cex = <span>0.5</span>, title = <span>"PC1 groups"</span>)<br><br><span>##### 选择sd标准差前100----------</span><br><span>library</span>(tidyverse)<br>chosen_data2 &lt;- tail(arrange(data,sd), <span>100</span>)<br>chosen_data2$sd &lt;- <span>NULL</span><br>data_mat2 &lt;- as.matrix(chosen_data2)<br><span># col_DiseaseState &lt;- RColorBrewer::brewer.pal(2, "Set1")[group_list]</span><br>col_PC1 &lt;- RColorBrewer::brewer.pal(<span>2</span>,<span>"Set2"</span>)[factor(pca_group)]<br><span># colSide &lt;- c(col_DiseaseState,col_PC1)</span><br>heatmap(data_mat2,<br>        ColSideColors = col_PC1,<br>        xlab = <span>"Disease State Groups"</span>,labRow = <span>""</span>,  <span># 去除横坐标</span><br>        hclustfun = hclust,  <span># default</span><br>        margins = c(<span>5</span>,<span>8</span>))  <span># 避免和后面添加的legend重叠  numeric vector of length 2 containing the margins (see par(mar = *)) for column and row names, respectively.</span><br><br><span># Create a legend for the color vector</span><br>legend(<span>"topright"</span>, legend = PC1_labels, fill = PC1_color, <br>       bty = <span>"n"</span>, cex = <span>0.5</span>, title = <span>"PC1 groups"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7536057692307693" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhroursUmtegiceRibm2yfnLAMLb9RPFgt8tnNnBj0cOexVvCkL0CQ1DK9Vyw/640?wx_fmt=png" data-type="png" data-w="832" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhroursUmtegiceRibm2yfnLAMLb9RPFgt8tnNnBj0cOexVvCkL0CQ1DK9Vyw/640?wx_fmt=png"><figcaption>SD&gt;2</figcaption></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.7324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou5KWK0ibsdoSZ5apNPCZVaOo1M8CmH8kqxjib6PrUNUtNHAIRNcywIkuA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou5KWK0ibsdoSZ5apNPCZVaOo1M8CmH8kqxjib6PrUNUtNHAIRNcywIkuA/640?wx_fmt=png"><figcaption>SD&gt;50</figcaption></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.7324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouSDNuwZ7wvZq4ib2gfIPhlLv7xAYbQFsMgAvgRUtpI4EiacDQmib1iceKlQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouSDNuwZ7wvZq4ib2gfIPhlLv7xAYbQFsMgAvgRUtpI4EiacDQmib1iceKlQ/640?wx_fmt=png"><figcaption>SD top100</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>差异分析：<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>load(<span>"1.merge_GSMdata_withGene.RData"</span>)<br>load(<span>"2.PCA.RData"</span>)<br><span>######将FPKM值转换为TPM值--------------</span><br>expMatrix &lt;- data[,c(<span>1</span>:<span>26</span>)]<br>rownames(expMatrix) &lt;- data$gene<br>fpkmToTpm &lt;- <span>function</span>(fpkm)<br>{<br>  exp(log(fpkm) - log(sum(fpkm)) + log(<span>1e6</span>))<br>}<br>tpms &lt;- apply(expMatrix,<span>2</span>,fpkmToTpm) <span>#每列的基因</span><br>tpms[<span>1</span>:<span>3</span>,]<br>colSums(tpms) <span>#都是每一百万（深度一样）</span><br><br><span>#####差异分析----------------</span><br>group_list<br><span>#表达矩阵数据校正</span><br>exprSet &lt;- tpms<br>boxplot(exprSet,outline=<span>FALSE</span>, notch=<span>T</span>,col=group_list, las=<span>2</span>)<br><br><span>library</span>(limma) <br>exprSet=normalizeBetweenArrays(exprSet)<br>boxplot(exprSet,outline=<span>FALSE</span>, notch=<span>T</span>,col=group_list, las=<span>2</span>)<br><br><span>#判断数据是否需要转换</span><br>exprSet &lt;- log2(exprSet+<span>1</span>)<br><span>#差异分析：</span><br>dat &lt;- exprSet<br>design=model.matrix(~factor( group_list ))<br>fit=lmFit(dat,design)<br>fit=eBayes(fit)<br>options(digits = <span>4</span>)<br><span># 获取差异表达基因</span><br>deg=topTable(fit,coef=<span>2</span>,adjust=<span>'BH'</span>,number = <span>Inf</span>)<br>head(deg)<br><span># logFC AveExpr      t   P.Value adj.P.Val     B</span><br><span># ENSG00000185499  3.422   2.750  7.371 9.587e-08  0.002646 7.704</span><br><span># ENSG00000119535  2.734   2.272  7.190 1.478e-07  0.002646 7.317</span><br><span># ENSG00000128203  1.349   1.800  7.081 1.922e-07  0.002646 7.082</span><br><span># ENSG00000101470 -2.496   3.279 -6.969 2.516e-07  0.002646 6.841</span><br><span># ENSG00000211670  4.152   3.780  6.873 3.179e-07  0.002675 6.631</span><br><span># ENSG00000010932 -3.515   3.148 -6.659 5.371e-07  0.003722 6.158</span><br>save(dat,deg,file = <span>'3.2.deg.Rdata'</span>)<br><br><span># load("3.2.deg.Rdata")</span><br><span>## 不同的阈值，筛选到的差异基因数量就不一样，后面的超几何分布检验结果就大相径庭。</span><br><span>if</span>(<span>T</span>){<br>  logFC_t=<span>2</span><br>  deg$g=ifelse(deg$P.Value&gt;<span>0.05</span>,<span>'stable'</span>,<br>               ifelse( deg$logFC &gt; logFC_t,<span>'UP'</span>,<br>                       ifelse( deg$logFC &lt; -logFC_t,<span>'DOWN'</span>,<span>'stable'</span>) )<br>  )<br>  table(deg$g)<br>  <span># DOWN stable     UP </span><br>  <span># 91  41858    123</span><br>  head(deg)<br>}<br><br><span>#####差异基因样本聚类热图------------</span><br><br>sigGenes &lt;- rownames(deg[deg$g!=<span>"stable"</span>,])  <span># 214</span><br><span># 用的是上一步通过差异分析得到的显著基因和tpm的结果</span><br>dat_deg &lt;- dat[match(sigGenes,rownames(dat)),]<br>dat_deg[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span># N1     N2    N3     N4</span><br><span># ENSG00000185499 0.5743 0.7200 1.368 0.7253</span><br><span># ENSG00000119535 0.7383 1.4715 1.012 0.3869</span><br><span># ENSG00000101470 4.3641 4.5919 5.006 5.0930</span><br><span># ENSG00000211670 0.4918 0.4594 1.199 1.2891</span><br>group_list<br><span># 数据框形式分组</span><br><span># disease</span><br>group_disease &lt;- data.frame(group=group_list)<br>rownames(group_disease)=colnames(dat_deg)<br><span>library</span>(pheatmap)<br>pheatmap(dat_deg,<br>         scale = <span>"row"</span>,  <span># 标准化 非归一化</span><br>         show_colnames =<span>T</span>,show_rownames = <span>F</span>, <br>         cluster_cols = <span>T</span>, <br>         annotation_col=group_disease,<br>         main = <span>"DEG_disease_cluster_rowScale"</span>)<br><br><span># PC1</span><br>pca_group<br>group_pc1 &lt;- data.frame(group=pca_group)<br>rownames(group_pc1)=colnames(dat_deg)<br><span>library</span>(pheatmap)<br>pheatmap(dat_deg,<br>         scale = <span>"row"</span>,<br>         show_colnames =<span>T</span>,show_rownames = <span>F</span>, <br>         cluster_cols = <span>T</span>, <br>         annotation_col=group_pc1,<br>         main = <span>"DEG_PC1_cluster_rowScale"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouvcGbMbnFAicOtaLeDiadnLbCc6Sn6ibTxlB9YXe7EiaeV8tHX39bYRyDibw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouvcGbMbnFAicOtaLeDiadnLbCc6Sn6ibTxlB9YXe7EiaeV8tHX39bYRyDibw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><img data-ratio="0.7324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouUNOTo7SuibhKlzIq0S367yMWUgd4MwKdNDxOogw22eWZB2pic0EiaiaGiag/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouUNOTo7SuibhKlzIq0S367yMWUgd4MwKdNDxOogw22eWZB2pic0EiaiaGiag/640?wx_fmt=png">我们的聚类结果可以看出，虽然“disease state”分组的聚类效果也不是很好，但比PC1要好</p><p data-tool="mdnice编辑器">作者认为“disease state”分组的聚类效果不好是因为存在非线性系统差异而生物学背景被覆盖掉</p><p data-tool="mdnice编辑器">单独看根据“disease state”的PCA和热图聚类的效果确实可以认为存在非线性系统差异，但我们没有按作者预期那样得到根据PC1分组聚类的结果</p><blockquote data-tool="mdnice编辑器"><p>您可能希望应用更复杂的规范化技术来强制形状相似。所以我使用了分位数quantile标准化并再次聚类。然而，结果没有改变：PC1高样本和低样本再次聚集在一起。（图4）<img data-ratio="0.6657407407407407" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouoyflUKRAmYhdmibwjVwETGqjjIFU6TicyiapKbdA24RsicAUficH5p7qt7A/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouoyflUKRAmYhdmibwjVwETGqjjIFU6TicyiapKbdA24RsicAUficH5p7qt7A/640?wx_fmt=png">从大规模的微阵列数据分析中已经知道，使分布形状相似并不能纠正非线性系统误差，这对RNA-Seq也是有效的。你必须明白，没有生物信息学方法可以消除组学数据的非线性系统误差。更糟糕的是，这种复杂的归一化技术向研究人员隐瞒了数据质量方面的问题。（请了解RMA或Z分数标准化的情况。）</p></blockquote><p data-tool="mdnice编辑器">我们在上面的差异分析的过程在对TPM矩阵进行了log2，并在绘制热图进行聚类的过程中对每行进行了scale标准化</p><p data-tool="mdnice编辑器"><strong>需要注意的是我们一开始进行差异分析时就画了boxplot查看数据分布，并去除组间差异，这应该与作者所说的“强制分布形状相似”一致</strong></p><p>其实我看作者又画的这个图，PC1分组聚类效果感觉还是没作者说的那么好<br></p><p><br></p><p data-tool="mdnice编辑器">接着作者为了进一步确定非线性系统误差的来源，从头获取fastq文件用其他软件做了一遍：</p><blockquote data-tool="mdnice编辑器"><p>我给你看另一个实验。我下载了FASTQ文件，并用其他算法对它们进行了重新量化；fastp、HISAT2和StringTie。你可以预期，不同的量化会产生不同形状的直方图。但是，PC1得分高和低的样本仍然被再次聚类。（图5）因此，FASTQ文件中一定存在内在差异，并且它主导了所有后续的分析工作。<img data-ratio="0.7564814814814815" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrour64BQiaHQwlSbGy3DuMwt4D4Q2cEbzXqEfPSpiaoSUB3u2uUWeibCduRQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrour64BQiaHQwlSbGy3DuMwt4D4Q2cEbzXqEfPSpiaoSUB3u2uUWeibCduRQ/640?wx_fmt=png"></p></blockquote><p data-tool="mdnice编辑器">数据集上传作者使用的软件：<img data-ratio="0.32314814814814813" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou5m1qFYmrib8TeExhmgCIMnJNexkaZ9jjt5wvxJK4PGTq8BAjRibJL62w/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou5m1qFYmrib8TeExhmgCIMnJNexkaZ9jjt5wvxJK4PGTq8BAjRibJL62w/640?wx_fmt=png">于是，作者将非线性系统误差的来源锁定到了获取fastq文件等实验操作、测序工作上</p><h2 data-tool="mdnice编辑器"><span></span>DE NOVO</h2><h3 data-tool="mdnice编辑器"><span></span>获取数据<span></span></h3><p data-tool="mdnice编辑器">下载 fastq 数据（推荐）从 EBI 数据库直接下载 fastq 格式数据，直接越过 SRA，而且不用再做格式转换https://sra-explorer.info/<img data-ratio="0.7064814814814815" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouUcX6t8qianeoJKuuDK5cCOKKGIM2Ub4hEnvd1wgIa79rmLP6nOafnFw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouUcX6t8qianeoJKuuDK5cCOKKGIM2Ub4hEnvd1wgIa79rmLP6nOafnFw/640?wx_fmt=png"></p><h3 data-tool="mdnice编辑器"><span></span>质控<span></span></h3><p data-tool="mdnice编辑器"><img data-ratio="0.2878965922444183" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouZIUPepahvDia1elFaBayTOs8z9QlOFAAhlqkew398adiaHZghBgicGAuw/640?wx_fmt=png" data-type="png" data-w="851" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouZIUPepahvDia1elFaBayTOs8z9QlOFAAhlqkew398adiaHZghBgicGAuw/640?wx_fmt=png"><img data-ratio="0.28338762214983715" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou10MX8POHHRug2rLndqAAurQ1BzicFZLiadTeeVvrjYOdRvyiau4NgRyZA/640?wx_fmt=png" data-type="png" data-w="921" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou10MX8POHHRug2rLndqAAurQ1BzicFZLiadTeeVvrjYOdRvyiau4NgRyZA/640?wx_fmt=png"></p><h3 data-tool="mdnice编辑器"><span></span>hisat2比对<span></span></h3><figure data-tool="mdnice编辑器"><img data-ratio="0.14722222222222223" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou7fWPDzN6iceHgBzeYibibcgzMT2RzpbzWgmPooGC1faKs4rnX3k1LX4KQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou7fWPDzN6iceHgBzeYibibcgzMT2RzpbzWgmPooGC1faKs4rnX3k1LX4KQ/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.32761904761904764" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouhajawIRWwRcA1icS6mBOeGSEFdgujcicCYpAV6A5rmR3DwNo8fNL5Z9A/640?wx_fmt=png" data-type="png" data-w="525" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouhajawIRWwRcA1icS6mBOeGSEFdgujcicCYpAV6A5rmR3DwNo8fNL5Z9A/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>stringtie定量<span></span></h3><p data-tool="mdnice编辑器">这个软件我之前没用过，这里写的详细点，转录组专辑之前在上游分析推文中使用的都是FeatureCount</p><p data-tool="mdnice编辑器">参考文章：</p><ul data-tool="mdnice编辑器"><li><section>学徒作业-hisat2+stringtie+ballgown流程   https://mp.weixin.qq.com/s?src=11&amp;timestamp=1682431784&amp;ver=4490&amp;signature=J9bCWUQrWood3U9A81VgVa2WRUfBl76OdAUhsTS1GfIQ0ciq1dU7Tz3tbWVulXstT8fysenGBi2gzqMr3XGz3SiFI0kQmIug1tK8kV0xQKWPFsfIQrayk*qsjCoy1WVv&amp;new=1</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.2953703703703704" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouqzKv6kjkGbkLF1CF7P5h7X3DJ24lPzvrCXYbTTnmrctyCk6L8HXD9A/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouqzKv6kjkGbkLF1CF7P5h7X3DJ24lPzvrCXYbTTnmrctyCk6L8HXD9A/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section>RNA-seq : Hisat2+Stringtie+DESeq2   https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247484051&amp;idx=1&amp;sn=aba8f000f86dc9bfb6e330d0591ab302&amp;scene=21&amp;token=1159231349&amp;lang=zh_CN#wechat_redirect</section></li></ul><blockquote data-tool="mdnice编辑器"><p>Stringtie和FeatureCount都是用于转录组定量的工具，但它们使用不同的定量策略。</p><p>在FeatureCount的情况下，它<strong>直接将读数映射到预先存在的注释（如参考基因组或基因注释），并将读数分配给相应的特征</strong>，然后可以用于量化。</p><p>另一方面，Stringtie<strong>使用从头开始的方法从读取中组装转录本并生成新的注释文件。然后使用该组装的转录组来估计来自同一组读数的表达水平。</strong>进行<strong>合并步骤以合并多个样本并生成一致转录组，该转录组可用于定量所有样本中的读数，从而提高准确性和再现性。</strong></p><p>这两种方法各有优缺点。<strong>FeatureCount的分析速度更快、更直接，但它只依赖于预先存在的注释，可能会错过以前没有注释的新的或替代的转录本。Stringtie速度较慢，但可以捕获新的或替代的转录物，并提供了对转录物丰度的改进评估，尤其是对于低表达或重叠的转录物。</strong></p><p>当然stringtie其实也可以直接定量，如果不需要发现新的转录本和基因的话，可直接基于 bam 文件走定量步骤，我们这里还是使用从头开的方法学习一下这个软件。从头开始的方法和软件具体命令参数可参考上面给出的文章。</p></blockquote><h4 data-tool="mdnice编辑器"><span></span>组装<span></span></h4><figure data-tool="mdnice编辑器"><img data-ratio="0.2365097588978186" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouuu25VibqiaOKp2VCu3tMPerA4lxF5Fa1FB4nO9Y4v7d046iawfTnhohIg/640?wx_fmt=png" data-type="png" data-w="871" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouuu25VibqiaOKp2VCu3tMPerA4lxF5Fa1FB4nO9Y4v7d046iawfTnhohIg/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-cropselx1="0" data-cropselx2="558" data-cropsely1="0" data-cropsely2="173" data-ratio="0.34629629629629627" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou4MwibslCGFmewrkMBYrxiakJ8yXS4Dc4Fdib7tXMphExVPyW2vxvwghpQ/640?wx_fmt=jpeg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou4MwibslCGFmewrkMBYrxiakJ8yXS4Dc4Fdib7tXMphExVPyW2vxvwghpQ/640?wx_fmt=jpeg"></figure><h4 data-tool="mdnice编辑器"><span></span>合并<span></span></h4><figure data-tool="mdnice编辑器"><img data-ratio="1.5956284153005464" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou60EVU56rjicyJXeW4XBFAFWuibOggVnAxonZyRKRRo8bp7F6050By4IA/640?wx_fmt=png" data-type="png" data-w="366" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou60EVU56rjicyJXeW4XBFAFWuibOggVnAxonZyRKRRo8bp7F6050By4IA/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.2490740740740741" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhroup52xhXjKribgEl3oKIA4QgmiaapyY2V9ia2iaq6aGp4Pj2KEHLBEic3e75A/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhroup52xhXjKribgEl3oKIA4QgmiaapyY2V9ia2iaq6aGp4Pj2KEHLBEic3e75A/640?wx_fmt=png"></figure><h4 data-tool="mdnice编辑器"><span></span>定量<span></span></h4><figure data-tool="mdnice编辑器"><img data-ratio="0.5212962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhroupZX5Z7Wib6UNOVicydf8PC53P51fpX8AwMVPOYctqhrJD5nQ9zRDvrTQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhroupZX5Z7Wib6UNOVicydf8PC53P51fpX8AwMVPOYctqhrJD5nQ9zRDvrTQ/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p><img data-ratio="0.37475728155339805" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouxTTrhH29qrrVN98asGzxM4zlIic4UOniaLICKVYbnXAZmJqtk2nNOEPg/640?wx_fmt=png" data-type="png" data-w="1030" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouxTTrhH29qrrVN98asGzxM4zlIic4UOniaLICKVYbnXAZmJqtk2nNOEPg/640?wx_fmt=png">我们这里下载的是py3的版本：prepDE.py (python3) : http://ccb.jhu.edu/software/stringtie/dl/prepDE.py3<img data-ratio="0.4685185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouo0IpOt7vbf7HianfE3T45eORoy8QS27ETct8icm1q0CCakE0Gqab2vhw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouo0IpOt7vbf7HianfE3T45eORoy8QS27ETct8icm1q0CCakE0Gqab2vhw/640?wx_fmt=png"></p></blockquote><p data-tool="mdnice编辑器">这里可以发现，我们只用了样本名.gtf文件，而没有用gene_abundances.tsv文件</p><p data-tool="mdnice编辑器">打开看看就可以发现，样本名.gtf文件是包括了转录水平和基因水平的，而gene_abundances.tsv只有基因水平。prepDE.py 脚本可以直接从 gtf 文件中提取 count 值，而不需要使用 gene_abundances.tsv 文件。这样可以省去合并 gene_abundances.tsv 表格的步骤，简化了数据处理流程。</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">结束后在当前目录生成 <code>gene_count_matrix.csv</code>和 <code>transcript_count_matrix.csv</code>文件，我们要用的是基因水平上文件 <code>gene_count_matrix.csv</code></p><p data-tool="mdnice编辑器">到了这一步我们其实就得到了熟悉的raw counts矩阵了，打开看会发现gene_id列有许多“MSTRG”标志符，是因为我们这里使用的是从头开始的方法</p><p data-tool="mdnice编辑器">MSTRG是StringTie软件生成的新基因的命名前缀，表示未在基因组注释中发现的新基因。在gene_count_matrix.csv文件中出现大量的MSTRG表示这些新基因在各个样本中都有被表达并被计算在了count矩阵中</p><p data-tool="mdnice编辑器">MSTRG 是 StringTie 生成的转录本（transcript）的名称，当 StringTie 无法将转录本与已知的基因注释匹配时，会生成一个新的 MSTRG 转录本。在生成 count 矩阵时，StringTie 会将 MSTRG 转录本与已知的基因注释进行合并，并将其与已知的基因一起计算。因此，gene_count_matrix.csv 中出现的 MSTRG 转录本实际上是 StringTie 生成的新转录本和已知基因的合并结果</p><figure data-tool="mdnice编辑器"><img data-ratio="0.1275" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouGNicvibUrZQ1LRR1qZCYkQP0YuRhhyd6icoUUKzVm3yCHDrYt75iannvQQ/640?wx_fmt=png" data-type="png" data-w="400" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouGNicvibUrZQ1LRR1qZCYkQP0YuRhhyd6icoUUKzVm3yCHDrYt75iannvQQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">获取已知基因看看有多少：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.053231939163498096" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrousoxEd60fmhNJPWEZcaML3Ey7WVcCFzMTiaasphaaF8c8ZmPSQibCp2Bg/640?wx_fmt=png" data-type="png" data-w="789" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrousoxEd60fmhNJPWEZcaML3Ey7WVcCFzMTiaasphaaF8c8ZmPSQibCp2Bg/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="1.2576271186440677" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouJyMsUkjibIldCKfLe10hBcWcIaUWyIWLHFKGhxkeh4qibWSgdyqEMJrQ/640?wx_fmt=png" data-type="png" data-w="295" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouJyMsUkjibIldCKfLe10hBcWcIaUWyIWLHFKGhxkeh4qibWSgdyqEMJrQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">48946个，和GEO给的数量42072个差不多</p><h4 data-tool="mdnice编辑器"><span></span>提取 FPKM/TPM 或 coverage 结果<span></span></h4><p data-tool="mdnice编辑器">我们在这里只提取FPKM </p><p data-tool="mdnice编辑器">需要借助一个perl脚本：https://github.com/griffithlab/rnaseq_tutorial/blob/master/scripts/stringtie_expression_matrix.pl</p><figure data-tool="mdnice编辑器"><img data-ratio="0.12130177514792899" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouhHE2DItnGFRCkx2URRzVxicvsYokUpXFRBx1CqDndGibrcQIlQbA4TqQ/640?wx_fmt=png" data-type="png" data-w="676" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouhHE2DItnGFRCkx2URRzVxicvsYokUpXFRBx1CqDndGibrcQIlQbA4TqQ/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.16203703703703703" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou3TfdERHErSaialqwztL4hOUdsWUAicLHLgDLAtZQicK3Sg3wHqv4GlxgQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou3TfdERHErSaialqwztL4hOUdsWUAicLHLgDLAtZQicK3Sg3wHqv4GlxgQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">发现这个脚本--result-dirs必须要求gtf和基因丰度tsv文件在以样本命名的文件夹下</p><p data-tool="mdnice编辑器">手动调整：<img data-ratio="0.053156146179401995" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouleD6wxcHtSAu8icXgGZR6TOLdsibmjibicjPaXib7MJ5CHLk8mL1B0DUZlQ/640?wx_fmt=png" data-type="png" data-w="602" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouleD6wxcHtSAu8icXgGZR6TOLdsibmjibicjPaXib7MJ5CHLk8mL1B0DUZlQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><img data-ratio="0.03333333333333333" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouGHrbFgDB3n1SyNQ0V3lz5tOU16AT716GXsbK8nm8lsMD6FJQ02I6ibg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouGHrbFgDB3n1SyNQ0V3lz5tOU16AT716GXsbK8nm8lsMD6FJQ02I6ibg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">大致这样改文件名</p><p data-tool="mdnice编辑器"><img data-ratio="0.027777777777777776" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrourusSibSy2ZsM6U4iaN1w2k1XlJgPECaInzTAR11YicmMrkmEPDrFSIsqw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrourusSibSy2ZsM6U4iaN1w2k1XlJgPECaInzTAR11YicmMrkmEPDrFSIsqw/640?wx_fmt=png">这中间我有个地方看错了，来来回回改名字有点乱就不贴了。反正最后就是改成这个样：</p><p data-tool="mdnice编辑器"><img data-ratio="0.553314121037464" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouqzicvI35H5LAhEVCvMKQmVYOCGt2QSTZCiaLrhwPaicFIFuQGG2DElrVw/640?wx_fmt=png" data-type="png" data-w="347" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouqzicvI35H5LAhEVCvMKQmVYOCGt2QSTZCiaLrhwPaicFIFuQGG2DElrVw/640?wx_fmt=png">获取逗号分隔样本文件名：<img data-ratio="0.04492512479201331" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouf7QbVm9LOmkxwIwQSZygs2QsxJWb385EiaLj7HKwEVrpX3MKFJxFC2Q/640?wx_fmt=png" data-type="png" data-w="601" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouf7QbVm9LOmkxwIwQSZygs2QsxJWb385EiaLj7HKwEVrpX3MKFJxFC2Q/640?wx_fmt=png">运行脚本提取FPKM:</p><p data-tool="mdnice编辑器"><img data-ratio="0.21944444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou0RzSjtbyVRpKFLwRRxqqdBqyvbsLka2qV7vL0K43uPUWKmMOr5ficbA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrou0RzSjtbyVRpKFLwRRxqqdBqyvbsLka2qV7vL0K43uPUWKmMOr5ficbA/640?wx_fmt=png">怪事出现了，脚本说它找不到transcript_id，但文件里明明是有的</p><p data-tool="mdnice编辑器">查看脚本所在仓库issue：https://github.com/griffithlab/rnaseq_tutorial/issues/46https://github.com/griffithlab/rnaseq_tutorial/issues/48</p><p data-tool="mdnice编辑器">发现存在相同问题：</p><figure data-tool="mdnice编辑器"><img data-ratio="1.0097902097902098" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrougGk902BlictjWlaHprN2MAwwX60tmG7K1BqKXQBV3PFHwQJqibA3NFvg/640?wx_fmt=png" data-type="png" data-w="715" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrougGk902BlictjWlaHprN2MAwwX60tmG7K1BqKXQBV3PFHwQJqibA3NFvg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><img data-ratio="0.42953929539295393" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouZbqmZY8yKoBp8C32s3WhsDD3ibr9bI2UTuCeiaibzcrc23AC8VZOKbcFg/640?wx_fmt=png" data-type="png" data-w="738" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouZbqmZY8yKoBp8C32s3WhsDD3ibr9bI2UTuCeiaibzcrc23AC8VZOKbcFg/640?wx_fmt=png">由于我本人不会perl所以我打开脚本大致看了看没看懂哪里有问题</p><p data-tool="mdnice编辑器">所以接下来我们使用raw counts矩阵进行分析</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247509250&amp;idx=1&amp;sn=38a4201cc0987208e5fd6d2f8c20b40b&amp;chksm=fa45603fcd32e92967d2eba813bfa26deeb5a68cb7be108d0540701a1c1cde82f97410bb9d4c&amp;scene=21&amp;cur_album_id=2545418429466607617#wechat_redirect" data-linktype="2">转录组差异分析FPKM与count处理差别大吗</a></section></li></ul><hr data-tool="mdnice编辑器"><h4 data-tool="mdnice编辑器"><span></span>raw counts 差异分析<span></span></h4><h5 data-tool="mdnice编辑器"><span></span>PCA<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 用counts进行差异分析PC1试一试</span><br>rm(list=ls())<br>data &lt;- read.table(<span>"known_gene_count_matrix.csv"</span>,sep = <span>','</span>,header = <span>T</span>)  <span># 表达矩阵</span><br>rownames(data) &lt;- data$gene_id<br>data$gene_id &lt;- <span>NULL</span><br><br>options(stringsAsFactors = <span>F</span>) <br>getOption(<span>'timeout'</span>)  <span># 60</span><br>options(timeout=<span>10000</span>)<br><span>library</span>(FactoMineR)<br><span>library</span>(factoextra)<br><br>group=rep(c(<span>"Non-IBD"</span>,<span>"CD"</span>),each=<span>13</span>)<br>group_list=factor(group,levels = c(<span>"Non-IBD"</span>,<span>"CD"</span>))<br>table(group_list)<span>#检查一下组别数量</span><br><span># Non-IBD      CD </span><br><span># 13      13</span><br><br><span># PCA</span><br>data[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span># SRR12858287 SRR12858288 SRR12858289 SRR12858290</span><br><span># ENSG00000288531                    0          11          11           0</span><br><span># ENSG00000230368|FAM41C             8           0           0           0</span><br><span># ENSG00000283040                    0           0           0           0</span><br><span># ENSG00000234711|TUBB8P11           1           2           0           0</span><br><br><span># 添加group列</span><br>data &lt;- as.data.frame(t(data))<br>data$group &lt;- group_list<br>data[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span># ENSG00000000003 ENSG00000000005 ENSG00000000419 ENSG00000000457</span><br><span># N1        4.936070      0.28569398        9.950503        1.425634</span><br><span># N2        4.704400      0.00000000       12.708906        1.571140</span><br><span># N3        6.968420      0.06803618       20.555438        1.249274</span><br><span># N4        7.351349      0.03205427       17.829558        1.941931</span><br>table(data$group)<br><span># Non-IBD      CD </span><br><span># 13      13 </span><br><span># 绘图</span><br>dat_pca &lt;- PCA(data[,-ncol(data)], graph = <span>FALSE</span>)  <span># 去除非数值列 pca结果</span><br>PCAplot&lt;- fviz_pca_ind(dat_pca,<br>                       geom.ind = <span>"point"</span>, <span># 只显示点，不显示文字</span><br>                       col.ind = data$group, <span># 用不同颜色表示分组</span><br>                       palette = c(<span>"#00AFBB"</span>, <span>"#E7B800"</span>),<br>                       addEllipses = <span>T</span>, <span># 是否圈起来，少于4个样圈不起来</span><br>                       legend.title = <span>"disease state groups"</span>) + theme_bw()<br>PCAplot<br><br><span># So I marked samples as PC1 score high and low (pink and green).</span><br>pca_group &lt;- rep(<span>"PC1 high socres"</span>,<span>26</span>)<br>pca_group[which(dat_pca$ind$coord[,<span>1</span>]&lt;<span>0</span>)] &lt;- <span>"PC1 low scores"</span><br>table(pca_group)<br><span># PC1 high socres  PC1 low scores </span><br><span># 14              12 </span><br>PCAplot_byPCA1&lt;- fviz_pca_ind(dat_pca,<br>                              geom.ind = <span>"point"</span>, <span># 只显示点，不显示文字</span><br>                              col.ind = pca_group, <span># 用不同颜色表示分组</span><br>                              palette = c(<span>"#00AFBB"</span>, <span>"#E7B800"</span>),<br>                              addEllipses = <span>T</span>, <span># 是否圈起来，少于4个样圈不起来</span><br>                              legend.title = <span>"PC1 scores groups"</span>) + theme_bw()<br>PCAplot_byPCA1<br><br>pca_group<br>mypca_group &lt;- pca_group<br>save(mypca_group, group_list,file = <span>"3.4.myPCA.RData"</span>)<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.7324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouYnEhr2CXvs1PnnIbicsVOibCBiaQNKkM6FWbgt0T7asxWNdv0nzfNKDnA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouYnEhr2CXvs1PnnIbicsVOibCBiaQNKkM6FWbgt0T7asxWNdv0nzfNKDnA/640?wx_fmt=png">其实可以明显看出来counts的PCA比FPKM的好一些</p><figure data-tool="mdnice编辑器"><img data-ratio="0.7324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouGNQvO7wbd86zl7jjWWib6v0QHAjn0icwdB10tJ9B8FRL7LyTLd7HRAnQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouGNQvO7wbd86zl7jjWWib6v0QHAjn0icwdB10tJ9B8FRL7LyTLd7HRAnQ/640?wx_fmt=png"></figure><h5 data-tool="mdnice编辑器"><span></span>hierarchical clustering<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>mydata &lt;- read.table(<span>"known_gene_count_matrix.csv"</span>,sep = <span>','</span>,header = <span>T</span>)<br>rownames(mydata) &lt;- mydata$gene_id<br>mydata$gene_id &lt;- <span>NULL</span><br><br>load(<span>"1.merge_GSMdata_withGene.RData"</span>)<br>load(<span>"2.PCA.RData"</span>)<br>group_list<br>colnames(mydata) &lt;- c(paste0(<span>"N"</span>,seq(<span>1</span>,<span>13</span>)),<br>                      paste0(<span>"C"</span>,seq(<span>1</span>,<span>13</span>)))<br><span>#表达矩阵数据校正</span><br>exprSet &lt;- mydata<br>boxplot(exprSet,outline=<span>FALSE</span>, notch=<span>T</span>,col=group_list, las=<span>2</span>)<br><br><span>library</span>(limma) <br>exprSet=normalizeBetweenArrays(exprSet)<br>boxplot(exprSet,outline=<span>FALSE</span>, notch=<span>T</span>,col=group_list, las=<span>2</span>)<br><span># 标准化 这里直接log2 </span><br><span># ###limma----voom差异分析</span><br><span># library(limma)</span><br><span># #1</span><br><span># exp=filter_count</span><br><span># Group=group_list</span><br><span># #2</span><br><span># dge &lt;- edgeR::DGEList(counts=exp)  # 需要借助edgeR包DGEList函数创建对象</span><br><span># dge &lt;- edgeR::calcNormFactors(dge)  # 以及对count标准化</span><br><span># # 无比较矩阵</span><br><span># #3</span><br><span># design &lt;- model.matrix(~Group)  # 所以类似edgeR的流程，也要单独设计方案</span><br><span># #4</span><br><span># v &lt;- voom(dge,design, normalize="quantile")</span><br>exprSet &lt;- log2(exprSet+<span>1</span>)<br><span>#差异分析：</span><br>dat &lt;- exprSet<br>design=model.matrix(~factor( group_list ))<br>fit=lmFit(dat,design)<br>fit=eBayes(fit)<br>options(digits = <span>4</span>)<br><span># 获取差异表达基因</span><br>deg=topTable(fit,coef=<span>2</span>,adjust=<span>'BH'</span>,number = <span>Inf</span>)<br>head(deg)<br><span># logFC AveExpr      t   P.Value adj.P.Val     B</span><br><span># MSTRG.5743|MT1HL1 -4.968   4.318 -7.135 2.065e-07   0.01011 6.880</span><br><span># MSTRG.22181|MT1G  -2.631  12.369 -6.594 7.494e-07   0.01297 5.580</span><br><span># MSTRG.22176|MT1H  -3.797   9.012 -6.570 7.952e-07   0.01297 5.521</span><br><span># MSTRG.22176|MT2A  -1.617  12.495 -6.400 1.201e-06   0.01469 5.105</span><br><span># MSTRG.21460|ZP2   -3.606   2.371 -6.204 1.939e-06   0.01898 4.623</span><br><span># MSTRG.7474|PRXL2A -1.477  11.128 -6.114 2.420e-06   0.01974 4.400</span><br><br><span>## 不同的阈值，筛选到的差异基因数量就不一样，后面的超几何分布检验结果就大相径庭。</span><br><span>if</span>(<span>T</span>){<br>  logFC_t=<span>2</span><br>  deg$g=ifelse(deg$P.Value&gt;<span>0.05</span>,<span>'stable'</span>,<br>               ifelse( deg$logFC &gt; logFC_t,<span>'UP'</span>,<br>                       ifelse( deg$logFC &lt; -logFC_t,<span>'DOWN'</span>,<span>'stable'</span>) )<br>  )<br>  table(deg$g)<br>  <span># DOWN stable     UP </span><br>  <span># 426  48232    288 </span><br>  head(deg)<br>}<br><span># logFC AveExpr      t   P.Value adj.P.Val     B      g</span><br><span># MSTRG.5743|MT1HL1 -4.968   4.318 -7.135 2.065e-07   0.01011 6.880   DOWN</span><br><span># MSTRG.22181|MT1G  -2.631  12.369 -6.594 7.494e-07   0.01297 5.580   DOWN</span><br><span># MSTRG.22176|MT1H  -3.797   9.012 -6.570 7.952e-07   0.01297 5.521   DOWN</span><br><span># MSTRG.22176|MT2A  -1.617  12.495 -6.400 1.201e-06   0.01469 5.105 stable</span><br><span># MSTRG.21460|ZP2   -3.606   2.371 -6.204 1.939e-06   0.01898 4.623   DOWN</span><br><span># MSTRG.7474|PRXL2A -1.477  11.128 -6.114 2.420e-06   0.01974 4.400 stable</span><br><br><span>#####差异基因样本聚类热图------------</span><br><br>sigGenes &lt;- rownames(deg[deg$g!=<span>"stable"</span>,])  <span># 714</span><br><span># 用的是上一步通过差异分析得到的显著基因和tpm的结果</span><br>dat_deg &lt;- dat[match(sigGenes,rownames(dat)),]<br>dat_deg[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span># N1     N2     N3     N4</span><br><span># MSTRG.5743|MT1HL1  6.238  7.942  7.723  8.553</span><br><span># MSTRG.22181|MT1G  13.401 14.159 14.425 14.035</span><br><span># MSTRG.22176|MT1H  10.439 11.601 11.553 11.601</span><br><span># MSTRG.21460|ZP2    3.976  4.509  5.038  5.989</span><br>group_list<br><span># 数据框形式分组</span><br><span># disease</span><br>group_disease &lt;- data.frame(group=group_list)<br>rownames(group_disease)=colnames(dat_deg)<br><span>library</span>(pheatmap)<br>pheatmap(dat_deg,<br>         scale = <span>"row"</span>,  <span># 标准化 非归一化</span><br>         show_colnames =<span>T</span>,show_rownames = <span>F</span>, <br>         cluster_cols = <span>T</span>, <br>         annotation_col=group_disease,<br>         main = <span>"DEG_disease_cluster_rowScale"</span>)<br><br><span># PC1</span><br><span># pca_group</span><br>group_pc1 &lt;- data.frame(group=pca_group)<br>rownames(group_pc1)=colnames(dat_deg)<br><span>library</span>(pheatmap)<br>pheatmap(dat_deg,<br>         scale = <span>"row"</span>,<br>         show_colnames =<span>T</span>,show_rownames = <span>F</span>, <br>         cluster_cols = <span>T</span>, <br>         annotation_col=group_pc1,<br>         main = <span>"DEG_raw_PC1_cluster_rowScale"</span>)<br><br>save(mydata,file=<span>"3.3.mydata_deg.RData"</span>)<br><span>####</span><br><span># 3.4</span><br><span># 用counts进行差异分析PC1试一试</span><br><span>####</span><br>load(<span>"3.4.myPCA.RData"</span>)<br>mypca_group<br>group_pc1 &lt;- data.frame(group=mypca_group)<br>rownames(group_pc1)=colnames(dat_deg)<br>group_pc1<br><span>library</span>(pheatmap)<br>pheatmap(dat_deg,<br>         scale = <span>"row"</span>,<br>         show_colnames =<span>T</span>,show_rownames = <span>F</span>, <br>         cluster_cols = <span>T</span>, <br>         annotation_col=group_pc1,<br>         main = <span>"DEG_my_PC1_cluster_rowScale"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouvcGbMbnFAicOtaLeDiadnLbCc6Sn6ibTxlB9YXe7EiaeV8tHX39bYRyDibw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouvcGbMbnFAicOtaLeDiadnLbCc6Sn6ibTxlB9YXe7EiaeV8tHX39bYRyDibw/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.7324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouUNOTo7SuibhKlzIq0S367yMWUgd4MwKdNDxOogw22eWZB2pic0EiaiaGiag/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouUNOTo7SuibhKlzIq0S367yMWUgd4MwKdNDxOogw22eWZB2pic0EiaiaGiag/640?wx_fmt=png"><figcaption>FPKM_PC1group</figcaption></figure><p data-tool="mdnice编辑器"><img data-ratio="0.7324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouXltvpCOB2UC669y1opeYsnjvticd4x0krm8jLkB1uLKqtzTCQsNsIIA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibiavjpo1zc5g4Gw1xKMhrouXltvpCOB2UC669y1opeYsnjvticd4x0krm8jLkB1uLKqtzTCQsNsIIA/640?wx_fmt=png">可以发现重新用其他上游分析软件获得的counts的聚类结果中确实也存在非线性系统误差，没有完全根据”state disease“分组聚类</p><p data-tool="mdnice编辑器">但也没如作者所说的那样根据PC1得分分组聚类</p><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span>总结</h2><p data-tool="mdnice编辑器">针对在一开始我们归纳的作者的两个观点，我们根据上面的复现结果进行讨论：</p><blockquote data-tool="mdnice编辑器"><p>TPM/FPKM/RPKM并虽然理论上可以消除线性系统误差，但对差异分析而言结果却不如raw counts不理想，这在一定程度反映了这些均一化方法的局限性和处理带来的潜在偏差</p></blockquote><p data-tool="mdnice编辑器">我们的结果中counts相比FPKM拥有更好的PCA效果（除了FPKM处理，还可能的影响：我们自己进行的转录组上游分析软件所用参数，如质控可能更严格等），FPKM虽然理论上可以消除线性系统误差但是无法消除非线性系统误差，所以如果选择FPKM而非counts并不能达到理想的去除系统误差效果，并且这样的处理可能会掩盖掉数据的质量问题，目前主流也是根据counts来进行差异分析</p><blockquote data-tool="mdnice编辑器"><p>在实验设计和操作环节需要尤其注意非线性误差的潜在影响，因为没有生物信息学方法可以处理非线性误差，任何不同来源的数据集的合并都是不可接受的</p></blockquote><p data-tool="mdnice编辑器">在我们的分析中可以发现该数据集确实存在非线性系统误差，并且经过自行使用其他软件进行上游分析得到counts进行差异分析，可以确定早在fastq文件中就存在这种误差，非线性系统误差来自实验设计、操作、测序等环节。</p><p data-tool="mdnice编辑器">作者认为没有任何生物信息学方法可以在处理的过程中去除这些误差（这里做了分布形状的校准）从而进一步提出任何不同来源的数据集的合并都是不可接受的</p><p data-tool="mdnice编辑器">此前表达量芯片专辑有篇推文介绍了如何整合不同数据集的结果<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247508097&amp;idx=1&amp;sn=1d5956fe296ff4012d281d9b5c3891cf&amp;chksm=fa4565bccd32ecaaeb00a9978a0f93dc8a516627bf9ecbeb4f11dd14f4b0edb160c15e3b6c1d&amp;scene=21&amp;cur_album_id=2544050400275136513#wechat_redirect" data-linktype="2">老文新看，今天来看看两个数据集的整合分析</a>，涉及到三种方法：</p><ul data-tool="mdnice编辑器"><li><section><p>直接<code>limma::removeBatchEffect()</code>移除批次效应，合并数据集</p></section></li><li><section><p>分别对两个数据集进行差异分析，然后取它们的交集</p></section></li><li><section><p>在第二种方法基础上，RRA方法对多个排好序的差异基因集，进行求交集的同时还考虑一下它们的排序情况</p></section></li></ul><p data-tool="mdnice编辑器">这里主要谈论的是第一种方法的可行性</p><p data-tool="mdnice编辑器">小编认为，①是否可以在“移除批次效应合并数据集”之前单独参照本文对非线性系统误差进行查看呢？如果各数据集实验分组聚类效果很好，是不是就可以合并呢？合并后再次查看实验分组聚类效果。</p><p data-tool="mdnice编辑器">②对单个数据集，如果PCA的效果不好，转录组专辑此前也介绍了一些处理方法“亡羊补牢”：<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247508815&amp;idx=1&amp;sn=e739ff0683fcb5aa18c53a3165db3a9b&amp;chksm=fa456672cd32ef649a05d0b079918b01a2c739ad4898b248c5f88d4391768c06ddab79e119e4&amp;scene=21&amp;cur_album_id=2545418429466607617#wechat_redirect" data-linktype="2">PCA效果不行，我们可以试试这样补救下</a>，那么进行了补救（筛选聚类合格样本数据数据后）能否再进行多个数据集合并呢？</p><p data-tool="mdnice编辑器">同时，我们的复现过程中存在一些跟作者不一致的地方也值得深入探讨，比如为什么作者预测认为存在非线性系统误差的数据集应该在PC1得分分组上有很好的聚类效果？欢迎大家在评论区讨论。</p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/L5ikz6qmCTSoO4ut4ahQvg",target="_blank" rel="noopener noreferrer">原文链接</a>
