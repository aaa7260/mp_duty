---
title: "ComplexHeatmap热图系列学习1"
date: 2023-04-11T00:58:37Z
draft: ["false"]
tags: [
  "fetched",
  "生信小知识"
]
categories: ["Acdemic"]
---
ComplexHeatmap热图系列学习1 by 生信小知识
------
<div><section><h2><span>ComplexHeatmap热图系列学习1</span></h2><blockquote><p>微信公众号：<strong>生信小知识</strong><br>关注可了解更多的生物信息学教程及知识。问题或建议，请公众号留言;</p></blockquote><h3><span>目录</span></h3><p><span><span>前言</span></span><span><span>0. 测试数据</span></span><span><span>1. Heatmap 函数</span></span><span><span>2. 配色</span></span><span><span><span>2.1 向量配色</span></span></span><span><span><span>2.2 颜色自动scale</span></span></span><span><span><span>2.3 连续性数值与离散型数值</span></span></span><span><span><span><span>2.3.1 连续性数值</span></span></span></span><span><span><span><span>2.3.2 离散型数值</span></span></span></span><span><span><span>2.4 缺失值NA</span></span></span><span><span><span>2.5 热图边框</span></span></span><span><span><span>2.6 热图方块边框颜色</span></span></span><span><span><span>2.7 标题背景</span></span></span><span><span>3. 标题</span></span><span><span><span>3.1 标题大小位置及方向</span></span></span><span><span><span>3.2 聚类标题</span></span></span><span><span><span>3.3 公式标题</span></span></span><span><span><span>3.4 各式各样标题格式</span></span></span><span><span>4. 聚类</span></span><span><span><span>4.1 聚类开关</span></span></span><span><span><span>4.2 聚类树位置及高度</span></span></span><span><span><span>4.3 层次聚类距离计算方式</span></span></span><span><span><span>4.4 层次聚类方式</span></span></span><span><span><span>4.5 聚类树形态</span></span></span><span><span>5. 自定义排序</span></span><span><span><span>5.1 以字符串形式排序</span></span></span><span><span><span>5.2 以数值型形式排序</span></span></span><span><span>6. 拆分热图</span></span><span><span><span>6.1 按照聚类结果拆分热图</span></span></span><span><span><span>6.2 通过向量分割</span></span></span><span><span><span>6.3 通过数据框分割</span></span></span><span><span><span>6.4 分割间隔的大小</span></span></span><span><span><span><span>6.4.1 分割间隔的美化</span></span></span></span><span><span><span>6.5 分割后排序</span></span></span><span><span><span>6.6 热图拆分slice标题设定</span></span></span><span><span><span>6.7 热图拆分slice标题和总标题共存</span></span></span><span><span>7. 标题的图形修饰</span></span><span><span>8. 结果保存——平衡文件大小与清晰度</span></span><span><span>后记</span></span></p><h3><span>前言</span></h3><p>最近对热图的需求增加，但是使用 <code>pheatmap</code> 已经不能满足我日渐复杂的需求了，所以这里花点时间 学习下功能更加强大的 <code>ComplexHeatmap</code>。</p><p>具体学习资料来自我的网友吴先生的公众号 ：Biomamba 生信基地，有兴趣的可以关注下：</p><ul><li><p><a href="https://mp.weixin.qq.com/s?__biz=MzAwMzIzOTk5OQ==&amp;mid=2247495595&amp;idx=4&amp;sn=8e81b9cc6aa5383e40b9eece37a2dde7&amp;scene=21#wechat_redirect" data-linktype="2">热图绘制天花板：ComplexHeatmap| 一、初探</a></p></li></ul><p><br></p><section><mp-common-profile data-pluginname="mpprofile" data-weui-theme="light" data-id="MzAwMzIzOTk5OQ==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/ImlBFVOwwpzyQpcoEQKDb6ic0Dia8dFR0tfmNm2u0eJfmhJzN3Jjh0jmmTycIeJdu7XMxu6Fvz8jicsKmH2S4MvOQ/0?wx_fmt=png" data-nickname="Biomamba 生信基地" data-alias="" data-signature="本人为在读博士研究生，此公众号旨在分享生信知识及科研经验与体会，欢迎各位同学、老师与专家的批评指正，也欢迎各界人士的合作与交流。" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><p><br></p><p><code>ComplexHeatmap</code>，这个包最初由<strong>Zuguang Gu</strong>博士于2016年被发布在《<strong>Bioinformatics</strong>》上，最初的灵感来自于 <code>pheatmap</code> ，甚至作者最初写的包就叫pheatmap2，因此 ComplexHeatmap 当中的许多函数名称也与 <code>pheatmap</code> 相同或类似。该包的官方教程参考：</p><ul><li><p><span>https://jokergoo.github.io/ComplexHeatmap-reference/book/</span></p></li></ul><p>今天主要学习最简单的部分：<strong>单个</strong>热图的热图<strong>主体部分</strong>。</p><section><mp-common-profile data-pluginname="mpprofile" data-weui-theme="light" data-id="MjM5NTk0Mzg2Nw==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJo1mibx7zpDpGwiaZDqzB9Z9RLOTh583lDKece7X3iczxtY5qS4neHe0GNGDvicK3aQPTWxiaBTuPtfJKg/0?wx_fmt=png" data-nickname="生信小知识" data-alias="" data-signature="记录自学生信的技术之路，将积累的经验为有相同需求的小白们铺平道路，避免误入我走过的弯路～" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><h3><span>0. 测试数据</span></h3><pre><code>set.seed(<span>123</span>)<br><br><span># matrix</span><br><span>if</span> (<span>T</span>) {<br>  mat = cbind(rbind(matrix(rnorm(<span>4</span>*<span>6</span>, mean = <span>1</span>,   sd = <span>0.5</span>), nrow = <span>4</span>),<br>                    matrix(rnorm(<span>4</span>*<span>6</span>, mean = <span>2</span>,   sd = <span>0.5</span>), nrow = <span>4</span>)))<br><br>  mat = mat[sample(<span>1</span>:nrow(mat), <span>6</span>), sample(<span>1</span>:ncol(mat), <span>6</span>)]<br><br>  rownames(mat) = paste0(<span>"row"</span>, <span>1</span>:nrow(mat))<br>  colnames(mat) = paste0(<span>"column"</span>, <span>1</span>:ncol(mat))<br>  mat[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>}<br><span>##        column1   column2   column3   column4</span><br><span>## row1 1.6874804 2.6039810 2.4475628 2.2769588</span><br><span>## row2 1.1566533 1.4384457 2.4390667 1.9690441</span><br><span>## row3 1.7793542 0.4869978 1.6120409 0.7220794</span><br><span>## row4 0.7197622 0.4660881 0.6565736 1.2003857</span><br></code></pre><h3><span>1. Heatmap 函数</span></h3><p><code>Heatmap</code> 的默认参数效果与 <code>pheatmap</code> 包很相似（配色也是蓝-白-红），输出结果包括聚类树状图、行列注释和图注：</p><pre><code><span>library</span>(ComplexHeatmap)<br>Heatmap(mat)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicGeFGVveh21dibNpTUdYzmxkqGotLY3mOXiclocHhlLPvq0Gppsa1dicyA/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicGeFGVveh21dibNpTUdYzmxkqGotLY3mOXiclocHhlLPvq0Gppsa1dicyA/640?wx_fmt=png"></p><figure><figcaption>fig1</figcaption></figure><p>在 <code>Heatmap</code> 函数的结果赋值给一个对象时，我们使用 <code>print()</code> <strong>有时</strong>不能正确显示结果，很容易出现bug，正确的做法是：</p><pre><code>pic = Heatmap(mat)<br>ComplexHeatmap::draw(pic)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicf0ry95msibPdSYkQptxtz8pIwjD9vchSJvomictICAQuIyvx3roxzxsw/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicf0ry95msibPdSYkQptxtz8pIwjD9vchSJvomictICAQuIyvx3roxzxsw/640?wx_fmt=png"></p><figure><figcaption>fig2</figcaption></figure><h3><span>2. 配色</span></h3><h4><span>2.1 向量配色</span></h4><p>这里大家只需将一个颜色向量传递给 <code>Heatmap</code> 函数的<strong>col参数</strong>即可。</p><p>我们使用 <code>circlize</code> 包来自动设置颜色：</p><pre><code><span>library</span>(circlize)<br><span># colorRamp2函数返回的是一个定义好的函数</span><br>col_fun = colorRamp2(c(-<span>2</span>, <span>0</span>, <span>2</span>), <span># 颜色对应的填充值范围</span><br>                     c(<span>"green"</span>, <span>"white"</span>, <span>"red"</span>)) <span># 设置上述值对应的颜色</span><br><br><span># 对于返回的函数col_fun，我们可以给一系列数字，该函数会根据上述定义返回该数字对应的颜色。例如下面例子中，我们可以看到当数字超过2后，返回的颜色都是#FF0000FF</span><br>col_fun(seq(-<span>3</span>, <span>3</span>))<br><span>## [1] "#00FF00FF" "#00FF00FF" "#B1FF9AFF" "#FFFFFFFF" "#FF9E81FF" "#FF0000FF" "#FF0000FF"</span><br></code></pre><p>有了这个函数，我们在画图时只需要将该函数传递到 <code>Heatmap</code> 的参数中即可：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, col = col_fun)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicHKiaBYMVdPX3oBmDyP6flBtnYLxLxlgCp9I5t1zCJB77luGhVicZGP2g/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicHKiaBYMVdPX3oBmDyP6flBtnYLxLxlgCp9I5t1zCJB77luGhVicZGP2g/640?wx_fmt=png"></p><figure><figcaption>fig3</figcaption></figure><h4><span>2.2 颜色自动scale</span></h4><p>按照上面的颜色分配，<strong>负值呈绿色，正值成红色</strong>。</p><p>这里即使不进行 <code>scale</code>，热图的颜色也<strong>不会受到极端值的影响（这是因为col_fun函数将-2至2的区间均匀分配在了c(“green”, “white”, “red”)的颜色向量之中，超过-2至2的值会被极值对应的颜色替代）</strong>，<strong>但是聚类树状图会受到影响（因为聚类本质上是根据热图中具体数据进行的，而不是根据颜色）</strong>：</p><pre><code>mat2 = mat<br>mat2[<span>1</span>, <span>1</span>] = <span>100000</span><br>Heatmap(mat2, name = <span>"mat"</span>, col = col_fun, <br>        column_title = <span>"左上角包含离群值"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic1PVZseybdbjlHSS0jTcP46GaknJxVAGuLYsKRLwAtEv8pyHL8Ptib3A/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic1PVZseybdbjlHSS0jTcP46GaknJxVAGuLYsKRLwAtEv8pyHL8Ptib3A/640?wx_fmt=png"></p><figure><figcaption>fig4</figcaption></figure><p>这里我们将mat矩阵做一定的变换，来检测当mat中的值超过【-2,2】后热图的改变：</p><pre><code>myh1 &lt;- Heatmap(mat, name = <span>"mat"</span>, col = col_fun, column_title = <span>"mat"</span>)<br>myh2 &lt;- Heatmap(mat/<span>4</span>, name = <span>"mat"</span>, col = col_fun, column_title = <span>"mat/4"</span>) <span># mat/4后热图颜色变浅</span><br>myh3 &lt;- Heatmap(abs(mat), name = <span>"mat"</span>, col = col_fun, column_title = <span>"abs(mat)"</span>) <span># abs取绝对值后绿色色块会消失</span><br><br><span># draw函数类似于patchwork可以用加号拼图</span><br>draw(myh1+myh2+myh3)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicPfLicA3sA25YcydWz0Qyiar9Qj2gtwUSDQEwaQDKmficibSVR3ZliahX4Cg/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicPfLicA3sA25YcydWz0Qyiar9Qj2gtwUSDQEwaQDKmficibSVR3ZliahX4Cg/640?wx_fmt=png"></p><figure><figcaption>fig5</figcaption></figure><h4><span>2.3 连续性数值与离散型数值</span></h4><h5><span>2.3.1 连续性数值</span></h5><p>如果我们想让程序自动根据提供的颜色对数据进行映射，我们直接输入一个颜色向量即可：</p><pre><code>range(mat)<br><span>## [1] 0.2861571 2.6461530</span><br><br><span># 色块的范围: 0-3</span><br>Heatmap(mat, name = <span>"mat"</span>, col = rev(rainbow(<span>10</span>)), <br>        column_title = <span>"set a color vector for a continuous matrix"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYickF5USZkicLt6iavo7HKOsR6CqgB5FCbeJ9pLUykE4E5aLCUMwWmlBSDw/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYickF5USZkicLt6iavo7HKOsR6CqgB5FCbeJ9pLUykE4E5aLCUMwWmlBSDw/640?wx_fmt=png"></p><figure><figcaption>fig6</figcaption></figure><h5><span>2.3.2 离散型数值</span></h5><p>如果一个<strong>矩阵中包含的均是离散型数据</strong>，那么我们可以构建一个映射向量用来确认值与颜色的对应关系。</p><p>我们先构建一个测试数据：</p><pre><code>discrete_mat = matrix(sample(LETTERS[<span>1</span>:<span>4</span>], <span>36</span>, replace = <span>TRUE</span>), <span>6</span>, <span>6</span>)<br>discrete_mat<br><span>##      [,1] [,2] [,3] [,4] [,5] [,6]</span><br><span>## [1,] "C"  "C"  "B"  "D"  "C"  "D" </span><br><span>## [2,] "C"  "A"  "A"  "A"  "A"  "B" </span><br><span>## [3,] "D"  "A"  "D"  "D"  "A"  "A" </span><br><span>## [4,] "B"  "C"  "B"  "A"  "C"  "A" </span><br><span>## [5,] "C"  "B"  "B"  "A"  "A"  "C" </span><br><span>## [6,] "C"  "C"  "B"  "C"  "C"  "D" </span><br></code></pre><p>然后构建一个颜色映射向量：</p><pre><code>colors = <span>1</span>:length(LETTERS[<span>1</span>:<span>4</span>])<br>names(colors) &lt;- LETTERS[<span>1</span>:<span>4</span>]<br>colors<br><span>## A B C D </span><br><span>## 1 2 3 4 </span><br><br>str(colors)<br><span>##  Named int [1:4] 1 2 3 4</span><br><span>##  - attr(*, "names")= chr [1:4] "A" "B" "C" "D"</span><br></code></pre><p>然后绘制热图：</p><pre><code>Heatmap(discrete_mat, name = <span>"mat"</span>, col = colors,<br>        column_title = <span>"a discrete numeric matrix"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicPSrSmsOX6a6Ll66iaztXranq6Xrv2GHSMCHib1ickXmndmznerR62UTzA/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicPSrSmsOX6a6Ll66iaztXranq6Xrv2GHSMCHib1ickXmndmznerR62UTzA/640?wx_fmt=png"></p><figure><figcaption>fig7</figcaption></figure><h4><span>2.4 缺失值NA</span></h4><p>与 <code>pheatmap</code> 类似，<code>ComplexHeatmap</code> 会将 <code>NA</code> 以一个特殊的颜色指代，<strong>默认为黑色</strong>。包含NA的矩阵也可以参与聚类。</p><blockquote><p>注意：NA的颜色并不会出现在图例中</p></blockquote><p>这里我们先看看使用 <code>pheatmap</code> 的结果图：</p><pre><code>mat_with_na = mat<br>mat_with_na[<span>1</span>, <span>1</span>] = <span>NA</span><br>pheatmap::pheatmap(mat_with_na)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic5KjAy5GkibP9meOL1UyB97GicHLRmF6nvMFEv2C3eaASJALENZHMoia6g/640?wx_fmt=png" data-type="png" data-w="900" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic5KjAy5GkibP9meOL1UyB97GicHLRmF6nvMFEv2C3eaASJALENZHMoia6g/640?wx_fmt=png"></p><figure><figcaption>fig8</figcaption></figure><p>可以看到 <code>pheatmp</code> 默认 <code>NA</code> 为灰色。</p><p>接下来我们看看 <code>ComplexHeatmap</code> ：</p><pre><code>Heatmap(mat_with_na, name = <span>"mat"</span>, na_col = <span>"black"</span>,<br>        column_title = <span>"a matrix with NA values"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicRbKe0w4XOWyL7BKUjxc9UxmG5jYDeKnXuSwsjMD6iaD7AahaSkiaxbcg/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicRbKe0w4XOWyL7BKUjxc9UxmG5jYDeKnXuSwsjMD6iaD7AahaSkiaxbcg/640?wx_fmt=png"></p><figure><figcaption>fig9</figcaption></figure><blockquote><p>其实和 <code>pheatmap</code> 一样，都可以通过 <code>na_col</code> 指定缺失值颜色</p></blockquote><h4><span>2.5 热图边框</span></h4><p><code>border</code> 参数可以设置热图边框的样式，这个参数的值可以是逻辑值（<strong>TRUE对应的是黑色</strong>）或颜色，也可以通过给 <code>border_gp</code> 参数一个 <code>grid::gpar()</code> 对象来设置：</p><pre><code>myh1 &lt;- Heatmap(mat, name = <span>"mat"</span>, border = <span>TRUE</span>, column_title = <span>"border = TRUE"</span>) <span># 默认为黑色</span><br>myh2 &lt;- Heatmap(mat, name = <span>"mat"</span>, border = <span>"red"</span>, column_title = <span>"border = \"red\""</span>) <span># 指定颜色为红色</span><br>myh3 &lt;- Heatmap(mat, name = <span>"mat"</span>, border_gp = gpar(col = <span>"green"</span>, lty = <span>2</span>, lwd = <span>2</span>), column_title = <span>"set heatmap borders"</span>) <span># lty=2表明画虚线</span><br><br><span># 图片拼接</span><br>draw(myh1+myh2+myh3)<br></code></pre><blockquote><p><code>gpar</code> 是R的基础画图设置：</p><ul><li><p><span>lty：Line type，1是实线， 2是虚线</span></p></li><li><p><span>lwd：Line width，线宽</span></p></li></ul></blockquote><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicqBlDlrtrIqIaib6keoSzx92oso9NRSeWRFhANeLNwsnYGSxxCxxB7uA/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicqBlDlrtrIqIaib6keoSzx92oso9NRSeWRFhANeLNwsnYGSxxCxxB7uA/640?wx_fmt=png"></p><figure><figcaption>fig10</figcaption></figure><h4><span>2.6 热图方块边框颜色</span></h4><p>对于热图中每个方块边框的颜色，我们可以用类似的方法去设置：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, rect_gp = gpar(col = <span>"white"</span>, lwd = <span>2</span>,lty = <span>2</span>), column_title = <span>"set cell borders"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYiczp4lxIEKbs4xCAtvNSScvL290pOMGH0qNZahiaeNQRL2RibOzKx3kiaSQ/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYiczp4lxIEKbs4xCAtvNSScvL290pOMGH0qNZahiaeNQRL2RibOzKx3kiaSQ/640?wx_fmt=png"></p><figure><figcaption>fig11</figcaption></figure><h4><span>2.7 标题背景</span></h4><p>这同样可以定义一个<code>gpar</code>对象返回给<code>column_title_gp</code>参数调整标题的背景：</p><pre><code><span>Heatmap</span>(mat, name = <span>"mat"</span>, column_title = <span>"I am a column title"</span>,<br>        <span>column_title_gp</span> = gpar(fill = <span>"red"</span>, col = <span>"white"</span>, border = <span>"blue"</span>))<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicMTda1J3ptXZZ1WKtPfaZh6vX7Rz8CZwn3xTSyvibRibialPQ8wiaXOEHWA/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicMTda1J3ptXZZ1WKtPfaZh6vX7Rz8CZwn3xTSyvibRibialPQ8wiaXOEHWA/640?wx_fmt=png"></p><figure><figcaption>fig16</figcaption></figure><p>可以发现标题的字与色块高度是一致的，间距过近，我们可以对 <code>ComplexHeatmap</code> 包自带的环境变量 <code>ht_opt</code> 进行修改设置：</p><pre><code>ht_opt$TITLE_PADDING = unit(c(<span>8.5</span>, <span>8.5</span>), <span>"points"</span>)<br>Heatmap(mat, name = <span>"mat"</span>, column_title = <span>"I am a column title"</span>,<br>        column_title_gp = gpar(fill = <span>"red"</span>, col = <span>"white"</span>, border = <span>"blue"</span>))<br><br><span>#重置ht_opt恢复默认状态:</span><br>ht_opt(RESET = <span>TRUE</span>)<br></code></pre><blockquote><p>具体 <code>ht_opt</code> 可以直接在命令行输入后查看，也可以输入 <code>?ht_opt</code> 查看相关设置方法。</p></blockquote><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic4MvpguoTWuYHXyic3Q94licyQ4nwibLxPTtpjY2HGOQ89jPk5dXibxMC6g/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic4MvpguoTWuYHXyic3Q94licyQ4nwibLxPTtpjY2HGOQ89jPk5dXibxMC6g/640?wx_fmt=png"></p><figure><figcaption>fig17</figcaption></figure><h3><span>3. 标题</span></h3><h4><span>3.1 标题大小位置及方向</span></h4><p><code>ComplexHeatmap</code> 的标题非常灵活，标题可以在行列、上下左右间来回切换。</p><p><strong>标题位置</strong>设置：</p><pre><code>myh1 &lt;- Heatmap(mat, name = <span>"mat"</span>, column_title = <span>"I am a column title"</span>, row_title = <span>"I am a row title"</span>)<br>myh2 &lt;- Heatmap(mat, name = <span>"mat"</span>, column_title = <span>"I am a column title at the bottom"</span>, column_title_side = <span>"bottom"</span>)<br><br><span># 图片拼接</span><br>draw(myh1+myh2)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicwO51EdnSu633S8bdNickUKDMj2KzalIGEbiagIWQgwUJtNEmxaxGeD7w/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicwO51EdnSu633S8bdNickUKDMj2KzalIGEbiagIWQgwUJtNEmxaxGeD7w/640?wx_fmt=png"></p><figure><figcaption>fig12</figcaption></figure><p><strong>标题大小</strong>设置：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, column_title = <span>"I am a big column title"</span>, column_title_gp = gpar(fontsize = <span>20</span>, fontface = <span>"bold"</span>))<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicG78HdWk0cog6gbwuhFN0bv9ibx5bym07PCAXtg69JvQGKcEljRmec4Q/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicG78HdWk0cog6gbwuhFN0bv9ibx5bym07PCAXtg69JvQGKcEljRmec4Q/640?wx_fmt=png"></p><figure><figcaption>fig13</figcaption></figure><p><strong>标题方向</strong>设置：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, column_title  = <span>"column title"</span>, column_title_rot = <span>90</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYichGxkZibYcT5vKUpsuaq5WJtrwfZfg9h6HhjfgbPrqGIbgAocMEPEDzQ/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYichGxkZibYcT5vKUpsuaq5WJtrwfZfg9h6HhjfgbPrqGIbgAocMEPEDzQ/640?wx_fmt=png"></p><figure><figcaption>fig14</figcaption></figure><h4><span>3.2 聚类标题</span></h4><p>将聚类的结果设置为标题，这个应该是 <code>pheatmap</code> 函数缺乏的功能之一：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, row_km = <span>2</span>, <span>#将所有行聚为两类</span><br>        row_title = <span>"Cluster%s"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicmyFvOcwxn0xWXJbIm9fSMqVmYBTa9NCFOMiccKGZvBHC8N32EPaORBg/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicmyFvOcwxn0xWXJbIm9fSMqVmYBTa9NCFOMiccKGZvBHC8N32EPaORBg/640?wx_fmt=png"></p><figure><figcaption>fig15</figcaption></figure><blockquote><p><code>row_km</code> 参数是通过对数据本身的聚类结果，根据我们想要分成多少类选择cutoff，并将cutoff在图中以虚线显示。并对分出的类进行标注。</p><p>当我们设置了 <code>row_km</code> 参数后，在其他参数中就可以以 <code>%s</code> 来指代具体分出类的数字。</p></blockquote><h4><span>3.3 公式标题</span></h4><p>这个应用应该相对比较少，但是做个简单记录，以免日后有需求：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, <br>        column_title = expression(hat(beta) == (X^t * X)^{-<span>1</span>} * X^t * y))<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicT4bOT4Drb3ibYUlxJvgWV0pUloXzkyPdgtGnNxNSpeDHNPQ2HDM0YFw/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicT4bOT4Drb3ibYUlxJvgWV0pUloXzkyPdgtGnNxNSpeDHNPQ2HDM0YFw/640?wx_fmt=png"></p><figure><figcaption>fig18</figcaption></figure><h4><span>3.4 各式各样标题格式</span></h4><p><code>ComplexHeatmap</code> 支持在标题中加入标记语言以调整各类格式，更多内容可以参考 <code>gridtext</code> 包，这里简单演示一下：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>,<br>    column_title = gt_render(<br>        paste0(<span>"Some &lt;span style='color:blue'&gt;blue text **in bold.**&lt;/span&gt;&lt;br&gt;"</span>,<br>            <span>"And *italics text.*&lt;br&gt;And some "</span>,<br>            <span>"&lt;span style='font-size:18pt; color:black'&gt;large&lt;/span&gt; text."</span>), <br>        r = unit(<span>2</span>, <span>"pt"</span>), <br>        padding = unit(c(<span>2</span>, <span>2</span>, <span>2</span>, <span>2</span>), <span>"pt"</span>)<br>    )<br>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicUJZGpta7PvGvN8oJ2EiaupicxsspduHwm78DicdpyBvvlx9Qgvsicw97jw/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicUJZGpta7PvGvN8oJ2EiaupicxsspduHwm78DicdpyBvvlx9Qgvsicw97jw/640?wx_fmt=png"></p><figure><figcaption>fig19</figcaption></figure><h3><span>4. 聚类</span></h3><p>聚类是诸多热图可视化项目的核心目的，<code>ComplexHeatmap</code> 的聚类风格比较多样，聚类参数（<code>cluster_rows</code> 和 <code>cluster_column</code>）能接受的参数值也比较多样。</p><h4><span>4.1 聚类开关</span></h4><p>默认是打开聚类，但是我们可以通过参数关闭聚类：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, cluster_rows = <span>FALSE</span>, cluster_columns = <span>FALSE</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic1rJvF1TL0DvgoXTwsY0ZSA8eKiaGcjZwNb4aMoqrFdQNxKX7SXhkRHA/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic1rJvF1TL0DvgoXTwsY0ZSA8eKiaGcjZwNb4aMoqrFdQNxKX7SXhkRHA/640?wx_fmt=png"></p><figure><figcaption>fig20</figcaption></figure><h4><span>4.2 聚类树位置及高度</span></h4><p>比 <code>pheatmap</code> 更加灵活的是，我们可以自由调整聚类树所在位置：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, row_dend_side = <span>"right"</span>, column_dend_side = <span>"bottom"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicc3vbVoRibhGNAibGVoMgeUrEpx5Xhib1SatUlTq8icibveiasqA6dlVu6tcQ/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicc3vbVoRibhGNAibGVoMgeUrEpx5Xhib1SatUlTq8icibveiasqA6dlVu6tcQ/640?wx_fmt=png"></p><figure><figcaption>fig21</figcaption></figure><p>我们甚至也可以修改聚类树的高度：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, column_dend_height = unit(<span>4</span>, <span>"cm"</span>), <br>        row_dend_width = unit(<span>4</span>, <span>"cm"</span>))<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic6mjAg70JD2xk1L1gQQlBK1SL1yBXEdeA1qGxrum3uWpOKbKw2OJKmA/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic6mjAg70JD2xk1L1gQQlBK1SL1yBXEdeA1qGxrum3uWpOKbKw2OJKmA/640?wx_fmt=png"></p><figure><figcaption>fig22</figcaption></figure><h4><span>4.3 层次聚类距离计算方式</span></h4><p>我们可以通过 <code>clustering_distance_rows</code> 和 <code>clustering_distance_columns</code> 分别来决定我们对行和列计算距离的方法。其中距离的计算主要将数据传递给 <code>dist()</code> 函数完成，可选方式参数值：</p><ul><li><p><code>euclidean</code>：默认选项</p></li><li><p><code>maximum</code></p></li><li><p><code>manhattan</code></p></li><li><p><code>canberra</code></p></li><li><p><code>binary</code></p></li><li><p><code>minkowski</code></p></li><li><p><code>pearson</code></p></li><li><p><code>spearman</code></p></li><li><p><code>kendall</code></p></li></ul><blockquote><p>注意：<code>dist()</code> 函数计算距离是所得的值是<strong>以 row 为标准</strong>的，也就是说算出来的距离是不同 row 之间的。</p></blockquote><pre><code>myh1 &lt;- Heatmap(mat, name = <span>"mat"</span>, clustering_distance_columns = <span>"pearson"</span>,<br>                column_title = <span>"Distance method (1 - pearson)"</span>)<br>myh2 &lt;- Heatmap(mat, name = <span>"mat"</span>, clustering_distance_columns = <span>"euclidean"</span>,<br>                column_title = <span>"Distance method euclidean"</span>)<br><br>draw(myh1+myh2)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicZxJjvSGmuibJBicryMWkNFlvm9xibWib3TZ9icpPMH0mwP1zAyjttCoRyHQ/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicZxJjvSGmuibJBicryMWkNFlvm9xibWib3TZ9icpPMH0mwP1zAyjttCoRyHQ/640?wx_fmt=png"></p><figure><figcaption>fig23</figcaption></figure><p>同时 <code>clustering_distance_rows</code> 和 <code>clustering_distance_columns</code> 参数还可以接受一个我们自定义的函数来计算距离，不过这个距离要以 <code>dist</code> 对象的格式呈递：</p><pre><code>myh1 &lt;- Heatmap(mat, name = <span>"mat"</span>, clustering_distance_columns = <span>function</span>(m) {as.dist((<span>1</span> - cor(m, method = <span>"pearson"</span>))/<span>2</span>)},<br>                column_title = <span>"Customed: (1 - pearson)"</span>)<br>myh2 &lt;- Heatmap(mat, name = <span>"mat"</span>, clustering_distance_columns = <span>function</span>(m) {dist(m, method = <span>"euclidean"</span>)},<br>                column_title = <span>"Customed: euclidean"</span>)<br><br>draw(myh1+myh2)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic0IafkM0ibDZkx0gtiaMJjEPORFItGTprwU3PeD9BoTaydqv6sR156BvA/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic0IafkM0ibDZkx0gtiaMJjEPORFItGTprwU3PeD9BoTaydqv6sR156BvA/640?wx_fmt=png"></p><figure><figcaption>fig24</figcaption></figure><h4><span>4.4 层次聚类方式</span></h4><p>在前文中，我们可以通过不同的方式对行/列的数据进行计算距离，有了距离后，我们还可以通过 <code>clustering_method_columns</code> 和 <code>clustering_method_rows</code> 参数指定行与列的层次聚类方式。其中聚类方式的计算主要将数据传递给 <code>hclust()</code> 函数完成，可选方式参数值：</p><ul><li><p><code>ward.D</code></p></li><li><p><code>ward.D2</code></p></li><li><p><code>single</code></p></li><li><p><code>complete</code>：默认方法</p></li><li><p><code>average</code></p></li><li><p><code>mcquitty</code></p></li><li><p><code>median</code></p></li><li><p><code>centroid</code></p></li></ul><p>可以看看不同聚类的结果：</p><pre><code>myh1 &lt;- Heatmap(mat, name = <span>"mat"</span>, clustering_method_columns = <span>"ward.D"</span>,<br>                column_title = <span>"Cluster by \"ward.D\""</span>)<br>myh2 &lt;- Heatmap(mat, name = <span>"mat"</span>, clustering_method_columns = <span>"ward.D2"</span>,<br>                column_title = <span>"Cluster by \"ward.D2\""</span>)<br>myh3 &lt;- Heatmap(mat, name = <span>"mat"</span>, clustering_method_columns = <span>"complete"</span>,<br>                column_title = <span>"Cluster by \"complete\""</span>)<br>myh4 &lt;- Heatmap(mat, name = <span>"mat"</span>, clustering_method_columns = <span>"single"</span>,<br>                column_title = <span>"Cluster by \"single\""</span>)<br>myh1 &lt;- as.ggplot(myh1)<br>myh2 &lt;- as.ggplot(myh2)<br>myh3 &lt;- as.ggplot(myh3)<br>myh4 &lt;- as.ggplot(myh4)<br><br>(myh1 + myh2) / (myh3 + myh4)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic1okMrrkr0IFCmLkOxuasic9gIBDudANXjDBQGCqHGRK8fO2rick26GWQ/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic1okMrrkr0IFCmLkOxuasic9gIBDudANXjDBQGCqHGRK8fO2rick26GWQ/640?wx_fmt=png"></p><figure><figcaption>fig25</figcaption></figure><p>当然了，作为极度灵活的R包，自然也是可以使用自定义的函数进行聚类。我们只需要将函数传递给 <code>cluster_rows</code> 或者 <code>cluster_columns</code> 即可：</p><pre><code>fh = <span>function</span>(x) {<br>  cluster::diana(x)<br>}<br>Heatmap(mat, name = <span>"mat"</span>, cluster_rows = fh, cluster_columns = fh,<br>        column_title = <span>"Cluster by customed function"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicADOuYwkXibrfPcEwraY5oaC6AsTgSpP2VMteHdJ2KC82Qb9ImNqkPPg/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicADOuYwkXibrfPcEwraY5oaC6AsTgSpP2VMteHdJ2KC82Qb9ImNqkPPg/640?wx_fmt=png"></p><figure><figcaption>fig27</figcaption></figure><h4><span>4.5 聚类树形态</span></h4><p>我们也可以对<strong>聚类树的颜色、线条宽度以及其他特性</strong>进行设置：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, row_dend_gp = gpar(col = <span>"red"</span>, lwd = <span>2</span>, lty = <span>2</span>),<br>        column_title = <span>"Cluster tree form"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicAROoe68ngb3Q5xcL53qQCl2Vce9p3glC1ynV00WIoLXfReCHOgfibUg/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicAROoe68ngb3Q5xcL53qQCl2Vce9p3glC1ynV00WIoLXfReCHOgfibUg/640?wx_fmt=png"></p><figure><figcaption>fig26</figcaption></figure><p>甚至来说，如果我们想要分出的不同cluster用不同的颜色表示也是可以的。下面演示一个对<strong>列</strong>根据聚类结果，对不同cluster用不同的颜色来绘制聚类树：</p><pre><code>myh1 &lt;- Heatmap(mat, name = <span>"mat"</span>,<br>                cluster_rows = <span>F</span>,<br>                clustering_distance_columns = <span>"euclidean"</span>, <br>                clustering_method_columns = <span>"complete"</span>,<br>                column_dend_gp = gpar(lwd = <span>3</span>), column_dend_height = unit(<span>3</span>, <span>"cm"</span>),<br>                column_title = <span>"Cluster by an uniform color"</span>)<br><br>row_dend &lt;- as.dendrogram(hclust(dist(mat, method = <span>"euclidean"</span>), method = <span>"complete"</span>))<br>row_dend &lt;- color_branches(row_dend, k = <span>2</span>) <br>myh2 &lt;- Heatmap(mat, name = <span>"mat"</span>, <br>                cluster_rows = <span>F</span>,<br>                cluster_columns = row_dend,<br>                column_dend_gp = gpar(lwd = <span>3</span>), column_dend_height = unit(<span>3</span>, <span>"cm"</span>),<br>                column_title = <span>"Cluster by various colors"</span>)<br><br><br>draw(myh1 + myh2)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicxqErLMnnGPiazjdCcYaoZKFHZvN1XmiaUVBkewSZf9ggt0rO4ta5tqng/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicxqErLMnnGPiazjdCcYaoZKFHZvN1XmiaUVBkewSZf9ggt0rO4ta5tqng/640?wx_fmt=png"></p><figure><figcaption>fig28</figcaption></figure><h3><span>5. 自定义排序</span></h3><h4><span>5.1 以字符串形式排序</span></h4><p>如果我们不想要聚类，而想让热图按照特定顺序进行展示，我们也可以通过 <code>row_order</code> 以及 <code>column_order</code> 实现：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, <br>        row_order = sort(rownames(mat)), <br>        column_order = sort(colnames(mat)),<br>        column_title = <span>"reorder matrix by row/column names"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYiczZYDx7Onw7tfuIibJMhBubMia4HQwK4sDuyiaicQTMwysBzobTfs2jX1cA/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYiczZYDx7Onw7tfuIibJMhBubMia4HQwK4sDuyiaicQTMwysBzobTfs2jX1cA/640?wx_fmt=png"></p><figure><figcaption>fig29</figcaption></figure><h4><span>5.2 以数值型形式排序</span></h4><p>当然了，我们也可以通过行数或者列数的数字进行设置：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, <br>        row_order = <span>1</span>:<span>6</span>, <br>        column_order = <span>6</span>:<span>1</span>,<br>        column_title = <span>"reorder matrix by the number of row/column"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicicbo7UGDtk5UYN8QY0mViaGicA50CdVjVWepmd6KvdUCwXTVo0vlkZQKA/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicicbo7UGDtk5UYN8QY0mViaGicA50CdVjVWepmd6KvdUCwXTVo0vlkZQKA/640?wx_fmt=png"></p><figure><figcaption>fig30</figcaption></figure><h3><span>6. 拆分热图</span></h3><h4><span>6.1 按照聚类结果拆分热图</span></h4><p>我们可以使用参数 <code>km</code>，<code>row_km</code> 以及 <code>column_km</code> 参数来依据 K-means clustering 的结果对热图进行拆分，同时，当我们对热图进行拆分后，其会自动添加一条虚线告诉我们拆分为特定类数时选择的cutoff在哪，但是我们也可以使用 <code>show_parent_dend_line</code> 来关闭这个虚线的显示：</p><pre><code>myh1 &lt;- Heatmap(mat, name = <span>"mat"</span>, row_km = <span>3</span>)<br>myh2 &lt;- Heatmap(mat, name = <span>"mat"</span>, column_km = <span>3</span>)<br>myh3 &lt;- Heatmap(mat, name = <span>"mat"</span>, row_km = <span>3</span>, column_km = <span>3</span>)<br>myh4 &lt;- Heatmap(mat, name = <span>"mat"</span>, row_km = <span>3</span>, column_km = <span>3</span>, show_parent_dend_line = <span>FALSE</span>)    <br><br>myh1 &lt;- as.ggplot(myh1)<br>myh2 &lt;- as.ggplot(myh2)<br>myh3 &lt;- as.ggplot(myh3)<br>myh4 &lt;- as.ggplot(myh4)<br><br>(myh1 + myh2) / (myh3 + myh4)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic9rL5EoYhDvuibMdbkQughoLZ4MAOwX7eIUjw2ZUGjeQic3neL7icjuzlA/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic9rL5EoYhDvuibMdbkQughoLZ4MAOwX7eIUjw2ZUGjeQic3neL7icjuzlA/640?wx_fmt=png"></p><figure><figcaption>fig31</figcaption></figure><blockquote><p>注意：由于 <code>k-means</code> 聚类每次结果可能会不相同，因为这和最初指定的质心有关。所以为了保证每次结果可以重复出来，我们有2种方案来解决这个问题：</p><ol><li><p>使用 <code>row_km_repeats</code> 或者 <code>column_km_repeats</code> 参数，将其设置为100，意思是重复对行/列进行聚类，一共聚类100次，使聚类结果最终收敛。</p></li><li><p><span>设置随机数种子</span></p></li></ol><p>个人更加喜欢使用方法2，大家自行选择即可。</p></blockquote><h4><span>6.2 通过向量分割</span></h4><p>我们也可以指定一组向量，让热图根据向量的模式进行分割：</p><pre><code>row_vector &lt;- rep(c(<span>"A"</span>, <span>"B"</span>), <span>3</span>)<br>row_vector<br><span>## [1] "A" "B" "A" "B" "A" "B"</span><br><br>col_vector &lt;- rep(c(<span>"A"</span>, <span>"B"</span>), each = <span>3</span>)<br>col_vector<br><span>## [1] "A" "A" "A" "B" "B" "B"</span><br><br>Heatmap(mat, name = <span>"mat"</span>, <br>        row_split = row_vector, column_split = col_vector)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicDB0H3qEOtQJOh7gAYKEgTkUGEgGbCjLfZhRv4Q5MfoRbMgQHu978icw/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicDB0H3qEOtQJOh7gAYKEgTkUGEgGbCjLfZhRv4Q5MfoRbMgQHu978icw/640?wx_fmt=png"></p><figure><figcaption>fig32</figcaption></figure><p>可以看到，在这种情况下，热图的确按照我们给的向量进行了分割，但是，<strong>分割后每个部分的热图仍然会在内部聚类</strong>。</p><h4><span>6.3 通过数据框分割</span></h4><p>所谓按照 “数据框” 进行分割，其实是<strong>将数据框的结果合并在一起后，将其转为向量进行处理</strong>的：</p><pre><code>split_dat &lt;- data.frame(type1 = rep(c(<span>"A"</span>, <span>"B"</span>), <span>3</span>),<br>                        type2 = rep(c(<span>"A"</span>, <span>"B"</span>), each = <span>3</span>))<br>split_dat<br><span>##   type1 type2</span><br><span>## 1     A     A</span><br><span>## 2     B     A</span><br><span>## 3     A     A</span><br><span>## 4     B     B</span><br><span>## 5     A     B</span><br><span>## 6     B     B</span><br><br>Heatmap(mat, name = <span>"mat"</span>, <br>        row_split = split_dat)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicoIlHtQHsR3Y340mGagD8uXhwwDYJxhPHic3P4RfHkKVjyTDc2Enp3IQ/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicoIlHtQHsR3Y340mGagD8uXhwwDYJxhPHic3P4RfHkKVjyTDc2Enp3IQ/640?wx_fmt=png"></p><figure><figcaption>fig33</figcaption></figure><h4><span>6.4 分割间隔的大小</span></h4><p>热图分割后，我们也可以调整分割间隔的大小。具体则是分别使用 <code>row_gap</code> 和 <code>column_gap</code> 进行调整：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, row_km = <span>3</span>, row_gap = unit(<span>5</span>, <span>"mm"</span>))<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYickjFN3swPM2HV0WB6LICF8p7iaD3zKw85rW214ibDc8pTR6VKp2cQNW1w/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYickjFN3swPM2HV0WB6LICF8p7iaD3zKw85rW214ibDc8pTR6VKp2cQNW1w/640?wx_fmt=png"></p><figure><figcaption>fig34</figcaption></figure><p>甚至我们还可以对每个分割的大小都做具体的规定：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, row_km = <span>3</span>, row_gap = unit(c(<span>2</span>, <span>4</span>), <span>"mm"</span>))<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicMmRnw9RkmNDrOKrelwBDWiajN4PU29q62vgrbulcfduDbGibBcScNCyA/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicMmRnw9RkmNDrOKrelwBDWiajN4PU29q62vgrbulcfduDbGibBcScNCyA/640?wx_fmt=png"></p><figure><figcaption>fig35</figcaption></figure><h5><span>6.4.1 分割间隔的美化</span></h5><p>这里简单拓展一下美化图片的方案：</p><ol><li><p><span>分隔加上边界线会更加的整齐：</span></p></li></ol><pre><code>Heatmap(mat, name = <span>"mat"</span>, row_km = <span>2</span>, column_km = <span>3</span>, border = <span>TRUE</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic10Dcv8J6DSHPp0icq0dtBiamzHib9ibzqWuSxUpRtD6BzPteoTP65tCEtQ/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic10Dcv8J6DSHPp0icq0dtBiamzHib9ibzqWuSxUpRtD6BzPteoTP65tCEtQ/640?wx_fmt=png"></p><figure><figcaption>fig36</figcaption></figure><ol start="2"><li><p><span>仅靠边界线分隔也比较美观：</span></p></li></ol><pre><code>Heatmap(mat, name = <span>"mat"</span>, row_km = <span>2</span>, column_km = <span>3</span>, <br>        row_gap = unit(<span>0</span>, <span>"mm"</span>), column_gap = unit(<span>0</span>, <span>"mm"</span>), border = <span>TRUE</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicp8hR2jveYkj7qTdvyTagJsLbep5c9GwzdYDEEaZKVsudzhSG2KnwYg/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicp8hR2jveYkj7qTdvyTagJsLbep5c9GwzdYDEEaZKVsudzhSG2KnwYg/640?wx_fmt=png"></p><figure><figcaption>fig37</figcaption></figure><h4><span>6.5 分割后排序</span></h4><p>分割后的热图，每个部分的顺序我们也是可以自定义的。但是这里需要注意，正如前面提到的，<strong>分割后每个部分的热图仍然会在内部聚类</strong>。</p><p>所以为了避免内部聚类导致我们的自定义顺序失效，我们需要<strong>将内部聚类的功能给关闭</strong>。</p><pre><code>row_vector &lt;- rep(c(<span>"A"</span>, <span>"B"</span>, <span>"C"</span>), each = <span>2</span>)<br>col_vector &lt;- rep(c(<span>"D"</span>, <span>"E"</span>, <span>"F"</span>), each = <span>2</span>)<br>myh1 &lt;- Heatmap(mat, name = <span>"mat"</span>, <br>        row_split = row_vector, column_split = col_vector)<br><br>row_vector &lt;- factor(rep(c(<span>"A"</span>, <span>"B"</span>, <span>"C"</span>), each = <span>2</span>), levels = c(<span>"B"</span>, <span>"C"</span>, <span>"A"</span>))<br>col_vector &lt;- factor(rep(c(<span>"D"</span>, <span>"E"</span>, <span>"F"</span>), each = <span>2</span>), levels = c(<span>"E"</span>, <span>"F"</span>, <span>"D"</span>))<br>myh2 &lt;- Heatmap(mat, name = <span>"mat"</span>, <br>        row_split = row_vector, column_split = col_vector,<br>        cluster_row_slices = <span>FALSE</span>, cluster_column_slices = <span>FALSE</span>)<br><br>myh3 &lt;- Heatmap(mat, name = <span>"mat"</span>, <br>        row_split = row_vector, column_split = col_vector)<br><br>myh1 &lt;- as.ggplot(myh1)<br>myh2 &lt;- as.ggplot(myh2)<br>myh3 &lt;- as.ggplot(myh3)<br><br>(myh1 + myh2) / myh3<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicLCC4mHcM5K18YenibYMiceo2AM8trGU0tQSv0lFcGEEhw9g8YzbXEHRg/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicLCC4mHcM5K18YenibYMiceo2AM8trGU0tQSv0lFcGEEhw9g8YzbXEHRg/640?wx_fmt=png"></p><figure><figcaption>fig38</figcaption></figure><p>可以看到，左上角热图的分割完全是随机。</p><p>而在我们利用因子指定分割后的顺序后，同时关闭分割后内部聚类，结果就如我们所想的排序方式了。</p><p>但是如果我们没有关闭分割后内部聚类，结果就和我们所想的排序方式有差别了。</p><h4><span>6.6 热图拆分slice标题设定</span></h4><p>对于热图拆分后的slice，默认的标题是数字：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, row_km = <span>2</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicLibRy9ibymploqZEWItJq2rFia6cCjmJRGr9hrg4dTzy3yjE26DsFsOjg/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicLibRy9ibymploqZEWItJq2rFia6cCjmJRGr9hrg4dTzy3yjE26DsFsOjg/640?wx_fmt=png"></p><figure><figcaption>fig39</figcaption></figure><p>可以看到我们设置分成2类，这时每类的名称即为对应的数字。</p><p>但是我们可以对这个标题进行一定的修改。在命令中，我们可以用 <code>%s</code> 指代具体的cluster数字：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, row_km = <span>2</span>, row_title = <span>"cluster_%s"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYictWRanjcsd4ibRTAynVjmic07KeBzQwheaHn0VlpLBOmfYf7FAp3FUmpg/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYictWRanjcsd4ibRTAynVjmic07KeBzQwheaHn0VlpLBOmfYf7FAp3FUmpg/640?wx_fmt=png"></p><figure><figcaption>fig40</figcaption></figure><p>不过以上是最简单的指定方法，当我们用数据框来拆分热图时，我们此时对于标题的设置就可以稍稍复杂一点，因为此时有至少2类分类结果：</p><pre><code>split &lt;- data.frame(type1 = rep(c(<span>"A"</span>, <span>"B"</span>), <span>3</span>),<br>                    type2 = rep(c(<span>"A"</span>, <span>"B"</span>), each = <span>3</span>))<br>split<br><span>##   type1 type2</span><br><span>## 1     A     A</span><br><span>## 2     B     A</span><br><span>## 3     A     A</span><br><span>## 4     B     B</span><br><span>## 5     A     B</span><br><span>## 6     B     B</span><br><br>Heatmap(mat, name = <span>"mat"</span>, row_split = split, row_title = <span>"1.%s - 2.%s"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYickyFECMCavDsOeiaxuCM4E2Ikb6SjXejngezH1NC2LlTCRHibEnO6P4Ew/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYickyFECMCavDsOeiaxuCM4E2Ikb6SjXejngezH1NC2LlTCRHibEnO6P4Ew/640?wx_fmt=png"></p><figure><figcaption>fig41</figcaption></figure><p>当然了，作为最灵活的热图，这些标题自然也是可以自定义设置的：</p><pre><code>myh1 &lt;- Heatmap(mat, name = <span>"mat"</span>, column_split = split)<br>myh2 &lt;- Heatmap(mat, name = <span>"mat"</span>, column_split = split, <br>                column_title = c(<span>"top_slice"</span>, <span>"middle_top_slice"</span>, <span>"middle_bottom_slice"</span>, <span>"bottom_slice"</span>))<br>draw(myh1 + myh2)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicMZhhUKBxrhZvrzVHVd60fW2thy20WwdL0glUjNT6kZeYjoibsX2CFGw/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicMZhhUKBxrhZvrzVHVd60fW2thy20WwdL0glUjNT6kZeYjoibsX2CFGw/640?wx_fmt=png"></p><figure><figcaption>fig42</figcaption></figure><blockquote><p>这里需要注意的一点是：<code>column_title</code> 参数指定标题时，好像无法指定具体的对应关系，即我们无法指定 <code>B,B</code> 对应 <code>top_slice</code>。我们需要先画出原图，然后按照对应关系进行绘制。</p><p>当然了，我们也可以先提取聚类结果，然后直接根据聚类结果顺序对title进行赋值。</p><p>只是这里不想过多折腾了，知道怎么做，后续如果有需求再做详细探索即可。</p></blockquote><h4><span>6.7 热图拆分slice标题和总标题共存</span></h4><p>我们使用函数画热图时，当我们将热图进行分割并对分割后的cluster赋予名字后，此时就无法再对总标题进行设置。因为参数只有一个，<code>row_title</code> 或者 <code>column_title</code>，那么此时我们可以采用下述方法解决该问题：</p><pre><code>myh = Heatmap(mat, name = <span>"mat"</span>, row_km = <span>3</span>, row_title = <span>"Cluster_%s"</span>)<br>draw(myh, row_title = <span>"I am a row title"</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic5kkNLeHpN2Y1xPoY1WnMf4ib6aVjZ9G7MHibOFjCCsZ4iaIAdp35KZOhA/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYic5kkNLeHpN2Y1xPoY1WnMf4ib6aVjZ9G7MHibOFjCCsZ4iaIAdp35KZOhA/640?wx_fmt=png"></p><figure><figcaption>fig43</figcaption></figure><h3><span>7. 标题的图形修饰</span></h3><p>通常情况下标题周围没有多余空间，可以如是设定：</p><pre><code>Heatmap(mat, name = <span>"mat"</span>, <br>        row_km = <span>2</span>, <br>        row_title_gp = gpar(col = c(<span>"red"</span>, <span>"blue"</span>), fill = c(<span>"orange"</span>, <span>"purple"</span>), font = <span>1</span>:<span>2</span>, fontsize = c(<span>8</span>,<span>10</span>)),<br>        row_names_gp = gpar(col = c(<span>"green"</span>, <span>"orange"</span>), fontsize = c(<span>10</span>, <span>14</span>)),<br>        column_km = <span>3</span>, <br>        column_title_gp = gpar(fill = c(<span>"red"</span>, <span>"blue"</span>, <span>"green"</span>), font = <span>1</span>:<span>3</span>),<span>#是不是有点熟悉的味道了，我们后面会出教程用ComplexHeatmap绘制单细胞测序中的热图</span><br>        column_names_gp = gpar(col = c(<span>"green"</span>, <span>"orange"</span>, <span>"purple"</span>), fontsize = c(<span>10</span>, <span>14</span>, <span>8</span>))<br>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicdXtLc1SXhoJpJ3qaicSAEUHqLoiad2VicFcgH5AILrB9ULsDUCdTSeD2Q/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicdXtLc1SXhoJpJ3qaicSAEUHqLoiad2VicFcgH5AILrB9ULsDUCdTSeD2Q/640?wx_fmt=png"></p><figure><figcaption>fig44</figcaption></figure><p>不过这里还是出现了前面提到的问题：数字似乎太靠上了，没有居中。我们可以稍作调整：</p><pre><code>ht_opt$TITLE_PADDING = unit(c(<span>4</span>, <span>4</span>), <span>"points"</span>)<br>Heatmap(mat, name = <span>"mat"</span>, <br>        row_km = <span>2</span>, <br>        row_title_gp = gpar(col = c(<span>"red"</span>, <span>"blue"</span>), fill = c(<span>"orange"</span>, <span>"purple"</span>), font = <span>1</span>:<span>2</span>, fontsize = c(<span>8</span>,<span>10</span>)),<br>        row_names_gp = gpar(col = c(<span>"green"</span>, <span>"orange"</span>), fontsize = c(<span>10</span>, <span>14</span>)),<br>        column_km = <span>3</span>, <br>        column_title_gp = gpar(fill = c(<span>"red"</span>, <span>"blue"</span>, <span>"green"</span>), font = <span>1</span>:<span>3</span>),<br>        column_names_gp = gpar(col = c(<span>"green"</span>, <span>"orange"</span>, <span>"purple"</span>), fontsize = c(<span>10</span>, <span>14</span>, <span>8</span>))<br>)<br>ht_opt(RESET = <span>TRUE</span>)<br></code></pre><p><img data-galleryid="" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicGsjAA9n7K7urIPpc1nyUszQU9KySXAheCmnl91tia5cZyMhPSrZcCVw/640?wx_fmt=png" data-type="png" data-w="432" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJplvicicCPrg8mWssfCW1niaYicGsjAA9n7K7urIPpc1nyUszQU9KySXAheCmnl91tia5cZyMhPSrZcCVw/640?wx_fmt=png"></p><figure><figcaption>fig45</figcaption></figure><h3><span>8. 结果保存——平衡文件大小与清晰度</span></h3><p>在R中我一般默认都是保存pdf，因为这种格式保存的是<strong>矢量图</strong>，放大也不会失真。</p><p>但是由于 <code>ComplexHeatmap</code> 一般用于大型或多个矩阵的处理，因此输出的文件通常非常之大。</p><p>这时我们可以用 <strong>光栅化</strong>（Rasterization） 来解决这一问题。所谓光栅化，其实就是把矢量图变成位图，这样就可以显著减少文件大小了。</p><p>在 <code>ComplexHeatmap</code> 中，当热图行/列数超过2000时则会自动将<strong>热图的body区域</strong>光栅化，这样就可以解决图片过大的问题。</p><blockquote><p>其实在 linux 中 <code>Deeptools</code> 的 <code>plotHeatmap</code> 工具也是用的相同的策略。</p></blockquote><pre><code><span># 光栅化</span><br>Heatmap(<span>...</span>, use_raster = <span>TRUE</span>)<br><span># 使用什么格式进行光栅化，一般来说，png格式所占用空间最小</span><br>Heatmap(<span>...</span>, use_raster = <span>TRUE</span>, raster_device = c(<span>"png"</span>, <span>"jpeg"</span>, <span>"tiff"</span>, <span>"CairoPNG"</span>, <span>"CairoJPEG"</span>, <span>"CairoTIFF"</span>, <span>"agg_png"</span>))<br><span># 光栅化后图片质量，数值为大于1的数字</span><br>Heatmap(<span>...</span>, use_raster = <span>TRUE</span>, raster_quality = <span>5</span>)<br><span># resize调整：</span><br>Heatmap(<span>...</span>, use_raster = <span>TRUE</span>, raster_resize_mat = <span>TRUE</span>)<br><span># resize最大化</span><br>Heatmap(<span>...</span>, use_raster = <span>TRUE</span>, raster_resize_mat = max)<br></code></pre><h3><span>后记</span></h3><p>内容真的很多了，所以其他一些小细节就下次再说了~<span></span></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/_I5zTsybYVxgyUb2K95mpA",target="_blank" rel="noopener noreferrer">原文链接</a>
