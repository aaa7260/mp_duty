---
title: "做通路富集分析的时候究竟输入多少个基因？"
date: 2023-04-04T14:32:31Z
draft: ["false"]
tags: [
  "fetched",
  "果子学生信"
]
categories: ["Acdemic"]
---
做通路富集分析的时候究竟输入多少个基因？ by 果子学生信
------
<div><section data-mpa-powered-by="yiban.io"><p>我在做差异基因富集分析的时候常有两个疑问？<br>第一，上调基因和下调基因，需要分开做么，分开做有优势么？<br>第二，富集分析输入的差异基因究竟是多少个？</p><p>关于第一个问题，我们已经解决了<br><a href="https://mp.weixin.qq.com/s?__biz=MzIyMzA2MTcwMg==&amp;mid=2650736390&amp;idx=1&amp;sn=5bf3f0d87a7ac0ac0e913a870c015bee&amp;scene=21#wechat_redirect" data-linktype="2">把compareCluster富集后缺失的组显示出来</a><br>现在来尝试解决第二个问题，我们的方法还是试。<br>我们将会用不同数量的基因来做富集分析，然后把结果可视化，看看有什么区别，还是会用到神奇函数<code>compareCluster</code></p><h4><span>启发是Y叔的例子</span></h4><p>在Y叔最新发表的clusterProfiler的文章中，Figure4十分亮眼<br></p><figure><img data-ratio="0.5722831505483549" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOCIBVLXS3184mmWm329bvK4vFgHicGxbFJCjbU23pntDfNK5BWibUnhmw/640?wx_fmt=png" data-type="png" data-w="1003" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOCIBVLXS3184mmWm329bvK4vFgHicGxbFJCjbU23pntDfNK5BWibUnhmw/640?wx_fmt=png"></figure><p>他优秀的展示了一个细胞在不同时间点，接受两种不同药物处理后下游通路的变化。<br>我们能看到有一些通路是药物特异的，有一些下游通路随着时间推移是药物共有的。<br>这样的图，十分容易俘获基础科研人员的心，我觉得是生信和基础结合的典范。</p><p>原文中提供了该图分析的代码，并且随着文章一起公布了。</p><pre><code><span>data</span>(DE_GSE8057)<br>xx &lt;- compareCluster(Gene∼time+treatment, <br><span>data</span>=DE_GSE8057, <span><span>fun</span> = enricher,</span><br>TERM2GENE=wp[,c(<span>"wpid"</span>, <span>"gene"</span>)], <br>TERM2NAME=wp[,c(<span>"wpid"</span>, <span>"name"</span>)])<br></code></pre><p>接下来我们就来复现这个图，一起了解下他需要的数据格式。</p><pre><code>library(clusterProfiler)<br><span>load</span>(<span>file</span> = <span>"data/DE_GSE8057.rda"</span>)<br><span>## downloaded from https://wikipathways-data.wmcloud.org/current/gmt/</span><br>gmt &lt;- <span>'data/wikipathways-20210710-gmt-Homo_sapiens.gmt'</span><br>wp &lt;- read.gmt.wp(gmt)<br></code></pre><p>先看DE_GSE8057这个数据<br>这个数据是个数据框，有三列，分别是Gene，time，treatment<br>应该原始数据中有2个药物6个时间点，总共12组数据，通过跟0h比较可以得到每一组的差异基因。<br>(具体的需要看这个数据的原文)<br></p><figure><img data-ratio="1.1288343558282208" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOy3S2SgUWJ1I5MMHQSGlnotWXHiaVfmlB2bico3W9yE0dsWxrZ3ohslvQ/640?wx_fmt=png" data-type="png" data-w="489" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOy3S2SgUWJ1I5MMHQSGlnotWXHiaVfmlB2bico3W9yE0dsWxrZ3ohslvQ/640?wx_fmt=png"></figure><p>另外一个数据就是基因集，这里下载的是Wikipathways的数据<br>这个数据有5列<br></p><figure><img data-ratio="0.5363636363636364" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFO0snDz9cbN8jRdib2Tfq1NDAZvdlFRcJYRvwnwEt4Y1vWNc7HiaaVjs5g/640?wx_fmt=png" data-type="png" data-w="1320" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFO0snDz9cbN8jRdib2Tfq1NDAZvdlFRcJYRvwnwEt4Y1vWNc7HiaaVjs5g/640?wx_fmt=png"></figure><p>接下来就是使用<code>compareCluster</code>来进行富集分析<br>总共就三类参数<br>第一是geneClusters和data，是输入的数据以及分组信息<br>Gene肯定是必要的，此外需要用<code>~</code>指示分组信息，用<code>+</code>好来连接多个分组信息<br>第二是<code>enricher</code>这个通用的ORA富集函数<br>第三是<code>enricher</code>是其他参数，就是基因集的信息</p><pre><code>xx &lt;- compareCluster(geneClusters=Gene~time+treatment, <br>                     <span>data</span>=DE_GSE8057, <br>                     <span><span>fun</span> = enricher,</span><br>                     TERM2GENE=wp[,c(<span>"wpid"</span>, <span>"gene"</span>)], <br>                     TERM2NAME=wp[,c(<span>"wpid"</span>, <span>"name"</span>)])<br></code></pre><p>做完了就是直接画图</p><pre><code><span>dotplot</span>(xx, x=<span>"time"</span>)<br></code></pre><figure><img data-ratio="0.776231884057971" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOT8FjniaCsEyiaD2RnFH1w7BtbDRCtpyW6WZ56P4SstbZwvmJFgegoJAA/640?wx_fmt=png" data-type="png" data-w="1725" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOT8FjniaCsEyiaD2RnFH1w7BtbDRCtpyW6WZ56P4SstbZwvmJFgegoJAA/640?wx_fmt=png"></figure><p>但是我们发现，横坐标的顺序，不是我们希望的，这里面可以通过调整因子的levels水平来控制<br><a href="https://mp.weixin.qq.com/s?__biz=MzIyMzA2MTcwMg==&amp;mid=2650736390&amp;idx=1&amp;sn=5bf3f0d87a7ac0ac0e913a870c015bee&amp;scene=21#wechat_redirect" data-linktype="2">跟之前显示缺失的组那里是一种手法</a><br>调整后就可以作图了</p><pre><code>## 富集分析<br>xx &lt;- compareCluster(geneClusters=Gene~time+treatment, <br>                     <span>data</span>=DE_GSE8057, <br>                     <span><span>fun</span> = enricher,</span><br>                     TERM2GENE=wp[,c(<span>"wpid"</span>, <span>"gene"</span>)], <br>                     TERM2NAME=wp[,c(<span>"wpid"</span>, <span>"name"</span>)])<br>## 调整因子水平<br><span>xx@</span>compareClusterResult$time = factor(<span>xx@</span>compareClusterResult$time,<br>                                      levels =c(<span>"0h"</span>,<span>"2h"</span>,<span>"6h"</span>,<span>"24h"</span>))<br>## 作图<br>dotplot(xx, x=<span>"time"</span>)<br></code></pre><p>现在这个顺序就是正确舒适的。<br></p><figure><img data-ratio="0.7715116279069767" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOPg87QJy8GwVc26DOMW0vIHTSeAYvBcWCC5p5TXscn8oRD3icia9wtiaqA/640?wx_fmt=png" data-type="png" data-w="1720" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOPg87QJy8GwVc26DOMW0vIHTSeAYvBcWCC5p5TXscn8oRD3icia9wtiaqA/640?wx_fmt=png"></figure><p>此时已经能够展示各个时间点特异的通路了，但是我们还可以用分面，把结果分成两个药物来展示<br>代码也很简单</p><pre><code>dotplot(xx, x=<span>"time"</span>) + ggplot2::facet_grid(~treatment)<br></code></pre><p>只不过效果出众，原文的图就出现了。<br></p><figure><img data-ratio="0.7753201396973225" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOCPBLia192aDwps3LjDYM81SfYMHZeBXh3Ybl7vAM4OL869ibDnBDC8ZA/640?wx_fmt=png" data-type="png" data-w="1718" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOCPBLia192aDwps3LjDYM81SfYMHZeBXh3Ybl7vAM4OL869ibDnBDC8ZA/640?wx_fmt=png"></figure><p>如果我们想要分开的是时间来展示，那也可以的，<br>把代码稍微调整一下就行。</p><pre><code>dotplot(xx, x=<span>"treatment"</span>) + ggplot2::facet_grid(~time)+<br>  scale_x_discrete(guide = guide_axis(angle = <span>45</span>)) <br></code></pre><figure><img data-ratio="0.7663389242336611" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFO53oXWjCxHhodQcbVhibVOCMSvx8F8zFqyPrY0mAxtLCQxsHQYMczjIg/640?wx_fmt=png" data-type="png" data-w="1729" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFO53oXWjCxHhodQcbVhibVOCMSvx8F8zFqyPrY0mAxtLCQxsHQYMczjIg/640?wx_fmt=png"></figure><p>如果你注意到Y轴的那些term名称有重叠，那么可以通过增加<code>label_format</code>参数来在一行显示<br>这个自动折叠功能很有用，尤其是wikipathways这样的条目名称很长的基因集</p><pre><code>dotplot(xx, x=<span>"time"</span>,label_format = <span>60</span>) + ggplot2::facet_grid(~treatment)<br></code></pre><figure><img data-ratio="0.7597477064220184" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOo1TiaewElmGxO7duehfhp0B5uxfaNaiciaHEpDA07G8GCcvNiaKTrBCmeQ/640?wx_fmt=png" data-type="png" data-w="1744" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOo1TiaewElmGxO7duehfhp0B5uxfaNaiciaHEpDA07G8GCcvNiaKTrBCmeQ/640?wx_fmt=png"></figure><h4><span>富集分析放入多少基因合适？</span></h4><p>在搞清楚以上作图所需要的数据后，我们就可以来操作了。<br>我们只要输入不同数目的基因来做富集分析，并且把结果放在一起展示就行。<br>跟之前一样，把差异分析的结果加载进来，区分上调和下调基因，不使用LogFC筛选</p><pre><code>rm(<span>list</span> = ls())<br>library(clusterProfiler)<br>library(dplyr)<br>library(tibble)<br>load(file = <span>"output/DEseq2_ESR1_Diff.Rdata"</span>)<br>diffgene &lt;- res %&gt;% <br>  filter(gene !=<span>""</span>) %&gt;% <br>  filter(adj.P.Val &lt; <span>0.05</span>) %&gt;% <br>  arrange(desc(logFC))<br><br>upgeneall &lt;- diffgene$gene[diffgene$logFC&gt;<span>0</span>]<br>dngeneall &lt;- diffgene$gene[diffgene$logFC&lt;<span>0</span>]<br></code></pre><p>为了简化操作，先写一个函数，可以输入需要的基因数目，然后返回一个准备好的数据</p><pre><code>generate_genes &lt;- <span><span>function</span><span>(number)</span></span>{<br>  <span>## 选取一定数目上调基因</span><br>  upgene = head(upgeneall,number)<br>  <span>## 选取一定数目下调基因</span><br>  dngene = tail(dngeneall,number)<br>  <span>## 输入文件</span><br>  gcSample = data.frame(group= c(rep(<span>"up"</span>,number),rep(<span>"down"</span>,number),rep(<span>"all"</span>,number*<span>2</span>)),<br>                        genes = c(upgene,dngene,c(upgene,dngene)),<br>                        num = number)<br>  <span>return</span>(gcSample)<br>}<br></code></pre><p>测试一下函数是够能够运行</p><pre><code><span>test</span> &lt;- generate_genes(500)<br></code></pre><p>会返回一个数据库，也有三列，group里面是up，down 和all<br></p><figure><img data-ratio="0.9226190476190477" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOLq2n5Tu5ibAdfE3g4BglCvNluxs2GVjAxTwO8b1bhy2d6jSUaicZFqeQ/640?wx_fmt=png" data-type="png" data-w="504" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOLq2n5Tu5ibAdfE3g4BglCvNluxs2GVjAxTwO8b1bhy2d6jSUaicZFqeQ/640?wx_fmt=png"></figure><p>接下来批量产生不同数目的数据,此处就以500,1000，1500, 2000为例</p><pre><code>mydata &lt;- <span>do</span>.<span>call</span>(<span>"rbind"</span>,lapply(c(<span>500</span>,<span>1000</span>,<span>1500</span>,<span>2000</span>),generate_genes))<br></code></pre><p>正式富集分析,代码也很好理解啦</p><pre><code>h_df &lt;- read.gmt(<span>"resource/h.all.v2022.1.Hs.symbols.gmt"</span>)<br>xx &lt;- compareCluster(genes~group+num, <br>                     <span>data</span>=mydata, <br>                     <span><span>fun</span>="enricher",</span><br>                     TERM2GENE = h_df)<br></code></pre><p>为了使得最后的结果有正确的顺序，我们再次使用因子调整一下顺序</p><pre><code>xx@compareClusterResult$num &lt;- factor(xx@compareClusterResult$num,<br>                                      levels = c(<span>"500"</span>,<span>"1000"</span>,<span>"1500"</span>,<span>"2000"</span>))<br>xx@compareClusterResult$group &lt;- factor(xx@compareClusterResult$group,<br>                                      levels = c(<span>"up"</span>,<span>"down"</span>,<span>"all"</span>))<br></code></pre><p>激动人心的时刻来了，作图代码类似，增加了一些参数</p><pre><code>dotplot(xx,<br>        showCategory = <span>30</span>,<br>        label_format = <span>60</span>,<br>        font.size = <span>10</span>,<br>        x = <span>"group"</span>)+ <br>  facet_grid(~<span>num</span>)<br></code></pre><p>我们能够看到，有一些通路，比如雌激素相关的通路，无论你输入多少个基因，他都是能富集到的。<br>这些通路的可靠性很高，并且我们引入了上调基因和下调基因，还能看出来，这两个通路是被抑制的。<br>而这个与该数据的背景十分吻合，因为他就是ESR1敲减的数据。<br></p><figure><img data-ratio="0.6871069182389937" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOFiclcBcerTg3K7X3dsBApQZTjliaeqGSElklK2ccymT3wXX9gksoD1GQ/640?wx_fmt=png" data-type="png" data-w="1908" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOFiclcBcerTg3K7X3dsBApQZTjliaeqGSElklK2ccymT3wXX9gksoD1GQ/640?wx_fmt=png"></figure><p>同时我们能看到，基因的数目在1000个往后，通路多了起来，有些通路无论基因如何增加<br>都很坚挺的存在，他们也应该是我们关注的通路。这个例子说，你应该尝试用不同数量的基因去做分析。<br>尝试，并不花钱，但是可以让你更加了解这个数据。<br>这样的尝试性质的图，他可以很直白的告诉别人，我选择的通路是可信的。<br>此时换一种表达形式，也十分方便</p><pre><code>dotplot(xx,<br>        showCategory = <span>30</span>,<br>        label_format = <span>60</span>,<br>        font.size = <span>10</span>,<br>        x = <span>"num"</span>)+ <br>  facet_grid(~<span>group</span>)+<br>  scale_x_discrete(guide = guide_axis(angle = <span>45</span>)) <br></code></pre><p>这时候，激活，抑制，各个基因数目的影响，看的更直观了。<br></p><figure><img data-ratio="0.785167745732784" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFO7CxeIZPePu1VHh8aDwUr15nibKeY6iatyPjp23nInq3Tal0VLp9KCia8g/640?wx_fmt=png" data-type="png" data-w="1699" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFO7CxeIZPePu1VHh8aDwUr15nibKeY6iatyPjp23nInq3Tal0VLp9KCia8g/640?wx_fmt=png"></figure><p>当然你可以尝试更多的基因数目，但是要注意版面不一定放得下。<br>此刻这里面红框的通路，只在特定情况出现，他可能可以救你一命，也可能害你三年，所以慎重选择。<br></p><figure><img data-ratio="0.5556925606247431" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOgA3nhoSbzmkNNUMQibDb1JfqH58RNNEfic4bibQfxlozDzULGwrBr4sxA/640?wx_fmt=png" data-type="png" data-w="2433" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX1pNRicickJ43EpfFicuICxzFOgA3nhoSbzmkNNUMQibDb1JfqH58RNNEfic4bibQfxlozDzULGwrBr4sxA/640?wx_fmt=png"></figure><h4><span>总结升华</span></h4><p>对于差异分析的结果，这里的富集分析用的是<code>over-representation analysis</code><br>这个通路富集分析的第一代技术。<br>后面为了解决这种不知道输入多少基因，不知道究竟是激活还是抑制的问题，<br>第二代通路富集技术产生了，他就是我十分喜欢的基因集富集分析(GSEA)，我们还做过专门的专题。</p><p>同时，在本文中我演示了如何学习并把技能化为己用的过程。他包括两个步骤。<br>第一，要首先复现出阳性的例子，搞清楚一个函数需要什么数据<br>第二，要有能力把自己的数据调整到他需要的样子<br>这样，所有的R包都能自由学习了。</p><p>最后感谢Y叔写出了<code>clusterPofiler</code>这样神奇的R包，让<code>ORA</code>和<code>GSEA</code>这样的富集分析和可视化变得简单易用。<br>当前通路富集分析已经发展到了第四代，这些新的技术不够普及的最大原因，<br>可能就是没有出现<code>clusterPofiler</code>这样简单易用的R包，能够让基础科研的工作者能够简单的上手用起来。</p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/4cV8R4NxNklW4jIzsqLGbg",target="_blank" rel="noopener noreferrer">原文链接</a>
