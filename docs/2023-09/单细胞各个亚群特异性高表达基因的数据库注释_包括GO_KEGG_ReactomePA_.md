---
title: "单细胞各个亚群特异性高表达基因的数据库注释（包括GO,KEGG,ReactomePA）"
date: 2023-09-26T16:37:45Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
单细胞各个亚群特异性高表达基因的数据库注释（包括GO,KEGG,ReactomePA） by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>现在单细胞技术的大行其道，让我们的表达量矩阵里面的列也变成了成百上千甚至过万了，首先它们属于不同的样品，如果是10x技术的单细胞转录组，每个样品可以有5到8千的单细胞列，其次呢我们通常是做多个单细胞样品，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508661&amp;idx=1&amp;sn=37715716398842f760b22589450069dd&amp;scene=21#wechat_redirect" data-linktype="2">2个分组的单细胞项目标准分析</a>，这样的话不同样品也可以有表型分组，比如处理组和对照组。</p></blockquote><p data-tool="mdnice编辑器">拿到了一个单细胞表达量矩阵，默认需要进行：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497956&amp;idx=1&amp;sn=5d4deb7cf7b7848b3e2273cbd663bb6a&amp;scene=21#wechat_redirect" data-linktype="2"> 单细胞聚类分群注释</a> ，如果你对单细胞数据分析还没有基础认知，可以看基础10讲：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486076&amp;idx=1&amp;sn=52bb851d7dc23461233a2cf458736151&amp;scene=21#wechat_redirect" data-linktype="2">01. 上游分析流程</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486082&amp;idx=1&amp;sn=03cadceffb2c14ba95d97fe5caf38d94&amp;scene=21#wechat_redirect" data-linktype="2">02.课题多少个样品，测序数据量如何</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486088&amp;idx=1&amp;sn=3a115338ee4937d20caab78627237553&amp;scene=21#wechat_redirect" data-linktype="2">03. 过滤不合格细胞和基因（数据质控很重要）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486096&amp;idx=1&amp;sn=1a99c4c5800b7e0287db3e8ef369fab8&amp;scene=21#wechat_redirect" data-linktype="2">04. 过滤线粒体核糖体基因</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486098&amp;idx=1&amp;sn=bf9a71df848d74fe665ce7d5e283d5ff&amp;scene=21#wechat_redirect" data-linktype="2">05. 去除细胞效应和基因效应</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486260&amp;idx=1&amp;sn=c6abf658de73594d1d77d8e1ffa7d153&amp;scene=21#wechat_redirect" data-linktype="2">06.单细胞转录组数据的降维聚类分群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486271&amp;idx=1&amp;sn=638b434b6deee63206af1c0eeda175ab&amp;scene=21#wechat_redirect" data-linktype="2">07.单细胞转录组数据处理之细胞亚群注释</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486278&amp;idx=1&amp;sn=91250ef733833ff00371818b215dc124&amp;scene=21#wechat_redirect" data-linktype="2">08.把拿到的亚群进行更细致的分群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486287&amp;idx=1&amp;sn=49627c638ff9c04418282c53518aa7c7&amp;scene=21#wechat_redirect" data-linktype="2">09.单细胞转录组数据处理之细胞亚群比例比较</a></section></li></ul><h3 data-tool="mdnice编辑器"><span></span><span>找各个单细胞亚群特异性高表达量基因</span><span></span></h3><p data-tool="mdnice编辑器">主流的方法是FindAllMarkers函数，但是它比较耗费计算机资源和时间，也可以采用cosg方法，省时省力。</p><p data-tool="mdnice编辑器">我们以大家熟知的pbmc3k数据集为例，大家先安装这个数据集对应的包，并且对它进行降维聚类分群，参考前面的例子：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497956&amp;idx=1&amp;sn=5d4deb7cf7b7848b3e2273cbd663bb6a&amp;scene=21#wechat_redirect" data-linktype="2">人人都能学会的单细胞聚类分群注释</a> ，而且每个亚群找高表达量基因，都存储为Rdata文件。标准代码是：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(SeuratData) <span>#加载seurat数据集  </span><br>getOption(<span>'timeout'</span>)<br>options(timeout=<span>10000</span>)<br><span>#InstallData("pbmc3k")  </span><br>data(<span>"pbmc3k"</span>)  <br>sce &lt;- pbmc3k.final  <br><span>library</span>(Seurat)<br>table(Idents(sce))<br>DimPlot(sce,label = <span>T</span>)<br><br>sce.markers &lt;- FindAllMarkers(object = sce, only.pos = <span>TRUE</span>, <br>                              min.pct = <span>0.25</span>, <br>                              thresh.use = <span>0.25</span>)<br><span>library</span>(dplyr) <br>top3 &lt;- sce.markers %&gt;% group_by(cluster) %&gt;% top_n(<span>3</span>, avg_log2FC)<br>DoHeatmap(sce ,top3$gene,size=<span>3</span>)<br></code></pre><p data-tool="mdnice编辑器">会得到热图，展现每个单细胞亚群特异性高表达量基因的前3个，它其实就是一种差异分析了，这个时候它对比的是每个单细胞亚群和所有的其它细胞。</p><p data-tool="mdnice编辑器">如果是使用COSG包的cosg函数，是另外的格式的输出各个单细胞亚群的top基因：</p><pre data-tool="mdnice编辑器"><span></span><code>  input_sce = sce<br>  table(Idents(input_sce))<br>  pro = <span>'cosg_seurat_clusters'</span><br>  <br>  <span>if</span>(<span>T</span>){<br>    <br>    <span>library</span>(COSG)<br>    marker_cosg &lt;- cosg(<br>      input_sce,<br>      groups=<span>'all'</span>,<br>      assay=<span>'RNA'</span>,<br>      slot=<span>'data'</span>,<br>      mu=<span>1</span>,<br>      n_genes_user=<span>100</span>)<br>    <br>    save(marker_cosg,file = paste0(pro,<span>'_marker_cosg.Rdata'</span>))<br>    head(marker_cosg)<br>    <br>    <span>## Top10 genes</span><br>    <span>library</span>(dplyr)  <br>    top_10 &lt;- unique(as.character(apply(marker_cosg$names,<span>2</span>,head,<span>10</span>)))<br> <br>    sce.Scale &lt;- ScaleData(input_sce ,features =  top_10  )  <br>    <br>    DoHeatmap(  sce.Scale , top_10 , <br>   <br>    <span>## Top3 genes</span><br>    top_3 &lt;- unique(as.character(apply(marker_cosg$names,<span>2</span>,head,<span>3</span>)))<br>     <br>  }<br>  <br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>然后数据库注释（包括GO,KEGG,ReactomePA）</span><span></span></h3><p data-tool="mdnice编辑器">我这里自己写了一个简单的函数， <code>com_go_kegg_ReactomePA_human</code>   ，可以根据输入的基因名字列表去批量做数据库注释（包括GO,KEGG,ReactomePA），这个函数 <code>com_go_kegg_ReactomePA_human</code> 的代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><br><br>com_go_kegg_ReactomePA_human &lt;- <span>function</span>(symbols_list ,pro){ <br>  <span>library</span>(clusterProfiler)<br>  <span>library</span>(org.Hs.eg.db)<br>  <span>library</span>(ReactomePA)<br>  <span>library</span>(ggplot2)<br>  <span>library</span>(stringr)<br>  <br>  <span># 首先全部的symbol 需要转为 entrezID</span><br>  gcSample = lapply(symbols_list, <span>function</span>(y){ <br>    y=as.character(na.omit(select(org.Hs.eg.db,<br>                                  keys = y,<br>                                  columns = <span>'ENTREZID'</span>,<br>                                  keytype = <span>'SYMBOL'</span>)[,<span>2</span>])<br>    )<br>    y<br>  })<br>  gcSample<br>  <br>  <span># 第1个注释是 KEGG </span><br>  xx &lt;- compareCluster(gcSample, fun=<span>"enrichKEGG"</span>,<br>                       organism=<span>"hsa"</span>, pvalueCutoff=<span>0.05</span>)<br>  dotplot(xx)  + <br>    scale_y_discrete(labels=<span>function</span>(x) str_wrap(x, width=<span>50</span>)) <br>  ggsave(paste0(pro,<span>'_kegg.pdf'</span>),width = <span>10</span>,height = <span>8</span>)<br>  <br>  <span># 第2个注释是 ReactomePA </span><br>  xx &lt;- compareCluster(gcSample, fun=<span>"enrichPathway"</span>,<br>                       organism = <span>"human"</span>,<br>                  pvalueCutoff=<span>0.05</span>)<br>  dotplot(xx)  + <br>    scale_y_discrete(labels=<span>function</span>(x) str_wrap(x, width=<span>50</span>)) <br>  ggsave(paste0(pro,<span>'_ReactomePA.pdf'</span>),width = <span>10</span>,height = <span>8</span>)<br>  <br>  <span># 然后是GO数据库的BP,CC,MF的独立注释</span><br>  <span># Run full GO enrichment test for BP </span><br>  formula_res &lt;- compareCluster(<br>    gcSample, <br>    fun=<span>"enrichGO"</span>, <br>    OrgDb=<span>"org.Hs.eg.db"</span>,<br>    ont     = <span>"BP"</span>,<br>    pAdjustMethod = <span>"BH"</span>,<br>    pvalueCutoff  = <span>0.05</span>,<br>    qvalueCutoff  = <span>0.05</span><br>  )<br>  <br>  <span># Run GO enrichment test and merge terms </span><br>  <span># that are close to each other to remove result redundancy</span><br>  lineage1_ego &lt;- simplify(<br>    formula_res, <br>    cutoff=<span>0.5</span>, <br>    by=<span>"p.adjust"</span>, <br>    select_fun=min<br>  ) <br>  pdf(paste0(pro,<span>'_GO_BP_cluster_simplified.pdf'</span>) ,width = <span>15</span>,height = <span>8</span>)<br>  print(dotplot(lineage1_ego, showCategory=<span>5</span>) + <br>          scale_y_discrete(labels=<span>function</span>(x) str_wrap(x, width=<span>50</span>)) )<br>  dev.off() <br>  write.csv(lineage1_ego@compareClusterResult, <br>            file=paste0(pro,<span>'_GO_BP_cluster_simplified.csv'</span>))<br>  <span># Run full GO enrichment test for CC </span><br>  formula_res &lt;- compareCluster(<br>    gcSample, <br>    fun=<span>"enrichGO"</span>, <br>    OrgDb=<span>"org.Hs.eg.db"</span>,<br>    ont     = <span>"CC"</span>,<br>    pAdjustMethod = <span>"BH"</span>,<br>    pvalueCutoff  = <span>0.05</span>,<br>    qvalueCutoff  = <span>0.05</span><br>  )<br>  <br>  <span># Run GO enrichment test and merge terms </span><br>  <span># that are close to each other to remove result redundancy</span><br>  lineage1_ego &lt;- simplify(<br>    formula_res, <br>    cutoff=<span>0.5</span>, <br>    by=<span>"p.adjust"</span>, <br>    select_fun=min<br>  ) <br>  pdf(paste0(pro,<span>'_GO_CC_cluster_simplified.pdf'</span>) ,width = <span>15</span>,height = <span>8</span>)<br>  print(dotplot(lineage1_ego, showCategory=<span>5</span>) + <br>          scale_y_discrete(labels=<span>function</span>(x) str_wrap(x, width=<span>50</span>)) )<br>  dev.off() <br>  write.csv(lineage1_ego@compareClusterResult, <br>            file=paste0(pro,<span>'_GO_CC_cluster_simplified.csv'</span>))<br>  <br>  <span># Run full GO enrichment test for MF </span><br>  formula_res &lt;- compareCluster(<br>    gcSample, <br>    fun=<span>"enrichGO"</span>, <br>    OrgDb=<span>"org.Hs.eg.db"</span>,<br>    ont     = <span>"MF"</span>,<br>    pAdjustMethod = <span>"BH"</span>,<br>    pvalueCutoff  = <span>0.05</span>,<br>    qvalueCutoff  = <span>0.05</span><br>  )<br>  <br>  <span># Run GO enrichment test and merge terms </span><br>  <span># that are close to each other to remove result redundancy</span><br>  lineage1_ego &lt;- simplify(<br>    formula_res, <br>    cutoff=<span>0.5</span>, <br>    by=<span>"p.adjust"</span>, <br>    select_fun=min<br>  ) <br>  pdf(paste0(pro,<span>'_GO_MF_cluster_simplified.pdf'</span>) ,width = <span>15</span>,height = <span>8</span>)<br>  print(dotplot(lineage1_ego, showCategory=<span>5</span>) + <br>          scale_y_discrete(labels=<span>function</span>(x) str_wrap(x, width=<span>50</span>)) )<br>  dev.off() <br>  write.csv(lineage1_ego@compareClusterResult, <br>            file=paste0(pro,<span>'_GO_MF_cluster_simplified.csv'</span>))<br>  <br>}<br></code></pre><p data-tool="mdnice编辑器">这样的话，无论是什么样的项目，使用起来都非常简洁：</p><pre data-tool="mdnice编辑器"><span></span><code>symbols_list &lt;-  as.list(as.data.frame(apply(marker_cosg$names,<span>2</span>,head,<span>100</span>)))<br><span>source</span>(<span>'com_go_kegg_ReactomePA_human.R'</span>)<br>com_go_kegg_ReactomePA_human(symbols_list, pro=<span>'pbmc'</span> )<br></code></pre><p data-tool="mdnice编辑器">可以简单的看看结果，首先是kegg数据库的注释，可以得到结果的可解释性还是蛮强的：</p><p><img data-galleryid="" data-ratio="0.8315696649029982" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxort5Fc7HGw2ahk2ZfuicTgiaPcZX8LHiamt1dHxvXqyGtkaI2qQicBa2kpoNZ51Z3Ho43tHYovzKGHg/640?wx_fmt=png" data-type="png" data-w="2268" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxort5Fc7HGw2ahk2ZfuicTgiaPcZX8LHiamt1dHxvXqyGtkaI2qQicBa2kpoNZ51Z3Ho43tHYovzKGHg/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>kegg数据库的注释</figcaption></figure><p data-tool="mdnice编辑器">然后是ReactomePA数据库的注释结果，也是很合理啦：</p><p><img data-galleryid="" data-ratio="0.8315696649029982" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxort5Fc7HGw2ahk2ZfuicTg0BmEBoY3Oj807glS2h3aJAvGlBzibcfPyzwZ5ibtWbXflCWtvN4icw0cw/640?wx_fmt=png" data-type="png" data-w="2268" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxort5Fc7HGw2ahk2ZfuicTg0BmEBoY3Oj807glS2h3aJAvGlBzibcfPyzwZ5ibtWbXflCWtvN4icw0cw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>ReactomePA数据库</figcaption></figure><p data-tool="mdnice编辑器">后面还有GO数据库的CC,BP,MF的图，我就不一一展示了，<strong>因为这个PBMC非常出名，但凡是有 这方面生物学背景的，都很容易理解这些单细胞各个亚群特异性高表达基因的数据库注释（包括GO,KEGG,ReactomePA），可以作为你单细胞分群准确性的一个辅助证明。</strong></p></section><h3 data-tool="mdnice编辑器"><span>文末友情推荐：毛遂自荐成为你的单细胞顾问</span></h3><p data-tool="mdnice编辑器">联系方式详见：<a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247514132&amp;idx=1&amp;sn=e39aafaee9f88325c9f02a929f7f6c8d&amp;chksm=9b4bf8afac3c71b988dc9921811dd17bc0f09f94f0c69bfed9fd997fc7a84ac80972ccd48af4&amp;scene=21#wechat_redirect" data-linktype="2">毛遂自荐成为你的单细胞顾问</a></p><p data-tool="mdnice编辑器">单细胞数据标准分析我们做的很多，但是无穷无尽的个性化分析，我们只能做到模仿，很难创新。而且我不是汤富酬张泽民这样的单细胞旗手，仅仅是带领学徒做了一下单细胞文献图表复现，只能做到模仿。文献有的我才会，不能凭空创造概念，只能说把自己看过的几百篇单细胞文献的共性整理，基于它们来对你进行指导哦。</p><p data-tool="mdnice编辑器">作为单细胞顾问，我可以提供的服务仅限于：</p><ul data-tool="mdnice编辑器"><li><section>你可以发5~10篇相关领域文献给我，预计耗时3小时我简单读一下，认识你的课题背景，收费3000块钱</section></li><li><section>你把自己的单细胞转录组数据分析做一个ppt给我，开腾讯会议我听你的讲解，互动一个小时，讨论一个小时，合计收费 2000元。</section></li><li><section>单细胞数据分析流程检查（降维聚类分群，亚群比例差异，表达量差异），耗时半个小时，收费2000块钱</section></li><li><section>其它高级分析的debug，单项收费1600</section></li></ul><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/utob8ZiDj9iuYDIwnq7N4A",target="_blank" rel="noopener noreferrer">原文链接</a>
