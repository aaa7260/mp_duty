---
title: "融合基因鉴定以及GATK寻找突变"
date: 2023-09-05T10:05:11Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
融合基因鉴定以及GATK寻找突变 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">上周的<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247516147&amp;idx=1&amp;sn=11463ea6885ab96c836011fdbbdd73df&amp;chksm=fa457acecd32f3d8658dcd9adb008a246054ca1caa406399cab4dab9e03df92f64d4252523bb&amp;scene=21&amp;cur_album_id=2545418429466607617#wechat_redirect" data-linktype="2">癌症样本全转录组数据的融合基因鉴定</a>中我们拿到数据进行一系列比对过滤后使用star完成了基因组比对，并通过设置参数拿到了Chimeric.out.junction文件以便star-fusion进行融合基因的鉴定</p><p data-tool="mdnice编辑器">但是这后面遇到了一些问题，本周我们就着力解决，完成star-fusion鉴定融合基因，并使用gatk寻找突变</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">参考：<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247498080&amp;idx=1&amp;sn=cabb8852794ae28f7d068f52bc6d98fb&amp;chksm=fa453c5dcd32b54b966e7b6abde2337682815d1b7965e4418781f23b7c95ae197dd705138100&amp;scene=21&amp;cur_album_id=1749887454125293572#wechat_redirect" data-linktype="2">RNA-seq数据分析完全指北-09：寻找融合基因</a></p><h1 data-tool="mdnice编辑器"><span></span>寻找融合基因</h1><h2 data-tool="mdnice编辑器"><span></span>STAR-Fusion鉴定融合基因</h2><blockquote data-tool="mdnice编辑器"><p>STAR和STAR-Fusion的版本一定要相对应</p></blockquote><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p>融合检测starfusion的运用和版本问题（https://zhuanlan.zhihu.com/p/587614424）</p><p>融合基因分析-STAR-Fusion（https://evvail.com/2022/10/05/2822.html）</p><p>STAR Fusion release and CTAT Genome Lib Compatibility Matrix（https://github.com/STAR-Fusion/STAR-Fusion/wiki/STAR-Fusion-release-and-CTAT-Genome-Lib-Compatibility-Matrix）</p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="0.5542916235780765" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykQoAYOGcBC3S1dndkm8HV3cvwz3G8pFSR6qzQwZ4tlLgTQxicnT96iaQQ/640?wx_fmt=png" data-type="png" data-w="967" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykQoAYOGcBC3S1dndkm8HV3cvwz3G8pFSR6qzQwZ4tlLgTQxicnT96iaQQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">使用 <code>mamba search</code> 检查star和star-fusion的版本，发现使用的star为最新版 2.7.10b，在表中无对应star-fusion版本，直接也下载star-fusion最新版 star-fusion=1.12.0（由于环境软件版本问题这里单独创建了一个python3.10的环境安装，在安装的时候发现自动安装了一个2.7.8a版本的star）</p><p data-tool="mdnice编辑器">此外，还需安装相关数据库</p><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p>融合基因分析-STAR-Fusion（https://evvail.com/2022/10/05/2822.html）</p><p>https://data.broadinstitute.org/Trinity/CTAT_RESOURCE_LIB/</p><p>其中’plug-n-play’是已经建好数据库的可以开箱直接使用，但是文件比较大下载需要时间;另一个是source版本的大约4G左右，下载好后需要自己建索引和必要的库文件</p><p>融合基因分析工具：STAR-Fusion  (https://zhuanlan.zhihu.com/p/586371542)</p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="0.2964554242749731" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykbonLpvrQYAhJdxy1uW2jxVdXyK5SCWA4uXeNh3SYSs82FRcegKZP0w/640?wx_fmt=png" data-type="png" data-w="931" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykbonLpvrQYAhJdxy1uW2jxVdXyK5SCWA4uXeNh3SYSs82FRcegKZP0w/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">我们这里直接下载开箱即用的数据库 ，并解压https://data.broadinstitute.org/Trinity/CTAT_RESOURCE_LIB/GRCh38_gencode_v37_CTAT_lib_Mar012021.plug-n-play.tar.gz</p><pre data-tool="mdnice编辑器"><span></span><code>cat srr_acc_list.txt | <span>while</span> <span>read</span> id<br><span>do</span> <br>        STAR-Fusion --genome_lib_dir ~/refdata/index/star_fusion/GRCh38_gencode_v37_CTAT_lib_Mar012021.plug-n-play/ctat_genome_lib_build_dir -J 4.mapping/<span>${id}</span>Chimeric.out.junction --output_dir 5.fusion/<span>${id}</span> --CPU 16<br><span>done</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>nohup bash fusion.sh &amp;&gt; fusion_log &amp;<br></code></pre><p data-tool="mdnice编辑器">完成后查看：</p><pre data-tool="mdnice编辑器"><span></span><code><span>$grep</span> -w <span>"complete"</span> fusion_log <br> * STAR-Fusion complete.  See output: /home/data/t120455/fusion_and_mut/5.fusion/SRR11178348/star-fusion.fusion_predictions.tsv (or .abridged.tsv version)<br> * STAR-Fusion complete.  See output: /home/data/t120455/fusion_and_mut/5.fusion/SRR11178349/star-fusion.fusion_predictions.tsv (or .abridged.tsv version)<br> * STAR-Fusion complete.  See output: /home/data/t120455/fusion_and_mut/5.fusion/SRR11178350/star-fusion.fusion_predictions.tsv (or .abridged.tsv version)<br> * STAR-Fusion complete.  See output: /home/data/t120455/fusion_and_mut/5.fusion/SRR11178351/star-fusion.fusion_predictions.tsv (or .abridged.tsv version)<br> * STAR-Fusion complete.  See output: /home/data/t120455/fusion_and_mut/5.fusion/SRR11178352/star-fusion.fusion_predictions.tsv (or .abridged.tsv version)<br> * STAR-Fusion complete.  See output: /home/data/t120455/fusion_and_mut/5.fusion/SRR11178353/star-fusion.fusion_predictions.tsv (or .abridged.tsv version)<br><br></code></pre><p data-tool="mdnice编辑器">未找到任何融合基因事件，只有表头信息</p><pre data-tool="mdnice编辑器"><span></span><code><span>#FusionName     JunctionReadCount       SpanningFragCount       est_J   est_S   SpliceType      LeftGene</span><br>        LeftBreakpoint  RightGene       RightBreakpoint JunctionReads   SpanningFrags   LargeAnchorSupport<br>      FFPM    LeftBreakDinuc  LeftBreakEntropy        RightBreakDinuc RightBreakEntropy       annots<br></code></pre><p data-tool="mdnice编辑器">而原推文中是存在的，并且这是胃癌样本，按理来说也应该有基因融合事件</p><p data-tool="mdnice编辑器"><img data-ratio="0.5434782608695652" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykBz6nP8QRgytr67A2A3Z4Q74wmlyyUsINVxicEjyy1o8DicZmRgjj5aiaA/640?wx_fmt=png" data-type="png" data-w="1012" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykBz6nP8QRgytr67A2A3Z4Q74wmlyyUsINVxicEjyy1o8DicZmRgjj5aiaA/640?wx_fmt=png">就这个问题我询问了曾老师</p><blockquote data-tool="mdnice编辑器"><p>Q：胃癌的样本，原推文找出了融合基因事件，我跟着走下来没有找到，在想新版的软件、参考基因组和注释文件会有什么影响吗</p><p>A：如果是全新的参考基因组什么的，应该不会影响它。融合事件是癌症特有的，只要你是癌症样品，按照道理它就应该有。有没有可能是融合事件过滤的参数太严格了呢？</p></blockquote><p data-tool="mdnice编辑器">在前面star比对获得Chimeric.out.junction文件时，我们像原推文那样设置了一系列参数：</p><blockquote data-tool="mdnice编辑器"><ul><li><section>融合基因部分</section></li></ul><pre><span></span><code>--chimSegmentMin 20    <span># 每对嵌合读段较短的一端至少有20个碱基，即PE150允许280+20结构的融合基因</span><br>--chimOutJunctionFormat 1    <span># 输出的Chimeric.out.junction文件可直接用于融合基因</span><br>--chimSegmentReadGapMax 0    <span># 嵌合读段之间不允许空位</span><br>--chimJunctionOverhangMin 20    <span># 嵌合的junction的最少的overhang是20个碱基，为了过滤非常短的外显子，即连续剪切事件</span><br></code></pre></blockquote><p data-tool="mdnice编辑器">于是我们这里更换star-fusion模式看看，直接对fq文件进行处理，跳过这些我们设置的参数</p><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p>融合基因分析-STAR-Fusion（https://evvail.com/2022/10/05/2822.html）</p><figure><img data-ratio="0.8407367280606717" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk3e0tUQpw4iclBmHFic3azbVGz9icq9l8j4x61Z9jXPDDG8AekiaXqph9sA/640?wx_fmt=png" data-type="png" data-w="923" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk3e0tUQpw4iclBmHFic3azbVGz9icq9l8j4x61Z9jXPDDG8AekiaXqph9sA/640?wx_fmt=png"></figure><p>融合基因分析工具：STAR-Fusion  (https://zhuanlan.zhihu.com/p/586371542)</p><figure><img data-ratio="0.8576233183856502" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykslic44TW2IQZoHiabyNiamEuF3JadRdrwWWo21ibH9nP1ByxkhJapSHGpA/640?wx_fmt=png" data-type="png" data-w="892" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykslic44TW2IQZoHiabyNiamEuF3JadRdrwWWo21ibH9nP1ByxkhJapSHGpA/640?wx_fmt=png"></figure></blockquote><p data-tool="mdnice编辑器">直接从双端按测序的fq文件开始：</p><pre data-tool="mdnice编辑器"><span></span><code>cat srr_acc_list.txt | <span>while</span> <span>read</span> id<br><span>do</span> <br>        STAR-Fusion --genome_lib_dir ~/refdata/index/star_fusion/GRCh38_gencode_v37_CTAT_lib_Mar012021.plug-n-play/ctat_genome_lib_build_dir --left_fq 3.trimg/<span>${id}</span>_rmr_rmOther_1_val_1.fq.gz --right_fq 3.trimg/<span>${id}</span>_rmr_rmOther_2_val_2.fq.gz --output_dir 5.fusion_from_fq/<span>${id}</span> --CPU 16<br><span>done</span><br></code></pre><p data-tool="mdnice编辑器">完成后查看：</p><pre data-tool="mdnice编辑器"><span></span><code><span>$grep</span> -w <span>"complete"</span> fusion_from_fq_log <br> * STAR-Fusion complete.  See output: /home/data/t120455/fusion_and_mut/5.fusion_from_fq/SRR11178348/star-fusion.fusion_predictions.tsv (or .abridged.tsv version)<br> * STAR-Fusion complete.  See output: /home/data/t120455/fusion_and_mut/5.fusion_from_fq/SRR11178349/star-fusion.fusion_predictions.tsv (or .abridged.tsv version)<br> * STAR-Fusion complete.  See output: /home/data/t120455/fusion_and_mut/5.fusion_from_fq/SRR11178350/star-fusion.fusion_predictions.tsv (or .abridged.tsv version)<br> * STAR-Fusion complete.  See output: /home/data/t120455/fusion_and_mut/5.fusion_from_fq/SRR11178351/star-fusion.fusion_predictions.tsv (or .abridged.tsv version)<br> * STAR-Fusion complete.  See output: /home/data/t120455/fusion_and_mut/5.fusion_from_fq/SRR11178352/star-fusion.fusion_predictions.tsv (or .abridged.tsv version)<br> * STAR-Fusion complete.  See output: /home/data/t120455/fusion_and_mut/5.fusion_from_fq/SRR11178353/star-fusion.fusion_predictions.tsv (or .abridged.tsv version)<br><br></code></pre><p data-tool="mdnice编辑器">直接从fq文件使用默认参数star-fusion找到了融合基因，以SRR11178349样本为例：</p><p data-tool="mdnice编辑器">/fusion_and_mut/5.fusion_from_fq/SRR11178348/star-fusion.fusion_predictions.tsv</p><pre data-tool="mdnice编辑器"><span></span><code><span>$grep</span> -v <span>"^#"</span> /home/data/t120455/fusion_and_mut/5.fusion_from_fq/SRR11178348/star-fusion.fusion_predictions.tsv | awk <span>'{print $1}'</span><br>E2F3--CDKAL1<br>WNK1--ERC1<br>PHACTR4--RCC1<br>GAS6--TUBB2B<br>AC022400.4--BMS1P4<br>WWTR1--COMMD2<br>TMEM181--WTAP<br>AL627309.5--SEPTIN14<br>MED13--DDX46<br>LINC02246--NRIP1<br>LSM14A--GARRE1<br>ERICH2--AC007405.3<br></code></pre><p data-tool="mdnice编辑器">解读结果文件：</p><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p>融合基因分析工具：STAR-Fusion（https://zhuanlan.zhihu.com/p/586371542#h_586371542_6）</p></blockquote><p data-tool="mdnice编辑器">以第一个样本为例，5.fusion_from_fq/SRR11178348/</p><figure data-tool="mdnice编辑器"><img data-ratio="0.4193877551020408" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykqvNEV0hjReA0J1qFA4NI7GokqCHiaG9hxINzDkCBPd8arkoc4rAY4fw/640?wx_fmt=png" data-type="png" data-w="980" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykqvNEV0hjReA0J1qFA4NI7GokqCHiaG9hxINzDkCBPd8arkoc4rAY4fw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">有一些文件和前面star比对结果类似就不再说，这里挑融合基因相关的看看</p><ul data-tool="mdnice编辑器"><li><section>log文件</section></li></ul><p data-tool="mdnice编辑器">Log.final.out</p><pre data-tool="mdnice编辑器"><span></span><code>                                  CHIMERIC READS:<br>                       Number of chimeric reads |       795505<br>                            % of chimeric reads |       2.06%<br></code></pre><p data-tool="mdnice编辑器">在STAR-Fusion的结果中，"CHIMERIC READS" 指的是被检测到具有融合特征的配对读取。融合基因事件通常由两个基因的某些部分融合形成，这可以导致在测序数据中检测到具有异常匹配的配对读取。这种异常匹配的配对读取就是 "CHIMERIC READS"，它表示两个不同的基因的片段在测序数据中被连在一起。这些 "CHIMERIC READS" 可能来自于基因融合点的跨越、基因重排等事件，是检测和识别融合基因的关键信息。根据这些异源的配对读取，STAR-Fusion可以进行融合事件的定位和推断。通常，"CHIMERIC READS" 数量的多少可以反映样本中融合基因事件的丰度或表达水平。具体分析和解读融合基因事件时，"CHIMERIC READS" 是一个重要的指标之一。</p><ul data-tool="mdnice编辑器"><li><section>Chimeric.out.junction</section></li></ul><p data-tool="mdnice编辑器">我们这里看看和前面star调用相关参数得到的Chimeric.out.junction文件有什么区别，因为我们用前面的Chimeric.out.junction使用Kickstart模式的star-fusion并没有找到融合基因事件</p><pre data-tool="mdnice编辑器"><span></span><code><span>$grep</span> -v <span>"^chr_"</span> ../../4.mapping/SRR11178348Chimeric.out.junction | wc -l<br>379390<br><span>$grep</span> -v <span>"^chr_"</span> Chimeric.out.junction | wc -l<br>1367384<br></code></pre><p data-tool="mdnice编辑器">可以发现我们现在Chimeric.out.junction文件包含了更多可能的融合基因事件记录</p><ul data-tool="mdnice编辑器"><li><section>star-fusion.fusion_predictions.abridged.tsv</section></li></ul><blockquote data-tool="mdnice编辑器"><p>STAR-Fusion的输出是一个以制表符分隔的文件(star-fusion.fusion_predictions.tsv)和一个不包括证据融合reads识别的删减版本(star-fusion.fusion_predictions.abridged.tsv)</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span>$head</span> -2 star-fusion.fusion_predictions.abridged.tsv <br><span>#FusionName JunctionReadCount SpanningFragCount est_J est_S SpliceType LeftGenLeftBreakpoint RightGene RightBreakpoint LargeAnchorSupport FFPM LeftBreakDinuc LeftBreakEntropy RightBreakDinuc RightBreakEntropy annots</span><br>E2F3--CDKAL1 48 9 48.00 9.00 ONLY_REF_SPLICE E2F3^ENSG00000112242.15 chr6:20488248:+CDKAL1^ENSG00000145996.11 chr6:20649293:+ YES_LDAS 1.4756 GT 1.8323 AG 1.9219 [<span>"Klijn_CellLines"</span>,<span>"TCGA_StarF2019"</span>,<span>"CCLE_StarF2019"</span>,<span>"INTRACHROMOSOMAL[chr6:0.04Mb]"</span>,<span>"NEIGHBORS[40743]"</span>]<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>2、获取上下游序列</h2><h3 data-tool="mdnice编辑器"><span></span>下载基因组CDS、注释文件并格式化为外显子和CDS文件<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>Homo_sapiens.GRCh38.cds.all.fa.gz<br>Homo_sapiens.GRCh38.110.chr.gtf.gz <br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>zcat Homo_sapiens.GRCh38.110.chr.gtf.gz |grep -w havana |perl -F<span>"\t"</span> -alne  <span>'{next if $F[2] ne "exon";@a=split(/\"/,$F[8]); print join("\t",$a[1],$a[5],$a[9],$F[0],$F[3],$F[4],$F[4]-$F[3]+1) }'</span> &gt; Homo_sapiens.GRCh38.g2t2exon.txt<br><br>zcat Homo_sapiens.GRCh38.110.chr.gtf.gz |grep -w havana |perl -F<span>"\t"</span> -alne  <span>'{next if $F[2] ne "CDS";@a=split(/\"/,$F[8]); print join("\t",$a[1],$a[5],$a[9],$F[0],$F[3],$F[4],$F[4]-$F[3]+1) }'</span> &gt; Homo_sapiens.GRCh38.g2t2cds.txt<br></code></pre><p data-tool="mdnice编辑器">关于gtf文件格式，参考：</p><blockquote data-tool="mdnice编辑器"><p>文件格式 - GFF/GTF （https://www.bilibili.com/read/cv12909188）</p></blockquote><p data-tool="mdnice编辑器"><code>grep -w havana</code>：使用 <code>grep</code> 命令根据关键词 “havana” 进行匹配。<code>-w</code> 参数表示精确匹配整个单词。</p><pre data-tool="mdnice编辑器"><span></span><code><span>$zcat</span> Homo_sapiens.GRCh38.110.chr.gtf.gz | grep -v <span>"^#"</span> | awk <span>'{print $2}'</span> | sort | uniq -c<br> 122430 ensembl<br> 718375 ensembl_havana<br>    275 ensembl_havana_tagene<br>     21 ensembl_tagene<br>2404017 havana<br> 170147 havana_tagene<br>    144 insdc<br>   5637 mirbase<br></code></pre><p data-tool="mdnice编辑器">“havana” 的注释通常被认为是较为可靠和高质量的注释。因此，通过匹配 “havana” 可以过滤掉其他注释来源（如"ensembl"、"refseq"等），并仅保留具有 “havana” 注释来源的行。</p><p data-tool="mdnice编辑器">打开文件仔细观察，可以发现CDS相比于exon序列，只是在transcript的5' 3'两端少了一部分</p><figure data-tool="mdnice编辑器"><img data-ratio="0.2657407407407407" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyku9botqsvwDcMTicsT5sxreTyFjDUO3ck92HIjNe2JPhVOYiciajS6Pb7w/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyku9botqsvwDcMTicsT5sxreTyFjDUO3ck92HIjNe2JPhVOYiciajS6Pb7w/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">这里就涉及到一个<strong>非翻译区外显子</strong>的概念：</p><p data-tool="mdnice编辑器">在<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247515785&amp;idx=1&amp;sn=16b3c4b26c7baff9dbd86953695c2e6f&amp;chksm=fa457bb4cd32f2a2ac59c21df556ee77b98c58ab3e838fe4cdab5408b7085024670143cf9238&amp;scene=21&amp;cur_album_id=2545418429466607617#wechat_redirect" data-linktype="2">鉴定lncRNA流程全套代码整理</a>中，我们比较了CDS和mRNA的不同，主要区别在于CDS不包含两端的UTR部分</p><p data-tool="mdnice编辑器">"exons and two codons"中的两个密码子当然就是起始密码子和终止密码子</p><p data-tool="mdnice编辑器">那么CDS和exons片段序列严格意义上又有什么区别呢？在前面的文件里。可以发现CDS相比于exon序列，只是在transcript的5' 3'两端少了一部分，少的部分就是非翻译区exon</p><p data-tool="mdnice编辑器">参考：原来外显子不是全都翻译啊！（https://zhuanlan.zhihu.com/p/87788625）</p><figure data-tool="mdnice编辑器"><img data-ratio="1.167832167832168" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykYDwHzbpAib67At1iaqjibA8F1AJiaB0h96dawOBQvaueBKl4jqJSBhQwkQ/640?wx_fmt=png" data-type="png" data-w="715" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykYDwHzbpAib67At1iaqjibA8F1AJiaB0h96dawOBQvaueBKl4jqJSBhQwkQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">查看原始gtf文件也可进行区分，可以看看起始密码子位于哪个exon的哪个位置</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5092592592592593" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyktdxFboPPPcug7uPRl2ibeTaicUktxlM7DfceBpNribibYMHS13TCMHtHow/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyktdxFboPPPcug7uPRl2ibeTaicUktxlM7DfceBpNribibYMHS13TCMHtHow/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>后面提取序列进行可视化都以SRR11178348样本为例</strong></p><h3 data-tool="mdnice编辑器"><span></span>将基因组坐标转为转录本坐标<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>library(stringr)<br><br>fusion &lt;- read.table(<span>"/home/data/t120455/fusion_and_mut/5.fusion_from_fq/SRR11178348/star-fusion.fusion_pdictions.abridged.tsv"</span>)<br>head(fusion)<br>cds &lt;- read.table(<span>"~/refdata/Homo_sapiens.GRCh38.g2t2exon.txt"</span>)<br>colnames(cds) &lt;- c(<span>'gene'</span>,<span>'transcript'</span>,<span>'exon'</span>,<span>'chr'</span>,<span>'start'</span>,<span>'end'</span>,<span>'exon_length'</span>)<br>head(cds)<br><br><span>if</span> (!exists(<span>"re"</span>)) {<br>  re &lt;- array(dim = c(0, 9))  <span># 占位</span><br><br><span>if</span> (!exists(<span>"re"</span>)) {<br>  re &lt;- array(dim = c(0, 9))  <span># 占位</span><br>  colnames(re) &lt;- c(<span>'gene'</span>,<span>'transcript'</span>,<span>'exon'</span>,<span>'chr'</span>,<span>'start'</span>,<span>'end'</span>,<span>'exon_length'</span>,<span>'pos'</span>,<span>'new_pos'</span>)<br>}<br>re<br><br><span>for</span> (m <span>in</span> 1:nrow(fusion)) {<br>  x &lt;- fusion[m,]<br>  g &lt;- str_split(x[7],<span>"\\^"</span>, simplify = TRUE)[1,2]<br>  g &lt;- str_split(g,<span>"\\."</span>, simplify = TRUE)[1,1]<br>  pos &lt;- as.numeric(str_split(x[8], <span>":"</span>, simplify = TRUE)[1,2])<br>  info &lt;- cds[cds<span>$gene</span> == g,] <span># 有的基因有多个转录本</span><br>  <span>if</span> (nrow(info) &gt; 0) {<br>    <span>for</span> (j <span>in</span> 1:length(split(info,info[,2]))) {<br>      y &lt;- split(info,info[,2])[[j]]<br>      <span>for</span> (i <span>in</span> 1:nrow(y)) {<br>        z &lt;- as.character(y[i,])<br>        <span>if</span>(z[5] &lt;= pos &amp; z[6] &gt;= pos ){<br>          new &lt;- sum(as.numeric(y[y[,3] &lt; as.numeric(z[3]),7])) + pos - as.numeric(z[5])+1 <br>          re &lt;- rbind(re,c(z,pos,new))<br>        }<br>        i &lt;- 1 + 1<br>      }<br>      j &lt;- j + 1<br>    }<br>  }<br>    m &lt;- m + 1<br>}<br><br>head(re)<br><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>     gene              transcript        exon chr  start      end        exon_length pos        new_pos<br>[1,] <span>"ENSG00000060237"</span> <span>"ENST00000535572"</span> <span>"25"</span> <span>"12"</span> <span>"907847"</span>   <span>"908034"</span>   <span>"188"</span>       <span>"908034"</span>   <span>"7060"</span> <br>[2,] <span>"ENSG00000060237"</span> <span>"ENST00000537603"</span> <span>"2"</span>  <span>"12"</span> <span>"907847"</span>   <span>"908201"</span>   <span>"355"</span>       <span>"908034"</span>   <span>"386"</span>  <br>[3,] <span>"ENSG00000060237"</span> <span>"ENST00000540885"</span> <span>"1"</span>  <span>"12"</span> <span>"907720"</span>   <span>"908034"</span>   <span>"315"</span>       <span>"908034"</span>   <span>"315"</span>  <br>[4,] <span>"ENSG00000060237"</span> <span>"ENST00000675631"</span> <span>"24"</span> <span>"12"</span> <span>"907847"</span>   <span>"908034"</span>   <span>"188"</span>       <span>"908034"</span>   <span>"5879"</span> <br>[5,] <span>"ENSG00000060237"</span> <span>"ENST00000676347"</span> <span>"18"</span> <span>"12"</span> <span>"907847"</span>   <span>"908034"</span>   <span>"188"</span>       <span>"908034"</span>   <span>"4278"</span> <br>[6,] <span>"ENSG00000204138"</span> <span>"ENST00000463428"</span> <span>"2"</span>  <span>"1"</span>  <span>"28407410"</span> <span>"28407463"</span> <span>"54"</span>        <span>"28407463"</span> <span>"141"</span> <br></code></pre><h3 data-tool="mdnice编辑器"><span></span>根据转录本坐标获取转录本序列<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>fa &lt;- readLines(<span>"~/refdata/Homo_sapiens.GRCh38.cds.all.fa.gz"</span>)<br>fa &lt;- paste0(fa, collapse = <span>""</span>)<br>fa &lt;- str_split(fa, <span>"&gt;"</span>)[[1]]<br>fa &lt;- fa[-1]<br>tid &lt;- str_split(fa, <span>"\\."</span>, simplify = TRUE)[,1]<br>head(tid)<br><br>seq &lt;- str_split(fa, <span>"]"</span>, simplify = TRUE)[,2]<br>head(seq)<br><br>re &lt;- as.data.frame(re)<br>re &lt;- re[re<span>$transcript</span> %<span>in</span>% tid,]<br>re<span>$tseq</span> &lt;- seq[match(re<span>$transcript</span>,tid)]<br>head(re)<br>re<span>$up</span> &lt;- unlist(lapply(1:nrow(re),<span>function</span>(i){<br>  <span>#i=1</span><br>  new_pos &lt;- as.numeric(re[i,9])<br>  l &lt;- nchar(re[i,10])<br>  <span>if</span>(new_pos&gt;500){<br>    <span>return</span>(substring(re[i,10],new_pos-500,new_pos))<br>  }<span>else</span>{<br>    <span>return</span>(substring(re[i,10],0,new_pos))<br>  }<br>  <br>}))<br>re<span>$down</span> &lt;- unlist(lapply(1:nrow(re),<span>function</span>(i){<br>  <span>#i=1</span><br>  new_pos &lt;- as.numeric(re[i,9])<br>  l &lt;- nchar(re[i,10])<br>  <span>if</span>((l-new_pos) &gt;500){<br>    <span>return</span>(substring(re[i,10],new_pos,new_pos+500))<br>  }<span>else</span>{<br>    <span>return</span>(substring(re[i,10],new_pos,l))<br>  }<br>  <br>}))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.24259259259259258" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykJpk21Gliat4aseo4ITtuuCTibJ0ZIB8wLVTVqLSPEfj9Zibv6lTYPKTTg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykJpk21Gliat4aseo4ITtuuCTibJ0ZIB8wLVTVqLSPEfj9Zibv6lTYPKTTg/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p>要注意，有的转录本不存在于FASTA文件中，所以最后会损失一部分转录本无法获取序列</p></blockquote><h2 data-tool="mdnice编辑器"><span></span>3、chimeraviz可视化</h2><blockquote data-tool="mdnice编辑器"><p>chimeraviz支持来自9种不同融合发现工具（deFuse、EricScript、InFusion、JAFFA、FusionCatcher、FusionMap、PRADA、SOAPfuse和<strong>STAR-FUSION</strong>）的输入</p></blockquote><p data-tool="mdnice编辑器">原推文是使用内置数据集来演示的，我们这里尝试能不能对我们上面自己找到的融合基因事件可视化</p><h3 data-tool="mdnice编辑器"><span></span>全局可视化<span></span></h3><p data-tool="mdnice编辑器">示例代码：</p><pre data-tool="mdnice编辑器"><span></span><code><br>library(chimeraviz)<br><br>star_fusion_candidates &lt;- system.file(<span>"extdata"</span>,<br>                                      <span>"star-fusion.fusion_candidates.final.abridged.txt"</span>,<br>                                      package=<span>"chimeraviz"</span>)<br>fusions &lt;- import_starfusion(star_fusion_candidates, <span>"hg38"</span>)<br><br>length(fusions)<br>plot_circle(fusions)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>&gt; star_fusion_candidates<br>[1] <span>"/home/data/t120455/R/x86_64-pc-linux-gnu-library/4.2/chimeraviz/extdata/star-fusion.fusion_candidates.final.abridged.txt"</span><br></code></pre><p data-tool="mdnice编辑器">打开发现和我们上面的得到的star-fusion.fusion_predictions.abridged.tsv格式一致</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; getwd()<br>[1] <span>"/home/data/t120455/fusion_and_mut/6.transcript_viz"</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>my_fusion_candidates &lt;- c(<span>"../5.fusion_from_fq/SRR11178348/star-fusion.fusion_predictions.abridged.tsv"</span>)<br>my_fusions &lt;- import_starfusion(my_fusion_candidates, <span>"hg38"</span>)<br>length(my_fusions)<br>plot_circle(my_fusions)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5148148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyktQ0LULdibHqJQN8G1mG1BlhLMCZRmnKuJiaP74BA3VRGW6zHwJ4tcVicg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyktQ0LULdibHqJQN8G1mG1BlhLMCZRmnKuJiaP74BA3VRGW6zHwJ4tcVicg/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>单独可视化<span></span></h3><p data-tool="mdnice编辑器">示例代码：</p><blockquote data-tool="mdnice编辑器"><p>需要融合位点附近的bam序列</p></blockquote><p data-tool="mdnice编辑器">原推文代码中存在部分代码不完整，且一些函数、参数需要更新，下面是我在原代码基础上修改后的代码和结果</p><pre data-tool="mdnice编辑器"><span></span><code>defuse833ke &lt;- system.file(<span>"extdata"</span>,<br>                           <span>"defuse_833ke_results.filtered.tsv"</span>,<br>                           package = <span>"chimeraviz"</span>)<br>fusions &lt;- import_defuse(defuse833ke, <span>"hg19"</span>, 1)<br>fusion &lt;- get_fusion_by_id(fusions, 5267)<br>edbSqliteFile &lt;- system.file(<span>"extdata"</span>,<br>                             <span>"Homo_sapiens.GRCh37.74.sqlite"</span>,<br>                             package=<span>"chimeraviz"</span>)<br>edb &lt;- ensembldb::EnsDb(edbSqliteFile)<br>                  <br>fusion5267and11759reads &lt;- system.file(<span>"extdata"</span>,<br>                                       <span>"fusion5267and11759reads.bam"</span>,<br>                                       package = <span>"chimeraviz"</span>)<br><span># 基于转录本</span><br>plot_fusion(fusion = fusion,<br>           bamfile = fusion5267and11759reads,<br>           edb = edb,<br>           non_ucsc = TRUE)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5407407407407407" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykAofHnQ2n1E5Deeb5BO38CJCGoBMNVsZ5micQ9C0KNHF2ibhjfN48sxSA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykAofHnQ2n1E5Deeb5BO38CJCGoBMNVsZ5micQ9C0KNHF2ibhjfN48sxSA/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>bamfile5267 &lt;- system.file(<span>"extdata"</span>,<br>                           <span>"5267readsAligned.bam"</span>,<br>                           package = <span>"chimeraviz"</span>)<br><br><span># 基于基因</span><br>plot_fusion(fusion = fusion,<br>           bamfile = bamfile5267,<br>           edb = edb,<br>           non_ucsc = TRUE,<br>           reduce_transcripts = TRUE)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5527777777777778" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykWRCK1sz3Eb8TLfsruVYcqibiazsQsGQMKYWsSGuvWIzZG1GOnCSFhOicQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykWRCK1sz3Eb8TLfsruVYcqibiazsQsGQMKYWsSGuvWIzZG1GOnCSFhOicQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">可视化我们的结果第一个样本中第一个融合基因事件：</p><p data-tool="mdnice编辑器">观察示例代码plot_fusion函数，有三个主要输入</p><ul data-tool="mdnice编辑器"><li><section>fusion</section></li></ul><p data-tool="mdnice编辑器">这个最简单，我们前面已经通过import_starfusion读取了融合基因事件结果文件</p><pre data-tool="mdnice编辑器"><span></span><code>my_fusion_candidates &lt;- c(<span>"../5.fusion_from_fq/SRR11178348/star-fusion.fusion_predictions.abridged.tsv"</span>)<br>my_fusions &lt;- import_starfusion(my_fusion_candidates, <span>"hg38"</span>)<br></code></pre><p data-tool="mdnice编辑器">在示例代码中，使用了 <code>get_fusion_by_id</code> 通过id来获取单独的融合基因事件，我们这里就直接对列表操作[[1]]取第一个</p><ul data-tool="mdnice编辑器"><li><section>edb</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.6238030095759234" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykgxviaibtkl0aErPYrLqUQ1XnFGpYhHTPw7eEkpibtwiaiaGVWUVmQUZPgAA/640?wx_fmt=png" data-type="png" data-w="731" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykgxviaibtkl0aErPYrLqUQ1XnFGpYhHTPw7eEkpibtwiaiaGVWUVmQUZPgAA/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>&gt; edbSqliteFile<br>[1] <span>"/home/data/t120455/R/x86_64-pc-linux-gnu-library/4.2/chimeraviz/extdata/Homo_sapiens.GRCh37.74.sqlite"</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>edb &lt;- ensembldb::EnsDb(edbSqliteFile)<br><br>&gt; edb<br>EnsDb <span>for</span> Ensembl:<br>|Backend: SQLite<br>|Db <span>type</span>: EnsDb<br>|Type of Gene ID: Ensembl Gene ID<br>|Supporting package: ensembldb<br>|Db created by: ensembldb package from Bioconductor<br>|script_version: 0.0.1<br>|Creation time: Sat May 28 16:01:27 2016<br>|ensembl_version: 74<br>|ensembl_host: unknown<br>|Organism: Homo_sapiens<br>|genome_build: GRCh37<br>|DBSCHEMAVERSION: 1.0<br>|source_file: Homo_sapiens.GRCh37.74_subset.gtf<br>| No. of genes: 4.<br>| No. of transcripts: 21.<br></code></pre><p data-tool="mdnice编辑器">当有不认识的文件时，拿文件名去google一下是一个不错的选择</p><p data-tool="mdnice编辑器">我这里检索时把37换成了38，因为我们自己使用的参考基因组是GRCh38</p><figure data-tool="mdnice编辑器"><img data-ratio="0.7922814982973894" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykeah3bWuiaYsAMWUU2tC4tRymoAjNXicVca3BYcthOzePEg71w6urXb6g/640?wx_fmt=png" data-type="png" data-w="881" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykeah3bWuiaYsAMWUU2tC4tRymoAjNXicVca3BYcthOzePEg71w6urXb6g/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">https://www.bioconductor.org/packages/devel/bioc/vignettes/ensembldb/inst/doc/ensembldb.html</p><p data-tool="mdnice编辑器">生成和使用基于ENEMBL的注释软件包，看起来是使用ENSEMBL gtf文件的一个R包</p><p data-tool="mdnice编辑器">简单看一下介绍：</p><blockquote data-tool="mdnice编辑器"><p><code>ensembldb</code>包提供了创建和使用以转录本为中心的注释数据库/包的功能。数据库的注释是 使用 Perl API直接从 Ensembl获取的。</p><p>除了从数据库中检索所有基因/转录模型和注释之外，该ensembldb 包还提供了一个过滤器框架，允许检索特定条目的注释，例如编码在基因上的基因lincRNA 基因的染色体区域或转录模型。</p><p>该包的另一个主要目标是生成版本化注释包，即为特定 Ensembl 版本构建的注释包，并且也根据该版本命名（例如，用于 EnsDb.Hsapiens.v86Ensembl 代码数据库版本 86 的人类基因定义）。这确保了可重复性，因为如果有较新版本的注释包/版本可用，它也允许从特定 Ensembl 版本加载注释。它还允许同时加载多个注释包，以便比较 Ensembl 版本之间的基因模型。</p><p>在下面的示例中，我们为智人加载基于 Ensembl 的注释包，Ensembl 版本 86。EnsDb提供对底层 SQLite 数据库的访问的对象绑定到变量 name EnsDb.Hsapiens.v86。</p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="0.8639240506329114" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykrSvCFjcickVicNS45YKjf0tnRaC7fmD870S8QH5pTt3Ky7JUokb8cakg/640?wx_fmt=png" data-type="png" data-w="632" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykrSvCFjcickVicNS45YKjf0tnRaC7fmD870S8QH5pTt3Ky7JUokb8cakg/640?wx_fmt=png"><figcaption>img</figcaption></figure><p data-tool="mdnice编辑器">人GHCh38版本，就用这个了，我没对这个包的其他功能有什么探索，ENSEMBL的注释包我平时使用较多的是biomart</p><p data-tool="mdnice编辑器">示例代码使用的数据集Homo_sapiens.GRCh37.74.sqlite只包含了4个genes，21个transcripts</p><p data-tool="mdnice编辑器">EnsDb.Hsapiens.v86明显是汇总的</p><ul data-tool="mdnice编辑器"><li><section>bamfile</section></li></ul><blockquote data-tool="mdnice编辑器"><p>需要融合位点附近的bam序列</p></blockquote><p data-tool="mdnice编辑器">关于sam/bam文件格式，参考：</p><blockquote data-tool="mdnice编辑器"><p>SAM文件与Samtools （http://47.57.89.98/detail/85/）</p><p>序列匹配中的CIGAR （http://47.57.89.98/detail/84/）</p></blockquote><p data-tool="mdnice编辑器">我这里直接拿star-fusio产生的Aligned.out.bam试试看</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; plot_fusion(fusion = my_fusions[[1]],<br>+             bamfile = <span>"../5.fusion_from_fq/SRR11178348/Aligned.out.bam"</span>,<br>+             edb = edb38,<br>+             non_ucsc = TRUE,<br>+             reduce_transcripts = TRUE)<br>Fetching transcripts <span>for</span> gene partners..<br>..transcripts fetched.<br>Fusion is intrachromosomal..<br>..but too far apart. Plot separate!<br>Selecting transcripts <span>for</span> E2F3..<br>..found transcripts of <span>type</span> exonBoundary<br>Selecting transcripts <span>for</span> CDKAL1..<br>..found transcripts of <span>type</span> exonBoundary<br>Error <span>in</span> h(simpleError(msg, call)) : <br>  error <span>in</span> evaluating the argument <span>'x'</span> <span>in</span> selecting a method <span>for</span> <span>function</span> <span>'colnames'</span>: error <span>in</span> evaluating the argument <span>'x'</span> <span>in</span> selecting a method <span>for</span> <span>function</span> <span>'mcols'</span>: Unable to find index <span>for</span> BAM file <span>'../5.fusion_from_fq/SRR11178348/Aligned.out.bam'</span>. You can build an index using the following <span>command</span>:<br> library(Rsamtools)<br> indexBam(<span>"../5.fusion_from_fq/SRR11178348/Aligned.out.bam"</span>)<br></code></pre><p data-tool="mdnice编辑器">告诉我需要索引，建索引：</p><pre data-tool="mdnice编辑器"><span></span><code><span>$samtools</span> index Aligned.out.bam<br>[E::hts_idx_push] Chromosome blocks not continuous<br>[E::sam_index] Read <span>'SRR11178348.231796'</span> with ref_name=<span>'chr2'</span>, ref_length=242193529, flags=99, pos=111858385 cannot be indexed<br>samtools index: failed to create index <span>for</span> <span>"Aligned.out.bam"</span><br></code></pre><p data-tool="mdnice编辑器">报错解决，参考：</p><blockquote data-tool="mdnice编辑器"><p>Samtools Index: Chromosome Blocks not Continuous （https://bioinformatics.stackexchange.com/questions/13997/samtools-index-chromosome-blocks-not-continuous）</p></blockquote><p data-tool="mdnice编辑器">于是先默认按照序列位置排序后再建索引：</p><pre data-tool="mdnice编辑器"><span></span><code><span>$samtools</span> sort Aligned.out.bam -o Aligned.out.sorted.bam<br>[bam_sort_core] merging from 5 files and 1 <span>in</span>-memory blocks...<br><br><span>$samtools</span> index Aligned.out.sorted.bam<br></code></pre><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">完整代码：</p><pre data-tool="mdnice编辑器"><span></span><code><span># install.packages("EnsDb.Hsapiens.v86_2.99.0.tar.gz",repos = NULL)</span><br>library(EnsDb.Hsapiens.v86)<br><span>## Making a "short cut"</span><br>edb38 &lt;- EnsDb.Hsapiens.v86<br><span>## print some informations for this package</span><br>edb38<br><span># 基于转录本</span><br>plot_fusion(fusion = my_fusions[[1]],<br>            bamfile = <span>"../5.fusion_from_fq/SRR11178348/Aligned.out.sorted.bam"</span>,<br>            edb = edb38,<br>            non_ucsc = TRUE)<br><span># 基于基因</span><br>plot_fusion(fusion = my_fusions[[1]],<br>            bamfile = <span>"../5.fusion_from_fq/SRR11178348/Aligned.out.sorted.bam"</span>,<br>            edb = edb38,<br>            non_ucsc = TRUE,<br>            reduce_transcripts = TRUE)<br></code></pre><p data-tool="mdnice编辑器">参数说明：</p><pre data-tool="mdnice编辑器"><span></span><code>reduce_transcripts<br>Boolean indicating whether or not to reduce all transcripts into a single transcript <span>for</span> each partner gene.<br></code></pre><p data-tool="mdnice编辑器">基于转录本</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5583333333333333" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykibTUKvTC8EhR23vOLBUw2eVpyXFial05iaLTKHZm58a29WT389VbKXibmg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykibTUKvTC8EhR23vOLBUw2eVpyXFial05iaLTKHZm58a29WT389VbKXibmg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">基于基因</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5546296296296296" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykicsWnOTw4Kx1RQmGQM3PDv4MK9Uqr6uUtNFfd6zgIf2qrsyntAyH2Aw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykicsWnOTw4Kx1RQmGQM3PDv4MK9Uqr6uUtNFfd6zgIf2qrsyntAyH2Aw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">我们这里使用的bam文件为star-fusion直接处理fq文件产生的</p><p data-tool="mdnice编辑器">从大小上可以看出，tar-fusion直接处理fq文件产生的比对上的序列bam和star比对产生的bam文件不一样</p><figure data-tool="mdnice编辑器"><img data-ratio="0.21414141414141413" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyksSuy4zMPGkNksFAmOluawEH3xOrKDfFjeibsxPtV2x0JW0TO8jibxe0Q/640?wx_fmt=png" data-type="png" data-w="990" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyksSuy4zMPGkNksFAmOluawEH3xOrKDfFjeibsxPtV2x0JW0TO8jibxe0Q/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.30462962962962964" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk3KzzFqAMy5zbRjgp1yWakoI4EhCoEc6V9d4KicoFiaepvFqMQiahWEAKA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk3KzzFqAMy5zbRjgp1yWakoI4EhCoEc6V9d4KicoFiaepvFqMQiahWEAKA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">sorted.bam相差了0.4G</p><p data-tool="mdnice编辑器">这里也拿前面star产生的bam文件可视化看看：</p><p data-tool="mdnice编辑器">基于转录本</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5731481481481482" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykR4Zq8uM6jWeEfoJFjKHEkElVgiaXeAdVytk3Oeia8AhJxhLL7B68G8eg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykR4Zq8uM6jWeEfoJFjKHEkElVgiaXeAdVytk3Oeia8AhJxhLL7B68G8eg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">基于基因</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5527777777777778" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyky7ibazmYTenAFicS2XMAp9jM2vdSJticibCTCFr8qpj68P9I01bPOWdnEw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyky7ibazmYTenAFicS2XMAp9jM2vdSJticibCTCFr8qpj68P9I01bPOWdnEw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">其实可以发现，对于我们目前这个E2F3-CDKAL1融合事件来说，并没有区别 57(48, 9)</p><blockquote data-tool="mdnice编辑器"><p>参考：</p><p>Bioconductor包chimeraviz嵌合RNA可视化 （http://www.360doc.com/content/21/0714/12/76149697_986499751.shtml）</p><p>顶部：显示融合的染色体位置。</p><p><strong>支持断裂点</strong>（红色曲线）的discordant reads数10（其中split的6，spanning的4），注释的转录本及read数图。</p></blockquote><p data-tool="mdnice编辑器">简单看看这两个基因相关的报道</p><p data-tool="mdnice编辑器">Medreading：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.43248945147679324" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykTgEibPQODMbCTrM7rwx3ib6IZH9oq9dLNw8JARBtEYo7EvFVQtJxUqQw/640?wx_fmt=png" data-type="png" data-w="948" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykTgEibPQODMbCTrM7rwx3ib6IZH9oq9dLNw8JARBtEYo7EvFVQtJxUqQw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">GeneCards：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.1962962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk919dnibHtkv7qgqTe704W1ERRZwgJH5dI1YicyJeG6SbAl6o8z22zbhw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk919dnibHtkv7qgqTe704W1ERRZwgJH5dI1YicyJeG6SbAl6o8z22zbhw/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.1675925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykBsMAUCiaS2V7J74G6qIREJfuuLz9zMcZQNx7U6VUdk1TZW5Cdiap1LWg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykBsMAUCiaS2V7J74G6qIREJfuuLz9zMcZQNx7U6VUdk1TZW5Cdiap1LWg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">E2F3得分最高的GeneHancer的Gene Targets中存在CDKAL1，可以为后面如果深入研究提供方向思路</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5296296296296297" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykGV3e8yU8Vv2eU0jFLjeUfBbvpzLycicRPW6FTSOe2yN4HXKvoLRtbMQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykGV3e8yU8Vv2eU0jFLjeUfBbvpzLycicRPW6FTSOe2yN4HXKvoLRtbMQ/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247498482&amp;idx=1&amp;sn=cd4817626c98b62fdc64037fab8cc0ef&amp;chksm=fa453fcfcd32b6d9106d639180d03488f89ddd914977ef8e61cabf4421cb8b7cf04f16900c35&amp;scene=21&amp;cur_album_id=1749887454125293572#wechat_redirect" data-linktype="2">gatk找突变</a></h1><blockquote data-tool="mdnice编辑器"><p>如果有读者仔细看过RNA-seq结题报告，就会发现在定量分析以外通常还会有SNP和INDEL分析。目前，对人类测序数据找突变最常用的软件是GATK，除了速度慢以外，没有其他明显缺点（可以通过部署Spark提高速度；当然，如果有钱，可以购买Sentieon，快了15-20倍）。</p><p><strong>和WES不同，RNA-seq对于外显子区域的覆盖度极度不均一，并且由于其数据来自转录本，跨越剪切位点的对比方式也使其与常规全外显子测序大不相同。对于RNA-seq与WES进行变异检测的异同，黄树嘉老师在《RNA-Seq能替代WES完成外显子的变异检测吗？》一文中有详细解释。</strong></p><p>本文后续内容主要来自GATK官网，但是这一部分的分析需要对WES检测变异具有一定的基础。如果跟不上下面的代码，墙裂推荐生信技能树的《<strong>肿瘤外显子专栏</strong>》，对于变异检测进行一个系统的了解之后再来follow。</p></blockquote><p data-tool="mdnice编辑器">这个专栏我曾经跟过：https://www.yuque.com/biotrainee/wes/mt7uba，可惜在不同 vcf 注释结果转 maf的时候发现注释结果有点问题，就没做下去</p><h2 data-tool="mdnice编辑器"><span></span>软件安装以及数据下载：</h2><p data-tool="mdnice编辑器">在语雀专栏中：</p><blockquote data-tool="mdnice编辑器"><p>GATK，这里下载的版本为最新版本 4.1.4.1（截止时间 2019年 12月 31日），方法是：</p><p>先进入 gatk 的官网 https://software.broadinstitute.org/gatk/，点击 Download(注：由于 GATK 官网界面的更新，新版本的界面已经不再如本文描述一样，且 ftp 链接也于 2020年6月1日关闭，所有数据库文件都迁移至谷歌云存储)</p></blockquote><p data-tool="mdnice编辑器">所以有些下载地址和方法存在变化，我这里主要参考我自己当时跟学时的笔记</p><p data-tool="mdnice编辑器"><span>作为一个菜鸟gatk我用的并不多，但每次使用都会阵痛，因为感觉对于一个小白来说入手不是很友好，有很多的依赖数据库文件、很多的参数，之前看到王通老师一篇推文  </span><a href="https://mp.weixin.qq.com/s?__biz=MzI2MjA1MDQxMg==&amp;mid=2649717017&amp;idx=2&amp;sn=cd105069453713454ac7fb006200768e&amp;scene=21#wechat_redirect" data-linktype="2">是时候将GATK彻底埋葬了</a><span> ，当然大佬看重的更多是软件性能和效果，我这等菜鸟还没到达那个层次</span></p><p data-tool="mdnice编辑器">所以这里希望尽量整理清楚一些</p><h3 data-tool="mdnice编辑器"><span></span>官网下载安装<span></span></h3><figure data-tool="mdnice编辑器"><img data-ratio="0.7435185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykZLicetblic1zpVJiaffqqcu82gpMhTEp2gYPGOvMqQtsLTJIA0ciaz9lmw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykZLicetblic1zpVJiaffqqcu82gpMhTEp2gYPGOvMqQtsLTJIA0ciaz9lmw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">https://github.com/broadinstitute/gatk/releases</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5120724346076458" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykeziaj8iaU6xb2zfegbN5lbpNia7ZF3qR03fEb29rpyJibCicY8uEeBqiaA8g/640?wx_fmt=png" data-type="png" data-w="994" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykeziaj8iaU6xb2zfegbN5lbpNia7ZF3qR03fEb29rpyJibCicY8uEeBqiaA8g/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">github release的文件一般是下载龟速，复制链接直接去服务器下更是，稍微好一点可以本地魔法下下来传给服务器，有时也比较慢</p><p data-tool="mdnice编辑器">我这里检索加速下载的工具</p><figure data-tool="mdnice编辑器"><img data-ratio="0.880093131548312" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykPNMf602TdqoQFaiaJK5fpxZCkgciamVtMAdIfrohbDd7HiaB9fNwIMXYg/640?wx_fmt=png" data-type="png" data-w="859" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykPNMf602TdqoQFaiaJK5fpxZCkgciamVtMAdIfrohbDd7HiaB9fNwIMXYg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p>下载速度慢？教你如何高速下载 github release！（https://zhuanlan.zhihu.com/p/521472595）</p></blockquote><p data-tool="mdnice编辑器">把文件地址输入进去，拿到加速链接用IDM下</p><p data-tool="mdnice编辑器">传给服务器，解压打开，可以看到gatk可执行程序</p><figure data-tool="mdnice编辑器"><img data-ratio="0.38866396761133604" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykskLX8jdY93NlpkFNW4b4RmZFrmLgfePmmibEFcqt3ylQeyNpr4vZ4sA/640?wx_fmt=png" data-type="png" data-w="988" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykskLX8jdY93NlpkFNW4b4RmZFrmLgfePmmibEFcqt3ylQeyNpr4vZ4sA/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>$./gatk --version<br>Using GATK jar /home/data/t120455/gatk-4.3.0.0/gatk-package-4.3.0.0-local.jar<br>Running:<br>    java -Dsamjdk.use_async_io_read_samtools=<span>false</span> -Dsamjdk.use_async_io_write_samtools=<span>true</span> -Dsamjdk.use_async_io_write_tribble=<span>false</span> -Dsamjdk.compression_level=2 -jar /home/data/t120455/gatk-4.3.0.0/gatk-package-4.3.0.0-local.jar --version<br>The Genome Analysis Toolkit (GATK) v4.3.0.0<br>HTSJDK Version: 3.0.1<br>Picard Version: 2.27.5<br><br></code></pre><h3 data-tool="mdnice编辑器"><span></span>conda安装<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>$mamba</span> search gatk4 | tail -3<br>gatk4                        4.2.6.1  py36hdfd78af_1  anaconda/cloud/bioconda<br>gatk4                        4.3.0.0  py36hdfd78af_0  anaconda/cloud/bioconda<br>gatk4                        4.4.0.0  py36hdfd78af_0  anaconda/cloud/bioconda<br><br><span>$mamba</span> search gatk | tail -3<br>gatk                             3.8          py36_2  anaconda/cloud/bioconda<br>gatk                             3.8          py36_3  anaconda/cloud/bioconda<br>gatk                             3.8          py36_4  anaconda/cloud/bioconda<br></code></pre><p data-tool="mdnice编辑器">这里可以看到gatk4.4对我们一些常用的包，如samtools和fastp版本进行了要求</p><pre data-tool="mdnice编辑器"><span></span><code>Package       Version  Build           Channel                                                       Size<br>─────────────────────────────────────────────────────────────────────────────────────────────────────────────<br>  Install:<br>─────────────────────────────────────────────────────────────────────────────────────────────────────────────<br><br>  + gatk4       4.4.0.0  py36hdfd78af_0  mirrors.bfsu.edu.cn/anaconda/cloud/bioconda                  364MB<br><br>  Upgrade:<br>─────────────────────────────────────────────────────────────────────────────────────────────────────────────<br><br>  - lcms2          2.12  hddcbb42_0      mirrors.bfsu.edu.cn/anaconda/cloud/conda-forge                  <br>  + lcms2          2.14  h6ed2654_0      mirrors.bfsu.edu.cn/anaconda/cloud/conda-forge               262kB<br>  - libtiff       4.2.0  hf544144_3      mirrors.bfsu.edu.cn/anaconda/cloud/conda-forge                  <br>  + libtiff       4.4.0  h82bc61c_5      mirrors.bfsu.edu.cn/anaconda/cloud/conda-forge               485kB<br>  - openjdk      11.0.1  h516909a_1016   mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge         <br>  + openjdk      17.0.3  h58dac75_5      mirrors.bfsu.edu.cn/anaconda/cloud/conda-forge               169MB<br><br>  Downgrade:<br>─────────────────────────────────────────────────────────────────────────────────────────────────────────────<br><br>  - fastp        0.23.4  hadf994f_2      bioconda                                                        <br>  + fastp        0.23.3  h5f740d0_0      mirrors.bfsu.edu.cn/anaconda/cloud/bioconda                    3MB<br>  - htslib         1.17  h81da01d_2      mirrors.bfsu.edu.cn/anaconda/cloud/bioconda                     <br>  + htslib        1.3.1  h0cf4675_7      mirrors.bfsu.edu.cn/anaconda/cloud/bioconda                    1MB<br>  - libdeflate     1.18  h0b41bf4_0      mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge         <br>  + libdeflate     1.14  h166bdaf_0      mirrors.bfsu.edu.cn/anaconda/cloud/conda-forge                83kB<br>  - samtools       1.17  hd87286a_1      mirrors.bfsu.edu.cn/anaconda/cloud/bioconda                     <br>  + samtools        1.6  hc3601fc_10     mirrors.bfsu.edu.cn/anaconda/cloud/bioconda                 Cached<br><br>  Summary:<br><br>  Install: 1 packages<br>  Upgrade: 3 packages<br>  Downgrade: 4 packages<br><br>  Total download: 538MB<br><br></code></pre><p data-tool="mdnice编辑器">gatk4.3和我们目前的环境（stringtie鉴定lncRNA、star-fusion鉴定融合基因）是很兼容的</p><pre data-tool="mdnice编辑器"><span></span><code> + gatk4  4.3.0.0  py36hdfd78af_0  mirrors.bfsu.edu.cn/anaconda/cloud/bioconda     294MB<br><br>  Summary:<br><br>  Install: 1 packages<br><br>  Total download: 294MB<br><br></code></pre><p data-tool="mdnice编辑器">我们这里也选择下载gatk4.3，和前面官网下载的版本保持一致，随着一些软件和包的坑踩多了我也不喜欢装最新版</p><pre data-tool="mdnice编辑器"><span></span><code>(lncRNA) t120455 00:42:14 ~ <br><span>$which</span> gatk<br>/home/data/t120455/miniconda3/envs/lncRNA/bin/gatk<br>(lncRNA) t120455 00:42:17 ~ <br><span>$gatk</span> --version<br>Using GATK jar /home/data/t120455/miniconda3/envs/lncRNA/share/gatk4-4.3.0.0-0/gatk-package-4.3.0.0-local.jar<br>Running:<br>    java -Dsamjdk.use_async_io_read_samtools=<span>false</span> -Dsamjdk.use_async_io_write_samtools=<span>true</span> -Dsamjdk.use_async_io_write_tribble=<span>false</span> -Dsamjdk.compression_level=2 -jar /home/data/t120455/miniconda3/envs/lncRNA/share/gatk4-4.3.0.0-0/gatk-package-4.3.0.0-local.jar --version<br>The Genome Analysis Toolkit (GATK) v4.3.0.0<br>HTSJDK Version: 3.0.1<br>Picard Version: 2.27.5<br></code></pre><p data-tool="mdnice编辑器">和官网安装的是一样的，其实我最希望conda安装帮我解决的是相关依赖数据库文件</p><h2 data-tool="mdnice编辑器"><span></span>数据库文件下载</h2><p data-tool="mdnice编辑器">我们这里先不着急往后走本项目gatk寻找突变</p><p data-tool="mdnice编辑器">我们着重探索gatk数据库文件下载的最佳路径</p><p data-tool="mdnice编辑器">所以这里我们根据语雀肿瘤外显子专栏测试下载提到的所需数据库文件：</p><p data-tool="mdnice编辑器">https://www.yuque.com/biotrainee/wes/mt7uba</p><pre data-tool="mdnice编辑器"><span></span><code><span>## gatk</span><br>nohup wget -c ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/hg38/dbsnp_146.hg38.vcf.gz &amp; <br>nohup wget -c ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/hg38/dbsnp_146.hg38.vcf.gz.tbi &amp; <br>nohup wget -c ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/hg38/Mills_and_1000G_gold_standard.indels.hg38.vcf.gz &amp; <br>nohup wget -c ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/hg38/Mills_and_1000G_gold_standard.indels.hg38.vcf.gz.tbi &amp; <br>nohup wget -c ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/hg38/Homo_sapiens_assembly38.fasta.gz &amp; <br>nohup wget -c ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/hg38/Homo_sapiens_assembly38.fasta.fai &amp; <br>nohup wget -c ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/hg38/Homo_sapiens_assembly38.dict &amp; <br>nohup wget -c ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/hg38/1000G_phase1.snps.high_confidence.hg38.vcf.gz &amp; <br>nohup wget -c ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/hg38/1000G_phase1.snps.high_confidence.hg38.vcf.gz.tbi &amp; <br>nohup wget -c ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/funcotator/funcotator_dataSources.v1.6.20190124s.tar.gz &amp;<br></code></pre><p data-tool="mdnice编辑器">这里给的是ftp server文件路径，不知道还能不能用</p><p data-tool="mdnice编辑器">Resource bundle(https://gatk.broadinstitute.org/hc/en-us/articles/360035890811-Resource-bundle)</p><p data-tool="mdnice编辑器">在官网这篇关于数据库文件下载的文章中提到：</p><figure data-tool="mdnice编辑器"><img data-ratio="1.0845771144278606" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk6Kibcskwypc3dw4knJNnzz3xOI9Zsng8gP3icCAVbLPdrXpOMIuXVbjA/640?wx_fmt=png" data-type="png" data-w="804" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk6Kibcskwypc3dw4knJNnzz3xOI9Zsng8gP3icCAVbLPdrXpOMIuXVbjA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">FTP 服务器访问将很快被禁用，并且使用 FTP 文件路径的代码必须在 2020 年 6 月 1 日之前使用 Google Bucket 文件路径进行更新。</p><p data-tool="mdnice编辑器">FTP 服务器适用于希望下载文件并在本地运行的人们。然而，FTP 是 Broad Institute 本地的（没有镜像），它对并发下载有严格的限制，并且一些国家的用户报告由于防火墙等原因难以访问它。由于这些（和其他）原因，FTP 服务器访问将于 2020 年 6 月 1 日之前被禁用。</p><p data-tool="mdnice编辑器">此外还有两种assess the resource bundle的方法：Google Cloud bucket和Cromwell on Azure</p><p data-tool="mdnice编辑器">下面以1000G_phase1.snps.high_confidence.hg38.vcf.gz文件（1.8G）为例进行下载测试，请注意三个方法并不是所有文件都包含，详细内容参考上面的Resource bundle(https://gatk.broadinstitute.org/hc/en-us/articles/360035890811-Resource-bundle)，</p><ul data-tool="mdnice编辑器"><li><section>ftp</section></li></ul><p data-tool="mdnice编辑器">ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/hg38/1000G_phase1.snps.high_confidence.hg38.vcf.gz</p><p data-tool="mdnice编辑器">看起来还能用</p><p data-tool="mdnice编辑器">wget:</p><pre data-tool="mdnice编辑器"><span></span><code><span>$wget</span> -c ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/hg38/1000G_phase1.snps.high_confidence.hg38.vcf.gz<br>--2023-09-01 01:20:29--  ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/hg38/1000G_phase1.snps.high_confidence.hg38.vcf.gz<br>           =&gt; ‘1000G_phase1.snps.high_confidence.hg38.vcf.gz’<br>Resolving ftp.broadinstitute.org (ftp.broadinstitute.org)... 69.173.70.223<br>Connecting to ftp.broadinstitute.org (ftp.broadinstitute.org)|69.173.70.223|:21... connected.<br>Logging <span>in</span> as gsapubftp-anonymous ... Logged <span>in</span>!<br>==&gt; SYST ... <span>done</span>.    ==&gt; PWD ... <span>done</span>.<br>==&gt; TYPE I ... <span>done</span>.  ==&gt; CWD (1) /bundle/hg38 ... <span>done</span>.<br>==&gt; SIZE 1000G_phase1.snps.high_confidence.hg38.vcf.gz ... 1888262073<br>==&gt; PASV ... <span>done</span>.    ==&gt; RETR 1000G_phase1.snps.high_confidence.hg38.vcf.gz ... <span>done</span>.<br>Length: 1888262073 (1.8G) (unauthoritative)<br><br>hg38.vcf.gz                 6%[=&gt;                                    ] 121.25M   335KB/s    eta 73m 11s<br></code></pre><p data-tool="mdnice编辑器">axel -n20:</p><figure data-tool="mdnice编辑器"><img data-ratio="0.7338282078472959" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykJLcN1c4mx9LmCJRLgXOoswVEtSkibiaYx7oYqMvMQGSAoyw919f5jLJg/640?wx_fmt=png" data-type="png" data-w="943" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykJLcN1c4mx9LmCJRLgXOoswVEtSkibiaYx7oYqMvMQGSAoyw919f5jLJg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">速度还是比较客观</p><ul data-tool="mdnice编辑器"><li><section>Google Buckets</section></li></ul><p data-tool="mdnice编辑器">https://console.cloud.google.com/storage/browser/genomics-public-data/resources/broad/hg38/v0</p><p data-tool="mdnice编辑器">https://console.cloud.google.com/storage/browser/_details/genomics-public-data/resources/broad/hg38/v0/1000G_phase1.snps.high_confidence.hg38.vcf.gz</p><pre data-tool="mdnice编辑器"><span></span><code><span>$wget</span> -c https://console.cloud.google.com/storage/browser/_details/genomics-public-data/resources/broad/hg38/v0/1000G_phase1.snps.high_confidence.hg38.vcf.gz<br>--2023-09-01 01:30:00--  https://console.cloud.google.com/storage/browser/_details/genomics-public-data/resources/broad/hg38/v0/1000G_phase1.snps.high_confidence.hg38.vcf.gz<br>Resolving console.cloud.google.com (console.cloud.google.com)... 142.251.42.238<br>Connecting to console.cloud.google.com (console.cloud.google.com)|142.251.42.238|:443... connected.<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>$axel</span> -n20 https://console.cloud.google.com/storage/browser/_details/genomics-public-data/resources/broad/hg38/v0/1000G_phase1.snps.high_confidence.hg38.vcf.gz<br>Initializing download: https://console.cloud.google.com/storage/browser/_details/genomics-public-data/resources/broad/hg38/v0/1000G_phase1.snps.high_confidence.hg38.vcf.gz<br></code></pre><p data-tool="mdnice编辑器">都连不上</p><p data-tool="mdnice编辑器">gsutil：</p><p data-tool="mdnice编辑器">之前我下载GTEx的数据库文件时用谷歌云推荐的gsutil，速度还行</p><p data-tool="mdnice编辑器">下载gsutil</p><blockquote data-tool="mdnice编辑器"><p>参考：</p><p>gsutil 安装及使用（https://www.cnblogs.com/biostat-yu/p/15770784.html）</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-367.0.0-linux-x86_64.tar.gz<br>tar zxvf google-cloud-sdk-367.0.0-linux-x86_64.tar.gz<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.12654614652711704" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykD1kYcCyHrKEEn8zfYGNcjU63YxIlTRXHAPr9rPxiaVusPYfwjQNAY9A/640?wx_fmt=png" data-type="png" data-w="1051" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykD1kYcCyHrKEEn8zfYGNcjU63YxIlTRXHAPr9rPxiaVusPYfwjQNAY9A/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>bash install.sh <br></code></pre><p data-tool="mdnice编辑器">根据提示信息，安装程序修改了我们的.bashrc配置文件</p><p data-tool="mdnice编辑器">我们也把gsutil可执行程序目录路径放到环境变量中</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5398148148148149" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyksPN5VO3o1cKvlSZtazFEE6FVHm0KhHWfrB6Uqo339DRafd5u4wF9Nw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyksPN5VO3o1cKvlSZtazFEE6FVHm0KhHWfrB6Uqo339DRafd5u4wF9Nw/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.30462962962962964" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykHS4ZGbjBgO260ibVk1sMOdaibiazU6U3iaWec39D5pIgm4YqgMXiaASVVpA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykHS4ZGbjBgO260ibVk1sMOdaibiazU6U3iaWec39D5pIgm4YqgMXiaASVVpA/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>$gsutil</span> cp -r gs://genomics-public-data/resources/broad/hg38/v0/1000G_phase1.snps.high_confidence.hg38.vcf.gz ./<br>Copying gs://genomics-public-data/resources/broad/hg38/v0/1000G_phase1.snps.high_confidence.hg38.vcf.gz...<br>==&gt; NOTE: You are downloading one or more large file(s), <span>which</span> would          <br>run significantly faster <span>if</span> you enabled sliced object downloads. This<br>feature is enabled by default but requires that compiled crcmod be<br>installed (see <span>"gsutil help crcmod"</span>).<br><br>/ [0 files][409.4 MiB/  1.8 GiB]   24.2 MiB/s<br></code></pre><p data-tool="mdnice编辑器">需要注意这里gsutil下载必须给定输出路径</p><p data-tool="mdnice编辑器">gsutil下载google buckets速度是axel -n20下载ftp速度的两倍</p><ul data-tool="mdnice编辑器"><li><section>Azure</section></li></ul><blockquote data-tool="mdnice编辑器"><p>参考：</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247515027&amp;idx=1&amp;sn=04a9355fee599d6cddf32f7f4c42736e&amp;scene=21#wechat_redirect" data-linktype="2">如何下载GATK resource bundle</a></p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="0.5859296482412061" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykQYkesgA30GruAUbt8C8l7HhnyjAFhByicJJdceNRBgW4BLP5bJeBuWw/640?wx_fmt=png" data-type="png" data-w="995" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykQYkesgA30GruAUbt8C8l7HhnyjAFhByicJJdceNRBgW4BLP5bJeBuWw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">下载安装azcopy，需要注意一些推文中的代码如果直接复制粘贴使用会报错，原因是格式问题，需要注意，这在我学习不同项目时遇到过</p><p data-tool="mdnice编辑器">Azure：</p><p data-tool="mdnice编辑器">https://learn.microsoft.com/en-us/azure/open-datasets/dataset-gatk-resource-bundle</p><p data-tool="mdnice编辑器">这个页面很清爽，方便检索，还有文件的介绍信息</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5092592592592593" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykU2K4espZJdIwrwBIZ7lTvic6l8Pf6TXEyfPC0Libf8o5M5QArOLvKhQw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykU2K4espZJdIwrwBIZ7lTvic6l8Pf6TXEyfPC0Libf8o5M5QArOLvKhQw/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.8706015891032917" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykQficZZ7SaBtDRBkrEW8l2nAXBktFiaQsvp8xrs1CykCCNxYcoEUESyyA/640?wx_fmt=png" data-type="png" data-w="881" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykQficZZ7SaBtDRBkrEW8l2nAXBktFiaQsvp8xrs1CykCCNxYcoEUESyyA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">本质上是ftp://ftp.1000genomes.ebi.ac.uk/vol1/ftp/的镜像，我之前用过1000G phase3做LD panel</p><p data-tool="mdnice编辑器">把ftp换成https协议http://ftp.1000genomes.ebi.ac.uk/vol1/ftp/就可以访问了</p><p data-tool="mdnice编辑器">安装参考推文的方法将地址和token值拼接起来下载</p><p data-tool="mdnice编辑器">对于1000G的文件，我这里测试West US 2的地址不行，West Central US可以</p><p data-tool="mdnice编辑器">但是我没找到如何具体下载某个文件，比如1000G_phase1.snps.high_confidence.hg38.vcf.gz</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5518518518518518" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykFbXTppLBfFtHep07Fucj30Udibg6mhYricc2VYrBy4WIggZIPRPRUm9A/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykFbXTppLBfFtHep07Fucj30Udibg6mhYricc2VYrBy4WIggZIPRPRUm9A/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">介绍页面说“This dataset contains approximately 815 TB of data and is updated daily.”</p><p data-tool="mdnice编辑器">有点害怕给服务器搞崩了，这里连上后下一会儿就给它取消了</p><p data-tool="mdnice编辑器">简单看一下下载下来的目录</p><pre data-tool="mdnice编辑器"><span></span><code>t120455 19:04:50 ~/refdata/dataset/phase1 <br><span>$tree</span><br>.<br>├── analysis_results<br>│   ├── integrated_call_sets<br>│   └── shapeit2_phased_haplotypes<br>│       └── ALL.chr9.SHAPEIT2_integrated_phase1_v3.20101123.snps_indels_svs.genotypes.all.vcf.gz.tbi<br>└── technical<br>    └── other_exome_alignments.alignment_indices<br><br></code></pre><p data-tool="mdnice编辑器">没找到如何具体下载某个文件，所以这个方法目前对我来说并不适用，希望知道的同学老师可以在评论区告诉我【Q1】</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">根据<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247498482&amp;idx=1&amp;sn=cd4817626c98b62fdc64037fab8cc0ef&amp;chksm=fa453fcfcd32b6d9106d639180d03488f89ddd914977ef8e61cabf4421cb8b7cf04f16900c35&amp;scene=21&amp;cur_album_id=1749887454125293572#wechat_redirect" data-linktype="2">gatk找突变</a>我们提前下载好所需的数据库文件，经过上面的测试，我们使用gsutil进行下载</p><p data-tool="mdnice编辑器">但有时也很慢，这就具体情况具体选择方法了</p><figure data-tool="mdnice编辑器"><img data-ratio="0.7620370370370371" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk6pK2qibOD94rjaHEOdLvxug0hyLngjPCkFpnX7pwsCjaPTzZ7UQw7UQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk6pK2qibOD94rjaHEOdLvxug0hyLngjPCkFpnX7pwsCjaPTzZ7UQw7UQ/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.7574074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykNiaKqf9hwLXVI3HQ1gWTjhqj9zehwWEibaeCibsjZpX2chWcnl73hHFdg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykNiaKqf9hwLXVI3HQ1gWTjhqj9zehwWEibaeCibsjZpX2chWcnl73hHFdg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">需要注意的是dbsnp文件，参考语雀专栏评论区：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.954653937947494" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykKVP1WeEmvMWb00XxJsYRKRyQVxKLAQZaPPQaVEuv2icdVRVLlqLtlUg/640?wx_fmt=png" data-type="png" data-w="838" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykKVP1WeEmvMWb00XxJsYRKRyQVxKLAQZaPPQaVEuv2icdVRVLlqLtlUg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">但是可能额因为vcf文件较大（超过10G），gsutil返回了这样的提示信息：</p><pre data-tool="mdnice编辑器"><span></span><code><span>$gsutil</span> cp -r gs://genomics-public-data/resources/broad/hg38/v0/Homo_sapiens_assembly38.dbsnp138.vcf ./<br>Copying gs://genomics-public-data/resources/broad/hg38/v0/Homo_sapiens_assembly38.dbsnp138.vcf...<br>==&gt; NOTE: You are downloading one or more large file(s), <span>which</span> would          <br>run significantly faster <span>if</span> you enabled sliced object downloads. This<br>feature is enabled by default but requires that compiled crcmod be<br>installed (see <span>"gsutil help crcmod"</span>).<br><br>CommandException: <br>Downloading this composite object requires integrity checking with CRC32c,<br>but your crcmod installation isn<span>'t using the module'</span>s C extension, so the<br><span>hash</span> computation will likely throttle download performance. For <span>help</span><br>installing the extension, please see <span>"gsutil help crcmod"</span>.<br><br>To download regardless of crcmod performance or to skip slow integrity<br>checks, see the <span>"check_hashes"</span> option <span>in</span> your boto config file.<br><br>NOTE: It is strongly recommended that you not <span>disable</span> integrity checks. Doing so<br>could allow data corruption to go undetected during uploading/downloading.<br><br></code></pre><p data-tool="mdnice编辑器">改用axel下载ftp</p><pre data-tool="mdnice编辑器"><span></span><code>Downloaded 3.17687 Gigabyte(s) <span>in</span> 38:32 minute(s). (1440.56 KB/s)<br></code></pre><p data-tool="mdnice编辑器">interval_list</p><pre data-tool="mdnice编辑器"><span></span><code>(lncRNA) t120455 00:50:30 ~/refdata/gatk_resource_bundle <br><span>$gsutil</span> cp -r gs://genomics-public-data/resources/broad/hg38/v0/wgs_calling_regions.hg38.interval_list ./<br></code></pre><p data-tool="mdnice编辑器">hapmap</p><pre data-tool="mdnice编辑器"><span></span><code>gsutil cp -r gs://gcp-public-data--broad-references/hg38/v0/hapmap_3.3.hg38.vcf.gz ./<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>gsutil cp -r gs://gcp-public-data--broad-references/hg38/v0/1000G_omni2.5.hg38.vcf.gz ./<br></code></pre><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">下面的处理我们仍以第一个样本SRR11178348为例进行处理，并使用conda下载下来的gatk4</p><p data-tool="mdnice编辑器">区别于前面的工作目录命令脚本一般在第一层fusion_and_mut下，这里后面的脚本都统一放在了第二层7.gatk_mut下</p><h2 data-tool="mdnice编辑器"><span></span>1、向bam文件添加头文件并去重</h2><pre data-tool="mdnice编辑器"><span></span><code>gatk AddOrReplaceReadGroups \<br>-I ../4.mapping/SRR11178348Aligned.sortedByCoord.out.bam \<br>-O ./SRR11178348_rg_added_sorted.bam \<br>-ID SRR11178348 \<br>-LB rna \<br>-PL illumina \<br>-PU hiseq \<br>-SM SRR11178348 &amp;&amp; \<br>gatk MarkDuplicates \<br>-I ./SRR11178348_rg_added_sorted.bam \<br>-O ./SRR11178348_dedup.bam  \<br>-M ./SRR11178348_dedup.metrics \<br>--CREATE_INDEX <span>true</span> \<br>--VALIDATION_STRINGENCY SILENT<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.2581648522550544" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykkfl2w7Cu37xqDV028RYlsNia7u4mBibs7KI10hS9EWm9FewvKPaZ2uwQ/640?wx_fmt=png" data-type="png" data-w="643" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykkfl2w7Cu37xqDV028RYlsNia7u4mBibs7KI10hS9EWm9FewvKPaZ2uwQ/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>2、转换MAPQ</h2><pre data-tool="mdnice编辑器"><span></span><code>gatk SplitNCigarReads \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-I ./SRR11178348_dedup.bam \<br>-O ./SRR11178348_dedup_split.bam<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>A USER ERROR has occurred: Fasta index file file:///home/data/t120455/refdata/Homo_sapiens.GRCh38.dna_sm<br>.primary_assembly.fa.fai <span>for</span> reference file:///home/data/t120455/refdata/Homo_sapiens.GRCh38.dna_sm.prim<br>ary_assembly.fa does not exist. Please see http://gatkforums.broadinstitute.org/discussion/1601/how-can-<br>i-prepare<span>-a</span>-fasta-file-to-use-as-reference <span>for</span> <span>help</span> creating it.<br><br></code></pre><blockquote data-tool="mdnice编辑器"><p>参考：</p><p>SAM文件与Samtools（http://47.57.89.98/detail/85/）</p><figure><img data-ratio="0.2597864768683274" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykAyZmxVuHyYNia19NRxlUAlxauAGky8xRCibqRARiasTicfABDmm0gp8qXw/640?wx_fmt=png" data-type="png" data-w="843" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykAyZmxVuHyYNia19NRxlUAlxauAGky8xRCibqRARiasTicfABDmm0gp8qXw/640?wx_fmt=png"></figure></blockquote><p data-tool="mdnice编辑器">手动创建索引：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.7159841479524438" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykjhYLy4BpicE6nRJWQeSPicd7ybqPJxEicvYxWAI8F3cP5FOCVNnCIIujQ/640?wx_fmt=png" data-type="png" data-w="757" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykjhYLy4BpicE6nRJWQeSPicd7ybqPJxEicvYxWAI8F3cP5FOCVNnCIIujQ/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>A USER ERROR has occurred: Fasta dict file file:///home/data/t120455/refdata/Homo_sapiens.GRCh38.dna_sm.<br>primary_assembly.dict <span>for</span> reference file:///home/data/t120455/refdata/Homo_sapiens.GRCh38.dna_sm.primary<br>_assembly.fa does not exist. Please see http://gatkforums.broadinstitute.org/discussion/1601/how-can-i-p<br>repare<span>-a</span>-fasta-file-to-use-as-reference <span>for</span> <span>help</span> creating it.<br><br></code></pre><p data-tool="mdnice编辑器">这个dict文件我在gatk的数据库文件里见过</p><figure data-tool="mdnice编辑器"><img data-ratio="0.48983050847457626" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk6WUI2Yzn7bndZ64HPeCyAl3KiaZCvvWQL7ib6ibpEjVB6GQobU6qOOCiag/640?wx_fmt=png" data-type="png" data-w="590" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk6WUI2Yzn7bndZ64HPeCyAl3KiaZCvvWQL7ib6ibpEjVB6GQobU6qOOCiag/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">.fasta文件的.dict文件通常是由Picard工具包中的CreateSequenceDictionary命令创建的，用于描述.fasta文件的参考序列</p><p data-tool="mdnice编辑器">若直接改用gatk提供的参考基因组相关数据库文件，会出现这个报错：</p><pre data-tool="mdnice编辑器"><span></span><code> A USER ERROR has occurred: Input files reference and reads have incompatible contigs: No overlapping con tigs found.<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>reference contigs = [chr1, chr2, chr3, chr4, chr5, chr6, chr7, chr8, chr9, chr10, chr11, chr12, chr13, chr14, chr15, chr16, chr17, chr18, chr19, chr20, chr21, chr22, chrX, chrY, chrM, chr1_KI270706v1_random, chr1_KI270707v1_random, chr1_KI270708v1_random, chr1_KI270709v1_random, chr1_KI270710v1_random, chr1_KI270711v1_random, chr1_KI270712v1_random, chr1_KI270713v1_random, chr1_KI270714v1_random, chr2_KI270715v<br>1_random, chr2_KI270716v1_random, chr3_GL000221v1_random, ...]<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code> reads contigs = [1, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 2, 20, 21, 22, 3, 4, 5, 6, 7, 8, 9, MT, X, Y, KI270728.1, KI270727.1, KI270442.1, KI270729.1, GL000225.1, KI270743.1, ...]GL000008.2, GL000009.2, KI270747.1, KI270722.1, GL000194.1, KI270742.1, GL000205.2,<br></code></pre><p data-tool="mdnice编辑器">这个错误通常是因为参考序列文件和特征文件之间的染色体或序列名称不匹配导致的。当使用GATK等工具时，要求参考序列文件和特征文件（如vcf、bam文件）中的染色体/序列名称必须对应一致。</p><p data-tool="mdnice编辑器">手动验证查看bam文件contig名称</p><pre data-tool="mdnice编辑器"><span></span><code><span>$samtools</span> view SRR11178348_dedup.bam | awk <span>'{print $3}'</span> | sort | uniq -c<br>6972121 1<br>2423838 10<br>3820170 11<br>4325551 12<br>1568207 13<br>3301455 14<br>2278217 15<br>3891309 16<br>4602996 17<br> 923565 18<br>4794034 19<br>5185623 2<br>2201475 20<br>3142953 21<br>1444028 22<br>3804606 3<br>2237300 4<br>2936031 5<br>4920276 6<br>4195418 7<br>2216511 8<br>2727988 9<br>   1944 GL000008.2<br>   3241 GL000009.2<br>   7321 GL000194.1<br>  14009 GL000195.1<br>   6639 GL000205.2<br>      2 GL000208.1<br>      6 GL000213.1<br>   5434 GL000214.1<br>     10 GL000216.2<br>   3730 GL000218.1<br>   6888 GL000219.1<br>1049361 GL000220.1<br>   2682 GL000221.1<br>   4577 GL000224.1<br>     88 GL000225.1<br>      2 KI270330.1<br>      2 KI270382.1<br>      2 KI270429.1<br>     88 KI270438.1<br>    134 KI270442.1<br>   7260 KI270466.1<br>  27229 KI270467.1<br>      2 KI270538.1<br>      8 KI270582.1<br>      2 KI270588.1<br>     20 KI270589.1<br>     34 KI270591.1<br>   2645 KI270706.1<br>     60 KI270707.1<br>    144 KI270708.1<br>     34 KI270709.1<br>  13411 KI270711.1<br>    118 KI270712.1<br>  10502 KI270713.1<br>     28 KI270714.1<br>     16 KI270715.1<br>    598 KI270716.1<br>   3784 KI270717.1<br>    176 KI270718.1<br>    152 KI270719.1<br>    420 KI270720.1<br>   1146 KI270721.1<br>    122 KI270722.1<br>     34 KI270725.1<br>     54 KI270726.1<br>     58 KI270727.1<br>    658 KI270728.1<br>      2 KI270729.1<br>    536 KI270731.1<br>      4 KI270732.1<br>1056468 KI270733.1<br>  10292 KI270734.1<br>      2 KI270735.1<br>      8 KI270736.1<br>   5126 KI270741.1<br>   4922 KI270742.1<br>    836 KI270743.1<br>   5388 KI270744.1<br>   2738 KI270745.1<br>    396 KI270746.1<br>    134 KI270747.1<br>     90 KI270748.1<br>     10 KI270749.1<br>     20 KI270750.1<br>   5306 KI270751.1<br>     64 KI270752.1<br>     16 KI270754.1<br> 373270 MT<br>1516002 X<br> 174341 Y<br><br></code></pre><blockquote data-tool="mdnice编辑器"><p>参考：</p><p>Errors about input files having missing or incompatible contigs （https://gatk.broadinstitute.org/hc/en-us/articles/360035891131-Errors-about-input-files-having-missing-or-incompatible-contigs）</p><p>GATK Input files reference and features have incompatible contigs: No overlapping contigs found. （https://www.biostars.org/p/9475152/）</p></blockquote><p data-tool="mdnice编辑器">在star比对的时候我们使用的是来自ENSEMBL的Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa</p><p data-tool="mdnice编辑器">所以这里我们手动创建这个.dict文件，而gatk4相较于gatk已经整合了Picard工具包，所以这里我们直接用gatk4创建：</p><pre data-tool="mdnice编辑器"><span></span><code>gatk CreateSequenceDictionary -R Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa -O Homo_sapiens.GRCh38.dna_sm.primary_assembly.dict<br></code></pre><p data-tool="mdnice编辑器">再次执行，结果文件：</p><pre data-tool="mdnice编辑器"><span></span><code>gatk SplitNCigarReads \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-I ./SRR11178348_dedup.bam \<br>-O ./SRR11178348_dedup_split.bam<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.18874172185430463" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk1x3f4EIBL06VG8U257tuEXLPA8yFlstRRWf9ia4Jia0QqvkvibmvuHVmA/640?wx_fmt=png" data-type="png" data-w="604" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLyk1x3f4EIBL06VG8U257tuEXLPA8yFlstRRWf9ia4Jia0QqvkvibmvuHVmA/640?wx_fmt=png"><figcaption>img</figcaption></figure><h2 data-tool="mdnice编辑器"><span></span>3、进行碱基质量重校正</h2><p data-tool="mdnice编辑器">第一次尝试运行代码</p><pre data-tool="mdnice编辑器"><span></span><code>gatk BaseRecalibrator \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-I ./SRR11178348_dedup_split.bam \<br>--known-sites ~/refdata/gatk_resource_bundle/1000G_phase1.snps.high_confidence.hg38.vcf \<br>--known-sites ~/refdata/gatk_resource_bundle/dbsnp_146.hg38.vcf \<br>--known-sites ~/refdata/gatk_resource_bundle/Mills_and_1000G_gold_standard.indels.hg38.vcf \<br>-O ./SRR11178348_recal_data.table &amp;&amp; \<br>gatk ApplyBQSR \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-I ./SRR11178348_dedup_split.bam \<br>-bqsr ./SRR11178348_recal_data.table \<br>-O ./SRR11178348_BQSR.bam<br><br></code></pre><p data-tool="mdnice编辑器">又出现这个报错：</p><pre data-tool="mdnice编辑器"><span></span><code>A USER ERROR has occurred: Input files reference and features have incompatible contigs: No overlapping contigs found.<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>reference contigs = [1, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 2, 20, 21, 22, 3, 4, 5, 6, 7, 8, 9, MT, X, Y, KI270728.1, KI270727.1, KI270442.1, KI270729.1, GL000225.1, KI270743.1, GL000008.2, GL000009.2, KI270747.1, KI270722.1, GL000194.1, KI270742.1, GL000205.2, GL000195.1, KI270736.1, KI270733.1, GL000224.1, GL000219.1, KI270719.1, GL000216.2, KI2707...]<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>features contigs = [chr1, chr2, chr3, chr4, chr5, chr6, chr7, chr8, chr9, chr10, chr11, chr12, chr13, chr14, chr15, chr16, chr17, chr18, chr19, chr20, chr21, chr22, chrX, chrY, chrM, chr1_KI270706v1_random, chr1_KI270707v1_random, chr1_KI270708v1_random, chr1_KI270709v1_random, chr1_KI270710v1_random, chr1_KI270711v1_random, chr1_KI270712v1_random, chr1_KI270713v1_random, chr1_KI<br></code></pre><p data-tool="mdnice编辑器">奇了怪了bam文件里的contigs名称一路走来怎么变了？并且和从gatk下载的fa一样，我最后用的参考基因组明明是一开始从ENSEMBL下载的啊</p><p data-tool="mdnice编辑器">手动验证查看bam文件contig名称</p><pre data-tool="mdnice编辑器"><span></span><code><span>$samtools</span> view SRR11178348_dedup_split.bam | awk <span>'{print $3}'</span> | sort | uniq -c<br>9234929 1<br>3211308 10<br>5379127 11<br>6319267 12<br>2082983 13<br>4311425 14<br>3127047 15<br>5295168 16<br>6460004 17<br>1236139 18<br>7438580 19<br>6976103 2<br>2960933 20<br>3395504 21<br>1944173 22<br>5108098 3<br>2912255 4<br>3882250 5<br>6238225 6<br>5590652 7<br>2958436 8<br>3627543 9<br>   1951 GL000008.2<br>   3278 GL000009.2<br>   7339 GL000194.1<br>  14424 GL000195.1<br>   6775 GL000205.2<br>      2 GL000208.1<br>      6 GL000213.1<br>   5499 GL000214.1<br>     10 GL000216.2<br>   3761 GL000218.1<br>   7200 GL000219.1<br>1059917 GL000220.1<br>   2721 GL000221.1<br>   4602 GL000224.1<br>    107 GL000225.1<br>      2 KI270330.1<br>      2 KI270382.1<br>      2 KI270429.1<br>     88 KI270438.1<br>    145 KI270442.1<br>   7378 KI270466.1<br>  30200 KI270467.1<br>      2 KI270538.1<br>      8 KI270582.1<br>      2 KI270588.1<br>     20 KI270589.1<br>     42 KI270591.1<br>   2681 KI270706.1<br>     60 KI270707.1<br>    144 KI270708.1<br>     34 KI270709.1<br>  15846 KI270711.1<br>    118 KI270712.1<br>  10539 KI270713.1<br>     28 KI270714.1<br>     16 KI270715.1<br>    611 KI270716.1<br>   3784 KI270717.1<br>    176 KI270718.1<br>    152 KI270719.1<br>    472 KI270720.1<br>   1146 KI270721.1<br>    122 KI270722.1<br>     34 KI270725.1<br>     54 KI270726.1<br>     58 KI270727.1<br>    658 KI270728.1<br>      2 KI270729.1<br>    536 KI270731.1<br>      4 KI270732.1<br>1062111 KI270733.1<br>  10872 KI270734.1<br>      2 KI270735.1<br>      8 KI270736.1<br>   5203 KI270741.1<br>   5001 KI270742.1<br>    836 KI270743.1<br>   5449 KI270744.1<br>   2791 KI270745.1<br>    396 KI270746.1<br>    146 KI270747.1<br>     90 KI270748.1<br>     10 KI270749.1<br>     25 KI270750.1<br>   5395 KI270751.1<br>    112 KI270752.1<br>     16 KI270754.1<br> 373567 MT<br>2102382 X<br> 195505 Y<br><br></code></pre><p data-tool="mdnice编辑器">怎么和报错说的features contigs不一样？</p><p data-tool="mdnice编辑器">哦，区别features于reads，这里的feature应该是指的是 <code>--known-sites</code> 参数指定的vcf文件，手动按照上面的方式查看contig name，证实想法，这也难怪，vcf文件都直接是gatk提供的</p><p data-tool="mdnice编辑器">而今迈步从头越？我可是从star比对开始就用的从ENSEMBL下载的参考基因组，其实理论上一开始就用的gatk提供的参考基因组，后续使用gatk做其他分析就不会出现这些情况</p><p data-tool="mdnice编辑器">能不能手动修改从gatk下载的数据库vcf文件的contigs名称？按理来说写脚本可以</p><p data-tool="mdnice编辑器">问问chatgpt：</p><blockquote data-tool="mdnice编辑器"><p>是的，你可以使用一些软件来直接修改VCF文件中的contig名称。以下是一些常用的工具和软件：</p><ol><li><section><p>BCFtools：BCFtools是一个流行的工具集，可用于操作和处理VCF和BCF文件。使用 <code>bcftools annotate</code>命令可以修改VCF文件的contig名称。</p><pre><span></span><code>bcftools annotate --rename-chrs &lt;contig_mapping.txt&gt; input.vcf -o output.vcf<br></code></pre><p>其中，<code>&lt;contig_mapping.txt&gt;</code>是一个包含旧名称和新名称对应关系的文本文件。你需要提供一个符合格式要求的映射文件，将旧的contig名称映射到新的contig名称。</p></section></li><li><section><p>Picard工具包：Picard工具包中的 <code>UpdateVcfSequenceDictionary</code>命令可以用于更新VCF文件中的contig信息。</p><pre><span></span><code>java -jar picard.jar UpdateVcfSequenceDictionary R=reference.fasta I=input.vcf O=output.vcf<br></code></pre><p>在命令中，<code>reference.fasta</code>是与VCF文件关联的参考序列文件，<code>input.vcf</code>是输入的VCF文件，<code>output.vcf</code>是生成的包含更新contig信息的VCF文件。</p></section></li><li><section><p>VCFtools：VCFtools是一个广泛使用的VCF文件处理工具。你可以使用 <code>vcf-annotate</code>命令来修改VCF文件中的contig名称。</p><pre><span></span><code>vcf-annotate --rename-chr &lt;contig_mapping.txt&gt; input.vcf &gt; output.vcf<br></code></pre><p>同样，你需要提供一个包含旧名称和新名称对应关系的映射文件 <code>&lt;contig_mapping.txt&gt;</code>。</p></section></li></ol><p>请注意，在使用任何软件修改VCF文件之前，务必备份原始文件，以防出现意外情况。另外，确保映射文件中的名称对应正确，以避免错误的重命名。</p></blockquote><p data-tool="mdnice编辑器">发现有现成的工具不用自己写脚本</p><p data-tool="mdnice编辑器">同时参考：</p><blockquote data-tool="mdnice编辑器"><p>修改vcf文件中的染色体名（https://blog.csdn.net/liangbilin/article/details/108991510）</p></blockquote><p data-tool="mdnice编辑器">我们这里使用bcftools来进行修改：</p><pre data-tool="mdnice编辑器"><span></span><code>mamba install bcftools<br></code></pre><p data-tool="mdnice编辑器">配置文件，根据实际情况修改，比如我这里chrMT改成chrM</p><figure data-tool="mdnice编辑器"><img data-ratio="1.3987341772151898" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykbJgYSDDolSxgiazZzS77VzK1pmjv7RDPGTxkyAKr2YPkpjhqxgpn7qw/640?wx_fmt=png" data-type="png" data-w="474" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykbJgYSDDolSxgiazZzS77VzK1pmjv7RDPGTxkyAKr2YPkpjhqxgpn7qw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">修改名称</p><pre data-tool="mdnice编辑器"><span></span><code>bcftools annotate --rename-chrs change_contig_name_vcf.config ./gatk_resource_bundle/1000G_phase1.snps.high_confidence.hg38.vcf -o ./gatk_resource_bundle/1000G_phase1.snps.high_confidence.hg38.RmChr.vcf<br><br>bcftools annotate --rename-chrs change_contig_name_vcf.config ./gatk_resource_bundle/Mills_and_1000G_gold_standard.indels.hg38.vcf -o ./gatk_resource_bundle/Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>nohup bcftools annotate --rename-chrs change_contig_name_vcf.config ./gatk_resource_bundle/dbsnp_146.hg38.vcf -o ./gatk_resource_bundle/dbsnp_146.hg38.RmChr.vcf &amp;<br></code></pre><p data-tool="mdnice编辑器">需要注意dbsnp_146.hg38.vcf</p><pre data-tool="mdnice编辑器"><span></span><code>[W::vcf_parse] Contig <span>'chr1'</span> is not defined <span>in</span> the header. (Quick workaround: index the file with tabix.)<br>Encountered an error, cannot proceed. Please check the error output above.<br>If feeling adventurous, use the --force option. (At your own risk!)<br></code></pre><p data-tool="mdnice编辑器">查看vcf文件可以看到确实没有像前面两个vcf文件那样的contig注释行</p><p data-tool="mdnice编辑器">添加 <code>--force</code> 参数，也是同样的报错</p><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p>生物信息问题杂烩（https://zhuanlan.zhihu.com/p/339566011?utm_id=0&amp;wd=&amp;eqid=daa8c63f0003925800000006648871ae#h_339566011_2）如果运行 bcftools 出现如下错误，说明需要对 vcf 创建索引文件</p><p>vcf文件处理&amp;合并（https://zhuanlan.zhihu.com/p/650801709）</p><p>最好不要用gzip直接压缩，可能会影响到后面建索引：</p><p>我碰到的报错：index: "xxx.vcf.gz" is in a format that cannot be usefully indexed</p><p>所以压缩vcf文件最好用bgzip</p></blockquote><p data-tool="mdnice编辑器">创建索引后修改成功</p><pre data-tool="mdnice编辑器"><span></span><code>bgzip dbsnp_146.hg38.vcf<br>bcftools index dbsnp_146.hg38.vcf.gz<br><span>cd</span> ..<br>nohup bcftools annotate --rename-chrs change_contig_name_vcf.config ./gatk_resource_bundle/dbsnp_146.hg38.vcf.gz -o ./gatk_resource_bundle/dbsnp_146.hg38.RmChr.vcf.gz &amp;<br><span>cd</span> gatk_resource_bundle<br>gunzip dbsnp_146.hg38.RmChr.vcf.gz<br></code></pre><p data-tool="mdnice编辑器">我猜前面两个vcf文件因为有contig注释行，所以bcftools修改contig名称不需要索引</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">第二次尝试运行代码</p><pre data-tool="mdnice编辑器"><span></span><code>gatk BaseRecalibrator \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-I ./SRR11178348_dedup_split.bam \<br>--known-sites ~/refdata/gatk_resource_bundle/1000G_phase1.snps.high_confidence.hg38.RmChr.vcf \<br>--known-sites ~/refdata/gatk_resource_bundle/dbsnp_146.hg38.RmChr.vcf \<br>--known-sites ~/refdata/gatk_resource_bundle/Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf \<br>-O ./SRR11178348_recal_data.table &amp;&amp; \<br>gatk ApplyBQSR \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-I ./SRR11178348_dedup_split.bam \<br>-bqsr ./SRR11178348_recal_data.table \<br>-O ./SRR11178348_BQSR.bam<br><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>A USER ERROR has occurred: Input /home/data/t120455/refdata/gatk_resource_bundle/1000G_phase1.snps.high_<br>confidence.hg38.RmChr.vcf must support random access to <span>enable</span> queries by interval. If it<span>'s a file, please index it using the bundled tool IndexFeatureFile<br><br></span></code></pre><pre data-tool="mdnice编辑器"><span></span><code>A USER ERROR has occurred: Input /home/data/t120455/refdata/gatk_resource_bundle/dbsnp_146.hg38.RmChr.vcf must support random access to <span>enable</span> queries by interval. If it<span>'s a file, please index it using the bu<br>ndled tool IndexFeatureFile<br><br></span></code></pre><pre data-tool="mdnice编辑器"><span></span><code>A USER ERROR has occurred: Input /home/data/t120455/refdata/gatk_resource_bundle/Mills_and_1000G_gold_st<br>andard.indels.hg38.RmChr.vcf must support random access to <span>enable</span> queries by interval. If it<span>'s a file, p<br>lease index it using the bundled tool IndexFeatureFile<br><br></span></code></pre><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p>2021-03-31 为VCF文件建立索引（.idx) （https://www.jianshu.com/p/307bb7b83c3f）</p><p>gatk IndexFeatureFile -I XXX.vcf</p></blockquote><p data-tool="mdnice编辑器">前面我们用bcftools给vcf.gz建立索引，而gatk可以直接对vcf建立索引</p><pre data-tool="mdnice编辑器"><span></span><code>gatk IndexFeatureFile -I 1000G_phase1.snps.high_confidence.hg38.RmChr.vcf<br>gatk IndexFeatureFile -I dbsnp_146.hg38.RmChr.vcf<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>gatk IndexFeatureFile -I Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf<br></code></pre><p data-tool="mdnice编辑器">需要注意Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf</p><pre data-tool="mdnice编辑器"><span></span><code>A USER ERROR has occurred: Error <span>while</span> trying to create index <span>for</span> Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf. Error was: htsjdk.tribble.TribbleException: The provided VCF file is malformed at approximately line number 3475: The reference allele cannot be missing<br></code></pre><p data-tool="mdnice编辑器">报错信息说第3475行的变异位点没有ref allele</p><p data-tool="mdnice编辑器">查看：</p><pre data-tool="mdnice编辑器"><span></span><code>t120455 23:46:56 ~/refdata/gatk_resource_bundle <br><span>$sed</span> -n <span>"3475p"</span> Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf <br>1 0 . . . . . .<br>t120455 23:47:19 ~/refdata/gatk_resource_bundle <br><span>$sed</span> -n <span>"3474,3476p"</span> Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf <br>1 965337 rs59448239 CTTAT C 37990.2 PASS <span>set</span>=Intersect1000GMinusSI<br>1 0 . . . . . .<br>t120455 23:47:33 ~/refdata/gatk_resource_bundle <br><span>$sed</span> -n <span>"3474,3477p"</span> Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf <br>1 965337 rs59448239 CTTAT C 37990.2 PASS <span>set</span>=Intersect1000GMinusSI<br>1 0 . . . . . .<br>t120455 23:47:52 ~/refdata/gatk_resource_bundle <br><span>$wc</span> -l Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf<br>3475 Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf<br></code></pre><p data-tool="mdnice编辑器">可以发现就是最后一行，干脆删掉</p><pre data-tool="mdnice编辑器"><span></span><code>t120455 23:48:08 ~/refdata/gatk_resource_bundle <br><span>$sed</span> -n <span>"3475p"</span> Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf <br>1 0 . . . . . .<br>t120455 23:51:56 ~/refdata/gatk_resource_bundle <br><span>$sed</span> -i <span>"3475d"</span> Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf <br>t120455 23:52:14 ~/refdata/gatk_resource_bundle <br><span>$sed</span> -n <span>"3475p"</span> Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf <br>t120455 23:52:17 ~/refdata/gatk_resource_bundle <br><span>$wc</span> -l Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf<br>3474 Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf<br><br></code></pre><p data-tool="mdnice编辑器">创建索引成功</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">第三次运行代码</p><pre data-tool="mdnice编辑器"><span></span><code>gatk BaseRecalibrator \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-I ./SRR11178348_dedup_split.bam \<br>--known-sites ~/refdata/gatk_resource_bundle/1000G_phase1.snps.high_confidence.hg38.RmChr.vcf \<br>--known-sites ~/refdata/gatk_resource_bundle/dbsnp_146.hg38.RmChr.vcf \<br>--known-sites ~/refdata/gatk_resource_bundle/Mills_and_1000G_gold_standard.indels.hg38.RmChr.vcf \<br>-O ./SRR11178348_recal_data.table &amp;&amp; \<br>gatk ApplyBQSR \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-I ./SRR11178348_dedup_split.bam \<br>-bqsr ./SRR11178348_recal_data.table \<br>-O ./SRR11178348_BQSR.bam<br></code></pre><p data-tool="mdnice编辑器">成功，结果文件：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.21739130434782608" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykUAhhPEpVP1H93kTrCibpqdbpWiaV6TjkRiaoIxFBRYRxmnL2bnibSyK5Ag/640?wx_fmt=png" data-type="png" data-w="621" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykUAhhPEpVP1H93kTrCibpqdbpWiaV6TjkRiaoIxFBRYRxmnL2bnibSyK5Ag/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>4、call mutations</h2><pre data-tool="mdnice编辑器"><span></span><code>gatk HaplotypeCaller \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-I ./SRR11178348_BQSR.bam \<br>-O ./SRR11178348.vcf \<br>-L ~/refdata/gatk_resource_bundle/wgs_calling_regions.hg38.RmChr.interval_list<br></code></pre><p data-tool="mdnice编辑器">这里需要注意 <code>-L</code> 参数使用的interval_list文件</p><p data-tool="mdnice编辑器">在GATK的HaplotypeCaller工具中，-L参数用于指定用于分析的区域列表文件路径。该参数允许指定特定的基因组区域，只对这些区域进行变异分析，而不是对整个基因组进行分析。这在特定感兴趣的区域或需要加快分析速度时非常有用，通过使用-L参数并提供区域列表文件路径，HaplotypeCaller工具将仅分析指定的区域，减少了分析的范围，从而节省了时间和计算资源。</p><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p>Broad hg38 ICE interval list （https://gatk.broadinstitute.org/hc/en-us/community/posts/360057855032-Broad-hg38-ICE-interval-list）</p><p>Intervals and interval lists （https://gatk.broadinstitute.org/hc/en-us/articles/360035531852-Intervals-and-interval-lists）</p><p>How to choose interval_list? （https://gatk.broadinstitute.org/hc/en-us/community/posts/8622509405339-How-to-choose-interval-list-）</p><p>You should use the <strong>wgs_calling_regions.hg38.interval_list</strong> for single-sample and joint calling.</p></blockquote><p data-tool="mdnice编辑器">文件下载：</p><p data-tool="mdnice编辑器">我们前面使用的google bucket</p><p data-tool="mdnice编辑器">https://console.cloud.google.com/storage/browser/genomics-public-data/resources/broad/hg38/v0</p><p data-tool="mdnice编辑器">而在</p><blockquote data-tool="mdnice编辑器"><p>How to choose interval_list? （https://gatk.broadinstitute.org/hc/en-us/community/posts/8622509405339-How-to-choose-interval-list-</p><p>和</p><p>Resource bundle(https://gatk.broadinstitute.org/hc/en-us/articles/360035890811-Resource-bundle)</p></blockquote><p data-tool="mdnice编辑器">中google bucket地址 https://console.cloud.google.com/storage/browser/gcp-public-data--broad-references/hg38/v0</p><p data-tool="mdnice编辑器">看起来维护时间更新，数据库文件更多</p><p data-tool="mdnice编辑器">下载interval_list</p><pre data-tool="mdnice编辑器"><span></span><code>(lncRNA) t120455 00:50:30 ~/refdata/gatk_resource_bundle <br><span>$gsutil</span> cp -r gs://genomics-public-data/resources/broad/hg38/v0/wgs_calling_regions.hg38.interval_list ./<br></code></pre><p data-tool="mdnice编辑器">直接去掉chr</p><pre data-tool="mdnice编辑器"><span></span><code>sed <span>'s/chr//g'</span><br></code></pre><p data-tool="mdnice编辑器">运行代码，结果文件：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.20108695652173914" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykmiavO2ySialic0JH2As1wFt0XGgK3fEyLSasBSKibicbticnOkNI15ROlia4Q/640?wx_fmt=png" data-type="png" data-w="552" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykmiavO2ySialic0JH2As1wFt0XGgK3fEyLSasBSKibicbticnOkNI15ROlia4Q/640?wx_fmt=png"><figcaption>img</figcaption></figure><h2 data-tool="mdnice编辑器"><span></span>5、对mutations进行过滤</h2><p data-tool="mdnice编辑器">像前面一样，对vcf文件修改contig名称并构建索引</p><pre data-tool="mdnice编辑器"><span></span><code>bcftools annotate --rename-chrs change_contig_name_vcf.config input.vcf -o input.RmChr.vcf<br><br>gatk IndexFeatureFile -I XX.RmChr.vcf<br></code></pre><p data-tool="mdnice编辑器">尝试运行代码：</p><p data-tool="mdnice编辑器">model:SNP</p><pre data-tool="mdnice编辑器"><span></span><code>gatk VariantRecalibrator \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-V ./SRR11178348.vcf \<br>-resource:hapmap,known=<span>false</span>,training=<span>true</span>,truth=<span>true</span>,prior=15.0 ~/refdata/gatk_resource_bundle/hapmap_3.3.hg38.RmChr.vcf \<br>-resource:omini,known=<span>false</span>,training=<span>true</span>,truth=<span>false</span>,prior=12.0 ~/refdata/gatk_resource_bundle/1000G_omni2.5.hg38.RmChr.vcf \<br>-resource:1000G,known=<span>false</span>,training=<span>true</span>,truth=<span>false</span>,prior=10.0 ~/refdata/gatk_resource_bundle/1000G_phase1.snps.high_confidence.hg38.RmChr.vcf \<br>-resource:dbsnp,known=<span>true</span>,training=<span>false</span>,truth=<span>false</span>,prior=6.0 ~/refdata/gatk_resource_bundle/dbsnp_146.hg38.RmChr.vcf \<br>-an DP -an QD -an FS -an SOR -an ReadPosRankSum -an MQRankSum \<br>-mode SNP \<br>-tranche 100.0 -tranche 99.9 -tranche 99.0 -tranche 95.0 -tranche 90.0 \<br>--tranches-file SRR11178348.snps.tranches \<br>-O SRR11178348.snps.recal<br><br>gatk ApplyVQSR \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-V ./SRR11178348.vcf \<br>--tranches-file SRR11178348.snps.tranches \<br>--recal-file SRR11178348.snps.recal \<br>-ts-filter-level 99.0 \<br>-mode SNP \<br>-O SRR11178348.snps.VQSR.vcf.gz<br><br></code></pre><p data-tool="mdnice编辑器">报错</p><pre data-tool="mdnice编辑器"><span></span><code>13:40:16.601 INFO  ProgressMeter - Traversal complete. Processed 241459 total variants <span>in</span> 4.8 minutes.<br>13:40:16.641 INFO  VariantDataManager - DP:      mean = 7.30     standard deviation = 28.00<br>13:40:16.674 INFO  VariantDataManager - QD:      mean = 24.32    standard deviation = 7.13<br>13:40:16.691 INFO  VariantDataManager - FS:      mean = 0.25     standard deviation = 1.26<br>13:40:16.719 INFO  VariantDataManager - SOR:     mean = 1.31     standard deviation = 0.82<br>13:40:16.759 INFO  VariantDataManager - ReadPosRankSum:          mean = 0.02     standard deviation = 0.<br>96<br>13:40:16.787 INFO  VariantDataManager - MQRankSum:       mean = 0.00     standard deviation = 0.00<br>13:40:16.807 INFO  VariantRecalibrator - Shutting down engine<br>[September 3, 2023 1:40:16 PM CST] org.broadinstitute.hellbender.tools.walkers.vqsr.VariantRecalibrator <br><span>done</span>. Elapsed time: 4.82 minutes.<br>Runtime.totalMemory()=8761901056<br>***********************************************************************<br><br>A USER ERROR has occurred: Bad input: Found annotations with zero variance. They must be excluded before<br> proceeding.<br><br></code></pre><p data-tool="mdnice编辑器">可以发现</p><pre data-tool="mdnice编辑器"><span></span><code>13:40:16.787 INFO  VariantDataManager - MQRankSum:       mean = 0.00     standard deviation = 0.00<br></code></pre><p data-tool="mdnice编辑器">报错信息让我们排除掉这个注释</p><p data-tool="mdnice编辑器">在GATK的VariantRecalibrator工具中，<code>-an</code>参数用于指定用于校准的注释特征。这些特征是基因组变异数据中的一些统计信息，用于帮助区分真实变异和假阳性。</p><p data-tool="mdnice编辑器">以下是命令中使用的六个特征的解释：</p><ol data-tool="mdnice编辑器"><li><section><strong>DP</strong>（Read Depth）：该特征表示在某个位点上的总测序深度，即所有覆盖该位点的读取数量的总和。</section></li><li><section><strong>QD</strong>（Quality by Depth）：该特征是变异质量（QUAL）除以测序深度（DP），用于衡量变异质量相对于测序深度的比值。较高的QD值通常表示更可靠的变异。</section></li><li><section><strong>FS</strong>（Fisher Strand Bias）：该特征衡量单个位点附近的两种不同链的碱基的比例，以捕捉可能的测序偏差情况。较低的FS值表示较少的偏差。</section></li><li><section><strong>SOR</strong>（Strand Odds Ratio）：该特征比较在正链和负链上观察到的变异读数的比例，以探测潜在的偏性。较低的SOR值表示较少的偏性。</section></li><li><section><strong>ReadPosRankSum</strong>：该特征比较在变异位置上校正的碱基相对于变异位置外校正的碱基的质量得分。用于衡量碱基在读取中的位置对变异的贡献。较高的ReadPosRankSum值表示较高的质量。</section></li><li><section><strong>MQRankSum</strong>（Mapping Quality Rank Sum Test）：该特征比较与该位点关联的变异碱基与参考碱基的比例，以衡量测序质量的偏差。较高的MQRankSum值表示较高的质量。</section></li></ol><p data-tool="mdnice编辑器">这些特征提供了关于基因组变异的不同方面的信息，通过将这些特征包含在质量校准中，可以更好地筛选和区分真实变异和假阳性。</p><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p>GATK报错信息汇总 （https://www.jianshu.com/p/dd60506b06a2）</p><p>所使用的一些tags也就是annotations是不适用的，应该把这些注释去掉</p></blockquote><p data-tool="mdnice编辑器">去除后运行成功</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">mode:INDEL</p><pre data-tool="mdnice编辑器"><span></span><code>gatk VariantRecalibrator \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-V ./SRR11178348.snps.VQSR.vcf.gz \<br>-resource:mills,known=<span>true</span>,training=<span>true</span>,truth=<span>true</span>,prior=12.0 ~/refdata/gatk_resource_bundle/Mills_and_<br>1000G_gold_standard.indels.hg38.RmChr.vcf \<br>-an DP -an QD -an FS -an SOR -an ReadPosRankSum -an MQRankSum \<br>-mode INDEL \<br>--max-gaussians 6 \<br>--tranches-file SRR11178348.indels.tranches \<br>-O SRR11178348.snps.indels.recal<br><br>gatk ApplyVQSR \<br>-R ~/refdata/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa \<br>-V ./SRR11178348.snps.VQSR.vcf.gz \<br>--tranches-file SRR11178348.indels.tranches \<br>--recal-file SRR11178348.snps.indels.recal \<br>-ts-filter-level 99.0 \<br>-mode INDEL \<br>-O SRR11178348.VQSR.vcf.gz<br></code></pre><p data-tool="mdnice编辑器">报错</p><pre data-tool="mdnice编辑器"><span></span><code>20:25:41.178 INFO  ProgressMeter - Traversal complete. Processed 241459 total variants <span>in</span> 0.0 minutes.<br>20:25:41.211 INFO  VariantDataManager - DP:   mean = 2.00  standard deviation = 0.00<br>20:25:41.242 INFO  VariantDataManager - QD:   mean = 27.73  standard deviation = 0.00<br>20:25:41.262 INFO  VariantDataManager - FS:   mean = -0.00  standard deviation = 0.00<br>20:25:41.274 INFO  VariantDataManager - SOR:   mean = 2.30  standard deviation = 0.00<br>20:25:41.299 INFO  VariantRecalibrator - Shutting down engine<br>[September 3, 2023 8:25:41 PM CST] org.broadinstitute.hellbender.tools.walkers.vqsr.VariantRecalibrator <span>done</span>. Elapsed time: 0.04 minutes.<br>Runtime.totalMemory()=2454716416<br>***********************************************************************<br><br>A USER ERROR has occurred: Bad input: Values <span>for</span> ReadPosRankSum annotation not detected <span>for</span> ANY training variant <span>in</span> the input callset. VariantAnnotator may be used to add these annotations.<br><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>A USER ERROR has occurred: Bad input: Values <span>for</span> MQRankSum annotation not detected <span>for</span> ANY training variant <span>in</span> the input callset. VariantAnnotator may be used to add these annotations.<br><br></code></pre><p data-tool="mdnice编辑器">去除这两个注释后，仍报错</p><pre data-tool="mdnice编辑器"><span></span><code>20:45:32.352 INFO  ProgressMeter - Traversal complete. Processed 241459 total variants <span>in</span> 0.0 minutes.<br>20:45:32.370 INFO  VariantDataManager - DP:   mean = 2.00  standard deviation = 0.00<br>20:45:32.387 INFO  VariantDataManager - QD:   mean = 27.73  standard deviation = 0.00<br>20:45:32.395 INFO  VariantDataManager - FS:   mean = -0.00  standard deviation = 0.00<br>20:45:32.400 INFO  VariantDataManager - SOR:   mean = 2.30  standard deviation = 0.00<br>20:45:32.407 INFO  VariantRecalibrator - Shutting down engine<br>[September 3, 2023 8:45:32 PM CST] org.broadinstitute.hellbender.tools.walkers.vqsr.VariantRecalibrator <span>done</span>. Elapsed time: 0.05 minutes.<br>Runtime.totalMemory()=2667577344<br>***********************************************************************<br><br>A USER ERROR has occurred: Bad input: Found annotations with zero variance. They must be excluded before proceeding.<br><br></code></pre><p data-tool="mdnice编辑器">可以发现这四个注释的variance都为0</p><p data-tool="mdnice编辑器">如果某个注释特征的方差为0，则意味着该特征在所有的样本中的取值都是相同的，没有变异性</p><p data-tool="mdnice编辑器">为什么会出现这个情况？【Q2】</p><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>小结</h1><p data-tool="mdnice编辑器">以上就是本周全部内容，又是一个新的流程，后面可能没有太多时间做这样的事，因为debug太耗时间了，可以发现我上面基本上一直在debug，导致我目前还不能很好地解读代码参数和结果文件背后的生物学意义，这才是最重要的</p><p data-tool="mdnice编辑器">这套流程可以和肿瘤外显子数据分析指南语雀专栏（https://www.yuque.com/biotrainee/wes/ipgs5k#z7xmO）比较学习</p><p data-tool="mdnice编辑器">对于gatk的vcf结果文件，我们可以通过不同软件进行注释或转换成maf文件</p><p data-tool="mdnice编辑器">原推文提到：</p><blockquote data-tool="mdnice编辑器"><p>其实，在获得VCF文件之后，<strong>还可以使用数据库文件或自有的测序文件进行germline突变的去除，以进一步提高结果的可信度。</strong></p></blockquote><p data-tool="mdnice编辑器">语雀专栏走的就是这个流程：</p><blockquote data-tool="mdnice编辑器"><figure><img data-ratio="0.4842592592592593" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykUiaxhSH4dgLtHib6xJv8DHbPSOroVYnV0EnDHd0iaxicsXHzolJaWH9dXw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicDDMT2Hyb4icCfdTL6puLykUiaxhSH4dgLtHib6xJv8DHbPSOroVYnV0EnDHd0iaxicsXHzolJaWH9dXw/640?wx_fmt=png"></figure><h2><span></span>单样本找 Germline SNPS + INDELs</h2><p>我们通常说的突变，可以分为种系突变 Germline mutations（又称生殖突变）和体细胞突变 Somatic mutations。前者是指在生殖细胞中发生的任何可检测、可遗传的突变。在生殖细胞系以外的细胞中发生的突变称为体细胞突变，也称作获得性突变，是不可遗传的。<strong>使用 GATK 的流程进行 Germline mutations，主要用到的工具是 HaplotypeCaller</strong>，流程示意图如下（最后得到的 vcf 文件应该还有走 VQSR 进行过滤）</p><h2><span></span>mutect 找 Somatic mutations</h2><p>前面单样本走 <strong>GATK HaplotypeCaller</strong> 流程得到 vcf 文件主要包含了 germline mutations 信息。但是我们这里分析的是肿瘤样本，包含成对的 tumor 和 normal 样本，更加关心的是 tumor 样本中所包含的 <strong>somatic mutations</strong> 信息。所以我们应该走 GATK 的 somatic mutations 流程</p></blockquote></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/UyyAycW6HSN_dImo03Aj0g",target="_blank" rel="noopener noreferrer">原文链接</a>
