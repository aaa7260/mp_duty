---
title: "构建seurat对象之初就应该是把基因名字转换好"
date: 2023-09-26T16:33:36Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
构建seurat对象之初就应该是把基因名字转换好 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>看到单细胞转录组测序数据的文献：《Single-cell sequencing links multiregional immune landscapes and tissue-resident T cells in ccRCC to tumor topology and therapy efficacy》，是提供了配套数据， 所以，我下载了ccRCC_6pat_Seurat 文件，居然是26G，非常巨大！其降维聚类分群和生物学命名后，如下所示：</p></blockquote><p><img data-galleryid="" data-ratio="0.7731343283582089" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wze8XSOWT7sLo9WsapcSQ5msCZh0Bf4pW4DiblSprvcEddrBBbowcEXc1TfHwlsqKspJqtpgDtfjHw/640?wx_fmt=png" data-type="png" data-w="670" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wze8XSOWT7sLo9WsapcSQ5msCZh0Bf4pW4DiblSprvcEddrBBbowcEXc1TfHwlsqKspJqtpgDtfjHw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>降维聚类分群和生物学命名</figcaption></figure><p data-tool="mdnice编辑器">可以看到，主要是T淋巴细胞，和髓系淋巴细胞，少部分b淋巴细胞，部分内皮细胞和成纤维细胞，以及上皮细胞。尤其是T淋巴细胞的各个亚群，非常清晰，值得学习！</p><p data-tool="mdnice编辑器">我仔细看了看那个26G的ccRCC_6pat_Seurat 文件，，发现是旧版本的seurat对象，所以使用了下面的代码进行转换：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(Seurat) <br>sce=readRDS(<span>'ccRCC_6pat_Seurat'</span>)<br>sce<br>sce=UpdateSeuratObject(sce)<br>sce<br>DimPlot(sce)<br>save(sce,file = <span>'first_sce.Rdata'</span>)<br></code></pre><p data-tool="mdnice编辑器">关键就是 UpdateSeuratObject 函数啦！我看了看，存储后的文件，就1个G啦，非常棒！</p><p data-tool="mdnice编辑器">看了看这个对象里面的元素应有尽有，可以直接绘图如下：</p><p><img data-galleryid="" data-ratio="0.5262757044935262" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wze8XSOWT7sLo9WsapcSQ5m1Xx8DLYvcmIfAKVRlpKqneMBryvU2Ze5WtMqwuoN6mKcjG9eKBHInQ/640?wx_fmt=png" data-type="png" data-w="2626" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wze8XSOWT7sLo9WsapcSQ5m1Xx8DLYvcmIfAKVRlpKqneMBryvU2Ze5WtMqwuoN6mKcjG9eKBHInQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">降维聚类分群都OK了，接下来就是根据背景知识对这些细胞亚群进行生物学命名啦！</p><p data-tool="mdnice编辑器">但是使用基因名字去可视化各个亚群，全部报错，因为它的基因居然是ensemb 数据库的ID ，并不是我们常见的基因symbol ：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; head(rownames(sce))<br>[1] <span>"ENSG00000237683"</span> <span>"ENSG00000228463"</span> <span>"ENSG00000225880"</span> <span>"ENSG00000230368"</span> <span>"ENSG00000187634"</span><br>[6] <span>"ENSG00000188976"</span><br></code></pre><p data-tool="mdnice编辑器">需要做一个转换，下面演示一下这个步骤：</p><p data-tool="mdnice编辑器">首先拿到基因转换列表：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br><span>library</span>(Seurat)<br>load(file = <span>'first_sce.Rdata'</span>)<br>sce <span>#   16323 features </span><br><span>library</span>(org.Hs.eg.db)<br>head(rownames(sce))<br>ids=select(org.Hs.eg.db,keys = rownames(sce),<br>           columns = c(<span>'ENSEMBL'</span>,<span>'SYMBOL'</span>),<br>           keytype = <span>'ENSEMBL'</span>)<br>head(ids)<br>dim(ids) <span># [1] 16428 </span><br>ids=na.omit(ids)<br>dim(ids) <span># [1] 15504 </span><br>length(unique(ids$SYMBOL)) <span># [1] 15494 </span><br><span># 这里的关系超级乱，互相之间都不是一对一 </span><br><span># 凡是混乱的ID一律删除即可</span><br>ids=ids[!duplicated(ids$SYMBOL),]<br>ids=ids[!duplicated(ids$ENSEMBL),]<br>pos=match(ids$ENSEMBL,rownames(sce) )<br>sce=sce[pos,]<br>sce <span># 15393 features</span><br><span># rownames(sce) = ids$SYMBOL</span><br></code></pre><p data-tool="mdnice编辑器">本来是准备使用 rownames(sce) = ids$SYMBOL 搞定这个 seurat对象的基因名字转换，但是失败了。</p><p data-tool="mdnice编辑器">略微搜索了一下，https://github.com/satijalab/seurat/issues/2617 提到了一个函数：</p><pre data-tool="mdnice编辑器"><span></span><code><span># https://github.com/satijalab/seurat/issues/2617</span><br><span># RenameGenesSeurat  ------------------------------------------------------------------------------------</span><br>RenameGenesSeurat &lt;- <span>function</span>(obj , <br>                              newnames ) { <br>  <span># Replace gene names in different slots of a Seurat object. Run this before integration. Run this before integration. </span><br>  <span># It only changes obj@assays$RNA@counts, @data and @scale.data.</span><br>  print(<span>"Run this before integration. It only changes obj@assays$RNA@counts, @data and @scale.data."</span>)<br>  RNA &lt;- obj@assays$RNA<br>  <br>  <span>if</span> (nrow(RNA) == length(newnames)) {<br>    <span>if</span> (length(RNA@counts)) RNA@counts@Dimnames[[<span>1</span>]]            &lt;- newnames<br>    <span>if</span> (length(RNA@data)) RNA@data@Dimnames[[<span>1</span>]]                &lt;- newnames<br>    <span>if</span> (length(RNA@scale.data)) RNA@scale.data@Dimnames[[<span>1</span>]]    &lt;- newnames<br>  } <span>else</span> {<span>"Unequal gene sets: nrow(RNA) != nrow(newnames)"</span>}<br>  obj@assays$RNA &lt;- RNA<br>  <span>return</span>(obj)<br>}<br>obj=RenameGenesSeurat(obj = sce, <br>                  newnames = ids$SYMBOL)<br>save(sce,file = <span>'first_sce.Rdata'</span>)<br><br></code></pre><p data-tool="mdnice编辑器">蛮简单的，接下来就可以继续可视化啦！</p><pre data-tool="mdnice编辑器"><span></span><code><span># T Cells (CD3D, CD3E, CD8A), </span><br><span># B cells (CD19, CD79A, MS4A1 [CD20]), </span><br><span># Plasma cells (IGHG1, MZB1, SDC1, CD79A), </span><br><span># Monocytes and macrophages (CD68, CD163, CD14),</span><br><span># NK Cells (FGFBP2, FCG3RA, CX3CR1),  </span><br><span># Photoreceptor cells (RCVRN), </span><br><span># Fibroblasts (FGF7, MME), </span><br><span># Endothelial cells (PECAM1, VWF). </span><br><span># epi or tumor (EPCAM, KRT19, PROM1, ALDH1A1, CD24).</span><br><span>#   immune (CD45+,PTPRC), epithelial/cancer (EpCAM+,EPCAM), </span><br><span># stromal (CD10+,MME,fibo or CD31+,PECAM1,endo) </span><br><br><span>library</span>(ggplot2) <br>genes_to_check = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <span>'CD4'</span>,<span>'CD8A'</span>,<span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span> ,<br>                   <span>'IGHG1'</span>, <span>'MZB1'</span>, <span>'SDC1'</span>,<br>                   <span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>, <br>                   <span>'TPSAB1'</span> , <span>'TPSB2'</span>,  <span># mast cells,</span><br>                   <span>'RCVRN'</span>,<span>'FPR1'</span> , <span>'ITGAM'</span> ,<br>                   <span>'FGF7'</span>,<span>'MME'</span>, <span>'ACTA2'</span>,<br>                   <span>'PECAM1'</span>, <span>'VWF'</span>, <br>                   <span>'EPCAM'</span> , <span>'KRT19'</span>, <span>'PROM1'</span>, <span>'ALDH1A1'</span> )<br><span>library</span>(stringr)  <br>p_all_markers &lt;- DotPlot(sce , features = genes_to_check,<br>                         assay=<span>'RNA'</span>  )  + coord_flip()<br><br>p_all_markers<br>ggsave(plot=p_all_markers, filename=<span>"check_all_marker_by_seurat_cluster.pdf"</span>)<br><br></code></pre><p data-tool="mdnice编辑器">可以很明显的看到：</p><p><img data-galleryid="" data-ratio="0.5392156862745098" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wze8XSOWT7sLo9WsapcSQ5m7FibbEynwawyNEF1o0LZXPVzXjd3M1xjewdWGzb7flAC1w7gs60YCgA/640?wx_fmt=png" data-type="png" data-w="2652" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wze8XSOWT7sLo9WsapcSQ5m7FibbEynwawyNEF1o0LZXPVzXjd3M1xjewdWGzb7flAC1w7gs60YCgA/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">我们做肿瘤研究的单细胞数据，一般来说会选择初步很粗狂的定义大的细胞亚群，比如我常用的 第一次分群是通用规则是：</p><ul data-tool="mdnice编辑器"><li><section>immune (CD45+,PTPRC),</section></li><li><section>epithelial/cancer (EpCAM+,EPCAM),</section></li><li><section>stromal (CD10+,MME,fibo or CD31+,PECAM1,endo)</section></li></ul><p data-tool="mdnice编辑器">根据上面的标记基因列表，我给出来的亚群是：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 需要自行看图，定细胞亚群：  </span><br>celltype=data.frame(ClusterID=<span>0</span>:<span>34</span>,<br>                    celltype=<span>'unkown'</span>)<br>celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>,<span>2</span>:<span>4</span>,<span>6</span>:<span>8</span>,<span>10</span>,<span>15</span>,<span>17</span>,<span>17</span>,<span>19</span>,<span>31</span>,<span>32</span>),<span>2</span>]=<span>'Tcells'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>24</span> ),<span>2</span>]=<span>'plasma'</span><br>celltype[celltype$ClusterID %<span>in</span>% c( <span>22</span> ),<span>2</span>]=<span>'naive-Bcells'</span><br>celltype[celltype$ClusterID %<span>in</span>% c(<span>21</span>),<span>2</span>]=<span>'mast'</span><br><br>celltype[celltype$ClusterID %<span>in</span>% c( <span>1</span>,<span>5</span>,<span>12</span>:<span>14</span>,<span>18</span>,<span>23</span>,<span>27</span>,<span>33</span>,<span>34</span>),<span>2</span>]=<span>'myeloid'</span><br>celltype[celltype$ClusterID %<span>in</span>% c( <span>9</span>,<span>16</span>,<span>26</span> ),<span>2</span>]=<span>'epithelial'</span><br><br>celltype[celltype$ClusterID %<span>in</span>% c( <span>11</span>),<span>2</span>]=<span>'endo'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c(<span>20</span>),<span>2</span>]=<span>'fibo'</span>  <br>celltype[celltype$ClusterID %<span>in</span>% c(<span>25</span> ),<span>2</span>]=<span>'SMC'</span>  <br><br>head(celltype)<br>celltype <br>table(celltype$celltype)<br></code></pre><p data-tool="mdnice编辑器">出图如下：</p><p><img data-galleryid="" data-ratio="0.540090771558245" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wze8XSOWT7sLo9WsapcSQ5mVmXJXia9fSadF1NkiaO64FSleSKtyq3kf7yGE5StibTkvtAJF4VJESEGg/640?wx_fmt=png" data-type="png" data-w="2644" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wze8XSOWT7sLo9WsapcSQ5mVmXJXia9fSadF1NkiaO64FSleSKtyq3kf7yGE5StibTkvtAJF4VJESEGg/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">之所以我们有一堆unknown，是因为我对这个ccRCC的肿瘤并不熟悉，我的背景认知就是3个大亚群！<span><strong>所以就非常的尴尬，空有数据宝山，可以对它做任意分析，但是却不知道这个数据的生物医学意义！！！</strong></span></p><p data-tool="mdnice编辑器"><span><strong>大家对于这样的困局有没有什么破局方法？欢迎留言讨论</strong></span></p><p data-tool="mdnice编辑器">前面的例子：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497956&amp;idx=1&amp;sn=5d4deb7cf7b7848b3e2273cbd663bb6a&amp;scene=21#wechat_redirect" data-linktype="2">人人都能学会的单细胞聚类分群注释</a>  ，我们演示了第一层次的分群。</p><p data-tool="mdnice编辑器">如果你对单细胞数据分析还没有基础认知，可以看基础10讲：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486076&amp;idx=1&amp;sn=52bb851d7dc23461233a2cf458736151&amp;scene=21#wechat_redirect" data-linktype="2">01. 上游分析流程</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486082&amp;idx=1&amp;sn=03cadceffb2c14ba95d97fe5caf38d94&amp;scene=21#wechat_redirect" data-linktype="2">02.课题多少个样品，测序数据量如何</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486088&amp;idx=1&amp;sn=3a115338ee4937d20caab78627237553&amp;scene=21#wechat_redirect" data-linktype="2">03. 过滤不合格细胞和基因（数据质控很重要）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486096&amp;idx=1&amp;sn=1a99c4c5800b7e0287db3e8ef369fab8&amp;scene=21#wechat_redirect" data-linktype="2">04. 过滤线粒体核糖体基因</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486098&amp;idx=1&amp;sn=bf9a71df848d74fe665ce7d5e283d5ff&amp;scene=21#wechat_redirect" data-linktype="2">05. 去除细胞效应和基因效应</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486260&amp;idx=1&amp;sn=c6abf658de73594d1d77d8e1ffa7d153&amp;scene=21#wechat_redirect" data-linktype="2">06.单细胞转录组数据的降维聚类分群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486271&amp;idx=1&amp;sn=638b434b6deee63206af1c0eeda175ab&amp;scene=21#wechat_redirect" data-linktype="2">07.单细胞转录组数据处理之细胞亚群注释</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486278&amp;idx=1&amp;sn=91250ef733833ff00371818b215dc124&amp;scene=21#wechat_redirect" data-linktype="2">08.把拿到的亚群进行更细致的分群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486287&amp;idx=1&amp;sn=49627c638ff9c04418282c53518aa7c7&amp;scene=21#wechat_redirect" data-linktype="2">09.单细胞转录组数据处理之细胞亚群比例比较</a></section></li></ul></section><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/LmDjcIscBgYb7izKYPkVOg",target="_blank" rel="noopener noreferrer">原文链接</a>
