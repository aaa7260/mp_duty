---
title: "批量的GSEA及基因表达热图可视化"
date: 2023-09-25T03:37:10Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
批量的GSEA及基因表达热图可视化 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section><strong><span>差异基因的生物学功能富集分析，除GO和KEGG外，另一种较为稳妥的</span><span>生物学功能数据库注释是GSEA方法，研究者可以针对特定的通路基因进行研究，再加上基因的表达热图</span><span>更为直观</span></strong><span>！（下面演示一个批量运行的示例）</span></section><section><span>这里，我们<span>用最经典的airway这个转录组测序数据集里面的表达量矩阵和分组信息，走标准的差异分析后，对基因进行logFC的排序，然后走kegg数据库的gsea注释，选取特定通路进行 gsea图和热图展示。</span></span></section><p data-tool="mdnice编辑器"><br></p><p data-tool="mdnice编辑器">****下载Airway数据集</p><pre data-tool="mdnice编辑器"><span></span><code><span># 修改镜像并下载BiocManager</span><br>options(<span>"repos"</span> = c(CRAN=<span>"http://mirrors.tuna.tsinghua.edu.cn/CRAN/"</span>))<br><span>if</span>(!require(<span>"BiocManager"</span>)) install.packages(<span>"BiocManager"</span>,update = F,ask = F)<br>options(BioC_mirror=<span>"http://mirrors.tuna.tsinghua.edu.cn/bioconductor/"</span>)<br>getOption(<span>"BioC_mirror"</span>)<br>getOption(<span>"repos"</span>)<br>BiocManager::install(<span>"airway"</span>)<br>BiocManager::install(<span>"org.Hs.eg.db"</span>)<br></code></pre><p data-tool="mdnice编辑器">****查看Airway数据集信息</p><pre data-tool="mdnice编辑器"><span></span><code>library(airway)<br>data(airway) <span># 将数据集加载出来</span><br>class(airway) <span>#查看数据集类型 (发现看不懂输出结果)</span><br>dim(airway) <span># 查看数据集的行列 (输出内容依然不明白)</span><br>View(airway)<br>airway@colData <span>#查看数据集第一列内容</span><br><br>airway<span>$SampleName</span>;airway[[1]]<br>airway<span>$cell</span>;airway[[2]]<br></code></pre><p data-tool="mdnice编辑器">****读取数据</p><pre data-tool="mdnice编辑器"><span></span><code>library(airway)<br><span>#Biocductor R包为三种：1.功能函数包2.数据包3.注释包（芯片基因之间的转换）</span><br><span>#此为中的一种，为数据包</span><br>data(airway)<span>#加载数据</span><br>exprSet=assay(airway)<span>#获取表达矩阵，默认airway获取表达矩阵就是assay，没有原因的</span><br>colnames(exprSet)<span>#看表达矩阵的列名</span><br>dim(exprSet)<span>#查看表达矩阵的维度</span><br>View(exprSet)<br><span>#设定分组信息</span><br>group_list=colData(airway)[,3]<span>#得出分组信息</span><br>tmp=data.frame(group_list)<span>#把group_list向量变为数据框tmp</span><br>row.names(tmp)=colnames(exprSet)<br><span>#把tmp的行名改为exprSet的列名</span><br><br>exprSet=exprSet[apply(exprSet,1,<span>function</span>(x)sum(x&gt;1)&gt;5),]<br><span>##分别对数据中每一行的数据进行一个什么运算，1代表行，2代表列</span><br></code></pre><p data-tool="mdnice编辑器">****DESeq2进行差异分析</p><pre data-tool="mdnice编辑器"><span></span><code>library(<span>"DESeq2"</span>) <br>colData&lt;-data.frame(row.names = colnames(exprSet),group_list=group_list)<br><span>#给每个样本进行标签化，设定每个样本的性质特点，分组的前期准备</span><br><br>dds &lt;- DESeqDataSetFromMatrix(countData =exprSet, colData = colData, design = ~group_list)<br><span>#countData为表达矩阵，colData样本特点内涵分组信息，design 以某个种（group_list）样本特点设定分组</span><br><span>#keep &lt;- rowSums(counts(dds)) &gt;= 10#筛选表达量之和大于10的基因</span><br><span>#dds &lt;- dds[keep,]</span><br>dds &lt;- DESeq(dds)<span>#四步矫正，处理数据</span><br>res &lt;- results(dds, contrast=c(<span>"group_list"</span>,<span>"untrt"</span>,<span>"trt"</span>))<span>#按照"untrt","trt"比较得出差异分析结果</span><br>resOrdered&lt;-res[order(res<span>$padj</span>),]<span>#把res排序</span><br>head(resOrdered)<br>DEG=as.data.frame(resOrdered)<span>#把差异分析结果变为数据框</span><br>DESeq2_DEG=na.omit(DEG)<span>#删除差异分析中缺少值的结果</span><br>View(DESeq2_DEG)<br></code></pre><p data-tool="mdnice编辑器">****针对这个差异分析结果进行 GSEA分析</p><pre data-tool="mdnice编辑器"><span></span><code>head(DESeq2_DEG)<br>geneList = DESeq2_DEG<span>$log2FoldChange</span><br>names(geneList)= rownames(DESeq2_DEG)<br><br><span>#按logFC值进行排序</span><br>geneList=sort(geneList,decreasing = T)<br>head(geneList)<br><br>library(clusterProfiler)<br>library(org.Hs.eg.db)<br>library(DOSE)<br>data(geneList)<br>head(geneList) <span>#排序好的基因序列，而且是entrezeID的形式</span><br><br>R.utils::setOption( <span>"clusterProfiler.download.method"</span>,<span>'auto'</span> )<br>kkgsea &lt;- gseKEGG(geneList     = geneList,<br>                  organism     = <span>'hsa'</span>, <br>                  minGSSize    = 10,<br>                  maxGSSize    = 500,<br>                  pvalueCutoff = 1,<br>                  pAdjustMethod = <span>"none"</span> ) <span>#进行gseKEGG富集分析 </span><br>kkgsea=setReadable(kkgsea,keyType = <span>'ENTREZID'</span>,OrgDb = <span>'org.Hs.eg.db'</span>)<br>tmp = kkgsea@result[,c(1:5,11)]<br>save(kkgsea,file = <span>'G:/编程/生信菜鸟团学徒练习/gsea_kk.Rdata'</span>)<br>View(kkgsea@result)<br></code></pre><p><img data-galleryid="" data-ratio="0.5277777777777778" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicFk8kGndfTIxsABOjb5YTtF30LbibgOMk1tcMGXiaa41Cc6h5J8h40QU7GnE4dDXBLPib7f9CZavq8g/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicFk8kGndfTIxsABOjb5YTtF30LbibgOMk1tcMGXiaa41Cc6h5J8h40QU7GnE4dDXBLPib7f9CZavq8g/640?wx_fmt=png"></p><p data-tool="mdnice编辑器"><br></p><p data-tool="mdnice编辑器">****对结果进行可视化</p><pre data-tool="mdnice编辑器"><span></span><code><span>#可视化前12条通路的分析结果</span><br>library(enrichplot)<br>gseaplot2(kkgsea,geneSetID = head(kkgsea@result<span>$ID</span>,12))<span>#可视化前12条通路</span><br><span># 按第一个条目做二维码图，并显示p值</span><br><span>#color是enrichment score线的颜色</span><br><span>#base_sizexy轴标题字的大小</span><br><span>#ES_geom是enrichment score线用线或点显示</span><br>gseaplot2(kkgsea,5,color=<span>"red"</span>,pvalue_table = T,title=<span>"DNA replication"</span>,base_size=10,ES_geom=<span>"line"</span>)<span>#可视化第5条信号通路</span><br><span>##当然也可以在一张图上展示多个条目</span><br>gseaplot2(kkgsea,1:3,color=<span>"red"</span>,pvalue_table = T,title=kkgsea@result<span>$Description</span>[1],base_size=10,ES_geom=<span>"line"</span>)<br><span>#山脊图</span><br>ridgeplot(kkgsea,fill = <span>"pvalue"</span>,5)+scale_fill_continuous(<span>type</span> = <span>"viridis"</span>)<br></code></pre><p><br></p><p>前12条通路的可视化结果<br></p><p><img data-galleryid="" data-ratio="0.9969558599695586" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicFk8kGndfTIxsABOjb5YTtOdoT4ibyelHX4vClo9z4zYwCYocng4c8P6ghgk15tBVTaFCiaTfhhoAA/640?wx_fmt=png" data-type="png" data-w="657" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicFk8kGndfTIxsABOjb5YTtOdoT4ibyelHX4vClo9z4zYwCYocng4c8P6ghgk15tBVTaFCiaTfhhoAA/640?wx_fmt=png"></p><p>第一条通路的可视化结果<br></p><p><img data-galleryid="" data-ratio="1.0107361963190185" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicFk8kGndfTIxsABOjb5YTtrib10SfJDZMJBDGj3JwMBA93BUfCIeiaiaImrOo5PjYWKCvwSE5dI54fA/640?wx_fmt=png" data-type="png" data-w="652" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicFk8kGndfTIxsABOjb5YTtrib10SfJDZMJBDGj3JwMBA93BUfCIeiaiaImrOo5PjYWKCvwSE5dI54fA/640?wx_fmt=png"></p><p><br></p><p><br></p><p data-tool="mdnice编辑器">****对所选通路的基因表达进行热图可视化</p><pre data-tool="mdnice编辑器"><span></span><code><span># 其中 exprSet 是前面的转录组测序后的counts矩阵</span><br><span># group_list 是矩阵里面的每个样品的分组信息</span><br><span># up_kegg 是自己挑选好的通路 </span><br><br>library(pheatmap)<br><span>#对通路的里面的基因拿去热图可视化</span><br>pro = <span>'up'</span><br><span>print</span>(pro)<br>dir.create(<span>'G:/编程/生信菜鸟团学徒练习/up_kk_gse_heatmap'</span>)<br>savDir &lt;- <span>'G:/编程/生信菜鸟团学徒练习/up_kk_gse_heatmap/'</span><br><br>lapply(1:nrow(kkgsea), <span>function</span>(i){ <br>  i=5 <br>  cg = strsplit(kkgsea@result<span>$core_enrichment</span>[i],<span>'/'</span>)[[1]]<br>  cg<br>  length(cg)<br>  dat=log2(edgeR::cpm(exprSet)+1)<br>  dat[1:4,1:4] <br>  table(group_list)<br>  pheatmap(dat,show_colnames =F,show_rownames = F) <span>#对那些提取出来的1000个基因所在的每一行取出，组合起来为一个新的表达矩阵</span><br>  n=t(scale(t(dat))) <span># 'scale'可以对log-ratio数值进行归一化</span><br>  n[n&gt;2]=2 <br>  n[n&lt; -2]= -2<br>  <span>#  n[1:4,1:4]</span><br>  pheatmap(n,show_colnames =F,show_rownames = F)<br>  ac=data.frame(group=group_list)<br>  rownames(ac)=colnames(n) <br>  pheatmap(n,show_colnames =F,show_rownames = F,<br>           annotation_col=ac)<br>  <br>  heatmap.title = paste0(<span>'Genes of '</span>, kkgsea@result<span>$Description</span>[i])<br>  filename =  paste0(savDir, pro,<span>'_'</span>,<br>                     gsub(<span>'/'</span>,<span>'-'</span>,kkgsea@result<span>$Description</span>[i]),<br>                     <span>'.pdf'</span>)<br>  <span>if</span>(length(cg) &gt; 15){plot.height &lt;- length(cg)/5}<br>  <span>if</span>(length(cg) %<span>in</span>% c(3:15)){plot.height &lt;- length(cg)*0.5}<br>  <span>if</span>(length(cg) %<span>in</span>% c(1:2)){plot.height &lt;- length(cg)*1.5}<br>  pheatmap(n,main = heatmap.title,<br>           show_colnames =F,show_rownames = F,<br>           annotation_col=ac,<br>           height = plot.height,<br>           filename = filename) <br>}) <br></code></pre></section><p><img data-galleryid="" data-ratio="0.5940860215053764" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicFk8kGndfTIxsABOjb5YTtFr2ibib66IFqzSq2Wn4cZ5W1mhWjB6a3fu0NQ79RFY5TfhVMWqRFic7VA/640?wx_fmt=png" data-type="png" data-w="744" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicFk8kGndfTIxsABOjb5YTtFr2ibib66IFqzSq2Wn4cZ5W1mhWjB6a3fu0NQ79RFY5TfhVMWqRFic7VA/640?wx_fmt=png"></p><h4 data-tool="mdnice编辑器">文末友情宣传</h4><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524930&amp;idx=5&amp;sn=19d5eb52cbba6389c6238cd7943d96c7&amp;chksm=9b4b22f9ac3cabefa5c0436a6e723c3ad447fd67bdd2f9d500043220c5e97e6934b6015977e3&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买一得‍五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">时隔5年，我们的生信技能树VIP学徒继续招生啦</a><br></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247522831&amp;idx=2&amp;sn=1744efdf428465425a145ff3a982198b&amp;chksm=9b4bdab4ac3c53a28fbecbbff4f254f470b54a7a20468bb753b295b930315e1ec45bcbabc10b&amp;scene=21#wechat_redirect" textvalue="144线程640Gb内存服务器共享一年‍仍然是仅需800" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">144线程640Gb内存服务器共享一年仍然是仅需800</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">千呼万唤始出来的独享生物信息学云服务器</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"></a><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524275&amp;idx=1&amp;sn=fa592ee29f636f34387491d0fceadd8e&amp;chksm=9b4bdf08ac3c561e0881974b3817beb0a0e514dc1a8df4c34c2b6653da6fa78e09acb03c70c2&amp;scene=21#wechat_redirect" textvalue="生信技能树知识整理实习生又又又开放申请啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信技能树知识整理实习生又又又开放申请啦</a></section></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524432&amp;idx=1&amp;sn=5b33b0c6807a9e6939c332c58fabff89&amp;chksm=9b4b20ebac3ca9fdb3d8bfaf2bef5552f64eb70e7fae557cc7197fb1a23b3e8bc31b585bf829&amp;scene=21#wechat_redirect" textvalue="生信共享办公室出租" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信共享办公室出租</a></p></li></ul><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Bpj_-9POyaPkU2LlFb2MSQ",target="_blank" rel="noopener noreferrer">原文链接</a>
