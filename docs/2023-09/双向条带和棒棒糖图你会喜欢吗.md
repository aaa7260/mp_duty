---
title: "双向条带和棒棒糖图你会喜欢吗"
date: 2023-09-01T11:02:47Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
双向条带和棒棒糖图你会喜欢吗 by 生信星球
------
<div><section data-mpa-powered-by="yiban.io"><span>‍</span><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第928天</strong></span></span><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><section><span><span>   </span><span>大神一句话，菜鸟跑半年。我不是大神，但我可以缩短你走弯路的半年~</span></span></section><section><span>   就像歌儿唱的那样，如果你不知道该往哪儿走，就留在这学点生信好不好~</span></section><p><span>   这里有豆豆和花花的学习历程，从新手到进阶，生信路上有你有我！</span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h4 data-tool="mdnice编辑器"><span><span></span>0.开头</span></h4><p data-tool="mdnice编辑器">多次看到文章里出现了这种漂亮的双向条带图或者是棒棒糖图。</p><p data-tool="mdnice编辑器">之前多用于富集分析上下调基因的展示，现在看到有用与展示lasso回归基因的系数，还有基因与免疫细胞之间的相关性哦。</p><p data-tool="mdnice编辑器">搞一下。</p><h4 data-tool="mdnice编辑器"><span><span></span>1.lasso回归系数展示</span></h4><p data-tool="mdnice编辑器">lasso回归模型的构建，翻翻前面的吧。变量名称我一般都不改动。</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>load(<span>"lasso_model.Rdata"</span>)<br>library(glmnet)<br><span>#&gt; Warning: package 'glmnet' was built under R version 4.3.1</span><br><span>#&gt; Warning: package 'Matrix' was built under R version 4.3.1</span><br>co = coef(fit,s = cvfit<span>$lambda</span>.min) <span>#提取最优lamda参数对应的模型的基因系数</span><br>coef = data.frame(gene = rownames(co),<br>                 coefficient = co[,1])<br>head(coef)<br><span>#&gt;            gene coefficient</span><br><span>#&gt; FNDC4     FNDC4 -0.05689081</span><br><span>#&gt; HSPB7     HSPB7  0.00000000</span><br><span>#&gt; ADAMTS1 ADAMTS1  0.09729311</span><br><span>#&gt; EGFL6     EGFL6  0.00000000</span><br><span>#&gt; MSLN       MSLN  0.00000000</span><br><span>#&gt; NR2F1     NR2F1 -0.03833734</span><br>coef = coef[coef<span>$coefficient</span>!=0,]<br>nrow(coef)<br><span>#&gt; [1] 26</span><br></code></pre><p data-tool="mdnice编辑器">可以看到，系数不为零的基因有26个。</p><p data-tool="mdnice编辑器">然后就是画图啦</p><pre data-tool="mdnice编辑器"><span></span><code>library(ggplot2)<br><span>#&gt; Warning: package 'ggplot2' was built under R version 4.3.1</span><br>library(dplyr)<br>library(stringr)<br>dat &lt;- mutate(coef,group = ifelse(coef<span>$coefficient</span>&lt;0,<span>"n"</span>,<span>"p"</span>)) %&gt;%  <br>  arrange(coefficient)<br>dat<span>$gene</span> = factor(dat<span>$gene</span>,levels = dat<span>$gene</span>)<br>head(dat)<br><span>#&gt;        gene coefficient group</span><br><span>#&gt; AADAC AADAC -0.19608156     n</span><br><span>#&gt; TAP1   TAP1 -0.18953961     n</span><br><span>#&gt; SHMT2 SHMT2 -0.11746386     n</span><br><span>#&gt; IL32   IL32 -0.06476249     n</span><br><span>#&gt; MATN2 MATN2 -0.06229653     n</span><br><span>#&gt; CCL18 CCL18 -0.05689775     n</span><br></code></pre><p data-tool="mdnice编辑器">这里设置成因子，是给基因定顺序，呈现在图上就是系数从小到大排好的顺序。</p><h5 data-tool="mdnice编辑器">首先是条形图</h5><pre data-tool="mdnice编辑器"><span></span><code>ggplot(dat, aes(x = gene, y = coefficient)) + <br>  geom_bar(<span>stat</span> = <span>"identity"</span>, aes(fill = group), width = 0.7) + <br>  scale_fill_manual(values = c(<span>"#2874C5"</span>, <span>"#f87669"</span>))+ <br>  coord_flip() + <br>  theme_light() +<br>  <span>#scale_x_discrete(labels = function(x) str_wrap(x, width = 30))  + </span><br>  theme(panel.border = element_blank(),legend.position = <span>"none"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpV9ia7xL6xMykpLJ7wmdEuKzMHh4IGiaOAVFNbx9Qy6L2FT3ib19zjO6AOic260JuP5AyU2vRw3Ll5kg/640?wx_fmt=jpeg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpV9ia7xL6xMykpLJ7wmdEuKzMHh4IGiaOAVFNbx9Qy6L2FT3ib19zjO6AOic260JuP5AyU2vRw3Ll5kg/640?wx_fmt=jpeg"></figure><h5 data-tool="mdnice编辑器">其次是棒棒糖图</h5><p data-tool="mdnice编辑器">之前也是玩过的</p><p data-tool="mdnice编辑器">https://www.yuque.com/xiaojiewanglezenmofenshen/dbwkg1/bgrr5l?singleDoc#</p><pre data-tool="mdnice编辑器"><span></span><code>ggplot(dat, aes(x=gene, y=coefficient)) +<br>  geom_segment( aes(x=gene, xend=gene, y=0, yend=coefficient), color=<span>"grey"</span>,linewidth = 2) +<br>  geom_point( aes(color = group), size=4) +<br>  scale_color_manual(values = c(<span>"#2874C5"</span>, <span>"#f87669"</span>))+ <br>  theme_light() +<br>  theme(panel.grid.major.x = element_blank(),<br>        panel.border = element_blank(),<br>        axis.ticks.x = element_blank(),<br>        legend.position = <span>"none"</span>) +<br>  coord_flip()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpV9ia7xL6xMykpLJ7wmdEuK4UKBCOlH0PKhniac871AudOJkZr00xgVuqYPCYibgjyJT7RStkRbXMVw/640?wx_fmt=jpeg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpV9ia7xL6xMykpLJ7wmdEuK4UKBCOlH0PKhniac871AudOJkZr00xgVuqYPCYibgjyJT7RStkRbXMVw/640?wx_fmt=jpeg"></figure><h4 data-tool="mdnice编辑器"><span><span></span>2.基因与免疫细胞的相关性展示</span></h4><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>library(ggplot2)<br>library(dplyr)<br>library(stringr)<br>library(tibble)<br>load(<span>"ciber_OV.Rdata"</span>)<br>load(<span>"TCGA-OV_sur_model.Rdata"</span>)<br>ls()<br><span>#&gt; [1] "exprSet"     "meta"        "proj"        "TME.results"</span><br></code></pre><p data-tool="mdnice编辑器">这里面的数据是：表达矩阵，临床信息表格，项目名称（一个字符串），cibersort计算结果。</p><p data-tool="mdnice编辑器">首先是数据的整理，要计算相关性，先要把基因与免疫细胞放在一起。</p><p data-tool="mdnice编辑器">免疫细胞中有全部样本中丰度都为0的，去掉。</p><pre data-tool="mdnice编辑器"><span></span><code>dat = data.frame(gene = exprSet[<span>"UST"</span>,],<br>                 TME.results[,-(23:25)])<br>k = colSums(dat)!=0;table(k)<br><span>#&gt; k</span><br><span>#&gt; FALSE  TRUE </span><br><span>#&gt;     1    22</span><br>dat = dat[,k]<br>head(dat)<br><span>#&gt;                       gene B.cells.naive B.cells.memory Plasma.cells</span><br><span>#&gt; TCGA-25-2392-01A 1.4258618    0.05524972              0  0.002044477</span><br><span>#&gt; TCGA-25-1312-01A 2.4093953    0.11955543              0  0.019723657</span><br><span>#&gt; TCGA-04-1341-01A 0.7848063    0.09676434              0  0.224775927</span><br><span>#&gt; TCGA-24-1471-01A 1.6984869    0.07933525              0  0.000000000</span><br><span>#&gt; TCGA-57-1585-01A 2.9336677    0.05677041              0  0.079099711</span><br><span>#&gt; TCGA-25-1317-01A 2.0147820    0.14929411              0  0.308282209</span><br><span>#&gt;                  T.cells.CD8 T.cells.CD4.memory.resting</span><br><span>#&gt; TCGA-25-2392-01A  0.04738134                 0.19799108</span><br><span>#&gt; TCGA-25-1312-01A  0.06258089                 0.17402099</span><br><span>#&gt; TCGA-04-1341-01A  0.14659062                 0.10947780</span><br><span>#&gt; TCGA-24-1471-01A  0.07791053                 0.25978686</span><br><span>#&gt; TCGA-57-1585-01A  0.05248321                 0.18941649</span><br><span>#&gt; TCGA-25-1317-01A  0.03731518                 0.06835275</span><br><span>#&gt;                  T.cells.CD4.memory.activated T.cells.follicular.helper</span><br><span>#&gt; TCGA-25-2392-01A                            0               0.010592055</span><br><span>#&gt; TCGA-25-1312-01A                            0               0.005340711</span><br><span>#&gt; TCGA-04-1341-01A                            0               0.109647454</span><br><span>#&gt; TCGA-24-1471-01A                            0               0.020173489</span><br><span>#&gt; TCGA-57-1585-01A                            0               0.011689718</span><br><span>#&gt; TCGA-25-1317-01A                            0               0.000000000</span><br><span>#&gt;                  T.cells.regulatory..Tregs. T.cells.gamma.delta</span><br><span>#&gt; TCGA-25-2392-01A                 0.06545165                   0</span><br><span>#&gt; TCGA-25-1312-01A                 0.10453661                   0</span><br><span>#&gt; TCGA-04-1341-01A                 0.04818645                   0</span><br><span>#&gt; TCGA-24-1471-01A                 0.05154977                   0</span><br><span>#&gt; TCGA-57-1585-01A                 0.06955758                   0</span><br><span>#&gt; TCGA-25-1317-01A                 0.06020367                   0</span><br><span>#&gt;                  NK.cells.resting NK.cells.activated   Monocytes Macrophages.M0</span><br><span>#&gt; TCGA-25-2392-01A       0.01026381         0.00000000 0.220905577     0.00000000</span><br><span>#&gt; TCGA-25-1312-01A       0.00000000         0.06938213 0.031403113     0.00000000</span><br><span>#&gt; TCGA-04-1341-01A       0.00000000         0.07063490 0.006971579     0.06588185</span><br><span>#&gt; TCGA-24-1471-01A       0.02762884         0.00000000 0.252636403     0.00000000</span><br><span>#&gt; TCGA-57-1585-01A       0.01074878         0.00000000 0.017259851     0.24586411</span><br><span>#&gt; TCGA-25-1317-01A       0.00000000         0.06765442 0.008184936     0.11462072</span><br><span>#&gt;                  Macrophages.M1 Macrophages.M2 Dendritic.cells.resting</span><br><span>#&gt; TCGA-25-2392-01A     0.03898395     0.34371613              0.00000000</span><br><span>#&gt; TCGA-25-1312-01A     0.02009685     0.29969346              0.00000000</span><br><span>#&gt; TCGA-04-1341-01A     0.04730625     0.03960571              0.00000000</span><br><span>#&gt; TCGA-24-1471-01A     0.07279296     0.14138293              0.01508471</span><br><span>#&gt; TCGA-57-1585-01A     0.05130538     0.08636666              0.06719474</span><br><span>#&gt; TCGA-25-1317-01A     0.07304576     0.07905093              0.00000000</span><br><span>#&gt;                  Dendritic.cells.activated Mast.cells.resting</span><br><span>#&gt; TCGA-25-2392-01A               0.000000000        0.007420216</span><br><span>#&gt; TCGA-25-1312-01A               0.000000000        0.088973751</span><br><span>#&gt; TCGA-04-1341-01A               0.002680086        0.000000000</span><br><span>#&gt; TCGA-24-1471-01A               0.000000000        0.000000000</span><br><span>#&gt; TCGA-57-1585-01A               0.000000000        0.000000000</span><br><span>#&gt; TCGA-25-1317-01A               0.000000000        0.000000000</span><br><span>#&gt;                  Mast.cells.activated Eosinophils Neutrophils</span><br><span>#&gt; TCGA-25-2392-01A           0.00000000           0 0.000000000</span><br><span>#&gt; TCGA-25-1312-01A           0.00000000           0 0.004692427</span><br><span>#&gt; TCGA-04-1341-01A           0.03147703           0 0.000000000</span><br><span>#&gt; TCGA-24-1471-01A           0.00171825           0 0.000000000</span><br><span>#&gt; TCGA-57-1585-01A           0.05779814           0 0.004445216</span><br><span>#&gt; TCGA-25-1317-01A           0.02919894           0 0.004796371</span><br></code></pre><p data-tool="mdnice编辑器">然后是用cor.one函数计算基因与所有细胞的相关性。</p><pre data-tool="mdnice编辑器"><span></span><code>library(tinyarray)<br><span>#&gt; Warning: package 'tinyarray' was built under R version 4.3.1</span><br>pdat = cor.one(dat,<span>"gene"</span>)<br>head(pdat)<br><span>#&gt;                                p.value           cor obsnumber</span><br><span>#&gt; B.cells.naive                0.9868082 -0.0008660344       367</span><br><span>#&gt; B.cells.memory               0.7054278  0.0197972351       367</span><br><span>#&gt; Plasma.cells                 0.7818942 -0.0145002329       367</span><br><span>#&gt; T.cells.CD8                  0.3752069 -0.0464220138       367</span><br><span>#&gt; T.cells.CD4.memory.resting   0.7249968 -0.0184245124       367</span><br><span>#&gt; T.cells.CD4.memory.activated 0.1275132 -0.0796965141       367</span><br></code></pre><p data-tool="mdnice编辑器">和上面的整理过程类似了，只是换了数据和列名。</p><pre data-tool="mdnice编辑器"><span></span><code>pdat &lt;- mutate(pdat,group = ifelse(pdat<span>$cor</span>&lt;0,<span>"n"</span>,<span>"p"</span>)) %&gt;%  <br>  arrange(cor)  %&gt;%  <br>  mutate(celltype = str_replace_all(rownames(.),<span>"\\."</span>,<span>" "</span>))<br>head(pdat)  <br><span>#&gt;                                  p.value         cor obsnumber group</span><br><span>#&gt; Macrophages.M1               0.005683221 -0.14409638       367     n</span><br><span>#&gt; T.cells.regulatory..Tregs.   0.015912913 -0.12577722       367     n</span><br><span>#&gt; T.cells.follicular.helper    0.055401932 -0.10008948       367     n</span><br><span>#&gt; Dendritic.cells.activated    0.099655378 -0.08608204       367     n</span><br><span>#&gt; T.cells.CD4.memory.activated 0.127513157 -0.07969651       367     n</span><br><span>#&gt; Monocytes                    0.228752717 -0.06297872       367     n</span><br><span>#&gt;                                                  celltype</span><br><span>#&gt; Macrophages.M1                             Macrophages M1</span><br><span>#&gt; T.cells.regulatory..Tregs.     T cells regulatory  Tregs </span><br><span>#&gt; T.cells.follicular.helper       T cells follicular helper</span><br><span>#&gt; Dendritic.cells.activated       Dendritic cells activated</span><br><span>#&gt; T.cells.CD4.memory.activated T cells CD4 memory activated</span><br><span>#&gt; Monocytes                                       Monocytes</span><br>pdat<span>$celltype</span> = factor(pdat<span>$celltype</span>,levels = pdat<span>$celltype</span>)<br></code></pre><p data-tool="mdnice编辑器">然后图就有啦！</p><pre data-tool="mdnice编辑器"><span></span><code>ggplot(pdat, aes(x = celltype, y = cor)) + <br>  geom_bar(<span>stat</span> = <span>"identity"</span>, aes(fill = group), width = 0.7) + <br>  scale_fill_manual(values = c(<span>"#2874C5"</span>, <span>"#f87669"</span>))+ <br>  coord_flip() + theme_light() +<br>  scale_x_discrete(labels = <span>function</span>(x) str_wrap(x, width = 30))  + <br>  theme(panel.border = element_blank(),legend.position = <span>"none"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpV9ia7xL6xMykpLJ7wmdEuKsJqMNItBLuEGKiciccQia2iasxr6LG0Z9b8ZrW9KqT1q45WpXt2SSiaTb0A/640?wx_fmt=jpeg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpV9ia7xL6xMykpLJ7wmdEuKsJqMNItBLuEGKiciccQia2iasxr6LG0Z9b8ZrW9KqT1q45WpXt2SSiaTb0A/640?wx_fmt=jpeg"></figure><pre data-tool="mdnice编辑器"><span></span><code>ggplot(pdat, aes(x = celltype, y = cor)) +<br>  geom_segment( aes(x=celltype, xend=celltype, y=0, yend=cor), color=<span>"grey"</span>,linewidth = 2) +<br>  geom_point( aes(color = group), size=4) +<br>  scale_color_manual(values = c(<span>"#2874C5"</span>, <span>"#f87669"</span>))+ <br>  theme_light() +<br>  theme(panel.grid.major.x = element_blank(),<br>        panel.border = element_blank(),<br>        axis.ticks.x = element_blank(),<br>        legend.position = <span>"none"</span>) +<br>  coord_flip()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpV9ia7xL6xMykpLJ7wmdEuKqIu38Ru3mP1AMdSI0UOcg1TjADWbicttT8UBDYRKDTD2SuicDKYGtAVQ/640?wx_fmt=jpeg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpV9ia7xL6xMykpLJ7wmdEuKqIu38Ru3mP1AMdSI0UOcg1TjADWbicttT8UBDYRKDTD2SuicDKYGtAVQ/640?wx_fmt=jpeg"></figure></section><section><blockquote><section><span>如果因为代码看不懂，而跟不上正文的节奏，可以来找我，相当于来一个新手保护期。我的</span><span>课程都是循环开课。</span><span>下一期的时间，点进去咨询微信咯</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247493855&amp;idx=1&amp;sn=7f0e563813dbf496d659eddec14dad62&amp;chksm=fdfba09dca8c298bff076c3ab0d46c145fc6c18c815c4280059fc1c8747bc2267f1df8c0ef67&amp;scene=21#wechat_redirect" textvalue="找我们学习生‍信" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">找我们学习生信</a></section><section>学习小组的文案时隔两年半终于更新了，在今日次页</section></blockquote></section><section><section><br></section></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/9b5bqMB3Oj9Ne9ET8DJ9rg",target="_blank" rel="noopener noreferrer">原文链接</a>
