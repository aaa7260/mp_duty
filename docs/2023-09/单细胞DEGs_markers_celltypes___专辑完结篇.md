---
title: "单细胞DEGs、markers、celltypes | 专辑完结篇"
date: 2023-09-19T05:54:35Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
单细胞DEGs、markers、celltypes | 专辑完结篇 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">这周转录组周更憋个大招，细心的小伙伴可能也发现了，<a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI1Njk4ODE0MQ==&amp;action=getalbum&amp;album_id=3019915773533913092&amp;scene=173&amp;from_msgid=2247514167&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" data-linktype="2">初学者暑期搞定单细胞</a>这个专辑也是我写的，暑期磨磨蹭蹭总归也还是出来了点东西，但是开学后就没有时间搞单细胞了，和目前做的方向也不相干，一些我想做的，比如细胞通讯、拟时序分析，都还没来得及，不知道有没有朋友真的暑期实现了我立的flag“搞定”了单细胞。所以这期周更算是这个单细胞专辑的完结篇，我将系统地总结：<strong>单细胞水平样本samples间的差异分析、clusters间的差异分析鉴定marker、一些检索细胞亚型markers的数据库以及如何使用一些打分算法结合markers辅助确定细胞亚型</strong>，这四个问题。</p><p data-tool="mdnice编辑器">内容很长，干货很多，小张让我分成两期推送，我想着反正最后一篇单细胞了，那就毕其功于一役吧。上期推文使用snakemake管理转录组流程，有一些小伙伴在评论区给我提出问题，这是我非常欣喜看到的，因为我本身是个生信菜狗，很多时候曾老师不一定有时间看我的推送帮我检查，我更多的时候是抱着学习的态度分享笔记，而不是教程。</p><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>单细胞水平样本间的差异分析</h1><p data-tool="mdnice编辑器">主要参考：</p><p data-tool="mdnice编辑器">生物学重复的不同条件下的scrna-seq数据的差异基因表达分析 （https://www.10xgenomics.com/resources/analysis-guides/differential-gene-expression-analysis-in-scrna-seq-data-between-conditions-with-biological-replicates）</p><p data-tool="mdnice编辑器">需要注意的是，这部分差异表达分析不应与下一部分，计算<strong>来自两个簇的细胞之间的差异表达基因以用于标记基因鉴定或细胞类型注释</strong>混淆，它们是两种不同目的的不同分析</p><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span>background</h2><ul data-tool="mdnice编辑器"><li><section><strong>Samples as biological replicates for DGE between conditions</strong></section></li></ul><p data-tool="mdnice编辑器">对于任何给定的细胞类型和条件，来自一个样本的细胞可能比来自不同样本的细胞更相似</p><ul data-tool="mdnice编辑器"><li><section><strong>Multi-condition DGE analysis approaches in scRNAseq data</strong></section></li></ul><p data-tool="mdnice编辑器">为了获得有效的假设检验结果，已经开发了几种DGE算法来解释差异表达分析中来自同一样本的细胞的分组性质。这些算法包括<strong>拟合混合效应模型</strong>、<strong>对样本内细胞计数求和（pseudobulk）</strong>以及<strong>测试分布差异</strong>。</p><ul data-tool="mdnice编辑器"><li><section><strong>General analysis workflow</strong></section></li></ul><p data-tool="mdnice编辑器">需要关注批次效应问题，就这个问题我们前面已经有所讨论<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515454&amp;idx=1&amp;sn=9baf3f82940d8cb2685bc140122fb686&amp;chksm=ea1cbbbcdd6b32aad5953a0d0e80766f0ec50e232c2df6208b8f2c340ff0f04a9a2c54a20726&amp;scene=21&amp;cur_album_id=3019915773533913092#wechat_redirect" data-linktype="2">harmony、不harmony，这是个问题</a></p><p data-tool="mdnice编辑器">个人感觉单细胞是否需要去除批次效应比bulk更难判断，因为单细胞我们已经进入到了细胞亚型的层次，任何校正影响都很大，bulk这个时候对于case、control来说更“粗枝大叶”一些</p><p data-tool="mdnice编辑器">一般来说，原始计数应用于DGE分析，而不是标准化或批量校正的数据</p><p data-tool="mdnice编辑器">但是在细胞聚类鉴定亚型时往往需要将原始单细胞RNA测序数据标准化，以消除技术差异</p><p data-tool="mdnice编辑器">参考 Batch Effect Correction Analysis Guide：</p><p data-tool="mdnice编辑器">https://www.10xgenomics.com/resources/analysis-guides/introduction-batch-effect-correction</p><ul data-tool="mdnice编辑器"><li><section><strong>Common multi-condition DGE analysis approaches</strong></section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.3673469387755102" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6Sm0jg1d7myxEVibZ7tBp8DvOicRwcGXcWEtrCJw9YkN8WicicYZoHTicmibw/640?wx_fmt=png" data-type="png" data-w="980" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6Sm0jg1d7myxEVibZ7tBp8DvOicRwcGXcWEtrCJw9YkN8WicicYZoHTicmibw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><em><strong>Mixed-effects model</strong></em>混合效应模型：处理相关数据的经典方法是使用混合效应模型，该模型<strong>使用随机效应来解释观测值之间的相关性。感兴趣的条件/组被建模为固定效应，并且样本特定的随机截距对来自相同样本（和细胞类型）的细胞之间的相关性进行建模。</strong></p><p data-tool="mdnice编辑器"><em><strong>Pseudobulk</strong></em>：使用标准统计软件在单细胞数据（数千次观测）的规模上拟合混合效应模型的计算量非常大。<strong>一种更简单的方法是总结每个样本的细胞类型内的UMI计数，并使用为bulk RNAseq开发的方法进行多条件DE。</strong></p><p data-tool="mdnice编辑器"><em><strong>Differential distribution test</strong></em> 差异分布测试：单细胞数据使我们能够<strong>估计和了解每个样本中相同细胞类型的细胞中基因表达的分布，而不是测试每个基因在不同条件下的平均表达差异</strong>。正如前两种方法所解决的那样，这些分布可能具有不同的手段，但<strong>差异分布测试也可以检测到更细微的差异，例如方差或模式数量的变化。我们可以测试这些分布在条件/组之间是否不同。</strong></p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">关于不同类型方法的介绍，参考：</p><p data-tool="mdnice编辑器">各种方法代表性工具描述性总结表格</p><p data-tool="mdnice编辑器">https://www.10xgenomics.com/resources/analysis-guides/differential-gene-expression-analysis-in-scrna-seq-data-between-conditions-with-biological-replicates</p><p data-tool="mdnice编辑器">下面我就将挑选每种方法的代表性工具进行展示</p><p data-tool="mdnice编辑器">在正式分析前，我还想提醒一个装包的问题，有的bioC的包在线安装会出现网络问题，我们往往会去bioconductor官网下载源码安装，有的时候bioC3.16 对应的R包源码无法访问，比如下面即将使用的muscat</p><p data-tool="mdnice编辑器">我这里提供两种解决方法：</p><ul data-tool="mdnice编辑器"><li><section><p>bioC3.17对于的R包并不是非4.3的R不能使用，只是可能会出现不能用的情况，主要还是去看看有哪些依赖</p></section></li><li><section><p>如果确实在线、bioconductor源码都无法访问，最后就是去github看看。但是github上当前托管的仓库代码应该是development的，并不是我们希望使用的stable版本，这个时候可以参考具体要使用的版本号，去仓库历史里返回之前commit的版本下载安装即可，参考：<a href="https://mp.weixin.qq.com/s?__biz=Mzg3OTU5NTQxMA==&amp;mid=2247493600&amp;idx=1&amp;sn=a50a7f24fb60de497d08309d45d73191&amp;scene=21#wechat_redirect" data-linktype="2">如何安装Github上特定版本号（每次提交的唯一标识）的R包？</a></p></section></li></ul><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>muscat</h1><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5OTYzMzY5Ng==&amp;mid=2247486232&amp;idx=1&amp;sn=832f8e36ce86afa8ae1ef4771d03c4e2&amp;scene=21#wechat_redirect" data-linktype="2">单细胞差异基因分析：pseudobulk（muscat包）</a></p><p>Differential state analysis with <code>muscat</code> [http://www.bioconductor.org/packages/release/bioc/vignettes/muscat/inst/doc/analysis.html]</p></blockquote><p data-tool="mdnice编辑器">来自8名狼疮患者的10x基于液滴的scRNA-seq PBCM数据</p><h2 data-tool="mdnice编辑器"><span></span>加载数据</h2><p data-tool="mdnice编辑器">数据来源：</p><p data-tool="mdnice编辑器">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE96583</p><p data-tool="mdnice编辑器">使用官方教程提供的方法无法连接访问</p><p data-tool="mdnice编辑器">去GEO查看提供的数据：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.3498419388830348" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6WYH4DWCfJ765EcJmGTQia1ulkhMoevJdyL40zU70pFIjMNfsv5JPexg/640?wx_fmt=png" data-type="png" data-w="949" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6WYH4DWCfJ765EcJmGTQia1ulkhMoevJdyL40zU70pFIjMNfsv5JPexg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">发现好像每个样本没有对应的genes信息，汇总的genes文件也不对，无法用 <code>read10X</code>读取：</p><p data-tool="mdnice编辑器">于是回到我的本地小电脑开启魔法，使用教程提供的方法获取数据：</p><pre data-tool="mdnice编辑器"><span></span><code><span># install.packages("interactiveDisplayBase_1.38.0.tar.gz",repos = NULL)</span><br><span># install.packages("AnnotationHub_3.8.0.tar.gz",repos = NULL)</span><br><span># install.packages("ExperimentHub_2.8.1.tar.gz",repos = NULL)</span><br><br>library(ExperimentHub)<br>eh &lt;- ExperimentHub()<br>query(eh, <span>"Kang"</span>)<br><br>options()<span>$repos</span><br><span># CRAN </span><br><span># "https://cran.rstudio.com/" </span><br><span># attr(,"RStudio")</span><br><span># [1] TRUE</span><br><br><span># install.packages("SingleCellExperiment_1.22.0.tar.gz",repos = NULL)</span><br><span># install.packages("muscData_1.14.0.tar.gz",repos = NULL)</span><br><br>sce &lt;- eh[[<span>"EH2259"</span>]]<br>save(sce,file = <span>"sce.Rdata"</span>)<br></code></pre><p data-tool="mdnice编辑器">保存好sce传给服务器</p><blockquote data-tool="mdnice编辑器"><p>我这里把R的下载镜像从清华退回到了CRAN，因为我发现使用镜像会导致魔法失效</p></blockquote><p data-tool="mdnice编辑器">包含来自8名狼疮患者的10x基于液滴的scRNA-seq PBCM数据，这些数据在用IFN-β治疗6小时之前和之后获得</p><pre data-tool="mdnice编辑器"><span></span><code>library(ExperimentHub)<br>eh &lt;- ExperimentHub()<br>query(eh, "Kang")<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>ExperimentHub with 3 records<br><span># snapshotDate(): 2022-10-31</span><br><span># $dataprovider: NCI_GDC, GEO</span><br><span># $species: Homo sapiens</span><br><span># $rdataclass: character, SingleCellExperiment, BSseq</span><br><span># additional mcols(): taxonomyid, genome, description, coordinate_1_based, maintainer,</span><br><span>#   rdatadateadded, preparerclass, tags, rdatapath, sourceurl, sourcetype </span><br><span># retrieve records with, e.g., 'object[["EH1661"]]' </span><br><br>           title                                         <br>  EH1661 | Whole Genome Bisulfit Sequencing Data <span>for</span> 47 samples<br>  EH1662 | Whole Genome Bisulfit Sequencing Data <span>for</span> 47 samples<br>  EH2259 | Kang18_8vs8  <br></code></pre><p data-tool="mdnice编辑器">数据集包含&gt;35，000个基因和~29，000个细胞</p><p data-tool="mdnice编辑器">EH2259 | Kang18_8vs8</p><pre data-tool="mdnice编辑器"><span></span><code>sce &lt;- eh[[<span>"EH2259"</span>]]<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>load("sce.Rdata")<br>sce<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>class: SingleCellExperiment <br>dim: 35635 29065 <br>metadata(0):<br>assays(1): counts<br>rownames(35635): MIR1302-10 FAM138A ... MT-ND6 MT-CYB<br>rowData names(2): ENSEMBL SYMBOL<br>colnames(29065): AAACATACAATGCC-1 AAACATACATTTCC-1 ... TTTGCATGGTTTGG-1 TTTGCATGTCTTAC-1<br>colData names(5): ind stim cluster cell multiplets<br>reducedDimNames(1): TSNE<br>mainExpName: NULL<br>altExpNames(0):<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>预处理</h2><ul data-tool="mdnice编辑器"><li><section>去除未检测到的基因</section></li><li><section>去除检测到很少或许多基因的细胞</section></li><li><section>去除非常低表达的基因</section></li><li><section>计算标准化表达式值以进行可视化</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code># remove undetected genes<br>sce &lt;- sce[rowSums(counts(sce) &gt; 0) &gt; 0, ]<br>dim(sce)<br></code></pre><p data-tool="mdnice编辑器">使用perCellQCMetrics来计算各种每个细胞的质量控制指标，并如上所述继续过滤细胞和基因：</p><pre data-tool="mdnice编辑器"><span></span><code># calculate per-cell quality control (QC) metrics<br>library(scater)<br>qc &lt;- perCellQCMetrics(sce)<br><br># remove cells with few or many detected genes<br>ol &lt;- isOutlier(metric = qc$detected, nmads = 2, log = TRUE)<br>sce &lt;- sce[, !ol]<br>dim(sce)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code># remove lowly expressed genes<br>sce &lt;- sce[rowSums(counts(sce) &gt; 1) &gt;= 10, ]<br>dim(sce)<br></code></pre><p data-tool="mdnice编辑器">最后使用logNormCounts，通过将每个计数除以其大小因子、添加伪计数 1 和对数转换，来计算log2转换后的标准表达量</p><pre data-tool="mdnice编辑器"><span></span><code># compute sum-factors &amp; normalize<br>sce &lt;- computeLibraryFactors(sce)<br>sce &lt;- logNormCounts(sce)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>数据准备</h2><p data-tool="mdnice编辑器">muscat期望输入 SCE 的特定格式。具体而言，必须提供以下单元格元数据 （colData） 列：</p><ul data-tool="mdnice编辑器"><li><section>"sample_id"：唯一的样本标识符（例如，PeterPan_ref1、Nautilus_trt3等）</section></li><li><section>"cluster_id"：亚群（集群）分配（例如，T细胞，单核细胞等）</section></li><li><section>"group_id"：实验组/条件（例如，对照/治疗，健康/患病等）</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>sce$id &lt;- paste0(sce$stim, sce$ind)<br>(sce &lt;- prepSCE(sce, <br>    kid = "cell", # subpopulation assignments<br>    gid = "stim",  # group IDs (ctrl/stim)<br>    sid = "id",   # sample IDs (ctrl/stim.1234)<br>    drop = TRUE))  # drop all other colData columns<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>class: SingleCellExperiment <br>dim: 7118 26820 <br>metadata(1): experiment_info<br>assays(2): counts logcounts<br>rownames(7118): NOC2L HES4 ... S100B PRMT2<br>rowData names(2): ENSEMBL SYMBOL<br>colnames(26820): AAACATACAATGCC-1 AAACATACATTTCC-1 ... TTTGCATGGTTTGG-1 TTTGCATGTCTTAC-1<br>colData names(3): cluster_id sample_id group_id<br>reducedDimNames(1): TSNE<br>mainExpName: NULL<br>altExpNames(0):<br></code></pre><p data-tool="mdnice编辑器">将聚类和样本 ID 以及聚类和样本的数量存储到以下简单变量中：</p><pre data-tool="mdnice编辑器"><span></span><code>nk &lt;- length(kids &lt;- levels(sce$cluster_id))<br>ns &lt;- length(sids &lt;- levels(sce$sample_id))<br>names(kids) &lt;- kids; names(sids) &lt;- sids<br><br>nk;ns<br>kids;sids<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>[1] 8<br>[1] 16<br>            B cells     CD14+ Monocytes         CD4 T cells         CD8 T cells     Dendritic cells   FCGR3A+ Monocytes <br>          <span>"B cells"</span>   <span>"CD14+ Monocytes"</span>       <span>"CD4 T cells"</span>       <span>"CD8 T cells"</span>   <span>"Dendritic cells"</span> <span>"FCGR3A+ Monocytes"</span> <br>     Megakaryocytes            NK cells <br>   <span>"Megakaryocytes"</span>          <span>"NK cells"</span> <br>   ctrl101   ctrl1015   ctrl1016   ctrl1039    ctrl107   ctrl1244   ctrl1256   ctrl1488    stim101   stim1015   stim1016   stim1039 <br> <span>"ctrl101"</span> <span>"ctrl1015"</span> <span>"ctrl1016"</span> <span>"ctrl1039"</span>  <span>"ctrl107"</span> <span>"ctrl1244"</span> <span>"ctrl1256"</span> <span>"ctrl1488"</span>  <span>"stim101"</span> <span>"stim1015"</span> <span>"stim1016"</span> <span>"stim1039"</span> <br>   stim107   stim1244   stim1256   stim1488 <br> <span>"stim107"</span> <span>"stim1244"</span> <span>"stim1256"</span> <span>"stim1488"</span> <br></code></pre><h2 data-tool="mdnice编辑器"><span></span>聚类样本大小</h2><pre data-tool="mdnice编辑器"><span></span><code># nb. of cells per cluster-sample<br>t(table(sce$cluster_id, sce$sample_id))<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>           B cells CD14+ Monocytes CD4 T cells CD8 T cells Dendritic cells FCGR3A+ Monocytes Megakaryocytes NK cells<br>  ctrl101      113             186         336          95               5                81             12       84<br>  ctrl1015     476             783         919         226              11               232             25      208<br>  ctrl1016     144             419         526         671              10               126             15      151<br>  ctrl1039      30             116         202          30               5                28              5       20<br>  ctrl107       51             222         197          31               2                29              5       49<br>  ctrl1244     134             429        1215          82              28                53             19      131<br>  ctrl1256     240             383        1136         156              12                50             15      275<br>  ctrl1488     234             317        1343          78              17                99             21      120<br>  stim101      144             222         437         121              20               126              7      120<br>  stim1015     357             683         814         153              17               222             24      224<br>  stim1016     129             361         426         600              10               124             12      239<br>  stim1039      39             154         318          40               7                36             13       32<br>  stim107       56             185         217          22               7                36              4       51<br>  stim1244      94             318         980          46              19                35             14      136<br>  stim1256     211             369        1047         133              16                73             21      257<br>  stim1488     283             370        1658          73              34               139             35      187<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>降维</h2><p data-tool="mdnice编辑器">可以发现直接提供的数据已经包含t-SNE降维坐标信息</p><pre data-tool="mdnice编辑器"><span></span><code># compute UMAP using 1st 20 PCs<br>sce &lt;- runUMAP(sce, pca = 20)<br></code></pre><p data-tool="mdnice编辑器">使用 scat 的 plotReducedDim 函数，我们可以分别绘制由clusters和groups ID 着色的 t-SNE 和 UMAP 表示。我们还创建了一个小的包装函数 .plot_dr()以提高颜色图例的可读性并简化绘图主题：</p><pre data-tool="mdnice编辑器"><span></span><code># wrapper to prettify reduced dimension plots<br>.plot_dr &lt;- function(sce, dr, col)<br>  plotReducedDim(sce, dimred = dr, colour_by = col) +<br>    guides(fill = guide_legend(override.aes = list(alpha = 1, size = 3))) +<br>    theme_minimal() + theme(aspect.ratio = 1)<br></code></pre><p data-tool="mdnice编辑器">对于我们的数据集，由cluster_ids着色的t-SNE和UMAP表明细胞群彼此分离良好。IFN-β刺激表现为当着色group_ids时细胞低维投影的剧烈变化，表明广泛的基因组规模发生转录变化。</p><pre data-tool="mdnice编辑器"><span></span><code># downsample to max. 100 cells per cluster<br>cs_by_k &lt;- split(colnames(sce), sce$cluster_id)<br>cs100 &lt;- unlist(sapply(cs_by_k, function(u) <br>  sample(u, min(length(u), 100))))<br><br># plot t-SNE &amp; UMAP colored by cluster &amp; group ID<br>for (dr in c("TSNE", "UMAP"))<br>  for (col in c("cluster_id", "group_id"))<br>    .plot_dr(sce[, cs100], dr, col)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd65VxFN0xaGcibVDjwln1UyWLiajsQ2VFoVAEJs5PuJNdCKksJMYEndKBw/640?wx_fmt=png" data-type="png" data-w="960" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd65VxFN0xaGcibVDjwln1UyWLiajsQ2VFoVAEJs5PuJNdCKksJMYEndKBw/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>差异状态（Differential State，DS）分析</h1><p data-tool="mdnice编辑器">为了测试不同条件下的状态变化，我们将考虑两种类型的方法：</p><ul data-tool="mdnice编辑器"><li><section>i）直接作用于<strong>细胞水平测量的混合模型</strong>;</section></li><li><section>ii） 作用于<strong>伪批量数据</strong>的基于聚合的方法。</section></li></ul><h2 data-tool="mdnice编辑器"><span></span>1.单细胞数据到pseudo（伪） bulk数据的聚合</h2><p data-tool="mdnice编辑器">为了利用现有的强大的bulk RNA-seq DE框架，如edgeR，DESeq2和limma，我们首先汇总每个样本（在每个分组中）的测量值以获得伪批量数据。</p><p data-tool="mdnice编辑器">通常，aggregateData() 将通过参数 by 指定的 colData 变量聚合数据，并返回包含伪批量数据的 SingleCellExperiment。</p><p data-tool="mdnice编辑器">对于 DS 分析，必须在聚类样本级别聚合测量值（默认值by = c("cluster_id", "sample_id"）。</p><p data-tool="mdnice编辑器">在这种情况下，返回的 SingleCellExperiment 将包含每个簇的一个测定，其中行 = 基因，列 = 样本。</p><blockquote data-tool="mdnice编辑器"><p>可以发现和bulk RNAseq的输入表达矩阵一致</p></blockquote><p data-tool="mdnice编辑器">参数assay和fun分别指定用于聚合的输入数据和汇总统计量。</p><p data-tool="mdnice编辑器">虽然原则上可以应用输入数据（原始/（对数）标准化计数，CPM等）和汇总统计数据（总和，平均值，中位数）的各种组合，但我们在这里<strong>默认为原始计数的总和</strong>：</p><pre data-tool="mdnice编辑器"><span></span><code>pb &lt;- aggregateData(sce,<br>    assay = "counts", fun = "sum",<br>    by = c("cluster_id", "sample_id"))<br># one sheet per subpopulation<br>assayNames(pb)  # cluster<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>[1] <span>"B cells"</span>           <span>"CD14+ Monocytes"</span>   <span>"CD4 T cells"</span>  <br>[4] <span>"CD8 T cells"</span>       <span>"Dendritic cells"</span>   <span>"FCGR3A+ Monocytes"</span><br>[7] <span>"Megakaryocytes"</span>    <span>"NK cells"</span> <br></code></pre><pre data-tool="mdnice编辑器"><span></span><code># pseudobulks for 1st subpopulation<br>t(head(assay(pb)))  # sample<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>         NOC2L HES4 ISG15 TNFRSF18 TNFRSF4 SDF4<br>ctrl101     12    0    13        8       1   13<br>ctrl1015    37    4   136       55      16   42<br>ctrl1016    13    3    42       10       0   15<br>ctrl1039     2    1    16        3       1    1<br>ctrl107      7    0     6        3       4    5<br>ctrl1244    24    7    25       30      11    7<br>ctrl1256    22    1    65       30      11   17<br>ctrl1488    19    1    34       27       6   23<br>stim101     12    8  1362        3       1    9<br>stim1015    34   27  4022       21       2   19<br>stim1016     7    8  1271        2       4    6<br>stim1039     3    3   393        1       1    2<br>stim107      4    2   556        1       0    3<br>stim1244    13   10   830        8       2    5<br>stim1256    14   10  2235       10       2    6<br>stim1488    18    5  2927       13       1   19<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>Pseudobulk-level MDS plot</h2><p data-tool="mdnice编辑器">multi-dimensional scaling (MDS) plot</p><p data-tool="mdnice编辑器">在进行任何正式测试之前，我们可以计算聚合信号的多维缩放（MDS）图，以探索整体样本的相似性。</p><p data-tool="mdnice编辑器">pbMDS 将 aggregateData 返回的任何包含 PB 数据的 SCE 作为输入，并使用 edgeR 计算 MDS 维度。理想情况下，数据的这种表示形式应将聚类和组彼此分开。反之亦然，来自同一聚类或组的样本应聚类在一起。</p><p data-tool="mdnice编辑器">在我们的关于伪散装计数的 MDS 图中可以观察到，第一维（MDS1）清楚地分离了细胞群（簇），而第二维（MDS2）分离了对照和受刺激的样本（组）。此外，两个T细胞簇彼此靠近。</p><pre data-tool="mdnice编辑器"><span></span><code>(pb_mds &lt;- pbMDS(pb))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6431451612903226" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd66TonkVMxCsoShxDgAWIYUCMk4FAafzAxcvVBibAnUpNOXsoGXYPSIFw/640?wx_fmt=png" data-type="png" data-w="992" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd66TonkVMxCsoShxDgAWIYUCMk4FAafzAxcvVBibAnUpNOXsoGXYPSIFw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>Sample-level analysis: Pseudobulk methods</h2><p data-tool="mdnice编辑器">一旦我们组装了伪批量数据，我们就可以使用 <code>pbDS</code> 测试 DS。默认情况下，<em>a∼group_id</em>模型拟合，并且测试线性模型的最后一个系数等于零。</p><pre data-tool="mdnice编辑器"><span></span><code># run DS analysis<br>res &lt;- pbDS(pb, verbose = FALSE)<br>res$table %&gt;% str()<br>res$table %&gt;% View()<br><br># access results table for 1st comparison<br>tbl &lt;- res$table[[1]]<br># one data.frame per cluster<br>names(tbl)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>[1] <span>"B cells"</span>           <span>"CD14+ Monocytes"</span>   <span>"CD4 T cells"</span>       <span>"CD8 T cells"</span>       <span>"Dendritic cells"</span>   <span>"FCGR3A+ Monocytes"</span><br>[7] <span>"Megakaryocytes"</span>    <span>"NK cells"</span> <br></code></pre><pre data-tool="mdnice编辑器"><span></span><code># view results for 1st cluster<br>k1 &lt;- tbl[[1]]  # B cells<br>head(format(k1[, -ncol(k1)], digits = 2))<br>B_deg_pseudobulk &lt;- format(k1[, -ncol(k1)], digits = 2)<br></code></pre><p data-tool="mdnice编辑器">选取Bcells进行展示</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5981963927855711" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6ibgwxjSLd2wXGtCAOItah2XkvUfvKLYNPiaGfYssNtPib0pZib3v5SzhfQ/640?wx_fmt=png" data-type="png" data-w="998" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6ibgwxjSLd2wXGtCAOItah2XkvUfvKLYNPiaGfYssNtPib0pZib3v5SzhfQ/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>pb$group_id<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code> [1] ctrl ctrl ctrl ctrl ctrl ctrl ctrl ctrl stim stim stim stim stim stim stim stim<br>Levels: ctrl stim<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>2.Cell-level analysis: Mixed models</h2><p data-tool="mdnice编辑器">作为上述<strong>样本水平</strong>方法的替代方案，我们将（针对每个基因）<strong>混合模型（MM）拟合到细胞水平</strong>的测量数据中。muscat提供了使用 3 种主要方法的 MM 实现：</p><ol data-tool="mdnice编辑器"><li><section>对数归一化数据与观测权重的线性混合模型（LMM）拟合；</section></li><li><section>在方差稳定数据上拟合LMM;</section></li><li><section>直接在计数上拟合广义线性混合模型 （GLMM）</section></li></ol><p data-tool="mdnice编辑器">在每种情况下，a∼1+group_id+(1|sample_id)模型适合每个基因，优化对数似然（即REML = FALSE，P 值使用参数 df（默认"Satterthwaite") 指定的自由度估计值计算。拟合、测试和适度按亚群维度被应用。对于差异分析，mmDS将仅考虑：</p><ul data-tool="mdnice编辑器"><li><section>在至少 <code>n_samples</code> 个样本中至少有 <code>n_cells</code> 个细胞（默认为 10 个）的亚群</section></li><li><section>计数为 &gt;= <code>min_count</code>（默认值 1）的基因至少在 <code>min_cells</code>（默认值 20）中</section></li></ul><blockquote data-tool="mdnice编辑器"><p>耗时占用资源过多，未跑完结果</p></blockquote><h2 data-tool="mdnice编辑器"><span></span>FindMarkers</h2><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247494678&amp;idx=1&amp;sn=9adbc5f89b9109dba2d4b8655e57f9d1&amp;scene=21#wechat_redirect" data-linktype="2">任意细胞亚群的差异分析</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5OTYzMzY5Ng==&amp;mid=2247486232&amp;idx=1&amp;sn=832f8e36ce86afa8ae1ef4771d03c4e2&amp;scene=21#wechat_redirect" data-linktype="2">单细胞差异基因分析：pseudobulk（muscat包）</a></p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>sce_seurat &lt;- as.Seurat(sce)<br>sce_seurat<br>View(sce_seurat)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>An object of class Seurat <br>7118 features across 26820 samples within 1 assay <br>Active assay: originalexp (7118 features, 0 variable features)<br> 2 dimensional reductions calculated: TSNE, UMAP<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>Bcells &lt;- subset(sce_seurat, cluster_id=="B cells")<br>Bcells<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>An object of class Seurat <br>7118 features across 2735 samples within 1 assay <br>Active assay: originalexp (7118 features, 0 variable features)<br> 2 dimensional reductions calculated: TSNE, UMAP<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code># Idents(sce_seurat) %&gt;% head()<br># sce_seurat@meta.data %&gt;% colnames()<br># sce_seurat &lt;- SetIdent(sce_seurat,value = "cluster_id")<br># Idents(sce_seurat) %&gt;% head()<br><br>B_markers_found &lt;- FindMarkers(Bcells,<br>                             min.pct = 0,logfc.threshold = 0,<br>                             slot = "counts",<br>                             group.by = "group_id",ident.1 = "ctrl",ident.2 = "stim")<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6036585365853658" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6OhdBXMMKd4B5aqlIxO2m4aeFF7bSTMuzwL94NnsRA6nemJFsiaBr8iaw/640?wx_fmt=png" data-type="png" data-w="984" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6OhdBXMMKd4B5aqlIxO2m4aeFF7bSTMuzwL94NnsRA6nemJFsiaBr8iaw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>比较Bcells结果FindMarkers vs pseudoBulk（muscat）</h2><pre data-tool="mdnice编辑器"><span></span><code>B_deg_pseudobulk$abs_logfc &lt;- B_deg_pseudobulk$logFC %&gt;% as.numeric() %&gt;% abs()<br>B_markers_found$abs_logfc &lt;- B_markers_found$avg_log2FC %&gt;% as.numeric() %&gt;% abs()<br><br>B_deg_pseudobulk$reg &lt;- ifelse(B_deg_pseudobulk$abs_logfc&gt;1&amp;as.numeric(B_deg_pseudobulk$p_val)&lt;0.05,"deg","normal")<br>table(B_deg_pseudobulk$reg)<br><br>B_markers_found$reg &lt;- ifelse(B_markers_found$abs_logfc&gt;1&amp;as.numeric(B_markers_found$p_val)&lt;0.05,"deg","normal")<br>table(B_markers_found$reg)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>   deg normal <br>   238   1729<br>   deg normal <br>    17   7101 <br></code></pre><p data-tool="mdnice编辑器">Pseudobulk鉴定了更多的DEGs</p><p data-tool="mdnice编辑器">看看FindMakers的结果在不在Pseudobulk的结果中：</p><pre data-tool="mdnice编辑器"><span></span><code>table(rownames(B_markers_found)[B_markers_found$reg=="deg"] %in% B_deg_pseudobulk$gene[B_deg_pseudobulk$reg=="deg"])<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>FALSE  TRUE <br>    1    16 <br></code></pre><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>MAST</h1><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247511067&amp;idx=1&amp;sn=cbab989bfda6f7e3eb51ab1eaa5be98b&amp;scene=21#wechat_redirect" data-linktype="2">单细胞分析工具--MAST差异基因分析</a></p><p data-tool="mdnice编辑器">Using MAST with RNASeq: MAIT Analysis. （http://bioconductor.org/packages/release/bioc/vignettes/MAST/inst/doc/MAITAnalysis.html）</p><p data-tool="mdnice编辑器">1、示例数据</p><p data-tool="mdnice编辑器">经细胞因子刺激前后的MAITs细胞的单细胞表达数据，使用MAST包分析其差异表达基因。</p><pre data-tool="mdnice编辑器"><span></span><code>data(maits, package='MAST')<br>dim(maits$expressionmat) #共96个细胞<br># [1]    96 16302<br>maits$expressionmat[1:4,1:4]<br>head(maits$cdat) #细胞注释数据<br>head(maits$fdat) #基因注释数据<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>##整理表达矩阵，使用symbol作为基因名<br>idx = -which(duplicated(maits$fdat$symbolid))<br>maits$fdat = maits$fdat[idx,]<br>maits$fdat = maits$fdat[,-1]<br>rownames(maits$fdat) = maits$fdat$symbolid<br>maits$expressionmat = maits$expressionmat[,idx]<br>colnames(maits$expressionmat) = rownames(maits$fdat)<br><br>maits$expressionmat[1:4,1:4]<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>head(maits$fdat)<br></code></pre><p data-tool="mdnice编辑器">2、构建SingleCellAssay对象</p><pre data-tool="mdnice编辑器"><span></span><code>library(MAST)<br>sca = FromMatrix(t(maits$expressionmat), maits$cdat, maits$fdat)<br>## 方便演示，随机筛选出2000个基因<br>sca = sca[unique(sample(rownames(sca),2000)),]<br>dim(sca)<br># [1] 2000    96<br>sca<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>## (1) 目标分组<br>colData(sca)<br>table(colData(sca)$condition)<br># Stim Unstim <br># 47     49 <br>## 将Unstim设置为参考组<br>cond&lt;-factor(colData(sca)$condition)<br>cond&lt;-relevel(cond,"Unstim")<br>cond  # Levels: Unstim Stim<br>colData(sca)$condition&lt;-cond<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>## (2) 考虑一个协变量因素<br>summary(colData(sca)$cngeneson)<br>#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. <br># -0.17159 -0.02578  0.01408  0.00000  0.05943  0.15415<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>## (3) 模拟一个分类变量分组因素<br>set.seed(123)<br>colData(sca)$region = sample(letters[1:3], ncol(sca), replace=T)<br>table(colData(sca)$region)<br># a  b  c <br>#32 31 33<br></code></pre><p data-tool="mdnice编辑器">3、回归分析</p><p data-tool="mdnice编辑器">MAST做差异分析的主要优势在于可以校正多种协变量因素，如下演示几种常用的用法。</p><pre data-tool="mdnice编辑器"><span></span><code><span>## (1) 校正cngeneson协变量:默认参数</span><br>zlmCond &lt;- zlm(~condition + cngeneson, sca,<br>    method=<span>"bayesglm"</span>, ebayes=TRUE)<br>summaryCond &lt;- summary(zlmCond, doLRT=<span>'conditionStim'</span>)<br>summaryDt &lt;- summaryCond<span>$datatable</span><br>levels(summaryDt<span>$contrast</span>)<br><span># [1] "conditionStim" "(Intercept)"   "cngeneson"</span><br><br><span>## (2) 校正cngeneson与region协变量:默认参数</span><br>zlmCond &lt;- zlm(~condition + cngeneson + region, sca, <br>    method = <span>"bayesglm"</span>, ebayes=TRUE)<br>summaryCond &lt;- summary(zlmCond, doLRT=<span>'conditionStim'</span>)<br>summaryDt &lt;- summaryCond<span>$datatable</span><br>levels(summaryDt<span>$contrast</span>)<br><span># [1] "conditionStim" "(Intercept)"   "cngeneson"     "regionb"       "regionc"</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>## (3) 校正cngeneson协变量，将region认为是随机因素<br>zlmCond &lt;- zlm(~condition + cngeneson + (1|region), sca, <br>    method = "glmer", ebayes=FALSE)<br>summaryCond &lt;- summary(zlmCond, doLRT='conditionStim')<br>summaryDt &lt;- summaryCond$datatable<br>levels(summaryDt$contrast)<br># [1] "conditionStim" "(Intercept)"   "cngeneson"<br></code></pre><p data-tool="mdnice编辑器">汇总差异基因结果</p><pre data-tool="mdnice编辑器"><span></span><code>df_pval = summaryDt %&gt;% <br>    filter(contrast=='conditionStim') %&gt;% <br>    filter(component=='H') %&gt;% <br>    select(primerid, `Pr(&gt;Chisq)`)<br><br>df_logfc = summaryDt %&gt;% <br>    filter(contrast=='conditionStim') %&gt;% <br>    filter(component=='logFC') %&gt;% <br>    select(primerid, coef, ci.hi, ci.lo)<br><br>df_stat = inner_join(df_logfc, df_pval) %&gt;% <br>    rename("primerid"="symbol") %&gt;% <br>    rename("Pr(&gt;Chisq)"="pval","coef"="logFC") %&gt;% <br>    mutate("fdr" = p.adjust(pval)) %&gt;% <br>    arrange(fdr)<br><br>dim(df_stat)<br>dim(na.omit(df_stat))<br>df_stat &lt;- na.omit(df_stat) %&gt;% arrange(fdr) %&gt;% mutate("abs_logfc"=abs(logFC))<br>head(df_stat)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>   symbol     logFC     ci.hi     ci.lo         pval          fdr abs_logfc<br>1:     U1 -3.980627 -3.248247 -4.713007 1.857517e-16 3.694601e-13  3.980627<br>2:  PSAT1  7.090388  8.553495  5.627281 8.466767e-16 1.683193e-12  7.090388<br>3:  DUSP1 -6.513010 -5.260700 -7.765321 8.668938e-15 1.722518e-11  6.513010<br>4: L26953  4.839456  6.001081  3.677831 1.201518e-11 2.386214e-08  4.839456<br>5:  PSMA5  4.989426  6.218109  3.760743 3.346791e-11 6.643381e-08  4.989426<br>6:    JUN -4.171474 -3.213458 -5.129490 4.173966e-11 8.281148e-08  4.171474<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>FindMarkers</h2><pre data-tool="mdnice编辑器"><span></span><code>maits$expressionmat[1:4,1:4]<br>counts &lt;- maits$expressionmat %&gt;% t()<br>counts[1:4,1:4]<br>mysce &lt;- CreateSeuratObject(counts = counts[rownames(counts) %in% rownames(sca),])<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>dim(mysce)<br>colData(sca)$condition %&gt;% table()<br>mysce$group_id &lt;- colData(sca)$condition<br>mysce$group_id %&gt;% table()<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>[1] 2000   96<br>.<br>Unstim   Stim <br>    49     47 <br>.<br>Unstim   Stim <br>    49     47 <br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>markers_found &lt;- FindMarkers(mysce,min.pct = 0,logfc.threshold = 0,<br>                             slot = "counts",group.by = "group_id",<br>                             ident.1 = "Unstim", ident.2 = "Stim")<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>|++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=03s  <br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>markers_found &lt;- markers_found %&gt;% arrange(p_val) %&gt;% mutate("abs_logfc"=abs(avg_log2FC))<br>head(markers_found)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>             p_val avg_log2FC pct.1 pct.2    p_val_adj abs_logfc<br>DUSP1 2.478956e-14  2.2429608 0.980 0.766 4.957912e-11 2.2429608<br>JUND  4.125845e-14  1.1074815 0.959 0.936 8.251689e-11 1.1074815<br>PSMA5 1.810076e-11 -1.5517307 0.714 1.000 3.620153e-08 1.5517307<br>RPL34 3.458046e-11  0.2375686 1.000 1.000 6.916093e-08 0.2375686<br>SMS   6.266779e-11 -1.7052944 0.143 0.787 1.253356e-07 1.7052944<br>SRP19 1.410429e-10 -1.5377399 0.510 0.957 2.820858e-07 1.5377399<br></code></pre><h1 data-tool="mdnice编辑器"><span></span>比较结果Findmarkers vs MAST</h1><p data-tool="mdnice编辑器">注意我们只随机取了两千个基因（MAST，MM模型，耗时）</p><pre data-tool="mdnice编辑器"><span></span><code>df_stat$reg &lt;- ifelse(df_stat$abs_logfc&gt;1&amp;as.numeric(df_stat$pval)&lt;0.05,"deg","normal")<br>table(df_stat$reg)<br><br>markers_found$reg &lt;- ifelse(markers_found$abs_logfc&gt;1&amp;as.numeric(markers_found$p_val)&lt;0.05,"deg","normal")<br>table(markers_found$reg)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>   deg normal <br>   381   1378 <br><br>   deg normal <br>   149   1851 <br></code></pre><p data-tool="mdnice编辑器">可以发现MAST鉴定了更多的差异表达基因</p><pre data-tool="mdnice编辑器"><span></span><code>table(rownames(markers_found)[markers_found<span>$reg</span>==<span>"deg"</span>] %<span>in</span>% df_stat<span>$symbol</span>[df_stat<span>$reg</span>==<span>"deg"</span>])<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>FALSE  TRUE <br>   23   126 <br></code></pre><p data-tool="mdnice编辑器">FindMarkers的大部分结果还是在MAST中的</p><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>distinct</h1><p data-tool="mdnice编辑器">参考：</p><p data-tool="mdnice编辑器">distinct: a method for differential analyses via hierarchical permutation tests(https://github.com/SimoneTiberi/distinct) github</p><p data-tool="mdnice编辑器">https://bioconductor.org/packages/release/bioc/vignettes/distinct/inst/doc/distinct.html</p><p data-tool="mdnice编辑器">distinct是一种在两组或多组分布之间执行差异分析的统计方法；差异分析是通过对每个样本的累积分布函数（cdfs）进行非参数排列检验来进行的。distinct是一种通用且灵活的工具：由于其<strong>完全非参数</strong>性质，对数据的生成方式没有任何假设，因此它可以应用于各种数据集。特别适合对单细胞数据进行差异状态分析（即，细胞亚群内的差异分析），例如单细胞RNA测序（scRNA-seq）和高维流式或质谱仪（HDCyto）数据。该方法还考虑了干扰协变量（如批处理效应）。</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br># BiocManager::install("distinct")<br>library(Seurat)<br>library(distinct)<br></code></pre><p data-tool="mdnice编辑器">1.加载示例数据</p><p data-tool="mdnice编辑器">由 6 个样本的子集（在 2 个条件下观察到的 3 个个体）和从 muscData 包的 Kang18_8vs8() 对象中选择的 100 个基因组成</p><pre data-tool="mdnice编辑器"><span></span><code>library(SingleCellExperiment)<br>data("Kang_subset", package = "distinct")<br>Kang_subset<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>class: SingleCellExperiment <br>dim: 100 9517 <br>metadata(1): experiment_info<br>assays(2): logcounts cpm<br>rownames(100): ISG15 SYF2 ... MX2 PDXK<br>rowData names(0):<br>colnames: NULL<br>colData names(3): stim cell sample_id<br>reducedDimNames(0):<br>mainExpName: NULL<br>altExpNames(0):<br></code></pre><p data-tool="mdnice编辑器">colData的ind列和stim表示每个细胞的个体ID和实验条件（对照或处理），而sample_id列显示差异分析所需的样品ID。对每个cell聚类分别执行条件之间的差异测试。请注意，如果细胞聚类标签未知，我们需要通过某种聚类算法将细胞聚类到组中。</p><pre data-tool="mdnice编辑器"><span></span><code>colData(Kang_subset)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>DataFrame with 9517 rows and 3 columns<br>         stim            cell sample_id<br>     &lt;factor&gt;        &lt;factor&gt;  &lt;factor&gt;<br>1        ctrl CD4 T cells     ctrl_107 <br>2        ctrl CD14+ Monocytes ctrl_1015<br>3        ctrl NK cells        ctrl_1015<br>4        ctrl CD4 T cells     ctrl_107 <br>5        ctrl CD14+ Monocytes ctrl_1015<br>...       ...             ...       ...<br>9513     stim CD14+ Monocytes stim_1015<br>9514     stim CD4 T cells     stim_101 <br>9515     stim CD14+ Monocytes stim_101 <br>9516     stim CD14+ Monocytes stim_107 <br>9517     stim CD4 T cells     stim_107 <br></code></pre><p data-tool="mdnice编辑器">实验设计比较两组（stim与ctrl），每组有3个生物学重复</p><pre data-tool="mdnice编辑器"><span></span><code>Kang_subset@metadata$experiment_info<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>  sample_id stim<br>1  ctrl_107 ctrl<br>2 ctrl_1015 ctrl<br>3  ctrl_101 ctrl<br>4  stim_101 stim<br>5 stim_1015 stim<br>6  stim_107 stim<br></code></pre><p data-tool="mdnice编辑器">2.设计实验</p><pre data-tool="mdnice编辑器"><span></span><code>samples = Kang_subset@metadata$experiment_info$sample_id<br>group = Kang_subset@metadata$experiment_info$stim<br>design = model.matrix(~group)<br># rownames of the design must indicate sample ids:<br>rownames(design) = samples<br>design<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>          (Intercept) groupstim<br>ctrl_107            1         0<br>ctrl_1015           1         0<br>ctrl_101            1         0<br>stim_101            1         1<br>stim_1015           1         1<br>stim_107            1         1<br>attr(,<span>"assign"</span>)<br>[1] 0 1<br>attr(,<span>"contrasts"</span>)<br>attr(,<span>"contrasts"</span>)<span>$group</span><br>[1] <span>"contr.treatment"</span><br></code></pre><p data-tool="mdnice编辑器">在条件之间执行差异分析。参数 name_assays_expression 指定assays(x)） 中的输入数据（对数counts），而name_cluster和name_sample定义包含细胞聚类（细胞）和单个样本 ID （sample_id） 的 colData(x) 的列名。我们要测试的组位于设计的第二列中，因此我们将指定：column_to_test = 2。</p><p data-tool="mdnice编辑器">请注意，colData(x)$name_sample 中的样本名称必须与 rownames(design) 中的样本名称相同（尽管顺序不一定相同）。</p><pre data-tool="mdnice编辑器"><span></span><code>rownames(design)<br><br>unique(colData(Kang_subset)$sample_id)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>[1] <span>"ctrl_107"</span>  <span>"ctrl_1015"</span> <span>"ctrl_101"</span>  <span>"stim_101"</span>  <span>"stim_1015"</span> <span>"stim_107"</span> <br>[1] ctrl_107  ctrl_1015 ctrl_101  stim_101  stim_1015 stim_107 <br>Levels: ctrl_101 ctrl_1015 ctrl_107 stim_101 stim_1015 stim_107<br></code></pre><p data-tool="mdnice编辑器">3.差异分析</p><p data-tool="mdnice编辑器">为了获得最重要基因的更精细排名，如果计算资源允许，我们鼓励用户增加P_4（即，原始p值&lt;0.001时的排列数量）并设置P_4 = 20，000（默认情况下P_4 = 10,000).</p><p data-tool="mdnice编辑器">强烈建议使用<strong>标准化数据</strong>，例如每百万次counts （CPM） 或 log2-CPM（例如，通过 scater::logNormCounts 创建的logcounts）).</p><blockquote data-tool="mdnice编辑器"><p><strong>前面的方法用的都是raw counts</strong></p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>set.seed(61217)<br><br>res = distinct_test(x = Kang_subset, <br>                    name_assays_expression = "logcounts",<br>                    name_cluster = "cell",<br>                    name_sample = "sample_id",<br>                    design = design,<br>                    column_to_test = 2,<br>                    min_non_zero_cells = 20,<br>                    n_cores = 2)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>2 groups of samples provided<br>Data loaded, starting differential testing<br>Differential testing completed, returning results<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>head(res)<br>table(res$cluster_id)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>     gene cluster_id      p_val  p_adj.loc    p_adj.glb filtered  mean_ctrl  mean_stim FC_ctrl/stim log2FC_ctrl/stim<br>1   ISG15    B cells 0.00009999 0.00139986 0.0007650398    FALSE  198.05692 8577.04339   0.02309151       -5.4364934<br>2    SYF2    B cells 0.41584158 0.60824590 0.6162697351    FALSE  333.73137  285.50405   1.16891993        0.2251761<br>3  LAPTM5    B cells 0.01349325 0.10171837 0.0551463399    FALSE 1495.39376 1185.58215   1.26131602        0.3349298<br>4   EIF3I    B cells 0.91089109 0.94965241 0.9528876576    FALSE  259.08484  233.50382   1.10955291        0.1499785<br>5 PRPF38A    B cells 0.04590818 0.17303854 0.1379341773    FALSE   61.89912   78.05793   0.79298948       -0.3346264<br>6   GTF2B    B cells 0.38613861 0.59127475 0.5881463146    FALSE   98.64613  109.72591   0.89902308       -0.1535699<br><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>          B cells   CD14+ Monocytes       CD4 T cells       CD8 T cells   Dendritic cells FCGR3A+ Monocytes <br>              100               100               100               100               100               100 <br>   Megakaryocytes          NK cells <br>              100               100 <br></code></pre><p data-tool="mdnice编辑器">结果以data.frame的形式报告，其中gene和cluster_id列包含基因和细胞簇名称，而p_val，p_adj.loc通过p_adj.glbBenjamini和Hochberg（BH）校正报告原始p值，局部和全局调整的p值。在局部调整的 p 值 （p_adj.loc） 中，BH 校正分别应用于每个聚类，而在全局调整的 p 值 （p_adj.glb） 中，对所有聚类的结果执行 BH 校正。</p><p data-tool="mdnice编辑器">我们可以进一步计算组之间的倍数变化（FC）和log2-FC。要计算FCs，请使用标准化数据，例如cpm;<strong>不要使用对数转换数据（例如，logcounts）。</strong></p><pre data-tool="mdnice编辑器"><span></span><code>res = log2_FC(res = res,<br>              x = Kang_subset, <br>              name_assays_expression = "cpm",<br>              name_group = "stim",<br>              name_cluster = "cell")<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>FC and log2_FC computed, returning results<br></code></pre><p data-tool="mdnice编辑器">取出Bcells的deg结果：</p><pre data-tool="mdnice编辑器"><span></span><code>bcells_distinct &lt;- res[res$cluster_id=="B cells",]<br>head(bcells_distinct)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>     gene cluster_id      p_val  p_adj.loc    p_adj.glb filtered  mean_ctrl  mean_stim FC_ctrl/stim log2FC_ctrl/stim abs_logfc    reg<br>1   ISG15    B cells 0.00009999 0.00139986 0.0007650398    FALSE  198.05692 8577.04339   0.02309151       -5.4364934 5.4364934    deg<br>2    SYF2    B cells 0.41584158 0.60824590 0.6162697351    FALSE  333.73137  285.50405   1.16891993        0.2251761 0.2251761 normal<br>3  LAPTM5    B cells 0.01349325 0.10171837 0.0551463399    FALSE 1495.39376 1185.58215   1.26131602        0.3349298 0.3349298 normal<br>4   EIF3I    B cells 0.91089109 0.94965241 0.9528876576    FALSE  259.08484  233.50382   1.10955291        0.1499785 0.1499785 normal<br>5 PRPF38A    B cells 0.04590818 0.17303854 0.1379341773    FALSE   61.89912   78.05793   0.79298948       -0.3346264 0.3346264 normal<br>6   GTF2B    B cells 0.38613861 0.59127475 0.5881463146    FALSE   98.64613  109.72591   0.89902308       -0.1535699 0.1535699 normal<br></code></pre><p data-tool="mdnice编辑器">此外，distinct还可以 处理协变量和批处理效应</p><h2 data-tool="mdnice编辑器"><span></span>FindMarkers</h2><p data-tool="mdnice编辑器">distinct用的logcounts这里我们也用logcounts</p><pre data-tool="mdnice编辑器"><span></span><code>Kang_subset<br>Kang_subset@assays@data$logcounts %&gt;% colnames() %&gt;% head()<br>counts &lt;- Kang_subset@assays@data$logcounts %&gt;% SparseM::as.matrix()<br>counts[1:4,1:4]<br>dim(counts)<br>table(Kang_subset$stim)<br>colnames(counts) &lt;- Kang_subset$sample_id<br>kang_seurat &lt;- CreateSeuratObject(counts = counts)<br></code></pre><p data-tool="mdnice编辑器">感觉SingleCellExperiment对象 <code>colData</code>函数取出来的像是Seurat对象的metadata</p><pre data-tool="mdnice编辑器"><span></span><code>colData(Kang_subset)<br>kang_seurat$group_id &lt;- Kang_subset$stim<br>kang_seurat$celltype &lt;- Kang_subset$cell<br></code></pre><p data-tool="mdnice编辑器">取出Bcells</p><pre data-tool="mdnice编辑器"><span></span><code>kang_seurat_bcells &lt;- subset(kang_seurat,celltype=="B cells")<br>table(kang_seurat_bcells$celltype)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>          B cells   CD14+ Monocytes       CD4 T cells       CD8 T cells   Dendritic cells FCGR3A+ Monocytes <br>             1246                 0                 0                 0                 0                 0 <br>   Megakaryocytes          NK cells <br>                0                 0 <br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>kangB_markers_found &lt;- FindMarkers(kang_seurat_bcells,min.pct = 0,logfc.threshold = 0,<br>                             slot = "counts",group.by = "group_id",<br>                             ident.1 = "ctrl", ident.2 = "stim")<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>head(kangB_markers_found)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>              p_val avg_log2FC pct.1 pct.2     p_val_adj abs_logfc    reg<br>ISG15 1.768192e-216 -1.9237559 0.168 0.991 1.768192e-214 1.9237559    deg<br>MX2    2.722777e-62 -0.6442930 0.038 0.431  2.722777e-60 0.6442930 normal<br>PSME2  3.444846e-42 -0.5201504 0.497 0.812  3.444846e-40 0.5201504 normal<br>RPL7   7.601723e-31  0.1705121 0.994 0.969  7.601723e-29 0.1705121 normal<br>SPI1   2.603640e-16  0.2425778 0.165 0.026  2.603640e-14 0.2425778 normal<br>PRDX5  1.645329e-14  0.3127005 0.333 0.153  1.645329e-12 0.3127005 normal<br></code></pre><h1 data-tool="mdnice编辑器"><span></span>结果比较FindMarkers vs distinct</h1><pre data-tool="mdnice编辑器"><span></span><code>bcells_distinct$abs_logfc &lt;- abs(bcells_distinct$`log2FC_ctrl/stim`)<br>kangB_markers_found$abs_logfc &lt;- abs(kangB_markers_found$avg_log2FC)<br><br>bcells_distinct$reg &lt;- ifelse(bcells_distinct$abs_logfc&gt;1&amp;as.numeric(bcells_distinct$p_val)&lt;0.05,"deg","normal")<br>table(bcells_distinct$reg)<br><br>kangB_markers_found$reg &lt;- ifelse(kangB_markers_found$abs_logfc&gt;1&amp;as.numeric(kangB_markers_found$p_val)&lt;0.05,"deg","normal")<br>table(kangB_markers_found$reg)<br><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>   deg normal <br>    16     84 <br><br>   deg normal <br>     1     99<br></code></pre><p data-tool="mdnice编辑器">看一下是不是全部基因数量size的影响</p><pre data-tool="mdnice编辑器"><span></span><code>kang_markers_found &lt;- FindMarkers(kang_seurat,min.pct = 0,logfc.threshold = 0,<br>                             slot = "counts",group.by = "group_id",<br>                             ident.1 = "ctrl", ident.2 = "stim")<br>kang_markers_found$abs_logfc &lt;- abs(kang_markers_found$avg_log2FC)<br>kang_markers_found$reg &lt;- ifelse(kang_markers_found$abs_logfc&gt;1&amp;as.numeric(kang_markers_found$p_val)&lt;0.05,"deg","normal")<br>table(kang_markers_found$reg)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>   deg normal <br>     1     99 <br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>&gt; kang_markers_found[kang_markers_found$reg=="deg",]<br>      p_val avg_log2FC pct.1 pct.2 p_val_adj abs_logfc reg<br>ISG15     0  -2.008996 0.258 0.989         0  2.008996 deg<br>&gt; kangB_markers_found[kangB_markers_found$reg=="deg",]<br>              p_val avg_log2FC pct.1 pct.2     p_val_adj abs_logfc reg<br>ISG15 1.768192e-216  -1.923756 0.168 0.991 1.768192e-214  1.923756 deg<br></code></pre><p data-tool="mdnice编辑器">可以发现参与差异分析的基因数量size对结果有影响但不大</p><pre data-tool="mdnice编辑器"><span></span><code>"ISG15" %in% bcells_distinct$gene<br># TRUE<br></code></pre><p data-tool="mdnice编辑器">distinct找到了更多的差异表达基因，结果的格式类似前面的muscat</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">就在我写这篇推送的时候发现最近我们自己和一些其他的公众号也写了推文介绍一系列做单细胞样本间差异表达分析的方法，可惜我检索整理资料基本上是在8月中旬完成的，没有覆盖到这部分</p><p data-tool="mdnice编辑器">这里贴出，作为参考：</p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515825&amp;idx=1&amp;sn=e691ab4c5179ea334f8b68759ff51301&amp;scene=21#wechat_redirect" data-linktype="2">muscat：专注于多样本多分组的单细胞差异分析</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515860&amp;idx=1&amp;sn=0e0dcb60296bf0d7cacd3f606b63f18c&amp;scene=21#wechat_redirect" data-linktype="2">muscat代码实操（一）：模拟复杂的 scRNA-seq 数据以及评估不同的差异表达分析方法的性能</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515486&amp;idx=1&amp;sn=8843633037afc6e5f375d3433465db73&amp;scene=21#wechat_redirect" data-linktype="2">Libra：单细胞差异分析算法的全家桶</a></p><blockquote data-tool="mdnice编辑器"><p>开发这个包的灵感来源于之前Seurat和Muscat包（muscat：专注于多样本多分组的单细胞差异分析），但是这两个包都是从不同的单一角度着手，虽各有所长，但适用场景有限。而Libra着手于解决一站式解决scRNA-seq差异分析，其总共集成了22种不同的差异分析算法，这些方法都可以从一个函数中访问，其中包括传统的单细胞方法以及包括pseudobulk和mixed model方法在内的所有主流算法。</p></blockquote><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>clusters间的差异分析鉴定marker</h1><p data-tool="mdnice编辑器">区别于上一部分，我们这里第二部分是“计算<strong>来自两个簇的细胞之间的差异表达基因以用于标记基因鉴定或细胞类型注释</strong>”，所以可以用官方提供的pbmc<strong>单样本</strong>数据集</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br># devtools::install_github('satijalab/seurat-data')<br>library(SeuratData) #加载seurat数据集  <br>getOption('timeout')<br>options(timeout=10000)<br>InstallData("pbmc3k")<br>data("pbmc3k")  <br>sce &lt;- pbmc3k.final   <br>library(Seurat)<br>DimPlot(sce,label = T,repel = T)<br></code></pre><p data-tool="mdnice编辑器">这里直接获取降维等处理好的数据</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; sce<br>An object of class Seurat <br>13714 features across 2638 samples within 1 assay <br>Active assay: RNA (13714 features, 2000 variable features)<br> 2 dimensional reductions calculated: pca, umap<br></code></pre><p data-tool="mdnice编辑器">需要理解具体走了哪些处理可以参考 <a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247514316&amp;idx=1&amp;sn=139a39771f22b6e7a484523313909f4c&amp;chksm=ea1cbe4edd6b3758f6c9564ca49ff66db7ea727ddf9d2391fa4a88132ac8f582a336ffcfd157&amp;scene=21&amp;cur_album_id=3019915773533913092#wechat_redirect" data-linktype="2">初探单细胞下游</a> ，同样也是官方的pbmc示例数据</p><h2 data-tool="mdnice编辑器"><span></span>FindAllMarkers</h2><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247505228&amp;idx=1&amp;sn=8c0d690636dd3c82bea50def8563a31d&amp;chksm=fa451071cd32996735c3a215a11c406d5b5fea037e5c2e9dfd55fb4effe21ef8c924019394c3&amp;scene=21&amp;cur_album_id=2546857217690632193#wechat_redirect" data-linktype="2">整合素β1基因敲除前后小鼠肺腺癌上皮细胞水平变化</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513489&amp;idx=1&amp;sn=fffb8aac0b6d6b984fb4f0966b09074f&amp;scene=21#wechat_redirect" data-linktype="2">速度上吊打FindAllMarkers的单细胞亚群特异性高表达基因查询算法</a></p></blockquote><p data-tool="mdnice编辑器">这里开了4个线程，主要是针对 <code>FindAllMarkers</code> 函数</p><pre data-tool="mdnice编辑器"><span></span><code>library(future)<br># check the current active plan<br>plan()<br>plan("multisession", workers = 4)<br>plan()<br>start = Sys.time()<br>sce.markers &lt;- FindAllMarkers(object = sce, only.pos = TRUE, <br>                              min.pct = 0.25, <br>                              thresh.use = 0.25)<br>end = Sys.time() <br>dur = end-start <br>dur<br></code></pre><p data-tool="mdnice编辑器">这里开了4个线程，主要是针对 <code>FindAllMarkers</code> 函数</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5654993514915694" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6H794m2mmvx1NgcCwc1aH7kYF07Pyn3GCibymHDM1QUUqKxic9bqngRdA/640?wx_fmt=png" data-type="png" data-w="771" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6H794m2mmvx1NgcCwc1aH7kYF07Pyn3GCibymHDM1QUUqKxic9bqngRdA/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.3847715736040609" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6IPNBznI3ibcXVGubSHQcaSMjJuib3hVg9qiaCaJyqzD8ibBtELia97Dliaew/640?wx_fmt=png" data-type="png" data-w="985" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6IPNBznI3ibcXVGubSHQcaSMjJuib3hVg9qiaCaJyqzD8ibBtELia97Dliaew/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.21881390593047034" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6R8XZf5MgJ99n1ploQliaEhicCpsPkhk1S9XSA64YLRdbOtUg8SqwGArQ/640?wx_fmt=png" data-type="png" data-w="978" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6R8XZf5MgJ99n1ploQliaEhicCpsPkhk1S9XSA64YLRdbOtUg8SqwGArQ/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p>每个单细胞亚群都有几百个左右的基因被挑选出来，9个单细胞亚群就是2885个基因，当然了，每个基因的特异性并不一样</p></blockquote><h2 data-tool="mdnice编辑器"><span></span>COSG</h2><p data-tool="mdnice编辑器">参考：</p><blockquote data-tool="mdnice编辑器"><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513489&amp;idx=1&amp;sn=fffb8aac0b6d6b984fb4f0966b09074f&amp;scene=21#wechat_redirect" data-linktype="2">速度上吊打FindAllMarkers的单细胞亚群特异性高表达基因查询算法</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247514149&amp;idx=1&amp;sn=5a2b1ecfd288afd7ee9073b44bb87704&amp;scene=21#wechat_redirect" data-linktype="2">单细胞分析工具||COSG鉴定marker基因</a></p><p>【单细胞】上下游，合体！</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>#remotes::install_github(repo = 'genecell/COSGR')<br>start = Sys.time()<br>library(COSG)<br>marker_cosg &lt;- cosg(<br>  sce,<br>  groups='all',<br>  assay='RNA',<br>  slot='data',<br>  mu=1,<br>  n_genes_user=100)<br>end = Sys.time() <br>dur = end-start <br>dur<br></code></pre><p data-tool="mdnice编辑器">参数说明如下：</p><ul data-tool="mdnice编辑器"><li><section><code>sce</code>是一个SingleCellExperiment对象，其中包含了RNA-seq数据。</section></li><li><section><code>groups='all'</code>用于定义要分析的细胞组。在这里，我们使用了数据集中的所有细胞组。</section></li><li><section><code>assay='RNA'</code>指定要分析的assay类型为RNA。</section></li><li><section><code>slot='data'</code>表示从SingleCellExperiment对象的"data" slot中获取标准化后的数据。</section></li><li><section><code>mu=1</code>是cosg函数中的一个参数，用于调整标记基因识别的准确性和灵敏度。默认值为1。</section></li><li><section><code>n_genes_user=100</code>是cosg函数中的一个参数，指定在计算标记基因时要考虑的top基因数量。</section></li></ul><p data-tool="mdnice编辑器">每个单细胞亚群默认就找到了 <code>n_genes_user</code>参数指定数量单细胞亚群特异性高表达基因：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.640625" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6Y9kLiajggtw0NhlTHRzYXaP480FZ2ugXvO0P9F8gUMiaMic2OYBT5Tkaw/640?wx_fmt=png" data-type="png" data-w="896" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6Y9kLiajggtw0NhlTHRzYXaP480FZ2ugXvO0P9F8gUMiaMic2OYBT5Tkaw/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p>可以看到， 这个结果跟前面的Seurat包的FindAllMarkers函数结果的形式就不一样的，前面的是长数据，现在这个 cosg 函数的结果是宽数据，有点类似于前面我们提到的：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511429&amp;idx=1&amp;sn=0ddae3b2234d173bf3ac0af558286aa1&amp;scene=21#wechat_redirect" data-linktype="2">基于非负矩阵分解的单细胞降维聚类分群</a>，找各个亚群的特征基因</p></blockquote><h2 data-tool="mdnice编辑器"><span></span>简单的比较两个函数的结果：</h2><pre data-tool="mdnice编辑器"><span></span><code>findG = split(sce.markers$gene,sce.markers$cluster)<br>str(findG)<br>names(findG)<br>tmp = do.call(rbind ,<br>        lapply(names(findG), function(x){<br>          table(marker_cosg$names[,x] %in% findG[[x]])<br>        }))<br>rownames(tmp) = names(findG)<br>tmp<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>             FALSE TRUE<br>Naive CD4 T     14   86<br>Memory CD4 T    27   73<br>CD14+ Mono      15   85<br>B               51   49<br>CD8 T           46   54<br>FCGR3A+ Mono    25   75<br>NK              34   66<br>DC              54   46<br>Platelet        37   63<br></code></pre><p data-tool="mdnice编辑器">虽然没曾老师推文中那么多，我们的结果中也是，DC和CD8 T   的表现比较差</p><figure data-tool="mdnice编辑器"><img data-ratio="0.4150753768844221" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6SUhbXSrHZpKqhdhgWkR5nYjPHONiaVYkKaJZzwLoakVYN3ibkQ44KeLA/640?wx_fmt=png" data-type="png" data-w="995" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6SUhbXSrHZpKqhdhgWkR5nYjPHONiaVYkKaJZzwLoakVYN3ibkQ44KeLA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">试试看仅仅是看top10的基因，它们交集如何：</p><pre data-tool="mdnice编辑器"><span></span><code>             FALSE TRUE<br>Naive CD4 T     10   0<br>Memory CD4 T     5    5<br>CD14+ Mono       3    7<br>B                2    8<br>CD8 T            2    8<br>FCGR3A+ Mono     3    7<br>NK               1    9<br>DC               4    6<br>Platelet         5    5<br></code></pre><p data-tool="mdnice编辑器">这时DC也较差，Platelet的表现也不行，最主要是Naive CD4 T top10竟然一个都没有overlap</p><p data-tool="mdnice编辑器">和曾老师的推文也有部分出入</p><figure data-tool="mdnice编辑器"><img data-ratio="0.43584521384928715" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6DLCtFdDINSTzHNm4dvyqGWf14ttDVWGOp8HAPmwv1SsrJH1UQ6MN1Q/640?wx_fmt=png" data-type="png" data-w="982" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6DLCtFdDINSTzHNm4dvyqGWf14ttDVWGOp8HAPmwv1SsrJH1UQ6MN1Q/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">翻到评论区：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.14778856526429343" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6ezjliahk6tTQnlFBKF4W4sXdeqyiapUJTzcIibfHMib4QHGROJtxG06ozQ/640?wx_fmt=png" data-type="png" data-w="927" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6ezjliahk6tTQnlFBKF4W4sXdeqyiapUJTzcIibfHMib4QHGROJtxG06ozQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">查看 <code>FindAllmarkers</code>和 <code>cosg</code> 函数的参数：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.7443237907206318" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6CgmtWjsTTOo2tdzdHcYIMeL959LDMnicr4PVUILLfDibRePyMLU4S42g/640?wx_fmt=png" data-type="png" data-w="1013" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8lmW3fCgPAva8gqzxjGxd6CgmtWjsTTOo2tdzdHcYIMeL959LDMnicr4PVUILLfDibRePyMLU4S42g/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p>我一开始以为 <code>FindAllmarkers</code> 函数 <code>min.pct</code> 参数表达该基因的细胞百分比，这个细胞是所有的细胞，经曾老师提醒，这里的细胞是当前差异对照分组细胞类型对应的细胞</p></blockquote><p data-tool="mdnice编辑器">添加COSG过滤参数：</p><pre data-tool="mdnice编辑器"><span></span><code>#remotes::install_github(repo = 'genecell/COSGR')<br>start = Sys.time()<br>library(COSG)<br>marker_cosg_fit &lt;- cosg(<br>  sce,<br>  groups='all',<br>  assay='RNA',<br>  slot='data',<br>  mu=1,<br>  remove_lowly_expressed = TRUE,<br>  expressed_pct = 0.25,<br>  n_genes_user=100)<br>end = Sys.time() <br>dur = end-start <br>dur<br></code></pre><p data-tool="mdnice编辑器">看看 cosg 函数的结果是否都在前面的 Seurat包的FindAllMarkers函数结果里面：</p><pre data-tool="mdnice编辑器"><span></span><code>findG = split(sce.markers$gene,sce.markers$cluster)<br>str(findG)<br>names(findG)<br>tmp = do.call(rbind ,<br>        lapply(names(findG), function(x){<br>          table(marker_cosg_fit$names[,x] %in% findG[[x]])<br>        }))<br>rownames(tmp) = names(findG)<br>tmp[,2]<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code> Naive CD4 T Memory CD4 T   CD14+ Mono            B        CD8 T FCGR3A+ Mono           NK           DC <br>         100          100          100          100           99          100          100          100 <br>    Platelet <br>         100 <br></code></pre><p data-tool="mdnice编辑器"><strong>可以发现将过滤阈值调整为一致后，基本上所有的cosg 函数的结果是否都在前面的 Seurat包的FindAllMarkers函数结果中</strong></p><hr data-tool="mdnice编辑器"><h1 data-tool="mdnice编辑器"><span></span>一些检索细胞亚型markers的数据库</h1><p data-tool="mdnice编辑器">上一部分是自己鉴定不同clusters之间的DEGs检查markers</p><p data-tool="mdnice编辑器">这里我们也提供一些可以检索的数据资源</p><ul data-tool="mdnice编辑器"><li><section>https://cellxgene.cziscience.com/datasets</section></li></ul><p data-tool="mdnice编辑器">CELL×GENE | Datasets 可能是目前的最大的统一的单细胞数据资源中心，横跨多种单细胞技术，全部的细胞都注释清楚了亚群，以层次结构组织展示</p><ul data-tool="mdnice编辑器"><li><section>http://117.50.127.228/CellMarker/CellMarker_help.html</section></li></ul><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzA5NjU5NjQ4MA==&amp;mid=2651206402&amp;idx=1&amp;sn=3ae94dceddc4e9e0da7e6943c547c00c&amp;scene=21#wechat_redirect" data-linktype="2">细胞类型注释，用它就够：CellMarker 2.0</a></p><ul data-tool="mdnice编辑器"><li><section><p>下面第四部分，我将介绍如何使用一些打分算法结合markers辅助确定细胞亚型，这些方法大部分都用R封装好了，并且有自己使用的细胞亚型的markers</p></section></li><li><section><p>初步定义细胞亚群往往用的是通用规则，我们过去的推文也有很多介绍，如<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247502273&amp;idx=1&amp;sn=cc6f6861d64afd61d560976ed6c33d05&amp;scene=21#wechat_redirect" data-linktype="2">听说你还缺单细胞亚群标记基因</a></p></section></li></ul><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">由于篇幅问题，第四部分“一些辅助划分细胞亚型的工具”将挪到本期推送的次版里</p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/26xnx5NPsjqSCIVu372vTQ",target="_blank" rel="noopener noreferrer">原文链接</a>
