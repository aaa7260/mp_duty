---
title: "高分文章用的Python单细胞拟时序算法Palantir，你能熟练运用嘛？"
date: 2023-09-23T15:59:25Z
draft: ["false"]
tags: [
  "fetched",
  "生信作曲家"
]
categories: ["Acdemic"]
---
高分文章用的Python单细胞拟时序算法Palantir，你能熟练运用嘛？ by 生信作曲家
------
<div><section><h3><span>前言</span><br></h3><blockquote><p><span></span><span></span><span><span>生信作曲家一直致力于构建国内</span><span><strong>和谐、开放、可持续</strong></span><span><strong>的生物信息交流平台</strong>。生信作曲家的目标是<strong>为每个科研人扫清科研路上的一切障碍，让生物信息学人人可做</strong>。目前，生信作曲家已推出</span><span><strong>"</strong><strong>跟着一区文章学通机器学习”、</strong></span><span><strong>"</strong><strong>跟着一区文章学通单细胞</strong><strong>"、"空间转录组从入门到精通”、孟德尔随机化实战”</strong><span><strong>、</strong></span><strong>Bootstrap<span><strong>、</strong></span>NATMI、CIBERSORTx、hdWGCNA、NTP、metaVIPER算法</strong></span><span>等多种强力教程，同时也兼具数据整理、可视化等核心入门技术教学，开办</span><span><strong>肿瘤发文计划RS、max，非肿瘤发文计划note、ultra、pro、时空百宝箱计划sp</strong><strong>和五一创新发文计划pro</strong></span><span><strong>等、生信中秋分享会、小年夜分享会、暑期集训营和冬季集训营</strong>等多次。辅导同学实现纯生信SCI发表硕果累累，帮助同学实现医学</span></span></p></blockquote><p>随着单细胞技术的普及，涌现出了许多拟时序分析算法。R语言方面：包括monocle2，monocle3， slingshot等；python方面：包括palantir，paga，dpt等。我们今天主要对发表于2019年发表于 nature biotechnology的<strong>Palantir算法</strong>进行介绍。</p><p>palantir是一种基于随机过程的拟时序算法，通过降维和流形分析，可以很好地捕捉细胞的状态的连续性，模拟低分化细胞向终末分化细胞的转变。</p><figure><figcaption><img data-ratio="0.537962962962963" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4OyyMA97qicsclxedBLtia5qyHGWmicZCoibOqFX2d6A4hKORaZBb9nrxXQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4OyyMA97qicsclxedBLtia5qyHGWmicZCoibOqFX2d6A4hKORaZBb9nrxXQ/640?wx_fmt=png"></figcaption></figure><p>该方法的引用质量是不错的（如下为引用palantir的文章）</p><figure><figcaption><img data-ratio="0.8851851851851852" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc43hpduibMClKQia2XR6iaAbdmJRLA4PJ91nmN9E5HIwGsGpTZjsxGVmuJQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc43hpduibMClKQia2XR6iaAbdmJRLA4PJ91nmN9E5HIwGsGpTZjsxGVmuJQ/640?wx_fmt=png"></figcaption></figure><h3><span>代码实操（准备工作）</span></h3><pre><code><span>#github：https://github.com/dpeerlab/Palantir  </span><br><span>#tutorial：</span><br><span>#https://nbviewer.org/github/dpeerlab/Palantir/blob/master/notebooks/Palantir_sample_notebook.ipynb</span><br><span>#datasets：https://github.com/dpeerlab/Palantir/tree/master/data</span><br><br>pip install palantir<br><br><span>import</span> palantir <span>as</span> pa<br><span>import</span> scanpy <span>as</span> sc<br><span>import</span> pandas <span>as</span> pd<br><span>import</span> os<br><span># 作图</span><br><span>import</span> matplotlib<br><span>import</span> matplotlib.pyplot <span>as</span> plt<br><span># warnings</span><br><span>import</span> warnings<br><span>from</span> numba.core.errors <span>import</span> NumbaDeprecationWarning<br>warnings.filterwarnings(action=<span>"ignore"</span>, category=NumbaDeprecationWarning)<br>warnings.filterwarnings(<br> action=<span>"ignore"</span>, module=<span>"scanpy"</span>, message=<span>"No data for colormapping"</span><br>)<br>plt.rcParams[<span>'font.family'</span>] = <span>"DejaVu Sans"</span>  <span>##设置字体</span><br><span># Inline plotting</span><br>%matplotlib inline<br></code></pre><h4><span>step1：加载数据及预处理</span></h4><p>为了更好的复现我们的结果，我们对随机参数进行设定，在palantir包中主要是使用numpy包进行set seed</p><pre><code><span>import</span> random<br><span>import</span> numpy <span>as</span> np<br>random_seed = <span>1314</span><br>random.seed(random_seed)<br>np.random.seed(random_seed)<br></code></pre><pre><code><span># 加载数据,该数据为造血干细胞发育情况的数据(CD34为干细胞marker)</span><br>data_dir = os.path.expanduser(<span>"./data/"</span>)<br>download_url = <span>"https://dp-lab-data-public.s3.amazonaws.com/palantir/marrow_sample_scseq_counts.h5ad"</span><br>file_path = os.path.join(data_dir, <span>"marrow_sample_scseq_counts.h5ad"</span>)<br>ad = sc.read(file_path, backup_url=download_url)<br>a<br><span># AnnData object with n_obs × n_vars = 4142 × 16106</span><br>ad.X.max()<br><span># 632.0   ## 需要标化下</span><br></code></pre><pre><code>sc.pp.normalize_total(ad)<br>pa.preprocess.log_transform(ad)<br>ad.X.max()<br><span>#13.47334</span><br><span># 高变基因</span><br>sc.pp.highly_variable_genes(ad, n_top_genes=<span>2000</span>, flavor=<span>"cell_ranger"</span>)<br><span>## pca</span><br>sc.pp.pca(ad)<br></code></pre><h4><span>step2：</span><span>Diffusion maps</span><span>的构建及</span><span>MAGIC填补</span></h4><p>Palantir会首先通过扩散映射 (Diffusion Maps)算法建立最近邻图，图中的每个细胞都与相似度最高的细胞相联系，且该图包含有处于相似发育阶段的细 胞，以及与发育轨迹相对应的路径等信息（与常规umap不同）</p><pre><code>dm_res = palantir.utils.run_diffusion_maps(ad, n_components=<span>5</span>)<br>ms_data = palantir.utils.determine_multiscale_space(ad)<br>ms_data  <span># 每个细胞都被赋予了一个状态</span><br></code></pre><figure><figcaption><img data-ratio="0.32037037037037036" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4g7alDUv8Cl1nJicJrzcX9UvhIMbtcABONteAA9Ec4ABX917YNYDpkmA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4g7alDUv8Cl1nJicJrzcX9UvhIMbtcABONteAA9Ec4ABX917YNYDpkmA/640?wx_fmt=png"></figcaption></figure><pre><code>sc.pp.neighbors(ad)<br>sc.tl.umap(ad)<br>sc.pl.embedding(<br>    ad,<br>    basis=<span>"umap"</span>,<br>    frameon=<span>False</span>,<br>)<br></code></pre><p>接下来用MAGIC来处理dropout的基因，这样可以<span><strong>让细胞的表达更加丰富合理，避免出现“只有几个点”表达的情况</strong></span></p><pre><code>imputed_X = palantir.utils.run_magic_imputation(ad)<br>sc.pl.embedding(<br> ad,<br> basis=<span>"umap"</span>,<br> layer=<span>"MAGIC_imputed_data"</span>,<br> color=[<span>"CD34"</span>, <span>"MPO"</span>, <span>"GATA1"</span>, <span>"IRF8"</span>],   <span>## HSC gene CD34, myeloid gene髓系细胞 MPO and erythroid precursor                                              #  gene 红系GATA1 and dendritic cell 树突细胞 gene IRF8.</span><br> frameon=<span>False</span>,<br> cmap=<span>'PuRd'</span><br>)<br>plt.show()<br></code></pre><figure><figcaption><img data-ratio="0.2212962962962963" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4xPNl7RRGejlYicQiarO7oWYfCozB5ON7zyx1UVYax0cYXW6ckSoJicib8Q/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4xPNl7RRGejlYicQiarO7oWYfCozB5ON7zyx1UVYax0cYXW6ckSoJicib8Q/640?wx_fmt=png"></figcaption></figure><pre><code><span>palantir</span><span>.plot</span><span>.plot_diffusion_components</span>(<span>ad</span>)<br><span>plt</span><span>.show</span>()<br></code></pre><figure><figcaption><img data-ratio="0.1638888888888889" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4I1RJ6dEZfJ7IqMtVU4icTCldibkkYYMtWQn6Ovznb2HHTzg3VYJz3ibeg/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4I1RJ6dEZfJ7IqMtVU4icTCldibkkYYMtWQn6Ovznb2HHTzg3VYJz3ibeg/640?wx_fmt=png"></figcaption></figure><p>对比可以看到发育是从component2为起点（具体道理也可以不用搞那么清楚明白）</p><h4><span>step3：正式的Palantir</span></h4><pre><code>start_cell = <span>"Run5_164698952452459"</span>   <span>## 自行选取起点</span><br>terminal_states = pd.Series(<br> [<span>"DC"</span>, <span>"Mono"</span>, <span>"Ery"</span>],<br> index=[<span>"Run5_131097901611291"</span>, <span>"Run5_134936662236454"</span>, <span>"Run4_200562869397916"</span>],  <span>## 自行选取终点</span><br>)<br></code></pre><p>这三个点在umap上的位置，我们通过umap图查看一下</p><pre><code>pa.plot.plot_diffusion_components(ad)<br>plt.show() <br></code></pre><figure><figcaption><img data-ratio="0.7890410958904109" data-type="png" data-w="730" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4l9wbNic9ficCjz2mg2BBywPDiaicMNZicYe82yx0TMCnseyxuzMPWzTlXQQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4l9wbNic9ficCjz2mg2BBywPDiaicMNZicYe82yx0TMCnseyxuzMPWzTlXQQ/640?wx_fmt=png"></figcaption></figure><pre><code>pr_res = pa.core.run_palantir(<br> ad, start_cell, num_waypoints=<span>500</span>, terminal_states=terminal_states,<br> n_jobs=<span>16</span><br>)<br></code></pre><h4><span>step4：更多的可视化</span></h4><pre><code>pa.plot.plot_palantir_results(ad, s=<span>10</span>)<br>plt.show()<br></code></pre><figure><figcaption><img data-ratio="0.5546296296296296" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4UuOrSVnS54dcmsj9GordbdY9e93E7e2priaNOBmVYz9L5uzG51FeqNQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4UuOrSVnS54dcmsj9GordbdY9e93E7e2priaNOBmVYz9L5uzG51FeqNQ/640?wx_fmt=png"></figcaption></figure><pre><code>pa.plot.plot_branch_selection(ad)<br>plt.show()<br></code></pre><figure><figcaption><img data-ratio="0.9481765834932822" data-type="png" data-w="1042" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4HHW6ofekXE1sWFvJ8lib5CLtqApWJbiaFv8vK0iaYuogNHTsuAKPf4QQg/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4HHW6ofekXE1sWFvJ8lib5CLtqApWJbiaFv8vK0iaYuogNHTsuAKPf4QQg/640?wx_fmt=png"></figcaption></figure><pre><code>genes = [<span>"CD34"</span>, <span>"MPO"</span>, <span>"GATA1"</span>, <span>"IRF8"</span>]<br>pa.plot.plot_gene_trends(ad, genes)<br>plt.show()<br></code></pre><figure><figcaption><img data-ratio="1.4673913043478262" data-type="png" data-w="736" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4FFGzib1hBR9ZibNyNKFV7FdV6N0qm3MJD5NusxWYNMic9UAdQCqx7ic9bQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4FFGzib1hBR9ZibNyNKFV7FdV6N0qm3MJD5NusxWYNMic9UAdQCqx7ic9bQ/640?wx_fmt=png"></figcaption></figure><pre><code>a.plot.plot_gene_trend_heatmaps(ad, genes)<br>plt.show()<br></code></pre><figure><img data-ratio="1.032967032967033" data-type="png" data-w="728" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4BLt05NuPE1tJjK3am9xOXppnDy82ZQia77yATkOrCtkEJ5hDna2ufzA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDVTQctYbrofaM7H9e3Sibc4BLt05NuPE1tJjK3am9xOXppnDy82ZQia77yATkOrCtkEJ5hDna2ufzA/640?wx_fmt=png"><br></figure><section><h3><span>后记</span></h3><p>palantir相比其他常规算法原理更加复杂高级，需要熟练掌握是需要一定的练习的。讨论更多，请备注 加群</p><p><img data-galleryid="" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="512" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/mo60jlFOtaBGpGicRlf1uIRz5z4icMGickywJW7jQIkU4lafb2SfXxTwtD6ia0Twl7EePYmgFGpYULxQ1Ym9GVbKibw/640?wx_fmt=jpeg" src="https://mmbiz.qpic.cn/mmbiz_jpg/mo60jlFOtaBGpGicRlf1uIRz5z4icMGickywJW7jQIkU4lafb2SfXxTwtD6ia0Twl7EePYmgFGpYULxQ1Ym9GVbKibw/640?wx_fmt=jpeg"></p><p><br></p></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/fgaACD2T5-vej0tqPBWhaA",target="_blank" rel="noopener noreferrer">原文链接</a>
