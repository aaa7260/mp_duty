---
title: "单细胞测序最好的教程（十）：万能的Transformer与细胞注释"
date: 2023-09-05T12:51:29Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
单细胞测序最好的教程（十）：万能的Transformer与细胞注释 by 单细胞天地
------
<div><section data-style-type="5" data-tools="新媒体排版" data-id="2430070"><section data-style-type="5" data-tools="新媒体排版" data-id="2390348"><section><section powered-by="xiumi.us"><section><section><section powered-by="xiumi.us"><section><section><br></section><section><section><section powered-by="xiumi.us"><section><section><p>分享是一种态度</p></section></section></section></section></section></section></section></section><section><section powered-by="xiumi.us"><section><section><img data-ratio="0.8738095238095238" data-src="https://mmbiz.qpic.cn/mmbiz_gif/siaia0BDGJdjSnnb9ibXpFagGPWQ0JjSSTNVBZthROEhicfINuLcxX2Ro3Zb600LJhrzeYIb120tLjSVXEtLn14DwA/640?wx_fmt=gif" data-type="gif" data-w="420" width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/siaia0BDGJdjSnnb9ibXpFagGPWQ0JjSSTNVBZthROEhicfINuLcxX2Ro3Zb600LJhrzeYIb120tLjSVXEtLn14DwA/640?wx_fmt=gif"></section></section></section></section></section></section></section></section></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>作者按</p><p>本章节主要讲解了基于transformer的迁移注释方法TOSICA，该算法在迁移注释上达到了SOTA的水平，在注释这么卷的赛道愣是杀出了一条血路。本教程首发于<span>单细胞最好的中文教程</span><sup>[1]</sup>，未经授权许可，禁止转载。</p><p><span>全文字数|预计阅读时间</span>: 3000|3min</p><p>——Starlitnightly（星夜）</p></blockquote><h2 data-tool="mdnice编辑器"><span></span><span>1. 背景</span></h2><p data-tool="mdnice编辑器">迁移注释实际上是自动注释的一类，与我们在3-4中介绍的自动注释不同，迁移注释需要我们有一个已经注释好的单细胞测序数据文件，而不是训练好的模型或者marker。我们需要使用这个已经注释好的单细胞测序数据文件来训练一个新的模型，例如Cell-Blast或者是Tosica等。</p><p data-tool="mdnice编辑器">此外，对于多个样本的单细胞测序文件，我们可以先主动注释好一个样本，然后使用迁移注释的方式，把剩下的样本也一起注释了。在这里，我们将介绍迁移注释的SOTA算法，TOSICA。TOSICA 实现了快速、准确的一站式注释和对批量不敏感的整合，同时为理解发育和疾病进展过程中的细胞行为提供了可解释的生物学见解。</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> omicverse <span>as</span> ov<br>print(<span>f'omicverse version: <span>{ov.__version__}</span>'</span>)<br><span>import</span> scanpy <span>as</span> sc<br>print(<span>f'scanpy version: <span>{sc.__version__}</span>'</span>)<br>ov.ov_plot_set()<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span>#omicverse version: 1.5.1</span><br>    <span>#scanpy version: 1.9.1</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>2. 加载数据</span></h2><p data-tool="mdnice编辑器">需要注意的是，参考单细胞测序数据与要注释的单细胞测序数据要保持一致的归一化方法。归一化方法通常受<code>sc.pp.normalize_total</code>中<code>target_sum</code>参数的影响，在scanpy中，默认值为自适应，这会导致我们在迁移注释时出错，为了避免这种情况的出现，我们需要将其统一，不能留空。网上的教程包括seurat会将<code>target_sum</code>设置为<code>1e4</code></p><p data-tool="mdnice编辑器">而如果你是使用omicverse的<code>preprocess</code>函数进行的归一化，那么默认<code>target_sum</code>为<code>50*1e4</code>。而在本教程中，我们将统一使用原始counts，然后使用omicverse的preprocess函数进行预处理与归一化</p><h3 data-tool="mdnice编辑器"><span></span><span>2.1 参考注释数据集</span><span></span></h3><p data-tool="mdnice编辑器">一个高质量的参考注释数据集对我们注释结果的影响是至关重要的，在这里，我们介绍<span>Cell Blast参考注释数据集</span><sup>[2]</sup>，Cell Blast收集了100+个高质量的单细胞注释数据集，我们从中下载了<code>Zheng</code>来注释我们的骨髓数据集。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5037037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRB3SOibjFmg1L1oQ4g95u2e4F8vPJ1c4AvrzgtF4554ehKaQ7gZJc6fbTorVYMux8g8VQWViatkPUQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRB3SOibjFmg1L1oQ4g95u2e4F8vPJ1c4AvrzgtF4554ehKaQ7gZJc6fbTorVYMux8g8VQWViatkPUQ/640?wx_fmt=png"><figcaption>cellblast</figcaption></figure><p data-tool="mdnice编辑器">需要注意的是，我们用来训练的参考数据集不能少于30,000个细胞，否则训练出来的TOSICA模型效果一般，如果参考数据集大于100,000个细胞，我们也可以随机选择30,000个细胞进行训练，效果是一样的。</p><pre data-tool="mdnice编辑器"><span></span><code>!wget https://cblast.gao-lab.org/Zheng/Zheng.h5ad<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># --2023-08-31 19:21:26--  https://cblast.gao-lab.org/Zheng/Zheng.h5ad</span><br>    <span># Resolving cblast.gao-lab.org (cblast.gao-lab.org)... 159.138.49.219</span><br>    <span># Connecting to cblast.gao-lab.org (cblast.gao-lab.org)|159.138.49.219|:443... connected.</span><br>    <span># HTTP request sent, awaiting response... 200 OK</span><br>    <span># Length: 500776712 (478M) [application/octet-stream]</span><br>    <span># Saving to: ‘Zheng.h5ad’</span><br>    <br>    <span># Zheng.h5ad          100%[===================&gt;] 477.58M  3.85MB/s    in 1m 56s  </span><br>    <br>    <span># 2023-08-31 19:23:23 (4.12 MB/s) - ‘Zheng.h5ad’ saved [500776712/500776712]</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>ref_adata = ov.utils.read(<span>'Zheng.h5ad'</span>)<br>ref_adata<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># AnnData object with n_obs × n_vars = 91789 × 32643</span><br>    <span>#     obs: 'cell_type1', 'lifestage', 'organism', 'dataset_name', 'platform', 'organ', 'data_type', 'cell_ontology_class', 'cell_ontology_id', 'n_genes', 'n_counts', '__libsize__'</span><br>    <span>#     var: 'variable_genes'</span><br>    <span>#     uns: 'cell_ontology_class_colors', 'cell_type1_colors', 'data_quality', 'known_markers', 'neighbors', 'umap'</span><br>    <span>#     obsm: 'X_umap', 'latent'</span><br>    <span>#     obsp: 'connectivities', 'distances'</span><br></code></pre><p data-tool="mdnice编辑器">随机选取30,000个细胞的方法，我们使用random.sample进行无放回采样</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> random<br>cell_idx=list(random.sample(ref_adata.obs.index.tolist(),<span>30000</span>))<br>ref_adata=ref_adata[cell_idx]<br>ref_adata<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># View of AnnData object with n_obs × n_vars = 3000 × 2398</span><br>    <span>#     obs: 'cell_type1', 'lifestage', 'organism', 'dataset_name', 'platform', 'organ', 'data_type', 'cell_ontology_class', 'cell_ontology_id', 'n_genes', 'n_counts', '__libsize__'</span><br>    <span>#     var: 'variable_genes', 'n_cells', 'percent_cells', 'robust', 'mean', 'var', 'residual_variances', 'highly_variable_rank', 'highly_variable_features'</span><br>    <span>#     uns: 'cell_ontology_class_colors', 'cell_type1_colors', 'data_quality', 'known_markers', 'neighbors', 'umap', 'log1p', 'hvg'</span><br>    <span>#     obsm: 'X_umap', 'latent'</span><br>    <span>#     layers: 'counts'</span><br>    <span>#     obsp: 'connectivities', 'distances'</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>ref_adata.obs[<span>'cell_ontology_class'</span>].cat.categories<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># Index(['B cell', 'T-helper 2 cell', 'cytotoxic T cell', 'dendritic cell',</span><br>    <span>#        'hematopoietic precursor cell', 'memory T cell', 'monocyte',</span><br>    <span>#        'naive thymus-derived CD4-positive, alpha-beta T cell',</span><br>    <span>#        'naive thymus-derived CD8-positive, alpha-beta T cell',</span><br>    <span>#        'natural killer cell', 'regulatory T cell'],</span><br>    <span>#       dtype='object')</span><br></code></pre><p data-tool="mdnice编辑器">我们检查其归一化程度</p><pre data-tool="mdnice编辑器"><span></span><code>ref_adata.X.max()<br></code></pre><p data-tool="mdnice编辑器">这是一个较大的整数，表明其并未进行归一化，是原始counts，我们对其进行预处理（包括归一化与高可变基因的计算）。</p><pre data-tool="mdnice编辑器"><span></span><code>ref_adata=ov.pp.preprocess(ref_adata,mode=<span>'shiftlog|pearson'</span>,n_HVGs=<span>3000</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># Begin robust gene identification</span><br>    <span># After filtration, 21666/32643 genes are kept. Among 21666 genes, 13971 genes are robust.</span><br>    <span># End of robust gene identification.</span><br>    <span># Begin size normalization: shiftlog and HVGs selection pearson</span><br>    <span># normalizing counts per cell The following highly-expressed genes are not considered during normalization factor computation:</span><br>    <span># ['IGLL5']</span><br>    <span>#     finished (0:00:00)</span><br>    <span># extracting highly variable genes</span><br>    <span># --&gt; added</span><br>    <span>#     'highly_variable', boolean vector (adata.var)</span><br>    <span>#     'highly_variable_rank', float vector (adata.var)</span><br>    <span>#     'highly_variable_nbatches', int vector (adata.var)</span><br>    <span>#     'highly_variable_intersection', boolean vector (adata.var)</span><br>    <span>#     'means', float vector (adata.var)</span><br>    <span>#     'variances', float vector (adata.var)</span><br>    <span>#     'residual_variances', float vector (adata.var)</span><br>    <span># End of size normalization: shiftlog and HVGs selection pearson</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>2.2 待注释数据集</span><span></span></h3><p data-tool="mdnice编辑器">我们还是使用之前的骨髓数据集，为了保持我们分析的一致性，但是我们需要从中先提取原始counts，因为我们在2-2的章节中对数据进行了归一化与高可变基因的筛选</p><pre data-tool="mdnice编辑器"><span></span><code>adata = ov.utils.read(<span>'data/s4d8_manual_annotation.h5ad'</span>)<br>adata=adata.raw.to_adata()<br>ov.utils.retrieve_layers(adata,layers=<span>'counts'</span>)<br>print(<span>'raw count adata:'</span>,adata.X.max())<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span>#......The X of adata have been stored in raw</span><br>    <span>#......The layers counts of adata have been retreved</span><br>    <span>#raw count adata: 889.0</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>adata=ov.pp.preprocess(adata,mode=<span>'shiftlog|pearson'</span>,n_HVGs=<span>3000</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># Begin robust gene identification</span><br>    <span># After filtration, 20171/20171 genes are kept. Among 20171 genes, 20171 genes are robust.</span><br>    <span># End of robust gene identification.</span><br>    <span># Begin size normalization: shiftlog and HVGs selection pearson</span><br>    <span># normalizing counts per cell The following highly-expressed genes are not considered during normalization factor computation:</span><br>    <span># []</span><br>    <span>#     finished (0:00:00)</span><br>    <span># WARNING: adata.X seems to be already log-transformed.</span><br>    <span># extracting highly variable genes</span><br>    <span># --&gt; added</span><br>    <span>#     'highly_variable', boolean vector (adata.var)</span><br>    <span>#     'highly_variable_rank', float vector (adata.var)</span><br>    <span>#     'highly_variable_nbatches', int vector (adata.var)</span><br>    <span>#     'highly_variable_intersection', boolean vector (adata.var)</span><br>    <span>#     'means', float vector (adata.var)</span><br>    <span>#     'variances', float vector (adata.var)</span><br>    <span>#     'residual_variances', float vector (adata.var)</span><br>    <span># End of size normalization: shiftlog and HVGs selection pearson</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>2.3 高可变基因一致化</span><span></span></h3><p data-tool="mdnice编辑器">我们对<code>ref_adata</code>与<code>adata</code>都提取了3000个高可变基因，但是这两个单细胞测序数据的高可变基因不一致，所以我们需要提取相同的高可变基因来进行分析。</p><pre data-tool="mdnice编辑器"><span></span><code><span>#提取高可变基因</span><br>ref_adata = ref_adata[:, ref_adata.var.highly_variable_features]<br><br><span>#提取共同高可变基因</span><br>ref_adata.var_names_make_unique()<br>adata.var_names_make_unique()<br>ret_gene=list(set(adata.var_names) &amp; set(ref_adata.var_names))<br>len(ret_gene)<br></code></pre><p data-tool="mdnice编辑器">我们发现参考数据集的高可变基因与目标数据集的共同基因只有2132个，我们可以将前面3000个高可变基因调高来保证取到的高可变基因重复率较高</p><pre data-tool="mdnice编辑器"><span></span><code>adata=adata[:,ret_gene]<br>ref_adata=ref_adata[:,ret_gene]<br></code></pre><p data-tool="mdnice编辑器">我们此时再看ref_adata与adata的最大值，发现其都在<code>np.log1p(50*1e4)</code>内，表明二者具有相同的归一化值。</p><pre data-tool="mdnice编辑器"><span></span><code>print(<span>f"The max of ref_adata is <span>{ref_adata.X.max()}</span>, query_data is <span>{adata.X.max()}</span>"</span>,)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>   <span># The max of ref_adata is 11.416531562805176, query_data is 10.87752914428711</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>3. 下载通路注释集</span></h2><p data-tool="mdnice编辑器">TOSICA作为一个transformer模型，具有多头注意力机制，这意味我们除了注释以外，还可以分析细胞的注意力主要位于什么通路上，所以我们可以将通路数据作为输入给予TOSICA模型。</p><p data-tool="mdnice编辑器">你可以使用ov.utils.download_tosica_gmt()来自动下载，也可以通过下面的链接手动下载：</p><ul data-tool="mdnice编辑器"><li><section>'GO_bp':'https://figshare.com/ndownloader/files/41460072',</section></li><li><section>'TF':'https://figshare.com/ndownloader/files/41460066',</section></li><li><section>'reactome':'https://figshare.com/ndownloader/files/41460051',</section></li><li><section>'m_GO_bp':'https://figshare.com/ndownloader/files/41460060',</section></li><li><section>'m_TF':'https://figshare.com/ndownloader/files/41460057',</section></li><li><section>'m_reactome':'https://figshare.com/ndownloader/files/41460054',</section></li><li><section>'immune':'https://figshare.com/ndownloader/files/41460063',</section></li></ul><p data-tool="mdnice编辑器">当然对于国内的用户，也可以使用百度网盘手动下载链接:</p><ul data-tool="mdnice编辑器"><li><section>https://pan.baidu.com/s/1FlOb4Wz-I7SnCV090q-NHA?pwd=3hb9</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>ov.utils.download_tosica_gmt()<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>4. 初始化 TOSICA 模型</span></h2><p data-tool="mdnice编辑器">我们首先需要在 He_Calvarial_Bone 数据集上训练 TOSICA 模型，omicverse 提供了一个简单的 <code>pyTOSICA</code> 类，所有后续操作都可以使用 <code>pyTOSICA</code> 完成。我们需要设置模型初始化的参数。</p><ul data-tool="mdnice编辑器"><li><section><code>adata</code>：参考 adata 对象</section></li><li><section><code>gmt_path</code>：默认的预先准备的掩码，或者 .gmt 文件的路径。您可以使用 <code>ov.utils.download_tosica_gmt()</code> 来获取基因集。</section></li><li><section><code>depth</code>：Transformer 模型的深度，设置为 2 时可能会发生内存泄漏。</section></li><li><section><code>label_name</code>：在 <code>adata.obs</code> 中表示细胞类型的参考键。</section></li><li><section><code>project_path</code>：TOSICA 模型的保存路径。</section></li><li><section><code>batch_size</code>：表示在单次传递中传递给程序进行训练的细胞数量。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>tosica_obj=ov.single.pyTOSICA(adata=ref_adata,<br>                              gmt_path=<span>'genesets/GO_bp.gmt'</span>, depth=<span>1</span>,<br>                              label_name=<span>'cell_ontology_class'</span>,<br>                              project_path=<span>'hGOBP_demo'</span>,<br>                              batch_size=<span>8</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span>#cuda:0</span><br>    <span>#Mask loaded!</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>5. 训练 TOSICA 模型</span></h2><p data-tool="mdnice编辑器">训练 TOSICA 模型时需要设置 4 个参数。</p><ul data-tool="mdnice编辑器"><li><section>pre_weights：预训练权重的路径。</section></li><li><section>lr：学习率。</section></li><li><section>epochs：epochs 的个数。</section></li><li><section>lrf：最后一层的学习率。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>tosica_obj.train(epochs=<span>5</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># Model builded!</span><br><br><br>    <span># [train epoch 0] loss: 1.300, acc: 0.485: 100%|██████████| 11504/11504 [01:54&lt;00:00, 100.70it/s]</span><br>    <span># [valid epoch 0] loss: 0.429, acc: 0.817: 100%|██████████| 4930/4930 [00:14&lt;00:00, 330.10it/s]</span><br>    <span># [train epoch 1] loss: 0.470, acc: 0.807: 100%|██████████| 11504/11504 [01:55&lt;00:00, 100.01it/s]</span><br>    <span># [valid epoch 1] loss: 0.371, acc: 0.843: 100%|██████████| 4930/4930 [00:14&lt;00:00, 330.79it/s]</span><br>    <span># [train epoch 2] loss: 0.390, acc: 0.842: 100%|██████████| 11504/11504 [01:54&lt;00:00, 100.11it/s]</span><br>    <span># [valid epoch 2] loss: 0.338, acc: 0.864: 100%|██████████| 4930/4930 [00:14&lt;00:00, 330.17it/s]</span><br>    <span># [train epoch 3] loss: 0.332, acc: 0.866: 100%|██████████| 11504/11504 [01:54&lt;00:00, 100.22it/s]</span><br>    <span># [valid epoch 3] loss: 0.291, acc: 0.881: 100%|██████████| 4930/4930 [00:14&lt;00:00, 330.55it/s]</span><br>    <span># [train epoch 4] loss: 0.284, acc: 0.888: 100%|██████████| 11504/11504 [01:54&lt;00:00, 100.36it/s]</span><br>    <span># [valid epoch 4] loss: 0.273, acc: 0.891: 100%|██████████| 4930/4930 [00:14&lt;00:00, 330.70it/s]</span><br><br><br>    <span># Training finished!</span><br></code></pre><p data-tool="mdnice编辑器">我们可以使用 <code>.save</code> 来保存 <code>TOSICA</code>模型到 <code>project_path</code></p><pre data-tool="mdnice编辑器"><span></span><code>tosica_obj.save()<br>tosica_obj.load()<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>6. 细胞类型预测</span></h2><p data-tool="mdnice编辑器">在训练好TOSICA模型后，我们将其注释结果迁移到目标数据上</p><pre data-tool="mdnice编辑器"><span></span><code>new_adata=tosica_obj.predicted(pre_adata=adata)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>   <span># 0</span><br>   <span># 10000</span><br>   <span># 14814</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>new_adata.obsm=adata[new_adata.obs.index].obsm.copy()<br>new_adata.obsp=adata[new_adata.obs.index].obsp.copy()<br>new_adata<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># AnnData object with n_obs × n_vars = 14814 × 299</span><br>    <span>#     obs: 'Prediction', 'Probability', 'n_genes_by_counts', 'log1p_n_genes_by_counts', 'total_counts', 'log1p_total_counts', 'pct_counts_in_top_20_genes', 'total_counts_mt', 'log1p_total_counts_mt', 'pct_counts_mt', 'total_counts_ribo', 'log1p_total_counts_ribo', 'pct_counts_ribo', 'total_counts_hb', 'log1p_total_counts_hb', 'pct_counts_hb', 'outlier', 'mt_outlier', 'scDblFinder_score', 'scDblFinder_class', 'leiden_res1', 'major_celltype', 'manual_celltype', 'minor_celltype'</span><br>    <span>#     obsm: 'X_mde', 'scaled|original|X_pca'</span><br>    <span>#     obsp: 'connectivities', 'distances'</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>ov.utils.embedding(<br>    new_adata,<br>    basis=<span>"X_mde"</span>,<br>    color=[<span>'major_celltype'</span>, <span>'Prediction'</span>],<br>    frameon=<span>'small'</span>,<br>    <span>#ncols=1,</span><br>    wspace=<span>0.5</span>,<br>    <span>#palette=ov.utils.pyomic_palette()[11:],</span><br>    show=<span>False</span>,<br>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.25833333333333336" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRB3SOibjFmg1L1oQ4g95u2emXUyA1ZiaKmUrtzYYkianBq9r5lwCuX88eSUL1WbomnSJdvT2vu8s5eA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRB3SOibjFmg1L1oQ4g95u2emXUyA1ZiaKmUrtzYYkianBq9r5lwCuX88eSUL1WbomnSJdvT2vu8s5eA/640?wx_fmt=png"><figcaption>迁移注释结果</figcaption></figure><p data-tool="mdnice编辑器">我们可以看见，其注释效果一般，这是由于我们是用PBMC外周血的细胞类型进行迁移，而不是使用骨髓数据进行迁移。所以参考数据集的选取对于注释准确率的影响非常大，一般我们手动注释一个样本然后进行迁移的准确率是最高的。</p><h2 data-tool="mdnice编辑器"><span></span><span>7. 注意力机制</span></h2><p data-tool="mdnice编辑器">transformer作为一个注意力模型，我们可以找到每一类细胞注意力集中的通路，这听起来有点类似通路富集。我们首先将预测细胞类型数量小于5的细胞给过滤掉。</p><pre data-tool="mdnice编辑器"><span></span><code>cell_idx=new_adata.obs[<span>'Prediction'</span>].value_counts()[new_adata.obs[<span>'Prediction'</span>].value_counts()&lt;<span>5</span>].index<br>new_adata=new_adata[~new_adata.obs[<span>'Prediction'</span>].isin(cell_idx)]<br></code></pre><p data-tool="mdnice编辑器">然后，我们使用 <code>sc.tl.rank_genes_groups</code> 计算出各细胞类型中注意力最高的差异通路。这种差异通路来源于之前计算所用的 gmt 基因组。</p><pre data-tool="mdnice编辑器"><span></span><code>sc.tl.rank_genes_groups(new_adata, <span>'Prediction'</span>, method=<span>'wilcoxon'</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>    <span># ranking genes</span><br>    <span>#     finished: added to `.uns['rank_genes_groups']`</span><br>    <span>#     'names', sorted np.recarray to be indexed by group ids</span><br>    <span>#     'scores', sorted np.recarray to be indexed by group ids</span><br>    <span>#     'logfoldchanges', sorted np.recarray to be indexed by group ids</span><br>    <span>#     'pvals', sorted np.recarray to be indexed by group ids</span><br>    <span>#     'pvals_adj', sorted np.recarray to be indexed by group ids (0:00:00)</span><br><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>sc.pl.rank_genes_groups_dotplot(new_adata,<br>                                n_genes=<span>3</span>,standard_scale=<span>'var'</span>,)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.962037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRB3SOibjFmg1L1oQ4g95u2eRibmGOT7nmvh0lysOQjSOEG5DMIIeeXiaQs0o1XlvIA1YGFfjZM0enQQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRB3SOibjFmg1L1oQ4g95u2eRibmGOT7nmvh0lysOQjSOEG5DMIIeeXiaQs0o1XlvIA1YGFfjZM0enQQ/640?wx_fmt=png"><figcaption>差异通路</figcaption></figure><p data-tool="mdnice编辑器">如果想获取特定细胞的通路，可以使用 sc.get.rank_genes_groups_df 来获取。</p><p data-tool="mdnice编辑器">例如，我们想获得细胞类型 B细胞 注意力最高的通路</p><pre data-tool="mdnice编辑器"><span></span><code>degs = sc.get.rank_genes_groups_df(new_adata, group=<span>'B cell'</span>, key=<span>'rank_genes_groups'</span>,pval_cutoff=<span>0.05</span>)<br>degs.head()<br></code></pre><p data-tool="mdnice编辑器">我们发现注意力最高的通路是<code>GOBP_REGULATION_OF_PROTEIN_BINDING</code>，我们在umap图上观察通路的注意力情况，发现其确实位于B细胞区域</p><pre data-tool="mdnice编辑器"><span></span><code>ov.utils.embedding(<br>    new_adata,<br>    basis=<span>"X_mde"</span>,<br>    color=[<span>'Prediction'</span>,<span>'GOBP_REGULATION_OF_PROTEIN_BINDING'</span>],<br>    frameon=<span>'small'</span>,<br>    <span>#ncols=1,</span><br>    wspace=<span>0.5</span>,<br>    <span>#palette=ov.utils.pyomic_palette()[11:],</span><br>    show=<span>False</span>,<br>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.3527777777777778" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRB3SOibjFmg1L1oQ4g95u2evTKvDbJtnBoAvibsAfK4RnB7PXic1JWLHqj7cv2SXuqYhgR35ThVNTNg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRB3SOibjFmg1L1oQ4g95u2evTKvDbJtnBoAvibsAfK4RnB7PXic1JWLHqj7cv2SXuqYhgR35ThVNTNg/640?wx_fmt=png"><figcaption>注意力模型</figcaption></figure><hr data-tool="mdnice编辑器"><h3 data-tool="mdnice编辑器"><span>参考资料</span></h3><section data-tool="mdnice编辑器"><span><span>[1]</span><p>单细胞最好的中文教程: <em>https://single-cell-tutorial.readthedocs.io/zh/latest/</em></p></span><span><span>[2]</span><p>Cell Blast参考注释数据集: <em>https://cblast.gao-lab.org/download</em></p></span></section></section><section><p><br></p><section data-style-type="5" data-tools="新媒体排版" data-id="2440476"><section><section><section><section><img data-ratio="0.9495798319327731" data-src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif" data-type="gif" data-w="119" data-width="100%" src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif"></section><section data-brushtype="text">往期回顾</section><section><br></section></section></section></section><section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515593&amp;idx=1&amp;sn=8be561895b5f00763aa79a40609db14e&amp;chksm=ea1cbb4bdd6b325d38950274dcb2393a5cb769fc59a589a0676f15e767cceafb76636d11d197&amp;scene=21#wechat_redirect" textvalue="国产单细胞转录组数据分析流程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="8" tab="innerlink" data-linktype="2" hasload="1">国产单细胞转录组数据分析流程</a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515808&amp;idx=1&amp;sn=271304f9dbf9a7e504f5e7644c207046&amp;chksm=ea1cb822dd6b313430cc7a76a713b603552598db95ec32fb66dfc1adbfd8d4ed622b44002a51&amp;scene=21#wechat_redirect" textvalue="单细胞测序最好的教程（九）: 发表在Science的细胞注释算法" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞测序最好的教程（九）: 发表在Science的细胞注释算法</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515539&amp;idx=1&amp;sn=dbe3e19f2ba3919e0bed47388d22c4b5&amp;chksm=ea1cbb11dd6b3207c7f2ff718391d97105f2d84d5c53066707425ed60268eb2d9d8284b23b03&amp;scene=21#wechat_redirect" textvalue="单细胞测序揭示多能干细胞在分化成内皮细胞过程中的转录变化" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">单细胞测序揭示多能干细胞在分化成内皮细胞过程中的转录变化</a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515538&amp;idx=1&amp;sn=9be83cecadb15fc6222edaa1e16f005a&amp;chksm=ea1cbb10dd6b3206228619c26296a2738f24fa3c993cf67e8ae5b33a9cc4d000fe74a9bfc8d8&amp;scene=21#wechat_redirect" textvalue="多分组单细胞测序数据第一层次未整合和整合分析对B细胞细分的分群有何影响？" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">多分组单细胞测序数据第一层次未整合和整合分析对B细胞细分的分群有何影响？</a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515528&amp;idx=1&amp;sn=0e7ae1c1981bed1c50fd38ee89548598&amp;chksm=ea1cbb0add6b321cde1a5bd2b592c92d673d29b9ed3a740dec3b3b8b9684b606b4723fc073bb&amp;scene=21#wechat_redirect" textvalue="2013-2023年度技术十年 | 单细胞的群星闪耀时" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">2013-2023年度技术十年 | 单细胞的群星闪耀时</a></p></section></section><hr><p><br></p></section><section data-style-type="5" data-tools="新媒体排版" data-id="2440475"><hr><p><br></p><hr><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524240&amp;idx=1&amp;sn=94c9ef8c3d8080c30c8372d4fb5999ab&amp;chksm=9b4bdf2bac3c563def9232bb78f43bcaa13d7c3442b00cf83aaa32ae98f4500883fa8803fb98&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课9月班" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信入门&amp;数据挖掘线上直播课9月班</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">时隔5年，我们的生信技能树VIP学徒继续招生啦</a><br></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">千呼万唤始出来的独享生物信息学云服务器</a></p></li></ul><p><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" data-type="gif" data-w="240" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg" data-type="other" data-w="341" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-id="93668"><section><section data-width="95%"><section><section><section data-width="38%"><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg" data-type="other" data-w="258" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/pA5xtv4SMcOf6ISmcEfEpg",target="_blank" rel="noopener noreferrer">原文链接</a>
