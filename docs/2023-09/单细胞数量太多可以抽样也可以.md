---
title: "单细胞数量太多可以抽样也可以"
date: 2023-09-26T16:18:06Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
单细胞数量太多可以抽样也可以 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>我分享过 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247498040&amp;idx=1&amp;sn=3a39699ab10fb71b966adb5e7e640270&amp;scene=21#wechat_redirect" data-linktype="2">对单细胞表达矩阵做gsea分析</a>的代码，是不同单细胞亚群两两之间差异分析后，对基因进行排序，非常正常的gsea分析。以及 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511608&amp;idx=1&amp;sn=aee917f6e8aef8b9214eedb4a23780a0&amp;scene=21#wechat_redirect" data-linktype="2">单细胞转录组数据的批量GSVA代码大放送</a>，是根据单细胞亚群分组后使用AverageExpression得到一个简单的表达量矩阵后进行gsva分析，把2万多个基因的表达量矩阵转换为几十或者上百个 通路的基因集打分矩阵。</p></blockquote><p data-tool="mdnice编辑器">但是有同学提问，它的单细胞表达量矩阵是五万到十万个细胞，并不想预先拆分成为单细胞亚群分组，所以没办法使用AverageExpression得到一个简单的表达量矩阵，想直接对全部的单细胞矩阵进行gsva，但是矩阵每次都会内存溢出，大家也可以尝试下面的代码：</p><pre data-tool="mdnice编辑器"><span></span><code><span># write.csv(t(as.matrix(sce.all@assays$RNA@counts)), file = "sce.all.csv")</span><br></code></pre><p data-tool="mdnice编辑器">一般来说都会报错，除非你的机器配置惊人：</p><pre data-tool="mdnice编辑器"><span></span><code>Error <span>in</span> asMethod(object) : <br>  Cholmod error <span>'problem too large'</span> at file ../Core/cholmod_dense.c, line 102<br></code></pre><p data-tool="mdnice编辑器">其实也有一个简单的解决方案，就是直接抽取十分之一细胞即可，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>sce.tmp = sce.all[, sample(<span>1</span>:ncol(sce.all),round(ncol(sce.all)/<span>10</span>)) ]<br>tmp=as.matrix(sce.tmp@assays$RNA@counts)<br>write.csv(t(tmp), file = <span>"sce.all.csv"</span>) <br></code></pre><p data-tool="mdnice编辑器">其实， 如果有单细胞亚群注释信息，我们仍然是推荐拆分成为不同单细胞亚群，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>load(file = <span>'phe-by-markers.Rdata'</span>)<br>table(phe$celltype)<br><br>sce.all$celltype = phe$celltype<br><span>#拆分为 多个 seurat子对象</span><br>sce.all.list &lt;- SplitObject(sce.all , split.by = <span>"celltype"</span>)<br>sce.all.list <br><br>names(sce.all.list)<br><span>for</span> (i <span>in</span> names(sce.all.list)) {<br>   mat = sce.all.list[[i]]@assays$RNA@counts<br>   write.csv(t(as.matrix(  mat )), file = paste0(i,<span>".sce.all.csv"</span>)) <br>} <br></code></pre><p data-tool="mdnice编辑器">一般来说，哪怕是五万到十万个细胞的矩阵，拆分成为不同单细胞亚群，每个亚群都是少于一万个细胞的，就可以很容易转变为真正的矩阵存储在R里面啦。</p><p data-tool="mdnice编辑器">但是，如果是下面的这样的情况就麻烦大了 ，总共是三百多万个单细胞，每个亚群仍然是有几十万个单细胞，比普通人一个单细胞转录组项目的细胞数量还有多一个数量级。</p><p><img data-galleryid="" data-ratio="0.8" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwgmI0ylwjvtz2gJfBx0X2yIwib36QxuTicofbutMGj3gwdtBJqMjvu48uDmGdkAjZKGv3pQm2qIeEA/640?wx_fmt=png" data-type="png" data-w="1150" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwgmI0ylwjvtz2gJfBx0X2yIwib36QxuTicofbutMGj3gwdtBJqMjvu48uDmGdkAjZKGv3pQm2qIeEA/640?wx_fmt=png"></p><h3 data-tool="mdnice编辑器"><span></span>为什么要输出csv文件呢<span></span></h3><p data-tool="mdnice编辑器">其实是因为有一些后续分析步骤在其它编程语言里面完成，比如在Python里面的转录因子分析。大家可以再次复习一下前面的笔记：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511888&amp;idx=1&amp;sn=15bad0f377832710a08451eb3d6d2f76&amp;scene=21#wechat_redirect" data-linktype="2">pyscenic的转录因子分析结果展示之5种可视化</a> ，回顾了一下 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247498091&amp;idx=1&amp;sn=5c157da6e889f2134ef9342cee560197&amp;scene=21#wechat_redirect" data-linktype="2">单细胞转录因子分析之SCENIC流程</a>  ，需要重新认识了  <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247504858&amp;idx=1&amp;sn=d0723511206f8957561ad0692aa8362b&amp;scene=21#wechat_redirect" data-linktype="2">使用pyscenic做转录因子分析</a> 后的结果。</p><p data-tool="mdnice编辑器">如果是多个单细胞亚群各自的csv文件，就需要写一个脚本接受输入输出文件了，在Linux环境里面写一个 Python脚本 （ csv2loom.py ）把 csv格式的表达量矩阵  转为  .loom 文件  ，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> os, sys<br>os.getcwd()<br>os.listdir(os.getcwd()) <br><br>input_csv = sys.argv[<span>1</span>]<br>output_loom = sys.argv[<span>2</span>]<br><br><span>import</span> loompy <span>as</span> lp;<br><span>import</span> numpy <span>as</span> np;<br><span>import</span> scanpy <span>as</span> sc;<br>x=sc.read_csv(input_csv);<br>row_attrs = {<span>"Gene"</span>: np.array(x.var_names),};<br>col_attrs = {<span>"CellID"</span>: np.array(x.obs_names)};<br>lp.create(output_loom,x.X.transpose(),row_attrs,col_attrs);<br></code></pre><p data-tool="mdnice编辑器">有两个这个Python脚本，就需要在Linux环境下面运行：</p><pre data-tool="mdnice编辑器"><span></span><code>conda activate pyscenic<br><span># 如果是单个文件：</span><br>python csv2loom.py  tmp.csv.gz tmp.loom<br><span># 如果是多个文件，可以走下面的代码：</span><br>ls *csv.gz|<span>while</span> <span>read</span> id;<span>do</span>( python csv2loom.py   <span>$id</span> <span>${id%%.*}</span>.loom );<span>done</span><br></code></pre><p data-tool="mdnice编辑器">把每个单细胞亚群的csv格式的表达量矩阵批量转变为loom格式后走  <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247504858&amp;idx=1&amp;sn=d0723511206f8957561ad0692aa8362b&amp;scene=21#wechat_redirect" data-linktype="2">使用pyscenic做转录因子分析</a> 的流程。</p><h3 data-tool="mdnice编辑器"><span></span>学徒作业<span></span></h3><p data-tool="mdnice编辑器">对pbmc3k这个经典的单细胞表达量矩阵，根据单细胞亚群注释信息，拆分成为不同的csv格式的表达量矩阵后，独立走  <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247504858&amp;idx=1&amp;sn=d0723511206f8957561ad0692aa8362b&amp;scene=21#wechat_redirect" data-linktype="2">使用pyscenic做转录因子分析</a> 流程，然后跟整个矩阵的  <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247504858&amp;idx=1&amp;sn=d0723511206f8957561ad0692aa8362b&amp;scene=21#wechat_redirect" data-linktype="2">使用pyscenic做转录因子分析</a> 流程的结果对比！</p><p data-tool="mdnice编辑器">大家先安装这个数据集对应的包，并且对它进行降维聚类分群，参考前面的例子：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497956&amp;idx=1&amp;sn=5d4deb7cf7b7848b3e2273cbd663bb6a&amp;scene=21#wechat_redirect" data-linktype="2">人人都能学会的单细胞聚类分群注释</a>  ，而且每个亚群找高表达量基因，都存储为Rdata文件。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 0.安装R包 ----</span><br><span># devtools::install_github('caleblareau/BuenColors')</span><br><span># utils::install.packages(pkgs = "ggstatsplot")</span><br><span># InstallData("pbmc3k") </span><br><br><span>library</span>(SeuratData) <span>#加载seurat数据集  </span><br>getOption(<span>'timeout'</span>)<br>options(timeout=<span>10000</span>)<br><span>#InstallData("pbmc3k")  </span><br>data(<span>"pbmc3k"</span>)  <br>sce &lt;- pbmc3k.final   <br><span>library</span>(Seurat)<br>table(Idents(sce))<br>p1=DimPlot(sce,label = <span>T</span>)<br><br></code></pre><p data-tool="mdnice编辑器">这个数据集已经进行了不同单细胞亚群的标记，接下来就靠大家啦！</p><p data-tool="mdnice编辑器">期待大家完成作业哦！</p><h3 data-tool="mdnice编辑器"><span></span>其实内存问题有一个终极解决方案<span></span></h3><p data-tool="mdnice编辑器">就是大内存服务器啦，我们有两个方案：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247510851&amp;idx=1&amp;sn=1f4aab69309001507bc7e0ebba616f6e&amp;scene=21#wechat_redirect" data-linktype="2">一个10x单细胞样品费用拿下你的专属64线程200G内存服务器</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247507852&amp;idx=1&amp;sn=cd51efdc0c7db4d71065d2bd42750a72&amp;scene=21#wechat_redirect" data-linktype="2">96线程384G内存服务器共享一年仅700（每月一批，循环开通账号）</a></section></li></ul></section><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/uUV3_2sUWodAO-yPMvqp4g",target="_blank" rel="noopener noreferrer">原文链接</a>
