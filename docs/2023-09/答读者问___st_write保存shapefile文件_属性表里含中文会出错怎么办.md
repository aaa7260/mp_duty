---
title: "答读者问 | st_write保存shapefile文件，属性表里含中文会出错怎么办"
date: 2023-09-05T00:10:31Z
draft: ["false"]
tags: [
  "fetched",
  "R语言学堂"
]
categories: ["Acdemic"]
---
答读者问 | st_write保存shapefile文件，属性表里含中文会出错怎么办 by R语言学堂
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器"><strong><span>专注</span></strong><span><strong><span>系列化</span></strong></span><strong><span>、</span></strong><span><strong><span>高质量</span></strong></span><strong><span>的R语言教程</span></strong></p><p data-tool="mdnice编辑器"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247502459&amp;idx=1&amp;sn=ee8b6442468ca123ca127806435103d3&amp;chksm=ce049251f9731b473ee5d4e7a19786cbe23c70c442843199edabbaf2d18d601c5b460063eb91&amp;scene=21#wechat_redirect" textvalue="‍推文索引" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>推文索引</span></a><span> | <a target="_blank" href="https://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247490868&amp;idx=1&amp;sn=181032ee65a5ce5c9595530cceabcb8c&amp;chksm=ce07451ef970cc08dc75ed55c295e2f6ecd6c327199fe99fc3a041a597b8dece8b3a9860fc92&amp;scene=21#wechat_redirect" textvalue="联系小编" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2">联系小编</a> | <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247503266&amp;idx=1&amp;sn=e43cfe33776bfc956d6f822aba8b95b0&amp;chksm=ce049588f9731c9e7a8489c13d5484fa81a60923e240e98a759d0388ad4b140607948d25b409&amp;scene=21#wechat_redirect" textvalue="咨询服务" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">咨询服务</a></span></p><hr data-tool="mdnice编辑器"></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span><span>读者问题</span></h2><p data-tool="mdnice编辑器">最近有读者向学堂君咨询了一个问题，问题代码出现在下面这篇推文里：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247484486&amp;idx=3&amp;sn=52737f5f61a73e58a3a8d444e8a8e43a&amp;scene=21#wechat_redirect" data-linktype="2">sf | 读取和保存空间矢量数据</a></section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="1.7247311827956988" data-type="png" data-w="930" data-src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzfjrq7Q4fPl89lyydHLfIqeYhOJDz2wChRcFaDOVnPap79EUk38ibeUw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzfjrq7Q4fPl89lyydHLfIqeYhOJDz2wChRcFaDOVnPap79EUk38ibeUw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span><span>问题复现</span></h2><p data-tool="mdnice编辑器">假设在R中生成了如下属性表含中文的<code>sf</code>对象：</p><pre data-tool="mdnice编辑器"><code><span>library</span>(sf)<br>nc &lt;- st_read(system.file(<span>"shape/nc.shp"</span>, package = <span>"sf"</span>))<br>nc$AREA = <span>"面积"</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.08636363636363636" data-type="png" data-w="880" data-src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZz7oEIINRfaib1Kszl9iaOKjJmCJRJPWD3bRU9KQ4rAA8xN97jcnyOFQoA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZz7oEIINRfaib1Kszl9iaOKjJmCJRJPWD3bRU9KQ4rAA8xN97jcnyOFQoA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">中文字符在R环境中是正常显示的。现在要使用<code>st_write()</code>函数将该对象保存为本地的shapefile文件：</p><pre data-tool="mdnice编辑器"><code>st_write(nc, <span>"E:/nc1.shp"</span>, delete_layer = <span>T</span>) <br></code></pre><p data-tool="mdnice编辑器">运行后可以正常在本地生成shapefile文件，但是输出结果会出现如下警告：</p><pre data-tool="mdnice编辑器"><code><span>## Warning in CPL_write_ogr(obj, dsn, layer, driver,</span><br><span>## as.character(dataset_options), : GDAL Message 1: One or several characters</span><br><span>## couldn't be converted correctly from UTF-8 to ISO-8859-1. This warning will not</span><br><span>## be emitted anymore.</span><br></code></pre><p data-tool="mdnice编辑器">该警告大致意思是说不能将某些编码为<code>UTF-8</code>的字符转换为<code>ISO-8859-1</code>。我们知道，<code>UTF-8</code>编码可以用来表示中文，这些不能转换的字符应该就是属性表的中文了。</p><p data-tool="mdnice编辑器">再使用<code>st_read()</code>函数导入刚才保存的shapefile文件：</p><pre data-tool="mdnice编辑器"><code>nc1 &lt;- st_read(<span>"E:/nc1.shp"</span>)<br></code></pre><p data-tool="mdnice编辑器">可以发现，现在中文字符变成了<code>??</code>：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.09389140271493213" data-type="png" data-w="884" data-src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzQlSUDUO3CibKrribIbmWWYt3BL4I7CZTCCDTy4PwgYPomc9623tiagxGA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzQlSUDUO3CibKrribIbmWWYt3BL4I7CZTCCDTy4PwgYPomc9623tiagxGA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">使用ArcGIS打开，也是同样的乱码：</p><figure data-tool="mdnice编辑器"><img data-ratio="1.136200716845878" data-type="png" data-w="279" data-src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzTRK53WYVRFBACwX90GkN0oh4ZCOb3cVYndUQX6Gjh6cyeQt76tySSQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzTRK53WYVRFBACwX90GkN0oh4ZCOb3cVYndUQX6Gjh6cyeQt76tySSQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">这表明shapefile文件在保存时出现了问题。</p><h2 data-tool="mdnice编辑器"><span></span><span>解决方法</span></h2><p data-tool="mdnice编辑器">解决方法就是在保存shapefile时把编码方式设置为<code>UTF-8</code>。</p><p data-tool="mdnice编辑器">实际上，学堂君在写推文<a href="https://mp.weixin.qq.com/s?__biz=Mzg2MjU1NjQ4NQ==&amp;mid=2247484486&amp;idx=3&amp;sn=52737f5f61a73e58a3a8d444e8a8e43a&amp;scene=21#wechat_redirect" data-linktype="2">sf | 读取和保存空间矢量数据</a>时并没有遇到这个问题，问题应该是由<code>GDAL</code>的更新引起的。<code>sf</code>包读取和写入矢量文件都需要依赖<code>GDAL</code>库（https://gdal.org/）。</p><p data-tool="mdnice编辑器"><code>st_write()</code>函数看起来并没有设置<code>encoding</code>的参数。查看<code>rgdal</code>工具包的CRAN网页，可以看到有个<code>OGR shapefile encoding</code>的文档，链接如下：</p><ul data-tool="mdnice编辑器"><li><section>https://mirrors.tuna.tsinghua.edu.cn/CRAN/web/packages/rgdal/vignettes/OGR_shape_encoding.pdf</section></li></ul><p data-tool="mdnice编辑器">文档的2.1节结尾有个示例：</p><pre data-tool="mdnice编辑器"><code>writeOGR(mySDF, dsn, layer, driver = <span>"ESRI Shapefile"</span>,<br>         layer_options = <span>'ENCODING="LDID/31"'</span>)<br></code></pre><p data-tool="mdnice编辑器"><code>st_write()</code>函数也有<code>layer_options</code>这个参数。比照上面示例：</p><pre data-tool="mdnice编辑器"><code>st_write(nc, <span>"E:/nc2.shp"</span>, delete_layer = <span>T</span>,<br>         layer_options = <span>'ENCODING=UTF-8'</span>)<br></code></pre><blockquote data-tool="mdnice编辑器"><span></span><p><strong>注意：</strong><code>ENCODING=UTF-8</code>的等号<code>=</code>两侧不能有空格。</p><span></span></blockquote><p data-tool="mdnice编辑器">上面代码的输出结果没有出现警告。再次把文件读入到R环境中：</p><pre data-tool="mdnice编辑器"><code>nc2 &lt;- st_read(<span>"E:/nc2.shp"</span>)<br></code></pre><p data-tool="mdnice编辑器">中文字符可正常显示：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.09173272933182333" data-type="png" data-w="883" data-src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZz4PsIMWBf5zdodvVVwibFF1BuEf7w9Cx0HYzl7ssgwVeajFOJ13KP9DQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZz4PsIMWBf5zdodvVVwibFF1BuEf7w9Cx0HYzl7ssgwVeajFOJ13KP9DQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">问题解决！</p><h2 data-tool="mdnice编辑器"><span></span><span>关于<code>layer_options</code>参数</span></h2><p data-tool="mdnice编辑器">在<code>sf</code>的CRAN网页中也有一篇介绍文档提到<code>layer_options</code>参数：</p><ul data-tool="mdnice编辑器"><li><section>https://mirrors.tuna.tsinghua.edu.cn/CRAN/web/packages/sf/vignettes/sf2.html</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.36574074074074076" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzolDWLJibhQ0wDiaro1VTiasib1ZibY05y2pMEcXvoPgiaYiaJaGibZ5Z8olGjQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzolDWLJibhQ0wDiaro1VTiasib1ZibY05y2pMEcXvoPgiaYiaJaGibZ5Z8olGjQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">阅读该文档可以知道：<code>layer_options</code>参数对应GDAL的驱动器手册中<code>options of creating layers</code>，另一个参数<code>dataset_option</code>对应<code>options of opening a dataset</code>。</p><p data-tool="mdnice编辑器">以shapefile为例，它的驱动器为<code>ESRI Shapefile</code>。在下面网页中点击对应的驱动器链接：</p><ul data-tool="mdnice编辑器"><li><section>https://gdal.org/drivers/vector/index.html</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.5737514518002322" data-type="png" data-w="861" data-src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzmSuJJ0cOPlsmZISxmAN24ySceKund1cCM09JLZ71hlhQMhPYAXNicnA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzmSuJJ0cOPlsmZISxmAN24ySceKund1cCM09JLZ71hlhQMhPYAXNicnA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">可以看到打开的网页有如下部分：</p><ul data-tool="mdnice编辑器"><li><section>https://gdal.org/drivers/vector/shapefile.html#configuration-options</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.3824074074074074" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzIs4SqfBUcTwFUD4iar7qykJrQMHNiaibSBMoLtngUjJsICQIsKYeI2ia2Q/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzIs4SqfBUcTwFUD4iar7qykJrQMHNiaibSBMoLtngUjJsICQIsKYeI2ia2Q/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">当有多个<code>option</code>需要设定时，<code>layer_options</code>参数的赋值使用如下形式：</p><pre data-tool="mdnice编辑器"><code>st_write(nc, <span>"E:/nc2.shp"</span>, delete_layer = <span>T</span>,<br>         layer_options = c(<span>'ENCODING=UTF-8'</span>, <span>'AUTO_REPACK=YES'</span>))<br></code></pre><p data-tool="mdnice编辑器">文档示例里使用了<code>OVERWRITE</code>这个选项，驱动器是<code>PostgreSQL</code>：</p><pre data-tool="mdnice编辑器"><code>st_write(st_as_sf(meuse), <span>"PG:dbname=postgis"</span>, <span>"meuse"</span>, <br>         layer_options = <span>"OVERWRITE=true"</span>)<br></code></pre><p data-tool="mdnice编辑器">打开<code>PostgreSQL</code>的手册网页，可以看到在<code>Layer Creation Options</code>里有<code>OVERWRITE</code>选项：</p><ul data-tool="mdnice编辑器"><li><section>https://gdal.org/drivers/vector/pg.html#layer-creation-options</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.32685185185185184" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzLu2oa1u48mc0qkpzDKon5Lj2j0dkDfFxYHKpnbRibsZnATvrsUGxRww/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KLibvaf3qiacTpkYhEia8nIZHZzLu2oa1u48mc0qkpzDKon5Lj2j0dkDfFxYHKpnbRibsZnATvrsUGxRww/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">因此<code>layer_options</code>参数可设置的选项，会因保存文件的类型（对应不同的驱动器）而异。</p></section><section><mp-common-profile data-pluginname="mpprofile" data-id="Mzg2MjU1NjQ4NQ==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/0M89ibrx9KL9a707y9iaaiaev0bAHCCHpKV6tpmhVIFmhtf98s0eb6otVJwVwPQNShzaGLp9kUSib1KeW8yIlO8nOA/0?wx_fmt=png" data-nickname="R语言学堂" data-alias="rstudier" data-signature="数据处理、可视化、数学模型、GIS、科研技能。" data-from="0" data-weuitheme="light"></mp-common-profile></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/zzuReKmu08_GJAFT1tJZkA",target="_blank" rel="noopener noreferrer">原文链接</a>
