---
title: "使用snakemake管理转录组流程"
date: 2023-09-12T15:02:46Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
使用snakemake管理转录组流程 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section>本周为大家带来snakemake的使用，参考往期<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247514989&amp;idx=1&amp;sn=2502564754823455d1833597ebc4cb4b&amp;chksm=fa457e50cd32f746fdde14c55c2ea5faad7ce95b7298813249cedf4a06de4ca4c3be3f3b25d2&amp;scene=21&amp;cur_album_id=2545418429466607617#wechat_redirect" data-linktype="2">初探mRNA、lncRNA联合分析之上游</a>流程，进行实战演练</section><section>我在学习snakemake阅读过的文章：</section><ul data-tool="mdnice编辑器"><li><section><section>Snakemake：简单好用的生信流程搭建工具(http://www.biomarker.com.cn/archives/19623)</section></section></li><li><section><section><a href="https://mp.weixin.qq.com/s?__biz=MzkzNTQwMjU5OA==&amp;mid=2247487172&amp;idx=1&amp;sn=a7b40d9da15a1d9440303af7b3886617&amp;scene=21#wechat_redirect" data-linktype="2">snakemake教程：写一个pipeline，自动下载参考基因组并建立索引</a></section></section></li><li><section><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg3OTU5NTQxMA==&amp;mid=2247497108&amp;idx=1&amp;sn=95113fbadc917ecd83b449880062e61a&amp;scene=21#wechat_redirect" data-linktype="2">Snakemake入门</a></section></section></li><li><section><section><a href="https://mp.weixin.qq.com/s?__biz=MzkxMjE4NDc2Mw==&amp;mid=2247494285&amp;idx=1&amp;sn=59553e05ae7dd37f9fb07b0da17485ca&amp;scene=21#wechat_redirect" data-linktype="2">Snakemake 搭建流程</a></section></section></li></ul><section>所以我们废话不多说直接上实战</section><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">snakemake基于python实现，安装也很简单直接用pip就行</p><pre data-tool="mdnice编辑器"><span></span><code>pip install snakemake<br></code></pre><p data-tool="mdnice编辑器">此外，本套使用snakemake管理的流程中的其他软件安装，参考往期推文</p><h2 data-tool="mdnice编辑器"><span></span>下面是<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247514989&amp;idx=1&amp;sn=2502564754823455d1833597ebc4cb4b&amp;chksm=fa457e50cd32f746fdde14c55c2ea5faad7ce95b7298813249cedf4a06de4ca4c3be3f3b25d2&amp;scene=21&amp;cur_album_id=2545418429466607617#wechat_redirect" data-linktype="2">初探mRNA、lncRNA联合分析之上游</a>使用snakemake管理流程的全部代码：</h2><pre data-tool="mdnice编辑器"><span></span><code>samples = [<span>"SRR20653290"</span>,<span>"SRR20653291"</span>,<span>"SRR20653292"</span>,<span>"SRR20653293"</span>,<span>"SRR20653294"</span>,<span>"SRR20653295"</span>]<br><br>rule target:<br>  input:<br>    <span>"end_signal_SRR20653290"</span>,<br>    <span>"end_signal_SRR20653291"</span>,<br>    <span>"end_signal_SRR20653292"</span>,<br>    <span>"end_signal_SRR20653293"</span>,<br>    <span>"end_signal_SRR20653294"</span>,<br>    <span>"end_signal_SRR20653295"</span><br>    <br>      <br>rule get_fa_index:<br>  output:<br>    <span>"ref/Homo_sapiens.GRCh38.dna.toplevel.fa"</span>,<br>    <span>"ref/human_hisat2"</span><br>  <br>  shell:<br>    <span>""</span><span>"<br>    mkdir ref<br>    axel -n20 https://ftp.ensembl.org/pub/release-110/fasta/homo_sapiens/dna/Homo_sapiens.GRCh38.dna.toplevel.fa.gz -o ref/<br>    gunzip ref/Homo_sapiens.GRCh38.dna.toplevel.fa.gz<br>    hisat2-build -p 12 ref/Homo_sapiens.GRCh38.dna.toplevel.fa ref/human_hisat2<br>    "</span><span>""</span><br>  <br>  <br>rule get_gtf:<br>  output:<br>    <span>"ref/gencode.v44.annotation_RmChr.gtf"</span><br>  <br>  shell:<br>    <span>""</span><span>"<br>    axel -n20 https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_44/gencode.v44.annotation.gtf.gz -o ref/<br>    gunzip gencode.v44.annotation.gtf.gz<br>    sed 's/^chr//' ref/gencode.v44.annotation.gtf &gt; ref/gencode.v44.annotation_RmChr.gtf<br>    "</span><span>""</span><br>    <br>  <br>rule get_fq:<br>  output:<br>    <span>"raw_fq/{id}_1.fastq.gz"</span>,<br>    <span>"raw_fq/{id}_2.fastq.gz"</span><br>    <br>  shell:<br>    <span>""</span><span>"<br>    mkdir raw_fq<br>    cd raw_fq/ &amp;&amp; kingfisher get -p PRJNA862537 -m ena-ascp ena-ftp prefetch aws-http &amp;&amp; cd ..<br>    "</span><span>""</span><br>  <br>  <br>rule fastp:<br>  input:<br>    <span>"raw_fq/{id}_1.fastq.gz"</span>,<br>    <span>"raw_fq/{id}_2.fastq.gz"</span><br>  output:<br>    <span>"clean_fq/{id}_1.fastp.fq.gz"</span>,<br>    <span>"clean_fq/{id}_2.fastp.fq.gz"</span>,<br>    <span>"{id}.html"</span><br>    <br>  shell:<br>    <span>""</span><span>"<br>    mkdir clean_fq<br>    fastp -i {input[0]} -o {output[0]} -I {input[1]} -O {output[1]} -l 36 -q 20 --compression=6 -R {wildcards.id} -h {output[2]}<br>    "</span><span>""</span><br>    <br>  <br>rule hisat2_samtools:<br>  input:<br>    <span>"ref/human_hisat2"</span>,<br>    <span>"clean_fq/{id}_1.fastp.fq.gz"</span>,<br>    <span>"clean_fq/{id}_2.fastp.fq.gz"</span><br><br>  output:<br>    <span>"bam/{id}.bam"</span><br>  <br>  shell:<br>    <span>""</span><span>"<br>    mkdir bam<br>    hisat2 -p 12 -x {input[0]}  -1 {input[1]} -2 {input[2]} | samtools sort -@ 4 -o {output}<br>    "</span><span>""</span><br>    <br>    <br>rule assembly_gtf:<br>  input:<br>    <span>"ref/gencode.v44.annotation_RmChr.gtf"</span>,<br>    <span>"bam/{id}.bam"</span><br>  output:<br>    <span>"assembly_gtf/{id}.gtf"</span><br>  shell:<br>    <span>""</span><span>"<br>    mkdir assembly_gtf<br>    stringtie -p 12 -G {input[0]} -o {output} -l {wildcards.id} {input[1]}<br>    "</span><span>""</span><br><br><br>rule merge_gtf:<br>  input:<br>    [<span>"assembly_gtf/{sample_id}.gtf"</span>.format(sample_id=sample_id) <span>for</span> sample_id <span>in</span> samples]<br>  output:<br>    <span>"merge_gtf/merged.gtf"</span><br>  shell:<br>    <span>""</span><span>"<br>    mkdir merge_gtf<br>    ls {input} &gt; merge_gtf/gtf.list<br>    stringtie --merge -p 12 -G {input} -o {output} merge_gtf/gtf.list<br>    "</span><span>""</span><br>    <br>    <br>rule quantity:<br>  input:<br>    <span>"merge_gtf/merged.gtf"</span>,<br>    <span>"bam/{id}.bam"</span><br>  output:<br>    <span>"quantity/{id}/gtf"</span>,<br>    <span>"quantity/{id}_gene_abundences.tsv"</span><br>  shell:<br>    <span>""</span><span>"<br>    mkdir quantity<br>    stringtie -p 12 -e -G {input[0]} -o {output[0]} -A {output[1]} {input[1]}  <br>    "</span><span>""</span><br><br><br>rule end_sig:<br>  input:<br>    <span>"quantity/{id}/gtf"</span>,<br>    <span>"quantity/{id}_gene_abundences.tsv"</span><br>  output:<br>    <span>"end_signal_{id}"</span><br>  shell:<br>    <span>"touch end_signal_{wildcards.id}"</span><br><br></code></pre><p data-tool="mdnice编辑器">我们dry run一下：</p><pre data-tool="mdnice编辑器"><span></span><code><span>$snakemake</span> --<span>help</span> | grep <span>"dry"</span><br>usage: snakemake [-h] [--dry-run] [--profile PROFILE]<br>  --dry-run, --dryrun, -n<br>                        <span>done</span>. If you have a very large workflow, use --dry-run<br>                        together with --dry-run to list files without actually<br>                        Use together with --dry-run to list files without<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>$snakemake</span> -n<br>Building DAG of <span>jobs</span>...<br>Job stats:<br>job                count<br>---------------  -------<br>assembly_gtf           6<br>end_sig                6<br>fastp                  6<br>get_fa_index           1<br>get_fq                 6<br>get_gtf                1<br>hisat2_samtools        6<br>merge_gtf              1<br>quantity               6<br>target                 1<br>total                 40<br></code></pre><p data-tool="mdnice编辑器">可视化之前需要安装graphviz</p><pre data-tool="mdnice编辑器"><span></span><code>mamba install graphviz<br></code></pre><p data-tool="mdnice编辑器">可视化</p><pre data-tool="mdnice编辑器"><span></span><code>snakemake --dag | dot -Tpdf &gt; test1.pdf<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7518518518518519" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9y3ibupsog1I5KBPoUPJexw3RySCau7Q6gVzlqC3F3Omxep86aseQqaib22fsiaeOrYTMx2qjvDR0aA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9y3ibupsog1I5KBPoUPJexw3RySCau7Q6gVzlqC3F3Omxep86aseQqaib22fsiaeOrYTMx2qjvDR0aA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">流程输入输出非常清晰</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">下面我们就看看编写snakemake代码时有哪些tricks，非常基础的部分参考上面给出的推文即可</p><h2 data-tool="mdnice编辑器"><span></span>易错点：</h2><p data-tool="mdnice编辑器">①一个snakemake流程由多个rule组成，<strong>每个rule都可以由input、output和处理（shell、script）三个部分组成，一开始编写的时候很容易忘记在shell中将输出输出部分改为{input} {output},而是像一般软件执行那样输入具体的文件路径名称</strong></p><p data-tool="mdnice编辑器">②每个rule的输入输出需要串得起来<strong>，snakemake正是通过rule的input和output部分完成流程的搭建，并匹配通配符</strong></p><p data-tool="mdnice编辑器">③在shell部分使用通配符时，需要注意加上wildcards，如{wildcards.id}</p><h2 data-tool="mdnice编辑器"><span></span>tricks</h2><h3 data-tool="mdnice编辑器"><span></span>多种方法确定最终需要生成的文件：<span></span></h3><p data-tool="mdnice编辑器">如</p><ul data-tool="mdnice编辑器"><li><section>①在smk文件最开始指定一个只有input的rule</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.8235294117647058" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9y3ibupsog1I5KBPoUPJexwAPtgFFHYyNX1EvOk4wicdcfeMJ6gNEfh6ial6CeH9iagTMBV3uRxVshQA/640?wx_fmt=png" data-type="png" data-w="969" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9y3ibupsog1I5KBPoUPJexwAPtgFFHYyNX1EvOk4wicdcfeMJ6gNEfh6ial6CeH9iagTMBV3uRxVshQA/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section>②在命令调用smk时指定输出所需结果文件</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="1.24" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9y3ibupsog1I5KBPoUPJexwSnGLwictrAFDWib36rwIKgTjiaGfia6E8dAM7Y9gsJtGS2gek590RmZ9hg/640?wx_fmt=png" data-type="png" data-w="700" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9y3ibupsog1I5KBPoUPJexwSnGLwictrAFDWib36rwIKgTjiaGfia6E8dAM7Y9gsJtGS2gek590RmZ9hg/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>多种方法选择平行情况：<span></span></h3><p data-tool="mdnice编辑器">有的时候我们会进行选择，比如是去下ENSEMBL的参考基因组，还是UCSC的</p><p data-tool="mdnice编辑器">当然这不需要我们手动选择</p><p data-tool="mdnice编辑器">如</p><ul data-tool="mdnice编辑器"><li><section>①在命令调用smk时 <code>-R</code> 参数指定使用的rule</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.7686350435624395" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9y3ibupsog1I5KBPoUPJexw0BUfficO6pamJU3VfGkNLa8OtRUhOibt81Qw2z3WicGZ5pLppcaxNjr1Q/640?wx_fmt=png" data-type="png" data-w="1033" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9y3ibupsog1I5KBPoUPJexw0BUfficO6pamJU3VfGkNLa8OtRUhOibt81Qw2z3WicGZ5pLppcaxNjr1Q/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section>②调整不同rule的output和input</section></li></ul><blockquote data-tool="mdnice编辑器"><p>Snakefile中定义的规则中自上而下的进行匹配</p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="1.1807407407407406" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9y3ibupsog1I5KBPoUPJexwZbkdic29MvEA2JHmygDJQtBAJ62vEbX4RkAnhj9tkqp4Ctm2msIlXmw/640?wx_fmt=png" data-type="png" data-w="675" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9y3ibupsog1I5KBPoUPJexwZbkdic29MvEA2JHmygDJQtBAJ62vEbX4RkAnhj9tkqp4Ctm2msIlXmw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>多种方法对输入文件完成聚合</h2><p data-tool="mdnice编辑器">在我上面编写的snakemake中merge_gtf部分一度让我头疼</p><p data-tool="mdnice编辑器">因为你如果把input写成<code>"assembly_gtf/{id}.gtf"</code>，就会报错：</p><pre data-tool="mdnice编辑器"><span></span><code>rule merge_gtf:<br>  input:<br>    <span>"assembly_gtf/{id}.gtf"</span><br>  output:<br>    <span>"merge_gtf/merged.gtf"</span><br>  shell:<br>    <span>""</span><span>"<br>    mkdir merge_gtf<br>    ls {input} &gt; merge_gtf/gtf.list<br>    stringtie --merge -p 12 -G {input} -o {output} merge_gtf/gtf.list<br>    "</span><span>""</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>$snakemake</span> -n<br>Building DAG of <span>jobs</span>...<br>WildcardError <span>in</span> rule merge_gtf <span>in</span> file /home/data/t120455/snakemake_demo/snakemake_tt/Snakefile, line 96:<br>Wildcards <span>in</span> input files cannot be determined from output files:<br><span>'id'</span><br></code></pre><p data-tool="mdnice编辑器">merge_gtf上一条rule：assembly_gtf的输出文件就是<code>assembly_gtf/{id}.gtf</code> ，所以很容易写成这样</p><p data-tool="mdnice编辑器">这里我们其实需要的是聚合操作</p><pre data-tool="mdnice编辑器"><span></span><code>rule merge_gtf:<br>  input:<br>    [<span>"assembly_gtf/{sample_id}.gtf"</span>.format(sample_id=sample_id) <span>for</span> sample_id <span>in</span> samples]<br>...<br></code></pre><p data-tool="mdnice编辑器">可以看出类似python列表推导式的格式，①</p><p data-tool="mdnice编辑器">②还可以使用其他函数来实现这个功能</p><p data-tool="mdnice编辑器">参考：</p><p data-tool="mdnice编辑器">Snakemake：简单好用的生信流程搭建工具(http://www.biomarker.com.cn/archives/19623)</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5388888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9y3ibupsog1I5KBPoUPJexwj98eDr3t2c2icAUiaSxYickTo5z4YTNpya3BKibG1ic4sgeByaV3DB1gwoA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9y3ibupsog1I5KBPoUPJexwj98eDr3t2c2icAUiaSxYickTo5z4YTNpya3BKibG1ic4sgeByaV3DB1gwoA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">以及 <a href="https://mp.weixin.qq.com/s?__biz=MzkxMjE4NDc2Mw==&amp;mid=2247494285&amp;idx=1&amp;sn=59553e05ae7dd37f9fb07b0da17485ca&amp;scene=21#wechat_redirect" data-linktype="2">Snakemake 搭建流程</a> - 聚合</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">以上就是本期全部内容</p></section><h4 data-tool="mdnice编辑器">文末友情宣传</h4><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524240&amp;idx=1&amp;sn=94c9ef8c3d8080c30c8372d4fb5999ab&amp;chksm=9b4bdf2bac3c563def9232bb78f43bcaa13d7c3442b00cf83aaa32ae98f4500883fa8803fb98&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买一‍得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">时隔5年，我们的生信技能树VIP学徒继续招生啦</a><br></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247522831&amp;idx=2&amp;sn=1744efdf428465425a145ff3a982198b&amp;chksm=9b4bdab4ac3c53a28fbecbbff4f254f470b54a7a20468bb753b295b930315e1ec45bcbabc10b&amp;scene=21#wechat_redirect" textvalue="144线程640Gb内存服务器共享一年‍仍然是仅需800" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">144线程640Gb内存服务器共享一年仍然是仅需800</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">千呼万唤始出来的独享生物信息学云服务器</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"></a><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524275&amp;idx=1&amp;sn=fa592ee29f636f34387491d0fceadd8e&amp;chksm=9b4bdf08ac3c561e0881974b3817beb0a0e514dc1a8df4c34c2b6653da6fa78e09acb03c70c2&amp;scene=21#wechat_redirect" textvalue="生信技能树知识整理实习生又又又开放申请啦" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信技能树知识整理实习生又又又开放申请啦</a></section></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524432&amp;idx=1&amp;sn=5b33b0c6807a9e6939c332c58fabff89&amp;chksm=9b4b20ebac3ca9fdb3d8bfaf2bef5552f64eb70e7fae557cc7197fb1a23b3e8bc31b585bf829&amp;scene=21#wechat_redirect" textvalue="生信共享办公室出租" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信共享办公室出租</a></p></li></ul><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/-xCb-X_Qxjk5KvCJDgaqOQ",target="_blank" rel="noopener noreferrer">原文链接</a>
