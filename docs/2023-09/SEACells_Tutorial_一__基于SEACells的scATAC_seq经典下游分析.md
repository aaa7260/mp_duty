---
title: "SEACells Tutorial（一）：基于SEACells的scATAC-seq经典下游分析"
date: 2023-09-18T04:32:46Z
draft: ["false"]
tags: [
  "fetched",
  "TOP生物信息"
]
categories: ["Acdemic"]
---
SEACells Tutorial（一）：基于SEACells的scATAC-seq经典下游分析 by TOP生物信息
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><code><span>写在前面：</span></code></p><p data-tool="mdnice编辑器">目前，单细胞基因组学数据的细胞分辨率与大多数分析的cluster级分辨率之间存在着根本的脱节，简单来说就是在聚类分析的过程中，通常会导致cluster级分辨率，这意味着<strong>一组细胞被归为同一类别，而忽略了它们内部的细微差异</strong>。</p><p data-tool="mdnice编辑器">为了克服数据的稀疏性和噪声的问题，我们通常会把<strong>metacells</strong>作为一个有效的解决办法。通俗来说，metacells是单细胞测序数据的细胞分组，即在不同深度下对单细胞进行聚合，其<strong>细胞内的变异都是由技术因素引起的，而非生物学因素</strong>，这样就使得细胞的均匀性大大提高。</p><p data-tool="mdnice编辑器">2023年3月27日，在<strong>nature biotechnology</strong>上发布了一篇文章，作者给出了一种计算metacells的算法，可从单细胞基因组学数据中推断出转录和表观层面的细胞状态。在这里我们对作者发布的SEACells整个分析tutorial进行复现，期望能够在实践中加以应用。</p><p data-tool="mdnice编辑器"><strong>备注</strong>：本教程代码部分在Google Colab运行环境中完成，Google Colab是Google提供的一个Jupyter Notebook式的交互环境。</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器"><code><span>文章目录：</span></code></p><ul><li><p>概述</p></li><li><p>一、准备工作</p></li><li><p>二、加载数据</p></li><li><p>三、提取元细胞</p></li><li><p>四、Gene-peak correlations计算</p></li><li><p>五、高度调控基因的计算</p></li><li><p>六、基因得分</p></li><li><p>七、Gene-accessibility计算</p></li><ul><li><p>元细胞中的开放峰识别</p></li><li><p>基因可及性指标</p></li><li><p>可视化</p></li></ul><li><p>Reference</p></li></ul><p data-tool="mdnice编辑器"><br></p><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span><span>概述</span></h2><p data-tool="mdnice编辑器">本文章主要为利用SEAcells进行scATAC-seq的下游分析提供一个教程，包含了四部分的内容：<strong>gene-peak associations</strong>的计算、<strong>highly regulated genes</strong>的识别、<strong>ATAC gene 得分</strong>计算以及基因可及性得分（<strong>gene accessibility scores</strong>），这大概包含了ATAC分析下游的大部分分析流程。</p><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span><span>一、准备工作</span></h2><pre data-tool="mdnice编辑器"><span></span><code>#载入包<br><span>import</span> numpy as np<br><span>import</span> pandas as pd<br><span>import</span> scanpy as sc<br><span>import</span> SEACells<br><span>import</span> matplotlib<br><span>import</span> matplotlib.pyplot as plt<br><span>import</span> seaborn as sns<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>#画图设置<br>%matplotlib <span>inline</span><br>sns.set_style(<span>'ticks'</span>)<br>matplotlib.rcParams[<span>'figure.figsize'</span>] = [<span>4</span>, <span>4</span>]<br>matplotlib.rcParams[<span>'figure.dpi'</span>] = <span>100</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>二、加载数据</span></h2><blockquote data-tool="mdnice编辑器"><p>我们使用 scanpy Anndata 对象作为加载和过滤数据的首选模式。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code># !mkdir data/<br># !wget https:<span>//dp-lab-data-public.s3.amazonaws.com/SEACells-multiome/cd34_multiome_rna.h5ad -O data/cd34_multiome_rna.h5ad # RNA data</span><br># !wget https:<span>//dp-lab-data-public.s3.amazonaws.com/SEACells-multiome/cd34_multiome_atac.h5ad -O data/cd34_multiome_atac.h5ad # ATAC data</span><br></code></pre><p data-tool="mdnice编辑器">该数据集包含 RNA 和 ATAC 模式作为两个不同的 Anndata 对象。ATAC 数据集包含预先计算的 SEACell 元细胞（如何计算metacells后续SEACells系列文章会提到）</p><blockquote data-tool="mdnice编辑器"><p><strong>数据集介绍</strong>这是过滤后的由 CD34+ 分选出来的的骨髓细胞数据集，未进行标准化，用于分析人类造血功能，详细信息可根据上述下载链接进行查看。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code># 用scanpy加载数据集<br>rna_ad = sc.read(<span>'data/cd34_multiome_rna.h5ad'</span>)<br>atac_ad = sc.read(<span>'data/cd34_multiome_atac.h5ad'</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code># ATAC的参考细胞类型<br>sc.pl.scatter(atac_ad, basis=<span>'umap'</span>, color=<span>'celltype'</span>, frameon=False)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7851851851851852" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aSUxhFtgmfadh9NZCu9pyvokO3hdRrOumibVh7hMbTZKTvIhEMTG156mwgzv1AIxLOYyGXictSxwXA/640?wx_fmt=png" data-type="png" data-w="810" height="340" width="480" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aSUxhFtgmfadh9NZCu9pyvokO3hdRrOumibVh7hMbTZKTvIhEMTG156mwgzv1AIxLOYyGXictSxwXA/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code># SEACells的metacells计算结果<br>SEACells.plot.plot_2D(atac_ad, key=<span>'X_umap'</span>, colour_metacells=False)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.0336134453781514" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aSUxhFtgmfadh9NZCu9pyvFMWhBNzZ1ibG2DS5yelbbicfIJHl3qeFSxibgjEUOCyRYonLBvQIHg8kg/640?wx_fmt=png" data-type="png" data-w="714" height="350" width="360" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aSUxhFtgmfadh9NZCu9pyvFMWhBNzZ1ibG2DS5yelbbicfIJHl3qeFSxibgjEUOCyRYonLBvQIHg8kg/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p>上图即为SEACells的metacells计算结果的可视化情况，red points即为我们计算得到metacells，下游的分析我们只需要在元细胞的基础上进行即可，这样我们的数据集的噪声和稀疏性问题就能得到不错地解决。</p></blockquote><h2 data-tool="mdnice编辑器"><span></span><span>三、提取元细胞</span></h2><blockquote data-tool="mdnice编辑器"><p>ATAC 和 RNA 单细胞 Anndata 对象应包含同一组细胞。仅相同细胞将用于下游分析。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>atac_meta_ad, rna_meta_ad = SEACells.genescores.prepare_multiome_anndata(atac_ad, rna_ad, SEACells_label=<span>'SEACell'</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>atac_meta_ad,rna_meta_ad<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>AnnData object with n_obs × n_vars = <span>99</span> × <span>246113</span><br>    obs: <span>'n_counts'</span><br>    var: <span>'GC_bin'</span>, <span>'counts_bin'</span>, <span>'n_cells'</span><br>    uns: <span>'log1p'</span><br>    obsm: <span>'X_svd'</span><br>    layers: <span>'raw'</span><br>AnnData object with n_obs × n_vars = <span>99</span> × <span>12464</span><br>    obs: <span>'n_counts'</span><br>    uns: <span>'log1p'</span><br>    layers: <span>'raw'</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>四、Gene-peak correlations计算</span></h2><p data-tool="mdnice编辑器">要计算基因表达和基因附近峰的可及性的相关性，需要：</p><ol data-tool="mdnice编辑器"><li><section>带有基因注释的 GTF 文件及基因周围的基因组跨度信息以测试相关性</section></li><li><section>染色体名称应编号为 1：、2：形式</section></li><li><section>基因周围的基因组跨度以测试相关性</section></li></ol><pre data-tool="mdnice编辑器"><span></span><code>#基因组文件获取<br>! wget https:<span>//dp-lab-data-public.s3.amazonaws.com/SEACells-multiome/hg38.gtf -O data/hg38.gtf</span><br></code></pre><blockquote data-tool="mdnice编辑器"><p>在此示例中，我们计算rna_meta_ad.var_names中的前十个基因的基因峰值相关性，方便进行演示</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code># 这个过程是计算密集型的<br>gene_set = rna_meta_ad.var_names[:<span>10</span>]<br>gene_peak_cors = SEACells.genescores.get_gene_peak_correlations(atac_meta_ad, rna_meta_ad, <br>                                           path_to_gtf=<span>'data/hg38.gtf'</span>, <br>                                           span=<span>100000</span>, <br>                                           n_jobs=<span>1</span>,<br>                                           gene_set=gene_set)<br></code></pre><blockquote data-tool="mdnice编辑器"><p>SEACells.genescores.get_gene_peak_correlations中的参数span：即我们需要的基因周围的基因组跨度，即测试基因与附近峰之间相关性的一段基因组区域的长度，这里取100000个碱基的长度。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>#查看运行结果<br>gene_peak_cors[<span>'FAM41C'</span>].head()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6335078534031413" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aSUxhFtgmfadh9NZCu9pyvttCEuto9ORHW9RqKozKqAg2Strv3CWhBPz53TDAXt4CPgiaPtPV7ibDQ/640?wx_fmt=png" data-type="png" data-w="573" height="260" width="360" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aSUxhFtgmfadh9NZCu9pyvttCEuto9ORHW9RqKozKqAg2Strv3CWhBPz53TDAXt4CPgiaPtPV7ibDQ/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span><span>五、高度调控基因的计算</span></h2><blockquote data-tool="mdnice编辑器"><p>对于下游分析，完整的基因峰值相关性结果可作为 pickle 文件提供，网址为 https://dp-lab-data-public.s3.amazonaws.com/SEACells-multiome/cd34_multiome_gene_peak_cors.p</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>#基因组文件获取<br>! wget https:<span>//dp-lab-data-public.s3.amazonaws.com/SEACells-multiome/cd34_multiome_gene_peak_cors.p -O data/cd34_multiome_gene_peak_cors.p</span><br>gene_peak_cors = pd.read_pickle(<span>'data/cd34_multiome_gene_peak_cors.p'</span>) <br></code></pre><blockquote data-tool="mdnice编辑器"><p>高度调控的基因，即与多个峰相关的基因，可以使用 get_gene_peak_assocations 函数来识别。get_gene_peak_assocations 返回与每个基因相关的显着峰的数量</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>peak_counts = SEACells.genescores.get_gene_peak_assocations(gene_peak_cors, <br>                                                           pval_cutoff=<span>1e-1</span>,<br>                                                           cor_cutoff=<span>0.1</span>)<br></code></pre><p data-tool="mdnice编辑器">参数说明：</p><ul data-tool="mdnice编辑器"><li><section>pval_cutoff=1e-1: 这个参数设置了一个p值截止值。相关性的p值大于这个截止值（在这种情况下是0.1）的基因峰值相关性可能被过滤掉。这意味着只有p值小于或等于0.1的相关性被认为是显著的。</section></li><li><section>cor_cutoff=0.1: 这个参数设置了一个相关系数截止值。相关性系数小于这个截止值（在这种情况下是0.1）的基因峰值相关性可能被过滤掉。这意味着只有相关系数大于或等于0.1的相关性被认为是显著的。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>#绘制分布图以识别具有较高调控程度的基因<br>plt.scatter(np.arange(len(peak_counts)), <br>           np.sort(peak_counts), s=<span>20</span>)<br>sns.despine()<br>plt.xlabel(<span>'Gene rank'</span>)<br>plt.ylabel(<span>'No. of correlated peaks'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.9636803874092009" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aSUxhFtgmfadh9NZCu9pyv3xXIUeJlsLHY8Qxqy23Ev2VfBiaJHjZlM3LSXPibNaMQGfOTF83WckCg/640?wx_fmt=png" data-type="png" data-w="826" height="360" width="360" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aSUxhFtgmfadh9NZCu9pyv3xXIUeJlsLHY8Qxqy23Ev2VfBiaJHjZlM3LSXPibNaMQGfOTF83WckCg/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span><span>六、基因得分</span></h2><blockquote data-tool="mdnice编辑器"><p>基因分数计算为相关峰的可及性的加权和，并且可以使用 get_gene_scores 计算。gene_scores 是一个 pandas.Data Frame，其中元细胞为行，基因为列。这可用于任何下游分析，例如聚类、可视化等。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>gene_scores = SEACells.genescores.get_gene_scores(atac_meta_ad, <br>                                                  gene_peak_cors,<br>                                                  pval_cutoff=<span>1e-1</span>,<br>                                                  cor_cutoff=<span>0.1</span>)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>七、Gene-accessibility计算</span></h2><h3 data-tool="mdnice编辑器"><span></span><span></span><span>元细胞中的开放峰识别</span><span></span></h3><blockquote data-tool="mdnice编辑器"><p>该函数还需要低维嵌入，例如 X_svd、X_umap等等。此处我们应用scATAC 的 SVD 来进行下面的分析。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code># 用原始计数矩阵创建一个元细胞的anndata数据<br>atac_meta_ad = SEACells.core.summarize_by_SEACell(atac_ad, SEACells_label=<span>'SEACell'</span>)<br>atac_meta_ad.obs[<span>'n_counts'</span>] = np.ravel(atac_meta_ad.X.sum(axis=<span>1</span>))<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code># 加入svd低维嵌入<br>seacell_label = <span>'SEACell'</span><br>sc_svd = pd.DataFrame(atac_ad.obsm[<span>'X_svd'</span>], index=atac_ad.obs_names)<br>atac_meta_ad.obsm[<span>'X_svd'</span>] = sc_svd.groupby(atac_ad.obs[seacell_label]).mean().loc[atac_meta_ad.obs_names, :]<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code># 确定每个元细胞中的开放峰<br>SEACells.accessibility.determine_metacell_open_peaks(atac_meta_ad, peak_set=None, low_dim_embedding=<span>'X_svd'</span>, pval_cutoff=<span>1e-2</span>,<br>                                  read_len=<span>147</span>, n_neighbors=<span>3</span>, n_jobs=<span>1</span>)<br># 该函数会将“Open Peaks”添加到 Anndata 层，并且是一个二进制矩阵，指示元细胞中峰是开放的还是封闭的<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>基因可及性指标</span><span></span></h3><blockquote data-tool="mdnice编辑器"><p>开放峰用于计算基因可及性度量，该度量表示相关开放峰的分数。注意：只有当每个基因都有足够数量的开放峰时，此指标才是可靠的。建议仅用于高度调控的基因，即我们第五部分计算得到的结果。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code># 根据肘点选择基因，此处的参考图为高度调控基因的分布图<br>high_reg_genes = peak_counts.index[peak_counts &gt; <span>9</span>]<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code># 计算基因可及性<br>SEACells.accessibility.get_gene_accessibility(atac_meta_ad, gene_peak_cors, <br>                                              gene_set=high_reg_genes, pval_cutoff=<span>1e-1</span>, cor_cutoff=<span>0.1</span>)<br># 此函数会将“基因可访问性”添加到 Anndata `.obsm` 字段<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>atac_meta_ad.obsm[<span>'GeneAccessibility'</span>]<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.31296296296296294" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aSUxhFtgmfadh9NZCu9pyv94OGCPkqNypYrY4Ekcq6G9ibgIAqzbAw3xKJ6DtsQrSa4NuZvaLibwPQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aSUxhFtgmfadh9NZCu9pyv94OGCPkqNypYrY4Ekcq6G9ibgIAqzbAw3xKJ6DtsQrSa4NuZvaLibwPQ/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>可视化</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code># 首先加入umap以可视化基因可及性<br>rna_umap = pd.DataFrame(rna_ad.obsm[<span>'X_umap'</span>], index=rna_ad.obs_names)<br>rna_meta_ad.obsm[<span>'X_umap'</span>] = rna_umap.groupby(atac_ad.obs[seacell_label]).mean().loc[rna_meta_ad.obs_names, :].values<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>genes = [<span>'KLF1'</span>, <span>'GATA1'</span>, <span>'SPI1'</span>]<br>temp = rna_meta_ad[:, genes]<br>temp.layers[<span>'GeneAccessibility'</span>] = atac_meta_ad[rna_meta_ad.obs_names].obsm[<span>'GeneAccessibility'</span>][genes].values<br><br># 基因分布的可视化<br>sc.pl.scatter(rna_meta_ad, basis=<span>'umap'</span>, color=genes)<br><br># 染色质可及性的可视化<br>sc.pl.scatter(temp, basis=<span>'umap'</span>, color=genes, layers=<span>'GeneAccessibility'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6453703703703704" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aSUxhFtgmfadh9NZCu9pyv1hibyK9PtlIBO8gEIVGT3N0XOZl7a8mBkSlkoq4rpegztCD8p8kkicmQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aSUxhFtgmfadh9NZCu9pyv1hibyK9PtlIBO8gEIVGT3N0XOZl7a8mBkSlkoq4rpegztCD8p8kkicmQ/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span><span>Reference</span></h2><p data-tool="mdnice编辑器">[1]https://github.com/dpeerlab/SEACells</p><p data-tool="mdnice编辑器">[2]Persad, S., Choo, ZN., Dien, C. et al. SEACells infers transcriptional and epigenomic cellular states from single-cell genomics data. Nat Biotechnol (2023).</p></section><section><mp-common-profile data-pluginname="mpprofile" data-id="MzkzMzE5NTM4NA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aJMzXzvekL6pv5hnSGnwsxWcOUF8av7a9VEiaicBGia4CRy0DUOeaFuFZY2BPLmRQSf4lkibg5l31Ttw/0?wx_fmt=png" data-nickname="TOP生物信息" data-alias="" data-signature="生信人，当自强。" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ZmnL-EnOAlMbtdXaAZXgCw",target="_blank" rel="noopener noreferrer">原文链接</a>
