---
title: "【单细胞高级分析. 26】slingshot：赏心悦目的轨迹分析图"
date: 2023-09-26T02:32:58Z
draft: ["false"]
tags: [
  "fetched",
  "TOP生物信息"
]
categories: ["Acdemic"]
---
【单细胞高级分析. 26】slingshot：赏心悦目的轨迹分析图 by TOP生物信息
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><strong>本文目录：</strong></p><ul><li><p>1. 构建SingleCellExperiment对象</p></li><li><p>2. 提取其他有用的信息</p></li><li><p>3. 细胞亚群划分</p></li><li><p>4. 使用slingshot构建分化谱系并进行拟时推断</p></li><li><p>5. 可视化</p></li><li><p>6. tradeSeq 下游分析</p></li><li><p>点评</p></li></ul><p data-tool="mdnice编辑器"><br></p><p data-tool="mdnice编辑器">轨迹分析的软件有很多，其中最大名气的当属 <code>Monocle2</code> 和 <code>Monocle3</code> ，但是他们的作图风格嘛，确实差点意思。后来我遇到了 <code>slingshot</code> 让我眼前一亮，今天就让我们来看看 <code>slingshot</code> 到底应该如何实现。</p><p data-tool="mdnice编辑器"><code>slingshot</code> 的官方教程链接：</p><pre data-tool="mdnice编辑器"><code>https://bioconductor.org/packages/release/bioc/vignettes/slingshot/inst/doc/vignette.html<br></code></pre><p data-tool="mdnice编辑器">今天我们就来实现下面这个图：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.30925925925925923" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JxHibB8Gzf8ibxWHgICMyXJWTwicglA993xbMKoCYNX6y12kST6arj99mg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JxHibB8Gzf8ibxWHgICMyXJWTwicglA993xbMKoCYNX6y12kST6arj99mg/640?wx_fmt=png"><figcaption>final_merged_image</figcaption></figure><p data-tool="mdnice编辑器"><code>前言</code></p><p data-tool="mdnice编辑器">最近跟群里的小伙伴交流的时候，发现有些初学者对于拟时序分析缺乏一些基本的概念。在这里，<strong>有必要简单讲讲为什么要做拟时序分析？</strong></p><ol data-tool="mdnice编辑器"><li><section><strong>拟时序分析的基本假设：</strong>有机生物体内有成千上亿的细胞，他们扮演不同的身份、执行不同的功能。但我们都知道，他们并不是泾渭分明的，而是存在<strong>过渡态</strong>。比如骨髓干细胞（HSC）会逐步分化为髓系、淋巴系、红系等，我们称这样的分化轨迹为 <code>lineage</code>，这里面就会存在大量不同分化状态的细胞。</section></li><li><section><strong>什么时候可以做拟时序：</strong>当你的样本或研究对象在生物学上存在过渡态细胞时，就可以做拟时序分析。</section></li><li><section><strong>拟时序分析能得到什么：</strong>最重要的结果，就是得到拟合的“假时序”，我们可以根据合理的“假时序”对基因表达的变化值进行推断。此外，我们结合 <code>CytoTRACE</code>、<code>palantir</code> 等算法评估细胞干性，可以找到细胞分化的“变异点”，并找到什么基因/基因集推动这样的改变，这一部分小编还在学习过程，未来有机会的话再分享。</section></li></ol><p data-tool="mdnice编辑器">今天我们使用的数据是 DISCO 图谱网站上的骨髓单细胞测序数据，该数据集包含了28万细胞，为了更方便地进行实操，我们挑选了以 HSC 为起点的髓系和红系数据，并随机挑选了15000个细胞，作为我们的示例数据。</p><p data-tool="mdnice编辑器">我们将会在本文中<span><strong>公布所有实操代码</strong></span>。如果你还希望得到<span><strong>示例数据</strong></span>，可以在公众号后台回复：<strong><span>20230926</span></strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>1. 构建SingleCellExperiment对象</span><span></span></h3><p data-tool="mdnice编辑器">通常情况下，做轨迹分析之前，我们现在已经拥有一个<strong>经过质控、降维、并注释好的 <code>seurat</code> 对象</strong>，并且你应该对你的细胞轨迹有一个基本的生物学概念。我们简单看看注释的情况：</p><p data-tool="mdnice编辑器">从下图我们初步可以判断，从生物学角度，<code>HSC</code> 作为发育起点，大致存在 <code>HSC --&gt; Myeloid</code> 和 <code>HSC --&gt; Erythroblast</code> 两个 <code>lineage</code>。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5518518518518518" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JXdWbOxVgzmOVkHogMKdhJgeU7UTnQ3TLRkTFwWsWriav8bicyWQyxS1g/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JXdWbOxVgzmOVkHogMKdhJgeU7UTnQ3TLRkTFwWsWriav8bicyWQyxS1g/640?wx_fmt=png"><figcaption>Bone marrow data from DISCO</figcaption></figure><p data-tool="mdnice编辑器"><code>slingshot</code> 接收的是 <code>sce</code> 对象，因此我们首先要构建一个。</p><p data-tool="mdnice编辑器">在此我们把矩阵提取出来构建，你也可以网上找 <code>seurat</code> 对象直接转换的方法。</p><pre data-tool="mdnice编辑器"><code><span># 加载R包</span><br><span># 首先你需要把这些包安装好</span><br>suppressPackageStartupMessages({<br>  <span>library</span>(slingshot)<br>  <span>library</span>(SingleCellExperiment)<br>  <span>library</span>(qs)<br>  <span>library</span>(tidyverse)<br>  <span>library</span>(RColorBrewer)<br>})<br><br><span># 加载数据</span><br>scobj = qs::qread(file = <span>'data/01_data_prepare.qs'</span>)<br></code></pre><p data-tool="mdnice编辑器">我们把 <code>counts</code> 矩阵提取，用于构建 <code>sce</code> 的对象。</p><pre data-tool="mdnice编辑器"><code><span># 在这里为了减少计算压力，我们把高变基因提取出来</span><br><span># 你可以跟我一样从 scale.data 中提取，也可以直接在 seurat 对象中找出来</span><br>scale.data &lt;- scobj@assays$RNA@scale.data<br>scale.gene &lt;- rownames(scale.data)<br><br>counts &lt;- scobj@assays$RNA@counts<br>counts &lt;- counts[scale.gene,]<br><br><span># 将表达矩阵转换为SingleCellExperiment对象</span><br><span># 输入需要counts矩阵，否则影响下游分析</span><br>sim &lt;- SingleCellExperiment(assays = List(counts = counts)) <br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>2. 提取其他有用的信息</span><span></span></h3><p data-tool="mdnice编辑器">为了与前面画图一致，我们把<strong>降维坐标</strong>和<strong>细胞标签</strong>也提取并加入 <code>sce</code> 对象。</p><pre data-tool="mdnice编辑器"><code><span># umap reduction</span><br>umap = scobj@reductions$umap@cell.embeddings<br>colnames(umap) = c(<span>'UMAP-1'</span>, <span>'UMAP-2'</span>)<br><span># 将降维的结果添加到SingleCellExperiment对象中</span><br>reducedDims(sim) = SimpleList(UMAP = umap)<br><br><span># metadata</span><br>meta = scobj@meta.data<br><span># colData(sim)相当于meta.data，但他不是data.frame格式</span><br><span># 所以需要分步赋予</span><br>colData(sim)$sampleId = meta$sampleId<br>colData(sim)$celltype = meta$celltype<br></code></pre><p data-tool="mdnice编辑器">我们可以直接用 <code>plot()</code> 函数画一下看看：</p><pre data-tool="mdnice编辑器"><code>rd = umap<br>plot(rd, col = rgb(<span>0</span>,<span>0</span>,<span>0</span>,<span>.5</span>), pch=<span>16</span>, asp = <span>1</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.9797297297297297" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JpZsynTGpDetbic11MWDGEAvfEyKVsAMRMib3Kx20MQ70R7t9YCnPIUXQ/640?wx_fmt=png" data-type="png" data-w="444" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JpZsynTGpDetbic11MWDGEAvfEyKVsAMRMib3Kx20MQ70R7t9YCnPIUXQ/640?wx_fmt=png"><figcaption>umap_raw</figcaption></figure><p data-tool="mdnice编辑器">现在，<code>sim</code> 的信息如下：</p><pre data-tool="mdnice编辑器"><code>class: SingleCellExperiment <br>dim: 1000 15000 <br>metadata(0):<br>assays(1): counts<br>rownames(1000): HES4 ISG15 ... MT-ND4L MT-ND6<br>rowData names(0):<br>colnames(15000): GGCTGGTAGTGGGCTA-1--GSM3901485<br>  CTACACCTCTCTGTCG-1--GSM3993354 ...<br>  GACGCGTTCCGTAGTA-1--GSM5047372<br>  GGCTCGACATTGGGCC-1--GSM3901492<br>colData names(2): sampleId celltype<br>reducedDimNames(1): UMAP<br>mainExpName: NULL<br>altExpNames(0):<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>3. 细胞亚群划分</span><span></span></h3><p data-tool="mdnice编辑器">在这里我们也可以使用自己注释好的细胞作为起点或者终点，但有时候效果并不是那么好，需要多尝试几种方式，以达到满意的效果。<code>slingshot</code> 官方提供了两种方式：高斯混合模型和K-means，如果你有兴趣，可以到官网查看，我在示例数据中也提供了相关的代码。<strong>根据个人的经验，使用的分群越精细，效果反而不那么好，轨迹会出现较多重叠的现象，或出现不符合生物学常识的轨迹。</strong></p><p data-tool="mdnice编辑器">在这里我们使用已经注释好的细胞类型进行轨迹推断。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>4. 使用slingshot构建分化谱系并进行拟时推断</span><span></span></h3><p data-tool="mdnice编辑器">在 <code>slingshot</code> 中，我们可以根据我们已有的信息指定拟时序的起点：</p><blockquote data-tool="mdnice编辑器"><p>如果你没有已知的起点，slingshot 会自己给你拟合一个预测的起点，但通常不太准，或者与实际的时序信息是相反</p></blockquote><pre data-tool="mdnice编辑器"><code><span># 一行命令就可生成，这里计算是比较快的</span><br>sim &lt;- slingshot(sim, <br>                 clusterLabels = <span>'celltype'</span>,  <span># 选择colData中细胞注释的列名</span><br>                 reducedDim = <span>'UMAP'</span>,  <br>                 start.clus= <span>"HSC"</span>,  <span># 选择起点</span><br>                 end.clus = <span>NULL</span>     <span># 这里我们不指定终点</span><br>                )     <br>colnames(colData(sim))<br><span># [1] "sampleId"          "celltype"          "slingshot"        </span><br><span># [4] "slingPseudotime_1" "slingPseudotime_2" "slingPseudotime_3"</span><br><span># [7] "slingPseudotime_4"</span><br></code></pre><p data-tool="mdnice编辑器">我们可以看到，<code>sim</code> 的 <code>colData</code> 中添加了一些时序信息，每一个 <code>lineage</code> 添加了一列信息，每列信息以时序信息（拟时间）组成，如果细胞对应不在这个 <code>lineage</code> 中，则以 <code>NA</code> 表示。</p><pre data-tool="mdnice编辑器"><code>head(colData(sim)[,<span>4</span>:<span>5</span>])<br><span># DataFrame with 6 rows and 2 columns</span><br><span>#                                slingPseudotime_1 slingPseudotime_2</span><br><span>#                                        &lt;numeric&gt;         &lt;numeric&gt;</span><br><span># GGCTGGTAGTGGGCTA-1--GSM3901485           1.54205           1.54208</span><br><span># CTACACCTCTCTGTCG-1--GSM3993354          13.46079          13.44990</span><br><span># CACATAGTCTGATTCT-1--GSM3901488                NA                NA</span><br><span># GGTGAAGAGTTGGACG-1--ERX4720942          19.42507                NA</span><br><span># CACCACTAGGTCATCT-1--GSM3396162                NA          22.34963</span><br><span># GTTACAGCAGATTGCT-1--GSM3901485           2.27809           2.28129</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>5. 可视化</span><span></span></h3><p data-tool="mdnice编辑器">首先我们看看我们各个 <code>lineage</code> 是什么样的，我们使用官方提供的代码</p><pre data-tool="mdnice编辑器"><code>plot(reducedDims(sim)$UMAP, pch=<span>16</span>, asp = <span>1</span>)<br>lines(SlingshotDataSet(sim), lwd=<span>2</span>, col=brewer.pal(<span>9</span>,<span>"Set1"</span>))<br>legend(<span>"right"</span>,<br>       legend = paste0(<span>"lineage"</span>,<span>1</span>:<span>6</span>),<br>       col = unique(brewer.pal(<span>6</span>,<span>"Set1"</span>)),<br>       inset=<span>0.8</span>,<br>       pch = <span>16</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6363636363636364" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JiblRsrgKYIY1VWD9rBOXibK4EcoeDAdakuFicC1vXm8d3kvhISxiawZyBA/640?wx_fmt=png" data-type="png" data-w="638" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JiblRsrgKYIY1VWD9rBOXibK4EcoeDAdakuFicC1vXm8d3kvhISxiawZyBA/640?wx_fmt=png"><figcaption>Lineages</figcaption></figure><p data-tool="mdnice编辑器">这些 <code>lineage</code> 大致都符合我们先前注释的亚群背后的生物学知识，也有轨迹出现部分重叠，可以设置 <code>slingshot</code> 参数 <code>reweight = FALSE</code> ，让细胞不会在多个轨迹间重复评估。</p><p data-tool="mdnice编辑器">接下来，假设我们现在对 <code>lineage3</code> 非常感兴趣，我们希望把 <code>lineage3</code> 进行可视化。</p><p data-tool="mdnice编辑器">首先我们为细胞赋予颜色：</p><pre data-tool="mdnice编辑器"><code>summary(sim$slingPseudotime_2)<br><span>#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's </span><br><span>#  0.000   2.207   4.050   6.339  10.041  18.065    9446 </span><br><br><span># 我们做一个绚丽的渐变色彩虹色</span><br>colors &lt;- colorRampPalette(brewer.pal(<span>11</span>,<span>'Spectral'</span>)[-<span>6</span>])(<span>100</span>) <span># 我们把这些颜色变成100个梯度，模拟渐变色</span><br>plotcol &lt;- colors[cut(sim$slingPseudotime_3, breaks=<span>100</span>)] <span># 这里我们用cut函数把 lineage2 分割成100个区间，同一区间的细胞给与同一个颜色</span><br>plotcol[is.na(plotcol)] &lt;- <span>"lightgrey"</span> <span># 不属于 lineage3 的点为NA，我们把他们变成灰色</span><br>plotcol<br></code></pre><p data-tool="mdnice编辑器">来看看效果：</p><p data-tool="mdnice编辑器">（但是这些 <code>lineage</code> 数据怎么用 <code>ggplot2</code> 系统绘画，笔者还没找到方法）</p><pre data-tool="mdnice编辑器"><code><span># 保存时，把下面的注释运行</span><br><span># pdf(file = "figures/04_lineage2.pdf",width = 7,height = 5)</span><br>plot(reducedDims(sim)$UMAP, col = plotcol, pch=<span>16</span>, asp = <span>1</span>)<br>lines(SlingshotDataSet(sim), lwd=<span>2</span>, col=brewer.pal(<span>9</span>,<span>"Set1"</span>))<br>legend(<span>"right"</span>,<br>       legend = paste0(<span>"lineage"</span>,<span>1</span>:<span>6</span>),<br>       col = unique(brewer.pal(<span>6</span>,<span>"Set1"</span>)),<br>       inset=<span>0.8</span>,<br>       pch = <span>16</span>)<br><span># dev.off()</span><br></code></pre><p data-tool="mdnice编辑器">还挺酷的吧~</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6182965299684543" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JuNnM7JdX59L0IQgcBSibGMT2G24DqudAGDicCu4o9ajK4AbQT3EwgZuw/640?wx_fmt=png" data-type="png" data-w="634" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JuNnM7JdX59L0IQgcBSibGMT2G24DqudAGDicCu4o9ajK4AbQT3EwgZuw/640?wx_fmt=png"><figcaption>Lineage3</figcaption></figure><p data-tool="mdnice编辑器">接下来你可以保存成pdf，放在 <code>Adobe Illustrator</code> 中修改一些细节，最后我们的效果如下：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.7135980746089049" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2J29ygkMic9TSQ8wdebFrtib9vT1yFx2LHWtB5PahKldyiaDPy0p9KfwY7A/640?wx_fmt=png" data-type="png" data-w="831" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2J29ygkMic9TSQ8wdebFrtib9vT1yFx2LHWtB5PahKldyiaDPy0p9KfwY7A/640?wx_fmt=png"><figcaption>final_image</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>6. tradeSeq 下游分析</span><span></span></h3><blockquote data-tool="mdnice编辑器"><p>这一部分的知识点比较烧脑，我们主要掌握使用的关键点就可以了。</p></blockquote><h4 data-tool="mdnice编辑器"><span></span>（1）我们对 <code>lineage2</code> 进行下游分析，首先对数据进行预处理。<span></span></h4><p data-tool="mdnice编辑器">当我们纳入的细胞类型较少、复杂程度低、轨迹符合生物学背景时，拟合的模型会接近好。当复杂程度较高（如细胞类型混杂），模型会受到大量噪音影响。</p><pre data-tool="mdnice编辑器"><code><span># sce对象的colData并不是 data.frame 格式，我们需要重新构建</span><br><span># 如果你知道更简便的方法，欢迎在评论区提出</span><br>coldata &lt;- colData(sim)<br>coldata &lt;- data.frame(celltype = coldata@listData$celltype, <br>                      sampleId = coldata@listData$sampleId,<br>                      plotcol = coldata@listData$plotcol)<br>rownames(coldata) = sim@colData@rownames<br><br><span># 我们把 lineage3 信息筛选出来</span><br><span># 细胞 barcodes</span><br>filter_cell &lt;- dplyr::filter(coldata, plotcol != <span>"lightgrey"</span>)<br>filter_cell &lt;- rownames(filter_cell)<br>head(filter_cell)<br><span># 矩阵 counts</span><br>counts &lt;- sim@assays@data@listData$counts<br>filter_counts &lt;- counts[,filter_cell]<br>filter_counts[<span>1</span>:<span>5</span>,<span>1</span>:<span>5</span>]<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>（2）<code>tradeSeq</code> 运行较慢，强烈建议随机抽取2000~3000个细胞（不会影响结果的稳定性）<span></span></h4><pre data-tool="mdnice编辑器"><code><span># 随机选取2000个细胞，你可以根据实际情况调整</span><br><span># 降低计算时间和压力</span><br>set.seed(<span>111</span>)<br>scell &lt;- sample(colnames(filter_counts), size = <span>2000</span>)<br><br><span># 最后的到抽样后的矩阵</span><br>filter_counts = filter_counts[, scell]<br>dim(filter_counts)<br><br><span># 重新将表达矩阵转换为SingleCellExperiment对象</span><br>filter_sim &lt;- SingleCellExperiment(assays = List(counts = filter_counts))<br><br><span># colData</span><br>filter_coldata = colData(sim)[scell, <span>1</span>:<span>3</span>]<br>filter_sim@colData = filter_coldata<br><br><span># reduction</span><br>rd = reducedDim(sim)<br>filter_rd &lt;- rd[scell,]<br>reducedDims(filter_sim) &lt;- SimpleList(UMAP = filter_rd)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>（3）由于重新构建sim，之前的轨迹信息我们需要重新做一遍<span></span></h4><blockquote data-tool="mdnice编辑器"><p>这里我们需要换一个细胞分类信息，还记得在前面《细胞分类》这部分讲过，当纳入slingshot的分类信息越多越复杂，就更有可能导致不理想的结果出现，如多个轨迹重叠。</p><p>我们这里已经把 <code>lineage3</code> 选出来，但其成分仍然非常复杂，如果单纯以目前注释的 <code>celltype</code> 进行分析，则会出现很多杂乱无章的信息。我们需要换一种方式更完美的还原 <code>lineage3 </code> ，在这类我推荐前面提到过的 <code>K-Means</code> 方式。</p></blockquote><pre data-tool="mdnice编辑器"><code><span># K-Means</span><br>set.seed(<span>111</span>)<br>cl &lt;- kmeans(filter_rd, centers = <span>4</span>)$cluster <span># 可以指定分群数量</span><br>head(cl)<br>colData(filter_sim)$kmeans &lt;- cl<br><br><span>## 可视化聚类分群的结果</span><br><span>library</span>(RColorBrewer)<br>mycolors = brewer.pal(<span>4</span>,<span>"Set1"</span>) <span># colors</span><br><br>plt_k = data.frame(filter_rd,<br>                   kmeans_clusters = factor(cl, levels = sort(unique(cl))))<br>ggplot(plt_k, aes(UMAP_1, UMAP_2))+<br>  geom_point(aes(color = kmeans_clusters), size = <span>.5</span>)+<br>  scale_color_manual(values = mycolors)+<br>  theme_bw()+<br>  theme(panel.grid = element_blank(),<br>        axis.text = element_blank(),<br>        axis.ticks = element_blank())+<br>  xlab(<span>'UMAP_1'</span>)+<br>  ylab(<span>'UMAP_2'</span>)+<br>  guides(color = guide_legend(override.aes = list(size = <span>5</span>)) <span># 调整图例展示的点大小</span><br>  )  <br></code></pre><p data-tool="mdnice编辑器"><code>K-Means</code> 可以理解为按“区域划分”，可以指定 <code>K-Means</code> 分割的区域数量，从而我们可以有效地控制整个轨迹地走向。否则细胞亚群可能东一块、西一块，对轨迹分析影响很大。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6690647482014388" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2J7I96HBJTG3xZCYYZW1agmh01YfRQViakTaTFBblul3TkVl7noB6pYMg/640?wx_fmt=png" data-type="png" data-w="417" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2J7I96HBJTG3xZCYYZW1agmh01YfRQViakTaTFBblul3TkVl7noB6pYMg/640?wx_fmt=png"><figcaption>lineage3_kmeans</figcaption></figure><pre data-tool="mdnice编辑器"><code><span># 使用 K-Means 划分的亚群进行轨迹推断</span><br>filter_sim &lt;- slingshot(filter_sim,<br>                        clusterLabels = <span>'kmeans'</span>,<br>                        reducedDim = <span>'UMAP'</span>,<br>                        start.clus= <span>"4"</span>, <span># 指定起点</span><br>                        end.clus = <span>'3'</span> <span># 指定终点</span><br>                        )<br>head(colnames(colData(filter_sim)))<br><br>plot(reducedDims(filter_sim)$UMAP, pch=<span>16</span>, asp = <span>1</span>)<br>lines(SlingshotDataSet(filter_sim), lwd=<span>2</span>, col=mycolors)<br></code></pre><p data-tool="mdnice编辑器">基本复现了 <code>lineage3</code> 的轨迹，如果你喜欢探索，可以尝试直接用 <code>HSC</code> 作为起点，<code>Erythroblast</code> 为终点。就会明白为什么小编会推荐你用 <code>K-Means</code>（T_T）。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.8362282878411911" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JGQOCV1EbibXzpzJich9J5ctbc88TLmg1NmwVYPuAkBng2zzrHlgoWb1Q/640?wx_fmt=png" data-type="png" data-w="403" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JGQOCV1EbibXzpzJich9J5ctbc88TLmg1NmwVYPuAkBng2zzrHlgoWb1Q/640?wx_fmt=png"><figcaption>lineage3_slingshot</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>（4）使用tradeSeq软件包中的负二项式广义加性模型（NB-GAM）进行拟合<span></span></h4><pre data-tool="mdnice编辑器"><code><span># BiocManager::install("tradeSeq")</span><br><span># 如果你的安装有问题，可以尝试手动安装，我也在示例数据压缩包中放了最新的tradeSeq安装包</span><br><span>library</span>(tradeSeq)<br><br><span># Fit negative binomial model</span><br>counts &lt;- filter_sim@assays@data$counts<br>crv &lt;- SlingshotDataSet(filter_sim)<br><br><br><span># 在使用NB-GAM模型之前，需要确定用于构建模型的基函数的数量。</span><br><span># 这些基函数被称为节点（knots），它们在模型的拟合过程中起到关键作用。</span><br><span># 使用evaluateK函数。该函数会运行一段时间</span><br><br><span># 2k cells ~16min(如果你的轨迹较多的话，时间更长)</span><br><span># 运行之后会自动出现图</span><br>set.seed(<span>111</span>)<br>icMat &lt;- evaluateK(counts = counts, <br>                   sds = crv, <br>                   k = <span>3</span>:<span>10</span>,    <span># no more than 12</span><br>                   nGenes = <span>200</span>, <span># 每个细胞纳入分析的基因数量，默认是500，这里为了节省示例计算时间</span><br>                   verbose = <span>T</span>)<br><span>#  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=02m 11s</span><br><span>#  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=01m 45s</span><br><span>#  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=02m 24s</span><br><span>#  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=02m 01s</span><br><span>#  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=02m 06s</span><br><span>#  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=01m 34s</span><br><span>#  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=02m 52s</span><br><span>#  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=01m 21s</span><br></code></pre><blockquote data-tool="mdnice编辑器"><p>我们需要根据下图来确定 nknots，详细解释见下面链接：</p><pre><code>https://statomics.github.io/tradeSeq/articles/fitGAM.html<br></code></pre><p>如果你只想快速确定，那么我们只需要看中间的两个图，我们找到快速下降曲线的<strong>转折点</strong>；如果这个点小于6，则选择对应的数字；如果这个点大于等于6，则选择6。</p><p>下图中，我们可以看到曲线变平滑的转折点是6之后，则我们选择 nknots = 6。</p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="0.2733050847457627" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2J7dwuWnYIp4XPLgjnMT1B4Tnos13Z2RBcelgm2e2BJgaKbAw53tAuvg/640?wx_fmt=png" data-type="png" data-w="944" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2J7dwuWnYIp4XPLgjnMT1B4Tnos13Z2RBcelgm2e2BJgaKbAw53tAuvg/640?wx_fmt=png"><figcaption>evaluateK</figcaption></figure><pre data-tool="mdnice编辑器"><code><span># we pick nknots = 6.</span><br>set.seed(<span>111</span>)<br>pseudotime &lt;- slingPseudotime(crv, na = <span>FALSE</span>)<br>cellWeights &lt;- slingCurveWeights(crv)<br><span># fit negative binomial GAM</span><br><span># 2k cells ~13 min</span><br><span># system.time()这个函数可以计算运行时间</span><br>system.time({ <br>  sce &lt;- fitGAM(counts = counts, <br>                pseudotime = pseudotime, <br>                cellWeights = cellWeights,<br>                nknots = <span>6</span>, <br>                verbose = <span>FALSE</span>)<br>})<br>table(rowData(sce)$tradeSeq$converged)<br><span># FALSE  TRUE </span><br><span>#   171   829</span><br></code></pre><blockquote data-tool="mdnice编辑器"><p>该模型可能难以适用于某些基因，因此拟合过程可能不会收敛到一个数据集中的所有基因，特别是在具有复杂模式和/或许多谱系的数据集中。您可以检查每个基因的收敛性，如下所示，其中 <code>TRUE</code> 值对应于收敛模型拟合，而 <code>FALSE</code> 值对应于未能完全收敛的模型。</p><p><code>FALSE</code> 值指的是模型未能完全收敛，即这些基因的拟合过程可能存在困难，并不意味着这些基因与轨迹变化无关。模型未能完全收敛可能是因为<strong>基因的特征非常复杂或数据集中包含许多细胞亚群</strong>，导致模型难以准确地拟合。</p></blockquote><h4 data-tool="mdnice编辑器"><span></span>（5）探索基因表达与拟时序的相关性<span></span></h4><pre data-tool="mdnice编辑器"><code><span># test for dynamic expression</span><br>assoRes &lt;- associationTest(sce)<br>head(assoRes)<br><span>#            waldStat df       pvalue   meanLogFC</span><br><span># HES4       4.495296  5 4.805131e-01   4.1062521</span><br><span># ISG15     46.567234  5 6.960814e-09   0.8088061</span><br><span># MXRA8            NA NA           NA   0.1996149</span><br><span># SMIM1   1292.662958  5 0.000000e+00   1.7751929</span><br><span># RBP7       1.741292  5 8.836572e-01 244.3457299</span><br><span># PLA2G2A          NA NA           NA   0.1996149</span><br></code></pre><p data-tool="mdnice编辑器"><code>associationTest</code>函数应用于<code>sce</code>对象，用于对每个基因进行检验以确定其在拟时中是否存在显著的关联性。结果保存在<code>assoRes</code>变量中，并通过打印前几行来查看。输出结果包含了以下列：</p><ul data-tool="mdnice编辑器"><li><section><p><code>waldStat</code>：Wald统计量，用于衡量基因表达与拟时的关联程度。</p></section></li><li><section><p><code>df</code>：自由度，用于衡量统计推断的准确性。</p></section></li><li><section><p><code>pvalue</code>：显著性水平（p值），用于评估基因表达与拟时之间的关联是否具有统计学意义。</p></section></li><li><section><p><code>meanLogFC</code>：均值对数倍数差异（Fold Change），表示基因在不同拟时阶段的平均表达差异。</p></section></li></ul><blockquote data-tool="mdnice编辑器"><p>请注意，输出结果中一些基因的值为NA是因为它们未能通过检验或计算相关的统计指标。只有具有非NA值的基因才能提供关于基因表达与拟时之间关联性的信息。</p></blockquote><p data-tool="mdnice编辑器">可以关注以下两个方面：</p><ol data-tool="mdnice编辑器"><li><section><code>pvalue</code>列：检查每个基因的p值，如果p值小于设定的显著性水平（通常为0.05），则可以得出结论认为基因表达与拟时之间存在显著的关联性。</section></li><li><section><code>meanLogFC</code>列：观察基因的均值对数倍数差异，正值表示基因在拟时上升的过程中表达增加，负值表示基因在拟时上升的过程中表达下降。</section></li></ol><h4 data-tool="mdnice编辑器"><span></span>（6）寻找与起止点相关性最高的基因<span></span></h4><pre data-tool="mdnice编辑器"><code><span># Discovering progenitor marker genes</span><br>startRes &lt;- startVsEndTest(sce)<br>head(startRes)<br><span>#             waldStat df       pvalue logFClineage1</span><br><span># HES4    1.011937e+00  1 3.144393e-01   -10.1403413</span><br><span># ISG15   2.027631e+01  1 6.702522e-06     1.6526103</span><br><span># MXRA8   7.526157e-15  1 9.999999e-01    -0.3659606</span><br><span># SMIM1   1.267845e+02  1 0.000000e+00     3.3647451</span><br><span># RBP7    3.080566e-01  1 5.788752e-01   332.3079668</span><br><span># PLA2G2A 7.526157e-15  1 9.999999e-01    -0.3659606</span><br></code></pre><blockquote data-tool="mdnice编辑器"><p><code>startVsEndTest</code> 使用Wald检验来评估零假设，即平滑器起始点（祖细胞群）的平均表达是否等于平滑器终点（分化细胞群）的平均表达。该检验基本上涉及每个亚群的两个平滑器系数的比较。默认情况下，<code>startVsEndTest </code> 函数在所有亚群中执行全局检验（即同时比较起始点和终点），但你也可以通过设置<code>lineages=TRUE</code>来单独评估每个 <code>lineage</code>。</p><p>在这个例子中，我们已经把 <code>lineage3</code> 单独挑选出来运算，并根据 <code>K-Means</code> 复现了轨迹，因此实际上我们只有一个 <code>lineage</code> 。所以（5）和（6）的运行结果是相似的。如果你有多个 <code>lineage</code> ，应该在这一步加上 <code>lineages=TRUE</code>。但不建议同时有多个轨迹。</p></blockquote><pre data-tool="mdnice编辑器"><code><span># 按相关性进行排序</span><br>oStart &lt;- order(startRes$waldStat, decreasing = <span>TRUE</span>)<br><br><span># 挑选相关性最强的基因，并可视化</span><br>sigGeneStart &lt;- names(sce)[oStart[<span>1</span>]]<br>plotSmoothers(sce, counts, gene = sigGeneStart)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7869955156950673" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2Jv0vgAjZH5mEGqGPay1vW7aheIpSg9Q5BqCZIWR2hrsFBD2rKK3jtlQ/640?wx_fmt=png" data-type="png" data-w="446" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2Jv0vgAjZH5mEGqGPay1vW7aheIpSg9Q5BqCZIWR2hrsFBD2rKK3jtlQ/640?wx_fmt=png"><figcaption>top gene</figcaption></figure><p data-tool="mdnice编辑器"><strong>我们也可以用UMAP图展示</strong></p><pre data-tool="mdnice编辑器"><code>plotGeneCount(crv, counts, gene = sigGeneStart)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5518867924528302" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JhvgzXT6Dicoib91gGdKFJYYohdnYuEHXmh7foTe5dlVRCTYFnQbexlbQ/640?wx_fmt=png" data-type="png" data-w="636" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JhvgzXT6Dicoib91gGdKFJYYohdnYuEHXmh7foTe5dlVRCTYFnQbexlbQ/640?wx_fmt=png"><figcaption>umap top</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>（7）美化基因表达量变化图<span></span></h4><p data-tool="mdnice编辑器">上述两个基因表达量变化图是通过 <code>ggplot2</code> 系统绘制的，我们可以通过添加一些自定义参数来美化他。</p><p data-tool="mdnice编辑器">我们提取需要的数据，并构建成清洁数据框。</p><pre data-tool="mdnice编辑器"><code><span># 取celltpye和配色信息</span><br>coldata &lt;- data.frame(celltype = sim@colData$celltype,<br>                      plotcol = sim@colData$plotcol)<br>rownames(coldata) = colnames(sim)<br><br><span># 把sce中的3000个细胞对应信息取出</span><br>filter_coldata &lt;- coldata[colnames(sce),]<br><br><span># 添加拟时序信息</span><br>filter_coldata$Pseudotime = sce$crv$pseudotime.Lineage1<br><br><span># top6 genes</span><br>top6 &lt;- names(sce)[oStart[<span>1</span>:<span>6</span>]]<br>top6_exp = sce@assays@data$counts[top6,] <br>top6_exp = log2(top6_exp + <span>1</span>) %&gt;% t()<br><br><span># 获得最终的清洁数据</span><br>plt_data = cbind(filter_coldata, top6_exp)<br>colnames(plt_data)<br><span># [1] "celltype"   "plotcol"    "Pseudotime" "CENPF"      "HBB"       </span><br><span># [6] "HMGB2"      "CD74"       "HBA1"       "MKI67"  </span><br></code></pre><p data-tool="mdnice编辑器">画图</p><pre data-tool="mdnice编辑器"><code><span>library</span>(ggplot2)<br><span>library</span>(ggsci)<br><span>library</span>(ggpubr)<br><span>library</span>(RColorBrewer)<br>getPalette = colorRampPalette(brewer.pal(<span>12</span>, <span>"Paired"</span>))<br>mycolors = getPalette(length(unique(plt_data$celltype)))<br><br><span># 为了拼图美观，我们把legend隐藏掉</span><br>plt_list = list()<br><span>for</span> (gene <span>in</span> top6) {<br>  print(gene)<br>  p = ggscatter(data = plt_data,<br>                x = <span>'Pseudotime'</span>,<br>                y = gene,<br>                color = <span>'celltype'</span>,<br>                size = <span>0.6</span>)+<br>    geom_smooth(se = <span>F</span>, color = <span>'orange'</span>)+<br>    theme_bw()+<br>    scale_color_manual(values = mycolors)+<br>    theme(legend.position = <span>'none'</span>)<br>  plt_list[[gene]] = p<br>}<br><br><span>library</span>(patchwork)<br>wrap_plots(plt_list)<br>ggsave(filename = <span>'figures/05_top6_genes.pdf'</span>, width = <span>9</span>, height = <span>5</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5411471321695761" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JHUAL8heSycjMxxp0FN6WYxzhvVI9tf6eZSYNFibibI4LSZJgicGLYWA4Q/640?wx_fmt=png" data-type="png" data-w="802" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JHUAL8heSycjMxxp0FN6WYxzhvVI9tf6eZSYNFibibI4LSZJgicGLYWA4Q/640?wx_fmt=png"><figcaption>top genes patchworks</figcaption></figure><pre data-tool="mdnice编辑器"><code><span># 这里单独save一张有legend的图</span><br>gene = <span>'HBB'</span><br>  p_test = ggscatter(data = plt_data,<br>                     x = <span>'Pseudotime'</span>,<br>                     y = gene,<br>                     color = <span>'celltype'</span>,<br>                     size = <span>0.6</span>)+<br>    geom_smooth(se = <span>F</span>, color = <span>'orange'</span>)+<br>    theme_bw()+<br>    scale_color_manual(values = mycolors)+<br>    theme(legend.position = <span>'right'</span>)+<br>    guides(color = guide_legend(ncol = <span>1</span>,  <span># 将图例分为两列显示</span><br>                                override.aes = list(size = <span>3</span>)) )  <span># 调整图例展示的点大小</span><br>  p_test<br>  ggsave(plot = p_test, filename = <span>'figures/05_HBB_legend.pdf'</span>, width = <span>5</span>, height = <span>5</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>（8）美化拼图<span></span></h4><p data-tool="mdnice编辑器">最后，我们把上面的元素用 <code>AI</code> 软件做个拼图</p><figure data-tool="mdnice编辑器"><img data-ratio="0.30925925925925923" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JxHibB8Gzf8ibxWHgICMyXJWTwicglA993xbMKoCYNX6y12kST6arj99mg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Z81Ku3ia5ojuqptuF7dpR2JxHibB8Gzf8ibxWHgICMyXJWTwicglA993xbMKoCYNX6y12kST6arj99mg/640?wx_fmt=png"><figcaption>final_merged_image</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>点评</span><span></span></h3><p data-tool="mdnice编辑器">那么今天分享就到这里了。整体而言，相比于 <code>Monocle</code> 工具，笔者认为 <code>slingshot</code> 是一个更加轻量的工具，他的计算速度较快，步骤较少，数据提取容易，既可以用官方的可视化方式，也可以基于 <code>ggplot</code> 系统进行优化，是一个不错的工具。除了上述展示方式以外，你还可以将这些基因进行富集分析，并用<code>UCell</code> 等打分工具对细胞进行平分，可视化到 <code>UMAP</code> 图上。官方的教程中还有许多其他展示方式，有兴趣自己翻阅吧！</p><p data-tool="mdnice编辑器">这篇 <code>slingshot</code> 推文也是群友问了多遍，终于姗姗来迟。其中经过了多个版本的更改，为了读者能复现和理解，我又更改了几个测试数据，最终选定了这个。</p><p data-tool="mdnice编辑器">如果我的工作为你带来了<strong><span>参考价值</span></strong>，或者你希望得到<strong><span>示例数据和全部源代码</span></strong>，可以在公众号后台回复【<strong><span>20230926</span></strong>】，请小编喝一杯咖啡，助力小编持续写作。</p><p data-tool="mdnice编辑器">我们下次再见~</p><p><img data-galleryid="" data-ratio="0.3435185185185185" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2YxjOo46Cn290Zj1jNh07VjwDSLCyMeGpOthx1dWqF6cTgaktcOFrckG9ge2YViac1PJkcnGDO78Qg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2YxjOo46Cn290Zj1jNh07VjwDSLCyMeGpOthx1dWqF6cTgaktcOFrckG9ge2YViac1PJkcnGDO78Qg/640?wx_fmt=png"></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/jqTrlM8C4DWURkiDpNhrIg",target="_blank" rel="noopener noreferrer">原文链接</a>
