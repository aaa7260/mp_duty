---
title: "Rshiny之个性化房贷计算器"
date: 2023-09-16T06:42:10Z
draft: ["false"]
tags: [
  "fetched",
  "芬菲随笔"
]
categories: ["Acdemic"]
---
Rshiny之个性化房贷计算器 by 芬菲随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><br></p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">事情起因是去年国庆节前想提前还贷，于是反复计算提前还多少期，剩余本金金额，尤其关心每月本金占月供的比例。毕竟每月还款额中都是利息还是有些心疼。然而，目前没看到满足要求的在线房贷计算网址，所以<span> 想自己写。</span></p><p data-tool="mdnice编辑器">本人很喜欢R语言可视化，正好基于R的基础学习Shiny容易很多。说干就干，去年国庆节后写完了脚本，学了Shiny语法，动力不足，搁置了。眼看着今年的国庆节快到了，计划总不能跨年吧。虽说今年的愿望是实现去年许下的前年未实现的愿望，但是今年的我有鸡汤文呀。</p><p data-tool="mdnice编辑器">分享两句：<br>1、只做重要的事情，以减少工作时间（80/20法则）。<br>2、减少时间来做重要的事情（帕金森法则）。</p><p data-tool="mdnice编辑器">每天问自己三次以下问题<br>1、我现在是有成效还是很忙碌而已？<br>2、我不停地找事做是不是为了逃避做重要的事情？<br>3、如果这就是我今天所完成的全部事情，我会对自己的一天感到满意吗？</p><p data-tool="mdnice编辑器">鸡汤喝饱的同时，信心不是一般的大，于是三天左右我的个性化房贷计算器上线，请尽情享用。<br>link：https://zff-excellent.shinyapps.io/mortgagecalculator/</p><p data-tool="mdnice编辑器">继续延续三步走：</p><ul data-tool="mdnice编辑器"><li><section>1、理解它。学习还房贷的计算公式；</section></li><li><section>2、实现它。写房贷计算脚本、函数封装并优化；</section></li><li><section>3、可视化它。再次学习Shiny语法、设置Shiny的界面、主题和部署。</section></li></ul><h2 data-tool="mdnice编辑器"><span><span>1</span></span><span>理解还款公式</span></h2><p data-tool="mdnice编辑器">理解还款公式见参考链接的前四个，最终得到公式如下：<br>已知月供 = 月本金 + 月利息，月利息都为剩余本金 × 月利率，等额本息中月供不变，等额本金中本金不变，因而，分别求本金和月供是很容易的事。</p><ul data-tool="mdnice编辑器"><li><section>1、等额本息</section><section>等额本息的具体利息计算公式为：<br><strong>每月还款本息</strong> = [贷款本金×月利率×（1+月利率）^还款月数]÷[（1+月利率）^还款月数－1]，其中“^”表示次方，月利率=年利率÷12。<br>总支付本息 = <strong>每月还款本息</strong>×贷款期限。<br>总支付利息 = 每月还款本息×贷款期限-贷款本金。</section></li><li><section>2、等额本金</section><section>等额本金的具体利息计算公式为：<br><strong>每月还款本金</strong> = 贷款本金÷贷款期限。<br>总支付利息 = (还款月数+1)×贷款本金×月利率/2。<br>总支付本息 = <strong>贷款本金</strong> + 总支付利息</section></li></ul><h2 data-tool="mdnice编辑器"><span><span>2</span></span><span>实现它</span></h2><pre data-tool="mdnice编辑器"><span></span><code><span># -----------------------------------------------------------------------</span><br><br>MortageCalculator &lt;- <span>function</span>(corpus, LoanPeriod, APR, Payway = <span>'EC'</span>){<br>  <br>  MPR = APR /100/ 12<br>  recorpus &lt;- corpus<br>  <span># ------------ 总情况</span><br>  <span>if</span>(Payway == <span>'EC'</span>) {<br>    monPay = corpus*MPR*(1+MPR)^LoanPeriod/((1+MPR)^LoanPeriod -1) <span># 月供不变</span><br>    total_load = monPay*LoanPeriod<br>    total_interest = monPay*LoanPeriod - corpus<br>    <br>    <span># matrix repalce dataframe</span><br>    res &lt;- matrix(nrow = LoanPeriod, ncol = 6) <span># 使用 matrix 代替 data.frame</span><br>    colnames(res) &lt;- c(<span>'期数(月)'</span>, <span>'每月月供(元)'</span>, <span>'月供本金(元)'</span>,<br>                       <span>'月供利息(元)'</span>, <span>'月供本金占比(%)'</span>, <span>'剩余本金(万元)'</span>)<br>    <br>    <span># 每月偿还利息 = 剩余本金 × 月利率</span><br>    <span># 每月偿还本金 = 每月还款额 - 每月还款利息</span><br>    <span># monInterest = recorpus*MPR # 利息，月供已知</span><br>    <span>for</span>(LP <span>in</span> (1:LoanPeriod)){<br>      monInterest = recorpus*MPR <span># 利息，月供已知</span><br>      monCorpus = monPay - monInterest <span># 本金</span><br>      corpusRatio = 100*monCorpus/monPay<br>      <br>      <span># 更新剩余本金</span><br>      recorpus &lt;- recorpus - monCorpus<br>      <br>      res[LP, ] &lt;- c(LP, monPay * 10000, monCorpus * 10000,<br>                     monInterest * 10000, corpusRatio, recorpus)<br>      <br><br>    }<br>    <span># 格式化输出</span><br>    res_formatted &lt;- apply(res, c(1, 2), <span>function</span>(x) {<br>      formatC(x, digits = 2, format = <span>"f"</span>)})<br>    res_formatted[, 1] &lt;- as.integer(res_formatted[, 1])<br>    <span>return</span>(res_formatted)<br><br>  }<span>else</span>{<br>    <span># ------------ 总情况</span><br>    monCorpus = corpus/LoanPeriod <span># 本金不变</span><br>    <span># monPay = corpus/LoanPeriod + corpus*MPR</span><br>    total_load = corpus + corpus *(LoanPeriod+1)*MPR/2<br>    total_interest = corpus *(LoanPeriod+1)*MPR/2<br>    <br>    <span># ------------ Details of repayment data</span><br>    res &lt;- matrix(nrow = LoanPeriod, ncol = 6)<br>    colnames(res) &lt;- c(<span>'期数(月)'</span>, <span>'每月月供(元)'</span>, <span>'月供本金(元)'</span>,<br>                       <span>'月供利息(元)'</span>, <span>'月供本金占比(%)'</span>, <span>'剩余本金(万元)'</span>)<br>    <span># 每月偿还利息 = 剩余本金 × 月利率</span><br>    <span># 每月偿还本金 = 贷款总额/还款月数</span><br>    <span># 每月月供 = 每月偿还本金 + 每月偿还利息</span><br>    <span>for</span>(LP <span>in</span> (1:LoanPeriod)){<br>      monInterest = recorpus*MPR <span># 利息，本金已知</span><br>      monPay = monCorpus + monInterest <span># 月供</span><br>      corpusRatio = 100*monCorpus/monPay<br>      <br>      <span># 更新剩余本金</span><br>      recorpus &lt;- recorpus - monCorpus<br>      <br>      res[LP, ] &lt;- c(LP, monPay * 10000, monCorpus * 10000,<br>                     monInterest * 10000, corpusRatio, recorpus)<br>    }<br>    <br>    <span># 格式化输出</span><br>    res_formatted &lt;- apply(res, c(1, 2), <span>function</span>(x) {<br>      formatC(x, digits = 2, format = <span>"f"</span>)})<br>    res_formatted[, 1] &lt;- as.integer(res_formatted[, 1])<br>    <span>return</span>(res_formatted)<br>  }<br>      <br>}<br><span># -----------------------------------------------------------------------</span><br><br>res &lt;- MortageCalculator(80, 360, 5.73, <span>'EC'</span>)<br>head(res)<br><br></code></pre><h2 data-tool="mdnice编辑器"><span><span>3</span></span><span>可视化它</span></h2><ul data-tool="mdnice编辑器"><li><section>1、新建一个Shiny目录</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>1、新建Shiny目录<br>File -&gt; New File -&gt; Shiny Web App，命名为MortgageCalculator<br><br>2、运行app程序<br>library(shiny)<br><span># 方式1：在app.R脚本中运行</span><br>shinyApp(ui = ui, server = server)<br><br><span># 方式2：在新建Shiny目录中运行</span><br>runApp(<span>"MortgageCalculator"</span>)<br><br><span># 如果展示脚本可以加上display.mode</span><br>runApp(<span>"MortgageCalculator"</span>, display.mode = <span>"showcase"</span>)<br></code></pre><section>2、学习Shiny语法<br></section><section>Shiny脚本三部分：ui.R、server.R、app.R。依次功能为输出、输入、运行。<br>Shiny可视化为三部分：titlePanel()、sidebarLayout()包含sidebarPanel()和mainPanel()。依次功能为标题、侧栏和内容栏。</section><section><img data-galleryid="" data-ratio="0.5784543325526932" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/9YXSPb9ydSanyc7abaKB2ZiaGq0TAAtg9FIuic7RrhGd3XBu3yeqXUG63zC9k2Q3T4mWrhlVnbTRddu9BicbXKziaQ/640?wx_fmt=png" data-type="png" data-w="427" src="https://mmbiz.qpic.cn/sz_mmbiz_png/9YXSPb9ydSanyc7abaKB2ZiaGq0TAAtg9FIuic7RrhGd3XBu3yeqXUG63zC9k2Q3T4mWrhlVnbTRddu9BicbXKziaQ/640?wx_fmt=png"></section><p><span>Shiny布局</span></p><section><p><img data-backh="551" data-backw="552" data-galleryid="" data-ratio="0.9981884057971014" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/9YXSPb9ydSanyc7abaKB2ZiaGq0TAAtg9ocIYsuBgjQgCuGTvws4DZqKuUiabunBiaJwaaH09EwDMgpOD6b8EJLvA/640?wx_fmt=png" data-type="png" data-w="552" src="https://mmbiz.qpic.cn/sz_mmbiz_png/9YXSPb9ydSanyc7abaKB2ZiaGq0TAAtg9ocIYsuBgjQgCuGTvws4DZqKuUiabunBiaJwaaH09EwDMgpOD6b8EJLvA/640?wx_fmt=png"></p><p><br></p><p>侧栏小工具</p><p><img data-galleryid="" data-ratio="0.654424040066778" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/9YXSPb9ydSanyc7abaKB2ZiaGq0TAAtg9N2pD0wIjBjRn9ZTkv8tofnSvR8DFN0d2XqiaNC3UjR7GmShDBcTcFow/640?wx_fmt=png" data-type="png" data-w="599" src="https://mmbiz.qpic.cn/sz_mmbiz_png/9YXSPb9ydSanyc7abaKB2ZiaGq0TAAtg9N2pD0wIjBjRn9ZTkv8tofnSvR8DFN0d2XqiaNC3UjR7GmShDBcTcFow/640?wx_fmt=png"></p><p>定义输出变量函数</p><p><br></p><p><img data-galleryid="" data-ratio="0.5735785953177257" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/9YXSPb9ydSanyc7abaKB2ZiaGq0TAAtg9E3GI9ZrdHJKTh1vQjrRic2nERlfpOErSywqoVxYU2rTsbjsOqQuq7vQ/640?wx_fmt=png" data-type="png" data-w="598" src="https://mmbiz.qpic.cn/sz_mmbiz_png/9YXSPb9ydSanyc7abaKB2ZiaGq0TAAtg9E3GI9ZrdHJKTh1vQjrRic2nERlfpOErSywqoVxYU2rTsbjsOqQuq7vQ/640?wx_fmt=png"></p><p><span>给输出变量赋值函数</span></p>学习Shiny的资料见参考链接5-12，学习完语法后，根据我的需求要求展示每月还贷表格和可视化月供中本金和利息的变化，并且顺利用按钮下载表格和图片。因此，我的第一个Shiny可视化脚本如下：</section><pre data-tool="mdnice编辑器"><span></span><code><span># Load packages ----</span><br>library(shiny)<br>library(shinythemes)<br>library(shinydashboard)<br>library(dashboardthemes)<br>library(tidyverse)<br>library(ggplot2)<br>library(ggsci)<br>library(wesanderson)<br>library(ggthemes)<br>library(cowplot)<br>library(Cairo)<br><br><span># Source helpers ----</span><br><span>source</span>(<span>'helpers.R'</span>, encoding = <span>'utf-8'</span>)<br><br><span># Define UI for application that draws a histogram</span><br><br><span># ----------------------------------------------------------------------</span><br><span># Third version: theme + panel</span><br><br>ui &lt;- dashboardPage(<br>  <br>  dashboardHeader(title = <span>"个性化房贷计算器"</span>, titleWidth = 300),<br>  dashboardSidebar(<br>    width = 300,<br>    img(src = <span>"OIP-C.jpg"</span>, height = 200, width = 280),<br>    <span># helpText("依据借款金额、借款期数、借款利率、还款方式，计算的每期还款情况，可用于借贷前估算月供和提前还款估算！"),</span><br>    numericInput(<span>"corpus"</span>, <span>"借款本金"</span>, value = 50),<br>    numericInput(<span>"LoanPeriod"</span>, <span>"借款期数"</span>,value = 360),<br>    numericInput(<span>"APR"</span>, <span>"借款利率"</span>,value = 4.3),<br>    selectInput(<span>"Payway"</span>, <span>"还款方式"</span>,<br>        choices = list(<span>'等额本息'</span> = <span>'1'</span>, <span>'等额本金'</span>= <span>'2'</span>), selected = <span>'1'</span>),<br>    <span># radioButtons("type", h3("选择图片格式"), choices = list("png", "pdf")),</span><br>    <br>    <span># Button CSS</span><br>    tags<span>$style</span>(<span>'#tableDown {background-color: red; color: white}'</span>),<br>    tags<span>$style</span>(<span>'#plotDown {background-color: red; color: white}'</span>)<br>  ),<br>  dashboardBody(<br>    <span># changing theme</span><br>    <span># blue_gradient/flat_red/grey_light/grey_dark/onenote/poor_mans_flatly/purple_gradient</span><br>    shinyDashboardThemes(theme = <span>"onenote"</span>),<br>    <br>    tabsetPanel(<br>      tabPanel(<span>"Plot"</span>, plotOutput(<span>"Plot"</span>), <br>               downloadButton(<span>'plotDown'</span>, label=<span>"Download Plot"</span>)),<br>      tabPanel(<span>"Table"</span>, DT::dataTableOutput(<span>"table"</span>), <br>               downloadButton(<span>'tableDown'</span>, label = <span>'Download Table'</span>))<br>    )<br><br>  ), <br>  skin = <span>"blue"</span><br>)<br><br><br><span># Define server logic required to draw a histogram</span><br>server &lt;- <span>function</span>(input, output) {<br>  <br>  <span># Reactive expression to generate the requested distribution ----</span><br>  <span># Get data</span><br>  dataInput &lt;- reactive({<br>    Payway &lt;- switch(input<span>$Payway</span>,<br>                     <span>'1'</span> = <span>'EC'</span>,<br>                     <span>'2'</span> = <span>'ECI'</span>)<br>    MortageCalculator(input<span>$corpus</span>, input<span>$LoanPeriod</span>, input<span>$APR</span>, Payway)<br>  })<br>  <br>  <span># Show data</span><br>  output<span>$table</span> &lt;- DT::renderDataTable({<br>    DT::datatable(dataInput())<br>  })<br>  <br>  <span># Download data</span><br>  output<span>$tableDown</span> &lt;- downloadHandler(<br>    filename = <span><span>function</span></span>() {<br>      Payway &lt;- switch(input<span>$Payway</span>,<br>                       <span>'1'</span> = <span>'等额本息'</span>,<br>                       <span>'2'</span> = <span>'等额本金'</span>)<br>      paste(Payway, <span>'借款'</span>, input<span>$corpus</span>, <span>'借贷期'</span>, input<span>$LoanPeriod</span>, <span>'年利率'</span>, input<span>$APR</span>,  <span>".csv"</span>, sep = <span>"-"</span>)<br>    },<br>    content = <span>function</span>(file) {<br>      write.csv(dataInput(), file, row.names = FALSE)<br>    }<br>  )<br>  <br>  <span># Show plot</span><br>  output<span>$Plot</span> &lt;- renderPlot({<br>    Payway &lt;- switch(input<span>$Payway</span>,<br>                     <span>'1'</span> = <span>'等额本息'</span>,<br>                     <span>'2'</span> = <span>'等额本金'</span>)<br>    p &lt;- dataInput() %&gt;% as.data.frame() %&gt;% mutate_all(as.numeric) %&gt;%<br>      dplyr::select(1:4) %&gt;%<br>      gather(key, value, -1) %&gt;%<br>      ggplot(aes(x = `期数(月)`, y = value, group = key, color = key)) +<br>      labs(title = paste(<span>'还款方式'</span>, Payway), y = <span>'人民币（元）'</span>, color = <span>''</span>) +<br>      geom_line(size = 1) +<br>      theme_stata() +<br>      scale_color_jco()<br>    p<br>  })<br>  <br>  <span># Download plot</span><br>  output<span>$plotDown</span> &lt;- downloadHandler(<br>    filename = <span><span>function</span></span>() {<br>      Payway &lt;- switch(input<span>$Payway</span>,<br>                       <span>'1'</span> = <span>'等额本息'</span>,<br>                       <span>'2'</span> = <span>'等额本金'</span>)<br>      paste(Payway, <span>'借款'</span>, input<span>$corpus</span>, <span>'借贷期'</span>, input<span>$LoanPeriod</span>, <span>'年利率'</span>, input<span>$APR</span>, <span>'.png'</span>, sep = <span>"-"</span>)<br>    },<br>    content = <span>function</span>(file) {<br>      <span># ggsave(file, plot = output$Plot, width = 6, height = 4, units = "in", dpi = 300)</span><br>      ggsave(file, plot = last_plot(), width = 6, height = 4, units = <span>"in"</span>, dpi = 600)<br>    }<br>  )<br>  <br>}<br><br><span># Run the application </span><br>shinyApp(ui = ui, server = server)<br><br><span># ----------------------------------------------------------------------</span><br></code></pre><section>3、部署shinyapp</section><pre data-tool="mdnice编辑器"><span></span><code>1、进入网址注册或登录<br>Share your Shiny Applictions Oline：https://www.shinyapps.io/<br>shinyapps.io用github授权登录<br>2、按照rsconnect<br>install.packages(<span>'rsconnect'</span>)<br>library(rsconnect)<br>3、账号授权<br>rsconnect::setAccountInfo(name=<span>'zff-excellent'</span>, token=<span>'xxxx'</span>, secret=<span>'注册后能看到'</span>)<br>4、部署<br>rsconnect::deployApp(<span>"E:/Year_2023/MachineLanguage_Project/OfficialAccountTweets/06-Web/MortgageCalculator"</span>)<br></code></pre><h2 data-tool="mdnice编辑器"></h2><h2 data-tool="mdnice编辑器"></h2><h2 data-tool="mdnice编辑器"></h2><h2 data-tool="mdnice编辑器"></h2><h2 data-tool="mdnice编辑器"></h2><p data-tool="mdnice编辑器"><span>获取注册账号信息</span><img data-backh="199" data-backw="532" data-galleryid="" data-ratio="0.3731481481481482" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/9YXSPb9ydSanyc7abaKB2ZiaGq0TAAtg9YCNial621TVI3MhakAmtdgic2PUcDmQZQaHpxoa9f5PgfaibYlPtLyYEg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/9YXSPb9ydSanyc7abaKB2ZiaGq0TAAtg9YCNial621TVI3MhakAmtdgic2PUcDmQZQaHpxoa9f5PgfaibYlPtLyYEg/640?wx_fmt=png"></p><section><iframe data-vidtype="2" data-mpvid="wxv_3104094892676448265" data-cover="http%3A%2F%2Fmmbiz.qpic.cn%2Fsz_mmbiz_jpg%2F9YXSPb9ydSanyc7abaKB2ZiaGq0TAAtg9CyZjGeb2EkqwMTk8wg5t5wrvo3fkzkEV2hcyfz3gexo6CS6lrtuvAA%2F0%3Fwx_fmt%3Djpeg" allowfullscreen="" frameborder="0" data-ratio="2.061688311688312" data-w="1270" data-src="https://mp.weixin.qq.com/mp/readtemplate?t=pages/video_player_tmpl&amp;action=mpvideo&amp;auto=0&amp;vid=wxv_3104094892676448265"></iframe><span><span>4</span></span><span>Reference</span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"></h2><p data-tool="mdnice编辑器">[1] 等额本息公式详细推导过程 计算方法原理解释：https://zhuanlan.zhihu.com/p/390581715<br>[2] 贷款还款方式以及计算公式：https://zhuanlan.zhihu.com/p/367906503<br>[3] 房贷计算公式（等额本息、等额本金）以及提前还款计算：https://zhuanlan.zhihu.com/p/617706691<br>[4] 等额本息和等额本金利息公式：https://www.csai.cn/loan/1375538.html<br>[5] Master Shiny: https://mastering-shiny.org/action-transfer.html#uploading-data<br>[6] Building Web Apps with R Shiny: https://debruine.github.io/shinyintro/reactives.html<br>[7] Outstanding User Interfaces with Shiny: https://unleash-shiny.rinterface.com/shiny-custom-handler.html<br>[8] https://shiny.posit.co/r/getstarted/shiny-basics/lesson5/<br>[9] https://shiny.posit.co/r/articles/build/overview/<br>[10] https://rviews.rstudio.com/2021/10/20/a-beginner-s-guide-to-shiny-modules/<br>[11] Shiny中的DownloadHander与update*函数https://zhuanlan.zhihu.com/p/114540289#%E6%A6%82%E8%A7%88<br>[12] 「R shiny基础」使用shinyapp分享你的Shiny应用：https://blog.csdn.net/u012110870/article/details/102804497</p></section></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><span></span></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/eaabR7Fao2Y2DTnAOz2CYg",target="_blank" rel="noopener noreferrer">原文链接</a>
