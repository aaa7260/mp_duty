---
title: "Scanpy生态教程12：推断CNV"
date: 2024-03-29T02:15:26Z
draft: ["false"]
tags: [
  "fetched",
  "生信会客厅"
]
categories: ["Acdemic"]
---
Scanpy生态教程12：推断CNV by 生信会客厅
------
<div><section><em>通过单细胞转录组的数据推断基因组的CNV，inferCNV包是最经典的工具。这里给大家介绍的infercnvpy包，是inferCNV包算法的python实现版。它可以完全复现inferCNV的结果，但是丰富了CNV热图的信息，还提供了通过聚类识别恶性细胞的方法。</em></section><p><br></p><p><strong>设置分析环境</strong></p><pre><code><span>import</span> scanpy <span>as</span> sc<br><span>import</span> infercnvpy <span>as</span> cnv<br><span>import</span> matplotlib.pyplot <span>as</span> plt<br><span>import</span> os<br><span>import</span> warnings</code></pre><pre><code>warnings.simplefilter(action=<span>"ignore"</span>)<br>sc.settings.verbosity = <span>3</span><br>sc.settings.set_figure_params(dpi=<span>80</span>, figsize=(<span>5</span>, <span>4.5</span>))</code></pre><pre><code>projpath = <span>'D:\\公众号\\2024scanpy'</span><br>chapter = <span>"10_inferCNV"</span></code></pre><pre><code>os.chdir(projpath)<br><span>if</span> <span>not</span> os.path.exists(chapter):<br>    os.makedirs(chapter)<br>os.chdir(chapter)</code></pre><h3><strong><br></strong></h3><h3><strong>推断CNV</strong></h3><section><span>进行cnv分析之前，需要把基因在染色体的坐标信息添加到var数据中，</span><code><span>infercnvpy.io.genomic_position_from_gtf</span></code><span>可以帮助我们从gtf文件中提取信息并保存到adata对象。</span></section><pre><code>adata = cnv.datasets.maynard2020_3k()</code><code><br>adata</code></pre><section><ul><li><li><li><li><li><li></ul><pre data-lang="javascript"><code><span>AnnData object <span>with</span> n_obs × n_vars = <span>3000</span> × <span>55556</span></span></code><code><span>    obs: <span>'age'</span>, <span>'sex'</span>, <span>'sample'</span>, <span>'patient'</span>, <span>'cell_type'</span></span></code><code><span>    <span>var</span>: <span>'ensg'</span>, <span>'mito'</span>, <span>'n_cells_by_counts'</span>, <span>'mean_counts'</span>, <span>'pct_dropout_by_counts'</span>, <span>'total_counts'</span>, <span>'n_counts'</span>, <span>'chromosome'</span>, <span>'start'</span>, <span>'end'</span>, <span>'gene_id'</span>, <span>'gene_name'</span></span></code><code><span>    uns: <span>'cell_type_colors'</span>, <span>'neighbors'</span>, <span>'umap'</span></span></code><code><span>    obsm: <span>'X_scVI'</span>, <span>'X_umap'</span></span></code><code><span>    obsp: <span>'connectivities'</span>, <span>'distances'</span></span></code></pre></section><pre><code><span># 检查数据类型，此数据集是log1p数据</span><br><span>print</span>(<span>f"<span>{adata.X.min()}</span>\n<span>{adata.X.max()}</span>"</span>) <br>adata.to_df()</code></pre><section><ul><li><li></ul><pre data-lang="css"><code><span>0<span>.0</span></span></code><code><span>13<span>.5234375</span></span></code></pre></section><pre><code>sc.pl.umap(adata, color=<span>"cell_type"</span>)</code></pre><p><span></span></p><p><img data-imgfileid="100001974" data-ratio="0.49074074074074076" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDSib6eGUsGWraHtibHIXibnmVQltc9mTNKUg6kGRUM3LILeKpgniazsvFBAQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDSib6eGUsGWraHtibHIXibnmVQltc9mTNKUg6kGRUM3LILeKpgniazsvFBAQ/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span></p><pre><code><span># We provide all immune cell types as "normal cells".</span><br>cnv.tl.infercnv(<br>    adata, n_jobs=<span>6</span>,<br>    reference_key=<span>"cell_type"</span>,<br>    reference_cat=[<span>"B cell"</span>, <span>"Macrophage"</span>, <span>"Mast cell"</span>, <span>"Monocyte"</span>, <span>"NK cell"</span>, <span>"Plasma cell"</span>,<br>                   <span>"T cell CD4"</span>, <span>"T cell CD8"</span>, <span>"T cell regulatory"</span>, <span>"mDC"</span>, <span>"pDC"</span>],<br>    window_size=<span>250</span>, <br>)</code></pre><section><ul><li></ul><pre data-lang="apache"><code><span><span>100</span>%|██████████| 1/1<span> [00:42&lt;00:00, 42.87s/it]</span></span></code></pre></section><pre><code><span># cnv矩阵保存在obsm['X_cnv']，行为细胞列为基因组分箱窗口（与基因平滑处理时的窗口不同），每个窗口的宽度大约5M</span><br>adata.obsm[<span>'X_cnv'</span>].shape</code></pre><section><ul><li></ul><pre><code><span>(3000, 5314)</span></code></pre></section><pre><code>cnv.pl.chromosome_heatmap(adata, groupby=<span>"cell_type"</span>)</code></pre><p><span></span></p><p><img data-imgfileid="100001975" data-ratio="0.5601851851851852" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDSYmqDrasOViaV48PdXTsNrIdZiczt8BmpaI1jA6iat725ruppjA8LKLwXg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDSYmqDrasOViaV48PdXTsNrIdZiczt8BmpaI1jA6iat725ruppjA8LKLwXg/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span></p><p><br></p><h3><strong>CNV聚类</strong></h3><section><span>完成CNV推断后我们得到了一个CNV矩阵，基于此运行Leiden聚类之后，我们可以根据CNA聚类绘制染色体热图。观察发现，与底部的聚类相比，顶部的聚类基本上没有差异表达的基因组区域。这些差异表达区域可能归因于拷贝数变异，相应的聚类很可能代表了肿瘤细胞。</span></section><pre><code>cnv.tl.pca(adata)<br>cnv.pp.neighbors(adata)<br>cnv.tl.leiden(adata)</code></pre><section><ul><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span>computing PCA</span></code><code><span>    <span>with</span> n_comps=<span>50</span></span></code><code><span>    finished (<span>0</span>:<span>00</span>:<span>01</span>)</span></code><code><span>computing neighbors</span></code><code><span>    finished: added <span>to</span> <span>`.uns['cnv_neighbors']`</span></span></code><code><span>    <span>`.obsp['cnv_neighbors_distances']`</span>, distances <span>for</span> <span>each</span> pair <span>of</span> neighbors</span></code><code><span>    <span>`.obsp['cnv_neighbors_connectivities']`</span>, weighted adjacency matrix (<span>0</span>:<span>00</span>:<span>13</span>)</span></code><code><span>running Leiden <span>clustering</span></span></code><code><span>    finished: <span>found</span> <span>18</span> clusters <span>and</span> added</span></code><code><span>    <span>'cnv_leiden'</span>, the cluster labels (adata.obs, categorical) (<span>0</span>:<span>00</span>:<span>00</span>)</span></code></pre></section><pre><code>cnv.pl.chromosome_heatmap(adata, groupby=<span>"cnv_leiden"</span>, dendrogram=<span>True</span>)</code></pre><p><img data-imgfileid="100001976" data-ratio="0.6092592592592593" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDSFuRwxorJrKvI80BlRZw6NDmaVib6gUlXFzKOdo5nscHNmoLUWtvU1LQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDSFuRwxorJrKvI80BlRZw6NDmaVib6gUlXFzKOdo5nscHNmoLUWtvU1LQ/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><h3><strong>CNV降维与评分</strong></h3><pre><code>cnv.tl.umap(adata)<br>cnv.tl.cnv_score(adata)</code></pre><section><ul><li><li><li></ul><pre data-lang="nginx"><code><span><span>computing</span> UMAP</span></code><code><span>    finished: added</span></code><code><span>    <span>'X_umap'</span>, UMAP coordinates (adata.obsm) (<span>0</span>:<span>00</span>:<span>07</span>)</span></code></pre></section><section><span>UMAP图由一大群“正常”细胞和几个具有独特CNV特征的小型聚类组成。除了包含纤毛细胞的“12号”簇之外，所有独立的聚类都是上皮细胞。这些很可能就是肿瘤细胞，并且每个聚类代表了单个亚克隆。</span></section><pre><code>fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(<span>2</span>, <span>2</span>, figsize=(<span>11</span>, <span>11</span>))<br>ax4.axis(<span>"off"</span>)<br>cnv.pl.umap(<br>    adata,<br>    color=<span>"cnv_leiden"</span>,<br>    legend_loc=<span>"on data"</span>,<br>    legend_fontoutline=<span>2</span>,<br>    ax=ax1,<br>    show=<span>False</span>,<br>)<br>cnv.pl.umap(adata, color=<span>"cnv_score"</span>, ax=ax2, show=<span>False</span>)<br>cnv.pl.umap(adata, color=<span>"cell_type"</span>, ax=ax3)</code></pre><p><span></span></p><p><img data-imgfileid="100001977" data-ratio="0.9685185185185186" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDSuVI6ypo6e4S60TVfv1EvB17jgxKicHBPglNjJticd6bXAib8SBqdHnbhQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDSuVI6ypo6e4S60TVfv1EvB17jgxKicHBPglNjJticd6bXAib8SBqdHnbhQ/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span></p><pre><code><span># 在原始umap图上展示数据</span><br>fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(<span>2</span>, <span>2</span>, figsize=(<span>12</span>, <span>11</span>), gridspec_kw={<span>"wspace"</span>: <span>0.5</span>})<br>ax4.axis(<span>"off"</span>)<br>sc.pl.umap(adata, color=<span>"cnv_leiden"</span>, ax=ax1, show=<span>False</span>)<br>sc.pl.umap(adata, color=<span>"cnv_score"</span>, ax=ax2, show=<span>False</span>)<br>sc.pl.umap(adata, color=<span>"cell_type"</span>, ax=ax3)</code></pre><p><span></span></p><p><img data-imgfileid="100001978" data-ratio="0.8925925925925926" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDS1A1r1vQONNOYlkibsdr8SFgRs6vsZ5MXTKeLOu3lnZ0qKBJJYSlsqmA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDS1A1r1vQONNOYlkibsdr8SFgRs6vsZ5MXTKeLOu3lnZ0qKBJJYSlsqmA/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span></p><h3><strong>肿瘤细胞分类</strong></h3><pre><code>adata.obs[<span>"cnv_status"</span>] = <span>"normal"</span><br>adata.obs.loc[<br>adata.obs[<span>"cnv_leiden"</span>].isin([<span>"10"</span>, <span>"16"</span>, <span>"13"</span>, <span>"8"</span>, <span>"12"</span>, <span>"17"</span>, <span>"1"</span>, <span>"14"</span>, <span>"11"</span>]), <span>"cnv_status"</span>] = <span>"tumor"</span></code></pre><pre><code>fig, (ax1, ax2) = plt.subplots(<span>1</span>, <span>2</span>, figsize=(<span>12</span>, <span>5</span>), gridspec_kw={<span>"wspace"</span>: <span>0.5</span>})<br>cnv.pl.umap(adata, color=<span>"cnv_status"</span>, ax=ax1, show=<span>False</span>)<br>sc.pl.umap(adata, color=<span>"cnv_status"</span>, ax=ax2)</code></pre><section><ul><li></ul><pre data-lang="python"><code><span><span>... </span>storing <span>'cnv_status'</span> <span>as</span> categorical</span></code></pre></section><p><img data-imgfileid="100001979" data-ratio="0.4148148148148148" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDScJhVoamjgICoV2pwWoxrQKKT0wkYkNgBiciayEJxLxZKr9OxibZyyTodg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDScJhVoamjgICoV2pwWoxrQKKT0wkYkNgBiciayEJxLxZKr9OxibZyyTodg/640?wx_fmt=png&amp;from=appmsg"></p><pre><code><span># 单独展示恶心细胞的cnv热图</span><br>cnv.pl.chromosome_heatmap(adata[adata.obs[<span>"cnv_status"</span>] == <span>"tumor"</span>, :])</code></pre><p><span></span></p><p><img data-imgfileid="100001980" data-ratio="0.6092592592592593" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDSdRe0CaHv73v0mPicuUuRn6Bs7FibOicKcQqibn8gctUVttOWWjvribBfI1w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDSdRe0CaHv73v0mPicuUuRn6Bs7FibOicKcQqibn8gctUVttOWWjvribBfI1w/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span></p><pre><code><span># 单独展示正常细胞的cnv热图</span><br>cnv.pl.chromosome_heatmap(adata[adata.obs[<span>"cnv_status"</span>] == <span>"normal"</span>, :])</code></pre><p><span></span></p><p><img data-imgfileid="100001981" data-ratio="0.6101851851851852" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDSmdytydOE7kuAbJVg92qJZl6VP5xS9CHTFAERLsDqkXWRUrLJicCfe2A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AEO4HP8OHSxuPqEWdhJazDSmdytydOE7kuAbJVg92qJZl6VP5xS9CHTFAERLsDqkXWRUrLJicCfe2A/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span></p><section><strong><br></strong></section><pre><section><strong><span>交流合作</span></strong></section><section><strong><span>Kinesin专业从事单细胞与空转数据的分析与培训，有此需求的朋友欢迎加微信洽谈合作。本公众号交流群向</span></strong><span>科研院校师生和公司生信人员</span><strong><span>开放，希望入群的朋友也可加我微信申请。</span></strong></section><section><strong><span><br></span></strong></section><section><strong><span><br></span></strong></section><section><strong><span><img data-imgfileid="100001982" data-ratio="0.3194444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/VTXDic6Eia0AGtAkJEKftUWtdPkZueleqBSVLS2GsSIKZHyGr0FWAu8nRuywTXiaGlZnCNNnicibR2vBlWI19trNoHQ/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp" data-type="png" data-w="1080" width="677px" src="https://mmbiz.qpic.cn/mmbiz_png/VTXDic6Eia0AGtAkJEKftUWtdPkZueleqBSVLS2GsSIKZHyGr0FWAu8nRuywTXiaGlZnCNNnicibR2vBlWI19trNoHQ/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp"></span></strong></section></pre><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/byA6MmhvEs8c7oDU-DMzVg",target="_blank" rel="noopener noreferrer">原文链接</a>
