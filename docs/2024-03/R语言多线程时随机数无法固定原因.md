---
title: "R语言多线程时随机数无法固定原因"
date: 2024-03-27T11:59:15Z
draft: ["false"]
tags: [
  "fetched",
  "生信小知识"
]
categories: ["Acdemic"]
---
R语言多线程时随机数无法固定原因 by 生信小知识
------
<div><section><h2><span>R语言多线程时随机数无法固定原因</span></h2><blockquote><p>微信公众号：<strong>生信小知识</strong><br>关注可了解更多的生物信息学教程及知识。问题或建议，请公众号留言;</p></blockquote><h3><span>目录</span></h3><p><span><span>前言</span></span><span><span>解决方案</span></span><span><span>后记</span></span></p><h3><span>前言</span></h3><p>很早之前，我介绍过如何在R语言中实现多线程并行运算，这在大数据计算时非常有用。具体可以查看【<a href="https://mp.weixin.qq.com/s?__biz=MjM5NTk0Mzg2Nw==&amp;mid=2247488650&amp;idx=1&amp;sn=0ac8206d251ac52f0fd9faa141a331cc&amp;scene=21#wechat_redirect" data-linktype="2">R语言多线程处理</a>】学习如何在R语言中进行多线程并行计算。</p><p>但是近来我在R语言中，使 <code>foreach</code> 用多线程运行时出现了一个与我预期不相符的结果，结果如下：</p><pre><code><span>library</span>(foreach)<br><span>library</span>(doParallel)<br><span># Loading required package: iterators</span><br><span># Loading required package: parallel</span><br>cl &lt;- makeCluster(<span>4</span>)<br>registerDoParallel(cl)<br><br>set.seed(<span>123</span>)<br>foreach(i=<span>1</span>:<span>2</span>,.combine=cbind) %dopar% {rnorm(<span>5</span>)}<br><span>#        result.1   result.2</span><br><span># [1,] -0.9704739  0.9708706</span><br><span># [2,]  0.1753931  0.2916369</span><br><span># [3,]  0.1820183 -1.7080542</span><br><span># [4,]  0.1813893  1.3364086</span><br><span># [5,] -0.4145590  0.8432729</span><br>set.seed(<span>123</span>)<br>foreach(i=<span>1</span>:<span>2</span>,.combine=cbind) %dopar% {rnorm(<span>5</span>)}<br><span>#        result.1   result.2</span><br><span># [1,] -0.1705899 -0.5460670</span><br><span># [2,] -0.8781730 -0.3107628</span><br><span># [3,] -0.5409302 -1.0984619</span><br><span># [4,] -1.2579302 -0.4108264</span><br><span># [5,]  0.4703415  0.4838866</span><br>stopCluster(cl)<br></code></pre><p>明明设置了随机种子，怎么结果就不一样了？</p><p>经过查找资料：</p><ul><li><p><span>https://www.sugarscape.net/blog/random-number-seed-in-foreach/</span></p></li><li><p><span>https://stackoverflow.com/questions/8358098/how-to-set-seed-for-random-simulations-with-foreach-and-domc-packages</span></p></li></ul><p>得到的结论是：<strong>在主线上的随机种子是123，但是当新开了子线程后，子线程的随机种子是没有设置的。</strong></p><h3><span>解决方案</span></h3><p>知道了问题的本质，那想要解决这个问题其实也很简单了，我们在每个子线程中也设置这个随机种子就好了：</p><pre><code><span>library</span>(foreach)<br><span>library</span>(doParallel)<br><span># Loading required package: iterators</span><br><span># Loading required package: parallel</span><br>cl &lt;- makeCluster(<span>4</span>)<br>registerDoParallel(cl)<br><br>set.seed(<span>123</span>)<br>foreach(i=<span>1</span>:<span>2</span>,.combine=cbind) %dopar% {set.seed(<span>123</span>); rnorm(<span>5</span>)}<br><span>#         result.1    result.2</span><br><span># [1,] -0.56047565 -0.56047565</span><br><span># [2,] -0.23017749 -0.23017749</span><br><span># [3,]  1.55870831  1.55870831</span><br><span># [4,]  0.07050839  0.07050839</span><br><span># [5,]  0.12928774  0.12928774</span><br>set.seed(<span>123</span>)<br>foreach(i=<span>1</span>:<span>2</span>,.combine=cbind) %dopar% {set.seed(<span>123</span>); rnorm(<span>5</span>)}<br><span>#         result.1    result.2</span><br><span># [1,] -0.56047565 -0.56047565</span><br><span># [2,] -0.23017749 -0.23017749</span><br><span># [3,]  1.55870831  1.55870831</span><br><span># [4,]  0.07050839  0.07050839</span><br><span># [5,]  0.12928774  0.12928774</span><br>stopCluster(cl)<br></code></pre><h3><span>后记</span></h3><p>这次只检查了 <code>foreach</code> 多线程的问题，没有检测 <code>parallel</code> 包的结果，如果有需要，后续再检测。</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/hYDYc7IFjDGLDvM9BMk57g",target="_blank" rel="noopener noreferrer">原文链接</a>
