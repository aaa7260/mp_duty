---
title: "《The R journal》杂志主编写了一个R包{vivid}，可将机器学习模型作图！"
date: 2024-03-25T12:08:12Z
draft: ["false"]
tags: [
  "fetched",
  "R语言和统计"
]
categories: ["Acdemic"]
---
《The R journal》杂志主编写了一个R包{vivid}，可将机器学习模型作图！ by R语言和统计
------
<div><section data-mpa-powered-by="yiban.io"><span>这篇文章介绍一个R包，名为<span>{vivid}</span>，可以将机器学习模型的交互作用以及变量重要性通过图片的形式呈现，并且还可以制作偏依赖图。而上述的几张图片是了解和解释机器学习模型的重要图片。如果使用得当，这个R包将会是你的得力战将！</span></section><section><span><br></span></section><section><span>这个R包的关键函数如下表所示： <br></span></section><section><span><br></span></section><section><img data-galleryid="" data-imgfileid="100026015" data-ratio="0.6287037037037037" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQP2QibuNw2rSu3dwH6woX13XosXUl15w2iasxDSiaPhlSMGfCyFcVecBFkw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQP2QibuNw2rSu3dwH6woX13XosXUl15w2iasxDSiaPhlSMGfCyFcVecBFkw/640?wx_fmt=png&amp;from=appmsg"><span>文献[1] 表2</span></section><section><br></section><section><span>首先安装并且载入相关的R包： </span></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>install.packages(<span>"vivid"</span>) </span><span># 计算变量交互以及重要性图</span><span><br mpa-from-tpl="t">install.packages(<span>"randomForest"</span>) </span><span># 建立随机森林模型</span><span><br mpa-from-tpl="t">install.packages(c(<span>"network"</span>, <span>"sna"</span>, <span>"scales"</span>, <span>"intergraph"</span>, <span>"lemon"</span>)) </span><span># 制作网络图</span><span><br mpa-from-tpl="t"><br mpa-from-tpl="t"><span>if</span> (!requireNamespace(<span>"graph"</span>, quietly = TRUE)){install.packages(<span>"BiocManager"</span>) <br mpa-from-tpl="t">  BiocManager::install(<span>"graph"</span>)<br mpa-from-tpl="t">} <br mpa-from-tpl="t">install.packages(<span>"zenplots"</span>)<br mpa-from-tpl="t"><br mpa-from-tpl="t">library(vivid) <br mpa-from-tpl="t">library(randomForest)<br mpa-from-tpl="t">library(MASS)</span></section></pre></section><section><span>将使用R包<span>{MASS}</span>中的著名数据集Boston，它是一个关于房价的数据集，感兴趣的读者可以使用代码</span><span>?Boston</span><span>进一步查看。</span><br></section><section><span><br></span></section><section><span>大致了解下数据集： </span></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>summary(Boston)</span></section></pre></section><section><img data-galleryid="" data-imgfileid="100026014" data-ratio="0.5925925925925926" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPVKrUuovHvKoKoT3axp09C10TUtyXT43c29t1KeNEgFpIaFhNDCQ4gA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPVKrUuovHvKoKoT3axp09C10TUtyXT43c29t1KeNEgFpIaFhNDCQ4gA/640?wx_fmt=png&amp;from=appmsg"></section><section><br></section><section><span>最后的一个变量medv通常作为感兴趣的结局变量，是一个连续变量，为房价。其他通常作为自变量，包含周边的犯罪率和空气污染等等。</span></section><section><span><br></span></section><section><span>下一步，以建立一个随机森林模型为例，代码如下： <br></span></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>set.seed(<span>123</span>)<br mpa-from-tpl="t">rf_model &lt;- randomForest(medv ~., data = Boston)</span></section></pre></section><section><span>上述代码中波浪线右侧的英文句号"."指的是纳入除因变量以外的<span>所有</span>变量。<br></span></section><section><br></section><section><span>下一步，计算变量交互作用（interactions）以及重要性（importance），将使用</span><span>vivi()</span><span>函数(顺便提一句，变量交互的英文为variable interactions，变量重要性的英文为variable importance，取首字母，即vi以及vi；所以作者使用vivi作为函数名<img data-imgfileid="100026026" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPibMYo75ShaeHroO3mPfBvbfdVwxO7vkVhic5aATzNibTHEAY4vnqJbWrA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="64" src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPibMYo75ShaeHroO3mPfBvbfdVwxO7vkVhic5aATzNibTHEAY4vnqJbWrA/640?wx_fmt=png&amp;from=appmsg">)，代码如下： </span><br></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>set.seed(<span>123</span>)<br mpa-from-tpl="t">VIVI_rf &lt;- vivi(data = Boston, <br mpa-from-tpl="t">                fit = rf_model,<br mpa-from-tpl="t">                response = <span>"medv"</span>)</span></section></pre></section><section><span>上述的三行代码为</span><span>vivi()</span><span>函数的必填内容，包含数据集，模型，以及因变量。</span></section><section><span><br></span></section><section><span>如果将上述的三行代码展开的话（如下），结果是一样的，只是隐藏了一些默认的行为： <br></span></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>set.seed(<span>123</span>)<br mpa-from-tpl="t">VIVI_rf &lt;- vivi(data = Boston, <br mpa-from-tpl="t">                fit = rf_model,<br mpa-from-tpl="t">                response = <span>"medv"</span>,<br mpa-from-tpl="t">                reorder = TRUE,<br mpa-from-tpl="t">                normalized = FALSE,<br mpa-from-tpl="t">                importanceType = <span>"agnostic"</span>,<br mpa-from-tpl="t">                gridSize = <span>50</span>,<br mpa-from-tpl="t">                nmax = <span>500</span>,<br mpa-from-tpl="t">                class<span> = 1,<br mpa-from-tpl="t">                <span>predictFun</span> = <span>NULL</span>,<br mpa-from-tpl="t">                <span>numPerm</span> = 4)</span></span></section></pre></section><section><span>其中，</span><span>importanceType = "agnostic" </span><span>指代默认使用agnostic置换方法计算重要性，它是一种非参数方法；</span><span>normalized = FALSE</span><span> 指代Friedman's H-statistic的值未被标准化。</span></section><section><span><br></span></section><section><span>上述函数的代码运行后将会产生一个矩阵，对角线上为变量重要性，非对角线上为变量交互。</span></section><section><span><br></span></section><section><span>可以查看一下结果，代码如下： </span></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>print(VIVI_rf, digits = <span>1</span>)</span></section></pre></section><section><img data-galleryid="" data-imgfileid="100026016" data-ratio="0.45092592592592595" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQP9ibltCIibrK3ohH2wO4cvCoIwv3wYLZlE2s0PHGBIx8o3iaAcf6rtNicEw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQP9ibltCIibrK3ohH2wO4cvCoIwv3wYLZlE2s0PHGBIx8o3iaAcf6rtNicEw/640?wx_fmt=png&amp;from=appmsg"></section><section><br></section><section><span>下一步，介绍如何将上面的矩阵作图。<br></span></section><section><span><br></span></section><section><span>这个R包提供了多种方式，第一种是将上述的矩阵做成热图（heatmap），代码如下： <br></span></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>viviHeatmap(mat = VIVI_rf)</span></section></pre></section><section><img data-galleryid="" data-imgfileid="100026013" data-ratio="0.812037037037037" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPePAbbv0IN0dZianNS0n3GfZnO7zncMUzvhOIB5jIKeA1S1ibs6G5Wic6w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPePAbbv0IN0dZianNS0n3GfZnO7zncMUzvhOIB5jIKeA1S1ibs6G5Wic6w/640?wx_fmt=png&amp;from=appmsg"></section><section><br></section><section><span>右侧上方图例Vint指代变量交互；而下方Vimp指代变量重要性。<br></span></section><section><span><br></span></section><section><span>在这个热图中，变量重要性是分布在对角线上的；而变量交互分布在非对角线上。<br></span></section><section><span><br></span></section><section><span>就变量重要性来说（绿色），lstat为最重要的变量，rm次之。<br></span></section><section><span><br></span></section><section><span>如果不喜欢上述的绿色，希望改成红色，可以进一步修饰，代码如下： <br></span></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>viviHeatmap(mat = VIVI_rf,<br mpa-from-tpl="t">            impPal = rev(colorspace::sequential_hcl(palette = <span>"Reds 3"</span>, n = <span>100</span>)))</span></section></pre></section><section><img data-galleryid="" data-imgfileid="100026017" data-ratio="0.8333333333333334" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQP5HaY4W6AE6t3D6UmjvnpfeM7HcXicqUKaaGD0Xr6Tic63eDAuJUZzBzQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQP5HaY4W6AE6t3D6UmjvnpfeM7HcXicqUKaaGD0Xr6Tic63eDAuJUZzBzQ/640?wx_fmt=png&amp;from=appmsg"></section><section><br></section><section><span>下一步，这个R包还提供了热图以外的形式，比如网络图，代码如下： </span><br></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>viviNetwork(mat = VIVI_rf)</span></section></pre></section><section><img data-galleryid="" data-imgfileid="100026019" data-ratio="0.7759259259259259" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPJpUMavbsH9dpcQAddsbqgnvA4JXDicC0lSlBEmODC7U2yPNyfII39Kw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPJpUMavbsH9dpcQAddsbqgnvA4JXDicC0lSlBEmODC7U2yPNyfII39Kw/640?wx_fmt=png&amp;from=appmsg"></section><section><br></section><section><span>上图中的节点(圆形)指代变量重要性，而连接线条指代变量交互。</span></section><section><span><br></span></section><section><span>也可以给变量交互（连接线条）设定一个阈值（比如0.2），代码如下： </span></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>viviNetwork(mat = VIVI_rf, intThreshold = <span>0.2</span>, removeNode = TRUE)</span></section></pre></section><section><img data-galleryid="" data-imgfileid="100026020" data-ratio="0.8055555555555556" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPEibLft6I6hF69Vc2UrBVMoTFdGxMMXDIyiaibynCDv1x7r6uicX3MxiaIBg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPEibLft6I6hF69Vc2UrBVMoTFdGxMMXDIyiaibynCDv1x7r6uicX3MxiaIBg/640?wx_fmt=png&amp;from=appmsg"></section><section><br></section><section><span>也可以改变图片的布局风格，代码如下： <br></span></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>viviNetwork(mat = VIVI_rf,<br mpa-from-tpl="t">            layout = igraph::layout_on_grid)</span></section></pre></section><section><img data-galleryid="" data-imgfileid="100026018" data-ratio="0.8212962962962963" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPibl4ZicEJkUOUJLJULLOH4IiaWpbPr5ibwOWuafLC0iceY9rdxUpcLBKVSg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPibl4ZicEJkUOUJLJULLOH4IiaWpbPr5ibwOWuafLC0iceY9rdxUpcLBKVSg/640?wx_fmt=png&amp;from=appmsg"></section><section><br></section><section><span>下一步，这个R包可以画出实战中非常重要的偏依赖图（同时伴随个体条件期望曲线），代码如下： <br></span></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>pdpVars(data = Boston,<br mpa-from-tpl="t">        fit = rf_model,<br mpa-from-tpl="t">        response = <span>"medv"</span>,<br mpa-from-tpl="t">        vars = colnames(VIVI_rf)[<span>1</span>:<span>5</span>],<br mpa-from-tpl="t">        nIce = <span>80</span>)</span></section></pre></section><section><img data-galleryid="" data-imgfileid="100026021" data-ratio="0.35555555555555557" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPUdGydDEDX0nTZQLXJ3Vdib0QVL4iaHOia1Q6PQC4yY6EUIwBk83VpXMZA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPUdGydDEDX0nTZQLXJ3Vdib0QVL4iaHOia1Q6PQC4yY6EUIwBk83VpXMZA/640?wx_fmt=png&amp;from=appmsg"></section><section><br></section><section><span>其中，前面三行分别为数据集，模型，以及因变量；</span><span>vars = colnames(VIVI_rf)[1:5]</span><span> 提取了VIVI_rf矩阵的前面五个变量；</span><span>nIce = 80</span><span>指定了个体条件期望曲线的个数。</span></section><section><span><br></span></section><section><span>在上图中，黑色的线条指代偏依赖图，而彩色的线条指代个体条件期望曲线。从上图的结果大致可以判断lstat以及rm对因变量有较大的影响。 <br></span></section><section><span><br></span></section><section><span>下一步，还可以画出偏依赖配对图，将使用到</span><span>pdpPairs()</span><span>函数，代码如下： <br></span></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>pdpPairs(data = Boston, <br mpa-from-tpl="t">         fit = rf_model, <br mpa-from-tpl="t">         response = <span>"medv"</span>, <br mpa-from-tpl="t">         nmax = <span>500</span>, <br mpa-from-tpl="t">         gridSize = <span>10</span>, <br mpa-from-tpl="t">         vars = colnames(VIVI_rf)[<span>1</span>:<span>5</span>],<br mpa-from-tpl="t">         nIce = <span>80</span>)</span></section></pre></section><section><img data-galleryid="" data-imgfileid="100026022" data-ratio="0.7222222222222222" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPwSxqnaIxLWXyKVDe3f3SHekqiavxGZyibuMdprFFmYria1ibT90bXIPL2A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/pCu8RzQCByRXvkHpu7m0Fast17YtBoQPwSxqnaIxLWXyKVDe3f3SHekqiavxGZyibuMdprFFmYria1ibT90bXIPL2A/640?wx_fmt=png&amp;from=appmsg"></section><section><br></section><section><span>上图的对角线展示了单变量的偏依赖图（以及个体条件期望曲线），对角线上方展示了双变量的偏依赖图；而对角线下方展示变量原始数据的散点图。</span></section><section><span><br></span></section><section><span>好啦，今天的内容就到这里。</span><span>如果有帮助，记得分享给需要的人</span><img data-ratio="1" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/Expression/Expression_67@2x.png" data-w="128" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/Expression/Expression_67@2x.png"><span>！</span></section><section><span><br></span></section><section><br></section><section><span>参考文献</span></section><section><br></section><section data-mpa-preserve-tpl-color="t" data-mpa-template="t" mpa-preserve="t" mpa-from-tpl="t"><pre><section><span>[1] vivid: An R package for Variable Importance and Variable Interactions Displays for Machine Learning Models</span></section></pre></section><section><br></section><section><span><strong><span>公众号的线上课程</span></strong></span></section><section><span>1. 《R语言和统计新手课程》</span></section><section><span>2. 《回归：从入门到进阶》</span></section><section><span>通过公众号菜单栏--线上课程--新手课程/回归课程即可到达相关链接。<br></span></section><section><span><br></span></section><section><strong><span>统计咨询</span></strong></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzk0MzE5OTAxMg==&amp;mid=2247508283&amp;idx=1&amp;sn=4ed28c3711a18a34b1b4346612cbfe81&amp;chksm=c3356770f442ee66f6abc20a6115ae619663d5f417f9823705ade284fc62593188c4de7903ce&amp;scene=21#wechat_redirect" textvalue="《服务介绍和经典合作案例》" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>《服务介绍和经典合作案例》</span></a></section><section><span><br></span></section><section><span><strong><span>公众号核心成员的成果发表</span></strong></span></section><section><span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzk0MzE5OTAxMg==&amp;mid=2247506555&amp;idx=1&amp;sn=0ca95fddcc184506e02c5b7ea70c0567&amp;chksm=c3351c30f4429526acad9c6c20dc0c3b76dc849d57a1755155f234f6eb31a24a904962f7aa5d&amp;scene=21#wechat_redirect" textvalue="《SCI医学1区论文》" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">《SCI医学1区影响因子9分论文》</a></span></section><section><br></section><section><span><strong><span>公众号核心成员担任SCI杂志Associate Editor!</span></strong></span></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzk0MzE5OTAxMg==&amp;mid=2247508003&amp;idx=1&amp;sn=4d6c2bf2e1723e751743ff6eeda407cc&amp;chksm=c3356668f442ef7ee530363ababa01f074c2bc1765f551a3d90cb2ce0a9faa62cdefa6380803&amp;scene=21#wechat_redirect" textvalue="《Journal of Alzheimer's disease杂志Associate editor》" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>《JAD杂志Associate editor》</span></a></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzk0MzE5OTAxMg==&amp;mid=2247508499&amp;idx=1&amp;sn=2adb08a49ac005b837970118de24e749&amp;chksm=c3356458f442ed4ecd899198d92e2a5584f146a4a0a82a75cd065bc1719fd76b226886be758f&amp;scene=21#wechat_redirect" textvalue="《Frontiers in Neuroscience, Frontiers in Neurology and Frontiers in Psychiatry杂志的神经退行性病变板块》" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>《Frontiers in Neuroscience, Frontiers in Neurology and Frontiers in Psychiatry杂志的神经退行性病变板块》</span></a></section><section><br></section><section><br></section><section data-mpa-template="t" mpa-from-tpl="t"><section><span>▌本文由</span><span><strong mpa-from-tpl="t"><span>R语言和统计</span></strong></span><span>首发</span></section><section><span>▌课程相关咨询可添加R师妹微信: kefu_rstats</span></section><section><span>▌编辑：June</span></section><section><span>▌邮箱：contact@rstats.cn</span></section><section><span>▌网站：www.rstats.cn</span></section><section><span>▌<strong>我们致力于</strong><strong>让R语言和统计变得简单！</strong><br></span></section><section><br></section><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section label="Powered by 135editor.com" data-role="outer" mpa-from-tpl="t"><section data-role="paragraph" mpa-from-tpl="t"><hr><section><br></section></section></section></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/M7ySxzafiSPpn-o-LOag1w",target="_blank" rel="noopener noreferrer">原文链接</a>
