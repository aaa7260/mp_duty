---
title: "Nature单细胞富集分析条形图复现"
date: 2024-03-17T00:28:45Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
Nature单细胞富集分析条形图复现 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">今天给大家复现一篇高分文章中对单细胞功能富集结果进行展示的条形图，此图无论是配色还是美观程度都还可以！</p><p data-tool="mdnice编辑器">文章原图如下：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100037100" data-ratio="0.9239130434782609" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibr3JVC0hNTa130iaY6dEp8s2fAicdujVQYrBtKIJT73JAf2xVQkZeylHdjqaKwxdK3G2wty7kKR0dg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="552" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibr3JVC0hNTa130iaY6dEp8s2fAicdujVQYrBtKIJT73JAf2xVQkZeylHdjqaKwxdK3G2wty7kKR0dg/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20240316163911483</figcaption></figure><p data-tool="mdnice编辑器">颜值是不是还可以！</p><p data-tool="mdnice编辑器">首先拿到单细胞不同亚群的功能富集结果，此次，我们使用SeuratData包中的pbmcsca。</p><h3 data-tool="mdnice编辑器"><span></span><span>差异分析</span><span></span></h3><p data-tool="mdnice编辑器">使用FindAllMarkers函数对每个亚群进行差异分析，参数使用默认参数，如果自己做其他项目可以调整一些参数</p><pre data-tool="mdnice编辑器"><code>rm(list=ls())<br>library(Seurat)<br>library(SeuratData)<br>library(clusterProfiler)<br>library(org.Hs.eg.db)<br><br>obj &lt;- LoadData(<span>"pbmcsca"</span>)<br>obj <br>head(obj@meta.data)<br><br><span># 使用原有的细胞注释</span><br>Idents(obj) &lt;- <span>"CellType"</span><br><br><span># 得到每个细胞亚群的高表达基因</span><br>obj.markers &lt;- FindAllMarkers(obj, only.pos = TRUE)<br>head(obj.markers)<br><br>         p_val avg_log2FC pct.1 pct.2 p_val_adj          cluster     gene<br>CST7         0        Inf 0.635 0.145         0 Cytotoxic T cell     CST7<br>GZMA         0        Inf 0.491 0.125         0 Cytotoxic T cell     GZMA<br>PYHIN1       0        Inf 0.259 0.090         0 Cytotoxic T cell   PYHIN1<br>SAMD3        0        Inf 0.198 0.055         0 Cytotoxic T cell    SAMD3<br>ARL4C        0        Inf 0.549 0.305         0 Cytotoxic T cell    ARL4C<br>C12orf75     0        Inf 0.351 0.112         0 Cytotoxic T cell C12orf75<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>功能富集</span><span></span></h3><p data-tool="mdnice编辑器">使用clusterProfiler进行KEGG Pathway通路富集分析，KEGG通路中基因为基因 ENTREZID，需要进行转换；当然如果是GO，直接设置keytype类型就可以了。</p><pre data-tool="mdnice编辑器"><code><span># 基因转成ENTREZID</span><br>Symbol &lt;- mapIds(get(<span>"org.Hs.eg.db"</span>), keys = obj.markers<span>$gene</span>, keytype = <span>"SYMBOL"</span>, column=<span>"ENTREZID"</span>)<br>ids &lt;- bitr(obj.markers<span>$gene</span>,<span>"SYMBOL"</span>,<span>"ENTREZID"</span>, <span>"org.Hs.eg.db"</span>)<br><br><span># 合并ENTREZID到obj.markers中</span><br>data &lt;- merge(obj.markers, ids, by.x=<span>"gene"</span>, by.y=<span>"SYMBOL"</span>)<br><br>head(data)<br>     gene         p_val  avg_log2FC pct.1 pct.2     p_val_adj          cluster ENTREZID<br>1    AAK1 1.191686e-262         Inf 0.385 0.192 4.015267e-258      CD4+ T cell    22848<br>2    AATF  1.298094e-03         Inf 0.103 0.091  1.000000e+00 Cytotoxic T cell    26574<br>3   ABCA8  2.613325e-34   0.6758008 0.565 0.079  8.805336e-30       Unassigned    10351<br>4   ABCE1  9.240937e-35 317.6269921 0.110 0.067  3.113641e-30      CD4+ T cell     6059<br>5 ABHD14B  7.371315e-69 106.9935161 0.173 0.099  2.483691e-64      CD4+ T cell    84836<br>6 ABHD17A 1.396019e-129 282.6004204 0.258 0.145 4.703745e-125 Cytotoxic T cell    81926<br><br></code></pre><p data-tool="mdnice编辑器">功能富集：compareCluster函数</p><pre data-tool="mdnice编辑器"><code>gcSample &lt;- split(data<span>$ENTREZID</span>, data<span>$cluster</span>)<br>gcSample<br><br>xx &lt;- compareCluster(gcSample, fun=<span>"enrichGO"</span>, keytype=<span>"SYMBOL"</span>, OrgDb=<span>"org.Hs.eg.db"</span>, ont=<span>"BP"</span>, pvalueCutoff=1, qvalueCutoff=1)<br><br>xx &lt;- compareCluster(gcSample, fun=<span>"enrichKEGG"</span>, organism=<span>"hsa"</span>, pvalueCutoff=1, qvalueCutoff=1)<br>res &lt;- xx@compareClusterResult<br><br><span>## 将富集结果中的 ENTREZID 重新转为 SYMBOL</span><br><span>for</span> (i <span>in</span> 1:dim(res)[1]) {<br>  arr = unlist(strsplit(as.character(res[i,<span>"geneID"</span>]), split=<span>"/"</span>))<br>  gene_names = paste(unique(names(Symbol[Symbol %<span>in</span>% arr])), collapse=<span>"/"</span>)<br>  res[i,<span>"geneID"</span>] = gene_names<br>}<br><br>head(res)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100037099" data-ratio="0.26296296296296295" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibr3JVC0hNTa130iaY6dEp8siago68wWWAUOpxuomJ7ByCeRicibfYdbQ9Tib2CKCeyFLibRAiaDqVDq9o0A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibr3JVC0hNTa130iaY6dEp8siago68wWWAUOpxuomJ7ByCeRicibfYdbQ9Tib2CKCeyFLibRAiaDqVDq9o0A/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20240316164811965</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span>绘图</span><span></span></h3><p data-tool="mdnice编辑器">此次绘图使用ggplot，由于亚群数比较多，这里选择两个亚群的 pvalue top5通路进行展示</p><pre data-tool="mdnice编辑器"><code><span>## 通路筛选</span><br>enrich &lt;- res %&gt;% <br>  group_by(Cluster) %&gt;% <br>  top_n(n = 5, wt = -pvalue) %&gt;% <br>  filter(Cluster %<span>in</span>% c(<span>"CD14+ monocyte"</span>, <span>"CD16+ monocyte"</span>))<br><br>dt &lt;- enrich<br>dt &lt;- dt[order(dt<span>$Cluster</span>), ]<br>dt<span>$Description</span> &lt;- factor(dt<span>$Description</span>, levels = dt<span>$Description</span>)<br>colnames(dt)<br></code></pre><p data-tool="mdnice编辑器">自定义主题：</p><pre data-tool="mdnice编辑器"><code><span># 先自定义主题：</span><br>mytheme &lt;- theme(<br>  axis.title = element_text(size = 13),<br>  axis.text = element_text(size = 11),<br>  axis.text.y = element_blank(), <span># 在自定义主题中去掉 y 轴通路标签:</span><br>  axis.ticks.length.y = unit(0,<span>"cm"</span>),<br>  plot.title = element_text(size = 13, hjust = 0.5, face = <span>"bold"</span>),<br>  legend.title = element_text(size = 13),<br>  legend.text = element_text(size = 11),<br>  plot.margin = margin(t = 5.5, r = 10, l = 5.5, b = 5.5)<br>)<br></code></pre><p data-tool="mdnice编辑器">绘图，颜色当然可以跟文献中的一样，有很多种方法把文章中的颜色抠出来，后面专门介绍~</p><pre data-tool="mdnice编辑器"><code>p &lt;- ggplot(data = dt, aes(x = -log10(pvalue), y = rev(Description), fill = Cluster)) +<br>  scale_fill_manual(values =c(<span>'#6bb9d2'</span>, <span>'#d55640'</span>)) +<br>  geom_bar(<span>stat</span> = <span>"identity"</span>, width = 0.5, alpha = 0.8) +<br>  scale_x_continuous(expand = c(0,0)) + <span># 调整柱子底部与y轴紧贴</span><br>  labs(x = <span>"-Log10(pvalue)"</span>, y = <span>"CD16+ monocyte         CD14+ monocyte"</span>, title = <span>"KEGG Pathway enrichment"</span>) +<br>  <span># x = 0.61 用数值向量控制文本标签起始位置</span><br>  geom_text(size=3.8, aes(x = 0.05, label = Description), hjust = 0) + <span># hjust = 0,左对齐</span><br>  geom_text(size=3, aes(x = 0.05, label = geneID), hjust = 0, vjust = 2.5, color=rep(c(<span>'#6bb9d2'</span>, <span>'#d55640'</span>),each=5)) + <span># hjust = 0,左对齐</span><br>  theme_classic() + <br>  mytheme +<br>  NoLegend()<br><br>p<br><br><span># 保存，这里的保存宽和高进行了调整，可以使得结果比较美观</span><br>ggsave(filename = <span>"test.png"</span>, width = 5.2, height = 5.1, plot = p)<br></code></pre><p data-tool="mdnice编辑器">结果如下：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100037101" data-ratio="0.9770318021201413" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibr3JVC0hNTa130iaY6dEp8sfk6VKlsr4EkS5FxAKEp5JiaibiaDJxxmCmAUEibUVicGdtCX35z2GllicVzg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="566" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losibr3JVC0hNTa130iaY6dEp8sfk6VKlsr4EkS5FxAKEp5JiaibiaDJxxmCmAUEibUVicGdtCX35z2GllicVzg/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20240316165927270</figcaption></figure><p data-tool="mdnice编辑器">文献信息如下：</p><p data-tool="mdnice编辑器">https://www.nature.com/articles/s41586-023-06783-1</p><p data-tool="mdnice编辑器">CHIT1-positive microglia drive motor neuron ageing in the primate spinal cord</p><p data-tool="mdnice编辑器">Nature. 2023 Dec;624(7992):611-620. doi: 10.1038/s41586-023-06783-1. Epub 2023 Oct 31</p><p data-tool="mdnice编辑器">下期见~</p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/vZXxoXSOX6Y7bnIuTHaBzg",target="_blank" rel="noopener noreferrer">原文链接</a>
