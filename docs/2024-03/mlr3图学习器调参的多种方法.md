---
title: "mlr3图学习器调参的多种方法"
date: 2024-03-25T05:54:33Z
draft: ["false"]
tags: [
  "fetched",
  "医学和生信笔记"
]
categories: ["Acdemic"]
---
mlr3图学习器调参的多种方法 by 医学和生信笔记
------
<div><p><img data-galleryid="" data-imgfileid="100017949" data-ratio="0.16666666666666666" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R9fO0vCqNNWMpw3VRMCZnvHTZzG2JUNYHDwaRCDvCcJZEJFRH3KVxBylYk1YcpWMJe8rBmrmeYwjg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R9fO0vCqNNWMpw3VRMCZnvHTZzG2JUNYHDwaRCDvCcJZEJFRH3KVxBylYk1YcpWMJe8rBmrmeYwjg/640?wx_fmt=png&amp;from=appmsg"></p><hr><table><tbody><tr><td width="172" valign="top"><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzOTQzNzU0NA==&amp;action=getalbum&amp;album_id=2231476971388059661&amp;uin=&amp;key=&amp;devicetype=Windows+11+x64&amp;version=63090819&amp;lang=zh_CN&amp;ascene=0&amp;session_us=gh_28ea67f3b544" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span><img data-cropselx1="0" data-cropselx2="151" data-cropsely1="0" data-cropsely2="127" data-galleryid="" data-imgfileid="100017953" data-ratio="0.8435185185185186" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZJVPcbVTf4Xmmz0ibmMDSDicNE8fAMebg1h5uSZJJ7nhmRNiaibJnoG6lOg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZJVPcbVTf4Xmmz0ibmMDSDicNE8fAMebg1h5uSZJJ7nhmRNiaibJnoG6lOg/640?wx_fmt=png&amp;from=appmsg"></span></a></p></td><td width="172" valign="top"><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzOTQzNzU0NA==&amp;action=getalbum&amp;album_id=2267367379124928515&amp;uin=&amp;key=&amp;devicetype=Windows+11+x64&amp;version=63090819&amp;lang=zh_CN&amp;ascene=0&amp;session_us=gh_28ea67f3b544" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span><img data-cropselx1="0" data-cropselx2="151" data-cropsely1="0" data-cropsely2="127" data-galleryid="" data-imgfileid="100017951" data-ratio="0.8435185185185186" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZ3noGibiag7bKyuAvs4POaZWW4JTQMeUibXHqF9Jv0MEoNJLpgvY2jxaTQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZ3noGibiag7bKyuAvs4POaZWW4JTQMeUibXHqF9Jv0MEoNJLpgvY2jxaTQ/640?wx_fmt=png&amp;from=appmsg"></span></a></p></td><td width="172" valign="top"><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzOTQzNzU0NA==&amp;action=getalbum&amp;album_id=2255945345983627264&amp;scene=173&amp;subscene=&amp;sessionid=svr_781993951eb&amp;enterid=1709989110&amp;from_msgid=2247500872&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span><img data-cropselx1="0" data-cropselx2="151" data-cropsely1="0" data-cropsely2="127" data-galleryid="" data-imgfileid="100017952" data-ratio="0.8435185185185186" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZtVWVkXRwiaATrnk7BzxzOOOibjbZSM1AVxkMNXHRHWFybibmVTYpUb4bA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZtVWVkXRwiaATrnk7BzxzOOOibjbZSM1AVxkMNXHRHWFybibmVTYpUb4bA/640?wx_fmt=png&amp;from=appmsg"></span></a></p></td></tr><tr><td width="172" valign="top"><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzOTQzNzU0NA==&amp;action=getalbum&amp;album_id=2393825487539191816&amp;scene=173&amp;subscene=&amp;sessionid=svr_20c53631f79&amp;enterid=1709989057&amp;from_msgid=2247501166&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span><img data-cropselx1="0" data-cropselx2="151" data-cropsely1="0" data-cropsely2="127" data-galleryid="" data-imgfileid="100017950" data-ratio="0.8435185185185186" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZqB1xXibTCqxzWDnSCZrJSicPH8II0G8JxLBmqTEoRWcpiaEEaEoXKibKaQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZqB1xXibTCqxzWDnSCZrJSicPH8II0G8JxLBmqTEoRWcpiaEEaEoXKibKaQ/640?wx_fmt=png&amp;from=appmsg"></span></a></p></td><td width="172" valign="top"><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzOTQzNzU0NA==&amp;action=getalbum&amp;album_id=3302133732023369734&amp;scene=173&amp;subscene=&amp;sessionid=svr_aba6bcd7c9d&amp;enterid=1709989036&amp;from_msgid=2247501168&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span><img data-cropselx1="0" data-cropselx2="151" data-cropsely1="0" data-cropsely2="127" data-galleryid="" data-imgfileid="100017955" data-ratio="0.8435185185185186" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZEDyJ5HeuhZiaaZxAYE2vibrTo3k9PZIicu9ADibzqWtfsVJ7qsyEn8OYPA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZEDyJ5HeuhZiaaZxAYE2vibrTo3k9PZIicu9ADibzqWtfsVJ7qsyEn8OYPA/640?wx_fmt=png&amp;from=appmsg"></span></a></p></td><td width="172" valign="top"><p><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzOTQzNzU0NA==&amp;action=getalbum&amp;album_id=3330048674143567873&amp;scene=173&amp;subscene=&amp;sessionid=undefined&amp;enterid=0&amp;from_msgid=2247501093&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="1"><span><img data-cropselx1="0" data-cropselx2="151" data-cropsely1="0" data-cropsely2="127" data-galleryid="" data-imgfileid="100017956" data-ratio="0.8435185185185186" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZdBBtwWIehx7CD2kBOPBbfIIOuVPZBWCAgZa6pica4yI2DC91G1zoiaJg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZdBBtwWIehx7CD2kBOPBbfIIOuVPZBWCAgZa6pica4yI2DC91G1zoiaJg/640?wx_fmt=png&amp;from=appmsg"></span></a></p></td></tr></tbody></table><p><img data-galleryid="" data-imgfileid="100017954" data-ratio="0.3333333333333333" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZlYnHSZZLNukeic7DKOOuoenP0uPxYP0L4Ngfl5CLhoLUxogGayzREWQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84RicFQdAjJlXFgFpqvDjKEysZlYnHSZZLNukeic7DKOOuoenP0uPxYP0L4Ngfl5CLhoLUxogGayzREWQ/640?wx_fmt=png&amp;from=appmsg"></p><hr><p><br></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><code>mlr3</code>的使用非常灵活，做一件事情有多种实现方法，虽然每种方法都可以实现目的，但是在使用过程中还是有一些不同之处。</p><p data-tool="mdnice编辑器">对于刚接触的<code>mlr3</code>的朋友可以先看<code>mlr3</code>入门合集：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247487478&amp;idx=1&amp;sn=00e6100eaa5f69561b1ed1fa5698ea73&amp;scene=21#wechat_redirect" data-linktype="2">mlr3教程汇总</a>(有些过时了,可以看看基础部分,实践部分请看2023年及以后的推文，2023年之前的代码会报错)</p><p data-tool="mdnice编辑器">本次主要给大家演示<strong>同时有数据预处理步骤和调参步骤</strong>时，如何使用多种方法实现，其实就是演示下如何整合<code>mlr3pipelines</code>的使用，之前介绍过<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247500451&amp;idx=1&amp;sn=f7998b379292dc635b12a195d538ba0b&amp;scene=21#wechat_redirect" data-linktype="2">如何使用mlr3pipelines进行数据预处理和特征工程</a>，但是并没有介绍如何和后面的模型拟合等过程连接起来。</p><p data-tool="mdnice编辑器">在此之前，已经给大家介绍了：</p><ul data-tool="mdnice编辑器"><li><section><code>mlr3</code>调参的基础知识：：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247486925&amp;idx=1&amp;sn=6d1a7af6170e850214ceb2c6db7e2beb&amp;scene=21#wechat_redirect" data-linktype="2">mlr3：超参数调优</a>；</section></li><li><section>有数据预处理但不包含调参：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247492249&amp;idx=1&amp;sn=ef3565c983840ae777535170f147d0ff&amp;scene=21#wechat_redirect" data-linktype="2">使用mlr3搞定二分类资料的多个模型评价和比较</a></section></li><li><section>无预处理包含调参的4种方法：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247501595&amp;idx=1&amp;sn=982240f60cbf40af01f8b3adadef8df5&amp;scene=21#wechat_redirect" data-linktype="2">mlr3超参数调优的多种方法</a></section></li></ul><p data-tool="mdnice编辑器">这里要强调一下，<code>mlr3pipelines</code>的功能非常强大，不但是可以做数据预处理和特征工程，结合<code>mlr3</code>独特的<strong>图形流</strong>，可以实现非常复杂的操作，这篇主要是介绍如何<strong>整合它的数据预处理和超参数调优</strong>。这个过程和<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247498260&amp;idx=1&amp;sn=3805558755e13030d7ddf37c28505c73&amp;scene=21#wechat_redirect" data-linktype="2">tidymodels中的recipes</a>的操作非常像，大家可以对比学习。</p><h2 data-tool="mdnice编辑器"><span></span><span>加载R包</span><span></span></h2><pre data-tool="mdnice编辑器"><code>rm(list = ls())<br><span>library</span>(mlr3verse)<br></code></pre><pre data-tool="mdnice编辑器"><code><span>library</span>(mlr3pipelines)<br><span>library</span>(magrittr)<br></code></pre><p data-tool="mdnice编辑器">一定要熟悉<code>mlr3</code>的<strong>图形流</strong>，如果你还不了解，下面的内容很难理解，可以参考：</p><ul data-tool="mdnice编辑器"><li><section><code>mlr3</code>入门合集：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247487478&amp;idx=1&amp;sn=00e6100eaa5f69561b1ed1fa5698ea73&amp;scene=21#wechat_redirect" data-linktype="2">mlr3教程汇总</a></section></li><li><section><code>mlr3</code>的数据预处理：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247500451&amp;idx=1&amp;sn=f7998b379292dc635b12a195d538ba0b&amp;scene=21#wechat_redirect" data-linktype="2">mlr3pipelines:mlr3图形流</a></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span>方法1</span><span></span></h2><p data-tool="mdnice编辑器">首先选择数据预处理步骤,并使用<code>mlr3</code>独有的管道符<code>%&gt;&gt;%</code>连接预处理步骤和学习器(算法),然后把它们变成一个<strong>图学习器</strong>(GraphLearner).</p><pre data-tool="mdnice编辑器"><code><span># 注意不同的管道符，不要用错了！</span><br>glr &lt;- po(<span>"encode"</span>) %&gt;&gt;%<br>  po(<span>"imputeoor"</span>) %&gt;&gt;%<br>  po(<span>"learner"</span>,lrn(<span>"classif.ranger"</span>,predict_type=<span>"prob"</span>)) %&gt;% <br>  as_learner() <span># 转变为图学习器，这一步很重要！</span><br><br><span># 换个简短的名字</span><br>glr$id &lt;- <span>"randomForest"</span><br>glr<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## &lt;GraphLearner:randomForest&gt;</span><br><span>## * Model: -</span><br><span>## * Parameters: encode.method=one-hot, imputeoor.min=TRUE,</span><br><span>##   imputeoor.offset=1, imputeoor.multiplier=1,</span><br><span>##   classif.ranger.num.threads=1</span><br><span>## * Packages: mlr3, mlr3pipelines, stats, mlr3learners, ranger</span><br><span>## * Predict Types:  response, [prob]</span><br><span>## * Feature Types: logical, integer, numeric, character, factor, ordered,</span><br><span>##   POSIXct</span><br><span>## * Properties: featureless, hotstart_backward, hotstart_forward,</span><br><span>##   importance, loglik, missings, multiclass, oob_error,</span><br><span>##   selected_features, twoclass, weights</span><br></code></pre><p data-tool="mdnice编辑器">这个方法和<code>tidymodels</code>中的工作流的概念如出一辙，简直是一模一样，二者结合起来非常好理解而且容易记忆！工作流的概念可参考：<a href="https://mp.weixin.qq.com/s?__biz=MzUzOTQzNzU0NA==&amp;mid=2247498288&amp;idx=1&amp;sn=2ac77e29b3803a0a50d4edd6393248cd&amp;scene=21#wechat_redirect" data-linktype="2">tidymodels工作流：workflow</a></p><p data-tool="mdnice编辑器">查看可以调节的超参数：</p><pre data-tool="mdnice编辑器"><code>glr$param_set<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## &lt;ParamSetCollection&gt;</span><br><span>##                                              id    class lower upper nlevels</span><br><span>##  1:                        classif.ranger.alpha ParamDbl  -Inf   Inf     Inf</span><br><span>##  2:       classif.ranger.always.split.variables ParamUty    NA    NA     Inf</span><br><span>##  3:                classif.ranger.class.weights ParamUty    NA    NA     Inf</span><br><span>##  4:                      classif.ranger.holdout ParamLgl    NA    NA       2</span><br><span>##  5:                   classif.ranger.importance ParamFct    NA    NA       4</span><br><span>##  6:                   classif.ranger.keep.inbag ParamLgl    NA    NA       2</span><br><span>##  7:                    classif.ranger.max.depth ParamInt     0   Inf     Inf</span><br><span>##  8:                   classif.ranger.min.bucket ParamInt     1   Inf     Inf</span><br><span>##  9:                classif.ranger.min.node.size ParamInt     1   Inf     Inf</span><br><span>## 10:                      classif.ranger.minprop ParamDbl  -Inf   Inf     Inf</span><br><span>## 11:                         classif.ranger.mtry ParamInt     1   Inf     Inf</span><br><span>## 12:                   classif.ranger.mtry.ratio ParamDbl     0     1     Inf</span><br><span>## 13:                   classif.ranger.node.stats ParamLgl    NA    NA       2</span><br><span>## 14:            classif.ranger.num.random.splits ParamInt     1   Inf     Inf</span><br><span>## 15:                  classif.ranger.num.threads ParamInt     1   Inf     Inf</span><br><span>## 16:                    classif.ranger.num.trees ParamInt     1   Inf     Inf</span><br><span>## 17:                    classif.ranger.oob.error ParamLgl    NA    NA       2</span><br><span>## 18:        classif.ranger.regularization.factor ParamUty    NA    NA     Inf</span><br><span>## 19:      classif.ranger.regularization.usedepth ParamLgl    NA    NA       2</span><br><span>## 20:                      classif.ranger.replace ParamLgl    NA    NA       2</span><br><span>## 21:    classif.ranger.respect.unordered.factors ParamFct    NA    NA       3</span><br><span>## 22:              classif.ranger.sample.fraction ParamDbl     0     1     Inf</span><br><span>## 23:                  classif.ranger.save.memory ParamLgl    NA    NA       2</span><br><span>## 24: classif.ranger.scale.permutation.importance ParamLgl    NA    NA       2</span><br><span>## 25:                    classif.ranger.se.method ParamFct    NA    NA       2</span><br><span>## 26:                         classif.ranger.seed ParamInt  -Inf   Inf     Inf</span><br><span>## 27:         classif.ranger.split.select.weights ParamUty    NA    NA     Inf</span><br><span>## 28:                    classif.ranger.splitrule ParamFct    NA    NA       3</span><br><span>## 29:                      classif.ranger.verbose ParamLgl    NA    NA       2</span><br><span>## 30:                 classif.ranger.write.forest ParamLgl    NA    NA       2</span><br><span>## 31:                       encode.affect_columns ParamUty    NA    NA     Inf</span><br><span>## 32:                               encode.method ParamFct    NA    NA       5</span><br><span>## 33:                    imputeoor.affect_columns ParamUty    NA    NA     Inf</span><br><span>## 34:                               imputeoor.min ParamLgl    NA    NA       2</span><br><span>## 35:                        imputeoor.multiplier ParamDbl     0   Inf     Inf</span><br><span>## 36:                            imputeoor.offset ParamDbl     0   Inf     Inf</span><br><span>##                                              id    class lower upper nlevels</span><br><span>##            default                   parents   value</span><br><span>##  1:            0.5                                  </span><br><span>##  2: &lt;NoDefault[3]&gt;                                  </span><br><span>##  3:                                                 </span><br><span>##  4:          FALSE                                  </span><br><span>##  5: &lt;NoDefault[3]&gt;                                  </span><br><span>##  6:          FALSE                                  </span><br><span>##  7:                                                 </span><br><span>##  8:              1                                  </span><br><span>##  9:                                                 </span><br><span>## 10:            0.1                                  </span><br><span>## 11: &lt;NoDefault[3]&gt;                                  </span><br><span>## 12: &lt;NoDefault[3]&gt;                                  </span><br><span>## 13:          FALSE                                  </span><br><span>## 14:              1  classif.ranger.splitrule        </span><br><span>## 15:              1                                 1</span><br><span>## 16:            500                                  </span><br><span>## 17:           TRUE                                  </span><br><span>## 18:              1                                  </span><br><span>## 19:          FALSE                                  </span><br><span>## 20:           TRUE                                  </span><br><span>## 21:         ignore                                  </span><br><span>## 22: &lt;NoDefault[3]&gt;                                  </span><br><span>## 23:          FALSE                                  </span><br><span>## 24:          FALSE classif.ranger.importance        </span><br><span>## 25:        infjack                                  </span><br><span>## 26:                                                 </span><br><span>## 27:                                                 </span><br><span>## 28:           gini                                  </span><br><span>## 29:           TRUE                                  </span><br><span>## 30:           TRUE                                  </span><br><span>## 31:  &lt;Selector[1]&gt;                                  </span><br><span>## 32: &lt;NoDefault[3]&gt;                           one-hot</span><br><span>## 33: &lt;NoDefault[3]&gt;                                  </span><br><span>## 34: &lt;NoDefault[3]&gt;                              TRUE</span><br><span>## 35: &lt;NoDefault[3]&gt;                                 1</span><br><span>## 36: &lt;NoDefault[3]&gt;                                 1</span><br><span>##            default                   parents   value</span><br></code></pre><p data-tool="mdnice编辑器">当把预处理步骤和学习器连接在一起时,因为有些预处理步骤也是有超参数的,所以此时<code>mlr3</code>会在超参数前面加上不同的前缀,方便区分是学习器的超参数还是预处理步骤的超参数.缺点就是参数的名字真的好长......</p><p data-tool="mdnice编辑器">选择超参数网格：</p><pre data-tool="mdnice编辑器"><code>search_space &lt;- ps(<br>  classif.ranger.max.depth = p_int(lower = <span>3</span>,upper = <span>10</span>),<br>  classif.ranger.min.node.size = p_int(<span>10</span>,<span>300</span>)<br>)<br>search_space<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## &lt;ParamSet&gt;</span><br><span>##                              id    class lower upper nlevels        default</span><br><span>## 1:     classif.ranger.max.depth ParamInt     3    10       8 &lt;NoDefault[3]&gt;</span><br><span>## 2: classif.ranger.min.node.size ParamInt    10   300     291 &lt;NoDefault[3]&gt;</span><br><span>##    value</span><br><span>## 1:      </span><br><span>## 2:</span><br></code></pre><p data-tool="mdnice编辑器">进行计算、调参：</p><pre data-tool="mdnice编辑器"><code><span># 加速</span><br><span>library</span>(future)<br>plan(<span>"multisession"</span>,workers=<span>12</span>)<br><br><span># 减少屏幕输出</span><br>lgr::get_logger(<span>"mlr3"</span>)$set_threshold(<span>"warn"</span>)<br>lgr::get_logger(<span>"bbotk"</span>)$set_threshold(<span>"warn"</span>)<br><br>set.seed(<span>123</span>)<br>glr_res &lt;- tune(<br>  tuner = tnr(<span>"grid_search"</span>, resolution = <span>5</span>),<br>  task = tsk(<span>"pima"</span>),<br>  learner = glr,<br>  resampling = rsmp(<span>"holdout"</span>),<br>  measures = msr(<span>"classif.acc"</span>),<br>  terminator = trm(<span>"none"</span>),<br>  search_space = search_space,<br>  store_models = <span>T</span><br>)<br><br><span># 查看最好的超参数</span><br>glr_res$result_learner_param_vals<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## $encode.method</span><br><span>## [1] "one-hot"</span><br><span>## </span><br><span>## $imputeoor.min</span><br><span>## [1] TRUE</span><br><span>## </span><br><span>## $imputeoor.offset</span><br><span>## [1] 1</span><br><span>## </span><br><span>## $imputeoor.multiplier</span><br><span>## [1] 1</span><br><span>## </span><br><span>## $classif.ranger.num.threads</span><br><span>## [1] 1</span><br><span>## </span><br><span>## $classif.ranger.max.depth</span><br><span>## [1] 6</span><br><span>## </span><br><span>## $classif.ranger.min.node.size</span><br><span>## [1] 10</span><br></code></pre><pre data-tool="mdnice编辑器"><code><span># 查看最好的结果和对应的超参数</span><br>as.data.table(glr_res$result)[,c(<span>1</span>,<span>2</span>,<span>5</span>)]<br></code></pre><pre data-tool="mdnice编辑器"><code><span>##    classif.ranger.max.depth classif.ranger.min.node.size classif.acc</span><br><span>## 1:                        6                           10        0.75</span><br></code></pre><pre data-tool="mdnice编辑器"><code><span># 查看每一组超参数的结果</span><br>as.data.table(glr_res$archive$data)[,<span>1</span>:<span>3</span>]<br></code></pre><pre data-tool="mdnice编辑器"><code><span>##     classif.ranger.max.depth classif.ranger.min.node.size classif.acc</span><br><span>##  1:                        3                          155   0.7226562</span><br><span>##  2:                        3                           82   0.7187500</span><br><span>##  3:                       10                           10   0.7343750</span><br><span>##  4:                        4                          300   0.7265625</span><br><span>##  5:                       10                          155   0.7265625</span><br><span>##  6:                       10                           82   0.7304688</span><br><span>##  7:                        3                          300   0.7226562</span><br><span>##  8:                        3                           10   0.7382812</span><br><span>##  9:                        3                          228   0.7187500</span><br><span>## 10:                        8                           10   0.7343750</span><br><span>## 11:                        6                          228   0.7187500</span><br><span>## 12:                        6                           82   0.7460938</span><br><span>## 13:                        4                           10   0.7421875</span><br><span>## 14:                        4                           82   0.7382812</span><br><span>## 15:                        8                           82   0.7460938</span><br><span>## 16:                        4                          155   0.7187500</span><br><span>## 17:                        8                          228   0.7109375</span><br><span>## 18:                        6                          300   0.7265625</span><br><span>## 19:                        8                          155   0.7304688</span><br><span>## 20:                        6                           10   0.7500000</span><br><span>## 21:                        4                          228   0.7109375</span><br><span>## 22:                        6                          155   0.7226562</span><br><span>## 23:                        8                          300   0.7265625</span><br><span>## 24:                       10                          300   0.7304688</span><br><span>## 25:                       10                          228   0.7265625</span><br><span>##     classif.ranger.max.depth classif.ranger.min.node.size classif.acc</span><br></code></pre><p data-tool="mdnice编辑器">可视化调参结果：</p><pre data-tool="mdnice编辑器"><code>autoplot(glr_res,type = <span>"performance"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100017957" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R9HoSn549U9rPsicVx3j3ibTQibOf8iahMAvibpqQbZCwwn5RONuibmezYgspklicVTtOG2UeswYL0nIwMYQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="504" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R9HoSn549U9rPsicVx3j3ibTQibOf8iahMAvibpqQbZCwwn5RONuibmezYgspklicVTtOG2UeswYL0nIwMYQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">把训练好的超参数应用于算法，重新训练、预测：</p><pre data-tool="mdnice编辑器"><code>glr$param_set$values = glr_res$result_learner_param_vals<br>glr$train(tsk(<span>"pima"</span>))$predict(tsk(<span>"pima"</span>))<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## &lt;PredictionClassif&gt; for 768 observations:</span><br><span>##     row_ids truth response   prob.pos  prob.neg</span><br><span>##           1   pos      pos 0.66378828 0.3362117</span><br><span>##           2   neg      neg 0.13229628 0.8677037</span><br><span>##           3   pos      pos 0.64295310 0.3570469</span><br><span>## ---                                            </span><br><span>##         766   neg      neg 0.13735664 0.8626434</span><br><span>##         767   pos      pos 0.51792572 0.4820743</span><br><span>##         768   neg      neg 0.07776001 0.9222400</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>方法2</span><span></span></h2><p data-tool="mdnice编辑器">建立<code>auto_tuner</code>，很强大，以后会经常用！</p><pre data-tool="mdnice编辑器"><code><span># 建立自动调参器</span><br>glr_at &lt;- po(<span>"encode"</span>) %&gt;&gt;% <span>#注意不同的管道符！</span><br>  po(<span>"imputeoor"</span>) %&gt;&gt;%<br>  po(<span>"learner"</span>,lrn(<span>"classif.ranger"</span>,predict_type=<span>"prob"</span>)) %&gt;% <br>  as_learner() %&gt;% <span>#不要忘记这一步哦~</span><br>  auto_tuner(<br>    tuner = tnr(<span>"grid_search"</span>, resolution = <span>5</span>),<br>    learner = .,<br>    resampling = rsmp(<span>"cv"</span>,folds = <span>3</span>),<br>    measure = msr(<span>"classif.acc"</span>),<br>    terminator = trm(<span>"none"</span>),<br>    search_space = search_space,<br>    store_models = <span>T</span><br>  )<br><br><span># 可以改个短一点的名字</span><br>glr_at$id &lt;- <span>"glr_autoTuner"</span><br><br><span># 执行调参</span><br>set.seed(<span>123</span>)<br>at_res &lt;- glr_at$train(tsk(<span>"pima"</span>))<br><br><span># 查看最好的超参数</span><br>at_res$tuning_result$learner_param_vals[[<span>1</span>]]<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## $encode.method</span><br><span>## [1] "one-hot"</span><br><span>## </span><br><span>## $imputeoor.min</span><br><span>## [1] TRUE</span><br><span>## </span><br><span>## $imputeoor.offset</span><br><span>## [1] 1</span><br><span>## </span><br><span>## $imputeoor.multiplier</span><br><span>## [1] 1</span><br><span>## </span><br><span>## $classif.ranger.num.threads</span><br><span>## [1] 1</span><br><span>## </span><br><span>## $classif.ranger.max.depth</span><br><span>## [1] 8</span><br><span>## </span><br><span>## $classif.ranger.min.node.size</span><br><span>## [1] 10</span><br></code></pre><p data-tool="mdnice编辑器">自动调参器虽然牛逼,但是这样就不能使用<code>autoplot</code>直接可视化结果了,当然你还是可以自己提取数据画的.</p><p data-tool="mdnice编辑器">重新建立<code>graph_learner</code>，然后把调好的超参数应用于模型，再次训练、建模：</p><pre data-tool="mdnice编辑器"><code>glr &lt;- po(<span>"encode"</span>) %&gt;&gt;%<br>  po(<span>"imputeoor"</span>) %&gt;&gt;%<br>  po(<span>"learner"</span>,lrn(<span>"classif.ranger"</span>,predict_type=<span>"prob"</span>)) %&gt;% <br>  as_learner()<br><br>glr$param_set$values &lt;- at_res$tuning_result$learner_param_vals[[<span>1</span>]]<br>glr$train(tsk(<span>"pima"</span>))$predict(tsk(<span>"pima"</span>))<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## &lt;PredictionClassif&gt; for 768 observations:</span><br><span>##     row_ids truth response   prob.pos  prob.neg</span><br><span>##           1   pos      pos 0.74703416 0.2529658</span><br><span>##           2   neg      neg 0.10255277 0.8974472</span><br><span>##           3   pos      pos 0.72220748 0.2777925</span><br><span>## ---                                            </span><br><span>##         766   neg      neg 0.10274966 0.8972503</span><br><span>##         767   pos      pos 0.61624926 0.3837507</span><br><span>##         768   neg      neg 0.05230132 0.9476987</span><br></code></pre><p data-tool="mdnice编辑器">以上就是在同时有数据预处理和超参数调优的情况下，进行<code>mlr3</code>调参的基本操作，可以看到再次用到了<code>auto_tuner</code>，真的很好用，以后还会经常用的，大家一定要学会它的用法。</p><p data-tool="mdnice编辑器">但是变为<strong>图学习器</strong>之后使用<code>tune()</code>的方式更加符合R语言中的做法，与<code>tidymodels</code>中的调优方式也很相似，方便记忆，而且还有非常多的可视化选项，我在日常使用中还是更喜欢这种方式。</p><p data-tool="mdnice编辑器">欢迎大家评论区留言或者加入QQ群交流。后台回复<strong>mlr3</strong>即可获取<code>mlr3</code>推文合集.</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/M5SjhiEOmuh8MQ-YrkZ-3A",target="_blank" rel="noopener noreferrer">原文链接</a>
