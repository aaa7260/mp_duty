---
title: "不走寻常路的单细胞表达量矩阵读取"
date: 2024-03-03T07:45:10Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
不走寻常路的单细胞表达量矩阵读取 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>之前在在单细胞天地教程：<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247490226&amp;idx=1&amp;sn=4fb0e8e871478acbd0fbfda504e7fa26&amp;scene=21#wechat_redirect" data-linktype="2">表达矩阵逆转为10X的标准输出3个文件</a>，详细介绍过 <strong>10X技术的单细胞转录组的3个标准文件</strong>，虽然说绝大部分文献提供其数据的时候并不是标准的文件名字，但是3个文件的文件名字还是通常会遵循以下模式：</p></blockquote><ol data-tool="mdnice编辑器"><li><section><strong>Feature / Gene-Barcodes Matrix 文件</strong>：这个文件的命名通常包含了数据类型（例如基因表达量）和文件格式（例如稀疏矩阵）。一般情况下，这个文件名中可能包含 "matrix"、"gene_bc_matrix" 或类似的关键词。有时也会包含数据集的名称或样本编号。</section></li><li><section><strong>Barcode 文件</strong>：这个文件通常命名为 "barcodes" 或者包含 "barcode" 关键词。里面有每个样品里面的每个细胞的标签信息，这个信息其实是无所谓的。</section></li><li><section><strong>Feature / Gene ID 文件</strong>：这个文件通常命名为 "features"、"genes" 或包含 "gene" 关键词。取决于不同版本的cellranger定量结果。</section></li></ol><p data-tool="mdnice编辑器">需要把每个样品都整理成为3个标准文件，文件名字和文件格式如下所示：</p><p><img data-galleryid="" data-imgfileid="100044866" data-ratio="0.35462962962962963" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyJoxhKOuicFvY4gzWx3DIO6ZTnZM6miawoLgm8TqA077kZx1dib5RRzpn0UHACCwgxesBia19eZJ5rAQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyJoxhKOuicFvY4gzWx3DIO6ZTnZM6miawoLgm8TqA077kZx1dib5RRzpn0UHACCwgxesBia19eZJ5rAQ/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>3个标准文件</figcaption></figure><p data-tool="mdnice编辑器">所以很容易批量读取这样的文件，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>dir=<span>'GSE201048_RAW/outputs/'</span><br>samples=list.files( dir )<br>samples <br>sceList = lapply(samples,<span>function</span>(pro){ <br>  <span># pro=samples[1] </span><br>  print(pro)  <br>  tmp = Read10X(file.path(dir,pro )) <br>  <span>if</span>(length(tmp)==<span>2</span>){<br>    ct = tmp[[<span>1</span>]] <br>  }<span>else</span>{ct = tmp}<br>  sce =CreateSeuratObject(counts =  ct ,<br>                          project =  pro  ,<br>                          min.cells = <span>5</span>,<br>                          min.features = <span>300</span> )<br>  <span>return</span>(sce)<br>}) <br></code></pre><p data-tool="mdnice编辑器">也有一些文献给的是txt或者csv格式的，如下所示的文件：</p><pre data-tool="mdnice编辑器"><span></span><code>  10M  7 30  2019 GSM3984317_NO.1.expression_matrix.txt.gz<br>  4.6M  7 30  2019 GSM3984318_NO.2.expression_matrix.txt.gz<br>  5.3M  7 30  2019 GSM3984319_NO.3.expression_matrix.txt.gz<br>  7.3M  7 30  2019 GSM3984322_NO.7.expression_matrix.txt.gz<br>   13M  7 30  2019 GSM3984326_NO.12.expression_matrix.txt.gz<br>  5.0M  7 30  2019 GSM3984330_NO.16.expression_matrix.txt.gz<br>   14M  4 24  2020 GSM4495152_NO.20.expression_matrix.txt.gz<br></code></pre><p data-tool="mdnice编辑器">代码也是很简单的，批量读取，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>dir=<span>'GSE135045_RAW/'</span><br>samples=list.files( dir )<br>samples <br>sceList = lapply(samples,<span>function</span>(pro){ <br>  <span># pro=samples[1] </span><br>  print(pro)  <br>  f= file.path(dir,pro);print(f)<br>  ct &lt;- data.table::fread( f, data.table = <span>F</span>)<br>  ct[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  rownames(ct)=ct[,<span>1</span>]<br>  ct=ct[,-<span>1</span>]<br>  sce &lt;- CreateSeuratObject(ct,project = gsub(<span>'.expression_matrix.txt.gz'</span>,<span>''</span>,pro),<br>                            min.cells = <span>5</span>,<br>                            min.features = <span>500</span>) <span>#后面就可以单细胞处理的标准流程啦</span><br> <br>  <span>return</span>(sce)<br>}) <br>do.call(rbind,lapply(sceList, dim))<br>sce.all=merge(x=sceList[[<span>1</span>]],<br>              y=sceList[ -<span>1</span> ],<br>              add.cell.ids = samples  )  <br>sce.all &lt;- JoinLayers(sce.all) <br></code></pre><p data-tool="mdnice编辑器">但是我看到了一个比较狡猾的数据集（GSE133283），它官网给出来了的文件如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>  32M  6 24  2019 GSM3904816_Adult-1_gene_counts.tsv.gz<br>   32M  6 24  2019 GSM3904817_Adult-2_gene_counts.tsv.gz<br>   33M  6 24  2019 GSM3904818_Adult-3_gene_counts.tsv.gz<br>   37M  6 24  2019 GSM3904819_Aged-1_gene_counts.tsv.gz<br>   37M  6 24  2019 GSM3904820_Aged-2_gene_counts.tsv.gz<br>   64M  6 24  2019 GSM3904821_EAE-1_gene_counts.tsv.gz<br>   63M  6 24  2019 GSM3904822_EAE-2_gene_counts.tsv.gz<br>   30M  6 24  2019 GSM3904823_Juvenile-1_gene_counts.tsv.gz<br>   29M  6 24  2019 GSM3904824_Juvenile-2_gene_counts.tsv.gz<br>   44M  6 24  2019 GSM3904825_Juvenile-3_gene_counts.tsv.gz<br>   40M  6 24  2019 GSM3904826_Juvenile-4_gene_counts.tsv.gz<br></code></pre><p data-tool="mdnice编辑器">它看起来是每个样品一个独立的文本文件，但里面并不是行列式的表达量矩阵文件，读入简单肉眼看了看：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt;   f= file.path(dir,pro);print(f)<br>[<span>1</span>] <span>"GSE133283_RAW/GSM3904816_Adult-1_gene_counts.tsv.gz"</span><br>ct &lt;- data.table::fread( f, data.table = <span>F</span>)<br>&gt;   head(ct)<br>           gene             cell count<br><span>1</span> 0610005C13Rik AACCGCGTCCGTTGCT     <span>1</span><br><span>2</span> 0610005C13Rik ATTATCCAGTTGTCGT     <span>1</span><br><span>3</span> 0610005C13Rik CAGTAACAGCAGCCTC     <span>1</span><br><span>4</span> 0610005C13Rik CATCGAAGTAGCGTAG     <span>1</span><br><span>5</span> 0610005C13Rik CCACTACTCACATGCA     <span>1</span><br><span>6</span> 0610005C13Rik CCTAAAGCAAGTAATG     <span>1</span><br>&gt;   ct[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>Error <span>in</span> `[.data.frame`(ct, <span>1</span>:<span>4</span>, <span>1</span>:<span>4</span>) : undefined columns selected <br>&gt;   dim(ct)<br>[<span>1</span>] <span>6182813</span>       <span>3</span><br></code></pre><p data-tool="mdnice编辑器">是稀疏矩阵的简化版，我略微思考了一下，做了一个简单的变幻：</p><pre data-tool="mdnice编辑器"><span></span><code>  library(reshape2)<br>  tmp = dcast(ct,gene~cell)<br>  tmp[1:4,1:4]<br></code></pre><p data-tool="mdnice编辑器">可以看到，很多NA，其实就是单细胞转录组里面的0值，需要替换一下：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt;   tmp[1:4,1:4]<br>           gene AAACCTGAGATGTGTA AAACCTGAGGTACTCT AAACCTGAGTGTTAGA<br>1 0610005C13Rik               NA               NA               NA<br>2 0610007N19Rik               NA               NA               NA<br>3 0610007P14Rik                1                2               NA<br>4 0610009B14Rik               NA               NA               NA<br>&gt; dim(tmp)<br>[1] 21892  3664<br></code></pre><p data-tool="mdnice编辑器">这个时候我们可以借助于r编程语言里面的reshape2包的dcast函数进行数据转换，在 R 语言中，<code>reshape2</code> 包提供了 <code>dcast()</code> 函数，用于将数据框从长格式（long format）转换为宽格式（wide format）。长格式数据通常包含多行和少列，每行对应一个观察值，并且包含一个用于标识不同组的变量；而宽格式数据通常包含少行和多列，每行对应一个唯一的标识符，并且包含多个变量。最后的完整的代码是：</p><pre data-tool="mdnice编辑器"><span></span><code>dir=<span>'GSE133283_RAW'</span><br>samples=list.files( dir )<br>samples <br>sceList = lapply(samples,<span>function</span>(pro){ <br>  <span># pro=samples[1] </span><br>  print(pro)  <br>  f= file.path(dir,pro);print(f)<br>  ct &lt;- data.table::fread( f, data.table = <span>F</span>)<br>  head(ct)<br>  dim(ct)<br>  <span>#ct[1:4,1:4]</span><br>  <span>library</span>(reshape2)<br>  tmp = dcast(ct,gene~cell)<br>  tmp[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>  ct = tmp<br>  rownames(ct)=ct[,<span>1</span>]<br>  ct=ct[,-<span>1</span>]<br>  ct[is.na(ct)]=<span>0</span><br>  sce &lt;- CreateSeuratObject(ct,project = gsub(<span>'_gene_counts.tsv.gz'</span>,<span>''</span>,pro),<br>                            min.cells = <span>5</span>,<br>                            min.features = <span>500</span>) <span>#后面就可以单细胞处理的标准流程啦</span><br>  <br>  <span>return</span>(sce)<br>}) <br><br></code></pre><p data-tool="mdnice编辑器">有了这个seurat的对象，后面就是我们常规的！代码在：（链接: https://pan.baidu.com/s/1pKEnPmWXi-pTab0WZUWzgg?pwd=a7s1） 相信大家很容易跟着去复现一次！</p><h3 data-tool="mdnice编辑器"><span></span><span>学徒作业</span><span></span></h3><p data-tool="mdnice编辑器">这个狡猾的数据集（GSE133283）对应的文章是：《Single-cell transcriptomics reveals functionally specialized vascular endothelium in brain》，文献里面的第一层次降维聚类分群如下所示：</p><p><img data-galleryid="" data-imgfileid="100044867" data-ratio="0.8712962962962963" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyJoxhKOuicFvY4gzWx3DIO6Ql1DBsPgUfowYpww51MJA23ggC5DiaIkyFvvw43Y07ucxj4XuWSbUrQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyJoxhKOuicFvY4gzWx3DIO6Ql1DBsPgUfowYpww51MJA23ggC5DiaIkyFvvw43Y07ucxj4XuWSbUrQ/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>第一层次降维聚类分群</figcaption></figure><p data-tool="mdnice编辑器"><strong>可以仔细看看文章里面的降维聚类分群参数，反正我使用标准代码跑了一下，没有文章那么清晰</strong>，不过我也解释过，这个肉眼可视化其实并没有那么重要，不影响分群后的各个亚群的生物学意义即可。</p><p><img data-galleryid="" data-imgfileid="100044868" data-ratio="1.0666666666666667" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyJoxhKOuicFvY4gzWx3DIO6ib8x02YeMWetoIQ8qiat4VXJjwfU4m70Nj5AsalgqOGbia04AmoKBfuMA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyJoxhKOuicFvY4gzWx3DIO6ib8x02YeMWetoIQ8qiat4VXJjwfU4m70Nj5AsalgqOGbia04AmoKBfuMA/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>没有文章那么清晰</figcaption></figure></section><h4 data-tool="mdnice编辑器">文末友情宣传</h4><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528328&amp;idx=1&amp;sn=33055906f1dca6958238a84b48405cd5&amp;chksm=9b4b2f33ac3ca6255cdf3d9e1422c6610aebd2fdece36ea0bd9d1cf838cbf1521b599ae81abe&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授‍课（买一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528133&amp;idx=1&amp;sn=2fc6bf3e8455222628c9814d6509c74f&amp;chksm=9b4b2e7eac3ca7687d2f12b37fa48bfe1b060b3c204df87dbf6e277321cfaeb8f5e4d283ca1e&amp;scene=21#wechat_redirect" textvalue="月薪两万找生信练习生（线下）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">月薪两万找生信练习生（线下）</a><br></section></li><li><section> <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528363&amp;idx=1&amp;sn=5e02f3e9b2e148191e23ebc2c0d780e7&amp;chksm=9b4b2f10ac3ca606c1c4bac8cf112bb9b0f18e3c4262f5f2b8c0dba3bfedf2ba201507247005&amp;scene=21#wechat_redirect" textvalue="2024的共享服务器交个朋友福利价仍然是800" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">2024的共享服务器交个朋友福利价仍然是800</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">千呼万唤始出来的独享生物信息学云服务器</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528144&amp;idx=1&amp;sn=be4d7e542d1077921024c86a4c130f16&amp;chksm=9b4b2e6bac3ca77d87a0ae0c12ae028d10225db19c8d7fb92b1299fa12f572bb769bcd92889b&amp;scene=21#wechat_redirect" textvalue="永久免费的生信进阶培训（线下）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">永久免费的生信进阶培训（线下）</a></section></li></ul><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/5M1AxA6qFNrjsDmYBeSvzQ",target="_blank" rel="noopener noreferrer">原文链接</a>
