---
title: "基础复习 | 功能富集分析 ORA"
date: 2024-03-18T13:49:39Z
draft: ["false"]
tags: [
  "fetched",
  "被炸熟的虾"
]
categories: ["Acdemic"]
---
基础复习 | 功能富集分析 ORA by 被炸熟的虾
------
<div><blockquote data-tool="mdnice编辑器"><section><span>在研究中，我们很容易通过各种检测方法获取一系列值得关注的基因列表。</span><span>但一方面，大家不是计算机，确实很难记住所有基因的功能，另一方面生物功能的执行往往涉及多个基因或蛋白的相互作用，直接注释会发现大量功能交叠现象，导致分析结果冗余，不利于进一步的精细分析，所以研究人员希望对得到的功能加以过滤和筛选，以便获得更有意义的功能信息。</span><span>这时最常听到的语句就是“你去做一下富集”——功能富集分析。</span><br></section></blockquote><section><span md-inline="plain">科学研究中，“富集”（enrichment）通常指使用某种方法使目的物质占比增加，如富集某种细胞或蛋白。功能富集分析可理解为</span><span>分析一组基因在某个功能结点上是否过出现(over-presentation)，从而找到与该基因集显著相关的功能类别，进而推出样本间重要的功能差异</span><span md-inline="plain">。ORA常用的统计方法有<strong>累计超几何分布、Fisher精确检验</strong>等。</span></section><section><span md-inline="plain">虽然现在已经有了太多好用的工具——</span><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzkwNDQwMDI5NQ==&amp;mid=2247485584&amp;idx=1&amp;sn=fe72ec1999b3bb50a1f89112f8e109a8&amp;chksm=c086d458f7f15d4eebb202d373362e2112ad7ead3dc82293fbb54ec5c7ab5a2ca818e392e67f&amp;token=1646044072&amp;lang=zh_CN&amp;scene=21#wechat_redirect" textvalue="记录 8 种常见的基因功能富集在线工具" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2"><strong><span>记录 8 种常见的基因功能富集在线工具</span></strong></a>，但是还是想理解一下原理<img data-ratio="1" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Sick.png" data-w="128" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Sick.png"></section><section><span md-inline="plain"></span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span>1、超几何检验</span></h2></section><section><span md-inline="plain">核心原理可以简述为：如果我们的基因集（几十个或者几百个）是随机抽取的，那么它在某个特定功能类别（例如KEGG的某条通路）中的富集情况应该是符合期望的。期望值是基于全部的基因的分布来计算的。比方说，我们通过差异分析或者其它分析拿到了200个基因，全部功能基因约有2万个，而且我们关注的某个特定功能类别（比如细胞增殖这个通路）包括100个基因。如果我们的抽取是随机的，我们预期在这个抽样中有多少基因属于我们关注的功能类别呢？如果我们拿到了的200个基因里面有10个是细胞增殖这个通路里面的，这种情况发生的概率如何？如果这种可能性很低，那么我们就认为我们观察到的富集情况是显著的，而不太可能是随机发生的。</span></section><section><span md-inline="plain">不太好理解，我们把它类比到我们学习超几何分布检验时用到的经典的</span><span md-inline="strong"><strong>“摸球”问题</strong></span><span md-inline="plain">上来：</span><span></span></section><section><img data-galleryid="" data-imgfileid="100003013" data-ratio="0.6035911602209945" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3J1g110LeIsq20ZicJJEImxb7x6xPIic41UZdWv9SCwTtyfMMcYIdx3ToHJic5E6DIr5LAq9jvMY5qcg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="724" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3J1g110LeIsq20ZicJJEImxb7x6xPIic41UZdWv9SCwTtyfMMcYIdx3ToHJic5E6DIr5LAq9jvMY5qcg/640?wx_fmt=png&amp;from=appmsg"></section><section><span md-inline="plain">袋子中共有黑球和红球N个，其中红球M个。小明进行了一次摸球（<span>绿色圆圈），</span>一共摸球n个，其中红球k个，问这次摸球能否说明小明“擅长”摸出红球？换句话说，本次摸球红球的占比是否</span><span md-inline="strong"><strong>显著</strong></span><span md-inline="plain">高于袋子中红球的占比？<img data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/Expression/Expression_9@2x.png" data-ratio="1" data-w="128" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/Expression/Expression_9@2x.png"><img data-ratio="1" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/Expression/Expression_9@2x.png" data-w="128" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/Expression/Expression_9@2x.png"></span></section><section><span md-inline="plain"><br></span></section><section><span md-inline="plain">把小球换成病人：假设总共有29个人，其中11个吸烟者，18个非吸烟者；发现<span>16个</span><span>肺</span><span>癌病人</span>中有10个是吸烟者<span>，用venn图表示为：</span></span></section><section><img data-galleryid="" data-imgfileid="100003016" data-ratio="0.6567425569176882" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3J1g110LeIsq20ZicJJEImxblbE0NMqo4vUAucuGCDkF1TlB35EgleN40ywX6Ay3aeBlkMINXStb4w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="571" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3J1g110LeIsq20ZicJJEImxblbE0NMqo4vUAucuGCDkF1TlB35EgleN40ywX6Ay3aeBlkMINXStb4w/640?wx_fmt=png&amp;from=appmsg"></section><section><span md-inline="plain"><span>问肺癌病人中<span>观察到的结果是否由随机性导致</span>？</span><span>这就是统计课经典课后习题<img data-ratio="1" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Hurt.png" data-w="128" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Hurt.png"></span></span></section><section><span md-inline="plain"><span><br></span></span></section><section><span md-inline="plain">如果把小球换成基因，就是ORA：蓝色方框中的球是所有的基因【共N个】，在探究某个特定通路P时，通路里面涉及到的基因用红色表示【共M个】。绿色圆圈是一次ORA分析，例如做了一次差异分析得到的基因【共n个】，这些基因中，有属于通路P的(红色球)【共k个】，有不属于的(黑色球)。</span><strong><span>问这次分析结果中，通路P的基因占比是否显著过高？</span></strong></section><h4 cid="n11" mdtype="heading"><span><strong><span>超几何分布实现</span></strong></span></h4><p><span md-inline="plain">        既然明白了检验原理，下面就是如何计算显著性统计值的问题。抄一段教科书——</span><span md-inline="plain">超几何分布描述的是从一个总体中抽取有限个物件而</span><span md-inline="strong"><strong>不放回</strong></span><span md-inline="plain">的情况下，抽取的样本中包含指定类别的物件的数量的概率分布。在超几何分布中，总体包含两种不同类型的元素，分别称为“成功”和“失败”，而样本的大小是固定的。超几何分布的参数包括：</span></p><ol cid="n257" mdtype="list"><li><p><span md-inline="strong"><strong>总体大小（N）</strong></span><span md-inline="plain">：总体中元素的总数量，即总体大小。</span></p></li><li><p><span md-inline="strong"><strong>总体中成功的元素个数（M）</strong></span><span md-inline="plain">：总体中具有成功属性的元素的数量，也称为总体中成功元素的个数。</span></p></li><li><p><span md-inline="strong"><strong>抽取的样本大小（n）</strong></span><span md-inline="plain">：每次从总体中抽取的样本数量，也称为样本大小。</span></p></li><li><p><span md-inline="strong"><strong>成功的次数（k）</strong></span><span md-inline="plain">：在抽取的样本中，成功元素出现的次数，即成功的次数。</span></p></li></ol><section><span md-inline="plain">在R语言中，可以使用</span><code>phyper</code><span md-inline="plain">函数来进行超几何分布的计算：</span></section><pre><code>N &lt;- <span>1000</span><br>M &lt;- <span>200</span><br>n &lt;- <span>50</span><br>k &lt;- <span>10</span><br><span># 计算超几何分布的p值</span><br>p_value &lt;- <span>1</span> - phyper(k - <span>1</span>, M, N - M, n)<br><span>#p_value &lt;- phyper(x - 1, K, N - K, n, lower.tail = FALSE)</span><br></code></pre><p><span md-inline="plain">就是说，对于ORA我们只需要知道以下数据就可以推算出显著性p值：</span></p><ul cid="n281" mdtype="list" data-mark="-"><li><section><span md-inline="strong"><strong>目标通路包含的基因数目；</strong></span></section></li><li><p><span md-inline="strong"><strong>背景基因数目：</strong></span><span md-inline="plain">一个物种所有得到注释（GO或KEGG等）的全部基因数量；</span></p></li><li><p><span md-inline="strong"><strong>待分析基因集数目：</strong>输入基因列表中存在功能注释的基因数量；</span><span>一些基因在背景集，例如GO/KEGG中缺乏基础注释，这些基因将在计算前被删除。</span></p></li><li><p><span md-inline="strong"><strong>待分析基因集中包含在目标通路中的基因数量</strong></span></p></li></ul><section><code>clusterProfiler</code><span md-inline="plain">是最常用的富集分析R包了，可以看出它的显著性p值基于超几何分布计算：</span></section><p><img data-galleryid="" data-imgfileid="100003015" data-ratio="0.4981481481481482" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3J1g110LeIsq20ZicJJEImxb3fUV4JKbHic3TXicl49mjCfjxxW7ssXiaia4WvvtL8icbVP45ibO5paQmDsw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3J1g110LeIsq20ZicJJEImxb3fUV4JKbHic3TXicl49mjCfjxxW7ssXiaia4WvvtL8icbVP45ibO5paQmDsw/640?wx_fmt=png&amp;from=appmsg"><span></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span>2、fisher精确检验</span></h2></section><p><span md-inline="plain">这个方法大家平时使用频率应该很高了。例如：在人类基因组背景中（总共30,000个基因），有40个基因参与p53信号通路。一个给定的300个基因的列表中有3个属于p53信号通路。</span></p><p><img data-galleryid="" data-imgfileid="100003017" data-ratio="0.30141843971631205" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3J1g110LeIsq20ZicJJEImxb19LJViazu7FBWNwYodZharzgWl6nINYNdTJ2ZqRjbcZoV2sfYRXgFuQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="564" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3J1g110LeIsq20ZicJJEImxb19LJViazu7FBWNwYodZharzgWl6nINYNdTJ2ZqRjbcZoV2sfYRXgFuQ/640?wx_fmt=png&amp;from=appmsg"></p><section><span md-inline="plain"></span></section><pre><code>result &lt;- fisher.test(matrix(c(<span>3</span>,<span>40</span>,<span>297</span>,<span>29940</span>),byrow = <span>T</span>,nrow = <span>2</span>),alternative = <span>"greater"</span>)<br>print(result$p.value)<span>#[1] 0.008868677</span><br></code></pre><section><span md-inline="plain">Fisher Exact P-Value = 0.008 (using 3 instead of 3-1). Since P-Value ≤ 0.01,this user gene list is specifically associated (enriched) in p53 signaling pathway than random chance.</span></section><h2 data-tool="mdnice编辑器"><span><strong><span>疑惑记录</span></strong></span></h2><p><span md-inline="plain">最后，一个疑惑：当我们使用DAVID工具做富集分析时，给出的结果如下</span></p><p><img data-galleryid="" data-imgfileid="100003014" data-ratio="0.2074074074074074" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/dRYYdqiaan3J1g110LeIsq20ZicJJEImxbXARcIibeHvyKw5y3n0cibKLeeBEkZegBEBNExTaK3cc9o739JpLk38WA/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/dRYYdqiaan3J1g110LeIsq20ZicJJEImxbXARcIibeHvyKw5y3n0cibKLeeBEkZegBEBNExTaK3cc9o739JpLk38WA/640?wx_fmt=jpeg&amp;from=appmsg"></p><ul cid="n295" mdtype="list" data-mark="-"><li><p><span md-inline="plain">Count：即List-hits，也就是我们提交gene list中进入BP分类的某Term的数量</span></p></li><li><p><span md-inline="plain">List total：提交gene list中进入BP分类的所有term的总数量</span></p></li><li><p><span md-inline="plain">Pop hits：目前已被注释进入BP分类某Term的gene 数量</span></p></li><li><p><span md-inline="plain">Pop total：目前已被注释进入BP分类的总gene数量</span></p></li></ul><p>利用这些数据反复折腾也没有计算出相同的p值，<strong><span>下文是GPT给的回答</span></strong>，<strong>还是没计算出来，emmm，先记录，再想想<img data-ratio="1" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Sick.png" data-w="128" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Sick.png"><img data-ratio="1" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Sick.png" data-w="128" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Sick.png"></strong></p><hr><section><span></span></section><section><img data-galleryid="" data-imgfileid="100003020" data-ratio="0.12828282828282828" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3J1g110LeIsq20ZicJJEImxb5QHjJ8BL2f1dy0Tt9icPOCPKGupibXaBN9ybZFq05EcunkibNXq38iaewA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="990" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3J1g110LeIsq20ZicJJEImxb5QHjJ8BL2f1dy0Tt9icPOCPKGupibXaBN9ybZFq05EcunkibNXq38iaewA/640?wx_fmt=png&amp;from=appmsg"></section><section><span md-inline="plain">在DAVID中，计算富集分析的p值通常是通过超几何分布或Fisher精确检验来完成的。下面是一个示例代码，展示了如何在R语言中使用</span><code>phyper()</code><span md-inline="plain">函数计算超几何分布的p值，以及使用</span><code>fisher.test()</code><span md-inline="plain">函数进行Fisher精确检验来计算富集分析结果的p值：</span></section><pre><code><span># 输入参数</span><br>Count &lt;- <span>23</span>  <span># 用户提供的基因列表中与特定功能集合中的基因重叠的基因数</span><br>List_total &lt;- <span>348</span>  <span># 用户提供的基因列表中的总基因数</span><br>Pop_hits &lt;- <span>43</span>  <span># 特定功能集合中的基因数</span><br>Pop_total &lt;- <span>8644</span>  <span># 总的基因数</span><br><br><span># 计算超几何分布的p值</span><br>hypergeo_p_value &lt;- phyper(Count - <span>1</span>, Pop_hits, Pop_total - Pop_hits, List_total, lower.tail = <span>FALSE</span>)<br><span># 输出超几何分布的p值</span><br>print(hypergeo_p_value)<span>#[1] 1.839131e-21</span><br><br><span># 进行Fisher精确检验</span><br>fisher_result &lt;- fisher.test(matrix(c(Count, List_total - Count, Pop_hits - Count, <br>                                      Pop_total - Pop_hits - List_total + Count), nrow = <span>2</span>))<br><span># 提取Fisher精确检验的p值</span><br>fisher_p_value &lt;- fisher_result$p.value<br><span># 输出Fisher精确检验的p值</span><br>print(fisher_p_value)<span>#[1] 1.839131e-21</span></code></pre><section><span md-inline="plain"></span></section><section><span md-inline="plain"></span></section><section><span></span></section><p><img data-imgfileid="100002689" data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/1LTeQhNfr8sUH75oYsoDaqjPCTiaukEmS8tWricW7LnLKKfIE9jKBexibqamsrlibaaXmuc2nicaYibfDFBNCmqX5mBw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="341" src="https://mmbiz.qpic.cn/sz_mmbiz_png/1LTeQhNfr8sUH75oYsoDaqjPCTiaukEmS8tWricW7LnLKKfIE9jKBexibqamsrlibaaXmuc2nicaYibfDFBNCmqX5mBw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><section><mp-common-profile data-pluginname="mpprofile" data-id="MzkwNDQwMDI5NQ==" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LbwMg7dXzIJdtiaJ3zdgseknLWAwvbggOibN3nhIFAOjnlOn8icDAxT7KQricYXq0JyKJZmVkMHtOQEA/0?wx_fmt=png" data-nickname="被炸熟的虾" data-alias="bio-lobster" data-signature="在湿实验室不务正业的生信学徒" data-from="1"></mp-common-profile></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Kj6F7xEGL1PFYttFwXBL0Q",target="_blank" rel="noopener noreferrer">原文链接</a>
