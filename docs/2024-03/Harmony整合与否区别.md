---
title: "Harmony整合与否区别"
date: 2024-03-08T12:32:12Z
draft: ["false"]
tags: [
  "fetched",
  "生信漫漫学"
]
categories: ["Acdemic"]
---
Harmony整合与否区别 by 生信漫漫学
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span></span><span>写在开头</span><span></span></h3><p data-tool="mdnice编辑器">关于这篇推文，是最近两天学习所得。起源是之前整的一篇单细胞文献解读:<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247520157&amp;idx=1&amp;sn=36b8ec02f5bf6f6b0eb296a62234a93a&amp;scene=21#wechat_redirect" data-linktype="2">人类妇科恶性肿瘤的多组学单细胞景观</a></p><p data-tool="mdnice编辑器">文章对<strong>人类卵巢和子宫内膜肿瘤共计11个样品，进行单细胞RNA-seq和单细胞ATAC-seq分析</strong></p><p data-tool="mdnice编辑器">除了对11个样品数据进行联合分析外，也对两种不同肿瘤的数据进行了单独的分析，其中<strong>子宫内膜癌(EEC)——患者1-5的所有细胞</strong>单细胞亚群聚类情况如下图所示</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100002906" data-ratio="0.5208333333333334" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9b0icRUfPb9Dn50l3p5r86d6iaJJoOIhIatZWDyD2y8PuCvIXQPNhMDfKLcqj9gq4zjOiaUleGbo5iahg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="720" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9b0icRUfPb9Dn50l3p5r86d6iaJJoOIhIatZWDyD2y8PuCvIXQPNhMDfKLcqj9gq4zjOiaUleGbo5iahg/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100002907" data-ratio="0.5183673469387755" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9b0icRUfPb9Dn50l3p5r86d6ITVwhBibESic7uLW8iaaCYPo40sAwpC2jH8liaeY1W4y4HAXbhJk6tLODg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="735" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9b0icRUfPb9Dn50l3p5r86d6ITVwhBibESic7uLW8iaaCYPo40sAwpC2jH8liaeY1W4y4HAXbhJk6tLODg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">曾老师想让我<strong>复现一下子宫内膜癌(EEC)的单细胞数据分析</strong>，因为文章结果提到<strong>EEC肿瘤具有高度的肿瘤内异质性</strong>，所以想<strong>比较一下Harmony整合与否的细胞聚类区别</strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>分析过程</span><span></span></h3><p data-tool="mdnice编辑器">对于<strong>多样品单细胞数据分析基本流程：数据读取、创建seurat对象、数据质控、Harmony整合、降维聚类分群、单细胞亚群命名</strong></p><p data-tool="mdnice编辑器">代码生信技能树公众号多次分享，我这边就不赘述了，Harmony的方法<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247527744&amp;idx=1&amp;sn=f94fa8404079c98a8d8df34870ac6a2c&amp;scene=21#wechat_redirect" data-linktype="2">两种不同的方法实现harmony的多个单细胞整合</a>，一般我会选择自己<strong>跑RunHarmony函数进行整合</strong></p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = F) <br><span>source</span>(<span>'scRNA_scripts/lib.R'</span>)<br><br><span>###### step1:导入数据 ######   </span><br><br>samples=list.files(<span>"./outputs/"</span>)<br>samples<br>dir &lt;- file.path(<span>'./outputs/'</span>,samples)<br>names(dir) &lt;- samples<br><span>#读取数据创建Seurat对象</span><br>counts &lt;- Read10X(data.dir = dir)<br><br>sce.all = CreateSeuratObject(counts,<br>                             min.cells = 5,<br>                             min.features = 300 )<br><br>dim(sce.all)   <span>#查看基因数和细胞总数</span><br>as.data.frame(sce.all@assays<span>$RNA</span><span>$counts</span>[1:10, 1:2])<br>table(sce.all@meta.data<span>$orig</span>.ident)  <span>#查看每个样本的细胞数</span><br>head(sce.all@meta.data)<br><br><span># 分组信息，通常是隐含在文件名，样品名字里面</span><br>sce.all<span>$group</span>=substring(colnames(sce.all),1,8)<br>table(sce.all@meta.data<span>$group</span>)<br>table(sce.all@meta.data<span>$orig</span>.ident)<br><br><br><span>###### step2:QC质控 ######</span><br>dir.create(<span>"./1-QC"</span>)<br>setwd(<span>"./1-QC"</span>)<br><span># 如果过滤的太狠，就需要去修改这个过滤代码</span><br><span>source</span>(<span>'../scRNA_scripts/qc.R'</span>)<br>sce.all.filt = basic_qc(sce.all)<br><span>print</span>(dim(sce.all))<br><span>print</span>(dim(sce.all.filt))<br>setwd(<span>'../'</span>)<br><br><br>sp=<span>'human'</span><br><br><span>###### step3: harmony整合多个单细胞样品 ######</span><br>dir.create(<span>"2-harmony"</span>)<br>getwd()<br>setwd(<span>"2-harmony"</span>)<br><span>source</span>(<span>'../scRNA_scripts/harmony.R'</span>)<br><span># 默认 ScaleData 没有添加"nCount_RNA", "nFeature_RNA"</span><br><span># 默认的</span><br>sce.all.int = run_harmony(sce.all.filt)<br>setwd(<span>'../'</span>)<br><br><span>###### step4: 降维聚类分群和看标记基因库 ######</span><br><br>table(Idents(sce.all.int))<br>table(sce.all.int<span>$seurat_clusters</span>)<br>table(sce.all.int<span>$RNA_snn_res</span>.1) <br><br>getwd()<br>dir.create(<span>'check-by-1'</span>)<br>setwd(<span>'check-by-1'</span>)<br>sel.clust = <span>"RNA_snn_res.1"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br><br><span>#选择pca不展示harmony过程</span><br>sce.all.tmp = RunUMAP(sce.all.int, dims = 1:15, <br>                      reduction = <span>"pca"</span>)<br><span>#可视化Harmony前后对比</span><br>DimPlot(sce.all.int,group.by = <span>"orig.ident"</span>) + DimPlot(sce.all.tmp,group.by = <span>"orig.ident"</span>)<br>DimPlot(sce.all.int,group.by = <span>"orig.ident"</span>) + DimPlot(sce.all.int,group.by = <span>"seurat_clusters"</span>) <br>DimPlot(sce.all.tmp,group.by = <span>"orig.ident"</span>) + DimPlot(sce.all.tmp,group.by = <span>"seurat_clusters"</span>)<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100002909" data-ratio="0.7284991568296796" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9b0icRUfPb9Dn50l3p5r86d6N5icJNOWd9gX0fhEqsYnRlvzPwsVlGqkM78vGSs3QGAMZWHM7NAhjDQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1779" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9b0icRUfPb9Dn50l3p5r86d6N5icJNOWd9gX0fhEqsYnRlvzPwsVlGqkM78vGSs3QGAMZWHM7NAhjDQ/640?wx_fmt=png&amp;from=appmsg"><figcaption>Harmony与否</figcaption></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100002910" data-ratio="0.6220886551465064" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9b0icRUfPb9Dn50l3p5r86d6TWCrJrEQMNEo4xUU5dFia3xrkiaw1tb1tXQW9B3pms4F3jaq52BhWicGw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1331" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9b0icRUfPb9Dn50l3p5r86d6TWCrJrEQMNEo4xUU5dFia3xrkiaw1tb1tXQW9B3pms4F3jaq52BhWicGw/640?wx_fmt=png&amp;from=appmsg"><figcaption>Harmony结果</figcaption></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100002908" data-ratio="0.6164179104477612" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9b0icRUfPb9Dn50l3p5r86d6SibiaDg0XpuBS8m4D3MCbl6GcK8l5CqfC4EfHvMjtkPWicTohfouVVBEQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1340" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9b0icRUfPb9Dn50l3p5r86d6SibiaDg0XpuBS8m4D3MCbl6GcK8l5CqfC4EfHvMjtkPWicTohfouVVBEQ/640?wx_fmt=png&amp;from=appmsg"><figcaption>不运行Harmony</figcaption></figure><p data-tool="mdnice编辑器"><strong>简单粗略的可以看到一些区别，比如不运行Harmony，同样的resolution会多三个分群。</strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>关于Harmony学习与思考</span><span></span></h3><p data-tool="mdnice编辑器">因为需要理解一下Harmony的意义，所以找了一些推文进行学习：</p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515454&amp;idx=1&amp;sn=9baf3f82940d8cb2685bc140122fb686&amp;scene=21#wechat_redirect" data-linktype="2">harmony、不harmony，这是个问题</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247504115&amp;idx=1&amp;sn=b6a7bc2e6e2298db1f7313e84d124f04&amp;scene=21#wechat_redirect" data-linktype="2">细胞亚群细分的时候仍然是要选择harmony等算法去除样品差异</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247504128&amp;idx=2&amp;sn=d58835f55a32b328b4a31f5d3164979e&amp;scene=21#wechat_redirect" data-linktype="2">使用harmony等算法去除单细胞样品差异得谨慎</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=Mzg2MTExNTkwNA==&amp;mid=2247521267&amp;idx=1&amp;sn=ab263c62c19c08c21197475bdee2317e&amp;scene=21#wechat_redirect" data-linktype="2">单细胞 | 多样本整合-harmony去批次</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzIyMzMwNDQ2MA==&amp;mid=2247483819&amp;idx=1&amp;sn=a00ca8b3aeb62246b28f4d362a44e349&amp;scene=21#wechat_redirect" data-linktype="2">单细胞转录组高级分析一：多样本合并与批次校正</a></p><blockquote data-tool="mdnice编辑器"><span></span><p>根据曾老师的指导，有了一点自己的理解（不一定能完整复述正确曾老师的意思hhh，小谢还需要多学习）</p></blockquote><p data-tool="mdnice编辑器"><strong>Harmony的作用及意义：</strong></p><p data-tool="mdnice编辑器">在多个样品进行联合分析，并进行细胞亚群的细分时，除了有样品（个体）之间的差异外，不同的细胞群之间也会存在差异</p><p data-tool="mdnice编辑器">一般病人会有上皮、免疫等细胞亚群，样品之间基本的免疫细胞间差异会较小，而上皮细胞之间会有稍大的差异</p><p data-tool="mdnice编辑器">Harmony整合可以将不同个体之间的差异消除掉，使得不同病人的免疫细胞亚群聚合在一起，同样也会将上皮细胞整合在一起</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100002915" data-ratio="0.38333333333333336" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9b0icRUfPb9Dn50l3p5r86d6vSjUBb90CeJm5kIV02olJq0Wzg0AuS2FzGcgTlbdgnVWhbFLaJkcsA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9b0icRUfPb9Dn50l3p5r86d6vSjUBb90CeJm5kIV02olJq0Wzg0AuS2FzGcgTlbdgnVWhbFLaJkcsA/640?wx_fmt=png&amp;from=appmsg"><figcaption>官方图解</figcaption></figure><p data-tool="mdnice编辑器">但是不同病人上皮细胞群之间的差异是有意义的，因为有些是个体特异的，所以如果要针对这些细胞亚群进行细分，就应该不使用Harmony整合，尽量保持不同样品之间的差异</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>写在结尾</span><span></span></h3><p data-tool="mdnice编辑器">综上就是对Harmony的一些比较粗略的理解，正式学习起来真的发现，每个小知识点都可以进行细化，之前一直就无脑运行代码，跑完Harmony就好。</p><p data-tool="mdnice编辑器">仔细学习起来，才发现还挺难理解的，不过也对文章解析有了新的思考</p><p data-tool="mdnice编辑器">咱就是说还是要<strong>多多理解代码和seurat结构，多总结多思考！</strong></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Va7yOSMnYtSA3sGDxIilxA",target="_blank" rel="noopener noreferrer">原文链接</a>
