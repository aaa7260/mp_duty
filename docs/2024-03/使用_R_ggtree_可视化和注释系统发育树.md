---
title: "使用 R+ggtree 可视化和注释系统发育树"
date: 2024-03-31T23:11:39Z
draft: ["false"]
tags: [
  "fetched",
  "生信七点半"
]
categories: ["Acdemic"]
---
使用 R+ggtree 可视化和注释系统发育树 by 生信七点半
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">本课程展示了如何使用<code>ggtree</code>，这是<code>ggplot2</code>包的扩展，用于可视化和注释系统发育树。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>ggtree包</span><span></span></h3><p data-tool="mdnice编辑器"><code>ggtree</code>是一个R包，扩展了<code>ggplot2</code>以用于可视化和注释系统发育树及其共变量和其他相关数据。它可从Bioconductor获得。Bioconductor是一个项目，提供用于分析和注释各种基因组数据的工具。您可以在这里搜索和浏览Bioconductor包。</p><ul data-tool="mdnice编辑器"><li><section><code>ggtree</code> Bioconductor页面: bioconductor.org/packages/ggtree。</section></li><li><section><code>ggtree</code>主页: guangchuangyu.github.io/ggtree（包含有关包的更多信息、更多文档、美丽图像的图库，以及相关资源的链接）。</section></li><li><section><code>ggtree</code>出版物: Yu, Guangchuang, et al. “ggtree: an r package for visualization and annotation of phylogenetic trees with their covariates and other associated data.” Methods in Ecology and Evolution (2016) DOI:10.1111/2041-210X.12628。</section></li></ul><p data-tool="mdnice编辑器">Bioconductor包通常有很好的文档，以使用说明的形式呈现。查看<code>ggtree</code>的登录页面——在页面中部“文档”标题下有多个针对<code>ggtree</code>不同应用和功能的教程，充满了可运行的示例和解释。</p><p data-tool="mdnice编辑器">就像从CRAN安装的R包一样，您只需要安装一次Bioconductor包（安装说明在这里），然后在每次开始新的R会话时加载它们。首先加载<code>tidyverse</code>包。</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(tidyverse)<br><span>library</span>(ggtree)<br></code></pre><p data-tool="mdnice编辑器">关于被屏蔽的函数的说明：加载<code>ggtree</code>后，浏览一下您看到的一些输出。首次安装<code>ggtree</code>可能需要一段时间，因为<code>ggtree</code>依赖许多其他R包。这些包又可能依赖其他包。当您加载<code>ggtree</code>时，这些都会被加载到您的工作环境中。还请注意以“The following objects are masked from 'package:....”开头的行。这表示<code>ggtree</code>加载了它自己的某些函数，如<code>dplyr</code>的<code>collapse()</code>函数。现在，如果您想使用<code>dplyr</code>的<code>collapse</code>函数，您必须使用这种语法显式调用它：<code>dplyr::collapse()</code>。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>导入树</span><span></span></h3><p data-tool="mdnice编辑器"><code>ggtree</code>是一个在R中用于可视化和注释系统发育树及其相关数据的包，作为<code>ggplot2</code>的扩展。它支持多种文件格式，这允许用户从不同的系统发育分析软件中导入树数据。以下是<code>ggtree</code>支持的一些主要文件格式及其对应的解析函数：</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>支持的文件格式</span><span></span></h3><ul data-tool="mdnice编辑器"><li><section><strong>Newick</strong>: 一种广泛使用的表示树结构的文本格式。</section></li><li><section><strong>Nexus</strong>: 一种包含丰富元数据的复杂格式，常用于进化分析。</section></li><li><section><strong>Phylip</strong>: 另一种用于进化分析数据的格式。</section></li><li><section><strong>Jplace</strong>: 用于存储植物放线菌类基因定位分析结果的文件格式。</section></li><li><section><strong>NHX (New Hampshire eXtended format)</strong>: Newick格式的扩展，允许在树中包含额外的注释信息。</section></li><li><section><strong>BEAST, EPA, HYPHY, PAML, PHYLDOG, pplacer, r8s, RAxML, RevBayes</strong>: <code>ggtree</code>还支持这些系统发育分析软件的输出格式。</section></li></ul><h3 data-tool="mdnice编辑器"><span></span><span></span><span>解析函数</span><span></span></h3><ul data-tool="mdnice编辑器"><li><section><strong>read.tree</strong>: 用于读取Newick文件。</section></li><li><section><strong>read.phylip</strong>: 用于读取Phylip文件。</section></li><li><section><strong>read.jplace</strong>: 用于读取Jplace文件，包括来自EPA和pplacer的输出。</section></li><li><section><strong>read.nhx</strong>: 用于读取NHX文件，包括来自PHYLODOG和RevBayes的输出。</section></li><li><section><strong>read.beast</strong>: 用于解析BEAST软件的输出。</section></li><li><section><strong>read.codeml</strong> 和 <strong>read.codeml_mlc</strong>: 用于解析CODEML软件的rst和mlc文件的输出。</section></li><li><section><strong>read.hyphy</strong>: 用于解析HYPHY软件的输出。</section></li><li><section><strong>read.paml_rst</strong>: 用于解析BASEML和CODEML软件的rst文件的输出。</section></li><li><section><strong>read.r8s</strong>: 用于解析r8s软件的输出。</section></li><li><section><strong>read.raxml</strong>: 用于解析RAxML软件的输出。</section></li></ul><p data-tool="mdnice编辑器">这些解析函数使<code>ggtree</code>能够处理来自不同来源和格式的系统发育树数据，进而允许用户在R中对这些树进行灵活的可视化和注释。<code>ggtree</code>的这些功能特别适合那些需要在系统发育分析中整合多种数据类型和来源信息的研究人员。利用<code>ggtree</code>，用户可以高效地探索系统发育树的结构，标注感兴趣的节点，以及将外部数据映射到树上，从而在生物学研究中获得深入的见解。本节演示了如何使用<code>ggtree</code>包来导入和可视化系统发育树数据。<code>ggtree</code>是基于<code>ggplot2</code>的一个扩展，专门用于系统发育树的可视化和注释。这里首先从导入系统发育树数据开始，展示了如何使用<code>ggtree</code>中的函数来构建和自定义树的基础图表。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>导入系统发育树数据</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(tidyverse)<br><span>library</span>(ggtree)<br><br>tree &lt;- read.tree(<span>"data/tree_newick.nwk"</span>)<br>tree<br></code></pre><p data-tool="mdnice编辑器">这段代码首先加载了<code>tidyverse</code>和<code>ggtree</code>包，然后使用<code>read.tree()</code>函数从Newick格式的文件中导入系统发育树数据。<code>tree</code>对象包含了树的结构信息，但直接展示该对象通常不会提供有用的视觉信息。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>基础树可视化</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 使用ggplot构建基础图形并添加geom_tree图层</span><br>ggplot(tree) + geom_tree() + theme_tree()<br><br><span># 使用ggtree函数的便捷方式</span><br>ggtree(tree)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100005394" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtmyWH0U7zjsoavEicLKdWzGicqhm0Ozk9OANsDLp4tO40EWKz5VUmxLOA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtmyWH0U7zjsoavEicLKdWzGicqhm0Ozk9OANsDLp4tO40EWKz5VUmxLOA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">就像在<code>ggplot2</code>中使用<code>ggplot()</code>函数创建基础画布并通过<code>+geom_???()</code>添加图层一样，在<code>ggtree</code>中，我们可以使用<code>geom_tree()</code>函数添加树图层。<code>ggtree()</code>函数是为了方便使用而设计的，它相当于<code>ggplot(...) + geom_tree() + theme_tree()</code>的快捷方式。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>添加比例尺</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 添加比例尺</span><br>ggtree(tree) + geom_treescale()<br><br><span># 或使用theme_tree2()添加x轴的整体比例尺</span><br>ggtree(tree) + theme_tree2()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100005396" data-ratio="0.7342592592592593" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtLarKRWz88ZqNuwJvItYojH2Z6JPVl9tcssU33VEMaiakADgoTzccicgA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtLarKRWz88ZqNuwJvItYojH2Z6JPVl9tcssU33VEMaiakADgoTzccicgA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">这部分代码展示了如何为树图添加比例尺，以表示遗传变化的量度。默认情况下，绘制的是进化距离或遗传变化显示在x轴上的系统发育图（phylogram）。如果您希望关闭分支长度的缩放并产生一个分类树（cladogram），可以在<code>ggtree()</code>调用中设置<code>branch.length="none"</code>选项。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>自定义树的外观</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 绘制一个分类树，使用粗蓝色点线</span><br>ggtree(tree, branch.length=<span>"none"</span>, color=<span>"blue"</span>, size=<span>2</span>, linetype=<span>3</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100005395" data-ratio="0.674074074074074" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumttuZ5DSzicLx6dicknqf4t8FibxicMjxB2ZTibjZP8wfZeUXyp1wBVuibwx8Q/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumttuZ5DSzicLx6dicknqf4t8FibxicMjxB2ZTibjZP8wfZeUXyp1wBVuibwx8Q/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">此代码段演示了如何使用<code>ggtree</code>自定义树图的外观，例如更改分支的颜色、大小和线型。在这个例子中，通过设置<code>branch.length="none"</code>生成了一个没有分支长度缩放的分类树，并使用蓝色、粗细为2、线型为点线的样式绘制分支。</p><p data-tool="mdnice编辑器">为了完成这些练习，我们将使用<code>ggtree</code>包来创建不同样式的系统发育树。首先，确保你已经加载了<code>ggtree</code>和<code>tidyverse</code>包，并且已经导入了一个系统发育树对象<code>tree</code>。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>练习 1：创建不同布局的系统发育树</span><span></span></h3><h4 data-tool="mdnice编辑器"><span></span><span>创建倾斜的系统发育树</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>ggtree(tree, layout=<span>"slanted"</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>创建圆形的系统发育树</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>ggtree(tree, layout=<span>"circular"</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>创建圆形、未缩放的分类树，使用粗红线</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>ggtree(tree, layout=<span>"circular"</span>, branch.length=<span>"none"</span>) +<br>  geom_treescale(color=<span>"red"</span>, size=<span>2</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>其他树的几何对象</span><span></span></h3><p data-tool="mdnice编辑器">添加额外的层。就像在<code>ggplot2</code>课程中一样，我们可以创建一个图表对象（例如<code>p</code>），来存储<code>ggplot</code>的基础布局，并根据需要添加更多层。下面我们将添加节点和尖端点，并最终标记尖端。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 创建基础图表</span><br>p &lt;- ggtree(tree)<br><br><span># 添加节点点</span><br>p + geom_nodepoint()<br><br><span># 添加尖端点</span><br>p + geom_tippoint()<br><br><span># 标记尖端</span><br>p + geom_tiplab()<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>练习 2：自定义系统发育树的美学特征</span><span></span></h3><p data-tool="mdnice编辑器">按照要求创建具有以下美学特征的系统发育树：</p><ul data-tool="mdnice编辑器"><li><section>尖端标签为紫色</section></li><li><section>紫色菱形尖端点</section></li><li><section>大型半透明黄色节点点</section></li><li><section>添加标题</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span># 创建基础图表并自定义</span><br>p &lt;- ggtree(tree) +<br>  geom_tiplab(color=<span>"purple"</span>) +  <span># 尖端标签为紫色</span><br>  geom_tippoint(shape=<span>18</span>, color=<span>"purple"</span>, size=<span>3</span>) +  <span># 紫色菱形尖端点</span><br>  geom_nodepoint(color=<span>"yellow"</span>, size=<span>5</span>, alpha=<span>0.5</span>) +  <span># 大型半透明黄色节点点</span><br>  ggtitle(<span>"Customized Phylogenetic Tree"</span>)  <span># 添加标题</span><br><br><span># 展示图表</span><br>p<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100005397" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtxRQiaVL7dWrpFUibL6OQmxoVw6Iz4jCtQ3T2t4sHVIldxvXDp2XdPBZQ/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtxRQiaVL7dWrpFUibL6OQmxoVw6Iz4jCtQ3T2t4sHVIldxvXDp2XdPBZQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">在这里，<code>shape=18</code>代表菱形点，<code>size</code>参数控制点的大小，<code>alpha</code>参数控制透明度。这些练习展示了<code>ggtree</code>在系统发育树可视化和自定义中的灵活性和强大功能。树的注释是系统发育分析中一个重要的部分，它可以帮助我们理解树的结构和演化关系。<code>ggtree</code>提供了强大的工具来进行树的注释。<code>geom_tiplab()</code>函数添加了一些基本的注释，但是我们可以进一步进行注释。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>内部节点编号</span><span></span></h3><p data-tool="mdnice编辑器">在深入了解<code>ggtree</code>如何内部处理树结构之前，了解内部节点编号是必要的。<code>ggtree</code>的某些函数，比如用于注释分支的函数，需要指定内部节点编号作为参数。要获取内部节点编号，可以使用<code>geom_text</code>函数，并通过<code>aes(label=node)</code>映射来显示，这里的"label"是树对象内部存储的"节点变量"（可以将其视为<code>gapminder</code>对象内的"continent"变量）。我们还提供<code>hjust</code>选项，以确保标签不会正好位于节点上。</p><pre data-tool="mdnice编辑器"><span></span><code>ggtree(tree) + geom_text(aes(label=node), hjust=-<span>.3</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100005398" data-ratio="0.6833333333333333" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtRKSSnZwDzrfIrP7t7JNZgwVmFTgO4ruomLG4dulkmKYnUDKYDkjUoQ/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtRKSSnZwDzrfIrP7t7JNZgwVmFTgO4ruomLG4dulkmKYnUDKYDkjUoQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">另一种获取内部节点编号的方式是使用<code>MRCA()</code>函数，通过提供一个包含类群名的向量（使用<code>c("taxon1", "taxon2")</code>创建）。该函数将返回输入类群最近共同祖先（MRCA）的节点编号。首先，重新创建绘图，以便您可以选择您想要从中获取MRCA的类群。</p><pre data-tool="mdnice编辑器"><span></span><code>ggtree(tree) + geom_tiplab()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100005400" data-ratio="0.6768518518518518" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumt4fKPNM5S5dBxsTlrN1VYg3LDQ6NibG64klPlNUiamFAwk121fQjsMw7Q/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumt4fKPNM5S5dBxsTlrN1VYg3LDQ6NibG64klPlNUiamFAwk121fQjsMw7Q/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">让我们获取类群C+E和类群G+H的最近共同祖先。我们可以使用<code>MRCA()</code>来获取内部节点编号。之后，回到之前带节点标签的绘图以确认这一点。</p><pre data-tool="mdnice编辑器"><span></span><code>MRCA(tree, tip=c(<span>"C"</span>, <span>"E"</span>))<br><span># 输出可能是：[1] 17</span><br>MRCA(tree, tip=c(<span>"G"</span>, <span>"H"</span>))<br><span># 输出可能是：[1] 21</span><br></code></pre><p data-tool="mdnice编辑器">通过这个过程，我们可以清楚地了解到系统发育树的结构，并且可以根据需要对特定的分支或节点进行注释。这对于突出显示树中的特定演化关系或分支群体特别有用。通过<code>ggtree</code>提供的工具，用户可以以直观和有效的方式探索和呈现他们的系统发育数据。</p><p data-tool="mdnice编辑器">标记分支群（Clades）是在系统发育树注释中的一个重要步骤，它可以帮助我们高亮显示和标注树中特定的演化分支。<code>ggtree</code>提供了<code>geom_cladelabel()</code>函数，用于在选定的分支群上添加一个标签和相应的条形指示，以此来注释所选的分支群。你可以使用内部节点编号来选择分支群，这个编号是连接该分支群中所有分类单元的节点的编号。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>标记特定分支群</span><span></span></h3><p data-tool="mdnice编辑器">下面的代码展示了如何为最近共同祖先在分类单元C和E之间的分支群（内部节点17）添加注释，并将标签设置为红色：</p><pre data-tool="mdnice编辑器"><span></span><code>ggtree(tree) + <br>  geom_cladelabel(node=<span>17</span>, label=<span>"Some random clade"</span>, color=<span>"red"</span>)<br></code></pre><p data-tool="mdnice编辑器">接下来，我们再次添加尖端标签。但你可能会注意到分支群标签和尖端标签之间距离太近了。我们可以通过添加<code>offset</code>参数来调整位置：</p><pre data-tool="mdnice编辑器"><span></span><code>ggtree(tree) + <br>  geom_tiplab() + <br>  geom_cladelabel(node=<span>17</span>, label=<span>"Some random clade"</span>, <br>                  color=<span>"red2"</span>, offset=<span>.8</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>添加另一个分支群标签</span><span></span></h3><p data-tool="mdnice编辑器">现在，我们为连接分类单元G和H的分支群（内部节点21）添加另一个标签：</p><pre data-tool="mdnice编辑器"><span></span><code>ggtree(tree) + <br>  geom_tiplab() + <br>  geom_cladelabel(node=<span>17</span>, label=<span>"Some random clade"</span>, <br>                  color=<span>"red2"</span>, offset=<span>.8</span>) + <br>  geom_cladelabel(node=<span>21</span>, label=<span>"A different clade"</span>, <br>                  color=<span>"blue"</span>, offset=<span>.8</span>)<br></code></pre><p data-tool="mdnice编辑器">如果标签没有很好地对齐或者标签超出了图表的边缘，我们可以通过设置<code>align=TRUE</code>参数让标签对齐，并通过调整图表的x轴范围来确保所有标签都能完整显示：</p><pre data-tool="mdnice编辑器"><span></span><code>ggtree(tree) + <br>  geom_tiplab() + <br>  geom_cladelabel(node=<span>17</span>, label=<span>"Some random clade"</span>, <br>                  color=<span>"red2"</span>, offset=<span>.8</span>, align=<span>TRUE</span>) + <br>  geom_cladelabel(node=<span>21</span>, label=<span>"A different clade"</span>, <br>                  color=<span>"blue"</span>, offset=<span>.8</span>, align=<span>TRUE</span>) + <br>  theme_tree2() + <br>  xlim(<span>0</span>, <span>70</span>) + <br>  theme_tree()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100005402" data-ratio="0.6203703703703703" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtL9bSlibneAvb3j9Up6iaX9Vcib7rTibnL5zCHar0UcLGAEf4YysrdRs1Fw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtL9bSlibneAvb3j9Up6iaX9Vcib7rTibnL5zCHar0UcLGAEf4YysrdRs1Fw/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>使用<code>geom_hilight()</code>高亮整个分支群</span><span></span></h3><p data-tool="mdnice编辑器">另一个选择是使用<code>geom_hilight()</code>函数来高亮整个分支群，这为我们提供了一个更加直观的方式来强调树中的特定部分：</p><pre data-tool="mdnice编辑器"><span></span><code>ggtree(tree) + <br>  geom_tiplab() + <br>  geom_hilight(node=<span>17</span>, fill=<span>"gold"</span>) + <br>  geom_hilight(node=<span>21</span>, fill=<span>"purple"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100005399" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtKYhQGUX9hI0afeUXxySUPibT5ADjbs5ABCs4BYB17YiaObXs9Iic1tZuA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtKYhQGUX9hI0afeUXxySUPibT5ADjbs5ABCs4BYB17YiaObXs9Iic1tZuA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">通过使用<code>ggtree</code>包中的这些功能，我们可以灵活地对系统发育树进行详细的注释和定制，从而使得演化分析的结果更加清晰易懂。为了完成这个练习，我们首先需要确定两组分类单元（B+C和L+J）的最近共同祖先（MRCA）。接着，我们将使用<code>ggtree</code>包来绘制系统发育树，并通过各种<code>geom</code>图层来注释树，以展示演化事件和特定的分支群。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>确定最近共同祖先（MRCA）</span><span></span></h3><p data-tool="mdnice编辑器">首先，使用<code>MRCA()</code>函数找出分类单元B+C和L+J的MRCA：</p><pre data-tool="mdnice编辑器"><span></span><code>MRCA_bc &lt;- MRCA(tree, tip=c(<span>"B"</span>, <span>"C"</span>))<br>MRCA_lj &lt;- MRCA(tree, tip=c(<span>"L"</span>, <span>"J"</span>))<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>绘制和注释树</span><span></span></h3><p data-tool="mdnice编辑器">接下来，绘制树并添加注释：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 绘制树并添加尖端标签</span><br>p &lt;- ggtree(tree) +<br>  geom_tiplab()<br><br><span># 高亮特定分支群</span><br>p &lt;- p + geom_hilight(node=MRCA_bc, fill=<span>"skyblue"</span>) +<br>         geom_hilight(node=MRCA_lj, fill=<span>"lightgreen"</span>)<br><br><span># 添加分支群标签</span><br>p &lt;- p + geom_cladelabel(node=<span>17</span>, label=<span>"Superclade A-E"</span>, <br>                         color=<span>"red"</span>, offset=<span>3</span>, align=<span>TRUE</span>)<br><br><span># 连接特定分类单元</span><br>p &lt;- p + geom_taxalink(<span>"C"</span>, <span>"E"</span>, color=<span>"gray"</span>, linetype=<span>2</span>) +<br>         geom_taxalink(<span>"G"</span>, <span>"J"</span>, color=<span>"gray"</span>, linetype=<span>2</span>, curvature=-<span>.9</span>)<br><br><span># 添加比例尺条</span><br>p &lt;- p + geom_treescale()<br><br><span># 添加标题</span><br>p &lt;- p + ggtitle(<span>"Evolutionary Events on Phylogenetic Tree"</span>)<br><br><span># 改变布局（可选）</span><br><span># p &lt;- ggtree(tree, layout="circular") + ... # 在此处添加前面的所有注释代码</span><br><br><span># 展示图表</span><br>p<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100005401" data-ratio="0.762962962962963" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumticravs9xCBPIeeTKMMnVcmSaw4HxUNR33Kf01JC8iau5OtSNGI8XiajyQ/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumticravs9xCBPIeeTKMMnVcmSaw4HxUNR33Kf01JC8iau5OtSNGI8XiajyQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">这段代码展示了如何使用<code>ggtree</code>包的各种功能来创建一个带有详细注释的系统发育树。通过<code>geom_hilight()</code>我们可以高亮显示特定的分支群；<code>geom_cladelabel()</code>添加分支群标签；<code>geom_taxalink()</code>在特定的分类单元之间绘制连接线，展示可能的演化事件；最后，<code>geom_treescale()</code>添加了比例尺条。你可以根据需要调整<code>offset</code>和<code>align</code>参数以优化标签的位置，并使用<code>ggtitle()</code>添加标题。如果愿意，还可以通过设置<code>layout="circular"</code>在<code>ggtree()</code>函数中改变树的布局为圆形。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>读取数据</span><span></span></h3><p data-tool="mdnice编辑器">在这个高级树注释的部分，我们将使用一组之前发表的数据集，来自Liang et al.的论文："Expansion of genotypic diversity and establishment of 2009 H1N1 pandemic-origin internal genes in pigs in China." 这个数据集包含了76个H3血凝素基因序列，这个谱系包含了猪和人类的流感A病毒。该数据集通过使用BEAST软件进行了重新分析，BEAST能够提供使用分子钟模型推断的有根、时间测量的系统发育树。</p><p data-tool="mdnice编辑器">接下来，我们将导入BEAST输出的系统发育树，并为其添加注释。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 读取BEAST生成的树文件</span><br>tree &lt;- read.beast(<span>"data/flu_tree_beast.tree"</span>)<br></code></pre><p data-tool="mdnice编辑器">数据下载连接：https://4va.github.io/biodatasci/data.html这里使用<code>read.beast()</code>而不是之前用的<code>read.tree()</code>来读取树数据，因为BEAST软件输出的树文件包含了更多与时间相关的信息。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>添加比例尺和调整布局</span><span></span></h3><p data-tool="mdnice编辑器">我们通过设置最新的采样日期<code>mrsd="YYYY-MM-DD"</code>来向<code>ggtree()</code>函数提供信息，这样可以在x轴上显示实际的日期。同时，我们添加比例尺条来表示遗传距离。</p><pre data-tool="mdnice编辑器"><span></span><code>ggtree(tree, mrsd=<span>"2013-01-01"</span>) + <br>  theme_tree2() <br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>添加尖端标签和调整轴范围</span><span></span></h3><p data-tool="mdnice编辑器">为了添加尖端标签并使它们右对齐，同时减少标签连接线的粗细，我们可以使用<code>geom_tiplab()</code>并设置<code>align=TRUE</code>和<code>linesize=.5</code>。为了确保所有的标签都能够适当地显示在图中，我们还需要设置x轴的范围，以展示1990到2020年间的变化。</p><pre data-tool="mdnice编辑器"><span></span><code>ggtree(tree, mrsd=<span>"2013-01-01"</span>) + <br>  theme_tree2() + <br>  geom_tiplab(align=<span>TRUE</span>, linesize=<span>.5</span>) + <br>  xlim(<span>1990</span>, <span>2020</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100005403" data-ratio="1.0166666666666666" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtXMoK7EiaxaZyNJaAxyLic1jCXVHpqfIrnyHTibviaibjdlzWpX4uQN6yTWA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtXMoK7EiaxaZyNJaAxyLic1jCXVHpqfIrnyHTibviaibjdlzWpX4uQN6yTWA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><code>msaplot</code>是<code>ggtree</code>包中的一个函数，它能够将多序列比对（MSA）和系统发育树并排展示，为我们提供了一个直观的方式来查看序列的演化和基因的变异。这种视图尤其有用，当你想要探索特定基因或序列区域在不同物种中是如何变化的时候。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>使用<code>msaplot</code>展示多序列比对和系统发育树</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>msaplot(p=ggtree(tree), fasta=<span>"data/flu_aasequence.fasta"</span>, window=c(<span>150</span>, <span>175</span>))<br></code></pre><p data-tool="mdnice编辑器">在这个例子中，<code>msaplot</code>函数接受一个<code>ggtree()</code>生成的树对象<code>p</code>和一个指向FASTA格式的多序列比对文件的路径<code>fasta</code>。<code>window</code>参数用于指定你想在比对中查看的序列窗口。这里，我们只关注从第150个到第175个氨基酸残基的窗口。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>尝试改变坐标系统</span><span></span></h3><p data-tool="mdnice编辑器">如果你想尝试一些有趣但可能不那么实用的视图，你可以通过在命令的末尾添加<code>+ coord_polar(theta="y")</code>来改变图的坐标系统，将它转换为极坐标系统：</p><pre data-tool="mdnice编辑器"><span></span><code>msaplot(p=ggtree(tree), fasta=<span>"data/flu_aasequence.fasta"</span>, window=c(<span>150</span>, <span>175</span>)) + <br>  coord_polar(theta=<span>"y"</span>)<br></code></pre><p data-tool="mdnice编辑器">这将会将MSA和系统发育树的视图转换为圆形，为你提供一个不同的视角来观察序列的演化。虽然这种视图可能在实际应用中不是很常用，但它提供了一个有趣的方式来探索和展示你的数据。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>更多高级注释</span><span></span></h3><p data-tool="mdnice编辑器"><code>ggtree</code>提供了许多高级功能来注释和定制系统发育树，包括添加额外的数据层、自定义节点和标签的样式，以及与其他生物信息学数据集进行集成。如果你对深入学习<code>ggtree</code>的高级注释功能感兴趣，请查看高级树注释使用说明（vignette）以获取更多信息和示例。这将为你提供更多工具和技巧，以便更有效地利用<code>ggtree</code>来探索和解释你的系统发育数据。</p><p data-tool="mdnice编辑器"><img data-imgfileid="100005407" data-ratio="0.9925925925925926" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtxgSKIaCS0AZoRY92ItK3vOPkurJMH7FWgicIo4C6t2AQ8lAy5X7OMrA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtxgSKIaCS0AZoRY92ItK3vOPkurJMH7FWgicIo4C6t2AQ8lAy5X7OMrA/640?wx_fmt=png&amp;from=appmsg"><code>ggtree</code>不仅允许您一次性绘制一个系统发育树，还可以同时绘制多个树，并且可以用<code>ggplot2</code>常规的方式来对它们进行分面展示。这为比较不同的树提供了一个方便的方法。此外，<code>ggtree</code>还提供了<code>facet_plot()</code>函数，使得可以将系统发育树与其他类型的数据面板并排展示，从而增加了更多数据的上下文理解。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>绘制多个树</span><span></span></h3><p data-tool="mdnice编辑器">以下代码演示了如何生成不同尺寸的随机树，并使用<code>facet_wrap()</code>进行分面展示：</p><pre data-tool="mdnice编辑器"><span></span><code>set.seed(<span>42</span>)<br>trees &lt;- lapply(rep(c(<span>10</span>, <span>25</span>, <span>50</span>, <span>100</span>), <span>3</span>), rtree)<br>class(trees) &lt;- <span>"multiPhylo"</span><br>ggtree(trees) + facet_wrap(~.id, scale=<span>"free"</span>, ncol=<span>4</span>) + ggtitle(<span>"Many trees. Such phylogenetics. Wow."</span>)<br></code></pre><p data-tool="mdnice编辑器"><img data-imgfileid="100005406" data-ratio="0.7314814814814815" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtMeQG03iawdAmib01r1P9aMXrTZT8n7gyhsdbr8PUJHtj3UAduAagz4Yg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtMeQG03iawdAmib01r1P9aMXrTZT8n7gyhsdbr8PUJHtj3UAduAagz4Yg/640?wx_fmt=png&amp;from=appmsg">这段代码生成了10、25、50和100尖端的4棵随机树，每种尺寸重复3次，然后将它们一起绘制并分面展示。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>与其他数据一起绘制树</span><span></span></h3><p data-tool="mdnice编辑器">接下来，我们将看看如何使用<code>facet_plot()</code>函数将系统发育树与其他面板上的自定义数据并排展示：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 生成一个随机树</span><br>tree &lt;- rtree(<span>30</span>)<br><br><span># 创建基础图表</span><br>p &lt;- ggtree(tree)<br><br><span># 生成随机值数据</span><br>d1 &lt;- data.frame(id=tree$tip.label, val=rnorm(<span>30</span>, sd=<span>3</span>))<br><br><span># 添加点状图</span><br>p2 &lt;- facet_plot(p, panel=<span>"dot"</span>, data=d1, geom=geom_point, aes(x=val), color=<span>'red3'</span>)<br><br><span># 生成另一组随机值数据</span><br>d2 &lt;- data.frame(id=tree$tip.label, value = abs(rnorm(<span>30</span>, mean=<span>100</span>, sd=<span>50</span>)))<br><br><span># 添加柱状图</span><br>p3 &lt;- facet_plot(p2, panel=<span>'bar'</span>, data=d2, geom=geom_segment, <br>           aes(x=<span>0</span>, xend=value, y=y, yend=y), size=<span>3</span>, color=<span>'blue4'</span>) <br><br><span># 展示全部图表并添加比例尺条</span><br>p3 + theme_tree2()<br></code></pre><p data-tool="mdnice编辑器"><img data-imgfileid="100005405" data-ratio="0.625" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtmaqYuicYNkDrh3vCcOnEVibqziceNZoj1rfEV4PUwvq6FnHlAXAJzyNzg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtmaqYuicYNkDrh3vCcOnEVibqziceNZoj1rfEV4PUwvq6FnHlAXAJzyNzg/640?wx_fmt=png&amp;from=appmsg">这段代码首先创建了一个30尖端的随机树，然后为每个尖端生成了一些随机值，并使用这些数据创建了点状图和柱状图。这些图表与系统发育树并排展示，提供了一个独特的视角来分析系统发育树上尖端的特性。</p><p data-tool="mdnice编辑器">为了在系统发育树上叠加生物轮廓图像，<code>ggtree</code>提供了一种与<code>phylopic.org</code>资源集成的方法，后者提供了大量生物形象的免费轮廓图像。通过使用<code>phylopic()</code>函数，你可以将这些图像添加到你的系统发育树绘图中，从而提供更多的视觉信息。</p><p data-tool="mdnice编辑器">以下是如何实现这一点的示例：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 读取系统发育树数据</span><br>tree &lt;- read.tree(<span>"data/tree_newick.nwk"</span>)<br><br><span># 使用ggtree绘制树并添加生物轮廓图像</span><br>ggtree(tree) %&gt;%<br>  <span># 在整个图上添加一个革兰氏阴性细菌的轮廓图</span><br>  phylopic(<span>"ba0a446e-18d7-4db9-9937-5adec24721b5"</span>, color=<span>"gold2"</span>, alpha = <span>.25</span>) %&gt;%<br>  <span># 在节点17添加Homo sapiens的轮廓图</span><br>  phylopic(<span>"c089caae-43ef-4e4e-bf26-973dd4cb65c5"</span>, color=<span>"purple3"</span>, alpha = <span>.5</span>, node=<span>17</span>) %&gt;%<br>  <span># 在节点21添加狗的轮廓图</span><br>  phylopic(<span>"6c9cb19d-1d8a-4215-88ba-d49cd4917a5e"</span>, color=<span>"purple3"</span>, alpha = <span>.5</span>, node=<span>21</span>)<br></code></pre><p data-tool="mdnice编辑器"><img data-imgfileid="100005408" data-ratio="0.7796296296296297" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtictNQzPpHbmFSCFnSR1QoHHPmiaYN4xO4ayNSiavVM6O3wLMIMNOYNIYA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/owuibmRdV9sibSefFGNxe1ibT6CiaFJHvumtictNQzPpHbmFSCFnSR1QoHHPmiaYN4xO4ayNSiavVM6O3wLMIMNOYNIYA/640?wx_fmt=png&amp;from=appmsg">在这个例子中，我们首先读取了Newick格式的系统发育树数据。然后，我们使用<code>ggtree()</code>来绘制这棵树，并通过<code>phylopic()</code>函数来添加几个生物轮廓图。每个<code>phylopic()</code>函数调用都指定了一个轮廓图的唯一标识符（可以从<code>phylopic.org</code>获得），颜色和透明度，以及（对于后两个图像）要添加轮廓图的节点编号。</p><p data-tool="mdnice编辑器">这种方法可以使得系统发育树的演示更加直观和生动，特别是在展示特定物种或演化关系的研究中。通过为树的不同部分叠加不同的生物轮廓图，我们可以清楚地展示系统发育树中的演化事件和分类关系。</p><blockquote data-tool="mdnice编辑器"><span></span><p>回复tree_newick.nwk 获取树文件</p></blockquote></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/zalmVPAWDjiYa-K1aOebCQ",target="_blank" rel="noopener noreferrer">原文链接</a>
