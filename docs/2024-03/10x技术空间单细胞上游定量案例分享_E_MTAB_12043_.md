---
title: "10x技术空间单细胞上游定量案例分享（E-MTAB-12043）"
date: 2024-03-07T23:02:42Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
10x技术空间单细胞上游定量案例分享（E-MTAB-12043） by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>前面我们已经分享过一次10x技术空间单细胞上游定量案例，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247519964&amp;idx=1&amp;sn=93af7c5c9e27279b0ddbefafad3ee782&amp;scene=21#wechat_redirect" data-linktype="2">空间单细胞的上游定量流程（spaceranger，10x技术）</a>, 不过这样的分析理论上需要跑四五次才能算是完全掌握。所以我们接下来分享E-MTAB-12043数据集的：</p></blockquote><p data-tool="mdnice编辑器">E-MTAB-12043 是2023年初的数据：《RNA Spatial Sequencing of Colorectal Liver Metastases regarding their Histopathological Growth Patterns》，在线链接可以看：</p><ul data-tool="mdnice编辑器"><li><section>https://www.ebi.ac.uk/biostudies/arrayexpress/studies/E-MTAB-12043</section></li><li><section>https://www.ebi.ac.uk/biostudies/arrayexpress/studies/E-MTAB-12043/sdrf?full=true</section></li></ul><p data-tool="mdnice编辑器">可以看到是6个样品的10x技术空间单细胞，但是有24次双端测序，所以是48个数据文件。而且是很标准的10x技术的空间单细胞转录组：</p><p><img data-galleryid="" data-imgfileid="100044956" data-ratio="0.9737470167064439" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzs6O7DPEN2odY1h1xvsnxjibz8QO2VibeVMxnkqa8yaupwqUhNTdJFehcy7UkWuzyGE0BJT81cao8Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="838" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzs6O7DPEN2odY1h1xvsnxjibz8QO2VibeVMxnkqa8yaupwqUhNTdJFehcy7UkWuzyGE0BJT81cao8Q/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">其中6个图片的路径是：</p><pre data-tool="mdnice编辑器"><span></span><code>https://www.ebi.ac.uk/biostudies/files/E-MTAB-12043/Sample1.tif<br>https://www.ebi.ac.uk/biostudies/files/E-MTAB-12043/Sample3.tif<br>https://www.ebi.ac.uk/biostudies/files/E-MTAB-12043/Sample4.tif<br>https://www.ebi.ac.uk/biostudies/files/E-MTAB-12043/Sample5.tif<br>https://www.ebi.ac.uk/biostudies/files/E-MTAB-12043/Sample6.tif<br>https://www.ebi.ac.uk/biostudies/files/E-MTAB-12043/Sample7.tif<br></code></pre><p data-tool="mdnice编辑器">根据上面的链接很容易下载后可以看到：</p><pre data-tool="mdnice编辑器"><span></span><code>ls -lh *tif|cut -d<span>" "</span> -f 5-<br><br>213M 8月   9  2022 Sample1.tif<br>211M 8月   9  2022 Sample3.tif<br>214M 8月   9  2022 Sample4.tif<br>198M 8月   9  2022 Sample5.tif<br>198M 8月   9  2022 Sample6.tif<br>195M 8月   9  2022 Sample7.tif<br></code></pre><p data-tool="mdnice编辑器">虽然说前些天我们演示了如何下载这个项目的fastq格式的测序数据原始文件，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528470&amp;idx=1&amp;sn=246dfa88fac7c413ca102f2db676a515&amp;scene=21#wechat_redirect" data-linktype="2">aspera的高速下载确实很快吗</a>，但是这个项目似乎是并没有给出来高速下载链接，所以只能说是传统下载方式了。然后是看看每个样品的fq文件，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code> ls -lh *gz|cut -d<span>" "</span> -f 5-<br> <br>1.1G 3月   4 01:14 Sample1_L1_1.fq.gz<br>1.6G 3月   4 01:21 Sample1_L1_2.fq.gz<br>1.2G 3月   4 04:02 Sample1_L2_1.fq.gz<br>1.7G 3月   4 04:07 Sample1_L2_2.fq.gz<br>1.2G 3月   4 02:48 Sample1_L3_1.fq.gz<br>1.8G 3月   4 02:53 Sample1_L3_2.fq.gz<br>1.1G 3月   4 02:56 Sample1_L4_1.fq.gz<br>1.7G 3月   4 03:01 Sample1_L4_2.fq.gz<br><br><br>1.5G 3月   3 22:11 Sample3_L1_1.fq.gz<br>2.2G 3月   3 23:03 Sample3_L1_2.fq.gz<br>1.6G 3月   4 01:48 Sample3_L2_1.fq.gz<br>2.3G 3月   4 01:55 Sample3_L2_2.fq.gz<br>1.6G 3月   4 03:25 Sample3_L3_1.fq.gz<br>2.3G 3月   4 03:31 Sample3_L3_2.fq.gz<br>1.5G 3月   4 02:00 Sample3_L4_1.fq.gz<br>2.3G 3月   4 02:07 Sample3_L4_2.fq.gz<br></code></pre><p data-tool="mdnice编辑器">有了这些文件，就可以开始我们的10x技术空间单细胞上游定量流程啦，从fastq文件开始， 走spaceranger定量流程，详情请见：<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247519964&amp;idx=1&amp;sn=93af7c5c9e27279b0ddbefafad3ee782&amp;scene=21#wechat_redirect" data-linktype="2">空间单细胞的上游定量流程（spaceranger，10x技术）</a>。我们来实战演练，首先是每个样品只需要是有r1和r2即可，并不一定要四个文件或者三个文件哈。但是文件名字一定要符合规则哦！</p><pre data-tool="mdnice编辑器"><span></span><code><span>for</span> file <span>in</span> *_1.fq.gz; <span>do</span> <br>    new_name=$(<span>echo</span> <span>"<span>$file</span>"</span> | sed <span>'s/_L/_S/'</span>| sed <span>'s/_1.fq.gz/_L001_R1_001.fastq.gz/'</span>)<br>    ln  <span>"<span>$file</span>"</span> <span>"<span>$new_name</span>"</span><br><span>done</span><br><br><span>for</span> file <span>in</span> *_2.fq.gz; <span>do</span> <br>    new_name=$(<span>echo</span> <span>"<span>$file</span>"</span> | sed <span>'s/_L/_S/'</span>| sed <span>'s/_2.fq.gz/_L001_R2_001.fastq.gz/'</span>)<br>    ln  <span>"<span>$file</span>"</span> <span>"<span>$new_name</span>"</span><br><span>done</span><br></code></pre><p data-tool="mdnice编辑器">可以看到改名后的如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code> ls -lh *gz|cut -d<span>" "</span> -f 5-<br> <br>1.1G 3月   4 01:14 Sample1_S1_L001_R1_001.fastq.gz<br>1.6G 3月   4 01:21 Sample1_S1_L001_R2_001.fastq.gz<br>1.2G 3月   4 04:02 Sample1_S2_L001_R1_001.fastq.gz<br>1.7G 3月   4 04:07 Sample1_S2_L001_R2_001.fastq.gz<br>1.2G 3月   4 02:48 Sample1_S3_L001_R1_001.fastq.gz<br>1.8G 3月   4 02:53 Sample1_S3_L001_R2_001.fastq.gz<br>1.1G 3月   4 02:56 Sample1_S4_L001_R1_001.fastq.gz<br>1.7G 3月   4 03:01 Sample1_S4_L001_R2_001.fastq.gz<br><br><br>1.5G 3月   3 22:11 Sample3_S1_L001_R1_001.fastq.gz<br>2.2G 3月   3 23:03 Sample3_S1_L001_R2_001.fastq.gz<br>1.6G 3月   4 01:48 Sample3_S2_L001_R1_001.fastq.gz<br>2.3G 3月   4 01:55 Sample3_S2_L001_R2_001.fastq.gz<br>1.6G 3月   4 03:25 Sample3_S3_L001_R1_001.fastq.gz<br>2.3G 3月   4 03:31 Sample3_S3_L001_R2_001.fastq.gz<br>1.5G 3月   4 02:00 Sample3_S4_L001_R1_001.fastq.gz<br>2.3G 3月   4 02:07 Sample3_S4_L001_R2_001.fastq.gz<br></code></pre><p data-tool="mdnice编辑器">写一个脚本文本文件（ run_sapceranger.sh ），如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#! /bin/bash -xe</span><br><span>##</span><br>bin=/home/jmzeng/x10/pipeline/spaceranger-2.1.1/spaceranger<br>db=/home/jmzeng/x10/pipeline/refdata-gex-GRCh38-2020-A<br>ls <span>$bin</span> <span>$db</span> <br>fq_dir=<span>${2}</span><br>/usr/bin/time -v <span>$bin</span> count --id=<span>${1}</span> \<br>--transcriptome=<span>$db</span> \<br>--fastqs=<span>$fq_dir</span> \<br>--sample=<span>${1}</span> \<br>--image=<span>${3}</span> \<br>--unknown-slide visium-1 \<br>--localcores=2 \<br>--localmem=80<br></code></pre><p data-tool="mdnice编辑器">上面的脚本文本文件（ run_sapceranger.sh ），可以接受3个参数，包括样品的fastq格式的测序数据文件前缀，样品的fastq格式的测序数据文件所在的文件夹路径，以及样品的图片。我们来运行第一个样品，就是单个样品跑上面的脚本文本文件（ run_sapceranger.sh ）的代码：</p><pre data-tool="mdnice编辑器"><span></span><code>mkdir rawdata<br>mv *.fastq.gz rawdata/<br><br>nohup bash run_sapceranger.sh  Sample1  \<br>./rawdata    \<br>./Sample1.tif  \ <br>1&gt;log_Sample1.txt 2&gt;&amp;1 &amp;<br></code></pre><p data-tool="mdnice编辑器">我们是多个样品有规则的文件，所以可以写一个批处理：</p><pre data-tool="mdnice编辑器"><span></span><code><span>for</span> i <span>in</span> {1..7}; <span>do</span><br>    nohup bash run_sapceranger.sh <span>"Sample<span>${i}</span>"</span> ./rawdata <span>"./Sample<span>${i}</span>.tif"</span> 1&gt; <span>"log_Sample<span>${i}</span>.txt"</span> 2&gt;&amp;1 &amp;<br><span>done</span><br></code></pre><p data-tool="mdnice编辑器">当然了，这一切代码成功运行的前提是，文件是齐全并且完整的，空间单细胞转录组需要图片和fastq文件哦！这些文件都很大， 所以很容易下载失败，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528470&amp;idx=1&amp;sn=246dfa88fac7c413ca102f2db676a515&amp;scene=21#wechat_redirect" data-linktype="2">aspera的高速下载确实很快吗</a>。我这里也是遇到了4个文件下载失败的问题，我们针对全部的文件进行 gzip  -t 的检验，发现是如下所示的4个文件失败了：</p><pre data-tool="mdnice编辑器"><span></span><code>gzip: Sample1_S1_L001_R1_001.fastq.gz: invalid compressed data--crc error  <br>gzip: Sample7_S2_L001_R2_001.fastq.gz: invalid compressed data--crc error <br>gzip: Sample7_S4_L001_R1_001.fastq.gz: invalid compressed data--crc error <br>gzip: Sample7_S4_L001_R2_001.fastq.gz: invalid compressed data--crc error<br></code></pre><p data-tool="mdnice编辑器">可以查看这失败的4个文件的md5，结果如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>5a0fa0fbed1240bdd976f971ddb0d104  ../rawdata/Sample1_S1_L001_R1_001.fastq.gz<br>dafec34a3c656dca347d7111f45d9488  ../rawdata/Sample7_S2_L001_R2_001.fastq.gz<br>6c88e1c352f1d7816a8c5001f70daeef  ../rawdata/Sample7_S4_L001_R1_001.fastq.gz<br>d1748a4944b6ada9c5fc5ab56f1eebd5  ../rawdata/Sample7_S4_L001_R2_001.fastq.gz<br></code></pre><p data-tool="mdnice编辑器">然后就重新下载了失败的这4个，并且再次查看md5 确实是跟前面的还不一样的，说明这次是有改进的 ：</p><pre data-tool="mdnice编辑器"><span></span><code>0bf310d02e4d00b521a563a9d2c5dde8  patch/Sample1_L1_1.fq.gz<br>28b8c43a0640a1f6c3eaf2b60b1a4879  patch/Sample7_L2_2.fq.gz<br>cf1cff6f03dab2ebf87b32c8fe30e4c6  patch/Sample7_L4_1.fq.gz<br>1777b6d89c6dd4a3f209c4f66580bd95  patch/Sample7_L4_2.fq.gz<br></code></pre><p data-tool="mdnice编辑器">然后针对失败的两个样品，重新跑上面的脚本文本文件（ run_sapceranger.sh ），发现Sample7跑流程仍然是失败的，说明还是有文件不完整，继续进行 gzip  -t 的检验，发现是这个Sample7_S4_L001_R2_001.fastq.gz文件还是有问题，反反复复下载了四次，才最后通过了检验。</p><p data-tool="mdnice编辑器">全部的6个样品跑完了之后，就可以整理他们的输出文件，然后去R里面做后续的分析咯：</p><pre data-tool="mdnice编辑器"><span></span><code>pro_folder=outputs<br>mkdir -p <span>$pro_folder</span><br>ls -lh  <span>$pro_folder</span><br> <br>mkdir -p <span>$pro_folder</span>/html <br>ls */outs/web_summary.html |<span>while</span> <span>read</span> id;<span>do</span> (cp <span>$id</span> <span>$pro_folder</span>/html/<span>${id%%/*}</span>.html );<span>done</span><br><br>mkdir -p <span>$pro_folder</span>/matrix <br>ls -d */outs/spatial   |<span>while</span> <span>read</span> id;<span>do</span> (mkdir -p <span>$pro_folder</span>/matrix/<span>${id%%/*}</span>/; cp -r  <span>$id</span> <span>$pro_folder</span>/matrix/<span>${id%%/*}</span>/; cp <span>${id%%/*}</span>/outs/filtered_feature_bc_matrix.h5 <span>$pro_folder</span>/matrix/<span>${id%%/*}</span>/  );<span>done</span> <br></code></pre><p data-tool="mdnice编辑器">但是文章里面写的是这6个样品，合起来是有两万多个spots，如下所示：</p><p><img data-galleryid="" data-imgfileid="100044955" data-ratio="1.5886363636363636" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzs6O7DPEN2odY1h1xvsnxjLNer8s0iaqicuaiax5J54GgaTiare8Ybb06YlicIBhGL7xCicAePCE6WKGUA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="880" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzs6O7DPEN2odY1h1xvsnxjLNer8s0iaqicuaiax5J54GgaTiare8Ybb06YlicIBhGL7xCicAePCE6WKGUA/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>6个样品，合起来是有两万多个spots</figcaption></figure><p data-tool="mdnice编辑器">我看了看，自己跑出来的结果非常诡异。。。</p></section><p><img data-galleryid="" data-imgfileid="100044957" data-ratio="0.6651270207852193" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzs6O7DPEN2odY1h1xvsnxj0OW566IIMzOzhibDEBfGiaCPFmn8hPiaLbzoR3ibTQjERq5kHmqa1xhhVQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1732" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzs6O7DPEN2odY1h1xvsnxj0OW566IIMzOzhibDEBfGiaCPFmn8hPiaLbzoR3ibTQjERq5kHmqa1xhhVQ/640?wx_fmt=png&amp;from=appmsg"></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">从这两个指标也能看出来诡异的地方就是<strong>这些测序片段都是可以比对到参考基因组，而且在基因坐标里面的，都是在外显子上面，非常合格的</strong>。就是不知道为什么都是Antisense ，不知道是不是软件有什么特殊的参数可以设置：</p><ul data-tool="mdnice编辑器"><li><section>Reads Mapped Confidently to Exonic Regions	96.8%</section></li><li><section>Reads Mapped Antisense to Gene	91.7%</section></li></ul></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/uXS-1cNPfg_2WZq9JdT0DA",target="_blank" rel="noopener noreferrer">原文链接</a>
