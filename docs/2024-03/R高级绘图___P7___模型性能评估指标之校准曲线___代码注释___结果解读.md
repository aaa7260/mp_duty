---
title: "R高级绘图 | P7 | 模型性能评估指标之校准曲线 | 代码注释 + 结果解读"
date: 2024-03-20T00:17:36Z
draft: ["false"]
tags: [
  "fetched",
  "生信小白要知道"
]
categories: ["Acdemic"]
---
R高级绘图 | P7 | 模型性能评估指标之校准曲线 | 代码注释 + 结果解读 by 生信小白要知道
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>新系列 —— <a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NjE1NTc1OA==&amp;action=getalbum&amp;album_id=3305722216473165828&amp;scene=173&amp;subscene=227&amp;sessionid=1706707724&amp;enterid=1706707729&amp;from_msgid=2247486379&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" data-linktype="2">R高级绘图</a>，准备整理所有曾经绘制过的图图和未来需要的图图们的代码！预计这个系列会囊括所有常见图形，只提供<strong>高级绘图代码</strong>，基础绘图主要在 <a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NjE1NTc1OA==&amp;action=getalbum&amp;album_id=3086856425876488196&amp;scene=173&amp;subscene=227&amp;sessionid=1706617263&amp;enterid=1706617619&amp;from_msgid=2247486350&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" data-linktype="2">R语言绘图</a> 系列中进行介绍，这个系列咱们主打：<strong>需要XX图？没问题！来这里！找到你要画的图！点进去！直接复制粘贴RUN！</strong></p><p><strong>更新顺序随机，小伙伴们有急需想要的图图也可以后台告诉我！我给它优先更新！</strong></p></blockquote><h2 data-tool="mdnice编辑器"><span></span><span>校准曲线</span><span></span></h2><p data-tool="mdnice编辑器"><strong>校准曲线（Calibration Curve）</strong>是用于<strong>评估分类模型预测概率</strong>的一种图形工具。它可以帮助我们了解<strong>模型输出的概率与实际观察到的概率之间的关系</strong>。</p><p data-tool="mdnice编辑器">在理想情况下，一个完美的分类器应该能够准确地预测出事件发生的概率。例如，如果一个分类器预测一个事件发生的概率为 0.7，那么在所有预测概率为 0.7 的样本中，大约有 70% 的样本实际上会发生这个事件。这种情况下，校准曲线将是一条对角线，即预测概率等于实际观察概率。</p><p data-tool="mdnice编辑器">然而，实际情况往往并非如此完美。许多分类器的预测概率可能存在偏差，即它们的预测概率与实际观察概率之间存在差异。校准曲线允许我们可视化这种偏差，帮助我们评估分类器的预测性能。</p><p data-tool="mdnice编辑器">下面就是一条校准曲线：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100003483" data-ratio="0.8453703703703703" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLrYicbeaibHCzd97ZelMicqyB6n1lFJXhhibznonLDSNt7ovtauialhpeKOFZcnKX0LPR2TKN3PtEwMTlw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLrYicbeaibHCzd97ZelMicqyB6n1lFJXhhibznonLDSNt7ovtauialhpeKOFZcnKX0LPR2TKN3PtEwMTlw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">校准曲线通常绘制预测概率（横轴）与实际观察概率（纵轴）之间的关系。如果分类器的预测是完美的，那么校准曲线将是一条对角线。如果分类器的预测存在偏差，则校准曲线将偏离对角线。例如，如果分类器倾向于低估事件发生的概率，则校准曲线将位于对角线的下方。</p><p data-tool="mdnice编辑器">通过观察校准曲线，我们可以了解分类器的预测性能，并且可以采取相应的措施来改进模型。</p><h2 data-tool="mdnice编辑器"><span></span><span>绘图代码</span><span></span></h2><p data-tool="mdnice编辑器">一般情况下，绘制ROC曲线、校准曲线等，都是为了评估模型的性能。所以我们在绘制校准曲线前，先用mlr3简单建立了一个模型，大家直接用自己的模型数据套进去即可。</p><blockquote data-tool="mdnice编辑器"><span></span><p>今日份绘图所用到的数据我已经上传到了GitHub，大家可以在公众号后台回复<code>校准曲线</code>，即可获得存放数据的链接。不过我在分享过程中也会把每一步的输入数据和输出结果进行展示，大家可以作为参考并调整自己的数据格式，然后直接用自己的数据跑，也是没有任何问题的！</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span># 加载包，没安装的记得安装一下哟！</span><br><span>library</span>(mlr3verse)<br><span>library</span>(mlr3extralearners)<br><br><span># 加载数据</span><br>train_data &lt;- readRDS(<span>"./train_data.rds"</span>)<br>head(train_data)[<span>1</span>:<span>5</span>, c(<span>1</span>:<span>3</span>, <span>79</span>:<span>81</span>)]<br><span>#                                      BP10MB.0. BP10MB.1. BP10MB.2. BoChr.22. BoChr.23. type</span><br><span># 0040b1b6-b07a-4b6e-90ef-133523eaf412       287        17        17         1         3    0</span><br><span># 00508f2b-36bf-44fc-b66b-97e1f3e40bfa       278         6        14         1         3    0</span><br><span># 005794f1-5a87-45b5-9811-83ddf6924568       314         0         0         0         0    0</span><br><span># 008bad10-d41b-4bbb-86fa-9976ecea46b1       286        12        17         3         1    0</span><br><span># 00b9d0e6-69dc-4345-bffd-ce32880c8eef       318         2         2         0         1    0</span><br><br><span># 数据包含多个变量列和一个分组信息列</span><br><br><span># 将数据转换为mlr3的分类任务</span><br>task_classif = as_task_classif(train_data, target = <span>"type"</span>)<br><br><span># 使用Gradient Boosting Machine (GBM)算法建立分类模型</span><br>gbm_model &lt;- lrn(<span>"classif.gbm"</span>, predict_type = <span>"prob"</span>)<br><br><span># 在训练数据上训练模型</span><br>gbm_model$train(task_classif)<br><br><span># 进行预测</span><br>pred &lt;- gbm_model$predict(task_classif)<br><br><span># 将预测结果与真实标签合并，并对列进行重命名</span><br>merged_data &lt;- bind_cols(pred$prob, pred$truth) %&gt;%<br>  rename(prob0 = `0`,     <span># 将第一个预测概率列重命名为prob0，代表模型预测样本属于类别0的概率。</span><br>         prob1 = `1`,     <span># 将第二个预测概率列重命名为prob1，代表模型预测样本属于类别1的概率。</span><br>         truth = `...3`)  <span># 将真实标签列重命名为truth</span><br><br><span># 将预测概率1的值分为20个区间（具体几个随你定，当然，要合理！），并将真实标签转换为0和1</span><br>processed_data &lt;- merged_data %&gt;%<br>  mutate(pred_cut = cut_interval(prob1, <span>20</span>),<br>         truth = if_else(truth == <span>'1'</span>, <span>1</span>, <span>0</span>))<br><br><span># 按照预测概率1的区间进行分组，计算每个区间的平均预测概率1和平均真实标签</span><br>cc_data &lt;- processed_data %&gt;%<br>  group_by(pred_cut) %&gt;%<br>  summarise(mean_pred = mean(prob1),   <span># 计算平均预测概率1</span><br>            mean_obs = mean(truth),    <span># 计算平均真实标签</span><br>            cnt = n())                 <span># 统计每个区间的样本数量</span><br><br>head(cc_data)<br><span># # A tibble: 6 × 4</span><br><span>#   pred_cut       mean_pred mean_obs   cnt</span><br><span>#   &lt;fct&gt;              &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;</span><br><span># 1 [0.001,0.0505]    0.0102   0.005   1000</span><br><span># 2 (0.0505,0.1]      0.0724   0         27</span><br><span># 3 (0.1,0.15]        0.119    0.0833    24</span><br><span># 4 (0.15,0.199]      0.169    0.125      8</span><br><span># 5 (0.199,0.249]     0.231    0.4        5</span><br><span># 6 (0.249,0.298]     0.271    0          5</span><br><br><span># 绘制校准曲线</span><br>ggplot(cc_data, aes(mean_pred, mean_obs)) +        <span># 设置绘图数据</span><br>  geom_line(linewidth = <span>1</span>, color = <span>'#f29325'</span>) +    <span># 绘制折线，代表校准曲线，设置线宽和颜色</span><br>  geom_point(aes(size = cnt), color = <span>'#025259'</span>) + <span># 绘制点，代表每个区间的样本数量，设置点的大小和颜色</span><br>  geom_abline(linetype = <span>"dashed"</span>, linewidth = <span>1</span>, color = <span>'grey30'</span>) +    <span># 绘制虚线，代表理想的校准曲线，设置线型、线宽和颜色</span><br>  coord_equal() +                                  <span># 设置坐标轴的刻度相等，保证x和y轴等比例</span><br>  labs(title = <span>'Calibration Curve'</span>,                <span># 设置图表标题</span><br>       x = <span>"Predicted Probability"</span>,                <span># 设置x轴标签</span><br>       y = <span>"Observed Probability"</span>) +               <span># 设置y轴标签</span><br>  theme_bw()                                       <span># 设置主题为白色背景，黑色网格线</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100003482" data-ratio="0.8453703703703703" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLrYicbeaibHCzd97ZelMicqyB6n1lFJXhhibznonLDSNt7ovtauialhpeKOFZcnKX0LPR2TKN3PtEwMTlw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLrYicbeaibHCzd97ZelMicqyB6n1lFJXhhibznonLDSNt7ovtauialhpeKOFZcnKX0LPR2TKN3PtEwMTlw/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>文末碎碎念</span><span></span></h2><p data-tool="mdnice编辑器">那今天的分享就到这里啦！我们下期再见哟！</p><p data-tool="mdnice编辑器">最后顺便给自己推荐一下嘿嘿嘿！</p><p data-tool="mdnice编辑器">如果我的分享对你有用的话，欢迎<strong>关注点赞在看转发分享</strong>阿巴阿巴阿巴阿巴巴巴！这可是我的第一原动力！</p><p data-tool="mdnice编辑器">蟹蟹你们的喜欢和支持！！！</p><section><mp-common-profile data-pluginname="mpprofile" data-id="Mzg5NjE1NTc1OA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLpicdicvWNnpcaTbejCVgKe4FsicHqo48FOkqJTkziaengudibCF8AW86uyjgee0pxhmhM8JoylYDkSXug/0?wx_fmt=png" data-nickname="生信小白要知道" data-alias="Bioidiot" data-signature="主打小白保姆级教程，因为自己淋过雨，所以想给大家撑把伞！ 记录从小白到现在小灰的过程，希望以后可以成为小黑！" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><p data-tool="mdnice编辑器">如果小伙伴们有需求的话，可以加入我们的交流群：<a href="https://mp.weixin.qq.com/s?__biz=Mzg5NjE1NTc1OA==&amp;mid=2247487109&amp;idx=1&amp;sn=22862390235151378bdecbf488c7c830&amp;scene=21#wechat_redirect" data-linktype="2">一定要知道 | 永久免费的生信交流群终于来啦！</a>！在这里，你可以稍有克制地畅所欲言！</p><p data-tool="mdnice编辑器">超级建议大家在入群前或入群后可以看一下这个：<a href="https://mp.weixin.qq.com/s?__biz=Mzg5NjE1NTc1OA==&amp;mid=2247486350&amp;idx=1&amp;sn=066dedbe912676f5c508b179167084a0&amp;scene=21#wechat_redirect" data-linktype="2">干货满满 | 给生信小白的入门小建议 | 掏心掏肺版</a>！绝对干货满满！让你不虚此看！</p><p data-tool="mdnice编辑器">如果有需要个性化定制分析服务的小伙伴，可以看看这里：<a href="https://mp.weixin.qq.com/s?__biz=Mzg5NjE1NTc1OA==&amp;mid=2247486984&amp;idx=1&amp;sn=b00b48d15e2e19e206803d3e14f05d23&amp;scene=21#wechat_redirect" data-linktype="2">你要的个性化生信分析服务今天正式开启啦！定制你的专属解决方案！全程1v1答疑！</a>！绝对包你满意！</p><p data-tool="mdnice编辑器">入群链接后续可能会不定期更新，主要是因为群满换码或是其他原因，如果小伙伴点开它之后发现，咦，怎么失效啦！不要慌！咱们辛苦一下动动小手去主页的<code>要咨询</code>那里，点击<code>进交流群</code>即可入群！</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100003481" data-ratio="1.0796296296296297" data-src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLrYicbeaibHCzd97ZelMicqyB6ibWoP2VGSnzibriaYGZaOwlIrsVZmDaxzWk1d6uS5nT5tOX0iawMXjvACg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/QQjtfWKmicLrYicbeaibHCzd97ZelMicqyB6ibWoP2VGSnzibriaYGZaOwlIrsVZmDaxzWk1d6uS5nT5tOX0iawMXjvACg/640?wx_fmt=png&amp;from=appmsg"></figure><h5 data-tool="mdnice编辑器"><span></span><span>参考资料</span><span></span></h5><p data-tool="mdnice编辑器">https://zhuanlan.zhihu.com/p/654728525</p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/_Q7q2fylGAYnju1YO6h-4w",target="_blank" rel="noopener noreferrer">原文链接</a>
