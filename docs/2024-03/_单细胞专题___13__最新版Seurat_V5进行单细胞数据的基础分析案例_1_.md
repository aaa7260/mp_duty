---
title: "​单细胞专题 | 13. 最新版Seurat V5进行单细胞数据的基础分析案例（1）"
date: 2024-03-25T08:01:23Z
draft: ["false"]
tags: [
  "fetched",
  "生物信息云"
]
categories: ["Acdemic"]
---
​单细胞专题 | 13. 最新版Seurat V5进行单细胞数据的基础分析案例（1） by 生物信息云
------
<div><p data-mpa-powered-by="yiban.io"><img data-ratio="0.11875" data-src="https://mmbiz.qpic.cn/mmbiz_gif/dREape4YBzwlE827QdNGgPv5S50JOQrAK6QYEGudEI2gzsmgrp3SUKRWPKH7NPbnft9rfWUyQIsd2A3wmfp0cQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-type="gif" data-w="640" src="https://mmbiz.qpic.cn/mmbiz_gif/dREape4YBzwlE827QdNGgPv5S50JOQrAK6QYEGudEI2gzsmgrp3SUKRWPKH7NPbnft9rfWUyQIsd2A3wmfp0cQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></p><hr><p><img data-ratio="0.25" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/dREape4YBzyF5jVxNCORGgSJRgWqy8hD1vw3aTCTiauBVLErhPNxeAq1Z3p1iaawPViah3KsJ6q4ibys098ibmnjzcQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="jpeg" data-w="600" src="https://mmbiz.qpic.cn/mmbiz_jpg/dREape4YBzyF5jVxNCORGgSJRgWqy8hD1vw3aTCTiauBVLErhPNxeAq1Z3p1iaawPViah3KsJ6q4ibys098ibmnjzcQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p><br></p><p><strong><span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651277403&amp;idx=1&amp;sn=1deef9220392274b9eb7018e764f56a5&amp;chksm=841eac26b3692530adc7a2d611ea00f4fb64eaeb32619cb78ed82553f47e713a1aa038b41f02&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 1.单细胞测序（10×genomics技术）的原理" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">单细胞专题 | 1.单细胞测序（10×genomics技术）的原理</a><br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651277453&amp;idx=1&amp;sn=cda31840d53f64763d84b6e3fde01b2c&amp;chksm=841eacf0b36925e6c453dbdb042cf1a8073f5919868a48e2f661bfda3e53660fe18d92f9969a&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 2.如何开始单细胞RNASeq数据分析" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">单细胞专题 | 2.如何开始单细胞RNASeq数据分析</a><br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651277619&amp;idx=1&amp;sn=59c73d767aed61f01a56a0165aed1061&amp;chksm=841ead4eb36924587ee97e8d109a3cc1d2a6c6cc9d87c729e75d220cae1f63838cce8503d506&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 3.单细胞转录组的上游分析-从BCL到FASTQ" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">单细胞专题 | 3.单细胞转录组的上游分析-从BCL到FASTQ</a><br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651277662&amp;idx=1&amp;sn=1f7abfda069a921b948f2cb00a0b4979&amp;chksm=841ead23b369243565a7f88d378302b509aefff9647b4f684a47269d6c2d374b3b37cf4696f1&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 4.单细胞转录组的上游分析-从SRA到FASTQ" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">单细胞专题 | 4.单细胞转录组的上游分析-从SRA到FASTQ</a><br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651277697&amp;idx=1&amp;sn=059a6f22487e94648d38d45453dff6b6&amp;chksm=841eadfcb36924ea64b3c0fc6e616a8313bf3773977c74db94544032556ab432640554397d85&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 5.单细胞转录组的上游分析-从FASTQ到count矩阵" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">单细胞专题 | 5.单细胞转录组的上游分析-从FASTQ到count矩阵</a><br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651281087&amp;idx=1&amp;sn=b8a375e92b9eae4d9be267004ad3bd95&amp;chksm=841eb2c2b3693bd455a2cacd9776eb421c06d2d710e5806ebb575d825d97fb6208076252d67d&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 6.单细胞下游分析——不同类型的数据读入" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞专题 | 6.单细胞下游分析——不同类型的数据读入</a></span></strong></p><p>无论是新版本还是老版本，前面6篇文章不影响，后面的其实改动也不大。</p><hr><p><strong>本篇文章是修改老版本文章：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651281359&amp;idx=1&amp;sn=8a57694f9110b836ac36da7e4b7c490e&amp;chksm=841eb3b2b3693aa4185cef77f182d3790e111795c5f0845531ccbfc1d92364eeed1f644aeb59&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 7.单细胞下游分析——常规分析流程案例一" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞专题 | 7.单细胞下游分析——常规分析流程案例一</a>，使用Seurat V5进行分析。</strong></p><p><strong><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651281482&amp;idx=1&amp;sn=6780a48b94c9bfb516149bd7dad146cd&amp;chksm=841ebc37b36935215409b43d6a8fbef7b8e4d308c3acac7e90407f9a2211b17fd1262f3817f7&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 8.单细胞类型注释之SingleR包详解" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞专题 | 8.单细胞类型注释之SingleR包详解</a><br></strong><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651281853&amp;idx=1&amp;sn=1a6d0bacaf90835ab91bb834e1157c66&amp;chksm=841ebdc0b36934d632dd29626cdd4ef851d38851430b103ca9416bdff70bcd52bf304af1cc13&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 9.如何人工注释单细胞类群？" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><strong>单细胞专题 | 9.如何人工注释单细胞类群？</strong></a><br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651281937&amp;idx=1&amp;sn=24da259459a657cbde381f262ec02ea1&amp;chksm=841ebe6cb369377ab62eb72c56b2afc1ecdf70ae24869f4f6b7aeb8b3a970e81a17ac361d302&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 10.细胞周期分析" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><strong>单细胞专题 | 10.细胞周期分析</strong></a><br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651283482&amp;idx=1&amp;sn=275e403e6bb59a0d2256502f515bfc38&amp;chksm=841e8467b3690d7187b22c05e4312a2cca5fd583c2ec3a8d4036799aa33367c7c6f999095df9&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 11.最新版cellphoneDB细胞通讯分析" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><strong>单细胞专题 | 11.最新版cellphoneDB细胞通讯分析</strong></a><br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651284115&amp;idx=1&amp;sn=3c470db7efb382ff4353c9d742ca32a2&amp;chksm=841e86eeb3690ff8fcd1745340dfb7d12e87eb4a66cd5ee87b15822ce65184f590a2008100f5&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 12.cellChat细胞通讯代码案例" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2"><strong>单细胞专题 | 12.cellChat细胞通讯代码案例</strong></a></p><hr><p><span><strong><span>1.数据信息</span></strong></span></p><p><span><span><span>在分离CD45阴性和CD45阳性细胞后，收集CD45阴性细胞用于后续的scRNAseq测序。</span></span></span></p><p><span><span><span>https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE130001</span></span></span><span><span><span></span></span></span></p><p><span><span><span>文献：Wang L, Sebra RP, Sfakianos JP, Allette K et al. A reference profile-free deconvolution method to infer cancer cell-intrinsic subtypes and tumor-type-specific stromal profiles. </span></span></span><span><span><span>Genome Med</span></span></span><span><span><span> 2020 Feb 28;12(1):24. PMID: </span></span></span><span><span><span>32111252</span></span></span><span><span><span></span></span></span></p><p><span></span><span><strong><span>2.数据下载</span></strong></span></p><p><span><span><span><shape type="#_x0000_t75" filled="f"><imagedata title="rId23"></imagedata></shape><img data-ratio="0.15178571428571427" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwvk0SjxJUsok468oqfITLuMM8bhf8libtkxvib7OtEPPxIV0pg5T1mAXziaVqfAVBgyF2OSTb0w9k6A/640?wx_fmt=png" data-type="png" data-w="560" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwvk0SjxJUsok468oqfITLuMM8bhf8libtkxvib7OtEPPxIV0pg5T1mAXziaVqfAVBgyF2OSTb0w9k6A/640?wx_fmt=png"></span></span></span><span><span><span></span></span></span></p><p><span>下载解压数据：</span><br></p><p><span><span><span><img data-ratio="0.3875" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwvk0SjxJUsok468oqfITLuUtxiawwib1TqdkwAoEdWUCyEsiab7PoYkbO4nFrrPWUX1Y8SRjUjX4rzw/640?wx_fmt=png" data-type="png" data-w="560" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwvk0SjxJUsok468oqfITLuUtxiawwib1TqdkwAoEdWUCyEsiab7PoYkbO4nFrrPWUX1Y8SRjUjX4rzw/640?wx_fmt=png"></span></span></span></p><p><span></span><span><strong><span>3.数据预处理</span></strong></span></p><p><span><span><span>这里的数据是10X标准输出的3个文件，这三个文件指的是：barcodes.tsv, features.tsv, matrix.mtx。这个情况就比较好处理了，barcodes.tsv就是 cell id，features.tsv就是 gene id，matrix.mtx就是计数 counts 矩阵。但我们需要整理一下文件。因为文件名多了一些信息，需要为每个样本单独建立一个文件夹，然后将该样本3个文件对应的重命名一下就可以了。就如下面是一个样本重命名后的。</span></span></span></p><p><span><span><span><img data-ratio="0.225" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwvk0SjxJUsok468oqfITLuOiak5b0booJPZ7oCKHhZ78xicWa1cuicJMWu4bia1jy9GicrFqIkTerPw8w/640?wx_fmt=png" data-type="png" data-w="560" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwvk0SjxJUsok468oqfITLuOiak5b0booJPZ7oCKHhZ78xicWa1cuicJMWu4bia1jy9GicrFqIkTerPw8w/640?wx_fmt=png"></span></span></span><span><span><span></span></span></span></p><p><span><span><span><br></span></span></span></p><p><span><span><span>当然，可以用代码解决，需要注意文件路径。</span></span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span><span>###============1、准备原始分析数据</span></span></code><code><span>fs = <span>list</span>.files(<span>'./GSE130001_RAW/'</span>,<span>'^GSM'</span>)</span></code><code><span>library(stringr)</span></code><code><span>samples = str_split(fs,<span>'_'</span>,simplify = T)[,<span>1</span>]</span></code><code><span><span># x &lt;- "GSM3729178"</span></span></code><code><span>lapply(unique(samples),<span><span>function</span><span>(x)</span></span>{</span></code><code><span>  y = fs[grepl(x,fs)]</span></code><code><span>  folder = paste0(<span>"GSE130001_RAW/"</span>, x)</span></code><code><span>  dir.create(folder,recursive = T)<span>#为每个样本创建子文件夹</span></span></code><code><span> </span></code><code><span>  <span>#重命名文件，并移动到相应的子文件夹里,注意对应顺序</span></span></code><code><span>  file.rename(paste0(<span>"GSE130001_RAW/"</span>,y[<span>1</span>]),file.path(folder,<span>"barcodes.tsv.gz"</span>))</span></code><code><span>  file.rename(paste0(<span>"GSE130001_RAW/"</span>,y[<span>2</span>]),file.path(folder,<span>"features.tsv.gz"</span>))</span></code><code><span>  file.rename(paste0(<span>"GSE130001_RAW/"</span>,y[<span>3</span>]),file.path(folder,<span>"matrix.mtx.gz"</span>))</span></code><code><span>})</span></code></pre></section><p><span><span><span><img data-ratio="0.425" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwvk0SjxJUsok468oqfITLuRpPn58lWF5YVXN20XepfLb8GuPjKbSaM1rFjzcuB18g8SBdfsUHyUw/640?wx_fmt=png" data-type="png" data-w="560" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwvk0SjxJUsok468oqfITLuRpPn58lWF5YVXN20XepfLb8GuPjKbSaM1rFjzcuB18g8SBdfsUHyUw/640?wx_fmt=png"></span></span></span><span><span><span></span></span></span></p><p><span><span><span><br></span></span></span></p><p><span></span><span><strong><span>4.读入数据创建Seurat对象</span></strong></span></p><p><span><span>这里我们先只考虑一个样本</span></span></p><section><ul><li><li><li></ul><pre data-lang="makefile"><code><span>library(Seurat)</span></code><code><span>sce = CreateSeuratObject(counts = Read10X(<span>"GSE130001_RAW/GSM3729178"</span>),</span></code><code><span>                   project = <span>"MedBioInfoCloud"</span>)</span></code></pre></section><p><span></span><span><strong><span>5.数据质控</span></strong></span></p><p><span><span><span>质控的目的是去除掉低质量的数据，包括破损或死亡的细胞、没捕获到细胞的empty droplet和捕获到2个以上细胞的doublets。一般低质量的细胞或者empty droplet通常含有很少的基因，而doublets容易测到更多的基因。另一方面，低质量或者死亡细胞会测到更多的线粒体基因表达的RNA。</span></span></span></p><p><span><span><span>过滤指标1:最少表达基因数的细胞&amp;最少表达细胞数的基因</span></span></span><span><span><span></span></span></span></p><section><ul><li><li><li></ul><pre data-lang="apache"><code><span><span>#过滤指标1:最少表达基因数的细胞&amp;最少表达细胞数的基因</span></span></code><code><span><span>sce</span>.<span>all</span> = sce</span></code><code><span><span>VlnPlot</span>(sce.<span>all</span>, features = c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>), ncol = 2)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802180" data-ratio="0.9040404040404041" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzzjiaG9dBweh1XPLic2f4ZhCgJFnUn9kf3oLeD9ZlwaUl32yS3wwzSOdpICaOOgk22sNwkffPyycW2w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="594" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzzjiaG9dBweh1XPLic2f4ZhCgJFnUn9kf3oLeD9ZlwaUl32yS3wwzSOdpICaOOgk22sNwkffPyycW2w/640?wx_fmt=png&amp;from=appmsg"></p><p><span><span><span><br></span></span></span></p><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span>selected_cell</span> &lt;- WhichCells(sce.<span>all</span>, expression = nFeature_RNA &gt; 300)</span></code><code><span><br></span></code><code><span><span>selected_features</span> &lt;- rownames(sce.<span>all</span>)[Matrix::rowSums(sce.<span>all</span>@assays[[<span>"RNA"</span>]]@layers[[<span>"counts"</span>]] &gt; 0 ) &gt; 3]</span></code><code><span><br></span></code><code><span><span>sce</span>.<span>all</span>.filt &lt;- subset(sce.<span>all</span>,</span></code><code><span>                       <span>features</span> = selected_features,</span></code><code><span>                       <span>cells</span> = selected_cell)</span></code><code><span><span>dim</span>(sce.<span>all</span>)</span></code><code><span><span>dim</span>(sce.<span>all</span>.filt)</span></code></pre></section><p><span><span><span>过滤后的基因和细胞数量</span></span></span></p><section><ul><li><li><li><li></ul><pre data-lang="css"><code><span><span>MedBioInfoCloud</span>: <span>dim</span>(<span>sce</span><span>.all</span>)</span></code><code><span><span>[1]</span> 32738  3532</span></code><code><span><span>MedBioInfoCloud</span>: <span>dim</span>(<span>sce</span><span>.all</span><span>.filt</span>)</span></code><code><span><span>[1]</span> 17478  3531</span></code></pre></section><p><span><span><span>可以看到，主要是过滤了基因，其次才是细胞.</span></span></span></p><p><span><span><span>过滤指标2:线粒体/核糖体基因比例</span></span></span><span><span><span></span></span></span></p><p><span><span><span>首先查看一下相关基因，注意小鼠和人的基因大小写区别：</span></span></span></p><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span>#线粒体基因</span></span></code><code><span><span># rownames(sce.all.filt)[grepl('^MT-',rownames(sce.all.filt),ignore.case = T)]</span></span></code><code><span><span>rownames</span>(sce.<span>all</span>.filt)[grepl('^Mt-',rownames(sce.<span>all</span>.filt),ignore.case = T)]</span></code><code><span><br></span></code><code><span><span>#核糖体蛋白基因</span></span></code><code><span><span># rownames(sce.all.filt)[grepl('^Rp[sl]',rownames(sce.all.filt),ignore.case = T)]</span></span></code><code><span><span>rownames</span>(sce.<span>all</span>.filt)[grepl('^RP[SL]',rownames(sce.<span>all</span>.filt),ignore.case = T)]</span></code></pre></section><p><span><span><span>计算上述两类基因在所有细胞中的比例：</span></span></span></p><p><span><span><span>使用PercentageFeatureSet函数评估每个细胞中的线粒体表达比例：</span></span></span></p><section><ul><li><li><li></ul><pre data-lang="apache"><code><span><span>#计算上述两种基因在所有细胞中的比例</span></span></code><code><span><span>sce</span>.<span>all</span>.filt[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(sce.<span>all</span>.filt, pattern = <span>"^MT-"</span>)</span></code><code><span><span>sce</span>.<span>all</span>.filt[[<span>"percent.rp"</span>]] &lt;- PercentageFeatureSet(sce.<span>all</span>.filt, pattern = <span>"^RP[SL]"</span>)</span></code></pre></section><p><span><span><span>上面的方法是修改 sce.all.filt[["percent.mt"]] ，下面我们演示 AddMetaData 函数，同样是可以增加线粒体基因含量信息到我们的seurat对象。</span></span></span></p><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span>##提取表达矩阵</span></span></code><code><span><span>C</span> &lt;- GetAssayData(object = sce.<span>all</span>.filt, layer = <span>"counts"</span>)</span></code><code><span><span>###计算核糖体蛋白基因的比例</span></span></code><code><span><span>rb</span>.genes &lt;- rownames(sce.<span>all</span>.filt)[grep(<span>"^RP[SL]"</span>,rownames(sce.<span>all</span>.filt))]</span></code><code><span><br></span></code><code><span><span>percent</span>.ribo &lt;- Matrix::colSums(C[rb.genes,])/Matrix::colSums(C)*100</span></code><code><span><span>###计算的结果添加到Seurat对象中</span></span></code><code><span><span>sce</span>.<span>all</span>.filt &lt;- AddMetaData(sce.<span>all</span>.filt, percent.ribo, col.name = <span>"percent.ribo"</span>)</span></code></pre></section><p><span><span><span>可视化:</span></span></span></p><section><ul><li><li><li></ul><pre data-lang="apache"><code><span><span>VlnPlot</span>(sce.<span>all</span>.filt, </span></code><code><span>        <span>features</span> = c(<span>"percent.mt"</span>,<span>"percent.ribo"</span>,<span>"percent.rp"</span>),</span></code><code><span>        <span>ncol</span> = 3)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802181" data-ratio="0.5796316359696642" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzzjiaG9dBweh1XPLic2f4ZhCgjOTU8HoTlLcWb0T6bCzTsM59r9uRZyVjQc4YEeHHK3GjL62eS1mtaA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="923" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzzjiaG9dBweh1XPLic2f4ZhCgjOTU8HoTlLcWb0T6bCzTsM59r9uRZyVjQc4YEeHHK3GjL62eS1mtaA/640?wx_fmt=png&amp;from=appmsg"></p><p><span>过滤：</span><br></p><section><ul><li><li></ul><pre data-lang="apache"><code><span><span>sce</span>.<span>all</span>.filt1 &lt;- subset(sce.<span>all</span>.filt,</span></code><code><span>                   <span>subset</span> = percent.mt &lt; 20)</span></code></pre></section><p><span><span><span>有些研究可能需要过滤红细胞基因，下面是匹配红细胞基因，可以按照上面基因核糖体基因比例方式计算。这里不计算了。</span></span></span></p><section><ul><li><li></ul><pre data-lang="apache"><code><span><span>HB</span>.genes &lt;- c(<span>"HBA1"</span>,<span>"HBA2"</span>,<span>"HBB"</span>,<span>"HBD"</span>,<span>"HBE1"</span>,<span>"HBG1"</span>,<span>"HBG2"</span>,<span>"HBM"</span>,<span>"HBQ1"</span>,<span>"HBZ"</span>) #</span></code><code><span><span>HB</span>.genes &lt;- CaseMatch(HB.genes, rownames(sce.<span>all</span>.filt1))</span></code></pre></section><p><span><span><span>官网教程这里要求基因数 200-2500，线粒体百分比为小于 5%，但实际情况还是要根据自己的数据来处理，先画图看异常值分布再调整数值。</span></span></span></p><section><ul><li><li><li></ul><pre data-lang="apache"><code><span><span>plot1</span> &lt;- FeatureScatter(sce.<span>all</span>.filt1, feature1 = <span>"nCount_RNA"</span>, feature2 = <span>"percent.mt"</span>)</span></code><code><span><span>plot2</span> &lt;- FeatureScatter(sce.<span>all</span>.filt1, feature1 = <span>"nCount_RNA"</span>, feature2 = <span>"nFeature_RNA"</span>)</span></code><code><span><span>plot1</span> + plot2</span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802182" data-ratio="0.5184108527131783" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzzjiaG9dBweh1XPLic2f4ZhCgPLiavg5ic8Df5MmcuooTg2WxLZkN36bjFsqEjxXeFrsmTP9SeEUKficwA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1032" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzzjiaG9dBweh1XPLic2f4ZhCgPLiavg5ic8Df5MmcuooTg2WxLZkN36bjFsqEjxXeFrsmTP9SeEUKficwA/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span><span><strong><span>6.数据标准化</span></strong></span><span><span><span></span></span></span></p><p><span><span><span>基因的表达矩阵需要经过标准化后才能进行后续的分析。使用NormalizeData函数进行标准化，normalization.method：标准化方法，可选项，</span></span></span></p><p><span>•<span></span></span><span><span><span>logNormalize：log(每个细胞的特征counts/细胞count总数*scale.factor)</span></span></span></p><p><span>•<span></span></span><span><span><span>CLR：中心化对数标准化</span></span></span></p><p><span>•<span></span></span><span><span><span>RC：相对计数，计算公式同logNormalize，不取log，计算CPM表达量，设置scale.factor=1e6</span></span></span></p><p><span><span><span>可选择LogNormalize：</span></span></span></p><section><ul><li><li><li><li></ul><pre data-lang="makefile"><code><span><span>###================数据标准化</span></span></code><code><span><span>#counts归一化</span></span></code><code><span>sce.all.filt2 &lt;- NormalizeData(sce.all.filt1, normalization.method =  <span>"LogNormalize"</span>,</span></code><code><span>                     scale.factor = 10000)</span></code></pre></section><p><span></span><span><strong><span>7.查找高变基因</span></strong></span></p><p><span><span><span>指一些基因在细胞中表达的浮动比较大，这些往往是我们后续分群的时候需要关注的。FindVariableFeatures 函数有 3 种选择高表达变异基因的方法，可以通过 selection.method参数来选择，它们分别是：vst（默认值）， mean.var.plot (mvp) 和 dispersion (disp)。nfeatures 参数的默认值是 2000，可以改变。如果 selection.method 参数选择的是 mvp，就不需要人为规定高表达变异基因的数目，算法会自动选择合适的数目。建议使用完 FindVariableFeatures 函数后，用 VariableFeaturePlot 对这些高表达变异基因再做个可视化，看看使用默认值 2000 会不会有问题。</span></span></span></p><section><ul><li><li><li><li></ul><pre data-lang="apache"><code><span><span>#前2000个高变feature RNA</span></span></code><code><span><span>sce</span>.<span>all</span>.filt2 &lt;- FindVariableFeatures(sce.<span>all</span>.filt2,</span></code><code><span>                            <span>selection</span>.method = <span>"vst"</span>, nfeatures = 2000)</span></code><code><span><span>VariableFeaturePlot</span>(object = sce.<span>all</span>.filt2)</span></code><span>‍</span></pre></section><p><img data-galleryid="" data-imgfileid="503802183" data-ratio="0.8338461538461538" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzzjiaG9dBweh1XPLic2f4ZhCgfpqSATf2MzO4HhzUWPRsM3A7Uicd6LNVwiaNyYOmvtOd8VRHhvXeDaxQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="650" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzzjiaG9dBweh1XPLic2f4ZhCgfpqSATf2MzO4HhzUWPRsM3A7Uicd6LNVwiaNyYOmvtOd8VRHhvXeDaxQ/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span><span>可以使用LabelPoints函数显示部分基因名称：</span></p><section><ul><li><li><li></ul><pre data-lang="xml"><code><span>P1 = VariableFeaturePlot(object = sce.all.filt2)</span></code><code><span>top10 <span>&lt;<span>-</span> <span>head</span>(<span>VariableFeatures</span>(<span>sce.all.filt2</span>), <span>10</span>)</span></span></code><code><span><span>LabelPoints</span>(<span>plot</span> = <span>P1,</span> <span>points</span> = <span>top10,</span> <span>repel</span> = <span>TRUE)</span></span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802184" data-ratio="0.8377125193199382" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzzjiaG9dBweh1XPLic2f4ZhCggn5RPyqcJQCvppFgibDiapibWoa0jXayiangW4K5OL42gYIb3jZzibx52zA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="647" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzzjiaG9dBweh1XPLic2f4ZhCggn5RPyqcJQCvppFgibDiapibWoa0jXayiangW4K5OL42gYIb3jZzibx52zA/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span><span><strong><span>8.基因归一化</span></strong></span></p><p><span><span><span>对所有的基因都做了scale，但是需要知道的是，其实后续的分析都是基于高变基因的，因此，使用默认参数就可以了。</span></span></span></p><p><span><span><span># 这里设置对所有的基因都做了scale,但是需要知道的是，其实后续的分析都是基于高变基因的，因此，使用默认参数就可以了，而且提升效率</span></span></span><span><span><span><br></span></span></span></p><section><ul><li><li></ul><pre data-lang="cs"><code><span>all.genes &lt;- rownames(x = sce)</span></code><code><span>sce &lt;- ScaleData(<span>object</span> = sce, features = all.genes) <span># 对所有基因做归一化处理</span></span></code></pre></section><p><span><span><span>此外需要注意的是，</span></span></span><span><span><span>ScaleData 可以用在去除细胞周期影响，利用 ScaleData 函数的 vars.to.regress 参数来消除细胞周期带来的变异。这里可以用到两种方法，一种方法是同时S.score 和 G2M.score，另一种方法是 regress out 两个score 的差。</span></span></span><span><span><span>非必要步骤</span></span></span><span><span><span>。</span></span></span></p><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>s.genes &lt;- Seurat::cc.genes.updated<span>.2019</span>$s.genes</span></code><code><span>g2m.genes &lt;- Seurat::cc.genes.updated<span>.2019</span>$g2m.genes</span></code><code><span><span># CellCycleScoring将Seurat对象中每个细胞的分组信息设置为其所处的细胞周期阶段</span></span></code><code><span>sce_Scale &lt;- CellCycleScoring(sce.all.filt2,</span></code><code><span>                              s.features = s.genes,</span></code><code><span>                              g2m.features = g2m.genes, set.ident = <span>TRUE</span>)</span></code><code><span><span># 观察细胞周期基因的表达情况</span></span></code><code><span>RidgePlot(sce_Scale, features = c(<span>"PCNA"</span>, <span>"TOP2A"</span>, <span>"MCM6"</span>, <span>"MKI67"</span>), ncol = <span>2</span>)</span></code><code><span><br></span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802185" data-ratio="0.6238317757009346" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzzjiaG9dBweh1XPLic2f4ZhCgF5MIHqx2YVRSdlRUibDW5icCKoicuJLnL7jtGXl7SsYzHjZqNWL7YcyPQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="856" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzzjiaG9dBweh1XPLic2f4ZhCgF5MIHqx2YVRSdlRUibDW5icCKoicuJLnL7jtGXl7SsYzHjZqNWL7YcyPQ/640?wx_fmt=png&amp;from=appmsg"></p><p><span><span><span><br></span></span></span></p><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="nginx"><code><span><span># 方法一</span></span></code><code><span><span>sce_Scale</span> &lt;- ScaleData(sce_Scale, vars.to.regress = c(<span>"S.Score"</span>, <span>"G2M.Score"</span>),</span></code><code><span>          features = rownames(sce_Scale))</span></code><code><span><span># 方法二</span></span></code><code><span>sce_Scale<span>$CC</span>.Difference &lt;- sce_Scale<span>$S</span>.Score - sce_Scale<span>$G2M</span>.Score</span></code><code><span>ScaleData(sce_Scale, vars.to.regress = <span>"CC.Difference"</span>,</span></code><code><span>          features = rownames(sce_Scale))</span></code></pre></section><p><span><span><span>第一种方法完全去除了细胞周期的影响，而第二种方法则消除了 S 和 G2M 期的差别，为什么要这么做呢？因为对于某些样本来说，有的细胞类型处于休眠期，有的细胞类型处于增殖期，如果把所有细胞周期的影响都去除掉，会影响这两类细胞的鉴定。这时候，我们只要去除增殖期内部细胞周期的差异，保留增殖期和休眠期的差别就可以了。是否需要排除细胞周期的影响，看自己的研究是否需要。</span></span></span></p><p><span></span><span><strong><span>9</span></strong></span><span><span><span>.</span></span></span><span><strong><span>降维聚类</span></strong></span></p><section><ul><li><li><li><li></ul><pre data-lang="cs"><code><span>sce &lt;- RunPCA(<span>object</span> = sce, pc.genes = VariableFeatures(sce))</span></code><code><span>P5 &lt;- DimPlot(<span>object</span> = sce , reduction = <span>"pca"</span>)</span></code><code><span>P6 &lt;- VizDimLoadings(sce, dims = <span>1</span>:<span>2</span>, reduction = <span>"pca"</span>)</span></code><code><span>P5 + P6</span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802186" data-ratio="0.37222222222222223" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyz3DwQykCYThvMcKNmjDMor5C6Ptbd6WoJyo6FwtUvacj8ER4xLgX1Mw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyz3DwQykCYThvMcKNmjDMor5C6Ptbd6WoJyo6FwtUvacj8ER4xLgX1Mw/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span></p><section><ul><li><li></ul><pre data-lang="objectivec"><code><span><span>#看看前18个主成分</span></span></code><code><span>DimHeatmap(sce, dims = <span>1</span>:<span>18</span>, cells = <span>100</span>, balanced = <span>TRUE</span>)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802187" data-ratio="0.6370370370370371" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyziadUn8W0iaFMkqjsj6VvMPceF4PMZFkbBKyzqeWGkicNZibaiaVUfuuYLKA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyziadUn8W0iaFMkqjsj6VvMPceF4PMZFkbBKyzqeWGkicNZibaiaVUfuuYLKA/640?wx_fmt=png&amp;from=appmsg"></p><p><span>我们可以看到PC16之后的热图没有明显的色块，更像一个零散的马赛克，PC1-16可以解释的差异就比较好。还有其他的一些判断方法。也可以用ElbowPlot来估计，PC16后基于平稳。JackStrawPlot图虚线以上的为可用维度，也可以调整 dims 参数，画出所有 pca 查看，这个方法耗时比较久。</span><br></p><p><span><span><span>主成分个数大一点对结果影响不大，但少了影响很大。</span></span></span></p><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="properties"><code><span><span>#判断最终选取的主成分数，这里我判断16个</span></span></code><code><span><span>P4</span> <span>&lt;- ElbowPlot(sce_Scale2)</span></span></code><code><span><span># 鉴定数据集的可用维度，虚线以上的为可用维度</span></span></code><code><span><span>sce_Scale2</span> <span>&lt;- JackStraw(object = sce_Scale2, num.replicate = 100)</span></span></code><code><span><span>sce_Scale2</span> <span>&lt;- ScoreJackStraw(object = sce_Scale2, dims = 1:20)</span></span></code><code><span><span>P5</span> <span>&lt;- JackStrawPlot(object = sce_Scale2, dims = 1:18)</span></span></code><code><span><span>P4</span> <span>+ P5</span></span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802188" data-ratio="0.6697061803444783" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzku1njvU9kPKMssdmDUlWHGkAgK7iaO2RETdsYOKQqDtzZUO492pqFAw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="987" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzku1njvU9kPKMssdmDUlWHGkAgK7iaO2RETdsYOKQqDtzZUO492pqFAw/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span><span><strong><span>10.细胞聚类</span></strong></span></p><p><span><span><span>在Seurat包中，对于单细胞数据先过滤，再标准化，再PCA降维，再聚类的过程，其中聚类就是先用KNN算法得到细胞的K个最近邻节点，(在图论聚类的过程中，KNN并不做分类器的功能，而是仅用于寻找每个细胞距离最近的k个细胞。此外，为了提高运算速度，降低背景噪音，主成分分析（PCA）会优先于KNN进行)，然后再用SNN算法对共享最近邻节点进一步加强细胞间的关系，(SNN是一种基于共享最近邻的聚类算法，它通过使用数据点间共享最近邻的个数作为相似度来处理密度不同的聚类问题，从而可以在含有噪音并且高维的数据集中发现各不相同的空间聚类。)</span></span></span></p><p><span><span><span>最后用Louvain算法对小簇进行模块划分，最终得到细胞亚群，并用tSNE/UMAP图进行可视化，使得细胞分群一目了然，这里的 dims 为上一步计算所用的维度数，而 resolution 参数控制聚类的数目，针对3K的细胞数目，最好的范围是0.4-1.2，默认是0.8。</span></span></span></p><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="cs"><code><span><span># 细胞聚类</span></span></code><code><span>sce_Scale2 &lt;- FindNeighbors(sce_Scale2, dims = <span>1</span>:<span>16</span>)</span></code><code><span>sce_Scale2 &lt;- FindClusters(sce_Scale2, resolution = <span>0.9</span>)</span></code><code><span><span>#tSNE可视化</span></span></code><code><span><span>set</span>.seed(<span>123</span>)</span></code><code><span>sce_Scale2 &lt;- RunTSNE(<span>object</span> = sce_Scale2, dims = <span>1</span>:<span>16</span>, <span>do</span>.fast = TRUE)</span></code><code><span>DimPlot(sce_Scale2,reduction = <span>"tsne"</span>,label=T)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802189" data-ratio="0.9703703703703703" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzic1Yy7avJKF598cnvgHvs3FXBRNF66Xckzh7wzEfDOABnFELVNyE5qg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="675" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzic1Yy7avJKF598cnvgHvs3FXBRNF66Xckzh7wzEfDOABnFELVNyE5qg/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li></ul><pre data-lang="css"><code><span># 在两个样本里12个<span>cluster</span>的分布情况</span></code><code><span><span>table</span>(<span>sce_Scale2</span>@<span>meta</span>.<span>data</span>$<span>seurat_clusters</span>,<span>sce_Scale2</span>@<span>meta</span>.<span>data</span>$<span>orig</span>.<span>ident</span>)</span></code><code><span>DimPlot(sce_Scale2,reduction = <span>"tsne"</span>,label=T,split.by =<span>'orig.ident'</span>)</span></code></pre></section><p><span><span><span>但是这里我们只有一个分组，图和上面一样。</span></span></span></p><p><span><span><span>可以提取数据用ggplot2进行可视化：</span></span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span>#再尝试用ggplot2可视化上图</span></code><code><span>library(ggplot2)</span></code><code><span>phe &lt;- <span>data</span>.frame(cell=rownames(<span>sce_Scale2@</span>meta.<span>data</span>),</span></code><code><span>                  cluster =<span>sce_Scale2@</span>meta.<span>data</span>$seurat_clusters)</span></code><code><span>tsne_pos &lt;- Embeddings(sce_Scale2,<span>'tsne'</span>)</span></code><code><span>dat &lt;- cbind(tsne_pos,phe)</span></code><code><span>head(dat)</span></code><code><span>P6 &lt;- ggplot(dat,aes(x=tSNE_1,y=tSNE_2,color=cluster))+</span></code><code><span>  geom_point(size=<span>0.95</span>)+</span></code><code><span>  stat_ellipse(<span>data</span>=dat,aes(x=tSNE_1,y=tSNE_2,fill=cluster,color = cluster),</span></code><code><span>               geom = <span>"polygon"</span>,alpha=<span>0.2</span>,level=<span>0.9</span>,type=<span>"t"</span>,</span></code><code><span>               linetype =<span>2</span>,show.legend = F) + coord_fixed() +</span></code><code><span>  theme(panel.grid =element_blank()) +   ## 删去网格</span></code><code><span>  theme(panel.border = element_blank(),panel.background = element_blank()) +   ## 删去外层边框</span></code><code><span>  theme(axis.line = element_line(linewidth=<span>1</span>, colour = <span>"black"</span>))+</span></code><code><span>  guides(colour = guide_legend(<span>override</span>.aes = list(size=<span>5</span>)))</span></code><code><span>P6</span></code><code><span><br></span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802190" data-ratio="0.9545454545454546" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzic1yys7S8rLKg68zQibhAWB2ThSAJFMzib0MoMiaD3ZrVFyCQgINYVFuGQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="682" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzic1yys7S8rLKg68zQibhAWB2ThSAJFMzib0MoMiaD3ZrVFyCQgINYVFuGQ/640?wx_fmt=png&amp;from=appmsg"></p><p>使用UMAP降维。<br></p><section><ul><li><li></ul><pre data-lang="xml"><code><span>sce_Scale2 <span>&lt;<span>-</span> <span>RunUMAP</span>(<span>object</span> = <span>sce_Scale2,</span> <span>dims</span> = <span>1:16,</span> <span>do.fast</span> = <span>TRUE)</span></span></span></code><code><span><span>DimPlot</span>(<span>sce_Scale2</span>,<span>reduction</span> = <span>"umap"</span>,<span>label</span>=<span>T)</span></span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802191" data-ratio="0.9850074962518741" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyz9HYE38ZeJKg0Rbq6DibvtshkyEhuibKFbibVtOHLOtibp6FegYXhP8lFSA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="667" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyz9HYE38ZeJKg0Rbq6DibvtshkyEhuibKFbibVtOHLOtibp6FegYXhP8lFSA/640?wx_fmt=png&amp;from=appmsg"></p><p><span><strong><span>11.寻找每个cluster的高变代表</span></strong></span><span><strong><span>基因</span></strong></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span>#寻找每个cluster的高变代表基因，并选取前<span>5</span>个，进行可视化</span></code><code><span>table(<span>sce_Scale2@</span>meta.<span>data</span>$seurat_clusters)</span></code><code><span>p &lt;- list()</span></code><code><span><span>for</span>( i <span>in</span> unique(<span>sce_Scale2@</span>meta.<span>data</span>$seurat_clusters) ){</span></code><code><span>  markers_df &lt;- FindMarkers(<span>object</span> = sce_Scale2, ident.1 = i, min.pct = <span>0.25</span>)</span></code><code><span>  print(x = head(markers_df))</span></code><code><span>  markers_genes =  rownames(head(x = markers_df, n = <span>4</span>))</span></code><code><span>  p1 &lt;- VlnPlot(<span>object</span> = sce_Scale2, features =markers_genes,log =T,ncol = <span>2</span>)</span></code><code><span>  p[[i]][[<span>1</span>]] &lt;- p1</span></code><code><span>  p2 &lt;- FeaturePlot(<span>object</span> = sce_Scale2, features=markers_genes,ncol = <span>2</span>)</span></code><code><span>  p[[i]][[<span>2</span>]] &lt;- p2</span></code><code><span>}</span></code><code><span>p[[<span>1</span>]][[<span>2</span>]]</span></code><code><span><br></span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802192" data-ratio="0.720348204570185" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzia2rktO1Ix9I6amMjDJBQhJicqOckOgEqOwFwQ6JuCwBH4lGyQVxYPaQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="919" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzia2rktO1Ix9I6amMjDJBQhJicqOckOgEqOwFwQ6JuCwBH4lGyQVxYPaQ/640?wx_fmt=png&amp;from=appmsg"></p><p><span><span><span><br></span></span></span></p><section><ul><li></ul><pre data-lang="markdown"><code><span>p[<span>[2</span>]][[1]]</span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802193" data-ratio="0.7251908396946565" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzO4FU2FoLY93BdsMgFLIddCH87SLiaX5mdPmkza4uF37d4UtnlhVMrMg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="917" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzO4FU2FoLY93BdsMgFLIddCH87SLiaX5mdPmkza4uF37d4UtnlhVMrMg/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li></ul><pre data-lang="xml"><code><span>#查阅所有的marker基因，可用于人工注释cell type</span></code><code><span>sce.markers <span>&lt;<span>-</span> <span>FindAllMarkers</span>(<span>object</span> = <span>sce_Scale2,</span> <span>only.pos</span> = <span>TRUE,</span> <span>min.pct</span> = <span>0.25,</span></span></span></code><code><span>                              <span>thresh.use</span> = <span>0.25)</span></span></code><code><span>DT::datatable(sce.markers)</span></code><code><span><br></span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802194" data-ratio="0.37037037037037035" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzVptYqH8NC3kiaL9VBO6OSqKY5ro85ZWDYWia6rIdPzIlIY2pRSfA6FzA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzVptYqH8NC3kiaL9VBO6OSqKY5ro85ZWDYWia6rIdPzIlIY2pRSfA6FzA/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li></ul><pre data-lang="bash"><code><span><span>#热图可视化每个cluster的marker基因表达差异</span></span></code><code><span>library(dplyr)</span></code><code><span>top5 &lt;- sce.markers %&gt;% group_by(cluster) %&gt;% top_n(5, avg_log2FC)</span></code><code><span>DoHeatmap(sce_Scale2,top5<span>$gene</span>,size=3)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="503802195" data-ratio="0.7856430707876371" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzURLP2BuFckIHfNEIIIYicjHdf1cxoAWbQou9Wnpkg5swSK77QIcnX5Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1003" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwh7S7HjSnJrJDXhonasWyzURLP2BuFckIHfNEIIIYicjHdf1cxoAWbQou9Wnpkg5swSK77QIcnX5Q/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span><span><strong><span>12.保存数据</span></strong></span></p><p><span><span><span>保存数据用于后续进一步分析。</span></span></span></p><section><ul><li><li><li></ul><pre data-lang="bash"><code><span><span>##保存数据</span></span></code><code><span>dir.create(<span>"data"</span>)</span></code><code><span>save(sce_Scale2,sce.markers,file = <span>'data/sce.output.merge.GSE130001.Rdata'</span>)</span></code></pre></section><p><img data-galleryid="" data-ratio="1.0291970802919708" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwlcDib0ZJoicuLyG92DicwGVnDorFCjt6v1RVJKusT6ib2vicAibS7CvADLziaUWZHqictxy4YkgyhsggMbg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="274" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzwlcDib0ZJoicuLyG92DicwGVnDorFCjt6v1RVJKusT6ib2vicAibS7CvADLziaUWZHqictxy4YkgyhsggMbg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p>B站视频合集</p><hr><section><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzw321c7L6nrpqs6Sa0FGFzaFwzp7pdXrJZ5QRhib950DOAUMrj2NDyfuonw7jbnBljp2rxeQJlAyng/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-w="400" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzw321c7L6nrpqs6Sa0FGFzaFwzp7pdXrJZ5QRhib950DOAUMrj2NDyfuonw7jbnBljp2rxeQJlAyng/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></section><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4NDAzODkzMA==&amp;mid=2651278937&amp;idx=1&amp;sn=70b476a444883a9282efc13ee9c19a72&amp;chksm=841eaa24b3692332de6263a5ed15e2b3da3017845d6e533a0b7944624afd2fc3275710f61439&amp;scene=21#wechat_redirect" textvalue="加入生信学习交流群" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"><strong>加入生信学习交流群</strong></a></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-mid="" mpa-from-tpl="t"><section data-mid="" mpa-from-tpl="t"><section data-mid="" mpa-from-tpl="t"><section data-mid="" mpa-from-tpl="t"><p data-mid=""><span>经    典    栏    目</span></p></section></section><section data-mid="" mpa-from-tpl="t"><br></section><section data-mid="" mpa-from-tpl="t"><br></section></section></section></section><p><br></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-mid="" mpa-from-tpl="t"><section data-mid="" mpa-from-tpl="t"><section data-mid="" mpa-from-tpl="t"><br></section><section data-mid="" mpa-from-tpl="t"><br></section><section data-mid="" mpa-from-tpl="t"><section data-mid="" mpa-from-tpl="t"><table align="center" width="528"><tbody><tr><td width="243" valign="bottom" align="center" height="45"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NDAzODkzMA==&amp;action=getalbum&amp;album_id=1338047035672526848#wechat_redirect" textvalue="你已选中了添加链接的内容" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.2084639498432602" data-s="300,640" data-type="png" data-w="638" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDhkvd0VYruWibnf6I99uicOsqFSIPicvmUP7w8m3ictoTgeAmsmF6v40nqw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDhkvd0VYruWibnf6I99uicOsqFSIPicvmUP7w8m3ictoTgeAmsmF6v40nqw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></a></td><td width="243" valign="bottom" align="center" height="45"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NDAzODkzMA==&amp;action=getalbum&amp;album_id=1385753371944239106#wechat_redirect" textvalue="你已选中了添加链接的内容" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.2084639498432602" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RND8LOmqZpGNerHE2ib3hrYBm7czV8ibjkg6bgUynABicHtDblDwibcK0iafdg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="638" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RND8LOmqZpGNerHE2ib3hrYBm7czV8ibjkg6bgUynABicHtDblDwibcK0iafdg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></a></td></tr><tr><td width="243" valign="bottom" align="center" height="45"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NDAzODkzMA==&amp;action=getalbum&amp;album_id=1410264757734817793#wechat_redirect" textvalue="你已选中了添加链接的内容" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.2084639498432602" data-s="300,640" data-type="png" data-w="638" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDnwmiaAUS36yqYw6aeJ9iaNkNUGmcU7ux65wvficPlQXDHQibW3JYrFJFvQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDnwmiaAUS36yqYw6aeJ9iaNkNUGmcU7ux65wvficPlQXDHQibW3JYrFJFvQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></a></td><td width="243" valign="bottom" align="center" height="45"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NDAzODkzMA==&amp;action=getalbum&amp;album_id=1369789283514761218#wechat_redirect" textvalue="你已选中了添加链接的内容" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.20689655172413793" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDANc1t4lIm5wTqesgaITcicUlfiaXHrSxrKVeWZYCzlH9MSy7IibTYQLNg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="638" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDANc1t4lIm5wTqesgaITcicUlfiaXHrSxrKVeWZYCzlH9MSy7IibTYQLNg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></a></td></tr><tr><td width="243" valign="bottom" align="center" height="45"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NDAzODkzMA==&amp;action=getalbum&amp;album_id=1519504738202025984#wechat_redirect" textvalue="你已选中了添加链接的内容" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.2084639498432602" data-s="300,640" data-type="png" data-w="638" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDQmkz6ffBVfRj1Ab8ibMyygNmmvL7yia3eoZzJNoWjNW6vwjG4y3PWsNg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDQmkz6ffBVfRj1Ab8ibMyygNmmvL7yia3eoZzJNoWjNW6vwjG4y3PWsNg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></a></td><td width="243" valign="bottom" align="center" height="45"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NDAzODkzMA==&amp;action=getalbum&amp;album_id=1519504738034253825#wechat_redirect" textvalue="你已选中了添加链接的内容" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.20689655172413793" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDCpphsguALa0tR6pfEy8yLBahRX9iaeYdKCwicKFbBd2X1yTSiaZyZwFqA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="638" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDCpphsguALa0tR6pfEy8yLBahRX9iaeYdKCwicKFbBd2X1yTSiaZyZwFqA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></a></td></tr><tr><td width="243" valign="bottom" align="center" height="45"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NDAzODkzMA==&amp;action=getalbum&amp;album_id=1687484069455986690#wechat_redirect" textvalue="你已选中了添加链接的内容" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.2084639498432602" data-s="300,640" data-type="png" data-w="638" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RND73kOWY2pcLs5dmFMQWCG1Noz1oRR2oBCDHgNjiaAXqEZkLllKtoeO0g/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RND73kOWY2pcLs5dmFMQWCG1Noz1oRR2oBCDHgNjiaAXqEZkLllKtoeO0g/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></a></td><td width="243" valign="bottom" align="center" height="45"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NDAzODkzMA==&amp;action=getalbum&amp;album_id=1521974159344533507#wechat_redirect" textvalue="你已选中了添加链接的内容" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.20689655172413793" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RND6nm4ADziajqL0hpSudJTiacRyqVOg9NpnKoyfmVOgzwp97HicIFjb0gDw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="638" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RND6nm4ADziajqL0hpSudJTiacRyqVOg9NpnKoyfmVOgzwp97HicIFjb0gDw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></a></td></tr><tr><td width="243" valign="bottom" align="center" height="45"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NDAzODkzMA==&amp;action=getalbum&amp;album_id=1715194110111776770#wechat_redirect" textvalue="你已选中了添加链接的内容" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.2087912087912088" data-s="300,640" data-type="png" data-w="637" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDRBOVZUPB816xXqA1SlbNzDRkmNRSjtCa3pqjuyAoQJxa1drcW0yeZQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDRBOVZUPB816xXqA1SlbNzDRkmNRSjtCa3pqjuyAoQJxa1drcW0yeZQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></a></td><td width="243" valign="bottom" align="center" height="45"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NDAzODkzMA==&amp;action=getalbum&amp;album_id=1715194110212440067#wechat_redirect" textvalue="你已选中了添加链接的内容" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.20689655172413793" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDxgtG3pdSyaKcfgvqjDrC2mpKa0MCu1rsbGkQLcOys8c9BVLs2VnjEg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="638" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDxgtG3pdSyaKcfgvqjDrC2mpKa0MCu1rsbGkQLcOys8c9BVLs2VnjEg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></a></td></tr><tr><td width="243" valign="bottom" align="center" height="45"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NDAzODkzMA==&amp;action=getalbum&amp;album_id=1712569781846933508#wechat_redirect" textvalue="你已选中了添加链接的内容" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.20722135007849293" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDXqLDtKHqQMBReWKnTibVusnVlY43shlib0iaoluz4tmJPej8ej4vWiaehA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="637" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RNDXqLDtKHqQMBReWKnTibVusnVlY43shlib0iaoluz4tmJPej8ej4vWiaehA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></a></td><td width="243" valign="bottom" align="center" height="45"><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA4NDAzODkzMA==&amp;action=getalbum&amp;album_id=1338481272770953216#wechat_redirect" textvalue="你已选中了添加链接的内容" tab="innerlink" data-linktype="1"><span data-positionback="static"><img data-ratio="0.2084639498432602" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RND3CbMQTDNRO3A5SELiaQ3DDeqQkt5rfZqpwQRsQYyTicQUD9zQlfolIvQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="638" src="https://mmbiz.qpic.cn/mmbiz_png/dREape4YBzxVERm1kp30MnGymicMs1RND3CbMQTDNRO3A5SELiaQ3DDeqQkt5rfZqpwQRsQYyTicQUD9zQlfolIvQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></a></td></tr></tbody></table><span></span><img data-ratio="0.4462962962962963" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/dREape4YBzyF5jVxNCORGgSJRgWqy8hD72dmSRN2iaqQ8CibvLricqsLfL7Mauoa1YLLVYDrhp0RNEGsvicky3kibeA/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/dREape4YBzyF5jVxNCORGgSJRgWqy8hD72dmSRN2iaqQ8CibvLricqsLfL7Mauoa1YLLVYDrhp0RNEGsvicky3kibeA/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></section></section><section data-mid="" mpa-from-tpl="t"><br></section><section data-mid="" mpa-from-tpl="t"><span></span></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/WQdaPedEwmREgx6wgEhaqQ",target="_blank" rel="noopener noreferrer">原文链接</a>
