---
title: "踩坑实录 | 使用R语言读入Visium HD空转数据"
date: 2024-03-29T13:20:50Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
踩坑实录 | 使用R语言读入Visium HD空转数据 by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">众所周知，10X Visium空转数据的一个spots不是单细胞分辨率的，而是包含十余个细胞的混合点（55 μm分辨率），因此为了解决这个问题，目前开发了数十种整合单细胞和空转数据的解卷积算法，例如：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247517524&amp;idx=1&amp;sn=6eca8b43a3816e2538ad0d3a745488dd&amp;scene=21#wechat_redirect" data-linktype="2">整合单细胞和空转数据多种方法之CellTrek</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247519266&amp;idx=1&amp;sn=2a7ead4dd345ba58f56a0cb710052d03&amp;scene=21#wechat_redirect" data-linktype="2">整合单细胞和空转数据多种方法之Cell2location</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247519938&amp;idx=1&amp;sn=d1814cc9fbcec0121242627bff3d59bf&amp;scene=21#wechat_redirect" data-linktype="2">整合单细胞和空转数据多种方法之RCTD</a></section></li></ul><p data-tool="mdnice编辑器">而在24年1月份，10X公司预告了一个新技术10X Visium HD，分辨率可达2 μm，可实现<strong>单细胞分辨率的全转录组空间分析，并且可实现连续的组织覆盖率</strong>：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004357" data-ratio="0.4882533197139939" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqUD1p3jH3yaxelE0ItUiatibqm5Vlic1Us0VFicIj1AUbpKc5kBF9e741UjukQrEpe3ER1HTevfYR3Dxg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="979" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqUD1p3jH3yaxelE0ItUiatibqm5Vlic1Us0VFicIj1AUbpKc5kBF9e741UjukQrEpe3ER1HTevfYR3Dxg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240329143324700</figcaption></figure><p data-tool="mdnice编辑器">就在前几天（24年3月26日），10X公司开放了10X Visium HD的两个FFPE样本的测试数据，分别是Mouse Small Intestine， https://www.10xgenomics.com/datasets/visium-hd-cytassist-gene-expression-libraries-of-mouse-intestine 和Human Colorectal Cancer （CRC），https://www.10xgenomics.com/datasets/visium-hd-cytassist-gene-expression-libraries-of-human-crc。</p><p data-tool="mdnice编辑器"><strong>因此，我对10X Visium HD CRC数据进行了开箱测试，Visium HD CRC数据下载自10X官方网站的数据：</strong></p><p data-tool="mdnice编辑器">https://www.10xgenomics.com/datasets/visium-hd-cytassist-gene-expression-libraries-of-human-crc</p><p data-tool="mdnice编辑器"><strong>10X Visium HD 的分析有点类似华大的空转数据分析，同样进行了分bin操作，数据输出为2 μm，还额外提供了8 μm和16 μm的数据：</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004360" data-ratio="0.849624060150376" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqUD1p3jH3yaxelE0ItUiatibq19Fo01q9T3kH2N919SOFhMjK8MG5CBuF7EWSkxveqnMW5micy1h1UYA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="931" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqUD1p3jH3yaxelE0ItUiatibq19Fo01q9T3kH2N919SOFhMjK8MG5CBuF7EWSkxveqnMW5micy1h1UYA/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240329144845576</figcaption></figure><p data-tool="mdnice编辑器"><strong>那我们实际在分析过程中使用哪个bin呢？</strong></p><p data-tool="mdnice编辑器"><strong>实际上需要根据目标组织类型和用户的需要进行抉择。针对CRC组织而言，10X官方推荐使用8 μm，详见10X官方对这个数据进行的详细解读：</strong></p><p data-tool="mdnice编辑器">https://www.10xgenomics.com/support/software/loupe-browser/latest/tutorials/lb-hd-spatial-gene-expression</p><p data-tool="mdnice编辑器">我也查到了一篇乳腺癌的10X Visium HD摘要文章（结果尚未发表），<strong>也是采用了8 μm的bin：</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100004359" data-ratio="0.3347778981581798" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqUD1p3jH3yaxelE0ItUiatibqThHnNNPeV3dekaKCf5cDcpIQarT5tIM6PCwKicAwhn9k7p8FP1PsCxA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="923" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqUD1p3jH3yaxelE0ItUiatibqThHnNNPeV3dekaKCf5cDcpIQarT5tIM6PCwKicAwhn9k7p8FP1PsCxA/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240329142153610</figcaption></figure><p data-tool="mdnice编辑器"><span><strong>因此，针对一般的肿瘤项目，非常推荐使用8x8μm 的 Bin 进行可视化和分析。</strong></span></p><p data-tool="mdnice编辑器"><span><strong>拿到数据之后，下一步是要将数据读入R语言保存为Seurat对象，然后走Seurat流程即可。然而万万没想到读入Visium HD数据就花了我快一个下午...</strong></span></p><p data-tool="mdnice编辑器"><span><strong>总结来说，目前Seurat其实并不兼容Visium HD的数据读取。因此我修改了Seurat源代码，写了一个自编函数，可将Visium HD空转数据一键式读入R语言，并保存为Seurat对象，正文如下。</strong></span></p><h3 data-tool="mdnice编辑器"><span>Step1. 下载示例数据</span></h3><p data-tool="mdnice编辑器"><strong>命令行下载及解压：</strong></p><pre data-tool="mdnice编辑器"><code><span>#</span><span>下载</span><br>wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Human_Colon_Cancer/Visium_HD_Human_Colon_Cancer_square_008um_outputs.tar.gz<br><span><br>#</span><span>解压</span><br>tar -zxvf Visium_HD_Human_Colon_Cancer_square_008um_outputs.tar.gz<br><span><br>#</span><span>check</span><br>tree -h ./ -L 3<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004356" data-ratio="0.9036918138041734" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqUD1p3jH3yaxelE0ItUiatibqmGhSHkX6iacceNfia8zTRozbK0PqeNQKU60nEumUanicb3V0nSFIyAHgg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="623" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqUD1p3jH3yaxelE0ItUiatibqmGhSHkX6iacceNfia8zTRozbK0PqeNQKU60nEumUanicb3V0nSFIyAHgg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240329113629907</figcaption></figure><h3 data-tool="mdnice编辑器"><span>Step2. 加载数据（有大坑）</span></h3><p data-tool="mdnice编辑器"><strong>空转数据的R语言环境（Seurat v4版本）读入和标准分析可参考：</strong></p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247486428&amp;idx=1&amp;sn=9be6ba02adeeb86aa7eea5e00aa70070&amp;scene=21#wechat_redirect" data-linktype="2">Seurat空间转录组分析（一）数据读入</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247486991&amp;idx=1&amp;sn=7eb1fd57b924e88c362beef7ada4eb4d&amp;scene=21#wechat_redirect" data-linktype="2">Seurat空间转录组分析（二）标准分析流程</a></section></li><li><section><span><strong>然而，和传统10X空转数据不同，Visium HD文件的读入有大坑，详见下文：</strong></span></section></li></ul><pre data-tool="mdnice编辑器"><code><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(patchwork)<br><span>library</span>(dplyr)<br></code></pre><pre data-tool="mdnice编辑器"><code>test_data = Load10X_Spatial(data.dir = <span>"./square_008um/"</span>,<br>                            filename = <span>"filtered_feature_bc_matrix.h5"</span>,<br>                            assay = <span>"Spatial"</span>, <br>                            slice = <span>"CRC"</span>)<br>test_data<br></code></pre><pre data-tool="mdnice编辑器"><code><span>    An object of class Seurat </span><br><span>    18085 features across 545913 samples within 1 assay </span><br><span>    Active assay: Spatial (18085 features, 0 variable features)</span><br><span>     1 image present: CRC</span><br></code></pre><p data-tool="mdnice编辑器">可以看到一张切片，在8 μm分辨率下有545 913个单细胞。</p><p data-tool="mdnice编辑器"><span><strong>然而，使用</strong><strong><code>SpatialDimPlot</code>函数可视化显示为空白图片（虽然没有报错）：</strong></span></p><pre data-tool="mdnice编辑器"><code>head(test_data@meta.data)<br>SpatialDimPlot(test_data,alpha = <span>0</span>)<br></code></pre><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span>Step3. 解决方案</span></h3><p><mp-pay-preview-filter data-offset="35"></mp-pay-preview-filter></p></section></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/n8FuF0C8WC7OuWA-uyaD4g",target="_blank" rel="noopener noreferrer">原文链接</a>
