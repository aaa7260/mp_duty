---
title: "细胞通讯分析之CellphoneDB（二）可视化篇"
date: 2022-12-30T01:35:37Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
细胞通讯分析之CellphoneDB（二）可视化篇 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">时间过得好快，又一个月过去了！前几期我分享了CellChat的学习笔记，包括：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247505973&amp;idx=1&amp;sn=2af24cf413aa52d9ab3ec4999be267fa&amp;scene=21#wechat_redirect" data-linktype="2">CellChat细胞通讯分析（一）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247506674&amp;idx=1&amp;sn=f39940f714833c4742ba2c61a579173f&amp;scene=21#wechat_redirect" data-linktype="2">CellChat细胞通讯（二）可视化篇</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247507275&amp;idx=1&amp;sn=47a8b040307b660ebe483aaec2cc4547&amp;chksm=fa451876cd32916030e713de041b56c79c495753edffd44476daa31fcf61c9819cb30028fcb2&amp;scene=21&amp;cur_album_id=2487778019613540353&amp;rd2werd=1&amp;key=1abe5a9a52da9c19911c3539a2229b80f894774a21abef6d9999b4233e7f004adbf4dd0b0d49a85571029e865b6d86d165fb73e3e5aaad76146469c7dda73b0729cb5b64e248e58e7fe7c88a5dab6d485061029782b5aada2c8340568d16f66f5277ca96a29d92b6918b115db1771b649b629fd5e79f16fe20976fb85ebd67a9&amp;ascene=14&amp;uin=MjA1MzU5NzYxNA==&amp;devicetype=Windows%2010%20x64&amp;version=63080021&amp;lang=zh_CN&amp;exportkey=n_ChQIAhIQ2aa3J/1BzHIIU82fdO9zsxLgAQIE97dBBAEAAAAAAD5IIeqIMAEAAAAOpnltbLcz9gKNyK89dVj0rj8%20dK8k/Rq515TlznIiHrf3JrhnZx86auq%20/Xv6Xyn7i49qVBgyuJIkeQIKr%20nwZNdA%20n0v62dxDH8ltEmLh3dXMCa6%2034IA5qksK6SWZSKc2tbTCg5cIZhTd%20Ojn%20I5XIUbMFUsRNvlEF%20H2JV84/6o2o%20PLtczzyALELC5WOBIG6cCFLzOWSG3eDIICZl3DAEcfXgVeOtrNuemquWXjs1MejdaJBLWullf4p1XiShkr9yxn%20SKe0v&amp;acctmode=0&amp;pass_ticket=4taWOLI7Rh2AVMRJ5hfeeRH3DDTmQAnVUiYTfUBCeRW4oZR5z0ZbHj7rLhJSkI%20k&amp;wx_header=1&amp;fontgear=2#wechat_redirect" data-linktype="2">CellChat细胞通讯分析（三）多组别比较分析</a></section></li></ul><p data-tool="mdnice编辑器">在此基础上，我还写了CellphoneDB的笔记：<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247508318&amp;idx=1&amp;sn=17c096db0c85ee056f738912d5816cc0&amp;scene=21#wechat_redirect" data-linktype="2">细胞通讯分析之CellphoneDB初探（一）</a>，在这个帖子里简单介绍了CellphoneDB，以及CellphoneDB的环境配制、单样本实战，最后提供了一个可视化的函数<code>cellphoneDB_Dotplot</code>。另外，cellphoneDB似乎是不支持小鼠等其他物种的数据，因此我写了 <a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247485748&amp;idx=1&amp;sn=a9a2229babc722013f5ea0e2a2db7dac&amp;scene=21#wechat_redirect" data-linktype="2">一行代码完成单细胞数据人鼠基因同源转换</a>，提供了一个函数，一行代码完成人鼠的基因同源转换，然后用转换后的数据走cellphoneDB流程即可。</p><p data-tool="mdnice编辑器">本期的帖子接上文，主要<span>解决</span>CellphoneDB的2个问题：</p><ul data-tool="mdnice编辑器"><li><section>由于目前一个单细胞项目基本包含数个/数十个样本，如何实现CellphoneDB的批量处理；</section></li><li><section>实现更多更丰富的可视化。</section></li></ul><h3 data-tool="mdnice编辑器">一. CellphoneDB的批量处理</h3><h4 data-tool="mdnice编辑器">1.1 首先在R语言环境下输出表达数据及表型数据：</h4><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(Seurat)<br><span>library</span>(tidyverse)<br><span>library</span>(data.table)<br><span>library</span>(dplyr)<br><span>library</span>(readr)<br><br><span>#### 1.load data</span><br>scRNA = read_rds(<span>"./Step4.m.seurat.rds"</span>)<br><br><span>#### 2.批量输出Output</span><br>out.dir = <span>"Step8.CellphoneDB/"</span><br><span>for</span>(sample <span>in</span> unique(scRNA$sampleID)){<br>  sp1 &lt;- subset(scRNA,sampleID == sample)<br>  sp1_counts &lt;- as.data.frame(sp1@assays$RNA@data) %&gt;% <br>    rownames_to_column(var = <span>"Gene"</span>)<br>  <br>  sp1_meta &lt;- data.frame(Cell=rownames(sp1@meta.data), <br>                         cell_type=sp1@meta.data$celltype)<br>  <br>  fwrite(sp1_counts,file = paste0(out.dir,sample,<span>"_counts.txt"</span>), row.names=<span>F</span>, sep=<span>'\t'</span>)<br>  fwrite(sp1_meta, file = paste0(out.dir,sample,<span>"_meta.txt"</span>), row.names=<span>F</span>, sep=<span>'\t'</span>)<br>}<br></code></pre><p data-tool="mdnice编辑器">运行之后<code>out.dir</code>目录下就会生成每个样本的表达数据和meta表型数据的txt文件。</p><img data-ratio="0.6277777777777778" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los9BicQvl1a4iasiaN0753dUPXbkmnaczg6YfNzYBaZYl3fHm4hV6tW5NhVWiaYEbVCsbp5u1NRXH14Eaw/640?wx_fmt=other" data-type="other" data-w="900" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los9BicQvl1a4iasiaN0753dUPXbkmnaczg6YfNzYBaZYl3fHm4hV6tW5NhVWiaYEbVCsbp5u1NRXH14Eaw/640?wx_fmt=other"><p data-tool="mdnice编辑器">然后在Linux环境下批量运行CellphoneDB：</p><h4 data-tool="mdnice编辑器">1.2 首先写一个通用型的shell脚本</h4><pre data-tool="mdnice编辑器"><span></span><code><span>#</span><span><span>#进入目的文件夹</span></span><br>cd Step8.CellphoneDB/<br><span><br>#</span><span><span>#先写个脚本</span></span><br>cat &gt;gc_cellphoneDB.bash<br>file_count=./$1_counts.txt<br>file_anno=./$1_meta.txt<br>outdir=./$1_Output<br><br>if [ ! -d ${outdir} ]; then<br>mkdir ${outdir}<br>fi<br>cellphonedb method statistical_analysis ${file_anno} ${file_count} --counts-data hgnc_symbol --output-path ${outdir} --threshold 0.01 --threads 10 <br><span>#</span><span><span>#如果细胞数太多，可以添加下采样参数，默认只分析1/3的细胞</span></span><br><span>#</span><span>--subsampling</span><br><span>#</span><span>--subsampling-log <span>true</span> <span>#对于没有log转化的数据，还要加这个参数</span></span><br></code></pre><h4 data-tool="mdnice编辑器">1.3 然后批量运行</h4><pre data-tool="mdnice编辑器"><span></span><code><span>#</span><span><span>#激活环境</span></span><br>conda activate cpdb <br><span><br>#</span><span><span>#批量运行此脚本</span></span><br>ls *counts.txt | while read id;<br>do <br>id=${id%%_counts.txt}<br>echo $id<br>bash gc_cellphoneDB.bash $id 1&gt;${id}.log 2&gt;&amp;1 <br>done<br></code></pre><p data-tool="mdnice编辑器">每个样本的结果在当前目录下。</p><h3 data-tool="mdnice编辑器">二. CellphoneDB的多种可视化方案</h3><p data-tool="mdnice编辑器">除了我上期用健明老师的代码改编的函数<code>cellphoneDB_Dotplot</code>绘制气泡图（详见<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247508318&amp;idx=1&amp;sn=17c096db0c85ee056f738912d5816cc0&amp;scene=21#wechat_redirect" data-linktype="2">细胞通讯分析之CellphoneDB初探（一）</a>），我们还可以使用如下方案进行可视化。</p><h4 data-tool="mdnice编辑器">2.1 衔接Cellchat的函数</h4><p data-tool="mdnice编辑器">其实只要深刻理解Cellchat这个包的函数逻辑，我们即可用cellphoneDB的结果作为input数据，进行可视化。</p><p data-tool="mdnice编辑器">这里需要的文件是count_network.txt作为input数据。</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(CellChat)<br><span>library</span>(tidyr)<br>df.net &lt;- read.table(<span>"./Step8.CellphoneDB/GSM5573466_Output/Outplot/count_network.txt"</span>,<br>                     header = <span>T</span>,sep = <span>"\t"</span>,stringsAsFactors = <span>F</span>)<br>meta.data &lt;- read.table(<span>"./Step8.CellphoneDB/GSM5573466_meta.txt"</span>,<br>                        header = <span>T</span>,sep = <span>"\t"</span>,stringsAsFactors = <span>F</span>)<br><br>groupSize &lt;- as.numeric(table(meta.data$cell_type))<br><br>df.net &lt;- spread(df.net, TARGET, count)<br>rownames(df.net) &lt;- df.net$SOURCE<br>df.net &lt;- df.net[, -<span>1</span>]<br>df.net &lt;- as.matrix(df.net)<br><br>netVisual_circle(df.net, vertex.weight = groupSize,<br>                 weight.scale = <span>T</span>, label.edge= <span>F</span>,<br>                 title.name = <span>"Number of interactions"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.9659367396593674" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los9BicQvl1a4iasiaN0753dUPXbLMDE2rWqCcq7DQiciaibficd2w19h94RY4DWM4EmTFU4y8ZqhSWpNhWlCg/640?wx_fmt=other" data-type="other" data-w="411" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los9BicQvl1a4iasiaN0753dUPXbLMDE2rWqCcq7DQiciaibficd2w19h94RY4DWM4EmTFU4y8ZqhSWpNhWlCg/640?wx_fmt=other"><figcaption>image-20221229204130690</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code><span># par(mfrow = c(3,3), xpd=TRUE)</span><br><span>for</span> (i <span>in</span> <span>1</span>:nrow(df.net)) {<br>  mat2 &lt;- matrix(<span>0</span>, nrow = nrow(df.net), ncol = ncol(df.net), dimnames = dimnames(df.net))<br>  mat2[i, ] &lt;- df.net[i, ]<br>  <br>  netVisual_circle(mat2, <br>                   vertex.weight = groupSize,<br>                   weight.scale = <span>T</span>, <br>                   edge.weight.max = max(df.net),<br>                   title.name = rownames(df.net)[i],<br>                   arrow.size=<span>0.5</span>)<br>  <br>}<br></code></pre><p data-tool="mdnice编辑器">批量输出互作结果，这里只显示其中1个：</p><img data-ratio="0.9236499068901304" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los9BicQvl1a4iasiaN0753dUPXb4ibf7KtqMZiayhUvQPWU5pTEaahIam3ts5PWbzTpCWAcQxTUibfEu6Q1w/640?wx_fmt=other" data-type="other" data-w="537" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los9BicQvl1a4iasiaN0753dUPXb4ibf7KtqMZiayhUvQPWU5pTEaahIam3ts5PWbzTpCWAcQxTUibfEu6Q1w/640?wx_fmt=other"><h4 data-tool="mdnice编辑器">2.2 R包ktplots</h4><p data-tool="mdnice编辑器">参考追风哥在简书上写的笔记：10X单细胞 &amp;&amp; 10X空间转录组分析之cellphoneDB可视化进阶，github: https://github.com/zktuong/ktplots。这个包自带了非常多的可视化方案，这里列举其中一两种：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#devtools::install_github('zktuong/ktplots', dependencies = TRUE)</span><br><span>library</span>(ktplots)<br><span>library</span>(Seurat)<br><span>library</span>(SingleCellExperiment)<br><span>library</span>(tidyverse)<br><span>library</span>(data.table)<br><span>library</span>(dplyr)<br><span>library</span>(readr)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>#### 1 加载数据</span><br>mypvals &lt;- read.table(<span>"./Step8.CellphoneDB/GSM5573466_Output/pvalues.txt"</span>,header = <span>T</span>,sep = <span>"\t"</span>,stringsAsFactors = <span>F</span>,check.names = <span>F</span>)<br>mymeans &lt;- read.table(<span>"./Step8.CellphoneDB/GSM5573466_Output/means.txt"</span>,header = <span>T</span>,sep = <span>"\t"</span>,stringsAsFactors = <span>F</span>,check.names = <span>F</span>) <br>mydecon &lt;- read.table(<span>"./Step8.CellphoneDB/GSM5573466_Output/deconvoluted.txt"</span>,header = <span>T</span>,sep = <span>"\t"</span>,stringsAsFactors = <span>F</span>,check.names = <span>F</span>)<br><br><span>#单细胞数据</span><br>seurat.data = read_rds(<span>"./Step4.m.seurat.rds"</span>)<br>scRNA =  subset(seurat.data,sampleID == <span>"GSM5573466"</span>)<br>table(scRNA$celltype)<br><span>#Seurat转SCE</span><br>sce &lt;- Seurat::as.SingleCellExperiment(scRNA)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>## Vis 1</span><br>p1 &lt;- plot_cpdb3(cell_type1 = <span>'CD4T|Treg'</span>, <br>                 cell_type2 = <span>'EpiC|EpiInt|EpiPit'</span>,<br>                 scdata = sce,<br>                 idents = <span>'celltype'</span>, <span># column name where the cell ids are located in the metadata</span><br>                 means = mymeans,<br>                 pvals = mypvals,<br>                 deconvoluted = mydecon, <span># new options from here on specific to plot_cpdb3</span><br>                 keep_significant_only = <span>TRUE</span>,<br>                 standard_scale = <span>TRUE</span>,<br>                 remove_self = <span>TRUE</span>,<br>                 legend.pos.x = -<span>5</span>,legend.pos.y = <span>5</span><br>)<br>p1<br></code></pre><img data-ratio="0.7066115702479339" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los9BicQvl1a4iasiaN0753dUPXbbQbr94pg8AVpw4SZJrQTMp0pRq1omXA5o7g8S2GDoBjfKVohPQ0waA/640?wx_fmt=other" data-type="other" data-w="1210" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los9BicQvl1a4iasiaN0753dUPXbbQbr94pg8AVpw4SZJrQTMp0pRq1omXA5o7g8S2GDoBjfKVohPQ0waA/640?wx_fmt=other"><p data-tool="mdnice编辑器">再复杂一点的：</p><pre data-tool="mdnice编辑器"><span></span><code>p2 &lt;- plot_cpdb2(cell_type1 = <span>"CD4T|Treg"</span>, <span># same usage style as plot_cpdb</span><br> cell_type2 = <span>'EpiC|EpiInt|EpiPit'</span>,<br> idents = <span>'celltype'</span>,<br> scdata = sce,<br> means = mymeans,<br> pvals = mypvals,<br> deconvoluted = mydecon, <span># new options from here on specific to plot_cpdb2</span><br> desiredInteractions = list(c(<span>'CD4T'</span>, <span>'Treg'</span>), c(<span>'Treg'</span>, <span>'EpiC'</span>), c(<span>'Treg'</span>, <span>'EpiInt'</span>), c(<span>'Treg'</span>, <span>'EpiPit'</span>)),<br> interaction_grouping = interaction_annotation,<br>    edge_group_colors = c(<span>"Activating"</span> = <span>"#e15759"</span>, <span>"Chemotaxis"</span> = <span>"#59a14f"</span>, <span>"Inhibitory"</span> = <span>"#4e79a7"</span>, <span>"Intracellular trafficking"</span> = <span>"#9c755f"</span>, <span>"DC_development"</span> = <span>"#B07aa1"</span>),<br>    node_group_colors = c(<span>"CD4T"</span> = <span>"#86bc86"</span>, <span>"Treg"</span> = <span>"#79706e"</span>, <span>"EpiC"</span> = <span>"#ff7f0e"</span>, <span>"EpiInt"</span> = <span>"#bcbd22"</span>  ,<span>"EpiPit"</span> = <span>"#17becf"</span>),<br>    keep_significant_only = <span>TRUE</span>,<br>    standard_scale = <span>TRUE</span>,<br>    remove_self = <span>TRUE</span>)<br>p2<br></code></pre><img data-ratio="0.849" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los9BicQvl1a4iasiaN0753dUPXbFImibZXBiaNdYkfmmoBXtaFUZw3IUprk9xEvBhTmJHjgydu6pWQBydZA/640?wx_fmt=other" data-type="other" data-w="1000" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2Los9BicQvl1a4iasiaN0753dUPXbFImibZXBiaNdYkfmmoBXtaFUZw3IUprk9xEvBhTmJHjgydu6pWQBydZA/640?wx_fmt=other"><p data-tool="mdnice编辑器">R包ktplots提供了非常多的可视化方案，详见github: https://github.com/zktuong/ktplot</p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/fKZe4GXyO6y2AI3b7ivYIg",target="_blank" rel="noopener noreferrer">原文链接</a>
