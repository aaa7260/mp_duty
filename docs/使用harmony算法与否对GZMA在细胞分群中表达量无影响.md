---
title: "使用harmony算法与否对GZMA在细胞分群中表达量无影响"
date: 2022-09-18T14:12:41Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
使用harmony算法与否对GZMA在细胞分群中表达量无影响 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>这周的推文是对一篇文献 《Systemic Blockade of Clever-1 Elicits Lymphocyte Activation Alongside Checkpoint Molecule Downregulation in Patients with Solid Tumors: Results from a Phase I/II Clinical Trial》中的数据集进行复现，该篇文献只对Tcell进行单细胞测序。整合C1D0 (C1D1),C4D7 (C4D8),C4D14 (C4D15)样本数据进行第一层次降维分群，之后再对CD8+ Tcell进行二次降维分群，我们拿到的数据是 CD8A-expressing CD8+ T-cell的csv文件。</p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="0.11243386243386243" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3Pp94tAI4lQ5eg59D4m0jIiaF8DrFdEhW63MwJekr9UE9dUjfUZ1hVUIA/640?wx_fmt=png" data-type="png" data-w="756" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3Pp94tAI4lQ5eg59D4m0jIiaF8DrFdEhW63MwJekr9UE9dUjfUZ1hVUIA/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><p>数据集：GSE1521693个样品：GSM4605352 C1D0 (C1D1)GSM4605353 C4D7 (C4D8)GSM4605354 C4D14 (C4D15)</p></blockquote><p data-tool="mdnice编辑器">要复现的图：</p><p data-tool="mdnice编辑器"><img data-ratio="0.7412280701754386" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PL45W2uTfC6uoHx7rDrXUhFQSdGa6zuKGvRrgYcSGxZd2ImrpDo6S1Q/640?wx_fmt=png" data-type="png" data-w="228" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PL45W2uTfC6uoHx7rDrXUhFQSdGa6zuKGvRrgYcSGxZd2ImrpDo6S1Q/640?wx_fmt=png"><img data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PHgmVfY5rad1YcQnreUr8RRyjoAvibzkgu5Eg6qhWcKhfRRT9FRf2vDw/640?wx_fmt=png" data-type="png" data-w="210" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PHgmVfY5rad1YcQnreUr8RRyjoAvibzkgu5Eg6qhWcKhfRRT9FRf2vDw/640?wx_fmt=png"></p><blockquote data-tool="mdnice编辑器"><p>文章中所用参数：CD8A-expressing CD8+ T-cell clusters were selected from initial clusters and subclustered by reapplying FindVariableFeatures, ScaleData, FindNeighbors, FindClusters, and RunUMAP with 15 dimensions and resolution 0.6.</p></blockquote><p data-tool="mdnice编辑器"><strong>下面是对该数据进行复现的代码</strong></p><blockquote data-tool="mdnice编辑器"><p>在复现该数据的时候，发现文章中的图没有进行harmony算法整合，我一开始想当然的认为从Tcell中提出的CD8+ Tcell子集，之后对CD8+ Tcell再次降维分群就是细分亚群，这当然需要进行harmony整合，而经过曾老师提醒，我是直接用CD8+Tcell降维分群来查看GZMA在细胞亚群中的表达量，并未对该数据进行细分。因此还是属于第一层次，所以即使不做harmony也没问题，既然都想到这一步，索性就对该数据的harmony前后对比一下。具体代码和可视化结果如下。</p></blockquote><p data-tool="mdnice编辑器"><strong>导入数据</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span>#文章中选择的是resolution = 0.6</span><br>rm(list=ls())<br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><span>library</span>(patchwork)<br><span>###step1：导入数据###</span><br>getwd()<br>dir.create(<span>"./outputs"</span>)<br>setwd(<span>"./outputs/"</span>)<br><span>library</span>(data.table)<br><span>#counts&lt;-read.csv("~/scrna_cell/20220908_GSE152169_human/data/GSE152169_expression_matrix_normalized_cd8.csv",row.names = 1)</span><br>counts=fread(<span>"~/scrna_cell/20220908_GSE152169_human/data/GSE152169_expression_matrix_normalized_cd8.csv.gz"</span>)<br>counts&lt;-as.data.frame(counts)<br>rownames(counts)&lt;-counts[,<span>1</span>] <br>counts&lt;-counts[,-<span>1</span>]<br>counts[<span>1</span>:<span>3</span>,<span>1</span>:<span>4</span>]<br>sce =CreateSeuratObject(counts,<br>                        min.cells = <span>5</span>,<br>                        min.features = <span>300</span> )<br>colnames(sce@meta.data)<br></code></pre><p data-tool="mdnice编辑器"><strong>降维分群</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span>###step2：标准化和降维分群###</span><br>sce &lt;- NormalizeData(sce, normalization.method =  <span>"LogNormalize"</span>,  <br>                     scale.factor = <span>1e4</span>)<br>GetAssay(sce,assay = <span>"RNA"</span>)<br>sce &lt;- FindVariableFeatures(sce, <br>                            selection.method = <span>"vst"</span>, nfeatures = <span>2000</span>)  <br>sce &lt;- ScaleData(sce) <br>sce &lt;- RunPCA(object = sce, pc.genes = VariableFeatures(sce)) <br>DimHeatmap(sce, dims = <span>1</span>:<span>12</span>, cells = <span>100</span>, balanced = <span>TRUE</span>)<br>ElbowPlot(sce) <br><br>sce &lt;- FindNeighbors(sce, dims = <span>1</span>:<span>15</span>)<br>sce &lt;- FindClusters(sce, resolution = <span>0.6</span>)<br>table(sce@meta.data$RNA_snn_res.0.6)  <br><br>set.seed(<span>123</span>)<br>sce &lt;- RunUMAP(object = sce, dims = <span>1</span>:<span>15</span>, do.fast = <span>TRUE</span>)<br>DimPlot(sce,reduction = <span>"umap"</span>,label=<span>T</span>) <br>ggsave(filename = <span>'before_harmony_umap.pdf'</span>,width = <span>8</span>,height = <span>8</span>) <br>head(sce@meta.data)<br>DimPlot(sce,reduction = <span>"umap"</span>,label=<span>T</span>,group.by = <span>'orig.ident'</span>) <br>ggsave(filename = <span>'before_harmony_umap_orig.ident.pdf'</span>,width = <span>8</span>,height = <span>8</span>) <br><br><span>#未进行harmony，GZMA的Featureplot</span><br>FeaturePlot(sce,features = c(<span>"GZMA"</span>))<br>ggsave(filename = <span>'before_featureplot_GZMA.pdf'</span>,width = <span>6</span>,height = <span>6</span>)<br></code></pre><img data-ratio="0.46217494089834515" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PdPUa9mPiagoicPibv76lEBWKgXttFhkEHQmsV1m1qUGEicps4Us2bgjqng/640?wx_fmt=png" data-type="png" data-w="846" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PdPUa9mPiagoicPibv76lEBWKgXttFhkEHQmsV1m1qUGEicps4Us2bgjqng/640?wx_fmt=png"><pre data-tool="mdnice编辑器"><span></span><code><span>#我们把GZMA人为分为GZMA+和GZMA-来比对一下harmony前后对该基因在细胞中的表达量是否会不同</span><br>celltype=data.frame(ClusterID=<span>0</span>:<span>10</span>,<br>                    celltype=<span>0</span>:<span>10</span> )   <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>3</span>),<span>2</span>]=<span>'GZMA-'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>,<span>1</span>,<span>2</span>,<span>4</span>,<span>5</span>,<span>6</span>,<span>7</span>,<span>8</span>,<span>9</span>,<span>10</span>),<span>2</span>]=<span>'GZMA+'</span>  <br><br>head(celltype)<br>celltype <br>table(celltype$celltype)<br><br>counts2@meta.data$celltype = <span>"NA"</span><br>table(counts2@meta.data$RNA_snn_res.0.6 )<br><br><span>for</span>(i <span>in</span> <span>1</span>:nrow(celltype)){<br>  counts2@meta.data[which(counts2@meta.data$RNA_snn_res.0.6 == celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]}<br>table(counts2@meta.data$celltype)<br><br><span>#harmony前</span><br>tab.1=table(sce@meta.data$orig.ident,sce@meta.data$seurat_clusters)<br>colnames(sce@meta.data)   <br><span>library</span>(gplots)<br>tab.1 <br>pro=<span>'before_harmony'</span><br>pdf(file = paste0(pro,<span>'before_GZMA.pdf'</span>),<br>    width = <span>9</span>,height  = <span>8</span>)<br>balloonplot(tab.1, main =<span>"GZMA- VS  GZMA+ "</span>, xlab =<span>""</span>, ylab=<span>""</span>,<br>            label = <span>T</span>, show.margins = <span>F</span>)<br>dev.off() <br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.9043715846994536" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PiaK6sNlGUibpIG4RE34c1Dpujde0oFnzuaYeib1BG2sWAxv7lSMJ1eozw/640?wx_fmt=png" data-type="png" data-w="366" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PiaK6sNlGUibpIG4RE34c1Dpujde0oFnzuaYeib1BG2sWAxv7lSMJ1eozw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>harmony</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span>###step3: harmony###</span><br>colnames(sce@meta.data)  <br><span>library</span>(harmony)<br>seuratObj &lt;- RunHarmony(sce, <span>"orig.ident"</span>)<br>names(seuratObj@reductions)<br>seuratObj &lt;- RunUMAP(seuratObj,  dims = <span>1</span>:<span>15</span>, <br>                     reduction = <span>"harmony"</span>)<br>DimPlot(seuratObj,reduction = <span>"umap"</span>,label=<span>T</span> )  <br><br>sce=seuratObj<br>sce &lt;- FindNeighbors(sce, reduction = <span>"harmony"</span>,<br>                     dims = <span>1</span>:<span>15</span>)<br>sce &lt;- FindClusters(sce, resolution = <span>0.6</span>)<br>table(sce@meta.data$seurat_clusters)<br>DimPlot(sce,reduction = <span>"umap"</span>,label=<span>T</span>) <br>ggsave(filename = <span>'harmony_umap_recluster_by_0.1.pdf'</span>,width = <span>8</span>,height = <span>8</span>) <br>DimPlot(sce,reduction = <span>"umap"</span>,label=<span>T</span>,<br>        group.by = <span>'orig.ident'</span>) <br>ggsave(filename = <span>'harmony_umap_sce_recluster_by_orig.ident.pdf'</span>,width = <span>8</span>,height = <span>8</span>)<br><br>FeaturePlot(sce,features = c(<span>"GZMA"</span>))<br>ggsave(filename = <span>'featureplot_GZMA.pdf'</span>,width = <span>6</span>,height = <span>6</span>)<br><br><span>#同样定义为GZMA+和GZMA-</span><br>celltype=data.frame(ClusterID=<span>0</span>:<span>10</span>,<br>                    celltype=<span>0</span>:<span>10</span> )   <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>3</span>),<span>2</span>]=<span>'GZMA-'</span> <br><br>celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>,<span>1</span>,<span>2</span>,<span>4</span>,<span>5</span>,<span>6</span>,<span>7</span>,<span>8</span>,<span>9</span>,<span>10</span>),<span>2</span>]=<span>'GZMA+'</span>  <br><br>head(celltype)<br>celltype <br>table(celltype$celltype)<br><br>sce@meta.data$celltype = <span>"NA"</span><br>table(sce@meta.data$RNA_snn_res.0.6 )<br><br><span>for</span>(i <span>in</span> <span>1</span>:nrow(celltype)){<br>  sce@meta.data[which(sce@meta.data$RNA_snn_res.0.6 == celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]}<br>table(sce@meta.data$celltype)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.4648581997533909" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PWroqqRMvFRVbC0alSTrHNECicysp2iaX2qUv6xwAO7hPT0WdwNvVU98A/640?wx_fmt=png" data-type="png" data-w="811" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PWroqqRMvFRVbC0alSTrHNECicysp2iaX2qUv6xwAO7hPT0WdwNvVU98A/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>#harmony后</span><br>tab.1=table(sce@meta.data$celltype,sce@meta.data$seurat_clusters)<br>colnames(sce@meta.data)   <br><span>library</span>(gplots)<br>tab.1 <br>pro=<span>'after_harmony'</span><br>pdf(file = paste0(pro,<span>'GZMA.pdf'</span>),<br>    width = <span>9</span>,height  = <span>8</span>)<br>balloonplot(tab.1, main =<span>" GZMA- VS  GZMA+ "</span>, xlab =<span>""</span>, ylab=<span>""</span>,<br>            label = <span>T</span>, show.margins = <span>F</span>)<br>dev.off() <br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.9065155807365439" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PEaEJK8MCStjpJSgF7L9j2kI9Ipo9TicW5wZWCqUjNibcbiccSG9Giafkkg/640?wx_fmt=png" data-type="png" data-w="353" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PEaEJK8MCStjpJSgF7L9j2kI9Ipo9TicW5wZWCqUjNibcbiccSG9Giafkkg/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span><span>两次数据分析对比结果可视化</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>#我们将两次数据未进行harmony和 进行harmony的对比</span><br>tab.2=table(counts2@meta.data$celltype,sce@meta.data$celltype)<br>balloonplot(tab.2, main =<span>" before harmony VS after harmony"</span>, xlab =<span>""</span>, ylab=<span>""</span>,<br>            label = <span>T</span>, show.margins = <span>F</span>)<br><br>harmony<br>GZMA- GZMA+ <br>  <span>475</span>  <span>2784</span><br><br>no-harmony<br>GZMA- GZMA+ <br>  <span>413</span>  <span>2846</span><br></code></pre><p data-tool="mdnice编辑器"><strong>最后通过table得到的balloonplot发现其实做不做harmony对基因GZMA在细胞分群中表达量基本上没有影响。</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="1.0893470790378006" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PFygOiaVUJREKrFdNQMm29SB4daqdk392Fv6Ol7NUDfqAsGCj7UVhnwA/640?wx_fmt=png" data-type="png" data-w="291" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9THgkxCede3hD8Qt22rF3PFygOiaVUJREKrFdNQMm29SB4daqdk392Fv6Ol7NUDfqAsGCj7UVhnwA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">如果还想进一步了解harmony在什么情况下使用，可以去看一下之前曾老师写的推文。</p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzU1MjkyODQ0NA==&amp;mid=2247483802&amp;idx=7&amp;sn=5e7a7f96a7b13a6758af791206a2e576&amp;scene=21#wechat_redirect" data-linktype="2">使用harmony等算法去除单细胞样品差异得谨慎</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzU1MjkyODQ0NA==&amp;mid=2247483802&amp;idx=8&amp;sn=7d29281dd08a771be38e98d9be39d9e7&amp;scene=21#wechat_redirect" data-linktype="2">细分亚群后需要使用harmony去除样品差异 </a></p></section><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/3MrmpanYjM9__Dpm4BXprg",target="_blank" rel="noopener noreferrer">原文链接</a>
