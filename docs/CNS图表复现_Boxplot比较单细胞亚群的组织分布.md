---
title: "CNS图表复现：Boxplot比较单细胞亚群的组织分布"
date: 2022-10-08T06:15:16Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
CNS图表复现：Boxplot比较单细胞亚群的组织分布 by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">对单细胞数据进行亚群注释之后，我们往往想比较某亚群，例如CD8Tex，是倾向于分布在实验组还是对照组，例如癌组织，癌旁组织，转移癌组织，淋巴组织？这时候有很多策略去做这种多组间的比较。如我在<a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484467&amp;idx=1&amp;sn=d0b54f5f77f48e9cebddc774216db1f6&amp;scene=21#wechat_redirect" data-linktype="2">《CNS图表复现：OR指数比较单细胞亚群的组织偏好》</a>所述：</p><p data-tool="mdnice编辑器"><strong>第一种</strong>，是《Therapy-Induced Evolution of Human Lung Cancer Revealed by Single-Cell RNA Sequencing》这篇Cell的做法，这篇文章有三种处理组（TN，RD和PD），<strong>或许是因为用的Smart-seq2测序，每个样本得到的细胞数量确实不多</strong>，因此作者简单粗暴的把同一组内的样本细胞加和计算亚群细胞的频率，进行统计，绘图如下：</p><figure data-tool="mdnice编辑器"><p><img data-galleryid="" data-ratio="0.2950310559006211" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqX0ibmKnFMyfeOST4lcwvWz7F83szNxjQpneJTiaZ5IslFOcr2KdehdIonsU2XwOYhakcrC6umKxFTQ/640?wx_fmt=png" data-type="png" data-w="966" src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqX0ibmKnFMyfeOST4lcwvWz7F83szNxjQpneJTiaZ5IslFOcr2KdehdIonsU2XwOYhakcrC6umKxFTQ/640?wx_fmt=png"></p></figure><p data-tool="mdnice编辑器">这种做法其实是存在一定问题的，它画不出所有样本分布的散点图，因为本质上作者把同一组的亚群看成一个样本。我在<a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484042&amp;idx=1&amp;sn=d12fbe7a757bebe68a46eee98a875ef8&amp;scene=21#wechat_redirect" data-linktype="2">单细胞思考：Cell作者一定是对的吗？</a>此文中复现了作者的处理思路和图表。</p><p data-tool="mdnice编辑器">我也在如上推文中给出了<strong>第二种</strong>多组间亚群比较的策略，<strong>即按照每个样本的细胞总和进行百分比的校正，然后比较频率。</strong>这也是绝大多数文章采取的策略，例如《Pan-cancer single-cell landscape of tumor-infiltrating T cells》张泽民团队比较多癌种某单细胞亚群的频率分布差异，一个散点代表一个样本：</p><figure data-tool="mdnice编辑器"><p><img data-galleryid="" data-ratio="0.502086230876217" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqX0ibmKnFMyfeOST4lcwvWz7bKDE1xFxvYGdgPOe8Fe1PpfEIFxccC7KdUowvT4NFYwbaoqSic9Y4MQ/640?wx_fmt=png" data-type="png" data-w="719" src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqX0ibmKnFMyfeOST4lcwvWz7bKDE1xFxvYGdgPOe8Fe1PpfEIFxccC7KdUowvT4NFYwbaoqSic9Y4MQ/640?wx_fmt=png"></p><figcaption><br></figcaption></figure><p data-tool="mdnice编辑器"><strong>第三种策略</strong>也是出现在《Pan-cancer single-cell landscape of tumor-infiltrating T cells》张泽民老师的这篇文章中，即Fig1F的这幅图，利用OR比值比的统计学方法，比较血液，正常组织和肿瘤组织，各单细胞亚群的分布差异，详见<a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484467&amp;idx=1&amp;sn=d0b54f5f77f48e9cebddc774216db1f6&amp;scene=21#wechat_redirect" data-linktype="2">《CNS图表复现：OR指数比较单细胞亚群的组织偏好》</a>。</p><figure data-tool="mdnice编辑器"><p><img data-galleryid="" data-ratio="1.6950354609929077" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqX0ibmKnFMyfeOST4lcwvWz7RresNXgYGtDZEq8bQicn9lAjmF95BARNR4hRKnpehr4OdohPLMwGoYg/640?wx_fmt=png" data-type="png" data-w="282" src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqX0ibmKnFMyfeOST4lcwvWz7RresNXgYGtDZEq8bQicn9lAjmF95BARNR4hRKnpehr4OdohPLMwGoYg/640?wx_fmt=png"></p><figcaption><br></figcaption></figure><p data-tool="mdnice编辑器"><strong>第四种策略</strong>也是张泽民团队经常使用的一个统计方法，Ro/e，这个指标是观察到的细胞数与期望细胞数的比值，用于量化每个亚群对组织的偏好程度</p><p data-tool="mdnice编辑器">有一位锲而不舍的读者想让我复现张泽民老师团队的Boxplot画法，其实张泽民团队公开的代码就有这个图的画法，我在此基础上做了一些调整，见下文。</p><h4 data-tool="mdnice编辑器"><span></span>二. 图表复现<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(data.table)<br><span>library</span>(readr)<br><span>library</span>(dplyr)<br><span>library</span>(plyr)<br><span>library</span>(ggpubr)<br><span>library</span>(ggplot2)<br><span>library</span>(patchwork)<br><span># 本次画图的技巧支持多线程运行</span><br>RhpcBLASctl::omp_set_num_threads(<span>2</span>)<br>doParallel::registerDoParallel(cores = <span>2</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>#### 1.加载数据</span><br>meta.tb = read_rds(<span>"./test_data.rds"</span>)<br><br><span>#### 2.数据预处理</span><br><span>### 2.1 （可选）这里选择CD8T亚群进行可视化，这里的loc的L分组作者原文是不进行画图展示的，因此过滤掉</span><br>dat.plot = data.table(filter(meta.tb,stype == <span>"CD8"</span>&amp;loc != c(<span>"L"</span>)))<br><br><span>### 2.2 绘图需要指定celltype标签(celltype)、分组信息(Group)、以及患者编号(SampleID)</span><br>dat.plot$Celltype = dat.plot$meta.cluster<br>dat.plot$Group = factor(dat.plot$loc,levels = c(<span>"P"</span>,<span>"N"</span>,<span>"T"</span>))<br>dat.plot$SampleID = dat.plot$patient.uid<br><br><span>### 2.3 统计细胞出现的频数和频率</span><br>dat.plot &lt;- dat.plot[,.(N=.N),by=c(<span>"cancerType"</span>,<span>"SampleID"</span>,<span>"Celltype"</span>,<span>"Group"</span>)]<br>sum.data &lt;- dat.plot[,{.(NTotal = sum(.SD$N))},by=c(<span>"cancerType"</span>,<span>"SampleID"</span>,<span>"Group"</span>)]<br><br>dat.plot = left_join(dat.plot,sum.data)<br>dat.plot$freq = dat.plot$N / dat.plot$NTotal *<span>100</span><br>head(dat.plot)<br></code></pre><figure data-tool="mdnice编辑器"><p><img data-galleryid="" data-ratio="0.17486338797814208" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqX0ibmKnFMyfeOST4lcwvWz7Iy2zrKxUAD5tn5BVTscvmIKMwxPyUoTYuwQ03GAQD51ezdUW3n68Xw/640?wx_fmt=png" data-type="png" data-w="915" src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqX0ibmKnFMyfeOST4lcwvWz7Iy2zrKxUAD5tn5BVTscvmIKMwxPyUoTYuwQ03GAQD51ezdUW3n68Xw/640?wx_fmt=png"></p></figure><pre data-tool="mdnice编辑器"><span></span><code><span>#### 3.可视化</span><br><span>### 3.1 指定输出的目录</span><br>out.prefix.loc.cmp = <span>"./Outplot/"</span><br><br><span>### 3.2 指定比较组以生成p值</span><br>compraisions.list=list(c(<span>"P"</span>,<span>"N"</span>),c(<span>"N"</span>,<span>"T"</span>),c(<span>"P"</span>,<span>"T"</span>))<br><br><span>### 3.3.设置配色</span><br>g.colSet = list(group = c(<span>"P"</span> = <span>"#e75945"</span>,<span>"N"</span> = <span>"#f39b7f"</span>,<span>"T"</span> = <span>"#00a087"</span>,<span>"L"</span> = <span>"#BC3C29FF"</span>))<br><br><span>### 3.4 ggboxplot可视化（换成ggplot2也行），同时lapply<span>支持多线程运行</span></span><br>p.list.perMcls &lt;- lapply(unique(sort(dat.plot$Celltype)),<span>function</span>(mcls){<br>  <br>  text.size = <span>10</span><br>  text.angle = <span>45</span><br>  text.hjust = <span>1</span><br>  legend.position = <span>"none"</span><br>  p &lt;- ggboxplot(dat.plot[Celltype== mcls ,],x=<span>"Group"</span>,y=<span>"freq"</span>,<br>                 color = <span>"Group"</span>, legend=<span>"none"</span>,title=mcls,<br>                 <span>#fill = "loc",alpha=0.8,</span><br>                 <span>#add = "none",outlier.shape=NA) +</span><br>                 xlab=<span>""</span>,ylab=<span>"frequency"</span>,<br>                 add = <span>"jitter"</span>,outlier.shape=<span>NA</span>) +<br>    scale_color_manual(values=g.colSet$group) +<br>    <span>#scale_color_manual(values=c("P"="#E41A1C","N"="#377EB8","T"="#4DAF4A")) +</span><br>    <span>#scale_fill_manual(values=c("P"="#E41A1C","N"="#377EB8","T"="#4DAF4A")) +</span><br>    stat_compare_means(label=<span>"p.format"</span>,comparisons=compraisions.list) +<br>    coord_cartesian(clip=<span>"off"</span>) +<br>    theme(plot.title = element_text(size = text.size+<span>2</span>,color=<span>"black"</span>,hjust = <span>0.5</span>),<br>          axis.ticks = element_line(color = <span>"black"</span>),<br>          axis.title = element_text(size = text.size,color =<span>"black"</span>), <br>          axis.text = element_text(size=text.size,color = <span>"black"</span>),<br>          axis.text.x = element_text(angle = text.angle, hjust = text.hjust ), <span>#,vjust = 0.5</span><br>          <span>#axis.line = element_line(color = "black"),</span><br>          <span>#axis.ticks = element_line(color = "black"),</span><br>          <span>#panel.grid.minor.y = element_blank(),</span><br>          <span>#panel.grid.minor.x = element_blank(),</span><br>          <span># panel.grid=element_blank(), # 去网格线</span><br>          legend.position = legend.position,<br>          legend.text = element_text(size= text.size),<br>          legend.title= element_text(size= text.size),<br>          <span># panel.border = element_rect(fill=NA,color="black", size=1, linetype="solid"),</span><br>          strip.background = element_rect(color=<span>"black"</span>,size= <span>1</span>, linetype=<span>"solid"</span>) <span># fill="#FC4E07", </span><br>    )<br>  <span># ggsave打开即可保存图片 </span><br>  <span>#ggsave(sprintf("%s.compostion.PNT.%s.png",out.prefix.loc.cmp,mcls),width=2,height=4.5)</span><br>  <span># ggsave(sprintf("%sepi.compostion.PNT.%s.pdf",out.prefix.loc.cmp,make.names(mcls)),</span><br>  <span>#        width=5,height= 7.5 ,useDingbats=F,units = "cm")</span><br>  <span>return</span>(p)<br>})<br>p.prop = wrap_plots(p.list.perMcls,ncol = <span>6</span>)<br>p.prop<br>ggsave(p.prop,filename = paste0(out.prefix.loc.cmp,<span>"Propotion_boxplot.pdf"</span>),width = <span>22</span>,height = <span>12</span>,units = <span>"cm"</span>)<br></code></pre></section><p><img data-galleryid="" data-ratio="0.7916287534121929" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqX0ibmKnFMyfeOST4lcwvWz76jpfNkc0ibibFfaNBwGDdV42chSYG25Kicz5ZgWicficFPPE8PaQtRgzN7w/640?wx_fmt=png" data-type="png" data-w="1099" src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqX0ibmKnFMyfeOST4lcwvWz76jpfNkc0ibibFfaNBwGDdV42chSYG25Kicz5ZgWicficFPPE8PaQtRgzN7w/640?wx_fmt=png"></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">测试数据及全文markdown代码后台回复：</p><p><mp-pay-preview-filter></mp-pay-preview-filter></p></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/eWYGQGbW4XXLIakUkA7fag",target="_blank" rel="noopener noreferrer">原文链接</a>
