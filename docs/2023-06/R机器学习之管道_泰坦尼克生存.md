---
title: "R机器学习之管道：泰坦尼克生存"
date: 2023-06-15T15:42:52Z
draft: ["false"]
tags: [
  "fetched",
  "R语言与数学建模"
]
categories: ["Acdemic"]
---
R机器学习之管道：泰坦尼克生存 by R语言与数学建模
------
<div><p data-first-child="" data-pid="C7VhUhZl">用最新 R 机器学习框架 mlr3verse 实现经典机器学习案例。</p><p data-pid="65N_Xihf">本文有和鲸网可在线运行版本：</p><p data-pid="65N_Xihf">https://www.heywhale.com/mw/project/6470cd41b1251d62bfaea1d5</p><p><span>数据预处理、特征工程，是非常重要的机器学习步骤。为此，</span><code>mlr3verse</code><span>框架提供了强大的管道、图学习器技术。</span></p><p data-pid="cgKBF5-C">一个管道运算（<code>PipeOp</code>），表示机器学习管道中的一个计算步骤。一系列的<code>PipeOps</code>通过边连接（<code>%&gt;&gt;%</code>）构成图（<code>Graph</code>），图可以是简单的线性图，也可以是复杂的非线性图。</p><p data-pid="xmwF-igT">这让我们可以像搭建积木一样，搭建出复杂的图，数据将沿着搭建好的图流动，完成从预处理到机器学习算法构成的整个过程：</p><ul><li><p>选取<code>PipeOp</code>, 通过<code>%&gt;&gt;%</code>、<code>gunion()</code>、<code>ppl()</code> 等搭建图</p></li><li><p><code>Graph$plot()</code><span>绘制图的结构关系；</span></p></li><li><p><code>as_learner(Graph)</code><span>将图转化为学习器，即可跟普通学习器一样使用</span></p></li></ul><p data-pid="OcRgN6ah">管道、图学习器主要用于：</p><ul><li><p>特征工程：缺失值插补、特征变换、特征选择、处理不均衡数据……</p></li><li><p><span>集成学习：装袋法、堆叠法</span></p></li><li><p><span>分支训练、分块训练</span></p></li></ul><p data-pid="zjRY-q4O">本篇以<code>Titanic</code>数据为例，借助管道技术，展示数据预处理、特征工程、机器学习算法流程化操作。</p><p data-pid="qrMQKYjD">加载包</p><pre><code>library(tidyverse)<br>library(mlr3verse)</code></pre><h3>1 准备数据</h3><pre><code>titanic <span>=</span> read_csv(<span>"titanic.csv"</span>)<br>glimpse(titanic)</code></pre><figure data-size="normal"><img data-ratio="0.3328112764291308" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdStsYNX0vTxKRGsy0kNDqZBTLozWTDjaKTtSJA3Maib5o45Yvx3UbrwA/640?wx_fmt=other" data-type="other" data-w="1277" height="425" width="1277" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdStsYNX0vTxKRGsy0kNDqZBTLozWTDjaKTtSJA3Maib5o45Yvx3UbrwA/640?wx_fmt=other"></figure><h3>2 数据预处理</h3><p data-pid="jxOn4v9z"><span>2.1 类型转化</span></p><p data-pid="0a-jh0dc">有些字符型特征，转化为（有序）因子型：</p><pre><code>titanic <span>=</span> titanic <span>%</span><span>&gt;</span><span>%</span> <br>  mutate(survived <span>=</span> factor(survived, c(<span>"yes"</span>,<span>"no"</span>)),<br>         sex <span>=</span> factor(sex, c(<span>"female"</span>,<span>"male"</span>)),<br>         embarked <span>=</span> factor(embarked, c(<span>"C"</span>,<span>"Q"</span>,<span>"S"</span>)),<br>         pclass <span>=</span> factor(pclass, c(<span>"1"</span>,<span>"2"</span>,<span>"3"</span>), ordered <span>=</span> <span>TRUE</span>),<br>         across(c(parch,sib_sp), as.<span>integer</span>))</code></pre><p data-pid="rPLd1ze2"><span>2.2 构建新特征</span></p><p data-pid="C7sABVzn">在原特征基础上，从背景知识出发构建对预测更有帮助的若干新特征：</p><ul><li><p>人均票价</p></li><li><p><span>座舱等级</span></p></li><li><p><span>头衔</span></p></li><li><p><span>姓氏</span></p></li><li><p><span>船票前缀</span></p></li></ul><p><br></p><pre><code>titanic <span>=</span> titanic <span>%</span><span>&gt;</span><span>%</span> <br>  mutate(fare_per_person <span>=</span> fare <span>/</span> (parch <span>+</span> sib_sp <span>+</span> <span>1</span>),<br>         deck <span>=</span> factor(str_sub(cabin, <span>1</span>, <span>1</span>)),<br>         title <span>=</span> factor(str_extract(name, <span>"(?&lt;=, ).*(?=\\.)"</span>)),<br>         surname <span>=</span> factor(str_extract(name, <span>"^.*(?=,)"</span>)),<br>         ticket_prefix <span>=</span> factor(str_extract(ticket, <span>"^.*(?= )"</span>))) <span>%</span><span>&gt;</span><span>%</span> <br>  <span>select</span>(<span>!</span>where(<span>is</span>.<span>character</span>))</code></pre><p data-pid="zDx-U3uD"><span>注：</span> 这也属于特征工程，也可以在图学习器管道步中来做。</p><h3>3 创建任务</h3><p data-pid="WLhhErS8"><span>任务</span>，是数据的封装。</p><pre><code><span>task</span> <span>=</span> as_task_classif(titanic, target <span>=</span> <span>"survived"</span>)</code></pre><p data-pid="yPqiinXY">该数据的目标列<code>survived</code>，前<code>891</code>行不缺失，<code>892:1309</code>行缺失，设为<code>"holdout"</code>（留出）：</p><pre><code><span>task</span><span>$</span>set_row_roles(<span>892</span>:<span>1309</span>, <span>"holdout"</span>)<br><span>task</span></code></pre><figure data-size="normal"><img data-ratio="0.2490566037735849" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdib3P7ZnItPqwBEvuuiaPRyv4q7YscAnKj8cdjrMO1e8CicLn8gBqT23vA/640?wx_fmt=other" data-type="other" data-w="1060" height="264" width="1060" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdib3P7ZnItPqwBEvuuiaPRyv4q7YscAnKj8cdjrMO1e8CicLn8gBqT23vA/640?wx_fmt=other"></figure><p data-pid="g98wOLVW">简单可视化探索：</p><pre><code>autoplot(<span>task</span>)</code></pre><figure data-size="normal"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmd7eve4rsVBW1wW7ibSM56ic2OAFqv9wEwAQbGEXLp6uibdKUnTYMor6Alw/640?wx_fmt=other" data-type="other" data-w="840" height="840" width="840" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmd7eve4rsVBW1wW7ibSM56ic2OAFqv9wEwAQbGEXLp6uibdKUnTYMor6Alw/640?wx_fmt=other"></figure><pre><code>cols <span>=</span> c(<span>"sex"</span>, <span>"age"</span>)<br>autoplot(<span>task</span><span>$</span>clone()<span>$</span><span>select</span>(cols), <span>type</span> <span>=</span> <span>"pairs"</span>)</code></pre><figure data-size="normal"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdbr3rKictErVBLOQoXQXdlQaI8GRbwPyH434GrTZqHPNicJibaT7yq58og/640?wx_fmt=other" data-type="other" data-w="840" height="840" width="840" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdbr3rKictErVBLOQoXQXdlQaI8GRbwPyH434GrTZqHPNicJibaT7yq58og/640?wx_fmt=other"></figure><h3>4 特征工程</h3><p data-pid="luXIawNU"><span>4.1 处理缺失值</span></p><p data-pid="Hsz-1uQv">查看缺失情况：</p><pre><code><span>task</span><span>$</span>missings()</code></pre><figure data-size="normal"><img data-ratio="0.2701863354037267" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdtlJBcnE7q8eXD0e0QVShEpqLEBXO2HSCssagOvMF2nfcTzcoZVshrQ/640?wx_fmt=other" data-type="other" data-w="966" height="261" width="966" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdtlJBcnE7q8eXD0e0QVShEpqLEBXO2HSCssagOvMF2nfcTzcoZVshrQ/640?wx_fmt=other"></figure><p data-pid="F_FnDOie">按想做的插补流程搭建管道图：</p><ul><li><p>对数值特征：增加一列是否缺失的标记列，同时用直方图法插补，需要接<span>特征并</span></p></li><li><p><span>对因子特征：超出范围插补，特别适合基于树的模型</span></p></li></ul><p><br></p><pre><code>po_indicator <span>=</span> po(<span>"missind"</span>,<br>  affect_columns <span>=</span> selector_type(c(<span>"numeric"</span>, <span>"integer"</span>)), <br>  <span>type</span> <span>=</span> <span>"numeric"</span>)<br>impute_step <span>=</span> gunion(list(po_indicator, po(<span>"imputehist"</span>))) <span>%</span><span>&gt;&gt;</span><span>%</span> <br>  po(<span>"featureunion"</span>) <span>%</span><span>&gt;&gt;</span><span>%</span> <br>  po(<span>"imputeoor"</span>)<br>impute_step<span>$</span>plot()</code></pre><figure data-size="normal"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdYOnA8Wic7fic4F6sNTgIpV85X1QSibOyD66PvPibibPV5hsWcLib4ldJcGxw/640?wx_fmt=other" data-type="other" data-w="840" height="840" width="840" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdYOnA8Wic7fic4F6sNTgIpV85X1QSibOyD66PvPibibPV5hsWcLib4ldJcGxw/640?wx_fmt=other"></figure><p data-pid="jO1LGVqq"><span>4.2 处理分类特征</span></p><ul><li><p>折叠占数据 3% 以下的因子水平</p></li><li><p><span>移除空的、训练期间不存在的因子水平</span></p></li><li><p><span>若某些因子水平在训练时未出现，而只是在预测时出现，则取一个随机水平值</span></p></li></ul><p><br></p><pre><code>cat_step <span>=</span> po(<span>"collapsefactors"</span>, <br>         param_vals <span>=</span> list(no_collapse_above_prevalence <span>=</span> <span>0.03</span>)) <span>%</span><span>&gt;&gt;</span><span>%</span><br>  po(<span>"fixfactors"</span>) <span>%</span><span>&gt;&gt;</span><span>%</span><br>  po(<span>"imputesample"</span>) <br>cat_step<span>$</span>plot()</code></pre><figure data-size="normal"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdqSZY8JZpbLoAW7cPDI1JgWwxiafVVuKe9BntVkwooPVE96UAmvIZt9g/640?wx_fmt=other" data-type="other" data-w="840" height="840" width="840" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdqSZY8JZpbLoAW7cPDI1JgWwxiafVVuKe9BntVkwooPVE96UAmvIZt9g/640?wx_fmt=other"></figure><h3>5 选择学习器</h3><p data-pid="ns6j9yRo"><span>学习器</span>，是机器学习算法的封装，选择随机森林分类学习器。</p><pre><code><span>#</span> 需要ranger包<br>rf <span>=</span> lrn(<span>"classif.ranger"</span>, predict_type <span>=</span> <span>"prob"</span>, num.trees <span>=</span> <span>500</span>, min.node.size <span>=</span> <span>4</span>)<br>rf</code></pre><figure data-size="normal"><img data-ratio="0.2610619469026549" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdg5D0cdLXAH4ibQTWXVmsb1GpmH0j7khUDwlZHAjyB2N3Al6rECw9FZg/640?wx_fmt=other" data-type="other" data-w="1130" height="295" width="1130" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdg5D0cdLXAH4ibQTWXVmsb1GpmH0j7khUDwlZHAjyB2N3Al6rECw9FZg/640?wx_fmt=other"></figure><h3>6 图学习器</h3><p data-pid="1FhaxoQd">接入预处理部分，构建完整的图：</p><pre><code>graph <span>=</span> impute_step <span>%</span><span>&gt;&gt;</span><span>%</span> cat_step <span>%</span><span>&gt;&gt;</span><span>%</span> rf<br>graph<span>$</span>plot()</code></pre><figure data-size="normal"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdbcmrGEMsUcwQH0DcjChWUHPpbkChppETsMGhwCTgvriaOayTm86uL2Q/640?wx_fmt=other" data-type="other" data-w="840" height="840" width="840" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdbcmrGEMsUcwQH0DcjChWUHPpbkChppETsMGhwCTgvriaOayTm86uL2Q/640?wx_fmt=other"></figure><p data-pid="mRHqXLco">转化为图学习器：</p><pre><code>glrn <span>=</span> as_learner(graph)</code></pre><h3>7 训练并评估模型性能</h3><p data-pid="OxsweGGq">图学习器<code>glrn</code>可以像普通学习器一样使用，采用<code>5</code>折交叉验证重抽样：</p><pre><code>set.seed(<span>1</span>)<br>rr <span>=</span> resample(<span>task</span>, glrn, rsmp(<span>"cv"</span>, folds <span>=</span> <span>5</span>))</code></pre><p data-pid="pHAmXVkk">查看重抽样结果，模型性能：</p><pre><code>rr<span>$</span>aggregate(msr(<span>"classif.auc"</span>))     <span>#</span> 平均AUC</code></pre><figure data-size="normal"><img data-ratio="0.2946859903381642" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdoXvTibo9UibDvq7cO5L06uAgKpLncz9x0Hww1zBTe8jI4f5ic9cxYbuRw/640?wx_fmt=other" data-type="other" data-w="207" height="61" width="207" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdoXvTibo9UibDvq7cO5L06uAgKpLncz9x0Hww1zBTe8jI4f5ic9cxYbuRw/640?wx_fmt=other"></figure><pre><code>rr<span>$</span>score(msr(<span>"classif.auc"</span>))      <span>#</span> 每折AUC</code></pre><figure data-size="normal"><img data-ratio="0.3770833333333333" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdG1ia8eQSmxAHLGmwMtxm9QvpRnyp2MBkp6mmEwQNS0P3e3H41bQxicLQ/640?wx_fmt=other" data-type="other" data-w="1440" height="625" width="1657" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdG1ia8eQSmxAHLGmwMtxm9QvpRnyp2MBkp6mmEwQNS0P3e3H41bQxicLQ/640?wx_fmt=other"></figure><p data-pid="gSZRtNSu">可视化重抽样结果：</p><pre><code>autoplot(rr, <span>type</span> <span>=</span> <span>"roc"</span>)</code></pre><figure data-size="normal"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdSlf0UwuIzYicfFdqNc2ts8891Ywjd28AMEJbAicMD90iccjyHNUme2xKA/640?wx_fmt=other" data-type="other" data-w="840" height="840" width="840" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCS4SrDIlXsoHgQdkWmrNmdSlf0UwuIzYicfFdqNc2ts8891Ywjd28AMEJbAicMD90iccjyHNUme2xKA/640?wx_fmt=other"></figure><p data-pid="yJcJyUq4">本篇主要参考 <span>A Pipeline for the Titanic Data Set - Advanced：</span></p><p><span>https://mlr-org.com/gallery/pipelines/2020-04-27-mlr3pipelines-Imputation-titanic/index.html</span></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/e9DVKozsh38xi_CHWU3Ntw",target="_blank" rel="noopener noreferrer">原文链接</a>
