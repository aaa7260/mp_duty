---
title: "​tsne及umap图美化"
date: 2023-06-25T16:16:06Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
​tsne及umap图美化 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span>❝</span><p>应群里的小伙伴的建议，这周的推文先更新一篇关于美化umap图的推文。（交流群在：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512238&amp;idx=1&amp;sn=e0c6dc2ea0e089aabb78133e50fb5d7f&amp;chksm=fa457593cd32fc853fe308bf65c9f642ae906ce9a06cc5eae87b8e807d36dfa0f98f8defe707&amp;scene=21#wechat_redirect" textvalue="为爱发电不可取（单细胞周更需要你的支持）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">为爱发电不可取（单细胞周更需要你的支持）</a>）</p><p>经过群里问卷的调研，之后更新方向会聚焦在单细胞高级分析相关内容（细胞通讯，拟时序，富集分析等等），单细胞常规分析figure美化，文献figure复现和文献分享四方面。</p><span>❞</span></blockquote><p data-tool="mdnice编辑器">通过查看一些单细胞转录组测序的文章，发现文章中的umap图主要分为以下几种。与用Dimplot直接作出的umap图差别在去掉了横纵坐标轴，并且在左下角添加了一个小的坐标轴，另外还有对细胞亚群加了框框。<img data-ratio="0.6675925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMMxeGRqp7K22lsrvUEDAqunqPD0dKibVMgLSt32oibss4Vtv1ajsd6wfg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMMxeGRqp7K22lsrvUEDAqunqPD0dKibVMgLSt32oibss4Vtv1ajsd6wfg/640?wx_fmt=png"></p><h4 data-tool="mdnice编辑器"><span></span>下面来让我试一下能不能画出发表级别的umap图<span></span></h4><h4 data-tool="mdnice编辑器"><span></span>导入数据<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br><span># devtools::install_github("sajuukLyu/ggunchull", type = "source")</span><br><span># install.packages("tidydr")</span><br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><span>library</span>(ggunchull)<br><span>library</span>(tidydr)<br><span>library</span>(ggsci)<br><span>library</span>(Cairo)<br><br>getwd()<br>dir.create(<span>"./figure"</span>)<br>setwd(<span>"./figure"</span>)  <br><br>load(<span>"../3-cell/sce.all_by_celltype.Rdata"</span>)<br><br>color = c(pal_d3(<span>"category20"</span>)(<span>20</span>),<br>          pal_d3(<span>"category20b"</span>)(<span>20</span>),<br>          pal_d3(<span>"category20c"</span>)(<span>20</span>),<br>          pal_d3(<span>"category10"</span>)(<span>10</span>))<br><br>color2=c(<span>"#D9AB42"</span>,<span>"#A35E47"</span>,<span>"#0F4C3A"</span>,<span>"#563F2E"</span>,<span>"#78C2C4"</span>,<span>"#C73E3A"</span>,<span>"#B47157"</span>,<span>"#2B5F75"</span>)<br><br>DimPlot(sce.all, reduction = <span>"tsne"</span>, group.by = <span>"celltype"</span>,<br>        cols = color2,<br>        pt.size = <span>1.5</span>,<br>        label = <span>T</span>,label.box = <span>T</span><br>) <br>ggsave(file=<span>"tsne.pdf"</span>,width = <span>12</span>,height = <span>9</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7520759193357058" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMxnOyicJR0cexZXNHV3tX0WegJoDPKNR3BPxEra39ysRg6QT84NC1kicg/640?wx_fmt=png" data-type="png" data-w="843" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMxnOyicJR0cexZXNHV3tX0WegJoDPKNR3BPxEra39ysRg6QT84NC1kicg/640?wx_fmt=png"></figure><h4 data-tool="mdnice编辑器"><span></span>提取tsne二维数据<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>df=sce.all@reductions$tsne@cell.embeddings %&gt;%<br>  as.data.frame() %&gt;%<br>  cbind(celltype=sce.all@meta.data$celltype)<br><br>head(df)<br><span>#umap数据提取同理</span><br></code></pre><h4 data-tool="mdnice编辑器"><span></span>去除坐标轴及使用ggunchull加框框<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#tsne</span><br>CairoPDF(<span>"tsne_ggunchull.pdf"</span>, width=<span>12</span>, height=<span>9</span>) <br>p_tsne=ggplot(df, aes(tSNE_1, tSNE_2, color=celltype,fill = celltype))+<br>  geom_point(size = <span>1</span>) + <span>#细胞亚群点的大小</span><br>  scale_color_manual(values=color2)+<br>  theme(panel.border = element_blank(), <span>#边框</span><br>        axis.title = element_blank(),  <span>#轴标题</span><br>        axis.text = element_blank(), <span># 文本</span><br>        axis.ticks = element_blank(),<br>        <span>#panel.grid = element_blank(),</span><br>        <span># panel.grid.major = element_blank(), #网格线</span><br>        <span># panel.grid.minor = element_blank(), #网格线</span><br>        panel.background = element_rect(fill = <span>'white'</span>), <span>#背景色</span><br>        plot.background=element_rect(fill=<span>"white"</span>),<span>#背景色</span><br>        legend.title = element_blank(), <span>#去掉legend.title </span><br>        legend.key=element_rect(fill=<span>'white'</span>), <br>        legend.text = element_text(size=<span>14</span>), <span>#设置legend标签的大小</span><br>        legend.key.size=unit(<span>0.6</span>,<span>'cm'</span>) )+<br>  stat_unchull(<br>    fill = <span>"white"</span>,<br>    alpha = <span>0</span>,<br>    show.legend = <span>FALSE</span>,<br>    nsm = <span>30</span>,<br>    nbin = <span>150</span>,<br>    sfac = <span>1.2</span>)+<br>guides(fill= guide_legend(override.aes = list(size = <span>4</span>)))+ <span>#图例点的大小</span><br>  scale_color_manual(values=color2);p_tsne<br>dev.off()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7398692810457517" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMFdlYmqAPsYWAibmKWofvUxueW7jxNfUzmlck5ibNDp499ulGRU3OcwBA/640?wx_fmt=png" data-type="png" data-w="765" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMFdlYmqAPsYWAibmKWofvUxueW7jxNfUzmlck5ibNDp499ulGRU3OcwBA/640?wx_fmt=png"><figcaption>image.png</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>使用stat_ellipse加置信区间<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>CairoPDF(<span>"tsne_ellipse.pdf"</span>, width=<span>12</span>, height=<span>9</span>) <br><span>#用stat_ellipse加置信区间</span><br>p_tsne1=ggplot(df, aes(tSNE_1, tSNE_2, color=celltype))+<br>  geom_point(size = <span>1</span>) + <span>#细胞亚群点的大小</span><br>  scale_color_manual(values=color2)+<br>  theme(panel.border = element_blank(), <span>#边框</span><br>   axis.title = element_blank(),  <span>#轴标题</span><br>   axis.text = element_blank(), <span># 文本</span><br>   axis.ticks = element_blank(),<br>  <span># panel.grid = element_blank(),</span><br>  <span># panel.grid.major = element_blank(), #网格线</span><br>  <span># panel.grid.minor = element_blank(), #网格线</span><br>   panel.background = element_rect(fill = <span>'white'</span>), <span>#背景色</span><br>   plot.background=element_rect(fill=<span>"white"</span>),<br>   legend.title = element_blank(), <span>#去掉legend.title </span><br>   legend.key=element_rect(fill=<span>'white'</span>), <br>   legend.text = element_text(size=<span>14</span>), <span>#设置legend标签的大小</span><br>   legend.key.size=unit(<span>0.6</span>,<span>'cm'</span>) )+<br>  stat_ellipse(aes(x = tSNE_1, y = tSNE_2, fill = celltype),<br>              geom = <span>"polygon"</span>,<span>#多边形</span><br>              linetype=<span>2</span>, <span># 椭圆，虚线</span><br>              alpha = <span>0.05</span>,  <span>#椭圆不透明度</span><br>              show.legend = <span>FALSE</span>, <span>#去掉椭圆对应的图例</span><br>              level = <span>0.93</span>)+ <span>#置信区间</span><br>  guides(fill= guide_legend(override.aes = list(size = <span>4</span>)))+ <span>#图例点的大小</span><br>  scale_color_manual(values=color2); p_tsne1 <br>dev.off()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7283464566929134" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMk8UkXIkZF5N0rPYkZPSDL6h7qTvld0fteWnyniaPJ2XOw3AUUKRWOaQ/640?wx_fmt=png" data-type="png" data-w="762" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMk8UkXIkZF5N0rPYkZPSDL6h7qTvld0fteWnyniaPJ2XOw3AUUKRWOaQ/640?wx_fmt=png"><figcaption>image.png</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>加坐标轴<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#theme_dr加左下角的坐标</span><br><span>#呈现效果如图，如果还想更加精确的加上细胞群外圈的框框的话，PPT和AI或许是更好的选择。</span><br><span>#theme_dr</span><br>CairoPDF(<span>"tsne_theme_dr.pdf"</span>, width=<span>12</span>, height=<span>9</span>) <br>p_tsne2&lt;-p_tsne1+theme_dr(xlength = <span>0.22</span>, ylength = <span>0.22</span>,<br>    arrow = grid::arrow(length = unit(<span>0.15</span>, <span>"inches"</span>), type = <span>"closed"</span>)<br>  )+theme(panel.grid = element_blank());p_tsne2<br><br>dev.off()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7461139896373057" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMhqY8Udk0oRGD1rwWcxPSPgeyAUG7yEticU6CxIoxQNeQIUJZ0EcQj4A/640?wx_fmt=png" data-type="png" data-w="772" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMhqY8Udk0oRGD1rwWcxPSPgeyAUG7yEticU6CxIoxQNeQIUJZ0EcQj4A/640?wx_fmt=png"><figcaption>image.png</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>加标签<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#先提取出tSNE_1的位置信息</span><br>celltype_position &lt;- df %&gt;%<br>  group_by(celltype) %&gt;%<br>  dplyr::summarise(<br>    tSNE_1 = median(tSNE_1),<br>    tSNE_2 = median(tSNE_2))<br> <br><span>library</span>(ggrepel)<br>CairoPDF(<span>"tsne_label.pdf"</span>, width=<span>12</span>, height=<span>9</span>) <br>p_tsne3&lt;-p_tsne2+<span>#geom_point(aes(color=factor(celltype)), size=3)+</span><br>  geom_label_repel(data = celltype_position,aes(label=celltype), <br>                   fontface=<span>"bold"</span>,point.padding=unit(<span>0.1</span>, <span>"lines"</span>))+theme(legend.position = <span>"none"</span>);p_tsne3<br><br>dev.off()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7666666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMwUdrKo5BibEHm0zDicYN8KSG9VJc7OiaGmpJXHxicibsBS2ibpOhodrxW4xw/640?wx_fmt=png" data-type="png" data-w="660" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMwUdrKo5BibEHm0zDicYN8KSG9VJc7OiaGmpJXHxicibsBS2ibpOhodrxW4xw/640?wx_fmt=png"><figcaption>image.png</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>总结<span></span></h4><blockquote data-tool="mdnice编辑器"><span>❝</span><p>在使用ggplot2画tsne或者umap图的时候，首先用theme()把主题背景，坐标轴等删除，之后可以用ggunchull或stat_ellipse加上框框，之后用theme_dr参数加上小坐标轴，标签需要用ggrepel包的geom_label_repel函数添加。</p><p>在作图的过程中想到，要想更好的基于ggplot2作图，学会创建stat,geom,theme这些参数是必不可少的。</p><p><br></p><span>❞</span></blockquote><h3 data-tool="mdnice编辑器"><span></span><span>微信交流群</span><span></span></h3><p data-tool="mdnice编辑器">如果你也想参与到群里的讨论中，给我提出一些推文更新建议的话欢迎入群。同时你也可以得到我前期更新的所有数据及代码，在群里我会把代码分享给大家，而且大家可以在群里<strong>「提出自己感兴趣的单细胞文献」</strong>我们尽可能优先选择大家的数据集去复现和实战，也欢迎大家在群里分享更多其它资料，咱们一起进步，<strong>「比较高级的单细胞分析」</strong>我们也会一起尝试， 相信你肯定是会不虚此行哈。</p><p data-tool="mdnice编辑器">附上上周推文的链接 <a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512238&amp;idx=1&amp;sn=e0c6dc2ea0e089aabb78133e50fb5d7f&amp;scene=21#wechat_redirect" data-linktype="2">为爱发电不可取（单细胞周更需要你的支持）</a></p><p data-tool="mdnice编辑器">上周已经说过我们这个群是真正的付费交流群，不仅提供数据，代码，学习资料，而且也会跟大家互动交流，还会坚持进行创作至少一年。</p><p data-tool="mdnice编辑器"><strong>「目前群里已经有接近200人，所以你想要进群的话就需要添加我的微信，私聊给我发99元的红包，我把你拉进群里。」</strong></p><span>是真正的付费交流群，因为提供数据，代码，学习资料，并且跟大家互动交流，而且会坚持进行创作至少一年。所以，如果介意99元的门槛，请不要加我好友。。。</span><img data-ratio="1.0068181818181818" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMfxY47qy5SxDwF5EfnWRd838hPEYo9lC7ADXSwExvpl4KgV2MeljeaA/640?wx_fmt=png" data-type="png" data-w="440" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosibO2UvPZJfQgeCLuFiaO21AMfxY47qy5SxDwF5EfnWRd838hPEYo9lC7ADXSwExvpl4KgV2MeljeaA/640?wx_fmt=png"></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/bZ9DYkKOKYo2w1OaoBxc1w",target="_blank" rel="noopener noreferrer">原文链接</a>
