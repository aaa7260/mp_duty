---
title: "富集分析的原理与实现"
date: 2023-06-25T04:07:58Z
draft: ["false"]
tags: [
  "fetched",
  "TOP生物信息"
]
categories: ["Acdemic"]
---
富集分析的原理与实现 by TOP生物信息
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">一般做完差异分析都会做这一步，目的是找到差异基因富集到的通路，进而与生物学意义联系起来。具体的统计方法很简单，这篇笔记里面的代码可以从零搭建一个富集分析工具。</p><blockquote data-tool="mdnice编辑器"><span>❝</span><p>后台回复20211007获取本文的测试数据和代码，以及（单细胞）转录组分析中可能用到的GO KEGG富集分析代码（这部分本文不演示）。</p><span>❞</span></blockquote><p data-tool="mdnice编辑器">关于Gene Ontology (GO), KEGG这些背景就不讲了，网上很多资料。</p><p data-tool="mdnice编辑器">将富集分析中的问题抽象出来，其实就是下图的“摸球”问题。</p><figure data-tool="mdnice编辑器"><img data-fileid="100000805" data-ratio="0.6035911602209945" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Znj63wMFy1oYw9XEQlVBR6iaaZdhUWVaibu5ml7sJAJhLQhShRXiaxkTcAwq9NwXUY1HsaTaCU6RfLw/640?wx_fmt=png" data-type="png" data-w="724" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Znj63wMFy1oYw9XEQlVBR6iaaZdhUWVaibu5ml7sJAJhLQhShRXiaxkTcAwq9NwXUY1HsaTaCU6RfLw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">蓝色方框中的球是所有的基因【共N个】，在探究某个特定通路P时，通路里面涉及到的基因用红色表示【共M个】。绿色圆圈是一次摸球事件，用来表示做了一次差异分析得到的基因【共n个】，这些基因中，有属于通路P的(红色球)【共k个】，有不属于的(黑色球)。</p><p data-tool="mdnice编辑器">用摸球问题中的语言再描述一次：袋子中共有黑球和红球N个，其中红球M个。某次抽样中，一共摸球n个，其中红球k个，问在这次摸球中，红球的占比是否显著高于袋子中红球的占比？（以前学摸球问题/超几何分布的时候，可能只求概率，没有进一步到这个统计检验）</p><p data-tool="mdnice编辑器">回答这个问题，需要求出问题中这个事件的概率以及更极端事件的概率之和，也就是p值，小于0.05或者0.01就能认为是显著了。</p><h3 data-tool="mdnice编辑器"><span></span><span><span></span>1. 一个通路，计算p值</span><span></span></h3><p data-tool="mdnice编辑器">接下来以一个GO term (GO_extracellular_matrix_organization)为例，计算p值。用的通路基因集是小鼠 GO BP的基因集，差异基因集是单细胞转录组分析中一个cluster的高表达基因</p><pre data-tool="mdnice编辑器"><span></span><code>library(tidyverse)<br>library(clusterProfiler)<br><br>gmt.df=read.gmt("Mm.c5.bp.v7.1.SYMBOL.gmt")<br>deg=read.table("test_deg.txt",header = T,sep = "\t",stringsAsFactors = F)<br>deg=deg[deg$gene %in% gmt.df$gene,]<br></code></pre><p data-tool="mdnice编辑器">这种情况下，前面说的几个参数的值如下：</p><ul data-tool="mdnice编辑器"><li><section>全部球的个数/全部基因数：<code>N=length(unique(gmt.df$gene))</code></section></li><li><section>全部红球的个数/通路基因集的基因数：<code>one.set=gmt.df[ gmt.df$term %in% c("GO_extracellular_matrix_organization") ,] M=length(one.set$gene)</code></section></li><li><section>摸球数/差异基因数：<code>n=length(deg$gene)</code></section></li><li><section>摸球中红球的个数/差异基因中属于这个通路的基因数：<code>k=sum(deg$gene %in% one.set$gene)</code></section></li></ul><p data-tool="mdnice编辑器"><code>N M n k</code>的值分别为: <code>23210, 271, 47, 6</code></p><p data-tool="mdnice编辑器">求p值之前，先看一下满足N M n这三个参数的超几何分布，在不同的k值之下的概率：</p><pre data-tool="mdnice编辑器"><span></span><code>df1=data.frame(x=1:47,y=dhyper(x=1:47, M, N-M, n))<br>df1%&gt;%ggplot(aes(x,y))+geom_point()+<br>  geom_line()+<br>  geom_vline(xintercept=k,color="red",linetype=5)+  #这里k等于6，其作为阈值<br>  theme_bw()+<br>  theme(panel.grid = element_blank())<br></code></pre><p data-tool="mdnice编辑器">dhyper()用来求概率，四个参数分别是：摸球中红球个数的向量，袋中红球数，袋中黑球数，摸球数</p><figure data-tool="mdnice编辑器"><img data-fileid="100000808" data-ratio="0.712037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Znj63wMFy1oYw9XEQlVBR69TBdv2t2CiaPCticqZkTgUZAr7JOExGmgSGX26EiaqXw6goXUCqnL2w0A/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Znj63wMFy1oYw9XEQlVBR69TBdv2t2CiaPCticqZkTgUZAr7JOExGmgSGX26EiaqXw6goXUCqnL2w0A/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">我们要计算的就是红线以及右边那些红球数对应的概率之和，如下：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; phyper(k-1,M, N-M, n, lower.tail=FALSE)<br>[1] 1.722659e-05<br></code></pre><p data-tool="mdnice编辑器">当<code>lower.tail=FALSE</code>，计算的是<code>P[X &gt; x]</code>，即大于第一个参数的概率之和。上面的代码第一个参数写的是<code>k-1</code>，因为我们需要求k以及k右边的概率之和。</p><p data-tool="mdnice编辑器">以上是对一个通路求p值</p><hr data-tool="mdnice编辑器"><h3 data-tool="mdnice编辑器"><span></span><span><span></span>2. 多个通路，依次计算p值</span><span></span></h3><p data-tool="mdnice编辑器">如果是多个通路，需要循环操作，依次对每个通路进行富集分析。下面的演示用到的差异基因集和GO BP基因集同上</p><p data-tool="mdnice编辑器">分析哪些pathway？要满足两个条件：</p><ul data-tool="mdnice编辑器"><li><section>通路里面基因的数量满足一定要求</section></li><li><section>至少和deg有基因交集</section></li></ul><p data-tool="mdnice编辑器">下面的代码就是对通路做过滤的</p><pre data-tool="mdnice编辑器"><span></span><code>bp.stat=as.data.frame(table(gmt.df$term))<br>colnames(bp.stat)[1]="pathway"<br>bp.stat=bp.stat%&gt;%filter(Freq &gt;= 2 &amp; Freq &lt;= 2000)<br><br>tmp.df=gmt.df<br>tmp.df$TF=tmp.df$gene %in% deg$gene<br>tmp.stat=as.data.frame(tmp.df %&gt;% dplyr::group_by(term) %&gt;% dplyr::summarize(counts=sum(TF)))<br>tmp.stat=tmp.stat%&gt;%filter(counts &gt; 0)<br>keep.pw=sort(intersect(bp.stat$pathway,tmp.stat$term))<br></code></pre><p data-tool="mdnice编辑器">下面就是循环求p值了</p><pre data-tool="mdnice编辑器"><span></span><code>N=length(unique(gmt.df$gene))<br>n=length(deg$gene)<br>term=c()<br>pvalue=c()<br><br>for (i in keep.pw) {<br>  one.set=gmt.df[ gmt.df$term %in% i ,]<br>  M=length(one.set$gene)<br>  k=sum(deg$gene %in% one.set$gene)<br>  one.pvalue=phyper(k-1,M, N-M, n, lower.tail=FALSE)<br>  term=append(term,i)<br>  pvalue=append(pvalue,one.pvalue)<br>}<br><br>my_go_res=data.frame(term=term,pvalue=pvalue)<br>my_go_res=my_go_res%&gt;%arrange(pvalue)<br></code></pre><figure data-tool="mdnice编辑器"><img data-fileid="100000807" data-ratio="0.17407407407407408" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Znj63wMFy1oYw9XEQlVBR6IDGc2uiaSbyicdXRDQqjGjWfhafQjlYSDw4KNgt30q8IbS2Kzn0GSY2w/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Znj63wMFy1oYw9XEQlVBR6IDGc2uiaSbyicdXRDQqjGjWfhafQjlYSDw4KNgt30q8IbS2Kzn0GSY2w/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">到这会儿还没有结束，还差一个FDR</p><hr data-tool="mdnice编辑器"><h3 data-tool="mdnice编辑器"><span></span><span><span></span>3. 计算矫正p值</span><span></span></h3><p data-tool="mdnice编辑器"><code>FDR, False Discovery Rates</code>。为什么要控制FDR，降低假阳性。这里用到的是The Benjamini-Hochberg method</p><p data-tool="mdnice编辑器"><strong>「The Benjamini-Hochberg method」</strong></p><p data-tool="mdnice编辑器">假设我们对10个通路做了富集分析，我们会先得到10个p值：</p><ol data-tool="mdnice编辑器"><li><section>将这10个p值从小到大排序</section></li><li><section>从1到10给这些p值排序</section></li><li><section>最大的FDR adjusted p value（第10位）等于原来最大的那个p值</section></li><li><section>第9位的FDR adjusted p value等于这两个值中的较小值：①前一位矫正的p值；②当前未矫正的p值 * （p值总个数/当前位数）</section></li><li><section>重复第4步，直到第1位</section></li></ol><p data-tool="mdnice编辑器">代码如下：</p><pre data-tool="mdnice编辑器"><span></span><code>fdr=c()<br>for (i in dim(my_go_res)[1]:1) {<br>  if (i==dim(my_go_res)[1]) {<br>    tmpfdr=my_go_res$pvalue[i]<br>  }else{<br>    tmpfdr=min(tmpfdr,my_go_res$pvalue[i] * (dim(my_go_res)[1] / i))<br>  }<br>  fdr=append(fdr,tmpfdr)<br>}<br>my_go_res$p.adj=rev(fdr)<br></code></pre><figure data-tool="mdnice编辑器"><img data-fileid="100000809" data-ratio="0.13796296296296295" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Znj63wMFy1oYw9XEQlVBR6r4VjAyAmhu7IxXmQMUwsfbeChahSB1MYr7AdfjqkbFXLGw2u9FLVRA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Znj63wMFy1oYw9XEQlVBR6r4VjAyAmhu7IxXmQMUwsfbeChahSB1MYr7AdfjqkbFXLGw2u9FLVRA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">到这儿富集分析的完整流程才算结束</p><hr data-tool="mdnice编辑器"><h3 data-tool="mdnice编辑器"><span></span><span><span></span>4. 轮子有现成的</span><span></span></h3><p data-tool="mdnice编辑器">当然，这个算法已经非常常见了，clusterProfiler的enricher()就能够自定义基因集做富集分析。使用如下：</p><pre data-tool="mdnice编辑器"><span></span><code>deg_gmt=clusterProfiler::enricher(deg$gene,TERM2GENE = gmt.df,minGSSize = 2,maxGSSize = 2000)<br>go_res=deg_gmt@result<br></code></pre><figure data-tool="mdnice编辑器"><img data-fileid="100000806" data-ratio="0.15925925925925927" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Znj63wMFy1oYw9XEQlVBR6eMCUnichcZmhCO9yhyIK1dw3TrfxcOE3F1SHtgovO5Licu6fJ5Lib583g/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2Znj63wMFy1oYw9XEQlVBR6eMCUnichcZmhCO9yhyIK1dw3TrfxcOE3F1SHtgovO5Licu6fJ5Lib583g/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">和上面的结果是一模一样的。</p><blockquote data-tool="mdnice编辑器"><span>❝</span><p>今天的内容就到这里，后台回复20211007获取本文的测试数据和代码，以及（单细胞）转录组分析中可能用到的GO KEGG富集分析代码（这部分本文不演示）。</p><span>❞</span></blockquote><h3 data-tool="mdnice编辑器"><span></span><span><span></span>ref</span><span></span></h3><ul data-tool="mdnice编辑器"><li><section>超几何分布检验（hypergeometric test）：https://blog.csdn.net/linkequa/article/details/86491665</section></li><li><section>富集分析的p值是怎么算出来的？：公众号【YuLabSMU】</section></li><li><section>R tips 富集分析及其p值在R中的计算：公众号【生信菜鸟团】</section></li><li><section>False Discovery Rates, FDR, clearly explained：https://www.youtube.com/watch?v=K8LQSvtjcEo&amp;t=909s&amp;ab_channel=StatQuestwithJoshStarmer</section></li></ul></section><p><span>原推文发表于<span>2021-10-29</span>，本文为二次发布。</span></p><p><img data-fileid="100000661" data-ratio="0.3426666666666667" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2axZjuhcBMEdia3TJv1r062wlx6iccn76qHGArtic86bicFB2rzGyGmBalQnmXobKOcmlq7KVf9ZLhtUg/640?wx_fmt=png" data-type="png" data-w="750" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2axZjuhcBMEdia3TJv1r062wlx6iccn76qHGArtic86bicFB2rzGyGmBalQnmXobKOcmlq7KVf9ZLhtUg/640?wx_fmt=png"></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/2Bjge37yXLcEk6uESKJjYQ",target="_blank" rel="noopener noreferrer">原文链接</a>
