---
title: "区区20万个单细胞居然超内存了"
date: 2023-06-30T01:49:32Z
draft: ["false"]
tags: [
  "fetched",
  "珠海健明生物医药科技"
]
categories: ["Acdemic"]
---
区区20万个单细胞居然超内存了 by 珠海健明生物医药科技
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>我有一个备用的小mac电脑，只有64G内存，32线程，4T硬盘。最近搞活动，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519474&amp;idx=1&amp;sn=a07f2684e4bebfc5307add35cfbf82a2&amp;scene=21#wechat_redirect" data-linktype="2">春节期间单细胞转录组数据分析全免费</a>，收到了上百个需求，就把它拿出来了避免吃灰。</p></blockquote><p data-tool="mdnice编辑器">其中一个数据集是2020发在NC的肺癌单细胞文章：《Single-cell RNA sequencing demonstrates the molecular and cellular reprogramming of metastatic lung adenocarcinoma》，是44个肺癌病人的58个10x技术的单细胞转录组样品，因为是两三年前的10x单细胞技术那个时候都比较辣鸡所以细胞数量就平均每个样品是3千，这样的话合计是20万个单细胞。</p><p data-tool="mdnice编辑器">作者提供的是 GSE131907_Lung_Cancer_raw_UMI_matrix.txt.gz 文件，我们来演示一下读取它，并且进行单细胞降维聚类分群哈：</p><pre data-tool="mdnice编辑器"><span></span><code>a=fread(<span>'inputs/GSE131907_Lung_Cancer_raw_UMI_matrix.txt.gz'</span>,<br>        data.table = <span>F</span>)<br>a[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>rownames(a)=a[,<span>1</span>]<br>a=a[,-<span>1</span>]<br><span># 208,506 cells derived from 58 lung adenocarcinomas from 44 patients, </span><br><br><span># 11 tumour, 11 distant normal lung, 10 normal lymph node, and 10 metastatic brain tissue samples </span><br><span># were obtained from LUAD patients conserving surgery without prior treatment. </span><br><span>#  7 metastatic lymph node and 4 lung tumour tissue samples from advanced stage LUAD patient</span><br><span># endobronchial ultrasound (EBUS) and bronchoscopy (BRONCHO).</span><br><br>kp1 = grepl(<span>'LN'</span>,colnames(a))<br>table(kp1)<br>kp2 = grepl(<span>'T'</span>,colnames(a))<br>table(kp2 )<br><br>a[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>dim(a)<br></code></pre><p data-tool="mdnice编辑器">因为数据量很小，所以读取起来完全没有压力，有了两万个基因在20万个单细胞里面的表达量矩阵，就可以直接构建单细胞对象了，但是CreateSeuratObject(counts =  ct )  会报错，居然是内存问题。</p><p data-tool="mdnice编辑器">虽然我这个小mac电脑，只有64G内存，32线程，4T硬盘仅仅是备用电脑平时吃灰的， 但是不应该是区区20万个单细胞都搞不定啊，我思考了一下，大概是因为在R里面的两万个基因在20万个单细胞里面的表达量矩阵存储格式不经济，我简单看了看，居然占用了20G内存，怪不得呢。</p><p data-tool="mdnice编辑器">本来是想把它转为稀疏矩阵，但是也失败了，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><br><span>if</span>(<span>F</span>){<br>  format(object.size(a) ,units=<span>'Gb'</span>)<br>  A &lt;- as( a , <span>"sparseMatrix"</span>) <br>  B &lt;- Matrix(as.matrix(a), sparse = <span>TRUE</span>) <br>  <span>library</span>(Matrix)<br>  <span>library</span>(mltools)<br>  A = mltools::sparsify(a)<br>  format(object.size(A) ,units=<span>'Gb'</span>)<br>}<br><br></code></pre><p data-tool="mdnice编辑器">然后灵机一动，虽然这个两万个基因在20万个单细胞里面的表达量矩阵失败，但是它本来就是44个肺癌病人的58个10x技术的单细胞转录组样品，我只需要拆分构建Seurat对象，最后合并这些对象，也是同样的操作啊；</p><pre data-tool="mdnice编辑器"><span></span><code><br>sampl = paste0(phe[,<span>2</span>],phe[,<span>3</span>])<br> <br>sceList = lapply(unique(sampl) ,<span>function</span>(pro){ <br>  <span># pro=unique(sampl)[1] </span><br>  print(pro)  <br>  sce =CreateSeuratObject(counts = a[,sampl %<span>in</span>% pro],<br>                          project =  gsub( <span>'_matrix'</span>,<span>''</span>,pro)  ,<br>                          min.cells = <span>5</span>,<br>                          min.features = <span>500</span> )<br>  <br>  <span>return</span>(sce)<br>})<br>names(sceList) <br><br>sce.all=merge(x=sceList[[<span>1</span>]],<br>              y=sceList[ -<span>1</span> ] )<br>as.data.frame(sce.all@assays$RNA@counts[<span>1</span>:<span>10</span>, <span>1</span>:<span>2</span>])<br>head(sce.all@meta.data, <span>10</span>)<br>table(sce.all@meta.data$orig.ident) <br></code></pre><p data-tool="mdnice编辑器">这次果然就不报错了，我们有了对象，后面的质量控制和降维聚类分群就顺理成章的事情了。</p><h3 data-tool="mdnice编辑器"><span></span>然后质量控制并且降维聚类分群即可<span></span></h3><p data-tool="mdnice编辑器">质量控制其实每个数据集不一样的，取决于单细胞转录组来源的技术，特殊情况下需要个性化的修改 scRNA_scripts/qc.R 里面的代码：</p><pre data-tool="mdnice编辑器"><span></span><code><span>###### step2:QC质控 ######</span><br>dir.create(<span>"./1-QC"</span>)<br>setwd(<span>"./1-QC"</span>)<br><span># 如果过滤的太狠,就需要去修改这个过滤代码</span><br><span>source</span>(<span>'../scRNA_scripts/qc.R'</span>)<br>sce.all.filt = basic_qc(sce.all)<br>print(dim(sce.all))<br>print(dim(sce.all.filt))<br>setwd(<span>'../'</span>) <br><br></code></pre><p data-tool="mdnice编辑器">但是多样品整合，以及后续的降维聚类分群这个代码在任意单细胞转录组数据集都是大概率不需要修改的：</p><pre data-tool="mdnice编辑器"><span></span><code>sp=<span>'human'</span><br><br><span>###### step3: harmony整合多个单细胞样品 ######</span><br>dir.create(<span>"2-harmony"</span>)<br>getwd()<br>setwd(<span>"2-harmony"</span>)<br><span>source</span>(<span>'../scRNA_scripts/harmony.R'</span>)<br><span># 默认 ScaleData 没有添加"nCount_RNA", "nFeature_RNA"</span><br><span># 默认的</span><br>sce.all.int = run_harmony(sce.all.filt)<br>setwd(<span>'../'</span>)<br><br><span>###### step4: 降维聚类分群和看标记基因库 ######</span><br><span># 原则上分辨率是需要自己肉眼判断,取决于个人经验</span><br><span># 为了省力,我们直接看  0.1和0.8即可</span><br>table(Idents(sce.all.int))<br>table(sce.all.int$seurat_clusters)<br>table(sce.all.int$RNA_snn_res.0.1) <br>table(sce.all.int$RNA_snn_res.0.8) <br><br>getwd()<br>dir.create(<span>'check-by-0.1'</span>)<br>setwd(<span>'check-by-0.1'</span>)<br>sel.clust = <span>"RNA_snn_res.0.1"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br>dir.create(<span>'check-by-0.8'</span>)<br>setwd(<span>'check-by-0.8'</span>)<br>sel.clust = <span>"RNA_snn_res.0.8"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>然后就是合理的生物学命名了<span></span></h3><p data-tool="mdnice编辑器">我给大家准备的基因列表主要是针对肿瘤单细胞的第一层次降维聚类分群 ， 是：</p><ul data-tool="mdnice编辑器"><li><section>immune (CD45+,PTPRC),</section></li><li><section>epithelial/cancer (EpCAM+,EPCAM),</section></li><li><section>stromal (CD10+,MME,fibo or CD31+,PECAM1,endo)</section></li></ul><p data-tool="mdnice编辑器">参考我前面介绍过 <a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247488940&amp;idx=1&amp;sn=1cc8a8a74715087939b9721c0881775d&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现08—肿瘤单细胞数据第一次分群通用规则</a>，这3大单细胞亚群构成了肿瘤免疫微环境的复杂。绝大部分文章都是抓住免疫细胞亚群进行细分，包括淋巴系（T,B,NK细胞）和髓系（单核，树突，巨噬，粒细胞）的两大类作为第二次细分亚群。但是也有不少文章是抓住stromal 里面的fibo 和endo进行细分，并且编造生物学故事的。</p><p data-tool="mdnice编辑器">我这里给出来了的单细胞亚群的生物学名字是：</p><pre data-tool="mdnice编辑器"><span></span><code>  celltype=data.frame(ClusterID=<span>0</span>:<span>13</span> ,<br>                      celltype= <span>0</span>:<span>13</span>) <br>  <span>#定义细胞亚群      </span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>, <span>11</span>,<span>13</span> ),<span>2</span>]=<span>'Tcells'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>6</span> ),<span>2</span>]=<span>'Bcells'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>5</span> ),<span>2</span>]=<span>'mast'</span><br>  <br>  celltype[celltype$ClusterID %<span>in</span>% c(  <span>3</span> ),<span>2</span>]=<span>'cycle'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c(  <span>4</span> ),<span>2</span>]=<span>'fibro'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c(  <span>7</span> ),<span>2</span>]=<span>'endo'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c(  <span>9</span> ),<span>2</span>]=<span>'pDC'</span><br>  <br>  celltype[celltype$ClusterID %<span>in</span>% c(  <span>1</span> ),<span>2</span>]=<span>'myeloids'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>2</span>,<span>12</span>,<span>8</span> ),<span>2</span>]=<span>'epi'</span><br>  <br></code></pre><p data-tool="mdnice编辑器">最后的降维聚类分群如下所示：</p><p><img data-galleryid="" data-ratio="1.136111111111111" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww4gP7tibZ6c7icGdcMEPCUeVgPibBIsH3kUjvOrrLibyF4BulAtulfJRyD3FLQxWEV7hpnHHevZl0xrg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww4gP7tibZ6c7icGdcMEPCUeVgPibBIsH3kUjvOrrLibyF4BulAtulfJRyD3FLQxWEV7hpnHHevZl0xrg/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>降维聚类分群</figcaption></figure><p data-tool="mdnice编辑器">当然了，降维聚类分群仅仅是故事的开始，后面还可以根据实验设计进行多种多样的分析。</p><h3 data-tool="mdnice编辑器"><span></span>单细胞春节福利继续<span></span></h3><p data-tool="mdnice编辑器">如果你有自己的单细胞转录组数据需要处理，可以直接参加我们的活动 ，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519474&amp;idx=1&amp;sn=a07f2684e4bebfc5307add35cfbf82a2&amp;scene=21#wechat_redirect" data-linktype="2">春节期间单细胞转录组数据分析全免费</a>，如果你感兴趣我们处理过的数据集，可以直接填表留下联系方式即可，我们会在元宵节之前统一发放全部的代码和数据给大家的：</p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p><img data-galleryid="" data-ratio="1.1717171717171717" data-s="300,640" data-type="png" data-w="594" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyQr8BdGAhNyoC6JsX1Adz5cNOEMLwqyYLg2yEFoG9EhZbst22ordDweoSa1ErNa5vouvVDL0Ixbw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyQr8BdGAhNyoC6JsX1Adz5cNOEMLwqyYLg2yEFoG9EhZbst22ordDweoSa1ErNa5vouvVDL0Ixbw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><figure data-tool="mdnice编辑器"><figcaption>元宵节之前统一发放全部的代码和数据</figcaption></figure></section><h4 data-tool="mdnice编辑器"><span>文末友情宣传</span></h4><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519543&amp;idx=1&amp;sn=b9290a55d50c038bcc6e97d53a88b1c5&amp;chksm=9b4bcd8cac3c449aaa16dbf518578e9c7a4e67fe4122ae7c4fb115ddb2a843a976fa3462dcea&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买‍一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li></ul><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/87HiAlsu7pbR-xlHCLnMXA",target="_blank" rel="noopener noreferrer">原文链接</a>
