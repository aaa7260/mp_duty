---
title: "R中优雅的绘制物种冲积图"
date: 2023-06-10T15:51:20Z
draft: ["false"]
tags: [
  "fetched",
  "R语言数据分析指南"
]
categories: ["Acdemic"]
---
R中优雅的绘制物种冲积图 by R语言数据分析指南
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span><span></span>欢迎关注R语言数据分析指南</span><span></span></h3><blockquote data-tool="mdnice编辑器"><span>❝</span><p>最近有朋友问R中绘制冲积图的代码，其本质仍然是条形图只是添加了样本间的连线；案例要求按列计算每个样本的相对丰度跟往常有所不同。下面小编就来简单介绍一下代码，<strong>「数据+代码已经上传2023VIP群，加群的观众老爷请自行下载」</strong></p><span>❞</span></blockquote><h3 data-tool="mdnice编辑器"><span></span><span><span></span>关注下方公众号下回更新不迷路</span><span></span></h3><section><mp-common-profile data-pluginname="mpprofile" data-id="Mzg3MzQzNTYzMw==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZF0rpeZII9Ltl26VbVagriczTria1fib3XgjwwHEHFjPzkmGpqWDVVHBSzhENictUM2iavAKiaM5lc9USw/0?wx_fmt=png" data-nickname="R语言数据分析指南" data-alias="YanJANtwo" data-signature="R语言重症爱好者，喜欢绘制各种精美的图表，喜欢的小伙伴可以关注我，跟我一起学习" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><h3 data-tool="mdnice编辑器"><span></span><span><span></span>加载R包</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(tidyverse)<br><span>library</span>(ggsci)<br><span>library</span>(magrittr)<br><span>library</span>(reshape)<br><span>library</span>(RColorBrewer)<br><span>library</span>(ggalluvial)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span></span>导入数据</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>df &lt;- read_tsv(<span>"genus.xls"</span>) %&gt;% column_to_rownames(var=<span>"ID"</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span></span>数据清洗</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 按列求和单独计算每列的相对丰度</span><br>df_new &lt;- df %&gt;% mutate_all(~ . / sum(.)) %&gt;% <br>  rownames_to_column(var=<span>"Genus"</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span></span>整合数据</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 将分组文件与丰度表进行整合</span><br>plot &lt;- df_new %&gt;% pivot_longer(-Genus) %&gt;% <br>  left_join(.,read_tsv(<span>"group.xls"</span>),by=c(<span>"name"</span>=<span>"sample"</span>))<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span></span>绘制冲积图</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>ggplot(plot, aes(name, value, alluvium = Genus, stratum = Genus)) +  <span># 创建绘图对象，设置x轴、y轴、alluvium和stratum变量为name、value、Genus</span><br>  geom_alluvium(aes(fill = Genus), alpha = <span>.5</span>, width = <span>0.6</span>) +  <span># 添加alluvium图层，设置填充颜色为Genus，透明度为0.5，宽度为0.6</span><br>  geom_stratum(aes(fill = Genus), width = <span>0.6</span>) +  <span># 添加stratum图层，设置填充颜色为Genus，宽度为0.6</span><br>  facet_grid(. ~ group, scales = <span>"free"</span>, space = <span>"free_x"</span>) +  <span># 根据group变量进行网格分面，设置自由的x轴和y轴刻度，自由的x轴间距</span><br>  labs(x = <span>NULL</span>, y = <span>NULL</span>) +  <span># 设置x轴标签和y轴标签为空</span><br>  scale_fill_simpsons() +  <span># 设置填充颜色的比例尺为Simpsons风格</span><br>  scale_y_continuous(expand = c(<span>0</span>, <span>0</span>)) +  <span># 设置y轴刻度范围的扩展为0</span><br>  scale_x_discrete(expand = c(<span>0</span>, <span>0</span>)) +  <span># 设置x轴刻度范围的扩展为0</span><br>  theme(<br>    axis.line.x = element_line(color = <span>"black"</span>),  <span># 设置x轴线的颜色为黑色</span><br>    axis.line.y = element_line(color = <span>"black"</span>),  <span># 设置y轴线的颜色为黑色</span><br>    axis.text.x = element_text(size = <span>8</span>,face = <span>"plain"</span>,angle = <span>0</span>,<br>      vjust = <span>0.5</span>,hjust = <span>0.5</span>,color = <span>"black"</span>),  <span># 设置x轴文本的大小、样式、角度、垂直和水平对齐方式，颜色为黑色</span><br>    axis.text.y = element_text(size = <span>8</span>, face = <span>"plain"</span>, color = <span>"black"</span>),  <span># 设置y轴文本的大小、样式，颜色为黑色</span><br>    panel.border = element_blank(),  <span># 设置面板边框为空白</span><br>    plot.background = element_blank(),  <span># 设置绘图区背景为空白</span><br>    axis.title.x = element_text(margin = margin(t = <span>10</span>), size = <span>11</span>, color = <span>"black"</span>),  <span># 设置x轴标题的边距、大小，颜色为黑色</span><br>    axis.title.y = element_text(margin = margin(r = <span>10</span>), size = <span>11</span>, color = <span>"black"</span>),  <span># 设置y轴标题的边距、大小，颜色为黑色</span><br>    panel.grid.major.x = element_blank(),  <span># 设置x轴主要网格线为空白</span><br>    panel.grid.minor.x = element_blank(),  <span># 设置x轴次要网格线为空白</span><br>    panel.grid.minor.y = element_blank(),  <span># 设置y轴次要网格线为空白</span><br>    panel.grid.major.y = element_blank(),  <span># 设置y轴主要网格线为空白</span><br>    plot.margin = unit(c(<span>0.5</span>, <span>0.5</span>, <span>0.5</span>, <span>0.5</span>), units = <span>"cm"</span>),  <span># 设置绘图区边距为0.5厘米</span><br>    legend.text = element_text(size = <span>8</span>, color = <span>"black"</span>),  <span># 设置图例文本的大小和颜色</span><br>    legend.key = element_blank(),  <span># 设置图例键为空白</span><br>    legend.title = element_blank(),  <span># 设置图例标题为空白</span><br>    panel.background = element_rect(fill = <span>"white"</span>),  <span># 设置面板背景为白色</span><br>    legend.background = element_rect(color = <span>"black"</span>,fill = <span>"transparent"</span>,<br>      size = <span>2</span>,linetype = <span>"blank"</span>),  <span># 设置图例背景的边框颜色为黑色，填充为透明，边框大小为2，线型为空白</span><br>    panel.spacing.x = unit(<span>0.1</span>, <span>"cm"</span>),  <span># 设置面板x轴间距为0.1厘米</span><br>    strip.background = element_blank(),  <span># 设置分面标签背景为空白</span><br>    strip.text = element_text(color = <span>"black"</span>, face = <span>"bold"</span>),  <span># 设置分面标签文本的颜色为黑色，样式为粗体</span><br>    legend.key.height = unit(<span>0.5</span>, <span>"cm"</span>),  <span># 设置图例键的高度为0.5厘米</span><br>    legend.key.width = unit(<span>0.5</span>, <span>"cm"</span>),  <span># 设置图例键的宽度为0.5厘米</span><br>    legend.spacing.x = unit(<span>0.1</span>, <span>"cm"</span>),  <span># 设置图例水平间距为0.1厘米</span><br>    legend.box.background = element_blank()  <span># 设置图例框背景为空白</span><br>)<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5043383947939263" data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gckY6icuITKzTK25UIt72drfYxUNvKzcxheTx6aiaSkQnKGDo1icxpEKZg/640?wx_fmt=png" data-type="png" data-w="922" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gckY6icuITKzTK25UIt72drfYxUNvKzcxheTx6aiaSkQnKGDo1icxpEKZg/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span><span><span></span>绘制组间冲积图</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>plot %&gt;% select(<span>1</span>,<span>3</span>,<span>4</span>) %&gt;% <br>  group_by(Genus,group) %&gt;% <br>  summarise(sum=sum(value),.groups = <span>'drop'</span>) %&gt;% <br>  pivot_wider(names_from=group,values_from=sum) %&gt;% <br>  column_to_rownames(var=<span>"Genus"</span>) %&gt;% <br>  mutate_all(~ . / sum(.)) %&gt;% <br>  rownames_to_column(var=<span>"Genus"</span>) %&gt;% <br>  pivot_longer(-Genus) %&gt;% <br>  ggplot(aes(name,value,alluvium=Genus,stratum = Genus))+<br>  geom_alluvium(aes(fill = Genus),alpha = <span>.5</span>,width = <span>0.6</span>) +<br>  geom_stratum(aes(fill = Genus),width = <span>0.6</span>)+<br>  labs(x=<span>NULL</span>,y=<span>NULL</span>)+<br>  scale_fill_simpsons()+<br>  scale_y_continuous(expand=c(<span>0</span>,<span>0</span>))+<br>  scale_x_discrete(expand=c(<span>0</span>,<span>0</span>))+<br>  theme(axis.line.x = element_line(color=<span>"black"</span>), <br>        axis.line.y = element_line(color=<span>"black"</span>),<br>        axis.text.x = element_text(size=<span>8</span>,face=<span>"plain"</span>,angle = <span>90</span>,vjust=<span>0.5</span>,color=<span>"black"</span>),<br>        axis.text.y = element_text(size=<span>8</span>,face=<span>"plain"</span>,color=<span>"black"</span>),<br>        panel.border = element_blank(),<br>        plot.background = element_blank(),<br>        axis.title.x = element_text(margin = margin(t = <span>10</span>),size=<span>11</span>,color=<span>"black"</span>),<br>        axis.title.y = element_text(margin = margin(r = <span>10</span>),size=<span>11</span>,color=<span>"black"</span>),<br>        panel.grid.major.x = element_blank(),                                          <br>        panel.grid.minor.x = element_blank(),<br>        panel.grid.minor.y = element_blank(),<br>        panel.grid.major.y = element_blank(),  <br>        plot.margin = unit(c(<span>0.5</span>,<span>0.5</span>,<span>0.5</span>,<span>0.5</span>), units = ,<span>"cm"</span>),<br>        legend.text = element_text(size =<span>8</span>,color=<span>"black"</span>),<br>        legend.key = element_blank(),<br>        legend.title = element_blank(),<br>        panel.background = element_rect(fill = <span>"white"</span>),<br>        legend.background = element_rect(color = <span>"black"</span>, <br>                                         fill = <span>"transparent"</span>,size = <span>2</span>, linetype = <span>"blank"</span>),<br>        panel.spacing.x = unit(<span>0</span>,<span>"cm"</span>),<br>        strip.background = element_blank(),<br>        strip.text = element_text(color=<span>"black"</span>,face=<span>"bold"</span>),<br>        legend.key.height = unit(<span>0.5</span>,<span>"cm"</span>),<br>        legend.key.width = unit(<span>0.5</span>,<span>"cm"</span>),<br>        legend.spacing.x = unit(<span>0.2</span>,<span>"cm"</span>),<br>        legend.box.background = element_blank())<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7131901840490797" data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gWib688zic6ialZRuZwichoqQyfBicZrQicPYibQUe0sKS69ibia72stPiciau5Aag/640?wx_fmt=png" data-type="png" data-w="652" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gWib688zic6ialZRuZwichoqQyfBicZrQicPYibQUe0sKS69ibia72stPiciau5Aag/640?wx_fmt=png"></figure><blockquote data-tool="mdnice编辑器"><span>❝</span><p>有需要学习个性化数据可视化的朋友，欢迎到小编的<strong>「淘宝店铺」</strong> <strong>「R语言数据分析指南」</strong>购买<strong>「2023年度会员文档」</strong>同步更新中 <code>初始价格99元</code>6月后将调整价格为<strong>「149元」</strong>，内容主要包括各种<strong>「高分论文的图表分析复现以及一些个性化图表的绘制」</strong>均包含数据+代码；按照往年数据小编年产出约在150+以上</p><span>❞</span></blockquote><p data-tool="mdnice编辑器">购买后微信发小编订单截图即邀请进新的会员交流群，小编的文档为按年售卖，只包含当年度的<strong>「除系列课程外」</strong>的文档，有需要往年文档的朋友也可下单购买，需要了解更多信息的朋友欢迎交流咨询。</p><h3 data-tool="mdnice编辑器"><span></span><span><span></span>淘宝扫一扫</span><span></span></h3><figure data-tool="mdnice编辑器"><img data-ratio="1.6136783733826248" data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gQSj6CPDfvIAsA904kricA4XFDwvd2AUd3iakp9xOPbZ5QiaDw5HFqqSyg/640?wx_fmt=png" data-type="png" data-w="541" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gQSj6CPDfvIAsA904kricA4XFDwvd2AUd3iakp9xOPbZ5QiaDw5HFqqSyg/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span><span><span></span>2023会员群精彩内容</span><span></span></h3><p data-tool="mdnice编辑器"><img data-ratio="0.4255555555555556" data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gNbdCUWDeG21h0OzleQhUCd2sWUEIWKNFC6eByRwKyNTHqc0LLuDGrg/640?wx_fmt=png" data-type="png" data-w="900" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gNbdCUWDeG21h0OzleQhUCd2sWUEIWKNFC6eByRwKyNTHqc0LLuDGrg/640?wx_fmt=png"><img data-ratio="0.4255555555555556" data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gLkMIp5GC5gSsaQqOUOQV7iahBSdDmf9AaKy57r9WrFU1NibUjyZaC3Mw/640?wx_fmt=png" data-type="png" data-w="900" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gLkMIp5GC5gSsaQqOUOQV7iahBSdDmf9AaKy57r9WrFU1NibUjyZaC3Mw/640?wx_fmt=png"><img data-ratio="0.4255555555555556" data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89g4J0nCoyp01BruSJ7OibufahvaO6SWmQfx8LG0NJL6LcDQvQJibrclo6w/640?wx_fmt=png" data-type="png" data-w="900" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89g4J0nCoyp01BruSJ7OibufahvaO6SWmQfx8LG0NJL6LcDQvQJibrclo6w/640?wx_fmt=png"><img data-ratio="0.4255555555555556" data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89ge3Vy4VcicazUz4zyxY3icDmhJvV61dUZlE3Y9PVBGvgPJL4jibRu0uZbQ/640?wx_fmt=png" data-type="png" data-w="900" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89ge3Vy4VcicazUz4zyxY3icDmhJvV61dUZlE3Y9PVBGvgPJL4jibRu0uZbQ/640?wx_fmt=png"><img data-ratio="0.4255555555555556" data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gNZbOT29WRTw56jJzxbBZIxwiczBE3z1RkulK2T1Wm2oib844fibVC6hVA/640?wx_fmt=png" data-type="png" data-w="900" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gNZbOT29WRTw56jJzxbBZIxwiczBE3z1RkulK2T1Wm2oib844fibVC6hVA/640?wx_fmt=png"><img data-ratio="0.4255555555555556" data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gpPR0AyajC43w3GdibCNa3Yz857N6z1qHagBCUg5Kyecg3LVm5q6VFeQ/640?wx_fmt=png" data-type="png" data-w="900" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZ9M5INpJt7icYmJbCpoY89gpPR0AyajC43w3GdibCNa3Yz857N6z1qHagBCUg5Kyecg3LVm5q6VFeQ/640?wx_fmt=png"></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/QQwczxSgdbSonD1KDCB0vA",target="_blank" rel="noopener noreferrer">原文链接</a>
