---
title: "GEO数据挖掘实战全流程1.27万字笔记"
date: 2023-06-01T11:19:42Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
GEO数据挖掘实战全流程1.27万字笔记 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">这个笔记主要是根据生信技能树数据挖掘线上直播课以及B站视频做的，GEO芯片数据分析部分。如果大家也想完整的学习，可以去跟这个马拉松授课，<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247520628&amp;idx=1&amp;sn=8904b3e4baed6d02397b4f6beb089085&amp;chksm=9b4bd1cfac3c58d9ee006daf365931bdfab8d5152ffb5090a2c6227d631e93c52f6656c39cd6&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课4月班" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信入门&amp;数据挖掘线上直播课4月班</a></p><p data-tool="mdnice编辑器"><span><strong>目录</strong></span></p><figure data-tool="mdnice编辑器"><img data-ratio="1.1480787253983131" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24icgYicYIfH3ibDicia9UUpHyQ1ea8nSZ5R9icAtgzhLF2dF9yO1grQbecWmg/640?wx_fmt=png" data-type="png" data-w="1067" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24icgYicYIfH3ibDicia9UUpHyQ1ea8nSZ5R9icAtgzhLF2dF9yO1grQbecWmg/640?wx_fmt=png"></figure><h1 data-tool="mdnice编辑器"><span>一、数据下载与读取</span></h1><h2 data-tool="mdnice编辑器"><span>1. 使用R包 GEOquery 下载</span></h2><p data-tool="mdnice编辑器">推荐用getGEO函数下载，通过GSE号下载后得到的 gset 是一个 ExpressionSet 对象。这个对象被封装在1个 list 中，因为 GSE中可能包含了多个 GPL 平台的数据，不同平台的数据会存放在 list 中，这个 list 的每个对象都是 1 个平台的 ExpressionSet 对象。</p><p data-tool="mdnice编辑器">这里需要做一下区分，如果通过getGEO读取下载到本地的GSE数据，那么读取进来直接就是ExpressionSet 对象而不是list。</p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzkyMDI4MzAxMA==&amp;mid=2247484135&amp;idx=1&amp;sn=2d0f013ab3fea194021372af9e313785&amp;scene=21#wechat_redirect" data-linktype="2">GEOquery包的使用</a></p><h2 data-tool="mdnice编辑器"><span>2. geoChina()</span></h2><p data-tool="mdnice编辑器">生信技能树健明老师写的 AnnoProbe 包中的 geoChina 函数，提供了一个中国区镜像，可以下载部分 GEO 数据。</p><pre data-tool="mdnice编辑器"><code><span>library</span>(AnnoProbe)<br>eSet &lt;- geoChina(gse_number, destdir = <span>'.'</span>)<br></code></pre><h2 data-tool="mdnice编辑器"><span>3. NCBI 直接下载</span></h2><ul data-tool="mdnice编辑器"><li><section>比如 <code>GSE168113_series_matrix.txt</code>。下载后在R中读取txt文件，read.table 函数参数怎么设置提前预览一下txt文件中的内容格式就知道了。</section></li></ul><pre data-tool="mdnice编辑器"><code>a&lt;- read.table(<span>"GSE42872_series_matrix.txt.gz"</span>,<br>               sep = <span>"\t"</span>,header = <span>T</span>,<br>               <span># row.names=1,   # 把探针名所在的第1列直接读取为行名</span><br>               comment.char = <span>"!"</span>)<br></code></pre><ul data-tool="mdnice编辑器"><li><section>另外是直接下载原始数据。不推荐，因为不同的芯片rawdata 格式不同，需要学习不同的处理方法。比如 <code>GSE168113_RAW.tar</code></section></li></ul><h2 data-tool="mdnice编辑器"><span>4. 读取芯片数据的方法</span></h2><p data-tool="mdnice编辑器"><strong>三大芯片制造商</strong>：affymetrix , illumina , agilent</p><p data-tool="mdnice编辑器"><strong>芯片类型</strong>：表达谱芯片（mRNA）、基因分析芯片（SNP,indel）、CNV芯片（拷贝数变异）、甲基化芯片、miRNA芯片</p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486087&amp;idx=1&amp;sn=1e775a1c3e215384e381953a9fa74ec3&amp;scene=21#wechat_redirect" data-linktype="2">从GEO数据库下载得到表达矩阵 一文就够 (qq.com)</a></p><ul data-tool="mdnice编辑器"><li><section>用affy包读取 affymetix 的基因表达芯片</section></li><li><section>用oligo包来读取 affymetix 的基因表达芯片</section></li><li><section>用R包lumi来处理illumina的bead系列表达芯片</section></li></ul><h2 data-tool="mdnice编辑器"><span>5. 实战(Step 0)</span></h2><p data-tool="mdnice编辑器"><strong>数据集背景了解</strong></p><ul data-tool="mdnice编辑器"><li><section><p>数据集: GSE42872 <code>https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE42872</code>。</p></section></li><li><section><p>数据类型：芯片数据</p></section></li><li><section><p>平台：GPL6244</p></section></li><li><section><p><strong>两个组，实验组 3 ，对照组 3</strong> 。宿主为人类</p></section></li></ul><p data-tool="mdnice编辑器"><strong>实验设计</strong>：用威罗非尼（Vemurafenib）或 DMSO 处理 BRAFV600E A375 黑色素瘤细胞(melanoma)。</p><p data-tool="mdnice编辑器"><strong>Summary</strong>: 威罗非尼是一种 BRAF 抑制剂，对黑色素瘤中最常见的 BRAF 突变体（BRAFV600E）具有特异性。威罗非尼通过抑制 MEK / ERK 丝裂原活化蛋白激酶的下游活化来抑制 BRAF 突变人黑色素瘤细胞的增殖。我们使用微阵列检查威罗非尼敏感的BRAFV600E人黑色素瘤细胞系（A375）对威罗非尼的转录反应，以进一步描述 BRAFV600E 驱动人类黑色素瘤细胞增殖和能量代谢的机制。PMID:24469106</p><h2 data-tool="mdnice编辑器"><span>6. 实战(Step 1)</span></h2><p data-tool="mdnice编辑器">数据下载与导入，获取表达矩阵。</p><pre data-tool="mdnice编辑器"><code>rm(list = ls())<br><span>library</span>(GEOquery)<br>gse_number = <span>"GSE42872"</span><br>eSet &lt;- getGEO(gse_number, destdir = <span>'.'</span>, getGPL = <span>F</span>)<br>class(eSet)<br>length(eSet)<br>eSet = eSet[[<span>1</span>]]<br><span>#(1)提取表达矩阵exp</span><br>exp &lt;- exprs(eSet)<br>dim(exp)<br>boxplot(exp) <span># 已经log 转化</span><br>exp[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span>#(2)提取临床信息</span><br>pd &lt;- pData(eSet)<br><span>#(3)让exp列名与pd的行名顺序完全一致</span><br>p = identical(rownames(pd),colnames(exp));p<br><span>if</span>(!p) exp = exp[,match(rownames(pd),colnames(exp))]<br><span>#(4)提取芯片平台编号</span><br>gpl_number &lt;- eSet@annotation;gpl_number<br>save(gse_number,pd,exp,gpl_number,file = <span>"step1output.Rdata"</span>)<br></code></pre><h1 data-tool="mdnice编辑器"><span>二、分组信息与探针注释</span></h1><h2 data-tool="mdnice编辑器"><span>1. 获取分组信息</span></h2><p data-tool="mdnice编辑器">pData 函数可以获得临床信息。</p><pre data-tool="mdnice编辑器"><code>pd &lt;- pData(eSet)<br><span># 第一种方法，有现成的可以用来分组的列</span><br>Group = pd$`disease state:ch1` <br><span># 第二种方法，自己生成</span><br>Group = c(rep(<span>"RA"</span>,times=<span>13</span>),<br>        rep(<span>"control"</span>,times=<span>9</span>))<br>Group = rep(c(<span>"RA"</span>,<span>"control"</span>),times = c(<span>13</span>,<span>9</span>))<br><span># 第三种方法，使用字符串处理的函数获取分组</span><br>Group=ifelse(str_detect(pd$source_name_ch1,<span>"control"</span>),<br>               <span>"control"</span>,<br>               <span>"RA"</span>)<br></code></pre><h2 data-tool="mdnice编辑器"><span>2. 获取芯片注释的方法</span></h2><h3 data-tool="mdnice编辑器"><span></span>(1) 捷径 tinyarray<span></span></h3><pre data-tool="mdnice编辑器"><code><span>library</span>(tinyarray) <span># 小洁老师写的R包</span><br>find_anno(gpl_number) <span># 打出找注释的代码</span><br>ids &lt;- AnnoProbe::idmap(<span>'GPL570'</span>) <span># 曾老师写的R包</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span>(2) bioconductor 包<span></span></h3><blockquote data-tool="mdnice编辑器"><p>安装与加载包的时候注意在包名后面加 .db，如 library(org.Hs.eg.db)</p></blockquote><p data-tool="mdnice编辑器">GPL与R包对应关系可参考：</p><ul data-tool="mdnice编辑器"><li><section>用R获取芯片探针与基因的对应关系三部曲-bioconductor | 生信菜鸟团 (bio-info-trainee.com)<code>http://www.bio-info-trainee.com/1399.html</code></section></li><li><section>GPL对应的Bioconductor注释包<code>https://blog.csdn.net/weixin_40739969/article/details/103186027</code></section></li></ul><pre data-tool="mdnice编辑器"><code><span># BiocManager::install("hugene10sttranscriptcluster.db")  # R包安装</span><br><span>library</span>(hugene10sttranscriptcluster.db)<br>ls(<span>"package:hugene10sttranscriptcluster.db"</span>)   <span># 查看这个包中的对象</span><br>ids=toTable(hugene10sttranscriptclusterSYMBOL) <span># 得到每个探针对应的SYMBOL,这里括号中的根据前面查找的对象可以更改</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span>(3) NCBI 下载文件解析<span></span></h3><ul data-tool="mdnice编辑器"><li><section>第一种方法：直接用 GEOquery 下载 soft 文件（soft 文件较大，需要网速）</section></li></ul><pre data-tool="mdnice编辑器"><code><span># 第一种方式：fData 函数提取表格，得到的 fd 表格即含有芯片注释信息</span><br>gse42589 &lt;- getGEO(<span>'GSE42589'</span>, destdir=<span>"."</span>,getGPL = <span>T</span>)<br>eSet = gse42589[[<span>1</span>]] <span># 下载如果是列表先提取对象</span><br>fd &lt;- fData(eSet)<br>colnames(fd) <br><span># 第二种方式：Table 函数提取表格，不过是直接从 soft 文件提取的，得到的表与第一种方法一致</span><br>gpl6244 &lt;- getGEO(<span>'GPL6244'</span>, destdir=<span>"."</span>)<br>fd &lt;- Table(gpl6244)<br>colnames(fd)<br></code></pre><ul data-tool="mdnice编辑器"><li><section>第二种方法：可以直接在浏览器上从NCBI里面下载文件来解析，如GEO Accession viewer (nih.gov)<code>https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GPL6244</code></section></li></ul><h3 data-tool="mdnice编辑器"><span></span>(4) 其它方法<span></span></h3><ul data-tool="mdnice编辑器"><li><section>去基因芯片的厂商的官网直接去下载</section></li><li><section>自主注释</section></li></ul><h2 data-tool="mdnice编辑器"><span>3. 实战(Step 2)</span></h2><p data-tool="mdnice编辑器">获取分组信息与探针注释</p><pre data-tool="mdnice编辑器"><code><span># 载入数据</span><br>rm(list = ls())  <br>load(file = <span>"step1output.Rdata"</span>)<br><span>library</span>(stringr)<br><br><span># 获取分组信息</span><br>  Group=ifelse(str_detect(pd$title,<span>"Control"</span>),<br>               <span>"control"</span>,<br>               <span>"treat"</span>)<br>colnames(exp) &lt;- paste(Group,c(<span>1</span>,<span>2</span>,<span>3</span>),sep = <span>"-"</span>);colnames(exp)<br><span># 需要把Group转换成因子，并设置参考水平，指定levels，对照组在前，处理组在后</span><br>Group = factor(Group,levels = c(<span>"control"</span>,<span>"treat"</span>))<br>Group<br><br><span># 探针注释的获取</span><br><span>library</span>(tinyarray) <span># 小洁老师写的R包</span><br>find_anno(gpl_number) <span>#打出找注释的代码</span><br>ids &lt;- AnnoProbe::idmap(<span>'GPL6244'</span>)<br>save(exp,Group,ids,gse_number,file = <span>"step2output.Rdata"</span>)<br></code></pre><h1 data-tool="mdnice编辑器"><span>三、表达矩阵数据检查</span></h1><h2 data-tool="mdnice编辑器"><span>1. 基础检查 tips</span></h2><h3 data-tool="mdnice编辑器"><span></span>log 转化<span></span></h3><p data-tool="mdnice编辑器">如何判断下载的表达矩阵是否进行过 log 转化 ？ =&gt;  箱线图的纵坐标如果在 0-20 之间代表是 log 后的表达矩阵</p><h3 data-tool="mdnice编辑器"><span></span>箱线图查看异常样本<span></span></h3><p data-tool="mdnice编辑器">不同样本箱线图整体表达水平应该基本一致，因为一般来说<strong>差异基因只是少数</strong>，不会对整体的数据分布产生太大的影响，下图就存在一个异常样本：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5260273972602739" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24PNGQiaX7FQYu5OZn1fQet34pkUq78JrUPaAVjwibZibS6Uuykx9hd5vXg/640?wx_fmt=png" data-type="png" data-w="730" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24PNGQiaX7FQYu5OZn1fQet34pkUq78JrUPaAVjwibZibS6Uuykx9hd5vXg/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>异常样本处理办法<span></span></h3><ol data-tool="mdnice编辑器"><li><section><p>删除异常样本</p></section></li><li><section><p>将样本表达水平拉到同一个水平线：</p></section></li></ol><pre data-tool="mdnice编辑器"><code>exp &lt;- limma::normalizeBetweenArrays(exp)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>表达矩阵里有负值<span></span></h3><ol data-tool="mdnice编辑器"><li><section>进行过 log 转化，正常。</section></li><li><section>没进行过 log 转化，可能存在错误数据，一般弃用，处理原始数据。</section></li><li><section>有一半负值，代表进行了 z-score 等标准化，不能用于差异分析，应处理原始数据。</section></li></ol><h3 data-tool="mdnice编辑器"><span></span>检查某些基因的表达量<span></span></h3><p data-tool="mdnice编辑器">如 GAPDH 管家基因</p><pre data-tool="mdnice编辑器"><code>exprSet[<span>"GAPDH"</span>,]     <br>boxplot(exprSet[,<span>1</span>])  <span># 发现GAPDH的表达量很高，因为是管家基因,如果很低反而有问题</span><br></code></pre><h2 data-tool="mdnice编辑器"><span>2. 绘图</span></h2><blockquote data-tool="mdnice编辑器"><p>注意, 某个图并没有体现出良好的分组并不是说一定要去除某个离群样本,我们只是用这些图大致检查一下数据质量,最后需不需要去除某个样本还需要结合具体实验设计</p></blockquote><h3 data-tool="mdnice编辑器"><span></span>(1) 箱线图<span></span></h3><p data-tool="mdnice编辑器"><strong>箱线图</strong>是一种用于展示一组数据分布情况的图表。它可以帮助我们直观地了解数据的中位数、最小值、最大值、四分位数以及异常值等统计指标。具体来说，箱线图由一个矩形和两条线组成。矩形的边界由第一四分位数和第三四分位数组成，而矩形内部的线条代表中位数。箱线图中的两条线分别表示数据的最小值和最大值。如果在最大值和最小值之外存在异常值，这些值将被表示为离群点。</p><p data-tool="mdnice编辑器">通过观察箱线图，我们可以直观地看出数据的集中趋势和分散程度。如果矩形较小且中位数靠近矩形中央，说明数据分布相对集中；如果矩形较大且中位数偏离矩形中央，说明数据分布相对分散。此外，如果存在离群点，我们需要考虑这些点是否是数据错误或异常值，需要进行进一步的数据分析和处理。</p><p data-tool="mdnice编辑器"><strong>ggplot2 制作箱线图</strong>需要对表达矩阵（数据框）进行长宽变换，一列为样本信息作为 x 轴，一列为每个样本每个基因的表达量，作为 y 轴，如果需要添加分组信息，还需要添加一列分组信息。</p><ul data-tool="mdnice编辑器"><li><section><strong>原始矩阵</strong>：行为 探针/基因 ，列为样本。</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.41574074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24LpmKnTXGhNorcWKvIxYGibQkdPcMTWJJFC6bM0Va6VmLicWn6H5DHGXg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24LpmKnTXGhNorcWKvIxYGibQkdPcMTWJJFC6bM0Va6VmLicWn6H5DHGXg/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section><strong>ggplot2画箱线图输入的数据</strong>：</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.6924177396280401" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24Hx5YNHY4wufvxkevfpuTpxEBrib7Fyryb9kA4eE1SsiaOx9mub4yWQCg/640?wx_fmt=png" data-type="png" data-w="699" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24Hx5YNHY4wufvxkevfpuTpxEBrib7Fyryb9kA4eE1SsiaOx9mub4yWQCg/640?wx_fmt=png"></figure><h4 data-tool="mdnice编辑器"><span>实战(Step 3.1)</span></h4><p data-tool="mdnice编辑器">对表达矩阵进行长宽变换后用 ggplot2 绘制箱线图。</p><pre data-tool="mdnice编辑器"><code><span># 载入数据</span><br>rm(list = ls())  <br>load(file = <span>"step1output.Rdata"</span>)<br>load(file = <span>"step2output.Rdata"</span>)<br><br><span># （1）箱线图</span><br><span>library</span>(reshape2)<br><span>library</span>(tibble)<br>exp &lt;- rownames_to_column(as.data.frame(exp),var = <span>"probe_id"</span>) <span># 行名转换为第1列</span><br>exp_L&lt;- melt(exp) <span># 长宽变换</span><br>colnames(exp_L)&lt;- c(<span>"probe_id"</span>,<span>"sample"</span>,<span>"value"</span>);table(exp_L$sample) <br>exp_L$group&lt;- rep(Group,each=nrow(exp)) <span># 添加分组列</span><br>head(exp_L)<br><span>library</span>(ggplot2)<br>p=ggplot(exp_L,aes(x=sample,y=value,fill=group))+geom_boxplot()+<br>  theme(axis.text.x = element_text(angle=<span>0</span>, vjust=<span>0.6</span>))<br>print(p)<br>exp&lt;- column_to_rownames(exp,<span>"probe_id"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.8148148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24lOmSoiawNAvblyfwficROpbwmWcAGnB4paHPGdNWBd30gVacCou0RRUA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24lOmSoiawNAvblyfwficROpbwmWcAGnB4paHPGdNWBd30gVacCou0RRUA/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>(2) 层次聚类<span></span></h3><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzkyMDI4MzAxMA==&amp;mid=2247484197&amp;idx=1&amp;sn=d3246b120bfe95356874841f2deaf67e&amp;scene=21#wechat_redirect" data-linktype="2">层次聚类笔记</a></p><p data-tool="mdnice编辑器"><strong>输入</strong>：距离矩阵（通过 dist 函数获得）：</p><pre data-tool="mdnice编辑器"><code>&gt; sampleDists<br>          control-<span>1</span> control-<span>2</span> control-<span>3</span>  treat-<span>1</span>  treat-<span>2</span>  treat-<span>3</span><br>control-<span>1</span>   <span>0.00000</span>  <span>39.71222</span>  <span>34.36004</span> <span>81.76124</span> <span>88.19851</span> <span>86.35148</span><br>control-<span>2</span>  <span>39.71222</span>   <span>0.00000</span>  <span>43.05040</span> <span>85.04253</span> <span>90.11748</span> <span>87.08480</span><br>control-<span>3</span>  <span>34.36004</span>  <span>43.05040</span>   <span>0.00000</span> <span>83.72428</span> <span>86.22464</span> <span>89.42490</span><br>treat-<span>1</span>    <span>81.76124</span>  <span>85.04253</span>  <span>83.72428</span>  <span>0.00000</span> <span>40.85336</span> <span>41.91346</span><br>treat-<span>2</span>    <span>88.19851</span>  <span>90.11748</span>  <span>86.22464</span> <span>40.85336</span>  <span>0.00000</span> <span>49.70981</span><br>treat-<span>3</span>    <span>86.35148</span>  <span>87.08480</span>  <span>89.42490</span> <span>41.91346</span> <span>49.70981</span>  <span>0.00000</span><br></code></pre><h4 data-tool="mdnice编辑器"><span>实战(Step 3.2)</span></h4><p data-tool="mdnice编辑器">用 dist 函数得到距离矩阵，然后用 factoextra 包的 hcut 函数进行层次聚类，再用 fviz_dend 函数进行可视化。</p><pre data-tool="mdnice编辑器"><code><span>library</span>(factoextra) <br>sampleDists &lt;- dist(t(exp),upper = <span>T</span>,diag=<span>T</span>)  <span># 得到距离矩阵</span><br><span># sampleDists1 &lt;- dist(scale(t(exp)),upper = T,diag=T)</span><br>res &lt;- hcut(          <br>  sampleDists,k = <span>2</span>,   <span># k表示分为两类</span><br>  hc_func = <span>"hclust"</span>,     <span># 功能：聚类</span><br>  hc_method = <span>"complete"</span>, <span># 距离定义方式：最大距离</span><br>  <span># hc_method = "average", # 距离定义方式：平均距离</span><br>  hc_metric = <span>"euclidean"</span>, <span># 欧式距离</span><br>  stand = <span>FALSE</span>,graph = <span>FALSE</span>)                        <br>fviz_dend(res,rect = <span>TRUE</span>,cex = <span>0.75</span>, <br>          <span># type="phylogenic",  # 树形图</span><br>          type=<span>"rectangle"</span>, <span># 矩形图</span><br>          horiz = <span>T</span>,<br>          k_colors = c(<span>"#0073C2FF"</span>,<span>"#CD534CFF"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.8407407407407408" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24ibeP31dCJJEAGbRJnZ95ASVgNsxP7PGYNiaJtrDQUI1e9gGDMV9PGmHA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24ibeP31dCJJEAGbRJnZ95ASVgNsxP7PGYNiaJtrDQUI1e9gGDMV9PGmHA/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>(3) 热图<span></span></h3><p data-tool="mdnice编辑器">热图是一种可视化方法，用于显示数据中不同部分之间的相对值或强度。热图通常以矩阵形式呈现，其中每个单元格的颜色表示该单元格所代表的值的大小。颜色通常是一个渐变色条，其中深色表示较高的值，浅色表示较低的值。</p><p data-tool="mdnice编辑器">pheatmap可以绘制具有不同颜色映射方案的热图，并允许用户对行和列进行聚类。在绘制热图之前，pheatmap 通常会对矩阵数据进行预处理，包括对数据进行缩放、标准化、聚类等操作（可通过参数进行设置）。其中，缩放和标准化可用于使数据在不同变量之间具有相同的尺度，以便更好地比较和解释结果。聚类可以将相关变量和行/列聚类在一起，以更好地显示数据中的模式和结构。pheatmap默认聚类、不标准化。pheatmap绘图时通常使用一个渐变色条来表示矩阵数据中的数值大小，其中深色表示高值，浅色表示低值。在 pheatmap 中，默认的层次聚类计算数据点之间距离的算法为欧氏距离<code>euclidean</code>，可更改为其它距离，与 dist() 函数一致；默认的计算簇之间距离的算法为 <code>complete</code>，可更改为其它距离算法，与 hclust() 函数一致。</p><p data-tool="mdnice编辑器"><em>按行标准化</em>意味着对每一行进行标准化处理，使得每一行的值都满足均值为0，标准差为1的正态分布。按行标准化可以在样本之间比较基因表达量的差异时，将不同样本的数据进行比较，消除了每个样本中表达量大小的影响，使得每个样本的表达量数据更加可比性。</p><p data-tool="mdnice编辑器"><em>按列标准化</em>意味着对每一列进行标准化处理，使得每一列的值都满足均值为0，标准差为1的正态分布。按列标准化可以在基因之间比较它们在样本中的表达模式时，将不同基因的数据进行比较，消除了基因表达量大小的影响，使得每个基因的表达量数据更加可比性。</p><p data-tool="mdnice编辑器">另外还可以画样本之间相关性的热图，比如使用 cor 函数计算得到样本相关性，然后画图。</p><p data-tool="mdnice编辑器"><strong>输入</strong>：pheatmap 绘制热图直接输入原始矩阵即可</p><figure data-tool="mdnice编辑器"><img data-ratio="0.41574074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24LpmKnTXGhNorcWKvIxYGibQkdPcMTWJJFC6bM0Va6VmLicWn6H5DHGXg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24LpmKnTXGhNorcWKvIxYGibQkdPcMTWJJFC6bM0Va6VmLicWn6H5DHGXg/640?wx_fmt=png"></figure><h4 data-tool="mdnice编辑器"><span>实战(Step 3.3)</span></h4><p data-tool="mdnice编辑器">筛选方差前1000大的基因，然后用 pheatmap 画基因表达热图。</p><pre data-tool="mdnice编辑器"><code>cg=names(tail(sort(apply(exp,<span>1</span>,sd)),<span>1000</span>)) <span># 筛选方差前1000大的基因</span><br>n=exp[cg,]<br><span>library</span>(pheatmap)<br>group=data.frame(group=Group)<br>rownames(group)=colnames(n) <br>pheatmap(n,<br>         show_colnames =<span>F</span>,<br>         show_rownames = <span>F</span>,<br>         annotation_col=group, <span># 添加分组信息</span><br>         scale = <span>"row"</span>, <span># 按行标准化</span><br>         breaks = seq(-<span>3</span>,<span>3</span>,length.out = <span>100</span>) <span># 颜色色阶调整</span><br>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7805555555555556" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24AVdGe42etKQ69wq0bj7CD5ibaic69SFochnCB99NTTAKDSH8bepzILBw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24AVdGe42etKQ69wq0bj7CD5ibaic69SFochnCB99NTTAKDSH8bepzILBw/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>(4) PCA<span></span></h3><ul data-tool="mdnice编辑器"><li><section><strong>主成分分析</strong></section></li></ul><p data-tool="mdnice编辑器">主成分分析 (Principal Component Analysis, PCA) 是一种常用的数据分析技术，用于降维和数据压缩。PCA 通过找到数据的主要成分来实现这一目标，这些成分能够最好地解释数据中的变异性。具体来说，PCA 将原始数据投影到一组新的坐标轴上，使得数据在新坐标系中的方差最大化。这些新的坐标轴称为主成分，是原始数据的线性组合。主成分按照它们解释原始数据的方差的大小排序，因此，可以选择最高排名的主成分，以获得对原始数据的最佳压缩。根据这些主成分对样本进行聚类，代表样本的点在坐标轴上距离越远，说明样本差异越大。</p><ul data-tool="mdnice编辑器"><li><section><p><strong>PCA图主要考察：同一分组是否自成一簇（组内相似），中心点之间是否有距离（组间不一致）</strong></p></section></li><li><section><p><strong>PCA 图解释</strong></p></section></li></ul><p data-tool="mdnice编辑器">PCA图是指在PCA过程中绘制的图形，通常用于可视化数据降维的结果。以下是PCA图的一些解释：</p><ol data-tool="mdnice编辑器"><li><section>散点图：散点图是PCA图中最常见的形式，用于显示数据在新的低维空间中的分布情况。每个数据点都表示为一个点，该点的位置由其在低维空间中的坐标确定。</section></li><li><section>方差贡献率图：这种图形显示每个主成分解释的总方差的百分比。这可以帮助你确定在低维空间中保留多少主成分才能保留足够的信息。</section></li><li><section>热图：热图显示原始数据的相关性结构。通常使用颜色来表示相关性的强度，红色表示正相关性，蓝色表示负相关性。</section></li><li><section>散点矩阵图：散点矩阵图显示原始数据中所有可能的变量之间的散点图。这可以帮助你确定哪些变量对主成分的解释贡献最大。</section></li></ol><p data-tool="mdnice编辑器">在<strong>散点PCA图</strong>中，每个数据点代表一个样本，它的位置由它在主成分分析后的低维空间中的坐标确定。通常，散点PCA图上的不同指标可以表示以下信息：</p><ol data-tool="mdnice编辑器"><li><section><p>X轴和Y轴：这些轴代表低维空间中的两个主成分。在散点PCA图上，X轴和Y轴通常代表最具有解释力的两个主成分。</p></section></li><li><section><p>数据点的位置：图上每个点代表一个样本，点与点之间的距离代表样本的差别。每个数据点在散点PCA图上的位置表示它在低维空间中的坐标。通常情况下，距离中心点较远的数据点表示数据中的一个特异点或异常值。而聚集在一起的数据点表示数据中具有相似性质的样本。</p></section></li><li><section><p>颜色：颜色可以用来表示数据点所属的类别或其他特征。例如，在聚类分析中，不同的簇可以用不同的颜色表示。</p></section></li><li><section><p>圆圈：某个簇样本地置信区间画出来地圈。</p></section></li><li><section><p>X轴和Y轴百分比：在PCA中，每个主成分解释的方差贡献率是一个重要的指标，用于评估该主成分对原始数据中方差的解释能力。具体来说，X轴和Y轴百分比表示对应的主成分解释的方差贡献率在总方差中的比例。例如，如果X轴和Y轴百分比分别为30％和20％，则表示X轴和Y轴解释了总方差的30％和20％，而其余主成分解释了剩余的50％。因此，X轴和Y轴的百分比可以帮助我们确定保留多少主成分以达到一定的降维效果。横纵坐标后面的百分比在其它领域可能有要求，比如主成分相加要大于 90% 之类的，不过生信分析中一般不怎么关注这个,因为变量（基因）太多了。</p></section></li></ol><p data-tool="mdnice编辑器">值得注意的是，PCA主成分分析是一种无监督学习方法，因此，X轴和Y轴的标签通常表示主成分的编号，而不是代表任何具体的特征或变量。</p><p data-tool="mdnice编辑器"><strong>输入</strong>：转置后表达矩阵（数据框），行为样本，列为基因</p><figure data-tool="mdnice编辑器"><img data-ratio="0.3917634635691658" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24qsibgfYUH00XhiaQGuy6oeq79SLhBP1ndkngmHrcs2eLDLcOtz4zgIEg/640?wx_fmt=png" data-type="png" data-w="947" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24qsibgfYUH00XhiaQGuy6oeq79SLhBP1ndkngmHrcs2eLDLcOtz4zgIEg/640?wx_fmt=png"></figure><h4 data-tool="mdnice编辑器"><span>实战(Step 3.4)</span></h4><p data-tool="mdnice编辑器">先得到转置后的表达矩阵，然后进行 pca 并绘图。</p><pre data-tool="mdnice编辑器"><code>dat=as.data.frame(t(exp))<br><span>library</span>(FactoMineR)<br><span>library</span>(factoextra) <br>dat.pca &lt;- PCA(dat, graph = <span>FALSE</span>)<br>pca_plot &lt;- fviz_pca_ind(dat.pca,<br>                       geom.ind = <span>"point"</span>, <span># show points only (nbut not "text")</span><br>                       col.ind = Group, <span># color by groups</span><br>                       palette = c(<span>"#00AFBB"</span>, <span>"#E7B800"</span>),<br>                       addEllipses = <span>TRUE</span>, <span># Concentration ellipses</span><br>                       legend.title = <span>"Groups"</span>)<br>pca_plot<br>save(pca_plot,file = <span>"pca_plot.Rdata"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7898148148148149" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24ASsIznPXCEVYSB5NpMT88P7ibN9ftHgVbc9UMJIePsj2icKROwL0ykjQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24ASsIznPXCEVYSB5NpMT88P7ibN9ftHgVbc9UMJIePsj2icKROwL0ykjQ/640?wx_fmt=png"></figure><h1 data-tool="mdnice编辑器"><span>四、差异分析</span></h1><h2 data-tool="mdnice编辑器"><span>1. limma 差异分析</span></h2><h3 data-tool="mdnice编辑器"><span></span>limma<span></span></h3><p data-tool="mdnice编辑器">Limma 是一个用于分析由微阵列芯片或 RNA-seq 技术产生的基因表达数据的软件包。limma的算法原理基于线性模型和贝叶斯方法。它采用线性模型来描述基因表达量数据中的差异，并使用贝叶斯方法来估计模型参数，如样本间差异和基因间方差。它还利用经验贝叶斯方法来控制假阳性率（false discovery rate，FDR）</p><h3 data-tool="mdnice编辑器"><span></span>差异分析结果解释<span></span></h3><ul data-tool="mdnice编辑器"><li><section><p>Foldchange(FC): 处理组表达水平平均值/对照组平均值</p></section></li><li><section><p>logFC: 处理组 log 后表达量的平均值 - 对照组 log 后表达量的平均值 。因为 log(x/y)=log(x)-log(y)</p></section></li><li><section><p>logFC 的合理取值范围：个位数。比如说，logFC = 10 ,代表基因上调表达了 2^10^ 也就是 1024 倍。</p></section></li><li><section><p>logFC &gt;0 , 代表基因表达量上升；logFC &lt;0 , 代表基因表达量下降；</p></section></li><li><section><p>通常所说的上下调基因是指表达量显著上调/下调的基因，显著性可根据 p 值判断</p></section></li><li><section><p>常见logFC取值: 1 2 1.2 1.5 2.2 0.585（没有唯一标准）</p></section></li></ul><h3 data-tool="mdnice编辑器"><span>实战(Step 4.1)</span></h3><pre data-tool="mdnice编辑器"><code><span>#载入数据</span><br>rm(list = ls()) <br>load(file = <span>"step2output.Rdata"</span>)<br><span>#使用limma进行差异分析</span><br><span>library</span>(limma)<br>design =model.matrix(~Group) <span># 构建分组矩阵</span><br>fit=lmFit(exp,design) <span># 线性拟合</span><br>fit=eBayes(fit) <span># 贝叶斯检验</span><br>deg=topTable(fit,coef=<span>2</span>,number = <span>Inf</span>) <span># 提取结果</span><br></code></pre><p data-tool="mdnice编辑器">limma 分析的结果包含 6 列：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.36525172754195456" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24Xibbibwml7FL9Z7icEc64lciaCKsxaaYzljM89EcSxIv5KK9HXEvpWLQmw/640?wx_fmt=png" data-type="png" data-w="1013" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24Xibbibwml7FL9Z7icEc64lciaCKsxaaYzljM89EcSxIv5KK9HXEvpWLQmw/640?wx_fmt=png"></figure><ol data-tool="mdnice编辑器"><li><section><code>logFC</code>：差异倍数（Fold Change）的对数值，是指实验组与对照组基因表达量的比值。正数表示上调表达，负数表示下调表达，0表示没有差异表达。</section></li><li><section><code>AveExpr</code>：基因在所有样本中的平均表达水平，通常是对数转换后的表达量平均值。</section></li><li><section><code>t</code>：差异检验统计量，用于衡量两组样本基因表达量差异的显著性。t绝对值越大表示差异越显著。</section></li><li><section><code>P.Value</code>：差异检验的显著性水平，即基于t统计量计算的P值。P值越小表示差异越显著。</section></li><li><section><code>adj.P.Val</code>：校正后的P值，通常使用Benjamini-Hochberg方法进行多重比较校正，控制False Discovery Rate (FDR)。adj.P.Val越小表示差异越显著。</section></li><li><section><code>B</code>：Bayes Factor值，可以用于衡量基因的差异表达程度。B值越大表示差异越显著。</section></li></ol><h2 data-tool="mdnice编辑器"><span>2. 补充差异分析表</span></h2><p data-tool="mdnice编辑器">由于差异分析得到的表只包含探针id号，为了方便后面的分析，我们给差异分析的表添加几列数据，探针 id、基因 symbol、基因差异类型（上调、下调或者不显著）、以及 ENTREZID。其中 ENTREZID 后面富集分析时会用到。</p><ul data-tool="mdnice编辑器"><li><section><p><strong>探针 id 列</strong>: 表达矩阵的行名即探针 id，只需将其转换成一列数据即可。</p></section></li><li><section><p><strong>基因 symbol 列</strong>: 即基因名称。在我们前面 Step2 获得的探针注释信息中, ids 变量中储存了探针 id 与基因 symbol的对应关系。但是需要注意的是多条探针可能会对应1个相同的基因，因为芯片厂商可能会针对某些基因设计多条探针。我们只需要保留其中 1 条探针的差异分析结果即可，所以过滤掉具有重复基因的探针得到的差异表达结果然后再添加基因 symbol列。</p></section></li><ul><li><section>去重的方法：随机去重、保留行和或者行平均值最大的探针、取多个探针的平均值。没有唯一标准。</section></li></ul><li><section><p><strong>基因差异类型（change）列</strong>：我们设置好阈值（logFC 与 p-value）后，将所有基因分为上调<code>up</code>、下调<code>down</code>、或者不显著<code>stable</code>，然后将其作为 1 列数据添加。</p></section></li><li><section><p><strong>ENTREZID 列</strong>：使用 clusterProfiler 包的 bitr 函数在相应数据库中（如人类 org.Hs.eg.db）获取基因 symbol 与 ENTREZID 的对应关系。symbol 与 ENTREZID 并不是一一对应的因此，得到的对应关系 symbol数可能会增多一点，也可能会较少一点（比如提示：3.26% of input gene IDs are fail to map...），都是正常的。</p></section></li><ul><li><section>对应物种数据库的包名称获取方法：bioconductor链接<code>http://bioconductor.org/packages/release/BiocViews.html</code></section></li></ul></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.8379629629629629" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24iapS6SMOaNRHZ0s6ZzvuxMzBBGEQMwj89iaLibicS9BdGhFkWeONlNqw0Q/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24iapS6SMOaNRHZ0s6ZzvuxMzBBGEQMwj89iaLibicS9BdGhFkWeONlNqw0Q/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><code><br></code><code>非模式生物没有 OrgDb 需要自己构建：</code><code>简书链接`https://www.jianshu.com/p/9c9e97167377`<br></code></pre><h3 data-tool="mdnice编辑器"><span>实战(Step 4.2)</span></h3><pre data-tool="mdnice编辑器"><code><span># 1.加probe_id列，把行名变成一列</span><br><span>library</span>(dplyr)<br>deg &lt;- mutate(deg,probe_id=rownames(deg))  <br><br><span>#2.加上探针注释中的symbol</span><br>ids = ids[!duplicated(ids$symbol),]  <span># 去除了ids 中重复的探针</span><br><span># ids = distinct(ids,symbol,.keep_all = T)  # 与上面语句等价</span><br>deg &lt;- inner_join(deg,ids,by=<span>"probe_id"</span>) <span># 添加symbol列，同时过滤重复的探针的差异分析结果</span><br>nrow(deg)<br><br><span>#3.加change列,标记上下调基因</span><br>logFC_t=<span>1</span><br>p_t = <span>0.05</span><br>k1 = (deg$P.Value &lt; p_t)&amp;(deg$logFC &lt; -logFC_t)<br>k2 = (deg$P.Value &lt; p_t)&amp;(deg$logFC &gt; logFC_t)<br>deg &lt;- mutate(deg,change = ifelse(k1,<span>"down"</span>,ifelse(k2,<span>"up"</span>,<span>"stable"</span>)))<br>table(deg$change)<br><br><span>#4.加ENTREZID列，用于富集分析（symbol转entrezid，然后inner_join）</span><br><span>library</span>(clusterProfiler)<br><span>library</span>(org.Hs.eg.db)<br>s2e &lt;- bitr(deg$symbol,  <span># 根据 deg 的symbol，在相应的数据库中找到对应的ENTREZID</span><br>            fromType = <span>"SYMBOL"</span>,<br>            toType = <span>"ENTREZID"</span>,<br>            OrgDb = org.Hs.eg.db) <span>#人类</span><br><span>#其他物种http://bioconductor.org/packages/release/BiocViews.html</span><br>deg_plot &lt;- deg  <span># 因为我不希望后面绘图丢失几个symbol所以这里弄了一个deg_plot用于差异基因绘图 </span><br>deg &lt;- inner_join(deg,s2e,by=c(<span>"symbol"</span>=<span>"SYMBOL"</span>)) <span># 添加ENTREZID列</span><br>save(Group,deg,deg_plot,logFC_t,p_t,gse_number,file = <span>"step4output.Rdata"</span>)<br></code></pre><p data-tool="mdnice编辑器">最后得到的 deg 表格 ：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.25925925925925924" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24vLTEibV9StMuadRIXYFics2asrSFkPLIvggYKIauzLqcVoSkxGAammyg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24vLTEibV9StMuadRIXYFics2asrSFkPLIvggYKIauzLqcVoSkxGAammyg/640?wx_fmt=png"></figure><h1 data-tool="mdnice编辑器"><span>五、差异分析可视化</span></h1><h2 data-tool="mdnice编辑器"><span>1. 火山图</span></h2><p data-tool="mdnice编辑器">火山图（volcano plot）通常用于比较两组样本或实验条件的数据，其中横坐标表示差异度（logFC），纵坐标表示显著性（负对数P值，-log10(P-value)）。每个数据点代表一个基因、蛋白质或其他生物分子，在火山图中呈现为一个点。点的位置表示该基因、蛋白质或分子的显著性和差异度。为什么要用负对数P值？因为 p 值本身很小，直接作为 y 轴画在图上不好看。因此，火山图中横坐标增加 1 ，代表 FoldChange 增加了 2 倍，纵坐标增加 1 ，代表 p 值减小了 10 倍。</p><p data-tool="mdnice编辑器">一般来说，显著性越高，P值越小，负对数P值越大，数据点越靠近图像顶部；差异度越高，Fold Change越大，数据点越靠近图像的左右两侧。在火山图中，通常会设置一个阈值（如 Fold Change 值或 P 值），以区分显著差异的点和非显著差异的点。一些火山图会进一步使用颜色编码来显示差异的方向，例如使用红色表示高表达，蓝色表示低表达。</p><p data-tool="mdnice编辑器"><strong>输入</strong>：差异分析得到的表格（需要 p值、logFC、以及基因差异表达的 change 三列数据）</p><h3 data-tool="mdnice编辑器"><span>实战(Step 5.1)</span></h3><pre data-tool="mdnice编辑器"><code><span># 载入数据</span><br>rm(list = ls()) <br>load(file = <span>"step1output.Rdata"</span>)<br>load(file = <span>"step4output.Rdata"</span>)<br><br><span># 画火山图</span><br><span>library</span>(dplyr)<br><span>library</span>(ggplot2)<br>dat &lt;- deg_plot<br><span># dat  = distinct(deg,symbol,.keep_all = T) 如果用deg作图需要对symbol去重</span><br>p &lt;- ggplot(data = dat, <br>            aes(x = logFC, <br>                y = -log10(P.Value))) +<br>  geom_point(alpha=<span>0.4</span>, size=<span>3.5</span>,  <span># 透明度，点大小</span><br>             aes(color=change)) +<br>  scale_color_manual(values=c(<span>"blue"</span>, <span>"grey"</span>,<span>"red"</span>))+<br>  geom_vline(xintercept=c(-logFC_t,logFC_t),lty=<span>4</span>,col=<span>"black"</span>,linewidth=<span>0.8</span>) +<br>  geom_hline(yintercept = -log10(p_t),lty=<span>4</span>,col=<span>"black"</span>,linewidth=<span>0.8</span>) +<br>  theme_bw()<br>p<br><span># 添加某些基因的标签</span><br>for_label &lt;- dat%&gt;% <br>  filter(symbol %<span>in</span>% c(<span>"DUSP6"</span>,<span>"ETV5"</span>))<br><br>volcano_plot &lt;- p +<br>  geom_point(size = <span>3</span>, shape = <span>1</span>, data = for_label) +<br>  ggrepel::geom_label_repel( <span># 添加标签</span><br>    aes(label = symbol),<br>    data = for_label,<br>    color=<span>"black"</span>)<br>volcano_plot<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7944444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24sz2lD3lrhSjLGa2neULzsepADGOIdxkrj3fhVoDIAy2629NiaSXU6gQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24sz2lD3lrhSjLGa2neULzsepADGOIdxkrj3fhVoDIAy2629NiaSXU6gQ/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span>2. 热图(Step 5.2)</span></h2><p data-tool="mdnice编辑器">根据需求选取一定数量或全部的差异基因，然后用 pheatmap 绘制热图。</p><pre data-tool="mdnice编辑器"><code>load(file = <span>'step2output.Rdata'</span>)<br><span># 表达矩阵行名替换</span><br>exp = exp[dat$probe_id,]<br>rownames(exp) = dat$symbol<br><span>if</span>(<span>T</span>){<br>  <span>#取前10上调和前10下调</span><br>  <span>library</span>(dplyr)<br>  dat2 = dat %&gt;%<br>    filter(change!=<span>"stable"</span>) %&gt;% <br>    arrange(logFC) <br>  cg = c(head(dat2$symbol,<span>10</span>),<br>         tail(dat2$symbol,<span>10</span>))<br>}<span>else</span>{<br>  <span>#全部差异基因</span><br>  cg = dat$symbol[dat$change !=<span>"stable"</span>]<br>  length(cg)<br>}<br>n=exp[cg,]<br>dim(n)<br><br><span>#差异基因热图</span><br><span>library</span>(pheatmap)<br>annotation_col=data.frame(group=Group)<br>rownames(annotation_col)=colnames(n) <br>heatmap_plot &lt;- pheatmap(n,show_colnames =<span>F</span>,<br>                         scale = <span>"row"</span>,<br>                         <span>#cluster_cols = F, </span><br>                         annotation_col=annotation_col,<br>                         breaks = seq(-<span>3</span>,<span>3</span>,length.out = <span>100</span>)<br>) <br>heatmap_plot<br><span>#也可以把火山图与热图拼在一起</span><br><span>library</span>(patchwork)<br>volcano_plot +heatmap_plot$gtable<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.8166666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24csvbr4N3wdu8TtfLI76vaC7vnIQjhLvwLeps4adNyZhf3znO2WHKgA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24csvbr4N3wdu8TtfLI76vaC7vnIQjhLvwLeps4adNyZhf3znO2WHKgA/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span>3. 相关性热图(Step 5.3)</span></h2><p data-tool="mdnice编辑器">使用 cor 函数计算基因之间的相关性，需要注意的是原始的表达矩阵是列为样本，直接用 cor 函数实际上计算的是样本之间的相关性，因此需要转置后才能计算基因之间的相关性。</p><p data-tool="mdnice编辑器"><strong>输入</strong>：相关性矩阵，用 pheatmap 或者 corrplot 画图</p><pre data-tool="mdnice编辑器"><code><span>library</span>(corrplot)<br>g = sample(deg$symbol[<span>1</span>:<span>500</span>],<span>10</span>) <span># 这里是随机取样，注意换成自己感兴趣的基因</span><br>g<br><br>M = cor(t(exp[g,]))  <span># cor计算列之间的相关性，所以要转置</span><br><span># pheatmap 绘图</span><br>pheatmap(M)<br><span># 用 corrplot 绘图</span><br><span>library</span>(paletteer)<br>my_color = rev(paletteer_d(<span>"RColorBrewer::RdYlBu"</span>))<br>my_color = colorRampPalette(my_color)(<span>10</span>)<br>corrplot(M, type=<span>"upper"</span>,<br>         method=<span>"pie"</span>,<br>         order=<span>"hclust"</span>, <br>         col=my_color,<br>         tl.col=<span>"black"</span>, <br>         tl.srt=<span>45</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.812962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24VNrY1VaKeH5W7BUmc5CREoNdpKLlib3GsaXkqRIeS2Xzc3NT3ibK4dNg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24VNrY1VaKeH5W7BUmc5CREoNdpKLlib3GsaXkqRIeS2Xzc3NT3ibK4dNg/640?wx_fmt=png"></figure><h1 data-tool="mdnice编辑器"><span>六、富集分析</span></h1><h2 data-tool="mdnice编辑器"><span>1. GO 与 KEGG、富集分析</span></h2><h3 data-tool="mdnice编辑器"><span></span>GO 与 KEGG 数据库简介<span></span></h3><p data-tool="mdnice编辑器">GO（Gene Ontology）数据库<code>www.geneontoloy.org</code>是一个关系数据库，包括GO 本体论、基因和基因产物在这些本体论术语中的注释信息。旨在建立一套适用于各种物种的，对基因和蛋白质功能从多个方面进行限定和描述的，并能随着研究不断深入而更新的语义(terms)词汇标准，即基因产物分类标准。注释系统中每一个结点(term)都是基因或蛋白功能的一种命名及描述。</p><ul data-tool="mdnice编辑器"><li><section>分子功能(Molecular Function, MF)描述在个体分子生物学上的活性，如催化活性或结合活性。</section></li><li><section>生物学过程(Biological Process,BP)由分子功能有序地组成的，具有多个步骤的一个过程，如细胞周期。</section></li><li><section>细胞组件(Cellular Component, CC)指基因产物位于何种细胞器或基因产物组中(如糙面内质网，核糖体，蛋白酶体等)，即基因产物在什么地方起作用。</section></li></ul><p data-tool="mdnice编辑器">KEGG<code>www.genome.jp/kegg</code>（Kyoto Encyclopedia of Genes and Genomes）是系统地分析基因功能、链接基因组信息和功能信息的数据库,旨在揭示生命现象的遗传与化学蓝图。</p><h3 data-tool="mdnice编辑器"><span></span>富集分析<span></span></h3><p data-tool="mdnice编辑器">通过将差异基因做 GO 富集分析，可以把基因按照不同的功能进行归类，达到对基因进行注释和分类的目的。富集分析可以这么理解：衡量每个通路里的基因在差异基因里是否足够多。</p><p data-tool="mdnice编辑器"><strong>富集的思路</strong>：可以选取全部差异基因富集，也可以上下调基因分开富集，或者选择自己感兴趣的基因进行富集。</p><h2 data-tool="mdnice编辑器"><span>2. 实战(Step 6.1)</span></h2><p data-tool="mdnice编辑器">利用 clusterProfiler 包进行 GO 富集分析以及可视化。</p><p data-tool="mdnice编辑器"><strong>输入</strong>：输入一组我们感兴趣的差异基因的 ENTREZID</p><p data-tool="mdnice编辑器"><strong>GO 富集分析</strong>：enrichGO 函数富集分析，barplot 函数与 dotplot函数画条带图与气泡图</p><pre data-tool="mdnice编辑器"><code><span># 载入数据与包</span><br>rm(list = ls())  <br>load(file = <span>'step4output.Rdata'</span>)<br><span>library</span>(clusterProfiler)<br><span>library</span>(ggthemes)<br><span>library</span>(org.Hs.eg.db)<br><span>library</span>(dplyr)<br><span>library</span>(ggplot2)<br><span>library</span>(stringr)<br><span>library</span>(enrichplot)<br><br><span># 1.GO 富集分析</span><br><br><span>#(1)输入数据</span><br>gene_up = deg$ENTREZID[deg$change == <span>'up'</span>] <br>gene_down = deg$ENTREZID[deg$change == <span>'down'</span>] <br>gene_diff = c(gene_up,gene_down) <span># 所有差异基因</span><br><br><span>#(2)GO富集</span><br>ego &lt;- enrichGO(gene = gene_diff, <span># 差异基因的ENTREZID</span><br>                OrgDb= org.Hs.eg.db, <span># 人类对应的数据库</span><br>                ont = <span>"ALL"</span>, <span># GO的三个部分都要</span><br>                readable = <span>TRUE</span>) <span># 这个参数可以把结果转换回symbol</span><br><span>#ont参数：One of "BP", "MF", and "CC" subontologies, or "ALL" for all three.</span><br><br><span>#(3)可视化</span><br><span>#条带图</span><br>barplot(ego)<br>barplot(ego, split = <span>"ONTOLOGY"</span>, font.size = <span>10</span>,  <span># 按照GO的三个组分分开画图</span><br>        showCategory = <span>5</span>) + <br>  facet_grid(ONTOLOGY ~ ., space = <span>"free_y"</span>,scales = <span>"free_y"</span>) <br><span>#气泡图</span><br>dotplot(ego) <br>dotplot(ego, split = <span>"ONTOLOGY"</span>, font.size = <span>10</span>, <br>        showCategory = <span>5</span>) + <br>  facet_grid(ONTOLOGY ~ ., space = <span>"free_y"</span>,scales = <span>"free_y"</span>) <br><span>#(4)拼图</span><br>a &lt;- barplot(ego)<br>b &lt;- dotplot(ego) <br><span>library</span>(patchwork)<br>a+b<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>G0 富集结果含义<span></span></h3><pre data-tool="mdnice编辑器"><code>ego@result<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.18981481481481483" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24H1o2SKNWl24zHZWibChsySVdKEoJUNFlhvQWVM9HHiawKnWXtZIYjIDQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24H1o2SKNWl24zHZWibChsySVdKEoJUNFlhvQWVM9HHiawKnWXtZIYjIDQ/640?wx_fmt=png"></figure><ol data-tool="mdnice编辑器"><li><section>ONTOLOGY : GO 的 ONTOLOGY 类别（BP、MF、CC）</section></li><li><section>ID: 对应于富集分析中找到的功能/通路的唯一标识符。</section></li><li><section>Description: 功能/通路的描述，通常是文本或注释信息。</section></li><li><section>GeneRatio: 在功能/通路中富集的差异基因数除以被收录的差异基因总数。比如 20/208 ，20 代表差异基因中有 20 个属于该通路，208 代表差异基因中有 208 个被对应的数据库所收录。</section></li><li><section>BgRatio: 在功能/通路中的基因总数数除以背景基因集中基因总数。比如 91/8217 ，91 代表该通路中共有 91 个基因，8217 代表对应的数据库中共有8217个基因。</section></li><li><section>pvalue: 统计分析中得到的原始p值。</section></li><li><section>p.adjust: 经过多重检验校正（例如，Bonferroni校正或Benjamini-Hochberg校正）后的p值。clusterProfiler包任何可视化都是基于 p.adjust 做的。</section></li><li><section>qvalue: 经过多重检验校正后的假发现率(FDR)。</section></li><li><section>geneID: 在相应功能/通路中富集的基因ID列表，以斜杆分隔。</section></li><li><section>Count: 在相应功能/通路中富集的基因数。</section></li></ol><h3 data-tool="mdnice编辑器"><span>可视化结果</span></h3><figure data-tool="mdnice编辑器"><img data-ratio="0.5666666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24MibTicPKiaztR6icgvPeUDHqAbZswWibfc3sFV8iathxdAUoUGorwWZTIYcA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24MibTicPKiaztR6icgvPeUDHqAbZswWibfc3sFV8iathxdAUoUGorwWZTIYcA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>横向条形图</strong></p><ul data-tool="mdnice编辑器"><li><section>x轴：Count（富集的基因数）</section></li><li><section>y轴：Description（功能/通路）</section></li><li><section>气泡颜色：对应通路的显著性水平，按照 p.adjust 分配，从蓝到红显著性逐渐升高</section></li></ul><p data-tool="mdnice编辑器"><strong>气泡图</strong></p><ul data-tool="mdnice编辑器"><li><section>x轴：GeneRatio</section></li><li><section>y轴：Description（功能/通路）</section></li><li><section>气泡大小：Count（富集的基因数多少）</section></li><li><section>气泡颜色：对应通路的显著性水平，按照 p.adjust 分配，从蓝到红显著性逐渐升高</section></li></ul><h3 data-tool="mdnice编辑器"><span>其它图形</span></h3><ul data-tool="mdnice编辑器"><li><section><strong>展示top通路的共同基因。</strong></section></li></ul><pre data-tool="mdnice编辑器"><code><span>#gl 用于设置下图的颜色</span><br>gl = deg$logFC<br>names(gl)=deg$ENTREZID<br><span>#Gene-Concept Network,要放大看</span><br>cnetplot(ego,<br>         <span># layout = "star",</span><br>         color.params = list(foldChange = gl),<br>         showCategory = <span>3</span>) <br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5777777777777777" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24buelqQrVEWff9rIBGfib3pYOZYy6iaibm78UTu2PkFAX0lwDu1AlvaWRQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24buelqQrVEWff9rIBGfib3pYOZYy6iaibm78UTu2PkFAX0lwDu1AlvaWRQ/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section><strong>展示 Go term 之间的关系</strong></section></li></ul><p data-tool="mdnice编辑器">有颜色的 term 代表实验中富集到的，灰色的 term 代表挖掘到的与之相关的一些 term</p><pre data-tool="mdnice编辑器"><code>ego_BP &lt;- enrichGO(gene = gene_diff,<br>                     OrgDb= org.Hs.eg.db,<br>                     ont = <span>"BP"</span>,  <span># 只选择GO的BP</span><br>                     readable = <span>TRUE</span>)<br>goplot(ego_BP)<br><span># 图的理解可参考 zhuanlan.zhihu.com/p/99789859</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5574074074074075" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24BnozZLsQL1uyhMSoYxuMFlBv3W85lMDqTTWkwHCxLc9F1X9LcApNgw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24BnozZLsQL1uyhMSoYxuMFlBv3W85lMDqTTWkwHCxLc9F1X9LcApNgw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span>3. 实战(Step 6.2)</span></h2><p data-tool="mdnice编辑器">利用 clusterProfiler 包进行 KEGG 富集分析以及可视化。</p><p data-tool="mdnice编辑器"><strong>输入</strong>：输入一组我们感兴趣的差异基因的 ENTREZID</p><p data-tool="mdnice编辑器"><strong>KEGG 富集分析</strong>：enrichKEGG 函数富集分析，画图函数与 GO 富集分析相同</p><pre data-tool="mdnice编辑器"><code><span>#（1）输入数据</span><br>gene_up = deg[deg$change == <span>'up'</span>,<span>'ENTREZID'</span>] <br>gene_down = deg[deg$change == <span>'down'</span>,<span>'ENTREZID'</span>] <br>gene_diff = c(gene_up,gene_down)<br><br><span>#（2）对上调/下调/所有差异基因进行富集分析</span><br><span>#富集上调基因</span><br>kk.up &lt;- enrichKEGG(gene = gene_up,<br>                    organism = <span>'hsa'</span>) <span># 指定物种名称，人类为hsa</span><br><span>#富集下调基因</span><br>kk.down &lt;- enrichKEGG(gene =  gene_down,<br>                      organism = <span>'hsa'</span>)<br><span>#富集所有基因</span><br>kk.diff &lt;- enrichKEGG(gene = gene_diff,<br>                      organism = <span>'hsa'</span>)<br><br><span>#(3)看看富集到了吗？https://mp.weixin.qq.com/s/NglawJgVgrMJ0QfD-YRBQg</span><br>table(kk.diff@result$p.adjust&lt;<span>0.05</span>)<br>table(kk.up@result$p.adjust&lt;<span>0.05</span>)<br>table(kk.down@result$p.adjust&lt;<span>0.05</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span>结果</span></h3><p data-tool="mdnice编辑器">按照矫正 p 值小于0.05来看，上调基因没有富集到。</p><pre data-tool="mdnice编辑器"><code>&gt; table(kk.diff@result$p.adjust&lt;<span>0.05</span>)<br><span>FALSE</span>  <span>TRUE</span> <br>  <span>289</span>    <span>14</span> <br>&gt; table(kk.up@result$p.adjust&lt;<span>0.05</span>) <br><span>FALSE</span> <br>  <span>282</span> <br>&gt; table(kk.down@result$p.adjust&lt;<span>0.05</span>)<br><span>FALSE</span>  <span>TRUE</span> <br>  <span>211</span>    <span>19</span> <br></code></pre><p data-tool="mdnice编辑器">kegg 富集分析结果各指标的含义与 GO 富集结果基本一致，也可以画点图、横向条形图，画图函数与前面GO富集的一致：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.3" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24nxBunB1ZHLKRAOP0cm7uGiahaKKFOl1NQiaqSSXVDiayRtDgribHWIauGg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24nxBunB1ZHLKRAOP0cm7uGiahaKKFOl1NQiaqSSXVDiayRtDgribHWIauGg/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>KEGG富集时遇到的问题<span></span></h3><figure data-tool="mdnice编辑器"><img data-ratio="0.15462962962962962" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24423bTGYvQPulasXpX8UmjMY9bkYoVcNVxUQOD8Fe7REaPdFR0BCEsA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24423bTGYvQPulasXpX8UmjMY9bkYoVcNVxUQOD8Fe7REaPdFR0BCEsA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">一开始我以为是没富集到，但是后来有一次重新跑的时候又富集到了，所以如果富集后 kk 直接返回 NULL 的话可能和网络有关系，因为一般来说 kk 都会返回一个列表的，列表中的数据 p 值不显著才算没有富集到。</p><h2 data-tool="mdnice编辑器"><span>4. 备注</span></h2><h3 data-tool="mdnice编辑器"><span></span>没有富集到怎么办？<span></span></h3><ol data-tool="mdnice编辑器"><li><section>clusterProfiler 是根据 p.adjust 进行富集的，可以试一下用 p 值进行筛选</section></li><li><section>换一种富集的方式，如 GSEA <code>https://www.yuque.com/docs/share/a67a180f-dd2b-4f6f-96c2-68a4b86fe862?</code></section></li><li><section>调整差异基因，增加或减少差异基因都会改变富集分析结果</section></li></ol><h3 data-tool="mdnice编辑器"><span></span>画其它图<span></span></h3><pre data-tool="mdnice编辑器"><code><span># 富集分析学习更多：http://yulab-smu.top/clusterProfiler-book/index.html</span><br><span># 弦图：https://www.yuque.com/xiaojiewanglezenmofenshen/dbwkg1/dgs65p</span><br><span># GOplot：https://mp.weixin.qq.com/s/LonwdDhDn8iFUfxqSJ2Wew</span><br></code></pre><h1 data-tool="mdnice编辑器"><span>七、tinyarray简化分析</span></h1><h2 data-tool="mdnice编辑器"><span>1. 双分组数据</span></h2><p data-tool="mdnice编辑器">前面我们经过六步对芯片数据进行了分析，使用小洁老师的 tinyarray 包可以简化上述流程，一步到位进行芯片数据分析。还是用这个数据集 GSE42872 用 tinyarray 包进行简化分析。我们自己只要完成前面两步得到表达矩阵、分组信息、探针注释信息，就可以直接一步获得差异分析可视化结果了。</p><pre data-tool="mdnice编辑器"><code><span># 下载数据</span><br><span># geo_download()函数直接从国内镜像下载表达矩阵，得到exp，pd,gpl</span><br><span>library</span>(tinyarray)<br><span>library</span>(stringr)<br>gse = <span>"GSE42872"</span><br>geo = geo_download(gse)<br>boxplot(geo$exp) <span># 发现不需要 log 转化</span><br><br><span># 获取分组信息和探针注释</span><br>Group=ifelse(str_detect(geo$pd$title,<span>"Control"</span>),<br>             <span>"control"</span>,<br>             <span>"treat"</span>)<br>Group = factor(Group,levels = c(<span>"control"</span>,<span>"treat"</span>))<br>find_anno(geo$gpl)<br>ids &lt;- AnnoProbe::idmap(<span>'GPL6244'</span>)<br>head(ids)<br><br><span>#差异分析和它的可视化 get_deg_all函数一步到位</span><br>dcp = get_deg_all(geo$exp,Group,ids)<br>table(dcp$deg$change)<br>head(dcp$deg)<br>dcp$plots<br><span>library</span>(ggplot2)<br>ggsave(<span>"deg.png"</span>,width = <span>15</span>,height = <span>5</span>)<br><br><span>#富集分析</span><br>genes = dcp$deg$ENTREZID[dcp$deg$change!=<span>"stable"</span>]<br>head(genes)<br><span>#有可能因为网络问题报错</span><br>g = quick_enrich(genes,destdir = tempdir())<br>names(g)<br>g[[<span>1</span>]][<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span>library</span>(patchwork)<br>g[[<span>3</span>]]+g[[<span>4</span>]]<br>ggsave(<span>"enrich.png"</span>,width = <span>12</span>,height = <span>7</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span>结果</span></h3><ol data-tool="mdnice编辑器"><li><section>差异分析可视化结果：热图、PCA图、火山图</section></li></ol><figure data-tool="mdnice编辑器"><img data-ratio="0.33611111111111114" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24ibLIBzicgrrIZWXoh6mZJ3nYRvgrSgnz3wCqqibS7mTTAa1D7gY8LJJPA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24ibLIBzicgrrIZWXoh6mZJ3nYRvgrSgnz3wCqqibS7mTTAa1D7gY8LJJPA/640?wx_fmt=png"></figure><ol start="2" data-tool="mdnice编辑器"><li><section>富集分析可视化结果，左图为 KEGG 富集气泡图，右图为 GO 富集气泡图。</section></li></ol><figure data-tool="mdnice编辑器"><img data-ratio="0.562037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ244NrtQDD3oCGDRKIV4LI6SHIkent8BXlcYiaDHUB18ernxatyV4XmvMQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ244NrtQDD3oCGDRKIV4LI6SHIkent8BXlcYiaDHUB18ernxatyV4XmvMQ/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span>2. 多分组数据</span></h2><p data-tool="mdnice编辑器">对于多分组数据，如 1 个对照组、两个以上实验组，或者多个实验组的，可以将原始数据输入用 limma 分析，然后提取两两比较的差异分析结果，再可视化。也可以用 tinyarray 包一步完成分析。以数据集 GSE474 为例：</p><pre data-tool="mdnice编辑器"><code><span>### 1.获取数据</span><br>rm(list = ls())<br><span>library</span>(stringr)<br><span>library</span>(tinyarray)<br>gse = <span>"GSE474"</span><br>geo = geo_download(gse)<br>geo$exp = log2(geo$exp+<span>1</span>)<br><br><span>### 2.生成分组向量与探针注释</span><br><span>#注意仍然是对照组放在levels的第一个位置</span><br><span>#三分组一般是两两比较，后面差异分析时看清楚谁比谁就可以了。</span><br>Group=str_split(geo$pd$title,<span>"-"</span>,simplify = <span>T</span>)[,<span>3</span>]<br>Group=factor(Group,levels = c(<span>"NonObese"</span>,<span>"Obese"</span>,<span>"MObese"</span>))<br>geo$gpl<br><span>if</span>(!<span>require</span>(hgu133a.db))BiocManager::install(<span>"hgu133a.db"</span>)<br><span>library</span>(hgu133a.db)<br>ids &lt;- toTable(hgu133aSYMBOL)<br>head(ids)<br><br><span>### 3.tinyarray的简化操作</span><br><span>#多分组的数据，get_deg_all仍然可以帮你简化操作，</span><br><span>#目前是三分组就两两差异分析，四个或五个分组的数据是后面几个组与第一个组差异分析，</span><br><span>#暂不支持其他的做法和更多的分组。</span><br>dcp = get_deg_all(geo$exp,Group,ids,symmetry = <span>T</span>,logFC_cutoff = <span>0.585</span>,cluster_cols = <span>F</span>,entriz = <span>F</span>)<br>dcp$plots<br>ggplot2::ggsave(<span>"deg.png"</span>,width = <span>15</span>,height = <span>10</span>)<br><br><span>#富集分析的输入数据是差异基因名字，只要你提供一组基因名就能做，</span><br><span>#要分别做三次还是取交集或合集一起做都可以，没有标准答案。</span><br></code></pre><h3 data-tool="mdnice编辑器"><span>结果</span></h3><p data-tool="mdnice编辑器">得到三个组的差异基因热图、PCA图、两两比较的差异基因韦恩图、两两比较的火山图</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6944444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24U9925cl6JTBReEZLfoJHBTIaBum5MLXH0LL7T1eBwsZiciaS3sPXr3bw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/9qvDEYXFF7YTytTp2TEoCPqnxpicFHZ24U9925cl6JTBReEZLfoJHBTIaBum5MLXH0LL7T1eBwsZiciaS3sPXr3bw/640?wx_fmt=png"></figure></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span>写在后面<span></span></h3><blockquote data-tool="mdnice编辑器"><p>GEO数据库里面的表达量芯片数据处理，主要的难点是表达量矩阵获取和探针的基因名字转换，搞定后只需要一定的生物学背景对数据进行合理的分组后就是标准的差异分析，富集分析。<strong>主要是参考我八年前的笔记：</strong></p></blockquote><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486063&amp;idx=1&amp;sn=156bee5397e979722b36b78284188538&amp;scene=21#wechat_redirect" data-linktype="2">解读GEO数据存放规律及下载，一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486054&amp;idx=1&amp;sn=209975adee162228cfe6e6c5065c5c8c&amp;scene=21#wechat_redirect" data-linktype="2">解读SRA数据库规律一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486087&amp;idx=1&amp;sn=1e775a1c3e215384e381953a9fa74ec3&amp;scene=21#wechat_redirect" data-linktype="2">从GEO数据库下载得到表达矩阵 一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486090&amp;idx=1&amp;sn=62374fbdd4f20c3185beb6568bbeb3e9&amp;scene=21#wechat_redirect" data-linktype="2">GSEA分析一文就够（单机版+R语言版）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486112&amp;idx=1&amp;sn=67a2104c62222bcb139623699f874a6c&amp;scene=21#wechat_redirect" data-linktype="2">根据分组信息做差异分析- 这个一文不够的</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486120&amp;idx=1&amp;sn=14d7892c1beec2fb9cdfc0ec0aba3e4e&amp;scene=21#wechat_redirect" data-linktype="2">差异分析得到的结果注释一文就够</a></section></li></ul><p data-tool="mdnice编辑器">因为都是标准的代码，所以每次有学徒和实习生我都会让大家两次十几个数据集，凑成为了一个合辑：《<strong>1000个基因芯片表达量矩阵数据处理</strong>》：</p><p data-tool="mdnice编辑器"><span>其实本文已经是一套</span><strong>万能代码</strong><span>，它理论上可以支持GEO数据库的至少5万个表达量芯片数据集，从下载表达量矩阵到后续差异分富集分析一条龙，而且输出大量图表和一个网页报告！</span><span>但是它并不是傻瓜式的，仍然需要你会R语言，需要生物学背景去修改分组形式，需要人为判断芯片的探针对应基因的关系，其它的图表，比如火山图，热图，GO和KEGG数据库富集图，GSEA图就是自动化的啦。已经是目前我们能想到的最小化干预了。</span></p><h3 data-tool="mdnice编辑器"><span>给大家一个作业本：以GSE16515为例</span></h3><ul data-tool="mdnice编辑器"><li><section>GEO链接：https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE16515</section></li><li><section>芯片平台：GPL570 [HG-U133_Plus_2] Affymetrix Human Genome U133 Plus 2.0 Array</section></li><li><section>平台链接：https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GPL570</section></li><li><section>样品信息：16个正常样本与36个胰腺导管腺癌（PDAC）样本</section></li><li><section>文章标题及链接：FKBP51 Affects Cancer Cell Response to Chemotherapy by Negatively Regulating，Akt.Cancer Cell. 2009 Sep 8; 16(3) https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2755578/</section></li></ul><p>需要你完成下面的3个分析图：<br></p><p data-tool="mdnice编辑器">首先是分组后查看是否合理：</p><p><img data-galleryid="" data-ratio="0.5712962962962963" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZ5JFmPvMY5elhBWZvkSar9jUiaGe4iajM6crbsYTqX4paIPc8J1b0GPMu6EXePjc6xkqPKbTN0j8Q/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZ5JFmPvMY5elhBWZvkSar9jUiaGe4iajM6crbsYTqX4paIPc8J1b0GPMu6EXePjc6xkqPKbTN0j8Q/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">然后是简单的差异分析：</p><p><img data-galleryid="" data-ratio="0.5055555555555555" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZ5JFmPvMY5elhBWZvkSartLy9lzwwJSMrQlGGkPeCh55nTb3Sf6icicgmKBylsuGfawK3RIO4OHibQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZ5JFmPvMY5elhBWZvkSartLy9lzwwJSMrQlGGkPeCh55nTb3Sf6icicgmKBylsuGfawK3RIO4OHibQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><figure data-tool="mdnice编辑器"><figcaption>简单的差异分析</figcaption></figure><p data-tool="mdnice编辑器">最后是简单的数据库注释：</p><p><img data-galleryid="" data-ratio="0.5138888888888888" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZ5JFmPvMY5elhBWZvkSar76lsVnciapM0a2yqKlPVZRFxtFhAh0cviamiaTRUiaacYoFDh34nGgfprg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZ5JFmPvMY5elhBWZvkSar76lsVnciapM0a2yqKlPVZRFxtFhAh0cviamiaTRUiaacYoFDh34nGgfprg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">每一个图表都有背后的统计学原理，也有各自美化的代码，但是都不在我们的万能代码里面哦。</p><p><br></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/4jrCRUfOlw09IMBbCpCl7A",target="_blank" rel="noopener noreferrer">原文链接</a>
