---
title: "白癜风单细胞转录组数据处理"
date: 2023-06-30T01:51:44Z
draft: ["false"]
tags: [
  "fetched",
  "珠海健明生物医药科技"
]
categories: ["Acdemic"]
---
白癜风单细胞转录组数据处理 by 珠海健明生物医药科技
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>前些天我们公众号弄了一个活动，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519474&amp;idx=1&amp;sn=a07f2684e4bebfc5307add35cfbf82a2&amp;scene=21#wechat_redirect" data-linktype="2">春节期间单细胞转录组数据分析全免费</a>，收到了上百个需求， 本来呢我们自己就算是春节前后14天不吃不喝不眠不休也不可能完成这么多单细胞数据处理。好在我灵机一动，想起来了前面两个月培养的一百多个在线实习生，毕竟教了大家R语言，转录组，以及单细胞转录组。</p></blockquote><p data-tool="mdnice编辑器">所以我写了一个还算是比较自动化的单细胞转录组数据处理代码，如果是我自己来做这样的处理，可以在十几分钟就完成复现文章的第一层次降维聚类分群图，如下所示的2分组的15个样品 ：</p><p><img data-galleryid="" data-ratio="0.37777777777777777" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyQr8BdGAhNyoC6JsX1Adz5bjnaRQibVMonp1G1ibGpyuSdWoxeibsliaGb9VbdDB202Ncy5PdTTxzNtQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyQr8BdGAhNyoC6JsX1Adz5bjnaRQibVMonp1G1ibGpyuSdWoxeibsliaGb9VbdDB202Ncy5PdTTxzNtQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>降维聚类分群图</figcaption></figure><p data-tool="mdnice编辑器">首先下载文件，在https://ngdc.cncb.ac.cn/omix/release/OMIX691 可以下载：</p><pre data-tool="mdnice编辑器"><span></span><code>PRJCA006797_RAW % ls -lh *gz|cut -d<span>" "</span> -f 6-<br><br>   12M  1 16 09:59 OMIX691-20-01.tar.gz<br>   25M  1 16 09:59 OMIX691-20-02.tar.gz<br>   23M  1 16 09:59 OMIX691-20-03.tar.gz<br>   42M  1 16 10:00 OMIX691-20-04.tar.gz<br>   36M  1 16 10:00 OMIX691-20-05.tar.gz<br>  7.9M  1 16 10:00 OMIX691-20-06.tar.gz<br>   10M  1 16 10:00 OMIX691-20-07.tar.gz<br>   27M  1 16 10:00 OMIX691-20-08.tar.gz<br>   11M  1 16 10:00 OMIX691-20-09.tar.gz<br>   20M  1 16 10:00 OMIX691-20-10.tar.gz<br>   23M  1 16 10:00 OMIX691-20-11.tar.gz<br>  7.3M  1 16 10:00 OMIX691-20-12.tar.gz<br>   31M  1 16 10:01 OMIX691-20-13.tar.gz<br>   29M  1 16 10:01 OMIX691-20-14.tar.gz<br>   19M  1 16 10:01 OMIX691-20-15.tar.gz<br><br></code></pre><p data-tool="mdnice编辑器">每个样品是一个压缩包，需要解压：</p><pre data-tool="mdnice编辑器"><span></span><code>ls *gz |<span>while</span> <span>read</span> id;<span>do</span> (tar zxvf <span>$id</span>);<span>done</span><br></code></pre><p data-tool="mdnice编辑器">可以看到每个文件夹里面的都是一个标准的10x输出：</p><pre data-tool="mdnice编辑器"><span></span><code><br>P09/outs/filtered_gene_bc_matrices/<br>P09/outs/filtered_gene_bc_matrices/GRCh38/<br>P09/outs/filtered_gene_bc_matrices/GRCh38/matrix.mtx<br>P09/outs/filtered_gene_bc_matrices/GRCh38/barcodes.tsv<br>P09/outs/filtered_gene_bc_matrices/GRCh38/genes.tsv<br>P10/outs/filtered_gene_bc_matrices/<br>P10/outs/filtered_gene_bc_matrices/GRCh38/<br>P10/outs/filtered_gene_bc_matrices/GRCh38/matrix.mtx<br>P10/outs/filtered_gene_bc_matrices/GRCh38/barcodes.tsv<br>P10/outs/filtered_gene_bc_matrices/GRCh38/genes.tsv<br><br></code></pre><p data-tool="mdnice编辑器">接下来就是读取它，然后降维聚类分群啦。值得注意的是这个时候每个文件夹里面的文件都是没有压缩状态，所以耗费磁盘空间比较大：</p><pre data-tool="mdnice编辑器"><span></span><code>├── [  96]  P09<br>│   └── [  96]  outs<br>│       └── [  96]  filtered_gene_bc_matrices<br>│           └── [ 160]  GRCh38<br>│               ├── [ 77K]  barcodes.tsv<br>│               ├── [821K]  genes.tsv<br>│               └── [111M]  matrix.mtx<br>└── [  96]  P10<br>    └── [  96]  outs<br>        └── [  96]  filtered_gene_bc_matrices<br>            └── [ 160]  GRCh38<br>                ├── [ 55K]  barcodes.tsv<br>                ├── [821K]  genes.tsv<br>                └── [ 74M]  matrix.mtx<br></code></pre><p data-tool="mdnice编辑器">一般来说，我们会压缩它，但是<strong>压缩它</strong>就意味着需要把 genes.tsv 修改为 features.tsv 的格式，所以这里略。很轻松的把这么多样品的表达量矩阵读入，并且构建成为了Seurat对象：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>) <br><span>source</span>(<span>'scRNA_scripts/lib.R'</span>)<br><br><span>###### step1:导入数据 ######   </span><br><span># 付费环节 800 元人民币</span><br>dir=<span>'PRJCA006797_RAW/'</span> <br>samples=list.files( dir )<br>samples<br><span># samples = head(samples,10) </span><br>sceList = lapply(samples,<span>function</span>(pro){ <br>  <span># pro=samples[1] </span><br>  print(pro)  <br>  sce =CreateSeuratObject(counts =  Read10X(file.path(dir,pro,<span>'outs/filtered_gene_bc_matrices/GRCh38'</span>)) ,<br>                          project =  gsub(<span>'_filtered_feature_bc_matrix'</span>,<span>''</span>,pro)  ,<br>                          min.cells = <span>5</span>,<br>                          min.features = <span>500</span> )<br>  <span>return</span>(sce)<br>})<br>names(sceList) <br><span># gsub('^GSM[0-9]*','',samples)</span><br>sce.all=merge(x=sceList[[<span>1</span>]],<br>              y=sceList[ -<span>1</span> ],<br>              add.cell.ids =gsub(<span>'_filtered_feature_bc_matrix'</span>,<span>''</span>,samples)     )<br><br>as.data.frame(sce.all@assays$RNA@counts[<span>1</span>:<span>10</span>, <span>1</span>:<span>2</span>])<br>head(sce.all@meta.data, <span>10</span>)<br>table(sce.all$orig.ident) <br><span># 分组信息，通常是隐含在文件名，样品名字里面</span><br><span># phe=str_split( colnames(sce.all),'[-_]',simplify = T)</span><br><span># head(phe)</span><br><span># table(phe[,1])</span><br>sce.all$group= substring(colnames(sce.all),<span>1</span>,<span>1</span>)<br><span># sce.all@meta.data$group =  ifelse(grepl('ne',sce.all$orig.ident),'ne','e')</span><br>table(sce.all@meta.data$group)<br>table(sce.all@meta.data$orig.ident)<br></code></pre><p data-tool="mdnice编辑器">上面的 scRNA_scripts 文件夹里面的 lib.R 就是加载一些单细胞转录组数据分析常见的包即可。</p><h3 data-tool="mdnice编辑器"><span></span>然后整合多个样品并且降维聚类分群<span></span></h3><p data-tool="mdnice编辑器">下面的scRNA_scripts 文件夹里面的 qc.R ， 就是检测线粒体基因，核糖体基因等简单的质量控制 ：</p><pre data-tool="mdnice编辑器"><span></span><code><span>###### step2:QC质控 ######</span><br>dir.create(<span>"./1-QC"</span>)<br>setwd(<span>"./1-QC"</span>)<br><span># 如果过滤的太狠，就需要去修改这个过滤代码</span><br><span>source</span>(<span>'../scRNA_scripts/qc.R'</span>)<br>sce.all.filt = basic_qc(sce.all)<br>print(dim(sce.all))<br>print(dim(sce.all.filt))<br>setwd(<span>'../'</span>)<br><br><span>###### step3: harmony整合多个单细胞样品 ######</span><br>dir.create(<span>"2-harmony"</span>)<br>getwd()<br>setwd(<span>"2-harmony"</span>)<br><span>source</span>(<span>'../scRNA_scripts/harmony.R'</span>)<br><span># 默认 ScaleData 没有添加"nCount_RNA", "nFeature_RNA"</span><br><span># 默认的</span><br>sce.all.int = run_harmony(sce.all.filt)<br>setwd(<span>'../'</span>)<br><br><span>###### step4: 降维聚类分群和看标记基因库 ######</span><br><span># 原则上分辨率是需要自己肉眼判断，取决于个人经验</span><br><span># 为了省力，我们直接看  0.1和0.8即可</span><br>table(Idents(sce.all.int))<br>table(sce.all.int$seurat_clusters)<br>table(sce.all.int$RNA_snn_res.0.1) <br>table(sce.all.int$RNA_snn_res.0.8) <br><br>getwd()<br>dir.create(<span>'check-by-0.1'</span>)<br>setwd(<span>'check-by-0.1'</span>)<br>sel.clust = <span>"RNA_snn_res.0.1"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br>sp=<span>'human'</span><br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br>dir.create(<span>'check-by-0.8'</span>)<br>setwd(<span>'check-by-0.8'</span>)<br>sel.clust = <span>"RNA_snn_res.0.8"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br>last_markers_to_check<br> <br></code></pre><p data-tool="mdnice编辑器">可以看到，我给大家准备的基因列表主要是针对肿瘤单细胞的第一层次降维聚类分群 ， 是：</p><ul data-tool="mdnice编辑器"><li><section>immune (CD45+,PTPRC),</section></li><li><section>epithelial/cancer (EpCAM+,EPCAM),</section></li><li><section>stromal (CD10+,MME,fibo or CD31+,PECAM1,endo)</section></li></ul><p data-tool="mdnice编辑器">参考我前面介绍过 <a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247488940&amp;idx=1&amp;sn=1cc8a8a74715087939b9721c0881775d&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现08—肿瘤单细胞数据第一次分群通用规则</a>，这3大单细胞亚群构成了肿瘤免疫微环境的复杂。绝大部分文章都是抓住免疫细胞亚群进行细分，包括淋巴系（T,B,NK细胞）和髓系（单核，树突，巨噬，粒细胞）的两大类作为第二次细分亚群。但是也有不少文章是抓住stromal 里面的fibo 和endo进行细分，并且编造生物学故事的。</p><p data-tool="mdnice编辑器">如果仅仅是使用我们的前面的 scRNA_scripts/check-all-markers.R ，会发现很多细胞亚群其实没办法给名字。而这个文章里面的各个单细胞亚群给出来了基因列表，所以需要我们自己肉眼看看这些基因：</p><p><img data-galleryid="" data-ratio="0.4222222222222222" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyQr8BdGAhNyoC6JsX1Adz5KtCyZ5x9pWO6To9ic3eiajQas63nAuJkhZVmvnicI2eMJeUCXSAgW0gibQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyQr8BdGAhNyoC6JsX1Adz5KtCyZ5x9pWO6To9ic3eiajQas63nAuJkhZVmvnicI2eMJeUCXSAgW0gibQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>基因列表</figcaption></figure><p data-tool="mdnice编辑器">所以最后我们的降维聚类分群和命名后的图是：</p><p><img data-galleryid="" data-ratio="1.137037037037037" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyQr8BdGAhNyoC6JsX1Adz5WVgSacRJaaTVbpwRTcicVZMVWmL66OcVa7kLDZ12sseQ8yBlibkImLDw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyQr8BdGAhNyoC6JsX1Adz5WVgSacRJaaTVbpwRTcicVZMVWmL66OcVa7kLDZ12sseQ8yBlibkImLDw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>降维聚类分群和命名</figcaption></figure><p data-tool="mdnice编辑器">看起来跟文章差不多了，感兴趣的也可以自己去读一下原文：《<strong>Anatomically distinct fibroblast subsets determine skin autoimmune patterns</strong>》，当然了降维聚类分群和命名仅仅是单细胞转录组数据分析的万里长征第一步而已。</p><p data-tool="mdnice编辑器"><strong>首先上面的单细胞亚群都是可以细分后探索的，比如 Keratinocyte 就起码有KRT1和KRT14的两个截然不同亚群，淋巴系里面也有少量的b细胞和plasma，髓系也可以细分。</strong></p><h3 data-tool="mdnice编辑器"><span></span>单细胞春节福利继续<span></span></h3><p data-tool="mdnice编辑器">如果你有自己的单细胞转录组数据需要处理，可以直接参加我们的活动 ，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519474&amp;idx=1&amp;sn=a07f2684e4bebfc5307add35cfbf82a2&amp;scene=21#wechat_redirect" data-linktype="2">春节期间单细胞转录组数据分析全免费</a>，如果你感兴趣我们处理过的数据集，可以直接填表留下联系方式即可，我们会在元宵节之前统一发放全部的代码和数据给大家的：</p><p><img data-galleryid="" data-ratio="1.1717171717171717" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyQr8BdGAhNyoC6JsX1Adz5cNOEMLwqyYLg2yEFoG9EhZbst22ordDweoSa1ErNa5vouvVDL0Ixbw/640?wx_fmt=png" data-type="png" data-w="594" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyQr8BdGAhNyoC6JsX1Adz5cNOEMLwqyYLg2yEFoG9EhZbst22ordDweoSa1ErNa5vouvVDL0Ixbw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>元宵节之前统一发放全部的代码和数据</figcaption></figure></section><h4 data-tool="mdnice编辑器"><span>文末友情宣传</span></h4><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519543&amp;idx=1&amp;sn=b9290a55d50c038bcc6e97d53a88b1c5&amp;chksm=9b4bcd8cac3c449aaa16dbf518578e9c7a4e67fe4122ae7c4fb115ddb2a843a976fa3462dcea&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买‍一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li></ul><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/pOK7DdvzsU1vWWM8Cz-b-g",target="_blank" rel="noopener noreferrer">原文链接</a>
