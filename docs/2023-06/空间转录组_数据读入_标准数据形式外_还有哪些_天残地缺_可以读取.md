---
title: "空间转录组|数据读入，标准数据形式外，还有哪些"天残地缺"可以读取"
date: 2023-06-20T04:54:26Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
空间转录组|数据读入，标准数据形式外，还有哪些"天残地缺"可以读取 by 生信随笔
------
<div><p><span><strong><span>空间转录组测序</span></strong><span>可以同时获得细胞的空间位置信息和基因表达数据，虽然囿于当前单个spot的精度问题，但是在组织细胞功能，肿瘤生物学、发育过程等需要空间位置的研究领域仍然可以提供很多非常有价值的东西。</span></span></p><p><span>本节会在spaceranger处理fastq，Seurat处理标准数据（h5 + spatial文件夹）外，额外提供以下几种情况如何处理</span></p><p><span>（1）</span><span><strong>raw/filtered_feature_bc_matrix 的三个文件 + spatial 文件夹</strong></span></p><p><span>（2）矩阵文件 + <span>spatial 文件夹 </span></span></p><p><span>（3）spatial文件夹如果</span><span><strong><span>只提供了</span><span>tissue_hires_image.png</span></strong></span><span></span></p><p><span>（4）未提供spatial文件夹，只提供了位置信息</span></p><p><span><span>数据来源于2022年CELL 文章 A human fetal lung cell atlas uncovers proximal-distal gradients of differentiation and key regulators of epithelial fates 中的空转Fastq数据（</span><span>E-MTAB-11265</span><span>）。</span></span></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><p><span>一 fastq数据，spaceranger分析</span><span> </span></p></section></section></section></section></section><p><br></p><p><span>如若初始是fastq数据，首先在10X官网（</span><span>https://www.10xgenomics.com/cn/support/software/space-ranger/downloads</span><span>）下载spaceranger软件然后安装，仍然是使用<strong>count</strong>参数处理fastq 数据即可。</span><span><strong></strong></span></p><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span>/path/spaceranger count --id=6332STDY10289523 \</span></code><code><span>--transcriptome=/path/refdata-gex-GRCh38-2020-A/ \</span></code><code><span>--fastqs=/path/ST_data/ \</span></code><code><span>--sample=6332STDY10289523 \</span></code><code><span>--image=/path/V10S24-031_D1.jpg \</span></code><code><span>--slide=V10S24-031 \</span></code><code><span>--area=D1</span></code></pre></section><p><span>注意slide 和 area的参数 ，可能来源于<strong>图片的命名</strong>（本示例中的V10S24-031_D1.jpg） ，可能来自于<strong>method 或者code的链接</strong>中。</span></p><p><span>如果没有slide信息的话，可以设置为<strong><span>--unknown-slide</span></strong></span></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><p><span>二 Seurat 数据读入</span><span> </span></p></section></section></section></section></section><p><br></p><p><span><span>上面</span><span>spaceranger count</span><span>后会得到outs文件夹，里面有网页版的质控报告，loupe文件，spatial文件夹 和 h5文件等，用于后续分析。</span></span></p><h3><span><strong>1， Load10X_Spatial 最优输入</strong></span><span></span></h3><p><span>outs文件夹中的 filtered_feature_bc_matrix.h5 + spatial文件夹 ，注意这两部分结果需要在同一级。</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="makefile"><code><span>library(Seurat)</span></code><code><span>library(hdf5r)</span></code><code><span>spe = Load10X_Spatial(data.dir = <span>"./outs/"</span>,</span></code><code><span>                            filename = <span>"filtered_feature_bc_matrix.h5"</span>,</span></code><code><span>                            assay = <span>"Spatial"</span>, </span></code><code><span>                            slice = <span>"Lung"</span>)</span></code><code><span>head(spe@meta.data,2)</span></code><code><span><span>#                      orig.ident nCount_Spatial nFeature_Spatial</span></span></code><code><span><span>#AAACAAGTATCTCCCA-1 SeuratProject           7232             2774</span></span></code><code><span><span>#AAACACCAATAACTGC-1 SeuratProject          20915             6318</span></span></code><code><span><br></span></code><code><span><span>#空转的话，就是SpatialFeaturePlot ，相较于单细胞转录组的FeaturePlot</span></span></code><code><span>SpatialFeaturePlot(spe, features = <span>"nFeature_Spatial"</span>)</span></code><code><span><br></span></code></pre></section><p><span>额，报错了，如下：</span></p><blockquote data-type="2" data-url="" data-author-name="" data-content-utf8-length="58" data-source-title=""><section><p><span>Error in FUN(left, right) : non-numeric argument to binary operator</span></p></section></blockquote><p><span>推荐google搜索，解决方法如下（将<span>spe@images$Lung@coordinates的信息改为</span>）：</span></p><section><ul><li><li><li></ul><pre data-lang="ruby"><code><span><span>for</span> (i <span>in</span> colnames((spe@images$Lung@coordinates))) {</span></code><code><span>  spe@images$Lung@coordinates[[i]] &lt;- as.integer(spe@images$Lung@coordinates[[i]])</span></code><code><span>}</span></code></pre></section><p><span>再次尝试，问题解决，</span><span><strong><span>注意如果你的数据没有该报错可以不用<span>as.integer </span></span>这部分！！！</strong></span></p><section><ul><li><li><li><li><li></ul><pre data-lang="properties"><code><span><span>SpatialFeaturePlot(spe,</span> <span>features = "nFeature_Spatial")</span></span></code><code><span><br></span></code><code><span><span>p0</span> <span>&lt;- SpatialDimPlot(spe,alpha = 0)</span></span></code><code><span><span>p1</span> <span>&lt;- SpatialDimPlot(spe,alpha = 1)</span></span></code><code><span><span>p0 + p1</span></span></code></pre></section><p><img data-galleryid="" data-ratio="0.4009259259259259" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjDP0sY1HPr8mhhFf5vfKUTBlcaq6jDcE9KZ6uNdkpxs7vPgFeTXFr1BVqUMd6bZ5H6AeyGdyDdIGw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjDP0sY1HPr8mhhFf5vfKUTBlcaq6jDcE9KZ6uNdkpxs7vPgFeTXFr1BVqUMd6bZ5H6AeyGdyDdIGw/640?wx_fmt=png"></p><p><span><strong>非常建议通过 str(spe)查看一下空转的数据结构 ，有助于后续更好的分析！</strong></span></p><h3></h3><h3><strong><span>2，10X的三个文件 + spatial文件夹</span></strong></h3><p>默认的<span>Load10X_Spatial</span>函数不能像单细胞转录组一样直接读取3个文件，通过<span>View(Load10X_Spatial)</span> 发现该函数写的比较死。其实我们只需要提取前面读取单细胞数据部分，使用<span>Read10X</span>即可</p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="ruby"><code><span>spe2 = Read10X(<span>"./outs/filtered_feature_bc_matrix/"</span>)</span></code><code><span>image2 &lt;- Read10X_Image(image.dir = file.path(<span>"./outs/"</span>, </span></code><code><span>                                              <span>"spatial"</span>), filter.matrix = TRUE)</span></code><code><span>spe2 &lt;- CreateSeuratObject(counts = spe2, assay = <span>"Spatial"</span>)</span></code><code><span><br></span></code><code><span>image2 &lt;- image2[Cells(x = spe2)]</span></code><code><span>DefaultAssay(spe2 = image2) &lt;- <span>"Spatial"</span></span></code><code><span>spe2[[<span>"slice1"</span>]] &lt;- image2</span></code><code><span><span>#没有报错，无需转化</span></span></code><code><span><span>for</span> (i <span>in</span> colnames((spe2@images$slice1@coordinates))) {</span></code><code><span>  spe2@images$slice1@coordinates[[i]] &lt;- as.integer(spe2@images$slice1@coordinates[[i]])</span></code><code><span>}</span></code><code><span><br></span></code><code><span>SpatialFeaturePlot(spe2, features = <span>"nFeature_Spatial"</span>)</span></code></pre></section><p>而<span>Load10X_Spatial</span>函数中的<span>spe2[[</span><span>"slice1"</span><span>]] </span>部分，也就是为什么在默认情况下image的slide 名字是slice1 ，所以如果多样本分析的时候<strong><span>记得改名字</span></strong>。</p><h3><strong><span>3，读取rds文件</span></strong></h3><p>部分文献会提供rds文件，但是因为版本不一致常会遇到问题</p><section><ul><li><li><li></ul><pre data-lang="powershell"><code><span>spe3 &lt;- readRDS(<span>"./STData/P1N_Spatial.rds"</span>)</span></code><code><span><br></span></code><code><span>SpatialFeaturePlot(spe3 , features = <span>"MS4A1"</span>)</span></code></pre></section><p><img data-ratio="0.14711033274956217" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjDP0sY1HPr8mhhFf5vfKUTB4FnkVzRCPaq7r8dbQKuukesHWcsHxicpp6AKPBe90ibyLV4ic5OTUpV6A/640?wx_fmt=png" data-type="png" data-w="571" width="456.8" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjDP0sY1HPr8mhhFf5vfKUTB4FnkVzRCPaq7r8dbQKuukesHWcsHxicpp6AKPBe90ibyLV4ic5OTUpV6A/640?wx_fmt=png"></p><p><span>google检索解决方案：</span><span>https://github.com/satijalab/seurat/issues/6312 ，可以<span>UpdateSeuratObject 一下</span></span></p><section><ul><li><li></ul><pre data-lang="javascript"><code><span>spe3&lt;- UpdateSeuratObject(spe3)</span></code><code><span>SpatialFeaturePlot(spe3, features = <span>"MS4A1"</span>)</span></code></pre></section><p><img data-ratio="1.2558823529411764" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjDP0sY1HPr8mhhFf5vfKUTBuBvictUDRXtn0eiavqBhSmYaLH7eYSP3v9IYrfN1ceB5JOgMSdAgiaOZg/640?wx_fmt=png" data-type="png" data-w="340" width="272" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjDP0sY1HPr8mhhFf5vfKUTBuBvictUDRXtn0eiavqBhSmYaLH7eYSP3v9IYrfN1ceB5JOgMSdAgiaOZg/640?wx_fmt=png"></p><h3><strong><span>4，只提供 tissue_hires_image.png</span></strong></h3><p>spatial文件夹中会有tissue_hires_image.png和 tissue_lowres_image.png 两种tiff图，而<span>Read10X_Image 函数中默认读取<span> </span><span>tissue_lowres_image.png图，</span></span></p><p><span><span>因此如果（1）文献<span><strong>只提供了<span>tissue_hires_image.png </span></strong></span><span>或者（2）想绘制<span><strong>高清一些</strong></span>的图，可以使用如下的方法</span></span></span></p><p><span><strong><span>4.1 尚无<span>Seurat object </span></span></strong></span></p><p>文献只提供hires图时候直接使用<span>Load10X_Spatial</span>会报错，可以先指定使用<span>tissue_</span><span>hi</span><span>re</span><span>s_image</span>图片 ，如下<br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="ruby"><code><span><br></span></code><code><span>img = Read10X_Image(<span>"./outs/spatial/"</span>, </span></code><code><span>                    image.name = <span>"tissue_hires_image.png"</span>)</span></code><code><span>spe4 = Load10X_Spatial(<span>"./outs/"</span>, image = img)</span></code><code><span>spe4@images$slice1@scale.factors$lowres = spe4@images$slice1@scale.factors$hires</span></code><code><span><span>#没有报错，无需转化</span></span></code><code><span><span>for</span> (i <span>in</span> colnames((spe4@images$slice1@coordinates))) {</span></code><code><span>  spe4@images$slice1@coordinates[[i]] &lt;- as.integer(spe4@images$slice1@coordinates[[i]])</span></code><code><span>}</span></code><code><span><span>#对比一下两张图的差异</span></span></code><code><span>p1 &lt;- SpatialFeaturePlot(spe2, features = <span>"nFeature_Spatial"</span>)</span></code><code><span>p2 &lt;- SpatialFeaturePlot(spe4, features = <span>"nFeature_Spatial"</span>)</span></code><code><span>p1 + p2</span></code></pre></section><p><img data-galleryid="" data-ratio="0.5527777777777778" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjDP0sY1HPr8mhhFf5vfKUTBDTmEucDgfbUb4eiauYIbg5k6GQ6c0gvESQauuOURDsPwK8QeZRmM75Q/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Y21ubvXhTjDP0sY1HPr8mhhFf5vfKUTBDTmEucDgfbUb4eiauYIbg5k6GQ6c0gvESQauuOURDsPwK8QeZRmM75Q/640?wx_fmt=png"></p><p><strong>其他的图可能会差异更明显。</strong><br></p><p><span><strong><span><span><span>4.2  已有<span>Seurat object</span></span></span></span></strong></span></p><p><span>如果前面已经创建了seurat object ，不想从头分析的话 也可以直接替换的，如下先重新定义一个spe5</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="ini"><code><span>spe5 &lt;- spe2</span></code><code><span><br></span></code><code><span><span>lowres</span> = spe5@images<span>$slice1</span></span></code><code><span><span>hires</span> = Read10X_Image(<span>"./outs/spatial/"</span>, </span></code><code><span>                      image.name = "tissue_hires_image.png")</span></code><code><span><br></span></code><code><span>hires@scale.factors$lowres = hires@scale.factors$hires</span></code><code><span><span>#Set the assay and key to the same as the lowres (I'm not sure if this is necessary or not).</span></span></code><code><span>hires@assay = lowres@assay</span></code><code><span>hires@key = lowres@key</span></code><code><span><span>#Finally, add the image into the object and everything should be good!</span></span></code><code><span>spe5@images$slice1 = hires</span></code><code><span><span>#没有报错，无需转化</span></span></code><code><span>for (i in colnames((spe5@images$slice1@coordinates))) {</span></code><code><span>  spe5@images$slice1@coordinates<span>[[i]]</span> &lt;- as.integer(spe5@images$slice1@coordinates<span>[[i]]</span>)</span></code><code><span>}</span></code><code><span><br></span></code><code><span>p1 &lt;- SpatialFeaturePlot(spe2, features = "nFeature_Spatial")</span></code><code><span>p2 &lt;- SpatialFeaturePlot(spe5, features = "nFeature_Spatial")</span></code><code><span>p1 + p2</span></code></pre></section><p><span>该</span><span>解答来源于https://github.com/satijalab/seurat/discussions/4833</span><br></p><h3><strong><span>5，只提供位置信息</span></strong></h3><p>没有提供spatial文件夹，只提供了空转spot的位置信息，可以按照单细胞的方式读取，但是无法绘制如上的空转切片为背景的图。</p><p>以上是总结的一些空转数据的读入方式，请查收！<br></p><section data-style-type="7" data-tools="新媒体排版" data-id="9190"><p><span><span data-txtless="spin" data-txtlessp="120">◆ </span><span>◆ </span><span data-txtless="spin" data-txtlessp="-120">◆  <span data-txtless="spin" data-txtlessp="120">◆ </span><span>◆</span></span></span></p></section><p cid="n94" mdtype="paragraph"><span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650398215&amp;idx=1&amp;sn=730225fb5ba3a51ceb8df0a531632515&amp;chksm=f01cbce7c76b35f1bebbf327d78a51d859770a46ae1329d362e3b705c4f8765ee2dc461d24dc&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">精心整理（含图PLUS版）|R语言生信分析，可视化</a>（R统计，ggplot2绘图，生信图形可视化汇总）</span></p><p cid="n94" mdtype="paragraph"><span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650400742&amp;idx=1&amp;sn=dca078db8e6c0c742264dcb0bf56a8e2&amp;chksm=f01c8506c76b0c107782efb89c5f5c0e244a9d664c15ea2b9d16dc70067b7249bd0e7ea9f9ae&amp;scene=21#wechat_redirect" textvalue="RNAseq纯生信挖掘思路分享？不，主要是送你代码！（建议收藏）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">RNAseq纯生信挖掘思路分享？不，主要是送你代码！（建议收藏）</a></span></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/1ZoH15-EXs049KhDVxsELw",target="_blank" rel="noopener noreferrer">原文链接</a>
