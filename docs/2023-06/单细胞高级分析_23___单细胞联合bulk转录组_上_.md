---
title: "单细胞高级分析(23): 单细胞联合bulk转录组（上）"
date: 2023-06-06T10:15:24Z
draft: ["false"]
tags: [
  "fetched",
  "TOP生物信息"
]
categories: ["Acdemic"]
---
单细胞高级分析(23): 单细胞联合bulk转录组（上） by TOP生物信息
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section>微信改版，文章将不再以大图展示</section><section>我们可能会因此<span><strong>错过</strong></span></section><section>将TOP生物信息<span><strong>设为星标</strong></span>，就能继续收到<span><strong>大图推送</strong></span></section><p><img data-ratio="0.6265625" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_gif/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXgZgSLSuFdufo7wLSPYYI7QvU937Kp18LIVTWNzwB5RTFD4WQG2423w/640?wx_fmt=gif" data-type="gif" data-w="640" src="https://mmbiz.qpic.cn/mmbiz_gif/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXgZgSLSuFdufo7wLSPYYI7QvU937Kp18LIVTWNzwB5RTFD4WQG2423w/640?wx_fmt=gif"></p><p data-tool="mdnice编辑器"><br></p><p data-tool="mdnice编辑器"><span>目前单细胞联合bulk转录组的分析思路有很多，今天介绍其中用得最多的</span><code>套路</code><span>，之所以说它是套路，是因为很多数据挖掘为主的生信文章都喜欢用这种分析思路。</span><br></p><p data-tool="mdnice编辑器">大致思路就是：</p><ol data-tool="mdnice编辑器"><li><section>找到合适的公开的单细胞数据集，按照scRNA-seq常规流程分析一遍，降维聚类注释。需要单细胞数据的目的：单细胞分析能精确得到不同celltype的表达特征，而这层信息正是第二步所参考的；</section></li><li><section>下载<code>TCGA</code>某种/些癌种的bulk转录组表达数据，借助<code>细胞类型占比估计软件</code>估计bulk肿瘤样本中各种celltype的占比；</section></li><li><section>将celltype的占比和患者<code>临床表型</code>（最常见的就是生存时间）联系起来，得出celltype与表型相关等等结论。</section></li></ol><p data-tool="mdnice编辑器">而说到<code>细胞类型占比估计软件</code>就不得不提<span>CIBERSORT</span>（最新版叫<code>CIBERSORTx</code>，网址https://cibersortx.stanford.edu/），作者Aaron Newman是计算生物领域的大牛，其团队还开发了单细胞、空间组学相关工具，如<code>CytoTRACE</code>、<code>CytoSPACE</code></p><p data-tool="mdnice编辑器">接下来会以<code>CIBERSORTx</code>为例，走完上述的<code>step1 2 3</code>。</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器"><br></p><ul><li><p>1.准备单细胞数据集</p></li><li><p>2. 基于CIBERSORTx的细胞占比估计</p></li><ul><li><p>2.1 如何构建signature matrix</p></li><li><p>2.2 推断TCGA样本的细胞类型占比</p></li></ul><li><p>3. 联系生存预后</p></li><li><p>题外话</p></li><li><p>参考<span></span></p></li></ul><p data-tool="mdnice编辑器">因为这个专题的篇幅很长，我分了上下两篇。第一篇讲到<code>2.1 如何构建signature matrix</code>，第二篇讲余下部分。</p><p>如何<span>获取这个专题所</span><span>有的代码和示例数据？</span>公众号后台<span><strong>回复</strong><strong>8位日期</strong></span>可知：<strong><span>20230602</span></strong></p><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span><span>1.准备单细胞数据集</span></h2><p data-tool="mdnice编辑器">这次的dataset仍然来自那篇我在B站讲过很多次的<code>鼻咽癌单细胞</code>文章（Single-cell transcriptomics reveals regulators underlying immune cell diversity and immune subtypes associated with prognosis in nasopharyngeal carcinoma）。</p><p data-tool="mdnice编辑器"><br><img data-ratio="0.47129629629629627" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXyUF8qMicQoEC55s7UNF521wZf79AO64gogvug6k9EIDaNm8FR9CVUww/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXyUF8qMicQoEC55s7UNF521wZf79AO64gogvug6k9EIDaNm8FR9CVUww/640?wx_fmt=png"><span>跟着Cell Research学单细胞分析系列视频（UP主：TOP菌）</span></p><p data-tool="mdnice编辑器">早在2021年，我讲<a href="https://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247484516&amp;idx=1&amp;sn=dd3d5e2fdbaf8b01e77490de062b2ced&amp;chksm=c2517f73f526f6656c3cbc7f6bc1b274b2772059a600b798b6fa683a17416e2f7d05201002b8&amp;scene=21#wechat_redirect" data-linktype="2">单细胞基础绘图</a>的时候，就把这篇文章的数据从原始<code>fastq</code>文件重新跑了一遍。<img data-ratio="0.8303886925795053" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXZaruvzDFMXdWezPB3s4MmDL7PeIl10fNtSjClJ6Tibzp5b0fZxVdXpQ/640?wx_fmt=png" data-type="png" data-w="566" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXZaruvzDFMXdWezPB3s4MmDL7PeIl10fNtSjClJ6Tibzp5b0fZxVdXpQ/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">考虑到这套数据的特点：</p><ul data-tool="mdnice编辑器"><li><section>成纤维细胞、内皮细胞等基质细胞非常少；</section></li><li><section>肿瘤细胞由于病人间/内异质性，很难存在共有的表达特征（不同于基质细胞，基质细胞会有<code>足够</code>的<code>共有</code>的表达谱）。</section></li></ul><p data-tool="mdnice编辑器">因此，在演示时删掉<code>非免疫细胞</code>，下文的讨论集中在<code>免疫细胞</code>的占比估计（实际分析中可以灵活处理）。</p><p data-tool="mdnice编辑器">删掉<code>细胞数很少</code>的6个样本，剩余10个样本。最终的图如下：<img data-ratio="0.727427597955707" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXPRTQTrlQMKFF6CRwEYKuCnGkqdic8ic2S4anULMRMRyWtXeEoADIeJGA/640?wx_fmt=png" data-type="png" data-w="587" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXPRTQTrlQMKFF6CRwEYKuCnGkqdic8ic2S4anULMRMRyWtXeEoADIeJGA/640?wx_fmt=png"></p><h2 data-tool="mdnice编辑器"><span></span><span>2. 基于CIBERSORTx的细胞占比估计</span></h2><p data-tool="mdnice编辑器">CIBERSORTx主要涉及的是step2：细胞类型占比估计。</p><p data-tool="mdnice编辑器">我不推荐用R版本的CIBERSORT（是一个叫CIBERSORT.R的代码文件，GitHub能搜到很多包都调用了这个文件），原因是代码非常旧，我在一些包中看到的这个CIBERSORT.R文件甚至是2016年的。</p><pre data-tool="mdnice编辑器"><span></span><code><span># CIBERSORT R script v1.04 (last updated 10-24-2016)</span><br></code></pre><p data-tool="mdnice编辑器">另一方面，CIBERSORTx的网站足够好用。</p><p data-tool="mdnice编辑器"><span></span></p><p data-tool="mdnice编辑器"><span>如果你无法登录CIBERSORTx官网（https://cibersortx.stanford.edu/），可以试试借助魔法。以下链接就是我用的魔法：</span><br></p><p data-tool="mdnice编辑器"><span></span></p><pre data-tool="mdnice编辑器"><code>https://tagss01.pro<span>#/register?invite=0LZOXWz7</span><strong><span></span></strong></code></pre><h3 data-tool="mdnice编辑器"><span></span>2.1 如何构建signature matrix<span></span></h3><p data-tool="mdnice编辑器">下图是step1+step2的流程图，最左边的<code>step1准备单细胞数据集</code>我们已经做完了，剩下的都是<code>step2</code>。我们可以看到<code>构建细胞类型参考矩阵</code>这一环节有两种做法：自己找marker构建；利用cibersortx网页构建。<img data-ratio="0.3937007874015748" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXG9WxZKHLlhbmlMNk1icibgzXc25Lfhib2mfPHlXEU5rc6ybMKv1tb3hrg/640?wx_fmt=png" data-type="png" data-w="1016" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXG9WxZKHLlhbmlMNk1icibgzXc25Lfhib2mfPHlXEU5rc6ybMKv1tb3hrg/640?wx_fmt=png">在下文我会比较两种构建signature matrix的做法，并给出我所推荐的做法（过程有点长，不关心这个问题的话，你可以直接跳到2.1节的结尾、2.2节的开头看结论）。</p><blockquote data-tool="mdnice编辑器"><p>为了比较两种做法的好坏，我们开启<code>上帝视角</code>，做一个<code>已知正确答案</code>的模拟测试：我们将step1中涉及到的10个样本的单细胞数据做成pesudobulk样本。具体做法是把每个样本中所有细胞在各个基因上的umi加和，得到20000基因10列的新矩阵。借助两种构建参考矩阵方法得到的两个signature matrix（一次用一个），把新的伪bulk样本当作常规的bulk去做细胞占比估计。由于真实的细胞占比是知道的，因此就能比较两种方法的优劣。</p></blockquote><h4 data-tool="mdnice编辑器"><span></span>2.1.1 <span>CIBERSORTx构建</span><span></span></h4><p data-tool="mdnice编辑器">我们需要从单细胞数据集对应的<code>Seurat对象</code>导出表达谱矩阵（single cell reference sample file，后续会上传CIBERSORTx网页），该文件的格式需要满足一些条件：</p><ol data-tool="mdnice编辑器"><li><section>数值不能取对数。</section></li><li><section>以制表符分隔的txt文件，没有双引号和缺失值NA。</section></li><li><section>第1列基因；第1行是细胞类型label。相同类型的细胞应具有相同的label；删除未定义的细胞。</section></li><li><section>CIBERSORTx会自动对输入数据进行标准化，使得每个样本内部的数值之和相同。如果提供基因长度矫正的表达矩阵（例如RPKM），则signature matrix将以TPM（每百万转录本）表示。如果提供count矩阵，则signature matrix将以CPM（每百万计数）表示。<code>无论输入什么，请确保signature matrix和后续bulk转录组矩阵都尽可能使用相同的标准化方式</code>。</section></li></ol><pre data-tool="mdnice编辑器"><span></span><code>第4点可能不好理解，稍微解释一下：<br>第4点提到的RPKM,TPM,CPM是几种常见的bulk转录组标准化方式。而且<br>RPKM/sum(RPKM)*10^6可以转换为TPM；<br>count/sum(count)*10^6可以转换为CPM<br></code></pre><p data-tool="mdnice编辑器">因为在这次演示中，后续的实际TCGA样本得到的是TPM矩阵，所以此处我们仍然希望得到TPM形式的signature matrix。</p><p data-tool="mdnice编辑器">按照第4点，我们需要RPKM形式的单细胞表达矩阵。那10X单细胞数据能不能得到类似的矩阵？答案是可以，参考我之前写的<a href="https://mp.weixin.qq.com/s?__biz=MzkzMzE5NTM4NA==&amp;mid=2247485294&amp;idx=1&amp;sn=6efb6ca4998a4ae293d80d746303164b&amp;scene=21#wechat_redirect" data-linktype="2">答读者问(6)：单细胞TPM矩阵如何分析？</a></p><blockquote data-tool="mdnice编辑器"><p>说白了就是，10X单细胞数据不需要对长度矫正，所以CP10K，CPM, TPM, RPKM这几个标准化方法<code>意义</code>是相同的，只是<code>倍数</code>不同。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>library(Seurat)<br>library(tidyverse)<br><br>allseu = readRDS(<span>"10个样本的免疫细胞.rds"</span>)<br><br><span>### single cell reference sample file</span><br>mat.RPKM.like=as.data.frame(allseu[[<span>"RNA"</span>]]@counts[,sample(1:26931,5000)]) %&gt;% <br>  apply(2,<span>function</span>(x){x/sum(x) * (10^9)})<br>mat.RPKM.like=mat.RPKM.like[rowSums(mat.RPKM.like) &gt; 0,]<br>allanno = allseu@meta.data[,c(<span>"CB"</span>,<span>"newtype"</span>)]<br>smallanno = allanno[colnames(mat.RPKM.like),]<br>colnames(mat.RPKM.like) = smallanno<span>$newtype</span><br>write.table(mat.RPKM.like,file = <span>"mat.RPKM.like.txt"</span>,quote = F,sep = <span>"\t"</span>,row.names = T,col.names = T)<br></code></pre><p data-tool="mdnice编辑器">这个文本文件的左上角没有"Gene"，也就是第一列的列名，用电脑文本编辑器加上即可。最终的单细胞表达谱矩阵是这样的：<img data-ratio="0.44620611551528877" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXHZQyuuMsjhZic0cznt2qIRYpx6Vvls7lEtRrX1CFPiaYuYFz61lJDDmw/640?wx_fmt=png" data-type="png" data-w="883" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXHZQyuuMsjhZic0cznt2qIRYpx6Vvls7lEtRrX1CFPiaYuYFz61lJDDmw/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">随后导入CIBERSORTx生成signature matrix</p><ol data-tool="mdnice编辑器"><li><section><p>上传数据<img data-ratio="0.4280639431616341" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jX98iaCPywicS9EKSfYLt8TaTBibPficqVwLUTn8POYhiaZ7ZiaVXicD2pCod1w/640?wx_fmt=png" data-type="png" data-w="563" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jX98iaCPywicS9EKSfYLt8TaTBibPficqVwLUTn8POYhiaZ7ZiaVXicD2pCod1w/640?wx_fmt=png">之后会进入新的界面（https://cibersortx.stanford.edu/upload.php）<img data-ratio="0.30092592592592593" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXdcc0XwkMYFVs1LZSwDiahSw3EhuUzRJtdkap4gYsBULlzFEHr5hiaLDA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXdcc0XwkMYFVs1LZSwDiahSw3EhuUzRJtdkap4gYsBULlzFEHr5hiaLDA/640?wx_fmt=png"></p></section></li><li><section><p>网页生成signature matrix</p></section></li></ol><p data-tool="mdnice编辑器">进入CIBERSORTx的分析界面（https://cibersortx.stanford.edu/runcibersortx.php）</p><figure data-tool="mdnice编辑器"><img data-ratio="0.7398148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXnkibn8o6Aiayt63ibHW2XcAYNVicknxJRAT14H9mwpia5vYWTpSKuIXj2Vg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXnkibn8o6Aiayt63ibHW2XcAYNVicknxJRAT14H9mwpia5vYWTpSKuIXj2Vg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">等待几分钟，结果出来后，下载即可</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5111111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jX33icGH1MKZR8kD7aiajDQhkOgIVMglDsQMj9IP5VGibsFBW2w9KfAibibmw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jX33icGH1MKZR8kD7aiajDQhkOgIVMglDsQMj9IP5VGibsFBW2w9KfAibibmw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">下载后的signature matrix长这样</p><figure data-tool="mdnice编辑器"><img data-ratio="0.2712962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXRLI1zeMSYic7F9EWEmp9RazicJXs7Bcu9qZ8lPoKD40CicaEic9UicK6YoQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXRLI1zeMSYic7F9EWEmp9RazicJXs7Bcu9qZ8lPoKD40CicaEic9UicK6YoQ/640?wx_fmt=png"></figure><h4 data-tool="mdnice编辑器"><span></span>2.1.2 <span>自己构建</span><span></span></h4><p data-tool="mdnice编辑器">如果是自己根据marker来构建，就省事很多。</p><pre data-tool="mdnice编辑器"><span></span><code>library(Seurat)<br>library(tidyverse)<br><br>allseu = readRDS(<span>"10个样本的免疫细胞.rds"</span>)<br><br><span>#更改默认的细胞identity</span><br>Idents(allseu) = <span>"newtype"</span><br>ref_marker=FindAllMarkers(allseu,logfc.threshold = 0.8,min.pct = 0.1,only.pos = T,test.use = <span>"wilcox"</span>)<br>ref_marker=ref_marker%&gt;%filter(p_val_adj &lt; 0.01)<br>ref_marker<span>$d</span>=ref_marker<span>$pct</span>.1 - ref_marker<span>$pct</span>.2<br><span>#ref_marker %&gt;% ggplot(aes(x=d,fill = cluster))+geom_density()+facet_grid(cluster~.)+geom_vline(xintercept = 0.1)</span><br><span>#借助这张图选择一个合适的阈值</span><br>ref_marker=ref_marker%&gt;%filter(d &gt; 0.1)<br>ref_marker=ref_marker%&gt;%arrange(cluster,desc(avg_log2FC))<br>ref_marker=as.data.frame(ref_marker)<br><br>used_gene=sort(unique(ref_marker<span>$gene</span>))<br>sig_matrix=AverageExpression(allseu, slot = <span>'data'</span> ,verbose = FALSE,features = used_gene)<br>sig_matrix=sig_matrix<span>$RNA</span> * 100<br><span>#这里要乘以100是因为seurat的scale.factor是10000，而TPM/CPM的定义是1百万，为了保持一致这里再乘以100</span><br>sig_matrix=as.data.frame(sig_matrix)<br>write.table(sig_matrix,file = <span>"ref_sig_by_DEG.txt"</span>,quote = F,sep = <span>"\t"</span>,row.names = T,col.names = T)<br></code></pre><p data-tool="mdnice编辑器">结果文件补上第一列的列名之后就是这样的：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.39658848614072495" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXNOOuGrg5joIPlQzI7o2kThiaHiaQ2dfDibUfsXKYO2jV23SwjXo7vnTmg/640?wx_fmt=png" data-type="png" data-w="938" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXNOOuGrg5joIPlQzI7o2kThiaHiaQ2dfDibUfsXKYO2jV23SwjXo7vnTmg/640?wx_fmt=png"></figure><h4 data-tool="mdnice编辑器"><span></span>2.1.3 <span>哪种方法好</span><span></span></h4><p data-tool="mdnice编辑器">我们先构建pesudobulk样本，同时统计每个样本真实的细胞类型占比</p><pre data-tool="mdnice编辑器"><span></span><code>library(Seurat)<br>library(tidyverse)<br><br>allseu = readRDS(<span>"10个样本的免疫细胞.rds"</span>)<br><br><span>### 真实占比</span><br>ground_truth = prop.table(table(allseu@meta.data<span>$newtype</span>,allseu@meta.data<span>$sample</span>),margin = 2) %&gt;% as.data.frame()<br>colnames(ground_truth) = c(<span>"newtype"</span>,<span>"sample"</span>,<span>"ratio"</span>)<br><br><span>### 构建pesudobulk样本</span><br>bulkmat = data.frame()<br><span>for</span> (si <span>in</span> unique(allseu@meta.data<span>$sample</span>)) {<br>  onesample = allseu@meta.data[allseu@meta.data<span>$sample</span> == si,<span>"CB"</span>]<br>  onemat = allseu[[<span>"RNA"</span>]]@counts[,onesample]<br>  onemat = rowSums(onemat) %&gt;% as.data.frame()<br>  colnames(onemat) = si<br>  <br>  <span>if</span>(<span>which</span>(unique(allseu@meta.data<span>$sample</span>) == si) == 1){<br>    bulkmat = onemat<br>  } <span>else</span> {<br>    bulkmat = cbind(bulkmat,onemat)<br>  }<br>}<br><br>bulkmat = bulkmat[rowSums(bulkmat) &gt; 0,]<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.3090418353576248" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXy9l1P9fGhssLAqEYy5lFSlIvNPJjicAGfZENGHh8UMfQZOzI8AD504g/640?wx_fmt=png" data-type="png" data-w="741" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXy9l1P9fGhssLAqEYy5lFSlIvNPJjicAGfZENGHh8UMfQZOzI8AD504g/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.4505928853754941" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXx5heInQvaBopbhiaSC6vOF9J9ZMfVRv9Syq4Eicw9wfbDTm2UR5IrhNA/640?wx_fmt=png" data-type="png" data-w="506" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXx5heInQvaBopbhiaSC6vOF9J9ZMfVRv9Syq4Eicw9wfbDTm2UR5IrhNA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">随后将count矩阵标准化为TPM</p><blockquote data-tool="mdnice编辑器"><p>由于该pesudobulk数据的特殊性（每一个count数值都不受gene length的影响），在计算TPM的时候，公式里不加gene length。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span>###转换为TPM</span><br>bulkmat.tpm = bulkmat %&gt;% apply(2,<span>function</span>(x){x/sum(x) * (10^6)})<br>write.table(bulkmat.tpm,file = <span>"bulkmat.tpm.txt"</span>,quote = F,sep = <span>"\t"</span>,row.names = T,col.names = T)<br></code></pre><p data-tool="mdnice编辑器">补上基因列名，就是这样的</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5549915397631133" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXH4n7U5goGiaaAxLkicibXTBBC3icfxaic6ertyClphniaEV6kK2BHTbbicsNg/640?wx_fmt=png" data-type="png" data-w="591" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXH4n7U5goGiaaAxLkicibXTBBC3icfxaic6ertyClphniaEV6kK2BHTbbicsNg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">接着我们用CIBERSORTx来推断细胞类型占比（真实占比我们已经知道）</p><ol data-tool="mdnice编辑器"><li><section>上传数据</section></li></ol><p data-tool="mdnice编辑器">上传页面（https://cibersortx.stanford.edu/upload.php）<img data-ratio="0.37407407407407406" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXMIz9MPtukotol6zO5StMn1e4OpUkrfrGG9WtXgeLQBYW2p54RFiameg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXMIz9MPtukotol6zO5StMn1e4OpUkrfrGG9WtXgeLQBYW2p54RFiameg/640?wx_fmt=png">红色是文件类型，要分别选择选择：<img data-ratio="0.6042780748663101" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXOjaPianNDunjXakt5gj4icoliaT8acyyjnibj29yakeZ3pqaqgbdUjvWHQ/640?wx_fmt=png" data-type="png" data-w="374" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXOjaPianNDunjXakt5gj4icoliaT8acyyjnibj29yakeZ3pqaqgbdUjvWHQ/640?wx_fmt=png"></p><ol start="2" data-tool="mdnice编辑器"><li><section>Impute Cell Fractions</section></li></ol><p data-tool="mdnice编辑器">分析页面（https://cibersortx.stanford.edu/runcibersortx.php）</p><p data-tool="mdnice编辑器">做两次：一次用方法1生成的signature matrix，一次用方法2的signature matrix。这里仅演示第一次运行，第二次运行同理。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.8037037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXDibBicMyqHoQq0ibQNBhPeZWQDUu2hdMkYBmM5Dp6qjs13qdg9Rvl61EQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXDibBicMyqHoQq0ibQNBhPeZWQDUu2hdMkYBmM5Dp6qjs13qdg9Rvl61EQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">结果出来后，点击下载即可，用于DIY画图</p><figure data-tool="mdnice编辑器"><img data-ratio="0.8037037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXp0mmDHia0RFMEM0yXVfLjk0lC1mpnrZb5Dhu6Xg7ldGLNHoW2GbEvrA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jXp0mmDHia0RFMEM0yXVfLjk0lC1mpnrZb5Dhu6Xg7ldGLNHoW2GbEvrA/640?wx_fmt=png"></figure><ol start="3" data-tool="mdnice编辑器"><li><section>准确性评估</section></li></ol><p data-tool="mdnice编辑器">将真实结果和推断结果画成散点图就能看出来了，主要看截距、斜率、相关性等指标。<img data-ratio="0.42685185185185187" data-src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jX7FQvue0qGXtSh9QiauiaLxrNGIgoibkEhzqia1AfW3whUsH7aF8Knmias5g/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2bfCCJ6tRDVTt2DfDmYF9jX7FQvue0qGXtSh9QiauiaLxrNGIgoibkEhzqia1AfW3whUsH7aF8Knmias5g/640?wx_fmt=png">从结果来看，自己找marker构建signature matrix得到的结果略好一些（当然前提是marker找得好）。</p><section><mp-common-profile data-pluginname="mpprofile" data-weui-theme="light" data-id="MzkzMzE5NTM4NA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/WThoCmvVu2aJMzXzvekL6pv5hnSGnwsxWcOUF8av7a9VEiaicBGia4CRy0DUOeaFuFZY2BPLmRQSf4lkibg5l31Ttw/0?wx_fmt=png" data-nickname="TOP生物信息" data-alias="" data-signature="生信人，当自强。" data-from="0" data-is_biz_ban="0"></mp-common-profile></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/4W5kav6r4UcX-haQ2rv3NA",target="_blank" rel="noopener noreferrer">原文链接</a>
