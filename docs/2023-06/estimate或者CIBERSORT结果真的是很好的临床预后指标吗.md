---
title: "estimate或者CIBERSORT结果真的是很好的临床预后指标吗"
date: 2023-06-28T10:55:36Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
estimate或者CIBERSORT结果真的是很好的临床预后指标吗 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>肿瘤免疫微环境我们讲了很多内容了，目录是：</p></blockquote><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506740&amp;idx=3&amp;sn=46e12b5bc3413e52f544c6846481dfb3&amp;scene=21#wechat_redirect" data-linktype="2">estimate的两个打分值本质上就是两个基因集的ssGSEA分析</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506712&amp;idx=1&amp;sn=2700187268c3af5448eb4c236aa6c684&amp;scene=21#wechat_redirect" data-linktype="2">针对TCGA数据库全部的癌症的表达量矩阵批量运行estimate</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506712&amp;idx=2&amp;sn=33cbb66d8c21a484a9c5e61924078e4d&amp;scene=21#wechat_redirect" data-linktype="2">不同癌症内部按照estimate的两个打分值高低分组看蛋白编码基因表达量差异</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506811&amp;idx=1&amp;sn=e28d4c762094f7f3e00b729d7fd33c69&amp;scene=21#wechat_redirect" data-linktype="2">使用CIBERSORT算法推断全部tcga样品的免疫细胞比例</a></section></li></ul><p data-tool="mdnice编辑器">都是依据肿瘤病人的转录组测序表达量矩阵进行的分析，也有几百篇类似的数据挖掘文章了，它们总是喜欢落脚到estimate或者CIBERSORT结果的预后意义。</p><p data-tool="mdnice编辑器">那么，我们就来实际检验看看estimate或者CIBERSORT结果真的是很好的临床预后指标吗！</p><h3 data-tool="mdnice编辑器"><span></span><span>首先看看 estimate 的StromalSignature 和  ImmuneSignature</span><span></span></h3><p data-tool="mdnice编辑器">载入前面步骤的 estimate 算法得到的StromalSignature 和  ImmuneSignature，如果你不知道下面的rdata文件（ssgseaScore-for-ssGSEA_for_seurat.Rdata ）来源，建议再看看<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506712&amp;idx=2&amp;sn=33cbb66d8c21a484a9c5e61924078e4d&amp;scene=21#wechat_redirect" data-linktype="2">不同癌症内部按照estimate的两个打分值高低分组看蛋白编码基因表达量差异</a> ：</p><pre data-tool="mdnice编辑器"><span></span><code>load(<span>'../expression/estimate_results/ssgseaScore-for-ssGSEA_for_seurat.Rdata'</span>)<br>head(ssgseaScore)<br><br>&gt; head(ssgseaScore)<br>                 StromalSignature ImmuneSignature<br>TCGA-OR-A5JP-01A      -<span>0.06619425</span>     -<span>0.13854919</span><br>TCGA-OR-A5JG-01A      -<span>0.09059249</span>     -<span>0.07372133</span><br>TCGA-OR-A5K1-01A      -<span>0.06014336</span>     -<span>0.02297215</span><br>TCGA-OR-A5JR-01A      -<span>0.09859187</span>     -<span>0.01468964</span><br>TCGA-OR-A5KU-01A      -<span>0.11097034</span>     -<span>0.16760435</span><br>TCGA-OR-A5L9-01A       <span>0.01055877</span>      <span>0.10013901</span><br><br>ssgseaScore$pid=substring(rownames(ssgseaScore),<span>1</span>,<span>12</span>)<br>head(ssgseaScore)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>接下来批量进行生存分析，区分各个癌症</span><span></span></h3><p data-tool="mdnice编辑器">仍然是32种癌症，内部的estimate 算法得到的StromalSignature 和  ImmuneSignature，各自根据中位值进行分组，然后进行生存分析看看estimate 算法得到的StromalSignature 和  ImmuneSignature指标是否有生存意义：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(survminer) <br><span>library</span>(survival)<br>load(file = <span>'phe_stage.Rdata'</span>)<br>phe[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br>tp=unique(phe$type)<br>tp<br><br>sur_list &lt;- lapply(tp, <span>function</span>(x){<br>  <span># x=tp[1]</span><br>  this_phe=phe[phe$type==x,]<br>  <span># 这里先看 os </span><br>  survival_dat=as.data.frame(this_phe[,c(<span>'bcr_patient_barcode'</span>,<span>'OS'</span>,<span>'OS.time'</span>)])<br>  head(survival_dat)<br>  <br>  colnames(survival_dat)=c(<span>'pid'</span>,<span>'event'</span>,<span>'time'</span>)<br>  survival_dat=merge(survival_dat,ssgseaScore,by=<span>'pid'</span>) <br>  survival_dat$time =  survival_dat$time/<span>365</span><br>  <br>  survival_dat$group=ifelse(survival_dat$StromalSignature&gt;median(survival_dat$StromalSignature),<br>                            <span>'stromal_high'</span>,<span>'stromal_low'</span>)<br>  fit &lt;- survfit(Surv(time, event) ~ group,<br>                 data = survival_dat)<br>  stromal_survp=ggsurvplot(fit,data = survival_dat, <span>#这里很关键，不然会报错</span><br>                   legend.title = x,<br>                   pval = <span>T</span>, <span>#在图上添加log rank检验的p值 </span><br>                   risk.table = <span>F</span>, <span>#在图下方添加风险表</span><br>                   xlab = <span>"Time in years"</span>, <span>#x轴标题</span><br>                   xlim = c(<span>0</span>, <span>10</span>), <span>#展示x轴的范围</span><br>                   break.time.by = <span>1</span>, <span>#x轴间隔</span><br>                   size = <span>1.5</span><span>#线条大小</span><br>  )<br>  survival_dat$group=ifelse(survival_dat$ImmuneSignature&gt;median(survival_dat$ImmuneSignature),<br>                            <span>'immune_high'</span>,<span>'immune_low'</span>)<br>  fit &lt;- survfit(Surv(time, event) ~ group,<br>                 data = survival_dat)<br>  immune_survp=ggsurvplot(fit,data = survival_dat, <span>#这里很关键，不然会报错</span><br>                           legend.title = x,<br>                           pval = <span>T</span>, <span>#在图上添加log rank检验的p值 </span><br>                           risk.table = <span>F</span>, <span>#在图下方添加风险表</span><br>                           xlab = <span>"Time in years"</span>, <span>#x轴标题</span><br>                           xlim = c(<span>0</span>, <span>10</span>), <span>#展示x轴的范围</span><br>                           break.time.by = <span>1</span>, <span>#x轴间隔</span><br>                           size = <span>1.5</span><span>#线条大小</span><br>  )<br>  <br>  <span>return</span>(list(<br>    immune_survp=immune_survp,<br>    stromal_survp=stromal_survp<br>  ))<br>})<br></code></pre><p data-tool="mdnice编辑器">这里每个癌症都返回来了一个list，包含这stromal和immune的高低分组后的差异分析图！</p><p data-tool="mdnice编辑器">对ImmuneSignature 出图：</p><pre data-tool="mdnice编辑器"><span></span><code><br>x=6;y=6<br>all_plot &lt;- arrange_ggsurvplots(lapply(sur_list, <span>function</span>(x) x[[1]]),<br>                                <span>print</span> = F,<br>                                ncol =x, nrow = y) <br><br>x=30;y=30<br>ggsave(all_plot,filename = <span>'stromal_sur_plot.pdf'</span>,<br>       width = x,height = y)<br></code></pre><p data-tool="mdnice编辑器">可以看到 ImmuneSignature 中位数分组后在部分癌症是有统计学显著的生存意义哦！</p><p><img data-ratio="0.51328125" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwLBjpXpkbMiaKbxxbzhbHgmJia8SYkW8LKrxLULz7AJGUFLBYUNAfCbnpRc4Sp1Z2gCzehMmPCAOMg/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwLBjpXpkbMiaKbxxbzhbHgmJia8SYkW8LKrxLULz7AJGUFLBYUNAfCbnpRc4Sp1Z2gCzehMmPCAOMg/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>ImmuneSignature 中位数分组生存分析</figcaption></figure><p data-tool="mdnice编辑器">对 StromalSignature  出图：</p><pre data-tool="mdnice编辑器"><span></span><code>x=6;y=6<br>all_plot &lt;- arrange_ggsurvplots(lapply(sur_list, <span>function</span>(x) x[[2]]),<br>                                <span>print</span> = F,<br>                                ncol =x, nrow = y) <br><br>x=30;y=30<br>ggsave(all_plot,filename = <span>'immune_sur_plot.pdf'</span>,<br>       width = x,height = y)<br></code></pre><p data-tool="mdnice编辑器">可以看到 StromalSignature  分组后在部分癌症是有统计学显著的生存意义哦！</p><p><img data-ratio="0.50078125" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwLBjpXpkbMiaKbxxbzhbHgmfnOiavrqtFUOTXibOfxDXLfqUsxK9BKXUR8KiaW82oeIkEaiaJdqkOhjLw/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwLBjpXpkbMiaKbxxbzhbHgmfnOiavrqtFUOTXibOfxDXLfqUsxK9BKXUR8KiaW82oeIkEaiaJdqkOhjLw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>StromalSignature  分组生存分析</figcaption></figure><p data-tool="mdnice编辑器">这个时候其实我们无需看这么多图，仅仅是输出p值，还有HR值即可！</p><h3 data-tool="mdnice编辑器"><span></span><span>survdiff代替 survfit</span><span></span></h3><p data-tool="mdnice编辑器">代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span># surv 构建对象</span><br><span># survfit 拟合生存曲线</span><br><span># survdiff 差异检验</span><br><br>options(digits = <span>2</span>)<br>km_results &lt;- do.call(rbind,<br>        lapply(tp, <span>function</span>(x){<br>          <span># x=tp[1]</span><br>          this_phe=phe[phe$type==x,]<br>          <span># 这里先看 os </span><br>          survival_dat=as.data.frame(this_phe[,c(<span>'bcr_patient_barcode'</span>,<span>'OS'</span>,<span>'OS.time'</span>)])<br>          head(survival_dat)<br>          <br>          colnames(survival_dat)=c(<span>'pid'</span>,<span>'event'</span>,<span>'time'</span>)<br>          survival_dat=merge(survival_dat,ssgseaScore,by=<span>'pid'</span>) <br>          survival_dat$time =  survival_dat$time/<span>365</span><br>          <br>          survival_dat$group=ifelse(survival_dat$StromalSignature&gt;median(survival_dat$StromalSignature),<br>                                    <span>'stromal_high'</span>,<span>'stromal_low'</span>)<br>          fit &lt;- survdiff(Surv(time, event) ~ group,<br>                          data = survival_dat)<br>          stromal_p.val = <span>1</span> - pchisq(fit$chisq, length(fit$n) - <span>1</span>)<br>          stromal_HR = (fit$obs[<span>2</span>]/fit$exp[<span>2</span>])/(fit$obs[<span>1</span>]/fit$exp[<span>1</span>])<br>          <br>          survival_dat$group=ifelse(survival_dat$ImmuneSignature&gt;median(survival_dat$ImmuneSignature),<br>                                    <span>'immune_high'</span>,<span>'immune_low'</span>)<br>          fit &lt;- survdiff(Surv(time, event) ~ group,<br>                          data = survival_dat)<br>          immune_p.val = <span>1</span> - pchisq(fit$chisq, length(fit$n) - <span>1</span>)<br>          immune_HR = (fit$obs[<span>2</span>]/fit$exp[<span>2</span>])/(fit$obs[<span>1</span>]/fit$exp[<span>1</span>])<br>          <br>          <span>return</span>(c(stromal_p.val,stromal_HR,<br>                   immune_p.val,immune_HR))<br>        }))<br>rownames(km_results)=tp<br>km_results<br></code></pre><p data-tool="mdnice编辑器">结果如下所示，可以看到BRCA这个癌症里面的 estimate 算法得到的StromalSignature 和  ImmuneSignature都是可以区分生存，因为p值都是0.05附近，结合前面的图表，可以看到：</p><ul data-tool="mdnice编辑器"><li><section>其中StromalSignature 高，死得快。</section></li><li><section>而ImmuneSignature高死的慢，是保护因子。</section></li></ul><p data-tool="mdnice编辑器">而且可以看到下面的HR值也有可能是反过来了的，需要自行甄别！</p><p data-tool="mdnice编辑器">而且真的是每个癌症都不一样，两个打分不一定是生存分析统计学显著，不一定是保护因子或者风险因子，唉！</p><pre data-tool="mdnice编辑器"><span></span><code><span># stromal_p.val,stromal_HR, immune_p.val,immune_HR </span><br>&gt; round(km_results,2)<br>     [,1] [,2] [,3] [,4]<br>ACC  0.70 1.16 0.03 2.34<br>BLCA 0.03 0.73 0.85 1.03<br>BRCA 0.06 0.77 0.04 1.33<br>CESC 0.47 1.18 0.06 1.56<br>CHOL 0.15 1.86 0.04 2.55<br>COAD 0.41 0.86 0.81 0.96<br>DLBC 0.87 1.11 0.63 0.74<br>ESCA 0.66 0.90 0.68 0.91<br>GBM  0.20 0.80 0.21 0.81<br>HNSC 0.23 1.16 0.04 1.30<br>KICH 0.76 0.84 0.64 1.31<br>KIRC 0.78 1.04 0.13 0.81<br>KIRP 0.06 0.59 0.83 1.06<br>LAML 0.80 0.95 0.01 0.59<br>LGG  0.00 0.57 0.01 0.63<br>LIHC 0.65 0.93 0.75 0.95<br>LUAD 0.16 1.21 0.07 1.28<br>LUSC 0.03 0.76 0.18 0.84<br>MESO 0.01 0.55 0.45 1.19<br>OV   0.63 0.94 0.36 1.13<br>PAAD 0.54 0.88 0.80 1.05<br>PCPG 0.17 2.92 0.64 1.39<br>PRAD 0.22 2.21 0.59 1.41<br>READ 0.16 0.61 0.80 1.10<br>SARC 0.06 1.47 0.01 1.69<br>SKCM 0.04 1.32 0.00 1.75<br>STAD 0.10 0.77 0.33 0.85<br>TGCT 0.04 0.00 0.19 0.25<br>THCA 1.00 1.00 0.75 1.16<br>THYM 0.92 0.94 0.73 1.26<br>UCEC 0.48 1.16 0.01 1.65<br>UCS  0.68 0.87 0.73 1.12<br>UVM  0.01 0.35 0.00 0.23<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>然后看CIBERSORT的22种免疫细胞比例的生存意义</span><span></span></h3><p data-tool="mdnice编辑器">同样的，载入前面步骤得到的CIBERSORT的22种免疫细胞比例，也是可以自己回顾<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247506811&amp;idx=1&amp;sn=e28d4c762094f7f3e00b729d7fd33c69&amp;scene=21#wechat_redirect" data-linktype="2">使用CIBERSORT算法推断全部tcga样品的免疫细胞比例</a>教程：</p><pre data-tool="mdnice编辑器"><span></span><code>load(<span>'../expression/CIBERSORT_results/cibersort_raw-for-seurat.Rdata'</span>)<br>colnames(cibersort_raw)<br>[1] <span>"Patients"</span>                    <br> [2] <span>"B.cells.naive"</span>               <br> [3] <span>"B.cells.memory"</span>              <br> [4] <span>"Plasma.cells"</span>                <br> [5] <span>"T.cells.CD8"</span>                 <br> [6] <span>"T.cells.CD4.naive"</span>           <br> [7] <span>"T.cells.CD4.memory.resting"</span>  <br> [8] <span>"T.cells.CD4.memory.activated"</span><br> [9] <span>"T.cells.follicular.helper"</span>   <br>[10] <span>"T.cells.regulatory..Tregs."</span>  <br>[11] <span>"T.cells.gamma.delta"</span>         <br>[12] <span>"NK.cells.resting"</span>            <br>[13] <span>"NK.cells.activated"</span>          <br>[14] <span>"Monocytes"</span>                   <br>[15] <span>"Macrophages.M0"</span>              <br>[16] <span>"Macrophages.M1"</span>              <br>[17] <span>"Macrophages.M2"</span>              <br>[18] <span>"Dendritic.cells.resting"</span>     <br>[19] <span>"Dendritic.cells.activated"</span>   <br>[20] <span>"Mast.cells.resting"</span>          <br>[21] <span>"Mast.cells.activated"</span>        <br>[22] <span>"Eosinophils"</span>                 <br>[23] <span>"Neutrophils"</span>                 <br>[24] <span>"group"</span>                       <br>[25] <span>"type"</span> <br></code></pre><p data-tool="mdnice编辑器"><strong>就作为学徒作业吧，我就不贴代码也不给结果啦！</strong></p><p data-tool="mdnice编辑器">每个细胞类型在每个癌症的生存情况，都需要km检验，都有一个p值和一个hr值，计算起来并不难，但是可视化就有点麻烦了！后面我们再细说这个可视化！</p></section><h3 data-tool="mdnice编辑器">文末友情推荐</h3><p><span>做教学我们是认真的，如果你对我们的<strong>马拉松授课（直播一个月互动教学）</strong>有疑问，可以看完我们从2000多个提问互动交流里面精选的200个问答！ <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247505193&amp;idx=1&amp;sn=bd55341f6409948188a0515f1552e2e3&amp;chksm=9b4b9592ac3c1c848b7f8965270cf9234945e0031e11ca3f559afc17247ca6098f57670cf192&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" wah-hotarea="click">2021第二期_生信入门班_微信群答疑整理</a>，以及 <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247505071&amp;idx=2&amp;sn=29727136d3907dd3b315232cbbb8d72d&amp;chksm=9b4b9414ac3c1d02c2ccd9639e01411d17347aa56c4e0eb3f254a8b159a50bde9aa7e20d2d2a&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" wah-hotarea="click">2021第二期_数据挖掘班_微信群答疑笔记</a></span></p><p data-tool="mdnice编辑器"><span>与十万人一起学生信，你值得拥有下面的学习班：</span></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247507009&amp;idx=2&amp;sn=f1c813866b3314a10463c317f62c3426&amp;chksm=9b4b9cfaac3c15ecc1325c17283d933650f27e4b2f84a1a423d64973dc7821eac58c1d46e838&amp;scene=21#wechat_redirect" textvalue="生信入门课-2021第8期" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">生信入门课-2021第8期</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247507009&amp;idx=1&amp;sn=c1c9efd3ed6663df6e710bf7a5a249c6&amp;chksm=9b4b9cfaac3c15ec63b5a2c9e6f5a7c328f0575c1e04b245ce6ab6d594320fa33a824e5f7d6d&amp;scene=21#wechat_redirect" textvalue="数据挖掘（GEO,TCGA,单细胞）2021第8期" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">数据挖掘（GEO,TCGA,单细胞）2021第8期</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247498002&amp;idx=1&amp;sn=c55c54c256cb99593af99d4325803e28&amp;chksm=ea1cff90dd6b76865a18d50a4aaea4b3b584b36c80b42423a9399d79d8acdaeb06d908a05172&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">单细胞数据分析（一折起）</a></p></li></ul><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/2Ob3WtjzD8l3bLJYdEmWew",target="_blank" rel="noopener noreferrer">原文链接</a>
