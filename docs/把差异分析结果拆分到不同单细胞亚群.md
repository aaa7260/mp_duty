---
title: "把差异分析结果拆分到不同单细胞亚群"
date: 2022-12-31T01:39:57Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
把差异分析结果拆分到不同单细胞亚群 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>差异分析大家都没有问题了，无论是表达量芯片还是转录组测序后的counts矩阵，都有各自的R包，很容易就拿到上下调的基因列表。如果是GEO数据库里面的表达量芯片数据处理，主要的难点是表达量矩阵获取和探针的基因名字转换，搞定后只需要一定的生物学背景对数据进行合理的分组后就是标准的差异分析，富集分析。<strong>主要是参考我八年前的笔记：</strong></p></blockquote><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486063&amp;idx=1&amp;sn=156bee5397e979722b36b78284188538&amp;scene=21#wechat_redirect" data-linktype="2">解读GEO数据存放规律及下载，一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486054&amp;idx=1&amp;sn=209975adee162228cfe6e6c5065c5c8c&amp;scene=21#wechat_redirect" data-linktype="2">解读SRA数据库规律一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486087&amp;idx=1&amp;sn=1e775a1c3e215384e381953a9fa74ec3&amp;scene=21#wechat_redirect" data-linktype="2">从GEO数据库下载得到表达矩阵 一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486090&amp;idx=1&amp;sn=62374fbdd4f20c3185beb6568bbeb3e9&amp;scene=21#wechat_redirect" data-linktype="2">GSEA分析一文就够（单机版+R语言版）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486112&amp;idx=1&amp;sn=67a2104c62222bcb139623699f874a6c&amp;scene=21#wechat_redirect" data-linktype="2">根据分组信息做差异分析- 这个一文不够的</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486120&amp;idx=1&amp;sn=14d7892c1beec2fb9cdfc0ec0aba3e4e&amp;scene=21#wechat_redirect" data-linktype="2">差异分析得到的结果注释一文就够</a></section></li></ul><p data-tool="mdnice编辑器">其他形式的矩阵也是可以差异分析的，比如蛋白质组学后的表达量矩阵，以及代谢组，等等。又或者是甲基化芯片后的矩阵，甲基化测序的 WGBS和RRBS，还有 芯片是最高频的甲基化技术，其中甲基化芯片数据处理我是有视频课程的，首先需要阅读我在生信技能树的甲基化系列教程，<strong>目录如下</strong>：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492739&amp;idx=1&amp;sn=c044bb55fe19d48f3b8299e3b41949d6&amp;scene=21#wechat_redirect" data-linktype="2">01-甲基化的一些基础知识.pdf</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492747&amp;idx=1&amp;sn=4edfdd4404bd85ef9a5439b01ee51ece&amp;scene=21#wechat_redirect" data-linktype="2">02-甲基化芯片的一般分析流程.pdf</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492863&amp;idx=1&amp;sn=807ec9cd3df2f5c4069f2d19ccc50fb9&amp;scene=21#wechat_redirect" data-linktype="2">03-甲基化芯片数据下载的多种技巧.pdf</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492863&amp;idx=2&amp;sn=6739846b541e1999c13f05b0b6ef35d1&amp;scene=21#wechat_redirect" data-linktype="2">04-甲基化芯片数据下载如何读入到R里面.pdf</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492872&amp;idx=2&amp;sn=32a38bfd069d5fc9f342b9be1db27094&amp;scene=21#wechat_redirect" data-linktype="2">05-甲基化芯片数据的一些质控指标.pdf</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492979&amp;idx=2&amp;sn=4072c2f045693bb02cf05ff32056da14&amp;scene=21#wechat_redirect" data-linktype="2">06-甲基化信号值矩阵差异分析哪家强.pdf</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247489833&amp;idx=1&amp;sn=e3a72b0087dd38080cb9b502e2e5c8de&amp;scene=21#wechat_redirect" data-linktype="2">07-甲基化芯片信号值矩阵差异分析的标准代码.pdf</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492970&amp;idx=2&amp;sn=213ee35045452b45722fb2473646619c&amp;scene=21#wechat_redirect" data-linktype="2">08-TCGA数据库的各个癌症甲基化芯片数据重新分析.pdf</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247490092&amp;idx=1&amp;sn=a9f9e5d2a997f9bcdacee6a46006cfec&amp;scene=21#wechat_redirect" data-linktype="2">09-TCGA数据库的癌症甲基化芯片数据重分析.pdf</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247488265&amp;idx=1&amp;sn=39bdf7ec77efd9f2fc15f680968fa9a4&amp;scene=21#wechat_redirect" data-linktype="2">10-TCGA数据辅助甲基化区域的功能研究.pdf</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247487877&amp;idx=1&amp;sn=a89e9429e02766e57c1ccff6ddf03820&amp;scene=21#wechat_redirect" data-linktype="2">11-按基因在染色体上的顺序画差异甲基化热图.pdf</a></section></li></ul><p data-tool="mdnice编辑器">但是因为传统的表达量矩阵都是bulk时代的产物，而且单细胞费用一直是居高不下，所以即使到2023大家的首选仍然是bulk测序，普通的bulk测序的转录组才四五百块钱，但是单细胞仍然是接近两万块钱一个样品。</p><p data-tool="mdnice编辑器">我们针对bulk时代的传统的表达量矩阵进行分组后的差异分析，拿到的上下调基因这个时候有两个不同的属性：</p><ul data-tool="mdnice编辑器"><li><section>不同分组本身不同单细胞亚群比例有变化，所以其单细胞亚群特异性基因会差异</section></li><li><section>不同分组的多个单细胞亚群都有同样的通路上下调导致bulk水平的统计学显著的上下调基因</section></li></ul><p data-tool="mdnice编辑器">这样的两个情况就需要区分一下，如果我们怀疑是不同分组本身不同单细胞亚群比例有变化，其实可以做一个去卷积的单细胞亚群比例推断，就可以验证。如果我们仅仅是想看自己的bulk水平的统计学显著的上下调基因是否有单细胞亚群特异性，一个R包：TOAST (TOols for the Analysis of heterogeneouS Tissues) 推荐给大家：</p><p><img data-galleryid="" data-ratio="0.7511520737327189" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxIOQVW1lK8Fde2FKGL3osEknrAJcIN3sPdMZdVROWnSVVb0H06v1ngENucyzEiab8QyBn7XTene3w/640?wx_fmt=png" data-type="png" data-w="1736" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxIOQVW1lK8Fde2FKGL3osEknrAJcIN3sPdMZdVROWnSVVb0H06v1ngENucyzEiab8QyBn7XTene3w/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">使用起来非常方便，就一个csTest函数即可，示范代码是：</p><pre data-tool="mdnice编辑器"><span></span><code>Design_out &lt;- makeDesign(design, Prop)<br>fitted_model &lt;- fitModel(Design_out, Y_raw)<br>fitted_model$all_coefs <span># list all phenotype names</span><br>fitted_model$all_cell_types <span># list all cell type names</span><br><span># coef should be one of above listed phenotypes</span><br><span># cell_type should be one of above listed cell types</span><br>res_table &lt;- csTest(fitted_model, coef = <span>"age"</span>, <br>                    cell_type = <span>"Neuron"</span>, contrast_matrix = <span>NULL</span>)<br>head(res_table)<br></code></pre><p data-tool="mdnice编辑器">可以看到，运行这个csTest函数的流程需要起码3个元素：</p><ul data-tool="mdnice编辑器"><li><section>Y _ raw 的表达量芯片矩阵或 DNA 甲基化信号值矩阵</section></li><li><section>一个称为 Design 的样本信息数据框</section></li><li><section>以及一个称为 prop 的细胞组成表(即混合比例)</section></li></ul><p data-tool="mdnice编辑器">Y _ raw 也可以是 SummarizedLaboratory 对象格式，而不是数据矩阵格式，不过这个不重要。我们的bulk时代的表达量芯片或者甲基化芯片很容易拿到矩阵，然后矩阵里面的每个样品都有自己的属性，比如疾病或者对象，处理和对照，性别，这样的信息，就是称为 Design 的样本信息数据框。比较麻烦的是一个称为 prop 的细胞组成表(即混合比例)，如果是甲基化芯片矩阵，可以使用EpiDISH-根据甲基化信号值推断样品的细胞成分，如果是表达量芯片矩阵，可以使用使用MuSiC来根据单细胞亚群特征基因集对bulk转录组数据推断细胞成分。</p><h3 data-tool="mdnice编辑器"><span></span>示例数据<span></span></h3><p data-tool="mdnice编辑器">加载这个包，就可以得到3种测试数据，两个甲基化芯片，一个普通表达量芯片矩阵，都有各自的样品分组以及各自的细胞比例矩阵。所以很容易运行这个csTest函数的流程。</p><pre data-tool="mdnice编辑器"><span></span><code><span>## ----loadData-----------------------------------------------------------------</span><br><span>library</span>(TOAST)<br>data(<span>"RA_100samples"</span>)<br><br><span># 第一个例子数据集是450K DNA 甲基化数据。基于 GSE42861提供的原始数据，</span><br><span># 我们获取并处理了该数据集。这是类风湿关节炎患者和对照组的 DNA 甲基化450K 数据。</span><br><span># 原始数据集有485577个特征和689个样本。</span><br><span># 我们已经将随机选择的50名 RA 患者和50名对照者的数据集减少到3000个 CpG。</span><br><br>Y_raw &lt;- RA_100samples$Y_raw<br>Pheno &lt;- RA_100samples$Pheno<br>Blood_ref &lt;- RA_100samples$Blood_ref<br><br><span>## ----checkData----------------------------------------------------------------</span><br>dim(Y_raw) <br>Y_raw[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br><span>## ----checkPheno---------------------------------------------------------------</span><br>dim(Pheno)<br>head(Pheno, <span>3</span>)<br>table(Pheno$disease)<br><br></code></pre><p data-tool="mdnice编辑器">我们这里选择了第一个是甲基化示例数据，所以使用EpiDISH-根据甲基化信号值推断样品的细胞成分，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>refinx &lt;- findRefinx(Y_raw, nmarker = <span>1000</span>) <br>Y &lt;- Y_raw[refinx,]<br>Ref &lt;- as.matrix(Blood_ref[refinx,])<br><span>library</span>(EpiDISH)<br>outT &lt;- epidish(beta.m = Y, ref.m = Ref, method = <span>"RPC"</span>)<br>estProp_RB &lt;- outT$estF<br>estProp_RB[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br><span>library</span>(TOAST) <br>K=<span>6</span><br>set.seed(<span>1234</span>)<br>outRF1 &lt;- csDeconv(Y_raw, K, TotalIter = <span>30</span>, bound_negative = <span>TRUE</span>)  <br>estProp_RF_improved &lt;- assignCellType(input=outRF1$estProp,<br>                                      reference=estProp_RB) <br>mean(diag(cor(estProp_RF_improved, estProp_RB)))<br>Prop &lt;- estProp_RF_improved<br>colnames(Prop) &lt;- colnames(Ref) <br>head(Prop) <br></code></pre><p data-tool="mdnice编辑器">如果是表达量芯片矩阵，需要使用MuSiC来根据单细胞亚群特征基因集对bulk转录组数据推断细胞成分。</p><pre data-tool="mdnice编辑器"><span></span><code> <span>"CD8T"</span>  <span>"CD4T"</span>  <span>"NK"</span>    <span>"Bcell"</span> <span>"Mono"</span>  <span>"Gran"</span> <br></code></pre><p data-tool="mdnice编辑器">这个时候，甲基化信号值矩阵把血液bulk矩阵拆分成为了常见的淋巴细胞以及髓系免疫细胞的比例。</p><p data-tool="mdnice编辑器">有了甲基化信号矩阵，样品的各个单细胞亚群比例矩阵，以及样品分组，就很容易运行这个csTest函数的流程。</p><pre data-tool="mdnice编辑器"><span></span><code><br>Design_out &lt;- makeDesign(design, Prop) <br>fitted_model &lt;- fitModel(Design_out, Y_raw)<br><span># print all the cell type names</span><br>fitted_model$all_cell_types<br><span># print all phenotypes</span><br>fitted_model$all_coefs<br><span>## -----------------------------------------------------------------------------</span><br>res_table &lt;- csTest(fitted_model, <br>                    coef = <span>"disease"</span>, <br>                    cell_type = <span>"Gran"</span>)<br>head(res_table, <span>3</span>)<br>Disease_Gran_res &lt;- res_table <br><br></code></pre><p data-tool="mdnice编辑器">其中 coef 参数可以控制我们想做的表型差异情况，示例数据里面的是类风湿关节炎患者和对照组这样的疾病状态。然后 cell_type 参数里面控制我们想看的单细胞亚群的差异情况。最后得到res_table就是差异分析结果啦，而且是针对粒细胞这个免疫细胞亚群的。</p><p data-tool="mdnice编辑器">这样的话，<strong>我们就把常规的差异分析结果给细化到了单细胞亚群的水平，虽然我们并没有做指定的单细胞层面的数据。</strong></p><h3 data-tool="mdnice编辑器"><span></span>学徒作业<span></span></h3><p data-tool="mdnice编辑器">使用包里面的第二个示例数据，GSE65133里面的芯片表达量矩阵，是PBMC，所以很容易使用PBMC3K的单细胞数据来去卷积，看   BCells    ，   CD8T      ，  CD4T ，  NK cells  ，Monocytes 这些单细胞亚群的比例的推断结果。就使用MuSiC来根据单细胞亚群特征基因集对bulk转录组数据推断细胞成分。</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/5XDSds_7OWLOFunK3NC_yA",target="_blank" rel="noopener noreferrer">原文链接</a>
