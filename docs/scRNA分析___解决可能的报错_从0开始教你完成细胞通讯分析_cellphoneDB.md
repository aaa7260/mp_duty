---
title: "scRNA分析 | 解决可能的报错，从0开始教你完成细胞通讯分析-cellphoneDB"
date: 2022-12-06T00:22:16Z
draft: ["false"]
tags: [
  "fetched",
  "生信补给站"
]
categories: ["Acdemic"]
---
scRNA分析 | 解决可能的报错，从0开始教你完成细胞通讯分析-cellphoneDB by 生信补给站
------
<div><p data-mpa-powered-by="yiban.io"><span><strong><span>CellPhoneDB</span></strong>是一个受配体及其相互作用的数据库，<span>整合了</span><strong><span>UniProt, ensemble, PDB, IMEx，IUPHAR</span></strong><span>等数据库的信息</span><strong><span>。</span></strong>CellPhoneDB数据库概况如下图所示</span></p><p><img data-ratio="0.5609756097560976" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjDcQ1OqWLrmZf17IX7dpYbrDnK78wfH3U0rUrw1UGSEEIyaggmU5ibZp6kJkTiaFibco9pB1Fkd27cPQ/640?wx_fmt=png" data-type="png" data-w="1025" width="820" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjDcQ1OqWLrmZf17IX7dpYbrDnK78wfH3U0rUrw1UGSEEIyaggmU5ibZp6kJkTiaFibco9pB1Fkd27cPQ/640?wx_fmt=png"><span><br></span></p><p><span>本文将从头开始介绍（1）如何安装cellphonedb</span><strong><span>以及解决可能的报错</span></strong><span>，（2）如何下载cellphonedb数据库，（3）单细胞数据提取输入文件 以及（4）简单的可视化.</span></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><p>一 cellphonedb准备</p></section></section></section></section></section><p><span><strong>1，cellphonedb安装</strong></span></p><p><span>考虑到不同的生信软件对于python 或者 R 的版本要求不一致，建议建立一个<strong>独立的python环境</strong>。官网</span><span>https://github.com/ventolab/CellphoneDB</span><span>介绍了conda 和 <span>virtualenv </span>2种方式，这里使用conda的方式。</span></p><p><span>1) Create python=&gt;3.6 environment</span></p><section><ul><li></ul><pre data-lang="nginx"><code><span><span>conda</span> create -n cpdb python=<span>3</span>.<span>7</span></span></code></pre></section><p><span>2) Activate environment</span></p><section><ul><li></ul><pre data-lang="bash"><code><span><span>source</span> activate cpdb</span></code></pre></section><p><span>3) <span>Install CellPhoneDB</span></span></p><section><ul><li></ul><pre data-lang="nginx"><code><span><span>pip</span> install cellphonedb</span></code></pre></section><p><span><strong>ERROR1：</strong></span><span>如果这一步出现如下报错</span></p><p><img data-ratio="0.2073778664007976" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjDcQ1OqWLrmZf17IX7dpYbrMqjynZ7AcDh15c5NFliaq6CoUciaJmFPxctW44YHNLaKTzY7D5X2C8mA/640?wx_fmt=png" data-type="png" data-w="1003" width="802.4" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjDcQ1OqWLrmZf17IX7dpYbrMqjynZ7AcDh15c5NFliaq6CoUciaJmFPxctW44YHNLaKTzY7D5X2C8mA/640?wx_fmt=png"></p><p><span>解决方式就是<span>先安装一下rpy2</span></span></p><section><ul><li></ul><pre data-lang="nginx"><code><span><span>conda</span> install -c conda-forge rpy2</span></code></pre></section><p><span>安装之后再安装pipinstallcellphonedb 即可。</span></p><p><span>检测方式：在终端输入cellphonedb ，出现如下截图的提示则安装成功，cellphonedb主要commands有四个，本文主要介绍一下红框内的method和plot，database也很重要 。</span></p><p><img data-ratio="0.4592720970537262" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjDcQ1OqWLrmZf17IX7dpYbrcjBBoyPq8edABlf3vz3hfWtN7w4YOIKWNn7Dl0ulHY395E8Il2HQvQ/640?wx_fmt=png" data-type="png" data-w="577" width="461.6" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjDcQ1OqWLrmZf17IX7dpYbrcjBBoyPq8edABlf3vz3hfWtN7w4YOIKWNn7Dl0ulHY395E8Il2HQvQ/640?wx_fmt=png"></p><p>安装成功！<br mpa-from-tpl="t"></p><p><span><strong>2，下载cellphoneDB数据库</strong></span></p><p><span>一般直接默认选择最新的版本。</span><br></p><p><span>（1）使用上述的database参数下载数据库文件，</span><code><span>cellphonedb database download</span></code></p><section><ul><li><li><li></ul><pre data-lang="markdown"><code><span>[<span> </span>][<span>APP</span>][<span>05/12/22-17:19:52</span>][<span>INFO</span>] Downloading release v4.0.0 of CellPhoneDB database</span></code><code><span>[<span> </span>][<span>APP</span>][<span>05/12/22-17:20:06</span>][<span>INFO</span>] Download completed!</span></code><code><span>[<span> </span>][<span>APP</span>][<span>05/12/22-17:20:06</span>][<span>INFO</span>] Copying database to xxx/releases/v4.0.0</span></code></pre></section><p><span>（2）在</span><span>https://github.com/ventolab/CellphoneDB-data</span><span> 网址手动下载<strong><span>cellphone.db</span></strong>文件 。</span></p><p><span>以上两种方式均可以，记清楚数据库文件所在的路径就可以。</span></p><p><strong>3，准备输入文件</strong></p><p>在单细胞的seuratObject文件中提取矩阵文件和注释文件，这里以<span>以一个样本为例</span><span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span>library(Seurat) </span></code><code><span>library(tidyverse)</span></code><code><span><span>load</span>(<span>"sce.anno.RData"</span>)</span></code><code><span><span>#使用一个样本作为示例</span></span></code><code><span><span>test</span> &lt;- subset(sce2, <span>sample</span> == <span>"P01"</span>)</span></code><code><span><br></span></code><code><span><span>#注释文件</span></span></code><code><span>meta_data &lt;- <span>test</span>@meta.data %&gt;% </span></code><code><span>  rownames_to_column(<span>"Cell"</span>) %&gt;% </span></code><code><span>  <span>select</span>(Cell,celltype) </span></code><code><span>write.table(meta_data, <span>'test_meta.txt'</span>, sep=<span>'\t'</span>, quote=F, row.names=F)</span></code><code><span><br></span></code><code><span><span>#矩阵文件</span></span></code><code><span><span>test</span>@assays$RNA@<span>data</span>[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]</span></code><code><span>write.table(as.matrix(<span>test</span>@assays$RNA@<span>data</span>), <span>'test_count.txt'</span>, sep=<span>'\t'</span>, quote=F)</span></code><code><span><br></span></code><code><span><span>test</span>@assays$RNA@<span>data</span>[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]</span></code><code><span><span>4</span> x <span>4</span> <span>sparse</span> Matrix <span>of</span> <span>class</span> <span>"dgCMatrix"</span></span></code><code><span>            K16733_AAACATACTCGTTT<span>-1</span> K16733_AAAGCAGAACGTTG<span>-1</span> K16733_AAAGCAGACTGAGT<span>-1</span> K16733_AAAGGCCTGCTCCT<span>-1</span></span></code><code><span>MIR1302<span>-2</span>HG                       .                       .                       .                       .</span></code><code><span>FAM138A                           .                       .                       .                       .</span></code><code><span>OR4F5                             .                       .                       .                       .</span></code><code><span>AL627309<span>.1</span>                        .                       .                       .                       .</span></code></pre></section><p><span>将上述的test_count.txt ，test_meta.txt 和 <strong><span>cellphone.db</span></strong>文件，上传到终端。</span></p><section data-mpa-template="t" mpa-from-tpl="t"><section data-style-type="1" data-tools="新媒体排版" data-id="13005" mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><section mpa-from-tpl="t"><span></span></section><section mpa-from-tpl="t"><p>二 cellphonedb 计算</p></section></section></section></section></section><p><strong>1，method-计算通讯关系</strong></p><p><span>（1）首先使用method参数进行主要的细胞通讯计算</span><span></span></p><section><ul><li></ul><pre data-lang="nginx"><code><span><span>cellphonedb</span> method statistical_analysis test_meta.txt test_count.txt --database ./cellphone.db --counts-data=gene_name --output-path</span></code></pre></section><p><span>主要参数：</span></p><p><span>--database  ：cellphonedb数据库文件</span></p><p><strong><span>--counts-data </span></strong><span>：count 矩阵是基因名格式，添加参数--counts-data=gene_name ；如果行名为ensemble名称的话，可以使用默认值。</span></p><p><span>--output-path<strong>  ：输出路径</strong></span></p><p><span>其他一些<strong>默认参数：</strong></span><span>Threshold:0.1 Iterations:1000 Debug-seed:-1 Threads:4 Precision:3</span></p><p><span>（2）运算完成后，会在输出路径下得到以下4个文件：</span></p><p><span>deconvoluted.txt：基因在亚群中的平均表达量<br>mean.txt：每对受体-配体的平均表达量<br>pvalues.txt：每对受体-配体的p值<br>significant_means.txt：每对受体-配体显著性结果的平均表达量值</span></p><h2><span><strong>2， cellphonedb可视化</strong></span></h2><p><span>cellphonedb提供了plot函数可以进行简单的可视化</span></p><section><ul><li><li><li><li></ul><pre data-lang="properties"><code><span><span>#气泡图</span></span></code><code><span><span>cellphonedb</span> <span>plot dot_plot </span></span></code><code><span><span>#热图</span></span></code><code><span><span>cellphonedb</span> <span>plot heatmap_plot test_meta.txt</span></span></code></pre></section><p><strong><span>ERROR2：如果</span></strong><span>出现如下报错<br></span></p><blockquote data-type="2" data-url="" data-author-name="" data-content-utf8-length="138" data-source-title=""><section><section>ImportError: cannot import name 'soft_unicode' from 'markupsafe' (/proj/cellphone_env2/lib/python3.7/site-packages/markupsafe/__init__.py)</section></section></blockquote><p><span>解决方式：可以将markupsafe降为2.0.1 。</span><br></p><section><ul><li></ul><pre data-lang="nginx"><code><span> <span>pip</span> install markupsafe==<span>2</span>.<span>0</span>.<span>1</span></span></code></pre></section><p><span><strong>ERROR3</strong></span>：出现如下报错，提示<span>没有ggplot2</span></p><p><img data-ratio="0.2754777070063694" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjDcQ1OqWLrmZf17IX7dpYbrTxIicVxbN72JSX7YEqaTcREDiatlBE2tT4OrhZlhuaG6DWHA0pdYm7NQ/640?wx_fmt=png" data-type="png" data-w="1884" width="1507.2" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjDcQ1OqWLrmZf17IX7dpYbrTxIicVxbN72JSX7YEqaTcREDiatlBE2tT4OrhZlhuaG6DWHA0pdYm7NQ/640?wx_fmt=png"></p><p><span>解决方式：安装R环境以及对应的R包</span></p><section><ul><li><li><li></ul><pre data-lang="sql"><code><span>conda <span>install</span> -c conda-forge r-base=<span>3.6</span><span>.2</span> <span># if not installed already</span></span></code><code><span>conda <span>install</span> -c conda-forge  r-ggplot2</span></code><code><span>conda <span>install</span> -c conda-forge r-pheatmap</span></code></pre></section><p><span>之后再运行plot即可得到以下2张图</span></p><p><img data-ratio="0.4060031595576619" data-src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjDcQ1OqWLrmZf17IX7dpYbr9RibtGVCmObSIRVyR7eK4ho5fibibqq3mibFnmq5jEPQghicYlicFIMMJ7VA/640?wx_fmt=png" data-type="png" data-w="1266" width="1012.8" src="https://mmbiz.qpic.cn/mmbiz_png/Y21ubvXhTjDcQ1OqWLrmZf17IX7dpYbr9RibtGVCmObSIRVyR7eK4ho5fibibqq3mibFnmq5jEPQghicYlicFIMMJ7VA/640?wx_fmt=png"></p><p><span>至此cellphonedb的主要分析就完</span><span>成了！</span></p><p><span>A：当然希望你不会遇到以上ERROR，如果遇到了那就解决就完事。</span><span></span></p><p><span>B：当然也可以根据method得到的4个结果文件，使用ggplot2或其他R包自行绘制 （以待后续）。</span></p><p><span></span><strong><span>参考资料：</span><span> </span><span>https://github.com/Teichlab/cellphonedb</span></strong></p><section data-style-type="7" data-tools="新媒体排版" data-id="9190"><p><span data-txtless="spin" data-txtlessp="120">◆ </span><span></span><span>◆ </span><span></span><span data-txtless="spin" data-txtlessp="-120">◆  <span data-txtless="spin" data-txtlessp="120">◆ </span><span>◆</span></span><span></span></p></section><p cid="n94" mdtype="paragraph"><span md-inline="plain"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650398215&amp;idx=1&amp;sn=730225fb5ba3a51ceb8df0a531632515&amp;chksm=f01cbce7c76b35f1bebbf327d78a51d859770a46ae1329d362e3b705c4f8765ee2dc461d24dc&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" wah-hotarea="click" hasload="1">精心整理（含图PLUS版）|R语言生信分析，可视化</a>（R统计，ggplot2绘图，生信图形可视化汇总）</span></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/1db_kayObhlHVZlt1eNlpw",target="_blank" rel="noopener noreferrer">原文链接</a>
