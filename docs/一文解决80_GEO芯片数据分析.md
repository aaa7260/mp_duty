---
title: "一文解决80%GEO芯片数据分析"
date: 2022-10-31T14:12:28Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
一文解决80%GEO芯片数据分析 by 生信菜鸟团
------
<div><section><mpprofile data-pluginname="mpprofile" data-id="Mzg5MjcxNzg1NA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqXDVibOSKuMOqUibHl7k8Xfd3d4IcTzXnLEicrnRKUMdadYVFiccABRBh7NpKVANzYmtFXqKtYpP5g8ag/0?wx_fmt=png" data-nickname="生信随笔" data-alias="Bio_NGS" data-signature="NGS多组学在肿瘤中的应用，生信工程师的成长之旅。" data-from="0"></mpprofile></section><h3 cid="n2" mdtype="heading"><span>前言</span><br></h3><p>本文写了一个通用性的GEO芯片处理流程，个人觉得能够解决80%以上的芯片数  据处理问题。包括数据的下载，ID转换和清洗，质控，以及差异分析。</p><p><br></p><p>对于初学者来说，R语言的进阶学习：</p><ul><li><p>一是要掌握以项目管理的方式，即R-project管理代码和数据，详见 <a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247485306&amp;idx=1&amp;sn=6891d31bfd0b0f83adf8720fa3a520d4&amp;scene=21#wechat_redirect" textvalue="R-project管理多个R工作目录" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2">R-project管理多个R工作目录</a>；</p><p><br></p></li><li><p>二是要学会写循环，最基本的是for循环，这里可以看《R语言实战》的第5章，《R数据科学》的第16章；</p><p><br></p></li><li><p>三是要学会写函数和脚本，把函数封装进一个`.R`后缀的脚本，需要使用时source一下，这样避免重复造轮子，函数的思想可以看《R语言实战》的第20章，《R数据科学》的第14章。实际上，R脚本在包装一下，就是一个R包。</p></li></ul><p><span><br></span></p><p><span>以GEO芯片数据实战为例，希望</span><span>给R语言初学者</span><span>抛砖引玉</span><span>。</span><span>在 https://www.ncbi.nlm.nih.gov/geo/ 得到我们想要下载的G</span><span>SE ID后，在R语言环境进行下载处理：</span><br></p><h3 cid="n2" mdtype="heading"><span md-inline="plain">Step1. 数据下载</span></h3><pre spellcheck="false" lang="{r}" cid="n3" mdtype="fences"><span role="presentation"><span># 加载R包</span></span><br><span role="presentation"><span># install.packages("tinyarray")</span></span><br><span role="presentation"><span># install.packages('AnnoProbe')</span></span><br><span role="presentation"><span># 加载R包</span></span><br><span role="presentation"><span>library</span>(<span>dplyr</span>)</span><br><span role="presentation"><span>library</span>(<span>openxlsx</span>)</span><br><span role="presentation"><span>library</span>(<span>stringr</span>)</span><br><span role="presentation"><span>library</span>(<span>limma</span>)</span><br><span role="presentation"><span>library</span>(<span>tidyverse</span>)</span><br><span role="presentation"><span>library</span>(<span>ggplot2</span>)</span><br><span role="presentation"><span>library</span>(<span>patchwork</span>)</span><br><span role="presentation"><span>library</span>(<span>GEOquery</span>)</span><br><span role="presentation"><span>library</span>(<span>tinyarray</span>)</span><br><span role="presentation"><span>library</span>(<span>tidyverse</span>)</span><br><span role="presentation"><span>library</span>(<span>readr</span>)</span><br><span role="presentation"><span>options</span>(<span>stringsAsFactors</span> <span>=</span> <span>FALSE</span>) <span>#禁止chr转成factor</span></span><br><span role="presentation"><span>source</span>(<span>"D:/Rdata/Code/database/source_code/GEO_download.R"</span>)</span></pre><p cid="n4" mdtype="paragraph"><span md-inline="plain">这里source的是我自定义的函数，已打包进一个R脚本。后台回 复“ GEO ”即可获取。</span></p><p cid="n5" mdtype="paragraph"><span md-inline="plain">其中包括一个</span><span md-inline="code" spellcheck="false"><code>downGSE(studyID = GSE号, destdir = 下载文件储存的目录)</code></span><span md-inline="plain">下载函数：</span><span md-inline="plain"></span></p><pre spellcheck="false" lang="R" cid="n15" mdtype="fences"><span role="presentation"><span>## 1.source下载所需的自定义函数</span></span><br><span role="presentation"><span>downGSE</span> <span>&lt;-</span> <span>function</span>(<span>studyID</span> <span>=</span> <span>"GSE1009"</span>, <span>destdir</span> <span>=</span> <span>"."</span>,<span>rdsSave</span> <span>=</span> <span>T</span>) {</span><br><span role="presentation"> <span>library</span>(<span>GEOquery</span>)</span><br><span role="presentation"> <span>Sys.setenv</span>(<span>"VROOM_CONNECTION_SIZE"</span><span>=</span><span>131072</span><span>*</span><span>6</span>)</span><br><span role="presentation"> <span>eSet</span> <span>&lt;-</span> <span>getGEO</span>(<span>studyID</span>, <span>destdir</span> <span>=</span> <span>destdir</span>, <span>getGPL</span> <span>=</span> <span>F</span>)</span><br><span role="presentation"> <span>if</span>(<span>length</span>(<span>eSet</span>) <span>==</span> <span>1</span>){</span><br><span role="presentation">   <span>exprSet</span> <span>=</span> <span>exprs</span>(<span>eSet</span>[[<span>1</span>]]) <span>#得到表达矩阵，此时的列名为探针序列，expreSet的结果与方法一得到的gset是一致的</span></span><br><span role="presentation">   <span>phenoDat</span> <span>=</span> <span>pData</span>(<span>eSet</span>[[<span>1</span>]]) <span>#得到样本分类信息</span></span><br><span role="presentation">   <span>write.csv</span>(<span>exprSet</span>, <span>paste0</span>(<span>studyID</span>, <span>"_exprSet.csv"</span>)) <span>#保存表达矩阵</span></span><br><span role="presentation">   <span>write.csv</span>(<span>phenoDat</span>, <span>paste0</span>(<span>studyID</span>, <span>"_metadata.csv"</span>)) <span>#保存样本信息</span></span><br><span role="presentation">}</span><br><span role="presentation"> </span><br><span role="presentation"> <span>if</span>(<span>length</span>(<span>eSet</span>) <span>&gt;</span> <span>1</span>){</span><br><span role="presentation">   <span>for</span> (<span>i</span> <span>in</span> <span>1</span><span>:</span><span>length</span>(<span>eSet</span>)) {</span><br><span role="presentation">     <span>gset</span> <span>=</span> <span>exprs</span>(<span>eSet</span>[[<span>i</span>]]) <span>%&gt;%</span> <span>as.data.frame</span>()</span><br><span role="presentation">     <span>head</span>(<span>gset</span>)</span><br><span role="presentation">     <span>write.csv</span>(<span>gset</span>, <span>paste0</span>(<span>studyID</span>,<span>"_"</span>,<span>i</span>, <span>"_exprSet.csv"</span>)) <span>#保存表达矩阵</span></span><br><span role="presentation">     </span><br><span role="presentation">     <span>phenoDat</span> <span>=</span> <span>pData</span>(<span>eSet</span>[[<span>i</span>]]) <span>%&gt;%</span> <span>as.data.frame</span>()</span><br><span role="presentation">     <span>head</span>(<span>phenoDat</span>)</span><br><span role="presentation">     <span>write.csv</span>(<span>phenoDat</span>, <span>paste0</span>(<span>studyID</span>,<span>"_"</span>,<span>i</span>, <span>"_metadata.csv"</span>)) <span>#保存样本信息</span></span><br><span role="presentation">     </span><br><span role="presentation">     <span>assign</span>(<span>paste0</span>(<span>"gset_"</span>,<span>i</span>),<span>gset</span>)</span><br><span role="presentation">     <span>assign</span>(<span>paste0</span>(<span>"phenoDat_"</span>,<span>i</span>),<span>phenoDat</span>)</span><br><span role="presentation">  }</span><br><span role="presentation">}</span><br><br><span role="presentation"> <span>#自定义了一个函数，可以查看该数据集包含了几个表达数据</span></span><br><span role="presentation"> <span>if</span>(<span>rdsSave</span> <span>==</span> <span>T</span>){</span><br><span role="presentation">   <span>#保存一下</span></span><br><span role="presentation">   <span>saveRDS</span>(<span>eSet</span>,<span>file</span> <span>=</span> <span>paste0</span>(<span>destdir</span>,<span>"/Step1."</span>,<span>studyID</span>,<span>"_eSet.rds"</span>))</span><br><span role="presentation">   <span>warning</span>(<span>paste0</span>(<span>"eSet was saved as RDS file in "</span>,<span>destdir</span>,<span>"/"</span>))  </span><br><span role="presentation">}</span><br><span role="presentation"> <span>else</span> {</span><br><span role="presentation">   <span>warning</span>(<span>paste0</span>(<span>"Attention: eSet was not saved"</span>))    </span><br><span role="presentation">}</span><br><span role="presentation"> <span>warning</span>(<span>paste0</span>(<span>"Attention: There may be "</span>,<span>length</span>(<span>eSet</span>),<span>"</span> <span>expression data in "</span>,<span>studyID</span>))</span><br><span role="presentation"> <span>print</span>(<span>paste0</span>(<span>"Including:"</span>))</span><br><span role="presentation"> <span>for</span> (<span>i</span> <span>in</span> <span>1</span><span>:</span><span>length</span>(<span>eSet</span>)) {</span><br><span role="presentation">   <span>print</span>(<span>paste</span>(<span>paste0</span>(<span>i</span>,<span>"."</span>),<span>paste0</span>(<span>"gset_"</span>,<span>i</span>),<span>paste0</span>(<span>"phenoDat_"</span>,<span>i</span>),<span>"and"</span>,<span>eSet</span>[[<span>i</span>]]@<span>annotation</span>))</span><br><span role="presentation">}</span><br><span role="presentation"> <span>return</span>(<span>eSet</span>)</span><br><span role="presentation">}</span></pre><p cid="n16" mdtype="paragraph"><span md-inline="plain">利用自定义的函数下载目标数据集：</span></p><pre spellcheck="false" lang="{r}" cid="n8" mdtype="fences"><span role="presentation"><span>dir.create</span>(<span>"data"</span>)</span><br><span role="presentation"><span>eSet</span> <span>=</span> <span>downGSE</span>(<span>"GSE99339"</span>,</span><br><span role="presentation">              <span>destdir</span> <span>=</span> <span>"./data/"</span>, <span>#指定下载文件储存的目录，默认是当前目录“./”</span></span><br><span role="presentation">              <span>rdsSave</span> <span>=</span> <span>T</span>) <span># Ture代表save当前的eSet为rds文件</span></span><br><span role="presentation"><span># eSet = read_rds("./Step1.GSE99339_eSet.rds")</span></span></pre><p cid="n9" mdtype="paragraph"><span md-inline="plain">注意，有的一个GSE号会含多个平台的测序数据，这个示例就包含两个平台的数据。</span><span md-inline="code" spellcheck="false"><code>downGSE()</code></span><span md-inline="plain">函数会给出Attention和所含的表达矩阵gset，表型信息phenoData和响应的GPL号。</span></p><p><img data-galleryid="" data-ratio="0.2736156351791531" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqVaqX5KvuO1f87APyaJ6ZOathaAw7FFK9Z3ibqkOH2arGO8OUTp2mAQADO62Uwgic610ZV0OAD5OoOw/640?wx_fmt=png" data-type="png" data-w="614" src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqVaqX5KvuO1f87APyaJ6ZOathaAw7FFK9Z3ibqkOH2arGO8OUTp2mAQADO62Uwgic610ZV0OAD5OoOw/640?wx_fmt=png"><span></span></p><h3 cid="n11" mdtype="heading"><span md-inline="plain">Step2. 数据读取</span></h3><pre spellcheck="false" lang="{r}" cid="n12" mdtype="fences"><span role="presentation"><span>names</span>(<span>eSet</span>)</span><br><br><span role="presentation"><span>for</span> (<span>i</span> <span>in</span> <span>1</span><span>:</span><span>length</span>(<span>eSet</span>)) {</span><br><span role="presentation"> <span>gset</span> <span>=</span> <span>exprs</span>(<span>eSet</span>[[<span>i</span>]]) <span>%&gt;%</span> <span>as.data.frame</span>()</span><br><span role="presentation"> <span>head</span>(<span>gset</span>)</span><br><span role="presentation"> </span><br><span role="presentation"> <span>phenoDat</span> <span>=</span> <span>pData</span>(<span>eSet</span>[[<span>i</span>]]) <span>%&gt;%</span> <span>as.data.frame</span>()</span><br><span role="presentation"> <span>head</span>(<span>phenoDat</span>)</span><br><span role="presentation"> </span><br><span role="presentation"> <span>assign</span>(<span>paste0</span>(<span>"gset_"</span>,<span>i</span>),<span>gset</span>)</span><br><span role="presentation"> <span>assign</span>(<span>paste0</span>(<span>"phenoDat_"</span>,<span>i</span>),<span>phenoDat</span>)</span><br><span role="presentation"> <span>rm</span>(<span>gset</span>,<span>phenoDat</span>)</span><br><span role="presentation">}</span><br><br><span role="presentation"><span>## 检查表型数据和表达数据是否对应</span></span><br><span role="presentation"><span>gset_1</span> <span>%&gt;%</span> <span>head</span>()</span><br><span role="presentation"><span>phenoDat_1</span> <span>%&gt;%</span> <span>head</span>()</span><br><span role="presentation"><span>dim</span>(<span>gset_1</span>)</span><br><span role="presentation"><span>dim</span>(<span>phenoDat_1</span>)</span><br><span role="presentation"><span># 如果是Ture，说明表型数据和表达数据一一对应</span></span><br><span role="presentation"><span>colnames</span>(<span>gset_1</span>) <span>==</span> <span>phenoDat_1</span><span>$</span><span>geo_accession</span></span><br><br><span role="presentation"><span># 第二个数据集</span></span><br><span role="presentation"><span>gset_2</span> <span>%&gt;%</span> <span>head</span>()</span><br><span role="presentation"><span>phenoDat_2</span> <span>%&gt;%</span> <span>head</span>()</span><br><span role="presentation"><span>colnames</span>(<span>gset_2</span>) <span>==</span> <span>phenoDat_2</span><span>$</span><span>geo_accession</span></span></pre><h3 cid="n13" mdtype="heading"><span md-inline="plain">Step3. ID转换注释</span></h3><p cid="n14" mdtype="paragraph"><span md-inline="plain">首先获取数据集包含的GPL ID及文件:</span></p><pre spellcheck="false" lang="{r}" cid="n15" mdtype="fences"><span role="presentation"><span>### 3.1 GPL获取</span></span><br><span role="presentation"><span>names</span>(<span>eSet</span>) <span>#该数据集包含两个表达数据及GPL</span></span><br><span role="presentation"><span>gpl_1</span> <span>&lt;-</span> <span>getGEO</span>(<span>"gpl19109"</span>, <span>AnnotGPL</span><span>=</span><span>FALSE</span>, <span>destdir</span><span>=</span><span>"./data/"</span>)</span><br><span role="presentation"><span>gpl_2</span> <span>&lt;-</span> <span>getGEO</span>(<span>"gpl19184"</span>, <span>AnnotGPL</span><span>=</span><span>FALSE</span>, <span>destdir</span><span>=</span><span>"./data/"</span>)</span></pre><p cid="n16" mdtype="paragraph"><span md-inline="plain">找到GPL里的探针及基因名称，然后对探针开始注释：</span></p><pre spellcheck="false" lang="{r}" cid="n17" mdtype="fences"><span role="presentation"><span>### 3.2 gpl_1</span></span><br><span role="presentation"><span>## 3.2.1 找到gpl对应的探针就基因ID  </span></span><br><span role="presentation"><span>head</span>(<span>Table</span>(<span>gpl_1</span>))</span></pre><p><img data-galleryid="" data-ratio="0.20207852193995382" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqVaqX5KvuO1f87APyaJ6ZOaPMooNVxpu2h0IKwfS48WlRTVg337fWzyqAhQbyHPsxFqkqDm41oiaIw/640?wx_fmt=png" data-type="png" data-w="866" src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqVaqX5KvuO1f87APyaJ6ZOaPMooNVxpu2h0IKwfS48WlRTVg337fWzyqAhQbyHPsxFqkqDm41oiaIw/640?wx_fmt=png"><span></span></p><p cid="n19" mdtype="paragraph"><span md-inline="plain">注意，不同平台提供的探针注释不一样，有的平台提供了我们想要的symbol ID；而少数情况没有提供symbol ID，而是ENTERZ ID，ENSEMBEL ID，SPOT ID等等其他乱七八糟的ID，总之，这些ID选择一个即可。</span></p><p cid="n20" mdtype="paragraph"><span md-inline="plain">可以看到示例数据的这个平台提供了探针ID（第一列），还有ENTERZ ID（第三列），把这两个信息提取出来：</span></p><pre spellcheck="false" lang="R" cid="n21" mdtype="fences"><span role="presentation"><span># 这里需要根据情况变化，选取第一列为探针名，第二列为geneID, geneID可以是SYMBOL, ENTREZID或ENSEMBEL ID等等</span></span><br><span role="presentation"><span>ids1</span> <span>=</span> <span>Table</span>(<span>gpl_1</span>)[,<span>c</span>(<span>1</span>,<span>3</span>)]</span><br><span role="presentation"><span>colnames</span>(<span>ids1</span>) <span>=</span> <span>c</span>(<span>"ID"</span>,<span>"geneID"</span>)</span></pre><p cid="n22" mdtype="paragraph"><span md-inline="plain">我自定义的函数脚本</span><span md-inline="code" spellcheck="false"><code>GEO_download.R</code></span><span md-inline="plain">还有一个</span><span md-inline="code" spellcheck="false"><code>sigleGSE()</code></span><span md-inline="plain">函数，用于清洗数据：</span></p><pre spellcheck="false" lang="R" cid="n23" mdtype="fences"><span role="presentation"><span>## 3.2.2 开始注释</span></span><br><span role="presentation"><span># 过滤</span></span><br><span role="presentation"><span>gset_1</span> <span>=</span> <span>gset_1</span>[<span>rownames</span>(<span>gset_1</span>) <span>%in%</span> <span>ids1</span><span>$</span><span>ID</span>,]</span><br><span role="presentation"> </span><br><span role="presentation"><span># 修改ids探针的顺序，与表达矩阵一致</span></span><br><span role="presentation"><span>ids1</span><span>=</span><span>ids1</span>[<span>match</span>(<span>rownames</span>(<span>gset_1</span>),<span>ids1</span><span>$</span><span>ID</span>),]</span><br><span role="presentation"> </span><br><span role="presentation"><span># 使用我自定义的模板函数清洗数据</span></span><br><span role="presentation"><span>gset_1</span> <span>&lt;-</span> <span>sigleGSE</span>(<span>gset_1</span>,<span>ids1</span>)</span><br><span role="presentation"> </span><br><span role="presentation"><span># 将表达矩阵探针序列替换为基因名称，得到最终的表达矩阵</span></span><br><span role="presentation"><span>rownames</span>(<span>gset_1</span>)<span>=</span><span>ids1</span>[<span>match</span>(<span>rownames</span>(<span>gset_1</span>), <span>ids1</span><span>$</span><span>ID</span>),<span>2</span>]</span></pre><p cid="n24" mdtype="paragraph"><span md-inline="plain">如果在GPL中没有找到symbol ID，而是其他的，比如这里的ENTREZ ID，这里的代码将进一步转换：</span></p><pre spellcheck="false" lang="{r}" cid="n25" mdtype="fences"><span role="presentation"><span>## 3.2.3 如果需要ID转换</span></span><br><span role="presentation"><span>gset_1</span> <span>=</span> <span>geneID_transform</span>(<span>input.data</span> <span>=</span> <span>gset_1</span>, <span>species</span> <span>=</span> <span>"human"</span>,</span><br><span role="presentation">                <span>fromType</span> <span>=</span> <span>"ENTREZID"</span>,<span>toType</span> <span>=</span> <span>c</span>(<span>"SYMBOL"</span>))</span><br><br><span role="presentation"><span># 保存</span></span><br><span role="presentation"><span>openxlsx</span><span>::</span><span>write.xlsx</span>(<span>list</span>(<span>gset_1</span>,<span>phenoDat_1</span>),</span><br><span role="presentation">                    <span>sheetName</span> <span>=</span> <span>list</span>(<span>"Expression data"</span>,<span>"Phenotype"</span>),</span><br><span role="presentation">                    <span>file</span> <span>=</span> <span>"./data/Expression_clinical_data_1.xlsx"</span>,</span><br><span role="presentation">                    <span>asTable</span> <span>=</span> <span>T</span>,</span><br><span role="presentation">                    <span>fontSize</span> <span>=</span> <span>12</span>,</span><br><span role="presentation">                    <span>rowNames</span> <span>=</span><span>T</span>)    </span></pre><p cid="n26" mdtype="paragraph"><span md-inline="plain">如果某个数据集含多个GPL和表达数据集，重复运行上面的代码即可：</span></p><pre spellcheck="false" lang="{r}" cid="n27" mdtype="fences"><span role="presentation"><span>### 3.3 gpl_2</span></span><br><span role="presentation"><span>## 3.3.1 找到gpl对应的探针就基因ID  </span></span><br><span role="presentation"><span>head</span>(<span>Table</span>(<span>gpl_2</span>))</span><br><span role="presentation"><span># 这里需要根据情况变化，选取第一列为探针名，第二列为geneID, geneID可以是SYMBOL, ENTREZID或ENSEMBEL ID等等</span></span><br><span role="presentation"><span>ids2</span> <span>=</span> <span>Table</span>(<span>gpl_2</span>)[,<span>c</span>(<span>1</span>,<span>2</span>)]</span><br><span role="presentation"><span>colnames</span>(<span>ids2</span>) <span>=</span> <span>c</span>(<span>"ID"</span>,<span>"geneID"</span>)</span><br><br><span role="presentation"><span>## 3.3.2 开始注释</span></span><br><span role="presentation"><span># 过滤</span></span><br><span role="presentation"><span>gset_2</span> <span>=</span> <span>gset_2</span>[<span>rownames</span>(<span>gset_2</span>) <span>%in%</span> <span>ids2</span><span>$</span><span>ID</span>,]</span><br><br><span role="presentation"><span># 修改ids探针的顺序，与表达矩阵一致</span></span><br><span role="presentation"><span>ids2</span><span>=</span><span>ids2</span>[<span>match</span>(<span>rownames</span>(<span>gset_2</span>),<span>ids1</span><span>$</span><span>ID</span>),]</span><br><br><span role="presentation"><span># 使用模板函数清洗数据</span></span><br><span role="presentation"><span>gset_2</span> <span>&lt;-</span> <span>sigleGSE</span>(<span>gset_2</span>,<span>ids1</span>)</span><br><br><span role="presentation"><span># 将表达矩阵探针序列替换为基因名称，得到最终的表达矩阵</span></span><br><span role="presentation"><span>rownames</span>(<span>gset_2</span>)<span>=</span><span>ids1</span>[<span>match</span>(<span>rownames</span>(<span>gset_2</span>), <span>ids1</span><span>$</span><span>ID</span>),<span>2</span>]</span><br><br><span role="presentation"><span>## 3.2.3 如果需要ID转换</span></span><br><span role="presentation"><span>gset_2</span> <span>=</span> <span>geneID_transform</span>(<span>input.data</span> <span>=</span> <span>gset_2</span>, <span>species</span> <span>=</span> <span>"human"</span>,</span><br><span role="presentation">                         <span>fromType</span> <span>=</span> <span>"ENTREZID"</span>,<span>toType</span> <span>=</span> <span>c</span>(<span>"SYMBOL"</span>))</span><br><br><span role="presentation"><span># 保存</span></span><br><span role="presentation"><span>openxlsx</span><span>::</span><span>write.xlsx</span>(<span>list</span>(<span>gset_2</span>,<span>phenoDat_2</span>),</span><br><span role="presentation">                    <span>sheetName</span> <span>=</span> <span>list</span>(<span>"Expression data"</span>,<span>"Phenotype"</span>),</span><br><span role="presentation">                    <span>file</span> <span>=</span> <span>"./data/Expression_clinical_data_2.xlsx"</span>,</span><br><span role="presentation">                    <span>asTable</span> <span>=</span> <span>T</span>,</span><br><span role="presentation">                    <span>fontSize</span> <span>=</span> <span>12</span>,</span><br><span role="presentation">                    <span>rowNames</span> <span>=</span><span>T</span>)  </span><br><br><span role="presentation"><span>### 3.3 如果还有更多的表达数据，如上同样的处理</span></span></pre><h3 cid="n28" mdtype="heading"><span md-inline="plain">Step4. 质控</span></h3><pre spellcheck="false" lang="{r}" cid="n29" mdtype="fences"><span role="presentation"><span>### Step4. 质控</span></span><br><span role="presentation"><span>## 4.1 看一下原表达矩阵是否经过log转换</span></span><br><span role="presentation"><span>range</span>(<span>gset_1</span>)</span><br><span role="presentation"><span>range</span>(<span>gset_2</span>)</span><br><br><span role="presentation"><span>## 4.2 分组，这里需要根据文章给的内容将原本进行分组</span></span><br><span role="presentation"><span># 这里的分组信息即为title</span></span><br><span role="presentation"><span>table</span>(<span>phenoDat_1</span><span>$</span><span>title</span>)</span><br><br><span role="presentation"><span># 处理,根据不同数据集灵活变化</span></span><br><span role="presentation"><span>phenoDat_1</span><span>$</span><span>group</span> <span>=</span> <span>str_split</span>(<span>phenoDat_1</span><span>$</span><span>title</span>,<span>"[</span><span>\\</span><span>[]"</span>,<span>simplify</span> <span>=</span> <span>T</span>)[,<span>1</span>]</span><br><span role="presentation"><span>table</span>(<span>phenoDat_1</span><span>$</span><span>group</span>)</span><br><br><span role="presentation"><span>phenoDat_1</span><span>$</span><span>group</span> <span>=</span> <span>recode</span>(<span>phenoDat_1</span><span>$</span><span>group</span>,</span><br><span role="presentation">                       <span>"Diabetic Nephropathy "</span> <span>=</span> <span>"DN"</span>,</span><br><span role="presentation">                       <span>"Focal and Segmental Glomerulosclerosis "</span> <span>=</span> <span>"FSG"</span>,</span><br><span role="presentation">                       <span>"Minimal Change Disease "</span> <span>=</span> <span>"MCD"</span>,</span><br><span role="presentation">                       <span>"Rapidly Progressive Glomerulonephritis "</span> <span>=</span> <span>"RPG"</span>,</span><br><span role="presentation">                       <span>"Tumor Nephrectomy "</span> <span>=</span> <span>"TN"</span>)</span><br><span role="presentation"><span>table</span>(<span>phenoDat_1</span><span>$</span><span>group</span>)</span><br><span role="presentation"><span>phenoDat_1</span><span>$</span><span>group</span> <span>%&gt;%</span> <span>as.factor</span>()</span><br><br><span role="presentation"><span>## 4.3下面是对最终得到的表达矩阵进行质控，有很多策略进行质控，这里是三种常用的策略；</span></span><br><span role="presentation"><span>## 存在合并数据的情况的话，我们也对批次batch进行了质控：</span></span><br><span role="presentation"><span>## 4.3.1 箱式图及管家基因</span></span><br><span role="presentation"><span>boxplot</span>(<span>gset_1</span>[,<span>1</span>])</span><br><span role="presentation"><span>gset_1</span>[<span>"GAPDH"</span>,] <span>%&gt;%</span> <span>as.numeric</span> <span>%&gt;%</span> <span>median</span>()</span><br><span role="presentation"><span>gset_1</span>[<span>"ACTB"</span>,] <span>%&gt;%</span> <span>as.numeric</span> <span>%&gt;%</span> <span>median</span>()</span><br><span role="presentation"><span>p1</span> <span>=</span> <span>boxplot</span>(<span>gset_1</span>)</span></pre><p><img data-galleryid="" data-ratio="0.4679186228482003" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqVaqX5KvuO1f87APyaJ6ZOaCg3hd9UfNicm6zjh4OpX7z036mb8A6c7rwTSJ5WDPd0HabYXL58bg3g/640?wx_fmt=png" data-type="png" data-w="639" src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqVaqX5KvuO1f87APyaJ6ZOaCg3hd9UfNicm6zjh4OpX7z036mb8A6c7rwTSJ5WDPd0HabYXL58bg3g/640?wx_fmt=png"><span></span></p><pre mdtype="fences" cid="n40" lang="R" spellcheck="false"><span role="presentation"><span>## 4.3.2 PCA图</span></span><br><span role="presentation"><span>pca_plot</span> <span>=</span> <span>draw_pca</span>(<span>gset_1</span>, <span>phenoDat_1</span><span>$</span><span>group</span>)</span><br><span role="presentation"><span>pca_plot</span></span></pre><p><img data-galleryid="" data-ratio="0.7978883861236803" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqVaqX5KvuO1f87APyaJ6ZOaSO9m6148lDjAPK8Bh0zvTJ4wItQKsVNa59FWwmcOLRfR1CbxRShNng/640?wx_fmt=png" data-type="png" data-w="663" src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqVaqX5KvuO1f87APyaJ6ZOaSO9m6148lDjAPK8Bh0zvTJ4wItQKsVNa59FWwmcOLRfR1CbxRShNng/640?wx_fmt=png"><span></span></p><h3 cid="n31" mdtype="heading"><span md-inline="plain">Step5. 差异分析</span></h3><pre spellcheck="false" lang="R" cid="n32" mdtype="fences"><span role="presentation"><span>### Step5. limma差异分析</span></span><br><span role="presentation"><span>group_list</span> <span>=</span> <span>dplyr</span><span>::</span><span>filter</span>(<span>phenoDat_1</span>,<span>group</span> <span>%in%</span> <span>c</span>(<span>"DN"</span>,<span>"MCD"</span>))</span><br><span role="presentation"><span>input_data</span> <span>=</span> <span>gset_1</span>[,<span>group_list</span><span>$</span><span>geo_accession</span>]</span><br><span role="presentation"><span>group_list</span> <span>=</span> <span>group_list</span><span>$</span><span>group</span> <span>%&gt;%</span> <span>factor</span>(<span>levels</span> <span>=</span> <span>c</span>(<span>"DN"</span>,<span>"MCD"</span>))</span><br><br><span role="presentation"><span>### 5.1 差异分析</span></span><br><span role="presentation"><span>nrDEG_1</span> <span>=</span> <span>limmaDEG</span>(<span>exp</span> <span>=</span> <span>input_data</span>,<span>group_list</span> <span>=</span> <span>group_list</span>,</span><br><span role="presentation">         <span>logFC_cutoff</span> <span>=</span> <span>1</span>,</span><br><span role="presentation">         <span>pvalue_cutoff</span> <span>=</span> <span>0.05</span>,</span><br><span role="presentation">         <span>adjust</span> <span>=</span> <span>TRUE</span>,</span><br><span role="presentation">         <span>entriz</span> <span>=</span> <span>TRUE</span>,</span><br><span role="presentation">         <span>species</span><span>=</span> <span>"human"</span>)</span><br><span role="presentation"><span># 保存</span></span><br><span role="presentation"><span>save</span>(<span>gset_1</span>,<span>phenoDat_1</span>,<span>nrDEG_1</span>,</span><br><span role="presentation">    <span>file</span><span>=</span> <span>"./data/Expression_clinical_nrDEG_data_1.Rdata"</span>)</span><br><br><span role="presentation"><span>### 5.2 火山图</span></span><br><span role="presentation"><span>volcano_plot</span> <span>=</span> <span>draw_volcano</span>(<span>nrDEG_1</span>, <span>pkg</span> <span>=</span> <span>4</span>,<span>pvalue_cutoff</span> <span>=</span> <span>0.05</span>, <span>logFC_cutoff</span> <span>=</span> <span>0.5</span>, </span><span role="presentation"><span>adjust</span> <span>=</span> <span>FALSE</span>, <span>symmetry</span> <span>=</span> <span>F</span>, </span><span role="presentation"> <span>color</span> <span>=</span> <span>c</span>(<span>"#2874C5"</span>,<span>"grey"</span>, <span>"#f87669"</span>))</span><br><span role="presentation"><span>volcano_plot</span></span><br><br><span role="presentation"><span>### 5.3热图</span></span><br><span role="presentation"><span>heatmap_plot</span> <span>=</span> <span>plotheatmap</span>( <span>input_data</span> <span>=</span> <span>input_data</span>, <span>group_list</span> <span>=</span> <span>group_list</span>, <span>nrDEG</span> <span>=</span> <span>nrDEG_1</span>,</span><span role="presentation"><span>gene_number</span> <span>=</span> <span>30</span>, <span>show_rownames</span> <span>=</span> <span>FALSE</span>, <span>show_column_title</span> <span>=</span> <span>T</span>, </span><span role="presentation"><span>scale_before</span> <span>=</span> <span>FALSE</span>, <span>n_cutoff</span> <span>=</span> <span>3</span>, <span>cluster_cols</span> <span>=</span> <span>TRUE</span>, <span>annotation_legend</span> <span>=</span> <span>FALSE</span>,</span><span role="presentation"><span>legend</span> <span>=</span> <span>FALSE</span></span><span role="presentation">)                    </span><br><br><span role="presentation"><span>volcano_plot</span> <span>|</span> <span>heatmap_plot</span></span></pre><p><img data-galleryid="" data-ratio="0.5260821309655938" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqVaqX5KvuO1f87APyaJ6ZOanHeF2ibIUiazTchGEVHkBEuqeEZDUbGFRHdU2hYWiaViaTCNHuicpJia6QRA/640?wx_fmt=png" data-type="png" data-w="901" src="https://mmbiz.qpic.cn/mmbiz_png/fTW9zRI3eqVaqX5KvuO1f87APyaJ6ZOanHeF2ibIUiazTchGEVHkBEuqeEZDUbGFRHdU2hYWiaViaTCNHuicpJia6QRA/640?wx_fmt=png"><span></span></p><blockquote cid="n34" mdtype="blockquote"><p cid="n35" mdtype="paragraph"><span md-inline="plain">注：部分代码改编自小洁老师的R包tinyarray 见</span><span md-inline="link"><a href="https://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247491659&amp;idx=1&amp;sn=34d3ae0cbb627c1b9c839d7353b2aada&amp;scene=21#wechat_redirect" data-linktype="2"><span md-inline="plain">宝藏R包tinyarray：常用图表一键收走</span></a></span></p><p cid="n36" mdtype="paragraph"><span md-inline="plain">这个R包本身的函数写得非常好，但是和我分析的习惯略有不同。一来是为了整理我之前的处理R代码，二来是比较我和小洁老师的处理<span>流程，因此做了一些整理和改编。</span></span></p></blockquote></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/nl5tVxrdjAxrXF8islD4kg",target="_blank" rel="noopener noreferrer">原文链接</a>
