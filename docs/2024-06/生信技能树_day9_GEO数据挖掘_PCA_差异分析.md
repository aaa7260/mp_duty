---
title: "生信技能树-day9 GEO数据挖掘-PCA、差异分析"
date: 2024-06-21T00:29:17Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
生信技能树-day9 GEO数据挖掘-PCA、差异分析 by 生信菜鸟团
------
<div><blockquote data-tool="mdnice编辑器"><p><span>从我们</span><span>生信技能树</span><span>历年的几千个马拉松授课学员里面募集了一些优秀的创作者，某种意义来说是传承了我们生信技能树的知识整理和分享的思想！</span></p></blockquote><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">今天的是三周合计15天的数据挖掘授课学员一点一滴整理的授课知识点笔记哦，还有互动练习题哈，欢迎大家点击文末的阅读原文去关注我们学员的公众号哦！</p><p><img data-galleryid="" data-imgfileid="100039951" data-ratio="0.9869791666666666" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicZWFXx8AD2QqR5r26iaEib7iaTAeenkZojmCFn9w4mCdFoicJMx4AQ3q11rUoUaJn8lUjibicBWzLIhSAQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1536" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicZWFXx8AD2QqR5r26iaEib7iaTAeenkZojmCFn9w4mCdFoicJMx4AQ3q11rUoUaJn8lUjibicBWzLIhSAQ/640?wx_fmt=png&amp;from=appmsg"></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span>PCA图、top1000基因热图</span></h1><pre data-tool="mdnice编辑器"><code>rm(list = ls())  <br>load(file = <span>"step2output.Rdata"</span>)<br><span>#输入数据：exp和Group</span><br></code></pre><ol data-tool="mdnice编辑器"><li><section>PCA 图</section></li></ol><pre data-tool="mdnice编辑器"><code>dat=as.data.frame(t(exp))<br><span>#根据sthda上的示例数据，更改自己的数据，需要转置后转为dataframe</span><br></code></pre><p data-tool="mdnice编辑器"><strong>Principal Component Analysis</strong></p><p data-tool="mdnice编辑器">http://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/112-pca-principal-component-analysis-essentials</p><pre data-tool="mdnice编辑器"><code><span>library</span>(FactoMineR)<br><span>library</span>(factoextra) <br>dat.pca &lt;- PCA(dat, graph = <span>FALSE</span>)<br><span>#对dat做PCA分析</span><br></code></pre><pre data-tool="mdnice编辑器"><code>fviz_pca_ind(dat.pca,<br>             geom.ind = <span>"point"</span>, <span># show points only (nbut not "text")</span><br>             col.ind = Group, <span># color by groups</span><br>             palette = c(<span>"#00AFBB"</span>, <span>"#E7B800"</span>),<br>             addEllipses = <span>TRUE</span>, <span># Concentration ellipses</span><br>             legend.title = <span>"Groups"</span><br>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039325" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBMMo3fZxlWboicvo4wxic4h3hwkW54tV7aIFnr3lnZ95etd5V2ypwW9XZw/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBMMo3fZxlWboicvo4wxic4h3hwkW54tV7aIFnr3lnZ95etd5V2ypwW9XZw/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></figure><pre data-tool="mdnice编辑器"><code><span>#画PCA图，使用pca分析后的数据dat.pca</span><br></code></pre><ol start="2" data-tool="mdnice编辑器"><li><section>top 1000 sd 热图</section></li></ol><pre data-tool="mdnice编辑器"><code><span>#离散基因热图，top1000表达基因，只是看一下，不用放文章里</span><br>g = names(tail(sort(apply(exp,<span>1</span>,sd)),<span>1000</span>)) <br><span>#对exp遍历，取每一行的sd，sort排序后取后1000个，再提取基因名字（向量名字）</span><br>n = exp[g,]<br><span>library</span>(pheatmap)<br>annotation_col = data.frame(row.names = colnames(n),<br>                            Group = Group)<br>pheatmap(n,<br>         show_colnames =<span>F</span>,<br>         show_rownames = <span>F</span>,<br>         annotation_col=annotation_col,<br>         scale = <span>"row"</span>, <span>#按行标准化，只保留行内差别，不保留行间差别，会把数据范围缩放到大概-5~5之间</span><br>         breaks = seq(-<span>3</span>,<span>3</span>,length.out = <span>100</span>) <span>#设置色带分布范围为-3~3之间，超出此范围的数字显示极限颜色</span><br>         ) <br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039327" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBMxkmYvMxcoWKI8ZM9SiaeMAUia6G0kHyh85EOdibAKDCRibzX440SOAaXDA/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBMxkmYvMxcoWKI8ZM9SiaeMAUia6G0kHyh85EOdibAKDCRibzX440SOAaXDA/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></figure><pre data-tool="mdnice编辑器"><code><span>#pheatmap的帮助文档非常详细，有其他需要可以去查看帮助文档</span><br><span># 关于scale的进一步学习：zz.scale.R</span><br></code></pre><h1 data-tool="mdnice编辑器"><span>差异分析</span></h1><pre data-tool="mdnice编辑器"><code>rm(list = ls()) <br>load(file = <span>"step2output.Rdata"</span>)<br><span>#load上一步做完后得到用于差异分析的结果表格</span><br><span>#需要输入数据：exp、ids、group，使用limma包根据贝叶斯检验原理进行差异分析</span><br><span>library</span>(limma)<br>design = model.matrix(~Group)<br><span>#根据分组信息生成一个模型矩阵</span><br>fit = lmFit(exp,design)<br><span>#线性拟合函数</span><br>fit = eBayes(fit)<br><span>#贝叶斯检验</span><br>deg = topTable(fit,coef = <span>2</span>,number = <span>Inf</span>)<br><span>#提取差异分析结果：coef = 2指design的第二列，number = infinity指提取全部</span><br></code></pre><p data-tool="mdnice编辑器">得到一个probe_id和对应的logFC、pValue的表格，但还需要和symbol还有entrezid连接在一起</p><p data-tool="mdnice编辑器">代码如下：</p><ol data-tool="mdnice编辑器"><li><section>加probe_id列，把行名变成一列，防止行名丢失</section></li></ol><pre data-tool="mdnice编辑器"><code><span>library</span>(dplyr)<br>deg = mutate(deg,probe_id = rownames(deg))<br><span>#mutate合并，deg和新的一列，新列名称叫probe_id，内容是rownames.deg</span><br></code></pre><ol start="2" data-tool="mdnice编辑器"><li><section>加上探针注释</section></li></ol><p data-tool="mdnice编辑器">probe_id和基因symbol不是一对一的关系，是多对一或者一对多的关系，因此需要去重</p><ul data-tool="mdnice编辑器"><li><section><p>一个探针对应多个基因：非特异性探针，在表格中可以看到，则需要直接去除</p></section></li><li><section><p>一个基因对应多个探针：相当于一个基因测了好多遍</p></section></li></ul><p data-tool="mdnice编辑器">处理方法：随机去重/保留行和或行平均值最大的探针/取多个探针的平均值</p><pre data-tool="mdnice编辑器"><code>ids = distinct(ids,symbol,.keep_all = <span>T</span>)<br><span>#此处是随机去重的方法，其他去重方式在zz.去重方式.R</span><br></code></pre><pre data-tool="mdnice编辑器"><code>deg = inner_join(deg,ids,by=<span>"probe_id"</span>)<br><span>#用inner_join取交集并把差异分析的结果deg和之前的id—symbol表格连接在一起</span><br>nrow(deg) <br></code></pre><pre data-tool="mdnice编辑器"><code><span>## [1] 20824</span><br></code></pre><pre data-tool="mdnice编辑器"><code><span>#检查一下，如果行数为0就是你找的探针注释是错的。</span><br></code></pre><ol start="3" data-tool="mdnice编辑器"><li><section>加change列,标记上下调基因</section></li></ol><pre data-tool="mdnice编辑器"><code>logFC_t = <span>1</span><br>p_t = <span>0.05</span><br><span>#设置logFC和pValue的阈值</span><br><span>#使用ifelse两次或者casewhen判断down、up、stable并输出成新的一列change</span><br>k1 = (deg$P.Value &lt; p_t)&amp;(deg$logFC &lt; -logFC_t)<br>k2 = (deg$P.Value &lt; p_t)&amp;(deg$logFC &gt; logFC_t)<br>deg = mutate(deg,change = ifelse(k1,<span>"down"</span>,ifelse(k2,<span>"up"</span>,<span>"stable"</span>)))<br>table(deg$change)<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## </span><br><span>##   down stable     up </span><br><span>##    579  19621    624</span><br></code></pre><ol start="4" data-tool="mdnice编辑器"><li><section>火山图</section></li></ol><pre data-tool="mdnice编辑器"><code><span>library</span>(ggplot2)<br>ggplot(data = deg, aes(x = logFC, y = -log10(P.Value))) +<br>  geom_point(alpha=<span>0.4</span>, size=<span>3.5</span>, aes(color=change)) +<br>  scale_color_manual(values=c(<span>"blue"</span>, <span>"grey"</span>,<span>"red"</span>))+<br>  geom_vline(xintercept=c(-logFC_t,logFC_t),lty=<span>4</span>,col=<span>"black"</span>,linewidth=<span>0.8</span>) +<br>  geom_hline(yintercept = -log10(p_t),lty=<span>4</span>,col=<span>"black"</span>,linewidth=<span>0.8</span>) +<br>  theme_bw()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039324" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBM2VKLgGLV656QYd60tZHTQU3ofh4ZgC2Suq29AL7bickT574Pzro7AFQ/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBM2VKLgGLV656QYd60tZHTQU3ofh4ZgC2Suq29AL7bickT574Pzro7AFQ/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></figure><pre data-tool="mdnice编辑器"><code><span>#使用ggplot的geom_point画火山图，vline和hline画阈值的线</span><br></code></pre><ol start="5" data-tool="mdnice编辑器"><li><section>差异基因热图</section></li></ol><pre data-tool="mdnice编辑器"><code><span># 表达矩阵行名替换为基因名，分为两步：</span><br>exp = exp[deg$probe_id,]<br><span>#按deg中的symbol列的内容在exp中按行取子集</span><br>rownames(exp) = deg$symbol<br><span>#把exp中行名改为deg的symbol列，此时已经是一一对应的</span><br></code></pre><pre data-tool="mdnice编辑器"><code>diff_gene = deg$symbol[deg$change !=<span>"stable"</span>]<br><span>#取出change列不是stable的基因symbol</span><br>n = exp[diff_gene,]<br><span>#按有差异的基因symbol在exp中按行取子集，即为有差异的基因的logFC和pValue，赋值到数据框n中，用于画差异基因热图</span><br></code></pre><pre data-tool="mdnice编辑器"><code><span>library</span>(pheatmap)<br>annotation_col = data.frame(group = Group)<br>rownames(annotation_col) = colnames(n) <br>pheatmap(n,show_colnames =<span>F</span>,<br>         show_rownames = <span>F</span>,<br>         scale = <span>"row"</span>,<br>         <span>#cluster_cols = F, </span><br>         annotation_col=annotation_col,<br>         breaks = seq(-<span>3</span>,<span>3</span>,length.out = <span>100</span>)<br>) <br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039326" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBM6oKq8KTRR1OZN7UiakwoT0oTXTGjS0w9kaGyZddsPstEiaLYfhCiabtaQ/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBM6oKq8KTRR1OZN7UiakwoT0oTXTGjS0w9kaGyZddsPstEiaLYfhCiabtaQ/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></figure><pre data-tool="mdnice编辑器"><code><span>#如果差异基因的聚类分组还是错乱的，则加cluster_col = F</span><br><span>#如果加了还是错乱的，去看：小洁老师的语雀/分组聚类的热图</span><br></code></pre><ol start="6" data-tool="mdnice编辑器"><li><section>加ENTREZID列，用于后续的富集分析</section></li></ol><p data-tool="mdnice编辑器">entrezid是富集分析指定用的，需要symbol转entrezid，然后inner_join</p><p data-tool="mdnice编辑器">使用clusterProfiler中的bitr函数实现，另外数据库根据物种不同</p><pre data-tool="mdnice编辑器"><code><span>library</span>(clusterProfiler)<br><span>library</span>(org.Hs.eg.db)<br>s2e = bitr(deg$symbol, <br>           fromType = <span>"SYMBOL"</span>,<br>           toType = <span>"ENTREZID"</span>,<br>           OrgDb = org.Hs.eg.db)<span>#人类,注意物种</span><br></code></pre><p data-tool="mdnice编辑器">一部分基因没匹配上是正常的。&lt;30%的失败都没事。</p><p data-tool="mdnice编辑器">其他物种http://bioconductor.org/packages/release/BiocViews.html#___OrgDb nrow(deg)</p><p data-tool="mdnice编辑器">看剩下数量，如果只有几十说明有问题</p><pre data-tool="mdnice编辑器"><code>deg = inner_join(deg,s2e,by=c(<span>"symbol"</span>=<span>"SYMBOL"</span>))<br><span>#把差异基因的表和entrezid通过innerjoin连接在一起，用于后面的富集分析</span><br></code></pre><p data-tool="mdnice编辑器">多了几行少了几行都正常，SYMBOL与ENTREZID不是一对一的</p><pre data-tool="mdnice编辑器"><code>nrow(deg)<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## [1] 20827</span><br></code></pre><pre data-tool="mdnice编辑器"><code><span>#再看看还有几行，然后保存</span><br>save(exp,Group,deg,logFC_t,p_t,file = <span>"step4output.Rdata"</span>)<br></code></pre><blockquote data-tool="mdnice编辑器"><span>❝</span><p>from 生信技能树</p></blockquote><span></span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span>文末友情宣传</span></h3><p data-tool="mdnice编辑器"><strong>强烈建议你推荐给身边的博士后以及年轻生物学PI，多一点数据认知，让他们的科研上一个台阶：</strong></p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247530001&amp;idx=1&amp;sn=676dcf224f9be23b288189775292aeeb&amp;chksm=9b4b36aaac3cbfbc3e3bb0865bd789d5093e3a643f3f345332995f707b7f209ae924e9e9529e&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买‍一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;scene=21#wechat_redirect" data-linktype="2">时隔5年，我们的生信技能树VIP学徒继续招生啦</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528363&amp;idx=1&amp;sn=5e02f3e9b2e148191e23ebc2c0d780e7&amp;scene=21#wechat_redirect" data-linktype="2">2024的共享服务器交个朋友福利价仍然是800</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;scene=21#wechat_redirect" data-linktype="2">千呼万唤始出来的独享生物信息学云服务器</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528144&amp;idx=1&amp;sn=be4d7e542d1077921024c86a4c130f16&amp;scene=21#wechat_redirect" data-linktype="2">永久免费的生信进阶培训（线下）</a></section></li></ul></section><p><br></p><p><br></p><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/jJfwC77CsoPimQJTIbkI2Q",target="_blank" rel="noopener noreferrer">原文链接</a>
