---
title: "RunTSNE二维及三维结果可视化"
date: 2024-06-19T03:36:33Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
RunTSNE二维及三维结果可视化 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span></span><span>前情提要</span><span></span></h3><p data-tool="mdnice编辑器">在<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247522734&amp;idx=1&amp;sn=87543a75fa71c707908f582df51bad27&amp;scene=21#wechat_redirect" data-linktype="2">单细胞PCA降维结果理解</a>以及<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247522941&amp;idx=1&amp;sn=5145f5c0570d691c4202ca8c188f90d4&amp;scene=21#wechat_redirect" data-linktype="2">细胞聚类分群及其可视化</a>中，<strong>除了有PCA以及聚类分群结果的可视化以外，都展示了一下UMAP图</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039296" data-ratio="0.6917148362235067" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWmRYYg4SkIJOHP32hJrmcdEcgRcpVkas5qibOFPVq4YDziccAickwzuTfg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1038" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWmRYYg4SkIJOHP32hJrmcdEcgRcpVkas5qibOFPVq4YDziccAickwzuTfg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>UMAP图是运行完RunUMAP()的线性降维可视化结果，和RunUMAP()同样起非线性降维作用的还有RunTSNE()</strong></p><p data-tool="mdnice编辑器">在<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247522734&amp;idx=1&amp;sn=87543a75fa71c707908f582df51bad27&amp;scene=21#wechat_redirect" data-linktype="2">单细胞PCA降维结果理解</a>中，我们运行完RunPCA之后，一共会保留下来50个维度，根据不同维度的相关性基因可以区分不同的细胞类群。但<strong>PCA通常只能显示数据的线性结构，不够直观</strong>。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039298" data-ratio="0.7514071294559099" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWW6CvpbPrILvFjBop2nO97YOnNN620saSlotwj9Y5UcOmlfxh5ZuAicqg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1066" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWW6CvpbPrILvFjBop2nO97YOnNN620saSlotwj9Y5UcOmlfxh5ZuAicqg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>可以使用t-分布邻域嵌入算法（t-SNE）或统一流形逼近与投影（UMAP）等非线性降维方法，在二维或三维图中为每个数据点提供一个位置，对高维数据进行可视化</strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>RunTSNE()及其参数</span><span></span></h3><figure data-tool="mdnice编辑器"><img data-imgfileid="100039295" data-ratio="1.1633986928104576" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWS4En4jb0BhnVyjiaG3rhGUMSvI7z1SRUPJ2UHFoziaLW8cCC4WicJpbOg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="612" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWS4En4jb0BhnVyjiaG3rhGUMSvI7z1SRUPJ2UHFoziaLW8cCC4WicJpbOg/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>pbmc &lt;- RunTSNE(pbmc,<br>                reduction = <span>"pca"</span>,<br>                dims = 1:10,<br>                dim.embed = 3)<br></code></pre><p data-tool="mdnice编辑器"><strong>常用的几个参数有</strong>：</p><ul data-tool="mdnice编辑器"><li><section><strong>object：</strong>对应的seurat对象，这里用的是pbmc示例数据</section></li><li><section><strong>reduction：</strong>对tSNE使用哪种降维方法，一般默认是pca</section></li><li><section><strong>dims：</strong>对应的PCA维度</section></li><li><section><strong>dim.embed：</strong>生成的tSNE嵌入的维度空间(默认为2)，也可以根据我们的需要设置对应的维度空间</section></li></ul><p data-tool="mdnice编辑器"><strong>降维结果也是存放在reductions</strong>里面</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039294" data-ratio="0.40185185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWRyH8MsOOlBTtYoWCvtSR5giaC10icuA7znVYwueAo3tZlOJialW2nHVdg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWRyH8MsOOlBTtYoWCvtSR5giaC10icuA7znVYwueAo3tZlOJialW2nHVdg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">和PCA结果不同的是，<strong>TSNE降维的结果只有cell.embeddings里面是有数值的，储存着细胞的坐标信息</strong>，基于坐标信息可以进行可视化</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039297" data-ratio="1.3461538461538463" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWYC9ibYnlyRN3CWKMyb5JAAHW0Sk0uqWOByFSYGQYnhYj03YX7xRw1FA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="520" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWYC9ibYnlyRN3CWKMyb5JAAHW0Sk0uqWOByFSYGQYnhYj03YX7xRw1FA/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>二维可视化及美化</span><span></span></h3><p data-tool="mdnice编辑器">可以使用<strong>Dimplot简单可视化tsne的二维结果图</strong></p><pre data-tool="mdnice编辑器"><span></span><code>pbmc &lt;- RunTSNE(pbmc,<br>                reduction = <span>"pca"</span>,<br>                dims = 1:10,<br>                dim.embed = 2)<br>                <br>DimPlot(pbmc,label = T,reduction = <span>'tsne'</span>,pt.size =2)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039301" data-ratio="0.7467289719626168" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWNgTcvevHB1oJibF2ibUbvFic82GMIhbj0T0d35RwicnjM3ib6HkqKqhB01g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1070" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWNgTcvevHB1oJibF2ibUbvFic82GMIhbj0T0d35RwicnjM3ib6HkqKqhB01g/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">在生信菜鸟团的<a href="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;__biz=MzUzMTEwODk0Ng==&amp;scene=1&amp;album_id=2546857217690632193&amp;count=3&amp;uin=&amp;key=&amp;devicetype=Windows+11+x64&amp;version=63090a1b&amp;lang=zh_CN&amp;ascene=0" data-linktype="2">#单细胞周更</a>中，有一期就是对TSNE和UMAP图进行美化——<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512357&amp;idx=1&amp;sn=0501e682033fdbb9771ffd14acd4f93d&amp;scene=21#wechat_redirect" data-linktype="2">tsne及umap图美化</a></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039299" data-ratio="0.608433734939759" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWIsZiaRVtwQicwrbYTd8ia7fzGgIgcJupibNQ4lUMgazia8AGtuuqG7Snt9g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="996" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWIsZiaRVtwQicwrbYTd8ia7fzGgIgcJupibNQ4lUMgazia8AGtuuqG7Snt9g/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>使用ggplot2美化：</strong></p><ul data-tool="mdnice编辑器"><li><section>提取tSNE二维坐标数据，以及细胞分群情况celltype</section></li><li><section>计算二维坐标的中位数，作为细胞分群情况的标签坐标</section></li><li><section>使用ggplot2绘制散点图</section></li><li><section>使用stat_ellipse加置信区间</section></li><li><section>使用geom_text加上标签信息</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span>#提取坐标数据</span><br>tSNE=pbmc@reductions<span>$tsne</span>@cell.embeddings %&gt;%<br>  as.data.frame() %&gt;%<br>  cbind(celltype=pbmc@meta.data<span>$celltype</span>)<br><br><span># 设置标签坐标</span><br>label &lt;- tSNE %&gt;%<br>  group_by(celltype)%&gt;%<br>  summarise(tSNE_1 = median(tSNE_1), tSNE_2 = median(tSNE_2))<br><br><span>#使用ggplot2绘图</span><br>p &lt;- ggplot(data = tSNE, aes(x = tSNE_1, y = tSNE_2)) +<br>  geom_point(aes(color = celltype),<br>             size = 2,<br>             alpha = 0.8)+<br>  stat_ellipse(aes(color = celltype),<br>               level = 0.95, linetype = 2, show.legend = F)+<br>  geom_text(data = label,<br>            aes(x = tSNE_1, y = tSNE_2, label = celltype),<br>            color = <span>'black'</span>, size = 5)<br><br>p<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039303" data-ratio="0.7555555555555555" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWYhFEa7LEfwgcjYJPicRF4ZicOiar9yZ9DUvUufyPRStDzaf8H55VGibpBg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWYhFEa7LEfwgcjYJPicRF4ZicOiar9yZ9DUvUufyPRStDzaf8H55VGibpBg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>对比Dimplot直接绘图和使用ggplot简单调整之后的图：</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039302" data-ratio="0.8107810781078107" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWW4h8qvBdpg7PtBzWQ6sdDLnB1VAO2WNqu3S3xF8H5hoZdcDW1PpZarw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="909" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWW4h8qvBdpg7PtBzWQ6sdDLnB1VAO2WNqu3S3xF8H5hoZdcDW1PpZarw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">当然<strong>还有更多的细节可以调整，Dimplot函数也有很多参数可以选择，后面我们再来探讨！</strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>三维可视化</span><span></span></h3><p data-tool="mdnice编辑器"><code>dim.embed</code>参数可以调整TSNE的维度，所以我们可以保留三个维度来进行可视化</p><pre data-tool="mdnice编辑器"><span></span><code>pbmc &lt;- RunTSNE(pbmc,<br>                reduction = <span>"pca"</span>,<br>                dims = 1:10,<br>                dim.embed = 3)<br></code></pre><p data-tool="mdnice编辑器">三维立体图可视化就可以用到<strong>scatterplot3d——Plots a three dimensional (3D) point cloud这个包</strong></p><p data-tool="mdnice编辑器"><strong>tSNE三维可视化步骤：</strong></p><ul data-tool="mdnice编辑器"><li><section>提取tSNE三维坐标数据，以及细胞分群情况celltype</section></li><li><section>选择合适的配图颜色</section></li><li><section>使用scatterplot3d绘制三维图</section></li><li><section>使用legend加上标签信息</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span>#加载R包</span><br>library(dplyr)<br>library(scatterplot3d)<br><br><span>#指定数据和颜色</span><br>plot = tSNE_3d<br>class(plot)<br><br>color.bin &lt;- c(<span>"#D9AB42"</span>,<span>"#A35E47"</span>,<span>"#0F4C3A"</span>,<span>"#563F2E"</span>,<span>"#78C2C4"</span>,<span>"#C73E3A"</span>,<span>"#B47157"</span>,<span>"#2B5F75"</span>)<br><br>plot &lt;- plot %&gt;% <br>  mutate(ID=rownames(plot),<br>         Type=pbmc@meta.data<span>$celltype</span>,<br>         TypeColor=color.bin[as.numeric(as.factor(Type))])<br><br><span>#scatterplot3d绘制三维图</span><br>scatterplot3d(x = plot<span>$tSNE_1</span>, <br>              y = plot<span>$tSNE_2</span>, <br>              z = plot<span>$tSNE_3</span>,<br>              color = plot<span>$TypeColor</span>,<br>              pch = 16, cex.symbols = 1,<br>              scale.y = 0.7, angle = 45,<br>              xlab = <span>"tSNE_1"</span>, ylab = <span>"tSNE_2"</span>, zlab = <span>"tSNE_3"</span>,<br>              main=<span>"3D Scatter Plot of tSNE"</span>,<br>              col.axis = <span>"#444444"</span>, col.grid = <span>"#CCCCCC"</span>)<br><br><span>#legend加上标签信息</span><br>legend(<span>"bottom"</span>, legend = levels(as.factor(plot<span>$Type</span>)),<br>       col =  color.bin,  pch = 16,<br>       inset = -0.25,xpd = TRUE, horiz = FALSE,ncol = 3)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039300" data-ratio="0.7509363295880149" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWqZx08WZOL6icafXx7nOFqkZIia2MyGUqyee5bHicRYKTyeaquhFbLTRjg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1068" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWqZx08WZOL6icafXx7nOFqkZIia2MyGUqyee5bHicRYKTyeaquhFbLTRjg/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>TSNE对比PCA</span><span></span></h3><p data-tool="mdnice编辑器">从二维看起来，tsne和PCA的结果差异不算很大，但<strong>PCA结果中因为有<code>feature.loding</code>的基因信息，所以不同维度根据其相关性基因可以对细胞亚群进行区分</strong></p><pre data-tool="mdnice编辑器"><span></span><code>DimPlot(pbmc,label = T,reduction = <span>'pca'</span>)+DimPlot(pbmc,label = T,reduction = <span>'tsne'</span>,pt.size =2)<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039307" data-ratio="0.674074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWglAZMiaoeazgyIvnu7kHWM1gfFmh9FDVZEJwmIIoN7CJyNlu6Y8RnQw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWglAZMiaoeazgyIvnu7kHWM1gfFmh9FDVZEJwmIIoN7CJyNlu6Y8RnQw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">从<strong>三维立体图看来，TSNE的降维后可视化的结果会更直观一些</strong>，相似的标签被聚类在一起</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039308" data-ratio="0.7684310018903592" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWaUeIUFYsk6RkwoNMZRb63BFDXuKWCnIZ0iaVvWKSn6ajezxLgkUPNtw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1058" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWaUeIUFYsk6RkwoNMZRb63BFDXuKWCnIZ0iaVvWKSn6ajezxLgkUPNtw/640?wx_fmt=png&amp;from=appmsg"><figcaption>PCA</figcaption></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100039304" data-ratio="0.7509363295880149" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWqZx08WZOL6icafXx7nOFqkZIia2MyGUqyee5bHicRYKTyeaquhFbLTRjg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1068" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRrDyDK8mnbRm5YFrc45mWWqZx08WZOL6icafXx7nOFqkZIia2MyGUqyee5bHicRYKTyeaquhFbLTRjg/640?wx_fmt=png&amp;from=appmsg"><figcaption>TSNE</figcaption></figure></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/IXtlwzcleF89rnDNRqVe7w",target="_blank" rel="noopener noreferrer">原文链接</a>
