---
title: "RunUMAP常用参数及三维可视化"
date: 2024-06-26T10:43:10Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
RunUMAP常用参数及三维可视化 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span></span><span>前情提要</span><span></span></h3><p data-tool="mdnice编辑器">在上一期<a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI1Njk4ODE0MQ==&amp;action=getalbum&amp;album_id=3418409629246324742&amp;scene=173&amp;subscene=227&amp;sessionid=1719372068&amp;enterid=1719373304&amp;from_msgid=2247523299&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" data-linktype="2">#单细胞常见图表</a>中，分享了<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247523299&amp;idx=1&amp;sn=e44471a4e1490d2596a7040eb712acd5&amp;scene=21#wechat_redirect" data-linktype="2">RunTSNE二维及三维结果可视化</a></p><p data-tool="mdnice编辑器"><strong>了解了一下<code>RunTSNE()</code>函数的常见参数，以及使用ggplot2美化二维结果，和简单的tSNE三维可视化步骤</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039944" data-ratio="0.8649706457925636" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRq7reqZyWEctgIjawxCwMEsvOC7EDZ76RrjBWd1fyMJhpjibqAtbrhxQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1022" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRq7reqZyWEctgIjawxCwMEsvOC7EDZ76RrjBWd1fyMJhpjibqAtbrhxQ/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100039942" data-ratio="0.7509363295880149" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRVzEr26e2yVm4PCnKjUAEgOjMtau4hvpzDIUxqHKjLbu3icIdKu8LsYg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1068" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRVzEr26e2yVm4PCnKjUAEgOjMtau4hvpzDIUxqHKjLbu3icIdKu8LsYg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">那这期一起来<strong>了解一下<code>RunUMAP()</code>的常见参数以及三维可视化情况</strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>UMAP非线性降维</span><span></span></h3><p data-tool="mdnice编辑器">UMAP，全称Uniform Manifold Approximation and Projection，是一种<strong>用于降维的非线性技术</strong>，类似于t-SNE，但<strong>计算速度更快，更适合大规模数据。</strong></p><p data-tool="mdnice编辑器">之前有简单整理过<a href="https://mp.weixin.qq.com/s?__biz=MzkxOTI0Mjc3Mw==&amp;mid=2247486924&amp;idx=1&amp;sn=99b37381e32b5fd0a4f2aa3a534304fe&amp;scene=21#wechat_redirect" data-linktype="2">细胞聚类方法比较(t-SNE&amp;UMAP)</a>，对两种非线性降维方法进行了比较。</p><p data-tool="mdnice编辑器"><strong>UMAP可以保留数据的全局结构，同时也能揭示数据的局部结构</strong>，因此在单细胞RNA测序数据分析中被广泛使用。</p><p data-tool="mdnice编辑器"><strong>UMAP的工作原理：</strong></p><ul data-tool="mdnice编辑器"><li><section>在高维空间中构建一个拓扑结构（或称为流形）</section></li><li><section>在低维空间中寻找一个最佳的映射，使得这个映射尽可能地保留原始数据的拓扑结构</section></li><li><section>原始的高维数据就被有效地降维到二维或三维，便于可视化和进一步分析</section></li></ul><p data-tool="mdnice编辑器"><strong>在R中，UMAP可以通过umap包或Seurat包中的RunUMAP函数来实现</strong>。在Python中，可以通过umap-learn包来实现。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>RunUMAP函数常用参数</span><span></span></h3><p data-tool="mdnice编辑器">在之前的推文<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247520756&amp;idx=1&amp;sn=736f2d8c5e0112d506a9f7f181cbdfe4&amp;scene=21#wechat_redirect" data-linktype="2">实战探究五个参数对UMAP图可视化的影响</a>中，同事分享了<strong>高变基因个数；pca维数；UMAP中的n_neighbors，min_dist和dims参数</strong>等五个参数对UMAP可视化的影响。</p><p data-tool="mdnice编辑器">这次我们主要看看<strong>RunUMAP函数中常用参数</strong>：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039941" data-ratio="1.2093023255813953" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRjzqlAMZLibe5TZOeEPOPC8yZUhMQDn586qO0rXzopPlKSbXJ70f9wiaQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="645" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRjzqlAMZLibe5TZOeEPOPC8yZUhMQDn586qO0rXzopPlKSbXJ70f9wiaQ/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>#不同参数对UMAP的影响</span><br>neighbors_nums &lt;- c(5,30,50)<br>min_dist_nums &lt;- c(0.1,0.3,0.5)<br><br><span>#可视化</span><br><br><span>for</span> (n <span>in</span> neighbors_nums){<br>  <span>for</span> (d <span>in</span> min_dist_nums){<br>        pbmc &lt;- RunUMAP(pbmc, dims = 1:15, <br>        umap.method = <span>"uwot"</span>, metric = <span>"cosine"</span>,<br>        reduction = <span>"pca"</span>, n.neighbors=n, min.dist=d)<br>        <br>        p1 &lt;- DimPlot(pbmc,label = T,reduction = <span>"umap"</span>,raster=F)<br>        <span>print</span>(p1)<br>      }<br>}<br></code></pre><p data-tool="mdnice编辑器"><strong>常用的几个参数有</strong>：</p><ul data-tool="mdnice编辑器"><li><section><strong>object：</strong>对应的seurat对象，这里用的是pbmc示例数据</section></li><li><section><strong>dims：</strong>对应的PCA降维后的维度</section></li><li><section><strong>reduction：</strong>对UMAP使用哪种降维方法，一般默认是pca（如果是多样品harmony之后的数据，reduction = "harmony"）</section></li><li><section><strong>umap.method</strong>:可以是<code>uwot</code>——通过uwot R包运行umap（一般选择这个参数），<code>uwot-learn</code>——通过uwot R包运行umap，并返回学到的umap模型，<code>umap-learn</code>——运行python umap-learn包的Seurat包装器</section></li><li><section><strong>n.neighbors</strong>：流形结构局部近似中使用的邻近点的数量，数值越大会保留更多的全局结构，而失去详细的局部结构。一般来说，设置在5到50的范围内</section></li><li><section><strong>n.components：</strong>生成的UMAP嵌入的维度空间(默认为2)，也可以根据我们的需要设置对应的维度空间</section></li><li><section><strong>min.dist：控制嵌入的压缩点在一起的紧密程度</strong>。数值越大会确保嵌入点分布更均匀，而较小的值允许算法根据局部结构更准确地优化。合理的值在0.001到0.5之间。</section></li></ul><h3 data-tool="mdnice编辑器"><span></span><span></span><span>dims数值对可视化的影响</span><span></span></h3><p data-tool="mdnice编辑器"><strong>使用默认参数值min.dist=0.3，n.neighbors=30</strong></p><p data-tool="mdnice编辑器"><strong>使用不同的dims维度进行可视化，使dims=1:5,1:15,1:30,1:50</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039945" data-ratio="0.962176509621765" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRpIPKYFJicCibybbNVumkKEialxP8p7fGPma6L8I3Cibdy8AwUQFwmia8Qpw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1507" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRpIPKYFJicCibybbNVumkKEialxP8p7fGPma6L8I3Cibdy8AwUQFwmia8Qpw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">从可视化结果可以看到，<strong>dims的维度越高，细胞亚群结构就越紧凑</strong>，dims=1:15或者1:30时，可视化的结果看起来较好</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>n.neighbors值对可视化的影响</span><span></span></h3><p data-tool="mdnice编辑器"><strong>控制dims=1:15,min.dist=0.3,分别设置n.neighbors=5,10,30,50</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039943" data-ratio="0.8896260554885405" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRic4Fs2pwqxlnMhfOlP10Tw1MfOxAc1cPbTxgR4C5BmKiae3kwiaib9G1zg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1658" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRic4Fs2pwqxlnMhfOlP10Tw1MfOxAc1cPbTxgR4C5BmKiae3kwiaib9G1zg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">从可视化结果可以看到，<strong>在控制嵌入的压缩点数值保持不变时，n.neighbors的值越大，局部结构会更加紧密。在<code>n.neighbors=50</code>时，每个细胞亚群的局部结构很紧凑，看起来全局的效果会好一些！</strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>min.dist值对可视化的影响</span><span></span></h3><p data-tool="mdnice编辑器"><strong>控制dims=1:15,n.neighbors=30（默认值），分别设置min.dist=0.01,0.1,0.3,0.5</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039950" data-ratio="0.8247305728871243" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoR5uNrfO1EeCZVZaLWCDvjeZXYzicnbu9D3rZZPBMHXA8mjc36Tj15dYw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1763" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoR5uNrfO1EeCZVZaLWCDvjeZXYzicnbu9D3rZZPBMHXA8mjc36Tj15dYw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">从可视化结果可以看到，<strong>在流形结构局部近似中使用的邻近点的数量保持不变时，min.dist的值越大，点分布的越均匀，值越小，局部结构更紧凑。在<code>min.dist=0.01</code>点图变的非常紧凑！</strong></p><p data-tool="mdnice编辑器"><strong>正如<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247520756&amp;idx=1&amp;sn=736f2d8c5e0112d506a9f7f181cbdfe4&amp;scene=21#wechat_redirect" data-linktype="2">实战探究五个参数对UMAP图可视化的影响</a>中提到的，UMAP参数中的n_neighbors，min_dist和dims这三个参数，是不会影响细胞的本质属性的，只是影响UMAP可视化的图。</strong></p><p data-tool="mdnice编辑器">我们在实际可视化结果的过程中，<strong>选择合适的参数阈值即可，不要过高或者过低。</strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>n.components参数及三维可视化</span><span></span></h3><p data-tool="mdnice编辑器">在RunUMAP里面可是使用<code>n.components</code>参数来调整生成的UMAP的维度，我们<strong>可以设置n.components = 5</strong>，然后对其三维结果进行可视化</p><pre data-tool="mdnice编辑器"><span></span><code><span>#三维立体图</span><br>library(scatterplot3d)<br>library(tidyverse)<br>library(openxlsx)<br>library(factoextra)<br><br>pbmc &lt;- RunUMAP(pbmc, dims = 1:10,<br>                reduction = <span>"pca"</span>,<br>                n.neighbors=10, <br>                min.dist=0.5,<br>                n.components = 5)<br><br>UMAP_3d = pbmc@reductions<span>$umap</span>@cell.embeddings %&gt;%<br>  as.data.frame() %&gt;%<br>  cbind(celltype=pbmc@meta.data<span>$celltype</span>)<br><br>plot = UMAP_3d<br><br>class(plot)<br><br>library(dplyr)<br>library(scatterplot3d)<br>color.bin &lt;- c(<span>"#D9AB42"</span>,<span>"#848484"</span>,<span>"#D65190"</span>,<span>"#A8D3A0"</span>,<span>"#78C2C4"</span>,<span>"#0076B9"</span>,<span>"#731A73"</span>,<span>"#2B5F75"</span>,<span>"#C73E3A"</span>)<br><br>plot &lt;- plot %&gt;% <br>  mutate(ID=rownames(plot),<br>         Type=pbmc@meta.data<span>$celltype</span>,<br>         TypeColor=color.bin[as.numeric(as.factor(Type))])<br><br>scatterplot3d(x = plot<span>$umap_1</span>, <br>              y = plot<span>$umap_2</span>, <br>              z = plot<span>$umap_3</span>,<br>              color = plot<span>$TypeColor</span>,<br>              pch = 16, cex.symbols = 1,<br>              scale.y = 0.7, angle = 45,<br>              xlab = <span>"UMAP_1"</span>, ylab = <span>"UMAP_2"</span>, zlab = <span>"UMAP_3"</span>,<br>              main=<span>"3D Scatter Plot of UMAP"</span>,<br>              col.axis = <span>"#444444"</span>, col.grid = <span>"#CCCCCC"</span>)<br><br>legend(<span>"bottom"</span>, legend = levels(as.factor(plot<span>$Type</span>)),<br>       col =  color.bin,  pch = 16,<br>       inset = -0.25,xpd = TRUE, horiz = FALSE,ncol = 3)<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039948" data-ratio="0.7723735408560312" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRxMxicXbicVqnqcXvUUOkwhBYr9KSxSt9ReTScoWcTjhrc6MlmG4qFCjw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1028" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRxMxicXbicVqnqcXvUUOkwhBYr9KSxSt9ReTScoWcTjhrc6MlmG4qFCjw/640?wx_fmt=png&amp;from=appmsg"><figcaption>UMAP</figcaption></figure><p data-tool="mdnice编辑器">对比一下之前<strong>TSNE的三维可视化结果</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039949" data-ratio="0.764367816091954" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRQjGCUsLmQy1LZXqouxICDmCywkF1hpQAaIMfzibNJ5ic2QQXnBAdfjrA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1044" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSRKaI5t8zRQDCk4DPgnicoRQjGCUsLmQy1LZXqouxICDmCywkF1hpQAaIMfzibNJ5ic2QQXnBAdfjrA/640?wx_fmt=png&amp;from=appmsg"><figcaption>TSNE</figcaption></figure><p data-tool="mdnice编辑器">从三维可视化的结果可以看到<strong>UMAP在降维过程中能够更好地保留数据的全局结构，避免了t-SNE可能出现的局部堆积现象</strong>。</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/UVkBbmnaFMNyKohZ22fB-Q",target="_blank" rel="noopener noreferrer">原文链接</a>
