---
title: "monocle单样本拟时序分析"
date: 2024-06-25T07:11:58Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
monocle单样本拟时序分析 by 生信技能树
------
<div><section data-mpa-powered-by="yiban.io"><br></section><section><section><section><section><section><section><section><h4><span><span> </span>0.背景知识</span></h4><p>做拟时序分析是为了探索自己感兴趣的几种细胞之间的发育关系，一般不是用全部类型的细胞来做的。例如本例中选择了CD14和CD16单核细胞。</p><p>如果让ai来说拟时序的目的那就比我说的多:</p><blockquote><p>拟时序分析（Pseudo-time analysis）是一种用于理解细胞状态和细胞命运变化的计算生物学方法。这种分析通常用于单细胞测序数据，其目的是重建细胞发育或疾病进程中的时间序列，即使实际的时间信息不可用。以下是进行拟时序分析的几个主要目的：</p><ol><li><p><strong>细胞状态推断</strong>：通过分析单个细胞的基因表达模式，推断细胞在生物学过程中所处的状态。</p></li><li><p><strong>细胞轨迹追踪</strong>：重建细胞从一种状态转变到另一种状态的路径，这有助于理解细胞分化、发育或疾病进展的过程。</p></li><li><p><strong>细胞命运预测</strong>：预测细胞随时间可能采取的发育轨迹，尤其是在干细胞分化或癌症发展的研究中。</p></li><li><p><strong>动态过程建模</strong>：创建细胞状态变化的动态模型，这有助于揭示细胞行为的内在规律和调控机制。</p></li><li><p><strong>细胞亚群识别</strong>：在复杂的细胞群体中识别不同的细胞亚群，并理解它们在生物学过程中的作用。</p></li><li><p><strong>基因调控网络推断</strong>：通过分析基因表达随“拟时间”的变化，推断基因调控网络和信号传导途径。</p></li><li><p><strong>疾病机理探索</strong>：在疾病研究中，拟时序分析有助于揭示疾病发生和发展的分子机制。</p></li><li><p><strong>药物作用机制研究</strong>：通过观察药物处理前后细胞状态的变化，研究药物的作用机制和效果。拟时序分析是一种强大的工具，它可以帮助研究者在没有直接时间标记的情况下，通过基因表达数据来探索细胞状态的变化和动态过程。这种方法在单细胞生物学、发育生物学、癌症生物学和神经科学等领域有着广泛的应用。</p></li></ol></blockquote><p>今天的代码是处理单样本数据的，明天再整一个多样本的。</p><pre><code>rm(list = ls())<br>library(Seurat)<br>library(monocle)<br>library(dplyr)<br>load("scRNA.Rdata")<br><span>table(scRNA$</span><span>celltype)</span><br><span><br>#</span><span># </span><br><span>#</span><span>#            B  B Activated    CD14 Mono    CD16 Mono CD4 Memory T  CD4 Naive T </span><br><span>#</span><span>#          568          201         2144          537          903         1524 </span><br><span>#</span><span>#        CD8 T           DC           Mk           NK          pDC  T activated </span><br><span>#</span><span>#          462          214          121          320           81          332</span><br><br>scRNA = subset(scRNA,idents = c("CD14 Mono","CD16 Mono"))<br><span>table(scRNA$</span><span>celltype)</span><br><span><br>#</span><span># </span><br><span>#</span><span># CD14 Mono CD16 Mono </span><br><span>#</span><span>#      2144       537</span><br></code></pre><p>本文的输入数据是seurat做完降维聚类分群注释的数据，并将注释的结果添加到了meta表格里面成为了celltype列。</p><p>因为只想要CD14和CD16单核细胞，所以提取出来相应的子对象。</p><p>因为monocle和seurat是两个不同的体系，所以需要将seurat对象转换为monocle可以接受的CellDataSet对象。虽然monocle3已经出来很久了，但大家都不约而同的选择monocle2，大概就是习惯了吧。。</p><pre><code>ct &lt;- scRNA@assays$RNA$counts<br><br>gene_ann &lt;- data.frame(<br>  gene_short_name = row.names(ct), <br>  row.names = row.names(ct)<br>)<br><br>pd &lt;- new("AnnotatedDataFrame",<br>          data=scRNA@meta.data)<br>fd &lt;- new("AnnotatedDataFrame",<br>          data=gene_ann)<br><br>sc_cds &lt;- newCellDataSet(<br>  ct, <br>  phenoData = pd,<br>  featureData =fd,<br>  expressionFamily = negbinomial.size(),<br>  lowerDetectionLimit=1)<br>sc_cds<br><span><br>#</span><span># CellDataSet (storageMode: environment)</span><br><span>#</span><span># assayData: 14053 features, 2681 samples </span><br><span>#</span><span>#   element names: exprs </span><br><span>#</span><span># protocolData: none</span><br><span>#</span><span># phenoData</span><br><span>#</span><span>#   sampleNames: AAACATACGCGAAG.1 AAACATACTCAGGT.1 ... TTTGACTGCCCTAC.1</span><br><span>#</span><span>#     (2681 total)</span><br><span>#</span><span>#   varLabels: orig.ident nCount_RNA ... Size_Factor (19 total)</span><br><span>#</span><span>#   varMetadata: labelDescription</span><br><span>#</span><span># featureData</span><br><span>#</span><span>#   featureNames: AL627309.1 RP11-206L10.2 ... LRRC3DN (14053 total)</span><br><span>#</span><span>#   fvarLabels: gene_short_name</span><br><span>#</span><span>#   fvarMetadata: labelDescription</span><br><span>#</span><span># experimentData: use 'experimentData(object)'</span><br><span>#</span><span># Annotation:</span><br></code></pre><h4><span><span> </span>1.构建细胞发育轨迹</span></h4><p>选择基因有不同的策略，比如 1.使用seurat给出的高变化基因 2.按照平均表达量大于某个数字(比如0.1，官网用的是这个)的基因 3.使用不同细胞类型之间的差异基因，differentialGeneTest计算。我们默认使用的是最后一个策略。</p><pre><code>sc_cds &lt;- estimateSizeFactors(sc_cds)<br>sc_cds &lt;- estimateDispersions(sc_cds)<br>table(scRNA@meta.data$celltype)<br><br><span>## </span><br><span>## CD14 Mono CD16 Mono </span><br><span>##      2144       537</span><br><br>fdif = <span>"diff_test_res.Rdata"</span><br><span>if</span>(!file.exists(fdif)){<br>  diff_test_res &lt;- differentialGeneTest(sc_cds,<br>                                        fullModelFormulaStr = <span>"~celltype"</span>,<br>                                        cores = <span>8</span>)<br>  save(diff_test_res,file = fdif)<br>}<br>load(fdif)<br>ordering_genes &lt;- row.names (subset(diff_test_res, qval &lt; <span>0.01</span>))<br><span>#然后是查看基因，设置为排序要使用的基因</span><br>head(ordering_genes)<br><br><span>## [1] <span>"ISG15"</span>    <span>"SSU72"</span>    <span>"GNB1"</span>     <span>"TNFRSF14"</span> <span>"WRAP73"</span>   <span>"C1orf174"</span></span><br><br>sc_cds &lt;- setOrderingFilter(sc_cds, ordering_genes)<br>plot_ordering_genes(sc_cds)<br></code></pre><figure><img data-imgfileid="100011165" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoDPdniceMl0Zg8KnMyWYDYqESX26CA6f36sDgv4TRWE3op97ARQICPOdWYk8HS98TX6tc0vTTkO9g/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoDPdniceMl0Zg8KnMyWYDYqESX26CA6f36sDgv4TRWE3op97ARQICPOdWYk8HS98TX6tc0vTTkO9g/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><pre><code><span>#降维</span><br><span>sc_cds</span> &lt;- reduceDimension(sc_cds)<br><span>#细胞排序</span><br>sc_cds &lt;- orderCells(sc_cds)<br></code></pre><h4><span><span> </span>2.绘图展示</span></h4><p>发育轨迹图</p><pre><code>library(ggsci)<br>p1 = plot_cell_trajectory(sc_cds)+ scale_color_nejm()<br>p2 = plot_cell_trajectory(sc_cds, color_by = 'Pseudotime') <br>p3 = plot_cell_trajectory(sc_cds, color_by = 'celltype')  + scale_color_npg()<br>library(patchwork)<br>p2+p1/p3<br></code></pre><figure><img data-imgfileid="100011162" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoDPdniceMl0Zg8KnMyWYDYqTZkPPkYsoDHzrEswbYnpw6ADtFxT7mm95bsSkWUcXrbiakrsbMVFP1Q/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoDPdniceMl0Zg8KnMyWYDYqTZkPPkYsoDHzrEswbYnpw6ADtFxT7mm95bsSkWUcXrbiakrsbMVFP1Q/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><p>这三种着色方式放在一起非常的带劲，很清晰的展示了pseudotime、state和celltype是怎样变化的。</p><p>经典的拟时序热图</p><p>展示了一些基因是如何随着时间轨迹的变化而渐变的，这个渐变不同于findmarkers，是体现变化过程的，而不是直接给出差异表达的基因。</p><pre><code>gene_to_cluster = diff_test_res %&gt;% arrange(qval) %&gt;% head(<span>50</span>) %&gt;% pull(gene_short_name);head(gene_to_cluster)<br><br><span>## [1] <span>"FCGR3A"</span> <span>"PLAC8"</span>  <span>"MS4A4A"</span> <span>"MS4A7"</span>  <span>"LYZ"</span>    <span>"VMO1"</span></span><br><br>plot_pseudotime_heatmap(sc_cds[gene_to_cluster,],<br>                        num_clusters = nlevels(Idents(scRNA)), <br>                        show_rownames = <span>TRUE</span>,<br>                        cores = <span>4</span>,return_heatmap = <span>TRUE</span>,<br>                        hmcols = colorRampPalette(c(<span>"navy"</span>, <span>"white"</span>, <span>"firebrick3"</span>))(<span>100</span>))<br></code></pre><figure><img data-imgfileid="100011163" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoDPdniceMl0Zg8KnMyWYDYqfGBEibYv19DgPEvKPcO0T9OOhLpbmp6iavrJiakhFbTtoJLrUURK2BYFw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoDPdniceMl0Zg8KnMyWYDYqfGBEibYv19DgPEvKPcO0T9OOhLpbmp6iavrJiakhFbTtoJLrUURK2BYFw/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><p>用感兴趣的基因给轨迹图着色，gs可以换成你想换的基因</p><pre><code>gs = head(gene_to_cluster)<br>plot_cell_trajectory(sc_cds,markers=gs,<br>                     use_color_gradient=T)<br></code></pre><figure><img data-imgfileid="100011164" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoDPdniceMl0Zg8KnMyWYDYqSIawxwX5B7ZVFA333dAbJDT27CumU7PwvAkBegGRleaibSuYd9wdYow/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoDPdniceMl0Zg8KnMyWYDYqSIawxwX5B7ZVFA333dAbJDT27CumU7PwvAkBegGRleaibSuYd9wdYow/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><p>也可以是jitter</p><pre><code>plot_genes_jitter(sc_cds[gs,],<br>                  grouping = <span>"celltype"</span>,<br>                  color_by = <span>"celltype"</span>,<br>                  nrow= <span>3</span>,<br>                  ncol = <span>NULL</span> )<br></code></pre><figure><img data-imgfileid="100011166" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoDPdniceMl0Zg8KnMyWYDYqWPBOtLW15yVPSuDTnq6vJYYTG1fKo1d1pKFCIXuGJKibSwONNKdbpIg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoDPdniceMl0Zg8KnMyWYDYqWPBOtLW15yVPSuDTnq6vJYYTG1fKo1d1pKFCIXuGJKibSwONNKdbpIg/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure></section><p><br></p><p><br></p></section></section></section></section></section></section><section><section><br></section></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/PrpHYombUysHbg7s-7ImBw",target="_blank" rel="noopener noreferrer">原文链接</a>
