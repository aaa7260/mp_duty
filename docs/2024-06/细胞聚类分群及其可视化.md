---
title: "细胞聚类分群及其可视化"
date: 2024-06-05T03:47:24Z
draft: ["false"]
tags: [
  "fetched",
  "生信漫漫学"
]
categories: ["Acdemic"]
---
细胞聚类分群及其可视化 by 生信漫漫学
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span>前情提要</span><span></span></h3><p data-tool="mdnice编辑器">在上一期<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247522734&amp;idx=1&amp;sn=87543a75fa71c707908f582df51bad27&amp;scene=21#wechat_redirect" data-linktype="2">单细胞PCA降维结果理解</a>中给大家介绍了PCA降维，以及如何理解我们得到的降维结果。</p><p data-tool="mdnice编辑器">那在单细胞基本分析流程中，<strong>使用<code>RunPCA()</code>进行了单细胞数据进行了线性降维，那接下来基于降维结果，对细胞进行聚类分群</strong></p><p data-tool="mdnice编辑器">需要用到的主要是<code>FindNeighbors()以及FindClusters()</code>两个函数，那这期就一起来了解一下<strong>单细胞的聚类分群叭！</strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>FindNeighbors及FindClusters简介</span><span></span></h3><blockquote data-tool="mdnice编辑器"><span></span><p><strong>细胞聚类的目标是根据细胞中各个基因表达模式的相似性（或距离）将一组细胞分组变成大类</strong>，使得这些大类成为有数学意义的亚群</p></blockquote><p data-tool="mdnice编辑器"><strong>seurat包中应用了一种基于图的聚类方法</strong>:</p><ul data-tool="mdnice编辑器"><li><section><p>第一步: 根据 PCA 空间中的欧几里得距离构建一个k-最近邻（KNN，k-nearest neighbor）图，并根据任意两个单元格的局部邻域共享重叠——共享最近邻（SNN，shared nearest neighbor）细化任意两个单元之间的边权重两步来组成。使用函数<code>FindNeighbors()</code>执行</p></section></li><li><section><p>第二步: 应用模块化优化技术,默认使用Louvain算法来实现，在图中挑选相似度最高的一群细胞作为一个细胞亚群。使用函数<code>FindClusters()</code>来实现</p></section></li></ul><h3 data-tool="mdnice编辑器"><span></span><span></span><span>命令使用及参数介绍</span><span></span></h3><h4 data-tool="mdnice编辑器"><span></span><span>Ⅰ FindNeighbors</span><span></span></h4><figure data-tool="mdnice编辑器"><img data-imgfileid="100039141" data-ratio="1.4696969696969697" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbqtuZ3EKfNQ4fyxPoNjt3t5991uqLu5qhNcRwIozhlMDMhiaFfmYh5KA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="462" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbqtuZ3EKfNQ4fyxPoNjt3t5991uqLu5qhNcRwIozhlMDMhiaFfmYh5KA/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>sce &lt;- FindNeighbors(sce, reduction = <span>"pca"</span>,<br>                     dims = 1:15) <br></code></pre><p data-tool="mdnice编辑器"><strong>FindNeighbors</strong>的一般会选择三个参数：</p><ul data-tool="mdnice编辑器"><li><section><strong>object：</strong>输入经过降维后的数据</section></li><li><section><strong>reduction：</strong>选择降维的方法，比如pca或umap</section></li><li><section><strong>dim参数：</strong>选择多少个PCA的维度进行分析，也就是上一步PCA降维后我们依据肘部图选择的维度</section></li></ul><figure data-tool="mdnice编辑器"><img data-imgfileid="100039142" data-ratio="0.17314095449500555" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbHpoCYJTfLzdZ8RPzDlHITU7bMN4fSRHgvKLVcBGnUibbXpZZiaDSRIIQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="901" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbHpoCYJTfLzdZ8RPzDlHITU7bMN4fSRHgvKLVcBGnUibbXpZZiaDSRIIQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">返回的结果告诉我们，计算了<strong>最近邻图以及SNN</strong>，并将结果保存在<strong>graphs</strong>中</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039139" data-ratio="0.7084690553745928" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzb1eHQmPxOQmBmuaewFmgp6zHGWvJZzPtEHf2VRHYNmtZEDztT2eBSgw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="614" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzb1eHQmPxOQmBmuaewFmgp6zHGWvJZzPtEHf2VRHYNmtZEDztT2eBSgw/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>Ⅱ FindClusters</span><span></span></h4><figure data-tool="mdnice编辑器"><img data-imgfileid="100039138" data-ratio="1.4457274826789839" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbSSuzIXU3NSHK0T5Q0wibZyU24mfgib53icjUnic5puicSWo1VvGSwvDtoTw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="433" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbSSuzIXU3NSHK0T5Q0wibZyU24mfgib53icjUnic5puicSWo1VvGSwvDtoTw/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>#设置不同的分辨率，观察分群效果</span><br><span>for</span> (res <span>in</span> c(0.01, 0.05, 0.1, 0.2, 0.3, 0.5,0.8,1)) {<br>  sce.all=FindClusters(sce.all, <br>                       resolution = res, algorithm = 1)<br>}<br></code></pre><p data-tool="mdnice编辑器">FindClusters也是一般三个参数：</p><ul data-tool="mdnice编辑器"><li><section><strong>object：</strong>输入上一步返回的seurat数据</section></li><li><section><strong>resolution参数</strong>：resolution是分辨率，与最后的分群数目有关的，值越大得到的分群数目会越多。</section></li><li><section><strong>algorithm参数</strong>：模块化优化算法，1代表使用原始的Louvain算法</section></li></ul><p data-tool="mdnice编辑器">可以计算不同分辨率，<strong>结果会保存在metadata里面</strong>，可以查看计算一下不同分辨率得到的分群的数量</p><pre data-tool="mdnice编辑器"><span></span><code>colnames(sce.all@meta.data)<br><br>&gt; table(sce.all@meta.data<span>$RNA_snn_res</span>.1)<br><br>  0   1   2   3   4   5   6   7   8   9  10 <br>559 498 342 278 239 231 172 159 114  32  14 <br><br>&gt; table(sce.all@meta.data<span>$RNA_snn_res</span>.0.8)<br><br>  0   1   2   3   4   5   6   7   8 <br>610 520 467 342 319 175 159  32  14 <br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039140" data-ratio="0.4888888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbg160pF6jqlZplVeQqV9Kfq4OtEcngk8KH19mSLVFicMUXL2ppIhy2cg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbg160pF6jqlZplVeQqV9Kfq4OtEcngk8KH19mSLVFicMUXL2ppIhy2cg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>使用table()可以看到当前分辨率下的细胞分群及其中的细胞数量，也可以对不同分辨率的进行可视化，然后根据可视化结果去选择合适的分辨率</strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>不同分辨率结果可视化</span><span></span></h3><h4 data-tool="mdnice编辑器"><span></span><span>Ⅰ clustree树状图</span><span></span></h4><p data-tool="mdnice编辑器">使用聚类树（clustree ）可视化显示<strong>在多个分辨率下分群之间的关系，可以看到样本随着分群数量的增加而变化的情况</strong></p><pre data-tool="mdnice编辑器"><span></span><code>clustree(sce.all@meta.data, prefix = <span>"RNA_snn_res."</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039145" data-ratio="0.9990740740740741" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbRXpz0t5KpzkIpUmwfPhhx1oN4N74qvAVeHv7dYrCQeABNxHVlVLDSA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbRXpz0t5KpzkIpUmwfPhhx1oN4N74qvAVeHv7dYrCQeABNxHVlVLDSA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>clustree里面也有一系列的参数可以进行选择,在<span>clustree ：聚类可视化利器</span><sup>[1]</sup>中周运来老师就有详细介绍</strong></p><p data-tool="mdnice编辑器"><strong>因为使用的是pbmc3k的示例数据，里面有注释结果</strong>，所以参考周老师整理的代码，<strong>可视化一下不同分辨率下分群与之的匹配程度</strong></p><pre data-tool="mdnice编辑器"><span></span><code>sce.all=FindClusters(sce.all,  <br>                     resolution = c(seq(0,1.6,.2)), algorithm = 1)<br><br>label_position &lt;- <span>function</span>(labels) {<br>  <span>if</span> (length(unique(labels)) == 1) {<br>    position &lt;- as.character(unique(labels))<br>  } <span>else</span> {<br>    position &lt;- <span>"mixed"</span><br>  }<br>  <span>return</span>(position)<br>}<br><br>clustree(sce.all@meta.data, prefix = <span>"RNA_snn_res."</span>, node_label = <span>"seurat_annotations"</span>,<br>         node_label_aggr = <span>"label_position"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039146" data-ratio="0.9342592592592592" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbdWR4IcM2ULetoo9ftGjnKKCvoiaohiauXuUvNcLlicScMAfqMDoSzMpLg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbdWR4IcM2ULetoo9ftGjnKKCvoiaohiauXuUvNcLlicScMAfqMDoSzMpLg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">从结果可看到不同的分辨率下细胞亚群分类的情况，<strong>一般比较常用的分辨率是0.1、0.5、0.8，如果选择低分辨率比如0.1就会将细胞分成，如果选择0.5或者0.8较高的分辨率就可以对细胞进行细分比如将CD4T分为Naive和Memory CD4T</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039143" data-ratio="0.8443708609271523" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbjibDEVuShOC8TUKQzdMib6Xl9fczkKIQupQZIazX9UAib7lmJDj0QCjIw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="302" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbjibDEVuShOC8TUKQzdMib6Xl9fczkKIQupQZIazX9UAib7lmJDj0QCjIw/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>Ⅱ 桑基图</span><span></span></h4><p data-tool="mdnice编辑器">除了聚类图外，另一种比较常用的细胞聚类可视化的方法是桑基图</p><pre data-tool="mdnice编辑器"><span></span><code><span>#安装加载需要的R包</span><br>install.packages(<span>"ggalluvial"</span>)<br>library(ggalluvial)<br>library(tidyverse)<br><br><span>#基于metadata里面不同的分辨率绘制桑基图</span><br>head(sce.all@meta.data)<br>ggplot(data = sce.all@meta.data,<br>       aes(axis1 = RNA_snn_res.0.2, axis2 = RNA_snn_res.0.4,axis3 = RNA_snn_res.0.6,axis4 = RNA_snn_res.0.8,<br>           axis5 = RNA_snn_res.1,axis6 = RNA_snn_res.1.2)) +<br>  scale_x_discrete(limits = c(paste0(<span>"res."</span>,seq(.2,1.2,.2))), expand = c(.01, .05)) +<br>  geom_alluvium(aes(fill = RNA_snn_res.1.2)) +<br>  geom_stratum() + geom_text(<span>stat</span> = <span>"stratum"</span>, infer.label = TRUE) +<br>  <span>#coord_polar()+</span><br>  theme(axis.text.x = element_text(angle = 90, hjust = 1))+<br>  ggtitle(<span>"cell number in each cluster"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039147" data-ratio="0.7074074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzb3l4AbGEsS7LLn9hrtdQ2O7UB7h1R3IHd8W5qt7zHeTP4k2qjPhTn2w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzb3l4AbGEsS7LLn9hrtdQ2O7UB7h1R3IHd8W5qt7zHeTP4k2qjPhTn2w/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">基于桑基图的结果，我们可以看到<strong>中间分辨率下细胞亚群的来源以及可能的分群去向</strong>。</p><p data-tool="mdnice编辑器">同样桑基图也可以选择不同的参数，展示不同的内容，<span>桑基图在单细胞数据探索中的应用</span><sup>[2]</sup>中也给出了更加详细的介绍</p><h4 data-tool="mdnice编辑器"><span></span><span>Ⅲ balloonplot</span><span></span></h4><p data-tool="mdnice编辑器">也可以使用balloonplot简单可视化一下两个resolution中的细胞分群情况</p><pre data-tool="mdnice编辑器"><span></span><code>gplots::balloonplot(table(sce.all<span>$RNA_snn_res</span>.0.2,sce.all<span>$RNA_snn_res</span>.0.8))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039144" data-ratio="0.7360824742268042" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbAYk7sMpGWThMCMLVSTPPHx7TRq3dm9lO9kke3n6FElzG4OcDUibEYdg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="970" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbAYk7sMpGWThMCMLVSTPPHx7TRq3dm9lO9kke3n6FElzG4OcDUibEYdg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">可以看到<strong>在0.2下的0群提高分辨率后变为0.8中的0和1两个群，2群变为4和6两个群，与聚类树中的结果一致</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039150" data-ratio="0.4398148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbW3N9XpYQDlsAEH0ia9ibk5wt4N7E0MFba2TForV0SW9cymLvVv5ibauPA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbW3N9XpYQDlsAEH0ia9ibk5wt4N7E0MFba2TForV0SW9cymLvVv5ibauPA/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>不同PCA维度的细胞聚类区别</span><span></span></h3><p data-tool="mdnice编辑器">在上一期<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247522734&amp;idx=1&amp;sn=87543a75fa71c707908f582df51bad27&amp;scene=21#wechat_redirect" data-linktype="2">单细胞PCA降维结果理解</a>结尾中提到，可以使用肘部图去选择合适的维度（FindNeighbors中的dims参数）</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100039151" data-ratio="1.049074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbbPcpnEEKTOCFgaAQsQiadfAzwlXudayr0nicIKXzMuiatl5gyy9h1e5dQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbbPcpnEEKTOCFgaAQsQiadfAzwlXudayr0nicIKXzMuiatl5gyy9h1e5dQ/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>#dims=1:15</span><br><br>sce &lt;- FindNeighbors(sce, reduction = <span>"pca"</span>,<br>                     dims = 1:15) <br>sce.all=sce<br><br>sce.all=FindClusters(sce.all,  <br>                     resolution = 0.5, algorithm = 1)<br><br>DimPlot(sce.all,reduction = <span>'umap'</span>,label = T,repel = T)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039149" data-ratio="0.7074074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbAWa0JMALuyVEZhicaoS3teicMNYRtD5l4XSQDr42QqmzybZ4wickWW6sQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbAWa0JMALuyVEZhicaoS3teicMNYRtD5l4XSQDr42QqmzybZ4wickWW6sQ/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>sce2 &lt;- FindNeighbors(sce, reduction = <span>"pca"</span>,<br>                     dims = 1:30) <br>sce.all2=sce2<br><br>sce.all2=FindClusters(sce.all2,  <br>                     resolution = 0.5, algorithm = 1)<br><br>DimPlot(sce.all2,reduction = <span>'umap'</span>,label = T,repel = T)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039148" data-ratio="0.7074074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbD7ibOQ4SwOev6t8ia6QolGgjJIibP8XsCobibib6L82fBoTOGy5LqibLiceqQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbD7ibOQ4SwOev6t8ia6QolGgjJIibP8XsCobibib6L82fBoTOGy5LqibLiceqQ/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100039152" data-ratio="0.7074074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbBibWm8M1oS3hia8TzfyjQc80cianbsWwGulmBzdYBBBkoMsroXWAMjAibg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSMbM0nlibw9YQEU248DAQzbBibWm8M1oS3hia8TzfyjQc80cianbsWwGulmBzdYBBBkoMsroXWAMjAibg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>根据结果可以看到选择不同的PCA维度，在同一分辨率下细胞分群数量有些区别</strong></p><p data-tool="mdnice编辑器">在细胞聚类分群中，<strong>FindNeighbors的dim参数和FindClusters的resolution参数，都与最后的分群数目有关，可以根据样品情况和实际需求选择合适的PCA维度以及分辨率</strong></p><section data-tool="mdnice编辑器"><span>参考资料</span></section><section data-tool="mdnice编辑器"><span><span>[1]</span><p>clustree ：聚类可视化利器: <span>https://www.jianshu.com/p/f997c2f41c48</span></p></span><span><span>[2]</span><p>桑基图在单细胞数据探索中的应用: <span>https://www.jianshu.com/p/a7a6b8b11e3c</span></p></span></section></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/AwzoxFS8qPEZnY2sOhjU8g",target="_blank" rel="noopener noreferrer">原文链接</a>
