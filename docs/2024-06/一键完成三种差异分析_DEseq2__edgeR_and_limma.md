---
title: "一键完成三种差异分析：DEseq2, edgeR and limma"
date: 2024-06-08T10:20:06Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
一键完成三种差异分析：DEseq2, edgeR and limma by 生信菜鸟团
------
<div><h3>limma、edgeR、DESeq2原理</h3><p><img data-galleryid="" data-imgfileid="100038674" data-ratio="0.367003367003367" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCNbG4o3fNiaumUURYYtbfUTIBhfLfY3pvicibSmplmKW0JJ24YiaBaQOHEVq3Ee7ONqVSiaNdKD2nVDg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="594" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCNbG4o3fNiaumUURYYtbfUTIBhfLfY3pvicibSmplmKW0JJ24YiaBaQOHEVq3Ee7ONqVSiaNdKD2nVDg/640?wx_fmt=png&amp;from=appmsg"></p><p><span>Limma基于线性模型，通过使用贝叶斯方法估计每个基因的差异方差</span><span>。它使用经验贝叶斯方法来将信息从所有基因中借用，</span><span>特别是在样本较少时提高估计的稳定性</span><span>。</span></p><hr><p><br></p><p><span>edgeR基于负二项分布模型</span><span>。它使用贝叶斯方法通过适应组内变异估计提高估计的稳定性。</span><span>edgeR考虑了基因的丰度和变异性，使其更适用于RNA-Seq数据</span><span>。</span></p><hr><p><span><br></span></p><p><span>DESeq2基于负二项分布的模型</span><span>。它通过使用贝叶斯方法来考虑样本间的差异以及基因表达的离散性。</span></p><p><span><br></span></p><h2 data-tool="mdnice编辑器"><span>1. 安装和加载所需的包</span></h2><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span>.libPaths(</span></code><code><span>  c(</span></code><code><span>    '/home/rootyll/seurat_v5/',</span></code><code><span>    "/usr/local/lib/R/site-library",</span></code><code><span>    "/usr/lib/R/site-library",</span></code><code><span>    "/usr/lib/R/library"</span></code><code><span>  )</span></code><code><span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span># 安装必要的包，如果尚未安装</span></code><code><span>if (!requireNamespace("BiocManager", quietly = TRUE))</span></code><code><span>    install.packages("BiocManager")</span></code><code><span><br></span></code><code><span>#BiocManager::install(c("Biobase", "limma", "edgeR", "DESeq2", "biomaRt", "VennDiagram"))</span></code><code><span>如果安装失败，需要：</span></code><code><span>wget -c https://codeload.github.com/montilab/BS831/zip/refs/heads/master</span></code><code><span>unzip master</span></code><code><span>devtools::install_local("~/gzh/20240608_limma_deseq2_edegr/BS831-master/",dependencies = TRUE)</span></code><code><span><br></span></code><code><span><br></span></code><code><span># 加载必要的包</span></code><code><span>#devtools::install_github("montilab/BS831",dependencies = TRUE)</span></code><code><span>library(BS831)</span></code><code><span>library(Biobase)</span></code><code><span>library(limma)</span></code><code><span>library(edgeR)</span></code><code><span>library(DESeq2)</span></code><code><span>library(biomaRt)</span></code><code><span>library(VennDiagram)</span></code><code><span><br></span></code></pre></section><p><br></p><h2 data-tool="mdnice编辑器"><span>2. 定义包的封装函数</span></h2><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span>run_deseq &lt;- function(eset, class_id, control, treatment) {</span></code><code><span>  control_inds &lt;- which(pData(eset)[, class_id] == control)</span></code><code><span>  treatment_inds &lt;- which(pData(eset)[, class_id] == treatment)</span></code><code><span>  eset.compare &lt;- eset[, c(control_inds, treatment_inds)]</span></code><code><span><br></span></code><code><span>  colData &lt;- data.frame(condition=as.character(pData(eset.compare)[, class_id]))</span></code><code><span>  dds &lt;- DESeqDataSetFromMatrix(exprs(eset.compare), colData, formula( ~ condition))</span></code><code><span><br></span></code><code><span>  dds$condition &lt;- factor(dds$condition, levels=c(control,treatment))</span></code><code><span><br></span></code><code><span>  dds_res &lt;- DESeq(dds)</span></code><code><span>  res &lt;- results(dds_res)</span></code><code><span>  res$dispersion &lt;- dispersions(dds_res)</span></code><code><span>  return(res)</span></code><code><span>}</span></code><code><span><br></span></code><code><span><br></span></code><code><span>run_edgeR &lt;- function(eset, class_id, control, treatment) {</span></code><code><span>  control_inds &lt;- which(pData(eset)[, class_id] == control)</span></code><code><span>  treatment_inds &lt;- which(pData(eset)[, class_id] == treatment)</span></code><code><span><br></span></code><code><span>  eset.compare &lt;- eset[, c(control_inds, treatment_inds)]</span></code><code><span>  condition &lt;- as.character(pData(eset.compare)[, class_id])</span></code><code><span><br></span></code><code><span>  y &lt;- DGEList(counts=exprs(eset.compare), group = condition)</span></code><code><span>  y &lt;- calcNormFactors(y)</span></code><code><span>  y &lt;- estimateGLMCommonDisp(y)</span></code><code><span>  y &lt;- estimateGLMTrendedDisp(y)</span></code><code><span>  y &lt;- estimateGLMTagwiseDisp(y)</span></code><code><span>  et &lt;- exactTest(y)</span></code><code><span>  res &lt;- topTags(et, n = nrow(eset.compare), sort.by = "none")</span></code><code><span>  return(res)</span></code><code><span>}</span></code><code><span><br></span></code><code><span><br></span></code><code><span>run_limma &lt;- function(eset, class_id, control, treatment) {</span></code><code><span>  control_inds &lt;- which(pData(eset)[, class_id] == control)</span></code><code><span>  treatment_inds &lt;- which(pData(eset)[, class_id] == treatment)</span></code><code><span><br></span></code><code><span>  eset.compare &lt;- eset[, c(control_inds, treatment_inds)]</span></code><code><span>  condition &lt;- as.character(pData(eset.compare)[, class_id])</span></code><code><span>  colData &lt;- data.frame(condition=as.character(pData(eset.compare)[, class_id]))</span></code><code><span><br></span></code><code><span>  design &lt;- model.matrix(~ 0 + factor(condition))</span></code><code><span>  colnames(design) &lt;- levels(factor(condition))</span></code><code><span>  fit &lt;- lmFit(eset.compare, design)</span></code><code><span>  command_str &lt;- paste("makeContrasts(",</span></code><code><span>                       "(", treatment , "-", control, ")",</span></code><code><span>                       ",levels = design)", sep = "")</span></code><code><span><br></span></code><code><span>  contrast.matrix &lt;- eval(parse(text=command_str))</span></code><code><span>  fit2 &lt;- contrasts.fit(fit, contrast.matrix)</span></code><code><span>  fit2 &lt;- eBayes(fit2)</span></code><code><span>  res &lt;- topTable(fit2, coef=1, adjust="BH", sort.by = "none", number=Inf)</span></code><code><span>  return(res)</span></code><code><span>}</span></code><code><span><br></span></code></pre></section><p><span><br></span></p><p><br></p><h2 data-tool="mdnice编辑器"><span>3. 加载数据集</span></h2><p><strong>如果是你自己的数据，需要整理成这样的数据格式</strong></p><p><br></p><p><br></p><p><img data-galleryid="" data-imgfileid="100038670" data-ratio="0.33557951482479786" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCNbG4o3fNiaumUURYYtbfURniaw5ic8um3XB53VOibC1sePWE6nvFIeUxzCpicBPKpmzsJGCs4ZP1gbA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="742" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCNbG4o3fNiaumUURYYtbfURniaw5ic8um3XB53VOibC1sePWE6nvFIeUxzCpicBPKpmzsJGCs4ZP1gbA/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-galleryid="" data-imgfileid="100038671" data-ratio="0.2296416938110749" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCNbG4o3fNiaumUURYYtbfUicIthyn3fBUssL3msKPuicj3rkHmrJjoMu2KeDzFohze8ZsfTpNvf9SA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="614" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCNbG4o3fNiaumUURYYtbfUicIthyn3fBUssL3msKPuicj3rkHmrJjoMu2KeDzFohze8ZsfTpNvf9SA/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p><img data-galleryid="" data-imgfileid="100038672" data-ratio="0.46296296296296297" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCNbG4o3fNiaumUURYYtbfUWbZtt2WRD7pBAxsIyT8o5jRTdE6fx0XOjxRavI1Amd7RAUmRJUZYNw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="756" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCNbG4o3fNiaumUURYYtbfUWbZtt2WRD7pBAxsIyT8o5jRTdE6fx0XOjxRavI1Amd7RAUmRJUZYNw/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><h2 data-tool="mdnice编辑器"><span>4. 运行</span></h2><section><ul><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span>#4运行----</span></code><code><span>## see wrappers at code/diffanalWrappers.R</span></code><code><span><br></span></code><code><span>## run deseq2</span></code><code><span>res_deseq2 &lt;- run_deseq(eset=esetRaw , class_id="Group", control="Ctrl_DMSO", treatment="Ctrl_PN")</span></code><code><span><br></span></code><code><span>## run edgeR htseq counts</span></code><code><span>res_edgeR &lt;- run_edgeR(eset=esetRaw , class_id="Group", control="Ctrl_DMSO", treatment="Ctrl_PN")</span></code><code><span><br></span></code><code><span>## run limma with cufflinks fpkm log2-transformed data</span></code><code><span>res_limma &lt;- run_limma(eset=esetFPKM , class_id="Group", control="Ctrl_DMSO", treatment="Ctrl_PN")</span></code></pre></section><p><img data-galleryid="" data-imgfileid="100038673" data-ratio="0.35124378109452736" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCNbG4o3fNiaumUURYYtbfUAm64mVbbyfWrkKeaM5sZexM6EjENSYgObqDu3TkhmuaAYa2ztjuBYg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1005" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicCNbG4o3fNiaumUURYYtbfUAm64mVbbyfWrkKeaM5sZexM6EjENSYgObqDu3TkhmuaAYa2ztjuBYg/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><h2 data-tool="mdnice编辑器"><span>写在最后</span></h2><p><span><span>为了更好的理解三个不同的r包，还是希望读者可以亲自使用不同的r包，去体验一下整个流程。在已经熟悉r包的基础上，再使用函数随时调用</span></span></p><p><br></p><p><strong><span>不足之处，欢迎指正——生信小博士</span></strong></p><section><mp-common-profile data-pluginname="mpprofile" data-id="Mzg2NDcxMzYwNg==" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Sks7JhVxUX46ZKxPSob6ptqIZgnIEnHOn5VMwCX8sN6MQy1Pq4XXFEOJ6grAmsoQugyCDKOZictDBHA/0?wx_fmt=png" data-nickname="生信小博士" data-alias="bioinformatics_Dr" data-signature="【生物信息学】R语言开始，学习生信。Seurat，单细胞测序，空间转录组。 Python，scanpy，cell2location。资料分享" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><p><br></p><section><ul><li><li><li><li></ul><pre data-lang="javascript"><code><span>参考：</span></code><code><span>https:<span>//bioconductor.org/packages/release/workflows/vignettes/RNAseq123/inst/doc/limmaWorkflow.html</span></span></code><code><span>https:<span>//montilab.github.io/BS831/articles/docs/DiffanalysisRNAseqComparison.html</span></span></code><code><span>https:<span>//montilab.github.io/BS831/articles/docs/Diffanalysis.html</span></span></code></pre></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/9ya_JHhITUckcrWDquhvjA",target="_blank" rel="noopener noreferrer">原文链接</a>
