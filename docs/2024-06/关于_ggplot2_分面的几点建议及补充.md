---
title: "关于 ggplot2 分面的几点建议及补充"
date: 2024-06-03T02:26:04Z
draft: ["false"]
tags: [
  "fetched",
  "老俊俊的生信笔记"
]
categories: ["Acdemic"]
---
关于 ggplot2 分面的几点建议及补充 by 老俊俊的生信笔记
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-mpa-powered-by="yiban.io"><section><mp-common-profile data-pluginname="mpprofile" data-id="MzkyMTI1MTYxNA==" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usezgsqIGqjITSMggCTSoViaYeoKe2xoZr1IIvNJoztibQxibYHLDDoiabwAc6Ggws3Tvdo8EPss2nLgaVQ/0?wx_fmt=png" data-nickname="老俊俊的生信笔记" data-alias="JunJunLab" data-signature="老俊俊的生信技能和知识分享,我不是巨人,但你可以站在我的肩膀上更进一步!" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><section><mp-common-clmusic data-pluginname="insertaudio" type="1" music_name="暧昧" albumurl="http://wx.y.gtimg.cn/music/photo_new/T002R500x500M000001mtYql0hiGm2_1.jpg" singer="王菲" duration="281000" username="" music_source="1" is_vip="1" listenid="78238782917715553" count="0" avatar=""></mp-common-clmusic></section><h2 data-tool="mdnice编辑器"><span></span><span>引言</span><span></span></h2><blockquote data-tool="mdnice编辑器"><span>❝</span><p><strong>ggplot2</strong> 是一个强大的 R 语言可视化包, 在科研绘图方面占据着半壁江山, 其包也是有几百人的团队维护着, 进行及时的 bug 更新和升级。</p></blockquote><figure data-tool="mdnice编辑器"><img data-imgfileid="100029856" data-ratio="0.7805309734513274" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WRLc7ibIrxSGdicWMNcNTgCiau8RKbD7O5keVRX80fUsKGSfUuhAeMuzcg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="565" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WRLc7ibIrxSGdicWMNcNTgCiau8RKbD7O5keVRX80fUsKGSfUuhAeMuzcg/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100029858" data-ratio="0.562037037037037" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19W9c7lcLJIiaUD2gbduPddKhwDIdJh5T6hFXhMiaX0vC5DNYWkK1WOc4aA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19W9c7lcLJIiaUD2gbduPddKhwDIdJh5T6hFXhMiaX0vC5DNYWkK1WOc4aA/640?wx_fmt=png&amp;from=appmsg"></figure><blockquote data-tool="mdnice编辑器"><span>❝</span><p>我在绘图时也会遇见一些问题, 这次我们就 <strong>facet_wrap/facet_grid</strong> 分面来研究一下。</p></blockquote><h2 data-tool="mdnice编辑器"><span></span><span>安装</span><span></span></h2><pre data-tool="mdnice编辑器"><span></span><code><span># install.packages("devtools")</span><br>devtools::install_github(<span>"junjunlab/ggSCvis"</span>)<br><br><span># or</span><br>remotes::install_github(<span>"junjunlab/ggSCvis"</span>)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>了解分面</span><span></span></h2><blockquote data-tool="mdnice编辑器"><span>❝</span><p>首先了解一下分面机制运行的大概组成部分, <strong>facet</strong> 对象包含一系列方法(<strong>compute_layout/map_data/draw_panels...</strong>), 如果你想拓展它,你就可以对其中的方法进行修改或者增加新的方法:</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span>#' All `facet_*` functions returns a `Facet` object or an object of a</span><br><span>#' `Facet` subclass. This object describes how to assign data to different</span><br><span>#' panels, how to apply positional scales and how to lay out the panels, once</span><br><span>#' rendered.</span><br><span>#'</span><br><span>#' Extending facets can range from the simple modifications of current facets,</span><br><span>#' to very laborious rewrites with a lot of [gtable()] manipulation.</span><br><span>#' For some examples of both, please see the extension vignette.</span><br><span>#'</span><br><span>#' `Facet` subclasses, like other extendible ggproto classes, have a range</span><br><span>#' of methods that can be modified. Some of these are required for all new</span><br><span>#' subclasses, while other only need to be modified if need arises.</span><br><span>#'</span><br><span>#' The required methods are:</span><br><span>#'</span><br><span>#'   - `compute_layout`: Based on layer data compute a mapping between</span><br><span>#'   panels, axes, and potentially other parameters such as faceting variable</span><br><span>#'   level etc. This method must return a data.frame containing at least the</span><br><span>#'   columns `PANEL`, `SCALE_X`, and `SCALE_Y` each containing</span><br><span>#'   integer keys mapping a PANEL to which axes it should use. In addition the</span><br><span>#'   data.frame can contain whatever other information is necessary to assign</span><br><span>#'   observations to the correct panel as well as determining the position of</span><br><span>#'   the panel.</span><br><span>#'</span><br><span>#'   - `map_data`: This method is supplied the data for each layer in</span><br><span>#'   turn and is expected to supply a `PANEL` column mapping each row to a</span><br><span>#'   panel defined in the layout. Additionally this method can also add or</span><br><span>#'   subtract data points as needed e.g. in the case of adding margins to</span><br><span>#'   `facet_grid()`.</span><br><span>#'</span><br><span>#'   - `draw_panels`: This is where the panels are assembled into a</span><br><span>#'   `gtable` object. The method receives, among others, a list of grobs</span><br><span>#'   defining the content of each panel as generated by the Geoms and Coord</span><br><span>#'   objects. The responsibility of the method is to decorate the panels with</span><br><span>#'   axes and strips as needed, as well as position them relative to each other</span><br><span>#'   in a gtable. For some of the automatic functions to work correctly, each</span><br><span>#'   panel, axis, and strip grob name must be prefixed with "panel", "axis", and</span><br><span>#'   "strip" respectively.</span><br><span>#'</span><br><span>#' In addition to the methods described above, it is also possible to override</span><br><span>#' the default behaviour of one or more of the following methods:</span><br><span>#'</span><br><span>#'   - `setup_params`:</span><br><span>#'   - `init_scales`: Given a master scale for x and y, create panel</span><br><span>#'   specific scales for each panel defined in the layout. The default is to</span><br><span>#'   simply clone the master scale.</span><br><span>#'</span><br><span>#'   - `train_scales`: Based on layer data train each set of panel</span><br><span>#'   scales. The default is to train it on the data related to the panel.</span><br><span>#'</span><br><span>#'   - `finish_data`: Make last-minute modifications to layer data</span><br><span>#'   before it is rendered by the Geoms. The default is to not modify it.</span><br><span>#'</span><br><span>#'   - `draw_back`: Add a grob in between the background defined by the</span><br><span>#'   Coord object (usually the axis grid) and the layer stack. The default is to</span><br><span>#'   return an empty grob for each panel.</span><br><span>#'</span><br><span>#'   - `draw_front`: As above except the returned grob is placed</span><br><span>#'   between the layer stack and the foreground defined by the Coord object</span><br><span>#'   (usually empty). The default is, as above, to return an empty grob.</span><br><span>#'</span><br><span>#'   - `draw_labels`: Given the gtable returned by `draw_panels`,</span><br><span>#'   add axis titles to the gtable. The default is to add one title at each side</span><br><span>#'   depending on the position and existence of axes.</span><br><span>#'</span><br><span>#' All extension methods receive the content of the params field as the params</span><br><span>#' argument, so the constructor function will generally put all relevant</span><br><span>#' information into this field. The only exception is the `shrink`</span><br><span>#' parameter which is used to determine if scales are retrained after Stat</span><br><span>#' transformations has been applied.</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>facet_wrap</span><span></span></h2><p data-tool="mdnice编辑器">默认画个分面:</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(ggplot2)<br><span>library</span>(ggSCvis)<br><br>base &lt;- ggplot(mtcars, aes(mpg, drat)) +<br>  geom_point()<br><br>base + facet_wrap(~cyl)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029857" data-ratio="0.6140979689366786" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WYA2Qd82oGNkSqChHXIQuCQblIR0KTZGMQbhnX3AtjJIYVwQPu0rLMQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="837" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WYA2Qd82oGNkSqChHXIQuCQblIR0KTZGMQbhnX3AtjJIYVwQPu0rLMQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">如果我想把 <strong>strip</strong> 放到外面, 发现并没有起作用:</p><pre data-tool="mdnice编辑器"><span></span><code>base + facet_wrap(~cyl) +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.wrap = unit(<span>0.1</span>,<span>"npc"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029855" data-ratio="0.6131736526946108" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19Wopg5aYV1ZqHTLr5QQGpqttwG0w9m6UYcusGjn8MBeQpzVVzM3m6l4g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="835" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19Wopg5aYV1ZqHTLr5QQGpqttwG0w9m6UYcusGjn8MBeQpzVVzM3m6l4g/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">你需要指定 <strong>strip.position</strong> 在其他位置才会起作用(不包括 <strong>top</strong>):</p><pre data-tool="mdnice编辑器"><span></span><code>base + facet_wrap(~cyl,strip.position = <span>"bottom"</span>) +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.wrap = unit(<span>0.1</span>,<span>"npc"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029854" data-ratio="0.6148325358851675" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WVZpzEA5mCIV1SJNibbKrqz6HMRsubLsBGiaum2Gho18ScsYFo0G9n4HA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="836" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WVZpzEA5mCIV1SJNibbKrqz6HMRsubLsBGiaum2Gho18ScsYFo0G9n4HA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">当图形分布涉及多行时候,只会在其中一个 <strong>panel</strong> 起作用:</p><pre data-tool="mdnice编辑器"><span></span><code>base + facet_wrap(~cyl,strip.position = <span>"bottom"</span>,<br>                  ncol = <span>2</span>) +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.wrap = unit(<span>0.1</span>,<span>"npc"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029861" data-ratio="0.617505995203837" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WbLOQpQ0rM5WsQiaYfnSlPA6bpYsgLVMgFbIcHOOtibNu9iaibUuU6oI1cg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="834" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WbLOQpQ0rM5WsQiaYfnSlPA6bpYsgLVMgFbIcHOOtibNu9iaibUuU6oI1cg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">而当在 <strong>left</strong> 时亦是如此, 当在 <strong>right</strong> 时则没有作用:</p><pre data-tool="mdnice编辑器"><span></span><code>base + facet_wrap(~cyl,strip.position = <span>"left"</span>) +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.wrap = unit(<span>0.1</span>,<span>"npc"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029863" data-ratio="0.6183115338882283" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19W4fymZ2Pvd1iaico0Fdauvib94INussR4YjVNjnD6BImicfdgqcyRb69p9g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="841" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19W4fymZ2Pvd1iaico0Fdauvib94INussR4YjVNjnD6BImicfdgqcyRb69p9g/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>base + facet_wrap(~cyl,strip.position = <span>"right"</span>) +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.wrap = unit(<span>0.1</span>,<span>"npc"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029860" data-ratio="0.6208133971291866" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WIPoeQ1WprPgoAZbvAyJ2cHDZWwsWlJ6XwtaoO5Xw0C7064F2qjhEpw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="836" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WIPoeQ1WprPgoAZbvAyJ2cHDZWwsWlJ6XwtaoO5Xw0C7064F2qjhEpw/640?wx_fmt=png&amp;from=appmsg"></figure><hr data-tool="mdnice编辑器"><blockquote data-tool="mdnice编辑器"><span>❝</span><p>我们去看源码部分, 关于 <strong>strip</strong> 的生成和下面代码相关, 经过测试你便可以发现问题的所在, 然后对其进行修改矫正:</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>strip_padding &lt;- convertUnit(calc_element(<span>"strip.switch.pad.wrap"</span>, theme), <span>"cm"</span>)<br>    strip_name &lt;- paste0(<span>"strip-"</span>, substr(params$strip.position, <span>1</span>, <span>1</span>))<br>    strip_mat &lt;- empty_table<br>    strip_mat[panel_pos] &lt;- unlist(unname(strips), recursive = <span>FALSE</span>)[[params$strip.position]]<br>    <span>if</span> (params$strip.position %<span>in</span>% c(<span>"top"</span>, <span>"bottom"</span>)) {<br>      inside_x &lt;- (theme$strip.placement.x %||% theme$strip.placement %||% <span>"inside"</span>) == <span>"inside"</span><br>      <span>if</span> (params$strip.position == <span>"top"</span>) {<br>        placement &lt;- <span>if</span> (inside_x) -<span>1</span> <span>else</span> -<span>2</span><br>        strip_pad &lt;- axis_size$top<br>      } <span>else</span> {<br>        placement &lt;- <span>if</span> (inside_x) <span>0</span> <span>else</span> <span>1</span><br>        strip_pad &lt;- axis_size$bottom<br>      }<br>      strip_height &lt;- unit(apply(strip_mat, <span>1</span>, max_height, value_only = <span>TRUE</span>), <span>"cm"</span>)<br>      panel_table &lt;- weave_tables_row(panel_table, strip_mat, placement, strip_height, strip_name, <span>2</span>, coord$clip)<br>      <span>if</span> (!inside_x) {<br>        strip_pad[as.numeric(strip_pad) != <span>0</span>] &lt;- strip_padding<br>        panel_table &lt;- weave_tables_row(panel_table, row_shift = placement, row_height = strip_pad)<br>      }<br>    } <span>else</span> {<br>      inside_y &lt;- (theme$strip.placement.y %||% theme$strip.placement %||% <span>"inside"</span>) == <span>"inside"</span><br>      <span>if</span> (params$strip.position == <span>"left"</span>) {<br>        placement &lt;- <span>if</span> (inside_y) -<span>1</span> <span>else</span> -<span>2</span><br>        strip_pad &lt;- axis_size$left<br>      } <span>else</span> {<br>        placement &lt;- <span>if</span> (inside_y) <span>0</span> <span>else</span> <span>1</span><br>        strip_pad &lt;- axis_size$right<br>      }<br>      strip_pad[as.numeric(strip_pad) != <span>0</span>] &lt;- strip_padding<br>      strip_width &lt;- unit(apply(strip_mat, <span>2</span>, max_width, value_only = <span>TRUE</span>), <span>"cm"</span>)<br>      panel_table &lt;- weave_tables_col(panel_table, strip_mat, placement, strip_width, strip_name, <span>2</span>, coord$clip)<br>      <span>if</span> (!inside_y) {<br>        strip_pad[as.numeric(strip_pad) != <span>0</span>] &lt;- strip_padding<br>        panel_table &lt;- weave_tables_col(panel_table, col_shift = placement, col_width = strip_pad)<br>      }<br>    }<br></code></pre><p data-tool="mdnice编辑器">我重新命名为 <strong>facet_wrapnew</strong> 函数, 然后进行验证看看, 发现可以正常工作:</p><pre data-tool="mdnice编辑器"><span></span><code>base +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.wrap = unit(<span>0.05</span>,<span>"npc"</span>)) +<br>  facet_wrapnew(~cyl,strip.position = <span>"top"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029859" data-ratio="0.6176821983273596" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WicRelCc7DSRQ1hyufibHIhF1hR7HJKKTkYm4ATLoPBfian0sJRFNFia6OA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="837" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WicRelCc7DSRQ1hyufibHIhF1hR7HJKKTkYm4ATLoPBfian0sJRFNFia6OA/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>base +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.wrap = unit(<span>0.05</span>,<span>"npc"</span>)) +<br>  facet_wrapnew(~cyl,strip.position = <span>"bottom"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029862" data-ratio="0.6140979689366786" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WV9jYx0eIzOkLFspXc22g5d5Zfyj2F4FpHIPHMFQPzZCgrbibZcEHE9Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="837" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WV9jYx0eIzOkLFspXc22g5d5Zfyj2F4FpHIPHMFQPzZCgrbibZcEHE9Q/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>base + theme(strip.placement = <span>"outside"</span>,<br>               strip.switch.pad.wrap = unit(<span>0.05</span>,<span>"npc"</span>)) +<br>  facet_wrapnew(~cyl,strip.position = <span>"right"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029869" data-ratio="0.6214285714285714" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WyrnDO6OIDqib8S2yIKX9KA4u66cGkBgCfBxG5kggmaBo4D5ULUaL8Bg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="840" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WyrnDO6OIDqib8S2yIKX9KA4u66cGkBgCfBxG5kggmaBo4D5ULUaL8Bg/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>base + theme(strip.placement = <span>"outside"</span>,<br>             strip.switch.pad.wrap = unit(<span>0.05</span>,<span>"npc"</span>)) +<br>  facet_wrapnew(~cyl,strip.position = <span>"left"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029865" data-ratio="0.6087470449172577" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WIyH4WNUIIvFeThpeLsQg3D6IQahux9iaZ5rWTPm3Lz71zNhANLvUsZw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="846" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WIyH4WNUIIvFeThpeLsQg3D6IQahux9iaZ5rWTPm3Lz71zNhANLvUsZw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">多行情况下也是可以工作:</p><pre data-tool="mdnice编辑器"><span></span><code>base +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.wrap = unit(<span>0.05</span>,<span>"npc"</span>)) +<br>  facet_wrapnew(~cyl,strip.position = <span>"top"</span>,<br>                ncol = <span>2</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029866" data-ratio="0.6080760095011877" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WLn8jhbu4ALVibEbWB670bDKiaddhBlGLfcmzeeq9s5z8ibewNbiaIb43OQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="842" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WLn8jhbu4ALVibEbWB670bDKiaddhBlGLfcmzeeq9s5z8ibewNbiaIb43OQ/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>base +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.wrap = unit(<span>0.05</span>,<span>"npc"</span>)) +<br>  facet_wrapnew(~cyl,strip.position = <span>"left"</span>,<br>                ncol = <span>2</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029864" data-ratio="0.6123662306777645" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WsNw6MafMJIGh2U7syj1ian4RkeE1N2HewSzEHjlw7pJ3rAXZg6wAd1Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="841" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WsNw6MafMJIGh2U7syj1ian4RkeE1N2HewSzEHjlw7pJ3rAXZg6wAd1Q/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>facet_grid</span><span></span></h2><blockquote data-tool="mdnice编辑器"><span>❝</span><p><strong>facet_grid</strong> 也是存在一些问题:</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>base +<br>  theme(strip.placement = <span>"outside"</span>,<br>    strip.switch.pad.grid = unit(<span>0.1</span>,<span>"npc"</span>)) +<br>  facet_grid(cyl~am)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029867" data-ratio="0.6119760479041916" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WpW7jSuYicqze518LfSRY5KUF4m6HqNFiaTfdOHpcDLdJPS6OVfABjrEA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="835" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WpW7jSuYicqze518LfSRY5KUF4m6HqNFiaTfdOHpcDLdJPS6OVfABjrEA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">设置 <strong>switch</strong> 参数才可生效:</p><pre data-tool="mdnice编辑器"><span></span><code>base +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.grid = unit(<span>0.1</span>,<span>"npc"</span>)) +<br>  facet_grid(cyl~am,<span>switch</span> = <span>"both"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029872" data-ratio="0.6123662306777645" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WwZSLyIiaXq3iaUxY9A6TcwhJttppYsUzfeC0C9JRPOib1gIWapzOuNjPw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="841" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WwZSLyIiaXq3iaUxY9A6TcwhJttppYsUzfeC0C9JRPOib1gIWapzOuNjPw/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>base +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.grid = unit(<span>0.1</span>,<span>"npc"</span>)) +<br>  facet_grid(cyl~am,<span>switch</span> = <span>"x"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029870" data-ratio="0.6239520958083832" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WkV0lLQOngBqjibH0a84iaPnfX2jFsa0icnoF2McQiaJMgEKE4hoa9UxzSg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="835" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WkV0lLQOngBqjibH0a84iaPnfX2jFsa0icnoF2McQiaJMgEKE4hoa9UxzSg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">相关源码如下:</p><pre data-tool="mdnice编辑器"><span></span><code><span># Add strips</span><br>    switch_x &lt;- !is.null(params$<span>switch</span>) &amp;&amp; params$<span>switch</span> %<span>in</span>% c(<span>"both"</span>, <span>"x"</span>)<br>    switch_y &lt;- !is.null(params$<span>switch</span>) &amp;&amp; params$<span>switch</span> %<span>in</span>% c(<span>"both"</span>, <span>"y"</span>)<br>    inside_x &lt;- (theme$strip.placement.x %||% theme$strip.placement %||% <span>"inside"</span>) == <span>"inside"</span><br>    inside_y &lt;- (theme$strip.placement.y %||% theme$strip.placement %||% <span>"inside"</span>) == <span>"inside"</span><br>    strip_padding &lt;- convertUnit(calc_element(<span>"strip.switch.pad.grid"</span>, theme), <span>"cm"</span>)<br>    panel_pos_col &lt;- panel_cols(panel_table)<br>    <span>if</span> (switch_x) {<br>      <span>if</span> (!is.null(strips$x$bottom)) {<br>        <span>if</span> (inside_x) {<br>          panel_table &lt;- gtable_add_rows(panel_table, max_height(strips$x$bottom), -<span>2</span>)<br>          panel_table &lt;- gtable_add_grob(panel_table, strips$x$bottom, -<span>2</span>, panel_pos_col$l, clip = <span>"on"</span>, name = paste0(<span>"strip-b-"</span>, seq_along(strips$x$bottom)), z = <span>2</span>)<br>        } <span>else</span> {<br>          <span>if</span> (!all(vapply(axes$x$bottom, is.zero, logical(<span>1</span>)))) {<br>            panel_table &lt;- gtable_add_rows(panel_table, strip_padding, -<span>1</span>)<br>          }<br>          panel_table &lt;- gtable_add_rows(panel_table, max_height(strips$x$bottom), -<span>1</span>)<br>          panel_table &lt;- gtable_add_grob(panel_table, strips$x$bottom, -<span>1</span>, panel_pos_col$l, clip = <span>"on"</span>, name = paste0(<span>"strip-b-"</span>, seq_along(strips$x$bottom)), z = <span>2</span>)<br>        }<br>      }<br>    } <span>else</span> {<br>      <span>if</span> (!is.null(strips$x$top)) {<br>        <span>if</span> (inside_x) {<br>          panel_table &lt;- gtable_add_rows(panel_table, max_height(strips$x$top), <span>1</span>)<br>          panel_table &lt;- gtable_add_grob(panel_table, strips$x$top, <span>2</span>, panel_pos_col$l, clip = <span>"on"</span>, name = paste0(<span>"strip-t-"</span>, seq_along(strips$x$top)), z = <span>2</span>)<br>        } <span>else</span> {<br>          <span>if</span> (!all(vapply(axes$x$top, is.zero, logical(<span>1</span>)))) {<br>            panel_table &lt;- gtable_add_rows(panel_table, strip_padding, <span>0</span>)<br>          }<br>          panel_table &lt;- gtable_add_rows(panel_table, max_height(strips$x$top), <span>0</span>)<br>          panel_table &lt;- gtable_add_grob(panel_table, strips$x$top, <span>1</span>, panel_pos_col$l, clip = <span>"on"</span>, name = paste0(<span>"strip-t-"</span>, seq_along(strips$x$top)), z = <span>2</span>)<br>        }<br>      }<br>    }<br>    panel_pos_rows &lt;- panel_rows(panel_table)<br>    <span>if</span> (switch_y) {<br>      <span>if</span> (!is.null(strips$y$left)) {<br>        <span>if</span> (inside_y) {<br>          panel_table &lt;- gtable_add_cols(panel_table, max_width(strips$y$left), <span>1</span>)<br>          panel_table &lt;- gtable_add_grob(panel_table, strips$y$left, panel_pos_rows$t, <span>2</span>, clip = <span>"on"</span>, name = paste0(<span>"strip-l-"</span>, seq_along(strips$y$left)), z = <span>2</span>)<br>        } <span>else</span> {<br>          <span>if</span> (!all(vapply(axes$y$left, is.zero, logical(<span>1</span>)))) {<br>            panel_table &lt;- gtable_add_cols(panel_table, strip_padding, <span>0</span>)<br>          }<br>          panel_table &lt;- gtable_add_cols(panel_table, max_width(strips$y$left), <span>0</span>)<br>          panel_table &lt;- gtable_add_grob(panel_table, strips$y$left, panel_pos_rows$t, <span>1</span>, clip = <span>"on"</span>, name = paste0(<span>"strip-l-"</span>, seq_along(strips$y$left)), z = <span>2</span>)<br>        }<br>      }<br>    } <span>else</span> {<br>      <span>if</span> (!is.null(strips$y$right)) {<br>        <span>if</span> (inside_y) {<br>          panel_table &lt;- gtable_add_cols(panel_table, max_width(strips$y$right), -<span>2</span>)<br>          panel_table &lt;- gtable_add_grob(panel_table, strips$y$right, panel_pos_rows$t, -<span>2</span>, clip = <span>"on"</span>, name = paste0(<span>"strip-r-"</span>, seq_along(strips$y$right)), z = <span>2</span>)<br>        } <span>else</span> {<br>          <span>if</span> (!all(vapply(axes$y$right, is.zero, logical(<span>1</span>)))) {<br>            panel_table &lt;- gtable_add_cols(panel_table, strip_padding, -<span>1</span>)<br>          }<br>          panel_table &lt;- gtable_add_cols(panel_table, max_width(strips$y$right), -<span>1</span>)<br>          panel_table &lt;- gtable_add_grob(panel_table, strips$y$right, panel_pos_rows$t, -<span>1</span>, clip = <span>"on"</span>, name = paste0(<span>"strip-r-"</span>, seq_along(strips$y$right)), z = <span>2</span>)<br>        }<br>      }<br>    }<br></code></pre><p data-tool="mdnice编辑器">修改后测试:</p><pre data-tool="mdnice编辑器"><span></span><code>base +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.grid = unit(<span>0.1</span>,<span>"npc"</span>)) +<br>  facet_gridnew(cyl~am)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029874" data-ratio="0.6140979689366786" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19W1lVBcJ9uTK75icOXUZ5J0G4thwWC8uiaiaMNfQIfiaJ7RE8ZjLFQdLDDxg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="837" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19W1lVBcJ9uTK75icOXUZ5J0G4thwWC8uiaiaMNfQIfiaJ7RE8ZjLFQdLDDxg/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>base +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.grid = unit(<span>0.1</span>,<span>"npc"</span>)) +<br>  facet_gridnew(cyl~am,<span>switch</span> = <span>"both"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029873" data-ratio="0.6142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19W3H0qeyZoXqicquRwCOp37yiaRohkPicBCj085icYbZ8Qpn4qMRAhghaj7Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="840" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19W3H0qeyZoXqicquRwCOp37yiaRohkPicBCj085icYbZ8Qpn4qMRAhghaj7Q/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>base +<br>  theme(strip.placement = <span>"outside"</span>,<br>        strip.switch.pad.grid = unit(<span>0.1</span>,<span>"npc"</span>)) +<br>  facet_gridnew(cyl~am,<span>switch</span> = <span>"y"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100029871" data-ratio="0.6140142517814727" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WzkibFsSo1enqOy3iajF8Dx8D1vVLsVHpZ0A1H5ItDaaV7Gn2OYvn9zyw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="842" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WzkibFsSo1enqOy3iajF8Dx8D1vVLsVHpZ0A1H5ItDaaV7Gn2OYvn9zyw/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>结尾</span><span></span></h2><blockquote data-tool="mdnice编辑器"><span>❝</span><p><strong>路漫漫其修远兮,吾将上下而求索。</strong></p></blockquote><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">欢迎加入生信交流群。加我微信我也拉你进 <strong>微信群聊</strong> <strong>老俊俊生信交流群</strong> <strong>(微信交流群需收取 20 元入群费用,一旦交费,拒不退还!(防止骗子和便于管理))</strong> 。QQ 群可免费加入, 记得进群按格式修改备注哦。</p><section data-tool="mdnice编辑器"><section><p><strong>老俊俊微信：</strong></p><figure><img data-imgfileid="100029878" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19W0WVYqIdeB4T9zZkIGkSLLDKck9rgEPNXfJiaqlnGKpxNXQ5Yq4jJFbQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="430" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19W0WVYqIdeB4T9zZkIGkSLLDKck9rgEPNXfJiaqlnGKpxNXQ5Yq4jJFbQ/640?wx_fmt=png&amp;from=appmsg"></figure><figure><img data-imgfileid="100029879" data-ratio="1.3668430335097002" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19Wj687mtKP830Fkl6t4wULI6M4ibI9jccxR0UrM8PA7uws5VyF8CJUPEQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="567" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4useymC7yjpwz3R1EJMd2eJ19Wj687mtKP830Fkl6t4wULI6M4ibI9jccxR0UrM8PA7uws5VyF8CJUPEQ/640?wx_fmt=png&amp;from=appmsg"></figure></section><section><p><strong>知识星球：</strong></p><figure><img data-imgfileid="100029877" data-ratio="1.5896226415094339" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WdQYj4FmLv8ictPPjU3n34UkRzyX48VOQZvXZUavxvBQtUFAgOcictFhg/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1060" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/G5jjcE4useymC7yjpwz3R1EJMd2eJ19WdQYj4FmLv8ictPPjU3n34UkRzyX48VOQZvXZUavxvBQtUFAgOcictFhg/640?wx_fmt=jpeg&amp;from=appmsg"></figure></section></section><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器"><strong></strong></p><center data-tool="mdnice编辑器"><strong> 往期回顾目录</strong></center><blockquote data-tool="mdnice编辑器"><span>❝</span><p><strong></strong></p><center><strong><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247513497&amp;idx=1&amp;sn=099c2c64ad62fbd0cfed434cf6c9efe6&amp;chksm=c1848fe8f6f306fe1a50d1c1e40edaad3b22940d5be76b87a78d3cf6b31d593d144c66a82640&amp;token=1130224323&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">关于 footprint 可视化总结</a></strong></center><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247513431&amp;idx=1&amp;sn=3817318720a1e6dec2274a9a5fdcabd9&amp;chksm=c1848f26f6f30630827c14c6ca2be924431b0f3844b28643a5d2880237774770d457e9c563f3&amp;token=1097809733&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">facet_sub 为 ggplot2 添加子图</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247513411&amp;idx=1&amp;sn=bf63f98e52053ad1c150fa6e3772ba28&amp;chksm=c1848f32f6f30624f6d20e7a19a6d7844f35875938d6554ebc835f900c0a58e5ed72106d1d44&amp;token=1097809733&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">单细胞小提琴图添加注释标明细胞类型</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247513387&amp;idx=1&amp;sn=13cb381408b3617b4fa4fb8f2b6a6b11&amp;chksm=c1848f5af6f3064c3159a7d7d3ce762fdca06a5699937ce747e9aa58ac9a23e3e5860b0e665a&amp;token=1953734631&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">蛋白序列无序区预测</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247513364&amp;idx=1&amp;sn=1eb4f13862354cb83108259b94f91d4c&amp;chksm=c1848f65f6f30673439c87d56444071b06cc8c7d926fbeced36e20e171f1da92c321a7d6c3d3&amp;token=1953734631&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">蛋白功能结构域查询</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247513343&amp;idx=1&amp;sn=760a9460b4942bebb87467b38445b428&amp;chksm=c1848e8ef6f30798a40679861d8bdcd35e640c135cb3c13cee593b203eda69fd46fd9f0b61e3&amp;token=572330817&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">circRNA 芯片数据分析</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247513266&amp;idx=1&amp;sn=f1a5f983dba54e3f1a36b8334344bebe&amp;chksm=c1848ec3f6f307d54ce69093708af9b1be0d6c593492034d60fd3b84520afd1c5e914975297e&amp;token=572330817&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">homer 结果可视化还用愁?</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247513224&amp;idx=1&amp;sn=86883b37af63f0be22018d70ac744919&amp;chksm=c1848ef9f6f307ef119125d9d04bebe933bde350787346449de12dfea51bea5224ce7b86992e&amp;token=1368479419&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">monaLisa: motif 富集分析</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247513202&amp;idx=1&amp;sn=4c96ea0db4628f354a349420525f9809&amp;chksm=c1848e03f6f307151fdc3d0571471f50fec9448b77807a2a9b92546006e1c2b08eb05d871d4d&amp;token=1368479419&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">rgt-hint 转录因子预测结果可视化(续)</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247513180&amp;idx=1&amp;sn=51e30d1b04182f55bb0c23901a37a36a&amp;chksm=c1848e2df6f3073bb4f5c00f60cd1c6725fe08992431cf0aadee3563bb8db3a2c0cf170c634e&amp;token=896011679&amp;lang=zh_CN&amp;poc_token=HP5gMmajxs0JmmG1VFdSTh9aDqshMc0eJZ_Jp5Av&amp;scene=21#wechat_redirect" data-linktype="2">rgt-hint 转录因子预测结果可视化</a></center></strong><p><br></p></blockquote></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/IaXfUkqgsPmFoTOn8F6j8g",target="_blank" rel="noopener noreferrer">原文链接</a>
