---
title: "Python转录组学分析框架：Omicverse的安装以及差异分析"
date: 2024-06-10T14:42:54Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
Python转录组学分析框架：Omicverse的安装以及差异分析 by 生信技能树
------
<div><section data-tool="markdown编辑器" data-website="https://markdown.com.cn/editor"><section data-tool="markdown.com.cn编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span></span></h1><p data-tool="mdnice编辑器"><strong>OmicVerse是用Python进行多组学（包括Bulk和单细胞分析）的基础框架。</strong>前面我们在&lt;生信技能树&gt;公众号宣传过一波; <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247523045&amp;idx=1&amp;sn=678221b6a58e720150a0a00f7933886d&amp;chksm=9b4bda5eac3c5348fe350b3568f85694dff0df84b52f92fe948e2e9d4e13a8620e82b35b0d06&amp;scene=21#wechat_redirect" textvalue="Python的转录组学分析框架与生态" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">Python的转录组学分析框架与生态</a>，因为是需要去github点star后发邮件才能进群交流，所以操作门槛有点高， 我们后续再次开放拉群小助手给大家哈。</p><p data-tool="mdnice编辑器">欲了解更多信息，请阅读我们的论文：OmicVerse: A single pipeline for exploring the entire transcriptome universe</p><p data-tool="mdnice编辑器">omicverse最初的名字是Pyomic，但我们希望涵盖整个转录组学的领域，因此将其改名为OmicVerse，旨在解决RNA-seq中的所有任务。目前omicverse已加入<code>scverse</code>生态。您可以在<code>scverse</code>的官网上找到我们。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6398148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxVQM0iav8H8eZ3NN63gKvzjKfibLcnTvUG8dvSAGRHxr3XJyB2uoK1OrMcJ6apib8tqHHia9MtgYebMg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxVQM0iav8H8eZ3NN63gKvzjKfibLcnTvUG8dvSAGRHxr3XJyB2uoK1OrMcJ6apib8tqHHia9MtgYebMg/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span>安装前准备</h2><p data-tool="mdnice编辑器">OmicVerse可以通过conda或pypi进行安装，不过您需要先安装<code>pytorch</code></p><blockquote data-tool="mdnice编辑器"><p>为避免潜在的依赖冲突，建议在<code>conda</code>环境中安装。并使用<code>pip install -U omicverse</code>进行更新。</p></blockquote><h3 data-tool="mdnice编辑器"><span></span>平台<span></span></h3><p data-tool="mdnice编辑器">在不同的平台上，最合适的安装方法有所不同。</p><ul data-tool="mdnice编辑器"><li><section><code>Windows</code>：我们建议安装<code>wsl</code>子系统，并在wsl子系统中安装<code>conda</code>以配置omicverse环境。</section></li><li><section><code>Linux</code>：我们可以选择安装anaconda或miniconda，然后使用conda来配置omicverse环境。</section></li><li><section><code>Mac Os</code>：我们建议使用<code>miniforge</code>或<code>mambaforge</code>进行配置。</section></li></ul><h3 data-tool="mdnice编辑器"><span></span>pip前提条件<span></span></h3><ul data-tool="mdnice编辑器"><li><section>如果使用conda/mamba，则只需运行<code>conda install -c anaconda pip</code>并跳过此部分。</section></li><li><section>安装Python，我们推荐使用pyenv版本管理系统，以及pyenv-virtualenv。</section></li></ul><h3 data-tool="mdnice编辑器"><span></span>Apple Silicon前提条件<span></span></h3><p data-tool="mdnice编辑器">在装有Apple Silicon的Mac上安装omicverse只能使用本机版本的Python。可以通过使用Apple Silicon版本的mambaforge（可以通过本机版本的homebrew通过<code>brew install --cask mambaforge</code>进行安装）来安装本机版本的Python。</p><h2 data-tool="mdnice编辑器"><span></span>Conda</h2><ol data-tool="mdnice编辑器"><li><section><p>安装conda。我们通常使用<code>mambaforge</code>发行版。使用python&gt;=3.8，conda考虑使用mamba代替conda。</p></section></li><li><section><p>创建一个新的conda环境：</p><pre><span></span><code>conda create -n omicverse python=3.8<br></code></pre></section></li><li><section><p>激活您的环境：</p><pre><span></span><code>conda activate omicverse<br></code></pre></section></li><li><section><p>首先安装PyTorch：</p><pre><span></span><code>conda install pytorch torchvision torchaudio pytorch-cuda=11.7 -c pytorch -c nvidia<br></code></pre></section></li><li><section><p>安装<code>omicverse</code>：</p><pre><span></span><code>conda install omicverse -c conda-forge<br></code></pre></section></li></ol><h2 data-tool="mdnice编辑器"><span></span>Pip</h2><p data-tool="mdnice编辑器">可以使用以下命令之一通过pip安装<code>omicverse</code>包：</p><ol data-tool="mdnice编辑器"><li><section><p>首先安装PyTorch：有关安装的更多信息可以在PyTorch找到。</p><pre><span></span><code><span>#</span><span> ROCM 5.2（仅限Linux）</span><br>pip3 install torch torchvision torchaudio --extra-index-url<br>pip install torch==1.13.1+rocm5.2 torchvision==0.14.1+rocm5.2 torchaudio==0.13.1 --extra-index-url https://download.pytorch.org/whl/rocm5.2<br><span>#</span><span> CUDA 11.6</span><br>pip install torch==1.13.1+cu116 torchvision==0.14.1+cu116 torchaudio==0.13.1 --extra-index-url https://download.pytorch.org/whl/cu116<br><span>#</span><span> CUDA 11.7</span><br>pip install torch==1.13.1+cu117 torchvision==0.14.1+cu117 torchaudio==0.13.1 --extra-index-url https://download.pytorch.org/whl/cu117<br><span>#</span><span> 仅限CPU</span><br>pip install torch==1.13.1+cpu torchvision==0.14.1+cpu torchaudio==0.13.1 --extra-index-url https://download.pytorch.org/whl/cpu<br></code></pre></section></li><li><section><p>在安装pytorch之后，我们可以通过<code>pip</code>开始安装<code>omicverse</code></p><pre><span></span><code>pip install -U omicverse<br>pip install -U numba<br></code></pre></section></li><li><section><p>如果您想使用测试版，请有两种方法供您安装</p></section></li></ol><ul><li><section>测试版 - 克隆此repo并运行：<code>pip install .</code></section></li><li><section>使用<code>pip install git+https://github.com/Starlitnightly/omicverse.git</code></section></li></ul><h2 data-tool="mdnice编辑器"><span></span>开发者版本</h2><p data-tool="mdnice编辑器">用于开发者测试的版本 - 克隆此repo并运行：</p><pre data-tool="mdnice编辑器"><span></span><code>pip install -e ".[dev,docs]"<br></code></pre></section></section><section data-tool="markdown编辑器" data-website="https://markdown.com.cn/editor"><section data-tool="markdown.com.cn编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span></span>Python版RNA-seq分析教程：差异表达基因分析</h1><p data-tool="mdnice编辑器">Bulk RNA-seq 分析的一个重要任务是分析差异表达基因，我们可以用 <code>omicverse</code>包来完成这个任务。对于差异表达分析而言，首先，我们可以先将 gene_id 改为 gene_name。其次，当我们的数据集存在批量效应时，我们可以使用 DEseq2的 SizeFactor 对其进行归一化，从统计学上，使用 wilcoxon的秩和检验或者 t-test来计算基因的 p 值。也可以使用类似<code>edgeR</code>，<code>Deseq2</code>等包的模型来计算p值。在这里，我们用一个从RNA-seq上游的定量包<code>FeatureCounts</code>生成的表达矩阵来演示差异表达分析的流程。我们的流程适用于任何Bulk RNA-seq的差异表达分析。</p><h2 data-tool="mdnice编辑器"></h2><h2 data-tool="mdnice编辑器"><span></span>环境的下载</h2><p data-tool="mdnice编辑器">在这里我们只需要安装<code>omicverse</code>环境即可，有两个方法：</p><ul data-tool="mdnice编辑器"><li><section>一个是使用conda：<code>conda install omicverse -c conda-forge</code></section></li><li><section>另一个是使用pip：<code>pip install omicverse  -i https://pypi.tuna.tsinghua.edu.cn/simple/</code>。<code>-i</code>的意思是指定清华镜像源，在国内可能会下载地快一些。</section></li></ul><h2 data-tool="mdnice编辑器"><span></span>导入包</h2><p data-tool="mdnice编辑器">我们首先导入分析需要用到的所有包，包括<code>omicverse</code>, <code>pandas</code>, <code>numpy</code>, <code>scanpy</code> <code>matplotlib</code>   和 <code>seaborn</code>.</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> omicverse <span>as</span> ov<br><span>import</span> pandas <span>as</span> pd<br><span>import</span> numpy <span>as</span> np<br><span>import</span> scanpy <span>as</span> sc<br><span>import</span> matplotlib.pyplot <span>as</span> plt<br><span>import</span> seaborn <span>as</span> sns<br><br><span>#设定绘图格式，分辨率300dpi等</span><br>ov.utils.ov_plot_set()<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>下载基因集</h2><p data-tool="mdnice编辑器">当我们需要转换基因 id 时，我们需要准备一个映射对文件。在这里，我们预处理了6个基因组 gtf 文件和生成的映射对，包括 T2T-CHM13，GRCh38，GRCh37，GRCm39，danRer7和 danRer11。如果需要转换其他 id，可以使用 gtf 将文件放在 genesets 目录中生成自己的映射。</p><pre data-tool="mdnice编辑器"><span></span><code>ov.utils.download_geneid_annotation_pair()<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>读取数据</h2><pre data-tool="mdnice编辑器"><span></span><code>data=pd.read_csv(<span>'https://raw.githubusercontent.com/Starlitnightly/ov/master/sample/counts.txt'</span>,index_col=<span>0</span>,sep=<span>'\t'</span>,header=<span>1</span>)<br><span>#replace the columns `.bam` to `` </span><br>data.columns=[i.split(<span>'/'</span>)[<span>-1</span>].replace(<span>'.bam'</span>,<span>''</span>) <span>for</span> i <span>in</span> data.columns]<br>data.head()<br></code></pre><p data-tool="mdnice编辑器">值得注意的是，我们的数据集并没有经过任何处理，<code>featurecounts</code>比对时用的gtf为<code>GRCm39</code>，所以我们这里用<code>GRCm39</code>来做基因id映射</p><h2 data-tool="mdnice编辑器"><span></span>基因id转换</h2><pre data-tool="mdnice编辑器"><span></span><code>data=ov.bulk.Matrix_ID_mapping(data,<span>'genesets/pair_GRCm39.tsv'</span>)<br>data.head()<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>差异表达分析</h2><p data-tool="mdnice编辑器">我们可以非常简单地通过omicverse进行差异表达基因分析，只需要提供一个表达式矩阵。我们首先创建一个 <code>pyDEG</code> 对象，并使用<code>drop_duplicates_index</code>去除重复的基因。由于部分基因名相同，我们的去除保留了表达量最大的基因名。</p><pre data-tool="mdnice编辑器"><span></span><code>dds=ov.bulk.pyDEG(data)<br>dds.drop_duplicates_index()<br>print(<span>'... drop_duplicates_index success'</span>)<br></code></pre><p data-tool="mdnice编辑器">我们还需要去除表达矩阵的批次效应 (batch effect)，我们使用DEseq2的的 SizeFactor 来对我们的矩阵计算归一化因子来去除批次效应。</p><pre data-tool="mdnice编辑器"><span></span><code>dds.normalize()<br>print(<span>'... estimateSizeFactors and normalize success'</span>)<br></code></pre><p data-tool="mdnice编辑器">现在我们可以从表达矩阵中计算差异表达基因，在计算前我们需要输入实验组和对照组。在这里，我们指定 <code>4-3</code>和<code>4-4</code>为实验组，<code>1--1</code>, <code>1--2</code>为对照组，使用<code>ttest</code>进行差异表达分析计算。当然你也可以使用<code>wilcox</code>来计算。此外<code>deseq2</code>也是支持的，不过流程可能会有一些区别，我们放到下一期讲。</p><pre data-tool="mdnice编辑器"><span></span><code>treatment_groups=[<span>'4-3'</span>,<span>'4-4'</span>]<br>control_groups=[<span>'1--1'</span>,<span>'1--2'</span>]<br>result=dds.deg_analysis(treatment_groups,control_groups,method=<span>'ttest'</span>)<br>result.head()<br></code></pre><p data-tool="mdnice编辑器">在计算完差异表达基因后，我们会发现一个重要的事情，就是低表达基因有很多，如果我们不对其进行过滤，会影响后续火山图的绘制，我们设定基因的平均表达量大于1作为阈值，将平均表达量低于1的基因全部过滤掉。</p><pre data-tool="mdnice编辑器"><span></span><code>print(result.shape)<br>result=result.loc[result[<span>'log2(BaseMean)'</span>]&gt;<span>1</span>]<br>print(result.shape)<br></code></pre><p data-tool="mdnice编辑器">我们还需要设置 Foldchange 的阈值，我们准备了一个名为 <code>foldchange_set</code> 的方法函数来完成。此函数根据 log2FC 分布自动计算适当的阈值，但您也可以手动输入阈值。该函数有三个参数：</p><ul data-tool="mdnice编辑器"><li><section>fc_threshold: 差异表达倍数的阈值，-1为自动计算</section></li><li><section>pval_threshold: 差异表达基因的p-value过滤值，默认为0.05，在有些情况下可以设定为0.1，意味着统计学差异不显著。</section></li><li><section>logp_max: p值的最大值，由于部分p值过小，甚至为0，取对数后火山图绘制较为困难，我们可以设定一个上限，高于这个上限的p值全部统一。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span># -1 means automatically calculates</span><br>dds.foldchange_set(fc_threshold=<span>-1</span>,<br>                   pval_threshold=<span>0.05</span>,<br>                   logp_max=<span>6</span>)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>差异表达的结果可视化</h2><p data-tool="mdnice编辑器">omicverse除了有较为完善的分析能力外，还有极强的可视化能力。首先是火山图，我们使用  <code>plot_volcano</code>函数来实现。该函数可以绘制你感兴趣的基因或高表达的基因。您需要输入一些参数:</p><ul data-tool="mdnice编辑器"><li><section>title: 火山图的标题</section></li><li><section>figsize: 图像大小</section></li><li><section>plot_genes: 需要绘制的基因，格式为list。如<code>['Gm8925','Snorc']</code></section></li><li><section>plot_genes_num: 需要绘制的基因数，该参数与<code>plot_genes</code>互斥，如果我们没有指定需要绘制的基因，可以自动绘制前n个高差异表达倍数的基因。</section></li></ul><p data-tool="mdnice编辑器">此外，我们还可以指定绘制的颜色等，具体的参数可以使用<code>help(dds.plot_volcano)</code>来查看</p><pre data-tool="mdnice编辑器"><span></span><code>dds.plot_volcano(title=<span>'DEG Analysis'</span>,figsize=(<span>4</span>,<span>4</span>),<br>                 plot_genes_num=<span>8</span>,plot_genes_fontsize=<span>12</span>,)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.1507293354943273" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxVQM0iav8H8eZ3NN63gKvzjPtVqqAGveQkrJPkQR7VrbJ1FtqmicFzeZjXY1GR7DxfAN8nqic7m1F8g/640?wx_fmt=png" data-type="png" data-w="617" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxVQM0iav8H8eZ3NN63gKvzjPtVqqAGveQkrJPkQR7VrbJ1FtqmicFzeZjXY1GR7DxfAN8nqic7m1F8g/640?wx_fmt=png"><figcaption>差异表达火山图</figcaption></figure><p data-tool="mdnice编辑器">如果我们想绘制特定的基因的箱线图，我们也可以使用 <code>plot_boxplot</code> 函数来完成该任务。</p><pre data-tool="mdnice编辑器"><span></span><code>dds.plot_boxplot(genes=[<span>'Ckap2'</span>,<span>'Lef1'</span>],treatment_groups=treatment_groups,<br>                control_groups=control_groups,figsize=(<span>2</span>,<span>3</span>),fontsize=<span>12</span>,<br>                 legend_bbox=(<span>2</span>,<span>0.55</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7728" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxVQM0iav8H8eZ3NN63gKvzj5Q3kLGZHblia4iaa5NovDr2LSNoJwFNoKoxKibC4ccYsBQyTuE9doERuw/640?wx_fmt=png" data-type="png" data-w="625" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxVQM0iav8H8eZ3NN63gKvzj5Q3kLGZHblia4iaa5NovDr2LSNoJwFNoKoxKibC4ccYsBQyTuE9doERuw/640?wx_fmt=png"><figcaption>差异表达箱线图</figcaption></figure><h2 data-tool="mdnice编辑器"><span></span>通路富集分析</h2><p data-tool="mdnice编辑器">在差异表达基因计算出来后，我们需要直接进行的下一步分析往往是看差异表达的基因与哪些通路相关，这里我们常用的方法是富集分析。omicverse可以一键完成富集分析并且可视化。</p><p data-tool="mdnice编辑器">我们封装了<code>gseapy</code> 包进入omicverse，其中包括 GSEA 富集分析的相关功能。我们优化了包的输出，并给出了一些更好看的图形绘制功能</p><p data-tool="mdnice编辑器">类似地，我们首先需要下载通路数据库。我们已经准备好了五个基因集，可以使用 ov.utils.download_pathway_database()进行自动下载。除此之外，你还可以在以下网站找到你感兴趣的基因集：https://maayanlab.cloud/enrichr/#libraries</p><pre data-tool="mdnice编辑器"><span></span><code>ov.utils.download_pathway_database()<br><span>#读取通路基因集，我们读取Wiki通路数据库</span><br>pathway_dict=ov.utils.geneset_prepare(<span>'genesets/WikiPathways_2019_Mouse.txt'</span>,organism=<span>'Mouse'</span>)<br></code></pre><p data-tool="mdnice编辑器">我们提取前面的差异表达基因来进行通路富集</p><pre data-tool="mdnice编辑器"><span></span><code><span>#差异表达基因提取</span><br>deg_genes=dds.result.loc[dds.result[<span>'sig'</span>]!=<span>'normal'</span>].index.tolist()<br><span>#通路富集分析</span><br>enr=ov.bulk.geneset_enrichment(gene_list=deg_genes,<br>                                pathways_dict=pathway_dict,<br>                                pvalue_type=<span>'auto'</span>,<br>                                organism=<span>'mouse'</span>)<br></code></pre><p data-tool="mdnice编辑器">我们可以使用geneset_plot来可视化通路富集的结果</p><pre data-tool="mdnice编辑器"><span></span><code>ov.bulk.geneset_plot(enr,figsize=(2,5),fig_title=<span>'Wiki Pathway enrichment'</span>,<br>                        cmap=<span>'Reds'</span>)<br><span>#如果需要保存的话,使用`plt.savefig`来保存图像</span><br>plt.savefig(<span>"enr_pathway.png"</span>,dpi=300,bbox_inches = <span>'tight'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.8840749414519906" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxVQM0iav8H8eZ3NN63gKvzjzXicxW4VibUwMrbvcItbZzZtFf5KsnKeCpByxseyf5NibkgZVvibia8OMfA/640?wx_fmt=png" data-type="png" data-w="854" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxVQM0iav8H8eZ3NN63gKvzjzXicxW4VibUwMrbvcItbZzZtFf5KsnKeCpByxseyf5NibkgZVvibia8OMfA/640?wx_fmt=png"><figcaption>通路富集结果</figcaption></figure></section></section><section data-tool="markdown编辑器" data-website="https://markdown.com.cn/editor"><h3 data-tool="markdown.com.cn编辑器"><span></span>如果你也想使用如此便捷的一站式Python工具<span></span></h3><p data-tool="markdown.com.cn编辑器">因为<span>前面我们</span><span>在</span><span>&lt;生信技能树</span><span>&gt;公众号</span><span>宣传过一波;</span><span> </span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247523045&amp;idx=1&amp;sn=678221b6a58e720150a0a00f7933886d&amp;chksm=9b4bda5eac3c5348fe350b3568f85694dff0df84b52f92fe948e2e9d4e13a8620e82b35b0d06&amp;scene=21#wechat_redirect" textvalue="Python的转录组学分析框架与生态" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">Python的转录组学分析框架与生态</a><span>，</span><span>因为是需要去github点star后发邮件才能进群交流，所以操作门槛有点高， 我们后续再次开放拉群小助手给大家</span><span>哈。</span></p><p data-tool="mdnice编辑器">因为交流群早就满200人，所以没办法通过二维码进群了哈。这个时候需要我们生信技能树的官方拉群小助手帮忙拉群哦！！！</p><p data-tool="mdnice编辑器">（免费，但是名额有限，500人，先到先得！！！另外，因为每次人数太多， 所以是<span><strong>每天上午十点准时拉群</strong></span>，其他时间不予回复，望见谅）</p><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><p><span><strong><span>长按识别二维码</span></strong></span></p><p><br></p><p><span><strong><span>烦请备注姓名学校单位信息以及Python</span></strong></span></p><p><img data-ratio="1.0287769784172662" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosickmVcW0l8px8WgmyDMn5eHrkIDyib4m6Q8JqPY9kpCyibaDGD2f0Qv6fofUKc1cf8MHemJ9fX2hiawQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="278" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosickmVcW0l8px8WgmyDMn5eHrkIDyib4m6Q8JqPY9kpCyibaDGD2f0Qv6fofUKc1cf8MHemJ9fX2hiawQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p></section></section></section></section></section></section></section></section></section></section></section><p data-tool="markdown.com.cn编辑器"><span><br></span></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/fIRVMNHFcffCuCzh_Qozhw",target="_blank" rel="noopener noreferrer">原文链接</a>
