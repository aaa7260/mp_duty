---
title: "cell2location：结直肠癌肝转移数据分析（一）"
date: 2024-06-21T00:31:25Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
cell2location：结直肠癌肝转移数据分析（一） by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">本次根据cell2location教程，使用一篇文献中的数据进行单细胞+空转数据整合分析，目的是对空间转录组数据进行单细胞亚群注释。</p><p data-tool="mdnice编辑器">大致分析思路如下：</p><ul data-tool="mdnice编辑器"><li><section><p><strong>Step1</strong>：预处理文献单细胞数据，整理为scanpy包中的anndata对象，为h5ad格式</p></section></li><li><section><p><strong>Step2</strong>：对单细胞h5ad格式数据进行 细胞类型signatures评估，即estimate the reference cell type signatures</p></section></li><li><section><p><strong>Step3</strong>：预处理文献空间转录组数据，整理为scanpy包中的anndata对象，为h5ad格式</p></section></li><li><section><p><strong>Step4</strong>：利用单细胞亚群signature，对空间转录组数据进行spatial mapping</p></section></li><li><section><p><strong>Step5</strong>：空间切片中 注释到的 细胞亚群 可视化，也可以与原文的整合结果进行比较看看</p></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span>数据介绍</span><span></span></h2><p data-tool="mdnice编辑器">本次数据来自文献：</p><p data-tool="mdnice编辑器">Spatiotemporal Immune Landscape of  Colorectal Cancer Liver Metastasis at Single-Cell Level</p><p data-tool="mdnice编辑器">Cancer Discov（<strong>IF 28.2/Q1</strong>）. 2022 Jan;12(1):134-153. doi: 10.1158/2159-8290.CD-21-0316. Epub 2021 Aug 20</p><p data-tool="mdnice编辑器">从这篇文献中，我需要获取的信息有以下两点：</p><p data-tool="mdnice编辑器"><strong>1.文献中的数据下载地址</strong>：http://www.cancerdiversity.asia/scCRLM，单细胞为R语言中的rda格式数据，空间为space ranger 软件的标准输出文件</p><p data-tool="mdnice编辑器"><strong>2.文献中单细胞+空间转录组数据整合分析方法</strong>：Seurat包进行整合</p><p data-tool="mdnice编辑器"><strong>3.样本情况：</strong></p><p data-tool="mdnice编辑器"><strong>数据情况如A图</strong>：总共有来自24个病人的97例配对的单细胞和空间转录组数据，所有肿瘤均为微卫星稳定型</p><p data-tool="mdnice编辑器">Cohort1：89个单细胞样本</p><p data-tool="mdnice编辑器">Cohort2：8个空间转录组样本</p><p data-tool="mdnice编辑器">Cohort3：27个IHC样本</p><p data-tool="mdnice编辑器">Cohort4：133个芯片样本</p><p data-tool="mdnice编辑器">Cohort5：430个常规bulk转录组样本</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100000380" data-ratio="0.2631077216396568" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/by7zpDFL3LLqW1Pia1ib2SP0wuUnFxqHehzjgHhnnxts9yay446wO2WW8E4n2RLvSria5iayy22Ns0GuNbZnWESADA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1049" src="https://mmbiz.qpic.cn/sz_mmbiz_png/by7zpDFL3LLqW1Pia1ib2SP0wuUnFxqHehzjgHhnnxts9yay446wO2WW8E4n2RLvSria5iayy22Ns0GuNbZnWESADA/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20240526153036334</figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>Step1：预处理文献单细胞数据</span><span></span></h2><p data-tool="mdnice编辑器">文献中提供的单细胞数据为两个rda格式：metadata.rda 和 exprmatrix.rda，整理为scanpy包中的anndata对象，为h5ad格式</p><h3 data-tool="mdnice编辑器"><span></span><span>先读入R对象数据，转为h5ad格式的scanpy对象AnnData</span><span></span></h3><p data-tool="mdnice编辑器">此部分命令在R中运行：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br><br>library(Seurat)<br><br>opt &lt;- list(input=<span>"./data/scCRLM/data/"</span>,<br>            od=<span>"./data/scCRLM/"</span>)<br><br>setwd(opt<span>$od</span>)<br><br><span>## 加载metadata</span><br>load(paste0(opt<span>$input</span>, <span>"/metadata.rda"</span>))<br>head(metadata)<br>table(metadata<span>$main_cell_type</span>)<br>table(metadata<span>$sub_cell_type</span>)<br>table(metadata<span>$orig</span>.ident)<br>table(metadata<span>$patient</span>)<br>table(metadata<span>$tissue</span>)<br><br><br><span>## 加载单细胞表达矩阵</span><br>load(paste0(opt<span>$input</span>, <span>"/exprmatrix.rda"</span>))<br>head(colnames(exprmatrix))<br>dim(exprmatrix)<br>dim(metadata)<br><br>scRNA &lt;- CreateSeuratObject(counts = exprmatrix, meta.data = metadata)<br>scRNA<br><br><span>## 简单看一下数据的各种指标</span><br>scRNA[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(scRNA, pattern = <span>"^MT-"</span>)<br>p &lt;- VlnPlot(scRNA, features = c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>, <span>"percent.mt"</span>), ncol = 3, pt.size = 0)<br>ggsave(filename = paste0(opt<span>$od</span>,<span>"/01_qc.png"</span>), width = 12, height = 5.5, <span>bg</span> = <span>"white"</span>, plot = p)<br></code></pre><p data-tool="mdnice编辑器">数据应该是已经进行过滤后的数据了：有178630个细胞，与文献中的是可以对应上的。回去看了一眼文献的质控，做的比较粗糙。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100000379" data-ratio="0.4449901768172888" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/by7zpDFL3LLqW1Pia1ib2SP0wuUnFxqHeh6Yx9KHnEKpkXR13bHLlhts9xrIb4WtYOBcia2q4dIEOAgEplQjIQZ5w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1018" src="https://mmbiz.qpic.cn/sz_mmbiz_png/by7zpDFL3LLqW1Pia1ib2SP0wuUnFxqHeh6Yx9KHnEKpkXR13bHLlhts9xrIb4WtYOBcia2q4dIEOAgEplQjIQZ5w/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20240525234458063</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span>保存一下数据：</span><span></span></h3><p data-tool="mdnice编辑器">推荐大家使用qs进行大数量</p><pre data-tool="mdnice编辑器"><span></span><code>qs::qsave(scRNA, <span>"scRNA.qs"</span>)<br><span># scRNA = qs::qread("scRNA.qs")</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>现在进行Seurat转为h5ad格式</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>#remotes::install_github("mojaveazure/seurat-disk")</span><br><span>### 方式3的详细版本 https://mp.weixin.qq.com/s/eq5XUXXZ8HusXlBlXVFJVA</span><br>library(SeuratData)<br>library(SeuratDisk)<br><br>seurat_object &lt;- scRNA<br>seu &lt;- DietSeurat(<br>  seurat_object,<br>  counts = TRUE, <span># so, raw counts save to adata.raw.X</span><br>  data = TRUE, <span># so, log1p counts save to adata.X</span><br>  scale.data = FALSE, <span># set to false, or else will save to adata.X</span><br>  features = rownames(seurat_object), <span># export all genes, not just top highly variable genes</span><br>  assays = <span>"RNA"</span>,<br>  dimreducs = c(<span>"pca"</span>,<span>"umap"</span>),<br>  graphs = c(<span>"RNA_nn"</span>, <span>"RNA_snn"</span>), <span># to RNA_nn -&gt; distances, RNA_snn -&gt; connectivities</span><br>  misc = TRUE<br>)<br><br><span># step 2: factor to character, or else your factor will be number in adata</span><br>i &lt;- sapply(seu@meta.data, is.factor)<br>seu@meta.data[i] &lt;- lapply(seu@meta.data[i], as.character)<br><br><span># step 3: convert</span><br>SaveH5Seurat(seu, filename = <span>"scRNA.h5seurat"</span>, overwrite = TRUE)<br>Convert(<span>"scRNA.h5seurat"</span>, <span>"scRNA.h5ad"</span>, assay=<span>"RNA"</span>, overwrite = TRUE)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>现在使用python读取查看数据结构</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>import scanpy as sc<br><br>dir = <span>'./data/scCRLM/'</span><br>adata = sc.read_h5ad(f<span>'{dir}scRNA.h5ad'</span>)<br><span>print</span>(adata)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000378" data-ratio="0.03148148148148148" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/by7zpDFL3LLqW1Pia1ib2SP0wuUnFxqHeh3YPa4ycAnkxhTaTwqfZ3rqNdxlvGzmeBagPOHJIciasxK552iby58ABw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/by7zpDFL3LLqW1Pia1ib2SP0wuUnFxqHeh3YPa4ycAnkxhTaTwqfZ3rqNdxlvGzmeBagPOHJIciasxK552iby58ABw/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20240527003832744</figcaption></figure><p data-tool="mdnice编辑器">使用scanpy包探索一下anndata对象结构</p><p data-tool="mdnice编辑器">X为矩阵数据，obs为观察值，var为变量；</p><p data-tool="mdnice编辑器">scanpy软件使用obs存储细胞信息，var存储基因信息。</p><pre data-tool="mdnice编辑器"><span></span><code><span>#查看AnnData</span><br><span>print</span>(adata)<br><span>print</span>(adata.X)<br><span>print</span>(adata.obs.index)<br><span>print</span>(adata.to_df().head())<br></code></pre><p data-tool="mdnice编辑器">AnnData object with n_obs × n_vars = 178630 × 20610</p><p data-tool="mdnice编辑器"><strong>X</strong>：为矩阵数据</p><p data-tool="mdnice编辑器"><strong>n_obs</strong>：细胞数目 178630</p><p data-tool="mdnice编辑器"><strong>n_vars</strong>：基因数目 20610</p><p data-tool="mdnice编辑器"><strong>obs:</strong> 相当于细胞的 meta.data</p><p data-tool="mdnice编辑器"><strong>var</strong>：相当于基因的 meta.data</p><p data-tool="mdnice编辑器"><strong>uns</strong>：存储分析方法及参数</p><p data-tool="mdnice编辑器"><strong>obsm</strong>：存储降维坐标等多维信息</p><p data-tool="mdnice编辑器"><strong>obsp</strong>：存储点与点之间的关系</p><p data-tool="mdnice编辑器"><strong>layers</strong>：存储数据，类似于Seurat中的data、counts卡槽</p><p data-tool="mdnice编辑器">获取基本的信息</p><pre data-tool="mdnice编辑器"><span></span><code><span># 获取细胞名</span><br>adata.obs.index.to_list()<br>adata.obs.index.to_list()[1:6]<br><br><span># 获取基因名</span><br>adata.var.index.to_list() <br>adata.var.index.to_list()[1:10]<br><br><span># 细胞数目</span><br>adata.n_obs<br><br><span># 基因数目</span><br>adata.n_vars <br><br><span># 查看obs某列的值</span><br>adata.obs[<span>'main_cell_type'</span>].values.tolist()[1:5]<br><br><span># 可查看每个细胞barcode对应细胞类型</span><br>pd.DataFrame({<span>'barcode'</span>:adata.obs.index.to_list(),<span>'main_cell_type'</span>:adata.obs.main_cell_type.to_list()})<br><br><span># 可查看细胞类型种类</span><br>adata.obs.main_cell_type.value_counts()<br><br><span># 获取当前object的Variable featurelevels</span><br>adata[:, adata.var.highly_variable].var.index <br><br><span># 存储旧的细胞标签</span><br>adata.obs[<span>'cluster'</span>]=adata.obs.seurat_clusters<br></code></pre><p data-tool="mdnice编辑器"><br></p><p data-tool="mdnice编辑器">对于h5ad与Seurat格式的互换，有一个更全的帖子推荐给大家：</p><p data-tool="mdnice编辑器"><span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247522054&amp;idx=1&amp;sn=fac73724a169c28b4faf02bcd02c7358&amp;chksm=fa45523bcd32db2d1fbe8672bcbc66bc0c48e12155bf34107b609bba312477e00a18f0f1bde9&amp;scene=21#wechat_redirect" textvalue="软件测评：百万级单细胞数据的Anndata和Seurat对象互转" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">软件测评：百万级单细胞数据的Anndata和Seurat对象互转</a><br></span></p><p data-tool="mdnice编辑器">下次见~</p></section><section powered-by="xiumi.us"><p><strong></strong></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/n5Kxri1uoEEi3wy6Yway8A",target="_blank" rel="noopener noreferrer">原文链接</a>
