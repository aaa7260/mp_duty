---
title: "高级替身！拟时序神器sctour，出图神似RNA velocity，兼顾时序和表达量给出降维"
date: 2024-06-20T05:17:22Z
draft: ["false"]
tags: [
  "fetched",
  "生信作曲家"
]
categories: ["Acdemic"]
---
高级替身！拟时序神器sctour，出图神似RNA velocity，兼顾时序和表达量给出降维 by 生信作曲家
------
<div><section><h3><span>前言</span></h3><p>拟时序分析的方法已经很多了，我们之前向大家介绍了VECTOR算法，实际上可以类似于RNA速率分析，做出向量，且不需要bam文件。</p><p><img data-galleryid="" data-imgfileid="100005654" data-ratio="0.8356940509915014" data-s="300,640" data-type="png" data-w="353" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichktawYe8T84HZEXS0yJ0IvVKotrHU5Ilgky8s6e7hA2EMRNjtfk8QsBg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichktawYe8T84HZEXS0yJ0IvVKotrHU5Ilgky8s6e7hA2EMRNjtfk8QsBg/640?wx_fmt=png&amp;from=appmsg"></p><p>今天我们介绍一种又能够做出<strong>更类似于RNA速率分析的拟时序算法，</strong><span><strong>sctour</strong></span><strong> !</strong><br><strong>sctour算法</strong>是一种用于稳健推断和精确预测细胞动态的深度学习架构，其优势在于，<span><strong>可以兼顾拟时间和表达了进行重降维聚类（一般拟时序不会给新的降维方法），</strong></span>并且，它出图真的非常类似RNA速率！</p><p><img data-galleryid="" data-imgfileid="100005655" data-ratio="0.5435185185185185" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichkicptRcicgMFDPc6ialCHaicd0GVA5Dlz5PHnMn2Pibv3MaNdBdaL5eqsADQ/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichkicptRcicgMFDPc6ialCHaicd0GVA5Dlz5PHnMn2Pibv3MaNdBdaL5eqsADQ/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p>不管心不心动，小编已经非常激动啦！<br></p><p><br></p><p><img data-galleryid="" data-imgfileid="100005656" data-ratio="0.4777777777777778" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichkckZcXjNPNf6g8GPSmuOzN77B1qXiaL1mPCxryu3nibWnV7knkT7WxicFQ/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichkckZcXjNPNf6g8GPSmuOzN77B1qXiaL1mPCxryu3nibWnV7knkT7WxicFQ/640?wx_fmt=png&amp;from=appmsg"><br></p><p><img data-galleryid="" data-imgfileid="100005658" data-ratio="0.5861111111111111" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichkPL6ic4YQiciatJibzUsSicGlbw7xvWynRzr3JJiaQibEXcibJyYOaN59nQ379w/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichkPL6ic4YQiciatJibzUsSicGlbw7xvWynRzr3JJiaQibEXcibJyYOaN59nQ379w/640?wx_fmt=png&amp;from=appmsg"></p><h3><span>代码实操</span></h3><pre><code><span># pip install sctour</span><br><span>import</span> sctour <span>as</span> sct<br><span>import</span> scanpy <span>as</span> sc<br><span>import</span> numpy <span>as</span> np<br><span>import</span> pandas <span>as</span> pd<br><span>import</span> matplotlib.pyplot <span>as</span> plt<br><br>adata = sc.read(<span>'G:/scouter/scRNA2.h5ad'</span>)<br>sc.pl.umap(adata, color=[<span>'celltype'</span>, <span>'Sample batch'</span>], legend_loc=<span>'on data'</span>)<br><br><span>## 恶性细胞已经分好群了</span><br></code></pre><figure><figcaption><img data-imgfileid="100005659" data-ratio="0.35555555555555557" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichkQ6swJXUh8ZWogW5zuHfkXVEhfPc8SbBcZ6uQpB4Oib4ufiboZoEZZ49g/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichkQ6swJXUh8ZWogW5zuHfkXVEhfPc8SbBcZ6uQpB4Oib4ufiboZoEZZ49g/640?wx_fmt=png&amp;from=appmsg"></figcaption></figure><pre><code><span># 计算</span><br><span>import</span> os<br>os.environ[<span>'NUMBA_DISABLE_INTEL_SVML'</span>] = <span>'1'</span><br><br><span>import</span> skmisc<br><span>#计算每个细胞中检测到的基因数量。这一步在scTour模型训练之前是必需的。</span><br>sc.pp.calculate_qc_metrics(adata, percent_top=<span>None</span>, log1p=<span>False</span>, inplace=<span>True</span>)<br><span># Select highly variable genes.   你可能需要 pip install --user scikit-misc==0.2.0</span><br>sc.pp.highly_variable_genes(adata, flavor=<span>'seurat_v3'</span>, n_top_genes=<span>1000</span>, subset=<span>True</span>)<br><br><br><span>#训练scTour模型。默认的损失模式是负二项条件似然（nb），</span><br><span># 默认情况下，当细胞总数少于10,000时，用于训练模型的细胞比例设置为0.9，而当细胞总数大于10,000时，该比例设置为0.2</span><br><span># 用户可以通过使用参数percent来调整比例（例如，percent=0.6）。</span><br><br><span>#较小的alpha_recon_lec往往会得出基于伪时间排列细胞的潜在表示，因此不能很好地分离具有相似发育顺序的细胞类型。</span><br><span># 这两个参数的默认值都是0.5。用户可以根据数据集调整它们。</span><br><br>tnode = sct.train.Trainer(adata, loss_mode=<span>'nb'</span>, alpha_recon_lec=<span>0.5</span>, alpha_recon_lode=<span>0.5</span>)<br>tnode.train()<br></code></pre><figure><figcaption><img data-imgfileid="100005660" data-ratio="0.17222222222222222" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichkBay00gPdnRNlSe1n2zeX4SgQibfZAqaLd2NkXJqkz5WFXFkJI7KlmXA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichkBay00gPdnRNlSe1n2zeX4SgQibfZAqaLd2NkXJqkz5WFXFkJI7KlmXA/640?wx_fmt=png&amp;from=appmsg"></figcaption></figure><pre><code><span>#伪时间</span><br><br><span>#基于训练好的模型推断发育伪时间。</span><br>adata.obs[<span>'ptime'</span>] = tnode.get_time()<br><br><span>#推断细胞位置，相当于替换掉umap</span><br><span>#两个参数alpha_z和alpha_predz用于调整从变分推断和ODE求解器获得的潜在空间的权重。</span><br><span># 较大的alpha_z会使潜在空间偏向于内在的转录组结构，而较大的alpha_predz则更能代表外在的伪时间排序。</span><br><span># 用户可以根据自己的目的调整这两个参数。</span><br><span>#zs represents the latent z from variational inference, and pred_zs represents the latent z from ODE solver</span><br><span>#mix_zs represents the weighted combination of the two, which is used for downstream analysis</span><br>mix_zs, zs, pred_zs = tnode.get_latentsp(alpha_z=<span>0.5</span>, alpha_predz=<span>0.5</span>)<br>adata.obsm[<span>'X_TNODE'</span>] = mix_zs<br><br><span>## 推断向量</span><br>adata.obsm[<span>'X_VF'</span>] = tnode.get_vector_field(adata.obs[<span>'ptime'</span>].values, adata.obsm[<span>'X_TNODE'</span>])<br><br><span># 可以保存</span><br><span>#adata.write('G:/scouter/sctour.h5ad')</span><br><br><span>#adata = sc.read('G:/scouter/sctour.h5ad')</span><br><br><br><span>#可视化，我们看到，sctour给出了新的聚类！</span><br>adata = adata[np.argsort(adata.obs[<span>'ptime'</span>].values), :]<br><br>sc.pp.neighbors(adata, use_rep=<span>'X_TNODE'</span>, n_neighbors=<span>15</span>)<br>sc.tl.umap(adata, min_dist=<span>0.1</span>)<br><br>fig, axs = plt.subplots(ncols=<span>2</span>, nrows=<span>2</span>, figsize=(<span>10</span>, <span>10</span>))<br>sc.pl.umap(adata, color=<span>'celltype'</span>, ax=axs[<span>0</span>, <span>0</span>], legend_loc=<span>'on data'</span>, show=<span>False</span>, frameon=<span>False</span>)<br>sc.pl.umap(adata, color=<span>'Sample batch'</span>, ax=axs[<span>0</span>, <span>1</span>], show=<span>False</span>, frameon=<span>False</span>)<br>sc.pl.umap(adata, color=<span>'ptime'</span>, ax=axs[<span>1</span>, <span>0</span>], show=<span>False</span>, frameon=<span>False</span>)<br>sct.vf.plot_vector_field(adata, zs_key=<span>'X_TNODE'</span>, vf_key=<span>'X_VF'</span>, use_rep_neigh=<span>'X_TNODE'</span>, color=<span>'celltype'</span>, show=<span>False</span>, ax=axs[<span>1</span>, <span>1</span>], legend_loc=<span>'none'</span>, frameon=<span>False</span>, size=<span>100</span>, alpha=<span>0.2</span>)<br>plt.show()<br></code></pre><figure><figcaption><img data-imgfileid="100005661" data-ratio="0.8694444444444445" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichkrAiaRFgcoQ3UbsB58LP2UqKOoLQ2pYEqBMH9FOSL9uIuljJlAJCIQug/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaA7ic8OyVzur10WLeN1EkichkrAiaRFgcoQ3UbsB58LP2UqKOoLQ2pYEqBMH9FOSL9uIuljJlAJCIQug/640?wx_fmt=png&amp;from=appmsg"></figcaption></figure><h3><span>版本及报错指南</span></h3><p>往往同学们运行时会遭遇各种报错，我们下面列出来一些常见的报错及解决策略。</p><h4><span>0. 示例数据</span></h4><p>购买后管理员处获取</p><p><img data-galleryid="" data-imgfileid="100000530" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="512" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/mo60jlFOtaCCLynHNic5cW7VTpnwXFdScicPJ3QSchkDsNZBRbjMMOnTvNAkwZAGK06AmFMKVeibqTj8bjvF00nQA/640?wx_fmt=jpeg" src="https://mmbiz.qpic.cn/mmbiz_jpg/mo60jlFOtaCCLynHNic5cW7VTpnwXFdScicPJ3QSchkDsNZBRbjMMOnTvNAkwZAGK06AmFMKVeibqTj8bjvF00nQA/640?wx_fmt=jpeg"></p><h4><span>1. python环境及版本一览</span></h4><p><mp-pay-preview-filter data-offset="23"></mp-pay-preview-filter></p></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/CBdljX2zfSoz-VZIWbcoRw",target="_blank" rel="noopener noreferrer">原文链接</a>
