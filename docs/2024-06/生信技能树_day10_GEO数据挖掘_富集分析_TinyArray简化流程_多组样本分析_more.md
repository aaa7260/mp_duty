---
title: "生信技能树-day10 GEO数据挖掘-富集分析、TinyArray简化流程、多组样本分析&more"
date: 2024-06-21T00:55:28Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
生信技能树-day10 GEO数据挖掘-富集分析、TinyArray简化流程、多组样本分析&more by 生信菜鸟团
------
<div><blockquote data-tool="mdnice编辑器"><p><span>从我们</span><span>生信技能树</span><span>历年的几千个马拉松授课学员里面募集了一些优秀的创作者，某种意义来说是传承了我们生信技能树的知识整理和分享的思想！</span></p></blockquote><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">今天的是三周合计15天的数据挖掘授课学员一点一滴整理的授课知识点笔记哦，还有互动练习题哈，欢迎大家点击文末的阅读原文去关注我们学员的公众号哦！</p><p><img data-galleryid="" data-imgfileid="100039952" data-ratio="0.9869791666666666" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicZWFXx8AD2QqR5r26iaEib7iaTAeenkZojmCFn9w4mCdFoicJMx4AQ3q11rUoUaJn8lUjibicBWzLIhSAQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1536" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicZWFXx8AD2QqR5r26iaEib7iaTAeenkZojmCFn9w4mCdFoicJMx4AQ3q11rUoUaJn8lUjibicBWzLIhSAQ/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器"><br></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span>富集分析</span></h1><h2 data-tool="mdnice编辑器"><span>一些理论知识</span></h2><ol data-tool="mdnice编辑器"><li><section><p>最常用于富集分析的数据库：GO 和 KEGG</p></section></li><li><section><p>人类的基因被数据库收录的 8000 个左右，被分类到不同的 KEGG 通路/GO term（细胞组分/分子功能/生物过程三个子部分）</p></section></li><li><section><p>用于富集分析的 R 包：clusterProfiler，Y叔开发的，还有一本书，clusterProfiler book</p></section></li><li><section><p>富集分析中得到的两个值的解释：</p></section></li></ol><ul data-tool="mdnice编辑器"><li><section><p>GeneRatio：差异基因中富集到的数量/差异基因在数据库中的数量</p></section></li><li><section><p>bgRatio：该通路总共多少个基因/数据库中总共多少个基因</p></section></li></ul><ol start="5" data-tool="mdnice编辑器"><li><section>所谓是否富集（p值）：geneRatio对于bgRatio是否明显较大，即“实际中奖概率”是否明显比“理论中奖概率”大，即：衡量每个通路里的基因在差异基因里是否足够多</section></li></ol><h2 data-tool="mdnice编辑器"><span>具体代码</span></h2><p data-tool="mdnice编辑器">书接上回~开始富集分析and画图：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())  <br>load(file = <span>'step4output.Rdata'</span>)<br><span>library</span>(clusterProfiler)<br><span>library</span>(ggthemes)<br><span>library</span>(org.Hs.eg.db)<br><span>library</span>(dplyr)<br><span>library</span>(ggplot2)<br><span>library</span>(stringr)<br><span>library</span>(enrichplot)<br></code></pre><ol data-tool="mdnice编辑器"><li><section>输入数据</section></li></ol><pre data-tool="mdnice编辑器"><span></span><code>gene_diff = deg$ENTREZID[deg$change != <span>"stable"</span>] <br><span>#输入数据为change不为stable的ENTREZID</span><br></code></pre><ol start="2" data-tool="mdnice编辑器"><li><section>富集</section></li></ol><pre data-tool="mdnice编辑器"><span></span><code>ekk &lt;- enrichKEGG(gene = gene_diff,organism = <span>'hsa'</span>)<br>ekk &lt;- setReadable(ekk,OrgDb = org.Hs.eg.db,keyType = <span>"ENTREZID"</span>)<br>ego &lt;- enrichGO(gene = gene_diff,OrgDb= org.Hs.eg.db,<br>                ont = <span>"ALL"</span>,readable = <span>TRUE</span>)<br><span>#setReadable和readable = TRUE都是把富集结果表格里的基因名称转为symbol</span><br></code></pre><ol start="3" data-tool="mdnice编辑器"><li><section>可视化</section></li></ol><pre data-tool="mdnice编辑器"><span></span><code>barplot(ego, split = <span>"ONTOLOGY"</span>) + <br>  facet_grid(ONTOLOGY ~ ., space = <span>"free_y"</span>,scales = <span>"free_y"</span>) <br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039329" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBMq1lxJBq46kMtpa0TyEHchozq6QGCHyf3pwQYJCXej5nmz2CMdkQdyA/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBMq1lxJBq46kMtpa0TyEHchozq6QGCHyf3pwQYJCXej5nmz2CMdkQdyA/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></figure><pre data-tool="mdnice编辑器"><span></span><code>barplot(ekk)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039332" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBMl1pnAdhoCia4x6Yqk5CiaIOribCYa5cg73VibE0yersZe6Gwydvc0BRkaQ/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBMl1pnAdhoCia4x6Yqk5CiaIOribCYa5cg73VibE0yersZe6Gwydvc0BRkaQ/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>#或者是dotplot</span><br></code></pre><p data-tool="mdnice编辑器">直接对自定义对象写的自定义函数，不需要加任何参数调整就可以直接出图，方便！</p><ol start="4" data-tool="mdnice编辑器"><li><section>富集不到的补救措施</section></li></ol><ul data-tool="mdnice编辑器"><li><section>调整logFC、pvalue的阈值（通常是调整logFC），以改动差异基因数量</section></li><li><section>不适用默认的padj，而是使用原始p值，在文章中说明清楚即可</section></li><li><section>换富集方法，GSEA也可以做KEGG富集</section></li><li><section>调整参数maxGSSize = 500，默认参数为500表示500个基因以上的通路不考虑，可以调大成1000之类</section></li></ul><ol start="5" data-tool="mdnice编辑器"><li><section>更多资料---</section></li></ol><ul data-tool="mdnice编辑器"><li><section>GSEA：https://www.yuque.com/docs/share/a67a180f-dd2b-4f6f-96c2-68a4b86fe862?#</section></li><li><section>Y叔的书：http://yulab-smu.top/clusterProfiler-book/index.html</section></li><li><section>GOplot：https://mp.weixin.qq.com/s/LonwdDhDn8iFUfxqSJ2Wew</section></li><li><section>网上的资料和宝藏无穷无尽，学好R语言慢慢发掘~</section></li></ul><h1 data-tool="mdnice编辑器"><span>问题数据和常见错误分析</span></h1><ol data-tool="mdnice编辑器"><li><section>数据提交者的锅</section></li></ol><ul data-tool="mdnice编辑器"><li><section>表达矩阵是空的</section></li><li><section>表达矩阵不完整</section></li><li><section>表达矩阵被标准化过</section></li><li><section>表达矩阵有错误或异常值</section></li></ul><p data-tool="mdnice编辑器">解决办法：</p><ul data-tool="mdnice编辑器"><li><section>换一个数据</section></li><li><section>处理原始数据</section></li></ul><ol start="2" data-tool="mdnice编辑器"><li><section>你的锅</section></li></ol><ul data-tool="mdnice编辑器"><li><section>用芯片流程分析转录组数据</section></li><li><section>忘记log/多余log</section></li><li><section>分组搞错</section></li><li><section>探针注释错误</section></li><li><section>id转换用错物种</section></li></ul><ol start="3" data-tool="mdnice编辑器"><li><section>不可抗力</section></li></ol><ul data-tool="mdnice编辑器"><li><section>找不到探针注释</section></li><li><section>数据有错又找不到原始数据</section></li><li><section>找不到想要的实验设计</section></li></ul><h1 data-tool="mdnice编辑器"><span>tinyarray简化版本分析流程</span></h1><p data-tool="mdnice编辑器">需要R包版本2.3.1及以上</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br><span>#打破下载时间的限制,改前60秒，改后10w秒</span><br>options(timeout = <span>100000</span>) <br>options(scipen = <span>20</span>)<span>#不要以科学计数法表示</span><br><span>#前面是一样的</span><br><br><span>library</span>(tinyarray)<br>packageVersion(<span>"tinyarray"</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>## [1] '2.3.3'</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(stringr)<br>geo = geo_download(<span>"GSE7305"</span>)<br>exp = geo$exp<br>exp = log2(exp+<span>1</span>)<br>boxplot(exp,las = <span>2</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039330" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBMDmRmCdJrHVGibBkbkgszBj4ibbU0fMRibIG7cdITf4CdiaxqShBEKQRicfQ/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBMDmRmCdJrHVGibBkbkgszBj4ibbU0fMRibIG7cdITf4CdiaxqShBEKQRicfQ/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></figure><pre data-tool="mdnice编辑器"><span></span><code>pd = geo$pd<br>gpl_number = geo$gpl<br><span>#替代了第一个脚本</span><br><br><span># 分组信息</span><br>k = str_detect(pd$title,<span>"Normal"</span>);table(k)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>## k</span><br><span>## FALSE  TRUE </span><br><span>##    10    10</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>Group = ifelse(k,<span>"Normal"</span>,<span>"Disease"</span>)<br>Group = factor(Group,levels = c(<span>"Normal"</span>,<span>"Disease"</span>))<br><br><span># 探针注释</span><br>find_anno(geo$gpl)<br><span>library</span>(hgu133plus2.db);ids &lt;- toTable(hgu133plus2SYMBOL)<br>head(ids)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>##    probe_id symbol</span><br><span>## 1 1007_s_at   DDR1</span><br><span>## 2   1053_at   RFC2</span><br><span>## 3    117_at  HSPA6</span><br><span>## 4    121_at   PAX8</span><br><span>## 5 1255_g_at GUCA1A</span><br><span>## 6   1294_at   UBA7</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>#差异分析和它的可视化</span><br>dcp = get_deg_all(exp,Group,ids,entriz = <span>F</span>)<br><span>#代替了3和4脚本</span><br>table(dcp$deg$change)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>## </span><br><span>##   down stable     up </span><br><span>##    579  19621    624</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>head(dcp$deg)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>##      logFC  AveExpr        t                          P.Value</span><br><span>## 1 6.270309 8.436140 45.39552 0.000000000000000000000009106509</span><br><span>## 2 3.943359 7.351799 35.25755 0.000000000000000000002600407155</span><br><span>## 3 2.318498 6.631187 32.33367 0.000000000000000000017855505829</span><br><span>## 4 4.905540 8.140399 30.78154 0.000000000000000000053206731115</span><br><span>## 5 4.878195 6.815838 29.02740 0.000000000000000000195062651758</span><br><span>## 6 4.106051 9.045949 28.82714 0.000000000000000000227319306208</span><br><span>##                     adj.P.Val        B    probe_id    symbol change</span><br><span>## 1 0.0000000000000000002489492 41.58809   202992_at        C7     up</span><br><span>## 2 0.0000000000000000473924204 37.34483   204971_at      CSTA     up</span><br><span>## 3 0.0000000000000001952499562 35.77275   228564_at LINC01116     up</span><br><span>## 4 0.0000000000000004155825748 34.85700 208131_s_at     PTGIS     up</span><br><span>## 5 0.0000000000000013331313106 33.74579   210002_at     GATA6     up</span><br><span>## 6 0.0000000000000013809647852 33.61341   212190_at  SERPINE2     up</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>dcp$plots<br><span>library</span>(ggplot2)<br>ggsave(<span>"deg.png"</span>,width = <span>15</span>,height = <span>5</span>)<br></code></pre><h1 data-tool="mdnice编辑器"><span>多分组数据分析流程</span></h1><ol data-tool="mdnice编辑器"><li><section>获取数据</section></li></ol><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br><span>#打破下载时间的限制,改前60秒，改后10w秒</span><br>options(timeout = <span>100000</span>) <br>options(scipen = <span>20</span>)<span>#不要以科学计数法表示</span><br><br><span>library</span>(tinyarray)<br>packageVersion(<span>"tinyarray"</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>## [1] '2.3.3'</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(stringr)<br>gse = <span>"GSE474"</span><br>geo = geo_download(gse)<br>exp = geo$exp<br>range(exp)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>## [1]     0.050827 35799.757813</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>exp = log2(exp+<span>1</span>)<br>boxplot(exp,las = <span>2</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100039331" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBM0buZKXfNbumyt8Zm5ZiaAIGqH9hEbDicPeuyp966YBTpApGXYWtIRiamA/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/6s6vow09gKzRHhT1CyKtibhBb4KeVgRBM0buZKXfNbumyt8Zm5ZiaAIGqH9hEbDicPeuyp966YBTpApGXYWtIRiamA/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></figure><pre data-tool="mdnice编辑器"><span></span><code>pd = geo$pd<br>gpl_number = geo$gpl<br><span>#获取数据和检查</span><br></code></pre><ol start="2" data-tool="mdnice编辑器"><li><section>生成分组向量与探针注释</section></li></ol><p data-tool="mdnice编辑器">注意仍然是对照组放在levels的第一个位置，三分组一般是两两比较，后面差异分析时看清楚谁比谁就可以了。</p><pre data-tool="mdnice编辑器"><span></span><code>Group=str_split(pd$title,<span>"-"</span>,simplify = <span>T</span>)[,<span>3</span>]<br>Group=factor(Group,levels = c(<span>"NonObese"</span>,<span>"Obese"</span>,<span>"MObese"</span>))<br>gpl_number<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>## [1] "GPL96"</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>find_anno(gpl_number)<br><span>library</span>(hgu133a.db);ids &lt;- toTable(hgu133aSYMBOL)<br>head(ids)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>##    probe_id symbol</span><br><span>## 1 1007_s_at   DDR1</span><br><span>## 2   1053_at   RFC2</span><br><span>## 3    117_at  HSPA6</span><br><span>## 4    121_at   PAX8</span><br><span>## 5 1255_g_at GUCA1A</span><br><span>## 6   1294_at   UBA7</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>#三个分组要注意顺序：从最适合做对照的到最不适合做对照的</span><br></code></pre><ol start="3" data-tool="mdnice编辑器"><li><section>差异分析</section></li></ol><p data-tool="mdnice编辑器">代码参考自limma的pdf文档,如果使用tinyarray简化，这段代码就不需要了，已经写进了函数里。以下是原始代码，可以选择性学习一下</p><p data-tool="mdnice编辑器">此时得到的deg就是三次差异分析的结果表格组成的列表。Obese-NonObese的意思就是Obese为处理，NoObese为对照的差异分析结果。</p><p data-tool="mdnice编辑器">之后就分别提取出结果画图即可。</p><ol start="4" data-tool="mdnice编辑器"><li><section>tinyarray的简化操作</section></li></ol><p data-tool="mdnice编辑器">多分组的数据，get_deg_all仍然可以帮你简化操作，目前是三分组就两两差异分析，四个或五个分组的数据是后面几个组与第一个组差异分析，暂不支持其他的做法和更多的分组。</p><p data-tool="mdnice编辑器">你可以自行对矩阵和临床信息取子集，两两差异分析。</p><pre data-tool="mdnice编辑器"><span></span><code>dcp = get_deg_all(exp,Group,ids,logFC_cutoff = <span>0.585</span>,entriz = <span>F</span>)<br>dcp$plots<br>ggplot2::ggsave(<span>"deg.png"</span>,width = <span>15</span>,height = <span>10</span>)<br></code></pre><h1 data-tool="mdnice编辑器"><span>多数据联合分析：</span></h1><p data-tool="mdnice编辑器">参见GEO_learnmore里的多数据联合分析_早期合并</p><h1 data-tool="mdnice编辑器"><span>WGCNA</span></h1><p data-tool="mdnice编辑器">参见GEO_learnmore里的WGCNA</p><blockquote data-tool="mdnice编辑器"><p>form 生信技能树</p></blockquote><span></span></section><p><br></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span>文末友情宣传</span></h3><p data-tool="mdnice编辑器"><strong>强烈建议你推荐给身边的博士后以及年轻生物学PI，多一点数据认知，让他们的科研上一个台阶：</strong></p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247530001&amp;idx=1&amp;sn=676dcf224f9be23b288189775292aeeb&amp;chksm=9b4b36aaac3cbfbc3e3bb0865bd789d5093e3a643f3f345332995f707b7f209ae924e9e9529e&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉松授课（买‍一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;scene=21#wechat_redirect" data-linktype="2">时隔5年，我们的生信技能树VIP学徒继续招生啦</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528363&amp;idx=1&amp;sn=5e02f3e9b2e148191e23ebc2c0d780e7&amp;scene=21#wechat_redirect" data-linktype="2">2024的共享服务器交个朋友福利价仍然是800</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;scene=21#wechat_redirect" data-linktype="2">千呼万唤始出来的独享生物信息学云服务器</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528144&amp;idx=1&amp;sn=be4d7e542d1077921024c86a4c130f16&amp;scene=21#wechat_redirect" data-linktype="2">永久免费的生信进阶培训（线下）</a></section></li></ul></section><p><br></p><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/MmnWgOfBzclyTzJwyGYDEA",target="_blank" rel="noopener noreferrer">原文链接</a>
