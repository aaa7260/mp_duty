---
title: "monocle多样本拟时序分析"
date: 2024-06-25T07:12:08Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
monocle多样本拟时序分析 by 生信技能树
------
<div><section data-mpa-powered-by="yiban.io">前面已经是介绍了单个样品的单细胞转录组表达量矩阵的monocle分析，接下来分享一下多样品的时候如何注意个体差异因素。</section><section><section><section><section><section><section><section><section><pre><code>rm(list = ls())<br>library(Seurat)<br>library(monocle)<br>library(dplyr)<br>load("../monocle_one_sample/sce.all.Rdata")<br>table(sce.all$celltype)<br><span><br>#</span><span># </span><br><span>#</span><span>#            B  B Activated    CD14 Mono    CD16 Mono CD4 Memory T  CD4 Naive T </span><br><span>#</span><span>#          975          386         4355         1044         1762         2501 </span><br><span>#</span><span>#        CD8 T           DC           Mk           NK          pDC  T activated </span><br><span>#</span><span>#          814          472          236          618          132          631</span><br><br>scRNA = subset(sce.all,idents = c("CD14 Mono","CD16 Mono"))<br><span>table(scRNA$</span><span>celltype)</span><br><span><br>#</span><span># </span><br><span>#</span><span># CD14 Mono CD16 Mono </span><br><span>#</span><span>#      4355      1044</span><br><span><br>table(scRNA$</span><span>orig.ident)</span><br><span><br>#</span><span># </span><br><span>#</span><span># IMMUNE_CTRL IMMUNE_STIM </span><br><span>#</span><span>#        2718        2681</span><br></code></pre><p>本文的输入数据是seurat做完降维聚类分群注释的数据，并将注释的结果添加到了meta表格里面成为了celltype列。</p><p>因为只想要CD14和CD16单核细胞，所以提取出来相应的子对象。</p><p>因为monocle和seurat是两个不同的体系，所以需要将seurat对象转换为monocle可以接受的CellDataSet对象。虽然monocle3已经出来很久了，但大家都不约而同的选择monocle2，大概就是习惯了吧。。</p><pre><code>ct &lt;- scRNA@assays$RNA$counts<br><br>gene_ann &lt;- data.frame(<br>  gene_short_name = row.names(ct), <br>  row.names = row.names(ct)<br>)<br><br>pd &lt;- new("AnnotatedDataFrame",<br>          data=scRNA@meta.data)<br>fd &lt;- new("AnnotatedDataFrame",<br>          data=gene_ann)<br><br>sc_cds &lt;- newCellDataSet(<br>  ct, <br>  phenoData = pd,<br>  featureData =fd,<br>  expressionFamily = negbinomial.size(),<br>  lowerDetectionLimit=1)<br>sc_cds<br><span><br>#</span><span># CellDataSet (storageMode: environment)</span><br><span>#</span><span># assayData: 14053 features, 5399 samples </span><br><span>#</span><span>#   element names: exprs </span><br><span>#</span><span># protocolData: none</span><br><span>#</span><span># phenoData</span><br><span>#</span><span>#   sampleNames: AAACATACATTTCC.1 AAACATACCAGAAA.1 ... TTTGACTGCCCTAC.1</span><br><span>#</span><span>#     (5399 total)</span><br><span>#</span><span>#   varLabels: orig.ident nCount_RNA ... Size_Factor (19 total)</span><br><span>#</span><span>#   varMetadata: labelDescription</span><br><span>#</span><span># featureData</span><br><span>#</span><span>#   featureNames: AL627309.1 RP11-206L10.2 ... LRRC3DN (14053 total)</span><br><span>#</span><span>#   fvarLabels: gene_short_name</span><br><span>#</span><span>#   fvarMetadata: labelDescription</span><br><span>#</span><span># experimentData: use 'experimentData(object)'</span><br><span>#</span><span># Annotation:</span><br></code></pre><h4><span><span> </span>1.构建细胞发育轨迹</span></h4><p>选择基因有不同的策略，比如 1.使用seurat给出的高变化基因 2.按照平均表达量大于某个数字(比如0.1，官网用的是这个)的基因 3.使用不同细胞类型之间的差异基因，differentialGeneTest计算。我们默认使用的是最后一个策略。</p><pre><code>sc_cds &lt;- estimateSizeFactors(sc_cds)<br>sc_cds &lt;- estimateDispersions(sc_cds)<br>table(scRNA@meta.data$celltype)<br><br><span>## </span><br><span>## CD14 Mono CD16 Mono </span><br><span>##      4355      1044</span><br><br>fdif = <span>"diff_test_res.Rdata"</span><br><span>if</span>(!file.exists(fdif)){<br>  diff_test_res &lt;- differentialGeneTest(sc_cds,<br>                                        fullModelFormulaStr = <span>" ~ celltype + orig.ident"</span>, <br>                                           reducedModelFormulaStr = <span>" ~ orig.ident"</span>, <br><br>                                        cores = <span>8</span>)<br>  save(diff_test_res,file = fdif)<br>}<br>load(fdif)<br>ordering_genes &lt;- row.names (subset(diff_test_res, qval &lt; <span>0.01</span>))<br><span>#然后是查看基因，设置为排序要使用的基因</span><br>head(ordering_genes)<br><br><span>## [1] <span>"NOC2L"</span>        <span>"ISG15"</span>        <span>"AGRN"</span>         <span>"RP4-758J18.2"</span> <span>"SSU72"</span>       </span><br><span>## [6] <span>"GNB1"</span></span><br><br>sc_cds &lt;- setOrderingFilter(sc_cds, ordering_genes)<br>plot_ordering_genes(sc_cds)<br></code></pre><figure><img data-imgfileid="100011175" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpEWxdcs33GCgvkJTyI7KTsbQtfia9E5HRFYFeEFxuCRd9D3KUwzZHpQ4zpCgttfhTaelIJybzJnsw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpEWxdcs33GCgvkJTyI7KTsbQtfia9E5HRFYFeEFxuCRd9D3KUwzZHpQ4zpCgttfhTaelIJybzJnsw/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><pre><code><span>#降维</span><br><span>sc_cds</span> &lt;- reduceDimension(sc_cds,residualModelFormulaStr = <span>"~orig.ident"</span>)<br><span>#细胞排序</span><br>sc_cds &lt;- orderCells(sc_cds)<br></code></pre><h4><span><span> </span>2.绘图展示</span></h4><p>发育轨迹图</p><pre><code>library(ggsci)<br>p1 = plot_cell_trajectory(sc_cds)+ scale_color_nejm()<br>p2 = plot_cell_trajectory(sc_cds, color_by = 'Pseudotime') <br>p3 = plot_cell_trajectory(sc_cds, color_by = 'celltype')  + scale_color_npg()<br>library(patchwork)<br>p2+p1/p3<br></code></pre><figure><img data-imgfileid="100011174" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpEWxdcs33GCgvkJTyI7KTsCrxaK4XtzWD1OibdvXUja5iaxuyklYnPLn4OJoNDEeRNEl5lxtNTquxA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpEWxdcs33GCgvkJTyI7KTsCrxaK4XtzWD1OibdvXUja5iaxuyklYnPLn4OJoNDEeRNEl5lxtNTquxA/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><p>这三种着色方式放在一起非常的带劲，很清晰的展示了pseudotime、state和celltype是怎样变化的。</p><p>以orig.ident着色可以看出，不同样本中的细胞基本是均匀分布在轨迹上的，说明前面的代码很好的去除了样本间的批次效应</p><pre><code>plot_cell_trajectory(sc_cds, color_by = <span>'orig.ident'</span>)<br></code></pre><figure><img data-imgfileid="100011176" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpEWxdcs33GCgvkJTyI7KTs7kcMqqFeXqXWawsFMoF9PvyxHh2V8JEw7ww4ica8Zy7JiaUPC7eWpOTw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpEWxdcs33GCgvkJTyI7KTs7kcMqqFeXqXWawsFMoF9PvyxHh2V8JEw7ww4ica8Zy7JiaUPC7eWpOTw/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><p>经典的拟时序热图</p><p>展示了一些基因是如何随着时间轨迹的变化而渐变的，这个渐变不同于findmarkers，是体现变化过程的，而不是直接给出差异表达的基因。</p><pre><code>gene_to_cluster = diff_test_res %&gt;% arrange(qval) %&gt;% head(<span>50</span>) %&gt;% pull(gene_short_name);head(gene_to_cluster)<br><br><span>## [1] <span>"S100A9"</span> <span>"S100A8"</span> <span>"FCGR3A"</span> <span>"IL8"</span>    <span>"PLAC8"</span>  <span>"TMSB4X"</span></span><br><br>plot_pseudotime_heatmap(sc_cds[gene_to_cluster,],<br>                        num_clusters = nlevels(Idents(scRNA)), <br>                        show_rownames = <span>TRUE</span>,<br>                        cores = <span>4</span>,return_heatmap = <span>TRUE</span>,<br>                        hmcols = colorRampPalette(c(<span>"navy"</span>, <span>"white"</span>, <span>"firebrick3"</span>))(<span>100</span>))<br></code></pre><figure><img data-imgfileid="100011172" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpEWxdcs33GCgvkJTyI7KTsRklkBrQOkRfjGyhj6ibNkC4xKbja5yECTqIlqT3aIYjicLbGmBFxicJzQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpEWxdcs33GCgvkJTyI7KTsRklkBrQOkRfjGyhj6ibNkC4xKbja5yECTqIlqT3aIYjicLbGmBFxicJzQ/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><p>用感兴趣的基因给轨迹图着色，gs可以换成你想换的基因</p><pre><code>gs = head(gene_to_cluster)<br>plot_cell_trajectory(sc_cds,markers=gs,<br>                     use_color_gradient=T)<br></code></pre><figure><img data-imgfileid="100011173" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpEWxdcs33GCgvkJTyI7KTskhic1LK93pZ9KtoNABhz6KlVTVict9YJ6PDBg5XOTRh11GOdhPna9WGA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpEWxdcs33GCgvkJTyI7KTskhic1LK93pZ9KtoNABhz6KlVTVict9YJ6PDBg5XOTRh11GOdhPna9WGA/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><p>也可以是jitter</p><pre><code>plot_genes_jitter(sc_cds[gs,],<br>                  grouping = <span>"celltype"</span>,<br>                  color_by = <span>"celltype"</span>,<br>                  nrow= <span>3</span>,<br>                  ncol = <span>NULL</span> )<br></code></pre><figure><img data-imgfileid="100011177" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpEWxdcs33GCgvkJTyI7KTskzbe0URULUZhY1jjoUpm4wK8pLkJH9xGySLyibNyQ81mJOY140ykNtA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpEWxdcs33GCgvkJTyI7KTskzbe0URULUZhY1jjoUpm4wK8pLkJH9xGySLyibNyQ81mJOY140ykNtA/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure></section><figure><figcaption></figcaption></figure></section><p><br></p><p><br></p></section></section></section></section></section></section><section><section><br></section></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Q4Vp-bSzLnomggeq-FaMRw",target="_blank" rel="noopener noreferrer">原文链接</a>
