---
title: "KEGG通路分析的可视化炫酷可视化--KEGG流星图"
date: 2024-06-02T14:34:35Z
draft: ["false"]
tags: [
  "fetched",
  "MS driven Multiomics"
]
categories: ["Acdemic"]
---
KEGG通路分析的可视化炫酷可视化--KEGG流星图 by MS driven Multiomics
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span>KEGG流星图</span><span></span></h1><blockquote data-tool="mdnice编辑器"><p>KEGG通路分析可视化常见的就是散点图，都快用腻了，更新一个基于 ggforce包的KEGG通路富集可视化方案，本方案中同时包括了参与通路的差异物counts、p value以及每条通路中全部差异物的整体变化情况(上调差异物多还是下调差异物多)</p></blockquote><p data-tool="mdnice编辑器">效果图如下：方案一：<img data-ratio="0.562962962962963" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVS8hkh7yCSkp5qpX34ia5E5OFr4K1Bh8jtvuD7arEohx1EntWMicJ9SmUkpHg6XzUUTMjhJumpFc3Q/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVS8hkh7yCSkp5qpX34ia5E5OFr4K1Bh8jtvuD7arEohx1EntWMicJ9SmUkpHg6XzUUTMjhJumpFc3Q/640?wx_fmt=png">方案二：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.562962962962963" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVS8hkh7yCSkp5qpX34ia5E5TFyeBgbL4mU1KhOIUVDx73PCQfBTl7POT8lgJYMgEZ2wN9blEAx82Q/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVS8hkh7yCSkp5qpX34ia5E5TFyeBgbL4mU1KhOIUVDx73PCQfBTl7POT8lgJYMgEZ2wN9blEAx82Q/640?wx_fmt=png"><figcaption>image-20231108115541050</figcaption></figure><h2 data-tool="mdnice编辑器"><span><span>1</span></span><span>数据准备</span><span></span></h2><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br><span>library</span>(tidyverse)<br><br><span>#loading data</span><br>files &lt;- fs::dir_ls(<span>"inputfile"</span>,recurse = <span>TRUE</span>,glob = <span>"*.txt"</span>)<br>files_names &lt;- str_extract(files,<span>"(?&lt;=\\/).*(?=\\.)"</span>);files_names<br>dat &lt;-  purrr::map_df(files,read.delim)<span>#reading data</span><br>names(dat)<br></code></pre><p data-tool="mdnice编辑器">inputfile下存放keeg的通路分析结果，必要信息包括：pathway信息、每条通路上全部差异物的数量(Diff.counts)、p.value、注释到每条通路中的全部代谢物或者蛋白Total.background（差异+非差异、每条通路中上调的差异物和下调的差异物(Diff.upcounts和Diff.downcounts):<img data-ratio="0.6268518518518519" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVS8hkh7yCSkp5qpX34ia5E5xputN2EslI32cbkquSDeC8PICqYmmtpZPlNnE4NKWosTkw8vUZicrLg/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVS8hkh7yCSkp5qpX34ia5E5xputN2EslI32cbkquSDeC8PICqYmmtpZPlNnE4NKWosTkw8vUZicrLg/640?wx_fmt=png"></p><h2 data-tool="mdnice编辑器"><span><span>2</span></span><span>数据整理：</span><span></span></h2><p data-tool="mdnice编辑器">计算每条通路的差异变化丰度：(Diff.upcounts-Diff.downcounts）/Total.background</p><pre data-tool="mdnice编辑器"><span></span><code><span># reshaping data</span><br><br>dat &lt;- dat %&gt;% <br>  mutate(diff.abundance = (Diff.upcounts - Diff.downcounts)/Background.counts,<br>         x=rep(<span>0</span>,n=nrow(.))) %&gt;% <span>#diff.abundance=x.trend</span><br>slice_min(order_by =P.value,n=<span>20</span>) %&gt;% <br>  mutate(index =seq(<span>1</span>,<span>20</span>)) %&gt;% <br>mutate(<br>group=case_when(<br>  diff.abundance&gt;<span>0</span>~<span>"more up-reulated metabolites"</span>,<br>  diff.abundance&lt;<span>0</span>~<span>"more down-regulated metabolites"</span>,<br>  <span>TRUE</span>~<span>"equal up- and down-regulated metabolites"</span><br>),<br>label=paste0(<span>"p="</span>,round(P.value,<span>3</span>),<span>" count="</span>,Diff.counts))<br></code></pre><h2 data-tool="mdnice编辑器"><span><span>3</span></span><span>可视化并保存</span><span></span></h2><p data-tool="mdnice编辑器">人为指定geom_point中size大小：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#manual setting size </span><br>plot.kegg2 &lt;- ggplot() +<br>    geom_vline(xintercept = c(<span>0</span>),size = <span>0.1</span>,color = <span>"#1f294e"</span>)+<br>    ggforce::geom_link(data = dat,aes(x = x,<br>                                      y = reorder(pathway, -index),<br>                           xend = diff.abundance,yend = pathway,<br>                           size = after_stat(index),<br>                           alpha = after_stat(index),<br>                           color=group<br>                           ),<br>                       show.legend = <span>F</span>)+<br>    geom_point(data = dat,<br>      aes(x = diff.abundance, y = pathway,color=group,<br>          ),<br>      size=<span>5</span>,<br>      shape = <span>21</span>,fill = <span>"white"</span>)+<br>    scale_colour_manual(values =c(<span>"#492952"</span>,<span>"#00B0F0"</span>,<span>"#EE0000"</span>))+<br>    guides(color=guide_legend(<span>'pathway condition'</span>)<br>           )+ <br>    geom_text(dat,mapping=aes(x=diff.abundance,y=pathway,label=label),<br>            size =<span>2.5</span>,color=<span>"grey20"</span>,<br>            hjust = <span>0</span>, nudge_x = <span>0.05</span>)+<br>    theme_test()+<br>  xlab(<span>"Differential Abundance Score"</span>)+<br>  ylab(<span>NULL</span>)<br><br><span>#saving</span><br>ggsave(<span>"outputfile/KEGG_abundancescore2.png"</span>, width = <span>8</span>, height = <span>4.5</span>)<br>print(plot.kegg2)<br>ggsave(<span>"outputfile/KEGG_abundancescore2.pdf"</span>, width =<span>8</span>, height = <span>4.5</span>,onefile=<span>F</span>)<br>print(plot.kegg2)<br>dev.off()   <br>    <br></code></pre><p><img data-galleryid="" data-ratio="0.562962962962963" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVS8hkh7yCSkp5qpX34ia5E5TFyeBgbL4mU1KhOIUVDx73PCQfBTl7POT8lgJYMgEZ2wN9blEAx82Q/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVS8hkh7yCSkp5qpX34ia5E5TFyeBgbL4mU1KhOIUVDx73PCQfBTl7POT8lgJYMgEZ2wN9blEAx82Q/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>image-20231108120854559</figcaption></figure><p data-tool="mdnice编辑器">或者将geom_point中size映射到对应的通路的差异物总数上：</p><pre data-tool="mdnice编辑器"><span></span><code><br>  <br>  <span>#mapping size to difference level</span><br>plot.kegg3 &lt;- <br>  ggplot() +<br>    geom_vline(xintercept = c(<span>0</span>),size = <span>0.1</span>,color = <span>"#1f294e"</span>)+<br>    ggforce::geom_link(data = dat,aes(x = x,<br>                                      y = reorder(pathway, -index),<br>                                      xend = diff.abundance,yend = pathway,<br>                                      size = after_stat(index),<br>                                      alpha = after_stat(index),<br>                                      color=group<br>    ),show.legend = <span>F</span>)+<br>    geom_point(data = dat,<br>               aes(x = diff.abundance, y = pathway,color=group,<br>                   size=(Diff.counts)<br>               ),<br>               shape = <span>21</span>,fill = <span>"white"</span>)+<br>    scale_colour_manual(values =c(<span>"#492952"</span>,<span>"#00B0F0"</span>,<span>"#EE0000"</span>))+<br>    guides(color=guide_legend(<span>'pathway condition'</span>),<br>           size=guide_legend(<span>'metabolite counts in each pathway'</span>))+ <br>    geom_text(dat,mapping=aes(x=diff.abundance,y=pathway,label=label),<br>              size =<span>2.5</span>,color=<span>"grey20"</span>,<br>              hjust = <span>0</span>, nudge_x = <span>0.05</span>)+<br>    theme_test()+  <br>    xlab(<span>"Differential Abundance Score"</span>)+<br>    ylab(<span>NULL</span>)<br><span>#saving</span><br>ggsave(<span>"outputfile/KEGG_abundancescore3.png"</span>, width = <span>8</span>, height = <span>4.5</span>)<br>print(plot.kegg3)<br>ggsave(<span>"outputfile/KEGG_abundancescore3.pdf"</span>, width =<span>8</span>, height = <span>4.5</span>,onefile=<span>F</span>)<br>print(plot.kegg3)<br>dev.off()  <br></code></pre><p><img data-galleryid="" data-ratio="0.562962962962963" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVS8hkh7yCSkp5qpX34ia5E5OFr4K1Bh8jtvuD7arEohx1EntWMicJ9SmUkpHg6XzUUTMjhJumpFc3Q/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVS8hkh7yCSkp5qpX34ia5E5OFr4K1Bh8jtvuD7arEohx1EntWMicJ9SmUkpHg6XzUUTMjhJumpFc3Q/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>image-20231108120915586</figcaption></figure><h2 data-tool="mdnice编辑器"><span><span>4</span></span><span>图片解析</span><span></span></h2><figure data-tool="mdnice编辑器"><img data-ratio="0.2861111111111111" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVS8hkh7yCSkp5qpX34ia5E540qhKERPqHRK21hqJv3fpsTuAiaFicXGicAgcGP4UmMPMueODFgw1tphw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/yDgqbg2dgMVS8hkh7yCSkp5qpX34ia5E540qhKERPqHRK21hqJv3fpsTuAiaFicXGicAgcGP4UmMPMueODFgw1tphw/640?wx_fmt=png"><figcaption>image-20231108121115429</figcaption></figure><p data-tool="mdnice编辑器">图中点的大小代表参与每条通路的差异物数量，每条通路的p以及对应数量也用geom_text加到了对应通路旁，如果趋势图从0点向左走，代表该通路中下调差异物多于上调差异物，如果趋势图从0点向右走，代表该通路中上调差异物多于下调差异物，位于0线上的点，代表该通路中上调差异物的数量与下调差异物的数量相等。</p><blockquote data-tool="mdnice编辑器"><p>期末考试，佛系更新ing, 需要帮助请私</p></blockquote></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/tc7f7A9rpQlqvrolU5c-SQ",target="_blank" rel="noopener noreferrer">原文链接</a>
