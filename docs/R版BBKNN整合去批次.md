---
title: "R版BBKNN整合去批次"
date: 2023-01-31T23:34:38Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
R版BBKNN整合去批次 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">之前我有测试过很多整合去批次的算法，例如CCA，RPCA，harmony，LIGER等：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484318&amp;idx=1&amp;sn=daf04a599413de0514afda07928eecb9&amp;scene=21&amp;key=97d114acb76dd546f4bdc602f36f0305abde8823b0b86d45dd68cccb6c6cae73645bfb28972e4b430471a3f93e47815b908c0054b14ae379ab4a5a4ec4a477dae933b5c3f3ef197714046839188266c69e6689ae768a60b00667ecda6bd23a274ea2f409d03597c64130c71cbeda94fa1d75ce2e2786844454ce89e8d1b00806&amp;ascene=14&amp;uin=MjA1MzU5NzYxNA==&amp;devicetype=Windows%2010%20x64&amp;version=63080021&amp;lang=zh_CN&amp;exportkey=n_ChQIAhIQRJMXAxODQ2uXkDQR61oHXBL0AQIE97dBBAEAAAAAACrnE4LVP4QAAAAOpnltbLcz9gKNyK89dVj0T%20%20453%208yJlg52jS0GP9P5Uw0%20CbpFoV5U1OQjuP8qTwi67hrKtLQyNLNaGXEGZbTEIGZ0lBAsc%20rbZNBSuUIGxivp/x3vqYg1EIcrT3dJOvZHcdf7UKx5Pzqm7cc6/KhPbNJJ7ej0gQ1rA8pumbZiqHHnPl560E2vEm%20W7%20nk/igp300ItM2FLBwBeRLu2/j3US/faPO4XUJdwNLy4W8pxDljO0Bh7qd1zGC7/C1ktp41EfM710FSOurzeGXNbA0bnp8Cd9oeO/qFlk4nI=&amp;acctmode=0&amp;pass_ticket=I9%20ODm8NSZ1Xc6tO/5LqOPiEZxT8cM4%20QlgBMK1m%20DR8X8auB7edQts7HwEW6KAz&amp;wx_header=0&amp;fontgear=2#wechat_redirect" data-linktype="2">CCA单细胞多样本整合和插槽选择（一）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?search_click_id=15727278847732631343-1648214930290-229699&amp;__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484384&amp;idx=1&amp;sn=e114a00e1594e8996bed895df64303a2&amp;chksm=c0389d91f74f14876a37b007117a988f50556b5229afd2aca835cf14b12c37163c1eb24f5ceb&amp;scene=21&amp;key=97d114acb76dd546cff9bad5bbac5f666a5ecef4c1eae6fdeff9ae9d4830d733a1752d5a6ed58f9464f2e9f389521869eaba13dfebcad1572a8c637b9b1a5552eca3ec7f636f32631a0cccdcdc5895550def42f4406061d77fd71886fd4f52f2e6f3aee4e9fa05cda84e636c21c42d75450b3195a24295ac3f5a8b4a82442510&amp;ascene=14&amp;uin=MjA1MzU5NzYxNA==&amp;devicetype=Windows%2010%20x64&amp;version=63080021&amp;lang=zh_CN&amp;exportkey=n_ChQIAhIQR38rqYkOMyGdCait7P8/vxL0AQIE97dBBAEAAAAAAMeuKFBVKM4AAAAOpnltbLcz9gKNyK89dVj0tpsr1hq0nrP4ln4DAtg/ROLCf/6rJ3Ta9Y8%20xeLwYrL9Z0ANKR0nY%20ffpTXPWGIr5k3Qj7DwTgYWAINPEs01ZsgaboktGS%20QqnDGKqKbMQ8PgZxS9xA4Aov8nfzHPNGTIEspbR7BixXE0AK2YZFCQfMlFBJsOIiOrlPlzZGEIOlC/0bSN8HjCwdQwIl/G2P%20%20UaesfwdEsyCC/nx5axPv/iIaPABVt9Hz1q5vAxbSZsUw7VQmsnQ0dQtXL3tU%20fkhJ7jAQE0l%20COdgTK9jg=&amp;acctmode=0&amp;pass_ticket=I9%20ODm8NSZ1Xc6tO/5LqOPiEZxT8cM4%20QlgBMK1m%20DQe%20Cp/mOJEG2PyxAxSnWsL&amp;wx_header=0&amp;fontgear=2#wechat_redirect" data-linktype="2">单细胞多样本整合之RPCA</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484506&amp;idx=1&amp;sn=98d7fe9265243c073a1444030fcd4a30&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之Harmony，LIGER和LISI</a></section></li></ul><p data-tool="mdnice编辑器">也有用python做过BBKNN和harmony：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484778&amp;idx=1&amp;sn=45f99192489b835d895bd2bd4d93e774&amp;scene=21#wechat_redirect" data-linktype="2">巧用Python加速单细胞分析</a></section></li></ul><p data-tool="mdnice编辑器">总体来说，在R语言环境下harmony相较其他算法还是比较优秀的，例如速度快，占内存小，整合的结果比较好。此外，python的BBKNN算法也是非常优秀的，丝毫不比R语言环境下的harmony弱，缺点就是需要用户会用python。我最近检索的时候发现bbknn居然出了R语言的版本，看时间戳也是近半年的更新，详见github：</p><ul data-tool="mdnice编辑器"><li><section>https://github.com/ycli1995/bbknnR</section></li></ul><p data-tool="mdnice编辑器">安装：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#devtools::install_github("ycli1995/bbknnR")</span><br>install.packages(<span>"bbknnR"</span>)<br></code></pre><p data-tool="mdnice编辑器">我们开箱试用一下，使用之前的示例数据，方便比较：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484506&amp;idx=1&amp;sn=98d7fe9265243c073a1444030fcd4a30&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样本整合之Harmony，LIGER和LISI</a></section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(bbknnR)<br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(dplyr)<br><span>library</span>(SeuratData)<br><span>library</span>(patchwork)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span>#### 1.load dataset</span><br>ifnb.data = LoadData(<span>"ifnb"</span>)<br><br><span>#### 2.normalize/HVG/scale三步走</span><br>ifnb.data &lt;- ifnb.data %&gt;% NormalizeData(verbose = <span>F</span>) %&gt;%<br>  FindVariableFeatures(selection.method = <span>"vst"</span>, nfeatures = <span>2000</span>, verbose = <span>F</span>) %&gt;% <br>  ScaleData(verbose = <span>F</span>) %&gt;%<br>  RunPCA(npcs = <span>50</span>, verbose = <span>F</span>)<br><br><span>#### 3. bbknn</span><br>ifnb.data &lt;- ifnb.data %&gt;% RunBBKNN(reduction = <span>"pca"</span>, <br>                                    run_TSNE = <span>F</span>,<br>                                    batch_key = <span>"orig.ident"</span>)<br><br>ifnb.data &lt;- ifnb.data %&gt;% FindNeighbors(reduction = <span>"pca"</span>, k.param = <span>10</span>, dims = <span>1</span>:<span>30</span>) %&gt;% <br>  FindClusters(resolution = <span>0.5</span>, algorithm = <span>1, graph.name="bbknn"</span>)%&gt;% <br>  identity()<br><br><span>#### 5.umap可视化</span><br>p1 &lt;- DimPlot(ifnb.data, reduction = <span>"umap"</span>, group.by = <span>"stim"</span>)<br>p2 &lt;- DimPlot(ifnb.data, reduction = <span>"umap"</span>,group.by = <span>"seurat_annotations"</span>, label = <span>TRUE</span>)<br>P.total = wrap_plots(p1,p2)<br>P.total<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.4482225656877898" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqU2GbLjmOYk4oxmYjLeFwBEvPsqSH616nLF3m1AoaEHXlKA6Fmnraku886MDOGb0b4eAEJWHmJ2nA/640?wx_fmt=other" data-type="other" data-w="647" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqU2GbLjmOYk4oxmYjLeFwBEvPsqSH616nLF3m1AoaEHXlKA6Fmnraku886MDOGb0b4eAEJWHmJ2nA/640?wx_fmt=other"><figcaption><br></figcaption></figure><p data-tool="mdnice编辑器"><strong>然而，效果虽然有点翻车。。但是总体上还是把不同组别的相同细胞类型正确归类在一起了。</strong></p><p data-tool="mdnice编辑器">下面这个是harmony的结果：</p><img data-ratio="0.39351851851851855" data-src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqU2GbLjmOYk4oxmYjLeFwBE77nk0udvmWSaoMvibqJgvlAhD8Caiak8z8jna3uyMd2j0Olv2Q5sXKpA/640?wx_fmt=other" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz/fTW9zRI3eqU2GbLjmOYk4oxmYjLeFwBE77nk0udvmWSaoMvibqJgvlAhD8Caiak8z8jna3uyMd2j0Olv2Q5sXKpA/640?wx_fmt=other"><span>- END -</span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ZkY8R3yZEEsIuV8lDIAdlA",target="_blank" rel="noopener noreferrer">原文链接</a>
