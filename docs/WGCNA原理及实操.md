---
title: "WGCNA原理及实操"
date: 2022-09-03T01:43:50Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
WGCNA原理及实操 by 生信技能树
------
<div><section powered-by="xiumi.us" mp-original-font-size="16" mp-original-line-height="25.600000381469727"><section mp-original-font-size="16" mp-original-line-height="25.600000381469727"><section mp-original-font-size="16" mp-original-line-height="25.600000381469727"><section mp-original-font-size="16" mp-original-line-height="0"><img data-ratio="0.91875" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wztsZWIld4dbSAHficyAXWgkicrhjjacU8Ey0UKM56qbSnedHStMqWUfTPQxbqxNTVZy1g59nNW3BSg/640?wx_fmt=jpeg" data-type="jpeg" data-w="640" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wztsZWIld4dbSAHficyAXWgkicrhjjacU8Ey0UKM56qbSnedHStMqWUfTPQxbqxNTVZy1g59nNW3BSg/640?wx_fmt=jpeg"></section></section><span title="" opera-tn-ra-cell="_$.pages:0.layers:0.comps:0.title1" mp-original-font-size="16" mp-original-line-height="25.600000381469727"><p mp-original-font-size="16" mp-original-line-height="25.600000381469727"><br mp-original-font-size="16" mp-original-line-height="25.600000381469727"></p></span></section><section mp-original-font-size="16" mp-original-line-height="25.600000381469727"><section powered-by="xiumi.us" mp-original-font-size="16" mp-original-line-height="25.600000381469727"><p mp-original-font-size="16" mp-original-line-height="25.600000381469727"><span>早期</span><span>学徒出师后大多会给有需要的小伙伴做项目，在数据挖掘领域我们给大家对接多种多样的需求：</span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247499139&amp;idx=1&amp;sn=3632f954ae8fd73f63c13dfc2b8b71ba&amp;scene=21#wechat_redirect" data-linktype="2"><span>明码标价之公共数据库的生存分析</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247499182&amp;idx=1&amp;sn=835cc06d716d5a1cc54e713b76e8bd22&amp;scene=21#wechat_redirect" data-linktype="2"><span>明码标价之公共数据集的WGCNA</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247500969&amp;idx=1&amp;sn=fdcaccdaba24f9c1a4ef6f64b2c5fe6a&amp;scene=21#wechat_redirect" data-linktype="2"><span>明码标价之公共数据库探索</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247499803&amp;idx=1&amp;sn=5d7bcce9b7c4221859b30d46b8dc1999&amp;scene=21#wechat_redirect" data-linktype="2"><span>明码标价之探索新流程（以MSIpred为例）</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247499964&amp;idx=1&amp;sn=addd2e2d167028a67d1032b81631b897&amp;scene=21#wechat_redirect" data-linktype="2"><span>明码标价之任意科研图表绘制（以氨基酸的位点变异图为例）</span></a></section></li></ul></section><p mp-original-font-size="16" mp-original-line-height="25.600000381469727"><span>部分极其优秀的学徒会把自己项目过程慢慢补齐的生物信息学技能一点一滴记录并且分享，我们择优发布到公众号借花献佛给大家</span><br></p></section></section></section><section powered-by="xiumi.us" mp-original-font-size="16" mp-original-line-height="25.600000381469727"><section data-tools="新媒体排版" data-id="763890" data-style-type="undefined" mp-original-font-size="16" mp-original-line-height="25.600000381469727"><section placeholder="请输入标题" mp-original-font-size="16" mp-original-line-height="24">下面是小贝的分享</section></section></section><h2>1. WGCNA 原理</h2><h3>1.1 建立共表达网络</h3><p><span>在基因共表达网络中，节点node代表基因，边edge代表两个基因间共表达关系。</span></p><ul><li><p><span>若一个基因同时与多个基因存在相关性，称为hub基因。</span></p></li><li><p><span>若一群基因存在高度互相相关，称为module。</span></p></li></ul><p><span>基因共表达网络的展示形式一般为 </span><span>n × n</span><span> 邻接矩阵adjacency matrix(n个基因)</span></p><h4>（1）similarity matrix</h4><p><span>在得到一个</span><span>m × n</span><span> 表达矩阵（m个样本，n个基因）后，第一步是计算两基因在多样本的表达水平相关性（例如spearman correlation，值一般在</span><span>-1 ~ 1</span><span>之间），从而得到表达相似度矩阵similarity matix，简记为S。根据是否考虑相关性的正负性，有两种处理方式。</span></p><p><img data-ratio="0.18779342723004694" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYic4u83FXlb9aXLSRDJj9PafwRHCft3wNoLJzg7fWEyzdDutjteEtKicQ/640?wx_fmt=png" data-type="png" data-w="426" width="284" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYic4u83FXlb9aXLSRDJj9PafwRHCft3wNoLJzg7fWEyzdDutjteEtKicQ/640?wx_fmt=png"></p><p>不要把`<strong>sign</strong>`和`directed`弄混了。前者表示相关的正负性，后者表示方向性。使用WGCNA建立的都是`undirected`网络。</p><h4>（2）adjacency matrix</h4><p><br></p><p>第二步是使用adjacency function将基因表达相似矩阵转为共表达邻接矩阵。根据adjacency function的特点分为hard与soft两种。</p><p><br></p><ul><li><p><strong>Hard adjacency function</strong>：设置一个阈值，若相关性高于阈值，则认为存在共表达关系，记为<code>1</code>；反之，则不存在，记为<code>0</code>。由此得到的结果成为 Unweighted Network。<br>该网络中的节点connectivity即为共表达的基因数。<br>此方法的关键是确定一个合理阈值。对此最显著的弊端是假设定义0.8为阈值，为什么0.79就认为不存在共表达关系呢。</p></li></ul><p><img data-ratio="0.122" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYPDtdCkt5JvsnicyBluwiaSVIrNjV707J7mls0HbKCNbF4vHIPE0E0PZg/640?wx_fmt=png" data-type="png" data-w="500" width="333.3333333333333" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYPDtdCkt5JvsnicyBluwiaSVIrNjV707J7mls0HbKCNbF4vHIPE0E0PZg/640?wx_fmt=png"></p><ul><li><p><strong>Soft adjacency function</strong>：使用的前提是假设基因共表达网络为scale-free netork无尺度网络，其特征是少部分节点具有高连通性，大部分节点具有低连通性。在该网络中所有edge中，大部分接近于0，小部分接近于1，符合幂律分布，可幂函数(power function)拟合。由此得到的结果位于[0,1]之间，成为Weighted Network。</p></li></ul><p><img data-ratio="0.3315508021390374" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYfmarWChPYQkntyLmgdwJSpfoMyuyjVdC0uzxuuWEr8nFMalFicH0FjQ/640?wx_fmt=png" data-type="png" data-w="748" width="748" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYfmarWChPYQkntyLmgdwJSpfoMyuyjVdC0uzxuuWEr8nFMalFicH0FjQ/640?wx_fmt=png"></p><p>该网络中的节点connectivity即为所有邻居基因的共表达权重总和。</p><p>此方法的关键是确定一个合理指数，使得符合幂律分布。由于更符合生物网络的本质，因此推荐使用这种方法。</p><p><img data-ratio="0.12716763005780346" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYwA0tZZCib31xo3kMicrZWxa1U6N2C7J14htgPQHISaiaN8cLvOH2mQv8A/640?wx_fmt=png" data-type="png" data-w="346" width="230.66666666666666" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYwA0tZZCib31xo3kMicrZWxa1U6N2C7J14htgPQHISaiaN8cLvOH2mQv8A/640?wx_fmt=png"></p><p>关于Scale-free network有两个特点</p><p>（1）对节点error有一定容忍度，即破坏其中普通的低联通性节点，不会影响整体网络结构；</p><p>（2）但如果是数的hub node发生错误，则会造成严重后果。</p><h4>（3）topological overlap matrix</h4><p>在WGCNA中，为了<span>minimize effects of noise and spurious associations</span> 将上一步得到adjacency matrix，转化为 topological overlap matrix (TOM)。这一转换主要是考虑到了<strong>第三方基因</strong>对于两两基因间共表达关系的贡献。</p><p><img data-ratio="0.1600407747196738" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYhVRZibCGphjVGwWIicNda7pGj895uwoz9tcY3o3trPCVySI8c9Dt7lJg/640?wx_fmt=png" data-type="png" data-w="981" width="654" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYhVRZibCGphjVGwWIicNda7pGj895uwoz9tcY3o3trPCVySI8c9Dt7lJg/640?wx_fmt=png"></p><p>对于式1，计算基因的连通性connectivity；对于式2，计算基因i与基因j分别与其余所有基因共表达指标乘积的和。</p><p>举例来说基因i与基因j之间的共表达值为0.6，基因i与基因1\~8的共表达值分别为0.1\~0.8，基因j与基因5\~10的共表达值分别为0.1~0.6。ki=3.6，kj=1.8，lij=(0.5\*0.1)+(0.6\*0.2)+(0.7\*0.3)=0.38;  所以wij = （0.38 + 0.6）/(1.8+1-0.6) = 0.445。</p><p>由原来的0.6变为了0.445，降低的原因在于第三方基因与这对基因的相关性并不一致。</p><p><img data-ratio="0.7432432432432432" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYPEa6d6h9vzuSOHDDrtMXdMcXhSGpTu0EFKfCY8icIH2JJWa8sZtibdRA/640?wx_fmt=png" data-type="png" data-w="666" width="666" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYPEa6d6h9vzuSOHDDrtMXdMcXhSGpTu0EFKfCY8icIH2JJWa8sZtibdRA/640?wx_fmt=png"></p><h3>1.2 鉴定模块及相关分析</h3><ul><li><p><span>鉴定模块Module：将基因共表达网络转化为 dissimilarity matrix，然后基于树状图的层次聚类进行动态剪切将基因划分为若干模块。</span></p></li><li><p><span>Module eigengene模块特征值：即使用一个特征值代表某样本对于某个模块的</span><strong><span>特征Trait</span></strong><span>情况。具体计算方法是使用主成分分析PCA，提取第一个主成分值，如下图所示。</span></p></li></ul><p><img data-ratio="0.44549125168236875" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYGHWiaZia7BHBic2nFao3kRLXicfKa9cicL5PAHOcuAmrInMibobpibjFOeoFA/640?wx_fmt=png" data-type="png" data-w="743" width="743" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYGHWiaZia7BHBic2nFao3kRLXicfKa9cicL5PAHOcuAmrInMibobpibjFOeoFA/640?wx_fmt=png"></p><ul><li><p><span>Gene significance，GS：即比较样本某个基因与对应表型的相关性，有如下两种计算方式。一种是计算相关性绝对值，另一种是计算相关显著性。总体原则是signifcance越接近0，表示越无关。</span></p></li></ul><p><img data-ratio="0.10188087774294671" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYqpsmkTeUvficDvHhS8m1wqAjTyxgHnicEbf6SawSpy2uN5wmwMBalREA/640?wx_fmt=png" data-type="png" data-w="638" width="425.3333333333333" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYqpsmkTeUvficDvHhS8m1wqAjTyxgHnicEbf6SawSpy2uN5wmwMBalREA/640?wx_fmt=png"></p><ul><li><p>Module significance，MS：即模块内基因的平均GS</p></li></ul><p><img data-ratio="0.29831932773109243" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYEtEHEbVRJC1G35oiawCrA3M7WVR8lXibicMCXfibBK2aRSdoyJXzA3kG6w/640?wx_fmt=png" data-type="png" data-w="238" width="158.66666666666666" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYEtEHEbVRJC1G35oiawCrA3M7WVR8lXibicMCXfibBK2aRSdoyJXzA3kG6w/640?wx_fmt=png"></p><ul><li><p>Module Membership: 模块内基因表达与模块特征值的相关性，也称为eigengene-based connectivity。其绝对值越接近1，表明与该模块相关。</p></li></ul><p><img data-ratio="0.19753086419753085" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pY2Gpjy1IDNuDCVu9lxZpjGjqjBrWsNLVE3kHxjNaNy03W3shKYD4wmg/640?wx_fmt=png" data-type="png" data-w="324" width="216" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pY2Gpjy1IDNuDCVu9lxZpjGjqjBrWsNLVE3kHxjNaNy03W3shKYD4wmg/640?wx_fmt=png"></p><ul><li><p>Intramodular connectivity模块内连通性：表示某基因与某个模块内基因的共表达权重关系总和。</p></li></ul><hr><p><span>参考资料：</span><span>[1] A General Framework for Weighted Gene Co-Expression Network Analysis. doi:10.2202/1544-6115.1128</span></p><p><span>[2] WGCNA: an R package for weighted correlation network analysis. doi:10.1186/1471-2105-9-559</span></p><hr><h2>2. WGCNA 实操：</h2><p><span>以下代码、数据主要参考</span>官方教程</p><h4>2.1 整理输入数据</h4><p><span>关于WGCNA的输入数据要求，</span>官方文档<span>已经做说明，大致如下几点：</span></p><p><span>（1）至少20个样本以上，越多越好；</span></p><p><span>（2）可以过滤点低表达或者低方差的基因，以减少干扰信息。但不太建议直接使用差异基因。</span></p><p><span>（3）WGCNA最初用于芯片测序数据，也适用于RNA-seq数据。关于RNAseq标准化，由于不涉及到不同基因之间的比较，所有常规标准化方式都可以。</span></p><ul><li><p><span>整理表达矩阵</span></p></li></ul><pre data-language="r">exp_dat = read.csv("LiverFemale3600.csv",row.names = 1) %&gt;% .[,-c(1:7)]<br># [1] 3600  135<br>##(1)转置为行名为样本，列名为基因的表达矩阵<br>exp_mt = as.data.frame(t(exp_dat))<br>exp_mt[1:4,1:4]<br>#       MMT00000044 MMT00000046 MMT00000051 MMT00000076<br># F2_2    -1.81e-02     -0.0773     -0.0226    -0.00924<br># F2_3     6.42e-02     -0.0297      0.0617    -0.14500<br># F2_14    6.44e-05      0.1120     -0.1290     0.02870<br># F2_15   -5.80e-02     -0.0589      0.0871    -0.04390<br><br><br>##(2)判断数据质量--缺失值<br>gsg = goodSamplesGenes(exp_mt)<br>gsg$allOK<br># [1] TRUE<br><br><br>##(3)判断数据质量--离群点样本<br>sampleTree = hclust(dist(exp_mt), method = "average")<br>sizeGrWindow(12,9)<br>par(cex = 0.6);<br>par(mar = c(0,4,2,0))<br>plot(sampleTree, main = "Sample clustering to detect outliers", <br>     sub="", xlab="", cex.lab = 1.5,<br>     cex.axis = 1.5, cex.main = 2)<br>abline(h = 15, col = "red") #根据实际情况而定<br><br>##如下图所示，存在一个显著离群点；剔除掉<br>clust = cutreeStatic(sampleTree, cutHeight = 15, minSize = 10)<br>table(clust)<br># clust<br># 0   1 <br># 1 134 <br>keepSamples = (clust==1)<br>exp_mt_f = exp_mt[keepSamples, ]</pre><p><img data-ratio="0.5213903743315508" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYicicn1s5pSOUy4icpJMC8ibmuzTwR3y49kyaPQNJU8TTWFbBAwUKk6d6kw/640?wx_fmt=png" data-type="png" data-w="748" width="748" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYicicn1s5pSOUy4icpJMC8ibmuzTwR3y49kyaPQNJU8TTWFbBAwUKk6d6kw/640?wx_fmt=png"></p><ul><li><p><span>整理样本表型数据</span></p></li></ul><pre data-language="r">trait_dat = read.csv("ClinicalTraits.csv",row.names = 2) %&gt;% <br>  .[,setdiff(11:37,c(15,30))]<br>trait_dat_f = trait_dat[rownames(exp_mt_f),]<br>#       length_cm ab_fat other_fat total_fat<br># F2_2       10.5   3.81      2.78      6.59<br># F2_3       10.8   1.70      2.05      3.75<br># F2_14      10.0   1.29      1.67      2.96<br># F2_15      10.3   3.62      3.34      6.96<br><br>identical(rownames(exp_mt_f), rownames(trait_dat_f))<br>#[1] TRUE<br><br>##汇总最终数据<br>exp_dat = exp_mt_f<br>dim(exp_dat)<br># [1]  134 3600<br>exp_dat[1:4,1:4]<br><br>trait_dat = trait_dat_f<br>dim(trait_dat)<br># [1] 134  25<br>trait_dat[1:4,1:4]</pre><p><span>如上最终得到了整理好的表达矩阵数据</span><span>exp_dat</span><span>以及对应样本的表型数据</span><span>trait_dat</span></p><h4>2.2 选择合适的软阈值β</h4><ul><li><p><span>在1.1建立共表达网络，了解到WGCNA将similarity matrix转置为adjacency matrix的方法是进行幂律分布拟合。</span></p></li><li><p><span>这一步骤的关键是选取一个合适的指数参数</span><span>β</span><span>,使得adjacency matrix结果的权重值分布最大程度符合幂律分布。</span></p></li><li><p><span>可使用</span><span>pickSoftThreshold</span><span>筛选出最合适的值。</span></p></li></ul><pre data-language="r">#选定候选值<br>powers = c(c(1:10), seq(from = 12, to=20, by=2))<br># [1]  1  2  3  4  5  6  7  8  9 10 12 14 16 18 20<br>sft = pickSoftThreshold(exp_dat, powerVector = powers, verbose = 5)<br>##结果可视化：<br>sizeGrWindow(9, 5)<br>par(mfrow = c(1,2))<br>cex1 = 0.9<br>### （1）是否符合幂律分布；<br>plot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],<br>     xlab="Soft Threshold (power)",ylab="Scale Free Topology Model Fit,signed R^2",type="n",<br>     main = paste("Scale independence"));<br>text(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],<br>     labels=powers,cex=cex1,col="red")<br>abline(h=0.90,col="red")<br>### （2）节点的平均连接度<br>plot(sft$fitIndices[,1], sft$fitIndices[,5],<br>     xlab="Soft Threshold (power)",ylab="Mean Connectivity", type="n",<br>     main = paste("Mean connectivity"))<br>text(sft$fitIndices[,1], sft$fitIndices[,5], labels=powers, cex=cex1,col="red")<br><br>par(mfrow = c(1,1))</pre><p><span>如下图所示，基本在</span><strong><span>6</span></strong><span>时，拟合幂律分布的结果是比较好的；同时节点的凭据连通性也趋于稳定了。之后会使用这个参数建立网络。</span></p><p><img data-ratio="0.4946808510638298" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYz4ZkxfMTeqGZtamjF9zBTfQY5UIk1ybuM7W3fQj8ibKTtDCTDNpiadnQ/640?wx_fmt=png" data-type="png" data-w="752" width="752" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYz4ZkxfMTeqGZtamjF9zBTfQY5UIk1ybuM7W3fQj8ibKTtDCTDNpiadnQ/640?wx_fmt=png"></p><h4>2.3 建立网络，鉴定模块</h4><h5>方式一：逐步分析</h5><pre data-language="r">##(1) 根据选定的软阈值，得出邻接矩阵<br>adjacency = adjacency(exp_dat, power = 6)<br>adjacency[1:4,1:4]<br>#               F2_2         F2_3        F2_14        F2_15<br># F2_2  1.000000e+00 2.669773e-02 8.679043e-07 0.0285218325<br># F2_3  2.669773e-02 1.000000e+00 1.491148e-06 0.1223727405<br># F2_14 8.679043e-07 1.491148e-06 1.000000e+00 0.0007245466<br># F2_15 2.852183e-02 1.223727e-01 7.245466e-04 1.0000000000<br><br>##(2)转为TOM矩阵<br>TOM = TOMsimilarity(adjacency)<br>TOM[1:4,1:4]<br>#              [,1]         [,2]         [,3]        [,4]<br># [1,] 1.0000000000 0.0443291435 0.0006062579 0.033303820<br># [2,] 0.0443291435 1.0000000000 0.0005190759 0.068058832<br># [3,] 0.0006062579 0.0005190759 1.0000000000 0.002154665<br># [4,] 0.0333038199 0.0680588319 0.0021546653 1.000000000<br><br>##(3)进一步转为不相似性矩阵（距离矩阵）<br>dissTOM = 1-TOM<br>dissTOM[1:4,1:4]<br>#           [,1]      [,2]      [,3]      [,4]<br># [1,] 0.0000000 0.9556709 0.9993937 0.9666962<br># [2,] 0.9556709 0.0000000 0.9994809 0.9319412<br># [3,] 0.9993937 0.9994809 0.0000000 0.9978453<br># [4,] 0.9666962 0.9319412 0.9978453 0.0000000<br><br>##(4) 层次聚类hierarchical clustering<br>geneTree = hclust(as.dist(dissTOM), method = "average")<br>##(5) 动态切割树，鉴定模块<br>dynamicMods = cutreeDynamic(dendro = geneTree, distM = dissTOM,<br>                            deepSplit = 2, pamRespectsDendro = FALSE,<br>                            minClusterSize = 30)<br># dynamicMods<br># 0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22 <br># 88 614 316 311 257 235 225 212 158 153 121 106 102 100  94  91  78  76  65  58  58  48  34<br>##如上表示切割为22个基因模块，其中模块0表示 unassigned genes<br><br>##(6)将模块名映射为颜色名，并可视化<br>dynamicColors = labels2colors(dynamicMods)<br>table(dynamicColors) #module0 会被映射到灰色 grey<br>sizeGrWindow(8,6)<br>plotDendroAndColors(geneTree, dynamicColors, "Dynamic Tree Cut",<br>                    dendroLabels = FALSE, hang = 0.03,<br>                    addGuide = TRUE, guideHang = 0.05,<br>                    main = "Gene dendrogram and primary module colors")</pre><p><img data-ratio="0.5351123595505618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYSMdydib4UuemFl6esYQ8icpY4VqjAdMhRoiau7ZcOgMqO6bK1aEDMhfFg/640?wx_fmt=png" data-type="png" data-w="712" width="712" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYSMdydib4UuemFl6esYQ8icpY4VqjAdMhRoiau7ZcOgMqO6bK1aEDMhfFg/640?wx_fmt=png"></p><ul><li><p><span>接下来需要判断有无非常相似的模块，进行合并操作</span></p></li></ul><pre data-language="r">##(7)根据模块的特征值，计算不同模块的相似性，进行层次聚类<br>MEList = moduleEigengenes(exp_dat, colors = dynamicColors)<br>MEs = MEList$eigengenes<br>MEDiss = 1-cor(MEs)<br>METree = hclust(as.dist(MEDiss), method = "average")<br>sizeGrWindow(7, 6)<br>plot(METree, main = "Clustering of module eigengenes",<br>     xlab = "", sub = "")<br>abline(h=0.25, col = "red")  #根据实际情况而定</pre><p><img data-ratio="0.4243243243243243" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYO3lElDIrqS7Ea1BicX4WqNCss7yMVCxa0yQOLxJ79umVTdMhwiaFSuqQ/640?wx_fmt=png" data-type="png" data-w="740" width="740" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYO3lElDIrqS7Ea1BicX4WqNCss7yMVCxa0yQOLxJ79umVTdMhwiaFSuqQ/640?wx_fmt=png"></p><pre data-language="r">##(8)根据选择的阈值，合并模块<br>merge = mergeCloseModules(exp_dat, dynamicColors, cutHeight = 0.25)<br>#新划分模块的颜色映射<br>mergedColors = merge$colors<br>#新划分模块的特征值<br>mergedMEs = merge$newMEs<br>#可视化合并前后的模块<br>sizeGrWindow(12, 9)<br>plotDendroAndColors(geneTree, cbind(dynamicColors, mergedColors),<br>                    c("Dynamic Tree Cut", "Merged dynamic"),<br>                    dendroLabels = FALSE, hang = 0.03,<br>                    addGuide = TRUE, guideHang = 0.05)</pre><p><img data-ratio="0.5371669004207573" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYibRM2BcWjhKYQkyb8Kny3phNujDMVNcbNC3BwW6u2L6ibTiaM8e0bJAtw/640?wx_fmt=png" data-type="png" data-w="713" width="713" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYibRM2BcWjhKYQkyb8Kny3phNujDMVNcbNC3BwW6u2L6ibTiaM8e0bJAtw/640?wx_fmt=png"></p><h5>方式二：一步分析</h5><p><span>WGCNA包提供了</span><span>blockwiseModules()</span><span>函数可将上述步骤打包在一起，一次执行建立网络、鉴定模块的分析。</span></p><p><span>结合逐步分析，可以看到有一些关键参数可以调节：</span></p><ul><li><p><span>power</span><span>：软阈值的选择</span></p></li><li><p><span>corType</span><span>：计算相关性的方法；可选pearson(默认)，bicor。后者更能考虑离群点的影响。</span></p></li><li><p><span>networkType</span><span>:计算邻接矩阵时，是否考虑正负相关性；默认为"unsigned",可选"signed", "signed hybrid"</span></p></li><li><p><span>TOMType</span><span>：计算TOM矩阵时，是否考虑正负相关性；默认为"signed",可选"unsigned"。但是根据幂律转换的邻接矩阵(权重)的非负性，所以认为这里选择"signed"也没有太多的意义。</span></p></li><li><p><span>minModuleSize</span><span>：模块的最少基因数</span></p></li><li><p><span>mergeCutHeight</span><span>：合并模块的阈值</span></p></li><li><p><span>numericLabels</span><span>：模块名是否为数字；若设置FALSE，表示映射为颜色名。</span></p></li><li><p><span>saveTOMs</span><span>：是否保存TOM矩阵；如果设为</span><span>TRUE</span><span>，需要设置</span><span>saveTOMFileBase</span><span>参数，提供保存文件名；设置</span><span>numericLabels</span><span>参数，是否将模块名保存为颜色名</span></p></li><li><p><span>nThreads</span><span>：交代线程数，适用于Linux环境</span></p></li><li><p><span>verbose</span><span>：0默认安静的执行，值越大表示给出的运行提示信息越多。</span></p></li></ul><p><span>关于</span><span>blocks</span><span>相关参数：主要是考虑到输入基因数太大，电脑运行内存不足的情况。默认为"NULL"，即全部一次运行，不分多个blocks。</span></p><p><img data-ratio="0.19002695417789758" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYC1VlaCVFqFuJ8UdEkyWuFSHCMeU7OIicgnHdeVg65Cffy6ABnWyNnMw/640?wx_fmt=png" data-type="png" data-w="742" width="742" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYC1VlaCVFqFuJ8UdEkyWuFSHCMeU7OIicgnHdeVg65Cffy6ABnWyNnMw/640?wx_fmt=png"></p><pre data-language="r">net = blockwiseModules(exp_dat, power = 6,<br>                       corType = "pearson",<br>                       networkType="unsigned",<br>                       TOMType = "unsigned", <br>                       minModuleSize = 30,<br>                       mergeCutHeight = 0.25,<br>                       verbose = 3)<br><br>names(net)<br># [1] "colors"         "unmergedColors" "MEs"            "goodSamples"    "goodGenes"     <br># [6] "dendrograms"    "TOMFiles"       "blockGenes"     "blocks"         "MEsOK"</pre><ul><li><p><span>解析结果list结构</span></p></li></ul><pre data-language="r">#(1) 最终得到的网络模块(合并之后)<br>unique(net$colors)<br>table(net$colors)<br># grey module是 unassigned gene<br><br>##合并之前的网络模块<br>unique(net$unmergedColors)<br>table(net$unmergedColors)<br><br>#(2) 134个样本对于18个模块的特征值<br>dim(net$MEs)<br>net$MEs[1:4,1:4]<br>net$MEsOK<br><br>#(3)聚类树状图，color注释模块<br>plotDendroAndColors(dendro = net$dendrograms[[1]],<br>                    colors = net$colors)</pre><p><img data-ratio="0.5381414701803051" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pY1tcYmygy20RjjrOF6AgLBHtv5JbhqUt5pJOPLOpbxCDS5JVAIdL2ow/640?wx_fmt=png" data-type="png" data-w="721" width="721" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pY1tcYmygy20RjjrOF6AgLBHtv5JbhqUt5pJOPLOpbxCDS5JVAIdL2ow/640?wx_fmt=png"></p><h4>2.4 关联表型分析</h4><p><span>以2.3 方式二得到结果继续分析</span></p><pre data-language="r"># (1)计算模块特征值<br># MEs = moduleEigengenes(exp_dat, net$colors)$eigengenes<br>MEs = net$MEs<br>MEs = orderMEs(MEs)<br><br># (2)计算18个module与25个表型的相关性以及对应的P值<br>moduleTraitCor = cor(MEs, trait_dat, use = "p")<br>moduleTraitCor[1:4,1:4]<br>#               length_cm       ab_fat  other_fat   total_fat<br># MEmagenta    0.08015682 -0.004282784 -0.0311292 -0.01504395<br># MEturquoise -0.14101586 -0.323615446 -0.0528274 -0.23393609<br># MEred       -0.15070061 -0.268348526 -0.1458333 -0.23102647<br># MEyellow    -0.13732537 -0.067163777  0.1958153  0.04806599<br><br>moduleTraitPvalue = corPvalueStudent(moduleTraitCor, nrow(MEs))<br>moduleTraitPvalue[1:4,1:4]<br>#              length_cm       ab_fat  other_fat   total_fat<br># MEmagenta   0.35722181 0.9608295943 0.72104901 0.863025117<br># MEturquoise 0.10411666 0.0001366333 0.54437147 0.006518482<br># MEred       0.08219621 0.0017187522 0.09269921 0.007237730<br># MEyellow    0.11358818 0.4406688535 0.02336043 0.581283912<br><br># (3)可视化相关性与P值<br>sizeGrWindow(10,6)<br># Will display correlations and their p-values<br>textMatrix = paste(signif(moduleTraitCor, 2), "\n(",<br>                   signif(moduleTraitPvalue, 1), ")", sep = "")<br>dim(textMatrix) = dim(moduleTraitCor)<br>par(mar = c(6, 8.5, 3, 3))<br>labeledHeatmap(Matrix = moduleTraitCor,<br>               xLabels = names(trait_dat),<br>               yLabels = names(MEs),<br>               ySymbols = names(MEs),<br>               colorLabels = FALSE,<br>               colors = greenWhiteRed(50),<br>               textMatrix = textMatrix,<br>               setStdMargins = FALSE,<br>               cex.text = 0.5,<br>               zlim = c(-1,1),<br>               main = paste("Module-trait relationships"))</pre><p><img data-ratio="0.6932599724896836" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYBcUDNPsdTgBV85yXRPzV4IZcyjzfVJ0CkTTXnaTz6M2lpy22ibVt0Sw/640?wx_fmt=png" data-type="png" data-w="727" width="727" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYBcUDNPsdTgBV85yXRPzV4IZcyjzfVJ0CkTTXnaTz6M2lpy22ibVt0Sw/640?wx_fmt=png"></p><pre data-language="r">##计算指定表型的相关分析<br>weight = trait_dat[,"X100xfat_weight",drop=F]<br>colnames(weight) = "weight"<br># (1) Gene significance，GS：即比较样本某个基因与对应表型的相关性<br>GS_weight = as.data.frame(cor(exp_dat, weight, use = "p"))<br>colnames(GS_weight) = "GS_weight"<br>head(GS_weight)<br>#               GS_weight<br># MMT00000044 -0.06788487<br># MMT00000046 -0.09806093<br># MMT00000051  0.20311624<br><br>GS.p_weight = as.data.frame(corPvalueStudent(as.matrix(GS_weight), nrow(exp_dat)))<br>#            GS.p_weight<br># MMT00000044 0.43576664<br># MMT00000046 0.25964873<br># MMT00000051 0.01858241<br><br><br># (2) Module Membership: 模块内基因表达与模块特征值的相关性<br>modNames = substring(names(MEs), 3)<br># 计算3600个基因与18个模块的相关性<br>MM = as.data.frame(cor(exp_dat, MEs, use = "p"))<br>colnames(MM) = paste("MM", modNames, sep="")<br>MM[1:4,1:4]<br><br>MMPvalue = as.data.frame(corPvalueStudent(as.matrix(MM), nrow(exp_dat)))<br>MMPvalue = as.data.frame(corPvalueStudent(as.matrix(MM), nrow(exp_dat)));<br>colnames(MMPvalue) = paste("p.MM", modNames, sep="");<br>MMPvalue[1:4,1:4]<br><br># (3) 可视化blue模块基因特征<br># identical(rownames(MM), names(net$colors))<br># TRUE<br>module = "blue"<br>moduleGenes = names(net$colors)[net$colors=="blue"]<br>sizeGrWindow(7, 7)<br>par(mfrow = c(1,1))<br>verboseScatterplot(abs(MM[moduleGenes, "MMblue"]),<br>                   abs(GS_weight[moduleGenes, 1]),<br>                   xlab = paste("Module Membership in", module, "module"),<br>                   ylab = "Gene significance for body weight",<br>                   main = paste("Module membership vs. gene significance\n"),<br>                   cex.main = 1.2, cex.lab = 1.2, cex.axis = 1.2, col = module)</pre><p><span>可视化blue模块内的基因特征。当基因与blue模块越相关时，该基因也与该表型Trait相关。</span></p><p><img data-ratio="0.6369593709043251" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYWkl5wRKMpTmkjibAZQFaZIG3sX1enD2R1D82XxyTe9zzicCd1xcwl1jQ/640?wx_fmt=png" data-type="png" data-w="763" width="763" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wznv0hV4N1SQj4HSMU6C8pYWkl5wRKMpTmkjibAZQFaZIG3sX1enD2R1D82XxyTe9zzicCd1xcwl1jQ/640?wx_fmt=png"></p><h4>2.5 挑选模块Hub基因</h4><p><span>关于模块的Hub基因，WGCNA并没有明确的筛选方法。</span></p><pre data-language="r">## (1) 模块内基因连接度<br>adjacency = adjacency(exp_dat, power = 6)<br># TOM = TOMsimilarity(adjacency)<br>TOM[1:4,1:4]<br>Alldegrees =intramodularConnectivity(adjacency, net$colors)<br>head(Alldegrees)<br>#                 kTotal    kWithin       kOut      kDiff<br># MMT00000044  0.4092743  0.2862358  0.1230385  0.1631973<br># MMT00000046 37.8927830 24.9652317 12.9275513 12.0376805<br># MMT00000051 28.3866248 17.2076759 11.1789488  6.0287271<br># MMT00000076  1.3015473  1.1992420  0.1023053  1.0969366<br># MMT00000080 25.9713107 16.3954194  9.5758914  6.8195280<br># MMT00000102 10.5051504  2.4713718  8.0337786 -5.5624067<br><br>#### kTotal:基因在整个网络中的连接度<br>#### kWithin: 基因在所属模块中的连接度，即Intramodular connectivity<br>#### kOut: kTotal-kWithin<br>#### kDiff: kIn-kOut<br><br>#也可以绘制一个模块基因的Intramodular connectivity与Gene significance的散点图<br><br><br>## (2) Module Membership: 即上一节计算的模块内基因表达与模块特征值的相关性。<br><br>## (3) Gene significance，GS：即比较样本某个基因与对应表型的相关性<br><br>## (4) 综合上述指标，自定义合适阈值，选取一定数量的模块Hub基因。</pre><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span>学徒作业癌症分子亚型特异性模块</span><span></span></h3><p data-tool="mdnice编辑器">我们《生信技能树》这些年有很多关于WGCNA的实战细节建议分享，见：</p><ul data-tool="mdnice编辑器"><li><section>一文学会WGCNA分析</section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247491248&amp;idx=1&amp;sn=afb11345a1e89cd57ace7dcf827dddbf&amp;scene=21#wechat_redirect" data-linktype="2">一文看懂WGCNA 分析(2019更新版)</a> （点击阅读原文即可拿到测序数据）</section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247499182&amp;idx=1&amp;sn=835cc06d716d5a1cc54e713b76e8bd22&amp;scene=21#wechat_redirect" data-linktype="2">明码标价之公共数据集的WGCNA</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247491248&amp;idx=2&amp;sn=2ca3ae271eccfbbf0b719d0a0e03439b&amp;scene=21#wechat_redirect" data-linktype="2">通过WGCNA作者的测试数据来学习</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247491373&amp;idx=1&amp;sn=72a6d5c354ecfdde5b0f048caf3ff5cc&amp;scene=21#wechat_redirect" data-linktype="2">重复一篇WGCNA分析的文章（代码版）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247491373&amp;idx=2&amp;sn=5bcca3300c1202575f0d6452b6233a4e&amp;scene=21#wechat_redirect" data-linktype="2">重复一篇WGCNA分析的文章（解读版）（逆向收费读文献2019-19）</a></section></li></ul><p data-tool="mdnice编辑器">其实WGCNA本身是对基因进行合理（加权共表达）的分组。</p><ul data-tool="mdnice编辑器"><li><section>如果一个表达量矩阵， 里面的样品是两个分组，比如正常和对照，那么简单的差异分析就可以拿到上下调基因，各自可以去富集生物学通路，就是基因分组了，并没有太多的进行WGCNA分析的必要性，而且绝大部分的两个分组的表达量矩阵里面的样品数量通常是小于15个的，官方也并推荐WGCNA分析。</section></li><li><section>如果一个表达量矩阵，里面的样品是时间序列这样的多分组，比如处理前后以及处理过程的不同时间梯度或者不同浓度，那么我们就需要每个分组都去跟对照组进行差异分析，上下调的组合非常多，结果也很难精炼出生物学结论，这个时候就可以选择WGCNA或者mfuzz这样的时间序列分析。</section></li></ul><p data-tool="mdnice编辑器">也就是说，只要是多分组，就涉及到多次差异分析，而且多分组意味着样品数量肯定不少，这样的话，在这个表达量矩阵里面，不同基因之间可以计算合理的相关性， 就可以根据基因之间的相似性进行基因划分为不同的模块了。</p><p data-tool="mdnice编辑器">最近看到了一个纯WGCNA数据挖掘可视化做的比较好的文章：《A network approach reveals driver genes associated with survival of patients with triple-negative breast cancer》，链接  ：https://doi.org/10.1016/j.isci.2021.102451<span title="DOI: 10.1016/j.isci.2021.102451" es-id-type="DOI" es-id="10.1016/j.isci.2021.102451" es-collect-button-id="1"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 1000 1000" enable-background="new 0 0 1000 1000" height="1em"><g><path d="M852.3,135.6l-47.7,48.3c157.6,178.7,157.4,451,0.1,631l48.8,49.5C1035.9,672.1,1035.5,327.2,852.3,135.6z M740.9,248.6l-49.3,49.9c96.1,115.5,96.1,285.8,0.5,402.1l48.8,49.6C863.4,606.1,863.6,391.5,740.9,248.6z M195.4,183.9l-47.7-48.3c-183.2,191.6-183.6,536.5-1.2,728.8l48.8-49.5C37.9,635,37.8,362.6,195.4,183.9z M259.1,248.6C136.4,391.5,136.6,606.1,259,750.3l48.8-49.6c-95.6-116.4-95.6-286.6,0.4-402.1L259.1,248.6z M499.8,340.4c-87.3,0-158.1,71.8-158.1,160.4c0,88.5,70.8,160.4,158.1,160.4c87.3,0,158.1-71.8,158.1-160.4C657.8,412.2,587,340.4,499.8,340.4z"></path></g></svg></span></p><p data-tool="mdnice编辑器">需要有乳腺癌背景知识，比如它的表达量分子分型通常是是 lumA、lumB、basal、HER2 等亚型，其中每个分子分型其实也可以细分，比如TNBC可以继续进一步细分为3~7种亚型。</p><p data-tool="mdnice编辑器">这次给大家的作业比较困难，需要通读文献，并且做出第一张图：</p></section><p><img data-galleryid="" data-ratio="0.6099290780141844" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycIUqM0zIIJ4RUDnON4mnibG4XxGMwOLicjBLjTTfPVV1lag4w23MC9iaMKusFbfOxCCfrCYzj8qyiaA/640?wx_fmt=png" data-type="png" data-w="1692" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycIUqM0zIIJ4RUDnON4mnibG4XxGMwOLicjBLjTTfPVV1lag4w23MC9iaMKusFbfOxCCfrCYzj8qyiaA/640?wx_fmt=png"></p><h3 data-tool="mdnice编辑器">写在文末</h3><p data-tool="mdnice编辑器">我在《生信技能树》，《生信菜鸟团》，《单细胞天地》的大量推文教程里面共享的代码都是复制粘贴即可使用的， 有任何疑问欢迎留言讨论，也可以发邮件给我，详细描述你遇到的困难的前因后果给我，我的邮箱地址是 jmzeng1314@163.com</p><p data-tool="mdnice编辑器">如果你确实觉得我的教程对你的科研课题有帮助，让你茅塞顿开，或者说你的课题大量使用我的技能，烦请日后在发表自己的成果的时候，加上一个简短的致谢，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>We thank Dr.Jianming Zeng(University of Macau), and all the members of his bioinformatics team, biotrainee, <span>for</span> generously sharing their experience and codes.<br></code></pre><p data-tool="mdnice编辑器">十年后我环游世界各地的高校以及科研院所（当然包括中国大陆）的时候，如果有这样的情谊，我会优先见你。</p><p><br></p><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/2VXprzgJSYJ39AhZ_FprCQ",target="_blank" rel="noopener noreferrer">原文链接</a>
