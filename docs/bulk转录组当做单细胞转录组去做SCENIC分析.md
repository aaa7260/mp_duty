---
title: "bulk转录组当做单细胞转录组去做SCENIC分析"
date: 2022-10-11T23:34:33Z
draft: ["false"]
tags: [
  "fetched",
  "东林的扯淡小屋"
]
categories: ["Acdemic"]
---
bulk转录组当做单细胞转录组去做SCENIC分析 by 东林的扯淡小屋
------
<div><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="ruby"><code><span>YDL&lt;- readRDS(<span>"mm_ternimalE.rds"</span>)</span></code><code><span>YDL</span></code><code><span>set.seed(<span>123</span>)</span></code><code><span>library(Seurat)</span></code><code><span>library(tidyverse)</span></code><code><span>library(patchwork)</span></code><code><span>library(SCENIC)</span></code><code><span><span>##==分析准备==##</span></span></code><code><span>dir.create(<span>"SCENIC"</span>)</span></code><code><span>dir.create(<span>"SCENIC/int"</span>)</span></code><code><span>scRNA &lt;- YDL</span></code><code><span>setwd(<span>"./SCENIC"</span>) </span></code><code><span><span>##准备细胞meta信息</span></span></code><code><span><span>##准备细胞meta信息</span></span></code><code><span>cellInfo &lt;- data.frame(scRNA@meta.data)</span></code><code><span>colnames(cellInfo)[which(colnames(cellInfo)==<span>"orig.ident"</span>)] &lt;- <span>"sample"</span></span></code><code><span><span>#colnames(cellInfo)[which(colnames(cellInfo)=="seurat_clusters")] &lt;- "cluster"</span></span></code><code><span>colnames(cellInfo)[which(colnames(cellInfo)==<span>"celltype"</span>)] &lt;- <span>"celltype"</span></span></code><code><span>cellInfo &lt;- cellInfo[,c(<span>"sample"</span>,<span>"celltype"</span>)]</span></code><code><span>saveRDS(cellInfo, file=<span>"int/cellInfo.Rds"</span>)</span></code><code><span><span>##准备表达矩阵</span></span></code><code><span><span>#为了节省计算资源，随机抽取1000个细胞的数据子集</span></span></code><code><span><span>#subcell &lt;- sample(colnames(scRNA),1000)</span></span></code><code><span><span>#scRNAsub &lt;- scRNA[,subcell]</span></span></code><code><span><span>#saveRDS(scRNAsub, "scRNAsub.rds")</span></span></code><code><span>exprMat &lt;- as.matrix(scRNA@assays$RNA@counts)</span></code><code><span>dim(exprMat)</span></code><code><span><span># [1] 32285  1000</span></span></code><code><span><span>#head(cellInfo)</span></span></code><code><span><span>##设置分析环境</span></span></code><code><span>mydbDIR &lt;- <span>"/data/yudonglin/scenic/cisTarget_databases/cisTarget_databases/"</span></span></code><code><span>mydbs &lt;- c(<span>"mm9-500bp-upstream-7species.mc9nr.feather"</span>,</span></code><code><span>           <span>"mm9-tss-centered-10kb-7species.mc9nr.feather"</span>)</span></code><code><span>names(mydbs) &lt;- c(<span>"500bp"</span>, <span>"10kb"</span>)</span></code><code><span>scenicOptions &lt;- initializeScenic(org=<span>"mgi"</span>, </span></code><code><span>                                  nCores=<span>20</span>,</span></code><code><span>                                  dbDir=mydbDIR, </span></code><code><span>                                  dbs = mydbs,</span></code><code><span>                                  datasetTitle = <span>"SCENIC"</span>)</span></code><code><span>saveRDS(scenicOptions, <span>"int/scenicOptions.rds"</span>)</span></code><code><span>genesKept &lt;- geneFiltering(exprMat, scenicOptions, </span></code><code><span>                           minCountsPerGene = <span>3</span> * <span>0</span>.<span>01</span> * ncol(exprMat), </span></code><code><span>                           minSamples = ncol(exprMat) * <span>0</span>.<span>01</span>)</span></code><code><span>exprMat_filtered &lt;- exprMat[genesKept, ]</span></code><code><span><span>##计算相关性矩阵</span></span></code><code><span>runCorrelation(exprMat_filtered, scenicOptions)</span></code><code><span><span>##TF-Targets相关性回归分析</span></span></code><code><span>exprMat_filtered_log &lt;- log2(exprMat_filtered+<span>1</span>)</span></code><code><span>runGenie3(exprMat_filtered_log, scenicOptions, nParts = <span>20</span>)</span></code><code><span><span>#这一步消耗的计算资源非常大，个人电脑需要几个小时的运行时间</span></span></code><code><span><span>##推断共表达模块</span></span></code><code><span>runSCENIC_1_coexNetwork2modules(scenicOptions)</span></code><code><span>scenicOptions &lt;- initializeScenic(org=<span>"mgi"</span>, </span></code><code><span>                                  nCores=<span>9</span>,</span></code><code><span>                                  dbDir=mydbDIR, </span></code><code><span>                                  dbs = mydbs,</span></code><code><span>                                  datasetTitle = <span>"erythrogenesis"</span>)</span></code><code><span><span>##推断转录调控网络（regulon）</span></span></code><code><span>runSCENIC_2_createRegulons(scenicOptions)</span></code><code><span><span>#以上代码可增加参数coexMethod=c("w001", "w005", "top50", "top5perTarget", "top10perTarget", "top50perTarget"))</span></span></code><code><span><span>#默认6种方法的共表达网络都计算，可以少选几种方法以减少计算量</span></span></code><code><span>scenicOptions &lt;- initializeScenic(org=<span>"mgi"</span>, </span></code><code><span>                                  nCores=<span>1</span>,</span></code><code><span>                                  dbDir=mydbDIR, </span></code><code><span>                                  dbs = mydbs,</span></code><code><span>                                  datasetTitle = <span>"erythrogenesis"</span>)</span></code><code><span><span>##==regulon活性评分与可视化==##</span></span></code><code><span><span>##regulons计算AUC值并进行下游分析</span></span></code><code><span>exprMat_all &lt;- as.matrix(scRNA@assays$RNA@counts)</span></code><code><span>exprMat_all &lt;- log2(exprMat_all+<span>1</span>)</span></code><code><span>saveRDS(exprMat_all,<span>"exprMat_all.rds"</span>)</span></code><code><span><span># rm(list=ls())</span></span></code><code><span><span># scenicOptions&lt;-readRDS("scenicOptions.rds")</span></span></code><code><span><span># exprMat_all&lt;-readRDS("exprMat_all.rds")</span></span></code><code><span>runSCENIC_3_scoreCells(scenicOptions, exprMat=exprMat_all)</span></code><code><span><span># #使用shiny互动调整阈值</span></span></code><code><span><span># aucellApp &lt;- plotTsne_AUCellApp(scenicOptions, exprMat_all)</span></span></code><code><span><span># savedSelections &lt;- shiny::runApp(aucellApp)</span></span></code><code><span><span># #保存调整后的阈值</span></span></code><code><span><span># newThresholds &lt;- savedSelections$thresholds</span></span></code><code><span><span># scenicOptions<span>@fileNames</span>$int["aucell_thresholds",1] &lt;- "int/newThresholds.Rds"</span></span></code><code><span><span># saveRDS(newThresholds, file=getIntName(scenicOptions, "aucell_thresholds"))</span></span></code><code><span><span># saveRDS(scenicOptions, file="int/scenicOptions.Rds")</span></span></code><code><span>runSCENIC_4_aucell_binarize(scenicOptions, exprMat=exprMat_all)</span></code><code><span>savehistory(<span>"scenic_code.txt"</span>)</span></code><code><span><br></span></code></pre></section><p>只有20个样本，视为20个单细胞：<br></p><p><img data-galleryid="" data-ratio="0.22018348623853212" data-s="300,640" data-type="png" data-w="654" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoICMLmibIsQh0maS56BbUAeWrLypOAPyVeRmgkVlhTusPhPtADlzy6Zfe1icZbnWvNMBuiafOibqYoUA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoICMLmibIsQh0maS56BbUAeWrLypOAPyVeRmgkVlhTusPhPtADlzy6Zfe1icZbnWvNMBuiafOibqYoUA/640?wx_fmt=png"></p><p><img data-galleryid="" data-ratio="0.7575757575757576" data-s="300,640" data-type="png" data-w="858" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoICMLmibIsQh0maS56BbUAeNvo9fPiaGJ2TSrxdS1OurXpGPVSBc6S4P7LrQsjD8g5Wjh5YibgoIkYA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoICMLmibIsQh0maS56BbUAeNvo9fPiaGJ2TSrxdS1OurXpGPVSBc6S4P7LrQsjD8g5Wjh5YibgoIkYA/640?wx_fmt=png"></p><p><img data-galleryid="" data-ratio="0.25" data-s="300,640" data-type="png" data-w="860" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoICMLmibIsQh0maS56BbUAeOWsOySuCRRm8YiaboxyllGUqY33votfiaW9ZnETKLBX8r5oIdJmgX8Tw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoICMLmibIsQh0maS56BbUAeOWsOySuCRRm8YiaboxyllGUqY33votfiaW9ZnETKLBX8r5oIdJmgX8Tw/640?wx_fmt=png"></p><p><img data-galleryid="" data-ratio="0.9313559322033899" data-s="300,640" data-type="png" data-w="1180" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoICMLmibIsQh0maS56BbUAebg2Ooml2QZ3c2lfCUMeg811SLLop3QJBeDFNKxNRw2eBtlIVf3TlSw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoICMLmibIsQh0maS56BbUAebg2Ooml2QZ3c2lfCUMeg811SLLop3QJBeDFNKxNRw2eBtlIVf3TlSw/640?wx_fmt=png"></p><p><img data-galleryid="" data-ratio="0.7664720600500416" data-s="300,640" data-type="png" data-w="1199" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoICMLmibIsQh0maS56BbUAeic9v7AeeKUicEcoEfDwjrWKM39qVnTkdAr16uD90UoTHYyI4yHx6lBjg/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoICMLmibIsQh0maS56BbUAeic9v7AeeKUicEcoEfDwjrWKM39qVnTkdAr16uD90UoTHYyI4yHx6lBjg/640?wx_fmt=png"><br></p><p><img data-galleryid="" data-ratio="0.9330065359477124" data-s="300,640" data-type="png" data-w="1224" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoICMLmibIsQh0maS56BbUAekU2vmYazwJ14B20UZyw1b4ZiayaawY46ABkR3QqM0ARI3uiaPNV1JD9A/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoICMLmibIsQh0maS56BbUAekU2vmYazwJ14B20UZyw1b4ZiayaawY46ABkR3QqM0ARI3uiaPNV1JD9A/640?wx_fmt=png"></p><p>也算是一个骚操作了hhh，不过要求每个样本至少三个重复才行。</p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/WvbszojyMMIoMus0smMy7g",target="_blank" rel="noopener noreferrer">原文链接</a>
