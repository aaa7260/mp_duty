---
title: "gtsummary包，批量建模并输出整洁模型结果"
date: 2022-10-15T11:56:05Z
draft: ["false"]
tags: [
  "fetched",
  "R语言统计与绘图"
]
categories: ["Acdemic"]
---
gtsummary包，批量建模并输出整洁模型结果 by R语言统计与绘图
------
<div><p data-mpa-powered-by="yiban.io"><img data-galleryid="" data-ratio="0.4311111111111111" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib0Bmz17WIGZ606Z1vvaCCv7lOXzf1Uf8Me14tRgtibcS4v6MXicTEp9QiaoKCBhibQXS3e395gOI3wTrQ/640?wx_fmt=png" data-type="png" data-w="900" src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib0Bmz17WIGZ606Z1vvaCCv7lOXzf1Uf8Me14tRgtibcS4v6MXicTEp9QiaoKCBhibQXS3e395gOI3wTrQ/640?wx_fmt=png"></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">今天继续来学习gtsummary包，这个R包的主要作用是汇总数据、回归建模，然后将统计的结果以一种可自定义的、优美的格式输出出来，简化数据科学流程，极大提高数据统计效率。</p><p data-tool="mdnice编辑器">前面我们学习了怎么使用<a href="https://mp.weixin.qq.com/s?__biz=MzU4OTc0OTg2MA==&amp;mid=2247498563&amp;idx=1&amp;sn=27727d24f1ca09f318adf7d47d32216d&amp;scene=21#wechat_redirect" data-linktype="2">gtsummary包去对临床数据进行统计描述</a>，今天来学习使用gtsummary包快速回归建模，并输出统计结果。</p><p data-tool="mdnice编辑器">下面来简单学习一下。</p><h2 data-tool="mdnice编辑器"><span></span><span>1. 安装和加载R包</span><span></span></h2><p data-tool="mdnice编辑器">可以直接从CRAN上安装。</p><pre data-tool="mdnice编辑器"><code>install.packages(<span>"gtsummary"</span>)<br><span>library</span>(gtsummary)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>2.加载数据</span><span></span></h2><p data-tool="mdnice编辑器">使用survival包的colon数据集进行演示。</p><pre data-tool="mdnice编辑器"><code>data(colon, package=<span>"survival"</span>)<br>colon<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.34105960264900664" data-src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNt74ibAmAkbCVr5rtUmnQiaiaATGopb06bHichL9WLic2gIpSVVjqib556ibxcA/640?wx_fmt=png" data-type="png" data-w="906" src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNt74ibAmAkbCVr5rtUmnQiaiaATGopb06bHichL9WLic2gIpSVVjqib556ibxcA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">这个数据集收集了B/C 期结肠癌患者辅助化疗后的生存时间数据。</p><p data-tool="mdnice编辑器">数据集中的变量解释：</p><pre data-tool="mdnice编辑器"><code>id <span># 患者编号</span><br>study <span># 所有患者都是1</span><br>rx <span># 表示治疗方式，有三种：观察、Levamisole、Levamisole + 5-FU</span><br>sex <span># 性别，男性为1，女性为0</span><br>age <span># 年龄</span><br>obstruct <span># 肿瘤是否阻塞结肠，1 为有，0 为无</span><br>perfor <span># 结肠是否穿孔，1 为有，0 为无</span><br>adhere <span># 肿瘤是否粘附邻近器官，1 为有，0 为无</span><br>nodes <span># 检出淋巴结的数目</span><br>status <span># 生存状态，1 为发生感兴趣终点事件，0 为删失</span><br>differ <span># 肿瘤的分化程度(1=well, 2=moderate, 3=poor)</span><br>extent <span># 局部转移程度（1=submucosa, 2=muscle, 3=serosa, 4=contiguous structures）</span><br>surg <span># 从手术到登记注册的时间(0=short, 1=long)</span><br>node4 <span># 超过4 个阳性淋巴结</span><br>time <span># 直至发生感兴趣终点事件或删失的时间</span><br>etype <span># 事件类型: 1= 复发,2= 死亡</span><br></code></pre><p data-tool="mdnice编辑器">查看数据类型。</p><pre data-tool="mdnice编辑器"><code>str(colon)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.4823196605374823" data-src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtMoN5yCW0A4dEFrhfDlcbDXSFjPmup36ro22BMMhnUhXSIBYhiagFhgw/640?wx_fmt=png" data-type="png" data-w="707" src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtMoN5yCW0A4dEFrhfDlcbDXSFjPmup36ro22BMMhnUhXSIBYhiagFhgw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span><span>3. 处理数据</span><span></span></h2><p data-tool="mdnice编辑器">有些数字型变量其实是分类变量，需要先转换数据类型。</p><p data-tool="mdnice编辑器">转换后构建新的数据集。</p><pre data-tool="mdnice编辑器"><code><span>library</span>(tidyverse)<br>mycolon &lt;- colon %&gt;% <span># 创建新数据集新变量</span><br>  transmute(time,<br>            status,<br>            Age = age,<br>            Sex = factor(sex, levels = c(<span>0</span>, <span>1</span>),<br>                         labels = c(<span>"Female"</span>, <span>"Male"</span>)),<br>            Obstruct = factor(colon$obstruct),<br>            Differ = factor(colon$differ))<br>str(mycolon) <span># 查看数据集结构</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.23168908819133036" data-src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtwpeeyvvsC5vx62nxYhdQwcB4fUFr6kLW6fj0zSw3FnkLibIzQk1CfKg/640?wx_fmt=png" data-type="png" data-w="669" src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtwpeeyvvsC5vx62nxYhdQwcB4fUFr6kLW6fj0zSw3FnkLibIzQk1CfKg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">数据集中保留6个变量，连续变量、分类变量都有。</p><p data-tool="mdnice编辑器">下面来看下gtsummary包是怎么快速回归建模，输出数据的。</p><h2 data-tool="mdnice编辑器"><span></span><span>4. 自动输出单因素回归结果</span><span></span></h2><p data-tool="mdnice编辑器">可以使用tbl_uvregression()函数批量输出单因素回归分析的结果。</p><p data-tool="mdnice编辑器">这里注意下y参数对应的响应变量。</p><pre data-tool="mdnice编辑器"><code>mycolon %&gt;% <br>  select(status, Age, Sex, Obstruct, Differ) %&gt;% <br>  tbl_uvregression(method = glm,<br>                   y = status,<br>                   method.args = list(family = binomial),<br>                   exponentiate = <span>TRUE</span>,<br>                   pvalue_fun = ~style_pvalue(.x, digits = <span>2</span>)<br>  )<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.756797583081571" data-src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNt4YnCtjLbLUFNibPbvAUvQWu188EExJVkMqJXLq46tjVsBeTHfbsJ75A/640?wx_fmt=png" data-type="png" data-w="662" src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNt4YnCtjLbLUFNibPbvAUvQWu188EExJVkMqJXLq46tjVsBeTHfbsJ75A/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span><span>5. 自动输出多因素逻辑回归模型结果</span><span></span></h2><p data-tool="mdnice编辑器">使用glm()函数构建逻辑回归模型，可以使用summary() 函数输出模型的摘要信息。</p><pre data-tool="mdnice编辑器"><code>fit &lt;- glm(status ~ Age + Sex + Obstruct + Differ,<br>           data=mycolon,<br>           family=<span>"binomial"</span>)<br>summary(fit)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7482517482517482" data-src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNttCp539eJ1icC3vvpCN7U8NaygBSguMkCnjzM9junzYfFpNZic5AuUM1A/640?wx_fmt=png" data-type="png" data-w="715" src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNttCp539eJ1icC3vvpCN7U8NaygBSguMkCnjzM9junzYfFpNZic5AuUM1A/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">可以使用tbl_regression()函数自动输出整洁的回归模型结果。</p><p data-tool="mdnice编辑器">将模型对象fit放在函数中即可，exponentiate是指对系数取幂。</p><pre data-tool="mdnice编辑器"><code>tbl_regression(fit, exponentiate = <span>TRUE</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5924657534246576" data-src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtz8hyz0AQoojrzYGFkgibYSOLJvXmeW3FEAQA8b0AFiaiaibXRGTtEOicQMA/640?wx_fmt=png" data-type="png" data-w="876" src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtz8hyz0AQoojrzYGFkgibYSOLJvXmeW3FEAQA8b0AFiaiaibXRGTtEOicQMA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">如上所示，即输出了模型的OR值、95%置信区间、P值。</p><h2 data-tool="mdnice编辑器"><span></span><span>6. 自动输出Cox回归模型结果</span><span></span></h2><p data-tool="mdnice编辑器">单因素的Cox回归模型参考逻辑回归模型即可，或者参阅帮助文档示例。</p><p data-tool="mdnice编辑器">可以使用coxph() 函数构建多因素Cox回归模型。</p><pre data-tool="mdnice编辑器"><code>fit &lt;- coxph(Surv(time,status) ~ Age + Sex + Obstruct + Differ,<br>             data=mycolon)<br>tbl_regression(fit, exponentiate = <span>TRUE</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6304347826086957" data-src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtEaNYLKpzWPHHgg5DbCDtgF2NruY6WPUOY8EBFzr5JOdLnZyIkJxic4g/640?wx_fmt=png" data-type="png" data-w="828" src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtEaNYLKpzWPHHgg5DbCDtgF2NruY6WPUOY8EBFzr5JOdLnZyIkJxic4g/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span></span><span>7. 修改模型输出结果</span><span></span></h2><p data-tool="mdnice编辑器">同样，tbl_regression()支持调整参数修改模型的结果输出。</p><p data-tool="mdnice编辑器">比如说修改变量名称。</p><pre data-tool="mdnice编辑器"><code>tbl_regression(fit, <br>               label = list(Age ~ <span>"Patient Age"</span>), <br>               exponentiate = <span>TRUE</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7378497790868925" data-src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNthKG3eBm0Fz7NIrd8XSwZ3Lic2goQnIEjSRb3ibnOt5oiaPicdSx5sDx63Q/640?wx_fmt=png" data-type="png" data-w="679" src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNthKG3eBm0Fz7NIrd8XSwZ3Lic2goQnIEjSRb3ibnOt5oiaPicdSx5sDx63Q/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">有些变量是二分类变量，模型中结果输出行数是两行，可以使用show_single_row参数指定单行输出，比如说性别Sex。</p><pre data-tool="mdnice编辑器"><code>tbl_regression(fit, <br>               label = list(Age ~ <span>"Patient Age"</span>), <br>               show_single_row = <span>"Sex"</span>,<br>               exponentiate = TRUE)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6029609690444145" data-src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtZU7UGBc8GYIGp91gyY5CelPDFvUV7WiafIv3ueNVpibDW0CEUrZbVdGg/640?wx_fmt=png" data-type="png" data-w="743" src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtZU7UGBc8GYIGp91gyY5CelPDFvUV7WiafIv3ueNVpibDW0CEUrZbVdGg/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">另外也可以指定输出P值的小数位数。</p><pre data-tool="mdnice编辑器"><code>tbl_regression(fit, <br>               label = list(Age ~ <span>"Patient Age"</span>), <br>               show_single_row = <span>"Sex"</span>,<br>               pvalue_fun = <span>function</span>(x) style_pvalue(x, digits = <span>2</span>),<br>               exponentiate = <span>TRUE</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6517341040462428" data-src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtskDL5EegCibNhz1sDgaGf3sicFWrDZsCE9szU3zmTVD5j8OYsxFricITw/640?wx_fmt=png" data-type="png" data-w="692" src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtskDL5EegCibNhz1sDgaGf3sicFWrDZsCE9szU3zmTVD5j8OYsxFricITw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">同样，对于分类变量，使用add_global_p()函数可以计算出总P值。</p><pre data-tool="mdnice编辑器"><code>tbl_regression(fit, <br>               label = list(Age ~ <span>"Patient Age"</span>), <br>               show_single_row = <span>"Sex"</span>,<br>               pvalue_fun = <span>function</span>(x) style_pvalue(x, digits = 2),<br>               exponentiate = TRUE) %&gt;% <br>  add_global_p()<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6154929577464788" data-src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtOpH3blkeicTCxHEqzqEdBuB4L3hKnDB5RJ5l7Ng44MAn4qsz6yCBqzw/640?wx_fmt=png" data-type="png" data-w="710" src="https://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib15zaZmBlcpp38jWksOFuNtOpH3blkeicTCxHEqzqEdBuB4L3hKnDB5RJ5l7Ng44MAn4qsz6yCBqzw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">这些是比较常用的参数调整，其他详细的参数调整可以参看官方的帮助文档。</p><p data-tool="mdnice编辑器"><strong>参考资料</strong></p><ol data-tool="mdnice编辑器"><li><section>tbl_summary()函数帮助文件</section></li></ol><hr data-tool="mdnice编辑器"></section><section><span><span>关注下方公众号，分享更多更好玩的R语言知识</span>。</span></section><p><span>公众号运营至今，已组建了3个方向的交流群：</span><span>统计绘图群、</span><span>临床公共数据挖掘群(包括MIMIC/NHANES/UKB)</span><span>、生信交流群</span><span>等，如果需要进群，请在公众号菜单栏处添加作者微信，邀请入群，请记得</span><span>附上备注</span><span>，谢谢</span><span>。</span></p><section><mp-common-profile data-pluginname="mpprofile" data-id="MzU4OTc0OTg2MA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/ibNJyXnh77ib2elLq04QpbFktmh35RDo2Zt13ZY6UvJxnMBL1vadlImFIbGiaJTPkjWgfqQ6mM1U7L8wdBPo11ANA/0?wx_fmt=png" data-nickname="R语言统计与绘图" data-alias="csuduanxm" data-signature="记录R语言的学习轨迹，分享R语言统计与绘图知识！" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><p><span>点个</span><span>在看</span><span>，SCI马上发表。</span></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Z_k9MFkg5areVWCluDR_BQ",target="_blank" rel="noopener noreferrer">原文链接</a>
