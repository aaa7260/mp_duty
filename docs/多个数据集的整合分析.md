---
title: "多个数据集的整合分析"
date: 2022-12-27T09:27:24Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
多个数据集的整合分析 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>今天是平平无奇的整合分析，是数据挖掘中经常用到的一部分~</p></blockquote><p data-tool="mdnice编辑器">参考文献在这里⬇</p><blockquote data-tool="mdnice编辑器"><ul><li><section><p>A robust 6-mRNA signature for prognosis prediction of pancreatic ductal adenocarcinoma</p></section></li><li><section><p>DOI: 10.7150/ijbs.32899</p></section></li></ul></blockquote><p data-tool="mdnice编辑器">文章的故事是从这句话开始的：prognostic gene signature by generating the differentially expressed mRNAs with <strong>P-value less than 0.001 and fold-change values of −2 to 2</strong> between tumor and non-tumor samples in <strong>GSE15471, GSE28735, and GSE62452</strong>  datasets.</p><p data-tool="mdnice编辑器">After downloading and normalizing the <strong>raw data CEL files</strong> from GEO and ArrayExpress by a  robust multiarray averaging <strong>(RMA) method</strong>, we used the ‘Affy’ and ‘affycoretools’ packages of R software.DEGs were defined with P&lt; 0.001 and |log2 fold change|&gt; 1 as the cut-off criteria：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.8890449438202247" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9Uv3mnuDlcFhlcKicrjn9h258iac1JJYNGf5aq3JpUNuHIKjPvWzp90iafkEPsbLDEiaPYxdb1E9fkcQ/640?wx_fmt=png" data-type="png" data-w="712" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9Uv3mnuDlcFhlcKicrjn9h258iac1JJYNGf5aq3JpUNuHIKjPvWzp90iafkEPsbLDEiaPYxdb1E9fkcQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">作者是直接下载cel格式的原始数据，然后用RMA函数获取表达矩阵，分别对三个数据集进行了差异分析，然后对差异分析取交集作了后续的分析。</p><p data-tool="mdnice编辑器">我们也试试看吧——</p><pre data-tool="mdnice编辑器"><code><span># GSE15471, GSE28735 and GSE62452</span><br>rm(list = ls()) <br><br><span>##全局设置</span><br><span>##下载的数据大小&gt;131072字节，所以需要调整默认连接缓存，以便正常下载</span><br>Sys.setenv(<span>"VROOM_CONNECTION_SIZE"</span>=<span>99999999</span>)<br>options(stringsAsFactors = <span>F</span>)<br>options(timeout = <span>999999999</span>)<br><br><span>library</span>(affy)<br><span>library</span>(GEOquery)<br><span>library</span>(oligo)<br><br>getwd()<br><br><span>if</span> (<span>F</span>) {<br><span># 1.数据解压到新建的文件夹中 ----------------------------------------------------------</span><br><span># dir.create("../GSE15471")##创建新的文件夹</span><br>samPath &lt;- <span>"../GSE15471"</span><br>untar(<span>"../Rawdata/GSE15471_RAW.tar"</span>, exdir = samPath)<span>##解压原始文件到sampath文件夹中</span><br>setwd(samPath)<br>list.files()<span>##显示文件夹中的文件，及原始文件顺序</span><br><br><span># 2.匹配临床信息，读取cel文件 ---------------------------------------------------------------</span><br>gse &lt;- <span>"GSE15471"</span><br>gset &lt;- getGEO(gse)<br><br><span>###匹配临床信息</span><br>celFiles &lt;- list.celfiles(samPath) <span>##listGzipped参数：Logical. List .CEL.gz files? </span><br>celFiles<br>dat &lt;- read.celfiles(filenames = celFiles, phenoData = phenoData(gset[[<span>1</span>]]), <br>                     sampleNames = rownames(pData(gset[[<span>1</span>]])))<br>class(dat)  <span>##这样一来，表型等信息的数据就在这个dat对象中了</span><br><br>eset=rma(dat)<br>class(eset)<br>exprSet=exprs(eset)<br>exprSet[<span>1</span>:<span>10</span>,<span>1</span>:<span>10</span>]<br><br>dim(exprSet)<br>range(exprSet)<br><br><br><span># 3.获取分组信息 ----------------------------------------------------------------</span><br><span>library</span>(GEOquery)<br>pd &lt;- pData(dat)<br>table(pd$characteristics_ch1.1)<br>group_list &lt;- ifelse(grepl(<span>"normal"</span>,pd$characteristics_ch1.1),<span>"normal"</span>,<span>"tumor"</span>)<br>table(group_list)<br><br><span>##判断一下样本名是否与表达矩阵的列名一一对应</span><br><span>if</span>(!identical(rownames(pd),colnames(exprSet))) exprSet = exprSet[,match(rownames(pd),colnames(exprSet))] <br><br>setwd(<span>"../Main/"</span>)<br>getwd()<br>save(exprSet,group_list,gse,file = paste0(gse,<span>"step1_output.Rdata"</span>))<br>}<br></code></pre><p data-tool="mdnice编辑器">这样我们就获得了表达矩阵和分组信息，接下来就是常规的探针注释和差异分析了。</p><pre data-tool="mdnice编辑器"><code><span>##因为注释平台不一样，所以annotation这一步要单独做一下，然后就可以直接用source函数解决了</span><br>gselist &lt;- c(<span>"GSE15471"</span>, <span>"GSE28735"</span>,<span>"GSE62452"</span>)<br><span>for</span> (i <span>in</span> gselist) {<br>  gse &lt;- gselist[<span>3</span>] <span>##改一下这里的数字</span><br>  <span>source</span>(<span>"step2_check.R"</span>)<br>  <span>source</span>(<span>"step4_DEG.R"</span>)<br>  <span>source</span>(<span>"step5_degVisualise.R"</span>)<br>}<br></code></pre><p data-tool="mdnice编辑器">完事了呢，我们来比较一下我们的差异分析和文章的差异分析结果：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.4251606978879706" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9Uv3mnuDlcFhlcKicrjn9h2GKrSyRibNvziaDH6KuZhibZREKib49xXHt11powiaWHLZSffr6riaricdaCqQ/640?wx_fmt=png" data-type="png" data-w="1089" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9Uv3mnuDlcFhlcKicrjn9h2GKrSyRibNvziaDH6KuZhibZREKib49xXHt11powiaWHLZSffr6riaricdaCqQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">155 VS 153，数量差不多~</p><p data-tool="mdnice编辑器">其实还有另外一种方法，就是RRA。之前的推文也介绍过这种算法，相较于简单的取交集，RRA会根据logFC值对交集基因再排个序：</p><pre data-tool="mdnice编辑器"><code>rm(list = ls())<br><br><span>library</span>(RobustRankAggreg)<br><span>library</span>(clusterProfiler)<br><span>library</span>(ggplotify)<br><br><span>##差异基因门槛：</span><br>logFC_t=<span>1</span><br>P.Value_t = <span>0.001</span><br><br><span># gselist &lt;- c("GSE15471", "GSE28735","GSE62452")</span><br>load(<span>"GSE15471_deg.Rdata"</span>)<br>GSE15471_deg &lt;- deg<br>load( <span>"GSE28735_deg.Rdata"</span>)<br>GSE28735_deg &lt;- deg<br>load(<span>"GSE62452_deg.Rdata"</span>)<br>GSE62452_deg &lt;- deg<br><br><span>###上调基因-------------</span><br>get_up &lt;- <span>function</span>(df){<br>    result=df[df$logFC&gt;(logFC_t) &amp; df$P.Value&lt;P.Value_t,]<br>    result=result[order(result$logFC,decreasing = <span>T</span>),]<br>    rownames(result)<br>}<br>glist=list(get_up(GSE15471_deg),<br>           get_up(GSE28735_deg),<br>           get_up(GSE62452_deg))<br><br>ups=aggregateRanks(glist = glist, N = length(unique(unlist(glist))))<br>tmp=as.data.frame(table(unlist(glist)))<br>ups$Freq=tmp[match(ups$Name,tmp[,<span>1</span>]),<span>2</span>]<br>head(ups)<br><br><span>##画热图</span><br>gs=ups[ups$Score &lt; <span>0.05</span>,<span>1</span>] <span>##抽到的次数越多，score越小</span><br>gs<br>updat=data.frame(GSE15471=GSE15471_deg[gs,<span>'logFC'</span>],<br>                 GSE28735=GSE28735_deg[gs,<span>'logFC'</span>],<br>                 GSE62452=GSE62452_deg[gs,<span>'logFC'</span>]<br>                 )<br><br>rownames(updat)=gs<br><span>library</span>(pheatmap)<br>head(updat)<br>updat1 &lt;- updat[<span>1</span>:<span>30</span>,]  <span>##太多了，取部分基因看看</span><br>pheatmap(updat,display_numbers=<span>F</span>)<br><br><span>###下调基因-----------</span><br>get_down &lt;- <span>function</span>(df){<br>  result=df[df$logFC&lt;(-logFC_t) &amp; df$P.Value&lt;P.Value_t,]<br>  result=result[order(result$logFC,decreasing = <span>F</span>),]<br>  rownames(result)<br>}<br>glist1=list(get_down(GSE15471_deg),<br>           get_down(GSE28735_deg),<br>           get_down(GSE62452_deg))<br><br>downs=aggregateRanks(glist = glist1, N = length(unique(unlist(glist1))))<br>tmp=as.data.frame(table(unlist(glist1)))<br>downs$Freq=tmp[match(downs$Name,tmp[,<span>1</span>]),<span>2</span>]<br>head(downs)<br>gs1=downs[downs$Score &lt; <span>0.05</span>,<span>1</span>] <span>##抽到的次数越多，score越小</span><br>gs1<br><br>downdat=data.frame(GSE15471=GSE15471_deg[gs1,<span>'logFC'</span>],<br>                   GSE28735=GSE28735_deg[gs1,<span>'logFC'</span>],<br>                   GSE62452=GSE62452_deg[gs1,<span>'logFC'</span>]<br>)<br>rownames(downdat)=gs1<br><span>library</span>(pheatmap)<br>head(downdat)<br>pheatmap(downdat,display_numbers=<span>F</span>)<br><br><br><span>####上下调基因一起画------------</span><br>union_RRA &lt;- rbind(updat1,downdat)<br><span>library</span>(ComplexHeatmap)<br><span>library</span>(circlize)<br>col_fun &lt;- colorRamp2(<br>  c(-<span>2</span>, <span>0</span>, <span>2</span>), <br>  c(<span>"green"</span>, <span>"white"</span>, <span>"red"</span>)<br>)<br>p &lt;- Heatmap(<br>  as.matrix(union_RRA), <br>  name = <span>"expression"</span>, <br>  border = <span>"black"</span>,<br>  col = col_fun,<br>  row_names_gp = gpar(fontsize=<span>4</span>),<br>  rect_gp = gpar(col = <span>"white"</span>, lwd = <span>2</span>)<br>);p<br>p1 &lt;- as.ggplot(p)<br>ggsave(<span>"../outputs/RRA_heatmap.png"</span>, egg::set_panel_size(p1, width=unit(<span>4.5</span>, <span>"in"</span>), height=unit(<span>5</span>, <span>"in"</span>)), <br>       width = <span>8</span>, height = <span>7</span>, units = <span>'in'</span>, dpi = <span>300</span>)<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.1118012422360248" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9Uv3mnuDlcFhlcKicrjn9h2wS5bxa1EerLAaAdEkbLPAqEiaZJNOv8l70MiaMZmejJW0RWDb1awlfkg/640?wx_fmt=png" data-type="png" data-w="805" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9Uv3mnuDlcFhlcKicrjn9h2wS5bxa1EerLAaAdEkbLPAqEiaZJNOv8l70MiaMZmejJW0RWDb1awlfkg/640?wx_fmt=png"></figure></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/bauw5qssAiqCoB7Y9mY8wg",target="_blank" rel="noopener noreferrer">原文链接</a>
