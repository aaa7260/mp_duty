---
title: "代码分享：GSEA 富集气泡图可视化的"
date: 2024-04-08T22:59:03Z
draft: ["false"]
tags: [
  "fetched",
  "生信碱移"
]
categories: ["Acdemic"]
---
代码分享：GSEA 富集气泡图可视化的 by 生信碱移
------
<div><section data-tool="markdown编辑器" data-website="https://markdown.com.cn/editor"><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><img data-imgfileid="100008221" data-ratio="1.0324675324675325" data-src="https://mmbiz.qpic.cn/mmbiz_gif/lN9Tp5oiaqHFn9Rg6MwMU3ukMR9ROPh7bf7QWHEMwhUBUwSUKFsV8oK9noHic3jLaeJVQewHJcLq1cTXVAat35Tw/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-type="gif" data-w="154" src="https://mmbiz.qpic.cn/mmbiz_gif/lN9Tp5oiaqHFn9Rg6MwMU3ukMR9ROPh7bf7QWHEMwhUBUwSUKFsV8oK9noHic3jLaeJVQewHJcLq1cTXVAat35Tw/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section></section></section></section></section><section><section powered-by="xiumi.us"><section><p>老铁快点击蓝字 <strong>关注俺</strong></p></section></section></section><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><img data-imgfileid="100008220" data-ratio="1.0324675324675325" data-src="https://mmbiz.qpic.cn/mmbiz_gif/lN9Tp5oiaqHFn9Rg6MwMU3ukMR9ROPh7bf7QWHEMwhUBUwSUKFsV8oK9noHic3jLaeJVQewHJcLq1cTXVAat35Tw/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" data-type="gif" data-w="154" src="https://mmbiz.qpic.cn/mmbiz_gif/lN9Tp5oiaqHFn9Rg6MwMU3ukMR9ROPh7bf7QWHEMwhUBUwSUKFsV8oK9noHic3jLaeJVQewHJcLq1cTXVAat35Tw/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section></section><p><br></p><section><br></section><p><br></p></section></section></section></section></section></section></section><section>代码如下（详情见注释）：<br></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span><span># 代码来源：https://bioinformaticsbreakdown.com/how-to-gsea/</span></span></code><code><span><span># 1.定义函数</span></span></code><code><span><span>GSEA</span> = function(gene_list, GO_file, pval) {</span></code><code><span>  <span>set</span>.seed(54321)</span></code><code><span>  <span>library</span>(dplyr)</span></code><code><span>  <span>library</span>(fgsea)</span></code><code><span><br></span></code><code><span>  <span>if</span> ( any( duplicated(names(gene_list)) )  ) {</span></code><code><span>    <span>warning</span>(<span>"Duplicates in gene names"</span>)</span></code><code><span>    <span>gene_list</span> = gene_list[!duplicated(names(gene_list))]</span></code><code><span>  }</span></code><code><span>  <span>if</span>  ( !<span>all</span>( order(gene_list, decreasing = TRUE) == 1:length(gene_list)) ){</span></code><code><span>    <span>warning</span>(<span>"Gene list not sorted"</span>)</span></code><code><span>    <span>gene_list</span> = sort(gene_list, decreasing = TRUE)</span></code><code><span>  }</span></code><code><span>  <span>myGO</span> = fgsea::gmtPathways(GO_file)</span></code><code><span><br></span></code><code><span>  <span>fgRes</span> &lt;- fgsea::fgsea(pathways = myGO,</span></code><code><span>                           <span>stats</span> = gene_list,</span></code><code><span>                           <span>minSize</span>=15, ## minimum gene set size</span></code><code><span>                           <span>maxSize</span>=400, ## maximum gene set size</span></code><code><span>                           <span>nperm</span>=10000) %&gt;% </span></code><code><span>                  <span>as</span>.data.frame() %&gt;% </span></code><code><span>                  <span>dplyr</span>::filter(padj &lt; !!pval) %&gt;% </span></code><code><span>                  <span>arrange</span>(desc(NES))</span></code><code><span>  <span>message</span>(paste(<span>"Number of signficant gene sets ="</span>, nrow(fgRes)))</span></code><code><span><br></span></code><code><span>  <span>message</span>(<span>"Collapsing Pathways -----"</span>)</span></code><code><span>  <span>concise_pathways</span> = collapsePathways(data.table::as.data.table(fgRes),</span></code><code><span>                                      <span>pathways</span> = myGO,</span></code><code><span>                                      <span>stats</span> = gene_list)</span></code><code><span>  <span>fgRes</span> = fgRes[fgRes$pathway %in% concise_pathways$mainPathways, ]</span></code><code><span>  <span>message</span>(paste(<span>"Number of gene sets after collapsing ="</span>, nrow(fgRes)))</span></code><code><span><br></span></code><code><span>  <span>fgRes</span>$Enrichment = ifelse(fgRes$NES &gt; 0, <span>"Up-regulated"</span>, <span>"Down-regulated"</span>)</span></code><code><span>  <span>filtRes</span> = rbind(head(fgRes, n = 10),</span></code><code><span>                  <span>tail</span>(fgRes, n = 10 ))</span></code><code><span><br></span></code><code><span>  <span>total_up</span> = sum(fgRes$Enrichment == <span>"Up-regulated"</span>)</span></code><code><span>  <span>total_down</span> = sum(fgRes$Enrichment == <span>"Down-regulated"</span>)</span></code><code><span>  <span><span>header</span></span> = paste0(<span>"Top 10 (Total pathways: Up="</span>, total_up,<span>", Down="</span>,    total_down, <span>")"</span>)</span></code><code><span><br></span></code><code><span>  <span>colos</span> = setNames(c(<span>"firebrick2"</span>, <span>"dodgerblue2"</span>),</span></code><code><span>                 <span>c</span>(<span>"Up-regulated"</span>, <span>"Down-regulated"</span>))</span></code><code><span><br></span></code><code><span><span>g1</span>= ggplot(filtRes, aes(reorder(pathway, NES), NES)) +</span></code><code><span>  <span>geom_point</span>( aes(fill = Enrichment, size = size), shape=21) +</span></code><code><span>  <span>scale_fill_manual</span>(values = colos ) +</span></code><code><span>  <span>scale_size_continuous</span>(range = c(2,10)) +</span></code><code><span>  <span>geom_hline</span>(yintercept = 0) +</span></code><code><span>  <span>coord_flip</span>() +</span></code><code><span>  <span>labs</span>(x=<span>"Pathway"</span>, y=<span>"Normalized Enrichment Score"</span>,</span></code><code><span>       <span>title</span>=header) + </span></code><code><span>        <span>th</span></span></code><code><span><br></span></code><code><span>  <span>output</span> = list(<span>"Results"</span> = fgRes, <span>"Plot"</span> = g1)</span></code><code><span>  <span>return</span>(output)</span></code><code><span>}</span></code><code><span><br></span></code><code><span><span># 2.输入差异基因排序列表</span></span></code><code><span><span>library</span>(dplyr)</span></code><code><span><br></span></code><code><span><span>S4table</span> = read.csv(<span>"./Data/journal.pone.0145322.s007.csv"</span>, header=TRUE, skip =1) %&gt;%</span></code><code><span>  <span>filter</span>(Gene.Symbol != <span>""</span>)</span></code><code><span><span>gene_list</span> = S4table$DESeq2.Log2.Fold.Change</span></code><code><span><span>names</span>(gene_list) = S4table$Gene.Symbol</span></code><code><span><span>gene_list</span> = sort(gene_list, decreasing = TRUE)</span></code><code><span><span>gene_list</span> = gene_list[!duplicated(names(gene_list))]</span></code><code><span><span>head</span>(gene_list)</span></code><code><span><span>##  SLC45A2     ZIC5   COL2A1     ZIC2   NKX2-3     PAX1 </span></span></code><code><span><span>## 4.713566 4.615739 4.529353 4.256526 4.101743 3.876818</span></span></code><code><span><br></span></code><code><span><span># 3.执行GSEA富集并可视化</span></span></code><code><span><span>GO_file</span> = <span>"./Gene_sets/c5.bp.v7.0.symbols.gmt"</span></span></code><code><span><br></span></code><code><span><span>res</span> = GSEA(gene_list, GO_file, pval = 0.05)</span></code><code><span><span>dim</span>(res$Results)</span></code><code><span><span>res</span>$Plot      # 可视化</span></code></pre></section><p><strong><span><strong><span><strong><span><span><img data-imgfileid="100008819" data-ratio="0.7777777777777778" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeXJEOsSMbAOEGeR3bXuHmD0uBqPP3IBO1drC6el6YAJ6OIepIYGaatPJd8tYDjmUOBvHibSG5b6g5g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="648" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeXJEOsSMbAOEGeR3bXuHmD0uBqPP3IBO1drC6el6YAJ6OIepIYGaatPJd8tYDjmUOBvHibSG5b6g5g/640?wx_fmt=png&amp;from=appmsg"></span></span></strong></span></strong></span></strong><br></p><p><strong><span><strong><span><strong><span><span><br></span></span></strong></span></strong></span></strong></p><section><span><strong><span><strong><span><strong><span><span>就分享到这里了</span><span> </span></span></strong></span></strong></span></strong></span><strong><span><strong><span><strong><span><img data-ratio="1" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Yellowdog.png" data-w="128" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Yellowdog.png"></span></strong></span></strong></span></strong></section><section><strong></strong></section><section><mp-common-profile data-id="MzkyNTIzMzYyMA==" data-pluginname="mpprofile" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/LvUIqvYKCeXYZNMxRMnjiaicO2a27jDZ2FgQga8TdeQcsGRJRIn2IInkKtfcbbMXOBSViaPXpTOBulUlNzd11pzow/0?wx_fmt=png" data-nickname="生信碱移" data-alias="liudoufu307" data-signature="春来秋至，分享我的所见与所识" data-from="2" data-weuitheme="light"></mp-common-profile></section><section><br></section><section><span><strong><span>END</span></strong><strong><span>~</span></strong></span><br></section><p><span><strong>仅供粉丝老铁们参考</strong></span></p><p><span><strong>如有侵权或</strong><strong>错误</strong><strong>，请联系删除改正～</strong></span></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/_9PapLclDES4s3Iywfh8uQ",target="_blank" rel="noopener noreferrer">原文链接</a>
