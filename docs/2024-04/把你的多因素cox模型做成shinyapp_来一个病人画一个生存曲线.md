---
title: "把你的多因素cox模型做成shinyapp，来一个病人画一个生存曲线"
date: 2024-04-26T12:19:00Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
把你的多因素cox模型做成shinyapp，来一个病人画一个生存曲线 by 生信星球
------
<div><section data-mpa-powered-by="yiban.io"><br></section><section><span>‍</span></section><section><img data-imgfileid="100010876" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-imgfileid="100010877" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第947天</strong></span></span><img data-imgfileid="100010875" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><section><span><span>   </span><span>大神一句话，菜鸟跑半年。我不是大神，但我可以缩短你走弯路的半年~</span></span></section><section><span>   就像歌儿唱的那样，如果你不知道该往哪儿走，就留在这学点生信好不好~</span></section><p><span>   这里有豆豆和花花的学习历程，从新手到进阶，生信路上有你有我！</span></p><section><h4><span><span> </span>0.背景知识</span></h4><p>在预后分析中，构建了多因素cox模型后可以选择森林图或者是诺谟图进行可视化。</p><p>之前看诺谟图，如果有一个新的病人信息，可以从诺谟图上面自行比划看该新病人的1、3、5年生存率。</p><p>这样画起来多少有点麻烦，最近埋头苦读的我发现一个人的生存率也可以做成生存曲线。</p><h4><span><span> </span>1.编造示例数据和构建模型</span></h4><pre><code>rm(list = ls())<br>library(rms)<br>library(prodlim)<br>library(survival)<br>set.seed(<span>13</span>)<br>ph &lt;- SimSurv(<span>100</span>)<br><span>head</span>(ph)<br><br><span>##   eventtime  censtime     time event X1         X2 status</span><br><span>## 1  3.068009 24.716896 3.068009     1  0  0.5543269      1</span><br><span>## 2  9.666322 17.105853 9.666322     1  1 -0.2802719      1</span><br><span>## 3  1.200405  2.101732 1.200405     1  1  1.7751634      1</span><br><span>## 4  2.749020  5.286182 2.749020     1  1  0.1873201      1</span><br><span>## 5  5.974245 14.870069 5.974245     1  0  1.1425261      1</span><br><span>## 6  1.853016  7.541804 1.853016     1  1  0.4155261      1</span><br><br><span>mod</span> &lt;- cph(Surv(ph$<span>time</span>, ph$<span>event</span>) ~ X1 + X2, <span>data</span>=ph, x=<span>TRUE</span>, y=<span>TRUE</span>, surv=<span>TRUE</span>)<br></code></pre><p>ph里面的X1和X2就是编造的临床信息</p><h4><span><span> </span>2.新来一个病人的话</span></h4><p>假如他的临床信息是 X1 = 0,X2 = 1</p><pre><code>new_dat <span>&lt;<span>-</span> <span>data.frame</span>(<span>X1</span> = <span>0,X2</span> = <span>1)</span><br></span></code></pre><p>画他的生存曲线</p><pre><code>g = survfit(mod,new = new_dat)<br>dat = data.frame(time = g<span>$time</span>,surv = g<span>$surv</span>)<br>plot(dat<span>$time</span>, dat<span>$surv</span>, <span>type</span> = <span>"s"</span>)<br></code></pre><figure><img data-imgfileid="100010891" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqUcMPO7GRWNZibSSuyV1zEAdEQAAibqcl5iaJrfgcE7SJdNAOGFU2gricV5Lu5TNDYHJ7jNIwicavOFEA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqUcMPO7GRWNZibSSuyV1zEAdEQAAibqcl5iaJrfgcE7SJdNAOGFU2gricV5Lu5TNDYHJ7jNIwicavOFEA/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><p>或者是ggplot2版本</p><pre><code>library(ggplot2)<br>ggplot(dat,aes(<span>time</span>,surv))+<br>  geom_line()+<br>  theme_bw()<br></code></pre><figure><img data-imgfileid="100010892" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqUcMPO7GRWNZibSSuyV1zEAWHe9dRtQ2ywb21rDy75lcWesNaolVJ7qOePCS1DzlstbPj0x5vpZsw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqUcMPO7GRWNZibSSuyV1zEAWHe9dRtQ2ywb21rDy75lcWesNaolVJ7qOePCS1DzlstbPj0x5vpZsw/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><h4><span><span> </span>3.更好玩的是可以做成shinyapp</span></h4><p>哈哈，看起来很厉害实际上就是唬唬人的东西，有人会用shiny来做很复杂很炫酷的网页工具，我们这个是个入门版本。</p><pre><code>rm(<span>list</span> = ls())<br>library(shiny)<br>library(rms)<br>library(prodlim)<br>library(survival)<br><span># 定义全局模拟数据和模型</span><br>simulate_data_and_model &lt;- <span><span>function</span><span>()</span> </span>{<br>  set.seed(<span>13</span>)<br>  ph &lt;- SimSurv(<span>100</span>)<br>  mod &lt;- cph(Surv(ph$time, ph$event) ~ X1 + X2, data=ph, x=<span>TRUE</span>, y=<span>TRUE</span>, surv=<span>TRUE</span>)<br>  <span>return</span>(<span>list</span>(ph = ph, mod = mod))<br>}<br><br><span># 调用一次模拟数据和模型，以便在Shiny中使用</span><br>data_and_model &lt;- reactive(simulate_data_and_model())<br><br>ui &lt;- fluidPage(<br>  titlePanel(<span>"病人生存曲线"</span>),<br>  sidebarLayout(<br>    sidebarPanel(<br>      numericInput(<span>"X1"</span>, <span>"X1 的值"</span>, <span>0</span>, min = <span>-10</span>, max = <span>10</span>, step = <span>.1</span>),<br>      numericInput(<span>"X2"</span>, <span>"X2 的值"</span>, <span>1</span>, min = <span>-10</span>, max = <span>10</span>, step = <span>.1</span>),<br>      actionButton(<span>"plotButton"</span>, <span>"绘制生存曲线"</span>)<br>    ),<br>    mainPanel(<br>      plotOutput(<span>"survivalPlot"</span>)<br>    )<br>  )<br>)<br><br>server &lt;- <span><span>function</span><span>(input, output)</span> </span>{<br><br>  observeEvent(input$plotButton, {<br><br>    new_dat &lt;- data.frame(<br>      X1 = input$X1,<br>      X2 = input$X2<br>    )<br><br>    g &lt;- survfit(data_and_model()$mod, <span>new</span> = new_dat)<br>    dat = data.frame(time = g$time,surv = g$surv)<br>    library(ggplot2)<br>    ggplot(dat,aes(time,surv))+<br>      geom_line()+<br>      theme_bw()<br><br>    output$survivalPlot &lt;- renderPlot({<br>      ggplot(dat,aes(time,surv))+<br>        geom_line()+<br>        theme_bw()<br>    })<br>  })<br>}<br><br>shinyApp(ui, server)<br></code></pre><p>然后就有一个酷酷的弹窗可以画图啦<br></p><figure><img data-imgfileid="100010893" data-ratio="0.5314814814814814" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqUcMPO7GRWNZibSSuyV1zEAb3xG5y0iaT2DP2E5EfibCrh7ic2h7QfmwEWsWvOfcUicYe0eIbVibje8V2Q/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqUcMPO7GRWNZibSSuyV1zEAb3xG5y0iaT2DP2E5EfibCrh7ic2h7QfmwEWsWvOfcUicYe0eIbVibje8V2Q/640?wx_fmt=other&amp;from=appmsg"></figure></section><section><section><section><figure><figcaption></figcaption></figure></section><figure><figcaption></figcaption></figure></section><figure><span></span><span></span></figure></section><section><figure><section><figure><figcaption></figcaption></figure></section></figure></section><section><figure><figcaption></figcaption></figure></section><section><figure><figcaption></figcaption></figure></section><section><figure><figcaption></figcaption></figure></section><section><blockquote><section><span>如果因为代码看不懂，而跟不上正文的节奏，可以来找我，相当于来一个新手保护期。</span><span>我的课程都是循环开课。</span><span>下一期的时间，点进去咨询微信咯</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494223&amp;idx=1&amp;sn=956c0412cf4235ad73269a1c219cd90c&amp;chksm=fdfba20dca8c2b1b8cfafefb05d6fa736f2f126c8883086f8963e9aafeb2af39791e2e56e254&amp;scene=21#wechat_redirect" textvalue="生信分析‍直播课程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信分析直播课程</a></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494009&amp;idx=1&amp;sn=035d253f973f65c0d1069e515eec2ce8&amp;chksm=fdfba13bca8c282de5a9222a2ab8bc0caa2ddf60cab543c2181e6d4a90b553f4dcde5f154adf&amp;scene=21#wechat_redirect" textvalue="生信新手保护学习小组‍" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信新手保护学习小组</a><br></section></blockquote></section><section><section><br></section></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/VYgzzja0FG7TqJm2Has9hQ",target="_blank" rel="noopener noreferrer">原文链接</a>
