---
title: "TGCA数据的标准化以及差异分析"
date: 2024-04-15T01:17:30Z
draft: ["false"]
tags: [
  "fetched",
  "果子学生信"
]
categories: ["Acdemic"]
---
TGCA数据的标准化以及差异分析 by 果子学生信
------
<div><section><p>前面我们<a href="https://mp.weixin.qq.com/s?__biz=MzIyMzA2MTcwMg==&amp;mid=2650733268&amp;idx=1&amp;sn=d5f9118fd480e9669e90ca923efb8ec8&amp;chksm=f029a97dc75e206bc7aaa7768738c50e978a7fece6fc2fbf79d5b3dc7220213d650015defe4a&amp;token=1715549924&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">从GDC下载了TCGA肿瘤数据库的数据</a>,也能够<a href="https://mp.weixin.qq.com/s?__biz=MzIyMzA2MTcwMg==&amp;mid=2650733278&amp;idx=1&amp;sn=de8d057b5bd45d4128c125ab6a866465&amp;chksm=f029a977c75e20616e17fc5db9e80033a864f09350071bc8bf0ff32645b1ac43da61a90ccbb6&amp;token=1715549924&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">把GDC下载的多个TCGA文件批量读入R</a></p><p>今天我们讲一下TCGA数据的标准化，以及差异分析，得到了标准化后的数据，我们就可以按照以前的帖子，做一系列操作</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzIyMzA2MTcwMg==&amp;mid=2650732846&amp;idx=1&amp;sn=9590ba79306d5f15311f0261a2d9d5ca&amp;chksm=f029aa87c75e239111c37be952ecf7a795c6f040cb637065cdd0fa6633ff0891608b77e203e0&amp;mpshare=1&amp;scene=21&amp;srcid=0815NLLKPstfXvPfqRVzexJO#wechat_redirect" data-linktype="2">Y叔推荐的这个图有毒！</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzIyMzA2MTcwMg==&amp;mid=2650732849&amp;idx=1&amp;sn=9d25f04368a75a4e4f352731f49faa9d&amp;chksm=f029aa98c75e238e8a5f1f2872568c91691eb0c6faa642da630d82757b54334a2a639c462294&amp;mpshare=1&amp;scene=21&amp;srcid=0926vxRwVAkuGVaanZmMEEPY#wechat_redirect" data-linktype="2">图有毒系列之2</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzIyMzA2MTcwMg==&amp;mid=2650732936&amp;idx=1&amp;sn=5f88a5f98318c76edb289c580e8e1b5f&amp;chksm=f029aa21c75e23379c29d52a303ade65cc0e32959bf7a61f6a3e4813007b96f9d69c718183b2&amp;mpshare=1&amp;scene=21&amp;srcid=09263zJYMuYXNJG7XZcs5qcn#wechat_redirect" data-linktype="2">多个基因在多亚组疾病中的展示</a></p><p>在得到了差异分析的结果后，我们可以完成热图，火山图，GO分析，KEGG分析，GSEA分析，就跟这个帖子中的一样。<br><a href="https://mp.weixin.qq.com/s?__biz=MzIyMzA2MTcwMg==&amp;mid=2650733210&amp;idx=1&amp;sn=76f5609282d92ba24644729fede24897&amp;chksm=f029a933c75e2025bc8c54a1ad046c3d5f837849d8f68969aa66bbbe58e194e3df0ed981f5d9&amp;token=1715549924&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">来完成你的生信作业，这是最有诚意的GEO数据库教程</a></p><p>下面开始今天的教程：<br>首先加载上一次课获得的数据；</p><pre><code><span>### 加载数据</span><br><span>load</span>(<span>"expr_df.Rdata"</span>)<br></code></pre><p>现在的数据是这个样子的<br></p><figure><img data-ratio="0.8608534322820037" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVuQc9sByJVib4rhLtQ6KwS3F656fwonByEpd4kqQFZmRib0u8Rj1VRnZw/640?wx_fmt=png" data-type="png" data-w="539" title="处理前" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVuQc9sByJVib4rhLtQ6KwS3F656fwonByEpd4kqQFZmRib0u8Rj1VRnZw/640?wx_fmt=png"><figcaption>处理前</figcaption></figure><p>去掉ensemble ID的点号</p><pre><code>library(tidyr)<br>expr_df_nopoint &lt;- expr_df %&gt;% <br>  tidyr::separate(gene_id,into = c(<span>"gene_id"</span>),sep=<span>"\\."</span>) <br></code></pre><p>现在的数据是这个样子的<br></p><figure><img data-ratio="0.666214382632293" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVZWh3y5rvbaPdLFib7ibFVibkPlW7iaBb6XfORA1KIH1CZqqzicnJzzTywJA/640?wx_fmt=png" data-type="png" data-w="737" title="处理后" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVZWh3y5rvbaPdLFib7ibFVibkPlW7iaBb6XfORA1KIH1CZqqzicnJzzTywJA/640?wx_fmt=png"><figcaption>处理后</figcaption></figure><p>去掉点号，是为了用gtf文件。<br>gtf文件的获取和作用在这里<br><a href="https://mp.weixin.qq.com/s?__biz=MzIyMzA2MTcwMg==&amp;mid=2650733146&amp;idx=1&amp;sn=8d566d43f439f66dbf367678d2ff1fdc&amp;chksm=f029a9f3c75e20e5ac9c6ed02ecb5b98bd482195db4b29f968cc49fe98a4019a297f376dbb7d&amp;token=1715549924&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">GTF文件有什么用啊？别的不谈，最起码能提lncRNA</a></p><p>加载gtf文件,这是目前我们能接触的最大文件，有260万行。</p><pre><code><span>load</span>(<span>file</span> = <span>"gtf_df.Rda"</span>)<br></code></pre><h3><span>提取mRNA</span></h3><pre><code>mRNA_exprSet &lt;- gtf_df %&gt;% <br>  dplyr::filter(type==<span>"gene"</span>,gene_biotype==<span>"protein_coding"</span>) %&gt;% <span>#筛选gene,和编码指标</span><br>  dplyr::select(c(gene_name,gene_id,gene_biotype)) %&gt;% <br>  dplyr::inner_join(expr_df_nopoint,by =<span>"gene_id"</span>) %&gt;% <br>  tidyr::unite(gene_id,gene_name,gene_id,gene_biotype,sep = <span>" | "</span>)<br></code></pre><p>最终得到19668行，这是编码基因的个数，现在的数据是这个样子的<br></p><figure><img data-ratio="0.3981373690337602" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVVzW5jTN0afdU3tU8WlMH99ibdEU8k9leb6fiaK3mMSNZYnK5PibWmJEkA/640?wx_fmt=png" data-type="png" data-w="859" title="编码RNA" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVVzW5jTN0afdU3tU8WlMH99ibdEU8k9leb6fiaK3mMSNZYnK5PibWmJEkA/640?wx_fmt=png"><figcaption>编码RNA</figcaption></figure><h3><span>提取lncRNA</span></h3><p>这里很有争议，而我的理由是，即使是编码基因，也会出现非编码转录本，而长链非编码RNA，指的是转录本，所以不能用gene的编码与否来界定</p><pre><code>ncRNA &lt;- c(<span>"sense_overlapping"</span>,<span>"lincRNA"</span>,<span>"3prime_overlapping_ncRNA"</span>,<br>           <span>"processed_transcript"</span>,<span>"sense_intronic"</span>,<br>           <span>"bidirectional_promoter_lncRNA"</span>,<span>"non_coding"</span>,<br>           <span>"antisense_RNA"</span>)<br><br>LncRNA_exprSet &lt;- gtf_df %&gt;% <br>  dplyr::filter(type==<span>"transcript"</span>,transcript_biotype %<span>in</span>% ncRNA) %&gt;% <span>#注意这里是transcript_biotype</span><br>  dplyr::select(c(gene_name,gene_id,transcript_biotype)) %&gt;% <br>  dplyr::distinct() %&gt;% <span>#删除多余行</span><br>  dplyr::inner_join(expr_df_nopoint,by =<span>"gene_id"</span>) %&gt;% <br>  tidyr::unite(gene_id,gene_name,gene_id,transcript_biotype,sep = <span>" | "</span>)<br></code></pre><p>最终得到25530个非编码转录本，数据是这个样子的<br></p><figure><img data-ratio="0.3866213151927438" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVDZ8qp4xZ2Lw4lkwzS720gX793z8HdMiaEicibicbnBRAicp9TjM2PwZX8ZQ/640?wx_fmt=png" data-type="png" data-w="882" title="非编码RNA" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVDZ8qp4xZ2Lw4lkwzS720gX793z8HdMiaEicibicbnBRAicp9TjM2PwZX8ZQ/640?wx_fmt=png"><figcaption>非编码RNA</figcaption></figure><h3><span>数据标准化</span></h3><p>标准化和差异分析都是用Deseq2这个包来完成，首先要构建dds对象，构建这个对象需要两个文件，第一是输入数据，我们已经有了，第二个是分组文件metadata，他至少由两列构成，一列是样本名称，一列是分组信息。</p><p>首先把样本名称变成数据框格式</p><pre><code>metadata <span>&lt;<span>-</span> <span>data.frame</span>(<span>TCGA_id</span> =<span>colnames(expr_df)[-1])</span><br></span></code></pre><p>分组信息包含在TCAG_id的第14,15字符很有用，他指示了样本是癌症还是癌旁或者是转移 病灶<br></p><figure><img data-ratio="0.3975481611208406" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoV1EPTHicvcsWDamzEXRibtvww6HfhuUs0slOGYT9nhUibicEhNAk7dO3ynA/640?wx_fmt=png" data-type="png" data-w="571" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoV1EPTHicvcsWDamzEXRibtvww6HfhuUs0slOGYT9nhUibicEhNAk7dO3ynA/640?wx_fmt=png"></figure><p>官网解释如下,01-09是癌症，10-19是正常，20-29是癌旁</p><blockquote><p>Tumor types range from 01 - 09, normal types from 10 - 19 and control samples from 20 - 29</p></blockquote><p>TCGA barcode的详细信息如下：<br></p><figure><img data-ratio="0.7003424657534246" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVrvGicaSicJuQMCfCMM1euwvp5PhQsGP0HKlmHCmXj1AkAjxBhJqredxQ/640?wx_fmt=png" data-type="png" data-w="1168" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVrvGicaSicJuQMCfCMM1euwvp5PhQsGP0HKlmHCmXj1AkAjxBhJqredxQ/640?wx_fmt=png"></figure><p>同时我们要注意，即使是肿瘤组织，01-09意义各不相同，比如，01代表原发灶，02代表转移灶，详细信息如下：<br></p><figure><img data-ratio="1.5494699646643109" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVDanPAyxBcUquiaPfzE87M0cpF1R5MZMU01x5OchpenfaLEk7ReO9E2A/640?wx_fmt=png" data-type="png" data-w="566" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVDanPAyxBcUquiaPfzE87M0cpF1R5MZMU01x5OchpenfaLEk7ReO9E2A/640?wx_fmt=png"></figure><p>我们用table这个函数统计一下脑胶质瘤GBM样本的分类</p><pre><code>table(substring(metadata<span>$TCGA_id</span>,14,15))<br></code></pre><figure><img data-ratio="0.18650088809946713" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVnJBsz3jY7Sn2ODyzD0zuIQqyTV3UZXzYFGRBA0OAebDV0hTheueVaw/640?wx_fmt=png" data-type="png" data-w="563" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVnJBsz3jY7Sn2ODyzD0zuIQqyTV3UZXzYFGRBA0OAebDV0hTheueVaw/640?wx_fmt=png"></figure><p>有154个是原发灶，有13个是转移灶，很奇怪是吧，没有癌旁。但是这个是能理解的，人的大脑正常组织是有用的，不同于肝脏这类奇怪多一块少一块无所谓，切取大脑正常组织是没有伦理的。实际上TCGA里面还有一部分肿瘤是没有癌旁的，比如，淋巴瘤。</p><p>这一部分没有正常对照的肿瘤如何进行差异分析呢，一种方法是，使用GTEx数据库中的正常组织，这个我们留一个坑，以后再讲。</p><p>但是，今天我们的活还是要做，我们就用复发和非复发来区分即可。</p><pre><code><span>sample</span> &lt;- ifelse(substring(metadata<span>$TCGA_id</span>,<span>14</span>,<span>15</span>)==<span>"01"</span>,<span>"cancer"</span>,<span>"recur"</span>)<br><span>## 这里的factor是为了dds的需要</span><br>metadata<span>$sample</span> &lt;- as.factor(sample)<br></code></pre><p>此时metadata是这个样子的<br></p><figure><img data-ratio="1.8164794007490637" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVaAWa24TelrEyXsIUtCJ0JYMibrK2r53cIsKpCFia3ic5YEkOxPCcctlYA/640?wx_fmt=png" data-type="png" data-w="267" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVaAWa24TelrEyXsIUtCJ0JYMibrK2r53cIsKpCFia3ic5YEkOxPCcctlYA/640?wx_fmt=png"></figure><p>构建dds的两个文件全部准备好，我们开始下一步</p><h3><span>mRNA标准化</span></h3><p>这一步是为了代码复用，把counts文件统一命名</p><pre><code><span>mycounts</span> &lt;- mRNA_exprSet<br></code></pre><p>构建dds对象，如果mycounts中的TCGA_id是行名，tidy这个参数设置为FASLE</p><pre><code>dds <span>&lt;<span>-DESeqDataSetFromMatrix(countData=mycounts,</span> <br>                             <span>colData</span>=<span>metadata,</span> <br>                             <span>design</span>=<span>~sample,</span><br>                             <span>tidy</span>=<span>TRUE)</span><br></span></code></pre><p>Deseq2分析，这里面有很多步骤都自己运行了，这一步十分耗时，取决于样本数以及电脑内存大小，我的16g内存电脑运行5分钟，而我的学员们有的人要运行20个小时。甚至，如果，你分析的是乳腺癌，1000多个样本，小电脑根本过不去，此时，你可以考虑升级一下装备。</p><pre><code>dds &lt;- DESe<span>q(dds)</span><br></code></pre><p>这个数据很重要，而且有些人获得也不容易，所以，需要保存一下,方便以后使用。</p><pre><code><span>save</span>(dds,file=<span>"mRNA_exprSet_dds_sample.Rdata"</span>)<br></code></pre><p>vst标准化,这一步跟上一步一样，速度取决于样本量和电脑</p><pre><code>vsd <span>&lt;<span>-</span> <span>vst</span>(<span>dds</span>, <span>blind</span> = <span>FALSE)</span><br></span></code></pre><p>为什么选择vst呢？看这个<br><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247485497&amp;idx=1&amp;sn=7aad3947685d3dfe46bab6d218c4d1d8&amp;chksm=9b484882ac3fc19426aeffb4ae0177f611490e464b595752de4bcf5873d5d36effecc4246ba8&amp;mpshare=1&amp;scene=21&amp;srcid=0213vhRDCk3X8brYarWssgnr#wechat_redirect" data-linktype="2">转录组的高级分析前该如何标准化数据？</a><br>Deseq2标准化的原理是什么，youtube上的StatQuest小哥视频说的特别好，可以看看这个帖子<br><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247485344&amp;idx=1&amp;sn=71b8bd1ce59dd1e05dc24f50c113812d&amp;chksm=fa46c29dcd314b8bb3d261418dc0e2d193256619971f1ffc03b22c22ee1131efc063c9970247&amp;mpshare=1&amp;scene=21&amp;srcid=0213ntDdYpDaSvHAaNEaG2xs#wechat_redirect" data-linktype="2">DESeq2的标准化方法</a></p><p>这时候，Deseq2还内置了主成分分析来看一下样本分布</p><pre><code><span>plotPCA</span>(vsd, <span>"sample"</span>)<br></code></pre><figure><img data-ratio="0.670958512160229" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVMjXiaEGg1Q8LSZeAwVClHHgqPkOgaEdY0PNqnF1xcJMvJBHnBeaOucw/640?wx_fmt=png" data-type="png" data-w="699" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVMjXiaEGg1Q8LSZeAwVClHHgqPkOgaEdY0PNqnF1xcJMvJBHnBeaOucw/640?wx_fmt=png"></figure><p>从图上我们可以看出，原发灶和转移灶，并不能完美分开，生物学意义就是，转移灶不是新的类型的肿瘤，他实际上还是脑胶质瘤，后续可能发生的结果是，下游额差异分析接结果不好，可能的解决方法是，找出配对的原发灶和转移灶来分析。我们看结果来说话。</p><p>获取标准化后的数据,这一步还会自动过滤掉不符合规定的基因，这时候，数据明显被标准化了</p><pre><code><span>mRNA_exprSet_vst</span> &lt;<span>-</span> <span>as</span><span>.data</span><span>.frame</span>(<span>assay</span>(<span>vsd</span>))<br></code></pre><figure><img data-ratio="0.5597964376590331" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVu81gvibxpQx0utSnFbwjib4xDGIscEyPaXsX8ojFK0dsOBRlVzFU4uicg/640?wx_fmt=png" data-type="png" data-w="786" title="标准化之后" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVu81gvibxpQx0utSnFbwjib4xDGIscEyPaXsX8ojFK0dsOBRlVzFU4uicg/640?wx_fmt=png"><figcaption>标准化之后</figcaption></figure><p>保存一下这个数据，调整一下格式，就可以用于本文开头说的那一系列操作。</p><pre><code><span>save</span>(ncRNA_exprSet_vst,file = <span>"ncRNA_exprSet_vst.Rda"</span>)<br></code></pre><h3><span>差异分析</span></h3><p>这里用到前面保存的dds,使用results函数提取</p><pre><code>res <span>&lt;<span>-</span> <span>results</span>(<span>dds</span>, <span>tidy</span>=<span>TRUE)</span> <br></span></code></pre><figure><img data-ratio="0.52375" data-src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVEiaReWjvG2COHUb3pdmElXWTsGhDiac1GA1UhonZsvkHiat2YtibAvygibQ/640?wx_fmt=png" data-type="png" data-w="800" title="" src="https://mmbiz.qpic.cn/mmbiz_png/NDy5aEnReX0dSGia6ia0ROUfY04msCmOoVEiaReWjvG2COHUb3pdmElXWTsGhDiac1GA1UhonZsvkHiat2YtibAvygibQ/640?wx_fmt=png"></figure><p>我们看到这个数据，有foldchange值，有pvlaue，那么筛选差异基因，热图，火山图，GO，KEGG分析，GSEA分析就顺理成章啦。<br>参考这个帖子即可<br><a href="https://mp.weixin.qq.com/s?__biz=MzIyMzA2MTcwMg==&amp;mid=2650733210&amp;idx=1&amp;sn=76f5609282d92ba24644729fede24897&amp;chksm=f029a933c75e2025bc8c54a1ad046c3d5f837849d8f68969aa66bbbe58e194e3df0ed981f5d9&amp;token=1715549924&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">来完成你的生信作业，这是最有诚意的GEO数据库教程</a></p><p>我们下周就把这个事情完成！</p><p>Note: 非编码的操作，一模一样，其中，counts数据我们已经提取好啦。</p></section><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Ph1O6V5RkxkyrKpVmB5ODA",target="_blank" rel="noopener noreferrer">原文链接</a>
