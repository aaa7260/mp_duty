---
title: "R tips：monocle安装调试"
date: 2024-04-13T08:42:49Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
R tips：monocle安装调试 by 生信菜鸟团
------
<div><p>如果使用monocle（非monocle3）进行轨迹分析的话，由于这个包比较古老了，年久失修，所以monocle的函数则大概会报一个错误“Error: the condition has length &gt; 1”。<br>本文会叙述一下修复此bug的过程。</p><h3><span>bug解析</span></h3><p>这个错误其实很简单的，就是if语句中条件逻辑值长度大于1。</p><p>在旧版本的R中，这种情况会给出一个warnning：“Error: the condition has length &gt; 1 and only the first element will be used”。而在新版本R中，就会被强制报错。</p><p>这里稍微展开一下，其实旧版本R中对这种情况的处理是有很大问题的，会留下潜藏的bug。作如下场景描述：有一个向量可能存在NA值，如果存在NA则需要将NA值替换为0。</p><p>看如下代码：</p><pre><code>vec &lt;- rnorm(<span>10</span>)<br>vec[<span>5</span>] &lt;- <span>NA</span><br><br><span># is.na(vec)</span><br><span># [1] FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE</span><br><br><span># have bugs</span><br><span>if</span>(is.na(vec)){<br>    vec[is.na(vec)] &lt;- <span>0</span><br>}<br><br><span># right version</span><br><span>if</span>(any(is.na(vec))){<br>    vec[is.na(vec)] &lt;- <span>0</span><br>}<br></code></pre><p>其实这里的if语句就会有问题了，is.na(vec)的结果是一个长度为10的逻辑向量，它的第5个值为TRUE，其他为FALSE。</p><p>由于旧版本R会只提取第一个值（FALSE）为用，因此就会导致if语句体并未被执行，但是问题是vec的第5个元素就是NA值，是需要处理的。</p><p>根据正确的分析逻辑，其if判断条件应改为any(is.na(vec))，只要有NA值，就需要处理。</p><p>所以新版本R对这种情况的强制报错是一个好事情，减少了潜在bug的产生。</p><p>一般情况下，这种bug是需要使用any、all函数对if条件判断值进行处理，调整为一个长度为1的向量。</p><h3><span>修复函数bug</span></h3><p>monocle的构建cds对象、降维聚类、构建轨迹的过程中有两个bug位点，均是报错“Error: the condition has length &gt; 1”。</p><p>修改函数bug是对源码进行修改，然后实施本地安装。可以先在CRAN或者github上将monocle的源码包下载下来，然后解压 'tar -xvzf monocle.VERSION.tar.gz'。</p><p>解压后的R源码就在monocle/R文件夹中。</p><p><strong>bug1: isSparseMatrix函数报错</strong></p><p>寻找源码中的isSparseMatrix位置，可以发现它的定义位置在R/utils.R文件中。</p><pre><code>cd monocle<br>grep isSparseMatrix R/*R<br><span>#</span><span> R/expr_models.R:  <span>if</span> (isSparseMatrix(exprs(cds))){</span><br><span>#</span><span> R/methods-CellDataSet.R:  <span># if (isSparseMatrix(exprs(object))){</span></span><br><span>#</span><span> R/utils.R:  <span>if</span> (class(cellData) != <span>"matrix"</span> &amp;&amp; isSparseMatrix(cellData) == FALSE){</span><br><span>#</span><span> R/utils.R:  <span>if</span> (isSparseMatrix(exprs(X))){</span><br><span>#</span><span> R/utils.R:isSparseMatrix &lt;- <span>function</span>(x){ <span># &lt;----函数定义-----</span></span><br><span>#</span><span> R/utils.R:  <span>if</span> (isSparseMatrix(counts)){</span><br></code></pre><p>isSparseMatrix函数用于判断一个R对象是否为SparseMatrix对象，如果传入的R对象是一个多class的R对象，那么这个函数的返回值就是一个长度大于1的逻辑向量。此函数应作如下修改：</p><pre><code><span># original code</span><br>isSparseMatrix &lt;- <span>function</span>(x){<br>  class(x) %<span>in</span>% c(<span>"dgCMatrix"</span>, <span>"dgTMatrix"</span>)<br>} <br><br><br><span># fix bugs</span><br>isSparseMatrix &lt;- <span>function</span>(x){<br>  any(class(x) %<span>in</span>% c(<span>"dgCMatrix"</span>, <span>"dgTMatrix"</span>))<br>}  <br></code></pre><p><strong>bug2: project2MST函数报错</strong></p><p>寻找源码中project2MST函数的位置，这个函数的定义在R/order_cells.R文件中。</p><pre><code>grep project2MST R/*R<br><span>#</span><span> R/order_cells.R:    cds &lt;- project2MST(cds, project_point_to_line_segment) <span>#project_point_to_line_segment can be changed into other states</span></span><br><span>#</span><span> R/order_cells.R:project2MST &lt;- <span>function</span>(cds, Projection_Method){</span><br></code></pre><p>在这个文件中，寻找project2MST函数体中如下代码,，并作修改：</p><pre><code><span># original code</span><br><span>if</span>(class(projection) != <span>'matrix'</span>)<br>    projection &lt;- as.matrix(projection)<br><br><span># fix bugs</span><br><span>if</span>(!<span>'matrix'</span> %<span>in</span>% class(projection))<br>    projection &lt;- as.matrix(projection)<br></code></pre><h3><span>本地安装修改好bug的R包</span></h3><p>本地安装可以使用命令行R CMD INSTALL，也可以使用R函数install.packages，也可以使用devtools包的install命令。</p><p>以前的R tips推文有讲过，这里以使用install.packages作为示例：</p><pre><code><span># shell环境</span><br><span># 将monocle重新压缩，此为shell命令，非R代码</span><br><span># tar -cvzf monocle monocle-fix-bugs.tar.gz</span><br><br><br><span># R环境中</span><br>install.packages(<span>'monocle-fix-bugs.tar.gz'</span>, repos = <span>NULL</span>, type = <span>"source"</span>) </code></pre><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/JckzyoROSOVovhlb6_hs_Q",target="_blank" rel="noopener noreferrer">原文链接</a>
