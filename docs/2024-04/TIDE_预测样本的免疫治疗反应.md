---
title: "TIDE 预测样本的免疫治疗反应"
date: 2024-04-25T01:09:03Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
TIDE 预测样本的免疫治疗反应 by 生信星球
------
<div><section data-mpa-powered-by="yiban.io"><br></section><section><span>‍</span></section><section><img data-imgfileid="100010876" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-imgfileid="100010877" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第946天</strong></span></span><img data-imgfileid="100010875" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><section><span><span>   </span><span>大神一句话，菜鸟跑半年。我不是大神，但我可以缩短你走弯路的半年~</span></span></section><section><span>   就像歌儿唱的那样，如果你不知道该往哪儿走，就留在这学点生信好不好~</span></section><p><span>   这里有豆豆和花花的学习历程，从新手到进阶，生信路上有你有我！</span></p><section><section><section><h4><span><span> </span>0.背景知识</span></h4><p>TIDE评分越高越容易发生免疫逃逸，免疫治疗获益的可能性就越低，评分&gt;0视为无响应，&lt;0视为有反应。</p><p>只有网页工具和python版。网页工具需要注册登陆使用，普通邮箱注册就可以。</p><p>http://tide.dfci.harvard.edu/</p><p>https://github.com/liulab-dfci/TIDEpy</p><h4><span><span> </span>1.亚型</span></h4><p>可以是现成的：</p><p>TCGA的亚型数据下载链接：https://tcga-pancan-atlas-hub.s3.us-east-1.amazonaws.com/download/TCGASubtype.20170308.tsv.gz</p><p>也可以是自己聚类得到的，例如<br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247491323&amp;idx=1&amp;sn=c2dd4df681b96870c7730ea04f3bb04e&amp;chksm=fdf856b9ca8fdfafd3003545c22dfcda857e1955e9afcbf97a58b77a6b1c694acbc40fc7bfb1&amp;scene=21#wechat_redirect" textvalue="实战-TCGA数据的NMF聚类和可视化" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">实战-TCGA数据的NMF聚类和可视化</a><br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247491290&amp;idx=1&amp;sn=96b991a9c3395550c841e93074043631&amp;chksm=fdf85698ca8fdf8ebf795be3af01b73c9c37cc5284a22a451858611572b34d650dadac94b163&amp;scene=21#wechat_redirect" textvalue="TCGA数据的一致性聚类实战和可视化" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">TCGA数据的一致性聚类实战和可视化</a><br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247491332&amp;idx=1&amp;sn=4b863298a0b9e12504cbf2ea6efe682e&amp;chksm=fdf85746ca8fde501a3a45369e986af3d8187ba1285252e1d883219755f0dce384d78095bb42&amp;scene=21#wechat_redirect" textvalue="有人把亚型分析做成了一站式R包" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">有人把亚型分析做成了一站式R包</a><br><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494487&amp;idx=1&amp;sn=4bf18cfd0f7f2d30a06959e6c58c0569&amp;chksm=fdfba315ca8c2a038dd51a3fafd31ff3af23be7647a9e774ec93c1091075791dc1d818db7ed0&amp;scene=21#wechat_redirect" textvalue="多组学、多算法聚类神器-MOVICS" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">多组学、多算法聚类神器-MOVICS</a></p><pre><code>rm(list = ls())<br>library(stringr)<br>sub = rio::import("TCGASubtype.20170308.tsv.gz")<br>k = stringr::str_starts(sub$Subtype_Selected,"ACC");table(k)<br><span><br>#</span><span># k</span><br><span>#</span><span># FALSE  TRUE </span><br><span>#</span><span>#  7643    91</span><br><br>sub = sub[k,]<br><span>table(sub$</span><span>Subtype_Selected)</span><br><span><br>#</span><span># </span><br><span>#</span><span>#         ACC.CIMP-high ACC.CIMP-intermediate          ACC.CIMP-low </span><br><span>#</span><span>#                    20                    27                    32 </span><br><span>#</span><span>#                ACC.NA </span><br><span>#</span><span>#                    12</span><br><br>k2 = sub$Subtype_Selected!="ACC.NA";table(k2)<br><span><br>#</span><span># k2</span><br><span>#</span><span># FALSE  TRUE </span><br><span>#</span><span>#    12    79</span><br><br>sub = sub[k2,]<br>sub = data.frame(row.names = sub$sample,<br>                 subtype = str_remove_all(sub$Subtype_Selected,"ACC.CIMP-| "))<br>head(sub)<br><span><br>#</span><span>#                      subtype</span><br><span>#</span><span># TCGA-OR-A5J1-01         high</span><br><span>#</span><span># TCGA-OR-A5J2-01          low</span><br><span>#</span><span># TCGA-OR-A5J3-01 intermediate</span><br><span>#</span><span># TCGA-OR-A5J4-01         high</span><br><span>#</span><span># TCGA-OR-A5J5-01 intermediate</span><br><span>#</span><span># TCGA-OR-A5J6-01          low</span><br></code></pre><p>搞成行名是样本名称，内容是亚型的格式即可。</p><h4><span><span> </span>2.表达矩阵</span></h4><pre><code>load("D:/TCGA_RNA_seq/count/acc_exp.Rdata")<br>acc[1:3,1:3]<br><span><br>#</span><span>#                    TCGA-OR-A5JD-01A-11R-A29S-07 TCGA-OR-A5L5-01A-11R-A29S-07</span><br><span>#</span><span># ENSG00000000003.15                         2086                         3813</span><br><span>#</span><span># ENSG00000000005.6                             2                            3</span><br><span>#</span><span># ENSG00000000419.13                         2086                         2909</span><br><span>#</span><span>#                    TCGA-OR-A5KX-01A-11R-A29S-07</span><br><span>#</span><span># ENSG00000000003.15                         2145</span><br><span>#</span><span># ENSG00000000005.6                             2</span><br><span>#</span><span># ENSG00000000419.13                         2546</span><br><br>library(tinyarray)<br>exp = trans_exp_new(acc)<br>table(make_tcga_group(exp)) #都是tumor，不是的话要去除normal样本<br><span><br>#</span><span># </span><br><span>#</span><span># normal  tumor </span><br><span>#</span><span>#      0     79</span><br><span><br>#</span><span>exp = exp[,make_tcga_group(exp)==<span>"tumor"</span>]</span><br></code></pre><h4><span><span> </span>3.匹配表达矩阵与亚型数据的样本顺序</span></h4><pre><code>head(colnames(<span>exp</span>))<br><br>## [<span>1</span>] <span>"TCGA-OR-A5JD-01A-11R-A29S-07"</span> <span>"TCGA-OR-A5L5-01A-11R-A29S-07"</span><br>## [<span>3</span>] <span>"TCGA-OR-A5KX-01A-11R-A29S-07"</span> <span>"TCGA-OR-A5JY-01A-31R-A29S-07"</span><br>## [<span>5</span>] <span>"TCGA-OR-A5JV-01A-11R-A29S-07"</span> <span>"TCGA-PK-A5H8-01A-11R-A29S-07"</span><br><br>head(rownames(<span>sub</span>))<br><br>## [<span>1</span>] <span>"TCGA-OR-A5J1-01"</span> <span>"TCGA-OR-A5J2-01"</span> <span>"TCGA-OR-A5J3-01"</span> <span>"TCGA-OR-A5J4-01"</span><br>## [<span>5</span>] <span>"TCGA-OR-A5J5-01"</span> <span>"TCGA-OR-A5J6-01"</span><br><br>colnames(<span>exp</span>) = str_sub(colnames(<span>exp</span>),<span>1</span>,<span>15</span>)<br>s = intersect(colnames(<span>exp</span>),rownames(<span>sub</span>));length(s)<br><br>## [<span>1</span>] <span>78</span><br><br><span>exp</span> = <span>exp</span>[,s]<br><span>sub</span> = <span>sub</span>[s,,drop=F]<br></code></pre><h4><span><span> </span>4.将表达矩阵进行标准化并导出</span></h4><p>TIDE首页有明显的提示：</p><p>Note: The gene expression value should be normalized toward a control sample which could be either normal tissues related with a cancer type or mixture sample from diverse tumor samples. The log2(RPKM+1) values from a RNA-seq experiment may not be meaningful unless a good reference control is available to adjust the batch effect and cancer type difference. <strong>In our study, we used the all sample average in each study as the normalization control.</strong></p><p>最后一句话说“使用每个研究中的所有样本平均值作为归一化对照” 代码是:</p><pre><code>exp2 &lt;- sweep(<span>exp</span>,<span>1</span>, apply(<span>exp</span>,<span>1</span>,mean,na.rm=T))<br><span>write</span>.<span>table</span>(exp2,<span>"TIDE.txt"</span>,sep = <span>"\t"</span>,quote = F)<br></code></pre><h4><span><span> </span>5.读取结果并作图</span></h4><p>将这个文件上传的TIDE，得到的结果是tide.csv</p><pre><code>res &lt;- read.csv("tide.csv",row.names = 1,check.names = F)<br>res[1:4,1:4]<br><span><br>#</span><span>#                 No benefits Responder TIDE     IFNG</span><br><span>#</span><span># TCGA-OR-A5J9-01       False     False 0.90 -1353.97</span><br><span>#</span><span># TCGA-P6-A5OF-01       False     False 0.68  -818.80</span><br><span>#</span><span># TCGA-OR-A5KV-01       False     False 0.66 -1885.47</span><br><span>#</span><span># TCGA-OR-A5JF-01       False     False 0.64 -1489.63</span><br><br>res = merge(res,sub,by = "row.names")<br><span>table(res$</span><span>Responder,res<span>$subtype</span>)</span><br><span><br>#</span><span>#        </span><br><span>#</span><span>#         high intermediate low</span><br><span>#</span><span>#   False   11           11  14</span><br><span>#</span><span>#   True     8           16  18</span><br><br>f = fisher.test(table(res$subtype,res$Responder)) <br>label = paste("fisher.test p value =",round(f$p.value,3))<br>label<br><span><br>#</span><span># [1] "fisher.test p value = 0.525"</span><br></code></pre><p>fisher.test用来检验subtype和Responder是否相关，p&lt;0.05表示相关<br>很不幸这个例子是不相关滴。</p><h4><span><span> </span>5.画图</span></h4><p>TIDE列是TIDE分数。Responder是免疫治疗是否响应</p><h5><span>5.1 TIDE评分柱状图</span></h5><pre><code>library(ggplot2)<br>library(dplyr)<br>res = arrange(res,desc(TIDE))<br>p1 = ggplot(res, aes(x = 1:nrow(res), <br>                     y = TIDE, <br>                     fill = Responder)) +<br>  geom_bar(stat = <span>"identity"</span>) +<br>  scale_fill_manual(values =  c(<span>"#f87669"</span>,<span>"#2fa1dd"</span>))+<br>  xlab(<span>"patient"</span>)+<br>  annotate(<span>"text"</span>, x = 40, y = 1, label = label,size = 5) +  <br>  theme_minimal()<br></code></pre><h5><span>5.2.免疫反应与亚型</span></h5><pre><code>library(dplyr)<br>dat = count(res,subtype,Responder)<br>dat = dat %&gt;% group_by(subtype) %&gt;% <br>  summarise(Responder = Responder,n = n/sum(n))<br>dat$Responder = factor(dat$Responder,levels = c(<span>"False"</span>,<span>"True"</span>))<br>dat<br><br><span>## # A tibble: 6 × 3</span><br><span>## # Groups:   subtype [3]</span><br><span>##   subtype      Responder     n</span><br><span>##   &lt;chr&gt;        &lt;fct&gt;     &lt;dbl&gt;</span><br><span>## 1 high         False     0.579</span><br><span>## 2 high         True      0.421</span><br><span>## 3 intermediate False     0.407</span><br><span>## 4 intermediate True      0.593</span><br><span>## 5 low          False     0.438</span><br><span>## 6 low          True      0.562</span><br><br>library(ggplot2)<br>p2 = ggplot(data = dat)+<br>  geom_bar(aes(x = subtype,y = n,<br>               fill = Responder),<br>           stat = <span>"identity"</span>)+<br>  scale_fill_manual(values =  c(<span>"#f87669"</span>,<span>"#2fa1dd"</span>))+<br>  geom_label(aes(x = subtype,y = n,<br>                label = scales::percent(n),<br>                fill = Responder),<br>            color = <span>"white"</span>,<br>            size = 4,label.size = 0,<br>            show.legend = F,<br>            position = position_fill(vjust = 0.5))+<br>  theme_minimal()+<br>  guides(label = <span>"none"</span>)<br>library(patchwork)<br>p1+p2+ plot_layout(widths = c(3,2),guides = <span>"collect"</span>)<br></code></pre><figure><img data-imgfileid="100010884" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHowYzd3Qp9ib7Cgef8lfBpVb2MGn5h7ogDInFu92Gic0uK9JRicmBPHeMd1rYbDIo5HmYuEJrmUw4CuA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHowYzd3Qp9ib7Cgef8lfBpVb2MGn5h7ogDInFu92Gic0uK9JRicmBPHeMd1rYbDIo5HmYuEJrmUw4CuA/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><h4><span><span> </span>6.其他几个评分</span></h4><pre><code>colnames(res)<br><br><span>##  [1] <span>"Row.names"</span>    <span>"No benefits"</span>  <span>"Responder"</span>    <span>"TIDE"</span>         <span>"IFNG"</span>        </span><br><span>##  [6] <span>"MSI Expr Sig"</span> <span>"Merck18"</span>      <span>"CD274"</span>        <span>"CD8"</span>          <span>"CTL.flag"</span>    </span><br><span>## [11] <span>"Dysfunction"</span>  <span>"Exclusion"</span>    <span>"MDSC"</span>         <span>"CAF"</span>          <span>"TAM M2"</span>      </span><br><span>## [16] <span>"subtype"</span></span><br></code></pre><blockquote><p>IFNG:Interferon-gamma,干扰素-γ是一种由免疫细胞，特别是T细胞和自然杀伤细胞产生的细胞因子。Cytotoxic T Lymphocyte(CTL.flag,细胞毒性T淋巴细胞) T cell dysfunction score(Dysfunction,T细胞功能障碍评分) T cell exclusion score(Exclusion,T细胞排斥评分) cancer-associated fibroblasts (CAF,癌症相关成纤维细胞) myeloid-derived suppressor cells (MDSC,髓源性抑制细胞) M2 macrophages.</p></blockquote><p>详细的分数计算原理在这里：https://liulab-dfci.github.io/RIMA/Response.html</p><p>可以作图比较他们</p><pre><code>dat = t(res[,c(4:5,8:9,11:15)])<br>draw_boxplot(dat,res$Responder)+<br>  facet_wrap(~rows,scales = <span>"free"</span>)<br></code></pre><figure><img data-imgfileid="100010885" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHowYzd3Qp9ib7Cgef8lfBpVbAUBoqulxPicaEduRM3JHgzx0PkyPHA4fliaGDeiaKSgVJ0IBicX6djO9Kg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHowYzd3Qp9ib7Cgef8lfBpVbAUBoqulxPicaEduRM3JHgzx0PkyPHA4fliaGDeiaKSgVJ0IBicX6djO9Kg/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><pre><code>draw_boxplot(dat,res<span>$subtype</span>)+<br>  facet_wrap(~rows,scales = <span>"free"</span>)<br></code></pre><figure><img data-imgfileid="100010886" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHowYzd3Qp9ib7Cgef8lfBpVbvCw56ADeJiaSnxeYOIwF9fhpQn1ZTibx4d15Ugucx80ayb8Fp7Lbal3g/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHowYzd3Qp9ib7Cgef8lfBpVbvCw56ADeJiaSnxeYOIwF9fhpQn1ZTibx4d15Ugucx80ayb8Fp7Lbal3g/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure></section><figure><figcaption></figcaption></figure></section><figure><span></span><span></span></figure></section><section><figure><section><figure><figcaption></figcaption></figure></section></figure></section><section><figure><figcaption></figcaption></figure></section><section><figure><figcaption></figcaption></figure></section><section><figure><figcaption></figcaption></figure></section><section><blockquote><section><span>如果因为代码看不懂，而跟不上正文的节奏，可以来找我，相当于来一个新手保护期。我的课程都是循环开课。下一期的时间，点进去咨询微信咯</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494223&amp;idx=1&amp;sn=956c0412cf4235ad73269a1c219cd90c&amp;chksm=fdfba20dca8c2b1b8cfafefb05d6fa736f2f126c8883086f8963e9aafeb2af39791e2e56e254&amp;scene=21#wechat_redirect" textvalue="生信分析‍直播课程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信分析直播课程</a></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494009&amp;idx=1&amp;sn=035d253f973f65c0d1069e515eec2ce8&amp;chksm=fdfba13bca8c282de5a9222a2ab8bc0caa2ddf60cab543c2181e6d4a90b553f4dcde5f154adf&amp;scene=21#wechat_redirect" textvalue="生信新手保护学习小组‍" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信新手保护学习小组</a><br></section></blockquote></section><section><section><br></section></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/-Vu6UcIesrC096aXRPRTyA",target="_blank" rel="noopener noreferrer">原文链接</a>
