---
title: "使用singleR基于自建数据库来自动化注释单细胞转录组亚群"
date: 2024-04-07T10:04:41Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
使用singleR基于自建数据库来自动化注释单细胞转录组亚群 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>早期（可能是五六年前）我们的单细胞转录组数据分析教程确实是提到过singleR的方法，它可以依赖于singleR自己的数据库文件去自动化注释单细胞转录组亚群。</p></blockquote><p data-tool="mdnice编辑器"><strong>但是因为singleR的数据库资源陈旧而且很有限，满足不了日益增长的单细胞应用，后面我们都是主推第一层次降维聚类分群后的人工命名，</strong>通常我们拿到了肿瘤相关的单细胞转录组的表达量矩阵后的第一层次降维聚类分群通常是：</p><ul data-tool="mdnice编辑器"><li><section>immune (CD45+,PTPRC),</section></li><li><section>epithelial/cancer (EpCAM+,EPCAM),</section></li><li><section>stromal (CD10+,MME,fibro or CD31+,PECAM1,endo)</section></li></ul><p data-tool="mdnice编辑器">参考我前面介绍过 <a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247488940&amp;idx=1&amp;sn=1cc8a8a74715087939b9721c0881775d&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现08—肿瘤单细胞数据第一次分群通用规则</a>，这3大单细胞亚群构成了肿瘤免疫微环境的复杂。绝大部分文章都是抓住免疫细胞亚群进行细分，包括淋巴系（T,B,NK细胞）和髓系（单核，树突，巨噬，粒细胞）的两大类作为第二次细分亚群。但是也有不少文章是抓住stromal 里面的 fibro 和endo进行细分，并且编造生物学故事的。</p><p data-tool="mdnice编辑器">这样的话，因为强烈依赖于人工审查对单细胞亚群进行生物学命名，所以工作量很大。前面我们已经介绍了心肝脾肺肾等多个器官的<strong>上皮细胞</strong>的细分亚群， 以及免疫细胞里面的髓系和B细胞细分亚群：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247506948&amp;idx=1&amp;sn=025d7f91abfa1b68d7910c86cf709e43&amp;scene=21#wechat_redirect" data-linktype="2">B细胞细分亚群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247506971&amp;idx=1&amp;sn=f0242285e2c827d922f938d9858d4ffe&amp;scene=21#wechat_redirect" data-linktype="2">髓系免疫细胞细分亚群</a></section></li></ul><p data-tool="mdnice编辑器">目前就是stromal 里面的 fibro 和endo进行细分我还介绍的不够，其实stromal 里面不仅仅是 fibro 和endo，还有周细胞和SMC，不过大多数情况下肿瘤样品里面的基质细胞并不多，所以不一定能细分清楚。但是如果专门的取基质细胞的，就很清晰可以看到了，比如2021的文章：《Resolving the intertwining of inflammation and fibrosis in human heart failure at single‐cell level》，数据集是GSE145154 ，里面 介绍很清晰的区分了 fibro 和endo以及周细胞和SMC：</p><p><img data-galleryid="" data-imgfileid="100045789" data-ratio="0.6222222222222222" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwdXZ587cwoGLibVmngniaJ7DRDUhLrmlqBicpUEh3iaLuzwmfIfVYr4LSRZ1dEwia0xF9zgiaQrZeUlQAA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwdXZ587cwoGLibVmngniaJ7DRDUhLrmlqBicpUEh3iaLuzwmfIfVYr4LSRZ1dEwia0xF9zgiaQrZeUlQAA/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>区分了 fibro 和endo以及周细胞和SMC</figcaption></figure><p data-tool="mdnice编辑器">而且很明显，上面的细胞和SMC其实是会相互混入的，这个暂时是无解的。而且这样的多层次分群，很明显是超出了singleR的能力，因为singleR的数据库就没有这样的stromal的细分。但是singleR确实是有自己的优点，比如它可以不需要提前降维聚类分群，直接针对表达量矩阵本身，就可以给每个细胞一个身份，这样的话它就跳过了降维聚类分群过程引入的误差。如果仅仅是因为singleR的数据库资源的匮乏，就放弃这个工具未免有点暴殄天物。让我们来演示一下如何为singleR方法自己构建一个特殊生物学领域的数据库吧：</p><h3 data-tool="mdnice编辑器"><span></span><span>singleR的书籍</span><span></span></h3><p data-tool="mdnice编辑器">你能想象吗，singleR的知识点细节都足以写成一本书了，详见：https://bioconductor.org/books/release/SingleRBook/</p><pre data-tool="mdnice编辑器"><span></span><code>Authors: Aaron Lun [aut, cre]<br>Version: 1.12.1<br>Modified: 2023-11-29<br>Compiled: 2023-12-06<br>Environment: R version 4.3.2 Patched (2023-11-13 r85521), Bioconductor 3.18<br>License: CC BY<br>Copyright: Aaron Lun, 2020<br>Source: https://github.com/LTLA/SingleRBook-base<br></code></pre><p data-tool="mdnice编辑器">但是我们只需要看这个书籍的第一个章节的1.3单元内容即可，是一个Quick start的案例演练，拿了pbmc4k这样的单细胞转录组数据集作为案例，然后使用singleR自己的HumanPrimaryCellAtlasData数据库文件来进行注释，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span># Loading test data.</span><br><span>library</span>(TENxPBMCData)<br>new.data &lt;- TENxPBMCData(<span>"pbmc4k"</span>)<br><br><span># Loading reference data with Ensembl annotations.</span><br><span>library</span>(celldex)<br>ref.data &lt;- HumanPrimaryCellAtlasData(ensembl=<span>TRUE</span>)<br><br><span># Performing predictions.</span><br><span>library</span>(SingleR)<br>predictions &lt;- SingleR(test=new.data, assay.type.test=<span>1</span>, <br>    ref=ref.data, labels=ref.data$label.main)<br><br>table(predictions$labels)<br></code></pre><p data-tool="mdnice编辑器">可以看到它需要的是一个数据库文件，然后只需要使用SingleR包里面的SingleR函数即可把数据库里面的细胞亚群注释信息映射到需要命名的单细胞转录组数据集里面。</p><p data-tool="mdnice编辑器">成功的运行了SingleR包里面的SingleR函数之后，就可以拿到每个单细胞的具体的身份信息，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>## </span><br><span>##           B_cell              CMP               DC              GMP </span><br><span>##              606                8                1                2 </span><br><span>##         Monocyte          NK_cell        Platelets Pre-B_cell_CD34- </span><br><span>##             1164              217                3               46 </span><br><span>##          T_cells </span><br><span>##             2293</span><br></code></pre><p data-tool="mdnice编辑器">现在的问题是我们不满意singleR自己的HumanPrimaryCellAtlasData数据库文件，所以需要自己构建一个类似的信息文件。</p><h3 data-tool="mdnice编辑器"><span></span><span>singleR有一个官方数据库资源包celldex</span><span></span></h3><p data-tool="mdnice编辑器">singleR有一本书的知识点也就算了，它还把自己的官方数据库资源做成了一个包celldex，值得注意是 Each dataset contains a log-normalized expression matrix that is intended to be comparable to log-UMI counts from common single-cell protocols (Aran et al. 2019) or gene length-adjusted values from bulk datasets.</p><p data-tool="mdnice编辑器">也就是说，它的每个数据库本质上就是一个bulk转录组测序后的表达量矩阵，获取的方法，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span># BiocManager::install("celldex")</span><br><span>library</span>(celldex)<br><br>ref &lt;- HumanPrimaryCellAtlasData()<br>ref &lt;- BlueprintEncodeData()<br>ref &lt;- MouseRNAseqData()<br>ref &lt;- ImmGenData()<br>ref &lt;- DatabaseImmuneCellExpressionData()<br>ref &lt;- NovershternHematopoieticData()<br>ref &lt;- MonacoImmuneData()<br></code></pre><p data-tool="mdnice编辑器">说实话，这个官方数据库资源包celldex里面的7大数据库资源，都不好用。这也就是为什么我们最近五六年的单细胞转录组经常不在推荐这个singleR方法学了，但是确实是可以通过自建一个数据库来避开它的缺点。</p><h3 data-tool="mdnice编辑器"><span></span><span>数据库信息来源</span><span></span></h3><p data-tool="mdnice编辑器">自建数据库，通常指的是我们已经做好了的单细胞转录组降维聚类分群结果，而且成功拿到了亚群名字，比如这个2020的文章：《A Single-Cell Atlas of the Human Healthy Airways》，它就拿到了如下所示的结果：</p><p><img data-galleryid="" data-imgfileid="100045788" data-ratio="0.883668903803132" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwdXZ587cwoGLibVmngniaJ7DSrHwtsM2zQPQwoMGHmAvibaUwEPJ300bffBovWH8JTXWzAGvCfrgiaRw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="894" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwdXZ587cwoGLibVmngniaJ7DSrHwtsM2zQPQwoMGHmAvibaUwEPJ300bffBovWH8JTXWzAGvCfrgiaRw/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>fibro 和endo以及周细胞和SMC</figcaption></figure><p data-tool="mdnice编辑器">可以看到，里面确实是有  fibro 和endo以及周细胞和SMC 信息，我们读取文章的公开信息：web tool ( https://www.genomique.eu/cellbrowser/HCA/ ).  这里面有表达量矩阵文件以及配套的细胞亚群名字信息。</p><pre data-tool="mdnice编辑器"><span></span><code>ct=fread( <span>'Raw_exprMatrix.tsv.gz'</span>,data.table = <span>F</span>)<br>ct[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>rownames(ct)=ct[,<span>1</span>]<br>ct=ct[,-<span>1</span>] <br>sce.all =CreateSeuratObject(counts =  ct , <br>                        min.cells = <span>5</span>,<br>                        min.features = <span>300</span> )<br></code></pre><p data-tool="mdnice编辑器">理解常规的单细胞转录组降维聚类分群代码，可以看 链接: https://pan.baidu.com/s/1bIBG9RciAzDhkTKKA7hEfQ?pwd=y4eh ，基本上大家只需要读入表达量矩阵文件到r里面就可以使用Seurat包做全部的流程。上面我们下载了 Raw_exprMatrix.tsv.gz 文件然后读取后构建了Seurat对象，接下来就读取细胞亚群注释信息文件 ，然后选取我们需要的单细胞亚群：</p><pre data-tool="mdnice编辑器"><span></span><code> phe2=data.table::fread(<span>'supplements/meta.tsv'</span>,data.table = <span>F</span>) <br>  rownames(phe2)=phe2$Id <br><br>  sce.all.int = sce.all <br>  phe=sce.all.int@meta.data<br>  head(phe)<br>  ids=intersect(rownames(phe),rownames(phe2)) <br><br>  chooseCT = c(<span>'Fibroblast'</span>,<span>'Smooth muscle'</span>,<span>'Pericyte'</span>,<span>'Endothelial'</span>,<br>               <span>'Macrophage'</span>,<span>'Monocyte'</span>,<span>'Dendritic'</span>,<span>'LT/NK'</span>,<span>'B cells'</span>,<span>'Plasma cells'</span>)<br>  tmp  =  phe2[ids,]<br>  tmp  = tmp[tmp$CellType %<span>in</span>% chooseCT,] <br>  sce.singleR=sce.all.int[,colnames(sce.all.int) %<span>in</span>% tmp$Id]<br>  sce.singleR$paper =  tmp[match(colnames(sce.singleR),tmp$Id),<span>'CellType'</span>]<br>  DimPlot(sce.singleR,group.by = <span>'paper'</span>,label = <span>T</span>,repel = <span>T</span>)<br>  save(sce.singleR,file = <span>'sce.singleR.Rdata'</span>)<br>as.data.frame(sort(table(sce.singleR$paper)))<br></code></pre><p data-tool="mdnice编辑器">得到如下所示的结果：</p><pre data-tool="mdnice编辑器"><span></span><code>            Var1 Freq<br><span>1</span>        B cells   <span>11</span><br><span>2</span>   Plasma cells   <span>19</span><br><span>3</span>  Smooth muscle   <span>35</span><br><span>4</span>       Pericyte   <span>45</span><br><span>5</span>     Fibroblast   <span>49</span><br><span>6</span>      Dendritic   <span>63</span><br><span>7</span>       Monocyte   <span>76</span><br><span>8</span>          LT/NK   <span>98</span><br><span>9</span>     Macrophage  <span>305</span><br><span>10</span>   Endothelial  <span>398</span><br></code></pre><p data-tool="mdnice编辑器"><strong>可以看到的是这个文件会很小，因为细胞数量确实是不多，但是已经是有  fibro 和endo以及周细胞和SMC 信息，以及部分免疫细胞亚群信息。</strong></p><h3 data-tool="mdnice编辑器"><span></span><span>构建适配singleR算法的数据库文件</span><span></span></h3><p data-tool="mdnice编辑器">前面拿到了一个Seurat单细胞转录组对象，里面有10个单细胞亚群，但是它并不是SingleR包里面的SingleR函数需要的格式（SingleCellExperiment）。可以做一个简单的转：</p><pre data-tool="mdnice编辑器"><span></span><code>load(file = <span>'sce.singleR.Rdata'</span>)<br>sce = sce.singleR<br>colnames(sce@meta.data)<br>Idents(sce) = sce$paper<br>table(Idents(sce) )<br><span>##NOTE：以前是AverageExpression</span><br>av &lt;-AggregateExpression(sce ,      <span># group.by = "celltype",</span><br>                         assays = <span>"RNA"</span>) <br>Ref = av[[<span>1</span>]]<br> <br>head(Ref)<br>ref_sce=SingleCellExperiment::SingleCellExperiment(assays=list(counts=Ref))<br><span>library</span>(scater)<br>ref_sce=scater::logNormCounts(ref_sce)<br><span>library</span>(SingleCellExperiment)<br>logcounts(ref_sce)[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>colData(ref_sce)$Type=colnames(Ref)<br>table(colnames(Ref))<br>ref_sce<br>save(ref_sce,file = <span>'HCA_airway_ref_sce.Rdata'</span>)<br></code></pre><p data-tool="mdnice编辑器">有了上面的 ref_sce 变量，就可以使用SingleR包里面的SingleR函数啦。</p><h3 data-tool="mdnice编辑器"><span></span><span>然后处理需要做注释的单细胞转录组数据集</span><span></span></h3><p data-tool="mdnice编辑器">我们这里举例的文章是2020发表在NC的：《Single-cell transcriptome atlas of the human corpus cavernosum》，对应的数据集是GSE206528，可以看到里面的9个单细胞转录组样品的表达量矩阵文件如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>   21M  6 21  2022 GSM6255907_Normal_1_gene_martix.csv.gz<br>   16M  6 21  2022 GSM6255908_Normal_2_gene_matrix.csv.gz<br>   27M  6 21  2022 GSM6255909_Normal_3_gene_matrix.csv.gz<br>   16M  6 21  2022 GSM6255910_non-DM1_gene_matrix.csv.gz<br>  9.6M  6 21  2022 GSM6255911_non-DM2_gene_matrix.csv.gz<br>   28M  6 21  2022 GSM6255912_non-DM3_gene_matrix.csv.gz<br>   25M  6 21  2022 GSM6255913_Diabetes_1_gene_matrix.csv.gz<br>   26M  6 21  2022 GSM6255914_Diabetes_2_gene_martix.csv.gz<br></code></pre><p data-tool="mdnice编辑器">这个GSE206528的单细胞转录组数据集，很容易构建成为Seurat对象。仍然是走常规的单细胞转录组降维聚类分群代码，可以看 链接: https://pan.baidu.com/s/1bIBG9RciAzDhkTKKA7hEfQ?pwd=y4eh ，基本上大家只需要读入表达量矩阵文件到r里面就可以使用Seurat包做全部的流程，这个时候需要自己肉眼去看每个亚群标记基因，然后才有可能去给具体的单细胞亚群一个生物学名字：</p><p><img data-cropselx1="0" data-cropselx2="558" data-cropsely1="0" data-cropsely2="436" data-galleryid="" data-imgfileid="100045790" data-ratio="1.1962962962962962" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwdXZ587cwoGLibVmngniaJ7DDQFQf2Syvohe53Rq9ibArdDnsF7fKkJeTL7DMv17rjENfiadcLIgwEdg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwdXZ587cwoGLibVmngniaJ7DDQFQf2Syvohe53Rq9ibArdDnsF7fKkJeTL7DMv17rjENfiadcLIgwEdg/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>具体的单细胞亚群一个生物学名字</figcaption></figure><p data-tool="mdnice编辑器">而且可以看到，上面的淋巴系（T,B,NK细胞）和髓系（单核，树突，巨噬，粒细胞）的两大类在我们的第一层次降维聚类分群里面其实是只能说是分成两个大类，没办法细分里面的具体亚群。</p><p data-tool="mdnice编辑器">但是，如果使用SingleR包里面的SingleR函数，其实是可以跨越上面的常规的降维聚类分群，直接使用单细胞表达量矩阵本身即可：</p><pre data-tool="mdnice编辑器"><span></span><code>load(<span>'./singleR/HCA_airway_ref_sce.Rdata'</span>) <br>ref_sce<br><br><span>source</span>(<span>'scRNA_scripts/lib.R'</span>)<br>ce.all  = readRDS(<span>'2-harmony/sce.all_int.rds'</span>) <br>testdata &lt;- GetAssayData(sce.all, slot=<span>"data"</span>) <br></code></pre><p data-tool="mdnice编辑器">接下来，运行 SingleR包里面的SingleR函数 是很简单的事情；</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(SingleR)<br>pred &lt;- SingleR(test=testdata, ref=ref_sce, <br>                labels=ref_sce$Type<br>)<br>as.data.frame(table(pred$labels))<br>head(pred) <br>labels=pred$labels<br>table(labels)  <br>save(labels,file = <span>'SingleR_celltype.Rdata'</span>) <br>sce.all$singleR=labels<br>DimPlot(sce.all, reduction = <span>"umap"</span>,repel = <span>T</span>,<br>        group.by = <span>"singleR"</span>,label = <span>T</span>)<br><br>ggsave(<span>'umap-by-singleR.pdf'</span>,width = <span>8</span>,height = <span>6</span>)<br></code></pre><p data-tool="mdnice编辑器">可以看到，效果还不错：</p><p><img data-galleryid="" data-imgfileid="100045792" data-ratio="0.7809680065627563" data-s="300,640" data-type="png" data-w="2438" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwdXZ587cwoGLibVmngniaJ7DgpspHlgDTfg06R8tsj2YeKoKpicyNxTiaQ7fogNJ6eGEicibWm69O5yibGA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwdXZ587cwoGLibVmngniaJ7DgpspHlgDTfg06R8tsj2YeKoKpicyNxTiaQ7fogNJ6eGEicibWm69O5yibGA/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>singleR.pdf</figcaption></figure><p data-tool="mdnice编辑器">而且第一层次降维聚类分群里面的淋巴系（T,B,NK细胞）和髓系（单核，树突，巨噬，粒细胞）的两大类在SingleR包里面的SingleR函数效果下面也细分的很清楚。</p><p data-tool="mdnice编辑器">另外，值得注意的是，如果我们想从Seurat对象里面获取表达量矩阵，有3个不一样的代码；</p><pre data-tool="mdnice编辑器"><span></span><code>testdata &lt;- GetAssayData(sce.all, slot=<span>"data"</span>)<br>testdata &lt;-sce.all@assays<span>$RNA</span><span>$counts</span><br>testdata &lt;-sce.all@assays<span>$RNA</span>@layers<span>$counts</span><br>testdata[1:4,1:4]<br>dim(testdata) <br></code></pre><p data-tool="mdnice编辑器">就是最后一个方法获取的是没有基因名字和细胞名字的稀疏矩阵，蛮有意思的：</p><p><img data-galleryid="" data-imgfileid="100045791" data-ratio="1.0057803468208093" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwdXZ587cwoGLibVmngniaJ7DfItQEUMrApJMgMviaRTz2vbAu88CcHLezceewhDhduejFMLw1NXLMcA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1038" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwdXZ587cwoGLibVmngniaJ7DfItQEUMrApJMgMviaRTz2vbAu88CcHLezceewhDhduejFMLw1NXLMcA/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>最后一个方法获取的是没有基因名字和细胞名字的稀疏矩阵</figcaption></figure></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span>学徒作业</span><span></span></h3><p data-tool="mdnice编辑器">前面提到的2021的文章：《Resolving the intertwining of inflammation and fibrosis in human heart failure at single‐cell level》，数据集是GSE145154 ，里面 介绍很清晰的区分了 fibro 和endo以及周细胞和SMC。<strong>大家试试看常规降维聚类分群后的命名，和我们演示的SingleR包里面的SingleR函数的效果，对比一下。</strong></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/GpOxe4WLIrBOjbdH5gfyOQ",target="_blank" rel="noopener noreferrer">原文链接</a>
