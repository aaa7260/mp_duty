---
title: "自行构建SingleR数据库"
date: 2024-04-24T23:46:03Z
draft: ["false"]
tags: [
  "fetched",
  "生信漫漫学"
]
categories: ["Acdemic"]
---
自行构建SingleR数据库 by 生信漫漫学
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span></span><span>写在开头</span><span></span></h3><p data-tool="mdnice编辑器">上篇推文给<strong>SingleR自动注释的内容开了个头</strong>，浅浅介绍了一下两个R包——<a href="https://mp.weixin.qq.com/s?__biz=MzkxOTI0Mjc3Mw==&amp;mid=2247487423&amp;idx=1&amp;sn=986070feaec118d7f42a077a8b16ad12&amp;scene=21#wechat_redirect" data-linktype="2">SingleR及数据库资源包celldex简介</a></p><p data-tool="mdnice编辑器">那既然是学习了<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247529445&amp;idx=1&amp;sn=623e8dd62ca3ad3518d2df4db0eacc1f&amp;scene=21#wechat_redirect" data-linktype="2">使用singleR基于自建数据库来自动化注释单细胞转录组亚群</a>，今天就来整理一下<strong>如何基于参考注释数据集，来自行构型SingleR注释数据库叭！</strong></p><p data-tool="mdnice编辑器"><strong>学习视频参考：人工注释与singleR注释差异</strong>(视频好像没办法插入链接，大家有需要的话，自己去技能树的视频号找一下直播回放)</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100003779" data-ratio="0.7809264305177112" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7jqQQ4zH9MV2QBA1qlAKGKWgeuIFNf1KnKdM2xzdrWJu2N5dVAwQEyQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1835" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7jqQQ4zH9MV2QBA1qlAKGKWgeuIFNf1KnKdM2xzdrWJu2N5dVAwQEyQ/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>参考数据库来源</span><span></span></h3><p data-tool="mdnice编辑器">基于需要分析的数据集的文献中——<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247521859&amp;idx=1&amp;sn=d34deaaf69f2e27699f5d8a600a0a2cb&amp;scene=21#wechat_redirect" data-linktype="2">人海绵体单细胞转录组图谱</a>，文章中第一层次降维聚类分群得到七个主要簇，包括<strong>ECs、FBS、周细胞(PC)、巨噬细胞(MACs)、SMCs、施万细胞(SWCs)和T细胞(Ts)</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100003780" data-ratio="0.3046153846153846" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7GcyTF9ialwjibM8BOleX5SaW9lo9FOVN8buXjHiagX8CUqbch8Ys8SUSA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="975" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7GcyTF9ialwjibM8BOleX5SaW9lo9FOVN8buXjHiagX8CUqbch8Ys8SUSA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">我们的参考数据库应该要包含这些细胞亚群，所以<strong>选择的文章是2020年的：《A Single-Cell Atlas of the Human Healthy Airways》</strong>，利用单细胞RNA图谱研究呼吸道细胞群分布和转录变化。</p><h4 data-tool="mdnice编辑器"><span></span><span>文章简介及数据情况</span><span></span></h4><p data-tool="mdnice编辑器"><strong>文章标题</strong>：《A Single-Cell Atlas of the Human Healthy Airways》</p><p data-tool="mdnice编辑器"><strong>发表日期和杂志</strong>：2020年发表在American Journal of Respiratory and Critical Care Medicine上</p><p data-tool="mdnice编辑器"><strong>在线阅读链接</strong>：https://doi.org/10.1164/rccm.201911-2199oc</p><p data-tool="mdnice编辑器"><strong>单细胞实验设计</strong>：</p><p data-tool="mdnice编辑器">采用单细胞RNA图谱技术对10例健康活体志愿者的<strong>呼吸道上皮细胞异质性</strong>进行了研究。总共<strong>在35个不同的位置收集了77,969个细胞，从鼻子到呼吸道树的第12部分。</strong></p><p data-tool="mdnice编辑器"><strong>主要结果</strong>：</p><p data-tool="mdnice编辑器">得到的图谱由高比例的上皮细胞(89.1%)组成，但也包括免疫细胞(6.2%)和基质细胞(4.7%)，这些细胞在呼吸道的不同区域具有不同的细胞比例。</p><p data-tool="mdnice编辑器">它揭示了来自鼻部(MUC4，PI3，Six3)和气管-支气管部(SCGB1A1，TFF3)的相同细胞类型(基底细胞，分泌细胞和多纤毛细胞)之间的差异基因表达。</p><p data-tool="mdnice编辑器"><strong>亚群里面也包含了我们目标数据集中注释到的大部分亚群</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100003776" data-ratio="0.9497907949790795" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7SyOFKQKPNnMW0ibr5YcfnMgfytIYIzs6nSCgOblJtXJkgcQBWpkba4Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="717" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7SyOFKQKPNnMW0ibr5YcfnMgfytIYIzs6nSCgOblJtXJkgcQBWpkba4Q/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>数据链接</strong>：</p><blockquote data-tool="mdnice编辑器"><span></span><p>https://www.genomique.eu/cellbrowser/HCA/</p></blockquote><figure data-tool="mdnice编辑器"><img data-imgfileid="100003778" data-ratio="0.3617278966491724" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7ZNYTBuKkmrySh3EP7z6ry2ae4ndA79D4wzRd4ReFcj0Riciba9XnZMqg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2477" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7ZNYTBuKkmrySh3EP7z6ry2ae4ndA79D4wzRd4ReFcj0Riciba9XnZMqg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">选择<strong>Data Download</strong>下载我们需要的数据即可</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100003777" data-ratio="0.43742824339839265" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7LLBAMOjyYgBIkzsgTlV4J74qdpvgLq3CkeGlqicFUtGiaO43Yibj1kZGg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1742" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7LLBAMOjyYgBIkzsgTlV4J74qdpvgLq3CkeGlqicFUtGiaO43Yibj1kZGg/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>构型SingleR注释数据库</span><span></span></h3><p data-tool="mdnice编辑器"><strong>参考推文：生信技能树</strong><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247529445&amp;idx=1&amp;sn=623e8dd62ca3ad3518d2df4db0eacc1f&amp;scene=21#wechat_redirect" data-linktype="2">使用singleR基于自建数据库来自动化注释单细胞转录组亚群</a></p><h4 data-tool="mdnice编辑器"><span></span><span>读取数据降维聚类分群</span><span></span></h4><p data-tool="mdnice编辑器">因为文章提供了<strong>原始质控后的细胞计数矩阵表格，以及meta.tsv的注释信息</strong>，我们基于<code>Raw_exprMatrix.tsv.gz</code>信息可以创建seurat对象，然后质控和降维聚类分群流程。</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = F) <br><span>source</span>(<span>'scRNA_scripts/lib.R'</span>)<br>getwd()<br><br><span>###### step1: 导入数据 ######   </span><br>ct=fread( <span>'Raw_exprMatrix.tsv.gz'</span>,data.table = F)<br>ct[1:4,1:4]<br>rownames(ct)=ct[,1]<br>ct=ct[,-1] <br><br>sce.all =CreateSeuratObject(counts =  ct , <br>                            min.cells = 5,<br>                            min.features = 300 )<br><br>dim(ct)<br>dim(sce.all)<br><br>as.data.frame(sce.all@assays<span>$RNA</span><span>$counts</span>[1:10, 1:2])<br>head(sce.all@meta.data, 10)<br>table(sce.all<span>$orig</span>.ident)<br>Idents(sce.all)<br><br><br>sp=<span>'human'</span><br><br><span>###### step2: QC质控 ######</span><br>dir.create(<span>"./1-QC"</span>)<br>setwd(<span>"./1-QC"</span>)<br><span># 如果过滤的太狠，就需要去修改这个过滤代码</span><br><span>source</span>(<span>'../scRNA_scripts/qc.R'</span>)<br>sce.all.filt = basic_qc(sce.all)<br><span>print</span>(dim(sce.all))<br><span>print</span>(dim(sce.all.filt))<br>setwd(<span>'../'</span>)<br>getwd()<br><br><span>###### step3: harmony整合多个单细胞样品 ######</span><br><br><span>if</span>(T){<br>  dir.create(<span>"2-harmony"</span>)<br>  getwd()<br>  setwd(<span>"2-harmony"</span>)<br>  <span>source</span>(<span>'../scRNA_scripts/harmony.R'</span>)<br>  <span># 默认 ScaleData 没有添加"nCount_RNA", "nFeature_RNA"</span><br>  <span># 默认的</span><br>  sce.all.int = run_harmony(sce.all.filt)<br>  setwd(<span>'../'</span>)<br>  <br>}<br><br><br><span>###### step4:  看标记基因库 ######</span><br><span># 原则上分辨率是需要自己肉眼判断，取决于个人经验</span><br><span># 为了省力，我们直接看  0.1和0.8即可</span><br><br>table(Idents(sce.all.int))<br>table(sce.all.int<span>$seurat_clusters</span>)<br>table(sce.all.int<span>$RNA_snn_res</span>.0.1) <br>table(sce.all.int<span>$RNA_snn_res</span>.0.8) <br><br>getwd()<br>dir.create(<span>'check-by-0.1'</span>)<br>setwd(<span>'check-by-0.1'</span>)<br>sel.clust = <span>"RNA_snn_res.0.1"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br>dir.create(<span>'check-by-0.5'</span>)<br>setwd(<span>'check-by-0.5'</span>)<br>sel.clust = <span>"RNA_snn_res.0.5"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br>dir.create(<span>'check-by-0.8'</span>)<br>setwd(<span>'check-by-0.8'</span>)<br>sel.clust = <span>"RNA_snn_res.0.8"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>获取需要的单细胞亚群</span><span></span></h4><p data-tool="mdnice编辑器">基于文章提供的<code>meta.tsv</code>可以获取细胞亚群的注释信息，具体可参考<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247520930&amp;idx=1&amp;sn=1eca87855b3f4eef5afbf960351ac5cf&amp;scene=21#wechat_redirect" data-linktype="2">如何利用文献中的细胞注释信息</a></p><pre data-tool="mdnice编辑器"><span></span><code><span>#读取文章提供的细胞亚群注视信息</span><br>  phe2=data.table::fread(<span>'supplements/meta.tsv'</span>,data.table = F)<br>  head(phe2)<br>  rownames(phe2)=phe2<span>$Id</span><br>  table(phe2<span>$Donor</span>)<br>  head(phe2) <br>  <br>  phe=sce.all.int@meta.data<br>  head(phe)<br>  ids=intersect(rownames(phe),rownames(phe2))<br>  g1=phe[ids,]<span>$RNA_snn_res</span>.0.8<br>  g2=phe2[ids,]<span>$CellType</span><br>  table(g2)<br><br>  tmp =  table(g1 ,g2 );tmp<br>  gplots::balloonplot(<br>    table(g1 ,g2 )<br>  )<br>  <br><span>#结合目标文件选择需要的亚群</span><br>  chooseCT = c(<span>'Fibroblast'</span>,<span>'Smooth muscle'</span>,<span>'Pericyte'</span>,<span>'Endothelial'</span>,<br>               <span>'Macrophage'</span>,<span>'Monocyte'</span>,<span>'Dendritic'</span>,<span>'LT/NK'</span>,<span>'B cells'</span>,<span>'Plasma cells'</span>)<br>  tmp  =  phe2[ids,]<br>  tmp  = tmp[tmp<span>$CellType</span> %<span>in</span>% chooseCT,] <span>#选择我们需要的内容</span><br>  table(tmp<span>$CellType</span>)<br>  <br><span>#保存我们需要的内容</span><br>  sce.singleR=sce.all.int[,colnames(sce.all.int) %<span>in</span>% tmp<span>$Id</span>]<br>  <br><span>#给我们的变量命名并保存变量</span><br>  sce.singleR<span>$paper</span> =  tmp[match(colnames(sce.singleR),tmp<span>$Id</span>),<span>'CellType'</span>]<br>  DimPlot(sce.singleR,group.by = <span>'paper'</span>,label = T,repel = T)<br>  save(sce.singleR,file = <span>'sce.singleR.Rdata'</span>)<br>  <br>as.data.frame(sort(table(sce.singleR<span>$paper</span>)))  <br></code></pre><ul data-tool="mdnice编辑器"><li><section>文章全部亚群注释信息</section></li></ul><figure data-tool="mdnice编辑器"><img data-imgfileid="100003786" data-ratio="0.46296296296296297" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7ERQibvo2u7s7koxk6icnaXFuqibGNKFickDpdYgGhuk53CaLBI2SeABgBA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7ERQibvo2u7s7koxk6icnaXFuqibGNKFickDpdYgGhuk53CaLBI2SeABgBA/640?wx_fmt=png&amp;from=appmsg"><figcaption>文章全部注释信息</figcaption></figure><ul data-tool="mdnice编辑器"><li><section>结合目标文件选择后的亚群信息</section></li></ul><figure data-tool="mdnice编辑器"><img data-imgfileid="100003785" data-ratio="0.19107744107744107" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7iaic9WytoAiaw8r8KMYIWhOEMeANpGabVXbhr2XdrZIesSgpEWPIK8Jfg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1188" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7iaic9WytoAiaw8r8KMYIWhOEMeANpGabVXbhr2XdrZIesSgpEWPIK8Jfg/640?wx_fmt=png&amp;from=appmsg"></figure><ul data-tool="mdnice编辑器"><li><section>最终保存下来的注释信息</section></li></ul><figure data-tool="mdnice编辑器"><img data-imgfileid="100003784" data-ratio="0.49696969696969695" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7VuHMia3ZBiaicyVjc3Vp09DcFMha4TPCfpRxNOqBtibZqaYF0NjsDlfcng/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="825" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bUm3VLk3IaEjNUjjU6ROp7VuHMia3ZBiaicyVjc3Vp09DcFMha4TPCfpRxNOqBtibZqaYF0NjsDlfcng/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>和原推文<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247529445&amp;idx=1&amp;sn=623e8dd62ca3ad3518d2df4db0eacc1f&amp;scene=21#wechat_redirect" data-linktype="2">使用singleR基于自建数据库来自动化注释单细胞转录组亚群</a>，数量有出入是因为展示用的全部数据，没有进行抽样。</strong></p><h4 data-tool="mdnice编辑器"><span></span><span>整理格式并创建适配singleR的数据库</span><span></span></h4><p data-tool="mdnice编辑器">将保存下来的注释信息整理成singleR需要的数据格式，<strong>SingleR包里面的SingleR函数需要的格式（SingleCellExperiment）</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span>#转换数据格式，构建适配singleR算法的数据库文件</span><br>load(file = <span>'sce.singleR.Rdata'</span>)<br>sce = sce.singleR<br>colnames(sce@meta.data)<br>Idents(sce) = sce<span>$paper</span><br>table(Idents(sce) )<br><span>##NOTE：以前是AverageExpression,它用于计算每个细胞在不同cluster的基因表达均值</span><br>av &lt;- AggregateExpression(sce ,      <span># group.by = "celltype",</span><br>                         assays = <span>"RNA"</span>) <br>Ref = av[[1]]<br><br>head(Ref)<br>ref_sce = SingleCellExperiment::SingleCellExperiment(assays=list(counts=Ref))<br><br>library(scater)<br>ref_sce=scater::logNormCounts(ref_sce)<br><br>library(SingleCellExperiment)<br>logcounts(ref_sce)[1:4,1:4]<br>colData(ref_sce)<span>$Type</span>=colnames(Ref)<br>table(colnames(Ref))<br><br>ref_sce<br><br><span>#保存 ref_sce 变量</span><br>save(ref_sce,file = <span>'HCA_airway_ref_sce.Rdata'</span>)<br></code></pre><p data-tool="mdnice编辑器"><strong>得到ref_sce 变量，就可以使用SingleR包里面的SingleR函数，对我们的目标分析数据进行注释了。</strong></p><p data-tool="mdnice编辑器"><strong>小tips：</strong>在构建数据库文件时候使用<code>AggregateExpression</code>计算每个细胞在不同cluster的基因表达均值,曾老师让我对比看看不取均值的情况。</p><p data-tool="mdnice编辑器">等我先摸索看看，大家也可以对比一下计算均值和不计算均值的区别，那今天就先浅浅的整理到这里叭！</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/1Szh3ZWOO8VFjMQ8a8bplA",target="_blank" rel="noopener noreferrer">原文链接</a>
