---
title: "生存模型的time C-index 计算与绘图"
date: 2024-04-23T00:48:03Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
生存模型的time C-index 计算与绘图 by 生信星球
------
<div><section data-mpa-powered-by="yiban.io"><br></section><section><span>‍</span></section><section><img data-imgfileid="100010843" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-imgfileid="100010844" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第943天</strong></span></span><img data-imgfileid="100010845" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><section><span><span>   </span><span>大神一句话，菜鸟跑半年。我不是大神，但我可以缩短你走弯路的半年~</span></span></section><section><span>   就像歌儿唱的那样，如果你不知道该往哪儿走，就留在这学点生信好不好~</span></section><p><span>   这里有豆豆和花花的学习历程，从新手到进阶，生信路上有你有我！</span></p><p><span></span></p><section><figure><section><h4><span><span> </span>0.Time C-index</span></h4><p>C-index 是一致性指数，与AUC值一样是评价模型预测能力的指标，在预后模型里，time-ROC很常见，Time C-index却不咋常见，今天整理一下它的代码。</p><h4><span><span> </span>1.单个模型的Time C-index</span></h4><pre><code>rm(list = ls())<br>library(rms)<br>library(pec)<br>library(ggplot2)<br><span>#</span><span>编造示例数据</span><br>n = 200<br>set.seed(123)<br>dat = data.frame(time = runif(n,0,11), <br>                 status = rbinom(n, size = 1, prob = 0.5),<br>                 x1 = rnorm(n), <br>                 x2 = rbinom(n, size = 1, prob = 0.5)) <br>head(dat)<br><span><br>#</span><span>#         time status         x1 x2</span><br><span>#</span><span># 1  3.1633527      0  2.1988103  0</span><br><span>#</span><span># 2  8.6713565      1  1.3124130  0</span><br><span>#</span><span># 3  4.4987461      1 -0.2651451  0</span><br><span>#</span><span># 4  9.7131914      1  0.5431941  0</span><br><span>#</span><span># 5 10.3451401      0 -0.4143399  0</span><br><span>#</span><span># 6  0.5011215      1 -0.4762469  1</span><br></code></pre><p>构建cox模型，单因素的和多因素的都可以</p><pre><code>model = cph(Surv(time,status)~x1+x2,data=dat,x=TRUE,y=TRUE,surv = T)<br>model<br><span><br>#</span><span># Cox Proportional Hazards Model</span><br><span>#</span><span># </span><br><span>#</span><span># cph(formula = Surv(time, status) ~ x1 + x2, data = dat, x = TRUE, </span><br><span>#</span><span>#     y = TRUE, surv = T)</span><br><span>#</span><span># </span><br><span>#</span><span>#                        Model Tests    Discrimination    </span><br><span>#</span><span>#                                              Indexes    </span><br><span>#</span><span># Obs       200    LR chi2      0.71    R2       0.004    </span><br><span>#</span><span># Events     92    d.f.            2    R2(2,200)0.000    </span><br><span>#</span><span># Center 0.0628    Pr(&gt; chi2) 0.7005    R2(2,92) 0.000    </span><br><span>#</span><span>#                  Score chi2   0.71    Dxy      0.075    </span><br><span>#</span><span>#                  Pr(&gt; chi2) 0.7013                      </span><br><span>#</span><span># </span><br><span>#</span><span>#    Coef    S.E.   Wald Z Pr(&gt;|Z|)</span><br><span>#</span><span># x1 -0.0634 0.1114 -0.57  0.5690  </span><br><span>#</span><span># x2  0.1260 0.2134  0.59  0.5549</span><br><span><br>#</span><span> time-cindex 计算</span><br>times &lt;- c(1, 3, 5, 7, 10)<br>cindex&lt;- cindex(model,<br>                 formula=Surv(time,status)~1,<br>                 eval.times = times,<br>                 data=dat)<br>plot(cindex)<br></code></pre><figure><img data-imgfileid="100010855" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpnSbWWsDzpNzuvoOtQolLZOXd1yG0BNnoQGnclAwRZkOg3DVuASJ070SzEanhIAnOojsvnibVHqqQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpnSbWWsDzpNzuvoOtQolLZOXd1yG0BNnoQGnclAwRZkOg3DVuASJ070SzEanhIAnOojsvnibVHqqQ/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><p>plot画的图太吃藕啦，我们用ggplot2画</p><pre><code>cindex_df &lt;- data.frame(<br>  Time = <span>times</span>,<br>  cindex = cindex<span>$AppCindex</span><span>$cph</span><br>)<br>head(cindex_df)<br><br><span>##   Time    cindex</span><br><span>## 1    1 0.6263943</span><br><span>## 2    3 0.5270632</span><br><span>## 3    5 0.5154819</span><br><span>## 4    7 0.5597028</span><br><span>## 5   10 0.5268912</span><br><br>ggplot(cindex_df, aes(x = Time, y = cindex)) +<br>  geom_line(linewidth = 1) + <br>  geom_hline(yintercept = 0.5,linetype = 4)+<br>  ylim(0.4,1)+<br>  labs(title = <span>"Time-dependent C-index"</span>, x = <span>"Time (years)"</span>, y = <span>"C-index"</span>) +<br>  theme_bw()<br></code></pre><figure><img data-imgfileid="100010852" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpnSbWWsDzpNzuvoOtQolLZfpE2ER34UudicOMC2LpuQDnjUdbCR5F3sE6f3TrK3JKXHIZ1Tbr5AMQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpnSbWWsDzpNzuvoOtQolLZfpE2ER34UudicOMC2LpuQDnjUdbCR5F3sE6f3TrK3JKXHIZ1Tbr5AMQ/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><h4><span><span> </span>2.多个模型的Time C-index 比较</span></h4><pre><code>rm(list = ls())<br>library(rms)<br>library(pec)<br>library(ggplot2)<br><span>#</span><span>编造示例数据</span><br>n = 200<br>set.seed(123)<br>dat = data.frame(time = runif(n,0,11), <br>                 status = rbinom(n, size = 1, prob = 0.5),<br>                 x1 = rnorm(n), <br>                 x2 = rbinom(n, size = 1, prob = 0.5)) <br>head(dat)<br><span><br>#</span><span>#         time status         x1 x2</span><br><span>#</span><span># 1  3.1633527      0  2.1988103  0</span><br><span>#</span><span># 2  8.6713565      1  1.3124130  0</span><br><span>#</span><span># 3  4.4987461      1 -0.2651451  0</span><br><span>#</span><span># 4  9.7131914      1  0.5431941  0</span><br><span>#</span><span># 5 10.3451401      0 -0.4143399  0</span><br><span>#</span><span># 6  0.5011215      1 -0.4762469  1</span><br></code></pre><p>构建模型并存到一个列表里</p><pre><code>models = list(X1_2=cph(Surv(<span>time</span>,status)~x1+x2,data=dat,x=<span>TRUE</span>,y=<span>TRUE</span>,surv = T),<br>              X1=cph(Surv(<span>time</span>,status)~x1,data=dat,x=<span>TRUE</span>,y=<span>TRUE</span>,surv = T),<br>              X2=cph(Surv(<span>time</span>,status)~x2,data=dat,x=<span>TRUE</span>,y=<span>TRUE</span>,surv = T))<br># <span>time</span>-cindex 计算<br>times &lt;- c(<span>1</span>, <span>3</span>, <span>5</span>, <span>7</span>, <span>10</span>)<br>cindex&lt;- cindex(models,<br>            formula=Surv(<span>time</span>,status)~<span>1</span>,<br>            <span>eval</span>.times = times,<br>            data=dat)<br>plot(cindex)<br></code></pre><figure><img data-imgfileid="100010854" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpnSbWWsDzpNzuvoOtQolLZsadYy3EC6d335drt1iaUuqklfPyQrcB2tzhO1TwUEY86gjryYew587Q/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpnSbWWsDzpNzuvoOtQolLZsadYy3EC6d335drt1iaUuqklfPyQrcB2tzhO1TwUEY86gjryYew587Q/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure><p>同样是用ggplot2画，但这次是多个模型,cindex$AppCindex里面是3个向量</p><pre><code><span>cindex$</span><span>AppCindex</span><br><span><br>#</span><span># $X1_2</span><br><span>#</span><span># [1] 0.6263943 0.5270632 0.5154819 0.5597028 0.5268912</span><br><span>#</span><span># </span><br><span>#</span><span># $X1</span><br><span>#</span><span># [1] 0.5713741 0.5684069 0.5495599 0.5651314 0.5231363</span><br><span>#</span><span># </span><br><span>#</span><span># $X2</span><br><span>#</span><span># [1] 0.5745114 0.4791345 0.4821615 0.5186476 0.5155350</span><br></code></pre><p>所以需要宽变长才能给ggplot2用</p><pre><code>cindex_df &lt;- data.frame(<br>  Time = times,<br>  do.call(cbind,cindex$AppCindex)<br>)<br>cindex_df<br><span><br>#</span><span>#   Time      X1_2        X1        X2</span><br><span>#</span><span># 1    1 0.6263943 0.5713741 0.5745114</span><br><span>#</span><span># 2    3 0.5270632 0.5684069 0.4791345</span><br><span>#</span><span># 3    5 0.5154819 0.5495599 0.4821615</span><br><span>#</span><span># 4    7 0.5597028 0.5651314 0.5186476</span><br><span>#</span><span># 5   10 0.5268912 0.5231363 0.5155350</span><br><span><br>#</span><span>宽变长</span><br>library(tidyr)<br>dat = pivot_longer(cindex_df,cols = 2:4,<br>             names_to = "model",<br>             values_to = "cindex")<br>head(dat)<br><span><br>#</span><span># # A tibble: 6 × 3</span><br><span>#</span><span>#    Time model cindex</span><br><span>#</span><span>#   &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;</span><br><span>#</span><span># 1     1 X1_2   0.626</span><br><span>#</span><span># 2     1 X1     0.571</span><br><span>#</span><span># 3     1 X2     0.575</span><br><span>#</span><span># 4     3 X1_2   0.527</span><br><span>#</span><span># 5     3 X1     0.568</span><br><span>#</span><span># 6     3 X2     0.479</span><br><br>library(ggplot2)<br>ggplot(dat, aes(x = Time, y = cindex)) +<br>  geom_line(aes(color = model),linewidth = 2) + <br>  scale_color_brewer(palette = "Set1")+<br>  geom_hline(yintercept = 0.5,linetype = 4)+<br>  ylim(0.4,1)+<br>  labs(title = "Time-dependent C-index", x = "Time (years)", y = "C-index") + <br>  theme_bw()<br></code></pre><figure><img data-imgfileid="100010853" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpnSbWWsDzpNzuvoOtQolLZmuZ7K7FJFROQtuxzDLR651RUsSSRmicbNP2WD1nP7zePMkYCPvicdSSw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" title="" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHpnSbWWsDzpNzuvoOtQolLZmuZ7K7FJFROQtuxzDLR651RUsSSRmicbNP2WD1nP7zePMkYCPvicdSSw/640?wx_fmt=other&amp;from=appmsg"><figcaption></figcaption></figure></section></figure></section><section><figure><figcaption></figcaption></figure></section><section><figure><figcaption></figcaption></figure></section><section><figure><figcaption></figcaption></figure></section><section><blockquote><section><span>如果因为代码看不懂，而跟不上正文的节奏，可以来找我，相当于来一个新手保护期。我的课程都是循环开课。下一期的时间，点进去咨询微信咯</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494223&amp;idx=1&amp;sn=956c0412cf4235ad73269a1c219cd90c&amp;chksm=fdfba20dca8c2b1b8cfafefb05d6fa736f2f126c8883086f8963e9aafeb2af39791e2e56e254&amp;scene=21#wechat_redirect" textvalue="生信分析‍直播课程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信分析直播课程</a></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494009&amp;idx=1&amp;sn=035d253f973f65c0d1069e515eec2ce8&amp;chksm=fdfba13bca8c282de5a9222a2ab8bc0caa2ddf60cab543c2181e6d4a90b553f4dcde5f154adf&amp;scene=21#wechat_redirect" textvalue="生信新手保护学习小组‍" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信新手保护学习小组</a><br></section></blockquote></section><section><section><br></section></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/xkvGFobVt78---_J8-MYBA",target="_blank" rel="noopener noreferrer">原文链接</a>
