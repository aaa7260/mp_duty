---
title: "空转可视化R包semla（三）分类标签的可视化"
date: 2024-04-19T10:34:39Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
空转可视化R包semla（三）分类标签的可视化 by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"></h3><blockquote data-tool="mdnice编辑器"><p>R包semla于2023年发表在生信领域的知名期刊Bioinformatics，题为《<strong>Semla: a versatile toolkit for spatially resolved transcriptomics analysis and visualization</strong>》（https://doi.org/10.1093/bioinformatics/btad626）。semla是用于处理、分析和可视化空间转录组学数据的工具，包括用于数据探索和组织注释的交互式 Web 应用程序。</p><p>为什么要开发semla呢？作者在文章中提到，Seurat R 包是单细胞分析和可视化中最受欢迎的包之一。然而，对于空间数据，特别是针对10X Visium数据，Seurat的交互功能和空间感知分析工具仍然相对有限。为了填补当前这些方面的不足，作者开发了一个R包semla，用来扩展Seurat的空间分析能力。</p><p>semla的官方github在https://github.com/ludvigla/semla，示例教程在https://ludvigla.github.io/semla/articles/semla.html</p></blockquote><p data-tool="mdnice编辑器">上次推文介绍了R包semla的入门介绍及基础可视化，详见</p><ul data-tool="mdnice编辑器"><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247488065&amp;idx=1&amp;sn=b4a5261bb50f81b5e5055049dd5e0b1d&amp;scene=21#wechat_redirect" data-linktype="2">空转可视化R包semla（一）入门介绍</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247488096&amp;idx=1&amp;sn=5efd8b4bc6a59f6b6698595cd0a8acc0&amp;scene=21#wechat_redirect" data-linktype="2">空转可视化R包semla（二）基础可视化篇</a></p></section></li></ul><p><span>本次推文继续介绍R包semla的可视化方案，主要是针对</span><strong>分类标签的可视化（官方教程在https://ludvigla.github.io/semla/articles/categorical_features.html）。</strong><strong></strong></p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(semla)<br><span>library</span>(tibble)<br><span>library</span>(ggplot2)<br><span>library</span>(patchwork)<br><br><span>### 3.1 加载数据</span><br><span># Load data</span><br>se_mbrain &lt;- readRDS(file = system.file(<span>"extdata"</span>, <br>                                        <span>"mousebrain/se_mbrain"</span>, <br>                                        package = <span>"semla"</span>))<br>se_mbrain$sample_id &lt;- <span>"mousebrain"</span><br>se_mcolon &lt;- readRDS(file = system.file(<span>"extdata"</span>, <br>                                        <span>"mousecolon/se_mcolon"</span>, <br>                                        package = <span>"semla"</span>))<br>se_mcolon$sample_id &lt;- <span>"mousecolon"</span><br>se &lt;- MergeSTData(se_mbrain, se_mcolon)<br></code></pre><p data-tool="mdnice编辑器">在本教程中，我们将了解<code>mapplabels()</code>函数的基本用法，用于绘制表示分类标签：</p><pre data-tool="mdnice编辑器"><span></span><code><span># Here we use the &amp; operator from the patchwork R package to add a theme</span><br><span># You can find more details in the 'advanced' tutorial</span><br>MapLabels(se, column_name = <span>"sample_id"</span>, ncol = <span>1</span>) &amp;<br>  theme(legend.position = <span>"right"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004467" data-ratio="1.4311512415349887" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLLtudh3aLb3dLlpHsPuF7iaib0NuqicOhumF4g62kKRbd8eLo0IRDiat0pA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="443" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLLtudh3aLb3dLlpHsPuF7iaib0NuqicOhumF4g62kKRbd8eLo0IRDiat0pA/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240418222833587</figcaption></figure><p data-tool="mdnice编辑器">实际上<code>mapplabels()</code>经常用于可视化聚类/细胞注释的结果，例如：</p><pre data-tool="mdnice编辑器"><span></span><code>se &lt;- se |&gt;<br>  NormalizeData() |&gt;<br>  ScaleData() |&gt;<br>  FindVariableFeatures() |&gt;<br>  RunPCA() |&gt;<br>  FindNeighbors(reduction = <span>"pca"</span>, dims = <span>1</span>:<span>10</span>) |&gt;<br>  FindClusters(resolution = <span>0.2</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>MapLabels(se, column_name = <span>"seurat_clusters"</span>, ncol = <span>1</span>) &amp;<br>  theme(legend.position = <span>"right"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004469" data-ratio="1.5057251908396947" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLQZaInHh3tbCiaPKcXgKxpWjX8VKqArPR9DddCDpcP8gLoJKfITZiboGg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="524" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLQZaInHh3tbCiaPKcXgKxpWjX8VKqArPR9DddCDpcP8gLoJKfITZiboGg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240418223012113</figcaption></figure><p data-tool="mdnice编辑器">除了<code>MapLabels</code>，作者还提供了<code>MapLabelsSummary</code>函数进行可视化：</p><pre data-tool="mdnice编辑器"><span></span><code>MapLabelsSummary(se, <br>                 column_name = <span>"seurat_clusters"</span>, <br>                 ncol = <span>1</span>, <br>                 section_number = <span>1</span>) &amp;<br>  theme(legend.position = <span>"none"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004470" data-ratio="0.7039473684210527" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLkgbpj6PQEACwIWslnH6iajrmIicia9sulI3ADp0aV4N0heXbWcSrPib0icw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="608" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLkgbpj6PQEACwIWslnH6iajrmIicia9sulI3ADp0aV4N0heXbWcSrPib0icw/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240418223123298</figcaption></figure><p data-tool="mdnice编辑器">就像使用MapFeatures一样，我们可以将H&amp;E图像添加到绘图中。在此之前，我们只需要首先使用LoadImages将H&amp;E图像加载到我们的Seurat对象中：</p><pre data-tool="mdnice编辑器"><span></span><code>se &lt;- LoadImages(se, verbose = <span>FALSE</span>)<br><br>MapLabels(se, <br>          column_name = <span>"seurat_clusters"</span>, <br>          image_use = <span>"raw"</span>, <br>          override_plot_dims = <span>TRUE</span>) +<br>  plot_layout(guides = <span>"collect"</span>) &amp;<br>  guides(fill = guide_legend(override.aes = list(size = <span>3</span>), <br>                             ncol = <span>2</span>)) &amp;<br>  theme(legend.position = <span>"right"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004471" data-ratio="0.40929535232383807" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLCAibkyicIaZHyv7ibVxia5zSPHib52dK5AuU1h5DMJ6f4RNzCxdRV4Q4IvQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="667" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLCAibkyicIaZHyv7ibVxia5zSPHib52dK5AuU1h5DMJ6f4RNzCxdRV4Q4IvQ/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240418223149711</figcaption></figure><p data-tool="mdnice编辑器"><code>MapLabels()</code>还提供了一个<code>crop_area</code>参数，可以帮助用户切割图像：</p><pre data-tool="mdnice编辑器"><span></span><code>p &lt;- MapLabels(se, <br>               column_name = <span>"seurat_clusters"</span>, <br>               image_use = <span>"raw"</span>, <br>               pt_alpha = <span>0.5</span>) &amp;<br>  theme(panel.grid.major = element_line(linetype = <span>"dashed"</span>), axis.text = element_text())<br>p<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004468" data-ratio="0.5069337442218799" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLMrDnJJMwMapmVB4bAhIurRRg9m83MriaZXeVaYfwICiaAH8pKbr9nSSw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="649" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLMrDnJJMwMapmVB4bAhIurRRg9m83MriaZXeVaYfwICiaAH8pKbr9nSSw/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240418223246849</figcaption></figure><p data-tool="mdnice编辑器">Clu基因表达显示了在结肠样本中具有淋巴组织的区域。现在，如果我们想要裁剪出小鼠结肠样本中的GALT组织，我们可以在以下位置切割图像：</p><ul data-tool="mdnice编辑器"><li><section>x-left = 0.45</section></li><li><section>y-left = 0.55</section></li><li><section>x-right = 0.65</section></li><li><section>y-right = 0.7</section></li></ul><p data-tool="mdnice编辑器">将上述坐标按照顺序 （x-left, y-left, x-right, y-right）提供给crop_area参数：</p><pre data-tool="mdnice编辑器"><span></span><code>p &lt;- MapLabels(se, <br>               column_name = <span>"selection"</span>, <br>               image_use = <span>"raw"</span>, <br>               pt_size = <span>5</span>, <br>               section_number = <span>2</span>, <br>               crop_area = c(<span>0.45</span>, <span>0.55</span>, <span>0.65</span>, <span>0.7</span>))<br>p<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004475" data-ratio="0.7725947521865889" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLJ5yzm2sYS1NyRZsEZGBfRnu3xynuEAQgO1AuqD8pIlQugAWPBJsg1w/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="686" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLJ5yzm2sYS1NyRZsEZGBfRnu3xynuEAQgO1AuqD8pIlQugAWPBJsg1w/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240418223332652</figcaption></figure><p data-tool="mdnice编辑器">拼图：</p><pre data-tool="mdnice编辑器"><span></span><code><span># override_plot_dims=TRUE can be used to crop the image to only</span><br><span># include the region that contain spots (see 'advanced' tutorial)</span><br>p_global &lt;- MapLabels(se, <br>                      column_name = <span>"selection"</span>, <br>                      image_use = <span>"raw"</span>,<br>                      pt_size = <span>1</span>, <br>                      section_number = <span>2</span>, <br>                      override_plot_dims = <span>TRUE</span>) &amp;<br>  guides(fill = guide_legend(override.aes = list(size = <span>3</span>)))<br><br>p_GALT &lt;- MapLabels(se, <br>                    column_name = <span>"selection"</span>, <br>                    image_use = <span>"raw"</span>,  <br>                    pt_size = <span>5</span>, <br>                    section_number = <span>2</span>, <br>                    crop_area = c(<span>0.45</span>, <span>0.55</span>, <span>0.65</span>, <span>0.7</span>)) &amp;<br>  theme(plot.title = element_blank(), <br>        plot.subtitle = element_blank(), <br>        legend.position = <span>"none"</span>)<br><br>(p_global / p_GALT)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004476" data-ratio="1.5139146567717996" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLHfpLyzReOMnRezRkNhcqyNibdhQDwtKNWcvC37RLLmePuTqnvWZgmMw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="539" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGLHfpLyzReOMnRezRkNhcqyNibdhQDwtKNWcvC37RLLmePuTqnvWZgmMw/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240418223357707</figcaption></figure><p data-tool="mdnice编辑器"><code>MapLabels</code>还可以将数据拆分为单独的面板，例如每个Cluster一个面板：</p><pre data-tool="mdnice编辑器"><span></span><code>cluster_colors &lt;- setNames(RColorBrewer::brewer.pal(length(levels(se$seurat_clusters)), <span>"Set1"</span>), <br>                           nm = levels(se$seurat_clusters))<br><br>MapLabels(se, <br>          column_name = <span>"seurat_clusters"</span>, <br>          split_labels = <span>TRUE</span>,<br>          section_number = <span>1</span>, <br>          <span>#image_use = "raw", </span><br>          ncol = <span>2</span>,<br>          colors = cluster_colors) +<br>  plot_layout(guides = <span>"collect"</span>) &amp;<br>  theme(legend.position = <span>"right"</span>, <br>        legend.title = element_blank(), <br>        legend.margin = margin(-<span>10</span>,-<span>10</span>,-<span>10</span>, <span>0</span>)) &amp;<br>  guides(fill = guide_legend(override.aes = list(size = <span>3</span>)))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100004474" data-ratio="0.9554030874785592" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGL0GNW0EFA9eGLfoLIb4Dewhwq9403agHL2PcqE88RJrWDMK9mzXAvQQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="583" src="https://mmbiz.qpic.cn/mmbiz_jpg/fTW9zRI3eqVugfICzgwvXic6LnFFcRAGL0GNW0EFA9eGLfoLIb4Dewhwq9403agHL2PcqE88RJrWDMK9mzXAvQQ/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20240418223711140</figcaption></figure><p data-tool="mdnice编辑器">以上是R包semla可视化部分，更多内容敬请期待~</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/5h9t9Li7yShs8Mh8FlDcVg",target="_blank" rel="noopener noreferrer">原文链接</a>
