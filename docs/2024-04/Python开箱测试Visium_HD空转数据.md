---
title: "Python开箱测试Visium HD空转数据"
date: 2024-04-11T02:25:50Z
draft: ["false"]
tags: [
  "fetched",
  "生信编程自修室"
]
categories: ["Acdemic"]
---
Python开箱测试Visium HD空转数据 by 生信编程自修室
------
<div><p>生信随笔写了一个 Visium HD 数据的开箱<a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247488048&amp;idx=1&amp;sn=62d7bd81195f6a910bf4653e496a526b&amp;scene=21#wechat_redirect" data-linktype="2">推文</a>，该推文基于 R 语言。因此，小编也再来基于 python 体系开箱一次。</p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>import json</span></code><code><span>import warnings</span></code><code><span>from pathlib import Path</span></code><code><span><br></span></code><code><span>import pandas as pd</span></code><code><span>import scanpy as sc</span></code><code><span>from anndata import AnnData</span></code><code><span>from h5py import File</span></code><code><span>from matplotlib.image import imread</span></code><code><span><br></span></code><code><span>sc.settings.set_figure_params(figsize=(5, 5))</span></code><code><span>%config InlineBackend.figure_format = 'retina'</span></code></pre></section><h4>数据下载</h4><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang=""><code><span>下载示例数据，并解压好相应压缩包进行下面的数据探索（解压: `tar -xvf *.tar.gz`）</span></code><code><span>### Colorectal</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Human_Colon_Cancer/Visium_HD_Human_Colon_Cancer_cloupe_008um.cloupe</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Human_Colon_Cancer/Visium_HD_Human_Colon_Cancer_feature_slice.h5</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Human_Colon_Cancer/Visium_HD_Human_Colon_Cancer_metrics_summary.csv</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Human_Colon_Cancer/Visium_HD_Human_Colon_Cancer_molecule_info.h5</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Human_Colon_Cancer/Visium_HD_Human_Colon_Cancer_spatial.tar.gz</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Human_Colon_Cancer/Visium_HD_Human_Colon_Cancer_square_002um_outputs.tar.gz</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Human_Colon_Cancer/Visium_HD_Human_Colon_Cancer_square_008um_outputs.tar.gz</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Human_Colon_Cancer/Visium_HD_Human_Colon_Cancer_square_016um_outputs.tar.gz</span></code><code><span><br></span></code><code><span>### Mouse Small Intestine</span></code><code><span><br></span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Mouse_Small_Intestine/Visium_HD_Mouse_Small_Intestine_cloupe_008um.cloupe</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Mouse_Small_Intestine/Visium_HD_Mouse_Small_Intestine_feature_slice.h5</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Mouse_Small_Intestine/Visium_HD_Mouse_Small_Intestine_metrics_summary.csv</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Mouse_Small_Intestine/Visium_HD_Mouse_Small_Intestine_molecule_info.h5</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Mouse_Small_Intestine/Visium_HD_Mouse_Small_Intestine_spatial.tar.gz</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Mouse_Small_Intestine/Visium_HD_Mouse_Small_Intestine_square_002um_binned_outputs.tar.gz</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Mouse_Small_Intestine/Visium_HD_Mouse_Small_Intestine_square_008um_binned_outputs.tar.gz</span></code><code><span>!wget https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Mouse_Small_Intestine/Visium_HD_Mouse_Small_Intestine_square_016um_binned_outputs.tar.gz</span></code></pre></section><h4>数据读取</h4><p>下面定义一个函数来读取数据，主要步骤的注释请看代码</p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>def read_visium_hd(</span></code><code><span>        path,</span></code><code><span>        genome = None,</span></code><code><span>        *,</span></code><code><span>        count_file = "filtered_feature_bc_matrix.h5",</span></code><code><span>        library_id = None,</span></code><code><span>        load_images = True,</span></code><code><span>        source_image_path = None):</span></code><code><span>    path = Path(path)</span></code><code><span>    adata = sc.read_10x_h5(path / count_file, genome=genome)</span></code><code><span><br></span></code><code><span>    adata.uns["spatial"] = dict()</span></code><code><span><br></span></code><code><span>    with File(path / count_file, mode="r") as f:</span></code><code><span>        attrs = dict(f.attrs)</span></code><code><span>    if library_id is None:</span></code><code><span>        library_id = attrs.pop("library_ids")[0].decode()</span></code><code><span><br></span></code><code><span>    adata.uns["spatial"][library_id] = dict()</span></code><code><span><br></span></code><code><span>    if load_images:</span></code><code><span>        files = dict(</span></code><code><span>            tissue_positions_file=path / "spatial/tissue_positions.parquet",</span></code><code><span>            scalefactors_json_file=path / "spatial/scalefactors_json.json",</span></code><code><span>            hires_image=path / "spatial/tissue_hires_image.png",</span></code><code><span>            lowres_image=path / "spatial/tissue_lowres_image.png",</span></code><code><span>        )</span></code><code><span><br></span></code><code><span>        # check if files exists, continue if images are missing</span></code><code><span>        for f in files.values():</span></code><code><span>            if not f.exists():</span></code><code><span>                if any(x in str(f) for x in ["hires_image", "lowres_image"]):</span></code><code><span>                    warnings.warn(</span></code><code><span>                        f"You seem to be missing an image file.\n"</span></code><code><span>                        f"Could not find '{f}'."</span></code><code><span>                    )</span></code><code><span>                else:</span></code><code><span>                    raise OSError(f"Could not find '{f}'")</span></code><code><span><br></span></code><code><span>        adata.uns["spatial"][library_id]["images"] = dict()</span></code><code><span>        for res in ["hires", "lowres"]:</span></code><code><span>            try:</span></code><code><span>                adata.uns["spatial"][library_id]["images"][res] = imread(</span></code><code><span>                    str(files[f"{res}_image"])</span></code><code><span>                )</span></code><code><span>            except Exception:</span></code><code><span>                raise OSError(f"Could not find '{res}_image'")</span></code><code><span><br></span></code><code><span>        # read json scalefactors</span></code><code><span>        adata.uns["spatial"][library_id]["scalefactors"] = json.loads(</span></code><code><span>            files["scalefactors_json_file"].read_bytes()</span></code><code><span>        )</span></code><code><span><br></span></code><code><span>        adata.uns["spatial"][library_id]["metadata"] = {</span></code><code><span>            k: (str(attrs[k], "utf-8") if isinstance(attrs[k], bytes) else attrs[k])</span></code><code><span>            for k in ("chemistry_description", "software_version")</span></code><code><span>            if k in attrs</span></code><code><span>        }</span></code><code><span><br></span></code><code><span>        # read coordinates</span></code><code><span>        positions = pd.read_parquet(files["tissue_positions_file"])</span></code><code><span>        positions.set_index('barcode', inplace=True)</span></code><code><span>        positions.columns = ['in_tissue', 'array_row', 'array_col', 'pxl_col_in_fullres', 'pxl_row_in_fullres']</span></code><code><span><br></span></code><code><span>        adata.obs = adata.obs.join(positions, how="left")</span></code><code><span><br></span></code><code><span>        adata.obsm["spatial"] = adata.obs[</span></code><code><span>            ["pxl_row_in_fullres", "pxl_col_in_fullres"]</span></code><code><span>        ].to_numpy()</span></code><code><span>        adata.obs.drop(</span></code><code><span>            columns=["pxl_row_in_fullres", "pxl_col_in_fullres"],</span></code><code><span>            inplace=True,</span></code><code><span>        )</span></code><code><span><br></span></code><code><span>        # put image path in uns</span></code><code><span>        if source_image_path is not None:</span></code><code><span>            # get an absolute path</span></code><code><span>            source_image_path = str(Path(source_image_path).resolve())</span></code><code><span>            adata.uns["spatial"][library_id]["metadata"]["source_image_path"] = str(</span></code><code><span>                source_image_path</span></code><code><span>            )</span></code><code><span><br></span></code><code><span>    return adata</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>from itertools import product</span></code><code><span><br></span></code><code><span>samples = ['Colon_Cancer', 'Small_Intestine']</span></code><code><span>resolutions = ['square_002um', 'square_008um', 'square_016um']</span></code><code><span>combinations = product(samples, resolutions)</span></code><code><span><br></span></code><code><span>for combin in combinations:</span></code><code><span>    sample, resolution = combin</span></code><code><span>    adata = read_visium_hd(f'./{sample}/{resolution}')</span></code><code><span>    adata.var_names_make_unique()</span></code><code><span>    adata.write(f'./{sample}_{resolution}.h5ad')</span></code></pre></section><pre><code>~/miniconda3/envs/official_Test/lib/python3.9/site-packages/anndata/_core/anndata.py:1830: UserWarning: Variable names are not unique. To make them unique, call `.var_names_make_unique`.<br>  utils.warn_names_duplicates("var")<br></code></pre><h4>数据探索</h4><p>首先，我们将结直肠癌 16um 分辨率的数据导入进来</p><section><ul><li></ul><pre data-lang="python"><code><span>adata = sc.read_h5ad('./Colon_Cancer_square_016um.h5ad')</span></code></pre></section><p>以成纤维细胞的 marker DCN 为例，查看基因的表达（注意，尚未对该数据进行归一化，正式画基因表达图时，先进行归一化）</p><section><ul><li><li><li></ul><pre data-lang="python"><code><span>sc.settings.set_figure_params(figsize=(8, 8), dpi=100)</span></code><code><span># img_key=None时，不展示图像</span></code><code><span>sc.pl.spatial(adata, color='DCN', size=2, img_key=None, cmap='Reds')</span></code></pre></section><p><img data-imgfileid="100002236" data-ratio="0.9462962962962963" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mVbfdEzp9o99lHlLiaDp32YXD8he4vK3KxUBSWia4c9AUcl2rXzfU4SsSw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mVbfdEzp9o99lHlLiaDp32YXD8he4vK3KxUBSWia4c9AUcl2rXzfU4SsSw/640?wx_fmt=png&amp;from=appmsg"></p><figure><figcaption>DCN基因表达</figcaption></figure><p>只展示 HE 图像，不展示点</p><section><ul><li><li><li></ul><pre data-lang="python"><code><span># hires</span></code><code><span>sc.settings.set_figure_params(figsize=(8, 8))</span></code><code><span>sc.pl.spatial(adata, color='DCN', size=0, img_key='hires')</span></code></pre></section><figure><p><img data-imgfileid="100002237" data-ratio="0.9462962962962963" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mVYPpGuEGtoefDBUoyxseF9sTKTwFQLDYNIwD5vo7Nib4oGqTOa6TZgRQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mVYPpGuEGtoefDBUoyxseF9sTKTwFQLDYNIwD5vo7Nib4oGqTOa6TZgRQ/640?wx_fmt=png&amp;from=appmsg"></p><figcaption>HE图</figcaption></figure><section><ul><li><li><li></ul><pre data-lang="python"><code><span># 将点overlay在HE图像上</span></code><code><span>sc.settings.set_figure_params(figsize=(8, 8))</span></code><code><span>sc.pl.spatial(adata, color='DCN', size=1.5, img_key='hires')</span></code></pre></section><figure><p><img data-imgfileid="100002238" data-ratio="0.9462962962962963" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mVxOXXiau6fh4ZeuEwULoTXFD4IAboPeZNLZj6OH5dK3ItCEEQ1AJb1kA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mVxOXXiau6fh4ZeuEwULoTXFD4IAboPeZNLZj6OH5dK3ItCEEQ1AJb1kA/640?wx_fmt=png&amp;from=appmsg"></p><figcaption>DCN基因表达与HE</figcaption></figure><h4>数据质量 8um</h4><p><span>为了查看数据质量，我们导入 8um 分辨率的结直肠癌数据，我们且近似</span>地<span>将其看做单细胞数据</span></p><section><ul><li></ul><pre data-lang="python"><code><span>adata = sc.read_h5ad('./Colon_Cancer_square_008um.h5ad')</span></code></pre></section><section><ul><li></ul><pre data-lang="python"><code><span>adata</span></code></pre></section><p>关于 Anndata 的数据结构，我们这里不赘述，详情请观看 Bilibili 相配套的视频教程（https://space.bilibili.com/51135340）</p><pre><code>AnnData object with n_obs × n_vars = 545913 × 18085<br>    obs: 'in_tissue', 'array_row', 'array_col'<br>    var: 'gene_ids', 'feature_types', 'genome'<br>    uns: 'spatial'<br>    obsm: 'spatial'<br></code></pre><section><ul><li><li><li><li><li></ul><pre data-lang="python"><code><span># 计算QC指标</span></code><code><span>adata.var["mt"] = adata.var_names.str.startswith("MT-")</span></code><code><span>sc.pp.calculate_qc_metrics(</span></code><code><span>    adata, qc_vars=["mt"], percent_top=None, log1p=False, inplace=True</span></code><code><span>)</span></code></pre></section><section><ul><li></ul><pre data-lang="python"><code><span>adata</span></code></pre></section><pre><code>AnnData object with n_obs × n_vars = 545913 × 18085<br>    obs: 'in_tissue', 'array_row', 'array_col', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt'<br>    var: 'gene_ids', 'feature_types', 'genome', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts'<br>    uns: 'spatial'<br>    obsm: 'spatial'<br></code></pre><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span>sc.settings.set_figure_params(figsize=(4, 4), dpi=80)</span></code><code><span>sc.pl.violin(</span></code><code><span>    adata,</span></code><code><span>    ["n_genes_by_counts", "total_counts", "pct_counts_mt"],</span></code><code><span>    jitter=0.4,</span></code><code><span>    multi_panel=True,</span></code><code><span>    size=0</span></code><code><span>)</span></code></pre></section><p>过滤前，中位基因数为 299,中位 UMI 为 380。</p><figure><p><img data-imgfileid="100002239" data-ratio="0.32222222222222224" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mV92uExE2Z2ALqR3haZ3cC0BK2ic4dFPj5rd3kze5UKibFJZGxoVukuKBA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mV92uExE2Z2ALqR3haZ3cC0BK2ic4dFPj5rd3kze5UKibFJZGxoVukuKBA/640?wx_fmt=png&amp;from=appmsg"></p><figcaption>结直肠癌Visium HD数据QC图</figcaption></figure><section><ul><li></ul><pre data-lang="python"><code><span>adata.obs[<span>'n_genes_by_counts'</span>].plot(kind=<span>'density'</span>)</span></code></pre></section><pre><code>&lt;AxesSubplot: ylabel='Density'&gt;<br></code></pre><figure><p><img data-imgfileid="100002240" data-ratio="0.7805555555555556" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mVdxSKJXL1RtDRFS43B2V9RGtCgnbRu4FtbHNmdK7d7ZibM4X0OwRk7Vw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="720" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mVdxSKJXL1RtDRFS43B2V9RGtCgnbRu4FtbHNmdK7d7ZibM4X0OwRk7Vw/640?wx_fmt=png&amp;from=appmsg"></p><figcaption><span>结直肠癌</span><span>V</span><span>i</span><span>s</span><span>ium HD基因数目分布图</span></figcaption></figure><section><ul><li><li></ul><pre data-lang="python"><code><span>sc.pl.scatter(adata, x="total_counts", y="pct_counts_mt")</span></code><code><span>sc.pl.scatter(adata, x="total_counts", y="n_genes_by_counts")</span></code></pre></section><p>数据分布，整体上来说还算正常</p><figure><p><img data-imgfileid="100002241" data-ratio="1.003338898163606" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mVbjMqjJsb1QRsiaAmUPsGGOx7vBw4j62jyIQg6lLzHlcPECUAUsQK5Uw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="599" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mVbjMqjJsb1QRsiaAmUPsGGOx7vBw4j62jyIQg6lLzHlcPECUAUsQK5Uw/640?wx_fmt=png&amp;from=appmsg"></p><figcaption>total count VS. pct count</figcaption></figure><figure><p><img data-imgfileid="100002242" data-ratio="0.9693548387096774" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mVZrOT9F6ELbWk5mkeBvBVz0N49sKtT99m7sHgBEsXVGnOvCibvRApWpg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="620" src="https://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbSxoLlicECvBQCzVeZVjK0mVZrOT9F6ELbWk5mkeBvBVz0N49sKtT99m7sHgBEsXVGnOvCibvRApWpg/640?wx_fmt=png&amp;from=appmsg"></p><figcaption>total count VS. n genes</figcaption></figure><h4>Next</h4><p>如果你习惯 R 语言并且想探索 Visium HD 的数据，我们建议您参考推文<a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247488048&amp;idx=1&amp;sn=62d7bd81195f6a910bf4653e496a526b&amp;scene=21#wechat_redirect" data-linktype="2">全网首发 | Visium HD 空转数据开箱测试</a></p><p>作为亚细胞分辨率的数据,我们更推荐你采用<strong>细胞分割构建真实空间单细胞数据</strong>的策略，关于这方面，我们建议您参考：</p><ol><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzU3MTY3ODA2Mw==&amp;mid=2247485036&amp;idx=1&amp;sn=6ad51f56bc198b3a1049ea21f7413fdd&amp;scene=21#wechat_redirect" data-linktype="2">亚细胞精度空间转录组细胞分割</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzU3MTY3ODA2Mw==&amp;mid=2247485097&amp;idx=1&amp;sn=3ab393b5219d437eb3d92a4d0ba9c52e&amp;scene=21#wechat_redirect" data-linktype="2">亚细胞精度空间转录组 RNA 分割</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzU3MTY3ODA2Mw==&amp;mid=2247485178&amp;idx=1&amp;sn=167d9dea7ec6d0662430788e685cf799&amp;scene=21#wechat_redirect" data-linktype="2">单细胞空间域分析详细教程</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzU3MTY3ODA2Mw==&amp;mid=2247485365&amp;idx=1&amp;sn=2b39f04177491ee5d70a3b72eabecc81&amp;scene=21#wechat_redirect" data-linktype="2">真正单细胞空间转录组数据的受配体分析教程</a></section></li></ol><p>Visium HD 的真正单细胞分析和上述推文可能存在一定的 gap，敬请关注后续推文，我们将持续更新！</p><section><mp-common-profile data-pluginname="mpprofile" data-id="MzU3MTY3ODA2Mw==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/rWiaFvFngFbQynpMRF2zxfbyAAKD7HObpc4ewnMg5WRK5u69FSRHb6aZreFxa2T6mKOKNKoltuuFDQtvh9VFdibQ/0?wx_fmt=png" data-nickname="生信编程自修室" data-alias="bio-informatics" data-signature="专注python、R语言编程、数据可视化、生物信息多组学分析" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/4aJC2lxhg3EpqRLxToodog",target="_blank" rel="noopener noreferrer">原文链接</a>
