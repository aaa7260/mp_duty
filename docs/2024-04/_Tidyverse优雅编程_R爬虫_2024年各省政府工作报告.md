---
title: "【Tidyverse优雅编程】R爬虫：2024年各省政府工作报告"
date: 2024-04-16T03:10:25Z
draft: ["false"]
tags: [
  "fetched",
  "R语言与数学建模"
]
categories: ["Acdemic"]
---
【Tidyverse优雅编程】R爬虫：2024年各省政府工作报告 by R语言与数学建模
------
<div><p><span>基本上 10 来行代码就能搞定。</span></p><p data-pid="ULGuzhpZ"><span>加载包：</span></p><pre><code><span>library</span><span>(</span><span>tidyverse</span><span>)</span><br><span>library</span><span>(</span><span>rvest</span><span>)</span></code></pre><h3>第一步，找到总网址</h3><p>http://unn.people.com.cn/n1/2024/0202/c14717-40171566.html<span>171566.html</span><span></span></p><figure data-size="normal"><img data-imgfileid="100002454" data-ratio="0.9609250398724083" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSson4VUh0StCicQAm8qrd8ydpxpJlJQq8bL8fSoGUlzklnsgGeGAOicia9A/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1254" height="1205" width="1254" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSson4VUh0StCicQAm8qrd8ydpxpJlJQq8bL8fSoGUlzklnsgGeGAOicia9A/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="CutE_3RQ">湖南、贵州、新疆待公布，实际上地方政府已经公布了，只是该网站没有及时更新。</p><h3>第二步，获取各个网址</h3><pre><code><span>htmls</span> <span>=</span> <span>read_html</span><span>(</span><span>"http://unn.people.com.cn/n1/2024/0202/c14717-40171566.html"</span><span>)</span> <span>%</span><span>&gt;</span><span>%</span> <br>  <span>html_elements</span><span>(</span><span>".rm_txt_con a , tr:nth-child(1) td:nth-child(1)"</span><span>)</span> <br><span>urls</span> <span>=</span> <span>html_attr</span><span>(</span><span>htmls</span><span>,</span> <span>"href"</span><span>)</span><br><span>ulrs</span></code></pre><figure data-size="normal"><img data-imgfileid="100002453" data-ratio="0.8571428571428571" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSs0JlrYJ9m8ibibzgDKibWG4YMpTopibJYrADbhPnoFn4eVSrGd9c9V0PLJA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1008" height="864" width="1008" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSs0JlrYJ9m8ibibzgDKibWG4YMpTopibJYrADbhPnoFn4eVSrGd9c9V0PLJA/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="t8qq7ma9">有个 <code>NA</code> ，一会儿删除就行。</p><p data-pid="MmtZKgTV">关于这一串怎么来的： <code>.rm_txt_con a , tr:nth-child(1) td:nth-child(1)</code> ，是借助 <code>SelectorGadget</code> 插件，具体使用可参阅我的 R 书附录爬虫节。</p><p data-pid="7enJp3iH">顺便也可以获取名称：</p><pre><code><span>names</span> <span>=</span> <span>html_text2</span><span>(</span><span>htmls</span><span>)</span><br><span>names</span></code></pre><figure data-size="normal"><img data-imgfileid="100002452" data-ratio="0.5443196004993758" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSsGdicC6oXgGR7noiaeMTpFXp8s4Kh5ibk8NABEIxCBcHCpZHstgQMXE7eg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="801" height="436" width="801" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSsGdicC6oXgGR7noiaeMTpFXp8s4Kh5ibk8NABEIxCBcHCpZHstgQMXE7eg/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="00FlTWfs">第 1 个（对应 <code>NA</code> ）正好也是重复，其它都与网址对应，最后缺一个上海的（确实是缺）。</p><p data-pid="XXE1QA3c">这些跟代码没关系，只是网页做的不规范导致的。</p><h3>第三步，调试解决一个网页的成功爬取（省略），写成函数</h3><pre><code><span>get_report</span> <span>=</span> <span>function</span><span>(</span><span>url</span><span>)</span> <span>{</span><br>  <span>read_html</span><span>(</span><span>url</span><span>)</span> <span>%</span><span>&gt;</span><span>%</span> <br>    <span>html_nodes</span><span>(</span><span>"p"</span><span>)</span> <span>%</span><span>&gt;</span><span>%</span> <br>    <span>html_text2</span><span>()</span> <span>%</span><span>&gt;</span><span>%</span> <br>    <span>str_c</span><span>(</span><span>collapse</span> <span>=</span> <span>""</span><span>)</span> <span>%</span><span>&gt;</span><span>%</span> <br>    <span>str_remove</span><span>(</span><span>regex</span><span>(</span><span>"分享让更多人看到.*"</span><span>,</span> <span>dotall</span> <span>=</span> <span>TRUE</span><span>))</span><br><span>}</span></code></pre><p data-pid="evv3EzsL">测试一下：</p><pre><code><span>get_report</span><span>(</span><span>urls</span><span>[[</span><span>2</span><span>]]</span><span>)</span>     <span>#</span> <span>只截取首尾</span></code></pre><figure data-size="normal"><img data-imgfileid="100002451" data-ratio="0.43297252289758537" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSs5FaJ3qNZ59rEsbtnOS5IXibJIjetY7lsr53hwjehibTicFsB8XibsDCUYg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1201" height="520" width="1201" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSs5FaJ3qNZ59rEsbtnOS5IXibJIjetY7lsr53hwjehibTicFsB8XibsDCUYg/640?wx_fmt=other&amp;from=appmsg"></figure><figure data-size="normal"><img data-imgfileid="100002450" data-ratio="0.33500417710944025" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSspu7L2A46ZDKmicD6hv8zDWSLYG31hWPyIGf3wI2iacabicvufPJQdRZsw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1197" height="401" width="1197" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSspu7L2A46ZDKmicD6hv8zDWSLYG31hWPyIGf3wI2iacabicvufPJQdRZsw/640?wx_fmt=other&amp;from=appmsg"></figure><h3>第四步，循环迭代完成批量爬取</h3><p data-pid="uNpgG1Ze">用数据思维，在数据框中完成：</p><pre><code><span>df</span> <span>=</span> <span>tibble</span><span>(</span><span>url</span> <span>=</span> <span>urls</span><span>[</span><span>-</span><span>1</span><span>]</span><span>,</span> <span>name</span> <span>=</span> <span>names</span><span>[</span><span>-</span><span>1</span><span>]</span><span>,</span> <span>text</span> <span>=</span> <span>map_chr</span><span>(</span><span>url</span><span>,</span> <span>get_report</span><span>))</span></code></pre><figure data-size="normal"><img data-imgfileid="100002449" data-ratio="0.3173611111111111" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSsO4OL2L8TlveJQv0wWwv5dH4vsHtDUN6ulAS2gGbuncNrnfXbxqKjbA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1440" height="700" width="2205" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSsO4OL2L8TlveJQv0wWwv5dH4vsHtDUN6ulAS2gGbuncNrnfXbxqKjbA/640?wx_fmt=other&amp;from=appmsg"></figure><h3>第五步，批量写出到文件</h3><pre><code><span>walk2</span><span>(</span><span>df</span><span>$</span><span>text</span><span>,</span> <span>str_c</span><span>(</span><span>"temp/"</span><span>,</span> <span>df</span><span>$</span><span>name</span><span>,</span> <span>".txt"</span><span>),</span> <span>write_lines</span><span>)</span></code></pre><figure data-size="normal"><img data-imgfileid="100002448" data-ratio="0.7169943820224719" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSssKUY5aavrP5snrweaAwias0M2V0g5OOoNxrT1Jz9j4CicpS6EZ7ibNo4w/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1424" height="1021" width="1424" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWAn3Td8d7pichPRpIW2xcbSssKUY5aavrP5snrweaAwias0M2V0g5OOoNxrT1Jz9j4CicpS6EZ7ibNo4w/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="W574c2yJ"><code>.txt</code>是无名的上海。</p><p data-pid="adP3iwF0"><strong>附完整代码：</strong></p><pre><code><span>library</span><span>(</span><span>tidyverse</span><span>)</span><br><span>library</span><span>(</span><span>rvest</span><span>)</span><br><span>#</span> <span>获取各个网址</span><span>,</span> <span>湖南</span><span>、</span><span>贵州</span><span>、</span><span>新疆待公布</span><br><span>htmls</span> <span>=</span> <span>read_html</span><span>(</span><span>"http://unn.people.com.cn/n1/2024/0202/c14717-40171566.html"</span><span>)</span> <span>%</span><span>&gt;</span><span>%</span> <br>  <span>html_elements</span><span>(</span><span>".rm_txt_con a , tr:nth-child(1) td:nth-child(1)"</span><span>)</span> <br><span>urls</span> <span>=</span> <span>html_attr</span><span>(</span><span>htmls</span><span>,</span> <span>"href"</span><span>)</span><br><span>names</span> <span>=</span> <span>html_text2</span><span>(</span><span>htmls</span><span>)</span><br><span>#</span> <span>解决一个网页的爬取</span><br><span>get_report</span> <span>=</span> <span>function</span><span>(</span><span>url</span><span>)</span> <span>{</span><br>  <span>read_html</span><span>(</span><span>url</span><span>)</span> <span>%</span><span>&gt;</span><span>%</span> <br>    <span>html_nodes</span><span>(</span><span>"p"</span><span>)</span> <span>%</span><span>&gt;</span><span>%</span> <br>    <span>html_text2</span><span>()</span> <span>%</span><span>&gt;</span><span>%</span> <br>    <span>str_c</span><span>(</span><span>collapse</span> <span>=</span> <span>""</span><span>)</span> <span>%</span><span>&gt;</span><span>%</span> <br>    <span>str_remove</span><span>(</span><span>regex</span><span>(</span><span>"分享让更多人看到.*"</span><span>,</span> <span>dotall</span> <span>=</span> <span>TRUE</span><span>))</span><br><span>}</span><br><span>#</span> <span>批量爬取各个网页</span><br><span>df</span> <span>=</span> <span>tibble</span><span>(</span><span>url</span> <span>=</span> <span>urls</span><span>[</span><span>-</span><span>1</span><span>]</span><span>,</span> <span>name</span> <span>=</span> <span>names</span><span>[</span><span>-</span><span>1</span><span>]</span><span>,</span> <span>text</span> <span>=</span> <span>map_chr</span><span>(</span><span>url</span><span>,</span> <span>get_report</span><span>))</span><br><span>#</span> <span>批量写出到文件</span><br><span>walk2</span><span>(</span><span>df</span><span>$</span><span>text</span><span>,</span> <span>str_c</span><span>(</span><span>"temp/"</span><span>,</span> <span>df</span><span>$</span><span>name</span><span>,</span> <span>".txt"</span><span>),</span> <span>write_lines</span><span>)</span></code></pre><hr><p data-pid="0p1U84cs"><br></p><hr><p data-pid="0p1U84cs">如果想系统地学习，上述优雅、高效的编程思维，可以：</p><p data-pid="owl1_jAp"><span>更多内容参阅：</span></p><h1>为R语言正名之书《R语言编程：基于tidyverse》正式上市！</h1><p data-pid="owl1_jAp"><span>https://zhuanlan.zhihu.com/p/602882965</span></p><p><br></p><p data-pid="GxIaD__7"><span>免费课件：</span></p><h1>1393页《R语言编程：基于tidyverse》完整课件分享</h1><p data-pid="GxIaD__7"><span>https://zhu</span><span>anlan.zhihu.com/p/589899603</span></p><p data-pid="adP3iwF0"><br></p><p data-pid="adP3iwF0"><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/lRooAX4O_8R2C-CZ3ohHFw",target="_blank" rel="noopener noreferrer">原文链接</a>
