---
title: "批量使用基于Python的Scrublet工具去除双细胞"
date: 2022-09-16T14:31:11Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
批量使用基于Python的Scrublet工具去除双细胞 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>单细胞转录组数据三五年前（2018）的10x技术一般来说都是3000左右的细胞数量每个样品，费用也是三万多，差不多了10块钱人民币一个细胞，那个时候基本上无需担心双细胞问题。（下面是2018的价格）</p><p><img data-galleryid="" data-ratio="0.5175202156334232" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wzyWbh9LGY7qfl2I0klSUhQQHF2bl6H0U7MXicP88Oqr9P51ZNfO3OMv0ulVKBWxIYQCrfF1ic2dpHA/640?wx_fmt=jpeg" data-type="png" data-w="742" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wzyWbh9LGY7qfl2I0klSUhQQHF2bl6H0U7MXicP88Oqr9P51ZNfO3OMv0ulVKBWxIYQCrfF1ic2dpHA/640?wx_fmt=jpeg"></p></blockquote><p data-tool="mdnice编辑器">但随着10x技术的迭代，目前一般来说都可以大多8000个左右的细胞费用降低到1.7万人民币左右，相当于2块钱一个细胞。这个时候就很多人喜欢要求细胞数量越多越好，我看到很多数据集都是1.5万个细胞甚至3万个细胞的数量每个10x单细胞转录组样品，实在是让人很无语。</p><p data-tool="mdnice编辑器">这样的话，我们就不得不对每次得到的10x单细胞转录组表达量矩阵进行双细胞的去除了，有一个基于Python的<strong>Scrublet</strong>工具去除双细胞速度非常快，值得推荐。</p><p data-tool="mdnice编辑器">一般来说单细胞转录组测序数据走完cellranger的定量流程，每个样品就会得到3个表达量矩阵文件（barcodes.tsv.gz，matrix.mtx.gz，genes.tsv.gz或者features.tsv.gz），然后就可以走seurat流程进行单细胞降维聚类分群。但是因为要插入Python的<strong>Scrublet</strong>工具去除双细胞流程，就变得复杂了一点。</p><h3 data-tool="mdnice编辑器"><span></span>首先是Python的<strong>Scrublet</strong>工具安装<span></span></h3><p data-tool="mdnice编辑器">很简单的 pip install 即可，一般来说大家的服务器或者苹果电脑都是有Python环境的，也有pip这个安装器，就是需要注意一下<strong>选择合适的镜像</strong>：</p><pre data-tool="mdnice编辑器"><span></span><code> pip install -i https://pypi.tuna.tsinghua.edu.cn/simple scrublet <br></code></pre><h3 data-tool="mdnice编辑器"><span></span>然后写一个脚本( run_scrublet.py )：<span></span></h3><p data-tool="mdnice编辑器">有意思的是这个脚本名字居然还有讲究，之前命名是（scrublet.py）一直报错，后来把脚本的名字修改为  run_scrublet.py  :</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> sys<br>print(sys.path)<span>#查看python安装位置</span><br><span>import</span> os, sys<br>os.getcwd()<br>os.listdir(os.getcwd()) <br> <br><span># 1.加载Scrublet需要的包</span><br><span>import</span> scrublet <span>as</span> scr<br><span>import</span> scipy.io<br><span>import</span> matplotlib.pyplot <span>as</span> plt<br><span>import</span> numpy <span>as</span> np<br><span>import</span> os<br><span>import</span> pandas <span>as</span> pd<br> <br><span># 1.读取输入文件（输入文件为10X的标准脚本）</span><br><span># input_dir = '/home/bakdata/x10/jmzeng/matrix'</span><br>input_dir =  sys.argv[<span>1</span>]<br>counts_matrix = scipy.io.mmread(input_dir + <span>'/matrix.mtx.gz'</span>).T.tocsc() <br>out_df = pd.read_csv(input_dir + <span>'/barcodes.tsv.gz'</span>, header = <span>None</span>, index_col=<span>None</span>, names=[<span>'barcode'</span>])<br> <br>scrub = scr.Scrublet(counts_matrix, expected_doublet_rate=<span>0.06</span>)<br><br>doublet_scores, predicted_doublets = scrub.scrub_doublets(min_counts=<span>2</span>, min_cells=<span>3</span>, min_gene_variability_pctl=<span>85</span>, n_prin_comps=<span>30</span>)<br> <br><span># doublets占比</span><br><span>print</span> (scrub.detected_doublet_rate_)<br><br>out_df[<span>'doublet_scores'</span>] = doublet_scores<br>out_df[<span>'predicted_doublets'</span>] = predicted_doublets<br>out_df.to_csv(input_dir + <span>'/doublet.txt'</span>, index=<span>False</span>,header=<span>True</span>)<br>out_df.head()<br></code></pre><p data-tool="mdnice编辑器">如果你有一个cellranger的定量流程的outputs文件夹，每个样品就会得到3个表达量矩阵文件（barcodes.tsv.gz，matrix.mtx.gz，genes.tsv.gz或者features.tsv.gz），很容易对单个样品跑上面的流程。</p><pre data-tool="mdnice编辑器"><span></span><code>python run_scrublet.py your_out_by_cellranger<br></code></pre><p data-tool="mdnice编辑器">但是我们通常情况下都不会仅仅是一个样品。</p><h3 data-tool="mdnice编辑器"><span></span>批量运行这个脚本<span></span></h3><p data-tool="mdnice编辑器">很简单的，比如我的授课项目（PRJNA768891-ccRCC）路径下面有4个样品：</p><pre data-tool="mdnice编辑器"><span></span><code>$  ls -d  /home/bakdata/x10/jmzeng/2022-PRJNA768891-ccRCC/rna/outputs/matrix/*<br>/home/bakdata/x10/jmzeng/2022-PRJNA768891-ccRCC/rna/outputs/matrix/SRR16213611<br>/home/bakdata/x10/jmzeng/2022-PRJNA768891-ccRCC/rna/outputs/matrix/SRR16213612<br>/home/bakdata/x10/jmzeng/2022-PRJNA768891-ccRCC/rna/outputs/matrix/SRR16213613<br>/home/bakdata/x10/jmzeng/2022-PRJNA768891-ccRCC/rna/outputs/matrix/SRR16213614<br></code></pre><p data-tool="mdnice编辑器">那么，我们就批量运行这个脚本，使用下面的代码：</p><pre data-tool="mdnice编辑器"><span></span><code> ls -d  /home/bakdata/x10/jmzeng/2022-PRJNA768891-ccRCC/rna/outputs/matrix/* |<span>while</span> <span>read</span> id;<span>do</span>(nohup python run_scrublet.py <span>$id</span> &amp; );<span>done</span><br></code></pre><p data-tool="mdnice编辑器">一般来说单细胞转录组测序数据走完cellranger的定量流程，每个样品就会得到3个表达量矩阵文件（barcodes.tsv.gz，matrix.mtx.gz，genes.tsv.gz或者features.tsv.gz），但是我这个脚本并不需要基因信息，仅仅是读取表达量矩阵即可判断细胞是否是双细胞，然后读取barcodes.tsv.gz后把细胞是否是双细胞这样的信息写出来即可。</p><p data-tool="mdnice编辑器">每个样品对应的文件夹里面都会输出一个文本文件 (doublet.txt )：</p><pre data-tool="mdnice编辑器"><span></span><code>$ head doublet.txt <br>barcode,doublet_scores,predicted_doublets<br>AAACCCAAGCAATTCC-1,0.020104244229337306,False<br>AAACCCAAGCATCGAG-1,0.10305343511450382,False<br>AAACCCAAGCTGGTGA-1,0.05794460641399417,False<br>AAACCCAAGGTGGGTT-1,0.014997115939242453,False<br>AAACCCAAGTGTTGTC-1,0.05228981544771018,False<br>AAACCCACAAATGGTA-1,0.04285714285714286,False<br>AAACCCACAACGGCTC-1,0.007255723960012898,False<br>AAACCCACACAGTCAT-1,0.03284527107241788,False<br>AAACCCACACGCTGCA-1,0.015420424789060229,False<br></code></pre><p data-tool="mdnice编辑器">当然了，其实还可以出一个umap去可视化被Python的<strong>Scrublet</strong>工具预测的双细胞：</p><p><img data-ratio="0.48828125" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzyWbh9LGY7qfl2I0klSUhQeyoXiaADQE5UmfyUF6iaC7RgyyjoiazUffTgvgtqVic26h0Gbfhrfjgliaw/640?wx_fmt=png" data-type="png" data-w="1280" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzyWbh9LGY7qfl2I0klSUhQeyoXiaADQE5UmfyUF6iaC7RgyyjoiazUffTgvgtqVic26h0Gbfhrfjgliaw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">需要注意的是Python的<strong>Scrublet</strong>工具并不是帮你去除双细胞，仅仅是预测给你。后续我们在进行降维聚类分群的时候就需要读入这个文本文件 (doublet.txt )，自己进行去除双细胞操作。我的示例代码是：</p><pre data-tool="mdnice编辑器"><span></span><code> <br><span>###### step1:导入数据 ######    </span><br><span>library</span>(data.table)<br>dir=<span>'matrix/'</span> <br>samples=list.files( dir  )<br>samples <br><br>sceList = lapply(samples,<span>function</span>(pro){ <br>  <span># pro=samples[1]</span><br>  folder=file.path( dir ,pro) <br>  print(pro)<br>  print(folder)<br>  print(list.files(folder))<br>  sce=CreateSeuratObject(counts = Read10X(folder),<br>                         project =  pro ,<br>                         min.cells = <span>5</span>,<br>                         min.features = <span>500</span>)<br>  doub = fread(file.path( dir ,pro,<span>'doublet.txt'</span>))<br>  print(table(doub$predicted_doublets))<br>  rm_barcodes = doub$barcode[doub$predicted_doublets]<br>  print(sce)<br>  sce=sce[,!colnames(sce) %<span>in</span>% rm_barcodes]<br>  print(sce)<br>  <span>return</span>(sce)<br>})<br>names(sceList)   <br></code></pre><p data-tool="mdnice编辑器">后面就是走走seurat流程进行单细胞降维聚类分群。这样的基础分析，也可以看基础10讲：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486076&amp;idx=1&amp;sn=52bb851d7dc23461233a2cf458736151&amp;scene=21#wechat_redirect" data-linktype="2">01. 上游分析流程</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486082&amp;idx=1&amp;sn=03cadceffb2c14ba95d97fe5caf38d94&amp;scene=21#wechat_redirect" data-linktype="2">02.课题多少个样品，测序数据量如何</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486088&amp;idx=1&amp;sn=3a115338ee4937d20caab78627237553&amp;scene=21#wechat_redirect" data-linktype="2">03. 过滤不合格细胞和基因（数据质控很重要）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486096&amp;idx=1&amp;sn=1a99c4c5800b7e0287db3e8ef369fab8&amp;scene=21#wechat_redirect" data-linktype="2">04. 过滤线粒体核糖体基因</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486098&amp;idx=1&amp;sn=bf9a71df848d74fe665ce7d5e283d5ff&amp;scene=21#wechat_redirect" data-linktype="2">05. 去除细胞效应和基因效应</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486260&amp;idx=1&amp;sn=c6abf658de73594d1d77d8e1ffa7d153&amp;scene=21#wechat_redirect" data-linktype="2">06.单细胞转录组数据的降维聚类分群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486271&amp;idx=1&amp;sn=638b434b6deee63206af1c0eeda175ab&amp;scene=21#wechat_redirect" data-linktype="2">07.单细胞转录组数据处理之细胞亚群注释</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486278&amp;idx=1&amp;sn=91250ef733833ff00371818b215dc124&amp;scene=21#wechat_redirect" data-linktype="2">08.把拿到的亚群进行更细致的分群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486287&amp;idx=1&amp;sn=49627c638ff9c04418282c53518aa7c7&amp;scene=21#wechat_redirect" data-linktype="2">09.单细胞转录组数据处理之细胞亚群比例比较</a></section></li></ul></section><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/i6_x1yeMbXawfKm36ewnKQ",target="_blank" rel="noopener noreferrer">原文链接</a>
