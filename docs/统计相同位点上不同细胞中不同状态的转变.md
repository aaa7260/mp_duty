---
title: "统计相同位点上不同细胞中不同状态的转变"
date: 2022-09-13T03:54:16Z
draft: ["false"]
tags: [
  "fetched",
  "生信小知识"
]
categories: ["Acdemic"]
---
统计相同位点上不同细胞中不同状态的转变 by 生信小知识
------
<div><section><h2><span>统计相同位点上不同细胞中不同状态的转变</span></h2><blockquote><p>微信公众号：<strong>生信小知识</strong><br>关注可了解更多的生物信息学教程及知识。问题或建议，请公众号留言;</p></blockquote><h3><span>目录</span></h3><p><span><span>前言</span></span><span><span>1. 测试数据下载</span></span><span><span>2. 数据预处理</span></span><span><span>3. 统计数据转换情况</span></span><span><span>4. 统计分析</span></span><span><span><span>4.1 统计频率改变</span></span></span><span><span><span>4.2 统计富集程度改变</span></span></span><span><span>后记</span></span></p><h3><span>前言</span></h3><p>今天尝试复现一篇文章中的一个有趣的分析，这篇文章即将被我写成文献分享。这篇文章来自：</p><ul><li><p><span>https://www.ncbi.nlm.nih.gov/pubmed/21441907</span></p></li></ul><p>如果不看文章，我简单描述下问题：</p><p>对于基因组来说，我们以200bp为一个bin，对于每个bin，我们都赋予它一个状态state。我们<strong>一共有15种状态</strong>。</p><p>现在我们<strong>有9种细胞</strong>，<strong>每种细胞对于相同位置的同一个bin，都可以有不同的状态</strong>。</p><p>例如：对于bin1来说，在细胞A中可能是state1，在细胞B和C中可能是state2，而在细胞D和E中可能仍是state1。</p><p>现在我想统计，<strong>每种state在不同细胞中的转变情况</strong>。文章的结果如下：</p><p><img data-galleryid="" data-ratio="0.3226837060702875" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJpMomRbz2OQW4WQAqhqzxFAHkHc4fGmNQwHQu0yajnnDjTNoRefx9PTrkhGTI3a1NHmoPPfW0UvNQ/640?wx_fmt=png" data-type="png" data-w="1878" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJpMomRbz2OQW4WQAqhqzxFAHkHc4fGmNQwHQu0yajnnDjTNoRefx9PTrkhGTI3a1NHmoPPfW0UvNQ/640?wx_fmt=png"><span></span></p><ul><li><p><span>a图：每个bin从一种细胞的状态转变为另外一种细胞的state的富集程度。数值越大，表示更有可能转变。例如：第一种细胞的state1，更偏向转变为第二种细胞的state1，因为它的值最大，为110.9</span></p></li><li><p><span>b图：每个bin从一种细胞的状态转变为另外一种细胞的state的频率。数值越大，表示转变发生的次数越多。考虑到这些转变过程中会受到每种染色质状态在基因组中占比问题，所以统计每次转换后的数值，需要除以在第一种细胞中该染色质状态的总数。例如：state1在基因组中占比为0.6（最下一行），有63.8的state1会从第一种细胞中转变为第二种细胞中的state1。</span></p></li></ul><h3><span>1. 测试数据下载</span></h3><p>这里我使用文章的原始数据，这样复现出来的结果我可以和原文比较，就知道我做的对不对了。</p><p>下载地址：http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/</p><ul><li><p><span>Gm12878：http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmGm12878HMM.bed.gz</span></p></li><li><p><span>H1：http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmH1hescHMM.bed.gz</span></p></li><li><p><span>HepG2：http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmHepg2HMM.bed.gz</span></p></li><li><p><span>HMEC：http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmHmecHMM.bed.gz</span></p></li><li><p><span>HSMM：http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmHsmmHMM.bed.gz</span></p></li><li><p><span>HUVEC：http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmHuvecHMM.bed.gz</span></p></li><li><p><span>K562：http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmK562HMM.bed.gz</span></p></li><li><p><span>NHEK：http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmNhekHMM.bed.gz</span></p></li><li><p><span>NHLF：http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmNhlfHMM.bed.gz</span></p></li></ul><p>大家可以使用命令行，也可以用迅雷自行下载。</p><p>这里我习惯使用命令行：</p><pre><code>wget -c http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmGm12878HMM.bed.gz &amp;&amp; gunzip wgEncodeBroadHmmGm12878HMM.bed.gz<br>wget -c http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmH1hescHMM.bed.gz &amp;&amp; gunzip wgEncodeBroadHmmH1hescHMM.bed.gz<br>wget -c http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmHepg2HMM.bed.gz &amp;&amp; gunzip wgEncodeBroadHmmHepg2HMM.bed.gz<br>wget -c http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmHmecHMM.bed.gz &amp;&amp; gunzip wgEncodeBroadHmmHmecHMM.bed.gz<br>wget -c http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmHsmmHMM.bed.gz &amp;&amp; gunzip wgEncodeBroadHmmHsmmHMM.bed.gz<br>wget -c http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmHuvecHMM.bed.gz &amp;&amp; gunzip wgEncodeBroadHmmHuvecHMM.bed.gz<br>wget -c http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmK562HMM.bed.gz &amp;&amp; gunzip wgEncodeBroadHmmK562HMM.bed.gz<br>wget -c http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmNhekHMM.bed.gz &amp;&amp; gunzip wgEncodeBroadHmmNhekHMM.bed.gz<br>wget -c http://hgdownload.soe.ucsc.edu/goldenPath/hg18/encodeDCC/wgEncodeBroadHmm/wgEncodeBroadHmmNhlfHMM.bed.gz &amp;&amp; gunzip wgEncodeBroadHmmNhlfHMM.bed.gz<br></code></pre><h3><span>2. 数据预处理</span></h3><p>下载后的数据，我发现存在一定的问题：坐标并非是200bp的bin，而是进行了合并。所以我需要先将数据进行恢复为200bp bin的格式。</p><p>首先，对文件进行重排序，使其按照基因组坐标进行排序分布，同时只提取需要的信息，去除其他无关信息：</p><pre><code>ls *bed | <span>while</span> <span>read</span> id<br><span>do</span><br>new=<span>${id}</span>.new<br>sort -k1,1 -k2,2n -k3,3n <span>${id}</span> | awk -F<span>"\t"</span> <span>'{print $1,$2,$3,$4}'</span> | awk -F<span>" "</span> -v OFS=<span>"\t"</span> <span>'{print $1,$2,$3,$4}'</span> &gt; <span>${new}</span><br><span>done</span><br></code></pre><p>接着，我们需要对数据处理，恢复200bp bin的格式：</p><pre><code>ls *new | <span>while</span> <span>read</span> id<br><span>do</span><br><br>awk -F<span>"\t"</span> -v OFS=<span>"\t"</span> <span>'{<br>    diff=$3-$2<br>    if(diff!=200){<br>        a=$2<br>        for (i=1; i &lt;= diff/200; i++){<br>            print $1,a,a+200,$4;<br>            a=a+200<br>        }<br>    }else{<br>        print $1,$2,$3,$4<br>    }<br>}'</span> <span>${id}</span> &gt; <span>${id}</span>.txt<br><br><span>done</span><br></code></pre><h3><span>3. 统计数据转换情况</span></h3><p>经过上述操作，所有数据都已经处理成标准格式：</p><ul><li><p><span>坐标一致</span></p></li><li><p><span>都是200bp大小的bin</span></p></li></ul><p>接下来，我们先对数据进行查看：</p><pre><code>$ wc *txt<br> 15113220  60452880 404857813 wgEncodeBroadHmmH1hescHMM.bed.new.txt<br> 15113220  60452880 404820874 wgEncodeBroadHmmHepg2HMM.bed.new.txt<br> 15113220  60452880 404765848 wgEncodeBroadHmmHmecHMM.bed.new.txt<br> 15113220  60452880 404804854 wgEncodeBroadHmmGm12878HMM.bed.new.txt<br> 15113220  60452880 404742546 wgEncodeBroadHmmK562HMM.bed.new.txt<br> 15113220  60452880 404915620 wgEncodeBroadHmmHuvecHMM.bed.new.txt<br> 15113220  60452880 404770806 wgEncodeBroadHmmHsmmHMM.bed.new.txt<br> 15113220  60452880 404786976 wgEncodeBroadHmmNhekHMM.bed.new.txt<br> 15113220  60452880 404848304 wgEncodeBroadHmmNhlfHMM.bed.new.txt<br></code></pre><p>可以看到，所有细胞都有15113220个bin。</p><p>因为有9种细胞，而转化只是在其中2种细胞中进行，所以根据排列组合，我们知道一共应该有9*8=72种细胞排列。为了计算的高效性，我们还是在linux中进行统计：</p><pre><code>ls *bed.new.txt &gt; file.txt<br><br>cat file.txt|<span>while</span> <span>read</span> id1<br><span>do</span><br>    cat file.txt|<span>while</span> <span>read</span> id2<br>    <span>do</span><br>        <span>if</span> [[ <span>${id1}</span> != <span>${id2}</span> ]]; <span>then</span><br>            paste <span>${id1}</span> <span>${id2}</span> | awk -F<span>"\t"</span> <span>'{print $4"-"$8}'</span> | sort | uniq -c | sed <span>"s/^ *//g"</span>&gt; <span>${id1}</span>_<span>${id2}</span>.summary.txt<br>        <span>fi</span><br>    <span>done</span><br><span>done</span><br></code></pre><h3><span>4. 统计分析</span></h3><p>接下来就要进行关键的核心分析了，这里涉及到的统计学计算比较多了，所以我们转移到R中继续。</p><p>首先，我们需要先计算出在所有细胞中，每种状态相互转换的次数，即下面代码中的 <code>transition</code> 变量：</p><pre><code><span># load environment</span><br><span>if</span> (<span>T</span>) {<br>  rm(list = ls())<br>  options(stringAsFactors = <span>F</span>)<br>  <span>library</span>(stringr)<br>  <span>library</span>(ggplot2)<br>  <span>library</span>(pheatmap)<br>}<br><br><span># get all files' info</span><br><span>if</span> (<span>T</span>) {<br>  files &lt;- list.files(pattern = <span>".*summary.txt"</span>,recursive = <span>T</span>,full.names = <span>T</span>)<br><br>  results &lt;- lapply(files,<span>function</span>(x){<br>    <span># x &lt;- files[1]</span><br>    compare &lt;- gsub(<span>"HMM.summary.txt"</span>,<span>""</span>,gsub(<span>".bed.new.txt"</span>,<span>""</span>,gsub(<span>"wgEncodeBroadHmm"</span>,<span>""</span>,x)))<br>    compare &lt;- gsub(<span>"HMM_"</span>,<span>"-"</span>,gsub(<span>"./"</span>,<span>""</span>,compare))<br>    <span>source</span> &lt;- str_split(compare,<span>"-"</span>,simplify = <span>T</span>)[,<span>1</span>]<br>    target &lt;- str_split(compare,<span>"-"</span>,simplify = <span>T</span>)[,<span>2</span>]<br><br>    dat &lt;- read.table(x,header = <span>F</span>,sep = <span>" "</span>)<br>    dat$source_state &lt;- as.numeric(str_split(dat$V2,<span>"-"</span>,simplify = <span>T</span>)[,<span>1</span>])<br>    dat$target_state &lt;- as.numeric(str_split(dat$V2,<span>"-"</span>,simplify = <span>T</span>)[,<span>2</span>])<br>    dat$number &lt;- as.numeric(dat$V1)<br>    dat$source_cell &lt;- <span>source</span><br>    dat$target_cell &lt;- target<br><br>    total_bin_source &lt;- tapply(dat$number,dat$source_state,sum)<br>    total_bin_target &lt;- tapply(dat$number,dat$target_state,sum)<br>    <span>for</span> (i <span>in</span> <span>1</span>:<span>15</span>) {<br>      dat[dat$source_state==i,<span>"total_bin_source"</span>] &lt;- total_bin_source[names(total_bin_source)==i]<br>      dat[dat$target_state==i,<span>"total_bin_target"</span>] &lt;- total_bin_target[names(total_bin_target)==i]<br>    }<br><br>    dat &lt;- dat[,-(<span>1</span>:<span>2</span>)]<br><br>    <span>return</span>(dat)<br>  })<br><br>  results &lt;- do.call(rbind,results)<br>}<br><br><span># transition statistics</span><br><span>if</span> (<span>T</span>) {<br>  results$transition &lt;- paste(results$source_state,results$target_state,sep = <span>"-"</span>)<br><br>  transition &lt;- tapply(results$number, results$transition, sum)<br>  transition &lt;- data.frame(transition=names(transition),<br>                           number=transition)<br>  transition$<span>source</span> &lt;- str_split(transition$transition,<span>"-"</span>,simplify = <span>T</span>)[,<span>1</span>]<br>  transition$target &lt;- str_split(transition$transition,<span>"-"</span>,simplify = <span>T</span>)[,<span>2</span>]<br><br>  total_bin_source &lt;- tapply(transition$number,transition$<span>source</span>,sum)<br>  total_bin_target &lt;- tapply(transition$number,transition$target,sum)<br><br>  <span>for</span> (i <span>in</span> <span>1</span>:<span>15</span>) {<br>    transition[transition$<span>source</span>==i,<span>"total_bin_source"</span>] &lt;- total_bin_source[names(total_bin_source)==i]<br>    transition[transition$target==i,<span>"total_bin_target"</span>] &lt;- total_bin_target[names(total_bin_target)==i]<br>  }<br><br>  rownames(transition) &lt;- <span>1</span>:nrow(transition)<br>}<br></code></pre><p>后面所有的分析都是基于 <code>transition</code> 进行的。</p><h4><span>4.1 统计频率改变</span></h4><pre><code><span># frequency</span><br><span>if</span> (T) {<br>  <span># expected</span><br>  round(total_bin_source/sum(total_bin_source)*100,1)<br><br>  <span># heatmap</span><br>  transition<span>$percent</span> &lt;- transition<span>$number</span>/transition<span>$total_bin_source</span><br>  transition<span>$source</span> &lt;- factor(transition<span>$source</span>,levels = 1:15)<br>  transition<span>$target</span> &lt;- factor(transition<span>$target</span>,levels = 15:1)<br><br>  ggdat &lt;- data.frame()<br>  <span>for</span> (i <span>in</span> 1:15) {<br>    <span>for</span> (j <span>in</span> 1:15) {<br>      ggdat[i,j] &lt;- round(transition[transition<span>$source</span>==i &amp; transition<span>$target</span>==j,7]*100,1)<br>    }<br>  }<br>  colnames(ggdat) &lt;- 1:15<br><br>  pheatmap(ggdat,scale = <span>"none"</span>, <br>           cluster_rows = F,cluster_cols = F,<br>           display_numbers=T)<br>}<br></code></pre><p><img data-galleryid="" data-ratio="0.4562043795620438" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJpMomRbz2OQW4WQAqhqzxFAT0EEQcC1opfp3ZS4NIGXqEh8GoibfoTPPDw5FsTsTeF1LCF0nowonnQ/640?wx_fmt=png" data-type="png" data-w="3288" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJpMomRbz2OQW4WQAqhqzxFAT0EEQcC1opfp3ZS4NIGXqEh8GoibfoTPPDw5FsTsTeF1LCF0nowonnQ/640?wx_fmt=png"></p><figure><figcaption>frequency</figcaption></figure><h4><span>4.2 统计富集程度改变</span></h4><pre><code><span># enrichment fold</span><br><span>if</span> (<span>T</span>) {<br>  transition$expected &lt;- transition$total_bin_source/sum(total_bin_source)*transition$total_bin_target<br>  transition$enrichment_fold &lt;- transition$number/transition$expected<br><br>  ggdat &lt;- data.frame()<br>  <span>for</span> (i <span>in</span> <span>1</span>:<span>15</span>) {<br>    <span>for</span> (j <span>in</span> <span>1</span>:<span>15</span>) {<br>      ggdat[i,j] &lt;- round(transition[transition$<span>source</span>==i &amp; transition$target==j,<span>9</span>],<span>1</span>)<br>    }<br>  }<br>  colnames(ggdat) &lt;- <span>1</span>:<span>15</span><br><br>  pheatmap(ggdat,scale = <span>"none"</span>, <br>           cluster_rows = <span>F</span>,cluster_cols = <span>F</span>,<br>           display_numbers=<span>T</span>,legend = <span>F</span>,filename = <span>"enrichment_fold.png"</span>,<br>           width = <span>5</span>, height = <span>5</span>)<br>}<br></code></pre><p><img data-galleryid="" data-ratio="0.3854059609455293" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJpMomRbz2OQW4WQAqhqzxFAFAyMZh5glRvBicBq41bUecETQSjrUmEMibhs2fBC0uOmAHFKSmCQOJMw/640?wx_fmt=png" data-type="png" data-w="3892" src="https://mmbiz.qpic.cn/mmbiz_png/fOo3cmIWvJpMomRbz2OQW4WQAqhqzxFAFAyMZh5glRvBicBq41bUecETQSjrUmEMibhs2fBC0uOmAHFKSmCQOJMw/640?wx_fmt=png"></p><figure><figcaption>enrichment_fold</figcaption></figure><p>可以看到，所有结果完全复现出来了。</p><h3><span>后记</span></h3><p>这两个分析还是很有意思的，尤其是统计富集程度改变的分析，我一开始怎么都没有想到富集程度到底要怎么计算，直到我回顾了超几何检验的思想。有兴趣的可以自己探索下，顺便附上超几何检验思想的讲解：</p><p><a href="https://mp.weixin.qq.com/s?__biz=MjM5NTk0Mzg2Nw==&amp;mid=2247488231&amp;idx=1&amp;sn=ea373cfc0ab9514feaf146218e5f490f&amp;scene=21#wechat_redirect" data-linktype="2">超几何检验再详解</a></p></section><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/hgES7FadZWNUDvZhExldPg",target="_blank" rel="noopener noreferrer">原文链接</a>
