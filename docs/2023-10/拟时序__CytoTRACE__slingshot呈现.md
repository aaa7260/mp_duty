---
title: "拟时序| CytoTRACE +slingshot呈现"
date: 2023-10-14T17:53:26Z
draft: ["false"]
tags: [
  "fetched",
  "朴素的科研打工仔"
]
categories: ["Acdemic"]
---
拟时序| CytoTRACE +slingshot呈现 by 朴素的科研打工仔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p><span><strong><br></strong></span></p><p><span><strong>   写在前面的话</strong></span></p><p><span><strong>    </strong> </span></p><p><span>    拟时序分析已经是单细胞和空间转录组中的应用文章中的必需分析，干货记录分享，简单易懂！</span></p><h2 data-tool="mdnice编辑器"><span><span>1</span></span><span>读取数据提取亚群</span></h2><pre data-tool="mdnice编辑器"><span></span><code>library(Seurat)<br>scRNA&lt;- readRDS(<span>"scRNA.rds"</span>)<br>DimPlot(scRNA, reduction = <span>"umap"</span>,label = TRUE)<br>Mono &lt;- subset(mono, idents = c(<span>"1"</span>))<br>Mono &lt;- SCTransform(Mono,method=<span>"glmGamPoi"</span>,vars.to.regress=c(<span>"percent.MT"</span>,<span>"G2M.Score"</span>,<span>"S.Score"</span>)) %&gt;% RunPCA() <br>library(harmony)<br>Mono &lt;- RunHarmony(Mono, group.by.vars = <span>"orig.ident"</span>,<br>                   assay.use = <span>"SCT"</span>, max.iter.harmony = <span>10</span>)<br>Mono &lt;- RunUMAP(Mono,reduction = <span>"harmony"</span>, dims = <span>1</span>:<span>30</span>, verbose = FALSE)<br>Mono &lt;- FindNeighbors(Mono, reduction = <span>"harmony"</span>,<br>                      dims = <span>1</span>:<span>30</span>) <br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.9861111111111112" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3XFDiaA7JGon64Q0ibZTtCqrhqOw8b6ZcTLIicUkgZ7VA3fbXmPooOJkAw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3XFDiaA7JGon64Q0ibZTtCqrhqOw8b6ZcTLIicUkgZ7VA3fbXmPooOJkAw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span><span>2</span></span><span>细胞类型注释</span></h2><pre data-tool="mdnice编辑器"><span></span><code>library(SingleR)<br>library(celldex)<br>ref &lt;- celldex::HumanPrimaryCellAtlasData()<br>Mono.count=Mono[[<span>"RNA"</span>]]<span>@counts</span><br>common_gene &lt;- intersect(rownames(Mono.count), rownames(ref))<br>ref &lt;- ref[common_gene,]<br>Mono.count_forref &lt;- Mono.count[common_gene,]<br>Mono.count_forref.se &lt;- SummarizedExperiment(assays=list(counts=Mono.count_forref))<br>Mono.count_forref.se &lt;- logNormCounts(Mono.count_forref.se)<br><br>pred.main.ref &lt;- SingleR(test = Mono.count_forref.se, ref = ref, labels = ref$label.main)<br>result_main_ref &lt;- as.data.frame(pred.main.ref$labels)<br>result_main_ref$CB &lt;- rownames(pred.main.ref)<br>colnames(result_main_ref) &lt;- c(<span>'ref_Main'</span>, <span>'CB'</span>)<br>DimPlot(Mono, reduction = <span>"umap"</span>, group.by = <span>"ref_Main"</span>,label = TRUE,repel = TRUE,ncol=<span>1</span>)+<br>  DimPlot(Mono, reduction = <span>"umap"</span>,label = TRUE,repel = TRUE)&amp;<br>  theme(axis.line = element_blank(), axis.ticks= element_blank(),axis.text = element_blank())<br>## 注释回第一次降维聚类展示<br>metadata &lt;- scRNA<span>@meta</span>.data<br>metadata$cell_type &lt;- NA<br>metadata$cell_type &lt;- Mono<span>@meta</span>.data[match(rownames(scRNA<span>@meta</span>.data), rownames(Mono<span>@meta</span>.data)), <span>'ref_Main'</span>]<br>celltype_names &lt;- <span>NULL<br><span>for</span><span>(i in <span>1</span>:dim(metadata)</span>[1])</span>{<br>  # print(i)<br>  sub_data &lt;- metadata[i,]<br>  <span>if</span>(is.na(sub_data$cell_type)){<br>    # print(<span>'Change value'</span>)<br>    sub_data$cell_type &lt;- sub_data$RNA_snn_res<span>.0</span><span>.3</span><br>    celltype_names &lt;- c(celltype_names, sub_data$cell_type)<br>  }<span>else</span>{<br>    celltype_names &lt;- c(celltype_names, sub_data$cell_type)<br>  }<br>}<br>metadata$cell_type &lt;- celltype_names<br>metadata$cell_type &lt;- factor(metadata$cell_type)<br>scRNA<span>@meta</span>.data &lt;- <span>metadata <br><span>DimPlot</span><span>(scRNA,reduction = <span>"umap"</span>,group.by = <span>"cell_type"</span>,label = TRUE,repel = TRUE)</span>&amp;<br>  <span>theme</span><span>(axis.line = element_blank()</span>, axis.ticks</span>= element_blank(),axis.text = element_blank())<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.13510747185261" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3IcjvkBChZlLMNMeibHwXcD4WrYNQBbhBSVziblrwuDOxKibpMWo8OicCvw/640?wx_fmt=png" data-type="png" data-w="977" src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3IcjvkBChZlLMNMeibHwXcD4WrYNQBbhBSVziblrwuDOxKibpMWo8OicCvw/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.9342592592592592" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3wAibicicLyUNOibYd9QZ4ptaluv0RuVy83396y5HFAn93D7BXAF02FOOTw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3wAibicicLyUNOibYd9QZ4ptaluv0RuVy83396y5HFAn93D7BXAF02FOOTw/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span><span>3</span></span><span>slingshot推断细胞分化轨迹</span></h2><pre data-tool="mdnice编辑器"><span></span><code>BiocManager::install(<span>"slingshot"</span>)<br>library(slingshot)<br>BiocManager::install(<span>"tradeSeq"</span>)<br>library(tradeSeq)<br>library(BiocParallel)<br>#准备分析文件<br>sce &lt;- as.SingleCellExperiment(Mono, assay = <span>"RNA"</span>) # SCT<br>#run slingshot<br>sce_slingshot1 &lt;- slingshot(sce, #这里是SingleCellExperiment单细胞对象<br>                            reducedDim = <span>'UMAP'</span>, #降维方式<br>                            clusterLabels = sce$ref_Main.y) #celltype<br>                            #start.clus = <span>''</span>#轨迹起点<br>colors &lt;- colorRampPalette(brewer.pal(<span>11</span>,<span>'Spectral'</span>)[-<span>6</span>])(<span>100</span>)<br>plotcol &lt;- colors[cut(sce_slingshot1$slingPseudotime_1, breaks=<span>100</span>)]<br>plot(reducedDims(sce_slingshot1)$UMAP, col = plotcol, pch=<span>16</span>, asp = <span>1</span>, cex = <span>0.8</span>)<br>lines(SlingshotDataSet(sce_slingshot1), lwd=<span>2</span>, col=<span>'black'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.9351851851851852" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3Z64iaibQCRUUpFRbxYia7eE7hV3sCzgaYRX7TSRMib1POJG8MSiaxZOV6uA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3Z64iaibQCRUUpFRbxYia7eE7hV3sCzgaYRX7TSRMib1POJG8MSiaxZOV6uA/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span><span>4</span></span><span>CytoTRACE推断细胞干性</span></h2><pre data-tool="mdnice编辑器"><span></span><code>下载源文件https:<span>//cytotrace.stanford.edu/CytoTRACE_0.3.3.tar.gz</span><br>devtools::install_local(<span>"CytoTRACE_0.3.3.tar.gz"</span>)<br>library(CytoTRACE)<br>#检查是否有缺失值，<br>table(is.na(Mono$ref_Main.y))<br>#将其转换为字符型，并将其命名为 phenotype这个变量，用于后续的分析。<br>phenotype = as.character(Mono$ref_Main.y)<br>names(phenotype) &lt;- rownames(Mono<span>@meta</span>.data)<br>#将 Mono 对象中的 RNA 计数矩阵提取出来，并转换为一个普通的矩阵<br>mat &lt;- as.matrix(Mono<span>@assays</span>$RNA<span>@counts</span>)<br># 接着，用CytoTRACE 函数分化潜能评估<br>results &lt;- CytoTRACE(mat = mat,ncores = <span>1</span>) #可以多核运行<br># 使用umap的坐标映射干性得分<br>emb &lt;- Mono<span>@reductions</span>[[<span>"umap"</span>]]<span>@cell</span>.embeddings<br># plotCytoTRACE(results,<br>              phenotype = phenotype,#细胞类型注释<br>              emb = emb, <br>              outputDir = <span>"./"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.3453703703703704" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx34geXWogHM9sq06X1Dibvp61cR3A7M6ia9olEtS66tIwNUfbPKjrvaqRg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx34geXWogHM9sq06X1Dibvp61cR3A7M6ia9olEtS66tIwNUfbPKjrvaqRg/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span><span>5</span></span><span>基因拟时变化表达</span></h2><pre data-tool="mdnice编辑器"><span></span><code>slingsce&lt;-SlingshotDataSet(sce_slingshot1)<br>pseudotimeED &lt;- slingPseudotime(slingsce, na = FALSE)<br>cellWeightsED &lt;- slingCurveWeights(slingsce)<br>counts&lt;-sce_slingshot1<span>@assays</span><span>@data</span><span>@listData</span>$counts<br># 拟合负二项式模型确定nknots<br>icMat &lt;- evaluateK(counts = counts, <br>                   sds = slingsce, <br>                   nGenes = <span>50</span>,<br>                   k = <span>3</span>:<span>10</span>,<br>                   verbose = T, <br>                   plot = TRUE)<br>sce_slinghot &lt;- fitGAM(counts = counts, pseudotime = pseudotimeED, cellWeights = cellWeightsED, nknots = <span>5</span>, verbose = T<br>                       ,BPPARAM = MulticoreParam(<span>20</span>),parallel=T)<br># 与伪时间存在显著关联的基因<br>rowData(sce_slinghot)$assocRes &lt;- associationTest(sce_slinghot, lineages = TRUE, l2fc = log2(<span>2</span>))<br>assocRes &lt;- rowData(sce_slinghot)$assocRes<br>oAsso &lt;- order(assocRes$waldStat, decreasing = TRUE)<br>Geneasso &lt;- names(sce_slinghot)[oStart[<span>1</span>]]<br>plotSmoothers(sce_slinghot, assays(sce_slinghot)$counts,<br>                    gene =Geneasso, alpha = <span>0.6</span>, border = T, lwd = <span>2</span>)+<br>    ggtitle(Geneasso)<br># 谱系内比较<br>startRes &lt;- startVsEndTest(sce_slinghot,lineages=T)<br>oStart &lt;- order(startRes$waldStat, decreasing = TRUE)<br>sigGeneStart &lt;- names(sce_slinghot)[oStart[<span>1</span>]]<br>plotSmoothers(sce_slinghot, assays(sce_slinghot)$counts, gene = sigGeneStart)+<br>    ggtitle(sigGeneStart)<br>plotGeneCount(slingsce, assays(sce_slinghot)$counts, gene = sigGeneStart)+<br>    ggtitle(sigGeneStart)<br># 谱系间比较<br>endRes &lt;- diffEndTest(sce_slinghot,pairwise=T)<br>oEnd &lt;- order(endRes$waldStat, decreasing = TRUE)<br>sigGene &lt;- names(sce_slinghot)[o[<span>1</span>]]<br>plotSmoothers(sce_slinghot, assays(sce_slinghot)$counts, gene = sigGene)+<br>    ggtitle(sigGene)<br>plotGeneCount(slingsce, assays(sce_slinghot)$counts, gene = sigGene)+<br>    ggtitle(sigGene)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.65" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3OBE3dL2rib26Z1qAmGGrpWSeyz4alKT6CxFltcwGljEVFcLZbWEToeg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3OBE3dL2rib26Z1qAmGGrpWSeyz4alKT6CxFltcwGljEVFcLZbWEToeg/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.8046462513199577" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx32muMxWFTx6YI9DsibEdkW1tibsA2RmyPicfwpemO2VVrYSSqMic8mTUbHQ/640?wx_fmt=png" data-type="png" data-w="947" src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx32muMxWFTx6YI9DsibEdkW1tibsA2RmyPicfwpemO2VVrYSSqMic8mTUbHQ/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="1.0031512605042017" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3wOj3cOiajC7W29vg8dtvlgqDKCVsSz058ticBMG1x33WW9usW0KfpEfg/640?wx_fmt=png" data-type="png" data-w="952" src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3wOj3cOiajC7W29vg8dtvlgqDKCVsSz058ticBMG1x33WW9usW0KfpEfg/640?wx_fmt=png"></figure><h2 data-tool="mdnice编辑器"><span><span>6</span></span><span>通路富集评分拟时变化表达</span></h2><pre data-tool="mdnice编辑器"><span></span><code># 把表达矩阵换成通路富集评分的矩阵，以AUcell评分为例<br>library(AUCell)<br>library(clusterProfiler)<br>cells_rankings &lt;- AUCell_buildRankings(Mono<span>@assays</span>$RNA<span>@data</span>) <br>Hallmarker &lt;- read.gmt(<span>"h.all.v2023.1.Hs.symbols.gmt"</span>) <br>geneSets &lt;- lapply(unique(Hallmarker$term), <br>                   function(x){print(x);Hallmarker$gene[Hallmarker$term == x]})<br>names(geneSets) &lt;- unique(Hallmarker$term)<br>cells_AUC &lt;- AUCell_calcAUC(geneSets, cells_rankings, <br>                            aucMaxRank=nrow(cells_rankings)*<span>0.1</span>)<br>sc_AUC &lt;- getAUC(cells_AUC)<br>sce_slinghot &lt;- fitGAM(counts = sc_AUC, pseudotime = pseudotimeED, cellWeights = cellWeightsED, nknots = <span>5</span>, verbose = T<br>                       ,BPPARAM = MulticoreParam(<span>20</span>),parallel=T)<br>plotSmoothers(sce_slinghot, assays(sce_slinghot)$counts,<br>                    gene =<span>"HALLMARK_HYPOXIA"</span>, alpha = <span>0.6</span>, border = T, lwd = <span>2</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7981481481481482" data-src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3ROAuhKNJuwgnmSoHworNX5mzrXpU5gE8yb7PiaBmjhS24icl2k7KmXuw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/Ze2f5C6nc66nXAy5ibENGrfOe0JymWnx3ROAuhKNJuwgnmSoHworNX5mzrXpU5gE8yb7PiaBmjhS24icl2k7KmXuw/640?wx_fmt=png"></figure></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/9CQVyhjk7yvt9dGVbqMhbA",target="_blank" rel="noopener noreferrer">原文链接</a>
