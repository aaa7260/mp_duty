---
title: "ggkegg：使用ggplot语法绘制高度定制的通路图"
date: 2023-10-23T02:11:29Z
draft: ["false"]
tags: [
  "fetched",
  "微生信生物"
]
categories: ["Acdemic"]
---
ggkegg：使用ggplot语法绘制高度定制的通路图 by 微生信生物
------
<div><p>[toc]</p><h2>写在前面</h2><p>有一天我在逛推特的时候看到了一个外国友人推荐这个R包，ggkegg，寥寥几个字我便感觉到这个包应该很有意思，所以在我们大数据搬家的期间我还是进行了这个包的一个了解和学习。</p><p>在学习之前我们首先明白ggkegg是将整个通路作为一个网络的形式展示的，借用了tidygraph和igrapg网络格式，所以在学习之前我给打击附上一批代码，了解一下tidygraph格式。</p><h2>实战 tidygraph格式处置</h2><h3>如何构建并操作tidygraph格式</h3><p>tidygraph中有很多特殊网络的构建函数，例如下面的create_ring就是构建一个环</p><pre><code>library(tidygraph)<br>create_ring(10)</code></pre><p>通过节点和边文件构建tidygraph对象</p><pre><code>#  理解数据格式，也就是理解网络的构成。网络主要是由节点和边组成的<br><br>#  学习构建网络数据结构<br>set.seed(0)<br>edges &lt;- data.frame(from = sample(1:15, 80, replace = TRUE), <br>                    to = sample(1:15, 80, replace = TRUE), <br>                    stringsAsFactors = FALSE) %&gt;% <br>distinct()<br>head(edges)<br><br># 对边加上属性，例如加上边的颜色，加上边的权重，<br>edges &lt;- data.frame(edges, <br>                    edge.width = rnorm(n = nrow(edges), mean = 1, sd = 0.5), <br>                    edge.colour = rnorm(n = nrow(edges), mean = 0, sd = 0.5),<br>                    stringsAsFactors = FALSE)<br>edges %&gt;% head<br>#  提取出来节点数据<br>node &lt;- unique(c(edges$from, edges$to)) %&gt;% sort()<br>node<br>#  给节点增加属性<br>nodes &lt;- data.frame(node, node.size = rnorm(n = length(node), mean = 1, sd = 0.5),<br>                    node.colour = sample(c("Class A", "Class B"), length(node), replace = TRUE), <br>                    stringsAsFactors = FALSE)<br>nodes %&gt;% head<br>#  构建tbl_graph对象<br>graph_data &lt;- tidygraph::tbl_graph(nodes = nodes, edges = edges, <br>                                   directed = FALSE)<br>graph_data<br>#  明白了如何构建tbl_graph对象之后，需要学会如何操作该对象<br><br>#  激活操作节点或者边<br>str(graph_data)<br>graph_data %&gt;% <br>  activate(nodes)<br><br>graph_data %&gt;% <br>  activate(edges)</code></pre><p>通过聚类结构转化网络结构</p><pre><code># 通过聚类结构转化网络结构<br>iris_clust &lt;- hclust(dist(iris[1:4]))<br>iris_tree &lt;- as_tbl_graph(iris_clust)<br>iris_tree<br><br>iris_tree %&gt;% activate(edges)<br><br>as_tibble(iris_tree)$label<br><br>as.character(iris$Species)[108]</code></pre><p>操作tidygraph对象，参考tidy家族数据处理方式，这也将风靡下一个十载，大家一定要学习；</p><pre><code>iris_tree &lt;- iris_tree %&gt;% <br>  activate(nodes) %&gt;% <br>  dplyr::mutate(label = as.numeric(label)) %&gt;% # 如何转化字符类型<br>  dplyr::mutate(Species = ifelse(leaf, as.character(iris$Species)[label], NA)) %&gt;% #如何增加列<br>  activate(edges) %&gt;% # 操作边文件 .N()代表了节点文件；.N()$Species代表提取节点文件中的Species列<br>  mutate(to_setose = .N()$Species[to] == 'setosa') # 添加指定节点的注释信息<br>iris_tree</code></pre><p>注意.E() 代表边文件，.G()代表整个网络文件自己此外，网络数据处理同样可以使用filter()/slice() 函数，也可以通过 arrange() 进行节点排序</p><pre><code>library(dplyr)<br>iris_sum &lt;- iris %&gt;% <br>  group_by(Species) %&gt;% <br>  summarise_all(mean) %&gt;% <br>  ungroup()<br><br>#  给node表格添加注释信息<br>iris_tree &lt;- iris_tree %&gt;% <br>  activate(nodes) %&gt;% <br>  left_join(iris_sum)<br>iris_tree<br><br>?create_notable<br><br>library(ggraph)<br>#  创建两个网络<br>gr1 &lt;- create_notable('bull') %&gt;% <br>  mutate(name = letters[1:5])<br>gr2 &lt;- create_ring(5) %&gt;% <br>  mutate(name = letters[4:8])</code></pre><p>合并网络图，这里提到的多个合并方法是我们做微生物组会经常用到的</p><pre><code>#bind_graphs 用于将两个网络对象绘制到同一个画布上，但是各自是独立的，可用于网络组图<br>gr1 %&gt;% bind_graphs(gr2) %&gt;% <br>  ggraph(layout = 'kk') + <br>  geom_edge_link() + <br>  geom_node_point(size = 8, colour = 'steelblue') +<br>  geom_node_text(aes(label = name), colour = 'white', vjust = 0.4) + <br>  ggtitle('Binding graphs') + <br>  theme_graph()<br><br># graph_join 会合并网络，相同点重合<br>gr1 %&gt;% graph_join(gr2) %&gt;% <br>  ggraph(layout = 'kk') + <br>  geom_edge_link() + <br>  geom_node_point(size = 8, colour = 'steelblue') +<br>  geom_node_text(aes(label = name), colour = 'white', vjust = 0.4) + <br>  ggtitle('Joining graphs') + <br>  theme_graph()<br><br>#  节点修改与保护<br>gr1 &lt;- create_star(6, directed = TRUE)<br>layout &lt;- create_layout(gr1, layout = 'fr')<br>gr1%&gt;% <br>  ggraph(layout = 'kk') + <br>  geom_edge_link() + <br>  geom_node_point(size = 8) +<br>  theme_graph()<br><br>gr1 &lt;- gr1 %&gt;% <br>  mutate(x = layout$x, y = layout$y, graph = 'original')<br>gr2 &lt;- gr1 %&gt;% <br>  mutate(graph = 'reverse') %&gt;% <br>  activate(edges) %&gt;% <br>  reroute(from = to, to = from)<br>gr3 &lt;- gr1 %&gt;% <br>  mutate(graph = 'using subset') %&gt;% <br>  activate(edges) %&gt;% <br>  reroute(from = to + 1, subset = to &lt; 4)# 操作边<br>#  虽然我们可以通过bind_graphs合并图形，但是是无须的，不能很好作为组图功能使用<br>ggraph(bind_graphs(gr1, gr2, gr3), layout = 'kk') + <br>  geom_edge_link(arrow = arrow()) + <br>  # facet_nodes(~graph) + # 通过分面可以根据标签将合并的图形拆分开<br>  theme_graph(foreground = 'steelblue')<br><br># 使用分面就可以完美实现组图功能<br>ggraph(bind_graphs(gr1, gr2, gr3), layout = 'nicely') + <br>  geom_edge_link(arrow = arrow()) + <br>  facet_nodes(~graph) + # 通过分面可以根据标签将合并的图形拆分开<br>  theme_graph(foreground = 'steelblue')</code></pre><h2>实战2 ggkegg的实战</h2><pre><code>#清空内存#######<br>rm(list=ls())</code></pre><p>建议使用pacman管理R包</p><pre><code>library(pacman)<br>p_load(ggkegg)<br>p_load(ggfx)<br>p_load(igraph)<br>p_load(tidygraph)<br>p_load(dplyr)<br># p_unload(dplyr)# 从环境中去除R包；有些R包功能冲突的条件下要使用<br><br>#  ko代表了大一级的通路<br># M代表了特定的代谢，更细一些；<br><br>#  了解kegg数据结构--套用的tiaygraph的数据结构<br>da = pathway("ko00640")<br><br>#  这是"tbl_graph" "igraph" 两种格式<br>class(da)<br>is.tbl_graph(da)<br><br>#  更多操作<br>#  kegg通路中最基础也是最复杂的通路<br># pathway("ko01100") <br>?process_line<br><br>gm_test &lt;- create_test_pathway(line=TRUE)<br>test &lt;- process_line(gm_test)# 转化为坐标体系</code></pre><p>一下我们通过三个例子学习一下ggkegg</p><p>第一个例子：绘制最为基本也是最复杂的通路</p><pre><code># 第一个例子：绘制最为基本也是最复杂的通路<br>p = pathway("ko01100") |&gt;<br>  process_line() |&gt;<br>  highlight_module(module("M00021")) |&gt;<br>  highlight_module(module("M00338")) |&gt;<br>  ggraph(x=x, y=y) +<br>  geom_node_point(size=1, aes(color=I(fgcolor),<br>                              filter=fgcolor!="none" &amp; type!="line"))+<br>  geom_edge_link0(width=0.1, aes(color=I(fgcolor),<br>                                 filter=type=="line"&amp; fgcolor!="none"))+<br>  with_outer_glow(<br>    geom_edge_link0(width=1,<br>                    aes(color=I(fgcolor),<br>                        filter=(M00021 | M00338))),<br>    colour="red", expand=5<br>  )+<br>  with_outer_glow(<br>    geom_node_point(size=1.5,<br>                    aes(color=I(fgcolor),<br>                        filter=(M00021 | M00338))),<br>    colour="red", expand=5<br>  )+<br>  geom_node_text(size=2,<br>                 aes(x=x, y=y,<br>                     label=graphics_name,<br>                     filter=name=="path:ko00270"),<br>                 repel=TRUE, family="sans", bg.colour="white")+<br>  theme_void()<br><br>ggsave("cs.pdf",p,width = 18,height = 12)</code></pre><p><img data-galleryid="" data-ratio="0.6666666666666666" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/wJzLDA3fpphfA0RPjJfGmPwob63kk1aHPZT1x5xwYL1R18LzDsPXdZLLFvzqEkOGpApoUG7HI3fsqLQXVFTQuA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/wJzLDA3fpphfA0RPjJfGmPwob63kk1aHPZT1x5xwYL1R18LzDsPXdZLLFvzqEkOGpApoUG7HI3fsqLQXVFTQuA/640?wx_fmt=png"></p><p>第二个例子：添加通路手绘图</p><pre><code># 第二个例子：添加通路手绘图<br>m &lt;- module("M00013")<br># 如何高亮节点<br>g &lt;- pathway("ko00640") |&gt; mutate(<br>  mod=highlight_set_nodes(m@reaction_components,how="all"))<br><br>gg &lt;- ggraph(g, layout="manual", x=x, y=y)+<br>  geom_node_rect(fill="grey",aes(filter=type=="ortholog"))+ # 节点加上方块阴影<br>  overlay_raw_map("ko00640")+ # 叠加通路的手绘图<br>  geom_node_point(aes(filter=type=="compound"), shape=21, <br>                  fill="blue", color="black", size=2)+ # 节点设定圆点，颜色填充蓝色<br>  ggfx::with_outer_glow(geom_node_point(aes(filter=mod, x=x, y=y), color="red",size=2),<br>                        colour="yellow",expand=5)+ # 高亮，这里借用的ggfx包进行添加<br>  theme_void()<br>gg<br><br>ggsave("ps.pdf",gg,width = 10,height = 7)</code></pre><p><img data-galleryid="" data-ratio="0.6092592592592593" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/wJzLDA3fpphfA0RPjJfGmPwob63kk1aHpJA6WB2ibE0dG1RvnM73SnIbqB4C5Nno7yWgKY2XAl2eH93nknxLM5Q/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/wJzLDA3fpphfA0RPjJfGmPwob63kk1aHpJA6WB2ibE0dG1RvnM73SnIbqB4C5Nno7yWgKY2XAl2eH93nknxLM5Q/640?wx_fmt=png"></p><p>第三个例子：ggkegg整合ggraph功能</p><pre><code>#  第三个例子：ggkegg整合ggraph功能<br>g &lt;- pathway("hsa04110")<br><br>pseudo_lfc &lt;- sample(seq(0,3,0.1), length(V(g)), replace=TRUE)<br>names(pseudo_lfc) &lt;- V(g)$name<br><br>ggkegg("hsa04110",<br>       convert_org = c("pathway","hsa","ko"),<br>       numeric_attribute = pseudo_lfc)+<br>  geom_edge_parallel2(<br>    aes(color=subtype_name),<br>    arrow = arrow(length = unit(1, 'mm')), <br>    start_cap = square(1, 'cm'),<br>    end_cap = square(1.5, 'cm')) + <br>  geom_node_rect(aes(filter=.data$type=="group"),<br>                 fill="transparent", color="red")+<br>  geom_node_rect(aes(fill=numeric_attribute,<br>                     filter=.data$type=="gene"))+<br>  geom_node_text(aes(label=converted_name,<br>                     filter=.data$type == "gene"),<br>                 size=2.5,<br>                 color="black")+ # 不同模块填充不同颜色<br>  with_outer_glow(geom_node_text(aes(label=converted_name,<br>                                     filter=converted_name=="PCNA"),<br>                                 size=2.5, color="red"),<br>                  colour="white",<br>                  expand=4)+<br>  scale_edge_color_manual(values=viridis::plasma(11))+<br>  scale_fill_viridis(name="LFC")+<br>  theme_void()</code><p><img data-galleryid="" data-ratio="0.6592592592592592" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/wJzLDA3fpphfA0RPjJfGmPwob63kk1aH0HYrXpicmbTUUvicVH8oXpCyib8XpdgibXjWhFvc9FibM3k1eVvwxGafjzA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/wJzLDA3fpphfA0RPjJfGmPwob63kk1aH0HYrXpicmbTUUvicVH8oXpCyib8XpdgibXjWhFvc9FibM3k1eVvwxGafjzA/640?wx_fmt=png"></p><pre><pre><h3>根际互作生物学研究室 简介</h3><p><strong>根际互作生物学研究室</strong>是沈其荣院士土壤微生物与有机肥团队下的一个关注于根际互作的研究小组。本小组由袁军副教授带领，主要关注：1.植物和微生物互作在抗病过程中的作用；2 环境微生物大数据整合研究；3 环境代谢组及其与微生物过程研究体系开发和应用。团队在过去三年中在 <em>Nature Communication，</em><em>ISME J，Microbiome，SCLS，<em>New Phytologist，<em>iMeta，</em></em>Fundamental Research， PCE，SBB，JAFC（封面），Horticulture Research，SEL（封面），BMC plant biology</em>等期刊上发表了多篇文章。欢迎关注 微生信生物 公众号对本研究小组进行了解。</p><p><br></p><p>撰写：文涛<span></span><span></span></p><p>修改：<span>文</span><span>涛</span></p><p>审核：袁军</p></pre><pre><h3>团队工作及其成果 （点击查看）</h3><h3>了解 交流 合作</h3><p><br></p><p><img data-galleryid="" data-ratio="0.4601851851851852" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/wJzLDA3fppgUZPTlXP1TQM7NTibagGMMCj7PRykL4td1lvfT9RL3R30lZcadYPBlibcia1GhWSJUP2lrrRgSS44TA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/wJzLDA3fppgUZPTlXP1TQM7NTibagGMMCj7PRykL4td1lvfT9RL3R30lZcadYPBlibcia1GhWSJUP2lrrRgSS44TA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"><br></p></pre></pre></pre><ul><ul><li><p>小组负责人邮箱 袁军：junyuan@njau.edu.cn；</p></li><li><p>小组成员文涛：taowen@njau.edu.cn；</p></li><li><p>团队公众号：微生信生物 添加主编微信，或者后台留言。<span></span></p></li><h3><br></h3><h3>加主编微信 加入群聊</h3><p><strong>目前营销人员过多，为了维护微生信生物3年来维护的超5500人群聊，目前更新进群要求：</strong></p><ul><li><p><strong>1</strong>.仅限相关专业或研究方向人员添加，必须实名，不实名则默认忽略。</p></li><li><p><strong>2</strong>.非相关专业的其他人员及推广宣传人员禁止添加。</p></li><li><p><strong>3</strong>.添加主编微信需和简单聊一聊专业相关问题，等待主编判断后，可拉群。</p></li><li><p><strong>4 </strong>微生信生物VIP微信群不受限制，给微生信生物供稿一次即可加入（群里发送推文代码+高效协助解决推文运行等问题+日常问题咨询回复）。</p></li></ul><li><p><a href="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;album_id=1629781174103441409&amp;__biz=MzUzMjYyMDE2OQ==#wechat_redirect" data-linktype="2">团队关注</a></p></li><li><p><a href="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;album_id=1629787949699563523&amp;__biz=MzUzMjYyMDE2OQ==#wechat_redirect" data-linktype="2">团队文章成果</a></p></li><li><p><a href="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;album_id=1398834972110487553&amp;__biz=MzUzMjYyMDE2OQ==#wechat_redirect" data-linktype="2">团队成果-EasyStat专题</a></p></li><li><p><a href="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;album_id=1408207832063016960&amp;__biz=MzUzMjYyMDE2OQ==#wechat_redirect" data-linktype="2">ggClusterNet专题</a></p></li><li><p><a href="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;album_id=1463992472430051330&amp;__biz=MzUzMjYyMDE2OQ==#wechat_redirect" data-linktype="2">袁老师小小组</a></p></li></ul></ul><code><br></code><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/U-_0OgHdY1yjNzZ0E3nHrw",target="_blank" rel="noopener noreferrer">原文链接</a>
