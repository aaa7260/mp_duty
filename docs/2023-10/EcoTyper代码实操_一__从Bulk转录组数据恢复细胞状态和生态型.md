---
title: "EcoTyper代码实操（一）：从Bulk转录组数据恢复细胞状态和生态型"
date: 2023-10-25T04:23:13Z
draft: ["false"]
tags: [
  "fetched",
  "生信宝库"
]
categories: ["Acdemic"]
---
EcoTyper代码实操（一）：从Bulk转录组数据恢复细胞状态和生态型 by 生信宝库
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span></h2><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span><span>前言</span></h2><p data-tool="mdnice编辑器">EcoTyper是一款以机器学习为基础框架的分析工具，能够从Bulk、单细胞、以及空间分辨率的基因表达数据中大规模地识别并验证细胞状态和生态型。Immugent在前两期的推文中：<a href="https://mp.weixin.qq.com/s?__biz=MzI4MjY5ODI1Nw==&amp;mid=2247489413&amp;idx=1&amp;sn=83a74ef4e0a9f2e513d945dc346200bf&amp;chksm=eb94a0fbdce329ed8d34357df3724081e7e6a0b535ac82f094f9afedcdac02ace84823de1edf&amp;token=348825747&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">EcoTyper：识别肿瘤中各种细胞的生态位-实体肿瘤</a>；<a href="https://mp.weixin.qq.com/s?__biz=MzI4MjY5ODI1Nw==&amp;mid=2247489492&amp;idx=1&amp;sn=306534b8bd80b5f957110462abb7b6a9&amp;chksm=eb94a0aadce329bcfee7e34f9cd968fc393aaf873b827538c8eaa66e540e30b62b9208681783&amp;token=348825747&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">EcoTyper：识别肿瘤中各种细胞的生态位-血液肿瘤</a>，分别介绍了EcoTyper的功能框架，以及其在肿瘤中的应用。我们可以发现基于EcoTyper识别的细胞状态和生态型对疾病的发生发展和预后都是至关重要的。从本期推文开始，我们将与大家一起学习EcoTyper的代码实操部分。</p><p data-tool="mdnice编辑器">EcoTyper的代码实操主要分为6个部分：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6134328358208955" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5ghcH6TYsoZBkFUPq8oFyt0tYlnN7zia6YWhw5ibfHfwWswSPCkricpeqA/640?wx_fmt=png" data-type="png" data-w="670" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5ghcH6TYsoZBkFUPq8oFyt0tYlnN7zia6YWhw5ibfHfwWswSPCkricpeqA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">由于EcoTyper的功能是十分全面的，我们将用6期推文结合代码实操介绍EcoTyper的使用方法。那么，今天让我们一起来学习一下它的第一个部分——<strong>Recovery of Cell States and Ecotypes in User-Provided Bulk Data</strong></p><p data-tool="mdnice编辑器"><strong><br></strong></p><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span><span>代码流程</span></h2><h3 data-tool="mdnice编辑器"><span></span><span>1.准备环境和数据</span><span></span></h3><h5 data-tool="mdnice编辑器"><span></span>下载 EcoTyper<span></span></h5><pre data-tool="mdnice编辑器"><code>wget https://github.com/digitalcytometry/ecotyper/archive/refs/heads/master.zip<br>unzip master.zip<br><span>cd</span> ecotyper-master<br><span>#EcoTyper是一个独立的软件，用R实现，但并不是R包哦。</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span>R环境准备：<span></span></h5><p data-tool="mdnice编辑器"><img data-ratio="0.19219653179190752" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5EViboiaLb9GdaNibArlKic358CiaNVchAAfaLrAQpibRCceGfBRtgWxtic7QA/640?wx_fmt=png" data-type="png" data-w="692" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5EViboiaLb9GdaNibArlKic358CiaNVchAAfaLrAQpibRCceGfBRtgWxtic7QA/640?wx_fmt=png">这是官网推荐的R和R包版本，但是小编用的最新的R版本，并且安装相应最新版本的R包也是很顺利的。</p><pre data-tool="mdnice编辑器"><code>install.packages(c(<span>"RColorBrewer"</span>,<span>"cluster"</span>, <span>"circlize"</span>,<span>"cowplot"</span>,<span>"data.table"</span>,<span>"doParallel"</span>,<span>"ggplot2"</span>,<span>"grid"</span>, <span>"reshape2"</span>, <span>"viridis"</span>,<span>"config"</span>,<span>"argparse"</span>,<span>"colorspace"</span>, <span>"plyr"</span>))<br>BiocManager::install(<span>"ComplexHeatmap"</span>)<br>BiocManager::install(<span>"Biobase"</span>)<br>BiocManager::install(<span>"NMF"</span>)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>输入数据：<span></span></h5><ol data-tool="mdnice编辑器"><li><section>表达谱数据：来源于TCGA的LUAD部分样本的表达谱数据，数据存储在<code>example_data/bulk_lung_data.txt</code>中。</section></li></ol><figure data-tool="mdnice编辑器"><img data-ratio="0.12946428571428573" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5Kq5Rz4Uqq6NteaBX9K6e9400kR1jiclxPhVjbSD8I8ibXEq2U6KkeO1g/640?wx_fmt=png" data-type="png" data-w="672" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5Kq5Rz4Uqq6NteaBX9K6e9400kR1jiclxPhVjbSD8I8ibXEq2U6KkeO1g/640?wx_fmt=png"></figure><ol start="2" data-tool="mdnice编辑器"><li><section>样本注释文件，数据存储在<code>example_data/bulk_lung_annotation.txt</code>。</section></li></ol><figure data-tool="mdnice编辑器"><img data-ratio="0.16470588235294117" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5TcZbpx5BaMef6ONCHNMs53fbf9GAqwB7YaI983UQlE3buwoVLbt2JQ/640?wx_fmt=png" data-type="png" data-w="680" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5TcZbpx5BaMef6ONCHNMs53fbf9GAqwB7YaI983UQlE3buwoVLbt2JQ/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span><span>2.recovery scripts</span><span></span></h3><p data-tool="mdnice编辑器"><code>EcoTyper_recovery_bulk.R</code>脚本用于在Bulk数据中恢复细胞状态和生态型。</p><pre data-tool="mdnice编辑器"><code>Rscript EcoTyper_recovery_bulk.R -h<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>参数详解：<span></span></h5><ul data-tool="mdnice编辑器"><li><section><code>-d</code>或<code>--discovery</code>：用于定义细胞状态和生态型的发现数据集的名称。可以选择的值包括'Carcinoma'（恶性肿瘤数据集）和'Lymphoma'（淋巴瘤数据集），也可以使用在运行EcoTyper发现脚本时配置文件中的自定义数据集名称。默认值为'Carcinoma'。</section></li><li><section><code>-m</code>或<code>--matrix</code>：输入bulk组织表达矩阵的文件路径，该文件需要以制表符分隔，其中第一列是基因名称，列名是样本。这是必需参数。</section></li><li><section><code>-a</code>或<code>--annotation</code>：输入矩阵中样本注释的文件路径，该文件也需要是制表符分隔的。文件中必须包含一个名为'ID'的列，其中包含与输入矩阵中的样本标识相同的ID，以及其他附加列。可选参数，默认值为'NULL'。</section></li><li><section><code>-c</code>或<code>--columns</code>：用于指定在输出热图中作为颜色条形图显示的注释文件中的列名的逗号分隔列表。可选参数，默认为'NULL'。</section></li><li><section><code>-t</code>或<code>--threads</code>：线程数，默认值为10。如果在windows下运行只能指定1。</section></li><li><section><code>-o</code>或<code>--output</code>：指定输出结果的目录路径，默认值为'RecoveryOutput'。</section></li><li><section><code>-h</code>或<code>--help</code>：打印帮助信息。</section></li></ul><h5 data-tool="mdnice编辑器"><span></span>运行脚本：<span></span></h5><pre data-tool="mdnice编辑器"><code>Rscript EcoTyper_recovery_bulk.R -d Carcinoma -m example_data/bulk_lung_data.txt -a example_data/bulk_lung_annotation.txt -c Tissue -o RecoveryOutput<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>3.结果解读</span><span></span></h3><p data-tool="mdnice编辑器"><img data-ratio="0.8772893772893773" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5GCyOfG3t1Uk6jNa1vRq8AvEJF0w6l8cXyda6esaRGXQWYgw91OViaeQ/640?wx_fmt=png" data-type="png" data-w="546" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5GCyOfG3t1Uk6jNa1vRq8AvEJF0w6l8cXyda6esaRGXQWYgw91OViaeQ/640?wx_fmt=png">可以看出结果主要分为两部分：各类型细胞的细胞状态恢复和生态型恢复。</p><h5 data-tool="mdnice编辑器"><span></span>细胞状态部分输出结果：<span></span></h5><p data-tool="mdnice编辑器">我们以成纤维细胞为例看下细胞状态恢复部分的结果。<img data-ratio="0.3309248554913295" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC52Vbj163PY8tglUhem8PLeeOM4EVLI5XSsZ1ESEYtViccv44ibsgiab6Tg/640?wx_fmt=png" data-type="png" data-w="692" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC52Vbj163PY8tglUhem8PLeeOM4EVLI5XSsZ1ESEYtViccv44ibsgiab6Tg/640?wx_fmt=png"></p><ul data-tool="mdnice编辑器"><li><section>state_assignment_heatmap.pdf/png:展示了在每个细胞状态中具有最高 log2 FC的基因的表达情况，这些基因被称为细胞状态特异性标记基因。热图的列代表了发现数据集中的样本，行代表了每个细胞状态的标记基因。所选的标记基因显示在热图的左侧。</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.7138728323699421" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5J5vYdzrh0AUQMKZo8qAYl5aR63od3QQMNjiaLgXwQJYmcpfibvrTHNVA/640?wx_fmt=png" data-type="png" data-w="692" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5J5vYdzrh0AUQMKZo8qAYl5aR63od3QQMNjiaLgXwQJYmcpfibvrTHNVA/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section>"state_assignment.txt"：发现数据集中每个样本的细胞状态。如果在质量控制步骤中过滤掉了给定样本中具有最高丰度的细胞状态，那么该样本将被视为未分配，不包括在此输出文件中。<code>基于这个文件，我们可以将细胞状态与临床结果（如患者的生存时间）进行关联研究。即使用 Kaplan-Meier 曲线和 log-rank 检验比较数据集中富集于不同的细胞状态的患者整体生存之间是否有差异。</code></section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.2828096118299446" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5zFBwa4GwyUHDarXTEqia5BcMwFrkfZBJFrZRZxj4ogW7VVcnfzy70HQ/640?wx_fmt=png" data-type="png" data-w="541" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5zFBwa4GwyUHDarXTEqia5BcMwFrkfZBJFrZRZxj4ogW7VVcnfzy70HQ/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section>"state_abundances.txt"：每个样本中每种细胞状态的相对丰度信息。"state_assignment.txt"文件只包含已分配到某种细胞状态的样本，而"state_abundances.txt"文件包括了发现数据集中的所有样本。这个文件提供了每个细胞状态在每个样本中的相对丰度信息。<code>"state_abundances.txt" 或 "ecotype_abundance.txt" 都包含了输入数据集中的所有样本。我们可以基于这两个文件进行一些下游分析。我们将细胞状态或生态型的相对丰度视为一个连续变量，使用R包 survival 中的 coxph 函数构建 Cox 比例风险回归模型评估细胞状态与总体生存之间的关系（保护因素/风险因素）。除了 Cox 回归外，还可以应用在基因集富集分析、配体-受体相互作用以及与免疫疗法关联等其他下游分析中。</code></section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.157514450867052" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5F5fcJ2aDGubNMSee7ic796Hg3O3JNlkpoq97OhUsyOGxgV1KwOIMUXg/640?wx_fmt=png" data-type="png" data-w="692" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5F5fcJ2aDGubNMSee7ic796Hg3O3JNlkpoq97OhUsyOGxgV1KwOIMUXg/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section>"heatmap_data.txt"：热图 "state_assignment_heatmap" 对应数据。经过标准化处理的基因的表达水平。列代表样本，行代表了每个细胞状态的标志基因。</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.1476121562952243" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5EyyibJrD3qE3jkFXlZOs1Rqccxd1OzkTrgP0YJYnyia7V94Qw3pmRFjQ/640?wx_fmt=png" data-type="png" data-w="691" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5EyyibJrD3qE3jkFXlZOs1Rqccxd1OzkTrgP0YJYnyia7V94Qw3pmRFjQ/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section>"heatmap_top_ann.txt"：用户提供的注释文件与细胞状态相关的信息的整合。只有被分配到主要细胞状态的样本才会包含在这个文件中。</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.14182344428364688" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5iaYhjNEibS0W98agic8qFX9FWALZtFGFrSsP0ib6icYibezwy1ibPaGibAdZNg/640?wx_fmt=png" data-type="png" data-w="691" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5iaYhjNEibS0W98agic8qFX9FWALZtFGFrSsP0ib6icYibezwy1ibPaGibAdZNg/640?wx_fmt=png"></figure><h5 data-tool="mdnice编辑器"><span></span>生态型部分输出结果：<span></span></h5><figure data-tool="mdnice编辑器"><img data-ratio="0.18786127167630057" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5wO1JBeOzu2FZSv1p01LpwP61fYPFpIFY8yic13jJgDSibUkRpnOBSnLQ/640?wx_fmt=png" data-type="png" data-w="692" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5wO1JBeOzu2FZSv1p01LpwP61fYPFpIFY8yic13jJgDSibUkRpnOBSnLQ/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section>"ecotype_abundance.txt"：在发现数据集中的每个生态型（ecotype）相对丰度的信息。</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.1531791907514451" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5IU9p7g5Cvliaibg1yVTJo0Om5ibRibQiaokBQI8GVF2L8QKAtP1eTciaTVTA/640?wx_fmt=png" data-type="png" data-w="692" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5IU9p7g5Cvliaibg1yVTJo0Om5ibRibQiaokBQI8GVF2L8QKAtP1eTciaTVTA/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section>"ecotype_assignment.txt"：发现数据集中的样本分配到各个生态型的信息。未被分配到任何生态型的样本将从该文件中被过滤掉。</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.08827785817655572" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5iafzy1ggVXCicZeZX0h4ic99mzZdCibylUsZn9j82NaiaodZfPbPqN6CKqw/640?wx_fmt=png" data-type="png" data-w="691" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC5iafzy1ggVXCicZeZX0h4ic99mzZdCibylUsZn9j82NaiaodZfPbPqN6CKqw/640?wx_fmt=png"></figure><ul data-tool="mdnice编辑器"><li><section>"heatmap_assigned_samples_viridis.pdf/png"：EcoTyper推断出的细胞状态分数的热图，这些细胞状态被分配到生态型中。</section></li></ul><figure data-tool="mdnice编辑器"><img data-ratio="0.6994219653179191" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC50SGDaic5aUjRj5S09mZU59SXx4CKHaL1ic3as1pOh5unkkycXeXnFV6w/640?wx_fmt=png" data-type="png" data-w="692" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7eSgXEO5Ktw3UoJosCDnmC50SGDaic5aUjRj5S09mZU59SXx4CKHaL1ic3as1pOh5unkkycXeXnFV6w/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span><span>4.血液肿瘤中恢复细胞状态和生态型</span><span></span></h3><p data-tool="mdnice编辑器">以上部分展示了如何在实体肿瘤中恢复细胞状态和生态型，我们也可以调整参数，实现在血液肿瘤中恢复细胞状态和生态型哦。</p><pre data-tool="mdnice编辑器"><code>Rscript EcoTyper_recovery_bulk.R -d Lymphoma -m example_data/bulk_lymphoma_data.txt -a example_data/bulk_lymphoma_annotation.txt -c schmitz_labels,COO -o RecoveryOutput -t 10<br></code></pre><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span><span>小结</span></h2><p data-tool="mdnice编辑器">在本期推文中，我们介绍了如何使用EcoTyper对Bulk转录组数据恢复细胞状态和生态型。EcoTyper不仅功能强大，而且使用起来很方便，运行速度也是很快的。此外，EcoTyper所生成的输出数据十分详尽，为我们提供了丰富的信息，可以用于各种后续分析。并且其输出的可视化结果也是十分精美的，感兴趣的小伙伴快来用起来吧~</p><p data-tool="mdnice编辑器">好啦，本期的分享到这里就结束了，我们下期再会~</p></section><p data-tool="mdnice编辑器"><br></p><hr data-tool="mdnice编辑器"></section><p><img data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/GL6g5Y3aR7eUr3zZytdDPl7kPJBscWxTDlwbSxRjmMoYpSCSmlGicFibnLH3pvictSibFwekOaooibv9Ria0zSCrC2icg/640?wx_fmt=jpeg" data-type="jpeg" data-w="344" src="https://mmbiz.qpic.cn/mmbiz_jpg/GL6g5Y3aR7eUr3zZytdDPl7kPJBscWxTDlwbSxRjmMoYpSCSmlGicFibnLH3pvictSibFwekOaooibv9Ria0zSCrC2icg/640?wx_fmt=jpeg"></p><h3 data-tool="mdnice编辑器"><span>关注下方公众号下回更新不迷路</span></h3><section><br></section><section><mp-common-profile data-pluginname="mpprofile" data-weui-theme="light" data-id="MzI4MjY5ODI1Nw==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7f0yanILMQZCnw1duTMROQRvgDqVjlYcrljTRy1E4ZLppLG6zicdd3h0IwjLpxnum1V5KsowibJM1sw/0?wx_fmt=png" data-nickname="生信宝库" data-alias="sxbk2020" data-signature="本公众号只用于生信知识的收集与传播，以及生信人之间互相交流和学习，不会涉及任何商业利益。本公众号各小编平时忙于科研，更新文章较其它同类型公众号较慢，但保持宁缺毋滥的本心，只更新对大家有用的推文。" data-from="2" data-is_biz_ban="0"></mp-common-profile></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/g0M2vLigIsW9jzkYa9t4HQ",target="_blank" rel="noopener noreferrer">原文链接</a>
