---
title: "巨噬细胞新分类体系（一篇Science文献复现）"
date: 2023-10-19T06:15:29Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
巨噬细胞新分类体系（一篇Science文献复现） by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span>❝</span><p>之前看到了曾老师写的关于巨噬细胞新分类体系（放弃传统M1和M2）的一篇推文，想起来自己之前写的推文对于巨噬细胞分类一直是按照M1和M2来的，主要是依据CD86和CD163的表达量来区分。正如这篇推文写的，巨噬细胞可以分类成为2个 （TREM2和FOLR2基因的排他性），<strong>「同时曾老师留了一个学徒作业，我今天这周推文就是来尝试做一下这个学徒作业。」</strong></p><span>❞</span></blockquote><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524627&amp;idx=1&amp;sn=8b22bc888f19f1426830cd6e28c1a683&amp;scene=21#wechat_redirect" data-linktype="2">巨噬细胞新分类体系（放弃传统M1和M2)</a></p><figure data-tool="mdnice编辑器"><img data-ratio="0.5141187925998053" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ9fdgQnWjusRw8BImSnmhBTege9G61ub0bs8wFHEl8gQX6kA8FicJ5v4A/640?wx_fmt=png" data-type="png" data-w="1027" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ9fdgQnWjusRw8BImSnmhBTege9G61ub0bs8wFHEl8gQX6kA8FicJ5v4A/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">还是先对单细胞数据进行按部就班的分析。</p><h4 data-tool="mdnice编辑器"><span></span>Step1: 导入数据<span></span></h4><p data-tool="mdnice编辑器">文章中给出的数据集是GSE234933，我把数据解压以后，发现是52个分开的rds格式的data,  就需要批量读入数据，并合并Seurat对象。（这部分需要注意一下）</p><p data-tool="mdnice编辑器">对于也想复现这篇文献的小伙伴，提醒一下，数据合并以后有<strong>「近 9G」</strong>，没有服务器的小伙伴<strong>「不要盲目复现」</strong>~</p><figure data-tool="mdnice编辑器"><img data-ratio="0.18959913326110509" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ9hribrVd8a7F2QM28Bkn87eT4SaAyxBgo1zwOTjDywTqQUGdBInqbicug/640?wx_fmt=png" data-type="png" data-w="923" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ9hribrVd8a7F2QM28Bkn87eT4SaAyxBgo1zwOTjDywTqQUGdBInqbicug/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>) <br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><span>library</span>(data.table)<br><span>library</span>(stringr)<br>getwd()<br>setwd(<span>"./GSE234933_raw/rds/"</span>)<br><span>###### step1:导入数据 ###### </span><br><span># 获取所有rds文件的列表</span><br>file_list &lt;- list.files(<span>"./GSE234933_raw/rds/"</span>, pattern = <span>".rds"</span>)<br><span># 创建一个空的列表来存储Seurat对象</span><br>seurat_list &lt;- list()<br><span># 循环读取每个rds文件的数据并创建Seurat对象</span><br><span>for</span> (file <span>in</span> file_list) {<br>  <span># 拼接文件路径</span><br>  data.path &lt;- paste0(<span>"./GSE234933_raw/rds/"</span>, file)<br>  <span># 读取RDS文件数据</span><br>  seurat_data &lt;- readRDS(data.path)<br>  <span># 创建Seurat对象，并指定项目名称为文件名（去除后缀）</span><br>  sample_name &lt;- tools::file_path_sans_ext(basename(file))<br>  seurat_obj &lt;- CreateSeuratObject(counts = seurat_data,<br>                                   project = sample_name,<br>                                   min.features = <span>200</span>,<br>                                   min.cells = <span>3</span>)<br>  <span># 将Seurat对象添加到列表中</span><br>  seurat_list &lt;- append(seurat_list, seurat_obj)<br>}<br><span># 提取下划线前面的部分</span><br>sample_names &lt;- sub(<span>"_.*"</span>, <span>""</span>, file_list)<br><span># 合并Seurat对象，将所有Seurat对象合并到一个对象中</span><br>seurat_combined &lt;- merge(seurat_list[[<span>1</span>]],<br>                         y = seurat_list[-<span>1</span>],<br>                         add.cell.ids = sample_names)<br>seurat_combined<br>saveRDS(seurat_combined, file = <span>"seurat.rds"</span>)<br><br><span>#load data</span><br>sce&lt;-readRDS(<span>"./seurat.rds"</span>)<br><br>head(rownames(sce@meta.data))<br>phe=str_split(rownames(sce@meta.data),<span>'_'</span>,simplify = <span>T</span>)<br>head(phe)<br>sce@meta.data$orig.ident=paste0(<span>''</span>,phe[,<span>2</span>])<br>table(sce@meta.data$orig.ident)<br><br>sce.all=sce<br>table(sce.all$orig.ident)<br><br><span>#########QC#########</span><br><span>########省略此步骤#######可以去看这个合集最早的推文#########</span><br>setwd(<span>'../'</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>Step2:降维分群和harmony<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>dir.create(<span>"2-harmony"</span>)<br>getwd()<br>setwd(<span>"2-harmony"</span>)<br><br><span># sce.all=readRDS("../1-QC/sce.all_qc.rds")</span><br>sce=sce.all <br>sce<br>sce &lt;- NormalizeData(sce, <br>                         normalization.method = <span>"LogNormalize"</span>,<br>                         scale.factor = <span>1e4</span>) <br>sce &lt;- FindVariableFeatures(sce)<br>sce &lt;- ScaleData(sce)<br>sce &lt;- RunPCA(sce, features = VariableFeatures(object = sce))<br><br><span>library</span>(harmony)<br>seuratObj &lt;- RunHarmony(sce, <span>"orig.ident"</span>)<br>names(seuratObj@reductions)<br>seuratObj &lt;- RunUMAP(seuratObj,  dims = <span>1</span>:<span>15</span>, <br>                     reduction = <span>"harmony"</span>)<br>DimPlot(seuratObj,reduction = <span>"umap"</span>,label=<span>T</span> ) <br><br>sce=seuratObj<br>sce &lt;- FindNeighbors(sce, reduction = <span>"harmony"</span>,<br>                     dims = <span>1</span>:<span>15</span>) <br>sce.all=sce<br><span>#设置不同的分辨率，观察分群效果</span><br><span>for</span> (res <span>in</span> c(<span>0.01</span>, <span>0.05</span>, <span>0.1</span>, <span>0.2</span>, <span>0.3</span>, <span>0.5</span>,<span>0.8</span>,<span>1</span>)) {<br>  sce.all=FindClusters(sce.all, <span>#graph.name = "CCA_snn",</span><br>                       resolution = res, algorithm = <span>1</span>)<br>}<br>colnames(sce.all@meta.data)<br>apply(sce.all@meta.data[,grep(<span>"RNA_snn"</span>,colnames(sce.all@meta.data))],<span>2</span>,table)<br><br>head(colnames(sce.all))<br>table(sce.all$orig.ident)<br><span>#接下来分析</span><br>sel.clust = <span>"RNA_snn_res.0.05"</span><br>sce.all &lt;- SetIdent(sce.all, value = sel.clust)<br>table(sce.all@active.ident) <br>saveRDS(sce.all, <span>"sce.all_int.rds"</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>marker gene<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>genes_to_check = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <span>'CD4'</span>,<span>'CD8A'</span>,<br>                   <span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span> ,<br>                   <span>'IGHG1'</span>, <span>'MZB1'</span>, <span>'SDC1'</span>,<br>                   <span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>, <br>                   <span>'TPSAB1'</span> , <span>'TPSB2'</span>,  <span># mast cells,</span><br>                   <span>'RCVRN'</span>,<span>'FPR1'</span> , <span>'ITGAM'</span> ,<br>                   <span>'C1QA'</span>,  <span>'C1QB'</span>,  <span># mac</span><br>                   <span>'S100A9'</span>, <span>'S100A8'</span>, <span>'MMP19'</span>,<span># monocyte</span><br>                   <span>'FCGR3A'</span>,<span>'LAMP3'</span>, <span>'IDO1'</span>,<span>'IDO2'</span>,<span>## DC3 </span><br>                   <span>'CD1E'</span>,<span>'CD1C'</span>, <span># DC2</span><br>                   <span>'KLRB1'</span>,<span>'NCR1'</span>, <span># NK </span><br>                   <span>'FGF7'</span>,<span>'MME'</span>, <span>'ACTA2'</span>, <span>## human  fibo </span><br>                   <span>'DCN'</span>, <span>'LUM'</span>,  <span>'GSN'</span> , <span>## mouse PDAC fibo </span><br>                   <span>'MKI67'</span> , <span>'TOP2A'</span>, <br>                   <span>'PECAM1'</span>, <span>'VWF'</span>,  <span>## endo </span><br>                   <span>'EPCAM'</span> , <span>'KRT19'</span>,<span>'KRT7'</span>, <span># epi </span><br>                   <span>'FYXD2'</span>, <span>'TM4SF4'</span>, <span>'ANXA4'</span>,<span># cholangiocytes</span><br>                   <span>'APOC3'</span>, <span>'FABP1'</span>,  <span>'APOA1'</span>,  <span># hepatocytes</span><br>                   <span>'Serpina1c'</span>,<span>'PROM1'</span>, <span>'ALDH1A1'</span> )<br><span># EPCAM, keratin 19 [KRT19], and KRT7); </span><br><span># cholangiocytes (  marked with FYXD2, TM4SF4, and ANXA4); </span><br><span># hepatocytes ( marked with APOC3, FABP1, and APOA1);</span><br><br><span>library</span>(stringr)  <br>genes_to_check=str_to_upper(genes_to_check)<br>genes_to_check<br>p &lt;- DotPlot(sce.all, features = unique(genes_to_check),<br>             assay=<span>'RNA'</span>,group.by = <span>"RNA_snn_res.0.05"</span>  )  + coord_flip()<br><br>p <br>ggsave(<span>'check_last_markers.pdf'</span>,height = <span>11</span>,width = <span>11</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>Step3: 细胞亚群命名<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>celltype=data.frame(ClusterID=<span>0</span>:<span>10</span>,<br>                    celltype= <span>0</span>:<span>10</span>) <br><br><span>#定义细胞亚群 </span><br>celltype[celltype$ClusterID %<span>in</span>% c(<span>0</span>,<span>7</span>),<span>2</span>]=<span>'T'</span>  <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>2</span>),<span>2</span>]=<span>'Macropage'</span>  <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>8</span>),<span>2</span>]=<span>'mast'</span>   <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>1</span>,<span>9</span>,<span>10</span>),<span>2</span>]=<span>'Epi-tumor'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>6</span>),<span>2</span>]=<span>'fibo'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c(<span>5</span>),<span>2</span>]=<span>'Endo'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c(<span>4</span>),<span>2</span>]=<span>'cycling'</span><br>celltype[celltype$ClusterID %<span>in</span>% c(<span>3</span>),<span>2</span>]=<span>'B'</span><br><br>head(celltype)<br>celltype<br>table(celltype$celltype)<br><br>sce.all@meta.data$celltype = <span>"NA"</span><br><span>for</span>(i <span>in</span> <span>1</span>:nrow(celltype)){<br>  sce.all@meta.data[which(sce.all@meta.data$RNA_snn_res.0.05== celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]}<br>table(sce.all@meta.data$celltype)<br><br><br>th=theme(axis.text.x = element_text(angle = <span>45</span>, <br>                                    vjust = <span>0.5</span>, hjust=<span>0.5</span>)) <br><br><span>library</span>(patchwork)<br>p_all_markers=DotPlot(sce.all, features = genes_to_check,<br>                      assay=<span>'RNA'</span> ,group.by = <span>'celltype'</span> )  + coord_flip()+th<br>p_umap=DimPlot(sce.all, reduction = <span>"umap"</span>, group.by = <span>"celltype"</span>,label = <span>T</span>,label.box = <span>T</span>)<br>p+p_umap<br>ggsave(<span>'markers_umap_by_celltype_2.pdf'</span>,width = <span>13</span>,height = <span>8</span>)<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6083333333333333" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ9TRk0l7Gq5qYiaqBjLax4on2ibeIk1XOeGQibvDwXiaicLNZX6l5ZNDDKSfA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ9TRk0l7Gq5qYiaqBjLax4on2ibeIk1XOeGQibvDwXiaicLNZX6l5ZNDDKSfA/640?wx_fmt=png"><strong>「初次分群，Macrophage部分并没有分的很清楚，后续还会把巨噬细胞提出来做分析。」</strong></p><h4 data-tool="mdnice编辑器"><span></span>根据文章中图上的基因来看<span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>Tumor=c(<span>"KRT8"</span>, <span>"EPCAM"</span>, <span>"Krt5"</span>, <span>"TP63"</span>, <span>"CDH1"</span>)<br>Stroma=c(<span>"FAP"</span>, <span>"PDGFRB"</span>, <span>"COL1A1"</span>,<span>"ACTA2"</span>,<span>"TAGLN"</span>,<span>"DCN"</span>,<span>"CDH5"</span>,<span>"TIE1"</span>,<span>"VWF"</span>,<span>"PECAM1"</span>)<br>Immune=c(<span>"FCN1"</span>, <span>"APOE"</span>, <span>"C1QB"</span>, <span>"SPP1"</span>, <span>"CXCL9"</span>,<span>"CD1E"</span>,<span>"CXCR2"</span>,<span>"CXCR1"</span>,<br>         <span>"KIT"</span>,<span>"CD3D"</span>,<span>"CD8A"</span>,<span>"MS4A1"</span>,<span>"CD79A"</span>,<span>"PTPRC"</span>)  <br>genes_to_check =list(<br>  Tumor=Tumor,<br>  Stroma=Stroma,<br>  Immune=Immune<br>)<br><span>library</span>(stringr)<br>genes_to_check = lapply(genes_to_check, str_to_upper)<br>p_all_markers=DotPlot(sce.all, <br>                      features = genes_to_check,<br>                      scale = <span>T</span>,assay=<span>'RNA'</span>,group.by = <span>"RNA_snn_res.0.05"</span>  )+<br>  theme(axis.text.x=element_text(angle=<span>45</span>,hjust = <span>1</span>))<br>p_all_markers<br>ggsave(<span>'check_GSE234944_markers.pdf'</span>,height = <span>11</span>,width = <span>11</span>)<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="1.0036407766990292" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ948W5VDkBqX3ZDUFhrubWvd0y95UrjxhEr00yIMssewHCPJyacgYK6Q/640?wx_fmt=png" data-type="png" data-w="824" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ948W5VDkBqX3ZDUFhrubWvd0y95UrjxhEr00yIMssewHCPJyacgYK6Q/640?wx_fmt=png"><strong>「复现的图」</strong><img data-ratio="0.5768421052631579" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ9SlYoq6PqPDu5YpdziaKlXvLLqeua6qHUPfxW0tdRJtJZ5RXiahBosdWg/640?wx_fmt=png" data-type="png" data-w="950" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ9SlYoq6PqPDu5YpdziaKlXvLLqeua6qHUPfxW0tdRJtJZ5RXiahBosdWg/640?wx_fmt=png"></p><p data-tool="mdnice编辑器"><strong>「由于篇幅有限和本次使用的数据量有点大，下周继续对巨噬细胞亚群进行细致的分析，也看看巨噬细胞新的定义分类~」</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="0.9175946547884187" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ9Wfnrs7ZcH1dXVZ5mnVH43Ve6Fh7Z86P6ia52175HW0gRYvBGTiaEFfiaQ/640?wx_fmt=png" data-type="png" data-w="898" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ9Wfnrs7ZcH1dXVZ5mnVH43Ve6Fh7Z86P6ia52175HW0gRYvBGTiaEFfiaQ/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span><span>微信交流群</span><span></span></h3><p data-tool="mdnice编辑器">如果你也想参与到群里的讨论中，给我提出一些推文更新建议的话欢迎入群。同时你也可以得到我前期更新的所有数据及代码，在群里我会把代码分享给大家，而且大家可以在群里「提出自己感兴趣的单细胞文献」<strong>「我们尽可能优先选择大家的数据集去复现和实战，也欢迎大家在群里分享更多其它资料，咱们一起进步，」</strong><strong>「比较高级的单细胞分析」</strong>我们也会一起尝试， 相信你肯定是会不虚此行哈。</p><p data-tool="mdnice编辑器">附上之前推文的链接 <a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512238&amp;idx=1&amp;sn=e0c6dc2ea0e089aabb78133e50fb5d7f&amp;scene=21#wechat_redirect" data-linktype="2">为爱发电不可取（单细胞周更需要你的支持）</a></p><p data-tool="mdnice编辑器"><strong>「「目前群里已经有300多人，所以你想要进群的话就需要添加我的微信，私聊给我发99元的红包，我把你拉进群里。」」</strong></p><p data-tool="mdnice编辑器">我们这个群是真正的付费交流群，提供数据，代码，学习资料，也会跟大家互动交流，还会坚持进行创作至少一年。如果介意99元的门槛且不认可我们知识分享的理念，<strong>「请不要加我好友」</strong>。。</p><figure data-tool="mdnice编辑器"><img data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ9ibq15WGmzz8dhXXoJ5fAUBmBhz0hcYTkTvJP1ZKn78Af9OWTwv1FjFA/640?wx_fmt=png" data-type="png" data-w="172" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2LosicibhMsao0dqt1gWJgvNDDQ9ibq15WGmzz8dhXXoJ5fAUBmBhz0hcYTkTvJP1ZKn78Af9OWTwv1FjFA/640?wx_fmt=png"></figure></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/8Eco5uXchKoQSavhbPXubQ",target="_blank" rel="noopener noreferrer">原文链接</a>
