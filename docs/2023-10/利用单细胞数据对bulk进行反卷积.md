---
title: "利用单细胞数据对bulk进行反卷积"
date: 2023-10-27T05:03:32Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
利用单细胞数据对bulk进行反卷积 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span></span>intro</h1><p data-tool="mdnice编辑器">buk-RNAseq和sc-RNAseq联合分析在许多文章中已经屡见不鲜了，这周介绍两种利用单细胞数据对bulk进行反卷积方法的基本实现</p><p data-tool="mdnice编辑器">参考：</p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247509903&amp;idx=1&amp;sn=33b077e4d235cb512597860fedc451e9&amp;scene=21#wechat_redirect" data-linktype="2">这个bulk RNA-seq反卷积工具，你可能还不知道</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247510285&amp;idx=1&amp;sn=5f79ada8bf3cefc59e382236b9a6ef62&amp;chksm=fa456c30cd32e526b42234d1ee13ca448c9860885cdadc89aac8b130a17075711597e06ef025&amp;scene=21&amp;cur_album_id=2542556111040872450#wechat_redirect" data-linktype="2">BayesPrism只有反卷积？那你可能了解的不够多！</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzIzMjQ4ODg1Mg==&amp;mid=2247485924&amp;idx=1&amp;sn=fa55d130d8457eff1e462ca94ec4961c&amp;scene=21#wechat_redirect" data-linktype="2">单细胞工具-使用BisqueRNA对Bulk RNA-seq数据解卷积</a></p><p data-tool="mdnice编辑器">这里沿用BayesPrim的测试数据集，在相同尺度下同时进行BayesPrism和BisqueRNA</p><h1 data-tool="mdnice编辑器"><span></span>两种方法算法原理比较</h1><h3 data-tool="mdnice编辑器"><span></span>BayesPrism<span></span></h3><p data-tool="mdnice编辑器">BayesPrism方法2022年4月发表在nature cancer(22.7分)</p><p data-tool="mdnice编辑器">https://www.nature.com/articles/s43018-022-00356-3</p><p data-tool="mdnice编辑器">https://github.com/Danko-Lab/BayesPrism</p><p data-tool="mdnice编辑器">贝叶斯棱镜由Deconvolution modules反卷积模块和Embedding learning module嵌入学习模块组成。反卷积模块对来自scRNA-seq的细胞类型特异性表达谱进行建模，以共同估计肿瘤（或非肿瘤）样品的大量RNA-seq表达的细胞类型组成和细胞类型特异性基因表达的后验分布。嵌入学习模块使用期望最大化 （EM） 来使用恶性基因程序的线性组合来近似肿瘤表达，同时以反卷积模块估计的非恶性细胞的推断表达和分数为条件。</p><blockquote data-tool="mdnice编辑器"><p>Deconvolution modules是一种分离混合信号中各个成分的方法。它从<strong>单细胞RNA测序(scRNA-seq)中建模先验(cell type-specific expression profiles)的模块</strong>。通过对肿瘤(或非肿瘤)样本的批量RNA测序表达进行分析，deconvolution模块可以共同估计<strong>细胞类型组成的后验分布和细胞类型特异性基因表达的后验分布。</strong></p><p>Embedding learning module则是一个使用期望最大化(Expectation-maximization, EM)算法对肿瘤表达进行建模的模块。它<strong>基于先前deconvolution模块推断出的基因表达和非恶性细胞比例的条件下，利用恶性基因程序的线性组合来近似表示肿瘤表达。</strong>简单来说，embedding learning module是用来学习肿瘤基因表达的模块，并可以根据先前deconvolution模块的估计结果来进行条件建模。</p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="0.4780600461893764" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRINWtZ04R1VTNfcSfdSf81tFz3w2caQMWn9uaCKuKx2Ma66FIVm5FadA/640?wx_fmt=png" data-type="png" data-w="866" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRINWtZ04R1VTNfcSfdSf81tFz3w2caQMWn9uaCKuKx2Ma66FIVm5FadA/640?wx_fmt=png"><figcaption>img</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span>BisqueRNA<span></span></h3><p data-tool="mdnice编辑器">BisqueRNA方法2020年发表在NC（16.6分）</p><p data-tool="mdnice编辑器">https://www.nature.com/articles/s41467-020-15816-6</p><p data-tool="mdnice编辑器">https://github.com/cozygene/bisque</p><p data-tool="mdnice编辑器">Bisque 提供两种操作模式：基于参考（单细胞数据集，假设和bulk来自同一样本组织）和基于标记（细胞类型及其marker，属于半监督模型，效果没有参考的好）的分解</p><figure data-tool="mdnice编辑器"><img data-ratio="0.8316831683168316" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRIAEZOspKEAJ0XYCb9UAZYiaRQzmhHTNibP2RnwQ3qMaIeMYC3ZlUrAVcw/640?wx_fmt=png" data-type="png" data-w="808" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRIAEZOspKEAJ0XYCb9UAZYiaRQzmhHTNibP2RnwQ3qMaIeMYC3ZlUrAVcw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">涉及以下步骤：</p><ol data-tool="mdnice编辑器"><li><section>构建参考图谱：首先，需要构建一个参考图谱，其中包含每种细胞类型的基因表达模式。参考图谱可以从已知的单细胞RNA-seq数据中获取，其中每个细胞单元都被分配给特定的细胞类型。</section></li><li><section>根据参考图谱反卷积：接下来，将批量RNA-seq数据与参考图谱进行比较，并使用数学算法进行计算，以确定批量数据中每种细胞类型的贡献比例。这个过程可以类比为一个反卷积问题，其中批量数据被视为观测到的总体数据，参考图谱被视为已知的组成部分。</section></li><li><section>非负最小二乘回归：在BisqueRNA中，使用非负最小二乘回归方法来进行反卷积。这意味着在估计细胞类型比例时，结果必须保持非负且最小误差。非负最小二乘回归是一种优化算法，通过最小化实际数据与估计结果之间的误差来实现这一点。</section></li><li><section>约束比例总和为一：为了确保估计的细胞类型比例总和为一，还会添加一个约束条件。这样可以保证细胞类型比例之和等于100%，表示完整的细胞组成。</section></li></ol><p data-tool="mdnice编辑器">通过这样的反卷积过程，BisqueRNA能够基于批量RNA-seq数据估计出细胞类型的比例，从而提供了对样本中细胞异质性的洞察。这种方法在细胞组成分析中具有广泛的应用，并为我们理解组织和疾病发展提供了重要的信息。</p><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">总的来说这类bulk反卷积方法往往需要一个定义好细胞亚型类型的单细胞基因表达谱数据或者定义好细胞亚型的markers列表，就可以对bulk-RNAseq表达谱数据进步性反卷积，得到每个bulk样本中的细胞组成比例估计</p><p data-tool="mdnice编辑器">其它bulk反卷积方法可参考：</p><p data-tool="mdnice编辑器">Benchmarking of cell type deconvolution pipelines for transcriptomics data [https://www.nature.com/articles/s41467-020-19015-1]</p><p data-tool="mdnice编辑器">Benchmarking and new generative methods for single-cell transcriptome data in bulk RNA sequence deconvolution [https://www.researchsquare.com/article/rs-3338396/v1]</p><h1 data-tool="mdnice编辑器"><span></span>BayesPrim</h1><h3 data-tool="mdnice编辑器"><span></span>加载数据集<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>library(<span>"devtools"</span>)<br><span># install_github("Danko-Lab/BayesPrism/BayesPrism")</span><br><span># install.packages("BayesPrism/BayesPrism/",repos = NULL, type = "source")</span><br>suppressWarnings(library(BayesPrism))<br><br><span>###### 加载数据集 ########</span><br>load(<span>"./tutorial.gbm.rdata"</span>)<br>ls()<br><span># [1] "bk.dat"            "cell.state.labels" "cell.type.labels"  "sc.dat"</span><br><br>bk.dat[1:4,1:4]<br><span># ENSG00000000003.13 ENSG00000000005.5 ENSG00000000419.11 ENSG00000000457.12</span><br><span># TCGA-06-2563-01A-01R-1849-01               5033                12               1536                646</span><br><span># TCGA-06-0749-01A-01R-1849-01               3422                62                934                479</span><br><span># TCGA-06-5418-01A-01R-1849-01               4976                17               1654                517</span><br><span># TCGA-06-0211-01B-01R-1849-01               5770                 5               1546                742</span><br><span># &gt; dim(bk.dat)</span><br><span># [1]   169 60483</span><br><span># bulk-RNAseq 基因表达矩阵 169个样本</span><br><br>sc.dat[1:4,1:4]<br><span># ENSG00000130876.10 ENSG00000134438.9 ENSG00000269696.1 ENSG00000230393.1</span><br><span># PJ016.V3                  0                 0                 0                 0</span><br><span># PJ016.V4                  0                 0                 0                 0</span><br><span># PJ016.V5                  0                 0                 0                 0</span><br><span># PJ016.V6                  0                 0                 0                 0</span><br><span># &gt; dim(sc.dat)</span><br><span># [1] 23793 60294</span><br><span># scRNAseq基因表达矩阵 23793个细胞</span><br><br><span># bulk和sc都是6w多的基因 所以肯定包括非编码的</span><br><br>table(cell.type.labels)<br><span># cell.type.labels</span><br><span># endothelial     myeloid       oligo    pericyte       tcell       tumor </span><br><span># 492        2505         160         489          67       20080 </span><br><span># 已经分好的细胞类型</span><br><span># &gt; length(cell.type.labels)</span><br><span># [1] 23793</span><br><span># 和sc.dat中23793个细胞对应</span><br><br>table(cell.state.labels)<br><span># cell.state.labels</span><br><span># endothelial     myeloid_0     myeloid_1     myeloid_2     myeloid_3     myeloid_4     myeloid_5     myeloid_6     myeloid_7     myeloid_8 </span><br><span># 492           550           526           386           382           266           141           130            75            49 </span><br><span># oligo      pericyte PJ016-tumor-0 PJ016-tumor-1 PJ016-tumor-2 PJ016-tumor-3 PJ016-tumor-4 PJ016-tumor-5 PJ016-tumor-6 PJ017-tumor-0 </span><br><span># 160           489           621           619           481           420           375           308           261           107 </span><br><span># PJ017-tumor-1 PJ017-tumor-2 PJ017-tumor-3 PJ017-tumor-4 PJ017-tumor-5 PJ017-tumor-6 PJ018-tumor-0 PJ018-tumor-1 PJ018-tumor-2 PJ018-tumor-3 </span><br><span># 107           101            89            83            64            22           444           429           403           361 </span><br><span># PJ018-tumor-4 PJ018-tumor-5 PJ025-tumor-0 PJ025-tumor-1 PJ025-tumor-2 PJ025-tumor-3 PJ025-tumor-4 PJ025-tumor-5 PJ025-tumor-6 PJ025-tumor-7 </span><br><span># 262           113           971           941           630           601           523           421           397           381 </span><br><span># PJ025-tumor-8 PJ025-tumor-9 PJ030-tumor-0 PJ030-tumor-1 PJ030-tumor-2 PJ030-tumor-3 PJ030-tumor-4 PJ030-tumor-5 PJ032-tumor-0 PJ032-tumor-1 </span><br><span># 319           236           563           482           425           419           348            73           195           171 </span><br><span># PJ032-tumor-2 PJ032-tumor-3 PJ032-tumor-4 PJ032-tumor-5 PJ035-tumor-0 PJ035-tumor-1 PJ035-tumor-2 PJ035-tumor-3 PJ035-tumor-4 PJ035-tumor-5 </span><br><span># 72            62            57            41           512           474           471           435           385           334 </span><br><span># PJ035-tumor-6 PJ035-tumor-7 PJ035-tumor-8 PJ048-tumor-0 PJ048-tumor-1 PJ048-tumor-2 PJ048-tumor-3 PJ048-tumor-4 PJ048-tumor-5 PJ048-tumor-6 </span><br><span># 241           150            81           545           463           437           333           303           277           244 </span><br><span># PJ048-tumor-7 PJ048-tumor-8         tcell </span><br><span># 228           169            67</span><br><span># 貌似在细胞类型上加上细胞状态？进一步分亚型？</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span>细胞类型和状态标签的 QC<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>##############细胞类型和状态标签的 QC##############</span><br><br>plot.cor.phi (input=sc.dat,<br>              input.labels=cell.state.labels,<br>              title=<span>"cell state correlation"</span>,<br>              <span>#specify pdf.prefix if need to output to pdf</span><br>              pdf.prefix=<span>"gbm.cor.cs"</span>,<br>              cexRow=0.2, cexCol=0.2,<br>              margins=c(2,2))<br><br>plot.cor.phi (input=sc.dat, <br>              input.labels=cell.type.labels, <br>              title=<span>"cell type correlation"</span>,<br>              <span>#specify pdf.prefix if need to output to pdf</span><br>              pdf.prefix=<span>"gbm.cor.ct"</span>,<br>              cexRow=0.5, cexCol=0.5,<br>)<br><br><span># 为进行反卷积cell.type.labels和cell.state.labels要有足够的区分度</span><br><span># 可以使用使用plot.cor.phi函数查看cell.type.labels和cell.state.labels的特征</span><br><span># 如果区分度不够或者过了，那么各个群在聚类图中，可能会聚集在一起</span><br><span># 如果出现大部分cluster 具有明显的相似性，可以考虑merge，或者以更低的resolution进行降维聚类（或者说higher granularity）</span><br><span># 如果重新聚类或者merge 不合适的话，也可考虑删除</span><br><br><span># 可以看到各个标签之间相似度很低</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="1.001497005988024" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRI8UMkfHy8nKtB9uT1jV63NQUR4ic5uMX3KZXwuxibo4wN3tic1Pia5NsYGA/640?wx_fmt=png" data-type="png" data-w="668" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRI8UMkfHy8nKtB9uT1jV63NQUR4ic5uMX3KZXwuxibo4wN3tic1Pia5NsYGA/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.9863429438543247" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRIfX6JuaCYdMmGtDgianUJITIic1n1uvib2Tr7ic7iaU5NnxxUayfvMBxAaXQ/640?wx_fmt=png" data-type="png" data-w="659" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRIfX6JuaCYdMmGtDgianUJITIic1n1uvib2Tr7ic7iaU5NnxxUayfvMBxAaXQ/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>过滤离群基因<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>#########过滤离群基因############</span><br><br><span># 在单细胞测序中，大量的核糖体基因或者线粒体基因不参与指导分析细胞功能，但其可能主导分布并使推断产生偏差。</span><br><span># 这些基因在区分细胞类型方面通常不能提供信息，并且可能是大的假变异的来源。因此，它们对反卷积是不利的。因此，有必要移除这些基因。</span><br><br><span># 查看单细胞数据的离群基因</span><br>sc.stat &lt;- plot.scRNA.outlier(<br>  input=sc.dat, <span>#make sure the colnames are gene symbol or ENSMEBL ID </span><br>  cell.type.labels=cell.type.labels,<br>  species=<span>"hs"</span>, <span>#currently only human(hs) and mouse(mm) annotations are supported</span><br>  return.raw=TRUE <span>#return the data used for plotting. </span><br>  <span># pdf.prefix="gbm.sc.stat" # specify pdf.prefix if need to output to pdf</span><br>)<br>head(sc.stat)<br><br><span># 查看bulk数据的离群基因</span><br>bk.stat &lt;- plot.bulk.outlier(<br>  bulk.input=bk.dat,<span>#make sure the colnames are gene symbol or ENSMEBL ID </span><br>  sc.input=sc.dat, <span>#make sure the colnames are gene symbol or ENSMEBL ID </span><br>  cell.type.labels=cell.type.labels,<br>  species=<span>"hs"</span>, <span>#currently only human(hs) and mouse(mm) annotations are supported</span><br>  return.raw=TRUE<br>  <span>#pdf.prefix="gbm.bk.stat" specify pdf.prefix if need to output to pdf</span><br>)<br>head(bk.stat)<br><br><span># 图中显示每个基因的归一化平均表达(x 轴)和最大特异性(y 轴)的对数，以及每个基因是否属于一个潜在的“异常”</span><br><span># 可以发现 核糖体蛋白质基因通常表现出高平均表达和低细胞类型特异性得分(局限在右下角)</span><br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6978193146417445" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRI5OqeRicTicXwVzz8aE6icWuEwaibOWp0Hhgu8ljG7ZchQ4wM3woYyohaOg/640?wx_fmt=png" data-type="png" data-w="642" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRI5OqeRicTicXwVzz8aE6icWuEwaibOWp0Hhgu8ljG7ZchQ4wM3woYyohaOg/640?wx_fmt=png"><img data-ratio="0.7087227414330218" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRIpmYAdWyYuibfhezhzZUllPIDbQ4YmSd8vztBHKeT0ggXfRKNC2eG3Tw/640?wx_fmt=png" data-type="png" data-w="642" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRIpmYAdWyYuibfhezhzZUllPIDbQ4YmSd8vztBHKeT0ggXfRKNC2eG3Tw/640?wx_fmt=png"></p><pre data-tool="mdnice编辑器"><span></span><code><span># 查看完之后，将从选定的群体中移除基因。</span><br><span># 注意，当参考基因和混合基因的性别不同时，建议排除 chrX 和 chrY 基因。</span><br><span># 也删除低转录基因，因为测量这些基因的转录倾向于噪声。去除这些基因也可以加快计算速度。</span><br><br>sc.dat.filtered &lt;- cleanup.genes (input=sc.dat,<br>                                  input.type=<span>"count.matrix"</span>,<br>                                  species=<span>"hs"</span>, <br>                                  gene.group=c( <span>"Rb"</span>,<span>"Mrp"</span>,<span>"other_Rb"</span>,<span>"chrM"</span>,<span>"MALAT1"</span>,<span>"chrX"</span>,<span>"chrY"</span>) ,<br>                                  exp.cells=5)<br><span># EMSEMBLE IDs detected.</span><br><span># number of genes filtered in each category: </span><br><span>#   Rb      Mrp other_Rb     chrM   MALAT1     chrX     chrY </span><br><span># 89       78     1011       37        1     2464      594 </span><br><span># A total of  4214  genes from Rb Mrp other_Rb chrM MALAT1 chrX chrY  have been excluded </span><br><span># A total of  24343  gene expressed in fewer than  5  cells have been excluded</span><br><br>dim(sc.dat.filtered)<br><span># [1] 23793 31737</span><br><span># 只剩下3w多基因了，其实这个过程可以参考我们过去单细胞的过滤，只不过BayesPrism自己也有对应的函数</span><br><br><span>########检查bulk和sc不同类型基因表达的一致性########</span><br><br>plot.bulk.vs.sc (sc.input = sc.dat.filtered,<br>                 bulk.input = bk.dat<br>                 <span>#pdf.prefix="gbm.bk.vs.sc" specify pdf.prefix if need to output to pdf</span><br>)<br><br><span># 这个包有些函数还挺方便的，比如以后检查同一问题不同研究的表达矩阵就可以直接用这个</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.3644578313253012" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRIEY1PPrwatCEibdxLySq1srAM2GTy3qlPMCia2hohK1kwia33JoYgDiaXeQ/640?wx_fmt=png" data-type="png" data-w="664" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8HONbiaIcvnTLKtm5iaglJRIEY1PPrwatCEibdxLySq1srAM2GTy3qlPMCia2hohK1kwia33JoYgDiaXeQ/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>确定bulk RNAseq反卷积的子集<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 从前面的相关性图可以看出来，蛋白质编码基因是两个测定之间最一致的组，那么直接拿蛋白质编码基因子集反卷积是没问题的</span><br><br>sc.dat.filtered.pc &lt;-  select.gene.type (sc.dat.filtered,<br>                                         gene.type = <span>"protein_coding"</span>)<br><span># EMSEMBLE IDs detected.</span><br><span># number of genes retained in each category: </span><br><span>#   </span><br><span>#   protein_coding </span><br><span># 16148 </span><br><br><span># 当观察到严重的批次效应或者在第二步QC时发现一些细胞类型存在非常相似的表达特征时</span><br><span># 可以考虑使用signature gene</span><br><span># 特征基因的选择可以丰富用于反卷积的基因信息，同时减少技术批量效应造成的噪声影响</span><br><br><span># # Select marker genes (Optional)</span><br><span># # performing pair-wise t test for cell states from different cell types</span><br><span># diff.exp.stat &lt;- get.exp.stat(sc.dat=sc.dat[,colSums(sc.dat&gt;0)&gt;3],# filter genes to reduce memory use</span><br><span>#                               cell.type.labels=cell.type.labels,</span><br><span>#                               cell.state.labels=cell.state.labels,</span><br><span>#                               pseudo.count = 0.1, #a numeric value used for log2 transformation. =0.1 for 10x data, =10 for smart-seq. Default=0.1.</span><br><span>#                               cell.count.cutoff=50, # a numeric value to exclude cell state with number of cells fewer than this value for t test. Default=50.</span><br><span>#                               n.cores=1 #number of threads</span><br><span># )</span><br><span># # cell.count.cutoff=50</span><br><span># # 理想情况下，每种细胞类型最好选择足够数量的基因，否则会降低截止值</span><br><span># # 根据signature gene提取Count matrix subset：</span><br><span># sc.dat.filtered.pc.sig &lt;- select.marker (sc.dat=sc.dat.filtered.pc,</span><br><span>#                                          stat=diff.exp.stat,</span><br><span>#                                          pval.max=0.01,</span><br><span>#                                          lfc.min=0.1)</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span>构建Prism 对象<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># Prism对象包含运行 BayesPrism 所需的所有数据，即 scRNA-seq reference 矩阵、每行参考的 cell type and cell state labels 以及mixture（Bulk RNA-seq）</span><br><br>myPrism &lt;- new.prism(<br>  reference=sc.dat.filtered.pc, <br>  mixture=bk.dat,<br>  input.type=<span>"count.matrix"</span>, <span># 当使用 scRNA-seq  Count 矩阵作为input (推荐)时，用户需要指定 input.type = “ count. Matrix”。Type 的另一个选项是“ GEP”(gene expression profile) ，它是基因矩阵的细胞状态。当使用Bulk RNAseq的数据作为reference 时， 应设置input.type ='GEP'</span><br>  cell.type.labels = cell.type.labels, <br>  cell.state.labels = cell.state.labels,<br>  key=<span>"tumor"</span>,<span># 参数key是 cell.type.label 中对应于恶性细胞类型的字符向量。如无恶性细胞，即设置为 NULL，此时，所有类型的细胞将被 treated equally</span><br>  outlier.cut=0.01,<br>  outlier.fraction=0.1,<br>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span>运行 BayesPrism<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>bp.res &lt;- run.prism(prism = myPrism, n.cores=24)  <span># 24核并行</span><br><span># Run Gibbs sampling... </span><br><span># Current time:  2023-10-16 14:02:06 </span><br><span># Estimated time to complete:  1hrs 17mins </span><br><span># Estimated finishing time:  2023-10-16 15:18:15 </span><br><span># Start run... </span><br><span># R Version:  R version 4.2.2 (2022-10-31) </span><br><span># </span><br><span># snowfall 1.84-6.2 initialized (using snow 0.4-4): parallel execution on 24 CPUs.</span><br><span># </span><br><span># Stopping cluster</span><br><span># </span><br><span># Update the reference matrix ... </span><br><span># snowfall 1.84-6.2 initialized (using snow 0.4-4): parallel execution on 24 CPUs.</span><br><span># </span><br><span># Stopping cluster</span><br><span># </span><br><span># Run Gibbs sampling using updated reference ... </span><br><span># Current time:  2023-10-16 14:40:44 </span><br><span># Estimated time to complete:  38mins </span><br><span># Estimated finishing time:  2023-10-16 15:18:17 </span><br><span># Start run... </span><br><span># snowfall 1.84-6.2 initialized (using snow 0.4-4): parallel execution on 24 CPUs.</span><br><span># </span><br><span># Stopping cluster</span><br><br>bp.res<br><span># &gt; slotNames(bp.res)</span><br><span># [1] "prism"                       "posterior.initial.cellState" "posterior.initial.cellType"  "reference.update"            "posterior.theta_f"  </span><br><span># [6] "control_param" </span><br><br><span># extract posterior mean of cell type fraction theta</span><br>theta &lt;- get.fraction (bp=bp.res,<br>                       which.theta=<span>"final"</span>,<br>                       state.or.type=<span>"type"</span>)<br><span># &gt; head(theta)</span><br><span># tumor    myeloid     pericyte endothelial        tcell        oligo</span><br><span># TCGA-06-2563-01A-01R-1849-01 0.8392297 0.04329259 2.999022e-02  0.07528272 6.474488e-04 0.0115573149</span><br><span># TCGA-06-0749-01A-01R-1849-01 0.7090654 0.17001073 8.995526e-07  0.01275526 1.179331e-06 0.1081665709</span><br><span># TCGA-06-5418-01A-01R-1849-01 0.8625322 0.09839143 9.729268e-03  0.02416954 7.039913e-07 0.0051768589</span><br><span># TCGA-06-0211-01B-01R-1849-01 0.8893449 0.04482991 1.131622e-02  0.05435490 2.508238e-06 0.0001515524</span><br><span># TCGA-19-2625-01A-01R-1850-01 0.9406438 0.03546026 1.932740e-03  0.01309753 4.535897e-06 0.0088610997</span><br><span># TCGA-19-4065-02A-11R-2005-01 0.6763166 0.08374439 1.849921e-01  0.01918132 3.541126e-04 0.0354114398</span><br><span># &gt; dim(theta)</span><br><span># [1] 169   6</span><br></code></pre><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">在BayesPrim基础上我们使用相同的蛋白质编码基因子集通过BisqueRNA进行反卷积</p><h1 data-tool="mdnice编辑器"><span></span>BisqueRNA</h1><h3 data-tool="mdnice编辑器"><span></span>准备数据<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># install.packages("BisqueRNA")</span><br>library(Biobase)<br>library(BisqueRNA)<br><br><span># bulk</span><br>bk.dat[1:4,1:4]<br>bulk.matrix &lt;- t(bk.dat)<br>bulk.eset &lt;- Biobase::ExpressionSet(assayData = bulk.matrix)<br>bulk.eset@assayData[[<span>"exprs"</span>]][1:4,1:4]<br><br><span># sc</span><br><span># 统一用蛋白质编码基因</span><br>sc.dat.filtered.pc[1:4,1:4]<br>sc.matrix &lt;- t(sc.dat.filtered.pc)<br>sc.obj &lt;- Seurat::CreateSeuratObject(counts = sc.matrix)<br><span># sc.dat.filtered.pc对象前面已经过滤了，这里就不根据min.cell min.features等参数过滤、</span><br>sc.obj@assays<span>$RNA</span>@counts[1:4,1:4]<br><span># 如果单细胞数据（来自 10x 平台）在seurat中，且包含细胞类型信息，Bisque 包含一个函数，该函数会自动将此对象转换为表达式集</span><br>sc.eset &lt;- BisqueRNA::SeuratToExpressionSet(sc.obj, delimiter=<span>"\\."</span>, position=1, version=<span>"v3"</span>)  <span># delimiter分割，postion指定样本id</span><br><span># Split sample names by "\." and checked position 1. Found 8 individuals.</span><br><span># Example: "PJ016.V3" corresponds to individual "PJ016".</span><br>table(sc.eset<span>$SubjectName</span>)<br><span># PJ016 PJ017 PJ018 PJ025 PJ030 PJ032 PJ035 PJ048 </span><br><span># 3085  1261  2197  5924  3097  1377  3768  3084 </span><br><span># 包含8个独立样本</span><br><br><span># 加入细胞类型</span><br>table(cell.type.labels)<br>sc.eset<span>$cellType</span> &lt;- cell.type.labels<br>table(sc.eset<span>$cellType</span>)<br><span># endothelial     myeloid       oligo    pericyte       tcell       tumor </span><br><span># 492        2505         160         489          67       20080</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span>基于参考数据集的分解<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 因为我们拿到BisqueRNA里来的矩阵就已经是蛋白质编码的了</span><br><span># 所以这里其实就是进行类似BayesPrism里的蛋白质子集的反卷积</span><br>res &lt;- BisqueRNA::ReferenceBasedDecomposition(bulk.eset, sc.eset, markers=NULL, use.overlap=FALSE)<br><br><span># 如果bulk和单细胞数据是同一个样本测得，可以设置use.overlap=TRUE，可能有更好的表现</span><br><span># 但如果不同数据集样本强行use.overlap=TRUE：</span><br><span># Decomposing into 6 cell types.</span><br><span># Error in GetOverlappingSamples(sc.eset, bulk.eset, subject.names, verbose) : </span><br><span>#   No overlapping samples in bulk and single-cell expression.</span><br><br>ref.based.estimates &lt;- t(res<span>$bulk</span>.props)<br>head(ref.based.estimates)<br>library(tidyverse)<br><span># 根据BayesPrim结果顺序排序</span><br>estimates &lt;- as.data.frame(ref.based.estimates) %&gt;% select(tumor,myeloid,pericyte,endothelial,tcell,oligo) %&gt;% as.matrix()<br>head(estimates)<br><br>head(theta)<br><br>dim(estimates);dim(theta)<br><span># [1] 169   6</span><br><span># [1] 169   6</span><br></code></pre><p data-tool="mdnice编辑器">此外，当没有参考单细胞数据集时，BisqueRNA可以仅使用已知的标记基因提供相对细胞类型丰度的估计值</p><p data-tool="mdnice编辑器">这其实是一个比较灵活的接口了，如果我们想使用像在前面BayesPrism提到的signature gene进行反卷积，也可以通过这个接口进行调整</p><p data-tool="mdnice编辑器">详情参考原介绍BisqueRNA的推文</p><h3 data-tool="mdnice编辑器"><span></span>简单比较BayesPrism和BisqueRNA的结果<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 同一细胞类型样本间比较</span><br>tmp &lt;- c()<br><span>for</span> (i <span>in</span> seq(1,6)){<br>  tmp &lt;- c(tmp, cor(estimates[,i],theta[,i]))<br>}<br>tmp<br><span># tumor,myeloid,pericyte,endothelial,tcell,oligo</span><br><span># [1] 0.8388819 0.9704178 0.3984573 0.2961502 0.1585450 0.2849336</span><br><br><span># 同一样本细胞类型占比比较</span><br>tmp &lt;- c()<br><span>for</span> (i <span>in</span> seq(1,169)){<br>  tmp &lt;- c(tmp, cor(estimates[i,],theta[i,]))<br>}<br>tmp<br>range(tmp)<br><span># [1] 0.7806862 0.9998643</span><br></code></pre><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">以上就是本周转录组周更的全部内容</p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/swPDu2PoGTBEutzaR7YYSg",target="_blank" rel="noopener noreferrer">原文链接</a>
