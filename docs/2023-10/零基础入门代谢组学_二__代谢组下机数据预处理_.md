---
title: "零基础入门代谢组学（二）：代谢组下机数据预处理！"
date: 2023-10-10T03:43:35Z
draft: ["false"]
tags: [
  "fetched",
  "生信作曲家"
]
categories: ["Acdemic"]
---
零基础入门代谢组学（二）：代谢组下机数据预处理！ by 生信作曲家
------
<div><h3><span>前言</span></h3><blockquote><p><span><span>生信作曲家一直致力于构建国内</span><span><strong>和谐、开放、可持续</strong></span><span><strong>的生物信息交流平台</strong>。生信作曲家的目标是<strong>为每个科研人扫清科研路上的一切障碍，让生物信息学人人可做</strong>。目前，生信作曲家已推出</span><span><strong>"</strong><strong>跟着一区文章学通机器学习”、</strong></span><span><strong>"</strong><strong>跟着一区文章学通单细胞</strong><strong>"、"空间转录组从入门到精通”、孟德尔随机化实战”</strong><span><strong>、</strong></span><strong>Bootstrap<span><strong>、</strong></span>NATMI、CIBERSORTx、hdWGCNA、NTP、metaVIPER算法</strong></span><span>等多种强力教程，同时也兼具数据整理、可视化等核心入门技术教学，开办</span></span><strong><span>单细胞孟德尔发文计划MR、</span></strong><span><span><strong>肿瘤发文计划RS、max，非肿瘤发文计划note、ultra、pro、时空百宝箱计划sp</strong><strong>和五一创新发文计划pro</strong></span><span><strong>等、生信中秋分享会、小年夜分享会、暑期集训营和冬季集训营</strong>等多次。辅导同学实现纯生信SCI发表硕果累累，帮助同学实现医学事业路上的理想与追求。</span></span></p></blockquote><section><span>代谢组学已经被广泛应用到科研中，代谢组学涉及的概念较为繁杂，生僻，因此学习和掌握代谢组学，对于基本名词的领会十分重要。接下来，作曲家将带领大家学习下机数据的预处理</span></section><section><figure><figcaption><img data-ratio="1.1601851851851852" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCLv5vicOKkfrTibl4548UWQkH9Fuibm5YKqticdvWeic8jpHxwoJn2G5QdRKzKSYCQianhsIkckWDpibcnw/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCLv5vicOKkfrTibl4548UWQkH9Fuibm5YKqticdvWeic8jpHxwoJn2G5QdRKzKSYCQianhsIkckWDpibcnw/640?wx_fmt=png"></figcaption></figure><section><h3><span>方法讲解</span></h3></section><p>数据预处理：质谱下机数据为原始文件，包括一级谱和二级谱等信息，下一步需要进行<strong>峰提取（解卷积）、峰对齐、保留时间的矫正、缺失值填充（Data Integrity Check），滤噪（Data Filtering）、离子融合、样本归一化（Sample normalization）、数据转换（Data transformation）和数据归一化（Data scaling）等处理。</strong>可以用<strong>XCMS</strong>本地软件或者R包、<strong>MSDIAL</strong>、<strong>MZmine2</strong>和<strong>Metaboanalys</strong>等软件。</p><h4><span>格式转换</span></h4><p>在处理之前，我们需要将下机得到的下机数据使用格式转化工具，将不同平台的数据转化为统一格式，再经由质谱数据分析软件对信号进行检测，常用的工具如下：MSConvert（ProteoWizard 中的一个转换工具），Abf Converter（和MS-DIAL 结合起来用）。</p><ul><li><p><span>如我们可以使用使用ProteoWizard软件将获得的质谱原始数据转换转成mzXML格式，也即XCMS的输入文件格式。</span></p></li></ul><p>Proteowizard支持被转换的格式如下：</p><figure><figcaption><img data-ratio="0.4444444444444444" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCLv5vicOKkfrTibl4548UWQkwGJicVlXPCu66jic5w2YtoutF9RQsIp7RLDnxDgklkMKlSx0Hia8lHHGg/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCLv5vicOKkfrTibl4548UWQkwGJicVlXPCu66jic5w2YtoutF9RQsIp7RLDnxDgklkMKlSx0Hia8lHHGg/640?wx_fmt=png"></figcaption></figure><p>Abf Converter支持转换的原始数据格式：</p><figure><figcaption><img data-ratio="0.8018518518518518" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCLv5vicOKkfrTibl4548UWQk3CCGG04gnESUqgXaf6rOaSyh1TMfXYSIlnrDRjlPngRA6bQBz4XnpA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCLv5vicOKkfrTibl4548UWQk3CCGG04gnESUqgXaf6rOaSyh1TMfXYSIlnrDRjlPngRA6bQBz4XnpA/640?wx_fmt=png"></figcaption></figure><h4><span>数据标准化/规范化</span></h4><p>指的是通过对多个样本，多个代谢物的定量数据进行一系列的中心化，缩放，以及转换操作，<strong>减少数据集的噪声干扰，强调其生物学信息，使其适用后续的统计分析方法</strong>，并改善其生物学解释性。简单来说，就是对代谢数据集进行一些改变，把数据拉到一个特定范围里，使之变得更有统计意义。但并不是任何数据都需要进行标准化的。</p><p>数据标准化分为三类</p><ul><li><p><span>样本标准化Sample Normalization：目的是为了消除样本自身或者测样的技术差异，使样本间可以比较，能突显样本的特征性。</span></p></li><li><p><span>数据归一化 Data Scaling：目的是为了使不同变量之间可以比较。例如，代谢组中有些代谢物含量天然高，有些天然低，做标准化的话，直接做PCA之类的模型，会默认表达量大的对模型贡献就大，影响正确结果</span></p></li><li><p><span>数据转换 Data transformation：为了使数据符合正态分布，多进行Log或者Power变换，以消除异质性。数据转换和数据归一化，主要是将数据限定在一定的范围内，使得后续分析更加方便，程序运行收敛加快或服从某些特征函数分布，从而解析模型的特征。</span></p></li></ul><blockquote><p>具体的方法 方法简要介绍：（多种方法的介绍https://ibook.antpedia.com/x/730437.html）</p><p>中心化（Centering）即将所有数据减去平均值，让数据分布在0值左右而非均值左右，聚焦于数据的差异；从均值附近变换到0值附近；对存在异方差的数据处理效果不佳；</p><p>缩放（Scaling）：指将数据统一乘或者除一个因子，以消除数量级差异，有多种不同的缩放方法适应不同的分析需求；</p><p>转换（Transformation）:即进行Log或者Power变换</p></blockquote><ul><li><p>示例：使用<strong>XCMS程序</strong>或R包进行保留时间矫正、峰识别、峰提取、峰积分、峰对齐等，得到包括正离子模式和负离子模式的质荷比（m/z）、保留时间（retention time）及峰强度（intensity）等信息的数据矩阵。最后利用每个样本的总离子流（total ion current，TIC）进行数据归一化、标准化处理，使得不同量级的数据能够进行比较。通过TIC图，初步观察仪器的保留时间重现性、所测得的物质数量以及不同组之间的色谱图是否具有较明显的差异。</p></li><li><p><span>使用XCMS包进行数据预处理代码：首先将下机的数据按照分组建立两个文件夹</span></p></li></ul><pre><code><span>#设置工作环境为data文件夹</span><br><br><span>#下载并加载r包</span><br><br>BiocManager::install(<span>"xcms"</span>)<br><br><span>library</span>(xcms)<br><br><span>#使用Normalize.medFC函数用于矩阵的标准化。它先计算每一行的中位数medSam,然后将矩阵的每一列除以medSam,得到medFDiSmpl。最后将medFDiSmpl的每一列除以其中位数,得到标准化后的矩阵。</span><br><br>normalize.medFC &lt;- <span>function</span>(mat) {      <br>    medSam &lt;- apply(mat, <span>1</span>, median)       <br>    medSam[which(medSam==<span>0</span>)] &lt;- <span>0.0001</span>      <br>    mat &lt;- apply(mat, <span>2</span>, <span>function</span>(mat, medSam){          <br>        medFDiSmpl &lt;- mat/medSam        <br>        vec&lt;-mat/median(medFDiSmpl)         <br>        <span>return</span>(vec)     <br>    }, medSam)     <br>    <span>return</span> (mat)}<br><br><span>#提取data文件夹中所有的文件</span><br><br>mzxmlfiles &lt;- list.files(full.names=<span>TRUE</span>, recursive= <span>TRUE</span>) <br><br><span>#峰提取</span><br><br>xset &lt;- xcmsSet (mzxmlfiles)<br><br><span># 峰分组</span><br><br>xset1 &lt;- group (xset)  <br><br><span># 保留时间校正</span><br><br>xset2 &lt;- retcor (xset1)  <br><br><span># 峰对齐</span><br><br>xset2 &lt;- group (xset2) <br><br><span># 缺失值填充</span><br><br>xset3 &lt;- fillPeaks (xset2) <br><br><span>#标准化</span><br><br>normalData &lt;- cbind(groups(xset3), normalize.medFC(groupval(xset3, <span>"medret"</span>, <span>"into"</span>)) ) <br><br><span>#得到矫正后的数据，保存为csv文件</span><br><br>write.csv(normalData,file=<span>"medFoldNorm.csv"</span>)<br><br><span>#在填充缺失值的xset3对象中,提取名为“medret”的矩阵,并将其值赋给dat变量，获得峰面积矩阵。</span><br><br>dat &lt;- groupval (xset3, <span>"medret"</span>, <span>"into"</span>)<br><br><span># 加分组标签</span><br><br>dat2 &lt;- rbind (group = as.character(phenoData(xset3)$class), dat)  <br><br><span>#保存</span><br><br>write.csv (dat2, file=<span>"PeakTable.csv"</span>) <br><br><span>#使用diffreport()函数生成CKD_mzxml和Control_mzxml两个组之间的差异报告,赋值给dr，并保存</span><br><br>dr &lt;- diffreport (xset3,<span>"CKD_mzxml"</span>, <span>"Control_mzxml"</span>)<br><br>write.csv (dr, file=<span>"diffreport.csv"</span>)<br></code></pre><p>另外还可以调整其他参数（如不同的保留时间）进行过滤，如针对保留时间进行过滤：</p><pre><code><span>#从xset3对象中提取峰群信息gt</span><br><br>gt &lt;- groups (xset3)<br><br><span>#设置条件过滤gt,选择保留时间在120-220秒之间且包含25个峰的峰群,赋值给groupidx1</span><br><br>groupidx1 &lt;- which(gt[,<span>"rtmed"</span>] &gt; <span>120</span> &amp; gt[,<span>"rtmed"</span>] &lt; <span>220</span> &amp; gt[,<span>"npeaks"</span>] == <span>25</span>)<br><br><span>#根据groupidx1使用getEIC()函数提取选定峰群的EIC</span><br><br>eiccor &lt;- getEIC(xset3, groupidx = groupidx1)<br><br><span>#绘制第1个被选定峰群的EIC图</span><br><br>plot (eiccor, xset3, groupidx = <span>1</span>)<br></code></pre><h4><span>数据质控（非必须）</span></h4><p>如何判断数据质量？</p><ul><li><p>通过TIC图观察QC样本的RT、Intensity的重复性</p></li><li><p>通过PCA图观察样本:在PCA图上，同组样本应该尽量聚集在一起</p></li><li><p>通过热图观察样本：可以通过热图找出离群样本</p></li></ul></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/CbNfGxqSAxr9F17naf4tjQ",target="_blank" rel="noopener noreferrer">原文链接</a>
