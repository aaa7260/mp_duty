---
title: "单细胞+TCGA+实验验证-2区5.6？"
date: 2023-10-16T10:09:42Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
单细胞+TCGA+实验验证-2区5.6？ by 生信菜鸟团
------
<div><section><blockquote><p>因为下周末有面基活动，所以得提前复习一下流程。复习的最好方式是走一遍流程。<br>一方面期待，一方面社恐，所以我肯定是高冷的…不敢说话</p></blockquote><figure><img data-ratio="1.3064814814814816" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6AhlzakOr82a3aA5ibicvJOg3EQ0WPW1gjYzAiafpNZXezg93Duj21wvAQ/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6AhlzakOr82a3aA5ibicvJOg3EQ0WPW1gjYzAiafpNZXezg93Duj21wvAQ/640?wx_fmt=png"></figure><br>首先下载数据<br><figure><img data-ratio="0.22685185185185186" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6NmPibq1xCiaJ9WSgpyGkKQmHe5urnHVINgmLrVLWEH9mq69icq2WLfxlw/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6NmPibq1xCiaJ9WSgpyGkKQmHe5urnHVINgmLrVLWEH9mq69icq2WLfxlw/640?wx_fmt=png"><figcaption><br></figcaption></figure>前面的流程就不放了，文中使用的是SingleR注释的，这倒是省了很多事<br><figure><img data-ratio="0.25462962962962965" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6WpgR49BGA4BCGh25OlYka3epThQ99CTbTlZO5FkExYJ6l0Sw49nooA/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6WpgR49BGA4BCGh25OlYka3epThQ99CTbTlZO5FkExYJ6l0Sw49nooA/640?wx_fmt=png"></figure><pre><code>rm(list=ls())<br>options(stringsAsFactors = F)<br>library(Seurat)<br>library(ggplot2)<br>library(clustree)<br>library(cowplot)<br>library(dplyr)<br>library(SingleR)<br>library(celldex)<br>library(singleseqgset)<br>library(devtools)<br>getwd()<br>setwd('3-cell/')<br>sce=readRDS( "../2-harmony/sce.all_int.rds")<br>sce<br><br><span># singleR注释</span><br><span>#hpca.se &lt;- HumanPrimaryCellAtlasData()</span><br><span>#save(hpca.se,file = 'hpca.RData')</span><br><span>load</span>(<span>'../hpca.RData'</span>)<br><span>#bpe.se &lt;- BlueprintEncodeData()</span><br><span>#save(bpe.se,file = 'bpe.RData')</span><br><span>load</span>(<span>'../bpe.RData'</span>)<br><span>unique</span>(hpca.se$label.main)<br><span>unique</span>(hpca.se$label.fine)<br><span>unique</span>(bpe.se$label.main)<br><span>unique</span>(bpe.se$label.fine)<br><span>##这个运行太太太慢了</span><br>DICE &lt;- DatabaseImmuneCellExpressionData() <br><span>#save(DICE,file = 'DICE.RData')</span><br>NHD &lt;- NovershternHematopoieticData() <br><span>load</span>(<span>'../NHD.RData'</span>)<br><span>#save(NHD,file = 'NHD.RData')</span><br><span>MID</span> &lt;- MonacoImmuneData()<br><span>load</span>(<span>'../MID.RData'</span>)<br><span>#save(MID,file = 'MID.RData')</span><br><span>unique</span>(NHD$label.main)<br><span>unique</span>(NHD$label.fine)<br><span>unique</span>(<span>MID</span>$label.main)<br><span>unique</span>(<span>MID</span>$label.fine)<br>anno &lt;- SingleR(sce@assays$RNA@<span>data</span>,<br>                <span>ref</span> = <span>list</span>(HPCA=hpca.se),<br>                labels = <span>list</span>(hpca.se$label.main),<br>                clusters = sce@meta.data$seurat_clusters<br>)<br>plotScoreHeatmap(anno,clusters = anno@rownames,show_colnames = T)<br><span>table</span>(anno$labels)<br><br>celltype = data.frame(ClusterID=rownames(anno), <br>                      celltype=anno$labels, <br>                      stringsAsFactors = F) <br><br>sce@meta.data$singleR = celltype[<span>match</span>(sce@meta.data$seurat_clusters,celltype$ClusterID),<span>'celltype'</span>]<br>P &lt;- DimPlot(sce, reduction = <span>"umap"</span>, group.by = <span>"singleR"</span>,raster=<span>FALSE</span>)<br>P<br><br>mycolors &lt;-c(<span>'#E5D2DD'</span>, <span>'#53A85F'</span>, <span>'#F1BB72'</span>, <span>'#F3B1A0'</span>, <span>'#D6E7A3'</span>, <span>'#57C3F3'</span>,<br>                      <span>'#E95C59'</span>, <span>'#E59CC4'</span>, <span>'#AB3282'</span>,  <span>'#BD956A'</span>, <br>                      <span>'#9FA3A8'</span>, <span>'#E0D4CA'</span>,  <span>'#C5DEBA'</span>, <span>'#F7F398'</span>,<br>                      <span>'#C1E6F3'</span>, <span>'#6778AE'</span>, <span>'#91D0BE'</span>, <span>'#B53E2B'</span>,<br>                      <span>'#712820'</span>, <span>'#DCC1DD'</span>, <span>'#CCE0F5'</span>,  <span>'#CCC9E6'</span>, <span>'#625D9E'</span>, <span>'#68A180'</span>, <span>'#3A6963'</span>,<br>                      <span>'#968175'</span>)<br><span>col</span> =c(<span>"#3176B7"</span>,<span>"#F78000"</span>,<span>"#3FA116"</span>,<span>"#CE2820"</span>,<span>"#9265C1"</span>,<br>                                      <span>"#885649"</span>,<span>"#DD76C5"</span>,<span>"#BBBE00"</span>,<span>"#41BED1"</span>)<br><br>p_umap=DimPlot(sce, reduction = <span>"umap"</span>, group.by = <span>"singleR"</span>,label = T,<br>               label.box=T,raster=<span>FALSE</span>,cols = <span>col</span>)<br>p_umap<br><br><span>table</span>(Idents(sce))  <br>Idents(sce)=sce$singleR<br><span>table</span>(Idents(sce))  <br>saveRDS(sce, <span>"sce.all_celltype.rds"</span>)<br></code></pre><p>根据这个情形来看，这里的内皮细胞直接就是文中那一群tumor_associated_内皮</p><figure><img data-ratio="0.7805555555555556" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6PJ0CeJo66PUUIibjmecQFaZkoUW2ibibxY0OSictiaGeqiaI5G0nlaJBwbQw/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6PJ0CeJo66PUUIibjmecQFaZkoUW2ibibxY0OSictiaGeqiaI5G0nlaJBwbQw/640?wx_fmt=png"><figcaption><br></figcaption></figure><pre><code><span>##看看哪几个是不是在一群细胞中表达</span><br><span>#PECAM1，VWF,ENG,CDH5</span><br><span>cell_marker</span> &lt;- c(<span>"PECAM1"</span>,<span>"VWF"</span>,<span>"ENG"</span>,<span>"CDH5"</span>)<br>FeaturePlot(sce,features = cell_marker,cols = c(<span>"lightgrey"</span> ,<span>"#DE1F1F"</span>),ncol=<span>2</span>,raster=FALSE)<br></code></pre><p>看了一下标记基因，确实是在这一群内皮里表达啊，虽然有些微弱看不清</p><figure><img data-ratio="0.8527777777777777" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF61f9zaMt1MVL1p6WKicr7r4JA3dPztD4kK8cYC8lxJYJQ7nwVrgoibiaPg/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF61f9zaMt1MVL1p6WKicr7r4JA3dPztD4kK8cYC8lxJYJQ7nwVrgoibiaPg/640?wx_fmt=png"></figure><pre><code>sce.all = sce<br>Idents(sce.all)<br>sce.markers &lt;- FindAllMarkers(object = sce.all, only.pos = <span>TRUE</span>, <br>                              min.pct = <span>0.25</span>, <br>                              thresh.<span>use</span> = <span>0.25</span>)<br>DT::datatable(sce.markers)<br>pro=<span>'markers'</span><br>write.csv(sce.markers,file=paste0(pro,<span>'_sce.markers.csv'</span>))<br>library(dplyr) <br>top10 &lt;- sce.markers %&gt;% group_by(cluster) %&gt;% top_n(<span>10</span>, avg_log2FC)<br>genes_to_remove &lt;- c(<span>'RGS10'</span>, <span>'HMGN3'</span>, <span>'PNRC1'</span>, <span>'SNX3'</span>, <span>'CFP'</span>, <span>'PAK1'</span>, <br>                     <span>'CSTA'</span>, <span>'CCR7'</span>, <span>'YPEL5'</span>, <span>'XBP1'</span>, <span>'SUB1'</span>, <span>'LSP1'</span>, <br>                     <span>'PIM2'</span>, <span>'FKBP11'</span>, <span>'SPCS3'</span>, <span>'CD38'</span>, <span>'ITM2C'</span>, <span>'EAF2'</span>,<br>                     <span>'HERPUD1'</span>, <span>'TPT1'</span>, <span>'CALM1'</span>, <span>'ZFP36'</span>, <span>'SRP14'</span>, <span>'TPM4'</span>,<br>                     <span>'HLA-B'</span>, <span>'MYL6'</span>, <span>'ITGB2'</span>, <span>'PFN1'</span>, <span>'SH3BGRL3'</span>, <span>'PPT1'</span>,<br>                     <span>'HSP90AA1'</span>, <span>'ARHGDIB'</span>, <span>'ITM2A'</span>, <span>'CTSS'</span>, <span>'ARPC1B'</span>, <span>'CALR'</span>,<br>                     <span>'RPS19'</span>, <span>'RPL11'</span>, <span>'RPS8'</span>, <span>'RPL19'</span>, <span>'RPL29'</span>, <span>'RPL18A'</span>, <span>'RPS28'</span>, <span>'RPS12'</span>, <br>                     <span>'RPL12'</span>, <span>'RPS21'</span>, <span>'RPL39'</span>, <span>'RPL30'</span>, <span>'RPL37'</span>, <span>'RPLP0'</span>, <span>'RPL7'</span>)<br>top10_n &lt;- top10[!(top10$gene %in% genes_to_remove), ]<br>table(sce$singleR)<br><span>#为了防止数据量太大不好出图，这里在每个亚群提取出来100个</span><br>DoHeatmap(subset(sce.all,downsample=<span>100</span>),top10_n$gene,size=<span>3</span>)+scale_fill_gradientn(colors=c(<span>"#94C4E1"</span>,<span>"white"</span>,<span>"red"</span>))<br><br><span>#|log2 (fold change)|&gt;2 and adjusted P value &lt; 0.01 were recognized as cellular marker genes.</span><br>table(sce.markers$cluster)<br>TEC_deg = sce.markers[sce.markers$cluster == <span>'Endothelial_cells'</span>,]<br>colnames(TEC_deg)<br><br>library(dplyr)<br><br>deg_label &lt;- TEC_deg %&gt;%<br>  mutate(change = ifelse(avg_log2FC &gt; <span>2</span> &amp; p_val_adj &lt; <span>0.01</span>, <span>"Up"</span>,<br>                         ifelse(avg_log2FC &lt; <span>-2</span> &amp; p_val_adj &lt; <span>0.01</span>, <span>"Down"</span>, <span>"stable"</span>)))<br><span>##这差异都是上调显著的啊</span><br>table(deg_label$change)<br>TEC_sig = deg_label[deg_label$change == <span>'Up'</span>,]<br><br>save(sce.markers,TEC_sig,file = paste0(pro, <span>'sce.markers.Rdata'</span>))<br></code></pre><p>来看看靶点的热图，看起来T和上皮细胞群的marker有点奇怪<br></p><figure><img data-ratio="0.7611111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6RRDp2GpiaB3r4xUb1ojSBiaZ2qXEfUGBPUYNy1TCHg0YU6QOp0qwibQTA/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6RRDp2GpiaB3r4xUb1ojSBiaZ2qXEfUGBPUYNy1TCHg0YU6QOp0qwibQTA/640?wx_fmt=png"></figure><pre><code>rm(list = ls())<br>library(stringr)<br>library(caret)<br>library(survminer)<br>library(survival)<br><span>#载入TCGA表达矩阵和临床信息表格：</span><br><span>load</span>(<span>'markerssce.markers.Rdata'</span>) <br><span>library</span>(timeROC)<br><span>library</span>(survival)<br><span>library</span>(clusterProfiler)<br><span>library</span>(stringr)<br><br>gene &lt;- TEC_sig$gene<br><br><span>#基因名称转换，返回的是数据框</span><br>gene = bitr(gene, fromType=<span>"SYMBOL"</span>, toType=<span>"ENTREZID"</span>, OrgDb=<span>"org.Hs.eg.db"</span>)<br><br><span>go</span> &lt;- enrichGO(gene = gene$ENTREZID, OrgDb = <span>"org.Hs.eg.db"</span>, ont=<span>"all"</span>)<br>barplot(<span>go</span>, <span>split</span>=<span>"ONTOLOGY"</span>,showCategory = <span>10</span>,label_format=<span>100</span>) + facet_grid(ONTOLOGY~., scale=<span>"free"</span>)<br><br>p1 &lt;- dotplot(<span>go</span>, <span>split</span> = <span>"ONTOLOGY"</span>, showCategory = <span>10</span>, label_format = <span>100</span>) + <br>  facet_grid(ONTOLOGY ~ ., scale = <span>"free"</span>) +<br>  ggtitle(<span>"GO"</span>)<br><br>a = <span>go</span>@<span>result</span><br><br>write.csv(a,<span>file</span> = <span>'GO.csv'</span>)<br><br>kk.diff &lt;- enrichKEGG(gene         = gene$ENTREZID,<br>                      organism     = <span>'hsa'</span>,<br>                      pvalueCutoff = <span>0.9</span>)<br><br><br>a = kk.diff@<span>result</span><br>p2 = dotplot(kk.diff, showCategory = <span>10</span>,label_format=<span>100</span>)+<br>  ggtitle(<span>"KEGG"</span>)<br>write.csv(a,<span>file</span> = <span>'KEGG.csv'</span>)<br><span>library</span>(patchwork)<br>p1+p2<br></code></pre><p>然后再就是基因集的GO和KEGG富集分析，主要与血管生成调节、血管生成、血管生成调节、内皮细胞增殖分化迁移、白细胞跨内皮细胞迁移、细胞粘附等特征有关<strong>。</strong><br></p><figure><img data-ratio="0.5453703703703704" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6HKbyIXibOicxteibS1bLq2iaJ9Z4duLFNgbosbYXuniaosuG2PDC0s4iciazA/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6HKbyIXibOicxteibS1bLq2iaJ9Z4duLFNgbosbYXuniaosuG2PDC0s4iciazA/640?wx_fmt=png"></figure><br>文中只有87个基因，我这里有一堆，对这几百个基因进行单因素Cox回归分析，得到40个与预后相关的基因。<pre><code>rm(list = ls())<br>proj = <span>"TCGA-LIHC"</span><br>load(paste<span>0</span>(proj,<span>"_sur_model.Rdata"</span>))<br>ls()<br>exprSet[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>meta[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><br><span>### 2.KM-plot</span><br>library(survival)<br>library(survminer)<br>table(gene$SYMBOL %in% rownames(exprSet))<br>exprSet = as.data.frame(exprSet)<br>exprSet &lt;- exprSet[gene$SYMBOL,]<br>str(exprSet)<br><span>#exp &lt;- log2(exp+1) #取log(FPKM+1)进行后续分析。</span><br>exprSet = na.omit(exprSet)<br><br><br>sfit &lt;- survfit(Surv(<span>time</span>, event)~grade, data=meta)<br>ggsurvplot(sfit,pval=TRUE)<br>ggsurvplot(sfit,<br>           palette = <span>"jco"</span>,<br>           risk.table =TRUE,<br>           pval =TRUE,<br>           conf.int =TRUE)<br><br><br><span>### 2.log-rank test</span><br><span>#KM的p值是log-rank test得出的，可以批量操作</span><br>logrankfile = paste<span>0</span>(proj,<span>"_log_rank_p.Rdata"</span>)<br><span>if</span>(!file.exists(logrankfile)){<br>  log_rank_p &lt;- apply(exprSet , <span>1</span> , function(gene){<br>    <span># gene=exprSet[1,]</span><br>    meta$group=ifelse(gene&gt;median(gene),<span>'high'</span>,<span>'low'</span>)  <br>    data.survdiff=survdiff(Surv(<span>time</span>, event)~group,data=meta)<br>    p.val = <span>1</span> - pchis<span>q(data.survdiff$chisq, length(data.survdiff$n)</span> - <span>1</span>)<br>    <span>return</span>(p.val)<br>  })<br>  log_rank_p=<span>sort</span>(log_rank_p)<br>  save(log_rank_p,file = logrankfile)<br>}<br>load(logrankfile)<br>table(log_rank_p&lt;<span>0</span>.<span>01</span>) <br>table(log_rank_p&lt;<span>0</span>.<span>05</span>) <br><br><br><span># 挑一个p值小的基因来做KM_plot</span><br>g = names(log_rank_p)[<span>1</span>];g<br>meta$gene = ifelse(exprSet[g,]&gt; median(exprSet[g,]),<span>'high'</span>,<span>'low'</span>)<br>sfit=survfit(Surv(<span>time</span>, event)~gene, data=meta)<br>ggsurvplot(sfit,pval =TRUE, data = meta, risk.table = TRUE)<br><br><br><span>### 3.批量单因素cox</span><br>coxfile = paste<span>0</span>(proj,<span>"_cox.Rdata"</span>)<br><span>if</span>(!file.exists(coxfile)){<br>  cox_results &lt;-apply(exprSet , <span>1</span> , function(gene){<br>    <span>#gene= exprSet[1,]</span><br>    meta$gene = gene<br>    <span>#可直接使用连续型变量</span><br>    <span>m</span> = coxph(Surv(<span>time</span>, event) ~ gene, data =  meta)<br>    <span>#也可使用二分类变量</span><br>    <span>#meta$group=ifelse(gene&gt;median(gene),'high','low') </span><br>    <span>#m=coxph(Surv(time, event) ~ group, data =  meta)</span><br>    beta &lt;- coef(<span>m</span>)<br>    se &lt;- <span>sqrt</span>(diag(vcov(<span>m</span>)))<br>    HR &lt;- <span>exp</span>(beta)<br>    HRse &lt;- HR * se<br><br>    <span>#summary(m)</span><br>    tmp &lt;- round(cbind(coef = beta, <br>                       se = se, z = beta/se, <br>                       p = <span>1</span> - pchis<span>q((beta/se)</span>^<span>2</span>, <span>1</span>),<br>                       HR = HR, HRse = HRse,<br>                       HRz = (HR - <span>1</span>) / HRse, <br>                       HRp = <span>1</span> - pchis<span>q(((HR - 1)</span>/HRse)^<span>2</span>, <span>1</span>),<br>                       HRCILL = <span>exp</span>(beta - qnorm(.<span>975</span>, <span>0</span>, <span>1</span>) * se),<br>                       HRCIUL = <span>exp</span>(beta + qnorm(.<span>975</span>, <span>0</span>, <span>1</span>) * se)), <span>3</span>)<br><br>    <span>return</span>(tmp[<span>'gene'</span>,]) <br>    <span>#return(tmp['grouplow',])#二分类变量</span><br>  })<br>  cox_results=as.data.frame(t(cox_results))<br>  save(cox_results,file = coxfile)<br>}<br>load(coxfile)<br>table(cox_results$p&lt;<span>0</span>.<span>01</span>)<br>table(cox_results$p&lt;<span>0</span>.<span>05</span>)<br><br>lr = names(log_rank_p)[log_rank_p&lt;<span>0</span>.<span>01</span>];<span>length</span>(lr)<br>cox = rownames(cox_results)[cox_results$p&lt;<span>0</span>.<span>01</span>];<span>length</span>(cox)<br><span>length</span>(intersect(lr,cox))<br>inter = intersect(lr,cox)<br>save(lr,cox,inter,file = paste<span>0</span>(proj,<span>"_logrank_cox_gene.Rdata"</span>))<br></code></pre><figure><img data-ratio="0.17314814814814813" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6Af9cia2dzpk9vOoZjYLTBDXchA0RRmXOK1N3iaVoQibJfrUpNdib1VVqmQ/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6Af9cia2dzpk9vOoZjYLTBDXchA0RRmXOK1N3iaVoQibJfrUpNdib1VVqmQ/640?wx_fmt=png"><figcaption><br></figcaption></figure>为了避免模型过度拟合，对单变量Cox回归的结果进行了LASSO回归分析<strong>。</strong><pre><code>rm(list = ls())<br>proj = <span>"TCGA-LIHC"</span><br>load(paste0(proj,<span>"_sur_model.Rdata"</span>))<br>ls()<br><span>exprSet[1:4,1:4]</span><br><span>meta[1:4,1:4]</span><br>load(paste0(proj,<span>"_logrank_cox_gene.Rdata"</span>))<br>exprSet = exprSet[inter,]<br><br><br><span>### 2.构建lasso回归模型</span><br><span>#输入数据是表达矩阵(仅含tumor样本)和每个病人对应的生死（顺序必须一致）。</span><br><br>x=t(exprSet)<br>y=meta$event<br>library(glmnet)<br><br><span>#### 2.1挑选合适的λ值</span><br><span>#- Lambda 是构建模型的重要参数。他的大小关系着模型选择的基因个数</span><br><span>#调优参数</span><br>set.seed(10)<br>cv_fit &lt;- cv.glmnet(x=x, y=y)<br>plot(cv_fit)<br><br><span>#系数图</span><br>fit &lt;- glmnet(x=x, y=y)<br>plot(fit,xvar = <span>"lambda"</span>)<br></code></pre><figure><img data-ratio="0.38055555555555554" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF62TDUuInOS9bm1gAvXoib2ZTLEoBQ261tRXN41wBOcugYLibtONbJIdxQ/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF62TDUuInOS9bm1gAvXoib2ZTLEoBQ261tRXN41wBOcugYLibtONbJIdxQ/640?wx_fmt=png"></figure><br>min的模型预测AUC还算高<pre><code><span>#### 2.2 用这两个λ值重新建模</span><br>model_lasso_min &lt;- glmnet(<span>x</span>=<span>x</span>, <span>y</span>=<span>y</span>,lambda=cv_fit$lambda.min)<br>model_lasso_1se &lt;- glmnet(<span>x</span>=<span>x</span>, <span>y</span>=<span>y</span>,lambda=cv_fit$lambda.<span>1</span>se)<br><br><span>#选中的基因与系数存放于模型的子集beta中，用到的基因有一个s0值，没用的基因只记录了“.”，所以可以用下面代码挑出用到的基因。</span><br>head(model_lasso_min$beta,<span>20</span>)<br>choose_gene_min=rownames(model_lasso_min$beta)[as.numeric(model_lasso_min$beta)!=<span>0</span>]<br>choose_gene_1se=rownames(model_lasso_1se$beta)[as.numeric(model_lasso_1se$beta)!=<span>0</span>]<br><span>length</span>(choose_gene_min)<br><span>length</span>(choose_gene_1se)<br>save(choose_gene_min,file = paste<span>0</span>(proj,<span>"_lasso_choose_gene_min.Rdata"</span>))<br>save(choose_gene_1se,file = paste<span>0</span>(proj,<span>"_lasso_choose_gene_1se.Rdata"</span>))<br><br><br><span>### 3.模型预测和评估</span><br><span>#newx参数是预测对象。输出结果lasso.prob是一个矩阵，第一列是min的预测结果，第二列是1se的预测结果，预测结果是概率，或者说百分比，不是绝对的0和1。</span><br><span>#将每个样本的生死和预测结果放在一起，直接cbind即可。</span><br>lasso.prob &lt;- predict(cv_fit, newx=<span>x</span> , <span>s</span>=c(cv_fit$lambda.min,cv_fit$lambda.<span>1</span>se) )<br>re=cbind(<span>y</span> ,lasso.prob)<br>head(re)<br>re=as.data.frame(re)<br>colnames(re)=c(<span>'event'</span>,<span>'prob_min'</span>,<span>'prob_1se'</span>)<br>re$event=as.factor(re$event)<br><br><span>#### ROC曲线</span><br>library(pROC)<br>library(ggplot2)<br><span>m</span> &lt;- roc(meta$event, re$prob_min)<br>g &lt;- ggroc(<span>m</span>,legacy.axes = T,size = <span>1</span>,color = <span>"#2fa1dd"</span>)<br>auc(<span>m</span>)<br><br>g + theme_minimal() +<br>  geom_segment(aes(<span>x</span> = <span>0</span>, xend = <span>1</span>, <span>y</span> = <span>0</span>, yend = <span>1</span>), <br>               colour = <span>"grey"</span>, linetype = <span>"dashed"</span>)+<br>  annotate(<span>"text"</span>,<span>x</span> = .<span>75</span>, <span>y</span> = .<span>25</span>,<br>           label = paste(<span>"AUC of min = "</span>,<span>format</span>(round(as.numeric(auc(<span>m</span>)),<span>2</span>),nsmall = <span>2</span>)),color = <span>"#2fa1dd"</span>)<br><br><span>#计算AUC取值范围在0.5-1之间，越接近于1越好。可以根据预测结果绘制ROC曲线。</span><br><br><span>#两个模型的曲线画在一起</span><br>m2 &lt;- roc(meta$event, re$prob_1se)<br>auc(m2)<br>g1 &lt;- ggroc(list(min = <span>m</span>,se = m2),legacy.axes = T,size = <span>1</span>)<br><br>g1 + theme_minimal() +<br>  scale_color_manual(<span>values</span> = c(<span>"#2fa1dd"</span>, <span>"#f87669"</span>)) +<br>  geom_segment(aes(<span>x</span> = <span>0</span>, xend = <span>1</span>, <span>y</span> = <span>0</span>, yend = <span>1</span>), <br>               colour = <span>"grey"</span>, linetype = <span>"dashed"</span>) +<br>  annotate(<span>"text"</span>, <span>x</span> = <span>0</span>.<span>75</span>, <span>y</span> = <span>0</span>.<span>25</span>,<br>           label = paste(<span>"AUC of min = "</span>, <span>sprintf</span>(<span>"%.2f"</span>, auc(<span>m</span>))), color = <span>"#2fa1dd"</span>) +<br>  annotate(<span>"text"</span>, <span>x</span> = <span>0</span>.<span>75</span>, <span>y</span> = <span>0</span>.<span>15</span>,<br>           label = paste(<span>"AUC of 1se = "</span>, <span>sprintf</span>(<span>"%.2f"</span>, auc(m2))), color = <span>"#f87669"</span>)<br></code></pre><figure><img data-ratio="0.8731481481481481" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6Gj6OmcbUN8ttH41BotlSWgDdtoFZiahfz5ia6cg00iaTuWH7WLTIUrcqQ/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6Gj6OmcbUN8ttH41BotlSWgDdtoFZiahfz5ia6cg00iaTuWH7WLTIUrcqQ/640?wx_fmt=png"><figcaption><br></figcaption></figure>选出了上面的预后基因后，直接开始多因素分析<pre><code><span>### 1.准备输入数据</span><br><span>##感觉还是选择min好一点</span><br>c(<span>"RAMP3"</span>,<span>"FEZ2"</span> ,   <span>"GIT1"</span>   , <span>"LIMS2"</span> ,  <span>"PLPP1"</span> ,  <span>"CALM1"</span>  ,<br><span>"INF2"</span>  ,  <span>"HDLBP"</span> , <span>"ADAM15"</span> , <span>"DCTN2"</span>  , <span>"LAMB1"</span>  , <span>"RAPGEF3"</span>)<br>rm(list = ls())<br>proj = <span>"TCGA-LIHC"</span><br>if(!require(My.stepwise))install.packages(<span>"My.stepwise"</span>)<br>load(paste0(proj,<span>"_sur_model.Rdata"</span>))<br>load(paste0(proj,<span>"_lasso_choose_gene_min.Rdata"</span>))<br>g = choose_gene_min<br><br><span>### 2.构建coxph模型 </span><br><span>#将用于建模的基因（例如lasso回归选中的基因）从表达矩阵中取出来，，可作为列添加在meta表噶的后面,组成的数据框赋值给dat。</span><br>library(stringr)<br>e=t(exprSet[g,])<br>colnames(e)= str_replace_all(colnames(e),<span>"-"</span>,<span>"_"</span>)<br>dat=cbind(meta,e)<br><br>dat$stage=as.numeric(factor(dat$stage))<br>colnames(dat)<br><br><span>### 逐步回归法构建最优模型</span><br>library(survival)<br>library(survminer)<br><span># 不能允许缺失值</span><br>dat2 = na.omit(dat)<br>library(My.stepwise)<br><br><span>#dat2 = dat2[,-1]</span><br>vl &lt;- colnames(dat2)[c(11:ncol(dat2))]<br>My.stepwise.coxph(Time = <span>"time"</span>,<br>                  Status = <span>"event"</span>,<br>                  variable.list = vl,<br>                  data = dat2)<br><br><span>#使用输出结果里的最后一个模型</span><br>model = coxph(formula = Surv(time, event) ~ RAMP3 + FEZ2 + GIT1 + <br>                LIMS2 + PLPP1 + CALM1 + INF2 + HDLBP + ADAM15 + <br>                DCTN2 + LAMB1 + RAPGEF3 , data = dat2)<br><br><br><span>### 3.模型可视化-森林图</span><br>ggforest(model,data = dat2)<br><br><span>### 4.模型预测</span><br>fp &lt;- predict(model,newdata = dat2)<br>library(Hmisc)<br>options(scipen=200)<br>with(dat2,rcorr.cens(fp,Surv(time, event)))<br></code></pre><figure><img data-ratio="0.6759259259259259" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6u4lpdSMjJw1otQJlrzfC7C6hYQRt7mCyhPAlZaqIGHOgUxKUibAKyvg/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6u4lpdSMjJw1otQJlrzfC7C6hYQRt7mCyhPAlZaqIGHOgUxKUibAKyvg/640?wx_fmt=png"><figcaption><br></figcaption></figure>按照现在模型来看，直接综合为riskscore<pre><code>dat2$riskscore = fp<br>vl <span>&lt;<span>-</span> <span>colnames</span>(<span>dat2</span>)[<span>c</span>(<span>10:ncol</span>(<span>dat2</span>))]<br><span>My.stepwise.coxph</span>(<span>Time</span> = <span>"time"</span>,<br>                  <span>Status</span> = <span>"event"</span>,<br>                  <span>variable.list</span> = <span>vl,</span><br>                  <span>data</span> = <span>dat2)</span><br><br><br>#使用输出结果里的最后一个模型<br><br><span>model1</span> = <span>coxph(formula</span> = <span>Surv(time,</span> <span>event</span>) ~ <span>grade</span>+<span>M</span>+<span>T</span>+<span>N</span>+<span>stage</span>+<span>riskscore</span> , <span>data</span> = <span>dat2)</span><br><br><br>### <span>3.</span>模型可视化<span>-</span>森林图<br><span>ggforest</span>(<span>model1</span>,<span>data</span> = <span>dat2)</span><br></span></code></pre><p>可以看到风险因子很显著<br></p><figure><img data-ratio="0.7685185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6yzY2OvVXSiaDvfEp6zEgwE6ksqzlNhibkEksGhGZCZqalPNsLPctEbnw/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6yzY2OvVXSiaDvfEp6zEgwE6ksqzlNhibkEksGhGZCZqalPNsLPctEbnw/640?wx_fmt=png"></figure><pre><code><span>### 2.划分高低风险并画生存分析图<br>names(fp) = dat2$ID<br>ri = ifelse(fp<span>&lt;<span>median(fp),"lowrisk","highrisk")</span><br><span>ri</span> = <span>factor(ri,levels</span> = <span>c(</span>"<span>lowrisk</span>","<span>highrisk</span>"))<br><br><span>sfit</span> &lt;<span>-</span> <span>survfit</span>(<span>Surv</span>(<span>time</span>, <span>event</span>)~<span>ri</span>, <span>data</span>=<span>dat2)</span><br><br><span>ggsurvplot</span>(<span>sfit</span>,<span>palette</span> = <span>c(</span>"#<span>E7B800</span>", "#<span>2E9FDF</span>"),<br>           <span>risk.table</span> =<span>TRUE,pval</span> =<span>TRUE,</span><br>           <span>conf.int</span> =<span>TRUE,xlab</span> =<span>"Time in months"</span>, <br>           <span>ggtheme</span> =<span>theme_light())</span><br><br>#### <span>2</span> <span>time-ROC</span>计算和出图<br><span>library</span>(<span>survminer</span>)<br><span>library</span>(<span>survival</span>)<br><span>library</span>(<span>timeROC</span>)<br>##这里是看<span>OS</span>时间是什么单位，<span>times</span>就用什么单位<br><span>result</span> &lt;<span>-with</span>(<span>dat2</span>, <span>timeROC</span>(<span>T</span>=<span>time,</span><br>                           <span>delta</span>=<span>event,</span><br>                           <span>marker</span>=<span>fp,</span><br>                           <span>cause</span>=<span>1,</span><br>                           <span>times</span>=<span>c(12,24,36,48,60),</span><br>                           <span>iid</span> = <span>TRUE))</span><br><span>plot_dat</span> = <span>data.frame(fpr</span> = <span>as.numeric(result$FP),</span><br>                      <span>tpr</span> = <span>as.numeric(result$TP),</span><br>                      <span>time</span> = <span>rep(as.factor(c(12,24,36,48,60)),each</span> = <span>nrow(result$TP)))</span><br><br><span>library</span>(<span>ggplot2</span>)<br><span>ggplot</span>() + <br>  <span>geom_line</span>(<span>data</span> = <span>plot_dat,aes(x</span> = <span>fpr,</span> <span>y</span> = <span>tpr,color</span> = <span>time),size</span> = <span>1)</span> + <br>  <span>scale_color_manual</span>(<span>name</span> = <span>NULL,values</span> = <span>c(</span>"#<span>2874C5</span>", "#<span>f87669</span>", "#<span>e6b707</span>",'<span>green</span>','<span>yellow</span>'),<br>                     <span>labels</span> = <span>paste0(</span>"<span>AUC</span> <span>of</span> ",<span>c</span>(<span>1</span>,<span>2</span>,<span>3</span>,<span>4</span>,<span>5</span>),"<span>-y</span> <span>survival:</span> ",<br>                                     <span>format</span>(<span>round</span>(<span>result</span>$<span>AUC</span>,<span>2</span>),<span>nsmall</span> = <span>2)))+</span><br>  <span>geom_line</span>(<span>aes</span>(<span>x</span>=<span>c(0,1),y</span>=<span>c(0,1)),color</span> = <span>"grey"</span>)+<br>  <span>theme_bw</span>()+<br>  <span>theme</span>(<span>panel.grid</span> = <span>element_blank(),</span><br>        <span>legend.background</span> = <span>element_rect(linetype</span> = <span>1,</span> <span>size</span> = <span>0.2,</span> <span>colour</span> = <span>"black"</span>),<br>        <span>legend.position</span> = <span>c(0.765,0.125))+</span><br>  <span>scale_x_continuous</span>(<span>expand</span> = <span>c(0.005,0.005))+</span><br>  <span>scale_y_continuous</span>(<span>expand</span> = <span>c(0.005,0.005))+</span><br>  <span>labs</span>(<span>x</span> = <span>"1 - Specificity"</span>,<br>       <span>y</span> = <span>"Sensitivity"</span>)+<br>  <span>coord_fixed</span>()<br></span></span></code></pre><p>挺符合常理的，模型预测的准确率随着时间延长逐渐减弱。<br></p><figure><img data-ratio="0.4888888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6ayrP80H0QJP2S6tp0srGKvtyQghYRkqx7lna3YMeUj3UEK4res9bcg/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6ayrP80H0QJP2S6tp0srGKvtyQghYRkqx7lna3YMeUj3UEK4res9bcg/640?wx_fmt=png"><figcaption>image.png</figcaption></figure><pre><code><span>### 3.风险因子三图联动</span><br>fp_dat=data.frame(patientid=<span>1</span>:<span>length</span>(fp),<br>                  fp=as.numeric(<span>sort</span>(fp)),<br>                  ri= ri[order(fp)])<br><br>sur_dat=data.frame(patientid=<span>1</span>:<span>length</span>(fp),<br>                   <span>time</span>=dat2[order(fp),<span>'time'</span>] ,<br>                   event=dat2[order(fp),<span>'event'</span>]) <br><br>sur_dat$event=ifelse(sur_dat$event==<span>0</span>,<span>'alive'</span>,<span>'death'</span>)<br>sur_dat$event=factor(sur_dat$event,levels = c(<span>"death"</span>,<span>"alive"</span>))<br><br>library(stringr)<br>gs = str_split(<span>"RAMP3 + FEZ2 + GIT1 + LIMS2 + PLPP1 + CALM1 + INF2 + HDLBP + ADAM15 + DCTN2 + LAMB1 + RAPGEF3"</span>,<span>" \\+ "</span>)[[<span>1</span>]]<br>gs<br>exp_dat = t(dat2[order(fp),gs])<br>colnames(exp_dat) = str_sub(colnames(exp_dat),<span>1</span>,<span>12</span>)<br>rownames(exp_dat) = str_replace_all(rownames(exp_dat),<span>"_"</span>,<span>"-"</span>)<br><span>###第一个图----</span><br>p1=ggplot(fp_dat,aes(<span>x</span>=patientid,<span>y</span>=fp))+<br>  geom_point(aes(color = ri))+<br>  scale_color_manual(<span>values</span> = c(<span>"#2874C5"</span>, <span>"#f87669"</span>))+<br>  geom_vline(xintercept = <span>0</span>.<span>5</span>*nrow(sur_dat),lty = <span>2</span>)+<br>  scale_x_continuous(expand=c(<span>0</span>.<span>01</span>,<span>0</span>))+<br>  labs(<span>x</span> = <span>""</span>,<span>y</span> = <span>"risk score"</span>)+<br>  theme_bw()<br><span>#第二个图</span><br>p2=ggplot(sur_dat,aes(<span>x</span>=patientid,<span>y</span>=<span>time</span>))+<br>  geom_point(aes(col=event))+<br>  scale_color_manual(<span>values</span> = c(<span>"#f87669"</span>,<span>"#2874C5"</span>))+<br>  geom_vline(xintercept = <span>0</span>.<span>5</span>*nrow(sur_dat),lty = <span>2</span>)+<br>  scale_x_continuous(expand=c(<span>0</span>.<span>01</span>,<span>0</span>))+<br>  labs(<span>x</span> = <span>""</span>)+<br>  theme_bw()<br><span>#第三个图</span><br><br>annotation_col = data.frame(group = ri,<br>                            row.names = names(ri))<br>mycolors &lt;- colorRampPalette(c(<span>"#2874C5"</span>,<span>"white"</span>, <span>"#f87669"</span>), bias = <span>1.2</span>)(<span>100</span>)<br>ann_colors = list(<br>  group = c(lowrisk=<span>"#2874C5"</span>, highrisk=<span>"#f87669"</span>)<br>)<br>p3=pheatmap::pheatmap(exp_dat,<br>                      col= mycolors,<br>                      annotation_col = annotation_col,<br>                      annotation_colors =ann_colors,<br>                      scale = <span>"row"</span>,<br>                      breaks = se<span>q(-3,3,length.out = 100)</span>,<br>                      show_colnames = F,<br>                      cluster_cols = F,<br>                      annotation_legend = F)<br><span>#拼图实现三图联动</span><br>library(ggpubr)<br>library(gridExtra)<br>library(patchwork)<br>library(ggplot2)<br>library(grid)<br>library(ggplotify)<br>p1/p2/as.ggplot(p3)<br></code></pre><figure><img data-ratio="0.8537037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6u2iawrLJR022G98NFWNQm7yAH9axensp2icSNNaGyibzMXIaX7dNyVZnA/640?wx_fmt=png" data-type="png" data-w="1080" title="image.png" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9eNSNB6x9Gpiay0Micvg0lF6u2iawrLJR022G98NFWNQm7yAH9axensp2icSNNaGyibzMXIaX7dNyVZnA/640?wx_fmt=png"></figure><br>本来想做个后面的免疫浸润，突然想起来很久以前的一个问题，服务器上不知道怎么回事跑不出来CIBERSORT，我每次得本地跑出来存为Rdata然后再load上去，罢了精华都在上面了。</section><hr><section><strong>大家下个月再见。</strong><br><p><br></p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/hsGvQm9sdALqUZKgZzbC8g",target="_blank" rel="noopener noreferrer">原文链接</a>
