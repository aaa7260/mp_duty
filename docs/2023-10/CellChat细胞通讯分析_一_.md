---
title: "CellChat细胞通讯分析（一）"
date: 2023-10-31T09:21:47Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
CellChat细胞通讯分析（一） by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">曾老师在 【<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497617&amp;idx=2&amp;sn=fe47078075a3b9994079761f96870aa3&amp;scene=21#wechat_redirect" data-linktype="2">细胞通讯分析的背景知识</a>】一文中介绍到：不同细胞类型和组织中的细胞之间相互作用(CCI)，主要是通过各种分子包括离子、代谢物、整联蛋白、受体、连接蛋白、结构蛋白、配体和细胞外基质的分泌蛋白来实现的。一些分子如激素、生长因子、趋化因子、细胞因子和神经递质等配体介导细胞之间的信息交流(CCC)。人们可以从基因表达中推断出CCI和CCC，尤其是在单细胞转录组测序之后，以RNA为代表的细胞信息之间的相互作用更能够对其进行解析。</p><p data-tool="mdnice编辑器">细胞之间的相互通讯极为复杂，一般由激素、生长因子、趋化因子、细胞因子和神经递质等配体介导细胞之间的信息交流，主要分为自分泌，旁分泌，近分泌和内分泌等。当前基于单细胞转录组测序，进行细胞通讯分析越来越常见。细胞通讯的方法主要有CellphoneDB（基于Python），Cellchat（基于R），iTALK（基于R），NicheNet等方法。生信技能树，生信菜鸟团和单细胞天地写了大量关于细胞通讯的帖子，例如：</p><ul data-tool="mdnice编辑器"><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511214&amp;idx=2&amp;sn=f6de43b97f62b597b01e16e0b3b898ca&amp;scene=21#wechat_redirect" data-linktype="2">直接为CellPhoneDB创建一个独立的conda环境</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511169&amp;idx=1&amp;sn=c8da9ab475ee4a433025ad09f3043c5b&amp;scene=21#wechat_redirect" data-linktype="2">把Seurat对象里面表达量矩阵和细胞表型信息输出给CellPhoneDB做细胞通讯</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497653&amp;idx=2&amp;sn=320d26cad3d8141bb081d6ff798ae778&amp;scene=21#wechat_redirect" data-linktype="2">细胞通讯分析结果的解读</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247511290&amp;idx=1&amp;sn=d79c15816f5866adff6e79a6d717401d&amp;scene=21#wechat_redirect" data-linktype="2">CellPhoneDB的单细胞通讯结果的可视化之气泡图</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247490531&amp;idx=1&amp;sn=e94dfedc6f7e5b80b73b00f73d4cb3b6&amp;scene=21#wechat_redirect" data-linktype="2">cellphonedb 及其可视化</a></p></section></li><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247487845&amp;idx=1&amp;sn=7346517da8ce6f5b95fe7fb640a87403&amp;scene=21#wechat_redirect" data-linktype="2">CellChat：细胞间相互作用分析利器</a></p></section></li><li><section><p>.....</p></section></li></ul><p data-tool="mdnice编辑器">我最近因为课题需要，仔细阅读了CellChat的官方文档。虽然CellChat的文档今年刚更新，但是我在实战中还是遇到了很多Bug......另外，在深入理解这个包的函数和分析<span>思维</span>逻辑之后，感触很多，由此萌生了写此系列的想法：</p><ul data-tool="mdnice编辑器"><li><section>一方面帮助大家debug，少走一些弯路；</section></li><li><section>另一方面，分享我对CellChat的一些（狭隘的）理解，以及使用过程发现的小技巧。</section></li></ul><p data-tool="mdnice编辑器">在生物学知识以外，希望能给需要的人一些启发。</p><h3 data-tool="mdnice编辑器">一. CellChat介绍</h3><p data-tool="mdnice编辑器">CellChat R包于2021年1月发表在Nature communication上，论文题为《Inference and analysis of cell-cell communication using CellChat》，DOI: 10.1038/s41467-021-21246-9. 当前引用量400+。虽然引用量低于隔壁的CellphoneDB，但CellChat基于R语言环境，和Seurat衔接比较好，同时其具备丰富的可视化函数（颜值还不低），所以当前的热度也很高。</p><p data-tool="mdnice编辑器">实际上，无论是CellphoneDB还是CellChat，其基于单细胞转录组数据推断细胞间通讯，均是利用对受配体的先验知识，即基于当前已知的/已证明的互作的受配体对，对细胞与细胞之间的通讯情况进行建模，来预测细胞A和细胞B的受配体通讯情况，从而构建细胞间通讯网络。在此基础上CellChat为进一步的数据探索、分析和可视化提供了大量的函数。</p><p data-tool="mdnice编辑器">值得注意的是，CellChat采用了一种自上而下的方法，即从宏观角度为始，然后在信号机制上细化它的更详细的细节（微观解读），以识别不同层次的信号变化，包括细胞-细胞通讯的一般原则和功能失调的细胞群/信号通路/配体受体。简言之，CellChat回答三个角度的问题：</p><ul data-tool="mdnice编辑器"><li><section><p>首先，哪些细胞亚群和哪些细胞亚群互作（包括细胞A与自己本身，即为自分泌），互作的数量和强度;</p><blockquote><p>这里的互作数量实际就是细胞A和细胞B存在的配受体对，总共存在几对；其强度可以理解为对应配受体对通讯概率的累和。</p></blockquote></section></li><li><section><p>其次，细胞亚群A和细胞亚群B存在哪些通讯相关的通路，而本质上，配受体对应的基因构成了通讯通路；</p></section></li><li><section><p>因此，第三个问题就是回答亚群A和细胞亚群B存在哪些互作的配受体，其通讯概率多大。</p></section></li></ul><p data-tool="mdnice编辑器">在运行CellChat的基本流程之后得到了细胞间通讯网络，从这里开始，围绕这三个问题，作者给出了一系列的代码和可视化函数。带着这种自上而下，从细胞，到通路，再到基因（受配体对）的思维，我们能够更好的理解作者的分析思路和代码思维。首先第一步，安装CellChat R包：</p><ul data-tool="mdnice编辑器"><li><section><p>CellChat 的github：https://github.com/sqjin/CellChat</p></section></li><li><section><p>数据库官网：http://www.cellchat.org/</p></section></li><li><section><p>R包CellChat的安装：</p></section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>remotes::install_github(<span>"sqjin/CellChat"</span>)<br></code></pre><h3 data-tool="mdnice编辑器">二. 利用CellChat进行细胞间通讯的推断与分析</h3><h4 data-tool="mdnice编辑器">Part I：CellChat对象的数据输入、处理和初始化</h4><p data-tool="mdnice编辑器">CellChat需要输入两部分数据：</p><ul data-tool="mdnice编辑器"><li><section>一是单细胞的基因表达数据（例如用Seurat包的normalizeData后的data数据，表达矩阵储存在seurat.data@assays$RNA@data）；</section></li><li><section>二是单细胞数据的meta.data，其中包含细胞类型的注释信息。</section></li></ul><p data-tool="mdnice编辑器">下面加载Seurat自带的PMBC单细胞数据作为演示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(CellChat)<br><span>library</span>(patchwork)<br><span>library</span>(Seurat)<br><span>library</span>(SeuratData)<br><span># AvailableData()</span><br><span># InstallData("pbmc3k")</span><br>options(stringsAsFactors = <span>FALSE</span>)<br>data(<span>"pbmc3k"</span>)<br>pbmc3k<br></code></pre><h5 data-tool="mdnice编辑器">Step1. 构建cellchat对象</h5><pre data-tool="mdnice编辑器"><span></span><code><span>#pbmc3k里的seurat_annotations有一些NA注释，过滤掉</span><br>data.input = pbmc3k@assays$RNA@data<br>meta.data =  pbmc3k@meta.data<br>meta.data = meta.data[!is.na(meta.data$seurat_annotations),]<br>data.input = data.input[,row.names(meta.data)]<br><br><span>#设置因子水平</span><br>meta.data$seurat_annotations = factor(meta.data$seurat_annotations,<br>                                      levels = c(<span>"Naive CD4 T"</span>, <span>"Memory CD4 T"</span>, <span>"CD14+ Mono"</span>, <span>"B"</span>, <span>"CD8 T"</span>, <br>                                                 <span>"FCGR3A+ Mono"</span>, <span>"NK"</span>, <span>"DC"</span>, <span>"Platelet"</span>))<br><br><span>### 1.2 Create a CellChat object</span><br>cellchat &lt;- createCellChat(object = data.input, <br>                           meta = meta.data, <br>                           group.by = <span>"seurat_annotations"</span>)<br></code></pre><p data-tool="mdnice编辑器">和Seurat一样，如有需要的话，可在CellChat对象的meta插槽中添加表型信息，以及更改当前默认的<strong>idents</strong>：</p><pre data-tool="mdnice编辑器"><span></span><code><span>### 1.3 可在cellchat对象的meta插槽中添加表型信息</span><br><span># 添加meta.data信息</span><br>cellchat &lt;- addMeta(cellchat, meta = meta.data)<br><br><span># 设置默认的labels</span><br>levels(cellchat@idents) <span># show factor levels of the cell labels</span><br>cellchat &lt;- setIdent(cellchat, ident.use = <span>"new.labels"</span>) <br>groupSize &lt;- as.numeric(table(cellchat@idents)) <span># number of cells in each cell group</span><br></code></pre><h5 data-tool="mdnice编辑器">Step2. 加载CellChatDB数据库</h5><p data-tool="mdnice编辑器">CellChatDB数据库是一个人工管理的数据库，包含了<strong>人类</strong>和<strong>小鼠</strong>的文献支持的配体-受体相互作用。</p><ul data-tool="mdnice编辑器"><li><section><strong>小鼠</strong>包含2021种已验证的分子相互作用，包括60%的分泌自分泌/旁分泌信号互作、21%的细胞外基质(ECM)受体互作和19%的细胞-细胞通讯互作。</section></li><li><section><strong>人类</strong>包含1939个已验证的分子相互作用，包括61.8%的旁分泌/自分泌信号互作、21.7%的细胞外基质(ECM)受体互作和16.5%的细胞-细胞通讯互作。</section></li></ul><p data-tool="mdnice编辑器">当然用户也可以通过添加自己精心策划的配体-受体对来更新CellChatDB（一般用的比较少），可参考https://htmlpreview.github.io/?https://github.com/sqjin/CellChat/blob/master/tutorial/Update-CellChatDB.html。</p><pre data-tool="mdnice编辑器"><span></span><code><span>### 1.4 加载CellChat受配体数据库</span><br>CellChatDB &lt;- CellChatDB.human <span># use CellChatDB.mouse if running on mouse data</span><br>showDatabaseCategory(CellChatDB)<br></code></pre><img data-ratio="0.4613686534216336" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6QUOzEdNNP9F0VAzQWwgoh9Ylp3FBBeRgUFQ9CTbdt6mC5EssfCkjCg/640?wx_fmt=other" data-type="other" data-w="906" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6QUOzEdNNP9F0VAzQWwgoh9Ylp3FBBeRgUFQ9CTbdt6mC5EssfCkjCg/640?wx_fmt=other"><pre data-tool="mdnice编辑器"><span></span><code><span># Show the structure of the database</span><br>dplyr::glimpse(CellChatDB$interaction)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>&gt; dplyr::glimpse(CellChatDB<span>$interaction</span>)<br>Rows: 1,939<br>Columns: 11<br>$ interaction_name   &lt;chr&gt; <span>"TGFB1_TGFBR1_TGFBR2"</span>, <span>"TGFB2_TGFBR1_TGFBR2"</span>, <span>"TGFB3_TGFBR1_TGFBR2"</span>, <span>"TGFB1_ACVR1B_TGFBR2"</span>, <span>"TGFB1~<br>$ pathway_name       &lt;chr&gt; "</span>TGFb<span>", "</span>TGFb<span>", "</span>TGFb<span>", "</span>TGFb<span>", "</span>TGFb<span>", "</span>TGFb<span>", "</span>TGFb<span>", "</span>TGFb<span>", "</span>TGFb<span>", "</span>TGFb<span>", "</span>TGFb<span>", "</span>TGFb<span>", "</span>B~<br>$ ligand             &lt;chr&gt; <span>"TGFB1"</span>, <span>"TGFB2"</span>, <span>"TGFB3"</span>, <span>"TGFB1"</span>, <span>"TGFB1"</span>, <span>"TGFB2"</span>, <span>"TGFB2"</span>, <span>"TGFB3"</span>, <span>"TGFB3"</span>, <span>"TGFB1"</span>, <span>"TGFB2"</span>,~<br>$ receptor           &lt;chr&gt; <span>"TGFbR1_R2"</span>, <span>"TGFbR1_R2"</span>, <span>"TGFbR1_R2"</span>, <span>"ACVR1B_TGFbR2"</span>, <span>"ACVR1C_TGFbR2"</span>, <span>"ACVR1B_TGFbR2"</span>, <span>"ACVR1C_~<br>$ agonist            &lt;chr&gt; "</span>TGFb agonist<span>", "</span>TGFb agonist<span>", "</span>TGFb agonist<span>", "</span>TGFb agonist<span>", "</span>TGFb agonist<span>", "</span>TGFb agonist<span>", "</span>T~<br>$ antagonist         &lt;chr&gt; <span>"TGFb antagonist"</span>, <span>"TGFb antagonist"</span>, <span>"TGFb antagonist"</span>, <span>"TGFb antagonist"</span>, <span>"TGFb antagonist"</span>, <span>"TG~<br>$ co_A_receptor      &lt;chr&gt; "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>", "</span><span>"~<br>$ co_I_receptor      &lt;chr&gt; "</span>TGFb inhibition receptor<span>", "</span>TGFb inhibition receptor<span>", "</span>TGFb inhibition receptor<span>", "</span>TGFb inhibiti~<br>$ evidence           &lt;chr&gt; <span>"KEGG: hsa04350"</span>, <span>"KEGG: hsa04350"</span>, <span>"KEGG: hsa04350"</span>, <span>"PMID: 27449815"</span>, <span>"PMID: 27449815"</span>, <span>"PMID: 2~<br>$ annotation         &lt;chr&gt; "</span>Secreted Signaling<span>", "</span>Secreted Signaling<span>", "</span>Secreted Signaling<span>", "</span>Secreted Signaling<span>", "</span>Secreted ~<br>$ interaction_name_2 &lt;chr&gt; <span>"TGFB1 - (TGFBR1+TGFBR2)"</span>, <span>"TGFB2 - (TGFBR1+TGFBR2)"</span>, <span>"TGFB3 - (TGFBR1+TGFBR2)"</span>, <span>"TGFB1 - (ACVR1B+~<br></span></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span># use a subset of CellChatDB for cell-cell communication analysis</span><br><span>#CellChatDB.use &lt;- subsetDB(CellChatDB, search = "Secreted Signaling") # use Secreted Signaling</span><br>CellChatDB.use &lt;- CellChatDB <span># simply use the default CellChatDB</span><br>cellchat@DB &lt;- CellChatDB.use<br></code></pre><h5 data-tool="mdnice编辑器">Step3. 对表达数据进行预处理</h5><p data-tool="mdnice编辑器">为了推断细胞状态特异性通讯，我们在一个细胞群中识别过表达的配体或受体，然后在配体或受体过度表达时识别过表达的配体-受体相互作用。我们还提供了一种函数，将基因表达数据投影到蛋白质-蛋白质相互作用(PPI)网络。具体地说，一个扩散过程是用来平滑基因表达值基于他们的邻居定义在一个高置信度实验验证的蛋白质-蛋白质网络。当分析浅层测序深度的单细胞数据时，该函数是有用的，因为投影减少了信号基因的dropout效应，特别是配体/受体亚基可能的零表达。有人可能会担心这种扩散过程可能带来的人工制品，然而，它只会带来非常弱的通讯。用户也可以跳过此步骤并设置raw<strong>。在computeCommunProb()函数中使用= TRUE</strong>。</p><pre data-tool="mdnice编辑器"><span></span><code><span>### 1.5 对表达数据进行预处理，用于细胞间通讯分析</span><br><span># subset the expression data of signaling genes for saving computation cost</span><br>cellchat &lt;- subsetData(cellchat) <span># This step is necessary even if using the whole database</span><br>future::plan(<span>"multiprocess"</span>, workers = <span>1</span>) <span># do parallel</span><br><br>cellchat &lt;- identifyOverExpressedGenes(cellchat)<br>cellchat &lt;- identifyOverExpressedInteractions(cellchat)<br><br><span># project gene expression data onto PPI (Optional: when running it, USER should set `raw.use = FALSE` in the function `computeCommunProb()` in order to use the projected data)</span><br><span># cellchat &lt;- projectData(cellchat, PPI.human)</span><br></code></pre><h4 data-tool="mdnice编辑器">Part II：细胞-细胞通讯网络的推断</h4><p data-tool="mdnice编辑器">CellChat通过给每个相互作用赋一个概率值并进行排列测试来推断生物意义的细胞-细胞通讯。CellChat通过整合基因表达和信号配体、受体及其辅助因子之间相互作用的先验知识，利用质量作用定律来建模细胞-细胞间通讯的概率。<strong>推断出的配体-受体对的数目显然取决于计算每个细胞组平均基因表达的方法</strong>。默认情况下，CellChat使用一种统计上稳健的平均值方法，叫做trimean，它产生的交互比其他方法少。然而，我们发现，CellChat在预测更强的交互方面表现得很好，这对缩小交互范围进行进一步的实验验证非常有帮助。在<strong>computeCommunProb</strong>中，我们提供了使用其他方法(如5%和10%截断平均值)来计算平均基因表达的选项。值得注意的是，<strong>trimean近似于25%的截断平均值，这意味着如果一组中表达细胞的百分比小于25%，那么平均基因表达为零。</strong>要使用<strong>10%<strong>的截断平均值，用户可以设置</strong>type = "truncatedMean"<strong>和</strong>trim = 0.1</strong>。<strong>computeAveExpr</strong>函数可以帮助检查信号基因的平均表达，如<strong>computeAveExpr(cellchat, features = c("CXCL12"，"CXCR4")， type = "truncatedMean"， trim = 0.1)<strong>。在分析未排序的单细胞转录组时，</strong>在细胞数量丰富的群体比细胞数量稀少的群体更倾向于发出集体更强的信号的假设下</strong>，CellChat在概率计算中也可以考虑各细胞群体中细胞比例的影响。用户可以设置 <strong>population. size = TRUE</strong>.</p><h5 data-tool="mdnice编辑器">Step4. 计算通讯概率，推断细胞通讯网络</h5><p data-tool="mdnice编辑器">如果所研究的生物过程中已知的信号通路无法预测，用户可以尝试<code>truncatedMean</code>来改变计算每个细胞组平均基因表达的方法。</p><p data-tool="mdnice编辑器">对于<strong>population. size</strong>参数的解读：是否考虑所有测序细胞中每组细胞的比例，</p><ul data-tool="mdnice编辑器"><li><section>population. size = FALSE：如果分析分选富集的单细胞，以消除潜在的人为因素细胞群的大小。</section></li><li><section>population. size = TRUE，如果分析非分选富集的单细胞转录组，原因是丰富的细胞群往往比稀少的细胞群发送集体更强的信号。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>cellchat &lt;- computeCommunProb(cellchat,population.size = <span>F</span>)<br><span># Filter out the cell-cell communication if there are only few number of cells in certain cell groups</span><br>cellchat &lt;- filterCommunication(cellchat, min.cells = <span>10</span>)<br></code></pre><h5 data-tool="mdnice编辑器">Step5. 提取预测的细胞通讯网络为data frame</h5><p data-tool="mdnice编辑器"><strong>小技巧：</strong>如何取cellchat的子集？</p><pre data-tool="mdnice编辑器"><span></span><code><span>### cellchat取子集</span><br>barcode.use = sample(row.names(cellchat@meta),<span>100</span>)<br>cellchat.subset = subsetCellChat(cellchat,cells.use = barcode.use)<br></code></pre><p data-tool="mdnice编辑器">作者提供了函数<strong>subsetCommunication</strong>去提取用户感兴趣的配受体对强度为data.frame：</p><blockquote data-tool="mdnice编辑器"><p>注意：这里提取受配体信息为data.frame的tips是很有用的，例如借助这个data.frame数据，我们可以<strong>个性化</strong>展示/可视化某些特定的受配体/通路，具体用法见下期推文。</p></blockquote><ul data-tool="mdnice编辑器"><li><section><p><code>df.net &lt;- subsetCommunication(cellchat)</code> returns a data frame consisting of all the inferred cell-cell communications at the level of ligands/receptors. Set <code>slot.name = "netP"</code> to access the the inferred communications at the level of signaling pathways</p><pre><span></span><code><span>#获取所有的配受体对以及其通讯概率</span><br>df.net &lt;- subsetCommunication(cellchat)<br>head(df.net)<br></code></pre><figure><img data-ratio="0.257243195785777" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6uMqbAHqibxGF1C5YBSqwY5dINHhApWic4y9tSxpVkFsm11kNc6kicCVYA/640?wx_fmt=other" data-type="other" data-w="1139" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6uMqbAHqibxGF1C5YBSqwY5dINHhApWic4y9tSxpVkFsm11kNc6kicCVYA/640?wx_fmt=other"><figcaption>image-20220816174933476</figcaption></figure><pre><span></span><code><span>#以通路为单位提取通讯信息</span><br>df.pathway = subsetCommunication(cellchat,slot.name = <span>"netP"</span>)<br></code></pre><figure><img data-ratio="0.2808586762075134" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6GQhPC44m33ms7Zs4wR0EtOuU3IAMSG8OIW17JbONLZ6ibQ9XV5ly7CA/640?wx_fmt=other" data-type="other" data-w="559" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6GQhPC44m33ms7Zs4wR0EtOuU3IAMSG8OIW17JbONLZ6ibQ9XV5ly7CA/640?wx_fmt=other"><figcaption>image-20220816175233270</figcaption></figure></section></li><li><section><p><code>df.net &lt;- subsetCommunication(cellchat, sources.use = c(1,2), targets.use = c(4,5))</code> gives the inferred cell-cell communications sending from cell groups 1 and 2 to cell groups 4 and 5.</p><pre><span></span><code>levels(cellchat@idents)<br><span>#[1] "Naive CD4 T"  "Memory CD4 T" "CD14+ Mono"   "B"            "CD8 T"        "FCGR3A+ Mono" "NK"           "DC"          </span><br><span>#[9] "Platelet"</span><br></code></pre><p>这里的**source.use = c(1)**指的是Naive CD4 T，2和3分别对应Memory CD4 T和CD14+ Mono：</p><pre><span></span><code>df.net &lt;- subsetCommunication(cellchat, sources.use = c(<span>1</span>), targets.use = c(<span>2</span>,<span>3</span>))<br>head(df.net)<br></code></pre><figure><img data-ratio="0.1592526690391459" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6HoVX7P3ibPopzcfTMNhlshpwKuqibXPO0k0NicjcpTkU67iabFUc4rK1ibg/640?wx_fmt=other" data-type="other" data-w="1124" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6HoVX7P3ibPopzcfTMNhlshpwKuqibXPO0k0NicjcpTkU67iabFUc4rK1ibg/640?wx_fmt=other"><figcaption>image-20220816175517757</figcaption></figure></section></li><li><section><p><code>df.net &lt;- subsetCommunication(cellchat, signaling = c("MIF", "MHC-I"))</code> gives the inferred cell-cell communications mediated by signaling MIF and MHC-I.</p><pre><span></span><code>df.net &lt;- subsetCommunication(cellchat, signaling = c(<span>"MIF"</span>, <span>"MHC-I"</span>))<br>head(df.net)<br></code></pre><figure><img data-ratio="0.2624555160142349" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6KGh1ibLKooY0jmibujM3aKdkE63qRSd7LCrAfI6hicEvOA87lTXKOFqvg/640?wx_fmt=other" data-type="other" data-w="1124" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6KGh1ibLKooY0jmibujM3aKdkE63qRSd7LCrAfI6hicEvOA87lTXKOFqvg/640?wx_fmt=other"><figcaption>image-20220816175748824</figcaption></figure></section></li></ul><h5 data-tool="mdnice编辑器">Step6. 在信号通路水平推断细胞通讯</h5><p data-tool="mdnice编辑器">CellChat通过汇总与每个信号通路相关的所有配体-受体相互作用的通讯概率，计算信号通路层面的通讯概率。</p><p data-tool="mdnice编辑器">注意：推断出的每个配体-受体对的细胞间通讯网络和每个信号通路分别存储在' net '和' netP '插槽中。</p><pre data-tool="mdnice编辑器"><span></span><code>cellchat &lt;- computeCommunProbPathway(cellchat)<br>head(cellchat@net)<br>head(cellchat@netP)<br></code></pre><h5 data-tool="mdnice编辑器">Step7. 计算加和的cell-cell通讯网络</h5><p data-tool="mdnice编辑器">我们可以通过计算links数或总结细胞通讯概率来计算加和的cell-cell通讯网络。用户还可以通过设置<code>sources.use</code> 和<code>targets.use</code>来计算细胞亚群之间的加和网络。</p><pre data-tool="mdnice编辑器"><span></span><code>cellchat &lt;- aggregateNet(cellchat)<br></code></pre><p data-tool="mdnice编辑器">然后，我们还可以可视化加和的细胞间通讯网络。例如，使用circle plot显示任意两个细胞亚群之间的通讯次数或总通讯强度(权重)：</p><pre data-tool="mdnice编辑器"><span></span><code>groupSize &lt;- as.numeric(table(cellchat@idents))<br>par(mfrow = c(<span>1</span>,<span>2</span>), xpd=<span>TRUE</span>)<br>netVisual_circle(cellchat@net$count, vertex.weight = groupSize,<br>                 weight.scale = <span>T</span>, label.edge= <span>F</span>,<br>                 title.name = <span>"Number of interactions"</span>)<br>netVisual_circle(cellchat@net$weight, vertex.weight = groupSize,<br>                 weight.scale = <span>T</span>, label.edge= <span>F</span>,<br>                 title.name = <span>"Interaction weights/strength"</span>)<br></code></pre><img data-ratio="0.42144373673036095" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6oxtQfuN0buTaBiaicfXtXovDENeO6noWgbj3TjUib4qnfB75zXAvEyI5w/640?wx_fmt=other" data-type="other" data-w="942" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6oxtQfuN0buTaBiaicfXtXovDENeO6noWgbj3TjUib4qnfB75zXAvEyI5w/640?wx_fmt=other"><p data-tool="mdnice编辑器">由于细胞间通讯网络的复杂性，我们可以对每个细胞亚群发出的信号进行检测。这里我们还控制参数<strong>edge.weight.max</strong>，以便我们可以比较不同网络之间的边权值：</p><pre data-tool="mdnice编辑器"><span></span><code>mat &lt;- cellchat@net$weight<br>par(mfrow = c(<span>3</span>,<span>3</span>), xpd=<span>TRUE</span>)<br><span>for</span> (i <span>in</span> <span>1</span>:nrow(mat)) {<br>  mat2 &lt;- matrix(<span>0</span>, nrow = nrow(mat), ncol = ncol(mat), dimnames = dimnames(mat))<br>  mat2[i, ] &lt;- mat[i, ]<br>  netVisual_circle(mat2, vertex.weight = groupSize,<br>                   weight.scale = <span>T</span>, edge.weight.max = max(mat),<br>                   title.name = rownames(mat)[i])<br>}<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6338363780778395" data-src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6LhAVjRyhR8wefGG8kLyuyVlm7bvvyHg2ibQywO7BPc63cWOnic1mfWSA/640?wx_fmt=other" data-type="other" data-w="1259" src="https://mmbiz.qpic.cn/mmbiz/iaRJcrq2LosibkrGnDCo7FxC55nSXDaJh6LhAVjRyhR8wefGG8kLyuyVlm7bvvyHg2ibQywO7BPc63cWOnic1mfWSA/640?wx_fmt=other"><figcaption>image-20220816202504614</figcaption></figure><p data-tool="mdnice编辑器">从这里开始，以上代码和函数均为得到细胞通讯网络。接下来，作者围绕细胞层面，通路层面和基因层面等，开发了一系列的可视化函数供用户进行数据探索。有一些图表和代码上的理解，以及存在一些Bug，我们下期再聊。</p><span>- END -</span></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/g4j7u0gHmpJH9ZA1Jp9hCw",target="_blank" rel="noopener noreferrer">原文链接</a>
