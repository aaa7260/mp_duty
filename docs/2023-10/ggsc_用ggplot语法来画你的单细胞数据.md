---
title: "ggsc：用ggplot语法来画你的单细胞数据"
date: 2023-10-26T01:34:31Z
draft: ["false"]
tags: [
  "fetched",
  "YuLabSMU"
]
categories: ["Acdemic"]
---
ggsc：用ggplot语法来画你的单细胞数据 by YuLabSMU
------
<div><p data-mpa-powered-by="yiban.io"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI5NjUyNzkxMg==&amp;mid=2247493251&amp;idx=1&amp;sn=1084340842a25cf1dc65745c1becc226&amp;chksm=ec4057c4db37ded2ade3b93c35f68519e3f780acd3d5b476b744dbc8087d12854790ef11852a&amp;scene=21#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" data-itemshowtype="8" tab="innerlink" data-linktype="1"><span><img data-galleryid="" data-ratio="1.088" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcyZKmkwWtdZDZcwhlHexZkoWYzDtNQHwqJnvjDcV2j6kWD024UnQeUdA/640?wx_fmt=png" data-type="png" data-w="750" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcyZKmkwWtdZDZcwhlHexZkoWYzDtNQHwqJnvjDcV2j6kWD024UnQeUdA/640?wx_fmt=png"></span></a></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">上次广告新包上线，其实一年前就写了，当时我叫这个包为<code>scplot</code>，后来发现这包名已经被别人叫了，于是改名<code>ggsc</code>。<strong>当然先卖个关子，功能远不止今天要讲的</strong>。</p><p data-tool="mdnice编辑器">我们直接上代码，从人见人爱的<code>Seurat</code>开始，这个包让几乎所有考研复试的小朋友都说自己跑过单细胞的分析：</p><pre data-tool="mdnice编辑器"><span></span><code>library(Seurat)<br>dir = "filtered_gene_bc_matrices/hg19"<br><br>pbmc.data &lt;- Read10X(data.dir = dir)<br>pbmc &lt;- CreateSeuratObject(counts = pbmc.data, project = "pbmc3k", min.cells=3, min.features=200)<br>pbmc<br>## An object of class Seurat <br>## 13714 features across 2700 samples within 1 assay <br>## Active assay: RNA (13714 features, 0 variable features)<br>## Normalizing the data<br>pbmc &lt;- NormalizeData(pbmc, normalization.method = "LogNormalize", <br>                      scale.factor = 10000)<br><br>pbmc &lt;- NormalizeData(pbmc)<br><br>## Identify the 2000 most highly variable genes<br>pbmc &lt;- FindVariableFeatures(pbmc, selection.method = "vst", nfeatures = 2000)<br><br>## In addition we scale the data<br>all.genes &lt;- rownames(pbmc)<br>pbmc &lt;- ScaleData(pbmc, features = all.genes)<br><br>pbmc &lt;- RunPCA(pbmc, features = VariableFeatures(object = pbmc), <br>               verbose = FALSE)<br>pbmc &lt;- FindNeighbors(pbmc, dims = 1:10, verbose = FALSE)<br>pbmc &lt;- FindClusters(pbmc, resolution = 0.5, verbose = FALSE)<br>pbmc &lt;- RunUMAP(pbmc, dims = 1:10, umap.method = "uwot", metric = "cosine")<br><br>## Run tSNE <br>pbmc &lt;- RunTSNE(pbmc, reduction = "pca", dims=1:5, tsne.method = "Rtsne")<br><br>## Assigning cell type identity to clusters<br>new.cluster.ids &lt;- c("Naive CD4 T", "CD14+ Mono", "Memory CD4 T", "B", "CD8 T",<br>                     "FCGR3A+ Mono", "NK", "DC", "Platelet")<br>names(new.cluster.ids) &lt;- levels(pbmc)<br>pbmc &lt;- RenameIdents(pbmc, new.cluster.ids)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span>降维图</h2><p data-tool="mdnice编辑器">Seurat版本：</p><pre data-tool="mdnice编辑器"><span></span><code>DimPlot(pbmc, reduction = "umap",<br>        label = TRUE, pt.size = 0.5)<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6666666666666666" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcyQpw2W3dok15PiadofR8ML6wnEKVlbiaBmsn1NPmAiaEPTX4VzZ3bnQ1cg/640?wx_fmt=png" data-type="png" data-w="864" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcyQpw2W3dok15PiadofR8ML6wnEKVlbiaBmsn1NPmAiaEPTX4VzZ3bnQ1cg/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">ggsc版本：</p><pre data-tool="mdnice编辑器"><span></span><code>library(ggplot2)<br>library(ggsc)<br>sc_dim(pbmc) + sc_dim_geom_label()<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6666666666666666" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcyMiclt32XUUkJ5HLKqVDmF6nuVicrR4zYoDd5QEtOC6WC4XNBor2muicUA/640?wx_fmt=png" data-type="png" data-w="864" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcyMiclt32XUUkJ5HLKqVDmF6nuVicrR4zYoDd5QEtOC6WC4XNBor2muicUA/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">就是<code>sc_dim</code>画散点，<code>sc_dim_geom_label</code>画标签。看上去我们除了搞个人见人爱的坐标轴之外，画出来一样。</p><p data-tool="mdnice编辑器">然而我们能够更灵活：</p><pre data-tool="mdnice编辑器"><span></span><code>sc_dim(pbmc) + <br>    sc_dim_geom_label(geom = shadowtext::geom_shadowtext, <br>            color='black', bg.color='white')<br></code></pre><p data-tool="mdnice编辑器">比如用什么图层来画细胞标签，可以传，这里用我写的<code>shadowtext</code>包来画，字就凸显出来了。</p><p data-tool="mdnice编辑器"><img data-ratio="0.6666666666666666" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcyWXnEcRztTqJnphghAN7FV1MLwJV6ZdvHbnj6mHo1ofG6J47SsRic7PA/640?wx_fmt=png" data-type="png" data-w="864" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcyWXnEcRztTqJnphghAN7FV1MLwJV6ZdvHbnj6mHo1ofG6J47SsRic7PA/640?wx_fmt=png"></p><h2 data-tool="mdnice编辑器"><span></span>基因表达量</h2><p data-tool="mdnice编辑器">Seurat版本：</p><pre data-tool="mdnice编辑器"><span></span><code>features = c("MS4A1", "GNLY", "CD3E", <br>            "CD14", "FCER1A", "FCGR3A", <br>            "LYZ", "PPBP", "CD8A")<br>FeaturePlot(pbmc,'CD4')<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6666666666666666" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcy7Yianx4gtTFracFibjFIKcHdHogFpGqVZYiaQxGgoXjT97IsCH9DGwUkg/640?wx_fmt=png" data-type="png" data-w="864" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcy7Yianx4gtTFracFibjFIKcHdHogFpGqVZYiaQxGgoXjT97IsCH9DGwUkg/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">ggsc版本：</p><pre data-tool="mdnice编辑器"><span></span><code>sc_feature(pbmc, 'CD4')<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6666666666666666" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcycRuVMiaSvYzBhEgzImfv80flXfI4jSqkgTzhQ5fBUgo7qzZX2GciaIEQ/640?wx_fmt=png" data-type="png" data-w="864" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcycRuVMiaSvYzBhEgzImfv80flXfI4jSqkgTzhQ5fBUgo7qzZX2GciaIEQ/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">如果要同时画几个呢：</p><p data-tool="mdnice编辑器">Seurat版本：</p><pre data-tool="mdnice编辑器"><span></span><code>FeaturePlot(pbmc, features)<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6666666666666666" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcyxDWpOp3CT54griaVNJrH0FEcib4r8oOeZ8SGD5ZVrVFWngFw0nuiavPZg/640?wx_fmt=png" data-type="png" data-w="864" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcyxDWpOp3CT54griaVNJrH0FEcib4r8oOeZ8SGD5ZVrVFWngFw0nuiavPZg/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">Seurat我感觉不好是它是拼图的，表达量的颜色标尺是不一样的，不方便比较，所以我出的是分面，标尺一致，基因的表达量，除了在细胞类型分布的区别之外，谁高谁低一目了然。</p><p data-tool="mdnice编辑器">ggsc版本：</p><pre data-tool="mdnice编辑器"><span></span><code>sc_feature(pbmc, features)<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6666666666666666" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcy3jdCrHUE00vxUpC0JUU1xOKqFQI7mL9wcv9FpS2GG48xuehc2uH4TA/640?wx_fmt=png" data-type="png" data-w="864" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcy3jdCrHUE00vxUpC0JUU1xOKqFQI7mL9wcv9FpS2GG48xuehc2uH4TA/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">当然分面也有分面的坏处，如果一起展示的基因的表达量实在是具有量级上的差别，那统一标尺，会有些基因的表达量根本没法看。那换成Seurat那种行不？这有何难。</p><pre data-tool="mdnice编辑器"><span></span><code>ff &lt;- lapply(features, sc_feature, object=pbmc)<br>aplot::plot_list(gglist= ff, ncol=3)<br></code></pre><p><img data-galleryid="" data-ratio="0.5907407407407408" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcykIq3JYD4MticGUp9ugRzXTU44Tjn1PJg6wP1YrL5icgGxqTeWkmHGicQA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcykIq3JYD4MticGUp9ugRzXTU44Tjn1PJg6wP1YrL5icgGxqTeWkmHGicQA/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">无非是独自出图，然后拼。</p><p data-tool="mdnice编辑器">好了，前面是和Seurat类比的一个函数，应该说更强大，但没有体现出图形语法是不是？没问题的，我们能够做到真正的降维图画了，再在上面把你选中的基因画出来。比如这样子：</p><pre data-tool="mdnice编辑器"><span></span><code>sc_dim(pbmc) + <br>   sc_dim_geom_feature(pbmc, 'CD4', color='black')<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6666666666666666" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcygfqNvbUl3DqP8yZXnnl3bnNwByjOj99eTfl8SuUatcwsseEhIRDbJw/640?wx_fmt=png" data-type="png" data-w="864" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcygfqNvbUl3DqP8yZXnnl3bnNwByjOj99eTfl8SuUatcwsseEhIRDbJw/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">多个基因同样适用：</p><pre data-tool="mdnice编辑器"><span></span><code>sc_dim(pbmc, alpha=.3) + <br>    ggnewscale::new_scale_color() + <br>    sc_dim_geom_feature(pbmc, features, mapping=aes(color=features)) +<br>    scale_color_viridis_d()<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6666666666666666" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcyEYqGuxghFuV83Mpv8T4lXt2T1uHEo3ADDdFF1fQx7f8qmNYrMeLePQ/640?wx_fmt=png" data-type="png" data-w="864" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcyEYqGuxghFuV83Mpv8T4lXt2T1uHEo3ADDdFF1fQx7f8qmNYrMeLePQ/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">我们可以把背景换成灰色，高亮选中的基因，而选中的基因，除了用表达量，你还可以用别的变量来映射，任君选择：</p><pre data-tool="mdnice编辑器"><span></span><code>sc_dim(pbmc, alpha=.3, reduction = 'tsne', color='grey50') +<br>    sc_dim_geom_feature(pbmc, features, mapping=aes(color=features))<br></code></pre><p><img data-galleryid="" data-ratio="0.5888888888888889" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcymiaBtr7IxKmBSUbxoBEkC0T91QHgI1CKtcbCcjSBL13MJLr8KFTe6Cg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kwyXzhIcibrjnJgNHJcgwcymiaBtr7IxKmBSUbxoBEkC0T91QHgI1CKtcbCcjSBL13MJLr8KFTe6Cg/640?wx_fmt=png"></p><p data-tool="mdnice编辑器">它提供给我们的，是更大的自由度，和灵活的语法，当然也带来了更多的可能性。以及有什么需求，向我们提，经常能够实现愿望。我当时写这个包，其中一个原因就是我觉得Seurat画的图太丑，真的很丑。</p><p data-tool="mdnice编辑器"><br></p><p data-tool="mdnice编辑器">未完待续...<br></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/VuEKNeA9q-ULGmqHILsBIQ",target="_blank" rel="noopener noreferrer">原文链接</a>
