---
title: "如何使用Celltypist建立属于自己的模型"
date: 2023-10-29T00:45:59Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
如何使用Celltypist建立属于自己的模型 by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">使用Celltypist建立属于自己的单细胞label transfer模型。</p><p data-tool="mdnice编辑器">Celltypist tool文章发表在science期刊上，《Cross-tissue immune cell analysis reveals tissue-specific features in humans》，DOI: <span>10.1126/science.abl5197</span></p><p data-tool="mdnice编辑器">官网链接：CellTypist | automated cell type annotation for scRNA-seq datasets</p><p data-tool="mdnice编辑器">如何使用Celltypist进行细胞预测，请看Ph.D. Zhao的优秀推文</p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484838&amp;idx=1&amp;sn=d02d0ee3daaa0ea69cfbfd11b9fde844&amp;scene=21#wechat_redirect" data-linktype="2">Celltypist：超越singleR的单细胞注释工具</a></p><h2 data-tool="mdnice编辑器"><span></span><span>1. 环境部署</span><span> </span></h2><pre data-tool="mdnice编辑器"><span></span><code>conda activate celltypist_env <span>#进入专门的环境 </span><br>pip install celltypist  <span>#Using pip </span><br><span># 或者</span><br>conda install -c bioconda -c conda-forge celltypist <span>#Using conda </span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>2. Python 版本</span><span> </span></h2><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> os <br><span>import</span> scanpy <span>as</span> sc<br><span>import</span> pandas <span>as</span> pd<br><span>import</span> celltypist<br><span>from</span> celltypist <span>import</span> models<br></code></pre><p data-tool="mdnice编辑器">设置工作路径</p><pre data-tool="mdnice编辑器"><span></span><code>os.chdir(<span>"//groups//chencp/project/18PDAC_Atlas/data/seq/DISCO_python/"</span>) <br></code></pre><p data-tool="mdnice编辑器">加载数据并简单处理</p><pre data-tool="mdnice编辑器"><span></span><code>adata_model = sc.read(<span>'CRX030763.h5ad'</span>)<br>sc.pp.normalize_total(adata_model, target_sum = <span>1e4</span>)<br>sc.pp.log1p(adata_model)<br></code></pre><p data-tool="mdnice编辑器">看下数据处理结果</p><pre data-tool="mdnice编辑器"><span></span><code>adata_model.X.expm1().sum(axis = <span>1</span>)[:<span>10</span>]<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>matrix([[10000.],<br>        [10000.],<br>        [10000.],<br>        [10000.],<br>        [10000.],<br>        [10000.],<br>        [10000.],<br>        [10000.],<br>        [10000.],<br>        [10000.]])<br></code></pre><p data-tool="mdnice编辑器">再看下数据情况</p><pre data-tool="mdnice编辑器"><span></span><code>adata_model<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>AnnData object with n_obs × n_vars = 7379 × 33538<br>    obs: <span>'orig.ident'</span>, <span>'nCount_RNA'</span>, <span>'nFeature_RNA'</span>, <span>'percent.mt'</span>, <span>'RNA_snn_res.0.8'</span>, <span>'seurat_clusters'</span>, <span>'cell.type'</span>, <span>'cell.type.score'</span>, <span>'sampling.weight'</span><br>    var: <span>'vst.mean'</span>, <span>'vst.variance'</span>, <span>'vst.variance.expected'</span>, <span>'vst.variance.standardized'</span>, <span>'vst.variable'</span>, <span>'gene'</span><br>    uns: <span>'neighbors'</span>, <span>'log1p'</span><br>    obsm: <span>'X_pca'</span>, <span>'X_umap'</span><br>    varm: <span>'PCs'</span><br>    obsp: <span>'distances'</span><br></code></pre><p data-tool="mdnice编辑器">开始建立模型</p><pre data-tool="mdnice编辑器"><span></span><code>new_model = celltypist.train(adata_model, labels = <span>'cell.type'</span>, n_jobs = <span>10</span>, feature_selection = <span>True</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>🍳 Preparing data before training<br>✂️ 8330 non-expressed genes are filtered out<br>🔬 Input data has 7379 cells and 25208 genes<br>⚖️ Scaling input data<br>🏋️ Training data using SGD logistic regression<br>🔎 Selecting features<br>🧬 3575 features are selected<br>🏋️ Starting the second round of training<br>🏋️ Training data using logistic regression<br>✅ Model training <span>done</span>!<br></code></pre><p data-tool="mdnice编辑器">7379 细胞， 25208 基因，从中挑选3575特征训练模型，时间大概是3分钟左右，</p><p data-tool="mdnice编辑器">其中提到的 <code>SGD logistic regression</code>模型，GPT给出的解释是，</p><blockquote data-tool="mdnice编辑器"><p>SGD Logistic Regression is a machine learning model for binary classification, where it predicts one of two possible outcomes based on input features. It utilizes a logistic function to map input features to a probability value between 0 and 1, representing the likelihood of belonging to the first category. Training this model involves adjusting parameters using the stochastic gradient descent (SGD) optimization algorithm, making it suitable for large-scale datasets.</p></blockquote><p data-tool="mdnice编辑器">大体意思是说，这个逻辑回归模型是一种用于二元分类问题的机器学习模型，使用逻辑函数来将输入特征映射到一个介于0和1之间的概率值，而这个概率值表示某个样本属于第一个类别的可能性。通过调不断调整模型参数，直到达到收敛条件的特点使得模型能够逐步适应不同的数据点，特别适用于大规模数据集。</p><p data-tool="mdnice编辑器">保存模型方便以后使用</p><pre data-tool="mdnice编辑器"><span></span><code>new_model.write(<span>'celltypist_demo_folder/model_pdac.pkl'</span>)<br></code></pre><p data-tool="mdnice编辑器">再次加载，使用绝对路径</p><pre data-tool="mdnice编辑器"><span></span><code>new_model = models.Model.load(<span>'celltypist_demo_folder/model_pdac.pkl'</span>)<br></code></pre><p data-tool="mdnice编辑器">看下模型情况</p><pre data-tool="mdnice编辑器"><span></span><code>new_model<br></code></pre><p data-tool="mdnice编辑器">加载测试数据并简单处理，</p><pre data-tool="mdnice编辑器"><span></span><code>adata_test.raw = adata_test<br>sc.pp.normalize_total(adata_test, target_sum = <span>1e4</span>)<br>sc.pp.log1p(adata_test)<br></code></pre><p data-tool="mdnice编辑器">同样看下数据处理结果，</p><pre data-tool="mdnice编辑器"><span></span><code>adata_test.X.expm1().sum(axis = <span>1</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>matrix([[10000.],<br>        [10000.],<br>        [10000.],<br>        ...,<br>        [10000.],<br>        [10000.],<br>        [10000.]])<br></code></pre><p data-tool="mdnice编辑器">画张点图看下表达情况，</p><figure data-tool="mdnice编辑器"><img data-ratio="0.4888888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/9LgsctS2IfE1y7ibVRxNY5oUPEVicE3xUHUYexdh27wvhhFCwmMWT6JKX5OicWmVIgyicVKUq3Q1phRUicEFiaRsb6Hg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/9LgsctS2IfE1y7ibVRxNY5oUPEVicE3xUHUYexdh27wvhhFCwmMWT6JKX5OicWmVIgyicVKUq3Q1phRUicEFiaRsb6Hg/640?wx_fmt=png"><figcaption>image-20231017115458656</figcaption></figure><p data-tool="mdnice编辑器">进行预测，如果之前没有加载模型，也可以直接在这引用，</p><pre data-tool="mdnice编辑器"><span></span><code>predictions = celltypist.annotate(adata_test, model = <span>'celltypist_demo_folder/model_pdac.pkl'</span>, majority_voting = <span>True</span>, mode = <span>'prob match'</span>, p_thres = <span>0.5</span>)<br></code></pre><p data-tool="mdnice编辑器">将预测加载到结果中并画图</p><pre data-tool="mdnice编辑器"><span></span><code>adata_test = predictions.to_adata(insert_prob = <span>True</span>)<br>sc.pl.umap(adata_test, color = [<span>'cell.type'</span>, <span>'majority_voting'</span>], legend_loc = <span>'on data'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><figcaption><br></figcaption><p><img data-galleryid="" data-ratio="0.3731481481481482" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/9LgsctS2IfE1y7ibVRxNY5oUPEVicE3xUHA1o4fbiamGlFKl6mu1e2rfaLUVC5dHUksIhZicUK28MSRq2x5JiczPicRQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/9LgsctS2IfE1y7ibVRxNY5oUPEVicE3xUHA1o4fbiamGlFKl6mu1e2rfaLUVC5dHUksIhZicUK28MSRq2x5JiczPicRQ/640?wx_fmt=png"></p><figcaption><br></figcaption></figure><p data-tool="mdnice编辑器">看下详细情况，</p><pre data-tool="mdnice编辑器"><span></span><code>cross_tab = pd.crosstab(adata_test.obs[<span>'cell.type'</span>], adata_test.obs[<span>'majority_voting'</span>])<br>cross_tab<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.46944444444444444" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/9LgsctS2IfE1y7ibVRxNY5oUPEVicE3xUHTOYkxSlCO1ufsjfxBbVzW2T5Ve4Bn0hC3WVnBxnc85jQHfMyvYTM3g/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/9LgsctS2IfE1y7ibVRxNY5oUPEVicE3xUHTOYkxSlCO1ufsjfxBbVzW2T5Ve4Bn0hC3WVnBxnc85jQHfMyvYTM3g/640?wx_fmt=png"><figcaption>image-20231017120220216</figcaption></figure><p data-tool="mdnice编辑器">因为celltype非完全重叠，且细胞数量有限，但可见模型总体预测结果还是挺好的，尤其是预测PDAC肿瘤细胞。</p><h2 data-tool="mdnice编辑器"><span></span><span>3. R版本的尝试</span><span> </span></h2><p data-tool="mdnice编辑器">加载环境</p><pre data-tool="mdnice编辑器"><span></span><code><span>require</span>(Seurat)<br><span>require</span>(data.table)<br><span>library</span>(reticulate)<br>use_condaenv(<span>"celltypist_env"</span>)<br>scanpy = import(<span>"scanpy"</span>)<br>celltypist = import(<span>"celltypist"</span>)<br>pandas &lt;- import(<span>"pandas"</span>)<br>numpy = import(<span>"numpy"</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>setwd(<span>"//groups//chencp/project/18PDAC_Atlas/data/seq/DISCO_python/"</span>) <br></code></pre><p data-tool="mdnice编辑器">将上面的h5ad对象转换成rds后，读进R，</p><pre data-tool="mdnice编辑器"><span></span><code>adata_model = readRDS(<span>'CRX030763.rds'</span>)<br>adata_test = readRDS(<span>'CRX030762.rds'</span>)<br></code></pre><p data-tool="mdnice编辑器">检查数据一致性，</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; adata_test<br>An object of class Seurat <br>33538 features across 2818 samples within 1 assay <br>Active assay: RNA (33538 features, 2000 variable features)<br> 2 dimensional reductions calculated: pca, umap<br>&gt; adata_model<br>An object of class Seurat <br>33538 features across 7379 samples within 1 assay <br>Active assay: RNA (33538 features, 2000 variable features)<br> 2 dimensional reductions calculated: pca, umap<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>new_model = celltypist$train(adata_model, labels = <span>'cell.type'</span>, n_jobs = <span>10</span>, feature_selection = <span>T</span>)<br></code></pre><p data-tool="mdnice编辑器">在进行此步骤时，</p><pre data-tool="mdnice编辑器"><span></span><code>An object of class Seurat <br>33538 features across 7379 samples within 1 assay <br>Active assay: RNA (33538 features, 2000 variable features)<br> 2 dimensional reductions calculated: pca, umap<br>Error <span>in</span> py_call_impl(callable, dots<span>$args</span>, dots<span>$keywords</span>) : <br>  Evaluation error: Unable to convert R object to Python <span>type</span>.<br></code></pre><p data-tool="mdnice编辑器">显示在将模型转换成R对象出了错误，看来如果要使用R版本就需要重新改写整个python包了。</p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/-Y9q6xC9LE1rlWU1xJ3ZEw",target="_blank" rel="noopener noreferrer">原文链接</a>
