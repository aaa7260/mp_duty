---
title: "【R语言】蒙特卡罗法计算圆周率Pi，R真的那么慢吗？"
date: 2022-09-16T15:08:26Z
draft: ["false"]
tags: [
  "fetched",
  "R语言与数学建模"
]
categories: ["Acdemic"]
---
【R语言】蒙特卡罗法计算圆周率Pi，R真的那么慢吗？ by R语言与数学建模
------
<div><p data-first-child="" data-pid="WGtcUTcE">看到一位曾经的 <code>R</code> 语言用户写了这么一篇文章：</p><p><span><span>yuanz：rust C python R运行效率对比（蒙特卡洛计算圆周率 PI）</span><span>https://zhuanlan.zhihu.com/p/564546171</span><span><br></span><span><span>有感而发，也</span><span>写这么</span><span>一小篇。</span></span></span></p><p data-pid="4OZvoBaF">该文用蒙特卡罗法，通过 <code>for</code> 循环 10000000 次近似计算圆周率，测得这样一个对比结果：</p><figure data-size="normal"><img data-ratio="0.5678733031674208" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/oh2MbgfdUWBCtCcWCp5NFLicicNWfdmOOCoGFqRMcaiaKvFCptN0OegTMhviaZdADaJA2ClsDwn0TjjQ3XIMHLvOgw/640?wx_fmt=jpeg" data-type="jpeg" data-w="442" width="442" src="https://mmbiz.qpic.cn/mmbiz_jpg/oh2MbgfdUWBCtCcWCp5NFLicicNWfdmOOCoGFqRMcaiaKvFCptN0OegTMhviaZdADaJA2ClsDwn0TjjQ3XIMHLvOgw/640?wx_fmt=jpeg"></figure><hr><p data-pid="Gw7aT5aO">为什么差距这么大？这涉及编程语言的大类区分：</p><ul><li><p><code>C、C++、Java、Python</code>等是更偏向于程序开发的人使用，涉及偏底层的编程开发技术更多；</p></li><li><p><code>R</code>语言、<code>Matlab</code>等是高级编程语言，或者说是给非编程开发人员用的，是用来解决问题而生的，里面提供了大量现成的函数、工具箱，让用户不用钻研程序开发就能方便地拿来解决自己的问题；</p></li></ul><p data-pid="RdI9_Au8">实际上，<code>Python</code> 有点居于两类之间的意思，既有底层程序开发，又有高级编程语言解决问题属性，比如<code>pandas、sklearn</code> 等库的流行。</p><p data-pid="CfbswT94">很多从 <code>C、Python</code> 语言学过来的人，都习惯了动不动就逐元素 <code>for</code> 循环，实际上在高级编程语言这边，这种思维是非常不好的：一是代码啰嗦，二是效率很低。高级编程语言已经全面支持<span> 向量化、泛函式编程、数据思维编程</span>，代码的简洁性、可读性、执行效率都远远高于在其中使用逐元素 <code>for</code> 循环。</p><p data-pid="KjJ4BlRn">所以，我教学生 R 语言编程时，常说的一句话就是：<span>那种动不动就逐元素 <code>for</code> 循环的不好的习惯，要大胆地、彻底地抛弃，你才能学好 R 语言</span>。</p><p data-pid="BdZgerXI">回到蒙特卡罗法计算圆周率问题，<span>不是 R 语言就这么慢，而是打开方式不对！</span></p><p data-pid="1fAeM5eK">原文的计算函数如下，典型的逐元素 for 循环写法：</p><pre><code><span>calculate_pi</span> <span>&lt;-</span> <span>function</span><span>(</span><span>sample_n</span><span>)</span> <span>{</span><br>  <span>in_circle</span> <span>=</span> <span>0</span><br>  <span>for</span> <span>(</span><span>index</span> <span>in</span> <span>1</span><span>:</span><span>sample_n</span><span>)</span> <span>{</span><br>    <span>x</span> <span>=</span> <span>runif</span><span>(</span><span>1</span><span>,</span> <span>min</span> <span>=</span> <span>0</span><span>,</span> <span>max</span> <span>=</span> <span>1</span><span>)</span><br>    <span>y</span> <span>=</span> <span>runif</span><span>(</span><span>1</span><span>,</span> <span>min</span> <span>=</span> <span>0</span><span>,</span> <span>max</span> <span>=</span> <span>1</span><span>)</span><br>    <span>r</span> <span>=</span> <span>x</span><span>*</span><span>x</span> <span>+</span> <span>y</span><span>*</span><span>y</span><br>    <span>if</span> <span>(</span><span>r</span> <span>&lt;</span><span>1</span><span>)</span> <span>{</span><br>      <span>in_circle</span> <span>=</span> <span>in_circle</span><span>+</span><span>1</span><br>    <span>}</span><br>  <span>}</span><br>  <span>pi</span> <span>=</span> <span>in_circle</span> <span>/</span> <span>sample_n</span> <span>*</span> <span>4</span><br>  <span>return</span><span>(</span><span>pi</span><span>)</span><br><span>}</span></code></pre><p data-pid="o19cYMuA">我改写成正确的向量化写法（R 中几乎所有自带函数都支持向量化，所以为什么不用？）：</p><pre><code><span>calculate_pi</span> <span>=</span> <span>function</span><span>(</span><span>sample_n</span><span>)</span> <span>{</span><br>  <span>x</span> <span>=</span> <span>runif</span><span>(</span><span>sample_n</span><span>)</span><br>  <span>y</span> <span>=</span> <span>runif</span><span>(</span><span>sample_n</span><span>)</span><br>  <span>mean</span><span>(</span><span>x</span><span>^</span><span>2</span> <span>+</span> <span>y</span><span>^</span><span>2</span> <span>&lt;</span> <span>1</span><span>)</span> <span>*</span> <span>4</span><br><span>}</span></code></pre><p data-pid="gfzzjp8O">代码更加简洁、可读性更高，关键是运行时间，同样的代码模拟10次，你再看：</p><pre><code><span>for</span> <span>(</span><span>index</span> <span>in</span> <span>1</span><span>:</span><span>10</span><span>)</span> <span>{</span><br>  <span>start</span> <span>=</span> <span>Sys</span><span>.</span><span>time</span><span>()</span><br>  <span>pi</span> <span>=</span> <span>calculate_pi</span><span>(</span><span>10000000</span><span>)</span><br>  <span>end</span> <span>=</span> <span>Sys.time</span><span>()</span><br>  <span>els</span> <span>=</span> <span>end</span> <span>-</span> <span>start</span><br>  <span>cat</span><span>(</span><span>"the pi is :"</span><span>,</span> <span>pi</span><span>,</span> <span>"use time is : "</span><span>,</span> <span>els</span><span>,</span> <span>'\</span><span>n</span><span>')</span><br><span>}</span></code></pre><figure data-size="normal"><img data-ratio="0.40625" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/oh2MbgfdUWBCtCcWCp5NFLicicNWfdmOOClHxgDKW6D7UyavO3jVdnNqOzS1bFLk2VHWdmCuTA739zpHHDiaRFjUg/640?wx_fmt=jpeg" data-type="jpeg" data-w="544" width="544" src="https://mmbiz.qpic.cn/mmbiz_jpg/oh2MbgfdUWBCtCcWCp5NFLicicNWfdmOOClHxgDKW6D7UyavO3jVdnNqOzS1bFLk2VHWdmCuTA739zpHHDiaRFjUg/640?wx_fmt=jpeg"></figure><p data-pid="yodo_BW0">我的电脑也是 2019 年买的 i7，应该性能相当。</p><p><br></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/huZze6HHtutJiXadzsK5yw",target="_blank" rel="noopener noreferrer">原文链接</a>
